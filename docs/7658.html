<html>
<head>
<title>Prometheus: Kubernetes endpoints monitoring with blackbox-exporter</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Prometheus: Kubernetes使用黑盒导出器进行端点监控</h1>
<blockquote>原文：<a href="https://itnext.io/prometheus-kubernetes-endpoints-monitoring-with-blackbox-exporter-a027ae136b8d?source=collection_archive---------3-----------------------#2022-12-11">https://itnext.io/prometheus-kubernetes-endpoints-monitoring-with-blackbox-exporter-a027ae136b8d?source=collection_archive---------3-----------------------#2022-12-11</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/5ccb07a8086391363cfbad22994baf33.png" data-original-src="https://miro.medium.com/v2/resize:fit:814/format:webp/1*5VOsGbX_JF8JDXtD_5zAYw.png"/></div></div></figure><p id="1b5e" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">blackbox-exporter是一个可以监控各种端点的导出器——互联网上的URL、AWS中的负载平衡器或Kubernetes集群中的服务，如MySQL或PostgreSQL数据库。</p><p id="535d" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">Blackbox Exporter可以给你HTTP响应时间统计、响应代码、SSL证书信息等。</p><p id="c606" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在这篇文章中我们要做什么:</p><ul class=""><li id="0e6d" class="kw kx iq ka b kb kc kf kg kj ky kn kz kr la kv lb lc ld le bi translated">在Helm的帮助下，将在<a class="ae lf" href="https://minikube.sigs.k8s.io/docs/start/" rel="noopener ugc nofollow" target="_blank"> Minikube </a>中部署<a class="ae lf" href="https://github.com/prometheus-community/helm-charts/tree/main/charts/kube-prometheus-stack" rel="noopener ugc nofollow" target="_blank"> kube-prometheus-stack </a></li><li id="4761" class="kw kx iq ka b kb lg kf lh kj li kn lj kr lk kv lb lc ld le bi translated">部署黑盒导出器本身</li><li id="04f0" class="kw kx iq ka b kb lg kf lh kj li kn lj kr lk kv lb lc ld le bi translated">使用Kubernetes ServiceMonitors配置端点监控，这将通过<a class="ae lf" href="https://github.com/prometheus/blackbox_exporter" rel="noopener ugc nofollow" target="_blank">黑盒导出器配置</a>创建</li><li id="74d3" class="kw kx iq ka b kb lg kf lh kj li kn lj kr lk kv lb lc ld le bi translated">将简要概述用于轮询端点的Blacbkox' <code class="fe ll lm ln lo b">probes</code></li></ul><p id="32f0" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我们走吧。</p><h1 id="52d9" class="lp lq iq bd lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm bi translated">运行Kube Prometheus堆栈</h1><p id="c56b" class="pw-post-body-paragraph jy jz iq ka b kb mn kd ke kf mo kh ki kj mp kl km kn mq kp kq kr mr kt ku kv ij bi translated">我们将在Minikube中完成这个设置，在那里我们将从舵库安装Prometheus操作器。</p><p id="5aab" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">启动迷你立方体本身:</p><pre class="ms mt mu mv gt mw lo mx bn my mz bi"><span id="64ce" class="na lq iq lo b be nb nc l nd ne">$ minikube start</span></pre><p id="e599" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">添加普罗米修斯图表库:</p><pre class="ms mt mu mv gt mw lo mx bn my mz bi"><span id="b688" class="na lq iq lo b be nb nc l nd ne">$ helm repo add prometheus-community https://prometheus-community.github.io/helm-charts<br/>helm repo update</span></pre><p id="a5d2" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">创建名称空间:</p><pre class="ms mt mu mv gt mw lo mx bn my mz bi"><span id="d6cc" class="na lq iq lo b be nb nc l nd ne">$ kubectl create ns monitoring</span></pre><p id="1f75" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">安装<code class="fe ll lm ln lo b">kube-prometheus-stack</code>图表:</p><pre class="ms mt mu mv gt mw lo mx bn my mz bi"><span id="4a77" class="na lq iq lo b be nb nc l nd ne">$ helm -n monitoring install prometheus prometheus-community/kube-prometheus-stack</span></pre><p id="6104" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">等待几分钟，直到所有的pod变为<em class="nf">运行</em>:</p><pre class="ms mt mu mv gt mw lo mx bn my mz bi"><span id="9bb8" class="na lq iq lo b be nb nc l nd ne">$ kubectl -n monitoring get pod<br/>NAME READY STATUS RESTARTS AGE<br/>alertmanager-prometheus-kube-prometheus-alertmanager-0 1/2 Running 1 (25s ago) 44s<br/>prometheus-grafana-599dbccb79-zlklx 2/3 Running 0 57s<br/>prometheus-kube-prometheus-operator-689dd6679c-s66vp 1/1 Running 0 57s<br/>prometheus-kube-state-metrics-6cfd96f4c8–84j26 1/1 Running 0 57s<br/>prometheus-prometheus-kube-prometheus-prometheus-0 0/2 PodInitializing 0 44s<br/>prometheus-prometheus-node-exporter-2h542 1/1 Running 0 57s</span></pre><p id="6b45" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">查找普罗米修斯服务:</p><pre class="ms mt mu mv gt mw lo mx bn my mz bi"><span id="42df" class="na lq iq lo b be nb nc l nd ne">$ kubectl -n monitoring get svc<br/>NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE<br/>alertmanager-operated ClusterIP None &lt;none&gt; 9093/TCP,9094/TCP,9094/UDP 7s<br/>prometheus-grafana ClusterIP 10.97.79.182 &lt;none&gt; 80/TCP 20s<br/>prometheus-kube-prometheus-alertmanager ClusterIP 10.106.147.39 &lt;none&gt; 9093/TCP 20s<br/>prometheus-kube-prometheus-operator ClusterIP 10.98.222.45 &lt;none&gt; 443/TCP 20s<br/>prometheus-kube-prometheus-prometheus ClusterIP 10.107.26.113 &lt;none&gt; 9090/TCP 20s<br/>…</span></pre><p id="7c5b" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">使用<code class="fe ll lm ln lo b">port-forward</code>打开对服务的访问:</p><pre class="ms mt mu mv gt mw lo mx bn my mz bi"><span id="ec0a" class="na lq iq lo b be nb nc l nd ne">$ kubectl -n monitoring port-forward svc/prometheus-kube-prometheus-prometheus 9090:9090</span></pre><p id="1f8f" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">打开<a class="ae lf" href="http://localhost:9090," rel="noopener ugc nofollow" target="_blank"><em class="nf">http://localhost:9090</em>，</a>检查是否一切正常:</p><figure class="ms mt mu mv gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi ng"><img src="../Images/5f0046d5a691d525d6dbe36e06290534.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*M1Sejjs8dNjMEqa-.png"/></div></div></figure><h1 id="9e23" class="lp lq iq bd lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm bi translated">运行黑盒导出器</h1><p id="2a5e" class="pw-post-body-paragraph jy jz iq ka b kb mn kd ke kf mo kh ki kj mp kl km kn mq kp kq kr mr kt ku kv ij bi translated">它的图表存在于同一个存储库中，所以只需安装导出器:</p><p id="0009" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">赫尔姆-n监控升级—安装普罗米修斯-黑盒普罗米修斯-社区/普罗米修斯-黑盒-导出器</p><p id="3c48" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">检查吊舱:</p><pre class="ms mt mu mv gt mw lo mx bn my mz bi"><span id="761c" class="na lq iq lo b be nb nc l nd ne">$ kubectl -n monitoring get pod<br/>NAME READY STATUS RESTARTS AGE<br/>prometheus-blackbox-prometheus-blackbox-exporter-6865d9b44h546j 1/1 Running 0 27s<br/>…</span></pre><p id="a9aa" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">Blackbox将其配置保存在ConfigMap中，config map连接到Pod并传递默认参数。更多<a class="ae lf" href="https://github.com/prometheus-community/helm-charts/blob/main/charts/prometheus-blackbox-exporter/values.yaml#L120" rel="noopener ugc nofollow" target="_blank">见此处&gt; &gt; &gt; </a>。</p><pre class="ms mt mu mv gt mw lo mx bn my mz bi"><span id="ce24" class="na lq iq lo b be nb nc l nd ne">kubectl -n monitoring get cm prometheus-blackbox-prometheus-blackbox-exporter -o yaml<br/>apiVersion: v1<br/>data:<br/>blackbox.yaml: |<br/>modules:<br/>http_2xx:<br/>http:<br/>follow_redirects: true<br/>preferred_ip_protocol: ip4<br/>valid_http_versions:<br/>- HTTP/1.1<br/>- HTTP/2.0<br/>prober: http<br/>timeout: 5s</span></pre><p id="5eb6" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">实际上，在这里我们可以看到模块，到目前为止只有一个，它使用<code class="fe ll lm ln lo b">http</code>探测器向<code class="fe ll lm ln lo b">targets</code>发出HTTP请求，这仍然需要添加。</p><h2 id="c905" class="nh lq iq bd lr ni nj dn lv nk nl dp lz kj nm nn md kn no np mh kr nq nr ml ns bi translated">黑盒和服务监视器</h2><p id="94e0" class="pw-post-body-paragraph jy jz iq ka b kb mn kd ke kf mo kh ki kj mp kl km kn mq kp kq kr mr kt ku kv ij bi translated">为了添加我们想要监控的端点，我们可以使用ServiceMonitor，请参见此处的配置<a class="ae lf" href="https://github.com/prometheus-community/helm-charts/blob/main/charts/prometheus-blackbox-exporter/values.yaml#L215" rel="noopener ugc nofollow" target="_blank">&gt;&gt;&gt;</a>。</p><p id="8fce" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">出于某种原因，这一时刻在googled指南中没有得到真正的描述，尽管它非常有用和简单:我们向Blackbox配置添加一个目标列表，Blackbox为每个目标创建一个ServiceMonitor，Prometheus开始监视它们。</p><p id="d13a" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">现在创建一个只有一个端点的文件<code class="fe ll lm ln lo b">blackbox-exporter-values.yaml</code>——只是为了检查它是否在工作:</p><pre class="ms mt mu mv gt mw lo nt nu aw nv bi"><span id="46e5" class="nh lq iq lo b gy nw nx l ny ne">serviceMonitor:<br/>  enabled: true<br/>  defaults:<br/>    labels:<br/>      release: prometheus<br/>  targets:<br/>    - name: google.com<br/>      url: <a class="ae lf" href="https://google.com" rel="noopener ugc nofollow" target="_blank">https://google.com</a></span></pre><p id="8ba9" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">如果没有另外指定，Blackbox使用图表中<code class="fe ll lm ln lo b">values.yaml</code>的默认值作为<a class="ae lf" href="https://github.com/prometheus-community/helm-charts/blob/main/charts/prometheus-blackbox-exporter/values.yaml#L233" rel="noopener ugc nofollow" target="_blank">，在这种情况下，将由<code class="fe ll lm ln lo b"><a class="ae lf" href="https://translate.google.com/website?sl=uk&amp;tl=en&amp;hl=en&amp;client=webapp&amp;u=https://github.com/prometheus-community/helm-charts/blob/main/charts/prometheus-blackbox-exporter/values.yaml%23L121" rel="noopener ugc nofollow" target="_blank">http_2xx</a></code>模块执行<code class="fe ll lm ln lo b">GET</code>请求并检查响应代码:如果收到200，则检查通过，如果收到另一个，则检查失败。</a></p><p id="ed28" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">用新配置更新Helm版本:</p><pre class="ms mt mu mv gt mw lo mx bn my mz bi"><span id="a39d" class="na lq iq lo b be nb nc l nd ne">$ helm -n monitoring upgrade — install prometheus-blackbox prometheus-community/prometheus-blackbox-exporter -f blackbox-exporter-values.yaml</span></pre><p id="fdea" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">检查ServiceMonitor是否已创建:</p><pre class="ms mt mu mv gt mw lo mx bn my mz bi"><span id="eb91" class="na lq iq lo b be nb nc l nd ne">kubectl -n monitoring get servicemonitor<br/>NAME AGE<br/>prometheus-blackbox-prometheus-blackbox-exporter-google.com 4m43s</span></pre><p id="86cd" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">检查普罗米修斯目标:</p><figure class="ms mt mu mv gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nz"><img src="../Images/ad60d46899efd3e081a0c35b7741d697.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*dKyB_IQtMKJje-8z.png"/></div></div></figure><p id="3c68" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">对于我们在黑盒配置中指定的每个目标，都会在Prometheus中添加一个单独的抓取作业:</p><figure class="ms mt mu mv gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi oa"><img src="../Images/aaf67f27770a8cffeb5dbfd03f45495e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*0WKozDrnpXHqLw3A.png"/></div></div></figure><p id="ef01" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">并检查黑盒指标:</p><figure class="ms mt mu mv gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi ob"><img src="../Images/95c0079ddd8c4f06da5f1bf3c776bd3c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*GM3RJFGY0KdT40p1.png"/></div></div></figure><p id="f849" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我个人使用的主要度量标准是<code class="fe ll lm ln lo b">probe_success</code>，它实际上告诉我们检查是否通过:</p><figure class="ms mt mu mv gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi oc"><img src="../Images/2c83c272d6d2459e0fb34e6981f43a9c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*G4xC7KFXiG1CBHJZ.png"/></div></div></figure><p id="8782" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">这里，在<code class="fe ll lm ln lo b">target</code>标签中，<code class="fe ll lm ln lo b">metricRelabelings</code>从黑盒配置的<code class="fe ll lm ln lo b">target</code>的<code class="fe ll lm ln lo b">name</code>字段中设置一个值，<code class="fe ll lm ln lo b">instance</code>标签具有URL。</p><h2 id="8d12" class="nh lq iq bd lr ni nj dn lv nk nl dp lz kj nm nn md kn no np mh kr nq nr ml ns bi translated">内部端点监控</h2><p id="0abd" class="pw-post-body-paragraph jy jz iq ka b kb mn kd ke kf mo kh ki kj mp kl km kn mq kp kq kr mr kt ku kv ij bi translated">太好了——我们去了谷歌，它甚至可以工作。</p><p id="6ab2" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">如何检查集群中的端点？</p><p id="edf5" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">让我们以Kubernetes文档中的nginx 为例，只是将它的Pod和服务部署到我们自己的名称空间，而不是<code class="fe ll lm ln lo b">default</code>。</p><p id="3ffc" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">创建名称空间:</p><pre class="ms mt mu mv gt mw lo mx bn my mz bi"><span id="b0d5" class="na lq iq lo b be nb nc l nd ne">$ kubectl create ns test-ns<br/>namespace/test-ns created</span></pre><p id="2bfa" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">使用Pod和服务创建一个清单，添加您的<code class="fe ll lm ln lo b">namespace</code>:</p><pre class="ms mt mu mv gt mw lo nt nu aw nv bi"><span id="09f1" class="nh lq iq lo b gy nw nx l ny ne">apiVersion: v1<br/>kind: Pod<br/>metadata:<br/>  name: nginx<br/>  namespace: test-ns<br/>  labels:<br/>    app.kubernetes.io/name: proxy<br/>spec:<br/>  containers:<br/>  - name: nginx<br/>    image: nginx:stable<br/>    ports:<br/>      - containerPort: 80<br/>        name: http-web-svc<br/>---<br/>apiVersion: v1<br/>kind: Service<br/>metadata:<br/>  name: nginx-service<br/>  namespace: test-ns<br/>spec:<br/>  selector:<br/>    app.kubernetes.io/name: proxy<br/>  ports:<br/>  - name: name-of-service-port<br/>    protocol: TCP<br/>    port: 80<br/>    targetPort: http-web-svc</span></pre><p id="3080" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">部署它:</p><pre class="ms mt mu mv gt mw lo mx bn my mz bi"><span id="d942" class="na lq iq lo b be nb nc l nd ne">$ kubectl apply -f testpod-with-svc.yaml<br/>pod/nginx created<br/>service/nginx-service created</span></pre><p id="aafa" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">查看资源:</p><pre class="ms mt mu mv gt mw lo mx bn my mz bi"><span id="0e6c" class="na lq iq lo b be nb nc l nd ne">% kubectl -n test-ns get all<br/>NAME READY STATUS RESTARTS AGE<br/>pod/nginx 1/1 Running 0 23s<br/>NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE<br/>service/nginx-service ClusterIP 10.106.58.247 &lt;none&gt; 80/TCP 23s</span></pre><p id="3ca2" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">更新黑盒配置:</p><pre class="ms mt mu mv gt mw lo nt nu aw nv bi"><span id="d8d5" class="nh lq iq lo b gy nw nx l ny ne">serviceMonitor:<br/>  enabled: true<br/>  defaults:<br/>    labels:<br/>      release: prometheus<br/>  targets:<br/>    - name: google.com<br/>      url: <a class="ae lf" href="https://google.com" rel="noopener ugc nofollow" target="_blank">https://google.com</a><br/>    - name: nginx-test<br/>      url: nginx-service.test-ns.svc.cluster.local:80</span></pre><p id="dd78" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">更新头盔版本:</p><pre class="ms mt mu mv gt mw lo mx bn my mz bi"><span id="6fee" class="na lq iq lo b be nb nc l nd ne">$ helm -n monitoring upgrade — install prometheus-blackbox prometheus-community/prometheus-blackbox-exporter -f blackbox-exporter-values.yaml</span></pre><p id="63a1" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">再次检查服务监视器:</p><pre class="ms mt mu mv gt mw lo mx bn my mz bi"><span id="a8e6" class="na lq iq lo b be nb nc l nd ne">$ kubectl -n monitoring get servicemonitor<br/>NAME AGE<br/>prometheus-blackbox-prometheus-blackbox-exporter-google.com 12m<br/>prometheus-blackbox-prometheus-blackbox-exporter-nginx-test 5s</span></pre><p id="2868" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">一会儿我们可以检查一下<code class="fe ll lm ln lo b">probe_success</code>:</p><figure class="ms mt mu mv gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi od"><img src="../Images/e226d1dcb38e20baaddc29053d41444e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*JxSFXsOcRSV5lIXq.png"/></div></div></figure><p id="c202" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">一般来说，没有必要以<code class="fe ll lm ln lo b">nginx-service.test-ns.svc.cluster.local</code>的形式指定完整的URL——像<em class="nf"> servicename.namespace </em>那样设置就足够了，也就是说<code class="fe ll lm ln lo b">nginx-service.test-ns</code>，但是完整的URL，在我看来，在标签和提醒中看起来更有用。</p><h2 id="bc37" class="nh lq iq bd lr ni nj dn lv nk nl dp lz kj nm nn md kn no np mh kr nq nr ml ns bi translated">黑盒导出器模块</h2><p id="c76b" class="pw-post-body-paragraph jy jz iq ka b kb mn kd ke kf mo kh ki kj mp kl km kn mq kp kq kr mr kt ku kv ij bi translated">一切看起来都很好，直到我们轮询一个总是返回200代码的公共HTTP端点。</p><p id="4900" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">但是我们如何检查其他HTTP代码呢？</p><p id="06db" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">让我们使用黑盒探针创建自己的模块:</p><pre class="ms mt mu mv gt mw lo nt nu aw nv bi"><span id="7fba" class="nh lq iq lo b gy nw nx l ny ne">config:<br/>  modules:<br/>    http_4xx:<br/>      prober: http<br/>      timeout: 5s<br/>      http:<br/>        method: GET<br/>        valid_status_codes: [404, 405]<br/>        valid_http_versions: ["HTTP/1.1", "HTTP/2.0"]<br/>        follow_redirects: true<br/>        preferred_ip_protocol: "ip4"<br/>serviceMonitor:<br/>  enabled: true<br/>  defaults:<br/>    labels:<br/>      release: prometheus<br/>  targets:<br/>    - name: google.com<br/>      url: <a class="ae lf" href="https://google.com" rel="noopener ugc nofollow" target="_blank">https://google.com</a><br/>    - name: nginx-test<br/>      url: nginx-service.test-ns.svc.cluster.local:80<br/>    - name: nginx-test-404<br/>      url: nginx-service.test-ns.svc.cluster.local:80/404<br/>      module: http_4xx</span></pre><p id="2af5" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在这里的<code class="fe ll lm ln lo b">modules</code>中，我们指定新模块的名称- <em class="nf"> http_4xx </em>，它应该使用哪个探测器-<code class="fe ll lm ln lo b">http</code>，以及这个探测器的参数-使用哪种请求，以及我们认为正确的响应代码。</p><p id="d6d3" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">接下来，在<em class="nf"> nginx-test-404的目标中，</em>我们明确指定了模块<code class="fe ll lm ln lo b">http_4xx</code>的使用。</p><h2 id="4c5a" class="nh lq iq bd lr ni nj dn lv nk nl dp lz kj nm nn md kn no np mh kr nq nr ml ns bi translated">模块测试</h2><p id="2edb" class="pw-post-body-paragraph jy jz iq ka b kb mn kd ke kf mo kh ki kj mp kl km kn mq kp kq kr mr kt ku kv ij bi translated">让我们看看如何检查模块是否如我们预期的那样工作。</p><p id="cf0b" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">一切都很简单:运行一个测试盒，使用带有<code class="fe ll lm ln lo b">-I</code>选项的<code class="fe ll lm ln lo b">curl</code>来检查端点的响应。</p><p id="66b6" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">对于TCP连接，您可以使用<code class="fe ll lm ln lo b">telnet</code>。</p><p id="7743" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">因此，用Ubuntu创建一个Pod，并通过运行<code class="fe ll lm ln lo b">bash</code>连接到它:</p><pre class="ms mt mu mv gt mw lo mx bn my mz bi"><span id="49fa" class="na lq iq lo b be nb nc l nd ne">$ kubectl -n monitoring run pod — rm -i — tty — image ubuntu — bash</span></pre><p id="fd19" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">安装<code class="fe ll lm ln lo b">curl</code>和<code class="fe ll lm ln lo b">telnet</code>:</p><pre class="ms mt mu mv gt mw lo mx bn my mz bi"><span id="c9db" class="na lq iq lo b be nb nc l nd ne">root@pod:/# apt update &amp;&amp; apt -y install curl telnet</span></pre><p id="de16" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">并检查<em class="nf">nginx-service.test-ns.svc.cluster.local:80/404</em>是否工作，以及它将返回哪个响应代码:</p><pre class="ms mt mu mv gt mw lo mx bn my mz bi"><span id="4f0c" class="na lq iq lo b be nb nc l nd ne">root@pod:/# curl -I nginx-service.test-ns.svc.cluster.local:80/404<br/>HTTP/1.1 404 Not Found<br/>404 — as we expected.</span></pre><p id="fcef" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">用新配置更新黑盒:</p><pre class="ms mt mu mv gt mw lo mx bn my mz bi"><span id="42c0" class="na lq iq lo b be nb nc l nd ne">$ helm -n monitoring upgrade — install prometheus-blackbox prometheus-community/prometheus-blackbox-exporter -f blackbox-exporter-values.yaml</span></pre><p id="3607" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">让我们检查它的配置图—我们在配置文件中指定的模块<code class="fe ll lm ln lo b">http_4xx</code>是否已被添加:</p><pre class="ms mt mu mv gt mw lo mx bn my mz bi"><span id="fb19" class="na lq iq lo b be nb nc l nd ne">$ kubectl -n monitoring get cm prometheus-blackbox-prometheus-blackbox-exporter -o yaml<br/>apiVersion: v1<br/>data:<br/>blackbox.yaml: |<br/>modules:<br/>http_2xx:<br/>http:<br/>follow_redirects: true<br/>preferred_ip_protocol: ip4<br/>valid_http_versions:<br/>- HTTP/1.1<br/>- HTTP/2.0<br/>prober: http<br/>timeout: 5s<br/>http_4xx:<br/>http:<br/>follow_redirects: true<br/>method: GET<br/>preferred_ip_protocol: ip4<br/>valid_http_versions:<br/>- HTTP/1.1<br/>- HTTP/2.0<br/>valid_status_codes:<br/>- 404<br/>- 405<br/>prober: http<br/>timeout: 5s</span></pre><p id="6418" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">并在普罗米修斯中检查结果:</p><figure class="ms mt mu mv gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi oe"><img src="../Images/bc52c37d86e51cf8fba33116eeea7447.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*4kDsItaLsmfbJ51b.png"/></div></div></figure><p id="8f80" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><code class="fe ll lm ln lo b">probe_success{target="nginx-test-404"} == 1</code>——“管用！”(三)</p><h2 id="12ef" class="nh lq iq bd lr ni nj dn lv nk nl dp lz kj nm nn md kn no np mh kr nq nr ml ns bi translated">TCP连接和数据库服务器监控</h2><p id="f132" class="pw-post-body-paragraph jy jz iq ka b kb mn kd ke kf mo kh ki kj mp kl km kn mq kp kq kr mr kt ku kv ij bi translated">我们经常使用的另一个模块是TCP，它只是试图打开一个到指定URL和端口的TCP连接。适用于检查数据库和任何其他非HTTP资源。</p><p id="5172" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">让我们启动一个MySQL服务器:</p><pre class="ms mt mu mv gt mw lo mx bn my mz bi"><span id="4954" class="na lq iq lo b be nb nc l nd ne">$ helm repo add bitnami https://charts.bitnami.com/bitnami<br/>helm install mysql bitnami/mysql</span></pre><p id="f54a" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">找到它的服务:</p><pre class="ms mt mu mv gt mw lo mx bn my mz bi"><span id="9ce1" class="na lq iq lo b be nb nc l nd ne">$ kubectl get svc<br/>NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE<br/>kubernetes ClusterIP 10.96.0.1 &lt;none&gt; 443/TCP 20h<br/>mysql ClusterIP 10.99.71.124 &lt;none&gt; 3306/TCP 40s<br/>mysql-headless ClusterIP None &lt;none&gt; 3306/TCP 40s</span></pre><p id="a321" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">更新黑盒配置:</p><pre class="ms mt mu mv gt mw lo nt nu aw nv bi"><span id="a910" class="nh lq iq lo b gy nw nx l ny ne">config:<br/>  modules:<br/>    ...<br/>    tcp_connect:<br/>      prober: tcp<br/>serviceMonitor:<br/>  ...<br/>  targets:<br/>    ...<br/>    - name: mysql<br/>      url: mysql.default.svc.cluster.local:3306<br/>      module: tcp_connect</span></pre><p id="fb03" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">部署和检查:</p><figure class="ms mt mu mv gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi of"><img src="../Images/8f867952200b643571b7ebf36157f580.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*6OQOZxyZ5qVfWTVH.png"/></div></div></figure><h2 id="420f" class="nh lq iq bd lr ni nj dn lv nk nl dp lz kj nm nn md kn no np mh kr nq nr ml ns bi translated">普罗米修斯警报</h2><p id="0c2e" class="pw-post-body-paragraph jy jz iq ka b kb mn kd ke kf mo kh ki kj mp kl km kn mq kp kq kr mr kt ku kv ij bi translated">关于警报没有什么特别要写的—一切都像任何其他普罗米修斯警报一样是标准的。</p><p id="d29b" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">例如，我们用下面的警报监视<a class="ae lf" href="https://rtfm.co.ua/en/apache-druid-overview-running-in-kubernetes-and-monitoring-with-prometheus/" rel="noopener ugc nofollow" target="_blank"> Apache Druid </a>服务(来自一个带有一些变量的Terraform配置的屏幕):</p><figure class="ms mt mu mv gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi og"><img src="../Images/2e1b767202d343df3cfd5d0d768085ce.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*7WFy3OtS4zR8xsNf.png"/></div></div></figure><p id="39b9" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">只要检查一下<code class="fe ll lm ln lo b">probe_success != 1</code>。</p><h1 id="959f" class="lp lq iq bd lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm bi translated">有用的链接</h1><ul class=""><li id="4cb7" class="kw kx iq ka b kb mn kf mo kj oh kn oi kr oj kv lb lc ld le bi translated"><a class="ae lf" href="https://lyz-code.github.io/blue-book/devops/prometheus/blackbox_exporter/#blackbox-exporter-probes" rel="noopener ugc nofollow" target="_blank">黑盒导出器探针</a> —更多探针示例</li></ul></div><div class="ab cl ok ol hu om" role="separator"><span class="on bw bk oo op oq"/><span class="on bw bk oo op oq"/><span class="on bw bk oo op"/></div><div class="ij ik il im in"><p id="390c" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><em class="nf">最初发布于</em> <a class="ae lf" href="https://rtfm.co.ua/en/prometheus-kubernetes-endpoints-monitoring-with-blackbox-exporter/" rel="noopener ugc nofollow" target="_blank"> <em class="nf"> RTFM: Linux、DevOps、系统管理</em> </a> <em class="nf">。</em></p></div></div>    
</body>
</html>