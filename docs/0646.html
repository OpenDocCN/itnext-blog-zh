<html>
<head>
<title>Use Helm to Install OpenVPN in Kubernetes to access pods and services</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Helm在Kubernetes中安装OpenVPN以访问pods和服务</h1>
<blockquote>原文：<a href="https://itnext.io/use-helm-to-deploy-openvpn-in-kubernetes-to-access-pods-and-services-217dec344f13?source=collection_archive---------0-----------------------#2018-04-28">https://itnext.io/use-helm-to-deploy-openvpn-in-kubernetes-to-access-pods-and-services-217dec344f13?source=collection_archive---------0-----------------------#2018-04-28</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><p id="8a5e" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">在开发过程中，访问Kubernetes集群中的应用程序(pods)而不创建外部(公共)端点是很有用的。这可以通过使用OpenVPN来实现。我们将使用Kubernetes包管理器Helm在我们的Kubernetes环境中安装OpenVPN。</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi ko"><img src="../Images/8b0a396e8521feb8c3486931a86cf594.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*VtshSOsifbo3UgtUbnSuyQ.png"/></div></div></figure><p id="3846" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><em class="la">本教程在</em> <a class="ae lb" href="https://cloud.google.com/free/" rel="noopener ugc nofollow" target="_blank"> <em class="la"> Google Cloud上执行，Google Cloud提供300美元免费积分</em> </a> <em class="la">以开始使用任何GCP产品。</em></p><h1 id="7cf5" class="lc ld it bd le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz bi translated">先决条件</h1><ul class=""><li id="23a3" class="ma mb it js b jt mc jx md kb me kf mf kj mg kn mh mi mj mk bi translated"><a class="ae lb" href="https://kubernetes.io/docs/tasks/tools/install-kubectl/#install-kubectl" rel="noopener ugc nofollow" target="_blank">安装kubectl </a></li><li id="e8d4" class="ma mb it js b jt ml jx mm kb mn kf mo kj mp kn mh mi mj mk bi translated"><a class="ae lb" href="https://github.com/kubernetes/helm/blob/master/docs/install.md" rel="noopener ugc nofollow" target="_blank">安装舵</a></li><li id="fdd3" class="ma mb it js b jt ml jx mm kb mn kf mo kj mp kn mh mi mj mk bi translated"><a class="ae lb" href="https://cloud.google.com/sdk/downloads" rel="noopener ugc nofollow" target="_blank">安装gcloud SDK </a>(如果你用的是谷歌云)</li><li id="fd01" class="ma mb it js b jt ml jx mm kb mn kf mo kj mp kn mh mi mj mk bi translated">创建一个谷歌云帐户(如果你正在使用谷歌云)</li><li id="d949" class="ma mb it js b jt ml jx mm kb mn kf mo kj mp kn mh mi mj mk bi translated">控制台中的链接计费帐户(如果您使用谷歌云免费层)</li></ul><h1 id="30e2" class="lc ld it bd le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz bi translated"><strong class="ak">设置Kubernetes </strong></h1><p id="6c39" class="pw-post-body-paragraph jq jr it js b jt mc jv jw jx md jz ka kb mq kd ke kf mr kh ki kj ms kl km kn im bi translated">我将解释如何在GCP建立Kubernetes。如果您已经有一个完整的Kubernetes集群，您可以跳过这些步骤。</p><p id="8419" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">官方Google Cloud文档<a class="ae lb" href="https://cloud.google.com/sdk/gcloud/reference/container/clusters/create" rel="noopener ugc nofollow" target="_blank">解释了如何创建一个比我下面解释的更高级的集群，但是这已经超出了范围。</a></p><pre class="kp kq kr ks gt mt mu mv mw aw mx bi"><span id="6210" class="my ld it mu b gy mz na l nb nc"># Configure your cli to connect with your Google Cloud account<br/>$ gcloud init</span><span id="37f4" class="my ld it mu b gy nd na l nb nc"># List project<br/>$ gcloud projects list<br/>PROJECT_ID          NAME                PROJECT_NUMBER<br/>openvpn-kubernetes  openvpn-kubernetes  xxx</span><span id="1141" class="my ld it mu b gy nd na l nb nc"># Create a basic cluster inside your project and desired region<br/>$ gcloud container clusters create cluster-1 --zone europe-west1-b --project openvpn-kubernetes</span></pre><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi ne"><img src="../Images/81f5a14f7c267ab708030c7f4babdbc7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*-VIUhNAjeQnXnuWNamQ7fQ.png"/></div></div></figure><p id="9841" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">等待几分钟，直到集群启动并运行！然后点击“Connect”获取配置<a class="ae lb" href="http://kubernetes.io/docs/user-guide/kubectl-overview/" rel="noopener ugc nofollow" target="_blank"> kubectl </a> CLI访问所必需的命令。</p><pre class="kp kq kr ks gt mt mu mv mw aw mx bi"><span id="720c" class="my ld it mu b gy mz na l nb nc">$ gcloud container clusters get-credentials cluster-1 --zone europe-west1-b --project openvpn-kubernetes</span></pre><p id="ac85" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">现在我们已经可以检查IP范围了。你可能会看到不同的价值观。</p><pre class="kp kq kr ks gt mt mu mv mw aw mx bi"><span id="3fbc" class="my ld it mu b gy mz na l nb nc">$ gcloud container clusters describe cluster-1 --zone europe-west1-b</span></pre><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi nf"><img src="../Images/4efc6090709ff743a3e3fa8b8fb82bc9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*-c387A2WvaIoeSNlzUxE8w.png"/></div></div></figure><p id="fa05" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">让我们牢记这些价值观。<br/>现在我们将配置Kubernetes仪表板访问。</p><h1 id="e9e2" class="lc ld it bd le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz bi translated">配置Kubernetes仪表板访问</h1><p id="8ce4" class="pw-post-body-paragraph jq jr it js b jt mc jv jw jx md jz ka kb mq kd ke kf mr kh ki kj ms kl km kn im bi translated">我们将创建一个ServiceAccount作为访问仪表板的变通方法。<br/>这个在<a class="ae lb" href="https://blog.heptio.com/on-securing-the-kubernetes-dashboard-16b09b1b7aca" rel="noopener ugc nofollow" target="_blank">这个博客</a>里有很详细的解释。这是对ServiceAccount机制的轻微滥用。</p><pre class="kp kq kr ks gt mt mu mv mw aw mx bi"><span id="935f" class="my ld it mu b gy mz na l nb nc"># Create ServiceAccount<br/>$ kubectl create serviceaccount my-dashboard-sa</span><span id="4057" class="my ld it mu b gy nd na l nb nc"># Create role binding<br/>$ kubectl create clusterrolebinding my-dashboard-sa \<br/>  --clusterrole=cluster-admin \<br/>  --serviceaccount=default:my-dashboard-sa</span><span id="548b" class="my ld it mu b gy nd na l nb nc"># Get the secret<br/>$ kubectl get secrets</span><span id="32f5" class="my ld it mu b gy nd na l nb nc"># Describe the my-dashboard-sa-token-xxx<br/># Copy the token<br/>$ kubectl describe secret my-dashboard-sa-token-xxx</span><span id="fc46" class="my ld it mu b gy nd na l nb nc"># Open the kubectl proxy to visit the dashboard<br/>$ kubectl proxy</span></pre><p id="2e66" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">现在我们可以访问<a class="ae lb" href="http://127.0.0.1:8001/ui" rel="noopener ugc nofollow" target="_blank">http://127 . 0 . 0 . 1:8001/ui</a>上的仪表盘。<br/>粘贴您之前复制的令牌:</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi ng"><img src="../Images/615e974a5f1f85e94ef8b3f8cc6680dd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*aG1uf8_p2Yu1SG6KVGgilA.png"/></div></div></figure><p id="2d9c" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">访问Kubernetes仪表板:</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi nh"><img src="../Images/a7e078292096502f234f99e94e735b2f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*3VhzEtLFoZ8QT2JSnIrB8Q.png"/></div></div></figure><h1 id="2937" class="lc ld it bd le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz bi translated">部署一个基本的示例应用程序</h1><p id="6583" class="pw-post-body-paragraph jq jr it js b jt mc jv jw jx md jz ka kb mq kd ke kf mr kh ki kj ms kl km kn im bi translated">我们将在名为“sample-app”的名称空间中部署一个非常基本的示例应用程序。该部署将包含2个运行web服务器(Nginx)的pod。我们将在上面创建一个服务，它将作为pod上面的负载平衡器。当服务是不朽的并且服务IP永远不会改变时，pod可以下降和上升，这可以导致不同的pod IP。</p><p id="a76e" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">有三种重要的服务类型:</p><ul class=""><li id="073a" class="ma mb it js b jt ju jx jy kb ni kf nj kj nk kn mh mi mj mk bi translated"><code class="fe nl nm nn mu b">ClusterIP</code>:在<strong class="js iu">集群内部IP </strong>上公开服务。选择该值将使服务只能从集群内部访问。这是默认的<code class="fe nl nm nn mu b">ServiceType</code>。</li><li id="9c5e" class="ma mb it js b jt ml jx mm kb mn kf mo kj mp kn mh mi mj mk bi translated"><code class="fe nl nm nn mu b">NodePort</code>:在一个静态端口(T3)公开每个节点IP上的服务。一个<code class="fe nl nm nn mu b">NodePort</code>服务将路由到的<code class="fe nl nm nn mu b">ClusterIP</code>服务被自动创建。通过请求<code class="fe nl nm nn mu b">&lt;NodeIP&gt;:&lt;NodePort&gt;</code>，您将能够从集群外部联系<code class="fe nl nm nn mu b">NodePort</code>服务<strong class="js iu">。</strong></li><li id="da5e" class="ma mb it js b jt ml jx mm kb mn kf mo kj mp kn mh mi mj mk bi translated"><code class="fe nl nm nn mu b">LoadBalancer</code>:使用云提供商的负载均衡器对外公开服务<strong class="js iu"/>。</li></ul><p id="8d84" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">我们不想公开我们的服务。我们将创建一个类型为<code class="fe nl nm nn mu b">ClusterIP</code>的服务。<code class="fe nl nm nn mu b">ClusterIP</code>将在<code class="fe nl nm nn mu b">servicesIpv4Cidr</code>的范围内。</p><pre class="kp kq kr ks gt mt mu mv mw aw mx bi"><span id="f918" class="my ld it mu b gy mz na l nb nc"># Create namespace for sample app<br/>$ kubectl create ns sample-app</span><span id="29f3" class="my ld it mu b gy nd na l nb nc"># Create a deployment object and an associated ReplicaSet object. <br/># The ReplicaSet has 2 pods.<br/>$ kubectl run my-nginx --image=nginx --replicas=2 --port=80 --namespace=sample-app</span><span id="a642" class="my ld it mu b gy nd na l nb nc"># Create a Service object of type ClusterIP that exposes the deployment:<br/>$ kubectl expose deployment my-nginx --namespace=sample-app <!-- -->--type=ClusterIP</span></pre><p id="b546" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">通过检查仪表板进行验证:</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi no"><img src="../Images/9c92ac2998e11fcf3f223401b24ffa2e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*W-d9n5X2UUfbDBO1IDoyLA.png"/></div></div><figcaption class="np nq gj gh gi nr ns bd b be z dk translated">两个吊舱正在运行</figcaption></figure><p id="4ad2" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">检查服务。没有外部端点(公共IP ),它是在预期范围内创建的。</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi nt"><img src="../Images/7a9f3f0e61616d1b86d331def0d9b795.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*FiygWNOMaBbvJ9JZX0jlow.png"/></div></div><figcaption class="np nq gj gh gi nr ns bd b be z dk translated">该服务仅在集群内部可用。</figcaption></figure><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi nu"><img src="../Images/c3df06293df85d43c23c1cc2e8cde3d1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ebgoEskBqedGFKHfgQbybA.png"/></div></div><figcaption class="np nq gj gh gi nr ns bd b be z dk translated">此方案总结了设置(忽略kube-proxy)</figcaption></figure><p id="95fd" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">我们如何在不定义外部端点(公共IP)的情况下访问我们的pod？这里我们将使用OpenVPN。我们将使用Helm在我们的集群中安装OpenVPN并与之连接。它将通过VPN将所有网络流量路由到kubernetes pods和服务。这将使我们能够在浏览器中访问Nginx服务的<code class="fe nl nm nn mu b">ClusterIP</code>!</p><h1 id="c9de" class="lc ld it bd le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz bi translated">准备持久存储</h1><p id="158d" class="pw-post-body-paragraph jq jr it js b jt mc jv jw jx md jz ka kb mq kd ke kf mr kh ki kj ms kl km kn im bi translated">我们将为我们的OpenVPN pod准备持久存储，因为我们不想在pod再次缩小和放大时丢失数据。每次部署都会生成新证书。如果启用了持久性，证书数据将在pod重新启动后保持不变。否则，每次部署或pod重启后，都需要新的客户端证书。</p><p id="9e84" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">我会在谷歌云平台准备存储。<br/>打开一个新的终端:</p><pre class="kp kq kr ks gt mt mu mv mw aw mx bi"><span id="823f" class="my ld it mu b gy mz na l nb nc"># Create disk<br/>$ gcloud compute disks create --size 1GB openvpn-disk --zone europe-west1-b</span></pre><p id="407a" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">创建我们的Kubernetes名称空间，我们将在其中部署OpenVPN pod。</p><pre class="kp kq kr ks gt mt mu mv mw aw mx bi"><span id="1143" class="my ld it mu b gy mz na l nb nc"># Create namespace<br/>$ kubectl create ns openvpn</span></pre><p id="3c60" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">为持久卷声明编写一个模板:<code class="fe nl nm nn mu b">openvpn-pv-claim.yaml</code>。<br/>这将认领谷歌云存储。这个索赔叫做<code class="fe nl nm nn mu b">openvpn-data-claim</code>。</p><figure class="kp kq kr ks gt kt"><div class="bz fp l di"><div class="nv nw l"/></div></figure><p id="1c7e" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">创建索赔:</p><pre class="kp kq kr ks gt mt mu mv mw aw mx bi"><span id="fbbc" class="my ld it mu b gy mz na l nb nc"># Create disk<br/>$ kubectl create -f openvpn-pv-claim.yaml</span></pre><p id="ef7b" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">我们可以在仪表板上验证。不要忘记选择正确的名称空间。</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi nx"><img src="../Images/d1926acde0879952daa3e1ebadd2f5d4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*E5maAjOFrC-XgLrab_lJnQ.png"/></div></div></figure><h1 id="e89e" class="lc ld it bd le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz bi translated">配置Helm并安装OpenVPN</h1><p id="e2b7" class="pw-post-body-paragraph jq jr it js b jt mc jv jw jx md jz ka kb mq kd ke kf mr kh ki kj ms kl km kn im bi translated">Helm是Kubernetes的包装经理。它由两部分组成:客户端(<em class="la"> helm </em>)和服务器(<em class="la"> tiller </em> ) Tiller运行在您的Kubernetes集群中。</p><pre class="kp kq kr ks gt mt mu mv mw aw mx bi"><span id="ca5e" class="my ld it mu b gy mz na l nb nc"># Create ServiceAccount<br/>$ kubectl create serviceaccount --namespace kube-system tiller</span><span id="a0a9" class="my ld it mu b gy nd na l nb nc"># add cluster role cluster-admin to ServiceAccount<br/>$ kubectl create clusterrolebinding tiller-cluster-rule --clusterrole=cluster-admin --serviceaccount=kube-system:tiller</span><span id="cbe4" class="my ld it mu b gy nd na l nb nc"># Install tiller in Kubernetes<br/>$ helm init --service-account tiller</span></pre><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi ny"><img src="../Images/e6b4aa1c1e9f9974c84f06b05c8089cc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*4TxJdBrNCb1SNCScAmfJZQ.png"/></div></div></figure><p id="816f" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">现在我们将使用<a class="ae lb" href="https://github.com/kubernetes/charts/tree/master/stable/openvpn" rel="noopener ugc nofollow" target="_blank">舵图来安装OpenVPN </a>。这里我们需要写一个包含我们配置的<code class="fe nl nm nn mu b">values.yaml</code>。它基于来自<a class="ae lb" href="https://github.com/kubernetes/charts/blob/master/stable/openvpn/values.yaml" rel="noopener ugc nofollow" target="_blank"> GitHub库</a>的<code class="fe nl nm nn mu b">values.yaml</code>。</p><pre class="kp kq kr ks gt mt mu mv mw aw mx bi"><span id="a3a9" class="my ld it mu b gy mz na l nb nc">$ mkdir helm-openvpn/<br/>$ cd helm-openvpn/<br/>$ vi values.yaml</span></pre><p id="c476" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">添加以下值。定义你的<code class="fe nl nm nn mu b">OVPN_K8S_POD_NETWORK</code>:</p><figure class="kp kq kr ks gt kt"><div class="bz fp l di"><div class="nv nw l"/></div></figure><p id="ff62" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">开始安装舵。我们将指向我们的<code class="fe nl nm nn mu b">values.yaml</code>并参考图表<code class="fe nl nm nn mu b">stable/openvpn</code>。</p><pre class="kp kq kr ks gt mt mu mv mw aw mx bi"><span id="0644" class="my ld it mu b gy mz na l nb nc">$ helm install --name openvpn -f values.yaml stable/openvpn --namespace openvpn</span></pre><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi nz"><img src="../Images/fc87d4c6adfd733e9f64f3ecbcd9f3c0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*BXB9aZvw3rWRtxedudEZ1g.png"/></div></div></figure><p id="c495" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">这可能需要一些时间，因为在部署过程中需要提取Docker映像。</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi oa"><img src="../Images/c9c6cf057f599d42cefea261b74a0cbb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*AlfGkle8938NQ8jGpANAgQ.png"/></div></div></figure><p id="efe7" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">访问仪表板以检查OpenVPN pod是否已启动并正在运行:</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi ob"><img src="../Images/bf71ea447e9e0be8ab7cb5cccd8df97e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*NhBnPt5avqRcqLCJkjpRyg.png"/></div></div></figure><p id="7d9a" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">在<code class="fe nl nm nn mu b">helm install</code>之后，会弹出一些命令。需要执行这些命令来创建OpenVPN证书。通过打印环境变量的内容进行验证。</p><pre class="kp kq kr ks gt mt mu mv mw aw mx bi"><span id="e50b" class="my ld it mu b gy mz na l nb nc"># execute each line separately<br/># Get pod name<br/>$ POD_NAME=$(kubectl get pods --namespace openvpn -l type=openvpn -o jsonpath='{ .items[0].metadata.name }')<br/>$ echo $POD_NAME</span><span id="dc7c" class="my ld it mu b gy nd na l nb nc"># Get Service name<br/>$ SERVICE_NAME=$(kubectl get svc --namespace openvpn -l type=openvpn  -o jsonpath='{ .items[0].metadata.name }')<br/>$ echo $SERVICE_NAME</span><span id="0aca" class="my ld it mu b gy nd na l nb nc"># Get Service IP (this can take a while, wait till deployment is finished)<br/>$ SERVICE_IP=$(kubectl get svc --namespace openvpn $SERVICE_NAME -o go-template='{{ range $k, $v := (index .status.loadBalancer.ingress 0)}}{{ $v }}{{end}}')<br/>$ echo $SERVICE_IP</span><span id="f6f4" class="my ld it mu b gy nd na l nb nc"># Define key name (different for each key!)<br/>$ KEY_NAME=kubeVPN<br/>$ echo $KEY_NAME</span></pre><p id="0610" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">如果变量的输出包含正确的值，您可以开始创建<code class="fe nl nm nn mu b">kubeVPN.ovpn</code>。</p><pre class="kp kq kr ks gt mt mu mv mw aw mx bi"><span id="bfda" class="my ld it mu b gy mz na l nb nc">$ kubectl --namespace openvpn exec -it $POD_NAME /etc/openvpn/setup/newClientCert.sh $KEY_NAME $SERVICE_IP<br/>$ kubectl --namespace openvpn exec -it $POD_NAME cat /etc/openvpn/certs/pki/$KEY_NAME.ovpn &gt; $KEY_NAME.ovpn</span></pre><p id="c395" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">一个<code class="fe nl nm nn mu b">kubeVPN.ovpn</code>文件被创建！</p><p id="86a7" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">该文件也存储在OpenVPN pod中。这个吊舱是持久的，所以不应该害怕失去<code class="fe nl nm nn mu b">kubeVPN.ovpn</code>。<br/>在安装和配置我们的VPN客户端之前，我们将停止<code class="fe nl nm nn mu b">kubectl proxy</code>命令。成功连接VPN以访问您的仪表板后，再次执行该操作。</p><h1 id="f7eb" class="lc ld it bd le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz bi translated">配置VPN客户端</h1><p id="2644" class="pw-post-body-paragraph jq jr it js b jt mc jv jw jx md jz ka kb mq kd ke kf mr kh ki kj ms kl km kn im bi translated">现在我们需要安装一个VPN客户端。Windows用户可以安装<a class="ae lb" href="https://openvpn.net/index.php/open-source/downloads.html" rel="noopener ugc nofollow" target="_blank"> OpenVPN客户端</a>。对于OSX用户来说，Tunnelblick是一个不错的选择。拖动。tunne中的ovpn文件单击并单击连接:</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi oc"><img src="../Images/14ae31e74c7861deb66e782470b2363c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*h6NoGg93l8aRa9M1E7jTYQ.png"/></div></div></figure><p id="fea2" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">现在我们连在一起了。让我们检查一下<code class="fe nl nm nn mu b">ifconfig</code>的输出。</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi od"><img src="../Images/34f1a31c9c736d29bde7abb35534a90a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*VSqgHV3sZiQdxlYlPxznvQ.png"/></div></div></figure><p id="d8ed" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">在<code class="fe nl nm nn mu b">helm install</code>期间，我收到了一个在<code class="fe nl nm nn mu b">values.yaml</code>内定义的范围内的IP。</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi oe"><img src="../Images/685839d1dfe8efd9b66c07d40ce00b3a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*4zLRVsnmhKxYhQjI_hL4sg.png"/></div></div></figure><p id="490e" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">让我们回到我们在示例应用程序中创建的Nginx服务:</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi nt"><img src="../Images/7a9f3f0e61616d1b86d331def0d9b795.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*FiygWNOMaBbvJ9JZX0jlow.png"/></div></div></figure><p id="0eb8" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">复制<code class="fe nl nm nn mu b">ClusterIP</code>并粘贴到你的浏览器中。现在，您在两个pod之间实现了“负载平衡”。</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi of"><img src="../Images/6ac4c57fc44f0eedd74e8df4722e4ad5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*DjYcvFtXD_VS-RznwmY_EQ.png"/></div></div></figure><p id="7382" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">您也可以不使用服务，而是通过连接到pod IP来访问您的pod。</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi og"><img src="../Images/2d8d278c48669debf099d1123b9dccc0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*HzOqJA6z27l1ygySHvdLvA.png"/></div></div></figure><h1 id="bc9a" class="lc ld it bd le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz bi translated">结论</h1><p id="e6e6" class="pw-post-body-paragraph jq jr it js b jt mc jv jw jx md jz ka kb mq kd ke kf mr kh ki kj ms kl km kn im bi translated">有用！我们可以在浏览器中访问类型为<code class="fe nl nm nn mu b">ClusterIP</code>的服务。<br/>记住关于这类服务的解释:<em class="la">“选择这个值</em> <code class="fe nl nm nn mu b"><em class="la">(ClusterIP)</em></code> <em class="la">使得服务只能从集群内部到达”。</em></p><p id="a8e0" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">通过使用OpenVPN，我们能够在浏览器中访问服务，而无需使用外部端点！我们甚至可以忽略服务，直接访问我们的pod。当您从VPN断开连接时，将无法再访问服务或pods。</p><p id="b4b0" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">希望你喜欢它！</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><a href="https://www.buymeacoffee.com/dZb8fLN"><div class="gh gi oh"><img src="../Images/83dc7212ef8502659c81086ad58b8d96.png" data-original-src="https://miro.medium.com/v2/resize:fit:340/format:webp/1*bk_C8Um34KavCkO2yzMCZg.png"/></div></a><figcaption class="np nq gj gh gi nr ns bd b be z dk translated">如果真的对你有帮助…:)</figcaption></figure></div></div>    
</body>
</html>