<html>
<head>
<title>Automated TLS with cert-manager and letsencrypt for Kubernetes</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用于Kubernetes的带有cert-manager和letsencrypt的自动化TLS</h1>
<blockquote>原文：<a href="https://itnext.io/automated-tls-with-cert-manager-and-letsencrypt-for-kubernetes-7daaa5e0cae4?source=collection_archive---------0-----------------------#2018-05-27">https://itnext.io/automated-tls-with-cert-manager-and-letsencrypt-for-kubernetes-7daaa5e0cae4?source=collection_archive---------0-----------------------#2018-05-27</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/ed478990559f5314d3609f85d5f7e561.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*InCDMznVDYORFVh6Wwk6_Q.png"/></div></div></figure><p id="4d88" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">你是否梦想过有一天，当一项新服务出现时，会自动创建并更新免费的TLS证书？那一天已经到来。如果你已经跳上了酷车，并在生产中运行Kubernetes，那么<code class="fe kw kx ky kz b"><a class="ae la" href="https://github.com/jetstack/cert-manager" rel="noopener ugc nofollow" target="_blank">cert-manager</a></code>是必须的。<code class="fe kw kx ky kz b">cert-manager</code>是一个在Kubernetes中自动创建和管理TLS证书的服务，它就像它的名字一样酷。</p><p id="3e3b" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">以下是我启动和运行cert-manager的步骤。</p><p id="764e" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><strong class="ka ir">设置证书管理器概述</strong></p><p id="b71b" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">要在kubernetes集群中实现这一设置，有3个主要环节:</p><ol class=""><li id="a75f" class="lb lc iq ka b kb kc kf kg kj ld kn le kr lf kv lg lh li lj bi translated">cert-manager服务确保TLS证书有效、最新，并在需要时更新。</li><li id="f6b7" class="lb lc iq ka b kb lk kf ll kj lm kn ln kr lo kv lg lh li lj bi translated">定义要使用的证书颁发机构的clusterIssuer资源</li><li id="c599" class="lb lc iq ka b kb lk kf ll kj lm kn ln kr lo kv lg lh li lj bi translated">定义应该创建的证书的证书资源</li></ol><p id="948c" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">以下步骤假设<a class="ae la" href="https://github.com/kubernetes/charts/tree/master/stable/nginx-ingress" rel="noopener ugc nofollow" target="_blank"> nginx-ingress控制器</a>正在kubernetes集群中运行，并且有一种方法可以创建DNS记录。此外，假设<a class="ae la" href="https://helm.sh/" rel="noopener ugc nofollow" target="_blank">舵</a>已安装。</p><p id="9f50" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><strong class="ka ir">下面是我在我的Kubernetes集群中启动和运行</strong> <code class="fe kw kx ky kz b"><strong class="ka ir">cert-manger</strong></code> <strong class="ka ir">的步骤概述。</strong></p><ol class=""><li id="3214" class="lb lc iq ka b kb kc kf kg kj ld kn le kr lf kv lg lh li lj bi translated">从<a class="ae la" href="https://github.com/kubernetes/charts/tree/master/stable/cert-manager" rel="noopener ugc nofollow" target="_blank">官方掌舵图</a>中启动证书管理器</li><li id="4a85" class="lb lc iq ka b kb lk kf ll kj lm kn ln kr lo kv lg lh li lj bi translated">创建一个lets encrypt CA<a class="ae la" href="https://cert-manager.readthedocs.io/en/latest/reference/clusterissuers.html" rel="noopener ugc nofollow" target="_blank">cluster issuer</a>k8s资源</li><li id="d785" class="lb lc iq ka b kb lk kf ll kj lm kn ln kr lo kv lg lh li lj bi translated">在kubernetes集群中启动一个应用程序(带有入口),以便在TLS端点进行访问。</li><li id="0c33" class="lb lc iq ka b kb lk kf ll kj lm kn ln kr lo kv lg lh li lj bi translated">创建一个<a class="ae la" href="https://cert-manager.readthedocs.io/en/latest/reference/certificates.html" rel="noopener ugc nofollow" target="_blank">证书</a>对象，描述如何为测试应用程序创建TLS证书</li></ol><p id="0763" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><strong class="ka ir">设置证书管理器的详细信息</strong></p><p id="3f67" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">以下是更详细的步骤:</p><ol class=""><li id="4a18" class="lb lc iq ka b kb kc kf kg kj ld kn le kr lf kv lg lh li lj bi translated">展开<code class="fe kw kx ky kz b"><a class="ae la" href="https://github.com/kubernetes/charts/tree/master/stable/cert-manager" rel="noopener ugc nofollow" target="_blank">cert-manager</a></code> <a class="ae la" href="https://github.com/kubernetes/charts/tree/master/stable/cert-manager" rel="noopener ugc nofollow" target="_blank">舵图</a>。创建<a class="ae la" href="https://github.com/JessicaGreben/example-nodejs/blob/master/deploy/cert-manager-setup/cert-manager-values.yaml" rel="noopener ugc nofollow" target="_blank"> values.yaml </a>文件，然后运行:<code class="fe kw kx ky kz b">helm-install --name my-release -f cert-manager-values.yaml cert-manager</code>。cert-manager可以配置为通过Ingresss上的批注自动为Ingres资源提供TLS证书。这就是我如何设置cert-manager的，因此，我在values.yaml文件中添加了两个设置<code class="fe kw kx ky kz b">ingressShim.defaultIssuerName</code>和<code class="fe kw kx ky kz b">ingressShim.defaultIssuerKind</code>。点击阅读更多关于<a class="ae la" href="https://cert-manager.readthedocs.io/en/latest/reference/ingress-shim.html" rel="noopener ugc nofollow" target="_blank">Ingres shim的信息。参见我的价值观文件</a><a class="ae la" href="https://github.com/JessicaGreben/example-nodejs/blob/master/deploy/cert-manager-setup/cert-manager-values.yaml" rel="noopener ugc nofollow" target="_blank">此处</a>。</li></ol><p id="20ca" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">2.创建<a class="ae la" href="https://github.com/JessicaGreben/example-nodejs/blob/master/deploy/cert-manager-setup/letsencrypt-clusterissuer-staging.yaml" rel="noopener ugc nofollow" target="_blank"> letsencrypt CA集群颁发者</a>。在这里，我使用letsencrypt staging ACME服务器只是为了测试，一旦成功，我将切换到letsencrypt生产服务器。我通过运行创建了以下文件:<code class="fe kw kx ky kz b">kubectl create -f letsencrypt-clusterissuer-staging.yaml</code>。</p><pre class="lp lq lr ls gt lt kz lu lv aw lw bi"><span id="3e89" class="lx ly iq kz b gy lz ma l mb mc">apiVersion: certmanager.k8s.io/v1alpha1<br/>kind: ClusterIssuer<br/>metadata:<br/>  name: letsencrypt-staging<br/>spec:<br/>  acme:<br/>    # The ACME server URL<br/>    server: <a class="ae la" href="https://acme-staging.api.letsencrypt.org/directory" rel="noopener ugc nofollow" target="_blank">https://acme-staging.api.letsencrypt.org/directory</a><br/>    # Email address used for ACME registration<br/>    email: <a class="ae la" href="mailto:myemail@gmail.com" rel="noopener ugc nofollow" target="_blank">myemail@gmail.com</a><br/>    # Name of a secret used to store the ACME account private key<br/>    privateKeySecretRef:<br/>      name: letsencrypt-staging<br/>    # Enable the HTTP-01 challenge provider<br/>    http01: {}</span></pre><p id="89b7" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">3.创建一个配置了TLS的测试应用程序。创建kubernetes清单文件(我在这里创建了一个舵图<a class="ae la" href="https://github.com/JessicaGreben/example-nodejs/tree/master/deploy/charts/example-nodejs" rel="noopener ugc nofollow" target="_blank"/>)包括一个<a class="ae la" href="https://github.com/JessicaGreben/example-nodejs/blob/master/deploy/charts/example-nodejs/templates/deployment.yaml" rel="noopener ugc nofollow" target="_blank">部署</a>、<a class="ae la" href="https://github.com/JessicaGreben/example-nodejs/blob/master/deploy/charts/example-nodejs/templates/service.yaml" rel="noopener ugc nofollow" target="_blank">服务</a>和<a class="ae la" href="https://github.com/JessicaGreben/example-nodejs/blob/master/deploy/charts/example-nodejs/templates/ingress.yaml" rel="noopener ugc nofollow" target="_blank">入口</a>。入口需要<a class="ae la" href="https://github.com/JessicaGreben/example-nodejs/blob/master/deploy/charts/example-nodejs/templates/ingress.yaml#L8" rel="noopener ugc nofollow" target="_blank">注释</a>来告诉cert-manager使用什么CA来创建TLS证书。域<code class="fe kw kx ky kz b">example-nodejs.mydomain.com</code>必须有一个配置为向nginx入口控制器负载平衡器发送流量的DNS记录。</p><pre class="lp lq lr ls gt lt kz lu lv aw lw bi"><span id="a4fa" class="lx ly iq kz b gy lz ma l mb mc">apiVersion: extensions/v1beta1<br/>kind: Ingress<br/>metadata:<br/>  name: myapp-ingress<br/>  annotations:<br/>    kubernetes.io/ingress.class: nginx<br/>    certmanager.k8s.io/cluster-issuer: letsencrypt-staging<br/>spec:<br/>  tls:<br/>  - hosts:<br/>    - example-nodejs.mydomain.com<br/>    secretName: example-nodejs-crt<br/>  rules:<br/>  - host: example-nodejs.mydomain.com<br/>    http:<br/>      paths:<br/>      - path: /<br/>        backend:<br/>          serviceName: example-nodejs<br/>          servicePort: 8080</span></pre><p id="8f99" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">4.创建配置了<a class="ae la" href="https://ietf-wg-acme.github.io/acme/draft-ietf-acme-acme.html#rfc.section.8.3" rel="noopener ugc nofollow" target="_blank"> acme http质询</a>的<code class="fe kw kx ky kz b"><a class="ae la" href="https://github.com/JessicaGreben/example-nodejs/blob/master/deploy/charts/example-nodejs/templates/certificate.yaml" rel="noopener ugc nofollow" target="_blank">certificate</a></code>资源。</p><pre class="lp lq lr ls gt lt kz lu lv aw lw bi"><span id="73c1" class="lx ly iq kz b gy lz ma l mb mc">apiVersion: certmanager.k8s.io/v1alpha1<br/>kind: Certificate<br/>metadata:<br/>  name: example-nodejs-crt<br/>spec:<br/>  secretName: example-nodejs-crt<br/>  dnsNames:<br/>  - example-nodejs.mydomain.com<br/>  acme:<br/>    config:<br/>    - http01:<br/>        ingressClass: nginx<br/>      domains:<br/>      - example-nodejs.mydomain.com<br/>  issuerRef:<br/>    name: letsencrypt-staging<br/>    kind: ClusterIssuer</span></pre><p id="9fce" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">创建此资源后，应该会创建一个tls证书。如果没有，请检查cert-manger服务的日志中是否有错误。</p><p id="425e" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">一旦所有这些部分都设置好了，当您试图在浏览器中访问应用程序时，仍然会得到一个错误，因为证书是用<a class="ae la" href="https://github.com/JessicaGreben/example-nodejs/blob/master/deploy/cert-manager-setup/letsencrypt-clusterissuer-staging.yaml#L8" rel="noopener ugc nofollow" target="_blank">临时letsencrypt服务器</a>创建的，但是这仍然显示证书<em class="md">已成功创建</em>。</p><figure class="lp lq lr ls gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi me"><img src="../Images/dfda30c90e7dcd791df28f541acf5dc7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*DeZnZBW7thzG_8ZSCFwJQQ.png"/></div></div></figure><p id="6f8e" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">一旦设置成功，就创建一个<a class="ae la" href="https://github.com/JessicaGreben/example-nodejs/blob/master/deploy/cert-manager-setup/letsencrypt-clusterissuer-prod.yaml" rel="noopener ugc nofollow" target="_blank">生产集群发布者</a>，并用<code class="fe kw kx ky kz b">letsencrypt-prod</code>集群发布者替换所有对<code class="fe kw kx ky kz b">letsencrypt-staging</code>集群发布者的引用。</p><p id="bfdd" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><strong class="ka ir">有趣的额外背景信息，如果你感兴趣:</strong></p><p id="edfe" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><strong class="ka ir">什么是letsencrypt？</strong> Letsencrypt是一个颁发免费TLS证书的证书颁发机构。它于2016年推出，其目的是通过使使用TLS变得更容易和更便宜，来尝试建立一个更安全的互联网。</p><p id="0e18" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><strong class="ka ir">什么是</strong> <a class="ae la" href="https://en.wikipedia.org/wiki/Automated_Certificate_Management_Environment" rel="noopener ugc nofollow" target="_blank"> <strong class="ka ir">极致协议</strong> </a> <strong class="ka ir">？ACME代表自动化证书管理环境。它是一个协议，用于自动化<a class="ae la" href="https://en.wikipedia.org/wiki/Certificate_authority" rel="noopener ugc nofollow" target="_blank">认证机构</a>及其用户的web服务器之间的交互，允许以非常低的成本自动化部署<a class="ae la" href="https://en.wikipedia.org/wiki/Public_key_infrastructure" rel="noopener ugc nofollow" target="_blank">公钥基础设施</a>。它是由<a class="ae la" href="https://en.wikipedia.org/wiki/Internet_Security_Research_Group" rel="noopener ugc nofollow" target="_blank">互联网安全研究小组</a> (ISRG)为他们的<a class="ae la" href="https://en.wikipedia.org/wiki/Let%27s_Encrypt" rel="noopener ugc nofollow" target="_blank">让我们加密</a>服务设计的。</strong></p><p id="5b02" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><strong class="ka ir">资源:</strong></p><ul class=""><li id="40ec" class="lb lc iq ka b kb kc kf kg kj ld kn le kr lf kv mf lh li lj bi translated">让我们来解密它是如何工作的</li><li id="e33a" class="lb lc iq ka b kb lk kf ll kj lm kn ln kr lo kv mf lh li lj bi translated"><a class="ae la" href="https://github.com/jetstack/cert-manager" rel="noopener ugc nofollow" target="_blank">证书管理器</a></li><li id="62b4" class="lb lc iq ka b kb lk kf ll kj lm kn ln kr lo kv mf lh li lj bi translated"><a class="ae la" href="https://github.com/JessicaGreben/example-nodejs" rel="noopener ugc nofollow" target="_blank">我的应用示例</a>和这篇博文的掌舵图</li></ul></div></div>    
</body>
</html>