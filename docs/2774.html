<html>
<head>
<title>Cross-Region Actions with CodePipeline on AWS</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">AWS上带有代码管道的跨区域操作</h1>
<blockquote>原文：<a href="https://itnext.io/cross-region-actions-with-codepipeline-on-aws-dcd786eb5fc?source=collection_archive---------4-----------------------#2019-07-30">https://itnext.io/cross-region-actions-with-codepipeline-on-aws-dcd786eb5fc?source=collection_archive---------4-----------------------#2019-07-30</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><figure class="gl gn jr js jt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi jq"><img src="../Images/5a667bcb9f2d2abfc76d768c198d8f96.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*9m3PUCJjSrpQaywO9vBC0w.jpeg"/></div></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated">在<a class="ae kf" href="https://unsplash.com/search/photos/code?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上由<a class="ae kf" href="https://unsplash.com/@max_duz?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Max Duzij </a>拍照</figcaption></figure><p id="74ce" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">在过去的几年中，我参与的许多项目都使用了TeamCity for CI/CD，但是，最近我开始使用AWS代码管道构建新的CI/CD管道。作为我一直在做的一个项目的一些其他变化的一部分，我决定我们应该将管道从TeamCity迁移到CodePipeline。</p><p id="9b27" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">TeamCity是一个很好的工具，但是我一直将项目从TeamCity转移到CodePipeline有几个原因:</p><ul class=""><li id="c806" class="le lf it ki b kj kk kn ko kr lg kv lh kz li ld lj lk ll lm bi translated">我们必须管理底层的EC2服务器，保持服务器之间的依赖关系是最新和常见的，这开始变得令人痛苦。</li><li id="3ced" class="le lf it ki b kj ln kn lo kr lp kv lq kz lr ld lj lk ll lm bi translated">随着项目数量的增加，TeamCity服务器开始成为我们部署过程中的瓶颈。</li><li id="7f47" class="le lf it ki b kj ln kn lo kr lp kv lq kz lr ld lj lk ll lm bi translated">缺少TeamCity的模板系统，使得在阶段之间重复部署管道变得困难。GUI需要太多的点击，这带来了潜在的人为错误。</li></ul><p id="bf00" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">下图粗略描述了之前的部署流程；它分为两个主要部分——我们基于API Gateway和Lambda构建的无服务器后端，以及基于两者结合构建的前端。NET MVC和React，运行在EC2上。在TeamCity为后端和前端编译了我们的代码之后，CloudFormation处理我们的API和Lambda函数部署的编排。网络前端。</p><figure class="lt lu lv lw gt ju gh gi paragraph-image"><div class="gh gi ls"><img src="../Images/865171be0c5c206fbb63d425913b4d27.png" data-original-src="https://miro.medium.com/v2/resize:fit:1062/format:webp/1*4-kc8rEEXPvbwpviWZwocA.png"/></div></figure><p id="36e6" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">虽然CodePipeline接管了整个流程的编排，但CodeBuild是主要的服务，承担了TeamCity正在执行的工作。CodePipeline阶段的一个很酷的特性是每个阶段的多个操作可以并行运行，以帮助减少管道完成的总时间。</p><p id="f779" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">经过一段时间的反复试验，我们的管道现在看起来如下所示(我们还从内部回购中偷偷移植了GitHub)。</p><figure class="lt lu lv lw gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi lx"><img src="../Images/0ef6ec57c767046b749e929b3be40e76.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*cS05P2N0jWjmpm-T6a_nig.png"/></div></div></figure><p id="0147" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">你可能会想，跨区域行动是从哪里来的，为什么有人会费心去使用它们呢？在这个项目中，目标客户群是澳大利亚人，因此所有资源都部署在ap-southeast-2中——在ap-southeast-2中使用CodePipeline也是有意义的。还记得我说过前端是一个. NET MVC应用吗？我漏掉了一个小细节它是建立在。NET框架而不是。网芯。这意味着我需要在CodeBuild上使用一个Windows Docker映像，在撰写本文时，这个映像在ap-southeast-2中是不可用的。为了解决这个问题，跨区域行动来拯救！</p><p id="e771" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">跨区域操作允许CodePipeline在管道所在的不同区域执行操作。如果使用AWS控制台中的向导，您会注意到在构建和部署阶段，您不仅可以选择部署提供者，还可以选择您希望发生该操作的区域。这对于我需要使用CodeBuild中的一个特性的情况很有用，这个特性在我所在的地区不可用，但也可以用于并行执行多地区部署。</p><div class="lt lu lv lw gt ab cb"><figure class="ly ju lz ma mb mc md paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><img src="../Images/6a2a8f864fcc43df1174eac0f3c02745.png" data-original-src="https://miro.medium.com/v2/resize:fit:1004/format:webp/1*Y4y75YiqN1cEVtpj7vomnQ.png"/></div></figure><figure class="ly ju me ma mb mc md paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><img src="../Images/da2d34cad0377d903a25fa8a571ee2c8.png" data-original-src="https://miro.medium.com/v2/resize:fit:998/format:webp/1*5DDzInCm25yoooeEUZ3Jlg.png"/></div></figure></div><h1 id="db9f" class="mf mg it bd mh mi mj mk ml mm mn mo mp mq mr ms mt mu mv mw mx my mz na nb nc bi translated">让我们动手吧！</h1><p id="24d2" class="pw-post-body-paragraph kg kh it ki b kj nd kl km kn ne kp kq kr nf kt ku kv ng kx ky kz nh lb lc ld im bi translated">首先，我们需要代码管道将与之交互的服务。因为我们的部署管道将包含三个主要组件；来源、构建和部署，我们需要确保我们拥有:</p><ol class=""><li id="5e34" class="le lf it ki b kj kk kn ko kr lg kv lh kz li ld ni lk ll lm bi translated">用我们的代码建立的GitHub或CodeCommit库或S3桶</li><li id="26ba" class="le lf it ki b kj ln kn lo kr lp kv lq kz lr ld ni lk ll lm bi translated">与我们的管道在不同区域的CodeBuild项目</li><li id="f28f" class="le lf it ki b kj ln kn lo kr lp kv lq kz lr ld ni lk ll lm bi translated">CodeDeploy应用程序和组已配置—您还需要有一个部署位置！</li></ol><h2 id="789c" class="nj mg it bd mh nk nl dn ml nm nn dp mp kr no np mt kv nq nr mx kz ns nt nb nu bi translated">代码构建</h2><p id="9c8c" class="pw-post-body-paragraph kg kh it ki b kj nd kl km kn ne kp kq kr nf kt ku kv ng kx ky kz nh lb lc ld im bi translated">虽然我将在悉尼创建我的整个管道，但我的CodeBuild项目将在北弗吉尼亚创建，所以我可以利用Windows映像。如果你以前从未研究过CodeBuild，它是基于Docker构建的，可以使用预先制作的Docker映像，也可以通过ECR自带映像。在开始之前，值得<a class="ae kf" href="https://docs.aws.amazon.com/codebuild/latest/userguide/welcome.html" rel="noopener ugc nofollow" target="_blank">阅读一下关于它的</a>。</p><p id="fdbe" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">对于该环境，您的配置应该如下所示，其他一切应该相当简单，但是请确保您没有选择输入或输出工件，因为CodePipeline将有助于这一点。另外，记得用一些命令填充<a class="ae kf" href="https://docs.aws.amazon.com/codebuild/latest/userguide/build-spec-ref.html" rel="noopener ugc nofollow" target="_blank"> buildspec </a>(甚至一个简单的echo也可以)。</p><figure class="lt lu lv lw gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi nv"><img src="../Images/c2350a5737784d42c34a755404eed795.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*LggyEcdakRa3apTrsoVQLg.png"/></div></div></figure><h2 id="10ba" class="nj mg it bd mh nk nl dn ml nm nn dp mp kr no np mt kv nq nr mx kz ns nt nb nu bi translated">代码部署</h2><p id="9fd3" class="pw-post-body-paragraph kg kh it ki b kj nd kl km kn ne kp kq kr nf kt ku kv ng kx ky kz nh lb lc ld im bi translated">在CodeBuild完成构建我的应用程序之后，我们可以将它的构建工件(编译后的代码)输出为一个包，供CodeDeploy使用。<a class="ae kf" href="https://docs.aws.amazon.com/codedeploy/latest/userguide/welcome.html" rel="noopener ugc nofollow" target="_blank"> CodeDeploy </a>是一种很好的协调应用程序变更的方式，无论是逐步推出还是执行蓝/绿更新。</p><p id="d6b9" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">尽管CodeDeploy现在支持许多不同的目标服务，但我将使用EC2作为我的应用程序和组的目标。当部署到EC2时，需要包含一个<a class="ae kf" href="https://docs.aws.amazon.com/codedeploy/latest/userguide/reference-appspec-file.html" rel="noopener ugc nofollow" target="_blank"> appspec </a>文件，为CodeDeploy提供如何处理部署的指令。</p><p id="1bb8" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">设置CodeDeploy的第一部分是配置应用程序。由于这只是一个示例，我将把它命名为TestApplication，但您可能希望根据在该特定基础架构上运行的应用或服务来命名它。</p><figure class="lt lu lv lw gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi nw"><img src="../Images/e58f5319480892a67bf9d3ac5c0fa577.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*V_4YKRU17edoEo7XQabqzQ.png"/></div></div></figure><p id="11ff" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">接下来，我们需要创建一个部署组。部署组包含设置和配置，在EC2部署的情况下，这些设置和配置与查找应该将应用程序部署到的实例相关，这也可以针对自动扩展组，并允许您绑定到负载平衡器，以确保整个部署的连续性。</p><div class="lt lu lv lw gt ab cb"><figure class="ly ju nx ma mb mc md paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><img src="../Images/82a3e0e5ba2b43d3107bf1cff6e5cb05.png" data-original-src="https://miro.medium.com/v2/resize:fit:1076/format:webp/1*-qtbtFHMkKby3GRS7LWhhg.png"/></div></figure><figure class="ly ju ny ma mb mc md paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><img src="../Images/0b0020518d6ee7bb464b8cfd7fd42341.png" data-original-src="https://miro.medium.com/v2/resize:fit:926/format:webp/1*ZDaW9ljoI0S0U4rlVtBJOw.png"/></div></figure></div><h2 id="9fc6" class="nj mg it bd mh nk nl dn ml nm nn dp mp kr no np mt kv nq nr mx kz ns nt nb nu bi translated">代码管道</h2><p id="2a22" class="pw-post-body-paragraph kg kh it ki b kj nd kl km kn ne kp kq kr nf kt ku kv ng kx ky kz nh lb lc ld im bi translated">一切都将使用CodePipeline联系在一起，code pipeline在高层次上是CodeBuild、CodeDeploy和许多其他服务的协调者。管道可以配置几个阶段；即。源代码、构建、测试、批准、部署，每个阶段都可以包含多个操作，因此如果需要，您可以为应用程序的多个部分并行执行构建。</p><p id="56f5" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">这个示例管道要简单得多，只包含三个阶段(源代码、构建、部署),每个阶段只有一个操作。</p><p id="7281" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">首先创建一个管道，给它一些基本信息，并配置您的代码源。</p><figure class="lt lu lv lw gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi nz"><img src="../Images/c1e14827fbd8f7606ca9eb5fd8ff585e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Ud6-sT29jjvgWj3wzGBZrg.png"/></div></div></figure><p id="7c73" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">接下来的两个步骤将允许您添加一个构建和部署阶段—您可以跳过任何一个，但是至少需要配置一个构建或部署阶段。因为我们将使用我们之前创建的预先存在的CodeBuild项目，所以选择它创建的地区(在我的例子中，是N. Virginia)和项目。</p><figure class="lt lu lv lw gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi oa"><img src="../Images/00574143b950a91c680286f75dbc3d96.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*SxHPn9QXNpD-J5uqXa5Ysg.png"/></div></div></figure><p id="8ba4" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">现在，在我们的部署阶段，回到悉尼，但如果我们愿意，我们也可以选择在不同地区进行代码部署。</p><figure class="lt lu lv lw gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi ob"><img src="../Images/a5ee1ac1969d0c89e5e283c8484d7c91.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*FmxMTYo5-NJIfdeLHDMUDQ.png"/></div></div></figure><p id="5dcc" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">检查和创建管道后，将首次尝试运行整个管道。假设您的源代码、buildspec和appspec都配置正确，并且您的代码是可构建的，那么这个过程应该是成功的。否则，CodeBuild和CodeDeploy都包含全面的日志记录，允许您深入查看可能发生了什么错误。</p><figure class="lt lu lv lw gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi oc"><img src="../Images/0879e1265eb223b74898357e5d151446.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*6zPg_JY1UqbLqq3WbXS1Hw.png"/></div></div></figure><h1 id="e6d8" class="mf mg it bd mh mi mj mk ml mm mn mo mp mq mr ms mt mu mv mw mx my mz na nb nc bi translated">在幕后</h1><p id="05bb" class="pw-post-body-paragraph kg kh it ki b kj nd kl km kn ne kp kq kr nf kt ku kv ng kx ky kz nh lb lc ld im bi translated">在幕后，除了IAM角色和管道之外，还创建了两个S3存储桶，一个在您的管道主要操作的区域，另一个在构建操作所在的区域，然后您的构建工件在这些S3存储桶之间为您复制。</p><p id="e92e" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">查看我们的管道的YML(如果您使用CloudFormation构建它)，现在有了对您的管道的不同组件所在的区域的引用，如果在默认区域之外。</p><figure class="lt lu lv lw gt ju"><div class="bz fp l di"><div class="od oe l"/></div></figure><h1 id="26f7" class="mf mg it bd mh mi mj mk ml mm mn mo mp mq mr ms mt mu mv mw mx my mz na nb nc bi translated">结论</h1><p id="350c" class="pw-post-body-paragraph kg kh it ki b kj nd kl km kn ne kp kq kr nf kt ku kv ng kx ky kz nh lb lc ld im bi translated">跨区域管道非常适合那些边缘情况，或者有助于通过单个管道执行多区域部署。它们可能有点复杂，因为我发现并不是所有的细节都有详细的记录，但是只要坚持一点，它就会工作。</p><p id="e544" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">如果您想更深入地使用代码部署管道，我已经上传了一组构建在无服务器框架上的模板到<a class="ae kf" href="https://github.com/GavL89/CrossRegionPipeline" rel="noopener ugc nofollow" target="_blank"> GitHub </a>。如果你不想使用无服务器框架，这些可以很容易地转换成本地云格式。</p></div></div>    
</body>
</html>