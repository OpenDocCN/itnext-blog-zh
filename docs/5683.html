<html>
<head>
<title>Network Isolated AKS — Part 1: Controlling network traffic</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">网络隔离AKS第1部分:控制网络流量</h1>
<blockquote>原文：<a href="https://itnext.io/network-isolated-aks-part-1-controlling-network-traffic-2cd0e045352d?source=collection_archive---------2-----------------------#2021-05-02">https://itnext.io/network-isolated-aks-part-1-controlling-network-traffic-2cd0e045352d?source=collection_archive---------2-----------------------#2021-05-02</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="279d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">孤立AK而不把自己困在</strong></p><p id="ee5b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这是关于AKS网络隔离的两篇博文的第一部分。首先，我将从网络的角度阐述如何保护AK。在<a class="ae kl" href="https://geekzter.medium.com/network-isolated-aks-part-2-how-do-i-get-in-1c01d0c1b115" rel="noopener">第2部分</a>中，我将描述如何为您自己的管理(例如CI/CD)访问您的集群。你会看到我使用Terraform，PowerShell，Azure CLI，Azure Pipelines，Kusto &amp; Cloud init。第1部分的完整解决方案在GitHub上:<a class="ae kl" href="https://github.com/geekzter/azure-aks" rel="noopener ugc nofollow" target="_blank"> geekzter/azure-aks:网络隔离AKS(github.com)</a>。</p><p id="9028" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">当您在Azure门户中或使用Azure CLI等工具创建Azure Kubernetes服务(AKS)时，默认配置将在流量(应用程序和管理)穿越公共IP地址的意义上是开放的。这在企业中是一个挑战，尤其是在受监管的行业中。需要努力控制所有的网络路径，在AK的情况下，有相当多的移动部分需要考虑。</p><h1 id="1240" class="km kn iq bd ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj bi translated">AKS网络模式</h1><p id="5776" class="pw-post-body-paragraph jn jo iq jp b jq lk js jt ju ll jw jx jy lm ka kb kc ln ke kf kg lo ki kj kk ij bi translated">AKS支持两种网络“模式”。这些模式控制集群中代理节点的IP地址分配。简而言之:</p><ul class=""><li id="63a5" class="lp lq iq jp b jq jr ju jv jy lr kc ls kg lt kk lu lv lw lx bi translated">kubenet 在不同的地址空间创建IP地址，并使用NAT(网络地址转换)来暴露代理。这就是Kubernetes术语“外部IP”的来源，它是网络其余部分都知道的私有IP地址。</li><li id="baea" class="lp lq iq jp b jq ly ju lz jy ma kc mb kg mc kk lu lv lw lx bi translated"><a class="ae kl" href="https://docs.microsoft.com/en-us/azure/aks/configure-azure-cni" rel="noopener ugc nofollow" target="_blank"> Azure CNI </a>为代理使用与虚拟网络其余部分相同的地址空间。参见<a class="ae kl" href="https://docs.microsoft.com/en-us/azure/aks/concepts-network#compare-network-models" rel="noopener ugc nofollow" target="_blank">比较</a></li></ul><p id="65bf" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我不会详细讨论这些模式，因为网络模式在很大程度上与您需要实现的隔离控制无关。对于网络隔离来说，选择哪一个并不会有很大的不同。我用蓝色CNI测试过。</p></div><div class="ab cl md me hu mf" role="separator"><span class="mg bw bk mh mi mj"/><span class="mg bw bk mh mi mj"/><span class="mg bw bk mh mi"/></div><div class="ij ik il im in"><h1 id="56f7" class="km kn iq bd ko kp mk kr ks kt ml kv kw kx mm kz la lb mn ld le lf mo lh li lj bi translated">交通路径</h1><p id="ff43" class="pw-post-body-paragraph jn jo iq jp b jq lk js jt ju ll jw jx jy lm ka kb kc ln ke kf kg lo ki kj kk ij bi translated">要限制进出AKS群集的所有流量，需要以下可用措施:</p><figure class="mq mr ms mt gt mu gh gi paragraph-image"><div role="button" tabindex="0" class="mv mw di mx bf my"><div class="gh gi mp"><img src="../Images/6c13bc0990a542fe45d983cd191c4100.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*gKGwuoM_VmMhyL-D.png"/></div></div><figcaption class="nb nc gj gh gi nd ne bd b be z dk translated">AKS网络流量路径</figcaption></figure><p id="d0dc" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我将仔细阅读下面的每一行，但是会进行一些关键的配置。集中在<a class="ae kl" href="https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/resources/kubernetes_cluster" rel="noopener ugc nofollow" target="_blank">azure RM _ kubernetes _ cluster</a>terra form资源上，因此我在这里突出显示它们:</p><figure class="mq mr ms mt gt mu"><div class="bz fp l di"><div class="nf ng l"/></div><figcaption class="nb nc gj gh gi nd ne bd b be z dk translated">Terraform AKS资源(仅相关属性)</figcaption></figure><h1 id="b75a" class="km kn iq bd ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj bi translated">1.私有集群</h1><p id="611f" class="pw-post-body-paragraph jn jo iq jp b jq lk js jt ju ll jw jx jy lm ka kb kc ln ke kf kg lo ki kj kk ij bi translated">Kubernetes API服务器是Kubernetes管理操作的入口点，默认情况下，它作为多租户PaaS服务托管。API服务器可以使用私有链接被投影到包含集群节点的虚拟网络中。这被称为<a class="ae kl" href="https://docs.microsoft.com/en-us/azure/aks/private-clusters" rel="noopener ugc nofollow" target="_blank">私有AKS集群</a>。这确保了从集群到API服务器的流量使用私有端点。</p><p id="bd02" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这就是它所做的一切，这只包括API服务器管理流量。控制AKS网络流量需要更多，例如您的应用程序正在被访问或正在访问外部世界。</p></div><div class="ab cl md me hu mf" role="separator"><span class="mg bw bk mh mi mj"/><span class="mg bw bk mh mi mj"/><span class="mg bw bk mh mi"/></div><div class="ij ik il im in"><h1 id="270a" class="km kn iq bd ko kp mk kr ks kt ml kv kw kx mm kz la lb mn ld le lf mo lh li lj bi translated">2.通过内部负载平衡器进入</h1><p id="0f3f" class="pw-post-body-paragraph jn jo iq jp b jq lk js jt ju ll jw jx jy lm ka kb kc ln ke kf kg lo ki kj kk ij bi translated">默认情况下，AKS会提供一个Azure外部负载平衡器，即一个公共IP地址。<br/>负载平衡器充当Kubernetes入口控制器。这对于只想入门的开发人员来说很容易，但这是Enterprise中的反模式。通常，路径中有一个过滤流量的安全设备，例如Web应用防火墙、Azure防火墙或网络虚拟设备(Barracuda、Fortinet、Palo Alto等)。企业架构师将尝试应用一个通用模式，而不管应用程序的堆栈是什么，例如Kubernetes或其他什么。</p><p id="2723" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">可以创建一个Azure <a class="ae kl" href="https://docs.microsoft.com/en-us/azure/aks/internal-lb" rel="noopener ugc nofollow" target="_blank">内部负载平衡器</a>，而不是一个外部负载平衡器(带有公共IP地址)。这是通过Kubernetes API实现的。您可以将其创建为Kubernetes清单的一部分:</p><figure class="mq mr ms mt gt mu"><div class="bz fp l di"><div class="nf ng l"/></div><figcaption class="nb nc gj gh gi nd ne bd b be z dk translated">内部负载平衡器清单</figcaption></figure><p id="dc43" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">或者您可以使用Terraform<a class="ae kl" href="https://registry.terraform.io/providers/hashicorp/kubernetes/latest/docs" rel="noopener ugc nofollow" target="_blank">Kubernetes provider</a>创建一个内部负载平衡器:</p><figure class="mq mr ms mt gt mu"><div class="bz fp l di"><div class="nf ng l"/></div><figcaption class="nb nc gj gh gi nd ne bd b be z dk translated">内部负载平衡器地形资源</figcaption></figure><p id="7687" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">因此，这可以与基础架构代码以及应用程序打包在一起。由你来决定什么最适合你。</p><p id="ab0c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">内部负载平衡器并不是真正的安全设备，但它使您能够将AKS集群节点“隐藏”在另一个安全设备(例如Azure防火墙或网络虚拟设备)后面。</p></div><div class="ab cl md me hu mf" role="separator"><span class="mg bw bk mh mi mj"/><span class="mg bw bk mh mi mj"/><span class="mg bw bk mh mi"/></div><div class="ij ik il im in"><h1 id="4bb5" class="km kn iq bd ko kp mk kr ks kt ml kv kw kx mm kz la lb mn ld le lf mo lh li lj bi translated">3.通过应用网关进入</h1><p id="618f" class="pw-post-body-paragraph jn jo iq jp b jq lk js jt ju ll jw jx jy lm ka kb kc ln ke kf kg lo ki kj kk ij bi translated">您最有可能将Kubernetes用于web应用程序。在这种情况下，Azure中有一个名为应用网关的本地第7层保护服务，可用于管理入口流量。有多种方法可以设置这个(例如<a class="ae kl" href="https://azure.github.io/application-gateway-kubernetes-ingress/" rel="noopener ugc nofollow" target="_blank">舵图</a>，到目前为止最简单的是使用<a class="ae kl" href="https://docs.microsoft.com/en-us/azure/application-gateway/tutorial-ingress-controller-add-on-existing" rel="noopener ugc nofollow" target="_blank"> AKS附加</a>。这使得AKS可以管理应用网关的生命周期并维护其配置。该插件在上面分享的<a class="ae kl" href="https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/resources/kubernetes_cluster#ingress_application_gateway" rel="noopener ugc nofollow" target="_blank">azure RM _ kubernetes _ cluster</a>片段中进行配置。</p><p id="f4c0" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">注意，应用网关入口控制器不在容器中运行(如NGINX或Traefik)。它是单独部署的独特服务，在自己的子网中运行。容器用于同步Kubernetes和应用程序网关之间的配置，尽管:</p><figure class="mq mr ms mt gt mu gh gi paragraph-image"><div role="button" tabindex="0" class="mv mw di mx bf my"><div class="gh gi nh"><img src="../Images/194afaa68e9f1ea6f7a8419fa3fd3342.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*ZGu65OP9I7c6P3ui.png"/></div></div><figcaption class="nb nc gj gh gi nd ne bd b be z dk translated"><a class="ae kl" href="https://azure.github.io/application-gateway-kubernetes-ingress/" rel="noopener ugc nofollow" target="_blank">简介—应用网关入口控制器(azure.github.io) </a></figcaption></figure></div><div class="ab cl md me hu mf" role="separator"><span class="mg bw bk mh mi mj"/><span class="mg bw bk mh mi mj"/><span class="mg bw bk mh mi"/></div><div class="ij ik il im in"><h1 id="f0f2" class="km kn iq bd ko kp mk kr ks kt ml kv kw kx mm kz la lb mn ld le lf mo lh li lj bi translated">4.通过Azure防火墙出口</h1><p id="74a6" class="pw-post-body-paragraph jn jo iq jp b jq lk js jt ju ll jw jx jy lm ka kb kc ln ke kf kg lo ki kj kk ij bi translated">使用<a class="ae kl" href="https://docs.microsoft.com/en-us/azure/aks/egress-outboundtype" rel="noopener ugc nofollow" target="_blank">用户定义的路由</a>和<a class="ae kl" href="https://docs.microsoft.com/en-us/azure/aks/limit-egress-traffic#restrict-egress-traffic-using-azure-firewall" rel="noopener ugc nofollow" target="_blank"> Azure防火墙</a>来管理出口，而不是直接进入互联网。</p><p id="9cbc" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">上述“交通路径”下的片段涵盖了AKS资源配置，以下是用户定义的路线:</p><figure class="mq mr ms mt gt mu"><div class="bz fp l di"><div class="nf ng l"/></div><figcaption class="nb nc gj gh gi nd ne bd b be z dk translated">用户定义的路线</figcaption></figure><p id="6f5a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">请注意，实际路线由Terraform外部的AKS更新(特别是在kubenet网络模式下)，需要告知Terraform不要接触使用“生命周期”参数的路线。</p><p id="5adb" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">Azure防火墙需要定义相当多的出站规则，如这里描述的<a class="ae kl" href="https://docs.microsoft.com/en-us/azure/aks/limit-egress-traffic#required-outbound-network-rules-and-fqdns-for-aks-clusters" rel="noopener ugc nofollow" target="_blank"/>。这些规则的实现太长了，无法一一列举，可以在这里找到<a class="ae kl" href="https://github.com/geekzter/azure-aks/blob/main/terraform/modules/network/egress.tf" rel="noopener ugc nofollow" target="_blank"/>(通用规则)和这里的<a class="ae kl" href="https://github.com/geekzter/azure-aks/blob/main/terraform/modules/aks-network/egress.tf" rel="noopener ugc nofollow" target="_blank"/>(依赖于API服务器IP地址的规则)。这些包括没有正式记录的规则。随着Kubernetes和AKS的不断更新，您可能会遇到比记录所需流量更多的问题，从而导致流量被阻塞。使用下面的Kusto查询(假设设置了日志分析，请始终这样做)来识别被阻止的HTTP出口:</p><figure class="mq mr ms mt gt mu"><div class="bz fp l di"><div class="nf ng l"/></div><figcaption class="nb nc gj gh gi nd ne bd b be z dk translated">Azure防火墙拒绝出站HTTP流量</figcaption></figure><h1 id="df87" class="km kn iq bd ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj bi translated">5.访问Azure PaaS服务</h1><p id="f7af" class="pw-post-body-paragraph jn jo iq jp b jq lk js jt ju ll jw jx jy lm ka kb kc ln ke kf kg lo ki kj kk ij bi translated">您的应用程序可能会连接到Azure PaaS服务，最有可能的候选服务是Azure Container Registry。为了确保流量保持在您的私有网络中，存在一个名为<a class="ae kl" href="https://docs.microsoft.com/en-us/azure/private-link/private-endpoint-overview" rel="noopener ugc nofollow" target="_blank">私有端点</a>的特性。</p><p id="b41d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如今，创建私有端点是相当标准的做法，下面是terraform片段:</p><figure class="mq mr ms mt gt mu"><div class="bz fp l di"><div class="nf ng l"/></div><figcaption class="nb nc gj gh gi nd ne bd b be z dk translated">Azure容器注册表私有端点</figcaption></figure></div><div class="ab cl md me hu mf" role="separator"><span class="mg bw bk mh mi mj"/><span class="mg bw bk mh mi mj"/><span class="mg bw bk mh mi"/></div><div class="ij ik il im in"><h1 id="334b" class="km kn iq bd ko kp mk kr ks kt ml kv kw kx mm kz la lb mn ld le lf mo lh li lj bi translated">6.CI/CD</h1><p id="f5d2" class="pw-post-body-paragraph jn jo iq jp b jq lk js jt ju ll jw jx jy lm ka kb kc ln ke kf kg lo ki kj kk ij bi translated">我将在即将发布的关于AKS网络隔离的<a class="ae kl" href="https://geekzter.medium.com/network-isolated-aks-part-2-how-do-i-get-in-1c01d0c1b115" rel="noopener">第2部分</a>文章中对此进行介绍。</p></div><div class="ab cl md me hu mf" role="separator"><span class="mg bw bk mh mi mj"/><span class="mg bw bk mh mi mj"/><span class="mg bw bk mh mi"/></div><div class="ij ik il im in"><h1 id="bfbb" class="km kn iq bd ko kp mk kr ks kt ml kv kw kx mm kz la lb mn ld le lf mo lh li lj bi translated">完整的源代码和演示</h1><p id="aa58" class="pw-post-body-paragraph jn jo iq jp b jq lk js jt ju ll jw jx jy lm ka kb kc ln ke kf kg lo ki kj kk ij bi translated">你可以在GitHub上的<a class="ae kl" href="https://github.com/geekzter/azure-aks" rel="noopener ugc nofollow" target="_blank"> geekzter/azure-aks </a>找到使用上述控件部署AKS的完整项目。这包括一个<a class="ae kl" href="https://github.com/geekzter/azure-aks/blob/main/pipelines/azure-aks-ci.yml" rel="noopener ugc nofollow" target="_blank"> YAML Azure管道</a>(查看<a class="ae kl" href="https://geekzter.medium.com/network-isolated-aks-part-2-how-do-i-get-in-1c01d0c1b115" rel="noopener">第2部分</a>网络指南)和手册说明。</p><h1 id="46a5" class="km kn iq bd ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj bi translated">其他资源</h1><p id="84ee" class="pw-post-body-paragraph jn jo iq jp b jq lk js jt ju ll jw jx jy lm ka kb kc ln ke kf kg lo ki kj kk ij bi translated">在<a class="ae kl" href="https://docs.microsoft.com/en-us/azure/architecture/reference-architectures/" rel="noopener ugc nofollow" target="_blank">docs.microsoft.com</a>发布了一个名为<a class="ae kl" href="https://docs.microsoft.com/en-us/azure/architecture/reference-architectures/containers/aks/secure-baseline-aks" rel="noopener ugc nofollow" target="_blank">Azure Kubernetes服务(AKS) </a>基线架构的参考架构。</p><p id="449c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果您正在使用企业级登录区(云采用框架)，并且想要插入其中，您可以使用<a class="ae kl" href="https://github.com/Azure/caf-terraform-landingzones-starter/tree/starter/enterprise_scale/construction_sets/aks/online/aks_secure_baseline" rel="noopener ugc nofollow" target="_blank"> AKS构造集</a>来创建一个AKS登录区。</p></div></div>    
</body>
</html>