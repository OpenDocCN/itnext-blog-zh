<html>
<head>
<title>Reverse tunnels for your Home Assistant on a Raspberry Pi</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">反向隧道为您的家庭助理对树莓皮</h1>
<blockquote>原文：<a href="https://itnext.io/reverse-tunnels-for-your-home-assistant-on-a-raspberry-pi-cf5c63b7638e?source=collection_archive---------3-----------------------#2018-09-03">https://itnext.io/reverse-tunnels-for-your-home-assistant-on-a-raspberry-pi-cf5c63b7638e?source=collection_archive---------3-----------------------#2018-09-03</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div class="gh gi jn"><img src="../Images/042abb0f01a5cf2334c0b1bd65b3c694.png" data-original-src="https://miro.medium.com/v2/resize:fit:1120/format:webp/0*SUzo1X_PZdAt2qcN.png"/></div></figure><p id="9259" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">有很多家庭自动化系统，但我最喜欢的是<a class="ae ks" href="https://www.home-assistant.io/" rel="noopener ugc nofollow" target="_blank">家庭助手</a>。它是用Python写的(GitHub 上有<a class="ae ks" href="https://github.com/home-assistant/home-assistant" rel="noopener ugc nofollow" target="_blank">，有一个很好的用户界面，非常容易部署。家庭助理与许多其他在线服务和硬件设备进行了大量集成。它与红色节点(</a><a class="ae ks" href="https://nodered.org/" rel="noopener ugc nofollow" target="_blank">https://nodered.org</a>)配合得非常好。</p><p id="1ed1" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">在这篇短文中，我们将使用:</p><ul class=""><li id="270a" class="kt ku iq jw b jx jy kb kc kf kv kj kw kn kx kr ky kz la lb bi translated">Raspbian  —操作系统</li><li id="3afd" class="kt ku iq jw b jx lc kb ld kf le kj lf kn lg kr ky kz la lb bi translated"><a class="ae ks" href="https://etcher.io/" rel="noopener ugc nofollow" target="_blank">Etcher</a>——可能是刻录图像的最佳工具，即使你不关心HA或本文的其余部分，也要试试Etcher！</li><li id="ef8c" class="kt ku iq jw b jx lc kb ld kf le kj lf kn lg kr ky kz la lb bi translated"><a class="ae ks" href="https://www.raspberrypi.org/products/" rel="noopener ugc nofollow" target="_blank">树莓派</a> —我们的迷你电脑:)</li><li id="039a" class="kt ku iq jw b jx lc kb ld kf le kj lf kn lg kr ky kz la lb bi translated"><a class="ae ks" href="https://www.docker.com/" rel="noopener ugc nofollow" target="_blank"> Docker </a> —打包和运行服务器应用程序的最简单方式</li><li id="0a6f" class="kt ku iq jw b jx lc kb ld kf le kj lf kn lg kr ky kz la lb bi translated"><a class="ae ks" href="https://webhookrelay.com/" rel="noopener ugc nofollow" target="_blank"> Webhook中继</a> —从外部访问家庭助手的隧道服务</li><li id="c432" class="kt ku iq jw b jx lc kb ld kf le kj lf kn lg kr ky kz la lb bi translated"><a class="ae ks" href="https://www.home-assistant.io/" rel="noopener ugc nofollow" target="_blank">家庭助手</a> —家庭自动化系统</li></ul><h1 id="11fb" class="lh li iq bd lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me bi translated">TL；速度三角形定位法(dead reckoning)</h1><p id="60d5" class="pw-post-body-paragraph ju jv iq jw b jx mf jz ka kb mg kd ke kf mh kh ki kj mi kl km kn mj kp kq kr ij bi translated">创建通过<a class="ae ks" href="https://my.webhookrelay.com/tunnels" rel="noopener ugc nofollow" target="_blank"> UI </a>的隧道，并在此提供访问密钥&amp;秘密<a class="ae ks" href="https://my.webhookrelay.com/tokens" rel="noopener ugc nofollow" target="_blank">。</a></p><p id="fb5a" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">有了这些详细信息，在隧道模式下启动<strong class="jw ir"> webhookrelayd </strong>容器，并指定您的隧道名称(在本例中，隧道名称为<code class="fe mk ml mm mn b">rpi</code>):</p><pre class="mo mp mq mr gt ms mn mt mu aw mv bi"><span id="5a41" class="mw li iq mn b gy mx my l mz na">docker run --name whr-relayd --net host --restart always -d webhookrelay/webhookrelayd-arm:latest --mode tunnel -t rpi -k token-key -s token-secret</span></pre><p id="b448" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">请注意，如果您在另一个容器中运行Home Assistant，那么<code class="fe mk ml mm mn b">--net host</code>并不是真正必需的，在这种情况下，您可以只使用Docker网络。</p><p id="9d40" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated"><strong class="jw ir">启动家庭助手</strong></p><pre class="mo mp mq mr gt ms mn mt mu aw mv bi"><span id="317e" class="mw li iq mn b gy mx my l mz na">docker run -d --name assistant --net host -v /home/pi/home_assistant:/config -v /etc/localtime:/etc/localtime:ro --restart always homeassistant/raspberrypi3-homeassistant:0.76.2</span></pre><p id="829b" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">从任何地方打开<code class="fe mk ml mm mn b">your-subdomain.webrelay.io</code>浏览器中的隧道:</p><figure class="mo mp mq mr gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="nc nd di ne bf nf"><div class="gh gi nb"><img src="../Images/5bf9b45699e72dbf40a808c7d7061042.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*WxcRcICjyoS1dUyH.png"/></div></div></figure></div><div class="ab cl ng nh hu ni" role="separator"><span class="nj bw bk nk nl nm"/><span class="nj bw bk nk nl nm"/><span class="nj bw bk nk nl"/></div><div class="ij ik il im in"><h1 id="d491" class="lh li iq bd lj lk nn lm ln lo no lq lr ls np lu lv lw nq ly lz ma nr mc md me bi translated">详细版本</h1><h2 id="a86d" class="mw li iq bd lj ns nt dn ln nu nv dp lr kf nw nx lv kj ny nz lz kn oa ob md oc bi translated">存储卡准备:</h2><ul class=""><li id="8554" class="kt ku iq jw b jx mf kb mg kf od kj oe kn of kr ky kz la lb bi translated">将MicroSD存储卡插入计算机</li><li id="40f3" class="kt ku iq jw b jx lc kb ld kf le kj lf kn lg kr ky kz la lb bi translated">格式化它</li><li id="02f2" class="kt ku iq jw b jx lc kb ld kf le kj lf kn lg kr ky kz la lb bi translated">从<a class="ae ks" href="https://www.raspberrypi.org/downloads/raspbian/" rel="noopener ugc nofollow" target="_blank">https://www.raspberrypi.org/downloads/raspbian/</a>下载Raspbian操作系统镜像</li><li id="ed7a" class="kt ku iq jw b jx lc kb ld kf le kj lf kn lg kr ky kz la lb bi translated">打开<a class="ae ks" href="https://etcher.io/" rel="noopener ugc nofollow" target="_blank">蚀刻机</a></li></ul><figure class="mo mp mq mr gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="nc nd di ne bf nf"><div class="gh gi og"><img src="../Images/2bc350ab02f67e1bfdef9bd973f0c800.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*KJHurUQvWedhD0Jo.png"/></div></div></figure><ul class=""><li id="8d12" class="kt ku iq jw b jx jy kb kc kf kv kj kw kn kx kr ky kz la lb bi translated">使用Etcher选择下载的Raspbian图像</li><li id="5951" class="kt ku iq jw b jx lc kb ld kf le kj lf kn lg kr ky kz la lb bi translated">选择与您的存储卡相对应的驱动器</li><li id="f22f" class="kt ku iq jw b jx lc kb ld kf le kj lf kn lg kr ky kz la lb bi translated">点击flash！</li></ul><h1 id="75cc" class="lh li iq bd lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me bi translated">安装Docker</h1><p id="c1ae" class="pw-post-body-paragraph ju jv iq jw b jx mf jz ka kb mg kd ke kf mh kh ki kj mi kl km kn mj kp kq kr ij bi translated">从拉斯边桌面发射终端。现在，使用终端安装Docker:</p><pre class="mo mp mq mr gt ms mn mt mu aw mv bi"><span id="e4e7" class="mw li iq mn b gy mx my l mz na">curl -sSL <a class="ae ks" href="https://get.docker.com" rel="noopener ugc nofollow" target="_blank">https://get.docker.com</a> | sh</span></pre><p id="30b0" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">关于Docker对Raspberry Pi支持的官方博客文章可以在<a class="ae ks" href="https://www.raspberrypi.org/blog/docker-comes-to-raspberry-pi/" rel="noopener ugc nofollow" target="_blank">这里</a>找到。</p><p id="6796" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">现在，重新启动它:</p><pre class="mo mp mq mr gt ms mn mt mu aw mv bi"><span id="33ca" class="mw li iq mn b gy mx my l mz na">sudo reboot</span></pre><h1 id="a6ee" class="lh li iq bd lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me bi translated">安装家庭助手</h1><p id="d042" class="pw-post-body-paragraph ju jv iq jw b jx mf jz ka kb mg kd ke kf mh kh ki kj mi kl km kn mj kp kq kr ij bi translated">访问Docker Hub上的Raspberry Pi 3 Home Assistant存储库，确定可用的最新版本。启动家庭助手非常简单:</p><pre class="mo mp mq mr gt ms mn mt mu aw mv bi"><span id="807f" class="mw li iq mn b gy mx my l mz na">docker run -d --name assistant --net host -v /home/pi/home_assistant:/config -v /etc/localtime:/etc/localtime:ro --restart always homeassistant/raspberrypi3-homeassistant:0.76.2</span></pre><h1 id="995b" class="lh li iq bd lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me bi translated">创建隧道和令牌</h1><p id="4827" class="pw-post-body-paragraph ju jv iq jw b jx mf jz ka kb mg kd ke kf mh kh ki kj mi kl km kn mj kp kq kr ij bi translated">在浏览器中打开https://my.webhookrelay.com/tunnels<a class="ae ks" href="https://my.webhookrelay.com/tunnels" rel="noopener ugc nofollow" target="_blank">并点击“创建隧道”。如果你是一个免费计划，让'子域'和'加密'字段为空，因为它们只适用于付费计划，你会得到自动生成的子域。</a></p><figure class="mo mp mq mr gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="nc nd di ne bf nf"><div class="gh gi oh"><img src="../Images/4635a9d4f8fa2bbd5ac05d97a629dfba.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*D3w6XnRDAYFOD1go.png"/></div></div></figure><p id="b93a" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">我们还需要一个令牌进行身份验证。转到https://my.webhookrelay.com/tokens<a class="ae ks" href="https://my.webhookrelay.com/tokens" rel="noopener ugc nofollow" target="_blank">创建一个新的令牌密钥&amp;秘密对:</a></p><figure class="mo mp mq mr gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="nc nd di ne bf nf"><div class="gh gi oi"><img src="../Images/cf45b6c11dd33bc61c685ac22af46222.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*mX1OckPdH4UUv1pS.png"/></div></div></figure><p id="a7a3" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">保持秘密在某个安全的地方，因为它现在被加密，不能恢复。如果你弄丢了，就生成一个新的。</p><h1 id="826a" class="lh li iq bd lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me bi translated">启动webhookrelayd</h1><p id="19ad" class="pw-post-body-paragraph ju jv iq jw b jx mf jz ka kb mg kd ke kf mh kh ki kj mi kl km kn mj kp kq kr ij bi translated">要启动隧道守护进程，请运行(只需用您自己的密钥和密码替换):</p><pre class="mo mp mq mr gt ms mn mt mu aw mv bi"><span id="04ba" class="mw li iq mn b gy mx my l mz na">docker run --name whr-relayd --net host --restart always -d webhookrelay/webhookrelayd-arm:latest --mode tunnel -t rpi -k your-key -s your-secret</span></pre><h1 id="2a9f" class="lh li iq bd lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me bi translated">结论</h1><p id="0cb7" class="pw-post-body-paragraph ju jv iq jw b jx mf jz ka kb mg kd ke kf mh kh ki kj mi kl km kn mj kp kq kr ij bi translated">就是这样，现在你可以远程访问你的家庭助理，而不需要配置你的路由器，获得静态IP或购买域名。隧道也可以通过基本认证来保护，但如果您只为您的家庭助理启用认证会更好。查看官方<a class="ae ks" href="https://www.home-assistant.io/components/http/" rel="noopener ugc nofollow" target="_blank">文档</a>中的更多信息。</p><p id="e7c1" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">此外，请记住，由于Webhook中继正在进行TLS终止，理论上流量可能会被拦截(然而，事实并非如此。只有webhooks可以被记录和重放)。为了解决这一潜在问题，我们将引入HTTPS直通模式，在这种模式下，加密流量将通过服务进行路由，并且仅在高可用性实例处终止。</p><p id="952e" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">另外，如果你是开发人员、工程师或者仅仅是技术人员，请尝试一下Webhook中继服务，我很乐意听到你的反馈！❤</p><p id="6fe1" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">附注#2:我目前正在试验hass.io插件，以使你的家庭自动化实例与IFTTT或Zapier服务的集成变得非常容易，我将很快就此写一篇博文:)</p></div><div class="ab cl ng nh hu ni" role="separator"><span class="nj bw bk nk nl nm"/><span class="nj bw bk nk nl nm"/><span class="nj bw bk nk nl"/></div><div class="ij ik il im in"><p id="6f65" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated"><em class="oj">原载于2018年9月3日</em><a class="ae ks" href="https://webhookrelay.com/blog/2018/09/03/home-assistant-remote-access/" rel="noopener ugc nofollow" target="_blank"><em class="oj">webhookrelay.com</em></a><em class="oj">。</em></p></div></div>    
</body>
</html>