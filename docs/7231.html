<html>
<head>
<title>Scheduler with an API: Rocketry + FastAPI</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">带有API的调度程序:Rocketry + FastAPI</h1>
<blockquote>原文：<a href="https://itnext.io/scheduler-with-an-api-rocketry-fastapi-a0f742278d5b?source=collection_archive---------0-----------------------#2022-07-23">https://itnext.io/scheduler-with-an-api-rocketry-fastapi-a0f742278d5b?source=collection_archive---------0-----------------------#2022-07-23</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><figure class="ip iq gp gr ir is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi io"><img src="../Images/0405b7b79b688b76bfc7b7202b0148c2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ncxYLUu4dXFjS353tezM3g.png"/></div></div></figure><div class=""/><p id="6041" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">如果你需要一个调度程序和一种与它们交流的方式，FastAPI 和<a class="ae kw" href="https://rocketry.readthedocs.io/" rel="noopener ugc nofollow" target="_blank">rockerry</a>是很好的一对。FastAPI是一个现代的API web框架，Rocketry是一个现代的调度后端。它们都易于使用，范围广泛，并且可以无缝地协同工作。</p><blockquote class="kx ky kz"><p id="9272" class="jy jz la ka b kb kc kd ke kf kg kh ki lb kk kl km lc ko kp kq ld ks kt ku kv ij bi translated">提示:我在这里做了一个完整的例子<a class="ae kw" href="https://github.com/Miksus/rocketry-with-fastapi" rel="noopener ugc nofollow" target="_blank"/>，你可以直接复制。</p></blockquote><h1 id="ffac" class="le lf jb bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">关于火箭技术和FastAPI</h1><p id="040c" class="pw-post-body-paragraph jy jz jb ka b kb mc kd ke kf md kh ki kj me kl km kn mf kp kq kr mg kt ku kv ij bi translated">在我们开始我们的项目之前，先简单介绍一下这些技术。这两个框架都很新，但它们都经过了良好的测试和生产质量。它们看起来也非常相似，尽管它们的目的完全不同(Rocketry的灵感来自FastAPI)。接下来，我们将对这两者进行一些讨论。</p><h2 id="f17e" class="mh lf jb bd lg mi mj dn lk mk ml dp lo kj mm mn ls kn mo mp lw kr mq mr ma ms bi translated">关于火箭技术</h2><p id="d9e4" class="pw-post-body-paragraph jy jz jb ka b kb mc kd ke kf md kh ki kj me kl km kn mf kp kq kr mg kt ku kv ij bi translated">Rocketry是一个现代化的调度框架，具有强大的条件系统，可以用简单的语法实现复杂的调度。它还具有:</p><ul class=""><li id="5823" class="mt mu jb ka b kb kc kf kg kj mv kn mw kr mx kv my mz na nb bi translated">任务并行化(异步、线程和子进程)</li><li id="7653" class="mt mu jb ka b kb nc kf nd kj ne kn nf kr ng kv my mz na nb bi translated">任务参数化</li><li id="620e" class="mt mu jb ka b kb nc kf nd kj ne kn nf kr ng kv my mz na nb bi translated">任务流水线(一个接一个地运行任务)</li><li id="8dab" class="mt mu jb ka b kb nc kf nd kj ne kn nf kr ng kv my mz na nb bi translated">完全可修改的运行时间</li></ul><p id="87f6" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">特别是异步支持和完全可修改的运行时在我们将Rocketry和FastAPI结合起来的项目中非常有用。我们可以使用我们的API读取任务日志、关闭调度程序或者创建、删除、终止或运行任务。</p><p id="ed68" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">这是火箭技术的样子:</p><figure class="nh ni nj nk gt is"><div class="bz fp l di"><div class="nl nm l"/></div></figure><p id="b8d6" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">Rocketry也有100多个内置条件，如果你愿意，你可以创建自己的条件。它可以处理非常复杂的调度策略。</p><p id="72a9" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">火箭的文档:<a class="ae kw" href="https://rocketry.readthedocs.io/" rel="noopener ugc nofollow" target="_blank">https://rocketry.readthedocs.io/</a></p><h2 id="491f" class="mh lf jb bd lg mi mj dn lk mk ml dp lo kj mm mn ls kn mo mp lw kr mq mr ma ms bi translated">关于FastAPI</h2><p id="2703" class="pw-post-body-paragraph jy jz jb ka b kb mc kd ke kf md kh ki kj me kl km kn mf kp kq kr mg kt ku kv ij bi translated">FastAPI是一个现代的web框架，通常用于构建REST APIs。它是健壮的、快速的和直观的。它内置了数据验证功能，就像Rocketry一样，使用起来非常简单:</p><figure class="nh ni nj nk gt is"><div class="bz fp l di"><div class="nl nm l"/></div></figure><p id="dfa6" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">FastAPI的文档:<a class="ae kw" href="https://fastapi.tiangolo.com/" rel="noopener ugc nofollow" target="_blank">https://fastapi.tiangolo.com/</a></p><h1 id="c45c" class="le lf jb bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">创建我们的应用程序</h1><p id="cb8c" class="pw-post-body-paragraph jy jz jb ka b kb mc kd ke kf md kh ki kj me kl km kn mf kp kq kr mg kt ku kv ij bi translated">现在我们已经了解了我们的工具，接下来我们将创建一个调度器，在其上构建一个API。我们的应用程序将由三部分组成:</p><ul class=""><li id="0726" class="mt mu jb ka b kb kc kf kg kj mv kn mw kr mx kv my mz na nb bi translated">FastAPI应用程序，我们称之为<em class="la"> api.py </em></li><li id="3f35" class="mt mu jb ka b kb nc kf nd kj ne kn nf kr ng kv my mz na nb bi translated">Rocketry应用程序，我们称之为<em class="la"> scheduler.py </em></li><li id="124f" class="mt mu jb ka b kb nc kf nd kj ne kn nf kr ng kv my mz na nb bi translated">结合了两者的启动器，我们称之为<em class="la"> main.py </em></li></ul><p id="f765" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在我们开始之前，请确保您的Python版本为3.7或更高。然后我们需要安装一些软件包:</p><pre class="nh ni nj nk gt nn no np nq aw nr bi"><span id="54e7" class="mh lf jb no b gy ns nt l nu nv">pip install rocketry<br/>pip install fastapi<br/>pip install "uvicorn[standard]"</span></pre><p id="9d89" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">Uvicorn是一个web服务器，我们将使用它来运行FastAPI应用程序。</p><h2 id="16a9" class="mh lf jb bd lg mi mj dn lk mk ml dp lo kj mm mn ls kn mo mp lw kr mq mr ma ms bi translated">创建调度程序</h2><p id="d283" class="pw-post-body-paragraph jy jz jb ka b kb mc kd ke kf md kh ki kj me kl km kn mf kp kq kr mg kt ku kv ij bi translated">接下来，我们将创建我们的调度程序(scheduler.py):</p><figure class="nh ni nj nk gt is"><div class="bz fp l di"><div class="nl nm l"/></div></figure><p id="162b" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我们首先创建了Rocketry实例，其中我们指定默认执行是异步的。您可以将它设置为您想要的任何值，但是如果您没有CPU密集型任务，async通常是一个很好的选择。创建应用程序后，我们创建了两个任务。请根据问题的需要随意修改任务。</p><h2 id="450d" class="mh lf jb bd lg mi mj dn lk mk ml dp lo kj mm mn ls kn mo mp lw kr mq mr ma ms bi translated">创建API</h2><p id="70d0" class="pw-post-body-paragraph jy jz jb ka b kb mc kd ke kf md kh ki kj me kl km kn mf kp kq kr mg kt ku kv ij bi translated">接下来，我们将创建我们的API (api.py):</p><figure class="nh ni nj nk gt is"><div class="bz fp l di"><div class="nl nm l"/></div></figure><p id="39e7" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我们创建了FastAPI应用程序，然后导入了scheduler的应用程序，因为我们需要在我们的routes中修改它。最后，我们创建了一些路由，其中一些用于检索信息，一些用于执行某种操作，如设置特定的任务运行。</p><p id="dee4" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">注意，关闭路径不会关闭FastAPI。为了关闭这两者，需要将FastAPI嵌入到Rocketry的任务中，这超出了本文的范围。</p><h2 id="bd33" class="mh lf jb bd lg mi mj dn lk mk ml dp lo kj mm mn ls kn mo mp lw kr mq mr ma ms bi translated">将Rocketry与FastAPI相结合</h2><p id="6c69" class="pw-post-body-paragraph jy jz jb ka b kb mc kd ke kf md kh ki kj me kl km kn mf kp kq kr mg kt ku kv ij bi translated">现在我们有了Rocketry应用程序(调度程序)和FastAPI应用程序(API ),我们需要将它们结合起来，这样我们实际上可以同时运行这两个程序。如果你想测试它们，你可以独立运行它们。</p><p id="23fa" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">Rocketry和FastAPI都使用<a class="ae kw" href="https://docs.python.org/3/library/asyncio.html" rel="noopener ugc nofollow" target="_blank"> async </a>运行，所以我们可以用它同时运行两者。我们需要创建一个异步函数来启动两个应用程序，并在应用程序完成之前保持空闲:</p><figure class="nh ni nj nk gt is"><div class="bz fp l di"><div class="nl nm l"/></div></figure><p id="93e4" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">您可能想知道为什么我们需要对uvicorn服务器进行子类化。你可以不这样做，但是Rocketry不会响应CTRL + C(手动中断)。这是因为Uvicorn会覆盖信号，以便对中断做出响应。我们基本上是把火箭的关闭呼叫加到了紫玉米的退出信号上。</p><p id="13b2" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在<em class="la"> main </em>函数中，我们创建了两个异步任务:一个用于Uvicorn服务器(运行FastAPI ),一个用于Rocketry的应用程序。然后我们<em class="la">等待</em>，这样调度程序和API就可以像异步一样一次运行一行Python代码。</p><p id="82a1" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">基本上，这个应用程序设置在Rocketry和FastAPI之间不断切换。例如，rockerry检查一个任务的开始条件，然后FastAPI响应一个到达API的请求，然后执行返回rockerry并可能运行该任务。换句话说，没有代码是并行运行的，但是代码执行会在应用程序之间不断切换。这听起来可能很慢，但在大多数情况下，它实际上相当快。</p><h1 id="ec68" class="le lf jb bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">接下来呢？</h1><p id="3c0f" class="pw-post-body-paragraph jy jz jb ka b kb mc kd ke kf md kh ki kj me kl km kn mf kp kq kr mg kt ku kv ij bi translated">为API创建所有相关的路由需要大量的手工工作。我做了一个模板，你可以复制来快速上手:<a class="ae kw" href="https://github.com/Miksus/rocketry-with-fastapi" rel="noopener ugc nofollow" target="_blank">https://github.com/Miksus/rocketry-with-fastapi</a>。</p><p id="032b" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">更多资源:</p><ul class=""><li id="dd4d" class="mt mu jb ka b kb kc kf kg kj mv kn mw kr mx kv my mz na nb bi translated">火箭的文档:<a class="ae kw" href="https://rocketry.readthedocs.io/" rel="noopener ugc nofollow" target="_blank">https://rocketry.readthedocs.io/</a></li><li id="a4e5" class="mt mu jb ka b kb nc kf nd kj ne kn nf kr ng kv my mz na nb bi translated">火箭的源代码:<a class="ae kw" href="https://github.com/Miksus/rocketry" rel="noopener ugc nofollow" target="_blank">https://github.com/Miksus/rocketry</a></li><li id="d73f" class="mt mu jb ka b kb nc kf nd kj ne kn nf kr ng kv my mz na nb bi translated">火箭学介绍:<a class="ae kw" rel="noopener ugc nofollow" target="_blank" href="/red-engine-insanely-powerful-scheduler-7d9d8e84b58b">https://it next . io/red-engine-insurally-powerful-scheduler-7d 9d 8e 84 b 58 b</a></li></ul><p id="d637" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">如果你喜欢你所读的，考虑离开Rocketry一个明星，并告诉其他人。开发是由创造令人敬畏的事物的热情推动的。</p></div></div>    
</body>
</html>