<html>
<head>
<title>Infrastructure Resilience: Handling Invalid Configuration in the Envoy Proxy</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">基础设施弹性:处理特使代理中的无效配置</h1>
<blockquote>原文：<a href="https://itnext.io/infrastructure-resilience-handling-invalid-configuration-in-the-envoy-proxy-f20883eba8a7?source=collection_archive---------5-----------------------#2019-12-02">https://itnext.io/infrastructure-resilience-handling-invalid-configuration-in-the-envoy-proxy-f20883eba8a7?source=collection_archive---------5-----------------------#2019-12-02</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/5fac15703d9460219d2c5f73756df56e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*6C_m6aUJXnQWbuFQ"/></div></div></figure><p id="c6fd" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">随着微服务部署规模的增加，管理流量路由的问题变得越来越复杂。当配置出错时，可能会导致从控制面板停机到<a class="ae kw" href="https://medium.com/@SkyscannerEng/misunderstanding-the-behaviour-of-one-templating-line-and-the-pain-it-caused-our-k8s-clusters-a420f30a99f1" rel="noopener">服务中断</a>的一切事情。</p><p id="b5b5" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">这篇简短的博文将介绍Gloo(基于Envoy的API网关)如何应对管理Envoy的大规模配置的挑战，以防止无效配置中断服务。</p><p id="a6a7" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">API网关和服务网格的用户经常处理必须被独立管理(即，每个服务)的大量配置对象，但是经常被合并到单个代理的配置中。这些配置包含大量跨对象的依赖关系，如下图所示:</p><figure class="ky kz la lb gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi kx"><img src="../Images/c95b77f7d1e39ef59a6f2104332ac94b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*5N5bVdjWCuMFAdM8"/></div></div></figure><p id="d9ce" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">用户经常使用Helm和Jsonnet等模板技术来管理大量路由配置(以及他们的服务、部署、配置映射和其他CRD)。这有助于减少管理所有这些配置的痛苦，但对减少配置相互依赖的问题没有什么帮助。请注意当单个配置无效时会发生什么:</p><figure class="ky kz la lb gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi lc"><img src="../Images/ce51134cb60787931172705415c26993.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*cycBtCTizUKHPvqH"/></div></div></figure><p id="6d0e" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在提供的图表中，两个路由表都变得无效，因为TLS机密无效，它们无法再路由到服务4。</p><p id="741c" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">对于运营商来说，配置的语法和功能验证变得越来越困难，尤其是对于可能跨越多个集群、云环境和k8s外工作负载的路由配置。资源之间通常存在依赖关系——服务、TLS秘密、<a class="ae kw" href="https://docs.solo.io/gloo/latest/gloo_routing/virtual_services/delegation/" rel="noopener ugc nofollow" target="_blank"> <em class="ld">、委托路由</em> </a>，而kubernetes服务需要不同配置之间的协调。</p><p id="58d3" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在大规模微服务环境中管理流量时，无效配置会导致漏洞和服务中断。因此，健壮的控制平面负责防止无效配置影响<a class="ae kw" href="https://blog.envoyproxy.io/service-mesh-data-plane-vs-control-plane-2774e720f7fc" rel="noopener ugc nofollow" target="_blank">数据平面</a>(代理)。</p><p id="df43" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">本文将探讨基于Envoy的API网关<a class="ae kw" href="https://docs.solo.io/gloo/latest/" rel="noopener ugc nofollow" target="_blank"> Gloo </a>如何处理和防止无效路由配置。</p><h1 id="9214" class="le lf iq bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">Gloo如何防止配置错误</h1><p id="e5ce" class="pw-post-body-paragraph jy jz iq ka b kb mc kd ke kf md kh ki kj me kl km kn mf kp kq kr mg kt ku kv ij bi translated">Gloo是下一代API网关和Kubernetes入口控制器，构建于Envoy代理之上。Gloo处理用户配置和环境数据，以动态配置Envoy中的路由和过滤器。在Kubernetes上运行Gloo时，这个用户配置是以<a class="ae kw" href="https://kubernetes.io/docs/tasks/access-kubernetes-api/custom-resources/custom-resource-definitions/" rel="noopener ugc nofollow" target="_blank">自定义资源</a> (CRDs)的形式提供的。</p><p id="099b" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">当用户请求创建或修改Gloo的定制资源之一时，该请求由Gloo的<a class="ae kw" href="https://kubernetes.io/docs/reference/access-authn-authz/extensible-admission-controllers/" rel="noopener ugc nofollow" target="_blank">验证准入Webhook </a>处理。Gloo运行一个内部转换循环，以验证对整个集群配置的每个单独更新都会产生一个有效的特使配置。如果Gloo检测到请求的更改会产生无效的Envoy配置，它会在被<em class="ld">允许</em>到Kubernetes存储之前被拒绝，客户端(kubectl或另一个与Kubernetes API交互的工具)会向用户返回一个错误。</p><p id="2f87" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">管理员可以通过<a class="ae kw" href="https://docs.solo.io/gloo/latest/api/github.com/solo-io/gloo/projects/gloo/api/v1/settings.proto.sk/#settings" rel="noopener ugc nofollow" target="_blank">设置API </a>配置Gloo验证的严格程度，以及Gloo应该如何处理已经被接受的无效配置的选项(例如，在验证被禁用的情况下)。</p><p id="7645" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">试试<a class="ae kw" href="https://gloo.solo.io/gloo_routing/validation/" rel="noopener ugc nofollow" target="_blank"> <strong class="ka ir">验证教程</strong> </a>看看Gloo如何保护API网关配置。</p><p id="09f4" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">Gloo是可用的开源或企业，我们邀请您尝试一下，并期待您的反馈。</p><ul class=""><li id="babb" class="mh mi iq ka b kb kc kf kg kj mj kn mk kr ml kv mm mn mo mp bi translated">了解更多关于<a class="ae kw" href="http://www.solo.io/gloo" rel="noopener ugc nofollow" target="_blank"> Gloo </a>的信息，并尝试<a class="ae kw" href="https://gloo.solo.io/gloo_routing/validation/" rel="noopener ugc nofollow" target="_blank">教程</a>。</li><li id="3caa" class="mh mi iq ka b kb mq kf mr kj ms kn mt kr mu kv mm mn mo mp bi translated"><a class="ae kw" href="https://slack.solo.io" rel="noopener ugc nofollow" target="_blank">加入我们的Slack </a>，分享您的问题和反馈。</li><li id="23c2" class="mh mi iq ka b kb mq kf mr kj ms kn mt kr mu kv mm mn mo mp bi translated"><a class="ae kw" href="https://github.com/solo-io/gloo" rel="noopener ugc nofollow" target="_blank">在GitHub中提出问题</a>。</li></ul><p id="68b0" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">感谢阅读，敬请关注更多来自<a class="ae kw" href="https://www.solo.io/" rel="noopener ugc nofollow" target="_blank"> Solo.io </a>的博客和令人兴奋的开源软件！</p></div></div>    
</body>
</html>