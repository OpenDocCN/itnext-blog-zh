<html>
<head>
<title>Storage Balance and Data Migration in Graph Database</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">图形数据库中的存储平衡和数据迁移</h1>
<blockquote>原文：<a href="https://itnext.io/storage-balance-and-data-migration-in-graph-database-2aced5447ae4?source=collection_archive---------4-----------------------#2022-09-20">https://itnext.io/storage-balance-and-data-migration-in-graph-database-2aced5447ae4?source=collection_archive---------4-----------------------#2022-09-20</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/b196a41d12f0591a4de76dcaeee9a471.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*OcsqttOvaQCqqw8p.png"/></div></div></figure><p id="c49c" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在我们的帖子<a class="ae kw" href="https://nebula-graph.io/posts/nebula-graph-storage-engine-overview" rel="noopener ugc nofollow" target="_blank"> <em class="kx">存储设计</em> </a>中，我们提到分布式kv存储由元服务管理。分区分布和机器状态都可以在元服务中找到。用户可以使用控制台中的命令来添加或删除机器，以执行存储服务的平衡计划。</p><p id="08ed" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><strong class="ka ir"> NebulaGraph </strong>的服务由三部分组成:图形、存储和元。这篇文章将介绍如何在存储服务中实现数据(分区)和工作负载平衡。</p><p id="ff0f" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">存储服务可以通过下面的<code class="fe ky kz la lb b">BALANCE</code>命令水平缩放:</p><ul class=""><li id="0bc2" class="lc ld iq ka b kb kc kf kg kj le kn lf kr lg kv lh li lj lk bi translated"><code class="fe ky kz la lb b">BALANCE DATA</code>用于将数据从旧机器迁移到新机器</li><li id="705d" class="lc ld iq ka b kb ll kf lm kj ln kn lo kr lp kv lh li lj lk bi translated"><code class="fe ky kz la lb b">BALANCE LEADER</code>只改变主分区的分布来平衡工作负载，不移动数据</li></ul><h1 id="6947" class="lq lr iq bd ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn bi translated">目录</h1><ul class=""><li id="9777" class="lc ld iq ka b kb mo kf mp kj mq kn mr kr ms kv lh li lj lk bi translated">平衡机制介绍</li><li id="b170" class="lc ld iq ka b kb ll kf lm kj ln kn lo kr lp kv lh li lj lk bi translated">集群数据迁移</li><li id="b930" class="lc ld iq ka b kb ll kf lm kj ln kn lo kr lp kv lh li lj lk bi translated">步骤1:先决条件</li><li id="9dfe" class="lc ld iq ka b kb ll kf lm kj ln kn lo kr lp kv lh li lj lk bi translated">步骤1.1显示当前集群状态</li><li id="29ca" class="lc ld iq ka b kb ll kf lm kj ln kn lo kr lp kv lh li lj lk bi translated">步骤1.2创建图形空间</li><li id="ac05" class="lc ld iq ka b kb ll kf lm kj ln kn lo kr lp kv lh li lj lk bi translated">步骤2添加新主机</li><li id="44f0" class="lc ld iq ka b kb ll kf lm kj ln kn lo kr lp kv lh li lj lk bi translated">第三步数据迁移</li><li id="2708" class="lc ld iq ka b kb ll kf lm kj ln kn lo kr lp kv lh li lj lk bi translated">步骤4如果中途停止数据平衡，…</li><li id="3604" class="lc ld iq ka b kb ll kf lm kj ln kn lo kr lp kv lh li lj lk bi translated">步骤5数据迁移完成</li><li id="8f30" class="lc ld iq ka b kb ll kf lm kj ln kn lo kr lp kv lh li lj lk bi translated">接下来，平衡领导者</li><li id="00b9" class="lc ld iq ka b kb ll kf lm kj ln kn lo kr lp kv lh li lj lk bi translated">批量放大</li><li id="e488" class="lc ld iq ka b kb ll kf lm kj ln kn lo kr lp kv lh li lj lk bi translated">结论</li></ul><h1 id="4c00" class="lq lr iq bd ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn bi translated">平衡机制介绍</h1><p id="3265" class="pw-post-body-paragraph jy jz iq ka b kb mo kd ke kf mp kh ki kj mt kl km kn mu kp kq kr mv kt ku kv ij bi translated">在<a class="ae kw" href="https://nebula-graph.io" rel="noopener ugc nofollow" target="_blank"> <strong class="ka ir">星云图数据库</strong> </a> <strong class="ka ir">中，</strong>平衡是指同时平衡raft leader和partition数据。但是余额<strong class="ka ir">不会改变领导者或分区的数量</strong>。</p><p id="55ef" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">当您使用Nebula服务添加新机器时,(新)存储将自动注册到元服务。Meta计算一个相等的分区分布，然后使用<strong class="ka ir">删除分区</strong>和<strong class="ka ir">添加分区</strong>来使这些分区均匀分布。对应的命令是<code class="fe ky kz la lb b">BALANCE DATA</code>。通常，数据迁移是一个耗时的过程。</p><p id="37f6" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">然而，<code class="fe ky kz la lb b">BALANCE DATA</code>只是改变了机器之间的副本分布。但是领导(相应的工作量)不会变。接下来，您需要使用<code class="fe ky kz la lb b">BALANCE LEADER</code>命令来实现负载平衡。这个过程也是通过元服务实现的。</p><h1 id="b138" class="lq lr iq bd ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn bi translated">集群数据迁移</h1><p id="0795" class="pw-post-body-paragraph jy jz iq ka b kb mo kd ke kf mp kh ki kj mt kl km kn mu kp kq kr mv kt ku kv ij bi translated">以下示例将展示如何将集群从三个实例扩展到八个实例。</p><h1 id="35fb" class="lq lr iq bd ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn bi translated">先决条件</h1><p id="ef75" class="pw-post-body-paragraph jy jz iq ka b kb mo kd ke kf mp kh ki kj mt kl km kn mu kp kq kr mv kt ku kv ij bi translated">假设您已经启动了一个有三个副本的集群。</p><h2 id="bcf3" class="mw lr iq bd ls mx my dn lw mz na dp ma kj nb nc me kn nd ne mi kr nf ng mm nh bi translated">步骤1.1显示当前集群状态</h2><p id="333a" class="pw-post-body-paragraph jy jz iq ka b kb mo kd ke kf mp kh ki kj mt kl km kn mu kp kq kr mv kt ku kv ij bi translated">用命令<code class="fe ky kz la lb b">SHOW HOSTS:</code>显示当前状态</p><pre class="ni nj nk nl gt nm lb nn no aw np bi"><span id="c044" class="mw lr iq lb b gy nq nr l ns nt">nebula&gt; SHOW HOSTS<br/>================================================================================================<br/>| Ip            | Port  | Status | Leader count | Leader distribution | Partition distribution |<br/>================================================================================================<br/>| 192.168.8.210 | 34600 | online | 0            | No valid partition  | No valid partition     |<br/>------------------------------------------------------------------------------------------------<br/>| 192.168.8.210 | 34700 | online | 0            | No valid partition  | No valid partition     |<br/>------------------------------------------------------------------------------------------------<br/>| 192.168.8.210 | 34500 | online | 0            | No valid partition  | No valid partition     |<br/>------------------------------------------------------------------------------------------------<br/>Got 3 rows (Time spent: 5886/6835 us)</span></pre><p id="a798" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><strong class="ka ir"> <em class="kx">返回结果说明:</em> </strong></p><ul class=""><li id="38cd" class="lc ld iq ka b kb kc kf kg kj le kn lf kr lg kv lh li lj lk bi translated"><strong class="ka ir"> <em class="kx"> IP </em> </strong>和<strong class="ka ir"> <em class="kx">端口</em> </strong>是存储实例。该集群有三个没有任何数据的存储实例(192.168.8.210:34600、192.168.8.210:34700、192.168.8.210:34500)。</li><li id="5ac1" class="lc ld iq ka b kb ll kf lm kj ln kn lo kr lp kv lh li lj lk bi translated"><strong class="ka ir"> <em class="kx">状态</em> </strong>显示每个实例的状态。有两种状态，即在线/离线。当主机崩溃时，metad会在其心跳超时后将其脱机。默认心跳阈值是10分钟(可以找到参数<code class="fe ky kz la lb b">expired_threshold_sec</code> meta的配置文件)。</li><li id="e7b9" class="lc ld iq ka b kb ll kf lm kj ln kn lo kr lp kv lh li lj lk bi translated"><strong class="ka ir"> <em class="kx">首领计数</em> </strong>显示了该实例所服务的筏首领的数量。</li><li id="ab45" class="lc ld iq ka b kb ll kf lm kj ln kn lo kr lp kv lh li lj lk bi translated"><strong class="ka ir"> <em class="kx">领导者分布</em> </strong>显示领导者在各个图形空间中的分布情况。目前，还没有创建任何空间。(你可以把空间看作一个独立的名称空间——类似于MySQL中的数据库。)</li><li id="0526" class="lc ld iq ka b kb ll kf lm kj ln kn lo kr lp kv lh li lj lk bi translated"><strong class="ka ir"> <em class="kx">分区分布</em> </strong>显示不同空间的分区数量。</li></ul><figure class="ni nj nk nl gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nu"><img src="../Images/0f54a710374fe3d00599504beb22bc18.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*-0t5qv6tVm72I-xH.png"/></div></div></figure><p id="ee7e" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我们可以看到在<em class="kx">领导者分布</em>和<em class="kx">分区分布</em>中暂时没有数据。</p><h2 id="08ee" class="mw lr iq bd ls mx my dn lw mz na dp ma kj nb nc me kn nd ne mi kr nf ng mm nh bi translated">步骤1.2创建图形空间</h2><p id="b8bb" class="pw-post-body-paragraph jy jz iq ka b kb mo kd ke kf mp kh ki kj mt kl km kn mu kp kq kr mv kt ku kv ij bi translated">创建一个名为<code class="fe ky kz la lb b">**test</code> **的图空间，有100个分区和3个副本。</p><pre class="ni nj nk nl gt nm lb nn no aw np bi"><span id="dd9f" class="mw lr iq lb b gy nq nr l ns nt">nebula&gt; CREATE SPACE test(PARTITION_NUM=100, REPLICA_FACTOR=3)</span></pre><p id="3663" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">几秒钟后，再次运行<code class="fe ky kz la lb b">SHOW HOSTS</code>命令:</p><pre class="ni nj nk nl gt nm lb nn no aw np bi"><span id="5c01" class="mw lr iq lb b gy nq nr l ns nt">nebula&gt; SHOW HOSTS<br/>================================================================================================<br/>| Ip            | Port  | Status | Leader count | Leader distribution | Partition distribution |<br/>================================================================================================<br/>| 192.168.8.210 | 34600 | online | 0            | test: 0             | test: 100              |<br/>------------------------------------------------------------------------------------------------<br/>| 192.168.8.210 | 34700 | online | 52           | test: 52            | test: 100              |<br/>------------------------------------------------------------------------------------------------<br/>| 192.168.8.210 | 34500 | online | 48           | test: 48            | test: 100              |<br/>------------------------------------------------------------------------------------------------</span></pre><figure class="ni nj nk nl gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nv"><img src="../Images/e01e0b750491b6c2c67ff04e96ab3da5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*DdlynXDImB9PoAUt.png"/></div></div></figure><p id="1c4b" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在我们创建了具有100个分区和3个副本的空间<code class="fe ky kz la lb b">test</code>后，主机192.168.8.210:34600不为任何领导者服务，而192.168.8.210:34700为52个领导者服务，192.168.8.210为48个领导者服务。领导者的分布并不均匀。</p><h1 id="3bbc" class="lq lr iq bd ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn bi translated">步骤2添加五个新实例</h1><p id="16d0" class="pw-post-body-paragraph jy jz iq ka b kb mo kd ke kf mp kh ki kj mt kl km kn mu kp kq kr mv kt ku kv ij bi translated">现在，让我们向集群中添加五个新实例。</p><p id="f8d5" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">同样，使用语句<code class="fe ky kz la lb b">SHOW HOSTS</code>显示新的状态。您可以看到已经有八个实例在服务中。但是新实例上没有运行任何分区。</p><pre class="ni nj nk nl gt nm lb nn no aw np bi"><span id="9ea3" class="mw lr iq lb b gy nq nr l ns nt">nebula&gt; SHOW HOSTS<br/>================================================================================================<br/>| Ip            | Port  | Status | Leader count | Leader distribution | Partition distribution |<br/>================================================================================================<br/>| 192.168.8.210 | 34600 | online | 0            | test: 0             | test: 100              |<br/>------------------------------------------------------------------------------------------------<br/>| 192.168.8.210 | 34900 | online | 0            | No valid partition  | No valid partition     |<br/>------------------------------------------------------------------------------------------------<br/>| 192.168.8.210 | 35940 | online | 0            | No valid partition  | No valid partition     |<br/>------------------------------------------------------------------------------------------------<br/>| 192.168.8.210 | 34920 | online | 0            | No valid partition  | No valid partition     |<br/>------------------------------------------------------------------------------------------------<br/>| 192.168.8.210 | 44920 | online | 0            | No valid partition  | No valid partition     |<br/>------------------------------------------------------------------------------------------------<br/>| 192.168.8.210 | 34700 | online | 52           | test: 52            | test: 100              |<br/>------------------------------------------------------------------------------------------------<br/>| 192.168.8.210 | 34500 | online | 48           | test: 48            | test: 100              |<br/>------------------------------------------------------------------------------------------------<br/>| 192.168.8.210 | 34800 | online | 0            | No valid partition  | No valid partition     |<br/>------------------------------------------------------------------------------------------------</span></pre><figure class="ni nj nk nl gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nw"><img src="../Images/6f8cf02b9071389ffa9f01a3d516bc48.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*ueSGfvR1t0K0S8qR.png"/></div></div></figure><p id="7abb" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">上图中，五个蓝色图标是新添加的。然而，因为我们刚刚添加了它们，所以它们不服务于分区。</p><h1 id="f39b" class="lq lr iq bd ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn bi translated">第三步数据迁移</h1><p id="39f1" class="pw-post-body-paragraph jy jz iq ka b kb mo kd ke kf mp kh ki kj mt kl km kn mu kp kq kr mv kt ku kv ij bi translated">运行命令<code class="fe ky kz la lb b">BALANCE DATA</code>:</p><pre class="ni nj nk nl gt nm lb nn no aw np bi"><span id="bb53" class="mw lr iq lb b gy nq nr l ns nt">nebula&gt; BALANCE DATA<br/>==============<br/>| ID         |<br/>==============<br/>| 1570761786 |<br/>--------------</span></pre><p id="bf17" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">如果分区分布不均，该命令将生成一个新计划并启动迁移过程。对于平衡的集群，重新运行<code class="fe ky kz la lb b">BALANCE DATA</code>不会导致任何新的操作。</p><p id="f996" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">您可以通过命令<code class="fe ky kz la lb b">BALANCE DATA $id</code>检查计划的运行进度。</p><pre class="ni nj nk nl gt nm lb nn no aw np bi"><span id="1064" class="mw lr iq lb b gy nq nr l ns nt">nebula&gt; BALANCE DATA 1570761786<br/>===============================================================================<br/>| balanceId, spaceId:partId, src-&gt;dst                           | status      |<br/>===============================================================================<br/>| [1570761786, 1:1, 192.168.8.210:34600-&gt;192.168.8.210:44920]   | succeeded   |<br/>-------------------------------------------------------------------------------<br/>| [1570761786, 1:1, 192.168.8.210:34700-&gt;192.168.8.210:34920]   | succeeded   |<br/>-------------------------------------------------------------------------------<br/>| [1570761786, 1:1, 192.168.8.210:34500-&gt;192.168.8.210:34800]   | succeeded   |<br/>-------------------------------------------------------------------------------<br/>...//We omitted some examples here.<br/>-------------------------------------------------------------------------------<br/>| [1570761786, 1:88, 192.168.8.210:34700-&gt;192.168.8.210:35940]  | succeeded   |<br/>-------------------------------------------------------------------------------<br/>| Total:189, Succeeded:170, Failed:0, In Progress:19, Invalid:0 | 89.947090%  |<br/>-------------------------------------------------------------------------------<br/>Got 190 rows (Time spent: 5454/11095 us)</span></pre><p id="b104" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><strong class="ka ir"> <em class="kx">返回结果说明:</em> </strong></p><ul class=""><li id="ace4" class="lc ld iq ka b kb kc kf kg kj le kn lf kr lg kv lh li lj lk bi translated">第一列是具体的任务。以1570761786，1:88，192 . 168 . 8 . 210:34700-&gt; 192 . 168 . 8 . 210:35940为例</li><li id="4f47" class="lc ld iq ka b kb ll kf lm kj ln kn lo kr lp kv lh li lj lk bi translated"><strong class="ka ir"> 1570761786 </strong>是余额ID</li><li id="1c26" class="lc ld iq ka b kb ll kf lm kj ln kn lo kr lp kv lh li lj lk bi translated"><strong class="ka ir"> 1:88 </strong>，1是spaceId(即空间<code class="fe ky kz la lb b">test</code>)，88是现在正在移动的分区Id</li><li id="0a35" class="lc ld iq ka b kb ll kf lm kj ln kn lo kr lp kv lh li lj lk bi translated"><strong class="ka ir">192 . 168 . 8 . 210:34700-&gt;192 . 168 . 8 . 210:3594</strong>，将数据从源实例移动到目的实例。迁移完成后，源实例上的无用数据将被垃圾收集。</li><li id="4fc1" class="lc ld iq ka b kb ll kf lm kj ln kn lo kr lp kv lh li lj lk bi translated">第二列显示任务的状态(结果)，有四种状态:</li><li id="f668" class="lc ld iq ka b kb ll kf lm kj ln kn lo kr lp kv lh li lj lk bi translated">成功</li><li id="975f" class="lc ld iq ka b kb ll kf lm kj ln kn lo kr lp kv lh li lj lk bi translated">不成功的</li><li id="6d92" class="lc ld iq ka b kb ll kf lm kj ln kn lo kr lp kv lh li lj lk bi translated">在发展中</li><li id="15b5" class="lc ld iq ka b kb ll kf lm kj ln kn lo kr lp kv lh li lj lk bi translated">无效的</li></ul><p id="97c0" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">最后一行是任务摘要。一些分区尚未迁移。</p><h1 id="6ebd" class="lq lr iq bd ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn bi translated">步骤4如果中途停止数据平衡</h1><p id="57c9" class="pw-post-body-paragraph jy jz iq ka b kb mo kd ke kf mp kh ki kj mt kl km kn mu kp kq kr mv kt ku kv ij bi translated"><code class="fe ky kz la lb b">BALANCE DATA STOP</code>命令将停止正在运行的计划并返回该计划ID。如果没有运行平衡计划，则会引发错误。</p><blockquote class="nx ny nz"><p id="52f6" class="jy jz kx ka b kb kc kd ke kf kg kh ki oa kk kl km ob ko kp kq oc ks kt ku kv ij bi translated"><em class="iq">由于一个平衡计划包含多个平衡(子)任务，</em> <code class="fe ky kz la lb b"><em class="iq">BALANCE DATA STOP</em></code> <em class="iq">并不停止正在运行的任务，而是取消后续的任务。正在运行的任务将继续，直到执行完成。</em></p></blockquote><p id="5783" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">您可以运行<code class="fe ky kz la lb b">BALANCE DATA $id</code>来显示停止的平衡计划的状态。</p><p id="1e34" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">所有运行(子)任务完成后，您可以再次运行<code class="fe ky kz la lb b">BALANCE DATA</code>命令，恢复之前的平衡计划(如果适用)。如果停止的计划中有失败的任务，该计划将重试。否则，如果所有任务都成功(例如，新机器被添加到集群)，将创建并执行新的平衡计划。</p><h1 id="5d89" class="lq lr iq bd ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn bi translated">步骤5数据迁移完成</h1><p id="41a2" class="pw-post-body-paragraph jy jz iq ka b kb mo kd ke kf mp kh ki kj mt kl km kn mu kp kq kr mv kt ku kv ij bi translated">在某些情况下，数据迁移需要几个小时甚至几天。迁移期间，<strong class="ka ir"> NebulaGraph </strong>在线服务不受影响。一旦迁移完成，进度将显示100%。您可以重试<code class="fe ky kz la lb b">BALANCE DATA</code>来修复那些失败的任务。如果几次尝试都无法修复，请通过<a class="ae kw" href="https://github.com/vesoft-inc/nebula/issues" rel="noopener ugc nofollow" target="_blank"> GitHub </a>联系我们。</p><p id="c750" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">最后，使用<code class="fe ky kz la lb b">SHOW HOSTS</code>检查最终的分区分布。</p><pre class="ni nj nk nl gt nm lb nn no aw np bi"><span id="8c42" class="mw lr iq lb b gy nq nr l ns nt">nebula&gt; SHOW HOSTS<br/>================================================================================================<br/>| Ip            | Port  | Status | Leader count | Leader distribution | *Partition distribution* |<br/>================================================================================================<br/>| 192.168.8.210 | 34600 | online | 3            | test: 3             | test: 37               |<br/>------------------------------------------------------------------------------------------------<br/>| 192.168.8.210 | 34900 | online | 0            | test: 0             | test: 38               |<br/>------------------------------------------------------------------------------------------------<br/>| 192.168.8.210 | 35940 | online | 0            | test: 0             | test: 37               |<br/>------------------------------------------------------------------------------------------------<br/>| 192.168.8.210 | 34920 | online | 0            | test: 0             | test: 38               |<br/>------------------------------------------------------------------------------------------------<br/>| 192.168.8.210 | 44920 | online | 0            | test: 0             | test: 38               |<br/>------------------------------------------------------------------------------------------------<br/>| 192.168.8.210 | 34700 | online | 35           | test: 35            | test: 37               |<br/>------------------------------------------------------------------------------------------------<br/>| 192.168.8.210 | 34500 | online | 24           | test: 24            | test: 37               |<br/>------------------------------------------------------------------------------------------------<br/>| 192.168.8.210 | 34800 | online | 38           | test: 38            | test: 38               |<br/>------------------------------------------------------------------------------------------------<br/>Got 8 rows (Time spent: 5074/6488 us)</span></pre><figure class="ni nj nk nl gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi od"><img src="../Images/442c3dc4e19a664db90b8de0c34c3113.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*Co1I9uFT3rQ_g-Eh.png"/></div></div></figure><p id="0f18" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">从<code class="fe ky kz la lb b">Partition distribution</code>列可以看出，这些数字彼此很接近(例如37或38)，总分区数是300。但是…</p><h1 id="707e" class="lq lr iq bd ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn bi translated">平衡领导者</h1><p id="ca6b" class="pw-post-body-paragraph jy jz iq ka b kb mo kd ke kf mp kh ki kj mt kl km kn mu kp kq kr mv kt ku kv ij bi translated">语句<code class="fe ky kz la lb b">BALANCE DATA</code>只迁移分区(和数据)。但领导者分布仍然不平衡，这意味着旧主机超负荷工作，而新主机没有得到充分利用。我们可以使用命令<code class="fe ky kz la lb b">BALANCE LEADER</code>重新分配raft leader。</p><pre class="ni nj nk nl gt nm lb nn no aw np bi"><span id="269e" class="mw lr iq lb b gy nq nr l ns nt">nebula&gt; BALANCE LEADER</span></pre><p id="6a8e" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">几秒钟后，使用语句<code class="fe ky kz la lb b">SHOW HOSTS</code>显示结果。</p><pre class="ni nj nk nl gt nm lb nn no aw np bi"><span id="7bd0" class="mw lr iq lb b gy nq nr l ns nt">nebula&gt; SHOW HOSTS<br/>================================================================================================<br/>| Ip            | Port  | Status | Leader count | *Leader distribution* | Partition distribution |<br/>================================================================================================<br/>| 192.168.8.210 | 34600 | online | 13           | test: 13            | test: 37               |<br/>------------------------------------------------------------------------------------------------<br/>| 192.168.8.210 | 34900 | online | 12           | test: 12            | test: 38               |<br/>------------------------------------------------------------------------------------------------<br/>| 192.168.8.210 | 35940 | online | 12           | test: 12            | test: 37               |<br/>------------------------------------------------------------------------------------------------<br/>| 192.168.8.210 | 34920 | online | 12           | test: 12            | test: 38               |<br/>------------------------------------------------------------------------------------------------<br/>| 192.168.8.210 | 44920 | online | 13           | test: 13            | test: 38               |<br/>------------------------------------------------------------------------------------------------<br/>| 192.168.8.210 | 34700 | online | 12           | test: 12            | test: 37               |<br/>------------------------------------------------------------------------------------------------<br/>| 192.168.8.210 | 34500 | online | 13           | test: 13            | test: 37               |<br/>------------------------------------------------------------------------------------------------<br/>| 192.168.8.210 | 34800 | online | 13           | test: 13            | test: 38               |<br/>------------------------------------------------------------------------------------------------</span></pre><p id="287d" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">根据<code class="fe ky kz la lb b">Leader distribution</code>列，RAFT领导者平均分布在集群中的所有主机上。</p><figure class="ni nj nk nl gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi od"><img src="../Images/78390a674415bbbc4216c5fb5e79d5fd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*-wyVi-_ohrQEqSIA.png"/></div></div></figure><p id="ebb5" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">如上图所示，当<code class="fe ky kz la lb b">BALANCE LEADER</code>运行成功时，新添加的<em class="kx">领袖分布</em>的数量(蓝色图标)与原实例(黑色图标)接近(例如12或13)。此外，由于<code class="fe ky kz la lb b">Partition distribution</code>号没有变化，这表明<code class="fe ky kz la lb b">balance leader</code>只涉及实例中领导者的重新分配。</p><h1 id="e418" class="lq lr iq bd ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn bi translated">批量放大</h1><p id="1fdc" class="pw-post-body-paragraph jy jz iq ka b kb mo kd ke kf mp kh ki kj mt kl km kn mu kp kq kr mv kt ku kv ij bi translated"><strong class="ka ir"> NebulaGraph </strong>还支持在服务期间使主机(以及集群中的规模)离线。命令是<code class="fe ky kz la lb b">BALANCE DATA REMOVE $host_list</code>。</p><p id="c600" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">例如，命令<code class="fe ky kz la lb b">BALANCE DATA REMOVE 192.168.0.1:50000,192.168.0.2:50000</code>从集群中删除两个主机，即192.168.0.1:50000和192.168.0.2:50000。</p><blockquote class="nx ny nz"><p id="6375" class="jy jz kx ka b kb kc kd ke kf kg kh ki oa kk kl km ob ko kp kq oc ks kt ku kv ij bi translated"><em class="iq">如果删除后副本数量不能满足法定数量要求(例如，从三个机器集群中远程两台机器)，</em><strong class="ka ir"><em class="iq">nebula graph</em></strong><em class="iq">将拒绝请求并返回错误代码。</em></p></blockquote><h1 id="da69" class="lq lr iq bd ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn bi translated">结论</h1><p id="7ff1" class="pw-post-body-paragraph jy jz iq ka b kb mo kd ke kf mp kh ki kj mt kl km kn mu kp kq kr mv kt ku kv ij bi translated">在本文中，我们展示了如何在raft集群上平衡数据和工作负载。如有疑问，欢迎留言评论。最后，我们看一下实例<em class="kx"> 192.168.8.210:34600 </em>的数据迁移过程。</p><figure class="ni nj nk nl gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/01123ca1bc7296c415e3f08252119701.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*SNOVM6BH4DZv39Ss.png"/></div></div></figure><p id="dd7e" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">红色数字表示命令执行后发生了变化。</p><h1 id="23c9" class="lq lr iq bd ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn bi translated">附录</h1><p id="5823" class="pw-post-body-paragraph jy jz iq ka b kb mo kd ke kf mp kh ki kj mt kl km kn mu kp kq kr mv kt ku kv ij bi translated">这是<strong class="ka ir">星云图</strong>的<a class="ae kw" href="https://github.com/vesoft-inc/nebula" rel="noopener ugc nofollow" target="_blank"> GitHub Repo </a>。欢迎尝试星云。如果您有任何疑问或问题，请发送给我们一个<a class="ae kw" href="https://github.com/vesoft-inc/nebula/issues" rel="noopener ugc nofollow" target="_blank">问题</a>。</p><h1 id="2bd7" class="lq lr iq bd ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn bi translated">你可能也会喜欢</h1><ol class=""><li id="482a" class="lc ld iq ka b kb mo kf mp kj mq kn mr kr ms kv oe li lj lk bi translated"><a class="ae kw" href="https://nebula-graph.io/posts/clean-stale-data-with-ttl-in-nebula-graph/" rel="noopener ugc nofollow" target="_blank">nebula graph如何用TTL自动清理陈旧数据</a></li><li id="789d" class="lc ld iq ka b kb ll kf lm kj ln kn lo kr lp kv oe li lj lk bi translated"><a class="ae kw" href="https://nebula-graph.io/posts/how-indexing-works-in-nebula-graph/" rel="noopener ugc nofollow" target="_blank">如何在NebulaGraph中建立索引</a></li><li id="1fd6" class="lc ld iq ka b kb ll kf lm kj ln kn lo kr lp kv oe li lj lk bi translated"><a class="ae kw" href="https://nebula-graph.io/posts/nebula-graph-snapshot-introduction/" rel="noopener ugc nofollow" target="_blank">星云图中的快照介绍</a></li></ol></div></div>    
</body>
</html>