<html>
<head>
<title>AWS: CloudFormation — using lists in Parameters</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">AWS:cloud formation-在参数中使用列表</h1>
<blockquote>原文：<a href="https://itnext.io/aws-cloudformation-using-lists-in-parameters-52982e78384f?source=collection_archive---------2-----------------------#2020-05-08">https://itnext.io/aws-cloudformation-using-lists-in-parameters-52982e78384f?source=collection_archive---------2-----------------------#2020-05-08</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/f358b82c7fdf4b01ecc455de6ab4c924.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*2pwFcOMESQtKp01Fu37QEA.jpeg"/></div></div></figure><p id="699b" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">除了<a class="ae kw" href="https://rtfm.co.ua/en/aws-elastic-kubernetes-service-a-cluster-creation-automation-part-1-cloudformation/" rel="noopener ugc nofollow" target="_blank">AWS Elastic Kubernetes Service:a cluster creation automation，第1部分— CloudFormation </a>和<a class="ae kw" href="https://rtfm.co.ua/en/aws-elastic-kubernetes-service-a-cluster-creation-automation-part-2-ansible-eksctl/" rel="noopener ugc nofollow" target="_blank">AWS Elastic Kubernetes Service:a cluster creation automation，第2部分— Ansible，eksctl </a>帖子之外，现在我将把一个参数作为一个带有多个值的列表传递给CloudFormation堆栈。</p><p id="bd6d" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">其思想是在Ansible中获取一个区域的所有AvailabilityZones，然后将该列表用于<code class="fe kx ky kz la b">eksctl</code>，这将在专用AvailabilityZones中创建WorkerNodes组，并使用相同的列表用于CloudFormation在right AvailabilityZone中创建子堆栈。</p><p id="81dc" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">对于Jenkins和Ansible，它将以另一种方式工作:</p><ol class=""><li id="250a" class="lb lc iq ka b kb kc kf kg kj ld kn le kr lf kv lg lh li lj bi translated">从a Jenkins中，作业参数取值为<em class="lk"> eu-west-3 </em>的<code class="fe kx ky kz la b">$REGION</code></li><li id="8aca" class="lb lc iq ka b kb ll kf lm kj ln kn lo kr lp kv lg lh li lj bi translated">一个Jenkins作业将启动一个Docker容器，Ansible将<code class="fe kx ky kz la b">$REGION</code>变量作为环境变量传递</li><li id="bf1d" class="lb lc iq ka b kb ll kf lm kj ln kn lo kr lp kv lg lh li lj bi translated">Ansible使用它的<code class="fe kx ky kz la b">{{ region }}</code>变量将获得Jenkins指定的区域的可用性区域列表</li><li id="a042" class="lb lc iq ka b kb ll kf lm kj ln kn lo kr lp kv lg lh li lj bi translated">并将该列表传递给<em class="lk"> cloudformation </em>角色，以在两个AvailabilityZones中创建两个嵌套堆栈</li><li id="0646" class="lb lc iq ka b kb ll kf lm kj ln kn lo kr lp kv lg lh li lj bi translated">并将该列表传递给<em class="lk"> eksctl </em>角色，以在两个可用性区域中创建节点组</li></ol><p id="1b35" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">此时，在我的云信息中，可用性区域是通过<code class="fe kx ky kz la b">Fn::GetAZs - { "Fn::Select": [ "0", { "Fn::GetAZs": "" } ] }</code>获取的:</p><pre class="lq lr ls lt gt lu la lv lw aw lx bi"><span id="790f" class="ly lz iq la b gy ma mb l mc md">...<br/>    "AZNetworkStackA": {<br/>      "Type": "AWS::CloudFormation::Stack",<br/>      "Properties": {<br/>        "TemplateURL": "eks-azs-networking.json",<br/>        "Parameters": {<br/>          "VPCID": { "Fn::GetAtt": ["RegionNetworkStack", "Outputs.VPCID"] },<br/>          "AZ": { "Fn::Select": [ "0", { "Fn::GetAZs": "" } ] },<br/>...</span></pre><p id="bfc0" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">因此，不使用<code class="fe kx ky kz la b">{ "Fn::Select": [ "0", { "Fn::GetAZs": "" } ] }</code>——让我们在Ansible中添加一个新任务来获得一个区域的所有可用区域，在那里将创建一个CloudFormation堆栈，然后它的两个角色——<em class="lk">eks CTL</em>и<em class="lk">cloud formation</em>——将使用具有相同值的相同列表。</p><p id="7cd5" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">最初的例子是很久以前在这里搜索到的— <a class="ae kw" href="https://aws.amazon.com/ru/premiumsupport/knowledge-center/multiple-values-list-parameter-cli/" rel="noopener ugc nofollow" target="_blank">我如何在AWS CloudFormation模板</a>中为单个参数使用多个值，现在我有机会在一个真实的例子中使用它。</p><h2 id="963e" class="ly lz iq bd me mf mg dn mh mi mj dp mk kj ml mm mn kn mo mp mq kr mr ms mt mu bi translated">Ansible</h2><p id="cc42" class="pw-post-body-paragraph jy jz iq ka b kb mv kd ke kf mw kh ki kj mx kl km kn my kp kq kr mz kt ku kv ij bi translated">最困难的任务是以这样一种形式创建列表，即CloudForamtion可以以正确的方式使用它，所以让我们从这开始。</p><p id="33c0" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">此外，由于这个列表将由ansi ble-worth中的两个独立角色使用，所以将它移动到一个专用任务中，并直接从角色中调用它，以避免重复代码。</p><p id="eaba" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">所以，创建一个<em class="lk">普通</em>角色:</p><pre class="lq lr ls lt gt lu la lv lw aw lx bi"><span id="db05" class="ly lz iq la b gy ma mb l mc md">$ mkdir -p roles/common/tasks</span></pre><p id="5517" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">创建一个新文件<code class="fe kx ky kz la b">roles/common/tasks/main.yml</code>，并在此创建一个任务，以获取所有可用区域，并将结果保存到一个<code class="fe kx ky kz la b">cluster_azs</code>变量中:</p><pre class="lq lr ls lt gt lu la lv lw aw lx bi"><span id="3120" class="ly lz iq la b gy ma mb l mc md">- name: "Getting AvailabilityZones list"<br/>  command: "aws ec2 describe-availability-zones --region {{ region }} --query 'AvailabilityZones[*].ZoneName' --output text"<br/>  register: cluster_azs</span></pre><p id="adb7" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><code class="fe kx ky kz la b">cluster_azs</code>将返回给我们一个如下的结构:</p><pre class="lq lr ls lt gt lu la lv lw aw lx bi"><span id="d73a" class="ly lz iq la b gy ma mb l mc md">…<br/>ok: [localhost] =&gt; {<br/>“msg”: {<br/>“changed”: true,<br/>“cmd”: [<br/>“aws”,<br/>“ec2”,<br/>“describe-availability-zones”,<br/>“ — region”,<br/>“eu-west-2”,<br/>“ — query”,<br/>“AvailabilityZones[*].ZoneName”,<br/>“ — output”,<br/>“text”<br/>],<br/>“delta”: “0:00:00.993216”,<br/>“end”: “2020–04–08 15:55:56.357234”,<br/>“failed”: false,<br/>“rc”: 0,<br/>“start”: “2020–04–08 15:55:55.364018”,<br/>“stderr”: “”,<br/>“stderr_lines”: [],<br/>“stdout”: “eu-west-2a\teu-west-2b\teu-west-2c”,<br/>“stdout_lines”: [<br/>“eu-west-2a\teu-west-2b\teu-west-2c”<br/>]<br/>}<br/>}<br/>…</span></pre><p id="5e38" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">现在，从带有"<em class="lk">eu-west-2a \ TEU-west-2b \ TEU-west-2c</em>"值的<code class="fe kx ky kz la b">stdout</code>字符串需要创建一个逗号分隔的列表。</p><p id="e95c" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">这里的元素用制表符分隔，所以我们可以使用<code class="fe kx ky kz la b">split()</code>函数来分隔它们，然后通过管道将数据传递给<code class="fe kx ky kz la b">join()</code>，它会将它们连接到一个新的列表中——但是使用逗号作为分隔符:</p><pre class="lq lr ls lt gt lu la lv lw aw lx bi"><span id="2265" class="ly lz iq la b gy ma mb l mc md">...<br/>- set_fact:<br/>    cluster_azs_names: "{{ cluster_azs.stdout.split('\t') | join(',') }}"</span></pre><p id="b60a" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">并在最后添加一个调试程序来检查结果:</p><pre class="lq lr ls lt gt lu la lv lw aw lx bi"><span id="2d3d" class="ly lz iq la b gy ma mb l mc md">...<br/>- debug:<br/>    msg: "cluster_azs_names: {{ cluster_azs_names }}"</span></pre><p id="491e" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">检查:</p><pre class="lq lr ls lt gt lu la lv lw aw lx bi"><span id="44dd" class="ly lz iq la b gy ma mb l mc md">…<br/>TASK [cloudformation : debug] ****<br/>ok: [localhost] =&gt; {<br/>“msg”: “cluster_azs_names: eu-west-2a,eu-west-2b,eu-west-2c”<br/>}<br/>…</span></pre><p id="6b13" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">酷毙了。</p><h2 id="4d8b" class="ly lz iq bd me mf mg dn mh mi mj dp mk kj ml mm mn kn mo mp mq kr mr ms mt mu bi translated">云形成参数</h2><h2 id="0f05" class="ly lz iq bd me mf mg dn mh mi mj dp mk kj ml mm mn kn mo mp mq kr mr ms mt mu bi translated"><code class="fe kx ky kz la b">List&lt;AWS::EC2::AvailabilityZone::Name</code></h2><p id="dace" class="pw-post-body-paragraph jy jz iq ka b kb mv kd ke kf mw kh ki kj mx kl km kn my kp kq kr mz kt ku kv ij bi translated">转到CloudFormation模板，添加一个类型为“<code class="fe kx ky kz la b">List&lt;AWS::EC2::AvailabilityZone::Name&gt;</code>”的新参数。参见<a class="ae kw" href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/parameters-section-structure.html#aws-specific-parameter-types" rel="noopener ugc nofollow" target="_blank"> AWS特定参数类型</a>中的完整列表:</p><pre class="lq lr ls lt gt lu la lv lw aw lx bi"><span id="bbad" class="ly lz iq la b gy ma mb l mc md">{<br/>  "AWSTemplateFormatVersion": "2010-09-09",<br/>  "Description": "AWS CloudFormation stack for Kubernetes cluster",<br/><br/>  "Parameters": {<br/><br/>    "VPCCIDRBlock": {<br/>      "Description": "VPC CidrBlock",<br/>      "Type": "String",<br/>      "Default": "10.0.0.0/16"<br/>    },<br/>    "AvailabilityZones": {<br/>      "Type": "List&lt;AWS::EC2::AvailabilityZone::Name&gt;",<br/>      "Description": "The list of the AvailabilityZones in a current Region",<br/>      "Default": "eu-west-2a, eu-west-2b"<br/>    }<br/>  },<br/><br/>...</span></pre><p id="0f91" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">添加嵌套堆栈，并使用<code class="fe kx ky kz la b">{ "Fn::Select": [ "0", { "Ref": "AvailabilityZones" } ] }</code>代替<code class="fe kx ky kz la b">{ "Fn::Select": [ "0", { "Fn::GetAZs": "" } ] }</code>，从传递给<em class="lk"> AvailabilityZones </em>参数的列表中获取第一个元素:</p><pre class="lq lr ls lt gt lu la lv lw aw lx bi"><span id="a2f5" class="ly lz iq la b gy ma mb l mc md">...<br/>    "AZNetworkStackA": {<br/>      "Type": "AWS::CloudFormation::Stack",<br/>      "Properties": {<br/>        "TemplateURL": "eks-azs-networking.json",<br/>        "Parameters": {<br/>          "VPCID": { "Fn::GetAtt": ["RegionNetworkStack", "Outputs.VPCID"] },<br/>          "AZ": { "Fn::Select": [ "0", { "Ref": "AvailabilityZones" } ] },<br/>...</span></pre><p id="ff28" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">打包它们(参见<a class="ae kw" href="https://rtfm.co.ua/en/aws-cloudformation-nested-stacks-and-stacks-parameters-import-export/" rel="noopener ugc nofollow" target="_blank">可用性区域锯:云形成-嵌套堆栈和堆栈参数导入/导出</a>):</p><pre class="lq lr ls lt gt lu la lv lw aw lx bi"><span id="d4f6" class="ly lz iq la b gy ma mb l mc md">$ aws --region eu-west-2 cloudformation package --template-file eks-root.json --output-template /tmp/packed-eks-stacks.json --s3-bucket eks-cloudformation-eu-west-2 --use-json</span></pre><p id="9799" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">运行:</p><pre class="lq lr ls lt gt lu la lv lw aw lx bi"><span id="8895" class="ly lz iq la b gy ma mb l mc md">$ ansible-playbook eks-cluster.yml --tags infra<br/>…<br/>TASK [cloudformation : Getting AvailabilityZones list] ****<br/>changed: [localhost]<br/>TASK [cloudformation : set_fact] ****<br/>ok: [localhost]<br/>TASK [cloudformation : debug] ****<br/>ok: [localhost] =&gt; {<br/>“msg”: “cluster_azs_names: eu-west-2a,eu-west-2b,eu-west-2c”<br/>}<br/>TASK [cloudformation : Create EKS EKSCTL-BTTRM-EKS-DEV-3-STACK CloudFormation stack] ****<br/>changed: [localhost]<br/>PLAY RECAP ****<br/>localhost : ok=5 changed=2 unreachable=0 failed=0 skipped=0 rescued=0 ignored=0</span></pre><p id="8e4c" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">检查:</p><figure class="lq lr ls lt gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi na"><img src="../Images/1263a0476b32430355aa95a3d4e9c268.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*x8l4zqtX5a_SEcJi.png"/></div></div></figure><p id="b36b" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">完成了。</p></div><div class="ab cl nb nc hu nd" role="separator"><span class="ne bw bk nf ng nh"/><span class="ne bw bk nf ng nh"/><span class="ne bw bk nf ng"/></div><div class="ij ik il im in"><p id="96a3" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><em class="lk">最初发表于</em> <a class="ae kw" href="https://rtfm.co.ua/en/aws-cloudformation-using-lists-in-parameters/" rel="noopener ugc nofollow" target="_blank"> <em class="lk"> RTFM: Linux、DevOps和系统管理</em> </a> <em class="lk">。</em></p></div></div>    
</body>
</html>