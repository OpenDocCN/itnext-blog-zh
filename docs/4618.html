<html>
<head>
<title>Jaeger’s multitenancy with Elasticsearch</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">耶格的多重租赁与弹性搜索</h1>
<blockquote>原文：<a href="https://itnext.io/jaegers-multitenancy-with-elasticsearch-ae318501f415?source=collection_archive---------3-----------------------#2020-08-05">https://itnext.io/jaegers-multitenancy-with-elasticsearch-ae318501f415?source=collection_archive---------3-----------------------#2020-08-05</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="d455" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我是IBM的一名应用架构师，致力于构建一个平台来加速高质量的持续交付，确保以现代灵活的方式实现开发运维并支持敏捷文化。</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="ks kt di ku bf kv"><div class="gh gi km"><img src="../Images/060b68c1c65e8fc8804d028b225f9e62.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*8ZTxPBYgltZZkWvQbzhkAA.jpeg"/></div></div><figcaption class="ky kz gj gh gi la lb bd b be z dk translated">作为规模的复杂性</figcaption></figure><p id="c269" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在过去的一年里，由于复杂的分布式微服务环境中分布式事务监控和根本原因分析的需要，我们引入了Jaeger框架来帮助我们解决这个问题。由于我们的平台被多个租户使用，我们必须决定如何使用Elasticsearch作为后端来实现多租户Jaeger。</p></div><div class="ab cl lc ld hu le" role="separator"><span class="lf bw bk lg lh li"/><span class="lf bw bk lg lh li"/><span class="lf bw bk lg lh"/></div><div class="ij ik il im in"><p id="fb79" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这是一个关于如何使用Elasticsearch设置Jaeger以支持多个租户的实践练习。但是首先，你应该阅读下面这篇文章<a class="ae lj" href="https://medium.com/jaegertracing/jaeger-and-multitenancy-99dfa1d49dc0" rel="noopener"> Jaeger和多租户</a>，它讨论了Jaeger的各种多租户选项。</p><h2 id="d20d" class="lk ll iq bd lm ln lo dn lp lq lr dp ls jy lt lu lv kc lw lx ly kg lz ma mb mc bi translated">背景</h2><p id="5f40" class="pw-post-body-paragraph jn jo iq jp b jq md js jt ju me jw jx jy mf ka kb kc mg ke kf kg mh ki kj kk ij bi translated">我们正在构建和运行一个基于Kubernetes的平台，该平台允许我们的客户使用我们的平台构建和部署他们自己的应用程序，因此在追踪数据方面有特定的要求:</p><ul class=""><li id="c7d8" class="mi mj iq jp b jq jr ju jv jy mk kc ml kg mm kk mn mo mp mq bi translated">一个支持所有租户的弹性搜索实例，</li><li id="bf5b" class="mi mj iq jp b jq mr ju ms jy mt kc mu kg mv kk mn mo mp mq bi translated">每个租户的跟踪数据都必须单独持久化—具有不同的保留时间范围，</li><li id="caec" class="mi mj iq jp b jq mr ju ms jy mt kc mu kg mv kk mn mo mp mq bi translated">每个租户能够查看和查询自己的跟踪数据，</li><li id="ddc5" class="mi mj iq jp b jq mr ju ms jy mt kc mu kg mv kk mn mo mp mq bi translated">尽可能减少开发活动，从而重用现有的Jaeger功能。</li></ul><h2 id="a6a9" class="lk ll iq bd lm ln lo dn lp lq lr dp ls jy lt lu lv kc lw lx ly kg lz ma mb mc bi translated">解决方案</h2><p id="75e3" class="pw-post-body-paragraph jn jo iq jp b jq md js jt ju me jw jx jy mf ka kb kc mg ke kf kg mh ki kj kk ij bi translated">在从不同来源查阅了足够多的资料后，我决定采用以下解决方案，包括:</p><ul class=""><li id="4858" class="mi mj iq jp b jq jr ju jv jy mk kc ml kg mm kk mn mo mp mq bi translated">Elasticsearch实例安装在租户的独立名称空间中——我们希望管理自己的es集群，</li><li id="4260" class="mi mj iq jp b jq mr ju ms jy mt kc mu kg mv kk mn mo mp mq bi translated">为每个租户安装Jaeger收集器，配置为使用具有特定租户名称/id的ES集群，</li><li id="77af" class="mi mj iq jp b jq mr ju ms jy mt kc mu kg mv kk mn mo mp mq bi translated">安装Jaeger代理作为被跟踪服务的辅助程序，</li><li id="5738" class="mi mj iq jp b jq mr ju ms jy mt kc mu kg mv kk mn mo mp mq bi translated">为每个租户配置自己的Jaeger的弹性搜索索引清理设置，</li><li id="0f72" class="mi mj iq jp b jq mr ju ms jy mt kc mu kg mv kk mn mo mp mq bi translated">一切都是用0开发工作建立起来的。</li></ul><h2 id="d721" class="lk ll iq bd lm ln lo dn lp lq lr dp ls jy lt lu lv kc lw lx ly kg lz ma mb mc bi translated">实施解决方案</h2><p id="9db0" class="pw-post-body-paragraph jn jo iq jp b jq md js jt ju me jw jx jy mf ka kb kc mg ke kf kg mh ki kj kk ij bi translated">好了，现在让我们跳到“代码”，看看我们如何配置上面的故事。对于这个练习，我已经使用<strong class="jp ir"> Helm </strong>部署了所有组件，所以从这个角度来看代码片段。</p><p id="3a36" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">安装Elasticsearch并没有什么特别的，因此你可以按照Helm提供的详细的在线文档来使用不同的ES图像风格。出于本练习的目的，我们假设已经在<em class="kl"> jaeger </em>名称空间中安装了具有以下配置的ES:</p><pre class="kn ko kp kq gt mw mx my mz aw na bi"><span id="f226" class="lk ll iq mx b gy nb nc l nd ne">clusterName: "elasticsearch" <br/>nodeGroup: "master"<br/>masterService: ""<br/>roles:<br/>  master: "true"<br/>  ingest: "true"<br/>  data: "true"<br/>httpPort: 9200<br/>transportPort: 9300</span></pre><p id="8ca3" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">转到Jaeger的部分，首先我们需要告诉它与新安装的Elasticsearch集群一起工作。因为我们想为每个租户单独存储ES中的数据，所以我们必须为每个租户提供一个索引前缀，即租户的名称。</p><pre class="kn ko kp kq gt mw mx my mz aw na bi"><span id="bdc5" class="lk ll iq mx b gy nb nc l nd ne">storage:<br/>  type: <strong class="mx ir">elasticsearch</strong><br/>  elasticsearch:<br/>    host: <strong class="mx ir">elasticsearch-master.jaeger.svc.cluster.local</strong><br/>    indexPrefix: <strong class="mx ir">&lt;TENANT_NAME&gt;</strong><br/>    extraEnv:<br/>      # We need this one for the index cleaner (later in our story)<br/>      - name: INDEX_PREFIX<br/>        value: <strong class="mx ir">&lt;TENANT_NAME&gt;</strong></span></pre><p id="e588" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们之前说过，我们将为每个租户配备一个收集器。因此，我们将只启用收集器部署并禁用Jaeger代理组件。</p><pre class="kn ko kp kq gt mw mx my mz aw na bi"><span id="21de" class="lk ll iq mx b gy nb nc l nd ne">agent:<br/>  enabled: <strong class="mx ir">false</strong><br/>collector:<br/>  enabled: <strong class="mx ir">true</strong><br/>  image: jaegertracing/jaeger-collector<br/>  pullPolicy: IfNotPresent</span></pre><p id="7e1e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们还想为每个租户展示他们自己的Jaeger UI，以便查看跟踪数据。</p><pre class="kn ko kp kq gt mw mx my mz aw na bi"><span id="5718" class="lk ll iq mx b gy nb nc l nd ne">query:<br/>  enabled: <strong class="mx ir">true</strong><br/>  image: jaegertracing/jaeger-query<br/>  basePath: /ops/jaeger/<strong class="mx ir">&lt;TENANT_NAME&gt;</strong></span></pre><p id="1302" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">Jaeger有一个自我ES索引清理组件，可以在我们的设置中为每个租户进行配置。我们只需要添加以下配置。由于这是我们的租户的相同配置和安装的一部分，因此它将清理在env变量INDEX_PREFIX下配置的elasticsearch索引(我们之前在设置存储类型时已经完成了这一步)。</p><pre class="kn ko kp kq gt mw mx my mz aw na bi"><span id="1e13" class="lk ll iq mx b gy nb nc l nd ne">esIndexCleaner:<br/>  enabled: <strong class="mx ir">true</strong><br/>  image: jaegertracing/jaeger-es-index-cleaner<br/>  schedule: "59 23 * * *"<br/>  successfulJobsHistoryLimit: 3<br/>  failedJobsHistoryLimit: 3<br/>  numberOfDays: 3</span></pre><p id="6ec6" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><em class="kl">如果您使用helm部署Kubernetes资源，您可以在安装时使用</em> <code class="fe nf ng nh mx b"><strong class="jp ir"><em class="kl">--set key=value</em></strong></code> <em class="kl">提供您的租户名称，并在您的Helm图表文件中引用它。</em></p><p id="559c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">让我们使用Helm图表最后看一下为一个租户安装Jaeger组件所需的yaml配置。</p><pre class="kn ko kp kq gt mw mx my mz aw na bi"><span id="3bae" class="lk ll iq mx b gy nb nc l nd ne">storage:<br/>  type: elasticsearch<br/>  elasticsearch:<br/>    host: elasticsearch-master.jaeger.svc.cluster.local<br/>    indexPrefix: &lt;TENANT_NAME&gt;<br/>    extraEnv:<br/>      - name: INDEX_PREFIX<br/>        value: &lt;TENANT_NAME&gt;<br/>agent:<br/>  enabled: false<br/>collector:<br/>  enabled: true<br/>  image: jaegertracing/jaeger-collector<br/>  pullPolicy: IfNotPresent<br/>query:<br/>  enabled: true<br/>  image: jaegertracing/jaeger-query<br/>  basePath: /ops/jaeger/&lt;TENANT_NAME&gt;<br/>esIndexCleaner:<br/>  enabled: true<br/>  image: jaegertracing/jaeger-es-index-cleaner<br/>  schedule: "59 23 * * *"<br/>  successfulJobsHistoryLimit: 3<br/>  failedJobsHistoryLimit: 3<br/>  numberOfDays: 3</span></pre></div><div class="ab cl lc ld hu le" role="separator"><span class="lf bw bk lg lh li"/><span class="lf bw bk lg lh li"/><span class="lf bw bk lg lh"/></div><div class="ij ik il im in"><p id="4299" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">剩下的唯一事情是将Jaeger的<strong class="jp ir"> agent </strong>组件作为sidecar部署到我们的服务中，并确保将它链接到每个租户的适当收集器。这可以通过在您的部署中添加一个新容器来轻松完成，如这里的<a class="ae lj" href="https://github.com/jaegertracing/jaeger-kubernetes#deploying-the-agent-as-sidecar" rel="noopener ugc nofollow" target="_blank">所述</a>。</p><p id="58ee" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">假设您的部署有一个名为<code class="fe nf ng nh mx b">my-app</code>的应用程序在端口<code class="fe nf ng nh mx b">8080</code>上运行一个来自<code class="fe nf ng nh mx b">yourimagerepository/hello-my-image</code>的容器，您将需要添加额外的<code class="fe nf ng nh mx b">jaeger-agent</code>容器，其中的参数需要指向正确的收集器。</p><p id="36d2" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><em class="kl">根据您的架构需求，您可以从每个pod部署一个代理或每个pod集部署一个代理甚至每个集群节点部署一个代理中受益。</em></p><pre class="kn ko kp kq gt mw mx my mz aw na bi"><span id="1eb2" class="lk ll iq mx b gy nb nc l nd ne">apiVersion: apps/v1<br/>kind: Deployment<br/>...<br/>spec:<br/>  template:<br/>    metadata:<br/>      labels:<br/>        app.kubernetes.io/name: my-app<br/>    spec:<br/>      containers:<br/>      - image: yourimagerepository/hello-my-image<br/>        name: my-app-cntr<br/>        ports:<br/>        - containerPort: 8080<br/>      - image: jaegertracing/jaeger-agent:1.17.0<br/>        name: jaeger-agent<br/>        resources:<br/>          limits:<br/>            cpu: 20m<br/>            memory: 20Mi<br/>        args: ["--reporter.grpc.host-port=jaeger-<strong class="mx ir">&lt;TENANT_NAME&gt;</strong>-collector.jaeger.svc.cluster.local:14250"]</span></pre><p id="12d1" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这就是为多租户目的部署Jaeger和Elasticsearch的全部内容。为每个租户重复上述过程可能会很乏味且容易出错，因此考虑将所有这些更改移入一个舵图中，并将其作为附加组件部署到您的租户中。</p><h2 id="ac28" class="lk ll iq bd lm ln lo dn lp lq lr dp ls jy lt lu lv kc lw lx ly kg lz ma mb mc bi translated">“做吧。或者不要。没有尝试。”</h2><p id="a402" class="pw-post-body-paragraph jn jo iq jp b jq md js jt ju me jw jx jy mf ka kb kc mg ke kf kg mh ki kj kk ij bi translated">配置生产设置时要考虑的其他方面。</p><ul class=""><li id="e1cd" class="mi mj iq jp b jq jr ju jv jy mk kc ml kg mm kk mn mo mp mq bi translated">因为Jaeger的UI没有任何认证/授权机制，所以你需要保护它。然而，这是很容易的，因为耶格的头盔图内置了对入口资源的支持，并且有多种保护它们的方法。</li><li id="bc07" class="mi mj iq jp b jq mr ju ms jy mt kc mu kg mv kk mn mo mp mq bi translated">检查Elasticsearch安全性以防止对您的Elasticsearch集群的未授权访问。</li><li id="2b48" class="mi mj iq jp b jq mr ju ms jy mt kc mu kg mv kk mn mo mp mq bi translated">验证Elasticsearch Index Cleaner作业是否正在执行并删除了旧数据。您可以检查每个租户的ES索引是否被删除。</li></ul><pre class="kn ko kp kq gt mw mx my mz aw na bi"><span id="4917" class="lk ll iq mx b gy nb nc l nd ne"><strong class="mx ir">kubectl logs jaeger-tenant1-es-index-cleaner-1596412740-29njp -n jaeger</strong><br/>Removing tenant1-jaeger-service-2020-07-31<br/>Removing tenant1-jaeger-span-2020-07-31</span><span id="d25a" class="lk ll iq mx b gy ni nc l nd ne"><strong class="mx ir">kubectl logs jaeger-tenant2-es-index-cleaner-1596412740-mdl8l -n jaeger</strong><br/>Removing tenant2-jaeger-span-2020-07-31<br/>Removing tenant2-jaeger-service-2020-07-31</span></pre><p id="1281" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><em class="kl">特别感谢</em>🍺<em class="kl">感谢我的同事</em> <a class="ae lj" href="https://medium.com/@saftageorge" rel="noopener"> <em class="kl">乔治·萨夫塔</em> </a> <em class="kl">为实现它所做的工作。</em></p></div></div>    
</body>
</html>