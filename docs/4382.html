<html>
<head>
<title>Using AWS to cut your monthly data transfer costs in less than 10 minutes</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用AWS在不到10分钟的时间内削减每月数据传输成本</h1>
<blockquote>原文：<a href="https://itnext.io/using-aws-to-save-on-your-monthly-data-transfer-costs-in-less-than-10-minutes-32407e9d26bf?source=collection_archive---------0-----------------------#2020-06-20">https://itnext.io/using-aws-to-save-on-your-monthly-data-transfer-costs-in-less-than-10-minutes-32407e9d26bf?source=collection_archive---------0-----------------------#2020-06-20</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><h2 id="4f56" class="io ip iq bd b dl ir is it iu iv iw dk ix translated" aria-label="kicker paragraph">实用开发工具</h2><div class=""/><div class=""><h2 id="c3ad" class="pw-subtitle-paragraph jw iz iq bd b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn dk translated">使用AWS Cloudfront降低贵公司<strong class="ak">其他</strong>昂贵的SaaS服务的成本</h2></div><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi ko"><img src="../Images/e71d23ed93aef0a5b8daa95669f2c2ec.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*kdkANvj0IgTseZA7i6cb8w.jpeg"/></div></div><figcaption class="la lb gj gh gi lc ld bd b be z dk translated">你在有效地管理你的交通流量吗？(由<a class="ae le" href="https://unsplash.com/@talen?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">塔伦·德·圣克罗伊</a>在<a class="ae le" href="/?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄)</figcaption></figure><h1 id="2293" class="lf lg iq bd lh li lj lk ll lm ln lo lp kf lq kg lr ki ls kj lt kl lu km lv lw bi translated">向外扩展的成本可能会很高，这里介绍了如何降低第三方转移成本，从而节省一点资金</h1><h2 id="9181" class="lx lg iq bd lh ly lz dn ll ma mb dp lp mc md me lr mf mg mh lt mi mj mk lv iw bi translated">TL；DR；</h2><p id="03ae" class="pw-post-body-paragraph ml mm iq mn b mo mp ka mq mr ms kd mt mc mu mv mw mf mx my mz mi na nb nc nd ij bi translated">使用AWS Cloudfront和Origin Request Lambda功能降低SaaS传输成本。只需一点点代码，你就可以创建一个代理来装载你的第三方服务。如果这两种服务的转让价格之间有足够大的差距，这可能会为您节省一些钱。</p></div><div class="ab cl ne nf hu ng" role="separator"><span class="nh bw bk ni nj nk"/><span class="nh bw bk ni nj nk"/><span class="nh bw bk ni nj"/></div><div class="ij ik il im in"><h2 id="b449" class="lx lg iq bd lh ly lz dn ll ma mb dp lp mc md me lr mf mg mh lt mi mj mk lv iw bi translated">一些背景…</h2><p id="bc27" class="pw-post-body-paragraph ml mm iq mn b mo mp ka mq mr ms kd mt mc mu mv mw mf mx my mz mi na nb nc nd ij bi translated">好吧，除非你的交通流量很大，否则你可能省不了几千美元。然而，我们确实设法每月节省了几百美元，而且我们的流量也不多。我们正在使用一种我们非常喜欢的图像处理服务。这种特殊的服务有一个定价模型，它基于几个因素。其中一些很有道理，也很容易理解。其他的事情，嗯，可能有点难。</p><p id="4118" class="pw-post-body-paragraph ml mm iq mn b mo nl ka mq mr nm kd mt mc nn mv mw mf no my mz mi np nb nc nd ij bi translated">转移成本是我们考虑如何优化的成本之一，因为我们最近看到用户使用量的增加导致成本激增。我的同事想出了一个简单而出色的解决方案，我只用了几个小时就实现了。</p></div><div class="ab cl ne nf hu ng" role="separator"><span class="nh bw bk ni nj nk"/><span class="nh bw bk ni nj nk"/><span class="nh bw bk ni nj"/></div><div class="ij ik il im in"><blockquote class="nq"><p id="27ac" class="nr ns iq bd nt nu nv nw nx ny nz nd dk translated">当然，像我们以前使用的服务提供商需要为不断增长的流量使用支付成本。但是，如果价格涨幅大大高于下面的选择，那么它可能只是有意义的尝试。</p></blockquote><p id="930f" class="pw-post-body-paragraph ml mm iq mn b mo oa ka mq mr ob kd mt mc oc mv mw mf od my mz mi oe nb nc nd ij bi translated">免责声明:我敦促你做自己的计算，而不只是假设你会节省，有一些参数是独特的每种情况。我不知道你的申请，所以不要把你的AWS账单发给我，以防事情不尽如人意。😁</p></div><div class="ab cl ne nf hu ng" role="separator"><span class="nh bw bk ni nj nk"/><span class="nh bw bk ni nj nk"/><span class="nh bw bk ni nj"/></div><div class="ij ik il im in"><h2 id="27e8" class="lx lg iq bd lh ly lz dn ll ma mb dp lp mc md me lr mf mg mh lt mi mj mk lv iw bi translated">贮藏</h2><p id="257f" class="pw-post-body-paragraph ml mm iq mn b mo mp ka mq mr ms kd mt mc mu mv mw mf mx my mz mi na nb nc nd ij bi translated">我在这个问题领域花了相当多的时间，用不同的缓存技术优化流量。大多数管理web站点的人迟早都需要实现不同种类的缓存技术，这些web站点会处理各种严重的负载。</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div class="gh gi of"><img src="../Images/01711b820a3190ae646d09209862c14e.png" data-original-src="https://miro.medium.com/v2/resize:fit:960/format:webp/1*HXAheQ2mTbhtMh0zc8GVrA.jpeg"/></div><figcaption class="la lb gj gh gi lc ld bd b be z dk translated">ID 85153447 Dreamstime.com特雷西·赫布登</figcaption></figure><p id="fe43" class="pw-post-body-paragraph ml mm iq mn b mo nl ka mq mr nm kd mt mc nn mv mw mf no my mz mi np nb nc nd ij bi translated">缓存是分层实施的，从特定应用感知的最内层到最外层，在我们的例子中，最外层是缓存来自应用堆栈的完整响应的CDN。在本帖中，我们将重点介绍如何使用AWS Cloudfront CDN来缓存来自第三方SaaS服务的外部交付的响应。</p></div><div class="ab cl ne nf hu ng" role="separator"><span class="nh bw bk ni nj nk"/><span class="nh bw bk ni nj nk"/><span class="nh bw bk ni nj"/></div><div class="ij ik il im in"><p id="9a28" class="pw-post-body-paragraph ml mm iq mn b mo nl ka mq mr nm kd mt mc nn mv mw mf no my mz mi np nb nc nd ij bi translated">AWS Cloudfront在定义功能方面有一个强大的特性，可以帮助您控制服务的逻辑。在cloudfront的生命周期中，有四个不同的点可以操纵请求/响应流。</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div class="gh gi og"><img src="../Images/30e6433dd21c467f4f02db685754dc77.png" data-original-src="https://miro.medium.com/v2/resize:fit:1090/format:webp/1*ZitRPstFKx3016JsykcjXA.png"/></div><figcaption class="la lb gj gh gi lc ld bd b be z dk translated">来源:<a class="ae le" href="https://docs.aws.amazon.com/lambda/latest/dg/lambda-edge.html" rel="noopener ugc nofollow" target="_blank"> AWS文档</a></figcaption></figure><p id="501d" class="pw-post-body-paragraph ml mm iq mn b mo nl ka mq mr nm kd mt mc nn mv mw mf no my mz mi np nb nc nd ij bi translated">在这篇文章中，我将展示如何在node.js中创建一个Origin request Lambda函数，使您能够透明地向外部SaaS服务代理请求。</p><h2 id="9b88" class="lx lg iq bd lh ly lz dn ll ma mb dp lp mc md me lr mf mg mh lt mi mj mk lv iw bi translated">设置AWS Cloudfront CDN</h2><p id="bc60" class="pw-post-body-paragraph ml mm iq mn b mo mp ka mq mr ms kd mt mc mu mv mw mf mx my mz mi na nb nc nd ij bi translated">为了简单起见，我们只使用现成的cloudfront CDN。对于任何类型的实际使用，您可能希望使用自己的域，自己的SSL证书。</p><p id="9642" class="pw-post-body-paragraph ml mm iq mn b mo nl ka mq mr nm kd mt mc nn mv mw mf no my mz mi np nb nc nd ij bi translated">构建一个新的cloudfront发行版很容易，有一点需要注意的是要使用的类。如果你想在所有地区都有本地业务，价格会有所变化。我们将选择最便宜的(价格等级100)，因为我们的用户群主要在美国和欧洲。这并不意味着我们不会为其他地区的用户提供服务，只是他们的往返路程会稍长一些，最终用户会从该特定价格级别中包含的某个地区的边缘服务器请求信息</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi oh"><img src="../Images/24cd5654b8c3ac3e1a139cdc4f8d95a1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*bgAW3pFdNAC_6U6Ny8GfMw.png"/></div></div></figure><p id="fb8b" class="pw-post-body-paragraph ml mm iq mn b mo nl ka mq mr nm kd mt mc nn mv mw mf no my mz mi np nb nc nd ij bi translated">默认设置应该适合概念验证。也许你需要改变:<br/> <strong class="mn ja">查询字符串转发和缓存</strong>:转发全部，基于全部缓存<br/>如果你发送查询参数给你的服务提供商。</p><p id="0010" class="pw-post-body-paragraph ml mm iq mn b mo nl ka mq mr nm kd mt mc nn mv mw mf no my mz mi np nb nc nd ij bi translated">对于这个测试发行版，我们不使用任何其他来源，但是由于cloudfront坚持要求您提供一个默认来源，我建议您将它指向一个空的S3桶作为默认内容。为生产或在现有的测试环境中进行配置，您可能已经有了一个可以使用的现有Cloudfront发行版。</p><h2 id="95d6" class="lx lg iq bd lh ly lz dn ll ma mb dp lp mc md me lr mf mg mh lt mi mj mk lv iw bi translated">Cloudfront源请求lambda函数</h2><p id="f2f6" class="pw-post-body-paragraph ml mm iq mn b mo mp ka mq mr ms kd mt mc mu mv mw mf mx my mz mi na nb nc nd ij bi translated">随着cloudfront发行版的建立，我们将转向AWS Lambda部分。</p><p id="4294" class="pw-post-body-paragraph ml mm iq mn b mo nl ka mq mr nm kd mt mc nn mv mw mf no my mz mi np nb nc nd ij bi translated">所有Cloudfront lambda函数都需要驻留在<strong class="mn ja"> us-east-1 </strong>区域，因此切换到该区域并创建一个新的node.js 10 Lamba函数:</p><figure class="kp kq kr ks gt kt"><div class="bz fp l di"><div class="oi oj l"/></div></figure><p id="7696" class="pw-post-body-paragraph ml mm iq mn b mo nl ka mq mr nm kd mt mc nn mv mw mf no my mz mi np nb nc nd ij bi translated">保存并发布新版本。这一步很重要，因为您只能引用要在Cloudfront发行版中使用的lambda函数的已发布版本(LATEST不工作)。</p><p id="04b3" class="pw-post-body-paragraph ml mm iq mn b mo nl ka mq mr nm kd mt mc nn mv mw mf no my mz mi np nb nc nd ij bi translated">复制已发布的arn即<br/><em class="ok">arn:AWS:lambda:us-east-1:37119999999:function:cdn-proxy:1</em></p></div><div class="ab cl ne nf hu ng" role="separator"><span class="nh bw bk ni nj nk"/><span class="nh bw bk ni nj nk"/><span class="nh bw bk ni nj"/></div><div class="ij ik il im in"><h2 id="f8d6" class="lx lg iq bd lh ly lz dn ll ma mb dp lp mc md me lr mf mg mh lt mi mj mk lv iw bi translated">将λ与云锋行为联系起来</h2><p id="2819" class="pw-post-body-paragraph ml mm iq mn b mo mp ka mq mr ms kd mt mc mu mv mw mf mx my mz mi na nb nc nd ij bi translated">🔙回到Cloudfront设置:现在我们需要创建一个新的<strong class="mn ja">行为</strong>来执行我们的Lambda函数。如果共享发行版，您需要决定一个对您和您现有的应用程序有意义的前缀。在这个例子中，我们使用/pfix/。这需要与上面Lambda函数中的逻辑相匹配，因为在将请求转发到源服务器(SaaS提供者)之前，我们会将其删除。</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi ol"><img src="../Images/813134bbff12de61dfd1af59675dd9ee.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*7eV4Qie6OyJopJHIKcC1TQ.png"/></div></div></figure><p id="9a40" class="pw-post-body-paragraph ml mm iq mn b mo nl ka mq mr nm kd mt mc nn mv mw mf no my mz mi np nb nc nd ij bi translated">确保lambda函数的IAM角色也包括能够执行的必要权限。(添加edgelamba.amazon.com信托关系)</p><figure class="kp kq kr ks gt kt"><div class="bz fp l di"><div class="oi oj l"/></div></figure></div><div class="ab cl ne nf hu ng" role="separator"><span class="nh bw bk ni nj nk"/><span class="nh bw bk ni nj nk"/><span class="nh bw bk ni nj"/></div><div class="ij ik il im in"><p id="8d3e" class="pw-post-body-paragraph ml mm iq mn b mo nl ka mq mr nm kd mt mc nn mv mw mf no my mz mi np nb nc nd ij bi translated">现在，您应该能够在Cloudfront中本地缓存来自您的提供商的内容，并且只有在缓存需要刷新或者由于某种原因从Cloudfront中被逐出时才重新请求。只需将所有指向供应商的链接替换为指向Cloudfront的链接，并在请求前添加您在上面选择的前缀:</p><p id="c35e" class="pw-post-body-paragraph ml mm iq mn b mo nl ka mq mr nm kd mt mc nn mv mw mf no my mz mi np nb nc nd ij bi translated">对<yourdistibutionid>. cloudfront . net/pfix/resources fromsaas/的请求将从您的SaaS提供商处请求URL(除了/pfix/)，然后将其保存在Cloudfront中以备下一次请求(不会命中您的提供商),从而节省传输费用的账单。</yourdistibutionid></p></div><div class="ab cl ne nf hu ng" role="separator"><span class="nh bw bk ni nj nk"/><span class="nh bw bk ni nj nk"/><span class="nh bw bk ni nj"/></div><div class="ij ik il im in"><p id="fbfb" class="pw-post-body-paragraph ml mm iq mn b mo nl ka mq mr nm kd mt mc nn mv mw mf no my mz mi np nb nc nd ij bi translated">照片致谢</p><p id="891f" class="pw-post-body-paragraph ml mm iq mn b mo nl ka mq mr nm kd mt mc nn mv mw mf no my mz mi np nb nc nd ij bi translated"><a class="ae le" href="https://docs.aws.amazon.com/AmazonCloudFront/latest/DeveloperGuide/CloudFrontPricing.html" rel="noopener ugc nofollow" target="_blank">https://docs . AWS . Amazon . com/Amazon cloudfront/latest/developer guide/cloudfront pricing . html</a></p></div></div>    
</body>
</html>