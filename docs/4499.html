<html>
<head>
<title>Express.js course with TypeScript Lesson 2 — Apollo &amp; WebSockets</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Express.js课程和TypeScript第2课— Apollo和WebSockets</h1>
<blockquote>原文：<a href="https://itnext.io/express-js-course-with-typescript-lesson-2-apollo-websockets-7eb2063186bf?source=collection_archive---------5-----------------------#2020-07-13">https://itnext.io/express-js-course-with-typescript-lesson-2-apollo-websockets-7eb2063186bf?source=collection_archive---------5-----------------------#2020-07-13</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><figure class="gl gn jr js jt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi jq"><img src="../Images/601b83b07de6672060880e43a5d8414e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*xSlx86aoRdw7YkVodaPAKA.png"/></div></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated"><a class="ae kf" href="https://www.duomly.com" rel="noopener ugc nofollow" target="_blank"> Duomly —编程在线课程</a></figcaption></figure><p id="3e69" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">本文原载于<a class="ae kf" href="https://www.blog.duomly.com/apollo-websockets-tutorial-express-js-course-lesson-2/" rel="noopener ugc nofollow" target="_blank">https://www . blog . duomly . com/Apollo-web sockets-tutorial-express-js-course-lesson-2/</a></p></div><div class="ab cl le lf hx lg" role="separator"><span class="lh bw bk li lj lk"/><span class="lh bw bk li lj lk"/><span class="lh bw bk li lj"/></div><div class="im in io ip iq"><h1 id="b46d" class="ll lm it bd ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi bi translated">Apollo和WebSockets简介教程</h1><p id="3e30" class="pw-post-body-paragraph kg kh it ki b kj mj kl km kn mk kp kq kr ml kt ku kv mm kx ky kz mn lb lc ld im bi translated">欢迎来到Express.js课程的第二课，在这里我们将重点关注面向初学者的Apollo &amp; WebSockets教程。</p><p id="ddac" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">在上一课中，我们用Expres.js构建了一个简单的GraphQL API。</p><p id="50cb" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">在这里，您可以找到第1课:如何构建GraphQL API教程的URL:</p><p id="5b58" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><a class="ae kf" href="https://www.blog.duomly.com/how-to-build-graphql-api-tutorial-express-js-course-lesson-1/" rel="noopener ugc nofollow" target="_blank">https://www . blog . duomly . com/how-to-build-graph QL-API-tutorial-express-js-course-lesson-1/</a></p><p id="111f" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">我们将在Express.js课程中构建的代码应该用作我的朋友Anna在React.js课程中构建的前端的后端。</p><p id="7c0e" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">通过完成这两项，您将能够构建完整的个人理财应用程序。</p><p id="059f" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">以下是React.js课程第1课:GraphQL教程的URL:</p><p id="baa9" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><a class="ae kf" href="https://www.blog.duomly.com/graphql-tutorial-reactjs-course/" rel="noopener ugc nofollow" target="_blank">https://www . blog . duomly . com/graph QL-tutorial-react js-course/</a></p><p id="bc01" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">在这里你可以做整个React.js互动课程:</p><p id="dacd" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><a class="ae kf" href="https://www.duomly.com/course/javascript-course/" rel="noopener ugc nofollow" target="_blank">https://www.duomly.com/course/javascript-course/</a></p><p id="7dea" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">在今天的课程中，我将教你如何创建Apollo服务器，通过WebSockets提供实时订阅服务。</p><p id="48e5" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">我们将创建新的模式，并了解什么是GraphQL变体以及如何使用它们。</p><p id="6d19" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">开始吧！</p><p id="0f20" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">如果你喜欢视频，这是youtube的版本:</p><figure class="mo mp mq mr gt ju"><div class="bz fp l di"><div class="ms mt l"/></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated">Apollo &amp; WebSockets教程</figcaption></figure><h1 id="cbb9" class="ll lm it bd ln lo mu lq lr ls mv lu lv lw mw ly lz ma mx mc md me my mg mh mi bi translated">如何安装graph QL-订阅</h1><p id="f341" class="pw-post-body-paragraph kg kh it ki b kj mj kl km kn mk kp kq kr ml kt ku kv mm kx ky kz mn lb lc ld im bi translated">作为最初的几个步骤，我们需要安装必要的依赖项，我们将在今天使用。</p><p id="2140" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">像第一个一样，我们应该安装npm包，它将允许我们创建GraphQL订阅。</p><p id="6b20" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">在项目目录中打开您的终端，并键入:</p><pre class="mo mp mq mr gt mz na nb nc aw nd bi"><span id="1a40" class="ne lm it na b gy nf ng l nh ni">npm i -S graphql-subscriptions</span></pre><h1 id="cf73" class="ll lm it bd ln lo mu lq lr ls mv lu lv lw mw ly lz ma mx mc md me my mg mh mi bi translated">如何安装HTTP</h1><p id="471d" class="pw-post-body-paragraph kg kh it ki b kj mj kl km kn mk kp kq kr ml kt ku kv mm kx ky kz mn lb lc ld im bi translated">我们需要安装的下一个包是“HTTP”。</p><p id="7942" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">这一点非常重要，因为它将让我们创建一个合适的服务器。</p><p id="065d" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">打开终端并键入:</p><pre class="mo mp mq mr gt mz na nb nc aw nd bi"><span id="accb" class="ne lm it na b gy nf ng l nh ni">npm i -S http</span></pre><h1 id="4cb0" class="ll lm it bd ln lo mu lq lr ls mv lu lv lw mw ly lz ma mx mc md me my mg mh mi bi translated">什么是GraphQL阿波罗，如何安装阿波罗服务器</h1><p id="ac07" class="pw-post-body-paragraph kg kh it ki b kj mj kl km kn mk kp kq kr ml kt ku kv mm kx ky kz mn lb lc ld im bi translated">Apollo server是一个开源的GraphQL包，它让我们可以轻松地在您的后端创建一个GraphQL服务器。</p><p id="cf49" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">使用这个包是一个很好主意，特别是如果我们想在前端使用Apollo客户端，因为它们可以流畅地协同工作。</p><p id="0688" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">要安装这个包，我们需要安装“Apollo-server-express”NPM包。</p><p id="0636" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">打开您的终端并键入:</p><pre class="mo mp mq mr gt mz na nb nc aw nd bi"><span id="1c2b" class="ne lm it na b gy nf ng l nh ni">npm i -S apollo-server-express</span></pre><h1 id="d1b4" class="ll lm it bd ln lo mu lq lr ls mv lu lv lw mw ly lz ma mx mc md me my mg mh mi bi translated">如何卸载express-graphql</h1><p id="b07b" class="pw-post-body-paragraph kg kh it ki b kj mj kl km kn mk kp kq kr ml kt ku kv mm kx ky kz mn lb lc ld im bi translated">我们已经完成了新的依赖项的安装，但是我们确定我们所有的都是必需的吗？</p><p id="2ab6" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">如果没有，我们肯定应该删除它们，以免弄乱我们的package.json文件。</p><p id="5ec7" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">其中一个我们不再需要的包是“express-graphql ”,所以我们需要卸载它。</p><p id="8945" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">打开终端并键入:</p><pre class="mo mp mq mr gt mz na nb nc aw nd bi"><span id="4189" class="ne lm it na b gy nf ng l nh ni">npm uninstall express-graphql</span></pre><h1 id="060d" class="ll lm it bd ln lo mu lq lr ls mv lu lv lw mw ly lz ma mx mc md me my mg mh mi bi translated">在schema.ts中用gql替换buildSchema</h1><p id="780d" class="pw-post-body-paragraph kg kh it ki b kj mj kl km kn mk kp kq kr ml kt ku kv mm kx ky kz mn lb lc ld im bi translated">恭喜，所有的依赖项都完成了。</p><p id="45e2" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">现在，我们可以进入正确的编码，这将更加有趣。</p><p id="302a" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">作为第一步，我们应该进入“schema.ts”文件，用“gql”替换“buildSchema”。</p><p id="b761" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">不要忘记删除不必要的进口和进口的“gql”。</p><pre class="mo mp mq mr gt mz na nb nc aw nd bi"><span id="245d" class="ne lm it na b gy nf ng l nh ni">import { gql } from 'apollo-server-express';</span><span id="89c4" class="ne lm it na b gy nj ng l nh ni">const schema = gql`</span></pre><h1 id="efbb" class="ll lm it bd ln lo mu lq lr ls mv lu lv lw mw ly lz ma mx mc md me my mg mh mi bi translated">什么是GraphQL突变以及如何向模式中添加突变</h1><p id="f8d6" class="pw-post-body-paragraph kg kh it ki b kj mj kl km kn mk kp kq kr ml kt ku kv mm kx ky kz mn lb lc ld im bi translated">GraphQL变异是一种返回数据的GraphQL查询，应该在我们想要修改数据时使用。</p><p id="c14f" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">我们在创建、更新或删除数据的情况下使用GraphQL变异。</p><p id="cae6" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">我们需要创建一个新的费用，所以GraphQL变体是这里使用的最佳方法。</p><p id="3d6a" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">Mutation看起来有点像Query，但是应该有允许的参数，我们可以将这些参数放在括号中以请求数据。</p><pre class="mo mp mq mr gt mz na nb nc aw nd bi"><span id="80b0" class="ne lm it na b gy nf ng l nh ni">type Mutation {<br/>  newExpense(id: Int, date: String, amount: Int, type: String, category: String): Expense<br/>}</span></pre><h1 id="dd43" class="ll lm it bd ln lo mu lq lr ls mv lu lv lw mw ly lz ma mx mc md me my mg mh mi bi translated">什么是GraphQL订阅以及如何向模式添加订阅</h1><p id="7242" class="pw-post-body-paragraph kg kh it ki b kj mj kl km kn mk kp kq kr ml kt ku kv mm kx ky kz mn lb lc ld im bi translated">GraphQL订阅是一个GraphQL特性，它允许我们在订阅的事件被触发时立即发送信息。</p><p id="ecd8" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">这有点类似于我们在Javascript中使用的eventListener。</p><p id="50c0" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">GraphQL订阅是将数据实时发送到前端的WebSockets服务器的一个好主意。</p><p id="37f8" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">我们需要创建名为“newExpenseCreated”的订阅，它将在schema.ts中返回“Expense”</p><pre class="mo mp mq mr gt mz na nb nc aw nd bi"><span id="4f69" class="ne lm it na b gy nf ng l nh ni">type Subscription {<br/>  newExpenseCreated: Expense<br/>}</span></pre><h1 id="6191" class="ll lm it bd ln lo mu lq lr ls mv lu lv lw mw ly lz ma mx mc md me my mg mh mi bi translated">在解析器中导入发布订阅</h1><p id="1813" class="pw-post-body-paragraph kg kh it ki b kj mj kl km kn mk kp kq kr ml kt ku kv mm kx ky kz mn lb lc ld im bi translated">模式看起来已经完成了，祝贺你！</p><p id="4fef" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">现在，我们应该进入resolvers.ts并在那里开发一些代码。</p><p id="a86c" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">我们将需要使用pubsub，因此，作为第一步，我们需要导入该依赖项。</p><p id="f2ef" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">导入后，我们需要将“new PubSub()”赋给名为“PubSub”的变量。</p><pre class="mo mp mq mr gt mz na nb nc aw nd bi"><span id="57b9" class="ne lm it na b gy nf ng l nh ni">import { PubSub } from 'graphql-subscriptions';<br/>const pubsub = new PubSub();</span></pre><h1 id="325c" class="ll lm it bd ln lo mu lq lr ls mv lu lv lw mw ly lz ma mx mc md me my mg mh mi bi translated">如何给解析器添加变异</h1><p id="4877" class="pw-post-body-paragraph kg kh it ki b kj mj kl km kn mk kp kq kr ml kt ku kv mm kx ky kz mn lb lc ld im bi translated">现在，我们需要重新构建解析器。</p><p id="b7a1" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">作为第一步，我们应该将费用放入名为“Query”的对象中。</p><p id="d409" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">在下一步中，我们应该创建一个名为“Mutation”的对象，并创建名为“newExpense”的变异，它应该以“root”和“args”作为参数。</p><p id="b6b7" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">在函数内部，我们需要创建Expense，通过pubsub发布事件“expense ”,并返回创建的对象。</p><pre class="mo mp mq mr gt mz na nb nc aw nd bi"><span id="212f" class="ne lm it na b gy nf ng l nh ni">Query: {<br/>  expenses: () =&gt; {<br/>    return getExpenses();<br/>  },<br/>},<br/>Mutation: {<br/>  newExpense: (root, args) =&gt; {<br/>    const expense = createExpense(args);<br/>    pubsub.publish('expense', { newExpenseCreated: expense });<br/>    return expense;<br/>  }<br/>},</span></pre><h1 id="4cf3" class="ll lm it bd ln lo mu lq lr ls mv lu lv lw mw ly lz ma mx mc md me my mg mh mi bi translated">如何向解析程序添加订阅</h1><p id="4fc3" class="pw-post-body-paragraph kg kh it ki b kj mj kl km kn mk kp kq kr ml kt ku kv mm kx ky kz mn lb lc ld im bi translated">订阅是resolvers.ts中我们应该关注的下一点。</p><p id="1287" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">像前面的步骤一样，我们应该创建一个对象“Subscription ”,并在里面创建“newExpenseCreated”对象。</p><p id="056a" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">接下来，我们应该订阅名为“expense”的事件。</p><p id="2e59" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">为此，请使用“pubsub.asyncIterator”。</p><pre class="mo mp mq mr gt mz na nb nc aw nd bi"><span id="2af6" class="ne lm it na b gy nf ng l nh ni">Subscription: {<br/>  newExpenseCreated: {<br/>    subscribe: () =&gt; pubsub.asyncIterator('expense')  // subscribe to changes in a topic<br/>  }<br/>}</span></pre><h1 id="081d" class="ll lm it bd ln lo mu lq lr ls mv lu lv lw mw ly lz ma mx mc md me my mg mh mi bi translated">在resolvers.ts中创建createExpense函数</h1><p id="dd04" class="pw-post-body-paragraph kg kh it ki b kj mj kl km kn mk kp kq kr ml kt ku kv mm kx ky kz mn lb lc ld im bi translated">作为resolvers.ts中的最后一步，我们应该创建一个返回费用数据的函数。</p><p id="aeb6" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">将其命名为“createExpense ”,并返回具有相同主体的对象，正如我们在模式中定义的那样。</p><pre class="mo mp mq mr gt mz na nb nc aw nd bi"><span id="9110" class="ne lm it na b gy nf ng l nh ni">const createExpense = (args) =&gt; {<br/>  return { id: args.id, date: args.date, amount: args.amount, type: args.type, category: args.category };<br/>}</span></pre><h1 id="3bbc" class="ll lm it bd ln lo mu lq lr ls mv lu lv lw mw ly lz ma mx mc md me my mg mh mi bi translated">在server.ts中导入依赖项</h1><p id="44dc" class="pw-post-body-paragraph kg kh it ki b kj mj kl km kn mk kp kq kr ml kt ku kv mm kx ky kz mn lb lc ld im bi translated">厉害！</p><p id="a411" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">现在，我们可以进入服务器。ts，这将是我们需要编码的最后一个文件。</p><p id="48ba" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">这里，我们应该从将要导入的必要依赖项开始。</p><p id="09e5" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">保持express、schema和resolvers不变。</p><p id="296d" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">并且导入“http”，以及server.ts上面的“apollo-server-express”</p><p id="75c6" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">接下来，您可以删除文件的全部内容，不包括“app”变量。</p><pre class="mo mp mq mr gt mz na nb nc aw nd bi"><span id="b6b6" class="ne lm it na b gy nf ng l nh ni">import * as express from 'express';<br/>import schema from './graphql/schema';<br/>import { createServer } from 'http';<br/>import { ApolloServer } from 'apollo-server-express';<br/>import resolvers from './graphql/resolvers';</span><span id="d423" class="ne lm it na b gy nj ng l nh ni">var app = express();</span></pre><h1 id="f8a4" class="ll lm it bd ln lo mu lq lr ls mv lu lv lw mw ly lz ma mx mc md me my mg mh mi bi translated">如何创建阿波罗服务器</h1><p id="fed8" class="pw-post-body-paragraph kg kh it ki b kj mj kl km kn mk kp kq kr ml kt ku kv mm kx ky kz mn lb lc ld im bi translated">如果我们删除了以前的服务器，我们需要从头开始创建新的服务器。</p><p id="2367" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">创建apolloServer，并将其赋给“Apollo”变量。</p><pre class="mo mp mq mr gt mz na nb nc aw nd bi"><span id="0ab0" class="ne lm it na b gy nf ng l nh ni">const apollo = new ApolloServer({<br/>  typeDefs: schema,<br/>  resolvers: resolvers,<br/>  playground: {<br/>    endpoint: `http://localhost:4000/graphql`,<br/>  }<br/>});</span></pre><h1 id="d593" class="ll lm it bd ln lo mu lq lr ls mv lu lv lw mw ly lz ma mx mc md me my mg mh mi bi translated">如何添加阿波罗中间件</h1><p id="68da" class="pw-post-body-paragraph kg kh it ki b kj mj kl km kn mk kp kq kr ml kt ku kv mm kx ky kz mn lb lc ld im bi translated">下一步，我们需要将apollo中间件应用于node.js express。</p><p id="cd66" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">这是一个小交易，因为我们只需要在“apollo”变量上触发applyMiddleware，并将我们的应用程序传入。</p><pre class="mo mp mq mr gt mz na nb nc aw nd bi"><span id="cb89" class="ne lm it na b gy nf ng l nh ni">apollo.applyMiddleware({ app: app });</span></pre><h1 id="1731" class="ll lm it bd ln lo mu lq lr ls mv lu lv lw mw ly lz ma mx mc md me my mg mh mi bi translated">如何创建WebSocket服务器</h1><p id="a18c" class="pw-post-body-paragraph kg kh it ki b kj mj kl km kn mk kp kq kr ml kt ku kv mm kx ky kz mn lb lc ld im bi translated">这是我们在今天的课程中需要执行的编码的最后一步，我们就要完成了。</p><p id="03ef" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">我们需要创建一个服务器，应用subscriptionHandler，并监听HTTP和WebSockets。</p><p id="cab9" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">让我们看看下面的例子是如何做到的:</p><pre class="mo mp mq mr gt mz na nb nc aw nd bi"><span id="4f22" class="ne lm it na b gy nf ng l nh ni">const ws = createServer(app);<br/>apollo.installSubscriptionHandlers(ws);</span><span id="0c53" class="ne lm it na b gy nj ng l nh ni">ws.listen({ port: 4000 }, () =&gt;{<br/>  console.log(`GraphQL API URL: http://localhost:4000/graphql`)<br/>  console.log(`Subscriptions URL: ws://localhost:4000/graphql`)<br/>});</span></pre><h1 id="e3d1" class="ll lm it bd ln lo mu lq lr ls mv lu lv lw mw ly lz ma mx mc md me my mg mh mi bi translated">测试</h1><p id="e39d" class="pw-post-body-paragraph kg kh it ki b kj mj kl km kn mk kp kq kr ml kt ku kv mm kx ky kz mn lb lc ld im bi translated">你已经完成了代码，祝贺你！</p><p id="d8c3" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">现在，我们可以开始测试了。</p><p id="8b5a" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">首先，我们需要通过以下方式运行应用程序:</p><pre class="mo mp mq mr gt mz na nb nc aw nd bi"><span id="a130" class="ne lm it na b gy nf ng l nh ni">npm run</span></pre><p id="eaf9" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">接下来，我们需要在两个浏览器窗口中打开该URL:</p><pre class="mo mp mq mr gt mz na nb nc aw nd bi"><span id="d755" class="ne lm it na b gy nf ng l nh ni"><a class="ae kf" href="http://localhost:4000/graphql" rel="noopener ugc nofollow" target="_blank">http://localhost:4000/graphql</a></span></pre><p id="b791" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">在第一个窗口中，我们需要开始监听订阅:</p><pre class="mo mp mq mr gt mz na nb nc aw nd bi"><span id="ba30" class="ne lm it na b gy nf ng l nh ni">subscription newExpenseCreated {<br/>  newExpenseCreated {<br/>    id,<br/>    amount,<br/>    type<br/>  }<br/>}</span></pre><p id="81a1" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">在第二个示例中，我们需要应用查询变量:</p><pre class="mo mp mq mr gt mz na nb nc aw nd bi"><span id="eee9" class="ne lm it na b gy nf ng l nh ni">{<br/>  "id": 1, "date": "today", "amount": 10, "type": "Outcoming", "category": "Food"<br/>}</span></pre><p id="21f2" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">并进行适当的突变:</p><pre class="mo mp mq mr gt mz na nb nc aw nd bi"><span id="4122" class="ne lm it na b gy nf ng l nh ni">mutation newExpense(<br/>$id: Int<br/>$date: String<br/>$amount: Int<br/>$type: String<br/>$category: String<br/>){<br/>  newExpense(id: $id, date: $date, amount: $amount, type: $type, category: $category) {<br/>    id,<br/>    amount,<br/>    category<br/>  }<br/>}</span></pre><h1 id="e50f" class="ll lm it bd ln lo mu lq lr ls mv lu lv lw mw ly lz ma mx mc md me my mg mh mi bi translated">结论</h1><p id="2916" class="pw-post-body-paragraph kg kh it ki b kj mj kl km kn mk kp kq kr ml kt ku kv mm kx ky kz mn lb lc ld im bi translated">现在，你已经学会了如何用WebSockets和Express.js创建Apollo服务器，恭喜你！</p><p id="a295" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">这些知识非常强大，你可以用WebSockets和GraphQL构建很多应用程序。</p><p id="557d" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">例如，您可以稍微修改一下代码，然后构建一个实时聊天或实时通知系统。</p><p id="53b9" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">我希望你能建立许多好的项目来发展你的编码组合和掌握你的技能。</p><p id="40d6" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">让我们在评论中知道你已经建立了什么！</p><p id="9802" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">以下是今天课程的代码:</p><p id="7194" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><a class="ae kf" href="https://github.com/Duomly/express-js-with-graphql-and-websockets/tree/Express-js-course-Lesson-2" rel="noopener ugc nofollow" target="_blank">https://github . com/Duomly/Express-js-with-graph QL-and-web sockets/tree/Express-js-course-Lesson-2</a></p><figure class="mo mp mq mr gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi nk"><img src="../Images/2e25de0c33522f17529189e6f4856477.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*1AL1zmR6A17_MqNb.png"/></div></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated"><a class="ae kf" href="https://www.duomly.com/?code=lifetime-80" rel="noopener ugc nofollow" target="_blank"> Duomly —编程在线课程</a></figcaption></figure><p id="176d" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">感谢阅读，</p><p id="db65" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">Duomly的Radek</p></div></div>    
</body>
</html>