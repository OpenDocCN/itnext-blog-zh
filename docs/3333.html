<html>
<head>
<title>Graceful error handling in REST-driven web applications</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">REST驱动的web应用程序中的优雅错误处理</h1>
<blockquote>原文：<a href="https://itnext.io/graceful-error-handling-in-rest-driven-web-applications-d4209b4937aa?source=collection_archive---------1-----------------------#2019-11-24">https://itnext.io/graceful-error-handling-in-rest-driven-web-applications-d4209b4937aa?source=collection_archive---------1-----------------------#2019-11-24</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div class="gh gi jn"><img src="../Images/3bdb8ccf3f5934d260c3171e4d31dd16.png" data-original-src="https://miro.medium.com/v2/resize:fit:1250/format:webp/1*kDdY6LStfWm_97bjx9W0bQ.jpeg"/></div></figure><p id="d210" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">你可以尽你所能留住客户，但是如果你把你的用户当成白痴，给他们发“Ooops！出事了！”对于你申请中出现的任何问题，你都必然会疏远和挫败他们。您的客户服务将被来自用户的无用的问题报告淹没，他们看到愚蠢的一般性错误消息；你和你的同事将会浪费他们的时间去追踪这样的报告；当用户对消极的错误信息失去耐心，开始放弃你的服务时，这最终会损害你的底线。</p><p id="dc77" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">您从后端开发人员那里听到的一个常见论点是，服务器上发生的事情会留在服务器上，出于安全和其他原因，您不应该向客户公开您的业务逻辑。这是一个有效的论点，但是，这不是每当服务器上发生非致命错误时返回没有任何上下文的<code class="fe ks kt ku kv b">500</code>响应的借口，并且当HTTP协议为此专门定义了<a class="ae kw" href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Status" rel="noopener ugc nofollow" target="_blank">一系列</a> <code class="fe ks kt ku kv b"><a class="ae kw" href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Status" rel="noopener ugc nofollow" target="_blank">4xx</a></code> <a class="ae kw" href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Status" rel="noopener ugc nofollow" target="_blank">错误代码</a>时。</p><p id="892f" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">那么，如何平衡前端UX/用户界面需求和后端出现的问题呢？你如何以一种既尊重又有帮助的方式向客户传达错误？当它们的交互仅限于HTTP代码和有效负载时，如何为前端应用程序提供足够的上下文来决定做什么？</p><p id="8b00" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">我在之前的文章<a class="ae kw" href="https://medium.com/@ismayilkhayredinov/improve-your-controller-logic-with-assertions-and-exceptions-e6efa7009550" rel="noopener">中已经开始解决这个问题，用断言和异常改进你的控制器逻辑</a>。让我用一些额外的技巧和经验来扩展一下。</p></div><div class="ab cl kx ky hu kz" role="separator"><span class="la bw bk lb lc ld"/><span class="la bw bk lb lc ld"/><span class="la bw bk lb lc"/></div><div class="ij ik il im in"><h1 id="9492" class="le lf iq bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated"><strong class="ak"> API提供者</strong></h1><p id="a6bc" class="pw-post-body-paragraph ju jv iq jw b jx mc jz ka kb md kd ke kf me kh ki kj mf kl km kn mg kp kq kr ij bi translated">作为API提供者，您的责任是处理客户请求并一致地响应它们。如果您认为客户端应用程序的存在只是为了呈现数据，那么您就错了。客户端应用程序和服务器应用程序都必须做出自己的业务决策。因为客户端应用程序是用户实际交互的对象，所以错误的决策会影响用户体验，并对您的核心业务产生更深远的影响。因此，对于API服务器来说，为客户端提供足够的上下文来为用户提供最好的体验是非常重要的。</p><h2 id="d6bb" class="mh lf iq bd lg mi mj dn lk mk ml dp lo kf mm mn ls kj mo mp lw kn mq mr ma ms bi translated"><strong class="ak">使用正确的HTTP错误代码</strong></h2><p id="a26e" class="pw-post-body-paragraph ju jv iq jw b jx mc jz ka kb md kd ke kf me kh ki kj mf kl km kn mg kp kq kr ij bi translated">HTTP代码的不正确使用会导致客户端的混乱。<code class="fe ks kt ku kv b">400</code>、<code class="fe ks kt ku kv b">401</code>和<code class="fe ks kt ku kv b">403</code>错误代码有很大区别。从过期的JWT令牌中恢复不同于修复表单字段中的某些错误或没有足够的权限提交表单。</p><h2 id="1dab" class="mh lf iq bd lg mi mj dn lk mk ml dp lo kf mm mn ls kj mo mp lw kn mq mr ma ms bi translated"><strong class="ak">将有效载荷添加到您的错误响应中</strong></h2><p id="784e" class="pw-post-body-paragraph ju jv iq jw b jx mc jz ka kb md kd ke kf me kh ki kj mf kl km kn mg kp kq kr ij bi translated">空的错误响应没有帮助。即使您的应用程序现在不使用它们，以后当您的应用程序增长并且您需要做出更复杂的决策时，它也可能需要更多的上下文。也就是说，要确保有效负载模式在所有响应中都是一致的:无论是返回一个错误对象数组，还是一个错误字符串，都要确保它适用于所有响应。鉴于大多数客户端应用程序都是用JavaScript编写的，并且必须提供给用户的浏览器，每增加一个规范化逻辑就意味着用户必须下载额外的千字节。</p><h2 id="6aab" class="mh lf iq bd lg mi mj dn lk mk ml dp lo kf mm mn ls kj mo mp lw kn mq mr ma ms bi translated"><strong class="ak">将错误分类</strong></h2><p id="d957" class="pw-post-body-paragraph ju jv iq jw b jx mc jz ka kb md kd ke kf me kh ki kj mf kl km kn mg kp kq kr ij bi translated">通过将子类型分配给错误，可以简化客户端的决策过程。HTTP代码太笼统。<code class="fe ks kt ku kv b">401</code>错误可能意味着用户尚未登录，或者用户由于不活动而被注销，或者您因为可疑的安全漏洞而重置了您的JWT密码。提供更具体的错误消息将改善用户的整体体验。</p><h2 id="7c29" class="mh lf iq bd lg mi mj dn lk mk ml dp lo kf mm mn ls kj mo mp lw kn mq mr ma ms bi translated">想想i18n</h2><p id="413b" class="pw-post-body-paragraph ju jv iq jw b jx mc jz ka kb md kd ke kf me kh ki kj mf kl km kn mg kp kq kr ij bi translated">有可能您最终会想要国际化您的应用程序。确保您的服务器已准备好接受来自客户端的每个请求的区域设置，并在服务器上翻译错误消息；或者发回一条错误消息，作为可以在客户机中本地化的键。您可能希望确保发送任何有助于消息多元化和插值的数据。</p><p id="d13f" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">假设我们有一个文件上传表单。服务器可能会对文件大小、类型和名称设置限制。让我们假设我们不希望表单验证库使客户端过载，但是我们仍然希望在发生错误时向客户端提供有用的信息。我们的客户使用法语和英语，服务器没有任何国际化功能。像这样的响应将为客户端提供足够的上下文，用法语告诉用户他们应该上传jpg、png或gif，而不是svg。我们的消息键也是一个错误子类型。</p><pre class="mt mu mv mw gt mx kv my mz aw na bi"><span id="9149" class="mh lf iq kv b gy nb nc l nd ne"><em class="nf">access</em>-<em class="nf">control</em>-<em class="nf">allow</em>-<em class="nf">headers</em>: <em class="nf">Content</em>-<em class="nf">Type</em>, <em class="nf">Accepts<br/>access</em>-<em class="nf">control</em>-<em class="nf">allow</em>-<em class="nf">methods</em>: <em class="nf">POST<br/>access</em>-<em class="nf">control</em>-<em class="nf">allow</em>-<em class="nf">origin</em>: *<br/><em class="nf">content</em>-<em class="nf">type</em>: <em class="nf">application</em>/<em class="nf">json<br/></em>date: <em class="nf">Sun</em>, 24 <em class="nf">Nov </em>2019 16:39:29 <em class="nf">GMT<br/></em>status: 400<br/><br/>{<br/>    "status_code": 400,<br/>    "message": "error.upload.file-type",<br/>    "context": {<br/>        "accepts": ['jpg', 'png', 'gif'],<br/>        "submitted": 'svg'<br/>    }<br/>}</span></pre></div><div class="ab cl kx ky hu kz" role="separator"><span class="la bw bk lb lc ld"/><span class="la bw bk lb lc ld"/><span class="la bw bk lb lc"/></div><div class="ij ik il im in"><p id="5486" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated"><strong class="jw ir"> API客户端</strong></p><p id="68ad" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">API客户端应该能够对各种类型的错误做出相应的反应，因此我建议您在做任何事情之前，先实现您的错误处理程序。了解你将如何处理重定向和错误信息将有助于你构建一个更健壮的应用程序。早期定义的集中式错误处理将使其更容易与其他关键组件集成，如路由器、i18n服务、表单验证库、警报/通知系统等。</p><p id="cdf0" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">如果您正在构建一个Vue应用程序，您可能希望将错误处理逻辑隔离在一个mixin中，这也将使您能够从进行API调用的单个组件中访问全局API。</p><p id="ccfe" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">如果您正在构建React应用程序，请查看ErrorBoundary组件。将路由器、react-intl等注入其中会更容易。您还可以利用redux操作，以及通过它的render()函数集成一个toast/notification系统。</p><h2 id="76b5" class="mh lf iq bd lg mi mj dn lk mk ml dp lo kf mm mn ls kj mo mp lw kn mq mr ma ms bi translated"><code class="fe ks kt ku kv b">401</code> /认证错误</h2><p id="bde0" class="pw-post-body-paragraph ju jv iq jw b jx mc jz ka kb md kd ke kf me kh ki kj mf kl km kn mg kp kq kr ij bi translated">当您遇到来自服务器的401错误时，最有可能的做法是将用户转发到登录表单。计划您的错误处理程序，以便您可以访问您的路由器，并在重定向发生后提供通知。例如，如果你正在使用<code class="fe ks kt ku kv b">window.location.href</code>重定向，你将会丢失任何你试图在重定向发生之前显示的消息。相应地管理应用程序状态—从浏览器存储中清除任何现有的会话和用户数据。</p><h2 id="2fbf" class="mh lf iq bd lg mi mj dn lk mk ml dp lo kf mm mn ls kj mo mp lw kn mq mr ma ms bi translated">400 /验证错误</h2><p id="e767" class="pw-post-body-paragraph ju jv iq jw b jx mc jz ka kb md kd ke kf me kh ki kj mf kl km kn mg kp kq kr ij bi translated">当用户提交表单时，最有可能出现这样的错误。您需要决定是内联显示验证错误，还是利用全局toast/通知系统。如果您正在编写验证处理程序，请确保考虑到您可能需要做的异步验证。我见过的许多验证库都让你陷入了一个忽略处理程序的坏习惯:</p><pre class="mt mu mv mw gt mx kv my mz aw na bi"><span id="1f79" class="mh lf iq kv b gy nb nc l nd ne">(value) =&gt; value.length &gt; 25 ? true : 'Only 25 characters allowed'</span></pre><p id="92b1" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">这又回到了我在文章中提到的关于异常和断言的观点。字符串很难处理，尤其是当你需要异步处理的时候。<code class="fe ks kt ku kv b">true</code>和非空字符串都可以被强制转换成<code class="fe ks kt ku kv b">true</code>，所以你可能会在代码中引入错误而没有注意到它们的区别。考虑抛出适当的错误，并在验证处理程序中捕获它们:</p><figure class="mt mu mv mw gt jr"><div class="bz fp l di"><div class="ng nh l"/></div></figure><p id="e3c5" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated"><strong class="jw ir"> 403 /权限错误</strong></p><p id="cfde" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">如果您正在构建多角色应用程序，这些错误有助于识别缺少的访问/权限。我相信对用户的权限级别应该是透明的:<em class="nf">你没有足够的权限修改这个对象</em>或者<em class="nf">你试图访问的资源仅限于职员</em>。也就是说，如果您从客户端应用程序进行API调用时遇到403错误，那么您构建组件的方式可能有问题——考虑一下您的条件角色逻辑，您很可能在代码中引入了一些不可靠的东西。</p><p id="b28c" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated"><strong class="jw ir"> 404 /未发现错误</strong></p><p id="be16" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">根据路由类型，您可以向用户显示404错误页面，或者通过通知告知他们缺少资源。例如，如果用户试图访问订单细节，而您的应用程序调用API从服务器检索细节并遇到404，那么显示404模板而不是弹出错误消息可能是安全的。但是，如果您从多个来源聚合您的实体并使用reducers，单个404响应可能甚至不需要打扰用户——只需隐藏依赖资源的组件，记录一个错误并在以后调查。</p><p id="6df3" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated"><strong class="jw ir"> 500和其他客户端错误</strong></p><p id="9d1f" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">我相信对用户透明是这里的关键。例如，代理给第三方提供者的API调用可能会由于提供者暂时不可用或一些其他配置问题(例如，您上次支付提供者服务失败，您无法访问他们的API)而导致错误。与其Ooops，不如直截了当— <em class="nf">我们无法联系我们的支付提供商，请几秒钟后重试</em>或<em class="nf">上一次操作导致数据完整性违规，可能需要手动干预来解决。请耐心等待</em>。通知用户错误已被记录，您的团队正在调查，这也是一个好主意。如果他们需要帮助，他们可以随时联系客户支持，并提供您向他们显示的附加上下文信息:数据库或日志聚合器中错误报告的唯一id，可以帮助您轻松定位问题并在以后调试问题的事务id:<em class="nf">我们遇到了一个错误，它已被记录为问题X-XXXXX。我们的团队正在调查这份报告，并将尽快纠正。同时，如果您有任何进一步的问题或意见，请随时使用问题id联系我们的支持人员</em>。</p><p id="b1c1" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated"><strong class="jw ir">明智地使用控制台</strong></p><p id="ba6c" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">生产环境中的浏览器控制台不应包含您的调试逻辑。不要污染它，用它来记录对用户识别问题有用的信息——复制你通过控制台弹出窗口显示的任何消息。</p><p id="b7a7" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">不要直接使用控制台，代理它，这样可以避免在生产中留下控制台调用。</p><figure class="mt mu mv mw gt jr"><div class="bz fp l di"><div class="ng nh l"/></div></figure></div><div class="ab cl kx ky hu kz" role="separator"><span class="la bw bk lb lc ld"/><span class="la bw bk lb lc ld"/><span class="la bw bk lb lc"/></div><div class="ij ik il im in"><p id="8cdb" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">总之，用户不是你的敌人——现在是2019年。尽可能开诚布公。最终，这将使他们感觉他们是改进你的软件的一部分，你将花费更少的时间去追踪错误和解决无用的错误报告。</p></div></div>    
</body>
</html>