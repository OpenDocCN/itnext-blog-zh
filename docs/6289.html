<html>
<head>
<title>MAAS Terraform Ansible Integration</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">马斯地形可变集成</h1>
<blockquote>原文：<a href="https://itnext.io/maas-terraform-ansible-integration-adb57e09caf2?source=collection_archive---------2-----------------------#2021-10-10">https://itnext.io/maas-terraform-ansible-integration-adb57e09caf2?source=collection_archive---------2-----------------------#2021-10-10</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/ba025efe3a5c7c4967ea885b17621051.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*uFOY3p9VmpQJ3h2hzjJfxg.png"/></div></div></figure><p id="e295" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">今天，我将介绍MAASTA项目，该项目将MAAS、Terraform和Ansible工具集成在一起，以实现DevOps生命周期中的端到端自动化。在继续之前，让我解释一些概念，描述问题是什么，以及MAASTA如何解决这个没有出路的工作。让我们从概念开始。</p><h1 id="388c" class="kw kx iq bd ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt bi translated">什么是端到端自动化？</h1><p id="1401" class="pw-post-body-paragraph jy jz iq ka b kb lu kd ke kf lv kh ki kj lw kl km kn lx kp kq kr ly kt ku kv ij bi translated">在DevOps生命周期中，每一步都与上一步和下一步有语义联系。在每一个项目中，我们使用不同的工具，这些工具可能不会直接与他人联系。例如，在部署中，我们可能会使用几个工具，如Terraform和Ansible，它们没有任何直接连接。尽管Terraform和Ansible之间没有直接联系，但在现实世界中，Terraform用于提供云实例、裸机、虚拟机等。，Ansible用于配置在上一步中由Terraform提供的系统。最大的问题是，当没有办法将Terraform的输出连接到Ansible的输入以将它们介绍给Ansible时，Ansible如何发现那些机器以配置它们。</p><p id="1b42" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><strong class="ka ir">传统的</strong>方式是运行Terraform来配置机器，手动编写这些机器的Ansible清单，并运行Ansible来配置这些机器，但在端到端自动化中，独立工具的边缘以自动化的方式连接。可以说，<strong class="ka ir">端到端自动化</strong>是一种完全以自动化方式开发DevOps生命周期的方法，不需要任何人工交互或手动过程。所有的工作都应该自动完成。</p><p id="ee17" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><strong class="ka ir">公共云上的地形和地形整合:</strong></p><p id="2fa6" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">端到端自动化在DevOps中并不是一个新话题！因此，为了集成Terraform和Ansible等工具以实现端到端自动化，目前开发了几种工具，但它们都用于集成Terraform和Ansible，例如由Terraform在公共云(如AWS、GCP等)上提供的实例。对于这种环境中的集成，在Google上搜索“<strong class="ka ir">terra form ansi ble Integration</strong>”。</p><h1 id="96ce" class="kw kx iq bd ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt bi translated">内部端到端自动化:</h1><p id="b99c" class="pw-post-body-paragraph jy jz iq ka b kb lu kd ke kf lv kh ki kj lw kl km kn lx kp kq kr ly kt ku kv ij bi translated">在我们使用基础架构、裸机、虚拟机等的内部环境中。，我们必须使用一种工具将它们转变为类似云的环境。我们应该这样做，以标准的方式继续接下来的步骤，因为标准的方式是基于最佳实践创建的。此外，我们可能希望在未来将我们的基础设施迁移到公共云，在这种情况下，我们应该能够在结构、技术等方面进行最小更改的情况下迁移整个系统。</p><h1 id="1985" class="kw kx iq bd ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt bi translated">MAAS Terraform Ansible集成:</h1><p id="cf4b" class="pw-post-body-paragraph jy jz iq ka b kb lu kd ke kf lv kh ki kj lw kl km kn lx kp kq kr ly kt ku kv ij bi translated">我们用来将内部基础架构转变为云的工具之一是MAAS。MAAS是在内部环境中创建裸机虚拟机云的理想工具。我选择它是因为它有一个Terraform的提供者。使用Terraform MAAS provider，您可以在没有任何直接人工交互的情况下提供实例。之后，是时候配置之前由Terraform提供的实例了，但是Ansible如何发现这些实例、机器。<strong class="ka ir">大问题！！！</strong></p><p id="5397" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">正如我之前所说，对于公共云实例，有几个工具可以发现由Terraform提供的实例，为它们创建一个可行的清单，但对于由MAAS提供的实例，到目前为止还没有找到解决方案。欢迎来到<strong class="ka ir">马斯塔</strong>。</p><div class="lz ma gp gr mb mc"><a href="https://github.com/ssbostan/maasta" rel="noopener  ugc nofollow" target="_blank"><div class="md ab fo"><div class="me ab mf cl cj mg"><h2 class="bd ir gy z fp mh fr fs mi fu fw ip bi translated">GitHub-ssbo stan/maasta:MAAS terra form ansi ble</h2><div class="mj l"><h3 class="bd b gy z fp mh fr fs mi fu fw dk translated">如果你觉得有用，就看星星。MAASTA是一个包装器，用于为MAAS实例创建一个可解析的清单。</h3></div><div class="mk l"><p class="bd b dl z fp mh fr fs mi fu fw dk translated">github.com</p></div></div><div class="ml l"><div class="mm l mn mo mp ml mq jw mc"/></div></div></a></div><p id="04bb" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><strong class="ka ir"> MAASTA </strong>是一个工具，用于为Terraform提供的MAAS实例生成可行的清单。借助MAASTA，您可以将MAAS、Terraform和Ansible集成在一起，在您的内部环境中实现端到端自动化。在MAASTA和这些工具的帮助下，DevOps生命周期的创建变得更加甜蜜。</p><h1 id="adbc" class="kw kx iq bd ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt bi translated">从零到全自动化入门:</h1><p id="60af" class="pw-post-body-paragraph jy jz iq ka b kb lu kd ke kf lv kh ki kj lw kl km kn lx kp kq kr ly kt ku kv ij bi translated">开始之前，您需要满足以下要求:</p><ul class=""><li id="aea4" class="mr ms iq ka b kb kc kf kg kj mt kn mu kr mv kv mw mx my mz bi translated">MAAS 2.9+安装环境，带有一些现成的机器。</li><li id="0366" class="mr ms iq ka b kb na kf nb kj nc kn nd kr ne kv mw mx my mz bi translated">能够访问MAAS服务器的工作站机器。</li></ul><h2 id="a3f8" class="nf kx iq bd ky ng nh dn lc ni nj dp lg kj nk nl lk kn nm nn lo kr no np ls nq bi translated">步骤1:配置工作站机器:</h2><p id="e0c6" class="pw-post-body-paragraph jy jz iq ka b kb lu kd ke kf lv kh ki kj lw kl km kn lx kp kq kr ly kt ku kv ij bi translated">工作站机器应具有以下要求:</p><ul class=""><li id="3a73" class="mr ms iq ka b kb kc kf kg kj mt kn mu kr mv kv mw mx my mz bi translated"><strong class="ka ir"> OpenSSH +私有/公共密钥</strong></li><li id="2938" class="mr ms iq ka b kb na kf nb kj nc kn nd kr ne kv mw mx my mz bi translated"><strong class="ka ir"> Python 3+(应安装Python 3-pip)</strong></li><li id="813f" class="mr ms iq ka b kb na kf nb kj nc kn nd kr ne kv mw mx my mz bi translated"><strong class="ka ir">地形1+ </strong></li><li id="6844" class="mr ms iq ka b kb na kf nb kj nc kn nd kr ne kv mw mx my mz bi translated"><strong class="ka ir"> Ansible 2.7+ </strong></li></ul><h2 id="bf34" class="nf kx iq bd ky ng nh dn lc ni nj dp lg kj nk nl lk kn nm nn lo kr no np ls nq bi translated">步骤2:配置MAAS:</h2><p id="5ccb" class="pw-post-body-paragraph jy jz iq ka b kb lu kd ke kf lv kh ki kj lw kl km kn lx kp kq kr ly kt ku kv ij bi translated">打开MAAS仪表板，添加工作站机器的SSH公钥，并为Terraform provider创建一个新的API密钥。</p><figure class="ns nt nu nv gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nr"><img src="../Images/6d8b1a46668aa19054eea470d63232b8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*xy6nvXCMeonoKYlq68cs5A.png"/></div></div><figcaption class="nw nx gj gh gi ny nz bd b be z dk translated">MAAS与一些现成的机器。</figcaption></figure><figure class="ns nt nu nv gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nr"><img src="../Images/0af5c19b3d0b4df93d938dc55b7be09f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*fzdJcc6DdHoRHqq9sFBXSA.png"/></div></div><figcaption class="nw nx gj gh gi ny nz bd b be z dk translated">将您的SSH公钥上传到MAAS。</figcaption></figure><figure class="ns nt nu nv gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nr"><img src="../Images/00f0bc3b7bfa5b3be69da87f333d0065.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*74B-DH-xMAr2IM_bonUrOg.png"/></div></div><figcaption class="nw nx gj gh gi ny nz bd b be z dk translated">为地形创建新的API键。</figcaption></figure><h1 id="f997" class="kw kx iq bd ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt bi translated">步骤3:安装MAASTA:</h1><p id="ec54" class="pw-post-body-paragraph jy jz iq ka b kb lu kd ke kf lv kh ki kj lw kl km kn lx kp kq kr ly kt ku kv ij bi translated">在工作站机器上运行以下命令:</p><pre class="ns nt nu nv gt oa ob oc od aw oe bi"><span id="f133" class="nf kx iq ob b gy of og l oh oi">sudo pip install git+https://github.com/ssbostan/maasta.git</span></pre><h2 id="969c" class="nf kx iq bd ky ng nh dn lc ni nj dp lg kj nk nl lk kn nm nn lo kr no np ls nq bi translated">步骤4:编写地形文件(IaC):</h2><p id="8ef0" class="pw-post-body-paragraph jy jz iq ka b kb lu kd ke kf lv kh ki kj lw kl km kn lx kp kq kr ly kt ku kv ij bi translated">您可以在MAASTA项目资源库中找到一些<a class="ae oj" href="https://github.com/ssbostan/maasta/tree/master/examples" rel="noopener ugc nofollow" target="_blank">示例</a>。</p><p id="32c8" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">下面的例子是<a class="ae oj" href="https://github.com/ssbostan/maasta/tree/master/examples/single" rel="noopener ugc nofollow" target="_blank">这里的</a>。</p><pre class="ns nt nu nv gt oa ob oc od aw oe bi"><span id="b94c" class="nf kx iq ob b gy of og l oh oi">terraform {<br/>  required_providers {<br/>    maas = {<br/>      source = "suchpuppet/maas"<br/>      version = "~&gt; 3.1.3"<br/>    }<br/>  }<br/>}</span><span id="b267" class="nf kx iq ob b gy ok og l oh oi">variable "MAAS_API_KEY" {<br/>  type = string<br/>}</span><span id="8329" class="nf kx iq ob b gy ok og l oh oi">variable "MAAS_API_URL" {<br/>  type = string<br/>  default = "<a class="ae oj" href="http://192.168.10.2:5240/MAAS" rel="noopener ugc nofollow" target="_blank">http://192.168.10.2:5240/MAAS</a>"<br/>}</span><span id="b98d" class="nf kx iq ob b gy ok og l oh oi">provider "maas" {<br/>  api_version = "2.0"<br/>  api_key = var.MAAS_API_KEY<br/>  api_url = var.MAAS_API_URL<br/>}</span><span id="a65e" class="nf kx iq ob b gy ok og l oh oi">resource "maas_instance" "docker" {<br/>  release_erase = false<br/>  release_erase_quick = true<br/>}</span></pre><h2 id="8fcf" class="nf kx iq bd ky ng nh dn lc ni nj dp lg kj nk nl lk kn nm nn lo kr no np ls nq bi translated">第五步:编写一份可行的行动手册(IaC):</h2><p id="2f47" class="pw-post-body-paragraph jy jz iq ka b kb lu kd ke kf lv kh ki kj lw kl km kn lx kp kq kr ly kt ku kv ij bi translated">您可以在MAASTA项目资源库中找到一些<a class="ae oj" href="https://github.com/ssbostan/maasta/tree/master/examples" rel="noopener ugc nofollow" target="_blank">示例</a>。</p><p id="2f45" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">下面这个例子是在这里找到<a class="ae oj" href="https://github.com/ssbostan/maasta/tree/master/examples/single" rel="noopener ugc nofollow" target="_blank">。</a></p><pre class="ns nt nu nv gt oa ob oc od aw oe bi"><span id="dd5f" class="nf kx iq ob b gy of og l oh oi">---<br/>  - hosts: docker<br/>    vars:<br/>      docker_old_packages:<br/>        - docker<br/>        - docker-engine<br/>        - docker.io<br/>        - containerd<br/>        - runc</span><span id="9160" class="nf kx iq ob b gy ok og l oh oi">docker_required_packages:<br/>        - apt-transport-https<br/>        - ca-certificates<br/>        - curl<br/>        - gnupg<br/>        - lsb-release</span><span id="21fc" class="nf kx iq ob b gy ok og l oh oi">docker_new_packages:<br/>        - docker-ce<br/>        - docker-ce-cli<br/>        - containerd.io</span><span id="e6df" class="nf kx iq ob b gy ok og l oh oi">tasks:<br/>      - name: update apt cache and upgrade system<br/>        apt:<br/>          update_cache: yes<br/>          upgrade: yes</span><span id="b050" class="nf kx iq ob b gy ok og l oh oi">- name: remove old packages<br/>        apt:<br/>          name: "{{ docker_old_packages }}"<br/>          state: absent</span><span id="8b46" class="nf kx iq ob b gy ok og l oh oi">- name: install required packages<br/>        apt:<br/>          name: "{{ docker_required_packages }}"<br/>          state: present</span><span id="67ed" class="nf kx iq ob b gy ok og l oh oi">- name: adding docker repository key<br/>        apt_key:<br/>          url: <a class="ae oj" href="https://download.docker.com/linux/ubuntu/gpg" rel="noopener ugc nofollow" target="_blank">https://download.docker.com/linux/ubuntu/gpg</a><br/>          state: present</span><span id="9910" class="nf kx iq ob b gy ok og l oh oi">- name: adding docker package repository<br/>        apt_repository:<br/>          repo: deb [arch=amd64] <a class="ae oj" href="https://download.docker.com/linux/ubuntu" rel="noopener ugc nofollow" target="_blank">https://download.docker.com/linux/ubuntu</a> {{ ansible_facts.lsb.codename }} stable</span><span id="35f8" class="nf kx iq ob b gy ok og l oh oi">- name: install docker<br/>        apt:<br/>          name: "{{ docker_new_packages }}"<br/>          state: present</span></pre><h2 id="f232" class="nf kx iq bd ky ng nh dn lc ni nj dp lg kj nk nl lk kn nm nn lo kr no np ls nq bi translated">第六步:开始派对！</h2><p id="318b" class="pw-post-body-paragraph jy jz iq ka b kb lu kd ke kf lv kh ki kj lw kl km kn lx kp kq kr ly kt ku kv ij bi translated">上面的例子Terraform和Ansible将为一台新的MAAS机器提供Terraform，Ansible将docker安装在Docker组中的机器上。让我们开始吧。</p><pre class="ns nt nu nv gt oa ob oc od aw oe bi"><span id="d50d" class="nf kx iq ob b gy of og l oh oi">export MAAS_API_URL=http://YOUR-MAAS-API-URL:5240/MAAS<br/>export MAAS_API_KEY=YOUR-MAAS-API-KEY</span><span id="ef6e" class="nf kx iq ob b gy ok og l oh oi">export TF_VAR_MAAS_API_URL=$MAAS_API_URL<br/>export TF_VAR_MAAS_API_KEY=$MAAS_API_KEY</span><span id="d53a" class="nf kx iq ob b gy ok og l oh oi">terraform init</span><span id="a53b" class="nf kx iq ob b gy ok og l oh oi">terraform plan</span><span id="59fa" class="nf kx iq ob b gy ok og l oh oi">terraform apply -auto-approve<br/># Wait for Terraform to complete...</span><span id="edb1" class="nf kx iq ob b gy ok og l oh oi">terraform show -json | python -m maasta<br/># The above command creates the inventory.yaml file.</span><span id="cf8d" class="nf kx iq ob b gy ok og l oh oi">ansible-playbook -i inventory.yaml -b playbook.yaml</span></pre><h1 id="8a35" class="kw kx iq bd ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt bi translated">最后的结论:</h1><p id="98b2" class="pw-post-body-paragraph jy jz iq ka b kb lu kd ke kf lv kh ki kj lw kl km kn lx kp kq kr ly kt ku kv ij bi translated">端到端自动化是一种很好的方法，但有时很难通过标准途径实现。对于公共云，找到了各种工具，但是对于内部部署，没有找到足够的工具和方法！MAASTA是实现端到端自动化的第一款机芯。我们应该创建标准路径！不要犹豫！为了创造一个更美好的世界，你的贡献是必要的。祝你好运。</p><p id="c708" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">关注我的领英【https://www.linkedin.com/in/ssbostan T2】</p></div></div>    
</body>
</html>