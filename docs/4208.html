<html>
<head>
<title>Helm: helm-secrets — sensitive data encryption with AWS KMS and use it with Jenkins</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">赫尔姆:赫尔姆-秘密-敏感数据加密与AWS KMS和使用它与詹金斯</h1>
<blockquote>原文：<a href="https://itnext.io/helm-helm-secrets-sensitive-data-encryption-with-aws-kms-and-use-it-from-jenkins-73d05c22c118?source=collection_archive---------0-----------------------#2020-05-16">https://itnext.io/helm-helm-secrets-sensitive-data-encryption-with-aws-kms-and-use-it-from-jenkins-73d05c22c118?source=collection_archive---------0-----------------------#2020-05-16</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div class="gh gi jn"><img src="../Images/48f36cc07437627b7e93daa6c1e9e8d6.png" data-original-src="https://miro.medium.com/v2/resize:fit:256/format:webp/0*5kRJoeazMCE4FbZY.png"/></div></figure><p id="aff8" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">因此，作为<a class="ae ks" href="https://rtfm.co.ua/en/helm-kubernetes-package-manager-an-overview-getting-started/" rel="noopener ugc nofollow" target="_blank">Helm:Kubernetes package manager——概述，入门</a>帖子的后续，让我们讨论一下Helm图表中的敏感数据。</p><p id="9b7e" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">我想要的是在存储库中存储一个图表文件，但即使这样的回购将是一个私有的Github回购——我仍然不想在那里以明文的方式存储密码。</p><p id="39c4" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">这里的解决方案可能是使用一个众所周知的<code class="fe kt ku kv kw b"><a class="ae ks" href="https://github.com/zendesk/helm-secrets/" rel="noopener ugc nofollow" target="_blank">helm-secrets</a></code>插件。插件本身只是一个使用<a class="ae ks" href="https://godoc.org/go.mozilla.org/sops/v3" rel="noopener ugc nofollow" target="_blank">Mozilla SOPS</a>(<em class="kx">SOPS-Secrets OPerationS</em>)的bash脚本的集合，是helm secrets命令的包装器。</p><p id="cdaa" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">它允许我们使用GPG/AWS KMS/GCP KMS密钥加密指定文件中的字符串，并即时解密这样的数据，将其作为一个普通值嵌入，就像我们使用普通的<code class="fe kt ku kv kw b">values.yaml</code>文件一样。</p><p id="40b1" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">因此，在这篇文章中，我们将在Arch Linux上安装插件，将创建一个AWS KMS密钥，然后将查看如何在Helm chart中加密/解密数据，然后将在Jenkins作业中使用它，该作业在我的工作项目中用于部署一个真正的工作应用程序。</p><p id="28cb" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated"><em class="kx">写这篇文章的时候打错了，顺便说一句</em>:</p><figure class="kz la lb lc gt jr gh gi paragraph-image"><div class="gh gi ky"><img src="../Images/0b8686e1e5b8fafe0a0bbd01e37de33f.png" data-original-src="https://miro.medium.com/v2/resize:fit:728/format:webp/0*mUlUhNWdz5yxMqXy.png"/></div></figure><h1 id="beb9" class="ld le iq bd lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma bi translated"><code class="fe kt ku kv kw b">helm-secrets</code>插件安装</h1><p id="4661" class="pw-post-body-paragraph ju jv iq jw b jx mb jz ka kb mc kd ke kf md kh ki kj me kl km kn mf kp kq kr ij bi translated">实际上，安装必须通过输入“<code class="fe kt ku kv kw b">helm plugin install</code>”来完成，但是它的安装脚本有点笨拙，在某些操作系统上可能无法正常工作。</p><h2 id="5df9" class="mg le iq bd lf mh mi dn lj mj mk dp ln kf ml mm lr kj mn mo lv kn mp mq lz mr bi translated"><code class="fe kt ku kv kw b">helm-secrets</code> &amp; <code class="fe kt ku kv kw b">sops</code>上拱Linux</h2><p id="ccdd" class="pw-post-body-paragraph ju jv iq jw b jx mb jz ka kb mc kd ke kf md kh ki kj me kl km kn mf kp kq kr ij bi translated">例如，在我的Arch Linux上，我首先遇到了权限问题:</p><pre class="kz la lb lc gt ms kw mt mu aw mv bi"><span id="c993" class="mg le iq kw b gy mw mx l my mz">$ helm plugin install <a class="ae ks" href="https://github.com/futuresimple/helm-secrets" rel="noopener ugc nofollow" target="_blank">https://github.com/futuresimple/helm-secrets</a><br/>which: no dpkg in (/usr/local/sbin:/usr/local/bin:/usr/bin:/usr/lib/jvm/default/bin:/usr/bin/site_perl:/usr/bin/vendor_perl:/usr/bin/core_perl:/home/setevoy/go/bin)<br/>mv: cannot create regular file ‘/usr/local/bin/sops’: Permission denied<br/>Error: plugin install hook for “secrets” exited with error</span></pre><p id="ff76" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">然后又是权限错误，无论如何我都不愿意用<code class="fe kt ku kv kw b">sudo</code>把它安装到<code class="fe kt ku kv kw b">/root</code>目录:</p><pre class="kz la lb lc gt ms kw mt mu aw mv bi"><span id="e4e2" class="mg le iq kw b gy mw mx l my mz">$ sudo helm plugin install <a class="ae ks" href="https://github.com/futuresimple/helm-secrets" rel="noopener ugc nofollow" target="_blank">https://github.com/futuresimple/helm-secrets</a><br/>which: no dpkg in (/usr/local/sbin:/usr/local/bin:/usr/bin:/usr/lib/jvm/default/bin:/usr/bin/site_perl:/usr/bin/vendor_perl:/usr/bin/core_perl:/home/setevoy/go/bin)<br/>/root/.local/share/helm/plugins/helm-secrets/install-binary.sh: line 62: /tmp/sops: Permission denied<br/>Error: plugin install hook for “secrets” exited with error</span></pre><p id="a744" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">所以—只需安装来自AUR的<code class="fe kt ku kv kw b">sops</code>包:</p><pre class="kz la lb lc gt ms kw mt mu aw mv bi"><span id="0a66" class="mg le iq kw b gy mw mx l my mz">$ yay -S sops</span></pre><p id="4717" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">或者，如果您是macOS用户，请使用<code class="fe kt ku kv kw b">brew</code>:</p><pre class="kz la lb lc gt ms kw mt mu aw mv bi"><span id="8bb1" class="mg le iq kw b gy mw mx l my mz">$ brew install sops</span></pre><p id="81f4" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">然后重复<code class="fe kt ku kv kw b">helm plugin install https://github.com/futuresimple/helm-secrets</code>命令并检查<a class="ae ks" href="https://helm.sh/docs/topics/plugins/" rel="noopener ugc nofollow" target="_blank">文档</a>——让我们看看它为我们安装了什么。</p><p id="3275" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">它必须使用<code class="fe kt ku kv kw b">$XDG_DATA_HOME/helm/plugins</code>目录，并且<code class="fe kt ku kv kw b"><a class="ae ks" href="https://wiki.archlinux.org/index.php/XDG_Base_Directory" rel="noopener ugc nofollow" target="_blank">$XDG_DATA_HOME</a></code>必须指向<code class="fe kt ku kv kw b">$HOME/.local/share</code>位置:</p><pre class="kz la lb lc gt ms kw mt mu aw mv bi"><span id="25c7" class="mg le iq kw b gy mw mx l my mz">$ ll $HOME/.local/share/helm/plugins/<br/>total 4<br/>lrwxrwxrwx 1 setevoy setevoy 76 May 15 08:30 helm-secrets -&gt; /home/setevoy/.cache/helm/plugins/https-github.com-futuresimple-helm-secrets</span></pre><p id="5945" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">插件的目录内容如下:</p><pre class="kz la lb lc gt ms kw mt mu aw mv bi"><span id="40f6" class="mg le iq kw b gy mw mx l my mz">$ ls -l /home/setevoy/.cache/helm/plugins/https-github.com-futuresimple-helm-secrets/<br/>total 68<br/>-rw-r — r — 1 setevoy setevoy 11337 May 15 08:30 LICENSE<br/>-rw-r — r — 1 setevoy setevoy 20057 May 15 08:30 README.md<br/>drwxr-xr-x 4 setevoy setevoy 4096 May 15 08:30 example<br/>-rwxr-xr-x 1 setevoy setevoy 2346 May 15 08:30 install-binary.sh<br/>-rw-r — r — 1 setevoy setevoy 338 May 15 08:30 plugin.yaml<br/>-rwxr-xr-x 1 setevoy setevoy 12388 May 15 08:30 secrets.sh<br/>-rwxr-xr-x 1 setevoy setevoy 4621 May 15 08:30 test.sh</span></pre><p id="bdf4" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">这里是上面提到的bash脚本和项目文档中的<a class="ae ks" href="https://github.com/zendesk/helm-secrets#moving-parts-of-project" rel="noopener ugc nofollow" target="_blank">活动部分。</a></p><p id="4583" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">此外，我们可以检查<code class="fe kt ku kv kw b">plugin.yaml</code>文件，看看插件将执行哪些操作:</p><pre class="kz la lb lc gt ms kw mt mu aw mv bi"><span id="70ef" class="mg le iq kw b gy mw mx l my mz">$ cat /home/setevoy/.cache/helm/plugins/https-github.com-futuresimple-helm-secrets/plugin.yaml<br/>name: “secrets”<br/>version: “2.0.2”<br/>usage: “Secrets encryption in Helm for Git storing”<br/>description: |-<br/>This plugin provides secrets values encryption for Helm charts secure storing<br/>command: “$HELM_PLUGIN_DIR/secrets.sh”<br/>useTunnel: true<br/>hooks:<br/>install: “$HELM_PLUGIN_DIR/install-binary.sh”<br/>update: “$HELM_PLUGIN_DIR/install-binary.sh”</span></pre><p id="0464" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated"><code class="fe kt ku kv kw b">command: "$HELM_PLUGIN_DIR/secrets.sh"</code>——嗯，是的——<code class="fe kt ku kv kw b">secrets.sh</code>是插件的主要工作脚本。</p><p id="b595" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">你也可以检查它的内容——但它真的足够大:</p><pre class="kz la lb lc gt ms kw mt mu aw mv bi"><span id="c927" class="mg le iq kw b gy mw mx l my mz">$ cat /home/setevoy/.cache/helm/plugins/https-github.com-futuresimple-helm-secrets/secrets.sh | wc -l<br/>534</span></pre><h1 id="c236" class="ld le iq bd lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma bi translated">加密配置</h1><p id="eb4b" class="pw-post-body-paragraph ju jv iq jw b jx mb jz ka kb mc kd ke kf md kh ki kj me kl km kn mf kp kq kr ij bi translated">为了找到用于加密和解密过程的密钥，将使用<code class="fe kt ku kv kw b">.sops.yaml</code>文件，它存储在您的图表目录的根目录中。</p><p id="8bc0" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">实际上，该文件由SOPS实用程序使用，因此您可以在使用. sops.yaml conf为新文件 doc选择KMS/PGP的<a class="ae ks" href="https://github.com/mozilla/sops#id18" rel="noopener ugc nofollow" target="_blank">中找到它的配置示例。</a></p><p id="e2a5" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">现在，我们可以创建一个AWS KMS密钥，用于保护我们的数据。</p><h2 id="0659" class="mg le iq bd lf mh mi dn lj mj mk dp ln kf ml mm lr kj mn mo lv kn mp mq lz mr bi translated">自动气象站KMS——一个重要的创新</h2><p id="5597" class="pw-post-body-paragraph ju jv iq jw b jx mb jz ka kb mc kd ke kf md kh ki kj me kl km kn mf kp kq kr ij bi translated">如果你以前没有使用过https://aws.amazon.com/ru/kms/getting-started的AWS KMS服务，请点击这里查看它的文档。</p><p id="34fe" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">转到AWS控制台并创建一个新的对称密钥(参见<a class="ae ks" href="https://docs.aws.amazon.com/kms/latest/developerguide/symmetric-asymmetric.html" rel="noopener ugc nofollow" target="_blank">使用对称和非对称密钥</a>):</p><figure class="kz la lb lc gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="nb nc di nd bf ne"><div class="gh gi na"><img src="../Images/1e24d8810bdae5ddc1b09d645f31bd8d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*EBJSI973oqW5UrQU.png"/></div></div></figure><figure class="kz la lb lc gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="nb nc di nd bf ne"><div class="gh gi nf"><img src="../Images/3279d4a7921bdee437845de0e6071a18.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*r0zDHvgBO2Z-AAb9.png"/></div></div></figure><p id="d802" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">设置其<em class="kx">管理员</em>:</p><figure class="kz la lb lc gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="nb nc di nd bf ne"><div class="gh gi na"><img src="../Images/e03bb8d1cd735314c14aee1c52cee504.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*vJHbNPAxqOoJc2Nb.png"/></div></div></figure><p id="88f2" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">现在，我们需要添加它的用户。</p><p id="a271" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">因为我将使用运行在AWS EC2上的Jenkins实例中的密钥，并且该EC2实例具有附加的<a class="ae ks" href="https://rtfm.co.ua/en/aws-iam-users-keys-rotation-ec2-iam-roles-and-jenkins/" rel="noopener ugc nofollow" target="_blank"> AWS EC2实例概要文件</a>来验证AWS服务，所以我需要添加它的IAM角色作为密钥的用户。</p><p id="7c1c" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">转到Jenkins EC2，找到它的IAM角色(在下面截图的底部):</p><figure class="kz la lb lc gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="nb nc di nd bf ne"><div class="gh gi ng"><img src="../Images/715ab5114adda19320e51b533359513e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1358/format:webp/0*crt7gG42Jv6oUuor.png"/></div></div></figure><p id="3020" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">将它附加到我们正在创建的键的<em class="kx">用户</em>:</p><figure class="kz la lb lc gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="nb nc di nd bf ne"><div class="gh gi nh"><img src="../Images/664102deb3c5cc6f1525cd3924151e88.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*AztOq4vNhsqRKcE8.png"/></div></div></figure><p id="cdf1" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">确认生成的策略:</p><figure class="kz la lb lc gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="nb nc di nd bf ne"><div class="gh gi ni"><img src="../Images/5c13ab9d9d7bc249245e6e28623aa827.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*1GvoURUkH_L7i4Ly.png"/></div></div></figure><p id="12d1" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">顺便说一句——注意这里:</p><pre class="kz la lb lc gt ms kw mt mu aw mv bi"><span id="5789" class="mg le iq kw b gy mw mx l my mz">...<br/>            "Principal": {<br/>                "AWS": "arn:aws:iam::534***385:root"<br/>            },<br/>            "Action": "kms:*",<br/>            "Resource": "*"<br/>...</span></pre><p id="e669" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">这个"<em class="kx">arn:aws:iam::534 * * * 385:root "</em>arn指的是AWS账户的所有用户，我记得是从<a class="ae ks" href="https://rtfm.co.ua/aws-elastic-kubernetes-service-rbac-avtorizaciya-cherez-aws-iam-i-rbac-gruppy/#IAM_Role_Trust_relationships" rel="noopener ugc nofollow" target="_blank">AWS elastic kubernetes service:rbac-авторизациячерезAWS iamиRBACгруппы</a>post(<em class="kx">目前只有俄语</em>)上看到的，所以要记住。</p><p id="b25d" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">按下<em class="kx">完成</em>按钮，钥匙准备好；</p><figure class="kz la lb lc gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="nb nc di nd bf ne"><div class="gh gi nj"><img src="../Images/517b4c4823864dea1712b3e3708c75d9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*4Y6KX_0knfg97Bei.png"/></div></div></figure><h2 id="81fc" class="mg le iq bd lf mh mi dn lj mj mk dp ln kf ml mm lr kj mn mo lv kn mp mq lz mr bi translated"><code class="fe kt ku kv kw b">.sops.yaml</code>配置</h2><p id="58fa" class="pw-post-body-paragraph ju jv iq jw b jx mb jz ka kb mc kd ke kf md kh ki kj me kl km kn mf kp kq kr ij bi translated">现在，转到您的图表目录并创建<code class="fe kt ku kv kw b">.sops.yaml</code>文件来配置用于我们的秘密的密钥。</p><p id="6708" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">让我们使用这里唯一的一个默认规则来应用于我们上面创建的带有AWS KMS密钥的任何机密文件:</p><pre class="kz la lb lc gt ms kw mt mu aw mv bi"><span id="8c1e" class="mg le iq kw b gy mw mx l my mz">---<br/>creation_rules:<br/>  - kms: 'arn:aws:kms:eu-west-1:534***385:key/620b89fe-***-25b435611e8b'</span></pre><h2 id="afa3" class="mg le iq bd lf mh mi dn lj mj mk dp ln kf ml mm lr kj mn mo lv kn mp mq lz mr bi translated">秘密文件</h2><p id="6220" class="pw-post-body-paragraph ju jv iq jw b jx mb jz ka kb mc kd ke kf md kh ki kj me kl km kn mf kp kq kr ij bi translated">接下来，创建一个名为<code class="fe kt ku kv kw b">secrets.yaml</code>的新文件。</p><p id="b70d" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">这里有一个小陷阱——脚本将寻找<em class="kx">秘密。*.yaml </em>文件默认情况下，请参见<a class="ae ks" href="https://github.com/zendesk/helm-secrets#usage-and-examples" rel="noopener ugc nofollow" target="_blank">用法和示例</a>，并且您不能只使用像“<em class="kx"> my-passwords.yaml </em>这样的名称，至少在没有一些额外配置的情况下:</p><blockquote class="nk nl nm"><p id="84e5" class="ju jv kx jw b jx jy jz ka kb kc kd ke nn kg kh ki no kk kl km np ko kp kq kr ij bi translated">按照惯例，包含秘密的文件被命名为secrets.yaml，或者任何以“secrets”开头的文件。并以“，”结尾。yaml”。例如secrets.test.yaml和secrets.prod.yaml。</p></blockquote><p id="8f80" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">例如，我现有的<code class="fe kt ku kv kw b">values.yaml</code>中有以下字符串——这里是一个“<em class="kx">密码”</em>密钥，带有一个明文值“<em class="kx"> pass </em>”:</p><pre class="kz la lb lc gt ms kw mt mu aw mv bi"><span id="1770" class="mg le iq kw b gy mw mx l my mz">...<br/>image:<br/>  registry: "docker.io"<br/>  username: "bttrm"<br/>  password: "pass"<br/>  repository: "bttrm"<br/>  name: "bttrm-apps"<br/>  tag: "120"<br/>...</span></pre><p id="69f7" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">从<code class="fe kt ku kv kw b">values.yaml</code>上切下<code class="fe kt ku kv kw b">image.password</code>并将其移动到<code class="fe kt ku kv kw b">secrets.yaml</code>:</p><pre class="kz la lb lc gt ms kw mt mu aw mv bi"><span id="48c7" class="mg le iq kw b gy mw mx l my mz">image:<br/>  password: "pass"</span></pre><p id="4d53" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">或者，为了使这个例子更加清楚和简单，我们也给这个<code class="fe kt ku kv kw b">secrets.yaml</code>添加一个新的键和值:</p><pre class="kz la lb lc gt ms kw mt mu aw mv bi"><span id="3931" class="mg le iq kw b gy mw mx l my mz">test:<br/>    secret: testecret</span></pre><p id="7b6a" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">然后为Kubernetes Secrets创建一个清单，在我的例子中，所有的秘密都在<code class="fe kt ku kv kw b">bttrm-apps-backend/templates/bttrm-apps-secrets.yaml</code>文件中描述，其中<em class="kx"> bttrm-apps-backend </em>是图表的目录:</p><pre class="kz la lb lc gt ms kw mt mu aw mv bi"><span id="42f1" class="mg le iq kw b gy mw mx l my mz">---<br/>apiVersion: v1<br/>kind: Secret<br/>metadata:<br/>  name: test-secret<br/>type: Opaque<br/>stringData:<br/>  example-secret: {{ .Values.test.secret }}</span></pre><p id="a49c" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">正如你所看到的——在<code class="fe kt ku kv kw b">stringData</code>字段中，我们通常将<code class="fe kt ku kv kw b">.Values</code>用于普通的<code class="fe kt ku kv kw b">values.yaml</code>文件。</p><h2 id="985b" class="mg le iq bd lf mh mi dn lj mj mk dp ln kf ml mm lr kj mn mo lv kn mp mq lz mr bi translated"><code class="fe kt ku kv kw b">helm secrets</code> - AccessDeniedException</h2><p id="f6ac" class="pw-post-body-paragraph ju jv iq jw b jx mb jz ka kb mc kd ke kf md kh ki kj me kl km kn mf kp kq kr ij bi translated">现在，我们可以使用<code class="fe kt ku kv kw b">helm secrets enc</code>命令加密文件:</p><pre class="kz la lb lc gt ms kw mt mu aw mv bi"><span id="de83" class="mg le iq kw b gy mw mx l my mz">$ helm secrets enc secrets.yaml<br/>Encrypting secrets.yaml<br/>Could not generate data key: [failed to encrypt new data key with master key “arn:aws:kms:eu-west-1:534***385:key/620b89fe-8365–45a6-aad6–25b435611e8b”: Failed to call KMS encryption service: AccessDeniedException:<br/>status code: 400, request id: 699332aa-492b-47b4-b9ab-50f83dbcc2a4]<br/>Error: plugin “secrets” exited with error</span></pre><p id="2008" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">啊，好吧。</p><p id="69a9" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">问题很明显SOPS试图使用<code class="fe kt ku kv kw b">~/.aws/credentials</code>中的<em class="kx">默认</em> <a class="ae ks" href="https://rtfm.co.ua/en/aws-cli-named-profiles/" rel="noopener ugc nofollow" target="_blank"> AWS CLI配置文件</a>访问<code class="fe kt ku kv kw b">.sops.yaml</code>配置中指定的AWS KMS密钥，我在这里配置了我的个人AWS帐户，而密钥位于我的工作帐户中。</p><p id="5722" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">因此，在这种情况下，您可以使用<code class="fe kt ku kv kw b">.sops.yaml</code>中的<code class="fe kt ku kv kw b">aws_profile</code>选项来指定一个概要文件:</p><pre class="kz la lb lc gt ms kw mt mu aw mv bi"><span id="aa49" class="mg le iq kw b gy mw mx l my mz">---<br/>creation_rules:<br/>  - kms: 'arn:aws:kms:eu-west-1:534***385:key/620b89fe-***-25b435611e8b'<br/>    aws_profile: 'arseniy'</span></pre><p id="eb2b" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">但同样的帐户将被用于詹金斯的工作。</p><p id="a710" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">另一种方法是使用<code class="fe kt ku kv kw b">$AWS_PROFILE</code>环境变量:</p><pre class="kz la lb lc gt ms kw mt mu aw mv bi"><span id="6cca" class="mg le iq kw b gy mw mx l my mz">$ AWS_PROFILE=arseniy</span></pre><p id="6d18" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">在<em class="kx"> bttrm-apps-backend </em>目录下重复<code class="fe kt ku kv kw b">secrets.yaml</code>文件加密:</p><pre class="kz la lb lc gt ms kw mt mu aw mv bi"><span id="6eda" class="mg le iq kw b gy mw mx l my mz">$ helm secrets enc bttrm-apps-backend/secrets.yaml</span></pre><p id="fce4" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">现在检查其内容:</p><pre class="kz la lb lc gt ms kw mt mu aw mv bi"><span id="0cf1" class="mg le iq kw b gy mw mx l my mz">image:<br/>    password: ENC[AES256_GCM,data:1t7 .. PyY,iv:9mzTyB ... 9KG7+Hg=,tag:6KJ ... gvA==,type:str]<br/>test:<br/>    secret: ENC[AES256_GCM,data:l4c ... vCy,iv:9riw ... 0fvQ=,tag:G3p ... oSw==,type:str]<br/>sops:<br/>    kms:<br/>    -   arn: arn:aws:kms:eu-west-1:534***385:key/620b89fe- ... -25b435611e8b<br/>        created_at: '2020-05-15T06:33:44Z'<br/>        enc: AQICAHj9F0HBsgu ... kb6GOxJkiOMZSSxOtA==<br/>...</span></pre><p id="ec89" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">如您所见，这些值现在已被加密，然后还有关于加密过程中应用的配置的sop信息。</p><p id="aa74" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">您可以使用<code class="fe kt ku kv kw b">secrets view</code>命令查看初始数据:</p><pre class="kz la lb lc gt ms kw mt mu aw mv bi"><span id="a075" class="mg le iq kw b gy mw mx l my mz">$ helm secrets view bttrm-apps-backend/secrets.yaml<br/>image:<br/>password: pass<br/>test:<br/>secret: testecret</span></pre><p id="7659" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">并用<code class="fe kt ku kv kw b">secrets edit</code>编辑文件:</p><pre class="kz la lb lc gt ms kw mt mu aw mv bi"><span id="10a6" class="mg le iq kw b gy mw mx l my mz">$ helm secrets edit bttrm-apps-backend/secrets.yaml</span></pre><p id="3531" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">并用<code class="fe kt ku kv kw b">secrets dec</code>命令解密——这将在原来的<code class="fe kt ku kv kw b">secrets.yaml</code>附近创建一个新的<code class="fe kt ku kv kw b">secrets.yaml.dec</code>文件。</p><h2 id="8e3e" class="mg le iq bd lf mh mi dn lj mj mk dp ln kf ml mm lr kj mn mo lv kn mp mq lz mr bi translated">测试部署</h2><p id="4c86" class="pw-post-body-paragraph ju jv iq jw b jx mb jz ka kb mc kd ke kf md kh ki kj me kl km kn mf kp kq kr ij bi translated">要部署带有加密数据的图表——像往常一样使用<code class="fe kt ku kv kw b">install</code>或<code class="fe kt ku kv kw b">upgrade</code>调用<code class="fe kt ku kv kw b">helm</code>,或者在我的例子中使用Jenkins作业(稍后会谈到)——<code class="fe kt ku kv kw b">upgrade --install</code>,但是现在添加<code class="fe kt ku kv kw b">secrets</code>命令- <code class="fe kt ku kv kw b">helm</code>将执行<code class="fe kt ku kv kw b">secrets.sh</code>脚本，该脚本将执行所有必要的操作。</p><p id="cb3b" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">在下面的例子中，我使用<code class="fe kt ku kv kw b">values.yaml</code> <strong class="jw ir">和</strong> <code class="fe kt ku kv kw b">secrets.yaml</code>文件作为值的来源，将<em class="kx"> bttrm-apps-backend/ </em>图表安装为<em class="kx"> bttrm-apps-backend </em>版本(实际上，您可以跳过默认的<code class="fe kt ku kv kw b">values.yaml</code>文件，指定唯一的<code class="fe kt ku kv kw b">secrets.yaml</code>作为附加文件):</p><pre class="kz la lb lc gt ms kw mt mu aw mv bi"><span id="ec96" class="mg le iq kw b gy mw mx l my mz">$ helm secrets upgrade — install bttrm-apps-backend bttrm-apps-backend/ -f bttrm-apps-backend/values.yaml -f bttrm-apps-backend/secrets.yaml<br/>Release “bttrm-apps-backend” has been upgraded. Happy Helming!<br/>…</span></pre><p id="448b" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">在执行了<code class="fe kt ku kv kw b">helm secrets upgrade</code>之后，检查加密过程中启动的进程可能会很有趣:</p><pre class="kz la lb lc gt ms kw mt mu aw mv bi"><span id="e563" class="mg le iq kw b gy mw mx l my mz">$ ps aux | grep helm<br/>setevoy 74906 0.0 0.3 1270888 49984 pts/1 Sl+ 17:05 0:00 helm secrets upgrade — install — namespace bttrm-apps-dev-1-ns — create-namespace — atomic bttrm-apps-backend bttrm-apps-backend/ -f bttrm-apps-backend/values.yaml -f bttrm-apps-backend/secrets.yaml<br/>setevoy 74914 0.0 0.0 4436 3672 pts/1 S+ 17:05 0:00 bash /home/setevoy/.local/share/helm/plugins/helm-secrets/secrets.sh upgrade — install — create-namespace — atomic bttrm-apps-backend bttrm-apps-backend/ -f bttrm-apps-backend/values.yaml -f bttrm-apps-backend/secrets.yaml<br/>setevoy 74963 0.8 0.5 1271768 96876 pts/1 Sl+ 17:06 0:00 helm upgrade bttrm-apps-backend bttrm-apps-backend/ — install — create-namespace — atomic -f bttrm-apps-backend/values.yaml -f bttrm-apps-backend/secrets.yaml.dec</span></pre><p id="ac98" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">例如:</p><ol class=""><li id="26ee" class="nq nr iq jw b jx jy kb kc kf ns kj nt kn nu kr nv nw nx ny bi translated">我们跑了<code class="fe kt ku kv kw b">helm secrets upgrade</code></li><li id="a5fd" class="nq nr iq jw b jx nz kb oa kf ob kj oc kn od kr nv nw nx ny bi translated">它叫做<code class="fe kt ku kv kw b">bash /home/setevoy/.local/share/helm/plugins/helm-secrets/secrets.sh upgrade</code></li><li id="5ed9" class="nq nr iq jw b jx nz kb oa kf ob kj oc kn od kr nv nw nx ny bi translated">执行了<code class="fe kt ku kv kw b">helm upgrade</code></li></ol><p id="9a1a" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">现在，我们来看看Kubernetes的秘密:</p><pre class="kz la lb lc gt ms kw mt mu aw mv bi"><span id="f962" class="mg le iq kw b gy mw mx l my mz">$ kubectl -n bttrm-apps-dev-1-ns get secret test-secret -o yaml<br/>apiVersion: v1<br/>data:<br/>example-secret: dGVzdGVjcmV0<br/>…</span></pre><p id="77b4" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">而来自<em class="kx"> dGVzdGVjcmV0 </em> base64编码字符串的值为:</p><pre class="kz la lb lc gt ms kw mt mu aw mv bi"><span id="cae2" class="mg le iq kw b gy mw mx l my mz">$ echo dGVzdGVjcmV0 | base64 — decode<br/>testecret</span></pre><p id="c41e" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">酷—”<em class="kx">管用！</em>”</p><p id="b7c7" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">去找詹金斯的工作。</p><h1 id="eae1" class="ld le iq bd lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma bi translated">詹金斯</h1><p id="e75b" class="pw-post-body-paragraph ju jv iq jw b jx mb jz ka kb mc kd ke kf md kh ki kj me kl km kn mf kp kq kr ij bi translated">现在，我需要将上述内容嵌入到一个詹金斯文件中，我在<a class="ae ks" href="https://rtfm.co.ua/helm-poshagovoe-sozdanie-charta-i-deplojmenta-iz-jenkins/#Jenkins_job_stages" rel="noopener ugc nofollow" target="_blank"> Helm中写道:пошаговоерожгегречартаигерееорертарез詹金斯</a>岗位(也是俄语，不幸的是<em class="kx">)——该脚本将建立一个码头工人的形象并将进行部署</em></p><p id="d7d7" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">如果现在删除发行:</p><pre class="kz la lb lc gt ms kw mt mu aw mv bi"><span id="2a01" class="mg le iq kw b gy mw mx l my mz">$ helm -n bttrm-apps-dev-1-ns delete bttrm-apps-backend<br/>release “bttrm-apps-backend” uninstalled</span></pre><p id="faad" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">运行Jenkins作业时，它显然将失败，因为<code class="fe kt ku kv kw b">helm</code>将无法找到我们从<code class="fe kt ku kv kw b">values.yaml</code>移动到<code class="fe kt ku kv kw b">secrets.yaml</code>文件中的数据:</p><pre class="kz la lb lc gt ms kw mt mu aw mv bi"><span id="6e55" class="mg le iq kw b gy mw mx l my mz">+ helm upgrade — install bttrm-apps-backend bttrm-apps-backend-20.tgz</span><span id="584b" class="mg le iq kw b gy oe mx l my mz">Release “bttrm-apps-backend” does not exist. Installing it now.</span><span id="e083" class="mg le iq kw b gy oe mx l my mz">Error: unable to build kubernetes objects from release manifest: error validating “”: error validating data: [unknown object type “nil” in Secret.stringData.backend-apple-cert-passphrase, unknown object type “nil” in Secret.stringData.backend-apple-sigin-key-id, unknown object type “nil” in Secret.stringData.backend-db-password, unknown object type “nil” in Secret.stringData.backend-private-key, unknown object type “nil” in Secret.stringData.backend-secret]</span></pre><p id="238d" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">因此，为了让它再次发挥作用，我需要在构建时使用的Docker映像中添加SOPS工具和<code class="fe kt ku kv kw b">helm-secrets</code>插件，然后更新脚本中的<em class="kx">阶段(“Helm install”)</em>，以添加<code class="fe kt ku kv kw b">secrets</code>命令和<code class="fe kt ku kv kw b">-f secrets.yaml</code>。</p><h2 id="478c" class="mg le iq bd lf mh mi dn lj mj mk dp ln kf ml mm lr kj mn mo lv kn mp mq lz mr bi translated">Jenkins Docker构建-形象</h2><p id="770b" class="pw-post-body-paragraph ju jv iq jw b jx mb jz ka kb mc kd ke kf md kh ki kj me kl km kn mf kp kq kr ij bi translated">目前，我的Docker映像是使用下一个Docker文件构建的:</p><pre class="kz la lb lc gt ms kw mt mu aw mv bi"><span id="7988" class="mg le iq kw b gy mw mx l my mz">FROM bitnami/minideb:stretch<br/>  <br/>RUN apt update &amp;&amp; install_packages ca-certificates wget<br/>RUN install_packages curl python-pip python-setuptools jq git<br/><br/>RUN curl -LO <a class="ae ks" href="https://storage.googleapis.com/kubernetes-release/release/`curl" rel="noopener ugc nofollow" target="_blank">https://storage.googleapis.com/kubernetes-release/release/`curl</a> -s <a class="ae ks" href="https://storage.googleapis.com/kubernetes-release/release/stable.txt`/bin/linux/amd64/kubectl" rel="noopener ugc nofollow" target="_blank">https://storage.googleapis.com/kubernetes-release/release/stable.txt`/bin/linux/amd64/kubectl</a><br/>RUN chmod +x ./kubectl<br/>RUN mv ./kubectl /usr/local/bin/kubectl<br/><br/>WORKDIR /tmp<br/>RUN curl  --location "https://github.com/weaveworks/eksctl/releases/latest/download/eksctl_$(uname -s)_amd64.tar.gz" | tar xz -C /tmp<br/>RUN mv /tmp/eksctl /usr/local/bin<br/><br/>RUN pip install ansible boto3 awscli<br/><br/>WORKDIR /tmp<br/>RUN curl -fsSL -o get_helm.sh <a class="ae ks" href="https://raw.githubusercontent.com/helm/helm/master/scripts/get-helm-3" rel="noopener ugc nofollow" target="_blank">https://raw.githubusercontent.com/helm/helm/master/scripts/get-helm-3</a><br/>RUN /bin/bash get_helm.sh<br/><br/>USER root</span></pre><p id="49b6" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">加上插件安装——这里使用的是<code class="fe kt ku kv kw b">bitnami/minideb:stretch</code>映像，所以我希望SOPS的安装没有任何问题，就像我的Arch Linux一样:</p><pre class="kz la lb lc gt ms kw mt mu aw mv bi"><span id="90af" class="mg le iq kw b gy mw mx l my mz">...<br/>RUN curl -fsSL -o get_helm.sh <a class="ae ks" href="https://raw.githubusercontent.com/helm/helm/master/scripts/get-helm-3" rel="noopener ugc nofollow" target="_blank">https://raw.githubusercontent.com/helm/helm/master/scripts/get-helm-3</a><br/>RUN /bin/bash get_helm.sh<br/>RUN helm plugin install <a class="ae ks" href="https://github.com/futuresimple/helm-secrets" rel="noopener ugc nofollow" target="_blank">https://github.com/futuresimple/helm-secrets</a> <br/><br/>USER root</span></pre><p id="99f2" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">尝试构建:</p><pre class="kz la lb lc gt ms kw mt mu aw mv bi"><span id="7180" class="mg le iq kw b gy mw mx l my mz">$ docker build -t bttrm/kubectl-aws:4.1 .<br/>…<br/>Step 14/15 : RUN helm plugin install <a class="ae ks" href="https://github.com/futuresimple/helm-secrets" rel="noopener ugc nofollow" target="_blank">https://github.com/futuresimple/helm-secrets</a><br/> — -&gt; Running in 9c8b1e891e86<br/>/usr/bin/dpkg<br/>/root/.local/share/helm/plugins/helm-secrets/install-binary.sh: line 57: sudo: command not found<br/>Error: plugin install hook for “secrets” exited with error<br/>The command ‘/bin/sh -c helm plugin install <a class="ae ks" href="https://github.com/futuresimple/helm-secrets'" rel="noopener ugc nofollow" target="_blank">https://github.com/futuresimple/helm-secrets'</a> returned a non-zero code: 1</span></pre><p id="4d0a" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">嗯——没有:-)</p><p id="4ea1" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">好的—我们可以使用PIP进行安装:</p><pre class="kz la lb lc gt ms kw mt mu aw mv bi"><span id="a8b6" class="mg le iq kw b gy mw mx l my mz">...<br/>RUN mv /tmp/eksctl /usr/local/bin <br/><br/>RUN pip install ansible boto3 awscli sops<br/><br/>WORKDIR /tmp<br/>...</span></pre><p id="553c" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">虽然在打造赫尔姆的过程中曾说过:</p><pre class="kz la lb lc gt ms kw mt mu aw mv bi"><span id="a256" class="mg le iq kw b gy mw mx l my mz">…<br/>sops is already installed:<br/>INFO: You’re using Sops 1 written in Python. Sops 2 was rewritten in Go. Consider installing it with: $ go get -u go.mozilla.org/sops/cmd/sops<br/>sops 1.18<br/>…</span></pre><p id="6f90" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">但让我们看看这是否能在Jenkins构建中起作用。</p><h2 id="f2b0" class="mg le iq bd lf mh mi dn lj mj mk dp ln kf ml mm lr kj mn mo lv kn mp mq lz mr bi translated">Jenkinsfile和部署作业</h2><p id="8d04" class="pw-post-body-paragraph ju jv iq jw b jx mb jz ka kb mc kd ke kf md kh ki kj me kl km kn mf kp kq kr ij bi translated">最后一步是更新管道的詹金斯文件——添加<code class="fe kt ku kv kw b">secrets</code>和<code class="fe kt ku kv kw b">-f bttrm-apps-backend/secrets.yaml</code>:</p><pre class="kz la lb lc gt ms kw mt mu aw mv bi"><span id="6999" class="mg le iq kw b gy mw mx l my mz">...<br/>        stage("Helm install") {<br/>                    ...<br/>                    sh "helm secrets upgrade --install --namespace ${AWS_EKS_NAMESPACE} --create-namespace --atomic ${APP_CHART_NAME} ${APP_CHART_NAME}-${RELEASE_VERSION}.tgz -f bttrm-apps-backend/secrets.yaml"<br/>                }<br/>            }   <br/>        }<br/>...</span></pre><p id="c531" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">运行:</p><figure class="kz la lb lc gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="nb nc di nd bf ne"><div class="gh gi of"><img src="../Images/561ba67d0f7a6fd83c7be354da1aefbb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*qjaKTddr446myKU_.png"/></div></div></figure><p id="da26" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">一切都准备好了。</p><h1 id="90bd" class="ld le iq bd lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma bi translated">有用的链接</h1><ul class=""><li id="d8b5" class="nq nr iq jw b jx mb kb mc kf og kj oh kn oi kr oj nw nx ny bi translated"><a class="ae ks" href="https://thefirstapril.com/2019/06/29/Secret-Management-in-Helm-Kubernetes/" rel="noopener ugc nofollow" target="_blank">赫尔姆的秘密管理——库本内斯</a></li><li id="b3aa" class="nq nr iq jw b jx nz kb oa kf ob kj oc kn od kr oj nw nx ny bi translated"><a class="ae ks" href="https://medium.com/@Devopscontinens/encrypting-helm-secrets-7f37a0ccabeb" rel="noopener">加密头盔密码</a></li><li id="6181" class="nq nr iq jw b jx nz kb oa kf ob kj oc kn od kr oj nw nx ny bi translated"><a class="ae ks" href="https://www.diycode.cc/projects/futuresimple/helm-secrets" rel="noopener ugc nofollow" target="_blank">掌舵秘籍</a></li></ul></div><div class="ab cl ok ol hu om" role="separator"><span class="on bw bk oo op oq"/><span class="on bw bk oo op oq"/><span class="on bw bk oo op"/></div><div class="ij ik il im in"><p id="9e8d" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated"><em class="kx">最初发表于</em> <a class="ae ks" href="https://rtfm.co.ua/en/helm-helm-secrets-sensitive-data-encryption-with-aws-kms-and-use-it-from-jenkins/" rel="noopener ugc nofollow" target="_blank"> <em class="kx"> RTFM: Linux、DevOps和系统管理</em> </a> <em class="kx">。</em></p></div></div>    
</body>
</html>