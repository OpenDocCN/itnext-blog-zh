<html>
<head>
<title>Multicloud IPv6 with Terraform — AWS</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">采用Terraform的多云IPv6—AWS</h1>
<blockquote>原文：<a href="https://itnext.io/multicloud-ipv6-with-terraform-aws-221a07f2b5a2?source=collection_archive---------3-----------------------#2021-02-09">https://itnext.io/multicloud-ipv6-with-terraform-aws-221a07f2b5a2?source=collection_archive---------3-----------------------#2021-02-09</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="8fdb" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在这篇文章中，我继续分享我在AWS、Azure和GCP使用Terraform构建IPv6可伸缩、弹性NGNIX部署的工作。</p><p id="69bb" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">该版本适用于AWS请点击查看Azure中的部署。完整的源代码可以在<a class="ae kl" href="https://github.com/fvanrooyen/MulticloudIPv6" rel="noopener ugc nofollow" target="_blank"> GitHub </a>中找到</p><p id="1a33" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">部署概述</strong></p><p id="4ba7" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">此部署的要求如下:</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div class="gh gi km"><img src="../Images/78ce8c2555208d9f5399219970f28a3f.png" data-original-src="https://miro.medium.com/v2/resize:fit:818/format:webp/0*X6w-k6_isU4WO5hs.png"/></div></figure><ol class=""><li id="b6c7" class="ku kv iq jp b jq jr ju jv jy kw kc kx kg ky kk kz la lb lc bi translated">客户需要通过IPv4和IPv6实现这种部署</li><li id="e6cf" class="ku kv iq jp b jq ld ju le jy lf kc lg kg lh kk kz la lb lc bi translated">单区域多AZ部署</li><li id="3d08" class="ku kv iq jp b jq ld ju le jy lf kc lg kg lh kk kz la lb lc bi translated">使用本地L4负载平衡器</li><li id="7944" class="ku kv iq jp b jq ld ju le jy lf kc lg kg lh kk kz la lb lc bi translated">将NGINX用于代理/L7</li><li id="8de2" class="ku kv iq jp b jq ld ju le jy lf kc lg kg lh kk kz la lb lc bi translated">NGINX实例需要自动伸缩</li></ol><p id="f9c3" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir"> AWS部署</strong></p><p id="79e3" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">AWS在各种基础设施组件中支持IPv6方面取得了巨大进步。他们所做的工作概括了转向IPv6寻址的真正本质。IPv6为我们提供了广阔的地址空间；这意味着没有NAT复杂性或私有地址重叠；相反，所有设备都有唯一的公共地址。尽管AWS还没有完成完全支持IPv6的工作，但像出口专用互联网网关这样的组件显示了建立在坚实原则上的基础。</p><p id="fdc1" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">快速概述我们将要创建的内容:</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="lj lk di ll bf lm"><div class="gh gi li"><img src="../Images/abd8ca89a74c4545037c8d7cf78b927f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*xmLz4kVTx47U2Bdit2ZRNw.png"/></div></div></figure><p id="9098" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">上面是一个三区域部署，每个区域使用一个公共和私有子网。您可能会注意到，从IPv6流的角度来看，流量在负载平衡器处停止。原因是我们将用于此部署的网络负载平衡器不会将IPv6流量转发到下游主机；相反，它会终止连接并将流量转换到IPv4网络。这种实现显然并不理想，但正如我提到的，AWS仍在努力让他们的所有服务完全支持IPv6，NLB似乎就是这种情况。</p><p id="df0b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir"> AWS IPv6联网</strong></p><p id="ec84" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">第一项任务是创建VPC:</p><figure class="kn ko kp kq gt kr"><div class="bz fp l di"><div class="ln lo l"/></div></figure><p id="6b3c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">对于要启用IPv6的VPC，会为其分配一个IPv6 CIDR块。该功能通过将<code class="fe lp lq lr ls b">assign_generated_ipv6_cidr_block</code>参数设置为真来实现。此时，AWS将从亚马逊的全球单播地址(GUA)中分配一个/56 IPv6 CIDR块，并将其附加到VPC。您不能自己选择此范围。gua，也称为<em class="lt">可聚合全球单播地址</em>，在IPv6互联网中可全球路由和到达。它们相当于公共IPv4地址。</p><p id="b8f0" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">下一步是设置公共和私有子网:</p><figure class="kn ko kp kq gt kr"><div class="bz fp l di"><div class="ln lo l"/></div></figure><p id="5337" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">为了确保此环境的安全，需要实施公共和私有子网。由于AWS将子网固定到一个可用性分区，因此我们将为每个分区创建两个，总共六个子网。专用子网确保自动扩展组实例只能通过负载平衡器进行访问。对于公共子网，通过使用<code class="fe lp lq lr ls b">ipv6_cidr_block = cidrsubnet(aws_vpc.ipv6_vpc.ipv6_cidr_block, 8, 1)</code>从VPC块中为IPv6分配一个IPv6 CIDR块来启用IPv6。<code class="fe lp lq lr ls b">cidrsubnet(prefix, newbits, netnum)</code>计算给定IP网络地址前缀内的子网地址；在这种情况下，我们将从VPC数据块为每个子网创建一个IPv6 /64。对于私有子网，不需要为IPv6做任何事情，因为它们只是IPv4子网。</p><p id="8bd7" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">创建VPC和子网后，就该设置Internet网关和路由表了。</p><figure class="kn ko kp kq gt kr"><div class="bz fp l di"><div class="ln lo l"/></div></figure><p id="0cb8" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">创建路由表时，需要IPv6条目<code class="fe lp lq lr ls b">ipv6_cidr_block = “::/0”</code></p><p id="d7c9" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">为了使专用子网能够与Internet通信，需要创建三个NAT网关。NAT网关只是IPv4的一项要求。</p><figure class="kn ko kp kq gt kr"><div class="bz fp l di"><div class="ln lo l"/></div></figure><p id="9799" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">上面的代码部分创建了三个NAT网关，每个AZ一个，在每个私有子网中创建了三个路由表，将默认路由设置为该区域的NAT网关，最后将其与适当的子网相关联。</p><p id="7cf0" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">关于出口专用的互联网网关</strong></p><p id="a437" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">值得一提的是，如果专用子网确实有一个与之相关联的IPv6地址块，那么就需要一个仅出口的互联网网关来将流量路由到互联网。仅出口internet网关被定义为:“一个水平扩展、冗余且高度可用的VPC组件，它允许通过IPv6从VPC中的实例向internet进行出站通信，并阻止internet启动与您的实例的IPv6连接。”因此，该组件有助于确保包含公共IPv6地址的专用子网的安全性。</p><p id="022e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">安全</strong></p><p id="a885" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">安全组被创建并应用于自动缩放组中的实例</p><figure class="kn ko kp kq gt kr"><div class="bz fp l di"><div class="ln lo l"/></div></figure><p id="6241" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">由于安全组将应用于专用子网组件，因此不需要输入IPv6条目。看着这个SG，可能会觉得奇怪的是“允许所有80”语句。这种奇怪与NLB没有任何安全组织的事实有关。相反，您可以通过将安全组直接附加到EC2实例来控制访问。</p><p id="65ff" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">负载平衡器</strong></p><p id="85ea" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我在这个部署中使用了NLB，因为它满足了POC的要求。如前所述，NLB不会转发IPv6流量。NLB的目标群体还不支持IPv6，我希望这一功能很快就能实现。</p><figure class="kn ko kp kq gt kr"><div class="bz fp l di"><div class="ln lo l"/></div></figure><p id="f9bf" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">创建基础LB需要将<code class="fe lp lq lr ls b"> ip_address_type</code>设置为<code class="fe lp lq lr ls b">“dualstack”</code>以支持IPv6端点并创建必要的A和AAAA DNS记录。因为我想让这个NLB跨越多个AZ，所以我使用了<code class="fe lp lq lr ls b">enable_cross_zone_load_balancing = true</code></p><p id="d785" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">从现在开始，一切都是通过创建一个监听器、目标组和健康检查来建立标准的IPv4。</p><p id="27d1" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">本质上，这是IPv6特定植入的终点，剩下的只是在自动扩展组的私有子网中设置实例。完整实现请查看<a class="ae kl" href="https://github.com/fvanrooyen/MulticloudIPv6" rel="noopener ugc nofollow" target="_blank"> GitHub </a>中的部署。</p><p id="e2f1" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">验证</strong></p><p id="50a6" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">对于这个简单的例子，我首先检查目标群体部分，以确保该站点可用:</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div class="gh gi lu"><img src="../Images/ca34ba65b87576a7f3b37a23e2b5e1d0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1278/format:webp/1*7ayJ2-TLpH1x60GztS2bCA.png"/></div></figure><p id="58e0" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">检查IPv6连接稍微复杂一点，这取决于您的提供商等。为了简单起见，我使用了<a class="ae kl" href="https://ipv6-test.com/validate.php" rel="noopener ugc nofollow" target="_blank">https://ipv6-test.com/validate.php</a></p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="lj lk di ll bf lm"><div class="gh gi lv"><img src="../Images/6215cd99b220412d1f7fb6787e25ef44.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*MLlNKiVLvWMd2nf95nMHPA.png"/></div></div></figure></div><div class="ab cl lw lx hu ly" role="separator"><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb"/></div><div class="ij ik il im in"><p id="3959" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">[1]: AWS。仅出口互联网网关<em class="lt"/><a class="ae kl" href="https://docs.aws.amazon.com/vpc/latest/userguide/egress-only-internet-gateway.html" rel="noopener ugc nofollow" target="_blank">https://docs . AWS . Amazon . com/VPC/latest/user guide/egress-only-internet-gateway . html</a></p></div></div>    
</body>
</html>