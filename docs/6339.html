<html>
<head>
<title>Kubernetes Storage — Part 1 — NFS complete tutorial</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Kubernetes存储—第1部分— NFS完整教程</h1>
<blockquote>原文：<a href="https://itnext.io/kubernetes-storage-part-1-nfs-complete-tutorial-75e6ac2a1f77?source=collection_archive---------0-----------------------#2021-10-20">https://itnext.io/kubernetes-storage-part-1-nfs-complete-tutorial-75e6ac2a1f77?source=collection_archive---------0-----------------------#2021-10-20</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/296896c9a8d85cbb833ce443b93a066f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*i5Tp6PHEccn70-4NDRe5ww.jpeg"/></div></div></figure><p id="7820" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在这一系列文章中，我打算讨论可用的Kubernetes存储解决方案，并提供完整的手册来将它们部署和连接到Kubernetes。每件产品都包含不同的储物解决方案，可与Kubernetes搭配使用。这一系列教程对每个了解Kubernetes存储架构和概念的人都很有用。请注意，这一系列的教程不是一个关于库伯内特的概念，我也不是在谈论库伯内特的概念。那么，让我们从NFS仓库开始派对吧。</p><h1 id="8355" class="kw kx iq bd ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt bi translated">所需资源:</h1><ul class=""><li id="b5b7" class="lu lv iq ka b kb lw kf lx kj ly kn lz kr ma kv mb mc md me bi translated">运行中的Kubernetes星团。建议1.18+。</li><li id="da31" class="lu lv iq ka b kb mf kf mg kj mh kn mi kr mj kv mb mc md me bi translated">具有一些可用存储的运行节点。</li></ul><p id="a0d1" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我将在基于Ubuntu 的系统上运行这些步骤。我建议你也这样做。</p><p id="1932" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在本演示中，我使用两个节点，配置如下:</p><p id="2a08" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><strong class="ka ir">作为NFS服务器的运行节点:</strong></p><pre class="mk ml mm mn gt mo mp mq mr aw ms bi"><span id="4c70" class="mt kx iq mp b gy mu mv l mw mx">OS: Ubuntu 20.04<br/>FQDN: node004.b9tcluster.local<br/>IP Address: 192.168.12.7</span></pre><p id="ff75" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><strong class="ka ir">单节点Kubernetes集群:</strong></p><pre class="mk ml mm mn gt mo mp mq mr aw ms bi"><span id="6ea5" class="mt kx iq mp b gy mu mv l mw mx">OS: Ubuntu 20.04<br/>Kubernetes: 1.21.5 (k3s distribution)<br/>FQDN: node005.b9tcluster.local<br/>IP Address: 192.168.12.8</span></pre><h1 id="f69f" class="kw kx iq bd ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt bi translated">1-部署和配置NFS服务器:</h1><p id="36cd" class="pw-post-body-paragraph jy jz iq ka b kb lw kd ke kf lx kh ki kj my kl km kn mz kp kq kr na kt ku kv ij bi translated">在您认为是NFS服务器的节点上运行以下命令。请注意，您可以用支持高可用性的集群方式部署NFS服务器。想搜就搜吧。</p><pre class="mk ml mm mn gt mo mp mq mr aw ms bi"><span id="efc3" class="mt kx iq mp b gy mu mv l mw mx">apt update &amp;&amp; apt -y upgrade</span><span id="e419" class="mt kx iq mp b gy nb mv l mw mx">apt install -y nfs-server</span><span id="6e74" class="mt kx iq mp b gy nb mv l mw mx">mkdir /data</span><span id="10b8" class="mt kx iq mp b gy nb mv l mw mx">cat &lt;&lt; EOF &gt;&gt; /etc/exports<br/>/data 192.168.12.8(rw,no_subtree_check,no_root_squash)<br/>EOF</span><span id="4c42" class="mt kx iq mp b gy nb mv l mw mx">systemctl enable --now nfs-server</span><span id="9e34" class="mt kx iq mp b gy nb mv l mw mx">exportfs -ar</span></pre><p id="444b" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">该命令安装NFS服务器并导出可由Kubernetes集群访问的<code class="fe nc nd ne mp b">/data</code>。在多节点Kubernetes集群的情况下，您应该允许所有Kubernetes <strong class="ka ir"> worker </strong>节点。</p><h1 id="5a5f" class="kw kx iq bd ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt bi translated">2-准备Kubernetes工作节点:</h1><p id="f884" class="pw-post-body-paragraph jy jz iq ka b kb lw kd ke kf lx kh ki kj my kl km kn mz kp kq kr na kt ku kv ij bi translated">现在，为了连接到NFS服务器，Kubernetes节点需要一个NFS客户端包来连接到NFS服务器。您应该只在Kubernetes工作节点上运行以下命令。控制平面节点不需要它！只是工人。</p><pre class="mk ml mm mn gt mo mp mq mr aw ms bi"><span id="19c3" class="mt kx iq mp b gy mu mv l mw mx">apt install -y nfs-common</span></pre><p id="fda4" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><strong class="ka ir">重要提示！</strong>每个存储解决方案可能需要客户端软件包来连接到存储服务器。您应该将它们安装在所有Kubernetes worker节点中。对于NFS，需要<strong class="ka ir"> nfs-common </strong>包。</p><h1 id="2040" class="kw kx iq bd ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt bi translated">3-在Kubernetes使用NFS:</h1><h2 id="59f4" class="mt kx iq bd ky nf ng dn lc nh ni dp lg kj nj nk lk kn nl nm lo kr nn no ls np bi translated">方法1-通过Pod清单直接连接到NFS:</h2><p id="5374" class="pw-post-body-paragraph jy jz iq ka b kb lw kd ke kf lx kh ki kj my kl km kn mz kp kq kr na kt ku kv ij bi translated">要使用Pod清单直接连接到NFS卷，请使用Pod中的NFSVolumeSource。这里有一个例子:</p><pre class="mk ml mm mn gt mo mp mq mr aw ms bi"><span id="2432" class="mt kx iq mp b gy mu mv l mw mx">apiVersion: v1<br/>kind: Pod<br/>metadata:<br/>  name: test<br/>  labels:<br/>    app.kubernetes.io/name: alpine<br/>    app.kubernetes.io/part-of: kubernetes-complete-reference<br/>    app.kubernetes.io/created-by: ssbostan<br/>spec:<br/>  containers:<br/>    - name: alpine<br/>      image: alpine:latest<br/>      command:<br/>        - touch<br/>        - /data/test<br/>      volumeMounts:<br/>        - name: nfs-volume<br/>          mountPath: /data<br/>  volumes:<br/>    - name: nfs-volume<br/>      nfs:<br/>        server: node004.b9tcluster.local<br/>        path: /data<br/>        readOnly: no</span></pre><h2 id="dc8f" class="mt kx iq bd ky nf ng dn lc nh ni dp lg kj nj nk lk kn nl nm lo kr nn no ls np bi translated">方法2 —使用PersistentVolume资源进行连接:</h2><p id="1c7d" class="pw-post-body-paragraph jy jz iq ka b kb lw kd ke kf lx kh ki kj my kl km kn mz kp kq kr na kt ku kv ij bi translated">要为NFS卷创建PersistentVolume对象，请使用以下清单。您应该注意，存储大小没有任何影响。</p><pre class="mk ml mm mn gt mo mp mq mr aw ms bi"><span id="1f17" class="mt kx iq mp b gy mu mv l mw mx">apiVersion: v1<br/>kind: PersistentVolume<br/>metadata:<br/>  name: nfs-volume<br/>  labels:<br/>    storage.k8s.io/name: nfs<br/>    storage.k8s.io/part-of: kubernetes-complete-reference<br/>    storage.k8s.io/created-by: ssbostan<br/>spec:<br/>  accessModes:<br/>    - ReadWriteOnce<br/>    - ReadOnlyMany<br/>    - ReadWriteMany<br/>  capacity:<br/>    storage: 10Gi<br/>  storageClassName: ""<br/>  persistentVolumeReclaimPolicy: Recycle<br/>  volumeMode: Filesystem<br/>  nfs:<br/>    server: node004.b9tcluster.local<br/>    path: /data<br/>    readOnly: no</span></pre><h2 id="67fb" class="mt kx iq bd ky nf ng dn lc nh ni dp lg kj nj nk lk kn nl nm lo kr nn no ls np bi translated">方法3 —使用存储类进行动态资源调配:</h2><p id="18bb" class="pw-post-body-paragraph jy jz iq ka b kb lw kd ke kf lx kh ki kj my kl km kn mz kp kq kr na kt ku kv ij bi translated">要使用StorageClass动态配置PersistentVolume，您需要安装NFS配置程序。我使用<strong class="ka ir">NFS-subdir-external-provisioner</strong>来实现这一点。以下命令通过使用honey Helm包管理器安装我们需要的所有东西。</p><pre class="mk ml mm mn gt mo mp mq mr aw ms bi"><span id="69fa" class="mt kx iq mp b gy mu mv l mw mx">helm repo add nfs-subdir-external-provisioner https://kubernetes-sigs.github.io/nfs-subdir-external-provisioner</span><span id="f641" class="mt kx iq mp b gy nb mv l mw mx">helm install nfs-subdir-external-provisioner nfs-subdir-external-provisioner/nfs-subdir-external-provisioner \<br/>  --create-namespace \<br/>  --namespace nfs-provisioner \<br/>  --set nfs.server=node004.b9tcluster.local \<br/>  --set nfs.path=/data</span></pre><figure class="mk ml mm mn gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nq"><img src="../Images/34a066d8211e2ef90bb24b9055994f17.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*lmzdyjISeeZIekaRc5hisQ.png"/></div></div><figcaption class="nr ns gj gh gi nt nu bd b be z dk translated">Kubernetes和NFS存储类。</figcaption></figure><p id="4118" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">若要创建PersistentVolumeClaim，请使用以下清单:</p><pre class="mk ml mm mn gt mo mp mq mr aw ms bi"><span id="d804" class="mt kx iq mp b gy mu mv l mw mx">apiVersion: v1<br/>kind: PersistentVolumeClaim<br/>metadata:<br/>  name: nfs-test<br/>  labels:<br/>    storage.k8s.io/name: nfs<br/>    storage.k8s.io/part-of: kubernetes-complete-reference<br/>    storage.k8s.io/created-by: ssbostan<br/>spec:<br/>  accessModes:<br/>    - ReadWriteMany<br/>  storageClassName: nfs-client<br/>  resources:<br/>    requests:<br/>      storage: 1Gi</span></pre><figure class="mk ml mm mn gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nv"><img src="../Images/f3da90f8c582919a67b584b97c426d3c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*mwSiM3A-OGMr23-bOcmKtg.png"/></div></div><figcaption class="nr ns gj gh gi nt nu bd b be z dk translated">Kubernetes NFS卷动态预配置。</figcaption></figure><h1 id="0f1f" class="kw kx iq bd ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt bi translated">4-库伯内特和NFS储存规范:</h1><p id="4a09" class="pw-post-body-paragraph jy jz iq ka b kb lw kd ke kf lx kh ki kj my kl km kn mz kp kq kr na kt ku kv ij bi translated">NFS在库伯内特世界有以下规格。在使用NFS储物件之前，您需要考虑这些因素。</p><ul class=""><li id="78f3" class="lu lv iq ka b kb kc kf kg kj nw kn nx kr ny kv mb mc md me bi translated"><strong class="ka ir">读写一次</strong>、<strong class="ka ir">只读一次</strong>、<strong class="ka ir">读写多次</strong>访问模式。</li><li id="bbaa" class="lu lv iq ka b kb mf kf mg kj mh kn mi kr mj kv mb mc md me bi translated">存储大小没有任何影响！</li><li id="5e0c" class="lu lv iq ka b kb mf kf mg kj mh kn mi kr mj kv mb mc md me bi translated">在动态预配置的情况下，卷被分离到不同的目录中。但是没有任何访问控制！</li></ul><h1 id="a641" class="kw kx iq bd ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt bi translated">最后一句话:</h1><p id="11b8" class="pw-post-body-paragraph jy jz iq ka b kb lw kd ke kf lx kh ki kj my kl km kn mz kp kq kr na kt ku kv ij bi translated">要了解关于Kubernetes的更多信息，请访问这个GitHub资源库。这个完整的Kubernetes参考将很快丰富。欢迎所有的贡献。如果您发现这篇文章有用，请查看项目GitHub资源库。祝你好运。</p><p id="7b76" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">关注我的LinkedIn<a class="ae nz" href="https://www.linkedin.com/in/ssbostan" rel="noopener ugc nofollow" target="_blank">https://www.linkedin.com/in/ssbostan</a></p><div class="oa ob gp gr oc od"><a href="https://github.com/ssbostan/kubernetes-complete-reference" rel="noopener  ugc nofollow" target="_blank"><div class="oe ab fo"><div class="of ab og cl cj oh"><h2 class="bd ir gy z fp oi fr fs oj fu fw ip bi translated">GitHub-ssbo stan/Kubernetes-complete-reference:Kubernetes reference，awesome，cheatsheet…</h2><div class="ok l"><h3 class="bd b gy z fp oi fr fs oj fu fw dk translated">Kubernetes容器编排引擎的最完整参考。由ssbostan和贡献者创建…</h3></div><div class="ol l"><p class="bd b dl z fp oi fr fs oj fu fw dk translated">github.com</p></div></div><div class="om l"><div class="on l oo op oq om or jw od"/></div></div></a></div></div></div>    
</body>
</html>