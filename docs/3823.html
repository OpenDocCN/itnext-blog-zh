<html>
<head>
<title>Performance Consultancy — Slow batch job</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">性能咨询—慢速批处理作业</h1>
<blockquote>原文：<a href="https://itnext.io/performance-consultancy-slow-batch-job-ec530baed843?source=collection_archive---------6-----------------------#2020-03-03">https://itnext.io/performance-consultancy-slow-batch-job-ec530baed843?source=collection_archive---------6-----------------------#2020-03-03</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><figure class="gl gn jr js jt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi jq"><img src="../Images/e3d356247e88b543d70af468bf763030.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*9l0PvfX_CXHDpjpLBg2oiw.jpeg"/></div></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated">塞巴斯蒂安·赫尔曼在<a class="ae kf" href="https://unsplash.com/?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</figcaption></figure><p id="ac80" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">在我职业生涯的早期，我曾在2013年担任绩效顾问。这是我在一个关键运营团队的最后一个咨询案例的故事。该客户是服装零售行业的，他们必须在月底运行一个批处理过程，但该过程阻止其他用户使用后台应用程序长达4小时，想象一下有数百人在那里无法工作？那是多少钱？很多。</p><p id="2356" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">因此，我们的目标是停止阻止用户，并潜在地提高作业的性能。该作业是作为Visual Fox Pro针对SQL Server运行的。</p><h2 id="a659" class="le lf it bd lg lh li dn lj lk ll dp lm kr ln lo lp kv lq lr ls kz lt lu lv lw bi translated">最初的简报</h2><p id="8dad" class="pw-post-body-paragraph kg kh it ki b kj lx kl km kn ly kp kq kr lz kt ku kv ma kx ky kz mb lb lc ld im bi translated">我仍然记得和几个人坐在一个会议室里，我的老板，我公司的CEO和来自客户的5个以上的资源。DBA向我们展示了一个SQL profiler，其中包含该作业的所有查询。</p><p id="3a1e" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">DBA向我们展示了批处理期间应用程序的SQL分析，我注意到了一个模式，在20，000个查询中，70–80%的查询是相同的select。周围的东西:</p><figure class="mc md me mf gt ju"><div class="bz fp l di"><div class="mg mh l"/></div></figure><p id="efa7" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">如果您在这个批处理中运行相同的查询14，000次，这个查询最好进行优化。导致问题的另一个迹象是，该查询消耗了SQL中相当多的CPU，并且每次执行时间都超过100毫秒。</p><p id="3b93" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">您能看出这个查询的问题吗？</p><p id="7a03" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">SQL Server是一个非常优化的数据库，它有索引的概念，所以数据更容易找到。通常情况下，您的目标是进行索引查找，在这种情况下，SQL Server只需找到行，而不必扫描索引的所有行，但是当您对where子句中的列应用函数时，会发生什么情况呢？</p><p id="7aae" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">SQL现在必须对每一行应用函数，并评估这些行是否符合标准。这里的区别是索引寻道和索引扫描。一个优化不佳的查询，运行14000次，是我们首先要解决的最明显的事情。</p><p id="892b" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">我在会议中与数据库管理员进行了这样的对话:</p><p id="9d0f" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">我:“你知道这个ISNULL在这个查询中会很重，对吗？”</p><p id="f525" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">DBA:“是的，我知道，但是应用程序允许这一列为空。”</p><p id="002d" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">我:“我们可以对应用程序进行验证吗？”</p><p id="d01d" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">DBA:“是的，但是数据库将包含来自先前插入行的空值”</p><p id="2e21" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">我:“是的，但是我们可以将旧的空值更新为零”</p><p id="0759" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">惊讶的DBA:“我没想过这个选项”。</p><figure class="mc md me mf gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi mi"><img src="../Images/52da57155db6add0df1c5144e564eb64.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*mst0Gv8gV0cwRqNO.png"/></div></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated">惊讶的皮卡丘迷因</figcaption></figure><p id="25d3" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">他知道这个问题令人不快，但是他还没有找到一个简单的解决方案。这是一个很好的专业，可能对我来说更容易，因为我从一个新的角度看问题，然后我的视野没有被以前的尝试或时间压力模糊。</p><p id="168b" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><strong class="ki iu">第一次修复</strong></p><p id="d800" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">通过从查询中删除ISNULL并对软件进行验证，我们将执行时间从4小时减少到了15分钟。这在处理性能问题时很常见，因为它们通常是瓶颈，消除瓶颈可以获得巨大的改进。</p><p id="bec9" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">在处理性能改进时这是通常的情况，我喜欢用帕累托原则来思考:</p><blockquote class="mj"><p id="9051" class="mk ml it bd mm mn mo mp mq mr ms ld dk translated">用20%的努力你得到了80%的结果，然后你必须用剩下的80%的努力去得到剩下的20%的结果。</p></blockquote><p id="a1b8" class="pw-post-body-paragraph kg kh it ki b kj mt kl km kn mu kp kq kr mv kt ku kv mw kx ky kz mx lb lc ld im bi translated">改进之后，不用说客户已经很高兴了，但我们仍然知道我们可以做得更好，因为我们有更多的建议，需要更多的工作。比如清理表格、更改应用程序以批处理这些查询等。这正是帕累托原则，剩下的20%改进是80%的工作。</p><p id="ab24" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">开发人员在Visual Fox Pro中进行了更改，以批量处理这些查询，对应用程序进行了一些改进，对数据库进行了调整，我们将时间缩短到了5分钟。</p><p id="2155" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">然后，我向雇佣我们的公司的副总裁展示了报告和幻灯片，以及我们务实的改进过程，以及我们如何从4小时的批量执行缩短到5分钟。我是我们公司唯一一个实际参与这个项目的顾问，19岁，只有3年的经验。当客户副总裁说我们做得非常出色时，这是我职业生涯中最美好的时刻之一。</p><p id="ac7c" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">这个咨询案例是咨询公司为这个客户做的第一份工作，它为更多的客户打开了大门，这仍然让我脸上挂着微笑，7年后，它仍然是咨询公司最大的客户之一。</p></div><div class="ab cl my mz hx na" role="separator"><span class="nb bw bk nc nd ne"/><span class="nb bw bk nc nd ne"/><span class="nb bw bk nc nd"/></div><div class="im in io ip iq"><p id="7ee2" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">作为最后的建议:</p><blockquote class="mj"><p id="75cc" class="mk ml it bd mm mn mo mp mq mr ms ld dk translated">当你被一个问题困扰了几个小时或几天时，把你的思维移开，去喝杯咖啡或在公园里散散步，然后带着一个新鲜的思维回来。</p></blockquote><p id="389e" class="pw-post-body-paragraph kg kh it ki b kj mt kl km kn mu kp kq kr mv kt ku kv mw kx ky kz mx lb lc ld im bi translated">我已经记不清有多少次我在伦敦骑车时解决了技术问题，然后想，我以前怎么没想到这一点？</p><p id="6012" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">快乐的性能优化。</p></div></div>    
</body>
</html>