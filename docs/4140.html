<html>
<head>
<title>How to set up SFTP server on Ubuntu(AWS-EC2)</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何在Ubuntu(AWS-EC2)上设置SFTP服务器</h1>
<blockquote>原文：<a href="https://itnext.io/how-to-set-up-sftp-server-on-ubuntu-aws-ec2-970c4353f894?source=collection_archive---------5-----------------------#2020-05-04">https://itnext.io/how-to-set-up-sftp-server-on-ubuntu-aws-ec2-970c4353f894?source=collection_archive---------5-----------------------#2020-05-04</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="429e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我最近请求为一个客户设置SFTP，以便他们可以管理环境内外的文件传输。在做好一切准备的同时，似乎许多向导在某种形式上遗漏了关键的一步。所以我决定自己写一份指南，详细介绍我的整个过程。</p><p id="762b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">■关于SFTP </strong>的介绍<br/> SFTP代表SSH文件传输协议。顾名思义，这是一种使用加密SSH连接在机器之间传输文件的安全方式。尽管名为FTP(文件传输协议),但它是一种完全不同的协议，尽管现代FTP客户端广泛支持它。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div class="gh gi kl"><img src="../Images/729a84df0832083bc801b559f2fbd8e2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1302/0*gXZ_Dn_QAOOkpy7k"/></div></figure><p id="5f77" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在某些情况下，您可能希望只允许某些用户传输文件，而不允许SSH访问。在本教程中，我们将设置SSH守护进程来限制SFTP对一个目录的访问，每个用户都不允许SSH访问。</p><p id="0a5f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">对于FTP设置，请通过此链接。【https://itnext.io/create-ftp-on-aws-ec2-f6e57d4d7f25】T5<br/>T6】</p><p id="1d03" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">所以，让我们开始SFTP设置。<br/> <strong class="jp ir">步骤1:安装OpenSSH-server &amp; SSH </strong> <br/>如果您还没有这样做，在服务器中安装OpenSSH，您可以使用以下命令:</p><pre class="km kn ko kp gt ku kv kw kx aw ky bi"><span id="6111" class="kz la iq kv b gy lb lc l ld le">$ sudo apt install openssh-server</span></pre><p id="e131" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">您还需要在将要访问SFTP服务器的系统上安装SSH。</p><pre class="km kn ko kp gt ku kv kw kx aw ky bi"><span id="0bca" class="kz la iq kv b gy lb lc l ld le">$ sudo apt install ssh</span></pre><p id="b286" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">步骤2:创建SFTP用户帐户</strong> <br/>首先，我们需要创建一个新用户，该用户只被授予对服务器的文件传输访问权限。</p><pre class="km kn ko kp gt ku kv kw kx aw ky bi"><span id="5d76" class="kz la iq kv b gy lb lc l ld le">$ sudo adduser sftp_user</span></pre><p id="a7a2" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">系统会提示您为该帐户创建一个密码，然后输入一些用户信息。用户信息是可选的，因此您可以按ENTER键将这些字段留空。</p><pre class="km kn ko kp gt ku kv kw kx aw ky bi"><span id="7687" class="kz la iq kv b gy lb lc l ld le">Enter new UNIX password: <br/>Retype new UNIX password: <br/>.....<br/>passwd: password updated successfully</span></pre><p id="a617" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">您现在已经创建了一个新用户，我们将被授予访问受限目录的权限。<br/>下一步，我们将创建文件传输目录并设置必要的权限。</p><p id="4994" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">步骤3:为文件传输创建目录</strong> <br/>为了限制SFTP对一个目录的访问，首先，我们必须确保该目录符合SSH服务器的权限要求，这是非常特殊的。</p><p id="c75a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">具体来说，目录本身以及文件系统树中它上面的所有目录必须归root所有，其他任何人都不可写。因此，不可能简单地限制对用户主目录的访问，因为主目录归用户所有，而不是归根目录所有。</p><p id="4144" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这里，我们将创建并使用<strong class="jp ir"> /var/sftp/myfolder/data/ </strong>作为目标上传目录。<strong class="jp ir"> /var/sftp/myfolder </strong>将归root所有，其他用户不可写。<br/>子目录<strong class="jp ir"> /var/sftp/myfolder/data/ </strong>将归<strong class="jp ir"> sftp_user </strong>(我们之前创建的)所有，以便用户能够向其中上传文件。</p><p id="7acb" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">首先，创建目录。</p><pre class="km kn ko kp gt ku kv kw kx aw ky bi"><span id="b7e3" class="kz la iq kv b gy lb lc l ld le">$ sudo mkdir -p /var/sftp/myfolder/data/</span></pre><p id="f842" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">将<strong class="jp ir"> /var/sftp/myfolder </strong>的所有者设置为<strong class="jp ir"> root </strong>。</p><pre class="km kn ko kp gt ku kv kw kx aw ky bi"><span id="1c9b" class="kz la iq kv b gy lb lc l ld le">$ sudo chown root:root /var/sftp/myfolder</span></pre><p id="b25e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">授予root用户对同一目录的写权限，仅授予其他用户读和执行权限。</p><pre class="km kn ko kp gt ku kv kw kx aw ky bi"><span id="b423" class="kz la iq kv b gy lb lc l ld le">$ sudo chmod 755 /var/sftp/myfolder</span></pre><p id="86cc" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">将上传目录的所有权更改为sftp_user。</p><pre class="km kn ko kp gt ku kv kw kx aw ky bi"><span id="b535" class="kz la iq kv b gy lb lc l ld le">$ sudo chown sftp_user:sftp_user /var/sftp/myfolder/data/</span></pre><p id="efcc" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这里我们已经完成了目录限制。<br/>因此，我们的sftp_user将只使用下面路径中的<strong class="jp ir"> /data/ </strong>。sftp_user从不更改目录。<br/><strong class="jp ir">/var/sftp/my folder/data/</strong></p><p id="f5db" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">步骤4:sshd_config设置</strong> <br/>在此步骤中，我们将修改SSH服务器配置，以禁止sftp_user的终端访问，但允许文件传输访问。</p><p id="7363" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">使用下面的命令打开SSH服务器配置文件。</p><pre class="km kn ko kp gt ku kv kw kx aw ky bi"><span id="8479" class="kz la iq kv b gy lb lc l ld le">$ sudo nano /etc/ssh/sshd_config</span></pre><p id="fcf1" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">或者可以通过↓来做。</p><pre class="km kn ko kp gt ku kv kw kx aw ky bi"><span id="1d6b" class="kz la iq kv b gy lb lc l ld le">$ sudo vi /etc/ssh/sshd_config</span></pre><p id="957f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">滚动到文件的最底部，并追加以下配置片段:</p><p id="5810" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir"> /etc/ssh/sshd_config </strong></p><pre class="km kn ko kp gt ku kv kw kx aw ky bi"><span id="57b6" class="kz la iq kv b gy lb lc l ld le">Port &lt;your_port_number&gt;<br/>Match User sftp_user<br/>ForceCommand internal-sftp<br/>PasswordAuthentication yes<br/>ChrootDirectory /var/sftp/myfolder<br/>PermitTunnel no<br/>AllowAgentForwarding no<br/>AllowTcpForwarding no<br/>X11Forwarding no</span></pre><p id="838d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">然后保存并关闭文件。[按:wq + enter]</p><p id="3a8a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">下面是这些指令的作用:<br/><strong class="jp ir">●匹配用户</strong>告诉SSH服务器只对指定的用户应用以下命令。这里，我们指定sftp_user。<br/><strong class="jp ir">●force command internal-sftp</strong>强制SSH服务器在登录时运行sftp服务器，不允许shell访问。<br/><strong class="jp ir">●password authentic ation</strong>yes允许对该用户进行密码认证。<br/><strong class="jp ir">●ch root directory/var/sftp/myfolder</strong>确保不允许用户访问/var/sftp/my folder目录之外的任何内容。<br/><strong class="jp ir">●AllowAgentForwarding no</strong>、AllowTcpForwarding no、X11Forwarding no对该用户禁用端口转发、隧道和X11转发。</p><p id="2f1a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在<strong class="jp ir">匹配用户【用户名】</strong>中，您也可以通过使用以下命令来使用该组。<br/> <strong class="jp ir">匹配组【sftp_group】</strong><br/>注意:你需要创建一个名为，sftp _ Group的新组。</p><p id="6ed1" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">步骤5:重启服务</strong> <br/>要应用配置更改，重启服务。</p><pre class="km kn ko kp gt ku kv kw kx aw ky bi"><span id="516e" class="kz la iq kv b gy lb lc l ld le">$ sudo systemctl restart sshd</span></pre><p id="a527" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">或者</p><pre class="km kn ko kp gt ku kv kw kx aw ky bi"><span id="fc2a" class="kz la iq kv b gy lb lc l ld le">$ sudo /etc/init.d/ssh restart</span></pre><p id="5c44" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在，您已经将SSH服务器配置为只允许sftp_user访问文件传输。</p><p id="308a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">第六步:在AWS-EC2安全组</strong> <br/>中打开你的sftp端口如果你使用的是AWS-EC2实例，那么你需要在这里打开端口。<br/> <strong class="jp ir">登录您的AWS账户。</strong> <br/> ↓ <br/> <strong class="jp ir">转到服务然后点击EC2菜单- &gt;运行实例。</strong> <br/> ↓ <br/> <strong class="jp ir">转到你的实例。</strong> <br/> ↓ <br/> <strong class="jp ir">打开安全组。</strong> <br/> ↓ <br/> <strong class="jp ir">在入库规则中，编辑入库规则</strong> <br/> ↓ <br/> <strong class="jp ir">请做如下设置</strong> <br/> <strong class="jp ir"> 1。类型</strong> =自定义TCP <br/> <strong class="jp ir"> 2。协议</strong> = TCP <br/> <strong class="jp ir"> 3。端口范围</strong> = your_port(与sshd_config文件中设置的相同)<br/> <strong class="jp ir"> 4。如果你不想在任何地方设置，你需要在这里将IP列入白名单。<br/> <strong class="jp ir"> 5。描述—可选的</strong> =你可以在这里提到一些有用的信息。</strong></p><p id="fb52" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果你想看视频，请访问这个链接。<br/>https://itnext.io/create-ftp-on-aws-ec2-f6e57d4d7f25<a class="ae kt" rel="noopener ugc nofollow" target="_blank" href="/create-ftp-on-aws-ec2-f6e57d4d7f25"/></p><p id="902b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">最后一步是测试配置，以确保它按预期工作。</p><p id="6544" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">第七步:验证配置</strong> <br/>您可以在您的终端和第三方软件(如WinSCP)中进行验证。</p><p id="d28b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">结论</strong>虽然本教程只使用了一个目录和一个用户，但是您也可以将这个示例扩展到多个用户和多个目录。SSH服务器允许更复杂的配置方案，包括同时限制组或多个用户的访问，甚至限制对某些IP地址的访问。</p><p id="a41e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我希望这篇文章能帮助你在Ubuntu上设置SFTP服务器。如果你遇到任何错误，请与我分享。</p><p id="4108" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果本指南对您和您的团队有所帮助，请与他人分享！</p><p id="1bbb" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">感谢&amp;最诚挚的问候<br/> Alok Rawat </strong></p></div><div class="ab cl lf lg hu lh" role="separator"><span class="li bw bk lj lk ll"/><span class="li bw bk lj lk ll"/><span class="li bw bk lj lk"/></div><div class="ij ik il im in"><p id="13d8" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><em class="lm">最初发表于2020年5月4日https://qiita.com</em><a class="ae kt" href="https://qiita.com/alokrawat050/items/709d3c777407ab658aa9" rel="noopener ugc nofollow" target="_blank"><em class="lm"/></a><em class="lm">。</em></p></div></div>    
</body>
</html>