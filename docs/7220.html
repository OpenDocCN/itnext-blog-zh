<html>
<head>
<title>TLS Migration — A better way</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">TLS迁移—更好的方法</h1>
<blockquote>原文：<a href="https://itnext.io/tls-migration-a-better-way-10796a1b3a24?source=collection_archive---------3-----------------------#2022-07-19">https://itnext.io/tls-migration-a-better-way-10796a1b3a24?source=collection_archive---------3-----------------------#2022-07-19</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/b7e74f2e823f311a8353dd844c05394a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*lj-_55KOWNXJg7uu"/></div></div></figure><p id="e445" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">HTTPS是必不可少的，因为它保护我们在互联网上的数据隐私。W3的2022年报告显示，近80%的网站使用HTTPS作为默认网络协议，比上一年增长了6%。</p><p id="3435" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">开始使用HTTP/TLS相当简单。获得一个CA签名的证书，在你的web服务器和反向代理负载平衡器上配置它，你就可以开始了。但是，您如何确保您的配置符合当前的行业标准呢？</p><p id="e86e" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">网络安全是一场军备竞赛。随着硬件和软件的发展，开发利用它们的工具和技术也在发展。这种激烈的竞争在很大程度上推动了我们今天在行业中看到的创新。</p><p id="b4ad" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">这与TLS有什么关系？自从Netscape在90年代开始使用SSLv1以来，已经有了许多版本，SSLv2、SSLv3、TLSv1.1、TLSv1.2，当前版本是tlsv 1.3。tlsv 1.1在2021年被弃用，大约每5年发布一次新版本。鉴于漏洞被发现的速度，这些发布周期也需要保持同步。</p><p id="68e5" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">对于组织来说，这带来了许多有趣的挑战，因为你只能控制你支持的TLS版本。此外，如果你的网站或API是公开的，那么你很可能无法控制连接的客户端，或者他们可以使用哪些TLS版本。</p><p id="1e55" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">那么，您如何知道何时取消对较旧的、不太安全的TLS版本的支持呢？在支持了几次迁移后，我了解到:</p><ul class=""><li id="3681" class="kw kx iq ka b kb kc kf kg kj ky kn kz kr la kv lb lc ld le bi translated">客户通常使用不再接收操作系统更新的设备，因此无法获得加密库和软件更新。这限制了他们能够使用的TLS版本。</li><li id="7185" class="kw kx iq ka b kb lf kf lg kj lh kn li kr lj kv lb lc ld le bi translated">API到处都在使用。它们为从物联网设备到销售点系统，甚至洗车场的一切事物提供动力(稍后将详细介绍)。这些设备经常被安装、遗忘，或者没有更新，或者不能接收更新。</li><li id="13ef" class="kw kx iq ka b kb lf kf lg kj lh kn li kr lj kv lb lc ld le bi translated">企业系统很复杂，很难了解哪些组件支持哪些TLS版本，以及HTTPS请求来自哪里。</li><li id="0064" class="kw kx iq ka b kb lf kf lg kj lh kn li kr lj kv lb lc ld le bi translated">企业需要花费大量的时间来调查和改变他们的系统，因此需要大量的预先通知。</li><li id="7bea" class="kw kx iq ka b kb lf kf lg kj lh kn li kr lj kv lb lc ld le bi translated">B2C和B2B服务通知邮件经常被忽略。即使it部门明确表示他们需要采取行动，否则会面临服务中断的风险。</li><li id="53b6" class="kw kx iq ka b kb lf kf lg kj lh kn li kr lj kv lb lc ld le bi translated">对TLS协议支持做出不知情或不明智的更改通常会导致客户投诉、品牌受损和不可避免的倒退。</li></ul><p id="0c4f" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">对于这种性质的变化，我很快对充分的计划产生了欣赏。回到2016年，在一次TLS迁移中，一个我称之为Bob的人提出了一张支持票。Bob想知道为什么他的洗车店的顾客不能使用他们的EFTPOS和信用卡付款。看着这张罚单，很明显他明显感到沮丧(说得轻松些)，这是可以理解的，因为这影响了他的业务收入。经过调查，我们确定他的洗车店运行的是Windows XP终端，可以进行API调用。请记住，Windows XP已于2014年停产，但Bob对此一无所知，因为它们由另一家第三方维护。同样，在这种情况下，我们既没有Bob的详细信息，也没有他的第三方的详细信息，所以他没有收到6个月前发生这种变化的通知。由此，为了最大限度地降低风险，企业认识到，我们需要采取更明智、更主动的方法，就此类关键服务变更与客户接洽。</p><h1 id="748d" class="lk ll iq bd lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh bi translated">挑战</h1><p id="49d5" class="pw-post-body-paragraph jy jz iq ka b kb mi kd ke kf mj kh ki kj mk kl km kn ml kp kq kr mm kt ku kv ij bi translated">大多数人都熟悉Web服务器、负载平衡器和反向代理的概念。这些基本上是终止、处理或路由HTTP流量。此外，他们还可以执行SSL卸载和其他web加速任务。</p><p id="3557" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">大多数web应用程序和API需要伸缩能力，因此需要负载平衡器或反向代理。不利的一面是，他们将终止HTTPS连接，并建立一个新的连接到您的web服务器。因此，客户端TLS版本将仅记录在负载平衡器访问日志中，这意味着您只能确定特定版本的流量所占的百分比，以及您的终端设备可能提供的任何其他元数据，如URL和IP地址。</p><h1 id="0d28" class="lk ll iq bd lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh bi translated">我已经记录了客户端TLS版本，这还不够吗？</h1><p id="bb95" class="pw-post-body-paragraph jy jz iq ka b kb mi kd ke kf mj kh ki kj mk kl km kn ml kp kq kr mm kt ku kv ij bi translated">如果您提供驱动关键业务流程的应用程序和API，并且可以影响客户的收入流，那么中断将会导致许多令人头痛的问题。在进行迁移之前，您需要考虑:</p><ul class=""><li id="bba9" class="kw kx iq ka b kb kc kf kg kj ky kn kz kr la kv lb lc ld le bi translated">我的客户中有多少比例会因为关闭特定版本而受到影响？</li><li id="0556" class="kw kx iq ka b kb lf kf lg kj lh kn li kr lj kv lb lc ld le bi translated">在这些客户中，有哪些是“大客户”？</li><li id="6988" class="kw kx iq ka b kb lf kf lg kj lh kn li kr lj kv lb lc ld le bi translated">我的客户对TLS迁移服务通知的响应速度有多快？</li><li id="5836" class="kw kx iq ka b kb lf kf lg kj lh kn li kr lj kv lb lc ld le bi translated">有什么交通是我不需要担心的吗？例如，机器人，或来自我的企业不在其中运营的外国的流量。</li></ul><p id="70d4" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">要回答这些问题，您需要能够将用户链接到特定的TLS版本，并地理定位他们的原始客户端IP地址；大多数云提供商的负载平衡器没有这些必需的日志功能。</p><h1 id="5a70" class="lk ll iq bd lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh bi translated">扩展反向代理日志记录</h1><p id="e2f3" class="pw-post-body-paragraph jy jz iq ka b kb mi kd ke kf mj kh ki kj mk kl km kn ml kp kq kr mm kt ku kv ij bi translated">我对这个问题的解决方案相当简单。它使用:</p><ul class=""><li id="aa15" class="kw kx iq ka b kb kc kf kg kj ky kn kz kr la kv lb lc ld le bi translated">您现有的OCI租赁、VCN、子网和应用服务器。</li><li id="8c45" class="kw kx iq ka b kb lf kf lg kj lh kn li kr lj kv lb lc ld le bi translated">运行<a class="ae mn" href="https://openresty.org/" rel="noopener ugc nofollow" target="_blank"> OpenResty </a>作为HTTPS负载平衡器/反向代理的Oracle Linux 8虚拟机。</li><li id="25c1" class="kw kx iq ka b kb lf kf lg kj lh kn li kr lj kv lb lc ld le bi translated">Lua脚本扩展了<a class="ae mn" href="https://openresty.org/" rel="noopener ugc nofollow" target="_blank"> OpenResty </a>的日志功能。</li><li id="f98e" class="kw kx iq ka b kb lf kf lg kj lh kn li kr lj kv lb lc ld le bi translated"><a class="ae mn" href="https://docs.oracle.com/en-us/iaas/Content/Logging/Concepts/agent_management.htm" rel="noopener ugc nofollow" target="_blank"> Oracle的统一监控代理</a>将我定制的JSON日志收集到<a class="ae mn" href="https://docs.oracle.com/en-us/iaas/Content/Logging/Concepts/loggingoverview.htm" rel="noopener ugc nofollow" target="_blank"> OCI日志</a>中。</li><li id="caff" class="kw kx iq ka b kb lf kf lg kj lh kn li kr lj kv lb lc ld le bi translated">一个<a class="ae mn" href="https://docs.oracle.com/en-us/iaas/Content/service-connector-hub/overview.htm" rel="noopener ugc nofollow" target="_blank">服务连接器</a>将我的定制日志推送到<a class="ae mn" href="https://docs.oracle.com/en-us/iaas/Content/Object/Concepts/objectstorageoverview.htm" rel="noopener ugc nofollow" target="_blank">对象存储</a>。</li><li id="9803" class="kw kx iq ka b kb lf kf lg kj lh kn li kr lj kv lb lc ld le bi translated">日志收集规则，将我的日志接收到日志分析中。</li><li id="6058" class="kw kx iq ka b kb lf kf lg kj lh kn li kr lj kv lb lc ld le bi translated"><a class="ae mn" href="https://docs.oracle.com/en-us/iaas/logging-analytics/doc/logging-analytics1.html" rel="noopener ugc nofollow" target="_blank">日志分析</a>中的仪表盘和日志浏览器，用于可视化数据。</li></ul><figure class="mp mq mr ms gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mo"><img src="../Images/232769ae8e161ca7162a323000e4996d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*xMlm6HosyhkHe8Tn"/></div></div></figure><p id="37ec" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">这种方法的伟大之处在于，它只需要对现有架构进行最小的改动，我可以利用OCI超酷的本地服务来完成日志收集和分析等繁重的工作。</p><h1 id="368f" class="lk ll iq bd lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh bi translated">设置和配置</h1><p id="313c" class="pw-post-body-paragraph jy jz iq ka b kb mi kd ke kf mj kh ki kj mk kl km kn ml kp kq kr mm kt ku kv ij bi translated">我将向您展示如何配置OpenResty和其他必需的OCI服务。首先，我们需要创建我们的VCN、子网和互联网网关:</p><figure class="mp mq mr ms gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mt"><img src="../Images/384fd5e8782cfe198e50968aa26e9fb8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*Wp12DDhIW_65hUb-"/></div></div></figure><p id="ab4f" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">现在，我们需要向安全列表添加规则，以允许TCP 443 (HTTPS)流量进入我们的公共子网:</p><figure class="mp mq mr ms gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mu"><img src="../Images/6aea0fdbab8818f16c7c7cf615dd6b52.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*AtYdhXkhqYRvXO_f"/></div></div></figure><p id="445f" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我使用无状态规则，因为这样更快，所以我添加了第二个规则来允许双向流。请注意，第二条规则的源CIDR是公共子网的CIDR。您的规则应该是这样的:</p><figure class="mp mq mr ms gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mv"><img src="../Images/a354028b033408b4ae4dee827fab7760.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*UgYn7uikuSgjVtIH"/></div></div></figure><p id="35a1" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我还应该指出，默认情况下，SSH被允许进入您的公共子网。对于生产环境，我建议删除这条规则，使用OCI的堡垒服务。</p><p id="ce9a" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">现在我要创建一个Oracle Linux 8虚拟机来运行OpenResty。选择Oracle Linux 8作为映像，并确保选择具有足够CPU、内存和网络资源的形状来处理传入的网络流量:</p><figure class="mp mq mr ms gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mw"><img src="../Images/7ce89303049324fa33636bba202ee612.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*nUXHtNgZQQkKVRxV"/></div></div></figure><p id="b836" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">选择VCN的公共子网，确保选择了“分配公共IPv4地址”。您还需要上传一个现有的SSH公钥，或者下载一个随机生成的密钥。我的建议是使用随机生成的密钥，并且不要在不同环境之间重复使用密钥:</p><figure class="mp mq mr ms gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mx"><img src="../Images/0f483cabb9a4258aa172f80540a4612e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*B0qlA5-cpKZ1rocX"/></div></div></figure><p id="ca67" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">单击“创建”以调配计算实例。</p><p id="ae6a" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">如果您正在尝试这个演示，并且没有web服务器来转发流量，您可以按照这些说明创建另一个运行Nginx的Oracle Linux 8虚拟机。注意，您只需要按照“安装和启用Nginx”一节中的说明进行操作。</p><p id="5394" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">现在我们想创建一个OCI负载平衡器，我们将使用它来代理OpenResty服务器和web服务器之间的流量。再次确保选择支持预期网络流量的形状:</p><figure class="mp mq mr ms gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi my"><img src="../Images/10b8defaf7fcb432c50e08b41f3f7fc1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*CstH0TK-Zs3OlzIA"/></div></div></figure><p id="1dfa" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">添加您创建的后端web服务器:</p><figure class="mp mq mr ms gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mz"><img src="../Images/322c5344d4e91d2bd6ac9f725e92a6de.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*y0qtPHC3-ZdZMvvO"/></div></div></figure><p id="aedb" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">配置HTTPS监听器。如果您没有SSL证书，您可以使用以下方式生成自签名证书:</p><pre class="mp mq mr ms gt na nb nc nd aw ne bi"><span id="8943" class="nf ll iq nb b gy ng nh l ni nj">$ openssl req -x509 -newkey rsa:4096 -keyout key.pem -out cert.pem -sha256 -days 365</span></pre><p id="fe08" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">选择“负载平衡器管理的证书”并上传证书、私钥，然后输入私钥的密码。</p><p id="edab" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">如果需要，您可以选择启用日志记录。单击提交创建负载平衡器。创建IP地址后，请记下它，因为我们很快就会用到它。</p><p id="4099" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">现在我们将在虚拟机上安装OpenResty。通过SSH或OCI堡垒服务连接到实例:</p><pre class="mp mq mr ms gt na nb nc nd aw ne bi"><span id="35fb" class="nf ll iq nb b gy ng nh l ni nj">$ ssh -i ~/.ssh/[your ssh key].key opc@[ip address]</span></pre><p id="80f5" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">运行以下命令安装OpenResty:</p><pre class="mp mq mr ms gt na nb nc nd aw ne bi"><span id="c652" class="nf ll iq nb b gy ng nh l ni nj">$ wget https://openresty.org/package/oracle/openresty.repo <br/>$ sudo mv openresty.repo /etc/yum.repos.d/ <br/>$ sudo yum check-update $ sudo yum install -y openresty-resty</span></pre><p id="dd99" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在本地机器上，使用scp将SSL证书和密钥复制到OpenResty服务器:</p><pre class="mp mq mr ms gt na nb nc nd aw ne bi"><span id="c48e" class="nf ll iq nb b gy ng nh l ni nj">$ cd /path/to/cert/folder $ scp -i ~/.ssh/[your ssh key].key *.pem opc@[ip address]:.</span></pre><p id="e947" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">现在，在OpenResty虚拟机上，将证书文件复制到所需的位置。</p><pre class="mp mq mr ms gt na nb nc nd aw ne bi"><span id="6c21" class="nf ll iq nb b gy ng nh l ni nj">$ sudo mkdir -p /etc/pki/nginx/private <br/>$ sudo cp cert.pem /etc/pki/nginx/ <br/>$ sudo cp key.pem /etc/pki/nginx/private/ <br/>$ sudo touch /etc/pki/nginx/private/key_password <br/>$ sudo vi /etc/pki/nginx/private/key_password</span></pre><p id="045e" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">将私钥密码添加到文件中，保存并退出Vi。</p><p id="ad3d" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">现在我们要替换OpenResty Nginx配置:</p><pre class="mp mq mr ms gt na nb nc nd aw ne bi"><span id="2920" class="nf ll iq nb b gy ng nh l ni nj">$ sudo rm /usr/local/openresty/nginx/conf/nginx.conf <br/>$ sudo vi /usr/local/openresty/nginx/conf/nginx.conf</span></pre><p id="1001" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">添加以下代码块:</p><pre class="mp mq mr ms gt na nb nc nd aw ne bi"><span id="cfaf" class="nf ll iq nb b gy ng nh l ni nj">#user  nobody;<br/>worker_processes  1;</span><span id="978a" class="nf ll iq nb b gy nk nh l ni nj">#error_log  logs/error.log;<br/>#error_log  logs/error.log  notice;<br/>#error_log  logs/error.log  info;</span><span id="c621" class="nf ll iq nb b gy nk nh l ni nj">#pid        logs/nginx.pid;</span><span id="f2d6" class="nf ll iq nb b gy nk nh l ni nj">events {<br/>    worker_connections  1024;<br/>}</span><span id="e028" class="nf ll iq nb b gy nk nh l ni nj">http {<br/>    include       mime.types;<br/>    default_type  application/octet-stream;<br/>    sendfile        on;<br/>    keepalive_timeout  65;</span><span id="292a" class="nf ll iq nb b gy nk nh l ni nj">include migration-server.conf;<br/>}</span></pre><p id="f7ea" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">保存并退出Vi。现在我们不想从Github获取所需的Nginx配置和Lua文件。像往常一样，在运行之前检查从网上下载的任何代码。</p><pre class="mp mq mr ms gt na nb nc nd aw ne bi"><span id="0adb" class="nf ll iq nb b gy ng nh l ni nj">$ cd /usr/local/openresty/nginx/conf/ <br/>$ sudo wget <a class="ae mn" href="https://raw.githubusercontent.com/scotti-fletcher/tls-migration/main/migration-server.conf" rel="noopener ugc nofollow" target="_blank">https://raw.githubusercontent.com/scotti-fletcher/tls-migration/main/migration-server.conf</a></span></pre><p id="917e" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">使用Vi编辑migration-server.conf文件，更新所需的行server_name、ssl_certificate、ssl_certificate_key、ssl_password_file和proxy_pass。proxy_pass值需要是您之前创建的负载平衡器的专用IP地址。</p><p id="86ff" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">现在我们需要获得所需的Lua脚本:</p><pre class="mp mq mr ms gt na nb nc nd aw ne bi"><span id="e925" class="nf ll iq nb b gy ng nh l ni nj">$ sudo mkdir /usr/local/openresty/nginx/lua <br/>$ cd /usr/local/openresty/nginx/lua <br/>$ sudo wget <a class="ae mn" href="https://raw.githubusercontent.com/scotti-fletcher/tls-migration/main/request-logger.lua" rel="noopener ugc nofollow" target="_blank">https://raw.githubusercontent.com/scotti-fletcher/tls-migration/main/request-logger.lua</a></span></pre><p id="b434" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在这个文件中，您可以定制您想要捕获的特定信息，在这个例子中，我涵盖了HTTP基本身份验证(针对API)和HTTP POST参数，例如当用户登录时。根据您的使用案例和登录用户名参数，您可能需要更新该文件:</p><pre class="mp mq mr ms gt na nb nc nd aw ne bi"><span id="2501" class="nf ll iq nb b gy ng nh l ni nj">json = require("cjson")<br/>local b64 = require("ngx.base64")<br/>local ssl = require "ngx.ssl"</span><span id="db90" class="nf ll iq nb b gy nk nh l ni nj">local data = {request={}}<br/>local req = data["request"]<br/>req["host"] = ngx.var.host<br/>req["uri"] = ngx.var.uri<br/>if ngx.req.get_headers()['user_agent'] then    <br/>    req['user_agent'] = ngx.req.get_headers()['user_agent']<br/>else<br/>    req['user_agent'] = 'Unknown'<br/>end<br/>if ngx.req.get_headers()['authorization'] then<br/>    -- We're assuming the auth header is HTTP Basic &amp; Base64 encoded, update as per your requirement<br/>    auth_header = ngx.req.get_headers()['authorization']<br/>    i, j = string.find(auth_header, " ")<br/>    decoded_value = b64.decode_base64url(string.sub(auth_header, i+1))<br/>    k, l = string.find(decoded_value, ':')<br/>    username = string.sub(decoded_value, 1, k-1)<br/>    req['api_username'] = username<br/>end<br/>tls_version, err = ssl.get_tls1_version_str()<br/>req['client_ip'] = ngx.var.remote_addr<br/>req['tls_version'] = tls_version<br/>req["time"] = ngx.req.start_time()<br/>req["method"] = ngx.req.get_method()<br/>-- Customise to capture usernames on login<br/>if ngx.req.get_post_args()['username'] then<br/>    req['username'] = ngx.req.get_post_args()['username']<br/>end</span><span id="5f2c" class="nf ll iq nb b gy nk nh l ni nj">local file = io.open("/usr/local/openresty/nginx/logs/tls.log", "a")<br/>file:write(json.encode(data) .. "\n")<br/>file:close()</span></pre><p id="73fe" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">现在我们需要创建日志来存储我们捕获的JSON数据:</p><pre class="mp mq mr ms gt na nb nc nd aw ne bi"><span id="d818" class="nf ll iq nb b gy ng nh l ni nj">$ sudo touch /usr/local/openresty/nginx/logs/tls.log <br/>$ sudo chmod 666 /usr/local/openresty/nginx/logs/tls.log</span></pre><p id="d2dd" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我还建议为tls.log文件设置Logrotate。</p><p id="e7fb" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">现在我们需要启用本地防火墙来允许端口443上的TCP流量:</p><pre class="mp mq mr ms gt na nb nc nd aw ne bi"><span id="eaa5" class="nf ll iq nb b gy ng nh l ni nj">$ sudo firewall-cmd --zone=public --permanent --add-port=443/tcp <br/>$ sudo firewall-cmd --reload <br/>$ sudo firewall-cmd --list-ports</span></pre><p id="0175" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">现在，您应该能够在web浏览器中浏览您的站点了。如果您选择了自签名证书，则需要接受浏览器证书警告消息。您应该会看到一个类似如下的页面:</p><figure class="mp mq mr ms gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nl"><img src="../Images/2b02f3fd8600f7a924441ed6dadce3c9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*oWEDAXcm7eE8NkP-"/></div></div></figure><p id="b95e" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">现在，我们将模拟一些流量，以演示捕获和记录。首先，我们将发送一个API请求:</p><pre class="mp mq mr ms gt na nb nc nd aw ne bi"><span id="a518" class="nf ll iq nb b gy ng nh l ni nj">$ curl -k -X POST -u "scott:password" -H "Content-Type:text/json" --tlsv1.3 --tls-max 1.3 https://[Public IP Address of the OpenResty Instance]/auth</span></pre><p id="9cad" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">如果我查看tls.log文件，我可以看到:</p><pre class="mp mq mr ms gt na nb nc nd aw ne bi"><span id="d335" class="nf ll iq nb b gy ng nh l ni nj">{"request":{"user_agent":"curl\/7.79.1","method":"POST","api_username":"scott","tls_version":"TLSv1.3","time":1657766981.205,"client_ip":"redacted","host":"redacted","uri":"\/auth"}}</span></pre><p id="6d06" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">如果我发出另一个模拟浏览器登录的请求:</p><pre class="mp mq mr ms gt na nb nc nd aw ne bi"><span id="d945" class="nf ll iq nb b gy ng nh l ni nj">$ curl -k -X POST -d "username=jackson" -d "password=test123" -H "Content-Type:application/x-www-form-urlencoded" --tlsv1.3 --tls-max 1.3 https://[Public IP Address of the OpenResty Instance]/login</span></pre><p id="1d3f" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我可以看到:</p><pre class="mp mq mr ms gt na nb nc nd aw ne bi"><span id="0942" class="nf ll iq nb b gy ng nh l ni nj">{"request":{"user_agent":"curl\/7.79.1","username":"jackson","method":"POST","tls_version":"TLSv1.3","time":1657767062.466,"client_ip":"redacted","host":"redacted","uri":"\/login"}}</span></pre><p id="4bc1" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我还可以调整使用的TLS版本:</p><pre class="mp mq mr ms gt na nb nc nd aw ne bi"><span id="6d10" class="nf ll iq nb b gy ng nh l ni nj">$ curl -k -X POST -u "scott:password" -H "Content-Type:text/json" --tlsv1.0 --tls-max 1.0 <a class="ae mn" href="https://redacted/auth" rel="noopener ugc nofollow" target="_blank">https://redacted/auth</a></span></pre><p id="540d" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我可以在我的JSON日志中看到TLS版本:</p><pre class="mp mq mr ms gt na nb nc nd aw ne bi"><span id="ff2c" class="nf ll iq nb b gy ng nh l ni nj">{"request":{"user_agent":"curl\/7.79.1","method":"POST","api_username":"scott","tls_version":"TLSv1","time":1657767151.891,"client_ip":"redacted","host":"redacted,"uri":"\/auth"}}</span></pre><p id="5c87" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在这一点上，您希望确保只记录最低限度的需求。默认情况下，脚本只包含您指定的值。我建议不要捕获和记录所有的帖子参数，因为你可能会捕获敏感的PII。</p><p id="cf8d" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">现在，我们需要接收我们的日志，这样我们就可以做出我前面提到的那些明智的决定。首先，我们需要创建一个动态组:</p><figure class="mp mq mr ms gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mv"><img src="../Images/179c02ae616978b7cdd1df9f4e1b78fc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*nvplmDu1XnIAUZ_S"/></div></div></figure><p id="b9b9" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">现在我们创建一个日志组:</p><figure class="mp mq mr ms gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nm"><img src="../Images/cfab739656f1ba3758966a073b5ccaf7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*dQEOxW1M6O7TzGJI"/></div></div></figure><p id="6799" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">现在我们创建一个自定义日志:</p><figure class="mp mq mr ms gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nn"><img src="../Images/342a9d6ba75aad4decfb6199732ff516.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*Y5NB3HXSxeF52FlO"/></div></div></figure><p id="d5cc" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">现在我们添加一个代理配置来收集我们的定制JSON tls.log:</p><figure class="mp mq mr ms gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi no"><img src="../Images/a7244b80336440c491a994021acbbd24.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*lm_CqcbUm5TpyIqh"/></div></div></figure><p id="b913" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">确保您单击了“创建策略以允许动态组中的实例使用日志记录服务”在“高级解析器选项”下，确保选择了JSON:</p><figure class="mp mq mr ms gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi np"><img src="../Images/a0b68543ad61246d4ea8127c7ee1741a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*gYtt76fKE3sinjRi"/></div></div></figure><p id="ccf9" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">通过选择JSON作为解析器，我的JSON日志将被正确地导入到OCI日志中，这使得在日志分析中映射字段变得更加容易。</p><p id="09e1" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">您的配置可能需要30分钟才能激活并开始收集日志，如果您想加快速度，您可以运行(在OpenResty虚拟机上):</p><pre class="mp mq mr ms gt na nb nc nd aw ne bi"><span id="b357" class="nf ll iq nb b gy ng nh l ni nj">$ sudo systemctl restart unified-monitoring-agent_config_downloader</span></pre><p id="3117" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">然后，您应该能够在OCI日志中看到您的日志:</p><figure class="mp mq mr ms gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nq"><img src="../Images/d66d4acc09f1b6db3f13994b5869e666.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*6TDpFnR_7ezdqrgU"/></div></div></figure><p id="fb7a" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">现在，我们需要创建一个存储桶来在日志记录和分析之间移动日志:</p><figure class="mp mq mr ms gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nr"><img src="../Images/20afd3fe505f7630f3b6bdd3a22db8b2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*yJqc94ISsWIQAKyX"/></div></div></figure><p id="6bab" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">现在我们需要创建一个服务连接器来将日志移动到我们的存储桶中:</p><figure class="mp mq mr ms gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi ns"><img src="../Images/84c76ce36060092651cc580f64baec52.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*eWhF6SRmCXZj1dsU"/></div></div></figure><p id="144f" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">确保单击“创建默认策略”，然后单击“创建”。</p><p id="3a1c" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">现在通过Curl，或者通过你的网络浏览器产生更多的流量。5–10分钟后，您应该会在对象存储桶中看到日志:</p><figure class="mp mq mr ms gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mv"><img src="../Images/222cbeba3c998c0e9787198c749fd5da.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*yCPzyPlNNyxAKCpq"/></div></div></figure><p id="c1f3" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在日志分析中，创建一个日志组来保存我们的TLS日志。我将我的日志称为“tls日志”:</p><figure class="mp mq mr ms gt jr gh gi paragraph-image"><div class="gh gi nt"><img src="../Images/31967b8934700e241aaf1d438575ab6a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1336/0*7fjbeFxA0D3b2dEP"/></div></figure><p id="e01b" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">如果您尚未从GitHub<a class="ae mn" href="https://github.com/scotti-fletcher/tls-migration/blob/main/tls-migration-source.zip" rel="noopener ugc nofollow" target="_blank">https://GitHub . com/scotti-Fletcher/TLS-migration/blob/main/TLS-migration-Source . zip</a>中检索到日志分析日志源和解析器配置，请下载该配置</p><p id="1418" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">点击“导入配置内容”，选择ZIP文件，点击导入:</p><figure class="mp mq mr ms gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nu"><img src="../Images/3c896bcd4084cc11f7cc36598a623bfb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*fg3dWCcOM9DnTduY"/></div></div></figure><p id="e526" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">现在我们需要创建一个对象收集规则，该规则允许从我们的openresty-logs桶中收集日志，并将它们加载到我们的tls-logs日志组中。</p><pre class="mp mq mr ms gt na nb nc nd aw ne bi"><span id="c16e" class="nf ll iq nb b gy ng nh l ni nj">$ oci log-analytics object-collection-rule create --name tls-collection-rule --compartment-id [Your Compartment OCID] --os-namespace [Your Object Storage Namespace] --os-bucket-name openresty-logs --log-group-id [The OCID of the tls-logs Log Group] --log-source-name tls-migration-source --namespace-name [Your Object Storage Namespace] --collection-type HISTORIC_LIVE --poll-since BEGINNING</span></pre><p id="bc7b" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">CLI应该返回一个JSON响应，表明您的规则创建成功。您还应该能够看到创建的事件规则:</p><figure class="mp mq mr ms gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nq"><img src="../Images/e80be6ac27a20599e2dd2c1edb96f835.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*yij6lDuR15eBQAQN"/></div></div></figure><p id="d054" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">如果您还没有从GitHub<a class="ae mn" href="https://github.com/scotti-fletcher/tls-migration/blob/main/tls-migration-dashboard.json" rel="noopener ugc nofollow" target="_blank">https://GitHub . com/scotti-Fletcher/TLS-migration/blob/main/TLS-migration-Dashboard . JSON</a>下载日志分析仪表板。您需要找到“ENTER_COMPARTMENT_ID”的所有值，并将其替换为要创建仪表板的车厢的OCID。</p><p id="0035" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">使用CLI运行以下命令。您还需要更新您想要创建仪表板的区域的端点的URL:</p><pre class="mp mq mr ms gt na nb nc nd aw ne bi"><span id="db4c" class="nf ll iq nb b gy ng nh l ni nj">$ oci raw-request --target-uri https://managementdashboard.ap-sydney-1.oci.oraclecloud.com/20200901/managementDashboards/actions/importDashboard --http-method POST --request-body file://tls-migration-dashboard.json</span></pre><p id="2324" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">然后，您应该能够查看您的仪表板和数据:</p><figure class="mp mq mr ms gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mv"><img src="../Images/b0d3b82a53c0121336722edb2e295451.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*h71rD5Ufsz7QJNVJ"/></div></div></figure><p id="dfc3" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我创建的仪表板显示了您的流量来源、一段时间内的流量数量、版本、正在连接的非TLSv1.3用户代理，以及有关哪些API和基于Web的用户未通过TLSv1.3进行连接的信息。</p><p id="ee09" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">从这里开始，你将能够回答那些早先的问题:</p><ul class=""><li id="e172" class="kw kx iq ka b kb kc kf kg kj ky kn kz kr la kv lb lc ld le bi translated">我的客户中有多少比例会因为关闭特定版本而受到影响？</li><li id="3fb4" class="kw kx iq ka b kb lf kf lg kj lh kn li kr lj kv lb lc ld le bi translated">在这些客户中，有哪些是“大客户”？</li><li id="f8ad" class="kw kx iq ka b kb lf kf lg kj lh kn li kr lj kv lb lc ld le bi translated">我的客户对TLS迁移服务通知的响应速度有多快？</li><li id="1b4e" class="kw kx iq ka b kb lf kf lg kj lh kn li kr lj kv lb lc ld le bi translated">有什么交通是我不需要担心的吗？例如，机器人，或来自我的企业不在其中运营的外国的流量。</li></ul><p id="57a1" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">如果您有其他具体问题，可以使用日志资源管理器编写自己的自定义查询。要查看仪表板中使用的查询，请单击每个小部件右上角的按钮。</p><h1 id="d1be" class="lk ll iq bd lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh bi translated">一些最后的想法</h1><p id="ebed" class="pw-post-body-paragraph jy jz iq ka b kb mi kd ke kf mj kh ki kj mk kl km kn ml kp kq kr mm kt ku kv ij bi translated">TLS迁移可能会很困难！希望我已经向您展示了如何解决这个问题，做出更好的决策，并帮助您的客户迁移到更强的TLS版本。</p><p id="4c24" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">从这里开始，您可以轻松地扩展解决方案，使其包含一个无服务器功能，当发现客户使用较旧的TLS版本时，可以向他们发送电子邮件。</p><p id="b01b" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">根据您的应用程序/ API，您可能希望只捕获存在用户名的请求，例如web浏览器的/login，或者API的特定URL。这可以通过修改Lua代码很容易地实现:</p><pre class="mp mq mr ms gt na nb nc nd aw ne bi"><span id="a60d" class="nf ll iq nb b gy ng nh l ni nj">if req["uri"] = '/login' then<br/>    -- do something here<br/>end</span></pre><p id="a31b" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">为了简单起见，我的演示只有一个OpenResty实例。如果您要在生产环境中使用它，我建议您设置HA，这样就不会有单点故障。</p><p id="a297" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">最后，OCI日志是简单的，易于使用，快速设置。管理第三方代理和日志记录基础架构、收集日志并分析它们需要大量时间。OCI通过其统一监控代理和本地服务为您完成了几乎所有这些繁重的工作。</p><figure class="mp mq mr ms gt jr gh gi paragraph-image"><div class="gh gi nv"><img src="../Images/834eae2f62eb6f5b97ee2b134c9263b3.png" data-original-src="https://miro.medium.com/v2/resize:fit:84/0*pzgdgih5H3u0maxw"/></div></figure></div><div class="ab cl nw nx hu ny" role="separator"><span class="nz bw bk oa ob oc"/><span class="nz bw bk oa ob oc"/><span class="nz bw bk oa ob"/></div><div class="ij ik il im in"><p id="f44e" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><em class="od">原载于2022年7月19日</em><a class="ae mn" href="https://redthunder.blog/2022/07/19/tls-migration-a-better-way/" rel="noopener ugc nofollow" target="_blank"><em class="od">http://red thunder . blog</em></a><em class="od">。</em></p></div></div>    
</body>
</html>