<html>
<head>
<title>Kubernetes: HorizontalPodAutoscaler — an overview with examples</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">kubernetes:HorizontalPodAutoscaler—示例概述</h1>
<blockquote>原文：<a href="https://itnext.io/kubernetes-horizontalpodautoscaler-an-overview-with-examples-51f0d520bfe6?source=collection_archive---------1-----------------------#2020-08-12">https://itnext.io/kubernetes-horizontalpodautoscaler-an-overview-with-examples-51f0d520bfe6?source=collection_archive---------1-----------------------#2020-08-12</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div class="gh gi jn"><img src="../Images/0cccf8d2e52e0240b724c66ecd431f30.png" data-original-src="https://miro.medium.com/v2/resize:fit:260/format:webp/0*_GX-UK17fVKwPoyT.png"/></div></figure><p id="5845" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated"><a class="ae ks" href="https://kubernetes.io/docs/tasks/run-application/horizontal-pod-autoscale/" rel="noopener ugc nofollow" target="_blank">Kubernetes HorizontalPodAutoscaler</a>根据CPU、内存或其他指标，在<code class="fe kt ku kv kw b"><a class="ae ks" href="https://kubernetes.io/docs/concepts/workloads/controllers/replicationcontroller/" rel="noopener ugc nofollow" target="_blank">ReplicationController</a></code>、<code class="fe kt ku kv kw b"><a class="ae ks" href="https://kubernetes.io/docs/concepts/workloads/controllers/deployment/" rel="noopener ugc nofollow" target="_blank">Deployment</a></code>或<code class="fe kt ku kv kw b"><a class="ae ks" href="https://kubernetes.io/docs/concepts/workloads/controllers/replicaset/" rel="noopener ugc nofollow" target="_blank">ReplicaSet</a></code>控制器下自动扩展Kubernetes Pods。</p><p id="3376" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">在<a class="ae ks" href="https://rtfm.co.ua/en/kubernetes-running-metrics-server-in-aws-eks-for-a-kubernetes-pod-autoscaler/" rel="noopener ugc nofollow" target="_blank"> Kubernetes:为Kubernetes Pod AutoScaler </a>帖子在AWS EKS运行metrics-server中，我们曾对此进行过简短的讨论，现在让我们更深入地检查一下可用于缩放的所有选项。</p><p id="efbd" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">对于HPA，您可以使用三种API类型:</p><ul class=""><li id="62c1" class="kx ky iq jw b jx jy kb kc kf kz kj la kn lb kr lc ld le lf bi translated"><code class="fe kt ku kv kw b">metrics.k8s.io</code>:默认指标，基本由<code class="fe kt ku kv kw b"><a class="ae ks" href="https://github.com/kubernetes-incubator/metrics-server" rel="noopener ugc nofollow" target="_blank">metrics-server</a></code>提供</li><li id="6dea" class="kx ky iq jw b jx lg kb lh kf li kj lj kn lk kr lc ld le lf bi translated"><code class="fe kt ku kv kw b"><a class="ae ks" href="https://github.com/kubernetes/community/blob/master/contributors/design-proposals/instrumentation/custom-metrics-api.md" rel="noopener ugc nofollow" target="_blank">custom.metrics.k8s.io</a></code>:指标，由集群内部的适配器提供，例如- <a class="ae ks" href="https://github.com/Azure/azure-k8s-metrics-adapter" rel="noopener ugc nofollow" target="_blank">微软Azure适配器</a>、<a class="ae ks" href="https://github.com/GoogleCloudPlatform/k8s-stackdriver" rel="noopener ugc nofollow" target="_blank">谷歌Stackdriver </a>、<a class="ae ks" href="https://github.com/directxman12/k8s-prometheus-adapter" rel="noopener ugc nofollow" target="_blank">普罗米修斯适配器</a>(普罗米修斯适配器将在本文稍后使用)，查看完整列表<a class="ae ks" href="https://github.com/kubernetes/metrics/blob/master/IMPLEMENTATIONS.md#custom-metrics-api" rel="noopener ugc nofollow" target="_blank">此处&gt; &gt; &gt; </a></li><li id="3327" class="kx ky iq jw b jx lg kb lh kf li kj lj kn lk kr lc ld le lf bi translated"><code class="fe kt ku kv kw b"><a class="ae ks" href="https://github.com/kubernetes/community/blob/master/contributors/design-proposals/instrumentation/external-metrics-api.md" rel="noopener ugc nofollow" target="_blank">external.metrics.k8s.io</a></code>:类似于自定义指标API，但是指标是由外部系统提供的，比如AWS CloudWatch</li></ul><p id="e227" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">文档:<a class="ae ks" href="https://kubernetes.io/docs/tasks/run-application/horizontal-pod-autoscale/#support-for-metrics-apis" rel="noopener ugc nofollow" target="_blank">支持度量API</a>，以及<a class="ae ks" href="https://cloud.google.com/kubernetes-engine/docs/concepts/custom-and-external-metrics" rel="noopener ugc nofollow" target="_blank">用于自动扩展工作负载的自定义和外部度量</a>。</p><p id="7419" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">除了水平吊舱自动缩放器(HPA)，您还可以使用<a class="ae ks" href="https://cloud.google.com/kubernetes-engine/docs/concepts/verticalpodautoscaler" rel="noopener ugc nofollow" target="_blank">垂直吊舱自动缩放(VPA) </a>，它们可以一起使用，尽管有一些限制，参见<a class="ae ks" href="https://cloud.google.com/kubernetes-engine/docs/concepts/horizontalpodautoscaler#limitations" rel="noopener ugc nofollow" target="_blank">水平吊舱自动缩放限制</a>。</p><h1 id="19fd" class="ll lm iq bd ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi bi translated">内容</h1><ul class=""><li id="d373" class="kx ky iq jw b jx mj kb mk kf ml kj mm kn mn kr lc ld le lf bi translated"><a class="ae ks" href="https://rtfm.co.ua/en/kubernetes-horizontalpodautoscaler-an-overview-with-examples/#Create_HorizontalPodAutoscaler" rel="noopener ugc nofollow" target="_blank">创建HorizontalPodAutoscaler </a></li><li id="4976" class="kx ky iq jw b jx lg kb lh kf li kj lj kn lk kr lc ld le lf bi translated"><a class="ae ks" href="https://rtfm.co.ua/en/kubernetes-horizontalpodautoscaler-an-overview-with-examples/#Load_testing_HorizontalPodAutoscaler_scaling" rel="noopener ugc nofollow" target="_blank">负载测试horizontalpod自动缩放</a></li><li id="d2e6" class="kx ky iq jw b jx lg kb lh kf li kj lj kn lk kr lc ld le lf bi translated"><a class="ae ks" href="https://rtfm.co.ua/en/kubernetes-horizontalpodautoscaler-an-overview-with-examples/#Multimetrics_scaling" rel="noopener ugc nofollow" target="_blank">多指标缩放</a></li><li id="1339" class="kx ky iq jw b jx lg kb lh kf li kj lj kn lk kr lc ld le lf bi translated"><a class="ae ks" href="https://rtfm.co.ua/en/kubernetes-horizontalpodautoscaler-an-overview-with-examples/#autoscaling_API_group_versions" rel="noopener ugc nofollow" target="_blank">自动缩放API组版本</a></li><li id="c90f" class="kx ky iq jw b jx lg kb lh kf li kj lj kn lk kr lc ld le lf bi translated"><a class="ae ks" href="https://rtfm.co.ua/en/kubernetes-horizontalpodautoscaler-an-overview-with-examples/#Custom_Metrics" rel="noopener ugc nofollow" target="_blank">自定义指标</a></li><li id="f209" class="kx ky iq jw b jx lg kb lh kf li kj lj kn lk kr lc ld le lf bi translated"><a class="ae ks" href="https://rtfm.co.ua/en/kubernetes-horizontalpodautoscaler-an-overview-with-examples/#Memory_metrics_scaling" rel="noopener ugc nofollow" target="_blank">内存指标缩放</a></li><li id="6166" class="kx ky iq jw b jx lg kb lh kf li kj lj kn lk kr lc ld le lf bi translated"><a class="ae ks" href="https://rtfm.co.ua/en/kubernetes-horizontalpodautoscaler-an-overview-with-examples/#Applicationbased_metrics_scaling" rel="noopener ugc nofollow" target="_blank">基于应用的指标扩展</a></li><li id="9374" class="kx ky iq jw b jx lg kb lh kf li kj lj kn lk kr lc ld le lf bi translated"><a class="ae ks" href="https://rtfm.co.ua/en/kubernetes-horizontalpodautoscaler-an-overview-with-examples/#Kubernetes_ServiceMonitor" rel="noopener ugc nofollow" target="_blank">Kubernetes service monitor</a></li><li id="714f" class="kx ky iq jw b jx lg kb lh kf li kj lj kn lk kr lc ld le lf bi translated"><a class="ae ks" href="https://rtfm.co.ua/en/kubernetes-horizontalpodautoscaler-an-overview-with-examples/#Prometheus_Adapter_ConfigMap_%E2%80%93_seriesQuery_and_metricsQuery" rel="noopener ugc nofollow" target="_blank"> Prometheus适配器配置图—系列查询和度量查询</a></li></ul><h1 id="8a0d" class="ll lm iq bd ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi bi translated">创建HorizontalPodAutoscaler</h1><p id="d136" class="pw-post-body-paragraph ju jv iq jw b jx mj jz ka kb mk kd ke kf mo kh ki kj mp kl km kn mq kp kq kr ij bi translated">让我们从一个简单的HPA开始，它将根据CPU的使用情况来扩展单元:</p><pre class="mr ms mt mu gt mv kw mw mx aw my bi"><span id="fb0c" class="mz lm iq kw b gy na nb l nc nd">apiVersion: autoscaling/v1<br/>kind: HorizontalPodAutoscaler<br/>metadata:<br/>  name: hpa-example<br/>spec:<br/>  scaleTargetRef:<br/>    apiVersion: apps/v1<br/>    kind: Deployment<br/>    name: deployment-example<br/>  minReplicas: 1<br/>  maxReplicas: 5<br/>  targetCPUUtilizationPercentage: 10</span></pre><p id="8740" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">这里:</p><ul class=""><li id="33e4" class="kx ky iq jw b jx jy kb kc kf kz kj la kn lb kr lc ld le lf bi translated"><code class="fe kt ku kv kw b">apiVersion: autoscaling/v1</code> -一个API组<code class="fe kt ku kv kw b">autoscaling</code>，注意API版本，因为在撰写本文时的<code class="fe kt ku kv kw b">v1</code>中，缩放仅由CPU指标提供，因此内存和自定义指标只能与API <code class="fe kt ku kv kw b">v2beta2</code>一起使用(仍然可以使用带注释的<code class="fe kt ku kv kw b">v1</code>，参见<a class="ae ks" href="https://kubernetes.io/docs/tasks/run-application/horizontal-pod-autoscale/#api-object" rel="noopener ugc nofollow" target="_blank"> API对象</a>。</li><li id="e277" class="kx ky iq jw b jx lg kb lh kf li kj lj kn lk kr lc ld le lf bi translated"><code class="fe kt ku kv kw b">spec.scaleTargetRef</code>:为нра指定将缩放哪个控制器(<code class="fe kt ku kv kw b">ReplicationController</code>、<code class="fe kt ku kv kw b">Deployment</code>、<code class="fe kt ku kv kw b">ReplicaSet</code>)，在这种情况下，HPA将寻找名为<em class="ne">部署的<code class="fe kt ku kv kw b">Deployment</code>对象——例如</em></li><li id="7e45" class="kx ky iq jw b jx lg kb lh kf li kj lj kn lk kr lc ld le lf bi translated"><code class="fe kt ku kv kw b">spec.minReplicas</code>、<code class="fe kt ku kv kw b">spec.maxReplicas</code>:该HPA运行的最小和最大pod</li><li id="b93c" class="kx ky iq jw b jx lg kb lh kf li kj lj kn lk kr lc ld le lf bi translated"><code class="fe kt ku kv kw b">targetCPUUtilizationPercentage</code>:当HPA添加或移除pod时，来自<code class="fe kt ku kv kw b"><a class="ae ks" href="https://cloud.google.com/blog/products/gcp/kubernetes-best-practices-resource-requests-and-limits" rel="noopener ugc nofollow" target="_blank">requests</a></code>的CPU使用率%</li></ul><p id="9131" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">创建它:</p><pre class="mr ms mt mu gt mv kw mw mx aw my bi"><span id="e016" class="mz lm iq kw b gy na nb l nc nd">$ kubectl apply -f hpa-example.yaml<br/>horizontalpodautoscaler.autoscaling/hpa-example created</span></pre><p id="9f86" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">检查:</p><pre class="mr ms mt mu gt mv kw mw mx aw my bi"><span id="3aed" class="mz lm iq kw b gy na nb l nc nd">$ kubectl get hpa hpa-example<br/>NAME REFERENCE TARGETS MINPODS MAXPODS REPLICAS AGE<br/>hpa-example Deployment/deployment-example &lt;unknown&gt;/10% 1 5 0 89s</span></pre><p id="57fa" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">目前，它的<code class="fe kt ku kv kw b">TARGETS</code>具有未知的<em class="ne">&lt;&gt;</em>值，因为还没有创建pod，但是指标已经可用:</p><pre class="mr ms mt mu gt mv kw mw mx aw my bi"><span id="ca75" class="mz lm iq kw b gy na nb l nc nd">$ kubectl get — raw “/apis/metrics.k8s.io/” | jq{<br/>“kind”: “APIGroup”,<br/>“apiVersion”: “v1”,<br/>“name”: “metrics.k8s.io”,<br/>“versions”: [<br/>{<br/>“groupVersion”: “metrics.k8s.io/v1beta1”,<br/>“version”: “v1beta1”<br/>}<br/>],<br/>“preferredVersion”: {<br/>“groupVersion”: “metrics.k8s.io/v1beta1”,<br/>“version”: “v1beta1”}<br/>}</span></pre><p id="fdb2" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">添加名为<em class="ne">的部署-示例</em>T15:</p><pre class="mr ms mt mu gt mv kw mw mx aw my bi"><span id="0fd9" class="mz lm iq kw b gy na nb l nc nd">apiVersion: apps/v1<br/>kind: Deployment<br/>metadata:<br/>  name: deployment-example<br/>spec:<br/>  replicas: 1<br/>  strategy:<br/>    type: RollingUpdate<br/>  selector:<br/>    matchLabels:<br/>      application: deployment-example<br/>  template:<br/>    metadata:<br/>      labels:<br/>        application: deployment-example<br/>    spec: <br/>      containers:<br/>      - name: deployment-example-pod<br/>        image: nginx<br/>        ports:<br/>          - containerPort: 80<br/>        resources:<br/>          requests:<br/>            cpu: 100m<br/>            memory: 100Mi</span></pre><p id="ef73" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">在这里，我们定义了一个部署，它将使用NINGX和<code class="fe kt ku kv kw b">requests</code>为100毫核和100 <a class="ae ks" href="https://en.wikipedia.org/wiki/Mebibyte" rel="noopener ugc nofollow" target="_blank">兆字节</a>内存旋转一个pod，请参见<a class="ae ks" href="https://cloud.google.com/blog/products/gcp/kubernetes-best-practices-resource-requests-and-limits" rel="noopener ugc nofollow" target="_blank"> Kubernetes最佳实践:资源请求和限制</a>。</p><p id="8a06" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">创建它:</p><pre class="mr ms mt mu gt mv kw mw mx aw my bi"><span id="fe9a" class="mz lm iq kw b gy na nb l nc nd">$ kubectl apply -f hpa-deployment-example.yaml<br/>deployment.apps/deployment-example created</span></pre><p id="31e8" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">现在检查HPA:</p><pre class="mr ms mt mu gt mv kw mw mx aw my bi"><span id="f906" class="mz lm iq kw b gy na nb l nc nd">$ kubectl get hpa hpa-example<br/>NAME REFERENCE TARGETS MINPODS MAXPODS REPLICAS AGE<br/>hpa-example Deployment/deployment-example 0%/10% 1 5 1 14m</span></pre><p id="642f" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">我们的нра发现了部署，并开始检查其吊舱的指标。</p><p id="4e63" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">让我们检查这些指标—找到一个pod:</p><pre class="mr ms mt mu gt mv kw mw mx aw my bi"><span id="5167" class="mz lm iq kw b gy na nb l nc nd">$ kubectl get pod | grep example | cut -d “ “ -f 1<br/>deployment-example-86c47f5897–2mzjd</span></pre><p id="076f" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">并运行以下API请求:</p><pre class="mr ms mt mu gt mv kw mw mx aw my bi"><span id="dc11" class="mz lm iq kw b gy na nb l nc nd">$ kubectl get — raw /apis/metrics.k8s.io/v1beta1/namespaces/default/pods/deployment-example-86c47f5897–2mzjd | jq<br/>{<br/>“kind”: “PodMetrics”,<br/>“apiVersion”: “metrics.k8s.io/v1beta1”,<br/>“metadata”: {<br/>“name”: “deployment-example-86c47f5897–2mzjd”,<br/>“namespace”: “default”,<br/>“selfLink”: “/apis/metrics.k8s.io/v1beta1/namespaces/default/pods/deployment-example-86c47f5897–2mzjd”,<br/>“creationTimestamp”: “2020–08–07T10:41:21Z”<br/>},<br/>“timestamp”: “2020–08–07T10:40:39Z”,<br/>“window”: “30s”,<br/>“containers”: [<br/>{<br/>“name”: “deployment-example-pod”,<br/>“usage”: {<br/>“cpu”: “0”,<br/>“memory”: “2496Ki”<br/>}<br/>}<br/>]<br/>}</span></pre><p id="4e3f" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">CPU使用率—零，内存—2mb，让我们用<code class="fe kt ku kv kw b">top</code>确认一下:</p><pre class="mr ms mt mu gt mv kw mw mx aw my bi"><span id="395f" class="mz lm iq kw b gy na nb l nc nd">$ kubectl top pod deployment-example-86c47f5897–2mzjd<br/>NAME CPU(cores) MEMORY(bytes)<br/>deployment-example-86c47f5897–2mzjd 0m 2Mi</span></pre><p id="3e35" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated"><em class="ne">“好吧，这些家伙</em>！”(с)</p><p id="d246" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">好了，我们有了指标，创建了HPA和部署，让我们来看看这里的扩展是如何工作的。</p><h2 id="2e86" class="mz lm iq bd ln nf ng dn lr nh ni dp lv kf nj nk lz kj nl nm md kn nn no mh np bi translated">负载测试水平自动缩放</h2><p id="71dc" class="pw-post-body-paragraph ju jv iq jw b jx mj jz ka kb mk kd ke kf mo kh ki kj mp kl km kn mq kp kq kr ij bi translated">对于负载测试，我们可以使用<a class="ae ks" href="https://hub.docker.com/r/loadimpact/loadgentest-wrk" rel="noopener ugc nofollow" target="_blank">load impact/loadgentest-wrk</a>实用程序映像。</p><p id="9874" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">现在，使用NGINX运行从本地工作站到pod的端口重定向，因为我们没有添加任何负载平衡器(参见<a class="ae ks" href="https://rtfm.co.ua/en/kubernetes-clusterip-vs-nodeport-vs-loadbalancer-services-and-ingress-an-overview-with-examples/" rel="noopener ugc nofollow" target="_blank">Kubernetes:cluster IP vs NodePort vs负载平衡器、服务和入口—示例概述</a>):</p><pre class="mr ms mt mu gt mv kw mw mx aw my bi"><span id="16c6" class="mz lm iq kw b gy na nb l nc nd">$ kubectl port-forward deployment-example-86c47f5897–2mzjd 8080:80<br/>Forwarding from 127.0.0.1:8080 -&gt; 80<br/>Forwarding from [::1]:8080 -&gt; 80</span></pre><p id="8bed" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">再次检查资源:</p><pre class="mr ms mt mu gt mv kw mw mx aw my bi"><span id="7cd6" class="mz lm iq kw b gy na nb l nc nd">$ kubectl get hpa hpa-example<br/>NAME REFERENCE TARGETS MINPODS MAXPODS REPLICAS AGE<br/>hpa-example Deployment/deployment-example 0%/10% 1 5 1 33m</span></pre><p id="5110" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">CPU使用率为0%，一个pod正在运行(<code class="fe kt ku kv kw b">REPLICAS</code> <em class="ne"> 1 </em>)。</p><p id="06e6" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">运行测试:</p><pre class="mr ms mt mu gt mv kw mw mx aw my bi"><span id="054a" class="mz lm iq kw b gy na nb l nc nd">$ docker run — rm — net=host loadimpact/loadgentest-wrk -c 100 -t 100 -d 5m <a class="ae ks" href="http://127.0.0.1:8080" rel="noopener ugc nofollow" target="_blank">http://127.0.0.1:8080</a><br/>Running 5m test @ <a class="ae ks" href="http://127.0.0.1:8080" rel="noopener ugc nofollow" target="_blank">http://127.0.0.1:8080</a></span></pre><p id="ab60" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">这里:</p><ul class=""><li id="2a22" class="kx ky iq jw b jx jy kb kc kf kz kj la kn lb kr lc ld le lf bi translated">使用100个线程打开100个连接</li><li id="9d18" class="kx ky iq jw b jx lg kb lh kf li kj lj kn lk kr lc ld le lf bi translated">运行测试5分钟</li></ul><p id="2d25" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">检查吊舱:</p><pre class="mr ms mt mu gt mv kw mw mx aw my bi"><span id="09dd" class="mz lm iq kw b gy na nb l nc nd">$ kubectl top pod deployment-example-86c47f5897–2mzjd<br/>NAME CPU(cores) MEMORY(bytes)<br/>deployment-example-86c47f5897–2mzjd 49m 2Mi</span></pre><p id="d349" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">CPU使用率现在为49mi，在<code class="fe kt ku kv kw b">requests</code>中，我们已经设置了10mi CPU限制——检查HPA:</p><pre class="mr ms mt mu gt mv kw mw mx aw my bi"><span id="773e" class="mz lm iq kw b gy na nb l nc nd">$ kubectl get hpa hpa-example<br/>NAME REFERENCE TARGETS MINPODS MAXPODS REPLICAS AGE<br/>hpa-example Deployment/deployment-example 49%/10% 1 5 4 42m</span></pre><p id="d7d5" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated"><code class="fe kt ku kv kw b">TARGETS</code>从10%的限制提高到49%，我们的HPA开始了新的pod-<code class="fe kt ku kv kw b">REPLICAS</code><em class="ne">4</em>:</p><pre class="mr ms mt mu gt mv kw mw mx aw my bi"><span id="486e" class="mz lm iq kw b gy na nb l nc nd">$ kubectl get pod | grep example<br/>deployment-example-86c47f5897–2mzjd 1/1 Running 0 31m<br/>deployment-example-86c47f5897–4ntd4 1/1 Running 0 24s<br/>deployment-example-86c47f5897-p7tc7 1/1 Running 0 8s<br/>deployment-example-86c47f5897-q49gk 1/1 Running 0 24s<br/>deployment-example-86c47f5897-zvdvz 1/1 Running 0 24s</span></pre><h1 id="ca19" class="ll lm iq bd ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi bi translated">多指标缩放</h1><p id="cd33" class="pw-post-body-paragraph ju jv iq jw b jx mj jz ka kb mk kd ke kf mo kh ki kj mp kl km kn mq kp kq kr ij bi translated">好吧，我们可以按CPU使用率进行扩展，但是如果您想同时按CPU和内存使用率进行扩展呢？</p><p id="251a" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">添加另一个<code class="fe kt ku kv kw b">Resource</code>，内存限制设置为相同的10%:</p><pre class="mr ms mt mu gt mv kw mw mx aw my bi"><span id="28ac" class="mz lm iq kw b gy na nb l nc nd">apiVersion: autoscaling/v2beta1<br/>kind: HorizontalPodAutoscaler<br/>metadata:<br/>  name: hpa-example<br/>spec:<br/>  scaleTargetRef:<br/>    apiVersion: apps/v1<br/>    kind: Deployment<br/>    name: deployment-example<br/>  minReplicas: 1<br/>  maxReplicas: 5<br/>  metrics:<br/>  - type: Resource<br/>    resource:<br/>      name: cpu<br/>      targetAverageUtilization: 10<br/>  - type: Resource<br/>    resource:<br/>      name: memory <br/>      targetAverageUtilization: 10</span></pre><h2 id="5be9" class="mz lm iq bd ln nf ng dn lr nh ni dp lv kf nj nk lz kj nl nm md kn nn no mh np bi translated">自动缩放API组版本</h2><p id="8382" class="pw-post-body-paragraph ju jv iq jw b jx mj jz ka kb mk kd ke kf mo kh ki kj mp kl km kn mq kp kq kr ij bi translated">让我们回到API版本。</p><p id="2a38" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">在HPA的第一个清单中，我们使用了<a class="ae ks" href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.18/#horizontalpodautoscaler-v1-autoscaling" rel="noopener ugc nofollow" target="_blank"> autoscaling/v1 </a> API，它只有一个<code class="fe kt ku kv kw b">targetCPUUtilizationPercentage</code>参数。</p><p id="0025" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">检查<a class="ae ks" href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.18/#metricspec-v2beta1-autoscaling" rel="noopener ugc nofollow" target="_blank"> autoscaling/v2beta1 </a> —现在，它增加了<code class="fe kt ku kv kw b">metrics</code>字段，这是<a class="ae ks" href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.18/#metricspec-v2beta1-autoscaling" rel="noopener ugc nofollow" target="_blank"> MetricSpec </a>数组，可以保存新字段<code class="fe kt ku kv kw b">external</code>、<code class="fe kt ku kv kw b">object</code>、<code class="fe kt ku kv kw b">pods</code>、<code class="fe kt ku kv kw b">resource</code>。</p><p id="602a" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">反过来，<code class="fe kt ku kv kw b">resource</code>拥有<a class="ae ks" href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.18/#resourcemetricsource-v2beta1-autoscaling" rel="noopener ugc nofollow" target="_blank"> ResourceMetricSource </a>，它拥有两个字段- <code class="fe kt ku kv kw b">targetAverageUtilization</code>和<code class="fe kt ku kv kw b">targetAverageValue</code>，这两个字段现在在<code class="fe kt ku kv kw b">mertics</code>中使用，而不是在<code class="fe kt ku kv kw b">targetCPUUtilizationPercentage</code>中使用。</p><p id="7a92" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">应用HPA更新:</p><pre class="mr ms mt mu gt mv kw mw mx aw my bi"><span id="9455" class="mz lm iq kw b gy na nb l nc nd">$ kubectl apply -f hpa-example.yaml<br/>horizontalpodautoscaler.autoscaling/hpa-example configured</span></pre><p id="dc05" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">检查一下:</p><pre class="mr ms mt mu gt mv kw mw mx aw my bi"><span id="798e" class="mz lm iq kw b gy na nb l nc nd">$ kubectl get hpa hpa-example<br/>NAME REFERENCE TARGETS MINPODS MAXPODS REPLICAS AGE<br/>hpa-example Deployment/deployment-example 3%/10%, 0%/10% 1 5 2 126m</span></pre><p id="92ac" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated"><code class="fe kt ku kv kw b">TARGETS</code>现在显示两个指标——CPU和内存。</p><p id="51fe" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">很难让NGINX消耗大量内存，所以我们用下面的<code class="fe kt ku kv kw b">kubectl</code>命令来看看它现在用了多少:</p><pre class="mr ms mt mu gt mv kw mw mx aw my bi"><span id="6c82" class="mz lm iq kw b gy na nb l nc nd">$ kubectl get — raw /apis/metrics.k8s.io/v1beta1/namespaces/default/pods/deployment-example-c4d6f96db-jv6nm | jq ‘.containers[].usage.memory’<br/>“2824Ki”</span></pre><p id="a79a" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">2兆。</p><p id="eafe" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">让我们再次更新我们的PHA并设置一个新的限制，但此时我们将使用原始值而不是百分比—1024千字节， 1兆字节使用<code class="fe kt ku kv kw b">targetAverageUtilization</code>而不是先前使用的<code class="fe kt ku kv kw b">targetAverageUtilization</code>:</p><pre class="mr ms mt mu gt mv kw mw mx aw my bi"><span id="e561" class="mz lm iq kw b gy na nb l nc nd">...<br/>  metrics:<br/>  - type: Resource<br/>    resource:<br/>      name: cpu<br/>      targetAverageUtilization: 10<br/>  - type: Resource<br/>    resource:<br/>      name: memory<br/>      targetAverageValue: 1024Ki</span></pre><p id="6284" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">应用并检查:</p><pre class="mr ms mt mu gt mv kw mw mx aw my bi"><span id="d002" class="mz lm iq kw b gy na nb l nc nd">$ kubectl get hpa hpa-example<br/>NAME REFERENCE TARGETS MINPODS MAXPODS REPLICAS AG<br/>hpa-example Deployment/deployment-example 2551808/1Mi, 0%/10% 1 5 3 2m8s</span></pre><p id="6145" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated"><code class="fe kt ku kv kw b">REPLICAS</code> == 3现在，pod被缩放，检查来自<code class="fe kt ku kv kw b">TARGETS</code>的值-将其转换为千字节:</p><pre class="mr ms mt mu gt mv kw mw mx aw my bi"><span id="ed63" class="mz lm iq kw b gy na nb l nc nd">$ echo 2551808/1024 | bc<br/>2492</span></pre><p id="0933" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">并检查实际内存使用情况:</p><pre class="mr ms mt mu gt mv kw mw mx aw my bi"><span id="bbc0" class="mz lm iq kw b gy na nb l nc nd">$ kubectl get — raw /apis/metrics.k8s.io/v1beta1/namespaces/default/pods/deployment-example-c4d6f96db-fldl2 | jq ‘.containers[].usage.memory’<br/>“2496Ki”</span></pre><p id="9a5f" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">2492 ~= 2496Ki。</p><p id="95aa" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">好了，我们现在能够通过CPU和内存使用来扩展部署。</p><h1 id="6f61" class="ll lm iq bd ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi bi translated">自定义指标</h1><h2 id="420a" class="mz lm iq bd ln nf ng dn lr nh ni dp lv kf nj nk lz kj nl nm md kn nn no mh np bi translated">内存指标扩展</h2><p id="9209" class="pw-post-body-paragraph ju jv iq jw b jx mj jz ka kb mk kd ke kf mo kh ki kj mp kl km kn mq kp kq kr ij bi translated">除了API服务器和<code class="fe kt ku kv kw b">cAdvisor</code>提供的指标，我们可以使用任何其他指标，例如由Prometheus收集的指标。</p><p id="8d56" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">它可以是Cloudwatch导出器Prometheus的<code class="fe kt ku kv kw b">node_exporter</code>收集的指标，也可以是来自应用程序的指标。</p><p id="259a" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">文件是<a class="ae ks" href="https://github.com/kubernetes/community/blob/master/contributors/design-proposals/instrumentation/custom-metrics-api.md" rel="noopener ugc nofollow" target="_blank">这里的&gt; &gt; &gt; </a>。</p><p id="b7a8" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">由于我们正在使用Prometheus(参见<a class="ae ks" href="https://rtfm.co.ua/en/kubernetes-monitoring-with-prometheus-exporters-a-service-discovery-and-its-roles/" rel="noopener ugc nofollow" target="_blank"> Kubernetes:使用Prometheus进行监控— exporters，一个服务发现，及其角色</a>和<a class="ae ks" href="https://rtfm.co.ua/en/kubernetes-a-clusters-monitoring-with-the-prometheus-operator/" rel="noopener ugc nofollow" target="_blank"> Kubernetes:使用Prometheus操作员进行集群监控</a>)所以让我们添加它的适配器:</p><figure class="mr ms mt mu gt jr gh gi paragraph-image"><div class="gh gi nq"><img src="../Images/df482b4e8343e2c85fb48dd377cefa9c.png" data-original-src="https://miro.medium.com/v2/resize:fit:830/format:webp/0*-tx4MNLtz4vhHf_d.png"/></div></figure><p id="ee44" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">如果您现在尝试访问外部或自定义API端点，您会得到错误:</p><pre class="mr ms mt mu gt mv kw mw mx aw my bi"><span id="28ef" class="mz lm iq kw b gy na nb l nc nd">$ kubectl get — raw /apis/custom.metrics.k8s.io/<br/>Error from server (NotFound): the server could not find the requested resource</span><span id="a436" class="mz lm iq kw b gy nr nb l nc nd">$ kubectl get — raw /apis/external.metrics.k8s.io/<br/>Error from server (NotFound): the server could not find the requested resource</span></pre><p id="4af3" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">从舵图上安装适配器:</p><pre class="mr ms mt mu gt mv kw mw mx aw my bi"><span id="d433" class="mz lm iq kw b gy na nb l nc nd">$ helm install prometheus-adapter stable/prometheus-adapter<br/>NAME: prometheus-adapter<br/>LAST DEPLOYED: Sat Aug 8 13:27:36 2020<br/>NAMESPACE: default<br/>STATUS: deployed<br/>REVISION: 1<br/>TEST SUITE: None<br/>NOTES:<br/>prometheus-adapter has been deployed.</span></pre><p id="0aec" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">几分钟后，您应该能够使用以下命令列出指标:</p><pre class="mr ms mt mu gt mv kw mw mx aw my bi"><span id="695f" class="mz lm iq kw b gy na nb l nc nd">$ kubectl get — raw /apis/custom.metrics.k8s.io/v1beta</span></pre><p id="54b3" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">等待一两分钟，再次检查API:</p><pre class="mr ms mt mu gt mv kw mw mx aw my bi"><span id="7ec0" class="mz lm iq kw b gy na nb l nc nd">$ kubectl get — raw=”/apis/custom.metrics.k8s.io/v1beta1" | jq .<br/>{<br/>“kind”: “APIResourceList”,<br/>“apiVersion”: “v1”,<br/>“groupVersion”: “custom.metrics.k8s.io/v1beta1”,<br/>“resources”: []<br/>}</span></pre><p id="f6c9" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">嗯，但是为什么<code class="fe kt ku kv kw b">"resources":[]</code>是空的？</p><p id="1d93" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">检查适配器的pod日志:</p><pre class="mr ms mt mu gt mv kw mw mx aw my bi"><span id="9917" class="mz lm iq kw b gy na nb l nc nd">$ kubectl logs -f prometheus-adapter-b8945f4d8-q5t6x<br/>I0808 10:45:47.706771 1 adapter.go:94] successfully using in-cluster auth<br/>E0808 10:45:47.752737 1 provider.go:209] unable to update list of all metrics: unable to fetch metrics for query “{__name__=~\”^container_.*\”,container!=\”POD\”,namespace!=\”\”,pod!=\”\”}”: Get <a class="ae ks" href="http://prometheus.default.svc:9090/api/v1/series?match%5B%5D=%7B__name__%3D~%22%5Econtainer_.%2A%22%2Ccontainer%21%3D%22POD%22%2Cnamespace%21%3D%22%22%2Cpod%21%3D%22%22%7D&amp;start=1596882347.736:" rel="noopener ugc nofollow" target="_blank">http://prometheus.default.svc:9090/api/v1/series?match%5B%5D=%7B__name__%3D~%22%5Econtainer_.%2A%22%2Ccontainer%21%3D%22POD%22%2Cnamespace%21%3D%22%22%2Cpod%21%3D%22%22%7D&amp;start=1596882347.736:</a> dial tcp: lookup prometheus.default.svc on 172.20.0.10:53: no such host<br/>I0808 10:45:48.032873 1 serving.go:306] Generated self-signed cert (/tmp/cert/apiserver.crt, /tmp/cert/apiserver.key)<br/>…</span></pre><p id="5dce" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">错误如下:</p><blockquote class="ns nt nu"><p id="627a" class="ju jv ne jw b jx jy jz ka kb kc kd ke nv kg kh ki nw kk kl km nx ko kp kq kr ij bi translated">拨打tcp:在172.20.0.10:53上查找prometheus.default.svc:没有这样的主机</p></blockquote><p id="969f" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">让我们试着通过<code class="fe kt ku kv kw b">Service</code> DNS名称从pod访问我们的Prometheus操作员:</p><pre class="mr ms mt mu gt mv kw mw mx aw my bi"><span id="5c0b" class="mz lm iq kw b gy na nb l nc nd">$ kubectl exec -ti deployment-example-c4d6f96db-fldl2 curl prometheus-prometheus-oper-prometheus.monitoring.svc.cluster.local:9090/metrics | head -5<br/>HELP go_gc_duration_seconds A summary of the pause duration of garbage collection cycles.<br/>TYPE go_gc_duration_seconds summary<br/>go_gc_duration_seconds{quantile=”0"} 2.0078e-05<br/>go_gc_duration_seconds{quantile=”0.25"} 3.8669e-05<br/>go_gc_duration_seconds{quantile=”0.5"} 6.956e-05</span></pre><p id="a3ff" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">好的，我们可以使用<em class="ne">Prometheus-Prometheus-oper-Prometheus . monitoring . SVC . cluster . local:9090</em>URL到达它。</p><p id="a84e" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">编辑适配器的部署:</p><pre class="mr ms mt mu gt mv kw mw mx aw my bi"><span id="77a6" class="mz lm iq kw b gy na nb l nc nd">$ kubectl edit deploy prometheus-adapter</span></pre><p id="85a5" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">更新其<code class="fe kt ku kv kw b">prometheus-url</code>:</p><pre class="mr ms mt mu gt mv kw mw mx aw my bi"><span id="3f93" class="mz lm iq kw b gy na nb l nc nd">...<br/>    spec:<br/>      affinity: {}<br/>      containers:<br/>      - args:<br/>        - /adapter<br/>        - --secure-port=6443<br/>        - --cert-dir=/tmp/cert<br/>        - --logtostderr=true<br/>        - --prometheus-url=http://prometheus-prometheus-oper-prometheus.monitoring.svc.cluster.local:9090<br/>...</span></pre><p id="5a9f" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">应用更改并再次检查:</p><pre class="mr ms mt mu gt mv kw mw mx aw my bi"><span id="ef95" class="mz lm iq kw b gy na nb l nc nd">$ kubectl get — raw “/apis/custom.metrics.k8s.io/v1beta1” | jq . |grep “pods/” | head -5<br/>“name”: “pods/node_load15”,<br/>“name”: “pods/go_memstats_next_gc_bytes”,<br/>“name”: “pods/coredns_forward_request_duration_seconds_count”,<br/>“name”: “pods/rest_client_requests”,<br/>“name”: “pods/node_ipvs_incoming_bytes”,</span></pre><p id="e184" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">很好—我们已经有了我们的指标，现在可以在HPA中使用它们。</p><p id="5398" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">检查API服务器上的<code class="fe kt ku kv kw b">memory_usage_bytes</code>指标:</p><pre class="mr ms mt mu gt mv kw mw mx aw my bi"><span id="3597" class="mz lm iq kw b gy na nb l nc nd">$ kubectl get — raw=”/apis/custom.metrics.k8s.io/v1beta1/namespaces/default/pods/*/memory_usage_bytes” | jq .<br/>{<br/>“kind”: “MetricValueList”,<br/>“apiVersion”: “custom.metrics.k8s.io/v1beta1”,<br/>“metadata”: {<br/>“selfLink”: “/apis/custom.metrics.k8s.io/v1beta1/namespaces/default/pods/%2A/memory_usage_bytes”<br/>},<br/>“items”: [<br/>{<br/>“describedObject”: {<br/>“kind”: “Pod”,<br/>“namespace”: “default”,<br/>“name”: “deployment-example-c4d6f96db-8tfnw”,<br/>“apiVersion”: “/v1”<br/>},<br/>“metricName”: “memory_usage_bytes”,<br/>“timestamp”: “2020–08–08T11:18:53Z”,<br/>“value”: “11886592”,<br/>“selector”: null<br/>},<br/>…</span></pre><p id="56da" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">更新нра的清单:</p><pre class="mr ms mt mu gt mv kw mw mx aw my bi"><span id="06fa" class="mz lm iq kw b gy na nb l nc nd">apiVersion: autoscaling/v2beta1<br/>kind: HorizontalPodAutoscaler<br/>metadata:<br/>  name: hpa-example<br/>spec:<br/>  scaleTargetRef:<br/>    apiVersion: apps/v1<br/>    kind: Deployment<br/>    name: deployment-example<br/>  minReplicas: 1<br/>  maxReplicas: 5<br/>  metrics:<br/>  - type: Pods<br/>    pods:<br/>      metricName: memory_usage_bytes<br/>      targetAverageValue: 1024000</span></pre><p id="1cf0" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">现在检查HPA的值:</p><pre class="mr ms mt mu gt mv kw mw mx aw my bi"><span id="1775" class="mz lm iq kw b gy na nb l nc nd">$ kubectl get hpa hpa-example<br/>NAME REFERENCE TARGETS MINPODS MAXPODS REPLICAS AGE<br/>hpa-example Deployment/deployment-example 4694016/1Mi, 0%/10% 1 5 5 69m</span></pre><p id="f2b9" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">应用最新的更改:</p><pre class="mr ms mt mu gt mv kw mw mx aw my bi"><span id="b9b6" class="mz lm iq kw b gy na nb l nc nd">$ kubectl apply -f hpa-example.yaml<br/>horizontalpodautoscaler.autoscaling/hpa-example configured</span></pre><p id="0d9a" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">再次检查:</p><pre class="mr ms mt mu gt mv kw mw mx aw my bi"><span id="2ba4" class="mz lm iq kw b gy na nb l nc nd">$ kubectl get hpa hpa-example<br/>NAME REFERENCE TARGETS MINPODS MAXPODS REPLICAS AGE<br/>hpa-example Deployment/deployment-example 11853824/1024k 1 5 1 16s</span></pre><p id="318b" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">仍有1个副本，请检查事件:</p><pre class="mr ms mt mu gt mv kw mw mx aw my bi"><span id="cf32" class="mz lm iq kw b gy na nb l nc nd">…<br/>43s Normal ScalingReplicaSet Deployment Scaled up replica set deployment-example-c4d6f96db to 1<br/>16s Normal ScalingReplicaSet Deployment Scaled up replica set deployment-example-c4d6f96db to 4<br/>1s Normal ScalingReplicaSet Deployment Scaled up replica set deployment-example-c4d6f96db to 5<br/>16s Normal SuccessfulRescale HorizontalPodAutoscaler New size: 4; reason: pods metric memory_usage_bytes above target<br/>1s Normal SuccessfulRescale HorizontalPodAutoscaler New size: 5; reason: pods metric memory_usage_bytes above target<br/>…</span></pre><p id="e132" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">还有HPA:</p><pre class="mr ms mt mu gt mv kw mw mx aw my bi"><span id="cd1b" class="mz lm iq kw b gy na nb l nc nd">$ kubectl get hpa hpa-example<br/>NAME REFERENCE TARGETS MINPODS MAXPODS REPLICAS AGE<br/>hpa-example Deployment/deployment-example 6996787200m/1024k 1 5 5 104s</span></pre><p id="87b4" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">太好了——“管用！”</p><p id="5e1e" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">这有利于集群中已经存在的指标，比如默认情况下由cAdvisor从集群中的所有容器收集的<code class="fe kt ku kv kw b">memory_usage_bytes</code>。</p><p id="46f7" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">让我们尝试使用更多的自定义指标，例如，让我们通过使用自己的指标来扩展Gorush-server，参见<a class="ae ks" href="https://rtfm.co.ua/en/kubernetes-running-a-push-server-with-gorush-behind-an-aws-loadbalancer/" rel="noopener ugc nofollow" target="_blank"> Kubernetes:在AWS负载平衡器后面运行带有Gorush的推送服务器</a>。</p><h2 id="dd4e" class="mz lm iq bd ln nf ng dn lr nh ni dp lv kf nj nk lz kj nl nm md kn nn no mh np bi translated">基于应用的指标扩展</h2><p id="a152" class="pw-post-body-paragraph ju jv iq jw b jx mj jz ka kb mk kd ke kf mo kh ki kj mp kl km kn mq kp kq kr ij bi translated">因此，我们在集群中运行Gorush服务器，用于向移动客户端发送推送通知。</p><p id="cebd" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">它有内置的<code class="fe kt ku kv kw b">/metrics</code>端点，该端点返回可以在Prometheus中使用的标准时间序列指标。</p><p id="f6ea" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">为了运行测试Gorush服务器，我们可以使用这样的<code class="fe kt ku kv kw b">Service</code>、<code class="fe kt ku kv kw b">ConfigMap</code>和<code class="fe kt ku kv kw b">Deployment</code>:</p><pre class="mr ms mt mu gt mv kw mw mx aw my bi"><span id="09ea" class="mz lm iq kw b gy na nb l nc nd">apiVersion: v1<br/>kind: Service<br/>metadata:<br/>  name: gorush<br/>  labels:<br/>    app: gorush<br/>    tier: frontend<br/>spec:<br/>  selector:<br/>    app: gorush<br/>    tier: frontend<br/>  type: ClusterIP<br/>  ports:<br/>  - name: gorush<br/>    protocol: TCP<br/>    port: 80<br/>    targetPort: 8088<br/>---<br/>apiVersion: v1<br/>kind: ConfigMap<br/>metadata:<br/>  name: gorush-config<br/>data:<br/>  stat.engine: memory<br/>---<br/>apiVersion: apps/v1<br/>kind: Deployment<br/>metadata:<br/>  name: gorush<br/>spec:<br/>  replicas: 1<br/>  selector:<br/>    matchLabels:<br/>      app: gorush<br/>      tier: frontend<br/>  template:<br/>    metadata:<br/>      labels:<br/>        app: gorush<br/>        tier: frontend<br/>    spec:<br/>      containers:<br/>      - image: appleboy/gorush<br/>        name: gorush<br/>        imagePullPolicy: Always<br/>        ports:<br/>        - containerPort: 8088<br/>        livenessProbe:<br/>          httpGet:<br/>            path: /healthz<br/>            port: 8088<br/>          initialDelaySeconds: 3<br/>          periodSeconds: 3<br/>        env:<br/>        - name: GORUSH_STAT_ENGINE<br/>          valueFrom:<br/>            configMapKeyRef:<br/>              name: gorush-config<br/>              key: stat.engine</span></pre><p id="24ce" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">创建专用命名空间:</p><pre class="mr ms mt mu gt mv kw mw mx aw my bi"><span id="8b58" class="mz lm iq kw b gy na nb l nc nd">$ kubectl create ns eks-dev-1-gorush<br/>namespace/eks-dev-1-gorush created</span></pre><p id="b151" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">创建应用程序:</p><pre class="mr ms mt mu gt mv kw mw mx aw my bi"><span id="0f6b" class="mz lm iq kw b gy na nb l nc nd">$ kubectl -n eks-dev-1-gorush apply -f my-gorush.yaml<br/>service/gorush created<br/>configmap/gorush-config created<br/>deployment.apps/gorush created</span></pre><p id="8de7" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">检查它的豆荚:</p><pre class="mr ms mt mu gt mv kw mw mx aw my bi"><span id="ac6f" class="mz lm iq kw b gy na nb l nc nd">$ kubectl -n eks-dev-1-gorush get pod<br/>NAME READY STATUS RESTARTS AGE<br/>gorush-5c6775748b-6r54h 1/1 Running 0 83s</span></pre><p id="ff59" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">Gorush服务:</p><pre class="mr ms mt mu gt mv kw mw mx aw my bi"><span id="670d" class="mz lm iq kw b gy na nb l nc nd">$ kubectl -n eks-dev-1-gorush get svc<br/>NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE<br/>gorush ClusterIP 172.20.186.251 &lt;none&gt; 80/TCP 103s</span></pre><p id="4a6c" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">将<code class="fe kt ku kv kw b">port-forward</code>运行至其舱:</p><pre class="mr ms mt mu gt mv kw mw mx aw my bi"><span id="97ba" class="mz lm iq kw b gy na nb l nc nd">$ kubectl -n eks-dev-1-gorush port-forward gorush-5c6775748b-6r54h 8088:8088<br/>Forwarding from 127.0.0.1:8088 -&gt; 8088<br/>Forwarding from [::1]:8088 -&gt; 8088</span></pre><p id="ad03" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">检查指标:</p><pre class="mr ms mt mu gt mv kw mw mx aw my bi"><span id="1d0b" class="mz lm iq kw b gy na nb l nc nd">$ curl -s localhost:8088/metrics | grep gorush | head<br/>HELP gorush_android_fail Number of android fail count<br/>TYPE gorush_android_fail gauge<br/>gorush_android_fail 0<br/>HELP gorush_android_success Number of android success count<br/>TYPE gorush_android_success gauge<br/>gorush_android_success 0<br/>HELP gorush_ios_error Number of iOS fail count<br/>TYPE gorush_ios_error gauge<br/>gorush_ios_error 0<br/>HELP gorush_ios_success Number of iOS success count</span></pre><p id="06fb" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">或者换一种方式:利用它的<code class="fe kt ku kv kw b">Service</code>名，我们可以直接到达。</p><p id="073f" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">查找服务:</p><pre class="mr ms mt mu gt mv kw mw mx aw my bi"><span id="971d" class="mz lm iq kw b gy na nb l nc nd">$ kubectl -n eks-dev-1-gorush get svc<br/>NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE<br/>gorush ClusterIP 172.20.186.251 &lt;none&gt; 80/TCP 26m</span></pre><p id="00e2" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">API服务器的开放代理:</p><pre class="mr ms mt mu gt mv kw mw mx aw my bi"><span id="16ba" class="mz lm iq kw b gy na nb l nc nd">$ kubectl proxy — port=8080<br/>Starting to serve on 127.0.0.1:8080</span></pre><p id="c911" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">并连接到服务:</p><pre class="mr ms mt mu gt mv kw mw mx aw my bi"><span id="7f1a" class="mz lm iq kw b gy na nb l nc nd">$ curl -sL localhost:8080/api/v1/namespaces/eks-dev-1-gorush/services/gorush:gorush/proxy/metrics | head<br/>HELP go_gc_duration_seconds A summary of the GC invocation durations.<br/>TYPE go_gc_duration_seconds summary<br/>go_gc_duration_seconds{quantile=”0"} 9.194e-06<br/>go_gc_duration_seconds{quantile=”0.25"} 1.2092e-05<br/>go_gc_duration_seconds{quantile=”0.5"} 2.1812e-05<br/>go_gc_duration_seconds{quantile=”0.75"} 5.1794e-05<br/>go_gc_duration_seconds{quantile=”1"} 0.000145631<br/>go_gc_duration_seconds_sum 0.001080551<br/>go_gc_duration_seconds_count 32<br/>HELP go_goroutines Number of goroutines that currently exist.</span></pre><h2 id="0fcd" class="mz lm iq bd ln nf ng dn lr nh ni dp lv kf nj nk lz kj nl nm md kn nn no mh np bi translated">Kubernetes <code class="fe kt ku kv kw b">ServiceMonitor</code></h2><p id="76aa" class="pw-post-body-paragraph ju jv iq jw b jx mj jz ka kb mk kd ke kf mo kh ki kj mp kl km kn mq kp kq kr ij bi translated">接下来要做的是为我们的Prometheus操作员向Kubernetes集群添加一个<code class="fe kt ku kv kw b">ServiceMonitor</code>来收集这些指标，检查<a class="ae ks" href="https://rtfm.co.ua/en/kubernetes-a-clusters-monitoring-with-the-prometheus-operator/#Adding_Kubernetes_ServiceMonitor" rel="noopener ugc nofollow" target="_blank">添加Kubernetes ServiceMonitor </a>。</p><p id="7e00" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">现在使用端口转发检查指标:</p><pre class="mr ms mt mu gt mv kw mw mx aw my bi"><span id="316f" class="mz lm iq kw b gy na nb l nc nd">$ kubectl -n monitoring port-forward prometheus-prometheus-prometheus-oper-prometheus-0 9090:9090<br/>Forwarding from [::1]:9090 -&gt; 9090<br/>Forwarding from 127.0.0.1:9090 -&gt; 9090</span></pre><p id="25e4" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">尝试访问它们:</p><pre class="mr ms mt mu gt mv kw mw mx aw my bi"><span id="6518" class="mz lm iq kw b gy na nb l nc nd">$ curl “localhost:9090/api/v1/series?match[]=gorush_total_push_count&amp;start=1597141864”<br/>{“status”:”success”,”data”:[]}</span></pre><p id="17b0" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated"><code class="fe kt ku kv kw b">"data":[]</code>现在是空的——或者普罗米修斯还没有收集那些指标。</p><p id="0220" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">定义<code class="fe kt ku kv kw b">ServiceMonitor</code>:</p><pre class="mr ms mt mu gt mv kw mw mx aw my bi"><span id="45f9" class="mz lm iq kw b gy na nb l nc nd">apiVersion: monitoring.coreos.com/v1<br/>kind: ServiceMonitor<br/>metadata:<br/>  labels:<br/>    serviceapp: gorush-servicemonitor<br/>    release: prometheus<br/>  name: gorush-servicemonitor<br/>  namespace: monitoring<br/>spec:     <br/>  endpoints:<br/>  - bearerTokenFile: /var/run/secrets/kubernetes.io/serviceaccount/token<br/>    interval: 15s<br/>    port: gorush<br/>  namespaceSelector:<br/>    matchNames: <br/>    - eks-dev-1-gorush<br/>  selector: <br/>    matchLabels:<br/>      app: gorush</span></pre><p id="9ba6" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated"><strong class="jw ir"> <em class="ne">注</em> </strong> <em class="ne">:普罗米修斯资源包括一个名为</em> <code class="fe kt ku kv kw b"><em class="ne">serviceMonitorSelector</em></code> <em class="ne">的字段，定义了要使用的服务监视器的选择。默认情况下，在版本</em> <code class="fe kt ku kv kw b"><em class="ne">v0.19.0</em></code> <em class="ne">之前，ServiceMonitors必须安装在与Prometheus实例相同的名称空间中。使用Prometheus操作符</em> <code class="fe kt ku kv kw b"><em class="ne">v0.19.0</em></code> <em class="ne">和更高版本，可以通过Prometheus资源的</em> <code class="fe kt ku kv kw b"><em class="ne">serviceMonitorNamespaceSelector</em></code> <em class="ne">字段在Prometheus名称空间之外选择ServiceMonitors。</em> <br/> <em class="ne">见</em> <a class="ae ks" href="https://github.com/prometheus-operator/prometheus-operator/blob/master/Documentation/user-guides/getting-started.md" rel="noopener ugc nofollow" target="_blank"> <em class="ne">普罗米修斯算子</em> </a></p><p id="fbda" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">创建此ServiceMonitor:</p><pre class="mr ms mt mu gt mv kw mw mx aw my bi"><span id="810b" class="mz lm iq kw b gy na nb l nc nd">$ kubectl apply -f ../../gorush-service-monitor.yaml<br/>servicemonitor.monitoring.coreos.com/gorush-servicemonitor created</span></pre><p id="e87a" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">在<em class="ne">目标</em>中检查:</p><figure class="mr ms mt mu gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="nz oa di ob bf oc"><div class="gh gi ny"><img src="../Images/4c3c4848daf947dcbe9c969b50332951.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*y54Jyx_-wICOnn8v.png"/></div></div></figure><p id="f2cd" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated"><em class="ne">上升</em>，好。</p><p id="c31c" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">几分钟后，再次检查指标:</p><pre class="mr ms mt mu gt mv kw mw mx aw my bi"><span id="63e3" class="mz lm iq kw b gy na nb l nc nd">$ curl “localhost:9090/api/v1/series?match[]=gorush_total_push_count&amp;start=1597141864”<br/>{“status”:”success”,”data”:[{“__name__”:”gorush_total_push_count”,”endpoint”:”gorush”,”instance”:”10.3.35.14:8088",”job”:”gorush”,”namespace”:”eks-dev-1-gorush”,”pod”:”gorush-5c6775748b-6r54h”,”service”:”gorush”}]}</span></pre><p id="a18a" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">或者这样:</p><pre class="mr ms mt mu gt mv kw mw mx aw my bi"><span id="46a7" class="mz lm iq kw b gy na nb l nc nd">$ curl -s localhost:9090/api/v1/label/__name__/values | jq | grep gorush<br/>“gorush_android_fail”,<br/>“gorush_android_success”,<br/>“gorush_ios_error”,<br/>“gorush_ios_success”,<br/>“gorush_queue_usage”,<br/>“gorush_total_push_count”,</span></pre><p id="cd2d" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">很好，我们已经得到了我们的指标，让我们继续在本次部署的<code class="fe kt ku kv kw b">HorizontalPodAutoscaler</code>中使用它们。</p><p id="da76" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">查看此处提供的指标组:</p><pre class="mr ms mt mu gt mv kw mw mx aw my bi"><span id="1660" class="mz lm iq kw b gy na nb l nc nd">$ kubectl get — raw “/apis/custom.metrics.k8s.io/v1beta1” | jq . | grep “gorush”<br/>“name”: “services/gorush_android_success”,<br/>“name”: “pods/gorush_android_fail”,<br/>“name”: “namespaces/gorush_total_push_count”,<br/>“name”: “namespaces/gorush_queue_usage”,<br/>“name”: “pods/gorush_ios_success”,<br/>“name”: “namespaces/gorush_ios_success”,<br/>“name”: “jobs.batch/gorush_ios_error”,<br/>“name”: “services/gorush_total_push_count”,<br/>“name”: “jobs.batch/gorush_queue_usage”,<br/>“name”: “pods/gorush_queue_usage”,<br/>“name”: “jobs.batch/gorush_android_fail”,<br/>“name”: “services/gorush_queue_usage”,<br/>“name”: “services/gorush_ios_success”,<br/>“name”: “jobs.batch/gorush_android_success”,<br/>“name”: “jobs.batch/gorush_total_push_count”,<br/>“name”: “pods/gorush_ios_error”,<br/>“name”: “pods/gorush_total_push_count”,<br/>“name”: “pods/gorush_android_success”,<br/>“name”: “namespaces/gorush_android_success”,<br/>“name”: “namespaces/gorush_android_fail”,<br/>“name”: “namespaces/gorush_ios_error”,<br/>“name”: “jobs.batch/gorush_ios_success”,<br/>“name”: “services/gorush_ios_error”,<br/>“name”: “services/gorush_android_fail”,</span></pre><p id="43a2" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">添加带有HPA的新清单，HPA将使用来自<code class="fe kt ku kv kw b">Pods</code>组的<code class="fe kt ku kv kw b">gorush_queue_usage</code>:</p><pre class="mr ms mt mu gt mv kw mw mx aw my bi"><span id="06c2" class="mz lm iq kw b gy na nb l nc nd">apiVersion: autoscaling/v2beta1<br/>kind: HorizontalPodAutoscaler<br/>metadata:<br/>  name: gorush-hpa<br/>spec:<br/>  scaleTargetRef:<br/>    apiVersion: apps/v1<br/>    kind: Deployment<br/>    name: gorush<br/>  minReplicas: 1<br/>  maxReplicas: 5<br/>  metrics:<br/>  - type: Pods<br/>    pods:<br/>      metricName: gorush_total_push_count<br/>      targetAverageValue: 2</span></pre><p id="f815" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">通过这样的设置，一旦<code class="fe kt ku kv kw b">gorush_total_push_count</code>的值超过<em class="ne"> 2 </em>，HPA必须缩放吊舱。</p><p id="bf92" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">创建它:</p><pre class="mr ms mt mu gt mv kw mw mx aw my bi"><span id="ab9c" class="mz lm iq kw b gy na nb l nc nd">$ kubectl -n eks-dev-1-gorush apply -f my-gorush.yaml<br/>service/gorush unchanged<br/>configmap/gorush-config unchanged<br/>deployment.apps/gorush unchanged<br/>horizontalpodautoscaler.autoscaling/gorush-hpa created</span></pre><p id="53ce" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">立即检查其价值:</p><pre class="mr ms mt mu gt mv kw mw mx aw my bi"><span id="ffb4" class="mz lm iq kw b gy na nb l nc nd">$ kubectl get — raw=”/apis/custom.metrics.k8s.io/v1beta1/namespaces/eks-dev-1-gorush/pods/*/gorush_total_push_count” | jq ‘.items[].value’<br/>“0”</span></pre><p id="4e99" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">检查нра:</p><pre class="mr ms mt mu gt mv kw mw mx aw my bi"><span id="c08d" class="mz lm iq kw b gy na nb l nc nd">$ kubectl -n eks-dev-1-gorush get hpa<br/>NAME REFERENCE TARGETS MINPODS MAXPODS REPLICAS AGE<br/>gorush-hpa Deployment/gorush 0/1 1 5 1 17s</span></pre><p id="8148" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated"><code class="fe kt ku kv kw b">TARGETS</code> <em class="ne"> 0/1 </em>，好的。</p><p id="4592" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">发送推送:</p><pre class="mr ms mt mu gt mv kw mw mx aw my bi"><span id="7697" class="mz lm iq kw b gy na nb l nc nd">$ curl -X POST a6095d18859c849889531cf08baa6bcf-531932299.us-east-2.elb.amazonaws.com/api/push -d ‘{“notifications”:[{“tokens”:[“990004543798742”],”platform”:2,”message”:”Hello Android”}]}’<br/>{“counts”:1,”logs”:[],”success”:”ok”}</span></pre><p id="defd" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">再次检查<code class="fe kt ku kv kw b">gorush_total_push_count</code>度量:</p><pre class="mr ms mt mu gt mv kw mw mx aw my bi"><span id="abed" class="mz lm iq kw b gy na nb l nc nd">$ kubectl get — raw=”/apis/custom.metrics.k8s.io/v1beta1/namespaces/eks-dev-1-gorush/pods/*/gorush_total_push_count” | jq ‘.items[].value’<br/>“1”</span></pre><p id="40fe" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">已发送一条推送消息。</p><p id="bb79" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">再次检查HPA:</p><pre class="mr ms mt mu gt mv kw mw mx aw my bi"><span id="feab" class="mz lm iq kw b gy na nb l nc nd">$ kubectl -n eks-dev-1-gorush get hpa<br/>NAME REFERENCE TARGETS MINPODS MAXPODS REPLICAS AGE<br/>gorush-hpa Deployment/gorush 1/2 1 5 1 9m42s</span></pre><p id="160e" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated"><code class="fe kt ku kv kw b">TARGETS</code> <em class="ne"> 1/2 </em>，<code class="fe kt ku kv kw b">REPLICAS</code>仍有1，发送另一个推送并检查事件:</p><pre class="mr ms mt mu gt mv kw mw mx aw my bi"><span id="f8a5" class="mz lm iq kw b gy na nb l nc nd">$ kubectl -n eks-dev-1-gorush get events — watch<br/>LAST SEEN TYPE REASON KIND MESSAGE<br/>18s Normal Scheduled Pod Successfully assigned eks-dev-1-gorush/gorush-5c6775748b-x8fjs to ip-10–3–49–200.us-east-2.compute.internal<br/>17s Normal Pulling Pod Pulling image “appleboy/gorush”<br/>17s Normal Pulled Pod Successfully pulled image “appleboy/gorush”<br/>17s Normal Created Pod Created container gorush<br/>17s Normal Started Pod Started container gorush<br/>18s Normal SuccessfulCreate ReplicaSet Created pod: gorush-5c6775748b-x8fjs<br/>18s Normal SuccessfulRescale HorizontalPodAutoscaler New size: 2; reason: pods metric gorush_total_push_count above target<br/>18s Normal ScalingReplicaSet Deployment Scaled up replica set gorush-5c6775748b to 2</span></pre><p id="af4e" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">以及住房津贴:</p><pre class="mr ms mt mu gt mv kw mw mx aw my bi"><span id="373f" class="mz lm iq kw b gy na nb l nc nd">$ kubectl -n eks-dev-1-gorush get hpa<br/>NAME REFERENCE TARGETS MINPODS MAXPODS REPLICAS AGE<br/>gorush-hpa Deployment/gorush 3/2 1 5 2 10m</span></pre><p id="3c73" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">太好了！因此，通过<code class="fe kt ku kv kw b">gorush_total_push_count</code>进行缩放是可行的。</p><p id="8076" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">但是这里有一个陷阱:<code class="fe kt ku kv kw b">gorush_total_push_count</code>是累积指标，例如，在生产图上，它看起来像下面这样:</p><figure class="mr ms mt mu gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="nz oa di ob bf oc"><div class="gh gi od"><img src="../Images/0fa7545b4f80b31d09a2a81b6f490de1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*iWSRALPylq6FeVjC.png"/></div></div></figure><p id="f742" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">在这种情况下，我们的HPA将会扩展豆荚直到时间的尽头。</p><h2 id="b7de" class="mz lm iq bd ln nf ng dn lr nh ni dp lv kf nj nk lz kj nl nm md kn nn no mh np bi translated">普罗米修斯适配器<code class="fe kt ku kv kw b">ConfigMap</code> - <code class="fe kt ku kv kw b">seriesQuery</code>和<code class="fe kt ku kv kw b">metricsQuery</code></h2><p id="e168" class="pw-post-body-paragraph ju jv iq jw b jx mj jz ka kb mk kd ke kf mo kh ki kj mp kl km kn mq kp kq kr ij bi translated">为了减轻这种情况，让我们添加一个自己的指标。</p><p id="ad74" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">普罗米修斯适配器有自己的<code class="fe kt ku kv kw b">ConfigMap</code>:</p><pre class="mr ms mt mu gt mv kw mw mx aw my bi"><span id="2233" class="mz lm iq kw b gy na nb l nc nd">$ kubectl get cm prometheus-adapter<br/>NAME DATA AGE<br/>prometheus-adapter 1 46h</span></pre><p id="2782" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">其中包含了<code class="fe kt ku kv kw b">config.yaml</code>，这里见其例<a class="ae ks" href="https://github.com/DirectXMan12/k8s-prometheus-adapter/blob/master/docs/sample-config.yaml" rel="noopener ugc nofollow" target="_blank">&gt;&gt;&gt;</a>。</p><p id="7f8a" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">创建一个<a class="ae ks" href="https://prometheus.io/docs/prometheus/latest/querying/basics/" rel="noopener ugc nofollow" target="_blank"> PromQL </a>查询，该查询将返回每秒的推送计数:</p><pre class="mr ms mt mu gt mv kw mw mx aw my bi"><span id="d797" class="mz lm iq kw b gy na nb l nc nd">rate(gorush_total_push_count{instance="push.server.com:80",job="push-server"}[5m])</span></pre><figure class="mr ms mt mu gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="nz oa di ob bf oc"><div class="gh gi od"><img src="../Images/0f7b56dd22a3a766556aa34bcb88b486.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*gaZQKuCcWCdNYj-C.png"/></div></div></figure><p id="284a" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">更新<code class="fe kt ku kv kw b">ConfigMap</code>并在那里添加新的查询:</p><pre class="mr ms mt mu gt mv kw mw mx aw my bi"><span id="0dfd" class="mz lm iq kw b gy na nb l nc nd">apiVersion: v1<br/>data:<br/>  config.yaml: |<br/>    rules:<br/>    - seriesQuery: '{__name__=~"gorush_total_push_count"}'<br/>      seriesFilters: []<br/>      resources:<br/>        overrides:<br/>          namespace:<br/>            resource: namespace<br/>          pod:<br/>            resource: pod<br/>      name:<br/>        matches: ""<br/>        as: "gorush_push_per_second"<br/>      metricsQuery: rate(&lt;&lt;.Series&gt;&gt;{&lt;&lt;.LabelMatchers&gt;&gt;}[5m])</span></pre><p id="d81c" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">保存并退出，检查它:</p><pre class="mr ms mt mu gt mv kw mw mx aw my bi"><span id="7bfd" class="mz lm iq kw b gy na nb l nc nd">$ kubectl get — raw=”/apis/custom.metrics.k8s.io/v1beta1/namespaces/eks-dev-1-gorush/pods/*/gorush_push_per_second” | jq<br/>Error from server (NotFound): the server could not find the metric gorush_push_per_second for pods</span></pre><p id="cb1d" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">重新创建pod，使其应用更改(参见<a class="ae ks" href="https://rtfm.co.ua/en/kubernetes-configmap-and-secrets-data-auto-reload-in-pods/" rel="noopener ugc nofollow" target="_blank"> Kubernetes:配置图和机密pod中的数据自动重新加载</a>):</p><pre class="mr ms mt mu gt mv kw mw mx aw my bi"><span id="f6fb" class="mz lm iq kw b gy na nb l nc nd">$ kubectl delete pod prometheus-adapter-7c56787c5c-kllq6<br/>pod “prometheus-adapter-7c56787c5c-kllq6” deleted</span></pre><p id="fcb9" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">检查一下:</p><pre class="mr ms mt mu gt mv kw mw mx aw my bi"><span id="edba" class="mz lm iq kw b gy na nb l nc nd">$ kubectl get — raw=”/apis/custom.metrics.k8s.io/v1beta1/namespaces/eks-dev-1-gorush/pods/*/gorush_push_per_second” | jq<br/>{<br/>“kind”: “MetricValueList”,<br/>“apiVersion”: “custom.metrics.k8s.io/v1beta1”,<br/>“metadata”: {<br/>“selfLink”: “/apis/custom.metrics.k8s.io/v1beta1/namespaces/eks-dev-1-gorush/pods/%2A/gorush_push_per_second”<br/>},<br/>“items”: [<br/>{<br/>“describedObject”: {<br/>“kind”: “Pod”,<br/>“namespace”: “eks-dev-1-gorush”,<br/>“name”: “gorush-5c6775748b-6r54h”,<br/>“apiVersion”: “/v1”<br/>},<br/>“metricName”: “gorush_push_per_second”,<br/>“timestamp”: “2020–08–11T12:28:03Z”,<br/>“value”: “0”,<br/>“selector”: null<br/>},<br/>…</span></pre><p id="5a46" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">更新нра以使用<code class="fe kt ku kv kw b">gorush_push_per_second</code>:</p><pre class="mr ms mt mu gt mv kw mw mx aw my bi"><span id="e605" class="mz lm iq kw b gy na nb l nc nd">apiVersion: autoscaling/v2beta1<br/>kind: HorizontalPodAutoscaler<br/>metadata:<br/>  name: gorush-hpa<br/>spec:<br/>  scaleTargetRef:<br/>    apiVersion: apps/v1<br/>    kind: Deployment<br/>    name: gorush<br/>  minReplicas: 1<br/>  maxReplicas: 5<br/>  metrics:<br/>  - type: Pods<br/>    pods:<br/>      metricName: gorush_push_per_second<br/>      targetAverageValue: 1m</span></pre><p id="8089" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">检查一下:</p><pre class="mr ms mt mu gt mv kw mw mx aw my bi"><span id="4360" class="mz lm iq kw b gy na nb l nc nd">$ kubectl -n eks-dev-1-gorush get hpa<br/>NAME REFERENCE TARGETS MINPODS MAXPODS REPLICAS AGE<br/>gorush-hpa Deployment/gorush 0/1m 1 5 1 68m</span></pre><p id="777e" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">事件:</p><pre class="mr ms mt mu gt mv kw mw mx aw my bi"><span id="6760" class="mz lm iq kw b gy na nb l nc nd">…<br/>0s Normal SuccessfulRescale HorizontalPodAutoscaler New size: 4; reason: pods metric gorush_push_per_second above target<br/>0s Normal ScalingReplicaSet Deployment Scaled up replica set gorush-5c6775748b to 4<br/>…</span></pre><p id="ef0e" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">还有现在的自置居所津贴:</p><pre class="mr ms mt mu gt mv kw mw mx aw my bi"><span id="ca2e" class="mz lm iq kw b gy na nb l nc nd">$ kubectl -n eks-dev-1-gorush get hpa<br/>NAME REFERENCE TARGETS MINPODS MAXPODS REPLICAS AGE<br/>gorush-hpa Deployment/gorush 11m/1m 1 5 5 70m</span></pre><p id="89cc" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">完成了。</p><h1 id="271d" class="ll lm iq bd ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi bi translated">有用的链接</h1><ul class=""><li id="ef7c" class="kx ky iq jw b jx mj kb mk kf ml kj mm kn mn kr lc ld le lf bi translated"><a class="ae ks" href="https://www.replex.io/blog/kubernetes-in-production-best-practices-for-cluster-autoscaler-hpa-and-vpa" rel="noopener ugc nofollow" target="_blank"> Kubernetes生产中的自动伸缩:集群自动伸缩、HPA和VPA的最佳实践</a></li><li id="986d" class="kx ky iq jw b jx lg kb lh kf li kj lj kn lk kr lc ld le lf bi translated"><a class="ae ks" href="https://medium.com/dev-genius/ultimate-kubernetes-resource-planning-guide-449a4fddd1d6" rel="noopener">终极Kubernetes资源规划指南</a></li><li id="ab30" class="kx ky iq jw b jx lg kb lh kf li kj lj kn lk kr lc ld le lf bi translated"><a class="ae ks" href="https://dev.to/cdennig/horizontal-autoscaling-in-kubernetes-2-custom-metrics-549k" rel="noopener ugc nofollow" target="_blank">Kubernetes # 2中的水平自动缩放—自定义指标</a></li><li id="7a8f" class="kx ky iq jw b jx lg kb lh kf li kj lj kn lk kr lc ld le lf bi translated"><a class="ae ks" href="https://blog.kloia.com/kubernetes-hpa-externalmetrics-prometheus-acb1d8a4ed50" rel="noopener ugc nofollow" target="_blank">Kubernetes HPA:external metrics+Prometheus</a></li><li id="666a" class="kx ky iq jw b jx lg kb lh kf li kj lj kn lk kr lc ld le lf bi translated"><a class="ae ks" href="https://rancher.com/docs/rancher/v2.x/en/cluster-admin/tools/monitoring/custom-metrics/" rel="noopener ugc nofollow" target="_blank">普罗米修斯定制度量适配器</a></li><li id="934c" class="kx ky iq jw b jx lg kb lh kf li kj lj kn lk kr lc ld le lf bi translated"><a class="ae ks" href="https://medium.com/@ranrubin/horizontal-pod-autoscaling-hpa-triggered-by-kafka-event-f30fe99f3948" rel="noopener">Kafka事件触发的水平Pod自动缩放(HPA)</a></li><li id="2cab" class="kx ky iq jw b jx lg kb lh kf li kj lj kn lk kr lc ld le lf bi translated"><a class="ae ks" href="https://cloud.google.com/kubernetes-engine/docs/concepts/custom-and-external-metrics" rel="noopener ugc nofollow" target="_blank">自动扩展工作负载的自定义和外部指标</a></li><li id="c4e8" class="kx ky iq jw b jx lg kb lh kf li kj lj kn lk kr lc ld le lf bi translated"><a class="ae ks" href="https://www.metricfire.com/blog/prometheus-metrics-based-autoscaling-in-kubernetes/" rel="noopener ugc nofollow" target="_blank">Kubernetes中基于普罗米修斯度量的自动缩放</a></li><li id="bb9b" class="kx ky iq jw b jx lg kb lh kf li kj lj kn lk kr lc ld le lf bi translated"><a class="ae ks" href="https://cloud.google.com/blog/products/gcp/kubernetes-best-practices-resource-requests-and-limits" rel="noopener ugc nofollow" target="_blank"> Kubernetes最佳实践:资源请求和限制</a></li><li id="5cf8" class="kx ky iq jw b jx lg kb lh kf li kj lj kn lk kr lc ld le lf bi translated"><a class="ae ks" href="https://ealebed.github.io/posts/2019/%D0%B7%D0%BD%D0%B0%D0%BA%D0%BE%D0%BC%D1%81%D1%82%D0%B2%D0%BE-%D1%81-kubernetes-%D1%87%D0%B0%D1%81%D1%82%D1%8C-19-horizontalpodautoscaler/" rel="noopener ugc nofollow" target="_blank">знакомствосKubernetes。часть19号:水平自动缩放器</a></li><li id="b8fb" class="kx ky iq jw b jx lg kb lh kf li kj lj kn lk kr lc ld le lf bi translated"><a class="ae ks" href="https://dzone.com/articles/how-to-use-kubernetes-for-autoscaling" rel="noopener ugc nofollow" target="_blank">如何使用Kubernetes进行自动缩放</a></li><li id="df3e" class="kx ky iq jw b jx lg kb lh kf li kj lj kn lk kr lc ld le lf bi translated"><a class="ae ks" href="https://koudingspawn.de/kubernetes-autoscaling/" rel="noopener ugc nofollow" target="_blank">通过内存自动缩放水平Pod</a></li><li id="3391" class="kx ky iq jw b jx lg kb lh kf li kj lj kn lk kr lc ld le lf bi translated"><a class="ae ks" rel="noopener ugc nofollow" target="_blank" href="/autoscaling-apps-on-kubernetes-with-the-horizontal-pod-autoscaler-798750ab7847">使用水平窗格自动缩放器自动缩放Kubernetes上的应用</a></li><li id="0b99" class="kx ky iq jw b jx lg kb lh kf li kj lj kn lk kr lc ld le lf bi translated"><a class="ae ks" href="https://banzaicloud.com/blog/k8s-horizontal-pod-autoscaler/" rel="noopener ugc nofollow" target="_blank">根据自定义指标水平自动扩展Kubernetes部署</a></li><li id="e8ab" class="kx ky iq jw b jx lg kb lh kf li kj lj kn lk kr lc ld le lf bi translated"><a class="ae ks" href="https://sysdig.com/blog/kubernetes-autoscaler/" rel="noopener ugc nofollow" target="_blank">使用自定义指标的Kubernetes pod自动缩放器</a></li><li id="a636" class="kx ky iq jw b jx lg kb lh kf li kj lj kn lk kr lc ld le lf bi translated"><a class="ae ks" href="https://medium.com/uptime-99/kubernetes-hpa-autoscaling-with-custom-and-external-metrics-da7f41ff7846" rel="noopener"> Kubernetes HPA使用自定义和外部指标进行自动扩展</a></li><li id="f229" class="kx ky iq jw b jx lg kb lh kf li kj lj kn lk kr lc ld le lf bi translated"><a class="ae ks" href="https://www.ibm.com/support/knowledgecenter/en/SSBS6K_3.1.0/manage_cluster/hpa.html" rel="noopener ugc nofollow" target="_blank">使用自定义指标自动缩放水平窗格</a></li><li id="8709" class="kx ky iq jw b jx lg kb lh kf li kj lj kn lk kr lc ld le lf bi translated"><a class="ae ks" rel="noopener ugc nofollow" target="_blank" href="/horizontal-pod-autoscale-with-custom-metrics-8cb13e9d475">带自定义普罗米修斯指标的水平Pod自动缩放</a></li><li id="64ad" class="kx ky iq jw b jx lg kb lh kf li kj lj kn lk kr lc ld le lf bi translated"><a class="ae ks" href="https://medium.com/@avkanumuri/kubernetes-hpa-using-custom-metrics-b14d70e50818" rel="noopener">使用自定义指标的Kubernetes HPA</a></li><li id="60c7" class="kx ky iq jw b jx lg kb lh kf li kj lj kn lk kr lc ld le lf bi translated"><a class="ae ks" href="https://icicimov.github.io/blog/kubernetes/Kubernetes_HPA_Autoscaling_with_Custom_Metrics/" rel="noopener ugc nofollow" target="_blank"> Kubernetes HPA使用自定义指标自动扩展</a></li><li id="617c" class="kx ky iq jw b jx lg kb lh kf li kj lj kn lk kr lc ld le lf bi translated"><a class="ae ks" href="https://nuvalence.io/building-a-k8s-autoscaler-with-custom-metrics/" rel="noopener ugc nofollow" target="_blank">使用自定义指标构建K8s自动缩放器</a></li></ul></div><div class="ab cl oe of hu og" role="separator"><span class="oh bw bk oi oj ok"/><span class="oh bw bk oi oj ok"/><span class="oh bw bk oi oj"/></div><div class="ij ik il im in"><p id="01bd" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated"><em class="ne">原发表于</em> <a class="ae ks" href="https://rtfm.co.ua/en/kubernetes-horizontalpodautoscaler-an-overview-with-examples/" rel="noopener ugc nofollow" target="_blank"> <em class="ne"> RTFM: Linux，devo PSисистемноеадммитииииииованниое</em></a>T30。</p></div></div>    
</body>
</html>