<html>
<head>
<title>Proxying Amazon PostgreSQL on OpenShift with PGPool</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">利用PGPool在OpenShift上代理Amazon PostgreSQL</h1>
<blockquote>原文：<a href="https://itnext.io/proxying-amazon-postgresql-on-openshift-with-pgpool-fb3a9be03583?source=collection_archive---------6-----------------------#2019-07-22">https://itnext.io/proxying-amazon-postgresql-on-openshift-with-pgpool-fb3a9be03583?source=collection_archive---------6-----------------------#2019-07-22</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><figure class="gl gn jr js jt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi jq"><img src="../Images/2c4e672ebef0bdbaf3fd8b84004792c9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*BOO1vUGw6hBk3BwG"/></div></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated">安娜在<a class="ae kf" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</figcaption></figure><p id="20d9" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">因此，您已经构建了一个使用<a class="ae kf" href="https://www.postgresql.org/" rel="noopener ugc nofollow" target="_blank"> PostgreSQL </a>数据库的生产应用程序。在开发阶段，您可能一直在使用计算机上的本地数据库，或者使用<a class="ae kf" href="https://hub.docker.com/_/postgres" rel="noopener ugc nofollow" target="_blank"> Docker </a>实例，或者可能使用<a class="ae kf" href="https://docs.openshift.com/container-platform/4.1/nodes/containers/nodes-containers-port-forwarding.html" rel="noopener ugc nofollow" target="_blank">端口转发</a>将数据库从您的<a class="ae kf" href="https://www.okd.io/minishift/" rel="noopener ugc nofollow" target="_blank">小型班</a>或开发<a class="ae kf" href="https://www.openshift.com/" rel="noopener ugc nofollow" target="_blank"> OpenShift </a>集群转储。然而，进入生产部署阶段后，您不再部署<em class="le"> PostgreSQL </em> pod，而是使用远程数据库，就像<a class="ae kf" href="https://aws.amazon.com/rds/postgresql/" rel="noopener ugc nofollow" target="_blank"> Amazon远程数据库服务(RDS)对PostgreSQL </a>那样。在生产环境中，最佳做法是将对数据库的网络访问限制为仅从<a class="ae kf" href="https://aws.amazon.com/vpc/" rel="noopener ugc nofollow" target="_blank">虚拟私有云(VPC) </a>内部进行。此外，您还可以合并一个<a class="ae kf" href="https://docs.aws.amazon.com/AmazonRDS/latest/UserGuide/UsingWithRDS.SSL.html" rel="noopener ugc nofollow" target="_blank"> SSL证书</a>，以进一步确保数据库连接的安全，从而避免“流氓”连接。</p><figure class="lg lh li lj gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi lf"><img src="../Images/a9ea8f52bb27749343a07b8ba62f9b5c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*_Da7yh_h4bwpPTfR"/></div></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated"><a class="ae kf" href="https://unsplash.com/@jsalvino?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">约翰·萨尔维诺</a>在<a class="ae kf" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</figcaption></figure><p id="34aa" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">每隔一段时间，您只能调试特定数据集的客户问题。然而，在这种封闭的环境中，选择有限:</p><ul class=""><li id="466e" class="lk ll it ki b kj kk kn ko kr lm kv ln kz lo ld lp lq lr ls bi translated">增加日志记录，希望捕捉相关数据。</li><li id="682d" class="lk ll it ki b kj lt kn lu kr lv kv lw kz lx ld lp lq lr ls bi translated">尝试通过反复试验生成有效数据集。</li><li id="cc56" class="lk ll it ki b kj lt kn lu kr lv kv lw kz lx ld lp lq lr ls bi translated">创建一个副本数据库或<a class="ae kf" href="https://www.postgresql.org/docs/10/app-pgdump.html" rel="noopener ugc nofollow" target="_blank"> pg_dump </a>的数据进行重新创建。</li></ul><p id="1787" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">前两个选项需要时间，可能不会带来太大的成功。第三种选择也很耗时，存在安全风险，而且成本很高，尤其是在多租户数据库环境中。在开发调试场景中，开发人员只需使用<em class="le"> OpenShift </em>的端口转发功能直接连接到<em class="le"> PostgreSQL </em> pod，并使用调试器或使用<a class="ae kf" href="https://www.postgresql.org/docs/9.3/app-psql.html" rel="noopener ugc nofollow" target="_blank"> psql </a>检查SQL语句来单步调试应用程序逻辑。想象一下，如果您可以像开发场景那样与远程数据库进行交互，但又不放弃您已经设置的所有安全限制，这将是多么了不起的进步。</p><figure class="lg lh li lj gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi ly"><img src="../Images/6c8a77d16b5cb014e364446a243715db.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*Q2wkVawHn225fkgV"/></div></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated">奥斯曼·拉纳在<a class="ae kf" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</figcaption></figure><h1 id="17e7" class="lz ma it bd mb mc md me mf mg mh mi mj mk ml mm mn mo mp mq mr ms mt mu mv mw bi translated">代理PostgreSQL</h1><p id="01df" class="pw-post-body-paragraph kg kh it ki b kj mx kl km kn my kp kq kr mz kt ku kv na kx ky kz nb lb lc ld im bi translated"><a class="ae kf" href="https://www.pgpool.net/mediawiki/index.php/Main_Page" rel="noopener ugc nofollow" target="_blank"> Pgpool-II </a>有助于使上述生产调试成为可能。“Pgpool-II是一个在PostgreSQL服务器和PostgreSQL数据库客户端之间工作的中间件”。Pgpool-II提供了几个功能，包括:连接池、复制、负载平衡、限制超出连接、看门狗和内存查询缓存。但是，我们将重点关注它作为生产数据库代理的能力。接下来，让我们看看如何将一个<em class="le"> Pgpool-II </em>容器部署到我们的<em class="le"> OpenShift </em>环境中来支持这个交互流。</p><h1 id="5bbd" class="lz ma it bd mb mc md me mf mg mh mi mj mk ml mm mn mo mp mq mr ms mt mu mv mw bi translated">在OpenShift上运行Pgpool-II</h1><p id="ab6f" class="pw-post-body-paragraph kg kh it ki b kj mx kl km kn my kp kq kr mz kt ku kv na kx ky kz nb lb lc ld im bi translated"><a class="ae kf" href="https://www.crunchydata.com/" rel="noopener ugc nofollow" target="_blank"> Crunchy Data </a>，这是一家企业<em class="le"> PostgreSQL </em>解决方案公司，提供了几个<a class="ae kf" href="https://crunchydata.github.io/crunchy-containers/stable/" rel="noopener ugc nofollow" target="_blank">基于容器的部署</a>，其中<em class="le"> Pgpool-II </em>包括在内。<a class="ae kf" href="https://github.com/CrunchyData/crunchy-containers" rel="noopener ugc nofollow" target="_blank"> crunchy-containers </a>存储库示例为<em class="le"> Docker </em>、<a class="ae kf" href="https://helm.sh/" rel="noopener ugc nofollow" target="_blank"> Helm </a>和<a class="ae kf" href="https://kubernetes.io/" rel="noopener ugc nofollow" target="_blank">Kubernetes</a>/<em class="le">open shift</em>提供部署。假设<em class="le"> PostgreSQL </em>数据库的主机名、用户名、密码和SSL证书存储在<em class="le"> OpenShift </em> secret中，我们将逐步完成部署到<em class="le"> OpenShift </em>的必要步骤。</p><div class="nc nd gp gr ne nf"><a href="https://github.com/chambridge/openshift-pgpool" rel="noopener  ugc nofollow" target="_blank"><div class="ng ab fo"><div class="nh ab ni cl cj nj"><h2 class="bd iu gy z fp nk fr fs nl fu fw is bi translated">chambridge/openshift-pgpool</h2><div class="nm l"><h3 class="bd b gy z fp nk fr fs nl fu fw dk translated">将Crunchy Data pgpool部署到OpenShift的部署步骤，以及用于生成配置数据的脚本。…</h3></div><div class="nn l"><p class="bd b dl z fp nk fr fs nl fu fw dk translated">github.com</p></div></div><div class="no l"><div class="np l nq nr ns no nt jz nf"/></div></div></a></div><p id="6540" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">上面的存储库提供了部署步骤和脚本，这些步骤和脚本构建在部署到<em class="le"> OpenShift </em>的<em class="le">易碎数据</em>示例之上。</p><pre class="lg lh li lj gt nu nv nw nx aw ny bi"><span id="1a75" class="nz ma it nv b gy oa ob l oc od">git clone git@github.com:chambridge/openshift-pgpool.git</span></pre><p id="03eb" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">从这里开始，您需要设置在使用提供的<code class="fe oe of og nv b">example.env.sh</code>部署<em class="le"> crunchy-containers </em>时将使用的环境，您可以将其复制到<code class="fe oe of og nv b">env.sh</code>和source，在这里您至少需要更新以下变量。</p><pre class="lg lh li lj gt nu nv nw nx aw ny bi"><span id="6b84" class="nz ma it nv b gy oa ob l oc od">CCPROOT=/home/user/code/crunchy-containers  # The base of the crunchy-containers clone GitHub repository</span><span id="e470" class="nz ma it nv b gy oh ob l oc od">CCP_NAMESPACE=myproject # Change this to the OpenShift project name</span></pre><p id="a672" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">下一步是登录到您的<em class="le"> OpenShift </em>集群和包含<em class="le"> PostgreSQL </em>主机名、用户名、密码和SSL证书秘密的项目。</p><pre class="lg lh li lj gt nu nv nw nx aw ny bi"><span id="3b72" class="nz ma it nv b gy oa ob l oc od">oc login<br/>oc project myproject</span></pre><p id="a620" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">现在，您可以使用存储库中包含的shell脚本创建部署pgpool所需的几个配置文件。</p><pre class="lg lh li lj gt nu nv nw nx aw ny bi"><span id="928b" class="nz ma it nv b gy oa ob l oc od"># Create pgpool.conf file with create_pgpool_conf.sh script:</span><span id="c36c" class="nz ma it nv b gy oh ob l oc od">./create_pool_passwd.sh SECRET_NAME HOSTNAME_KEY USERNAME_KEY PASSWORD_KEY<br/></span><span id="3d60" class="nz ma it nv b gy oh ob l oc od"># Create pool_passwd file with create_pool_passwd.sh script:</span><span id="e088" class="nz ma it nv b gy oh ob l oc od">./create_pool_passwd.sh SECRET_NAME USERNAME_KEY PASSWORD_KEY<br/></span><span id="4395" class="nz ma it nv b gy oh ob l oc od"># Create server.pem file with create_server_pemfile.sh script:</span><span id="cd07" class="nz ma it nv b gy oh ob l oc od">./create_server_pemfile.sh SECRET_NAME CACERT_KEY</span></pre><p id="8d78" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">所有这些文件都将存储在<code class="fe oe of og nv b">kube/pgpool/configs/</code>中，这样它们就可以被复制到一个克隆的<em class="le"> crunchy-containers </em>仓库中。</p><pre class="lg lh li lj gt nu nv nw nx aw ny bi"><span id="9261" class="nz ma it nv b gy oa ob l oc od">cd ..<br/>git clone https://github.com/CrunchyData/crunchy-containers.git<br/>cd crunchy-containers/examples/</span></pre><p id="aa3b" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">现在您复制上面创建的安装文件并部署pgpool:</p><pre class="lg lh li lj gt nu nv nw nx aw ny bi"><span id="cdca" class="nz ma it nv b gy oa ob l oc od">cp -rf ../../openshift-pgpool/kube/ kube/<br/>cd kube/pgpool/<br/>./run_sslcacert.sh</span></pre><figure class="lg lh li lj gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi oi"><img src="../Images/72945afb9ae89c1b6789f94693bfc763.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*8Zg4SpR7ktCs1qq0YMO1iw.png"/></div></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated">部署的pgpool pod</figcaption></figure><h1 id="ab62" class="lz ma it bd mb mc md me mf mg mh mi mj mk ml mm mn mo mp mq mr ms mt mu mv mw bi translated">使用部署的pgpool</h1><p id="f48c" class="pw-post-body-paragraph kg kh it ki b kj mx kl km kn my kp kq kr mz kt ku kv na kx ky kz nb lb lc ld im bi translated">您现在可以连接到部署的<code class="fe oe of og nv b">pgpool</code> pod，它实际上将代理<em class="le"> PostgreSQL </em>数据库。使用<code class="fe oe of og nv b">oc port-forward</code>连接到数据库。</p><p id="8906" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">按照以下步骤与部署的代理交互:</p><ol class=""><li id="5bcd" class="lk ll it ki b kj kk kn ko kr lm kv ln kz lo ld oj lq lr ls bi translated">找到已部署<code class="fe oe of og nv b">pgpool</code>的pod名称。</li></ol><pre class="lg lh li lj gt nu nv nw nx aw ny bi"><span id="d73c" class="nz ma it nv b gy oa ob l oc od">oc get pods -l name=pgpool -o name<!-- --> </span></pre><p id="1241" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">2.使用端口转发连接到远程数据库。</p><pre class="lg lh li lj gt nu nv nw nx aw ny bi"><span id="e2c0" class="nz ma it nv b gy oa ob l oc od">oc port-forward [pod] 5432:5432 &gt;/dev/null 2&gt;&amp;1 &amp;</span></pre><p id="53bf" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">现在，您可以使用本地应用程序或<code class="fe oe of og nv b">psql</code>连接到远程数据库。</p><pre class="lg lh li lj gt nu nv nw nx aw ny bi"><span id="ef74" class="nz ma it nv b gy oa ob l oc od">psql --password --host=127.0.0.1 --port=5432 --username=dbuser --dbname=mydb</span><span id="ede7" class="nz ma it nv b gy oh ob l oc od">select * from mytable;</span></pre><p id="6c24" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">对端口转发的访问仅限于那些对<em class="le"> OpenShift </em>项目拥有<code class="fe oe of og nv b">edit</code>或更大权限的用户，并且在提取秘密数据以限制访问后，pod可以扩展到零和/或部署到任何项目。</p><h1 id="5101" class="lz ma it bd mb mc md me mf mg mh mi mj mk ml mm mn mo mp mq mr ms mt mu mv mw bi translated">摘要</h1><p id="25b7" class="pw-post-body-paragraph kg kh it ki b kj mx kl km kn my kp kq kr mz kt ku kv na kx ky kz nb lb lc ld im bi translated">在这个故事中，我们强调了一种访问我们的网络隔离远程生产数据库的机制。我们了解了<em class="le"> Pgpool-II </em>及其功能，包括充当PostgreSQL 数据库的代理。接下来，我们完成了创建适当的<em class="le"> Pgpool-II </em>配置的设置步骤，以便使用SSL证书连接到远程数据库。最后，我们看到了如何将<code class="fe oe of og nv b">pgpool</code> pod部署到<em class="le"> OpenShift </em>中，并使用端口转发为开发人员获得与本地开发相同的生产体验。</p></div></div>    
</body>
</html>