<html>
<head>
<title>Reversing NodeJS malware, part 2: Analysing the source code</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">逆转NodeJS恶意软件，第2部分:分析源代码</h1>
<blockquote>原文：<a href="https://itnext.io/reversing-nodejs-malware-part-2-analysing-the-source-code-a31c316ff4f?source=collection_archive---------2-----------------------#2022-02-05">https://itnext.io/reversing-nodejs-malware-part-2-analysing-the-source-code-a31c316ff4f?source=collection_archive---------2-----------------------#2022-02-05</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><figure class="is it gp gr iu iv gh gi paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="gh gi ir"><img src="../Images/f03d749250fbc58c3416754c7712fc7a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*T2GA7P4Vkjukaa1fUbOJog.jpeg"/></div></div></figure><div class=""/><p id="b138" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">在我的上一篇文章(见<a class="ae kz" rel="noopener ugc nofollow" target="_blank" href="/how-i-reversed-a-nodejs-malware-and-found-the-author-7dd9531b389f">这里</a>)中，我们发现了一个NodeJS恶意软件，它通过修补电子客户端的源代码来窃取客户端的不和谐凭证。</p><p id="9873" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">从那以后，发生了很多事情。作者删除了知识库，他为自己造成的伤害公开道歉。</p><h1 id="5e18" class="la lb je bd lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx bi translated">电子</h1><p id="5e21" class="pw-post-body-paragraph kb kc je kd b ke ly kg kh ki lz kk kl km ma ko kp kq mb ks kt ku mc kw kx ky im bi translated">Electron是一个框架，允许开发人员使用HTML、Javascript和CSS等Web技术构建桌面应用程序。</p><p id="5220" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">这个框架很流行，被许多典型的应用程序广泛使用，如VSCode、Whatsapp或Discord。</p><p id="86f1" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">由于应用程序代码是用Javascript编写的，所以源代码仍然在那里，只是隐藏在显眼的地方。那么，是什么保护我们免受恶意用户编辑包含源代码的归档并用恶意软件篡改它呢？在电子层面上，几乎没有。在操作系统层面，您可以使用代码签名或在安全的地方安装应用程序:</p><ul class=""><li id="f609" class="md me je kd b ke kf ki kj km mf kq mg ku mh ky mi mj mk ml bi translated">在Windows上，<code class="fe mm mn mo mp b">C:\Program Files\</code>中的程序只能由应用程序自己编辑，但默认情况下，会安装在<code class="fe mm mn mo mp b">%APPDATA%</code>中，而在这里没有这种保护。</li><li id="6c87" class="md me je kd b ke mq ki mr km ms kq mt ku mu ky mi mj mk ml bi translated">在Mac上，应用程序通常经过签名，并且在安装过程中会验证该签名。但是在那之后，就不再检查任何东西了。</li><li id="d137" class="md me je kd b ke mq ki mr km ms kq mt ku mu ky mi mj mk ml bi translated">在Linux上，没有这样的默认保护机制。</li></ul><h1 id="00a4" class="la lb je bd lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx bi translated">电子恶意软件注入:盗版者</h1><p id="ed66" class="pw-post-body-paragraph kb kc je kd b ke ly kg kh ki lz kk kl km ma ko kp kq mb ks kt ku mc kw kx ky im bi translated">让我们通过观察PirateStealer的注射器如何工作来开始我们的电子注射之旅。</p><p id="1f17" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">它首先试图在您的<code class="fe mm mn mo mp b">%APPDATA%</code>目录中找到您的Discord安装，然后定位所有正在运行的进程。然后，它从Github库下载感染有效载荷，停止您的Discord，注入有效载荷，并重新启动您的Discord客户端。让我们把重点放在有效载荷注入上。有效载荷注入是通过修改主Discord桌面文件来完成的，您可以在您的<code class="fe mm mn mo mp b">%LOCALAPPDATA%\Discord\app-&lt;version&gt;\modules\discord_desktop_core-2\discord_desktop_core</code>目录中找到该文件。index.js文件通常应该如下所示:</p><pre class="mv mw mx my gt mz mp na nb aw nc bi"><span id="20b9" class="nd lb je mp b gy ne nf l ng nh">module.exports = require('./core.asar');</span></pre><p id="bfd0" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">注射后，它将看起来像这样:</p><pre class="mv mw mx my gt mz mp na nb aw nc bi"><span id="574c" class="nd lb je mp b gy ne nf l ng nh">const fs=require("fs"),path=require("path"),{BrowserWindow:BrowserWindow,session:session}=require("electron"),querystring=require("querystring"),os=require("os");var webhook="https://discord.com/api/.....</span></pre><p id="b043" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">正如你所看到的，恶意软件修改了Discord的源代码，使其代码在Discord中运行。</p><p id="a434" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">现在是时候看看这个注入的有效载荷了。</p><h1 id="ad86" class="la lb je bd lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx bi translated">PirateStealer有效载荷</h1><p id="019d" class="pw-post-body-paragraph kb kc je kd b ke ly kg kh ki lz kk kl km ma ko kp kq mb ks kt ku mc kw kx ky im bi translated">我不会公布有效载荷的完整代码，因为最初的Github库被禁止了，但我们仍然可以突出一些聪明的机制。</p><p id="5d0e" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">首先，我们可以看看PirateStealer是如何从Discord客户端获取令牌的。为了准备分发代码，Discord团队将其代码与<a class="ae kz" href="https://webpack.js.org/" rel="noopener ugc nofollow" target="_blank"> Webpack </a>捆绑在一起。该工具允许将许多资源捆绑成更大的块，以便于安装过程。</p><p id="7de3" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">Webpack还为开发人员提供了一种在运行时添加自己代码的方法。</p><p id="4617" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">这个特性来自这个<a class="ae kz" href="https://github.com/webpack/webpack/blob/98887e42fc9966210a09f10f33861d4f70549478/lib/web/JsonpChunkLoadingRuntimeModule.js#L412" rel="noopener ugc nofollow" target="_blank"> Webpack JSONP加载器</a>。从突出显示的代码中可以看出，这一行允许开发人员访问整个Webpack运行时。从那里，我们可以访问<strong class="kd jf">所有不协调的功能。从那里，我们可以列出每个函数并搜索<code class="fe mm mn mo mp b">getToken</code>函数。没错，就是这样，Discord最关键的安全功能显而易见。如果Discord将该函数重命名为任何其他名称，它将破坏所有当前存在的令牌抓取器。</strong> <em class="ni">【咆哮:关】</em></p><p id="53ec" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">使用这个令牌，PirateStealers运行对内部Discord API的几个调用:</p><ul class=""><li id="a8ab" class="md me je kd b ke kf ki kj km mf kq mg ku mh ky mi mj mk ml bi translated">它首先检查个人资料的独特徽章，如验证开发者，早期支持者…</li><li id="d594" class="md me je kd b ke mq ki mr km ms kq mt ku mu ky mi mj mk ml bi translated">然后它会列出支付来源(它不会暴露你的信用卡，但<strong class="kd jf">它会暴露你的邮政地址！</strong>)</li><li id="6bbb" class="md me je kd b ke mq ki mr km ms kq mt ku mu ky mi mj mk ml bi translated">然后，它列出了你的朋友与罕见的徽章，为未来的目标。</li><li id="3c1a" class="md me je kd b ke mq ki mr km ms kq mt ku mu ky mi mj mk ml bi translated">最后，如果它之前获取了您的密码，它会重置您的MFA(更多信息请见下文)。</li></ul><p id="88e5" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">我们看到了恶意软件可以用一个简单的令牌做什么。这是相当强大的，在我看来…</p><p id="5be5" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">但这并不是恶意软件的全部功能。它还会监视您在应用程序中的活动:</p><ul class=""><li id="20ea" class="md me je kd b ke kf ki kj km mf kq mg ku mh ky mi mj mk ml bi translated">它检测用户何时登录、更改其密码或更改其电子邮件地址(这意味着它可以窃取您的密码和电子邮件地址)。这会泄露您现有的密码，并允许黑客登录并更改帐户上的任何信息。</li><li id="153d" class="md me je kd b ke mq ki mr km ms kq mt ku mu ky mi mj mk ml bi translated">它检测用户何时添加信用卡并泄露关于该卡的所有信息(<strong class="kd jf">包括CVC！</strong>)</li></ul><h1 id="55b8" class="la lb je bd lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx bi translated">推荐</h1><p id="c4ad" class="pw-post-body-paragraph kb kc je kd b ke ly kg kh ki lz kk kl km ma ko kp kq mb ks kt ku mc kw kx ky im bi translated">根据我们在文章中看到的内容，我建议:</p><ul class=""><li id="b5b8" class="md me je kd b ke kf ki kj km mf kq mg ku mh ky mi mj mk ml bi translated"><strong class="kd jf">不要在Discord的付款方式中使用您的实际地址。</strong></li><li id="e5ea" class="md me je kd b ke mq ki mr km ms kq mt ku mu ky mi mj mk ml bi translated"><strong class="kd jf">想加支付方式就不要用信用卡；用Paypal代替，不会泄露任何关键信息。</strong></li></ul><p id="6a9f" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">还有，<strong class="kd jf">请经常不和谐，混淆和旋转getToken函数名。这将使获取代币的过程变得非常复杂…</strong></p><p id="10b3" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">感谢您阅读这篇文章，如果您有任何建议或意见，您可以在Discord(<strong class="kd jf">https://discord.gg/FKuAky4K8M</strong>)上提出。</p><p id="ed7f" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">如果你喜欢这篇文章，请考虑留下你的反馈。这种文章需要很长时间准备(除了我的日常工作，几乎有一周时间)，所以如果你想支持我，你可以在这里订阅<a class="ae kz" href="https://medium.com/@devops-guy/membership" rel="noopener">中级会员</a>。这也给了你无限的媒体访问权。</p></div></div>    
</body>
</html>