<html>
<head>
<title>Getting started with MongoDB and Go on Azure</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">开始使用MongoDB并继续使用Azure</h1>
<blockquote>原文：<a href="https://itnext.io/getting-started-with-mongodb-and-go-on-azure-fbe612eefe5c?source=collection_archive---------5-----------------------#2020-04-03">https://itnext.io/getting-started-with-mongodb-and-go-on-azure-fbe612eefe5c?source=collection_archive---------5-----------------------#2020-04-03</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="dfe1" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">作为一个围棋爱好者，很高兴看到以官方MongoDB Go驱动程序的形式为MongoDB提供一流的支持<a class="ae kl" href="https://github.com/mongodb/mongo-go-driver" rel="noopener ugc nofollow" target="_blank">。我们将通过为一个好的老式CRUD风格的应用程序构建一个简单的REST API来学习如何使用它！</a></p><p id="8d15" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在这篇博客中，将涵盖以下主题:</p><ul class=""><li id="9126" class="km kn iq jp b jq jr ju jv jy ko kc kp kg kq kk kr ks kt ku bi translated">演练应用程序:CRUD操作</li><li id="f8e0" class="km kn iq jp b jq kv ju kw jy kx kc ky kg kz kk kr ks kt ku bi translated">为MongoDB API设置Azure Cosmos DB</li><li id="aff6" class="km kn iq jp b jq kv ju kw jy kx kc ky kg kz kk kr ks kt ku bi translated">设置Azure应用服务并将应用程序部署到云</li><li id="a7d7" class="km kn iq jp b jq kv ju kw jy kx kc ky kg kz kk kr ks kt ku bi translated">带着REST API兜一圈</li></ul><p id="6510" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">接下来，您可以自由选择使用MongoDB集群(<a class="ae kl" href="https://hub.docker.com/_/mongo" rel="noopener ugc nofollow" target="_blank"> Docker可能是最快/最简单的选择</a>)。我将使用<a class="ae kl" href="https://docs.microsoft.com/azure/cosmos-db/?WT.mc_id=medium-blog-abhishgu" rel="noopener ugc nofollow" target="_blank"> Azure Cosmos DB </a>，它是微软的全球分布式多模型数据库服务，支持文档、键值、图表和列数据模型。它实现了MongoDB的wire协议，使得任何理解该协议版本的MongoDB客户端驱动程序(包括Go驱动程序)都可以本地连接到Cosmos DB。</p><blockquote class="la lb lc"><p id="f1bb" class="jn jo ld jp b jq jr js jt ju jv jw jx le jz ka kb lf kd ke kf lg kh ki kj kk ij bi translated"><em class="iq">您可以在没有Azure订阅的情况下免费试用</em><a class="ae kl" href="https://azure.microsoft.com/try/cosmosdb/?WT.mc_id=medium-blog-abhishgu" rel="noopener ugc nofollow" target="_blank"><em class="iq">Azure Cosmos DB</em></a><em class="iq">(在有限的时间内)，或者使用</em> <a class="ae kl" href="https://docs.microsoft.com/azure/cosmos-db/optimize-dev-test?WT.mc_id=medium-blog-abhishgu#azure-cosmos-db-free-tier" rel="noopener ugc nofollow" target="_blank"> <em class="iq"> Azure Cosmos DB免费层</em> </a> <em class="iq">来获得一个前400 RU/s和5 GB免费存储空间的帐户。</em></p></blockquote><p id="3286" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">应用程序(API)将被部署到<a class="ae kl" href="https://docs.microsoft.com/azure/app-service/?WT.mc_id=medium-blog-abhishgu" rel="noopener ugc nofollow" target="_blank"> Azure应用程序服务</a>。它使您能够以自己选择的编程语言构建和托管web应用、移动后端和RESTful APIs，而无需管理基础设施。<a class="ae kl" href="https://docs.microsoft.com/azure/app-service/containers/app-service-linux-intro?WT.mc_id=medium-blog-abhishgu" rel="noopener ugc nofollow" target="_blank">您可以在Linux上使用它</a>在Linux上本地托管web应用程序，以获得支持的应用程序堆栈，并支持多种语言的内置Docker映像<a class="ae kl" href="https://docs.microsoft.com/azure/app-service/containers/app-service-linux-intro?WT.mc_id=medium-blog-abhishgu#languages" rel="noopener ugc nofollow" target="_blank">，如Node.js、Java、Python </a>等。</p><blockquote class="la lb lc"><p id="f87d" class="jn jo ld jp b jq jr js jt ju jv jw jx le jz ka kb lf kd ke kf lg kh ki kj kk ij bi translated"><em class="iq">虽然我们在本例中有一个Go应用程序，但我们仍然可以在应用程序服务上托管它，因为它也支持自定义Docker图像！</em></p></blockquote></div><div class="ab cl lh li hu lj" role="separator"><span class="lk bw bk ll lm ln"/><span class="lk bw bk ll lm ln"/><span class="lk bw bk ll lm"/></div><div class="ij ik il im in"><h1 id="2fb3" class="lo lp iq bd lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml bi translated">概观</h1><p id="2dc0" class="pw-post-body-paragraph jn jo iq jp b jq mm js jt ju mn jw jx jy mo ka kb kc mp ke kf kg mq ki kj kk ij bi translated">这个应用程序很简单，它公开了一个REST API来创建、读取、更新和删除带有GitHub ID、博客和技能的开发人员档案。</p><p id="e8ea" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">像往常一样，代码可以在GitHub 上获得，但是让我们快速浏览一下！</p><p id="1aa8" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">下面是代码布局:</p><pre class="mr ms mt mu gt mv mw mx my aw mz bi"><span id="0e63" class="na lp iq mw b gy nb nc l nd ne">.<br/>├── Dockerfile<br/>├── api<br/>│   ├── crud.go<br/>│   └── crud_test.go<br/>├── go.mod<br/>├── go.sum<br/>├── main.go<br/>├── model<br/>│   └── developer.go<br/>└── test.sh</span></pre><p id="38ac" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">主要的CRUD操作在<code class="fe nf ng nh mw b">api</code>包中的<code class="fe nf ng nh mw b">crud.go</code>文件中。它包含创建、读取、更新和删除操作的实现。</p><p id="abc9" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><code class="fe nf ng nh mw b">Create</code>函数获取MongoDB集合的句柄，并将请求体(JSON有效负载)整理成一个结构(<code class="fe nf ng nh mw b">model.Developer</code>)。然后使用<code class="fe nf ng nh mw b"><a class="ae kl" href="https://godoc.org/go.mongodb.org/mongo-driver/mongo#Collection.InsertOne" rel="noopener ugc nofollow" target="_blank">InsertOne</a></code> <a class="ae kl" href="https://godoc.org/go.mongodb.org/mongo-driver/mongo#Collection.InsertOne" rel="noopener ugc nofollow" target="_blank">函数</a>插入该结构，处理错误(上面未显示)并在成功的情况下返回一个<code class="fe nf ng nh mw b">HTTP 201</code>。</p><pre class="mr ms mt mu gt mv mw mx my aw mz bi"><span id="1c9a" class="na lp iq mw b gy nb nc l nd ne">coll := a.Connection.Database(a.DBName).Collection(a.CollectionName)<br/>...<br/>var dev model.Developer<br/>json.NewDecoder(req.Body).Decode(&amp;dev)<br/>...<br/>res, err := coll.InsertOne(ctx, dev)<br/>...<br/>rw.WriteHeader(http.StatusCreated)</span></pre><p id="24f2" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">下面是读取操作的工作原理:</p><pre class="mr ms mt mu gt mv mw mx my aw mz bi"><span id="7fd4" class="na lp iq mw b gy nb nc l nd ne">vars := mux.Vars(req)<br/>githubID := vars["github"]<br/>...<br/>coll := a.Connection.Database(a.DBName).Collection(a.CollectionName)<br/>r := coll.FindOne(context.Background(), bson.M{githubIDAttribute: githubID})<br/>...<br/>var p model.Developer<br/>r.Decode(&amp;p)<br/>json.NewEncoder(rw).Encode(&amp;p)</span></pre><p id="8e0c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><code class="fe nf ng nh mw b"><a class="ae kl" href="https://godoc.org/go.mongodb.org/mongo-driver/mongo#Collection.FindOne" rel="noopener ugc nofollow" target="_blank">FindOne</a></code> <a class="ae kl" href="https://godoc.org/go.mongodb.org/mongo-driver/mongo#Collection.FindOne" rel="noopener ugc nofollow" target="_blank">函数</a>与过滤标准<code class="fe nf ng nh mw b">github_id</code>一起使用，过滤标准是集合<code class="fe nf ng nh mw b">bson.M{githubIDAttribute: githubID}</code>的分区键。如果找到，结果将被转换为结构并返回给调用方。</p><p id="d685" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">获取所有开发人员配置文件是类似的</p><pre class="mr ms mt mu gt mv mw mx my aw mz bi"><span id="a5a1" class="na lp iq mw b gy nb nc l nd ne">r, err := coll.Find(context.Background(), bson.D{})<br/>...<br/>devs := []model.Developer{}<br/>err = r.All(context.Background(), &amp;devs)<br/>...</span></pre><p id="bcae" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><code class="fe nf ng nh mw b"><a class="ae kl" href="https://godoc.org/go.mongodb.org/mongo-driver/mongo#Collection.Find" rel="noopener ugc nofollow" target="_blank">Find</a></code>使用一个空的<code class="fe nf ng nh mw b">bson</code>文档作为过滤器，列出集合中的所有文档，结果以JSON数组的形式发送回调用者</p><p id="ad5d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><code class="fe nf ng nh mw b"><a class="ae kl" href="https://godoc.org/go.mongodb.org/mongo-driver/mongo#Collection.FindOneAndReplace" rel="noopener ugc nofollow" target="_blank">FindOneAndReplace</a></code>用于更新一条特定的记录。<code class="fe nf ng nh mw b">github_id</code>用作过滤标准，传入的JSON有效负载是更新后的记录。</p><pre class="mr ms mt mu gt mv mw mx my aw mz bi"><span id="d48b" class="na lp iq mw b gy nb nc l nd ne">var dev model.Developer<br/>json.NewDecoder(req.Body).Decode(&amp;dev)<br/>...<br/>r := coll.FindOneAndReplace(context.Background(), bson.M{githubIDAttribute: githubID}, &amp;dev)<br/>...<br/>rw.WriteHeader(http.StatusNoContent)</span></pre><p id="eadc" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">使用<code class="fe nf ng nh mw b"><a class="ae kl" href="https://godoc.org/go.mongodb.org/mongo-driver/mongo#Collection.FindOneAndDelete" rel="noopener ugc nofollow" target="_blank">FindOneAndDelete</a></code>完成删除，它接受<code class="fe nf ng nh mw b">github_id</code>作为要删除的记录的过滤标准</p><pre class="mr ms mt mu gt mv mw mx my aw mz bi"><span id="c0d8" class="na lp iq mw b gy nb nc l nd ne">vars := mux.Vars(req)<br/>githubID := vars["github"]<br/>...<br/>r := coll.FindOneAndDelete(context.Background(), bson.M{githubIDAttribute: githubID})<br/>...<br/>rw.WriteHeader(http.StatusNoContent)</span></pre><p id="8965" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在<code class="fe nf ng nh mw b">main.go</code>一切都联系在一起。它将CRUD操作处理程序与HTTP路由相关联，启动服务器并设置一个优雅的退出机制</p><pre class="mr ms mt mu gt mv mw mx my aw mz bi"><span id="e96e" class="na lp iq mw b gy nb nc l nd ne">.....<br/>func main() {<br/>	r := mux.NewRouter() <br/>        r.Methods(http.MethodPost).Path("/developers")<br/>                                  .HandlerFunc(crudAPI.Create)<br/>	r.Methods(http.MethodGet).Path("/developers/{github}")<br/>                                 .HandlerFunc(crudAPI.Read)<br/>        r.Methods(http.MethodGet).Path("/developers")<br/>                                 .HandlerFunc(crudAPI.ReadAll)<br/>        r.Methods(http.MethodPut).Path("/developers")<br/>                                 .HandlerFunc(crudAPI.Update)<br/>        r.Methods(http.MethodDelete).Path("/developers/{github}")<br/>                                    .HandlerFunc(crudAPI.Delete)</span><span id="69de" class="na lp iq mw b gy ni nc l nd ne">	server := http.Server{Addr: ":" + port, Handler: r}</span><span id="0685" class="na lp iq mw b gy ni nc l nd ne">	go func() {<br/>		err := server.ListenAndServe()<br/>		if err != nil &amp;&amp; err != http.ErrServerClosed {<br/>			log.Fatalf("could not start server %v", err)<br/>		}<br/>	}()<br/>....<br/>	exit := make(chan os.Signal)<br/>	signal.Notify(exit, syscall.SIGTERM, syscall.SIGINT)<br/>	&lt;-exit<br/>....<br/>	c, cancel := context.WithTimeout(context.Background(), 5*time.Second)<br/>	defer func() {<br/>		crudAPI.Close()<br/>		cancel()<br/>	}()<br/>	err := server.Shutdown(c)<br/>....</span></pre><p id="29fb" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">好了，除此之外，是时候提供所需的服务并部署应用程序了。在此之前，我们先来看看一些先决条件</p></div><div class="ab cl lh li hu lj" role="separator"><span class="lk bw bk ll lm ln"/><span class="lk bw bk ll lm ln"/><span class="lk bw bk ll lm"/></div><div class="ij ik il im in"><h1 id="f750" class="lo lp iq bd lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml bi translated">先决条件</h1><ul class=""><li id="c964" class="km kn iq jp b jq mm ju mn jy nj kc nk kg nl kk kr ks kt ku bi translated">一个<a class="ae kl" href="https://docs.microsoft.com/azure/?WT.mc_id=medium-blog-abhishgu" rel="noopener ugc nofollow" target="_blank">微软Azure账户</a>—<a class="ae kl" href="https://azure.microsoft.com/free/?WT.mc_id=medium-blog-abhishgu" rel="noopener ugc nofollow" target="_blank">注册一个免费账户吧！</a></li><li id="b46b" class="km kn iq jp b jq kv ju kw jy kx kc ky kg kz kk kr ks kt ku bi translated"><code class="fe nf ng nh mw b">Azure CLI</code>或者<code class="fe nf ng nh mw b">Azure Cloud Shell</code>——你可以选择安装<a class="ae kl" href="https://docs.microsoft.com/cli/azure/install-azure-cli?view=azure-cli-latest&amp;WT.mc_id=medium-blog-abhishgu" rel="noopener ugc nofollow" target="_blank"> Azure CLI </a>如果你还没有的话(应该很快！)或者直接从浏览器使用<a class="ae kl" href="https://azure.microsoft.com/features/cloud-shell/?WT.mc_id=medium-blog-abhishgu" rel="noopener ugc nofollow" target="_blank"> Azure云壳</a>。</li></ul><h1 id="d61c" class="lo lp iq bd lq lr nm lt lu lv nn lx ly lz no mb mc md np mf mg mh nq mj mk ml bi translated">设置Azure Cosmos DB</h1><p id="61ec" class="pw-post-body-paragraph jn jo iq jp b jq mm js jt ju mn jw jx jy mo ka kb kc mp ke kf kg mq ki kj kk ij bi translated">您需要创建一个启用了MongoDB API支持的Azure Cosmos DB帐户以及一个数据库和集合。您可以使用Azure门户或Azure CLI</p><blockquote class="la lb lc"><p id="3791" class="jn jo ld jp b jq jr js jt ju jv jw jx le jz ka kb lf kd ke kf lg kh ki kj kk ij bi translated"><em class="iq">了解如何在Azure Cosmos DB </em> 中使用数据库、容器和项目的更多信息</p></blockquote><h2 id="f683" class="na lp iq bd lq nr ns dn lu nt nu dp ly jy nv nw mc kc nx ny mg kg nz oa mk ob bi translated">使用Azure门户网站</h2><p id="f04a" class="pw-post-body-paragraph jn jo iq jp b jq mm js jt ju mn jw jx jy mo ka kb kc mp ke kf kg mq ki kj kk ij bi translated">请遵循以下步骤:</p><ul class=""><li id="3ed8" class="km kn iq jp b jq jr ju jv jy ko kc kp kg kq kk kr ks kt ku bi translated"><a class="ae kl" href="https://docs.microsoft.com/azure/cosmos-db/create-mongodb-java?WT.mc_id=medium-blog-abhishgu#create-a-database-account" rel="noopener ugc nofollow" target="_blank">创建一个Azure Cosmos DB帐户</a></li><li id="6755" class="km kn iq jp b jq kv ju kw jy kx kc ky kg kz kk kr ks kt ku bi translated"><a class="ae kl" href="https://docs.microsoft.com/azure/cosmos-db/create-mongodb-java?WT.mc_id=medium-blog-abhishgu#add-a-collection" rel="noopener ugc nofollow" target="_blank">添加一个数据库和集合</a>并获取连接字符串</li></ul><h2 id="7ce8" class="na lp iq bd lq nr ns dn lu nt nu dp ly jy nv nw mc kc nx ny mg kg nz oa mk ob bi translated">使用Azure CLI</h2><p id="96dc" class="pw-post-body-paragraph jn jo iq jp b jq mm js jt ju mn jw jx jy mo ka kb kc mp ke kf kg mq ki kj kk ij bi translated">(相同的命令可用于Azure CLI或Azure Cloud Shell)</p><p id="bcee" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">导出以下环境变量:</p><pre class="mr ms mt mu gt mv mw mx my aw mz bi"><span id="5b5a" class="na lp iq mw b gy nb nc l nd ne">export RESOURCE_GROUP=[to be filled]<br/>export LOCATION=[to be filled]<br/>export COSMOS_DB_ACCOUNT=[to be filled]<br/>export COSMOS_DB_NAME=[to be filled]<br/>export COSMOS_COLLECTION_NAME=[to be filled]<br/>export SHARDING_KEY_PATH='[to be filled]'</span></pre><p id="bdca" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">首先创建一个<a class="ae kl" href="https://docs.microsoft.com/cli/azure/group?view=azure-cli-latest&amp;WT.mc_id=medium-blog-abhishgu#az-group-create" rel="noopener ugc nofollow" target="_blank">新的资源组</a>，在它下面你可以放置你所有的资源。完成后，您可以删除资源组，这将依次删除所有服务</p><pre class="mr ms mt mu gt mv mw mx my aw mz bi"><span id="7abb" class="na lp iq mw b gy nb nc l nd ne">az group create --name $RESOURCE_GROUP --location $LOCATION</span></pre><p id="1cd6" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><a class="ae kl" href="https://docs.microsoft.com/cli/azure/cosmosdb?view=azure-cli-latest&amp;WT.mc_id=medium-blog-abhishgu#az-cosmosdb-create" rel="noopener ugc nofollow" target="_blank">创建账户</a>(通知<code class="fe nf ng nh mw b">--kind MongoDB</code>)</p><pre class="mr ms mt mu gt mv mw mx my aw mz bi"><span id="5a74" class="na lp iq mw b gy nb nc l nd ne">az cosmosdb create --resource-group $RESOURCE_GROUP --name abhishgu-mongodb --kind MongoDB</span></pre><p id="fe70" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><a class="ae kl" href="https://docs.microsoft.com/cli/azure/cosmosdb/mongodb/database?view=azure-cli-latest&amp;WT.mc_id=medium-blog-abhishgu#az-cosmosdb-mongodb-database-create" rel="noopener ugc nofollow" target="_blank">创建数据库</a></p><pre class="mr ms mt mu gt mv mw mx my aw mz bi"><span id="fbbf" class="na lp iq mw b gy nb nc l nd ne">az cosmosdb mongodb database create --account-name $COSMOS_DB_ACCOUNT --name $COSMOS_DB_NAME --resource-group $RESOURCE_GROUP</span></pre><p id="4929" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">最后，<a class="ae kl" href="https://docs.microsoft.com/cli/azure/cosmosdb/mongodb/collection?view=azure-cli-latest&amp;WT.mc_id=medium-blog-abhishgu#az-cosmosdb-mongodb-collection-create" rel="noopener ugc nofollow" target="_blank">在数据库中创建一个集合</a></p><pre class="mr ms mt mu gt mv mw mx my aw mz bi"><span id="8c26" class="na lp iq mw b gy nb nc l nd ne">az cosmosdb mongo collection create --account-name $COSMOS_DB_ACCOUNT --database-name $COSMOS_DB_NAME --name $COSMOS_COLLECTION_NAME --resource-group-name $RESOURCE_GROUP --shard $SHARDING_KEY_PATH</span></pre><p id="4976" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">获取连接字符串并保存它。你以后会用到它</p><pre class="mr ms mt mu gt mv mw mx my aw mz bi"><span id="072b" class="na lp iq mw b gy nb nc l nd ne">az cosmosdb list-connection-strings --name $COSMOS_DB_ACCOUNT --resource-group $RESOURCE_GROUP -o tsv --query connectionStrings[0].connectionString</span></pre></div><div class="ab cl lh li hu lj" role="separator"><span class="lk bw bk ll lm ln"/><span class="lk bw bk ll lm ln"/><span class="lk bw bk ll lm"/></div><div class="ij ik il im in"><h1 id="a1f4" class="lo lp iq bd lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml bi translated">部署到Azure应用服务</h1><h2 id="2ac1" class="na lp iq bd lq nr ns dn lu nt nu dp ly jy nv nw mc kc nx ny mg kg nz oa mk ob bi translated">为应用程序构建Docker映像</h2><blockquote class="la lb lc"><p id="9653" class="jn jo ld jp b jq jr js jt ju jv jw jx le jz ka kb lf kd ke kf lg kh ki kj kk ij bi translated"><em class="iq">这一步是可选的。你可以使用我在</em><a class="ae kl" href="https://hub.docker.com/" rel="noopener ugc nofollow" target="_blank"><em class="iq">docker hub</em></a>上提供的预建图像 <code class="fe nf ng nh mw b"><a class="ae kl" href="https://hub.docker.com/r/abhirockzz/mongodb-go-app" rel="noopener ugc nofollow" target="_blank"><em class="iq">abhirockzz/mongodb-go-app</em></a></code> <em class="iq"/></p></blockquote><p id="5ced" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">您可以使用<code class="fe nf ng nh mw b">Dockerfile</code>来构建您自己的映像，并将其推送到您选择的Docker注册表(公共/私有)</p><blockquote class="la lb lc"><p id="ff35" class="jn jo ld jp b jq jr js jt ju jv jw jx le jz ka kb lf kd ke kf lg kh ki kj kk ij bi translated"><a class="ae kl" href="https://docs.microsoft.com/azure/app-service/containers/tutorial-custom-docker-image?WT.mc_id=medium-blog-abhishgu" rel="noopener ugc nofollow" target="_blank"> <em class="iq">这里有一个教程</em> </a> <em class="iq">提供了一个如何使用</em> <a class="ae kl" href="https://azure.microsoft.com/services/container-registry/?WT.mc_id=medium-blog-abhishgu" rel="noopener ugc nofollow" target="_blank"> <em class="iq"> Azure容器注册表</em> </a> <em class="iq">和Azure Web App服务</em>的例子</p></blockquote><pre class="mr ms mt mu gt mv mw mx my aw mz bi"><span id="d04a" class="na lp iq mw b gy nb nc l nd ne">docker build -t [REPOSITORY_NAME/YOUR_DOCKER_IMAGE:TAG] .<br/>//e.g.<br/>docker build -t [abhirockzz/mongodb-go-app] .</span><span id="588f" class="na lp iq mw b gy ni nc l nd ne">//login to your registry<br/>docker login</span><span id="9e93" class="na lp iq mw b gy ni nc l nd ne">//push image to registry<br/>docker push [REPOSITORY_NAME/YOUR_DOCKER_IMAGE:TAG]</span></pre><h2 id="2753" class="na lp iq bd lq nr ns dn lu nt nu dp ly jy nv nw mc kc nx ny mg kg nz oa mk ob bi translated">创建Azure应用服务</h2><p id="1820" class="pw-post-body-paragraph jn jo iq jp b jq mm js jt ju mn jw jx jy mo ka kb kc mp ke kf kg mq ki kj kk ij bi translated">是时候将我们的应用部署到云上了——让我们使用Azure应用服务快速完成这项工作。首先，创建一个应用服务计划，为我们的web应用运行定义一组计算资源。</p><blockquote class="la lb lc"><p id="e5a7" class="jn jo ld jp b jq jr js jt ju jv jw jx le jz ka kb lf kd ke kf lg kh ki kj kk ij bi translated"><em class="iq">关于App服务计划</em>的详细信息，请参见 <a class="ae kl" href="https://docs.microsoft.com/azure/app-service/overview-hosting-plans?toc=/azure/app-service/containers/toc.json&amp;WT.mc_id=medium-blog-abhishgu" rel="noopener ugc nofollow" target="_blank"> <em class="iq">文档</em> </a> <em class="iq"/></p></blockquote><p id="36d0" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">该计划与一个<code class="fe nf ng nh mw b">SKU</code>相关联——就像认知服务一样，你也需要为应用服务选择一个<code class="fe nf ng nh mw b">SKU</code>(定价层)。对于这个例子，我们将使用一个小层(<code class="fe nf ng nh mw b">B1</code>)。</p><blockquote class="la lb lc"><p id="59f5" class="jn jo ld jp b jq jr js jt ju jv jw jx le jz ka kb lf kd ke kf lg kh ki kj kk ij bi translated"><em class="iq">接受的值是</em> <code class="fe nf ng nh mw b"><em class="iq">B1, B2, B3, D1, F1, FREE, P1V2, P2V2, P3V2, PC2, PC3, PC4, S1, S2, S3, SHARED</em></code></p></blockquote><pre class="mr ms mt mu gt mv mw mx my aw mz bi"><span id="e677" class="na lp iq mw b gy nb nc l nd ne">export APP_SERVICE_PLAN_NAME=[to be filled]<br/>export APP_SERVICE_SKU=B1</span><span id="d36a" class="na lp iq mw b gy ni nc l nd ne">az appservice plan create --name $APP_SERVICE_PLAN_NAME --resource-group $RESOURCE_GROUP --sku $APP_SERVICE_SKU --is-linux</span></pre><blockquote class="la lb lc"><p id="e574" class="jn jo ld jp b jq jr js jt ju jv jw jx le jz ka kb lf kd ke kf lg kh ki kj kk ij bi translated"><em class="iq">文档为</em> <code class="fe nf ng nh mw b"><a class="ae kl" href="https://docs.microsoft.com/cli/azure/appservice/plan?view=azure-cli-latest&amp;WT.mc_id=medium-blog-abhishgu#az-appservice-plan-create" rel="noopener ugc nofollow" target="_blank"><em class="iq">az appservice plan create</em></a></code></p></blockquote><p id="295d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">设置环境变量</p><pre class="mr ms mt mu gt mv mw mx my aw mz bi"><span id="a61f" class="na lp iq mw b gy nb nc l nd ne">export APP_NAME=[to be filled]<br/>export DOCKER_IMAGE=[to be filled]<br/>export MONGODB_CONNECTION_STRING="[to be filled]"<br/>export DATABASE_NAME=[to be filled]<br/>export COLLECTION_NAME=[to be filled]</span></pre><blockquote class="la lb lc"><p id="4979" class="jn jo ld jp b jq jr js jt ju jv jw jx le jz ka kb lf kd ke kf lg kh ki kj kk ij bi translated"><em class="iq">请确保在连接字符串值</em>周围使用双引号( <code class="fe nf ng nh mw b"><em class="iq">""</em></code> <em class="iq">)</em></p></blockquote><p id="35db" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><a class="ae kl" href="https://docs.microsoft.com/cli/azure/webapp?view=azure-cli-latest&amp;WT.mc_id=medium-blog-abhishgu#az-webapp-create" rel="noopener ugc nofollow" target="_blank">部署应用</a></p><pre class="mr ms mt mu gt mv mw mx my aw mz bi"><span id="d923" class="na lp iq mw b gy nb nc l nd ne">az webapp create --resource-group $RESOURCE_GROUP --plan $APP_SERVICE_PLAN_NAME --name $APP_NAME --deployment-container-image-name $DOCKER_IMAGE</span></pre><p id="bcf6" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><a class="ae kl" href="https://docs.microsoft.com/cli/azure/webapp/config/appsettings?view=azure-cli-latest&amp;WT.mc_id=medium-blog-abhishgu#az-webapp-config-appsettings-set" rel="noopener ugc nofollow" target="_blank">添加环境变量作为应用所需的配置设置</a></p><pre class="mr ms mt mu gt mv mw mx my aw mz bi"><span id="f948" class="na lp iq mw b gy nb nc l nd ne">az webapp config appsettings set --resource-group $RESOURCE_GROUP --name $APP_NAME --settings MONGODB_CONNECTION_STRING=$MONGODB_CONNECTION_STRING DATABASE_NAME=$DATABASE_NAME COLLECTION_NAME=$COLLECTION_NAME</span></pre><p id="e4d5" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">API应该在某个时候部署。当它完成时，就去试一试吧！</p></div><div class="ab cl lh li hu lj" role="separator"><span class="lk bw bk ll lm ln"/><span class="lk bw bk ll lm ln"/><span class="lk bw bk ll lm"/></div><div class="ij ik il im in"><h1 id="6b66" class="lo lp iq bd lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml bi translated">测试API</h1><blockquote class="la lb lc"><p id="f5f2" class="jn jo ld jp b jq jr js jt ju jv jw jx le jz ka kb lf kd ke kf lg kh ki kj kk ij bi translated">我已经使用了 <code class="fe nf ng nh mw b"><em class="iq">curl</em></code> <em class="iq">进行演示，但是你也可以使用你选择的任何其他工具</em></p></blockquote><p id="ff1c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><a class="ae kl" href="https://docs.microsoft.com/cli/azure/webapp?view=azure-cli-latest&amp;WT.mc_id=medium-blog-abhishgu#az-webapp-show" rel="noopener ugc nofollow" target="_blank">获取已部署应用的端点/主机名</a></p><pre class="mr ms mt mu gt mv mw mx my aw mz bi"><span id="f138" class="na lp iq mw b gy nb nc l nd ne">APP_URL=$(az webapp show --name $APP_NAME --resource-group $RESOURCE_GROUP -o tsv --query 'defaultHostName')</span></pre><p id="19f0" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">创建一些开发人员档案</p><pre class="mr ms mt mu gt mv mw mx my aw mz bi"><span id="5275" class="na lp iq mw b gy nb nc l nd ne">curl -X POST -d '{"github_id":"abhirockzz", "blog":"dev.to/abhirockzz", "skills":["java","azure"]}' $APP_URL/developers</span><span id="50c8" class="na lp iq mw b gy ni nc l nd ne">curl -X POST -d '{"github_id":"abhishek", "blog":"medium.com/@abhishek1987/", "skills":["go","mongodb"]}' $APP_URL/developers</span></pre><p id="a70c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">使用GitHub ID查找单个开发人员配置文件</p><pre class="mr ms mt mu gt mv mw mx my aw mz bi"><span id="b875" class="na lp iq mw b gy nb nc l nd ne">curl $APP_URL/developers/abhirockzz</span></pre><p id="a4bf" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果您搜索不存在的配置文件</p><pre class="mr ms mt mu gt mv mw mx my aw mz bi"><span id="3adf" class="na lp iq mw b gy nb nc l nd ne">curl $APP_URL/developers/foo</span><span id="4868" class="na lp iq mw b gy ni nc l nd ne">//developer profile with GitHub ID foo does not exist</span></pre><p id="ab52" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">获取所有开发配置文件</p><pre class="mr ms mt mu gt mv mw mx my aw mz bi"><span id="17c3" class="na lp iq mw b gy nb nc l nd ne">curl $APP_URL/developers</span></pre><p id="14b2" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">删除开发人员档案</p><pre class="mr ms mt mu gt mv mw mx my aw mz bi"><span id="61a1" class="na lp iq mw b gy nb nc l nd ne">curl -X DELETE $APP_URL/developers/abhishek</span></pre><p id="6051" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">再次确认</p><pre class="mr ms mt mu gt mv mw mx my aw mz bi"><span id="ec98" class="na lp iq mw b gy nb nc l nd ne">curl $APP_URL/developers</span></pre><p id="a806" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">完成后，您可以删除资源组来删除所有服务</p><pre class="mr ms mt mu gt mv mw mx my aw mz bi"><span id="c4c1" class="na lp iq mw b gy nb nc l nd ne">az group delete --name $RESOURCE_GROUP --no-wait</span></pre><p id="93f9" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这个博客到此为止。我希望得到您的反馈和建议！简单地发推文或发表评论。如果你觉得这篇文章有用，请点赞并关注😃😃</p></div></div>    
</body>
</html>