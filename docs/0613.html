<html>
<head>
<title>How to share one database connection in a node/express app</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何在node/express应用程序中共享一个数据库连接</h1>
<blockquote>原文：<a href="https://itnext.io/how-to-share-a-single-database-connection-in-a-node-js-express-js-app-fcad4cbcb1e?source=collection_archive---------0-----------------------#2018-04-17">https://itnext.io/how-to-share-a-single-database-connection-in-a-node-js-express-js-app-fcad4cbcb1e?source=collection_archive---------0-----------------------#2018-04-17</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/4cf9becfdac8f4d69d7a7ba4c7fde160.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*scZ5_B1mKwZxqP0KuCkf_w.png"/></div></div></figure><p id="3947" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在node/express应用程序中，您经常需要调用数据库；在不止一个场合，通常是在不止一个模块中。在本文中，我将展示一种简洁而简单的方法来连接数据库，并在所有与数据库相关的操作中重用该连接。我们还将确保在开始接受请求之前连接已经准备好。我将使用<a class="ae kw" href="http://mongodb.github.io/node-mongodb-native/" rel="noopener ugc nofollow" target="_blank"> MongoDB </a>作为我的数据库，但是这些原则可以应用于任何数据库管理系统。</p></div><div class="ab cl kx ky hu kz" role="separator"><span class="la bw bk lb lc ld"/><span class="la bw bk lb lc ld"/><span class="la bw bk lb lc"/></div><div class="ij ik il im in"><p id="ee8f" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我们所有与数据库相关的操作都将由一个模块来处理，姑且称之为<code class="fe le lf lg lh b">db.js</code>。该模块将导出2个函数:</p><pre class="li lj lk ll gt lm lh ln lo aw lp bi"><span id="2fe2" class="lq lr iq lh b gy ls lt l lu lv">const assert = require("assert");<br/>const client = require("mongodb").MongoClient;<br/>const config = require("../config");</span><span id="748a" class="lq lr iq lh b gy lw lt l lu lv">let _db;</span><span id="cfde" class="lq lr iq lh b gy lw lt l lu lv">module.exports = {<br/>    getDb,<br/>    initDb<br/>};</span></pre><p id="3a87" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">数据库对象存储在一个<code class="fe le lf lg lh b">_db</code>对象中，这个对象最初是<code class="fe le lf lg lh b">undefined</code>，但是一旦我们连接到数据库，它将被设置为实际的数据库连接。您可能会猜到这两个函数是做什么的:</p><ul class=""><li id="d387" class="lx ly iq ka b kb kc kf kg kj lz kn ma kr mb kv mc md me mf bi translated"><code class="fe le lf lg lh b">initDb</code>初始化我们的数据库，确保它可以使用——基本上是连接到数据库。</li><li id="6af5" class="lx ly iq ka b kb mg kf mh kj mi kn mj kr mk kv mc md me mf bi translated"><code class="fe le lf lg lh b">getDb</code>返回一个连接的数据库对象，通过它我们可以执行所有的数据库操作。</li></ul><p id="a647" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">这个想法是，当我们第一次初始化我们的应用程序时，在我们开始监听http连接之前，我们将通过调用<code class="fe le lf lg lh b">initDb</code>来初始化我们的数据库连接，此后，我们将能够通过调用<code class="fe le lf lg lh b">getDb.</code>来获得我们连接的数据库的实例。让我们来看看<code class="fe le lf lg lh b">initDb</code>的实现。</p><pre class="li lj lk ll gt lm lh ln lo aw lp bi"><span id="9624" class="lq lr iq lh b gy ls lt l lu lv">function initDb(callback) {<br/>    if (_db) {<br/>        console.warn("Trying to init DB again!");<br/>        return callback(null, _db);<br/>    }</span><span id="fe4d" class="lq lr iq lh b gy lw lt l lu lv">client.connect(config.db.connectionString, config.db.connectionOptions, connected);</span><span id="c6c9" class="lq lr iq lh b gy lw lt l lu lv">function connected(err, db) {<br/>        if (err) {<br/>            return callback(err);<br/>        }<br/>        console.log("DB initialized - connected to: " + config.db.connectionString.split("@")[1]);<br/>        _db = db;<br/>        return callback(null, _db);<br/>    }<br/>}</span></pre><p id="f8ff" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">首先，我们检查<code class="fe le lf lg lh b">_db</code>是否已经设置。如果有，这意味着我们已经连接到数据库，我们打印一条警告消息，然后返回已经连接的数据库。如果没有设置<code class="fe le lf lg lh b">_db </code>，我们连接到数据库，设置<code class="fe le lf lg lh b">db</code>，然后返回连接的数据库。此时，我们可以通过调用下面实现的<code class="fe le lf lg lh b">getDb,</code>开始请求数据库对象:</p><pre class="li lj lk ll gt lm lh ln lo aw lp bi"><span id="5b98" class="lq lr iq lh b gy ls lt l lu lv">function getDb() {<br/>    assert.ok(_db, "Db has not been initialized. Please called init first.");<br/>    return _db;<br/>}</span></pre><p id="328c" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">非常简单。我们检查是否已经设置了<code class="fe le lf lg lh b">_db</code>(记住，如果没有设置_ <code class="fe le lf lg lh b">db</code>，那么这意味着我们没有连接到数据库)，如果没有，我们抛出一个错误。否则，我们返回连接的数据库。</p></div><div class="ab cl kx ky hu kz" role="separator"><span class="la bw bk lb lc ld"/><span class="la bw bk lb lc ld"/><span class="la bw bk lb lc"/></div><div class="ij ik il im in"><p id="d264" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">这就是我们的数据库模块。现在让我们看看如何正确使用它。在我们开始监听express服务器上的http连接之前，我们需要确保我们的数据库是连接的。所以在我们的<code class="fe le lf lg lh b">app.js</code>(或者任何你启动服务器的地方)我们需要在启动服务器之前建立连接。</p><p id="a538" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">//app.js</p><pre class="li lj lk ll gt lm lh ln lo aw lp bi"><span id="e7bc" class="lq lr iq lh b gy ls lt l lu lv">const initDb = require("./db").initDb;<br/>const getDb = require("./db").getDb;<br/>const app = require("express")();</span><span id="2e98" class="lq lr iq lh b gy lw lt l lu lv">const port = 3001;</span><span id="2909" class="lq lr iq lh b gy lw lt l lu lv">app.use("/", exampleRoute);</span><span id="241c" class="lq lr iq lh b gy lw lt l lu lv">initDb(function (err) {<br/>    app.listen(port, function (err) {<br/>        if (err) {<br/>            throw err; //<br/>        }<br/>        console.log("API Up and running on port " + port);<br/>    });<br/>);</span><span id="e78a" class="lq lr iq lh b gy lw lt l lu lv">function exampleRoute(req, res){<br/> const db = getDb();<br/> //Do things with your database connection<br/> res.json(results);<br/>}</span></pre><p id="c0d7" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">举例来说，我们的服务器上只有一条路由(<code class="fe le lf lg lh b">app.use(“/”, exampleRoute);</code>)。注意，我们首先通过调用<code class="fe le lf lg lh b">initDb</code>来初始化我们的数据库，只有在对它的回调中，我们才开始监听http连接(<code class="fe le lf lg lh b">app.listen</code>)。现在，无论何时我们点击任何路径，我们的数据库都已经连接上了，我们可以通过调用<code class="fe le lf lg lh b">getDb</code>来访问它(就像我们在exampleRoute中所做的那样)，这是一个可以被我们整个代码库共享的单一连接。</p><p id="602d" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">如果你有不同的策略在你的整个代码库中共享你的数据库，我很乐意看到它。请在评论区分享。</p><p id="8af4" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">仅此而已。</p></div></div>    
</body>
</html>