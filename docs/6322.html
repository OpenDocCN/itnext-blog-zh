<html>
<head>
<title>How to validate Kubernetes YAML files</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何验证Kubernetes YAML文件</h1>
<blockquote>原文：<a href="https://itnext.io/how-to-validate-kubernetes-yaml-files-9a17b9a30f08?source=collection_archive---------3-----------------------#2021-10-17">https://itnext.io/how-to-validate-kubernetes-yaml-files-9a17b9a30f08?source=collection_archive---------3-----------------------#2021-10-17</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><figure class="ip iq gp gr ir is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi io"><img src="../Images/735826662a4ca1f25e5020ad70612545.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*moMdTArDb0aQjw7zNkzBQg.jpeg"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">图片由<a class="ae jd" href="https://pixabay.com/users/mohamed_hassan-5229782/?utm_source=link-attribution&amp;utm_medium=referral&amp;utm_campaign=image&amp;utm_content=4576720" rel="noopener ugc nofollow" target="_blank">穆罕默德·哈桑</a>拍摄，来自<a class="ae jd" href="https://pixabay.com/?utm_source=link-attribution&amp;utm_medium=referral&amp;utm_campaign=image&amp;utm_content=4576720" rel="noopener ugc nofollow" target="_blank">皮克斯拜</a></figcaption></figure><div class=""/><div class=""><h2 id="00fa" class="pw-subtitle-paragraph kd jf jg bd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku dk translated">在Kubernetes上开发</h2></div><h2 id="c511" class="kv kw jg bd kx ky kz dn la lb lc dp ld le lf lg lh li lj lk ll lm ln lo lp lq bi translated">介绍</h2><p id="08a5" class="pw-post-body-paragraph lr ls jg lt b lu lv kh lw lx ly kk lz le ma mb mc li md me mf lm mg mh mi mj ij bi translated">在<a class="ae jd" rel="noopener ugc nofollow" target="_blank" href="/how-to-create-kubernetes-yaml-files-abb8426eeb45">之前的文章</a>中，我们已经学习了如何创建Kubernetes YAML文件。现在，让我们看看如何确保我们创建的文件不仅是有效的YAML，更重要的是遵守Kubernetes开发的最佳实践。</p><p id="c0ab" class="pw-post-body-paragraph lr ls jg lt b lu mk kh lw lx ml kk lz le mm mb mc li mn me mf lm mo mh mi mj ij bi translated">本文旨在作为验证Kubernetes清单文件的指南。如果您是开发人员、软件架构师、安全专家，或者只是对学习更多关于创建和管理Kubernetes清单的质量保证过程感兴趣，那么这篇文章就是为您准备的。</p><h2 id="3b9c" class="kv kw jg bd kx ky kz dn la lb lc dp ld le lf lg lh li lj lk ll lm ln lo lp lq bi translated">左倾哲学</h2><p id="5ab2" class="pw-post-body-paragraph lr ls jg lt b lu lv kh lw lx ly kk lz le ma mb mc li md me mf lm mg mh mi mj ij bi translated"><a class="ae jd" href="https://devopedia.org/shift-left" rel="noopener ugc nofollow" target="_blank">左移</a>运动，或者我喜欢称之为“向左扩展”,最初是为了让开发人员能够负责并拥有软件生命周期的端到端过程。</p><p id="368c" class="pw-post-body-paragraph lr ls jg lt b lu mk kh lw lx ml kk lz le mm mb mc li mn me mf lm mo mh mi mj ij bi translated">如果做得好，这意味着创建工具和支持组织结构，通过允许开发团队对他们创建和维护的软件拥有完全的所有权和控制权，来设置开发团队的成功。做错意味着大多数时候把所有的责任都“甩”给开发人员，并希望得到最好的结果。</p><p id="906f" class="pw-post-body-paragraph lr ls jg lt b lu mk kh lw lx ml kk lz le mm mb mc li mn me mf lm mo mh mi mj ij bi translated">本着向左扩展的精神，创作和管理Kubernetes产品的过程也应该是开发团队的责任。</p><p id="c1b2" class="pw-post-body-paragraph lr ls jg lt b lu mk kh lw lx ml kk lz le mm mb mc li mn me mf lm mo mh mi mj ij bi translated">Kubernetes已经有了一个强大而复杂的验证资源的流程，其形式为以下工具:</p><ul class=""><li id="e820" class="mp mq jg lt b lu mk lx ml le mr li ms lm mt mj mu mv mw mx bi translated"><a class="ae jd" href="https://kubernetes.io/docs/reference/access-authn-authz/admission-controllers/" rel="noopener ugc nofollow" target="_blank">准入控制器</a></li><li id="5e1b" class="mp mq jg lt b lu my lx mz le na li nb lm nc mj mu mv mw mx bi translated">通过<a class="ae jd" href="https://www.openpolicyagent.org/" rel="noopener ugc nofollow" target="_blank">开放策略代理</a>、<a class="ae jd" href="https://kyverno.io/" rel="noopener ugc nofollow" target="_blank"> Kyverno </a>或<a class="ae jd" href="https://www.kubewarden.io/" rel="noopener ugc nofollow" target="_blank"> Kubewarden </a>等工具实施策略</li><li id="7b54" class="mp mq jg lt b lu my lx mz le na li nb lm nc mj mu mv mw mx bi translated"><a class="ae jd" href="https://kubernetes.io/docs/concepts/policy/pod-security-policy/?spm=a2c4g.11186623.2.14.703c8b7fMCIbrz" rel="noopener ugc nofollow" target="_blank"> pod安全策略</a>(在1.21中已弃用)</li></ul><p id="71b9" class="pw-post-body-paragraph lr ls jg lt b lu mk kh lw lx ml kk lz le mm mb mc li mn me mf lm mo mh mi mj ij bi translated">这些工具很棒，但是它们属于集群操作层，更适合作为一个平台，而不是适合标准开发人员工作流程的工具。</p><p id="398b" class="pw-post-body-paragraph lr ls jg lt b lu mk kh lw lx ml kk lz le mm mb mc li mn me mf lm mo mh mi mj ij bi translated">我们接下来要看的是各种工具和方法，它们将验证过程的起点转移到开发工作流程，从而大大提高整个系统的质量。</p><p id="e0eb" class="pw-post-body-paragraph lr ls jg lt b lu mk kh lw lx ml kk lz le mm mb mc li mn me mf lm mo mh mi mj ij bi translated"><strong class="lt jh">圣杯的移位验证留下来的是为了</strong> <a class="ae jd" href="https://fsharpforfunandprofit.com/posts/designing-with-types-making-illegal-states-unrepresentable/" rel="noopener ugc nofollow" target="_blank"> <strong class="lt jh">让非法状态无可替代</strong> </a> <strong class="lt jh">。对于像YAML这样的非静态类型语言来说，这很难做到，但是使用正确的工具，这是可以做到的。</strong></p><blockquote class="nd"><p id="6eff" class="ne nf jg bd ng nh ni nj nk nl nm mj dk translated">服务或产品的质量不是你投入的东西。它是客户或顾客从中得到的。</p><p id="5a76" class="ne nf jg bd ng nh ni nj nk nl nm mj dk translated">—彼得·德鲁克</p></blockquote><h2 id="a76c" class="kv kw jg bd kx ky nn dn la lb no dp ld le np lg lh li nq lk ll lm nr lo lp lq bi translated">你将学到什么</h2><p id="b5ca" class="pw-post-body-paragraph lr ls jg lt b lu lv kh lw lx ly kk lz le ma mb mc li md me mf lm mg mh mi mj ij bi translated">阅读本文后，您将了解到:</p><ul class=""><li id="364e" class="mp mq jg lt b lu mk lx ml le mr li ms lm mt mj mu mv mw mx bi translated">了解验证左移对最终产品的影响</li><li id="f420" class="mp mq jg lt b lu my lx mz le na li nb lm nc mj mu mv mw mx bi translated">验证Kubernetes YAML文件的不同方法有哪些</li><li id="06ca" class="mp mq jg lt b lu my lx mz le na li nb lm nc mj mu mv mw mx bi translated">在CI/CD管道中自动化验证流程的好处是什么</li><li id="e710" class="mp mq jg lt b lu my lx mz le na li nb lm nc mj mu mv mw mx bi translated">了解专门用于验证不同种类的YAML文件的工具</li></ul><h2 id="e4de" class="kv kw jg bd kx ky kz dn la lb lc dp ld le lf lg lh li lj lk ll lm ln lo lp lq bi translated">先决条件</h2><p id="377f" class="pw-post-body-paragraph lr ls jg lt b lu lv kh lw lx ly kk lz le ma mb mc li md me mf lm mg mh mi mj ij bi translated">如果你想继续下去，并得到你的手脏与YAML，你需要:</p><ul class=""><li id="d5e4" class="mp mq jg lt b lu mk lx ml le mr li ms lm mt mj mu mv mw mx bi translated">带有<a class="ae jd" href="https://github.com/Microsoft/vscode-remote-release" rel="noopener ugc nofollow" target="_blank">远程开发扩展</a>的VS代码</li><li id="ab15" class="mp mq jg lt b lu my lx mz le na li nb lm nc mj mu mv mw mx bi translated"><a class="ae jd" href="https://www.docker.com/products/docker-desktop" rel="noopener ugc nofollow" target="_blank"> docker桌面</a>或任何替代品(需要能够运行容器)</li><li id="a0ad" class="mp mq jg lt b lu my lx mz le na li nb lm nc mj mu mv mw mx bi translated">克隆<a class="ae jd" href="https://github.com/Piotr1215/generate-k8s-yaml" rel="noopener ugc nofollow" target="_blank">该存储库</a></li></ul><p id="b824" class="pw-post-body-paragraph lr ls jg lt b lu mk kh lw lx ml kk lz le mm mb mc li mn me mf lm mo mh mi mj ij bi translated">请注意，存储库使用了一个<a class="ae jd" href="https://code.visualstudio.com/docs/remote/containers" rel="noopener ugc nofollow" target="_blank"> devcontainer </a>，其中包含了运行示例构建所需的所有工具和配置。因此，图像很大，所以请在运行容器之前对其进行相应的修改。</p></div><div class="ab cl ns nt hu nu" role="separator"><span class="nv bw bk nw nx ny"/><span class="nv bw bk nw nx ny"/><span class="nv bw bk nw nx"/></div><div class="ij ik il im in"><h2 id="d3ba" class="kv kw jg bd kx ky kz dn la lb lc dp ld le lf lg lh li lj lk ll lm ln lo lp lq bi translated">我们需要验证什么？</h2><p id="be97" class="pw-post-body-paragraph lr ls jg lt b lu lv kh lw lx ly kk lz le ma mb mc li md me mf lm mg mh mi mj ij bi translated">让我们更仔细地看看验证过程。我们可以将验证过程分为3个不同的类别:</p><ul class=""><li id="df30" class="mp mq jg lt b lu mk lx ml le mr li ms lm mt mj mu mv mw mx bi translated"><strong class="lt jh">YAML语法的结构验证</strong>。这是验证文件是否为有效YAML的最简单步骤。这总是一个很好的起点，如果我们的文件有YAML错误，我们希望尽快知道，甚至更好，完全防止错误。</li><li id="a173" class="mp mq jg lt b lu my lx mz le na li nb lm nc mj mu mv mw mx bi translated"><strong class="lt jh">K8s模式的语义验证</strong>。下一步是验证文件是否是正确的Kubernetes YAML文件。这个验证是由Kubernetes自动完成的，但是在这个过程中有点太晚了。记住，我们要向左移动。这个领域中一个有趣的工具是库贝瓦尔。</li><li id="a6ef" class="mp mq jg lt b lu my lx mz le na li nb lm nc mj mu mv mw mx bi translated"><strong class="lt jh">资源的实用验证</strong>。最后一个类别是验证过程从不同的上下文中查看文件的地方。我们希望检查文件和配置是否存在安全漏洞、性能问题、是否符合最佳实践、版本控制方案等等。最适合执行这种验证的工具是<strong class="lt jh">政策。</strong>在这里，我想重点介绍两个工具，trivy和datree。两者都带来了独特的视角和功能。</li></ul><figure class="oa ob oc od gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi nz"><img src="../Images/581050db7a6cd89a5e735ad0a33aaeb3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*QQvnt-OqYlIUlvYrnreA6A.png"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">K8s YAML验证。来源:作者</figcaption></figure><h2 id="431d" class="kv kw jg bd kx ky kz dn la lb lc dp ld le lf lg lh li lj lk ll lm ln lo lp lq bi translated">使用trivy进行安全检查</h2><p id="7e5d" class="pw-post-body-paragraph lr ls jg lt b lu lv kh lw lx ly kk lz le ma mb mc li md me mf lm mg mh mi mj ij bi translated">特里维可以扫描YAML文件的安全漏洞，错误配置和更多。每张支票都有一个网页，解释背后的原因及其严重性。这里唯一的问题是检查是“静态的”，我们不能直接影响是否应该跳过其中的任何一项(通过设置严重性标志，这在一定程度上是可能的)</p><figure class="oa ob oc od gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi oe"><img src="../Images/cb5fcf1886c2eac703fee756a9a7ccd4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*9qFQcAXnfciu_PUB1q2y2A.png"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">K8s部署文件的繁琐扫描。来源:作者</figcaption></figure><h2 id="bb53" class="kv kw jg bd kx ky kz dn la lb lc dp ld le lf lg lh li lj lk ll lm ln lo lp lq bi translated">使用datree执行策略</h2><p id="8b29" class="pw-post-body-paragraph lr ls jg lt b lu lv kh lw lx ly kk lz le ma mb mc li md me mf lm mg mh mi mj ij bi translated"><a class="ae jd" href="https://www.datree.io/" rel="noopener ugc nofollow" target="_blank"> Datree </a>采取了不同的方法，开发者可以打开或关闭策略。</p><p id="5330" class="pw-post-body-paragraph lr ls jg lt b lu mk kh lw lx ml kk lz le mm mb mc li mn me mf lm mo mh mi mj ij bi translated">可以看到datree首先检查文件是否是有效的YAML，然后根据Kubernetes模式验证内容。这满足了我们的结构-&gt;语义-&gt;语用验证流程！</p><figure class="oa ob oc od gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi of"><img src="../Images/f8872e64203848ec222694b7a89bc51e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*qGAkDCx2DKe48O-BrV84yA.png"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">datree策略检查。来源:作者</figcaption></figure><p id="7b98" class="pw-post-body-paragraph lr ls jg lt b lu mk kh lw lx ml kk lz le mm mb mc li mn me mf lm mo mh mi mj ij bi translated">每个检查都与一个可配置的策略集相关联。可以打开和关闭策略，以满足个性化验证方案的需求。</p><figure class="oa ob oc od gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi og"><img src="../Images/abe1c47d06c06dc920f2b7a7aa44e1be.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*T4lugHE8kFCcEVIZxorSIA.png"/></div></div></figure><p id="f4ed" class="pw-post-body-paragraph lr ls jg lt b lu mk kh lw lx ml kk lz le mm mb mc li mn me mf lm mo mh mi mj ij bi translated">这使我们更接近于将验证过程左移，并授权开发人员控制整个过程。</p><h2 id="9072" class="kv kw jg bd kx ky kz dn la lb lc dp ld le lf lg lh li lj lk ll lm ln lo lp lq bi translated">通过CI/CD管道实现自动化</h2><p id="78e1" class="pw-post-body-paragraph lr ls jg lt b lu lv kh lw lx ly kk lz le ma mb mc li md me mf lm mg mh mi mj ij bi translated">每一个重复开发过程的最终目标都是自动化它。将来自datree和trivy的验证规则添加到我们的CI管道中很容易。它们提供了与所有主要git提供商的丰富集成，如GitHub、GitLab以及Helm安装插件等。</p><h2 id="abf2" class="kv kw jg bd kx ky kz dn la lb lc dp ld le lf lg lh li lj lk ll lm ln lo lp lq bi translated">结束语</h2><p id="3a87" class="pw-post-body-paragraph lr ls jg lt b lu lv kh lw lx ly kk lz le ma mb mc li md me mf lm mg mh mi mj ij bi translated">Kubernetes的故事对开发者来说仍有许多不足之处。我很高兴看到创建了一些工具来解决在Kubernetes上开发的一些困难。像datree这样的工具特别关注并支持左移运动。</p><p id="5dda" class="pw-post-body-paragraph lr ls jg lt b lu mk kh lw lx ml kk lz le mm mb mc li mn me mf lm mo mh mi mj ij bi translated">开发人员完全控制着他们的软件生命周期、工具和组织结构，旨在授权和支持开发团队完成他们创造令人惊叹的软件的使命。这是对我们所有人都有利的未来。</p></div></div>    
</body>
</html>