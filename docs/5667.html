<html>
<head>
<title>Istio: shared Ingress/AWS ALB, Helm chart with conditions, Istio, and ExternalDNS</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Istio:共享入口/AWS ALB、带条件的舵图表、Istio和外部</h1>
<blockquote>原文：<a href="https://itnext.io/istio-shared-ingress-aws-alb-helm-chart-with-conditions-istio-and-externaldns-c75b5d188d51?source=collection_archive---------6-----------------------#2021-04-27">https://itnext.io/istio-shared-ingress-aws-alb-helm-chart-with-conditions-istio-and-externaldns-c75b5d188d51?source=collection_archive---------6-----------------------#2021-04-27</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/7b10e0b10e383f972a219ab5303b948c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*kkvtw5c0lGhRYKcEogx7zw.jpeg"/></div></div></figure><p id="c7c9" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">让我们带着Istio继续我们的旅程。</p><p id="958f" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">以前的零件:</p><ol class=""><li id="a6e3" class="kw kx iq ka b kb kc kf kg kj ky kn kz kr la kv lb lc ld le bi translated"><a class="ae lf" href="https://rtfm.co.ua/en/istio-an-overview-and-running-service-mesh-in-kubernetes/" rel="noopener ugc nofollow" target="_blank">Istio:Kubernetes中的概述和运行服务网格</a></li><li id="1589" class="kw kx iq ka b kb lg kf lh kj li kn lj kr lk kv lb lc ld le bi translated"><a class="ae lf" href="https://rtfm.co.ua/en/istio-external-aws-application-loadbalancer-and-istio-ingress-gateway/" rel="noopener ugc nofollow" target="_blank"> Istio:外部AWS应用负载平衡器和Istio入口网关</a></li></ol><p id="24d8" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">除了Istio，在这篇文章中，我们还将配置ExternalDNS，详见<a class="ae lf" href="https://rtfm.co.ua/en/kubernetes-update-aws-route53-dns-from-an-ingress/" rel="noopener ugc nofollow" target="_blank"> Kubernetes:从入口</a>更新AWS Route53 DNS。</p><p id="dbba" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">下面描述的一切都是一种概念验证，将被部署到同一个AWS Elastic Kubernetes服务开发集群。</p><ul class=""><li id="c5f6" class="kw kx iq ka b kb kc kf kg kj ky kn kz kr la kv ll lc ld le bi translated"><a class="ae lf" href="https://rtfm.co.ua/en/istio-shared-ingress-aws-alb-helm-chart-with-conditions-istio-and-externaldns/#Goals" rel="noopener ugc nofollow" target="_blank">目标</a></li><li id="f251" class="kw kx iq ka b kb lg kf lh kj li kn lj kr lk kv ll lc ld le bi translated"><a class="ae lf" href="https://rtfm.co.ua/en/istio-shared-ingress-aws-alb-helm-chart-with-conditions-istio-and-externaldns/#Shared_IngressAWS_ALB" rel="noopener ugc nofollow" target="_blank">共享入口/AWS ALB </a></li><li id="13bc" class="kw kx iq ka b kb lg kf lh kj li kn lj kr lk kv ll lc ld le bi translated"><a class="ae lf" href="https://rtfm.co.ua/en/istio-shared-ingress-aws-alb-helm-chart-with-conditions-istio-and-externaldns/#Testing_applications" rel="noopener ugc nofollow" target="_blank">测试应用</a></li><li id="9afb" class="kw kx iq ka b kb lg kf lh kj li kn lj kr lk kv ll lc ld le bi translated"><a class="ae lf" href="https://rtfm.co.ua/en/istio-shared-ingress-aws-alb-helm-chart-with-conditions-istio-and-externaldns/#Istio_shared_IngressAWS_ALB_and_Helm" rel="noopener ugc nofollow" target="_blank"> Istio:共享入口/AWS ALB和头盔</a></li><li id="83f9" class="kw kx iq ka b kb lg kf lh kj li kn lj kr lk kv ll lc ld le bi translated"><a class="ae lf" href="https://rtfm.co.ua/en/istio-shared-ingress-aws-alb-helm-chart-with-conditions-istio-and-externaldns/#Planning_conditions" rel="noopener ugc nofollow" target="_blank">规划:条件</a></li><li id="88e8" class="kw kx iq ka b kb lg kf lh kj li kn lj kr lk kv ll lc ld le bi translated"><a class="ae lf" href="https://rtfm.co.ua/en/istio-shared-ingress-aws-alb-helm-chart-with-conditions-istio-and-externaldns/#Creating_Helm_chart_and_templates" rel="noopener ugc nofollow" target="_blank">创建舵图和模板</a></li><li id="4a05" class="kw kx iq ka b kb lg kf lh kj li kn lj kr lk kv ll lc ld le bi translated"><a class="ae lf" href="https://rtfm.co.ua/en/istio-shared-ingress-aws-alb-helm-chart-with-conditions-istio-and-externaldns/#Deployment" rel="noopener ugc nofollow" target="_blank">部署</a></li><li id="0142" class="kw kx iq ka b kb lg kf lh kj li kn lj kr lk kv ll lc ld le bi translated"><a class="ae lf" href="https://rtfm.co.ua/en/istio-shared-ingress-aws-alb-helm-chart-with-conditions-istio-and-externaldns/#Service_VirtualService_Gateway" rel="noopener ugc nofollow" target="_blank">服务，虚拟服务，网关</a></li><li id="777b" class="kw kx iq ka b kb lg kf lh kj li kn lj kr lk kv ll lc ld le bi translated"><a class="ae lf" href="https://rtfm.co.ua/en/istio-shared-ingress-aws-alb-helm-chart-with-conditions-istio-and-externaldns/#Ingress" rel="noopener ugc nofollow" target="_blank">入口</a></li><li id="e2c7" class="kw kx iq ka b kb lg kf lh kj li kn lj kr lk kv ll lc ld le bi translated"><a class="ae lf" href="https://rtfm.co.ua/en/istio-shared-ingress-aws-alb-helm-chart-with-conditions-istio-and-externaldns/#Istio_and_ExternalDNS" rel="noopener ugc nofollow" target="_blank"> Istio和ExternalDNS </a></li><li id="07bb" class="kw kx iq ka b kb lg kf lh kj li kn lj kr lk kv ll lc ld le bi translated"><a class="ae lf" href="https://rtfm.co.ua/en/istio-shared-ingress-aws-alb-helm-chart-with-conditions-istio-and-externaldns/#ExternalDNS_doesnt_create_records_for_Istio_Gateway_and_VirtualService_No_endpoints_could_be_generated" rel="noopener ugc nofollow" target="_blank"> ExternalDNS不会为Istio Gateway和VirtualService创建记录:“无法生成端点”</a></li></ul><h1 id="0e05" class="lm ln iq bd lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj bi translated">目标</h1><p id="c8e2" class="pw-post-body-paragraph jy jz iq ka b kb mk kd ke kf ml kh ki kj mm kl km kn mn kp kq kr mo kt ku kv ij bi translated">所以，现在我有三个任务:</p><ol class=""><li id="22fc" class="kw kx iq ka b kb kc kf kg kj ky kn kz kr la kv lb lc ld le bi translated">测试一个共享的AWS应用程序负载平衡器(AWS ALB)和Istio入口网关如何与不同名称空间中的应用程序一起工作</li><li id="202d" class="kw kx iq ka b kb lg kf lh kj li kn lj kr lk kv lb lc ld le bi translated">创建带有模板的舵图，以便能够选择创建入口、Istio网关和Istio虚拟服务</li><li id="c5d6" class="kw kx iq ka b kb lg kf lh kj li kn lj kr lk kv lb lc ld le bi translated">添加Istio网关或VirtualService时，配置ExternalDNS以在AWS Route53中创建记录</li></ol><p id="263a" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">首先，让我们看看Istio Ingress Gateway如何与位于专用名称空间中的应用程序一起工作。为此，我们将创建一个入口，它将创建一个带有<a class="ae lf" href="https://rtfm.co.ua/en/aws-elastic-kubernetes-service-running-alb-ingress-controller/" rel="noopener ugc nofollow" target="_blank"> ALB入口控制器</a>的AWS应用负载平衡器，以及两个测试应用，每个应用都有自己的服务、网关和虚拟服务。</p><p id="43c0" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在Ingress/AWS ALB中，我们将描述主机，这将触发<a class="ae lf" href="https://rtfm.co.ua/kubernetes-obnovlenie-dns-v-route53-pri-sozdanii-ingress/" rel="noopener ugc nofollow" target="_blank"> ExternalDNS </a>创建记录。此外，这里我们将执行SSL终止—将从AWS证书管理器附加SSL证书。</p><p id="f760" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在每个应用的网关中，我们将开放Istio入口网关上的端口，并添加该网关将接受流量的主机。</p><p id="3b51" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">共享入口将在<code class="fe mp mq mr ms b">istio-system</code>名称空间中创建，因为它需要访问Istio入口服务。</p><p id="ae3d" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">实际上，我们可以创建一个共享网关，但是在讨论的最后<a class="ae lf" href="https://discuss.istio.io/t/istio-ingressgateway-controller-and-namespaces/1217/14" rel="noopener ugc nofollow" target="_blank">这里&gt; &gt; &gt; </a>人们说每个应用程序有一个专用网关会更好，这似乎更正确，所以让我们这样做。</p><p id="607c" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">因此，现在我们将创建:</p><ol class=""><li id="696d" class="kw kx iq ka b kb kc kf kg kj ky kn kz kr la kv lb lc ld le bi translated">专用入口/AWS ALB，在Route53的<code class="fe mp mq mr ms b">istio-system</code>命名空间中有两个测试记录</li><li id="4600" class="kw kx iq ka b kb lg kf lh kj li kn lj kr lk kv lb lc ld le bi translated">在名称空间<code class="fe mp mq mr ms b">backend-app-1-ns</code>和<code class="fe mp mq mr ms b">backend-app-2-ns</code>中测试<em class="mt"> app1 </em>和<em class="mt"> app2 </em>相应地，每个应用都有自己的部署、服务、网关和虚拟服务</li></ol><p id="03b0" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">第二个任务将更加有趣:需要创建Helm模板来在不同的环境(类似于开发和生产)上部署应用程序，以在具有不同入口和Istio配置的各种环境上部署应用程序。</p><p id="f904" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在第三项任务中，我们将配置ExternalDNS以与Istio Gateway和VirtualService一起工作。</p><p id="6d2a" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">下面的一些部分可能会令人困惑，但我已经尽可能简单地描述了它们。</p><h1 id="594f" class="lm ln iq bd lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj bi translated">共享入口/AWS ALB</h1><p id="982b" class="pw-post-body-paragraph jy jz iq ka b kb mk kd ke kf ml kh ki kj mm kl km kn mn kp kq kr mo kt ku kv ij bi translated">为Ingress/ALB创建清单文件— <code class="fe mp mq mr ms b">common-ingress-gateway.yaml</code>:</p><pre class="mu mv mw mx gt my ms mz na aw nb bi"><span id="d56e" class="nc ln iq ms b gy nd ne l nf ng">---<br/>apiVersion: extensions/v1beta1<br/>kind: Ingress<br/>metadata:<br/>  name: backend-common-alb<br/>  namespace: istio-system<br/>  annotations:<br/>    # create AWS Application LoadBalancer<br/>    kubernetes.io/ingress.class: alb<br/>    # external type<br/>    alb.ingress.kubernetes.io/scheme: internet-facing<br/>    # AWS Certificate Manager certificate's ARN<br/>    alb.ingress.kubernetes.io/certificate-arn: "arn:aws:acm:us-east-2:534***385:certificate/db886018-c173-43d0-b1be-b940de71f2a2"<br/>    # open ports 80 and 443 <br/>    alb.ingress.kubernetes.io/listen-ports: '[{"HTTP": 80}, {"HTTPS":443}]'<br/>    # redirect all HTTP to HTTPS<br/>    alb.ingress.kubernetes.io/actions.ssl-redirect: '{"Type": "redirect", "RedirectConfig": { "Protocol": "HTTPS", "Port": "443", "StatusCode": "HTTP_301"}}'<br/>    # ExternalDNS settings: <a class="ae lf" href="https://rtfm.co.ua/en/kubernetes-update-aws-route53-dns-from-an-ingress/" rel="noopener ugc nofollow" target="_blank">https://rtfm.co.ua/en/kubernetes-update-aws-route53-dns-from-an-ingress/</a><br/>    external-dns.alpha.kubernetes.io/hostname: "app1-test-common-ingress.example.com, app2-test-common-ingress.example.com"<br/>spec:<br/>  rules:<br/>  - http:<br/>      paths:<br/>        - path: /*<br/>          backend:<br/>            serviceName: ssl-redirect<br/>            servicePort: use-annotation<br/>        - path: /*<br/>          backend:<br/>            serviceName: istio-ingressgateway<br/>            servicePort: 80</span></pre><p id="d238" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">这里，在<code class="fe mp mq mr ms b">annotations</code>中，我们描述了将由外部域名创建的域名，它们将被映射到AWS ALB的URL，在<code class="fe mp mq mr ms b">backend</code>中，我们将把所有流量发送到<code class="fe mp mq mr ms b">istio-ingressgateway</code> Kubernetes服务。</p><p id="9433" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">部署它:</p><pre class="mu mv mw mx gt my ms mz na aw nb bi"><span id="0f59" class="nc ln iq ms b gy nd ne l nf ng">$ kubectl apply -f common-ingress-gateway.yaml<br/>ingress.extensions/backend-common-alb created</span></pre><p id="8b54" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">检查入口/大气:</p><pre class="mu mv mw mx gt my ms mz na aw nb bi"><span id="5347" class="nc ln iq ms b gy nd ne l nf ng">$ kubectl -n istio-system get ingress backend-common-alb<br/>NAME CLASS HOSTS ADDRESS PORTS AGE<br/>backend-common-alb &lt;none&gt; * aadca942-***1826302788.us-east-2.elb.amazonaws.com 80 72s</span></pre><p id="38b6" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">和外部DNS日志:</p><pre class="mu mv mw mx gt my ms mz na aw nb bi"><span id="fb0d" class="nc ln iq ms b gy nd ne l nf ng">…<br/>time=”2021–04–12T09:45:02Z” level=info msg=”Desired change: CREATE app-1-test-common-ingress.example.com A [Id: /hostedzone/Z30KLN6M3D0LB6]”<br/>time=”2021–04–12T09:45:02Z” level=info msg=”Desired change: CREATE app-1-test-common-ingress.example.com TXT [Id: /hostedzone/Z30KLN6M3D0LB6]”<br/>time=”2021–04–12T09:45:02Z” level=info msg=”Desired change: CREATE app-2-test-common-ingress.example.com A [Id: /hostedzone/Z30KLN6M3D0LB6]”<br/>time=”2021–04–12T09:45:02Z” level=info msg=”Desired change: CREATE app-2-test-common-ingress.example.com TXT [Id: /hostedzone/Z30KLN6M3D0LB6]”<br/>time=”2021–04–12T09:45:03Z” level=info msg=”4 record(s) in zone example.com. [Id: /hostedzone/Z30KLN6M3D0LB6] were successfully updated”<br/>…</span></pre><p id="ade3" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">尝试访问URL，必须得到一个错误，因为Istio入口网关尚未配置:</p><pre class="mu mv mw mx gt my ms mz na aw nb bi"><span id="7639" class="nc ln iq ms b gy nd ne l nf ng">$ curl -I <a class="ae lf" href="https://app-1-test-common-ingress.example.com" rel="noopener ugc nofollow" target="_blank">https://app-1-test-common-ingress.example.com</a><br/>HTTP/2 502<br/>date: Mon, 12 Apr 2021 09:46:11 GMT<br/>server: istio-envoy</span></pre><p id="5ee6" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">是的，502错误，因为Istio入口网关还没有域的路由:</p><pre class="mu mv mw mx gt my ms mz na aw nb bi"><span id="54cb" class="nc ln iq ms b gy nd ne l nf ng">$ istioctl proxy-config routes -n istio-system istio-ingressgateway-8459df68cb-bh76b<br/>NOTE: This output only contains routes loaded via RDS.<br/>NAME DOMAINS MATCH VIRTUAL SERVICE<br/>* /healthz/ready*<br/>* /stats/prometheus*</span></pre><p id="8bab" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">现在，让我们创建测试应用程序，我们将在其中描述Istio入口网关的设置。</p><h2 id="b9c8" class="nc ln iq bd lo nh ni dn ls nj nk dp lw kj nl nm ma kn nn no me kr np nq mi nr bi translated">测试应用程序</h2><p id="0cb1" class="pw-post-body-paragraph jy jz iq ka b kb mk kd ke kf ml kh ki kj mm kl km kn mn kp kq kr mo kt ku kv ij bi translated">除了应用程序和服务的名称空间和名称之外，这两个应用程序完全相似。</p><p id="ef8e" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在这里，我们将创建:</p><ul class=""><li id="fb63" class="kw kx iq ka b kb kc kf kg kj ky kn kz kr la kv ll lc ld le bi translated">命名空间</li><li id="43d5" class="kw kx iq ka b kb lg kf lh kj li kn lj kr lk kv ll lc ld le bi translated">部署</li><li id="46cf" class="kw kx iq ka b kb lg kf lh kj li kn lj kr lk kv ll lc ld le bi translated">服务</li><li id="9837" class="kw kx iq ka b kb lg kf lh kj li kn lj kr lk kv ll lc ld le bi translated">门</li><li id="fb03" class="kw kx iq ka b kb lg kf lh kj li kn lj kr lk kv ll lc ld le bi translated">虚拟服务</li></ul><p id="75ff" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">整个清单如下:</p><pre class="mu mv mw mx gt my ms mz na aw nb bi"><span id="7ae2" class="nc ln iq ms b gy nd ne l nf ng">---<br/>apiVersion: v1<br/>kind: Namespace<br/>metadata:<br/>  name: backend-app-1-ns<br/>  labels:<br/>    istio-injection:<br/>      enabled<br/>---<br/>apiVersion: apps/v1<br/>kind: Deployment<br/>metadata:<br/>  name: backend-app-1-deploy<br/>  namespace: backend-app-1-ns<br/>  labels:<br/>    app: backend-app-1<br/>    version: v1<br/>spec:<br/>  replicas: 2<br/>  selector:<br/>    matchLabels:<br/>      app: backend-app-1<br/>  template:<br/>    metadata:<br/>      labels:<br/>        app: backend-app-1<br/>        version: v1<br/>    spec: <br/>      containers:<br/>      - name: app1<br/>        image: nginxdemos/hello<br/>        ports:<br/>        - containerPort: 80<br/>        resources:<br/>          requests:<br/>            cpu: 100m<br/>            memory: 100Mi<br/>        readinessProbe:<br/>          httpGet:<br/>            path: /<br/>            port: 80<br/>---<br/>apiVersion: v1<br/>kind: Service<br/>metadata:<br/>  name: backend-app-1-servcie<br/>  namespace: backend-app-1-ns<br/>spec:       <br/>  selector:<br/>    app: backend-app-1<br/>  ports:    <br/>    - name: http<br/>      protocol: TCP<br/>      port: 80<br/>---<br/>apiVersion: networking.istio.io/v1alpha3<br/>kind: Gateway<br/>metadata:<br/>  name: backend-app-1-gateway<br/>  namespace: backend-app-1-ns<br/>spec:<br/>  selector:<br/>    istio: ingressgateway<br/>  servers:<br/>  - port:<br/>      number: 80<br/>      name: http<br/>      protocol: HTTP<br/>    hosts:<br/>    - "app-1-test-common-ingress.example.com"<br/>---<br/>apiVersion: networking.istio.io/v1alpha3<br/>kind: VirtualService<br/>metadata:<br/>  name: backend-app-1-virtualservice<br/>  namespace: backend-app-1-ns<br/>spec:<br/>  hosts:<br/>  - "app-1-test-common-ingress.example.com"<br/>  gateways:<br/>  - backend-app-1-gateway<br/>  http:<br/>  - match:<br/>    - uri:<br/>        prefix: /<br/>    route:<br/>    - destination:<br/>        host: backend-app-1-servcie<br/>        port:<br/>          number: 80</span></pre><p id="2d6d" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">部署它:</p><pre class="mu mv mw mx gt my ms mz na aw nb bi"><span id="332a" class="nc ln iq ms b gy nd ne l nf ng">$ kubectl apply -f app1.yaml<br/>namespace/backend-app-1-ns created<br/>deployment.apps/backend-app-1-deploy created<br/>service/backend-app-1-servcie created<br/>gateway.networking.istio.io/backend-app-1-gateway created<br/>virtualservice.networking.istio.io/backend-app-1-virtualservice created</span></pre><p id="cef5" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">复制清单文件，将<em class="mt"> app-1 </em>改为<em class="mt"> app-2 </em>，同样部署:</p><pre class="mu mv mw mx gt my ms mz na aw nb bi"><span id="e6ae" class="nc ln iq ms b gy nd ne l nf ng">$ kubectl apply -f app2.yaml<br/>namespace/backend-app-2-ns created<br/>deployment.apps/backend-app-2-deploy created<br/>service/backend-app-2-servcie created<br/>gateway.networking.istio.io/backend-app-2-gateway created<br/>virtualservice.networking.istio.io/backend-app-2-virtualservice created</span></pre><p id="7406" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">再次检查Istio的路线:</p><pre class="mu mv mw mx gt my ms mz na aw nb bi"><span id="f2cc" class="nc ln iq ms b gy nd ne l nf ng">$ istioctl proxy-config routes -n istio-system istio-ingressgateway-8459df68cb-bh76b=<br/>NOTE: This output only contains routes loaded via RDS.<br/>NAME DOMAINS MATCH VIRTUAL SERVICE<br/>http.80 app-1-test-common-ingress.example.com /* backend-app-1-virtualservice.backend-app-1-ns<br/>http.80 app-2-test-common-ingress.example.com /* backend-app-2-virtualservice.backend-app-2-ns</span></pre><p id="17fe" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">并尝试访问<em class="mt"> app-1 </em>的URL:</p><pre class="mu mv mw mx gt my ms mz na aw nb bi"><span id="796f" class="nc ln iq ms b gy nd ne l nf ng">$ curl -I <a class="ae lf" href="https://app-1-test-common-ingress.example.com" rel="noopener ugc nofollow" target="_blank">https://app-1-test-common-ingress.example.com</a><br/>HTTP/2 200<br/>date: Mon, 12 Apr 2021 09:52:13 GMT<br/>content-type: text/html<br/>server: istio-envoy</span></pre><p id="9e27" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">酷，现在一切正常。现在，我们有一个用Kubernetes Ingress创建的共享AWS ALB，它通过Istio Ingress网关向两个专用应用程序和专用名称空间发送流量。</p><p id="020f" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">丢弃资源，但将入口留在共享负载平衡器中，以供进一步测试:</p><pre class="mu mv mw mx gt my ms mz na aw nb bi"><span id="3708" class="nc ln iq ms b gy nd ne l nf ng">$ kubectl delete -f app1.yaml<br/>$ kubectl delete -f app2.yaml</span></pre><p id="8ba7" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">让我们看看舵轮图。</p><h1 id="99d8" class="lm ln iq bd lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj bi translated">Istio:共享入口/AWS ALB和头盔</h1><h2 id="119c" class="nc ln iq bd lo nh ni dn ls nj nk dp lw kj nl nm ma kn nn no me kr np nq mi nr bi translated">规划:条件</h2><p id="fee5" class="pw-post-body-paragraph jy jz iq ka b kb mk kd ke kf ml kh ki kj mm kl km kn mn kp kq kr mo kt ku kv ij bi translated">下面的任务很重要:我们有一个开发EKS集群，和一个生产EKS。</p><p id="429c" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在开发集群上，我们已经有了Istio，它正在那里进行测试，但不是针对所有在那里运行的应用程序。在生产集群上，我们还没有安装Ietio，但将来会安装。</p><p id="3740" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">此外，我们所有的应用程序现在都在专用的名称空间中，并且有专用的Ingress/AWS ALB。</p><p id="033e" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在开发集群上，我想改变这种方法，现在使用共享的Ingress/ALB，并通过Istio Ingress网关发送所有流量，但在生产集群上，保持原样，即每个应用程序将使用自己的ALB，目前，他们将直接向应用程序的服务发送流量，将来，当我们在生产集群上实施Istio时，我们需要将Ingress更改为使用Istio Ingress网关。</p><p id="b28a" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">但是，开发和生产应用程序可能会使用或不使用Istio，因为它在我们的架构中还处于“早期阶段”,并且应用程序的一些时间设置会有所不同，因此需要创建这样一个掌舵图，它可以配置必要的资源和入口设置。</p><p id="1048" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">所以，一开始，需要т.е。во-первых — надо确定图表使用自己的入口还是共享的入口？第二件事是，如果它使用自己的入口，它将使用哪个后端——Istio入口网关还是应用程序的公共服务？如果它将使用Istio入口网关，图表必须创建网关和虚拟服务资源。</p><p id="5c38" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">因此，我们的模板必须接受三种配置方案:</p><ol class=""><li id="8e6b" class="kw kx iq ka b kb kc kf kg kj ky kn kz kr la kv lb lc ld le bi translated">使用共享负载平衡器和Istio: Istio入口网关负载平衡器和Istio入口网关服务作为<code class="fe mp mq mr ms b">backend</code></li><li id="2f42" class="kw kx iq ka b kb lg kf lh kj li kn lj kr lk kv lb lc ld le bi translated">拥有/专用于应用和Istio入口网关的负载平衡器:使用Istio入口网关服务为应用创建入口<code class="fe mp mq mr ms b">backend</code></li><li id="e2c6" class="kw kx iq ka b kb lg kf lh kj li kn lj kr lk kv lb lc ld le bi translated">拥有/专用于应用程序的负载平衡器，但没有Istio:使用应用程序的服务作为<code class="fe mp mq mr ms b">backend</code>为应用程序创建入口</li></ol><p id="3355" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">即:</p><ol class=""><li id="ddc5" class="kw kx iq ka b kb kc kf kg kj ky kn kz kr la kv lb lc ld le bi translated">入口是共享的还是自己的？</li><li id="436b" class="kw kx iq ka b kb lg kf lh kj li kn lj kr lk kv lb lc ld le bi translated">如果共享—不创建入口资源</li><li id="7954" class="kw kx iq ka b kb lg kf lh kj li kn lj kr lk kv lb lc ld le bi translated">如果拥有，然后创建一个入口，但选择后端Istio入口服务，或一个应用程序的公共Kubernetes服务</li><li id="dfc7" class="kw kx iq ka b kb lg kf lh kj li kn lj kr lk kv lb lc ld le bi translated">入口后端——是应用程序的组织还是服务？</li><li id="6c23" class="kw kx iq ka b kb lg kf lh kj li kn lj kr lk kv lb lc ld le bi translated">如果是Istio，那么需要将<code class="fe mp mq mr ms b">backend</code>设置为<code class="fe mp mq mr ms b">serviceName: istio-ingressgateway</code>，并创建网关和虚拟服务资源</li><li id="b406" class="kw kx iq ka b kb lg kf lh kj li kn lj kr lk kv lb lc ld le bi translated">如果是应用程序的服务，则将<code class="fe mp mq mr ms b">baсkend</code>设置为<code class="fe mp mq mr ms b">serviceName: &lt;APPNAME&gt;-service</code>，不创建网关和虚拟服务资源</li></ol><p id="d9fe" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">为了实现这个目标，让我们使用一个<code class="fe mp mq mr ms b">values.yaml</code>——我们为开发和生产环境准备了专用文件。</p><p id="619f" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在这些文件中，我们可以定义两个参数— <code class="fe mp mq mr ms b">istio.enabled</code>和<code class="fe mp mq mr ms b">ingress.enabled</code>。</p><p id="5ba7" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">这将使我们能够为Dev <code class="fe mp mq mr ms b">ingress.enabled=false</code>设置，但不创建入口，而是设置<code class="fe mp mq mr ms b">istio.enabled==true</code>并创建网关和VirtualService，这将由来自<code class="fe mp mq mr ms b">istio-system</code>名称空间的共享入口/ALB使用。</p><p id="0b0d" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">对于生产，我们将能够设置<code class="fe mp mq mr ms b">ingress.enabled=true</code>和<code class="fe mp mq mr ms b">istio.enabled=false</code>，然后图表将通过当前使用的方案进行部署，稍后，当我们在生产集群上实施Istio时，我们将这些值设置为<code class="fe mp mq mr ms b">ingress.enabled=true</code>和<code class="fe mp mq mr ms b">istio.enabled=true</code>，这将创建一个专用的入口/负载平衡器，它将通过Istio入口网关发送流量。</p><p id="4a29" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">好吧，我们试试。</p><h2 id="633f" class="nc ln iq bd lo nh ni dn ls nj nk dp lw kj nl nm ma kn nn no me kr np nq mi nr bi translated">创建舵图和模板</h2><p id="89c5" class="pw-post-body-paragraph jy jz iq ka b kb mk kd ke kf ml kh ki kj mm kl km kn mn kp kq kr mo kt ku kv ij bi translated">创建新图表:</p><pre class="mu mv mw mx gt my ms mz na aw nb bi"><span id="1a86" class="nc ln iq ms b gy nd ne l nf ng">$ helm create app-1<br/>Creating app-1</span></pre><p id="7289" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">创建目录以保存用于开发和生产的<code class="fe mp mq mr ms b">values.yaml</code>:</p><pre class="mu mv mw mx gt my ms mz na aw nb bi"><span id="378b" class="nc ln iq ms b gy nd ne l nf ng">$ mkdir -p app-1/env/{dev,prod}</span></pre><p id="299d" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">删除默认模板和值:</p><pre class="mu mv mw mx gt my ms mz na aw nb bi"><span id="3f30" class="nc ln iq ms b gy nd ne l nf ng">$ rm -r app-1/templates/* app-1/values.yaml</span></pre><p id="04ba" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在这些目录中创建自己的值文件:</p><pre class="mu mv mw mx gt my ms mz na aw nb bi"><span id="5da1" class="nc ln iq ms b gy nd ne l nf ng">$ vim -p app-1/env/dev/values.yaml app-1/env/prod/values.yaml</span></pre><p id="2554" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">对于开发人员— <code class="fe mp mq mr ms b">app-1/env/dev/values.yaml</code>:</p><pre class="mu mv mw mx gt my ms mz na aw nb bi"><span id="03b2" class="nc ln iq ms b gy nd ne l nf ng">appConfig:<br/>  name: "backend-app-1"<br/>  version: "v1"<br/>  url: "dev-app-1-test-common-ingress.example.com"<br/>  <br/>istio:<br/>  enabled: true<br/>    <br/>ingress:<br/>  enabled: false</span></pre><p id="6b21" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">不要创建入口，而是创建网关和虚拟服务。</p><p id="03fc" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">生产— <code class="fe mp mq mr ms b">app-1/env/prod/values.yaml</code>:</p><pre class="mu mv mw mx gt my ms mz na aw nb bi"><span id="eae2" class="nc ln iq ms b gy nd ne l nf ng">appConfig:<br/>  name: "backend-app-1"<br/>  version: "v1"<br/>  url: "prod-app-1-test-common-ingress.example.com"<br/>  <br/>istio:<br/>  enabled: false<br/>  <br/>ingress:<br/>  enabled: true</span></pre><p id="4106" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在这里，将创建一个入口作为专用AWS ALB，但不会创建资源—入口将直接向应用程序的服务发送流量</p><p id="3703" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">创建模板文件:</p><pre class="mu mv mw mx gt my ms mz na aw nb bi"><span id="f072" class="nc ln iq ms b gy nd ne l nf ng">$ vim -p app-1/templates/ingress.yaml app-1/templates/service.yaml app-1/templates/deployment.yaml</span></pre><p id="c53a" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我们不会在那些模板中定义<code class="fe mp mq mr ms b">namespace</code>(仅用于入口，见下文)，因为名称空间将由Helm在部署期间创建。</p><h2 id="ec86" class="nc ln iq bd lo nh ni dn ls nj nk dp lw kj nl nm ma kn nn no me kr np nq mi nr bi translated">部署</h2><p id="a692" class="pw-post-body-paragraph jy jz iq ka b kb mk kd ke kf ml kh ki kj mm kl km kn mn kp kq kr mo kt ku kv ij bi translated">这里没有变化，只是一些值取自<code class="fe mp mq mr ms b">values.yaml</code>:</p><pre class="mu mv mw mx gt my ms mz na aw nb bi"><span id="ed48" class="nc ln iq ms b gy nd ne l nf ng">--- <br/>apiVersion: apps/v1<br/>kind: Deployment<br/>metadata:<br/>  name: {{ .Values.appConfig.name }}-deploy<br/>  labels:<br/>    app: {{ .Values.appConfig.name }}<br/>    version: {{ .Values.appConfig.version }}<br/>spec:<br/>  replicas: 2<br/>  selector:<br/>    matchLabels:<br/>      app: {{ .Values.appConfig.name }}<br/>  template: <br/>    metadata:<br/>      labels:<br/>        app: {{ .Values.appConfig.name }}<br/>        version: {{ .Values.appConfig.version }}<br/>    spec: <br/>      containers:<br/>      - name: web-app<br/>        image: nginxdemos/hello<br/>        ports:<br/>        - containerPort: 80<br/>        resources:<br/>          requests:<br/>            cpu: 100m<br/>            memory: 100Mi<br/>        readinessProbe:<br/>          httpGet:<br/>            path: /<br/>            port: 80</span></pre><h2 id="95a6" class="nc ln iq bd lo nh ni dn ls nj nk dp lw kj nl nm ma kn nn no me kr np nq mi nr bi translated">服务，虚拟服务，网关</h2><p id="95cf" class="pw-post-body-paragraph jy jz iq ka b kb mk kd ke kf ml kh ki kj mm kl km kn mn kp kq kr mo kt ku kv ij bi translated">在这里，我们将始终创建一个带有条件检查的服务:如果<code class="fe mp mq mr ms b">ingress.enabled==true</code>，那么设置<code class="fe mp mq mr ms b">type: NodePort</code>，这样我们的负载平衡器将能够向WorkerNode发送流量。如果是<code class="fe mp mq mr ms b">false</code>，那么使用缺省值<code class="fe mp mq mr ms b">ClusterIP</code>，这样我们的请求就不会经过额外的Iptables规则，而是直接发送到一个Pod离开的WorkerNode(参见<a class="ae lf" href="https://rtfm.co.ua/en/kubernetes-service-load-balancing-kube-proxy-and-iptables/" rel="noopener ugc nofollow" target="_blank"> Kubernetes: Service，load balancing，kube-proxy，和iptables </a>):</p><pre class="mu mv mw mx gt my ms mz na aw nb bi"><span id="e506" class="nc ln iq ms b gy nd ne l nf ng">--- <br/>apiVersion: v1<br/>kind: Service<br/>metadata:<br/>  name: {{ .Values.appConfig.name }}-service<br/>spec:<br/>  {{- if .Values.ingress.enabled }}<br/>  type: NodePort<br/>  {{- end }}<br/>  selector:<br/>    app: {{ .Values.appConfig.name }}<br/>  ports:<br/>    - name: http<br/>      protocol: TCP<br/>      port: 80</span></pre><p id="2c2a" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">然后，将检查<code class="fe mp mq mr ms b">istio.enabled</code>条件，如果设置为<code class="fe mp mq mr ms b">true</code>，将创建网关和虚拟服务资源:</p><pre class="mu mv mw mx gt my ms mz na aw nb bi"><span id="3ee9" class="nc ln iq ms b gy nd ne l nf ng">{{- if .Values.istio.enabled }}<br/>---<br/>apiVersion: networking.istio.io/v1alpha3<br/>kind: Gateway<br/>metadata:<br/>  name: {{ .Values.appConfig.name }}-gateway<br/>spec:     <br/>  selector: <br/>    istio: ingressgateway<br/>  servers:<br/>  - port: <br/>      number: 80<br/>      name: http<br/>      protocol: HTTP<br/>    hosts:  <br/>    - {{ .Values.appConfig.url }}<br/>---         <br/>apiVersion: networking.istio.io/v1alpha3<br/>kind: VirtualService<br/>metadata:<br/>  name: {{ .Values.appConfig.name }}-virtualservice<br/>spec:<br/>  hosts:<br/>  - {{ .Values.appConfig.url }}<br/>  gateways:<br/>  - {{ .Values.appConfig.name }}-gateway<br/>  http:<br/>  - match:<br/>    - uri:<br/>        prefix: /<br/>    route:<br/>    - destination:<br/>        host: {{ .Values.appConfig.name }}-service<br/>        port:<br/>          number: 80<br/>{{- end }}</span></pre><h2 id="1ac7" class="nc ln iq bd lo nh ni dn ls nj nk dp lw kj nl nm ma kn nn no me kr np nq mi nr bi translated">进入</h2><p id="e207" class="pw-post-body-paragraph jy jz iq ka b kb mk kd ke kf ml kh ki kj mm kl km kn mn kp kq kr mo kt ku kv ij bi translated">对于<code class="fe mp mq mr ms b">ingress.enabled</code>条件中的入口，首先将检查是否需要创建入口，如果需要，那么将检查使用哪个名称空间，就像我们将使用Istio一样，那么这个入口必须在<code class="fe mp mq mr ms b">istio-system</code>名称空间中创建，如果是“公共”入口，那么在应用程序的名称空间中创建。</p><p id="150a" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">稍后，我们将使用<code class="fe mp mq mr ms b">istio.enabled</code>检查它的流量将被发送到哪里——发送到Istio或应用程序的一个公共服务:</p><pre class="mu mv mw mx gt my ms mz na aw nb bi"><span id="adb1" class="nc ln iq ms b gy nd ne l nf ng">{{- if .Values.ingress.enabled }}<br/>--- <br/>apiVersion: extensions/v1beta1<br/>kind: Ingress<br/>metadata:<br/>  name: {{ .Values.appConfig.name }}-alb<br/>  {{- if .Values.istio.enabled }}<br/>  namespace: istio-system<br/>  {{- end }}<br/>  annotations:<br/>    kubernetes.io/ingress.class: alb<br/>    alb.ingress.kubernetes.io/scheme: internet-facing<br/>    alb.ingress.kubernetes.io/certificate-arn: "arn:aws:acm:us-east-2:534***385:certificate/db886018-c173-43d0-b1be-b940de71f2a2"<br/>    alb.ingress.kubernetes.io/listen-ports: '[{"HTTP": 80}, {"HTTPS":443}]'<br/>    alb.ingress.kubernetes.io/actions.ssl-redirect: '{"Type": "redirect", "RedirectConfig": { "Protocol": "HTTPS", "Port": "443", "StatusCode": "HTTP_301"}}'<br/>    external-dns.alpha.kubernetes.io/hostname: {{ .Values.appConfig.url }}<br/>spec:   <br/>  rules:<br/>  - http:<br/>      paths:<br/>        - path: /*<br/>          backend:<br/>            serviceName: ssl-redirect<br/>            servicePort: use-annotation<br/>        - path: /*<br/>          backend:<br/>          {{- if .Values.istio.enabled }}<br/>            serviceName: istio-ingressgateway<br/>          {{ else }}<br/>            serviceName: {{ .Values.appConfig.name }}-service<br/>          {{- end }}<br/>            servicePort: 80<br/>{{- end }}</span></pre><p id="2a70" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">使用<code class="fe mp mq mr ms b">--debug</code>和<code class="fe mp mq mr ms b">--dry-run</code>运行舵-不得打印入口，但必须提供带有虚拟服务的网关:</p><p id="f7e2" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">helm upgrade—install back end-app-1—命名空间dev-back end-app-1-ns—create-namespace-f app-1/env/dev/values . YAML app-1/—调试—模拟运行</p><p id="6f8e" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">如果这里没有错误，那么将其部署到开发集群:</p><pre class="mu mv mw mx gt my ms mz na aw nb bi"><span id="1304" class="nc ln iq ms b gy nd ne l nf ng">$ helm upgrade --install backend-app-1 --namespace dev-backend-app-1-ns --create-namespace -f app-1/env/dev/values.yaml app-1/<br/>Release “backend-app-1” does not exist. Installing it now.<br/>NAME: backend-app-1<br/>LAST DEPLOYED: Mon Apr 12 18:03:08 2021<br/>NAMESPACE: dev-backend-app-1-ns<br/>STATUS: deployed<br/>REVISION: 1<br/>TEST SUITE: None</span></pre><p id="a154" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">检查<code class="fe mp mq mr ms b">dev-backend-app-1-ns</code>名称空间中的入口:</p><pre class="mu mv mw mx gt my ms mz na aw nb bi"><span id="bef3" class="nc ln iq ms b gy nd ne l nf ng">$ kubectl -n dev-backend-app-1-ns get ingress<br/>No resources found.</span></pre><p id="530e" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">很好，我们必须看到网关和虚拟服务的创建:</p><pre class="mu mv mw mx gt my ms mz na aw nb bi"><span id="ad5e" class="nc ln iq ms b gy nd ne l nf ng">$ kubectl -n dev-backend-app-1-ns get gateway<br/>NAME AGE<br/>backend-app-1-gateway 38s<br/>kubectl -n dev-backend-app-1-ns get virtualservice<br/>NAME GATEWAYS HOSTS AGE<br/>backend-app-1-virtualservice [backend-app-1-gateway] [dev-app-1-test-common-ingress.example.com] 65s</span></pre><p id="e38a" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">很好！</p><p id="3e01" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">现在，部署一个“生产”:</p><pre class="mu mv mw mx gt my ms mz na aw nb bi"><span id="c4f0" class="nc ln iq ms b gy nd ne l nf ng">$ helm upgrade --install backend-app-1 --namespace prod-backend-app-1-ns --create-namespace -f app-1/env/prod/values.yaml app-1/</span></pre><p id="74f8" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">检查它在<code class="fe mp mq mr ms b">prod-backend-app-1-ns</code>名称空间中的入口，因为我们在这里设置了不使用Istio:</p><pre class="mu mv mw mx gt my ms mz na aw nb bi"><span id="5e48" class="nc ln iq ms b gy nd ne l nf ng">$ kubectl -n prod-backend-app-1-ns get ingress<br/>NAME CLASS HOSTS ADDRESS PORTS AGE<br/>backend-app-1-alb &lt;none&gt; * aadca942-***-49478225.us-east-2.elb.amazonaws.com 80 4m54s</span></pre><p id="defc" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">对于开发环境，更新我们在最开始创建的入口——这是我们的共享入口。在这里添加<code class="fe mp mq mr ms b">external-dns.alpha.kubernetes.io/hostname</code>，这样ExternalDNS将创建一个映射到此负载平衡器的记录:</p><pre class="mu mv mw mx gt my ms mz na aw nb bi"><span id="a65e" class="nc ln iq ms b gy nd ne l nf ng">...<br/>    # ExternalDNS settings: <a class="ae lf" href="https://rtfm.co.ua/en/kubernetes-update-aws-route53-dns-from-an-ingress/" rel="noopener ugc nofollow" target="_blank">https://rtfm.co.ua/en/kubernetes-update-aws-route53-dns-from-an-ingress/</a><br/>    external-dns.alpha.kubernetes.io/hostname: "dev-app-1-test-common-ingress.example.com"<br/>...</span></pre><p id="d630" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">应用:</p><pre class="mu mv mw mx gt my ms mz na aw nb bi"><span id="558b" class="nc ln iq ms b gy nd ne l nf ng">$ kubectl apply -f common-ingress-gateway.yaml<br/>ingress.extensions/backend-common-alb configured</span></pre><p id="52fa" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">检查Istio入口网关路由—我们现在只能看到Dev路由:</p><pre class="mu mv mw mx gt my ms mz na aw nb bi"><span id="4cd7" class="nc ln iq ms b gy nd ne l nf ng">$ istioctl proxy-config routes -n istio-system istio-ingressgateway-8459df68cb-bh76b — name http.80<br/>NOTE: This output only contains routes loaded via RDS.<br/>NAME DOMAINS MATCH VIRTUAL SERVICE<br/>http.80 dev-app-1-test-common-ingress.example.com /* backend-app-1-virtualservice.dev-backend-app-1-ns</span></pre><p id="d5b3" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">或者这样:</p><pre class="mu mv mw mx gt my ms mz na aw nb bi"><span id="3a35" class="nc ln iq ms b gy nd ne l nf ng">$ istioctl proxy-config routes -n istio-system istio-ingressgateway-8459df68cb-bh76b — name http.80 -o json | jq ‘.[].virtualHosts[].domains[0], .[].virtualHosts[].routes[].route.cluster’<br/>“dev-app-1-test-common-ingress.example.com”<br/>“outbound|80||backend-app-1-service.dev-backend-app-1-ns.svc.cluster.local”</span></pre><p id="64d5" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">并尝试访问应用程序的URL。</p><p id="8124" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">产品:</p><pre class="mu mv mw mx gt my ms mz na aw nb bi"><span id="a077" class="nc ln iq ms b gy nd ne l nf ng">$ curl -I <a class="ae lf" href="https://prod-app-1-test-common-ingress.example.com" rel="noopener ugc nofollow" target="_blank">https://prod-app-1-test-common-ingress.example.com</a><br/>HTTP/2 200<br/>date: Tue, 13 Apr 2021 12:47:15 GMT<br/>content-type: text/html<br/>server: nginx/1.13.8</span></pre><p id="d41e" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><code class="fe mp mq mr ms b">server: nginx/1.13.8</code> -从NGINX收到的响应，这意味着请求通过负载均衡器直接发送给应用程序的服务。</p><p id="52e4" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">和Dev:</p><pre class="mu mv mw mx gt my ms mz na aw nb bi"><span id="bc85" class="nc ln iq ms b gy nd ne l nf ng">$ curl -I <a class="ae lf" href="https://dev-app-1-test-common-ingress.example.com" rel="noopener ugc nofollow" target="_blank">https://dev-app-1-test-common-ingress.example.com</a><br/>HTTP/2 200<br/>date: Tue, 13 Apr 2021 12:47:18 GMT<br/>content-type: text/html<br/>server: istio-envoy</span></pre><p id="027a" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><code class="fe mp mq mr ms b">server: istio-envoy</code> -流量通过共享负载平衡器，然后到达Istio入口网关，然后到达一个sidecar容器，该容器带有应用程序Pod中的Envoy代理。</p><p id="5161" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">现在，让我们检查第三个可用的方案—创建一个专用入口，但是为它启用Istio。</p><p id="1a61" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在<code class="fe mp mq mr ms b">app-1/env/prod/values.yaml</code>中将<code class="fe mp mq mr ms b">istio.enabled</code>更改为<em class="mt">真</em>，<code class="fe mp mq mr ms b">ingress.enabled</code>我们已经设置为<em class="mt">真</em>:</p><pre class="mu mv mw mx gt my ms mz na aw nb bi"><span id="2dbc" class="nc ln iq ms b gy nd ne l nf ng">appConfig:<br/>  name: "backend-app-1"<br/>  version: "v1"<br/>  url: "prod-app-1-test-common-ingress.example.com"<br/>  <br/>istio:<br/>  enabled: true<br/>    <br/>ingress:<br/>  enabled: true</span></pre><p id="f73f" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">更新设置:</p><pre class="mu mv mw mx gt my ms mz na aw nb bi"><span id="66cc" class="nc ln iq ms b gy nd ne l nf ng">$ helm upgrade --install backend-app-1 --namespace prod-backend-app-1-ns --create-namespace -f app-1/env/prod/values.yaml app-1/</span></pre><p id="2be0" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">再次检查Istio入口网关路由:</p><pre class="mu mv mw mx gt my ms mz na aw nb bi"><span id="34bf" class="nc ln iq ms b gy nd ne l nf ng">$ istioctl proxy-config routes -n istio-system istio-ingressgateway-8459df68cb-bh76b --name http.80<br/>NOTE: This output only contains routes loaded via RDS.<br/>NAME DOMAINS MATCH VIRTUAL SERVICE<br/>http.80 dev-app-1-test-common-ingress.example.com /* backend-app-1-virtualservice.dev-backend-app-1-ns<br/>http.80 prod-app-1-test-common-ingress.example.com /* backend-app-1-virtualservice.prod-backend-app-1-ns</span></pre><p id="5bc5" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">是的，我们现在有了一条通往生产后端的新路线。</p><p id="ec5b" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">检查<code class="fe mp mq mr ms b">prod-backend-app-1-ns</code>名称空间中的入口:</p><pre class="mu mv mw mx gt my ms mz na aw nb bi"><span id="2fec" class="nc ln iq ms b gy nd ne l nf ng">$ kubectl -n prod-backend-app-1-ns get ingress backend-app-1-alb<br/>Error from server (NotFound): ingresses.extensions “backend-app-1-alb” not found</span></pre><p id="934b" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">好，检查一下<code class="fe mp mq mr ms b">istio-system</code>名称空间:</p><pre class="mu mv mw mx gt my ms mz na aw nb bi"><span id="fd07" class="nc ln iq ms b gy nd ne l nf ng">$ kubectl -n istio-system get ingress backend-app-1-alb<br/>NAME CLASS HOSTS ADDRESS PORTS AGE<br/>backend-app-1-alb &lt;none&gt; * aadca942-***-1554475105.us-east-2.elb.amazonaws.com 80 8m52s</span></pre><p id="dad1" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">用<code class="fe mp mq mr ms b">curl</code>试试:</p><pre class="mu mv mw mx gt my ms mz na aw nb bi"><span id="bd14" class="nc ln iq ms b gy nd ne l nf ng">$ curl -I <a class="ae lf" href="https://prod-app-1-test-common-ingress.example.com" rel="noopener ugc nofollow" target="_blank">https://prod-app-1-test-common-ingress.example.com</a><br/>HTTP/2 200<br/>date: Tue, 13 Apr 2021 13:14:34 GMT<br/>content-type: text/html<br/>server: istio-envoy</span></pre><p id="9e52" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><code class="fe mp mq mr ms b">server: istio-envoy</code> -太好了！我们的交通现在正在通过Istio。</p><h1 id="e17d" class="lm ln iq bd lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj bi translated">内部和外部</h1><p id="3aea" class="pw-post-body-paragraph jy jz iq ka b kb mk kd ke kf ml kh ki kj mm kl km kn mn kp kq kr mo kt ku kv ij bi translated">最后一件事是将ExternalDNS与Istio一起使用。</p><p id="d989" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">目前，当使用共享入口和负载平衡器时，我们可以在该入口的注释中指定主机/URL，但该入口不会受应用程序的舵图影响，因为它是从专用清单创建的<code class="fe mp mq mr ms b">common-ingress-gateway.yaml</code>。</p><p id="42ee" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">因此，为了能够在应用程序部署期间创建DNS记录，我们需要更新共享入口的注释，这导致了额外的自动化和复杂性。</p><p id="f66a" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">相反，我们可以在某种程度上配置ExternalDNS，它不仅会使用Ingresses注释，还会使用Istio的资源。</p><p id="f53b" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">让我们更新它的部署并添加<code class="fe mp mq mr ms b">--source=istio-gateway</code>和/或<code class="fe mp mq mr ms b">--source=istio-virtualservice</code>，参见文档<a class="ae lf" href="https://github.com/kubernetes-sigs/external-dns/blob/master/docs/tutorials/istio.md" rel="noopener ugc nofollow" target="_blank">此处&gt; &gt; &gt; </a>:</p><pre class="mu mv mw mx gt my ms mz na aw nb bi"><span id="002a" class="nc ln iq ms b gy nd ne l nf ng">...<br/>      containers:<br/>      - args:<br/>        - --log-level=info<br/>        - --log-format=text<br/>        - --events<br/>        - --policy=upsert-only<br/>        - --provider=aws<br/>        - --registry=txt<br/>        - --interval=2m<br/>        - --source=service<br/>        - --source=ingress<br/>        - --source=istio-gateway<br/>        - --source=istio-virtualservice<br/>...</span></pre><p id="8e79" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">从<code class="fe mp mq mr ms b">common-ingress-gateway.yaml</code>上取下线:</p><pre class="mu mv mw mx gt my ms mz na aw nb bi"><span id="2e1b" class="nc ln iq ms b gy nd ne l nf ng">...<br/>external-dns.alpha.kubernetes.io/hostname: "dev-app-1-test-common-ingress.example.com"<br/>...</span></pre><p id="93fc" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">现在，将从网关的<code class="fe mp mq mr ms b">spec.servers.hosts</code>或虚拟服务的<code class="fe mp mq mr ms b">spec.hosts</code>在网关和/或虚拟服务中设置主机名。</p><p id="9518" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">另外，检查ExternalDNS是否能够读取其ClusterRole <code class="fe mp mq mr ms b">external-dns</code>中的Istio资源:</p><pre class="mu mv mw mx gt my ms mz na aw nb bi"><span id="0d24" class="nc ln iq ms b gy nd ne l nf ng">...<br/>- apiGroups:<br/>  - networking.istio.io<br/>  resources:<br/>  - virtualservices<br/>  - gateways<br/>  verbs:<br/>  - get<br/>  - list<br/>  - watch<br/>...</span></pre><h2 id="f49e" class="nc ln iq bd lo nh ni dn ls nj nk dp lw kj nl nm ma kn nn no me kr np nq mi nr bi translated">ExternalDNS不会为Istio Gateway和VirtualService创建记录:“无法生成任何端点”</h2><p id="4b0e" class="pw-post-body-paragraph jy jz iq ka b kb mk kd ke kf ml kh ki kj mm kl km kn mn kp kq kr mo kt ku kv ij bi translated">但是这里我面临一个问题。</p><p id="ccae" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在ExternalDNS部署中启用<code class="fe mp mq mr ms b">--debug</code>并检查其日志:</p><pre class="mu mv mw mx gt my ms mz na aw nb bi"><span id="9435" class="nc ln iq ms b gy nd ne l nf ng">…<br/>time=”2021–04–14T12:53:05Z” level=debug msg=”Adding event handler for Istio VirtualService”<br/>time=”2021–04–14T12:53:05Z” level=debug msg=”Adding event handler for Istio Gateway”<br/>time=”2021–04–14T12:53:05Z” level=debug msg=”Adding event handler for service”<br/>time=”2021–04–14T12:53:05Z” level=debug msg=”Adding event handler for ingress”<br/>…<br/>level=debug msg=”No endpoints could be generated from ingress istio-system/backend-common-alb”<br/>…</span></pre><p id="e6e0" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">创建了istio的处理程序，因此ExternalDNS可以看到Istio的更新，但不能创建新记录。</p><p id="01c9" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">这是因为Istio入口网关服务是使用节点端口服务的类型创建的，以使其与共享负载平衡器而不是默认负载平衡器一起工作，并且ExternalDNS无法解析VirtualService来确定从<code class="fe mp mq mr ms b">common-ingress-gateway.yaml</code>清单创建的外部入口的<a class="ae lf" href="https://rtfm.co.ua/en/kubernetes-what-is-endpoints/" rel="noopener ugc nofollow" target="_blank"> Kubernetes端点</a>。</p><p id="2839" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我们可以用一个小技巧来“修复”它:在VirtualService注释中直接指定ALB的URL。</p><p id="22bb" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">尽管如此，请记住，在某些情况下，将使用专用的Ingress/ALB创建一个VirtualService，然后我们不需要添加此注释。</p><p id="edf9" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">因此，向VirtualService清单添加一个新条件— <code class="fe mp mq mr ms b">if not .Values.ingress.enabled</code>:</p><pre class="mu mv mw mx gt my ms mz na aw nb bi"><span id="aa8a" class="nc ln iq ms b gy nd ne l nf ng">apiVersion: networking.istio.io/v1alpha3<br/>kind: VirtualService<br/>metadata:<br/>  name: {{ .Values.appConfig.name }}-virtualservice<br/>  {{- if not .Values.ingress.enabled }}<br/>  annotations:<br/>    external-dns.alpha.kubernetes.io/target: {{ .Values.istio.externalURL }}<br/>  {{- end }}<br/>...</span></pre><p id="214b" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">并在<code class="fe mp mq mr ms b">app-1/env/dev/values.yaml</code>文件中为<code class="fe mp mq mr ms b">istio.externalURL</code>设置一个蓝色——它将足够持久，并将仅用于开发环境:</p><pre class="mu mv mw mx gt my ms mz na aw nb bi"><span id="43da" class="nc ln iq ms b gy nd ne l nf ng">...<br/>istio:<br/>  enabled: true<br/>  externalURL: "aadca942-istiosystem-backe-3ee2-700661912.us-east-2.elb.amazonaws.com"<br/>...</span></pre><p id="f2af" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">总之，服务、网关和VirtualService将有这样一个清单:</p><pre class="mu mv mw mx gt my ms mz na aw nb bi"><span id="34af" class="nc ln iq ms b gy nd ne l nf ng">--- <br/>apiVersion: v1<br/>kind: Service<br/>metadata:<br/>  name: {{ .Values.appConfig.name }}-service<br/>spec:<br/>  {{- if .Values.ingress.enabled }}<br/>  type: NodePort<br/>  {{- end }}<br/>  selector:<br/>    app: {{ .Values.appConfig.name }}<br/>  ports:<br/>    - name: http<br/>      protocol: TCP<br/>      port: 80<br/>    <br/>{{- if .Values.istio.enabled }}<br/>--- <br/>apiVersion: networking.istio.io/v1alpha3<br/>kind: Gateway<br/>metadata:<br/>  name: {{ .Values.appConfig.name }}-gateway<br/>spec:<br/>  selector:<br/>    istio: ingressgateway<br/>  servers:  <br/>  - port:<br/>      number: 80<br/>      name: http <br/>      protocol: HTTP<br/>    hosts:<br/>    - "*"<br/>---       <br/>apiVersion: networking.istio.io/v1alpha3<br/>kind: VirtualService<br/>metadata:<br/>  name: {{ .Values.appConfig.name }}-virtualservice<br/>  {{- if not .Values.ingress.enabled }}<br/>  annotations:<br/>    external-dns.alpha.kubernetes.io/target: {{ .Values.istio.externalURL }}<br/>  {{- end }}<br/>spec:<br/>  hosts:<br/>  - {{ .Values.appConfig.url | quote }}<br/>  gateways:<br/>  - {{ .Values.appConfig.name }}-gateway<br/>  http:<br/>  - match:<br/>    - uri:<br/>        prefix: /<br/>    route:<br/>    - destination:<br/>        host: {{ .Values.appConfig.name }}-service<br/>        port:<br/>          number: 80<br/>{{- end }}</span></pre><p id="87bb" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">部署它并检查外部DNS日志:</p><pre class="mu mv mw mx gt my ms mz na aw nb bi"><span id="5a58" class="nc ln iq ms b gy nd ne l nf ng">…<br/>time=”2021–04–14T13:05:00Z” level=info msg=”Desired change: CREATE dev-app-1-test-common-ingress.example.com A [Id: /hostedzone/Z30KLN6M3D0LB6]”<br/>time=”2021–04–14T13:05:00Z” level=info msg=”Desired change: CREATE dev-app-1-test-common-ingress.example.com TXT [Id: /hostedzone/Z30KLN6M3D0LB6]”<br/>…</span></pre><p id="365c" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">用<code class="fe mp mq mr ms b">curl</code>再试一次:</p><pre class="mu mv mw mx gt my ms mz na aw nb bi"><span id="66e4" class="nc ln iq ms b gy nd ne l nf ng">$ curl -I <a class="ae lf" href="https://dev-app-1-test-common-ingress.example.com" rel="noopener ugc nofollow" target="_blank">https://dev-app-1-test-common-ingress.example.com</a><br/>HTTP/2 200<br/>date: Wed, 14 Apr 2021 13:21:11 GMT<br/>content-type: text/html<br/>server: istio-envoy</span></pre><p id="3aae" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">完成了。</p></div><div class="ab cl ns nt hu nu" role="separator"><span class="nv bw bk nw nx ny"/><span class="nv bw bk nw nx ny"/><span class="nv bw bk nw nx"/></div><div class="ij ik il im in"><p id="63e1" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><em class="mt">最初发布于</em> <a class="ae lf" href="https://rtfm.co.ua/en/istio-shared-ingress-aws-alb-helm-chart-with-conditions-istio-and-externaldns/" rel="noopener ugc nofollow" target="_blank"> <em class="mt"> RTFM: Linux、DevOps、系统管理</em> </a> <em class="mt">。</em></p></div></div>    
</body>
</html>