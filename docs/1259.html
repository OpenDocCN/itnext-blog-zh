<html>
<head>
<title>How to build a feedback form that captures a screenshot using HTML5 Canvas</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何使用HTML5 Canvas构建一个捕捉屏幕截图的反馈表单</h1>
<blockquote>原文：<a href="https://itnext.io/how-to-build-a-feedback-form-that-captures-a-screenshot-using-html5-canvas-e9a50e1f6f5?source=collection_archive---------9-----------------------#2018-08-22">https://itnext.io/how-to-build-a-feedback-form-that-captures-a-screenshot-using-html5-canvas-e9a50e1f6f5?source=collection_archive---------9-----------------------#2018-08-22</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="a2ff" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我有一个客户，他的应用程序得到反馈，从外部API返回的一些数据与预期不符。在查看日志并试图找出问题后，我决定我们需要获取令人不快的结果的屏幕截图。让应用程序的最终用户手动完成这一过程可能会让我们得不到我们所需要的东西。是时候实现自动化了！</p><p id="218e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">该应用的后端是用Rails编写的。我想任何后端都可以做到这一点；它甚至可以是无服务器的。我们的目标是:</p><ul class=""><li id="765a" class="kl km iq jp b jq jr ju jv jy kn kc ko kg kp kk kq kr ks kt bi translated">无需用户交互即可捕获应用程序的屏幕截图</li><li id="e80c" class="kl km iq jp b jq ku ju kv jy kw kc kx kg ky kk kq kr ks kt bi translated">显示一个要求简短和详细描述的表单</li><li id="2652" class="kl km iq jp b jq ku ju kv jy kw kc kx kg ky kk kq kr ks kt bi translated">提交时，获取信息并通过电子邮件发送给合适的人</li></ul><p id="fe5a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">让我们深入到它的后端！</p><p id="c4ac" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">首先，我需要一个端点来发布我的表单，所以我在config/routes.rb中创建了一个条目:</p><pre class="kz la lb lc gt ld le lf lg aw lh bi"><span id="e594" class="li lj iq le b gy lk ll l lm ln">post '/feedback' <em class="lo">=&gt; </em>'feedback#create', constraints: { format: 'json' }</span></pre><p id="dcca" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">然后我创建了<code class="fe lp lq lr le b">FeedbackController</code>:</p><pre class="kz la lb lc gt ld le lf lg aw lh bi"><span id="83ba" class="li lj iq le b gy lk ll l lm ln"><strong class="le ir">class </strong><em class="lo">FeedbackController </em>&lt; ApplicationController<br/><br/>  <strong class="le ir">def </strong>create<br/>    img = feedback_params[:img]<br/>    subj = feedback_params[:subject]<br/>    desc = feedback_params[:description]<br/>    FeedbackMailer.email_admins(img, subj, desc).deliver_later<br/>    render json: <strong class="le ir">nil</strong>, status: :ok<br/>  <strong class="le ir">end<br/><br/>  </strong>protected<br/><br/>  <strong class="le ir">def </strong>feedback_params<br/>    params.require(:feedback).permit(%i[img subject description])<br/>  <strong class="le ir">end<br/>end</strong></span></pre><p id="07a0" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我想这是不言自明的。从请求中获取<code class="fe lp lq lr le b">params</code>，并将它们发送到我用<code class="fe lp lq lr le b">rails g mailer Feedback</code>创建的<code class="fe lp lq lr le b">FeedbackMailer</code>类。</p><pre class="kz la lb lc gt ld le lf lg aw lh bi"><span id="c360" class="li lj iq le b gy lk ll l lm ln"><strong class="le ir">class </strong><em class="lo">FeedbackMailer </em>&lt; ApplicationMailer<br/><br/>  <strong class="le ir">def email_</strong>admins(<em class="lo">img</em>, <em class="lo">subj</em>, <em class="lo">desc</em>)<br/>    @img = <em class="lo">img<br/>    </em>@subject = <em class="lo">subj<br/>    </em>@description = <em class="lo">desc<br/>    mail</em>(to: ENV['FEEDBACK_EMAIL_RECEIVER'], subject: 'Sorting Hat feedback')<br/>  <strong class="le ir">end<br/>end</strong></span></pre><p id="995a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这个特殊的应用程序以前从未发送过电子邮件，所以我们需要为它抓取一个响应的布局模板。由于它是针对内部用户，我们希望它看起来不错，但它不需要赢得设计奖。一个好的入门模板可以在这里找到:<a class="ae ls" href="https://github.com/leemunroe/responsive-html-email-template" rel="noopener ugc nofollow" target="_blank">https://github.com/leemunroe/responsive-html-email-template</a></p><p id="bd8d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">对于Rails，我简单地从这个模板中删除了起始副本，添加了一个<code class="fe lp lq lr le b">&lt;%= yield %&gt;</code> erb标签，我们就可以开始工作了。</p><p id="017a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">对于实际的电子邮件内容，我们基本上是吐出<code class="fe lp lq lr le b">FeedbackMailer</code>收到的参数:</p><pre class="kz la lb lc gt ld le lf lg aw lh bi"><span id="4ea7" class="li lj iq le b gy lk ll l lm ln">&lt;h1&gt;&lt;%= @subject %&gt;&lt;/h1&gt;<br/><br/>&lt;p&gt;&lt;%= @description %&gt;&lt;/p&gt;<br/><br/>&lt;p&gt;Here's a picture of what they had on screen:&lt;/p&gt;<br/><br/>&lt;small&gt;(note this tool does not capture product images)&lt;/small&gt;<br/>&lt;img src="&lt;%= @img %&gt;" alt="screenshot"&gt;</span></pre><p id="f2bf" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">开发的最后一步是确保我们可以模拟获取电子邮件，为此我使用了优秀的<code class="fe lp lq lr le b">mailcatcher</code> gem。然后在<code class="fe lp lq lr le b">config/environments/development.rb</code>中，我添加了捕获电子邮件的SMTP配置:</p><pre class="kz la lb lc gt ld le lf lg aw lh bi"><span id="19aa" class="li lj iq le b gy lk ll l lm ln"><em class="lo"># gem install mailcatcher<br/></em>config.action_mailer.default_url_options = { host: 'localhost', port: 3000 }<br/>config.action_mailer.delivery_method = :smtp<br/>config.action_mailer.smtp_settings = { address: 'localhost', port: 1025 }</span></pre><p id="d6ea" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">对于生产，我们想做几件事。异步处理电子邮件很重要，因为最终用户最终会等待服务器处理发送电子邮件，谁知道这是否可行！我们选择使用sidekiq和Redis来处理后台工作，这需要我们的<code class="fe lp lq lr le b">config/environments/production.rb</code>中的一些条目:</p><pre class="kz la lb lc gt ld le lf lg aw lh bi"><span id="339b" class="li lj iq le b gy lk ll l lm ln"><em class="lo"># Use a real queuing backend for Active Job (and separate queues per environment)<br/></em>config.active_job.queue_adapter = :sidekiq<br/>config.active_job.queue_name_prefix = <strong class="le ir">"appname_</strong>#{Rails.env}<strong class="le ir">"<br/></strong>config.action_mailer.perform_caching = <strong class="le ir">false</strong></span><span id="f2a1" class="li lj iq le b gy lt ll l lm ln">config.action_mailer.default_url_options = { host: 'myapp.com' }<br/>config.action_mailer.delivery_method = :smtp<br/>config.action_mailer.smtp_settings = {<br/>    address: ENV['SMTP_HOST'],<br/>    port: ENV['SMTP_PORT'],<br/>    username: ENV['SMTP_USER'],<br/>    password: ENV['SMTP_PASSWORD']<br/>}</span></pre><p id="bc49" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这是我们的后端设置！对于Rails应用程序来说，没有什么疯狂或不标准的。</p><p id="22c9" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">对于前端，我们想添加一个按钮，它将捕获在中呈现的内容并呈现一个模态。是时候做些HTML了！</p><pre class="kz la lb lc gt ld le lf lg aw lh bi"><span id="9303" class="li lj iq le b gy lk ll l lm ln">&lt;button class="btn btn-secondary" id="feedback"&gt;<br/>  &lt;span id="feedbackSpinner" class="spinner"&gt;&lt;/span&gt;<br/>  Feedback<br/>&lt;/button&gt;</span></pre><p id="0170" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们的模式:</p><pre class="kz la lb lc gt ld le lf lg aw lh bi"><span id="e38d" class="li lj iq le b gy lk ll l lm ln">&lt;div id="feedbackModal" class="modal" tabindex="-1" role="dialog"&gt;<br/>  &lt;div class="modal-dialog" role="document"&gt;<br/>    &lt;div class="modal-content"&gt;<br/>      &lt;div class="modal-header"&gt;<br/>        &lt;h5 class="modal-title"&gt;Send Feedback&lt;/h5&gt;<br/>        &lt;button type="button" class="close" data-dismiss="modal" aria-label="Close"&gt;<br/>          &lt;span aria-hidden="true"&gt;&amp;times;&lt;/span&gt;<br/>        &lt;/button&gt;<br/>      &lt;/div&gt;<br/>      &lt;div class="modal-body"&gt;<br/>        &lt;p&gt;Let us know if something is incorrect, needs improvement, or any other general feedback about Sorting Hat.&lt;/p&gt;<br/>        &lt;div class="form-group"&gt;<br/>          &lt;label for="subject"&gt;Summary&lt;/label&gt;<br/>          &lt;input id="subject" type="text" class="form-control" placeholder="Brief description, name, email, etc."&gt;<br/>        &lt;/div&gt;<br/>        &lt;div class="form-group"&gt;<br/>          &lt;label for="description"&gt;Description&lt;/label&gt;<br/>          &lt;textarea id="description" row="3" class="form-control" placeholder="What were you searching for? What was expected? What happened?"&gt;&lt;/textarea&gt;<br/>        &lt;/div&gt;<br/>      &lt;/div&gt;<br/>      &lt;div class="modal-footer"&gt;<br/>        &lt;button type="button" class="btn btn-secondary" data-dismiss="modal"&gt;Cancel&lt;/button&gt;<br/>        &lt;button  id="sendFeedback" type="button" class="btn btn-primary"&gt;Send Feedback&lt;/button&gt;<br/>      &lt;/div&gt;<br/>    &lt;/div&gt;<br/>  &lt;/div&gt;<br/>&lt;/div&gt;</span></pre><p id="eb66" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">好了，这里是标准的引导模式和按钮组件。现在来看看Javascript。我们找到了一个名为<a class="ae ls" href="https://github.com/niklasvh/html2canvas" rel="noopener ugc nofollow" target="_blank"> html2canvas </a>的很棒的库来帮助我们捕捉屏幕。它基于承诺，这使得延迟显示模态非常容易，直到屏幕截图完成。因为一直拍模特的照片是不合适的。html2canvas可以通过选择器名称捕获任何内容，这使得它非常灵活，甚至可以用于图像处理工具或任何其他您可以想象的疯狂功能。在我们的例子中，我们只是发布屏幕截图的数据uri，因为没有理由在我们的服务器上长期存储屏幕截图。</p><pre class="kz la lb lc gt ld le lf lg aw lh bi"><span id="3b66" class="li lj iq le b gy lk ll l lm ln">(<strong class="le ir">function </strong>($) {<br/>  $(document).on('turbolinks:load', <strong class="le ir">function </strong>() {<br/><br/>    <strong class="le ir">let </strong>img = <strong class="le ir">null</strong>;<br/><br/>    <strong class="le ir">function </strong>sendFeedback() {<br/>      <strong class="le ir">let </strong>subject = $('input#subject').val()<br/>      <strong class="le ir">let </strong>description = $('input#description').val()<br/>      $.ajax({<br/>        beforeSend: <strong class="le ir">function</strong>(xhr) {xhr.setRequestHeader('X-CSRF-Token', $('meta[name="csrf-token"]').attr('content'))},<br/>        url: '/feedback',<br/>        method: 'post',<br/>        data: {<br/>          feedback: {<br/>            subject: subject,<br/>            description: description,<br/>            img: img<br/>          }<br/>        },<br/>        success(e) {<br/>          $feedbackModal.modal('hide')<br/>          tmpl = $("#alert").html();<br/>          $.results.html(tmpl({error: "Thanks! We received your feedback and will get back to you soon.", type: 'success'}));<br/>        }<br/>      })<br/>    }<br/>    $.itemSpinner = Handlebars.compile($('#item-spinner').html());<br/>    <strong class="le ir">function </strong>startItemSpinner(el) {<br/>      $(el).html($.itemSpinner);<br/>    }<br/><br/>    <strong class="le ir">function </strong>stopItemSpinner(el) {<br/>      $(el).html('');<br/>    }<br/><br/>    <strong class="le ir">let </strong>$feedbackModal = $('#feedbackModal').modal({show: <strong class="le ir">false</strong>});<br/><br/>    $('button#feedback').click(<strong class="le ir">function </strong>(evt) {<br/>      evt.preventDefault();<br/>        startItemSpinner('#feedbackSpinner');<br/>      html2canvas(document.body).then(<strong class="le ir">function </strong>(canvas) {<br/>        img = canvas.toDataURL();<br/>        stopItemSpinner('#feedbackSpinner');<br/>        $feedbackModal.modal('show')<br/>      });<br/>    })<br/><br/>    $('button#sendFeedback').click(sendFeedback)<br/>  })<br/>})(jQuery);</span></pre><p id="c1e3" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">是的<em class="lo">喘息</em>它使用的是jQuery，而alert和spinner就是这一点车把模板:</p><pre class="kz la lb lc gt ld le lf lg aw lh bi"><span id="4cf8" class="li lj iq le b gy lk ll l lm ln">&lt;script id="item-spinner" type="text/x-handlebars-template"&gt;<br/>  &lt;i class="fa fa-spin fa-cog"&gt;&lt;/i&gt;<br/>&lt;/script&gt;</span><span id="dae0" class="li lj iq le b gy lt ll l lm ln">&lt;script id="alert" type="text/x-handlebars-template" charset="utf-8"&gt;<br/>  &lt;div class="alert alert-{{type}} alert-dismissible fade show" role="alert"&gt;<br/>    &lt;button type="button" class="close" data-dismiss="alert" aria-label="Close"&gt;<br/>      &lt;span aria-hidden="true"&gt;&amp;times;&lt;/span&gt;<br/>    &lt;/button&gt;<br/>    {{error}}<br/>  &lt;/div&gt;<br/>&lt;/script&gt;</span></pre><p id="121d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">你可以随意修改。这个特定的应用程序已经有了这些库，没有理由围绕它构建一个巨大的同构node.js ui。符合您的需求！</p><p id="b601" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">主要的逻辑是这样的:</p><pre class="kz la lb lc gt ld le lf lg aw lh bi"><span id="64f1" class="li lj iq le b gy lk ll l lm ln">html2canvas(document.body).then(<strong class="le ir">function </strong>(canvas) {<br/>        img = canvas.toDataURL();<br/>        stopItemSpinner('#feedbackSpinner');<br/>        $feedbackModal.modal('show')<br/>      });</span></pre><p id="f0be" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我发现处理屏幕截图可能需要1-2秒。只要足够长，我们需要提供一些反馈，表明它正在工作。因此，我们展示了一个微调，直到模态显示。然后，我们有一个“发送反馈”按钮的处理程序，向我们的控制器发送一个AJAX调用，并开始这个过程。这里不需要多部分，因为我们使用的是<code class="fe lp lq lr le b">canvas.toDataUR()</code>方法，它给出了图像的URI表示。</p><p id="2583" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这就是我们所有的代码。您应该启动mailcatcher，看看是否能得到反馈！</p><p id="34f4" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">想给我一些反馈吗？对用其他语言或变体实现有疑问吗？给我发消息！感谢阅读！</p></div></div>    
</body>
</html>