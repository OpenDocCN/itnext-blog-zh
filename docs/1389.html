<html>
<head>
<title>Development and Debugging with Kubernetes</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Kubernetes进行开发和调试</h1>
<blockquote>原文：<a href="https://itnext.io/development-and-debugging-with-kubernetes-296bb60d9549?source=collection_archive---------2-----------------------#2018-10-02">https://itnext.io/development-and-debugging-with-kubernetes-296bb60d9549?source=collection_archive---------2-----------------------#2018-10-02</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="46f1" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我正在使用一台osx笔记本电脑，在本文中，我将展示如何快速创建一个开发/测试kubernetes集群，以及使用一些有用的工具来使用Kubernetes进行工作和调试。</p><h1 id="6a17" class="kl km iq bd kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li bi translated">创建一个开发Kubernetes集群</h1><p id="3566" class="pw-post-body-paragraph jn jo iq jp b jq lj js jt ju lk jw jx jy ll ka kb kc lm ke kf kg ln ki kj kk ij bi translated">在这种情况下，我想在我的开发中创建一个真正的kubernetes集群，使用最少的内存和快速的启动时间，使用Docker中的Docker代替传统的本地虚拟机。<br/>我发现<a class="ae lo" href="https://github.com/kubernetes-sigs/kubeadm-dind-cluster" rel="noopener ugc nofollow" target="_blank"> kubeadm-dind-cluster </a>就是为此而生</p><h1 id="6ca6" class="kl km iq bd kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li bi translated">安装Kubeadm-dind-cluster</h1><h2 id="be04" class="lp km iq bd kn lq lr dn kr ls lt dp kv jy lu lv kz kc lw lx ld kg ly lz lh ma bi translated">先决条件</h2><p id="d7a4" class="pw-post-body-paragraph jn jo iq jp b jq lj js jt ju lk jw jx jy ll ka kb kc lm ke kf kg ln ki kj kk ij bi translated">我在笔记本电脑上使用docker-for-mac，用自制软件安装Unix软件</p><pre class="mb mc md me gt mf mg mh mi aw mj bi"><span id="87ee" class="lp km iq mg b gy mk ml l mm mn">brew install jq<br/>brew install md5sha1sum</span></pre><p id="74ac" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们还需要创建一个<code class="fe mo mp mq mg b">/boot</code>目录(它在OSX上不存在),并使用<code class="fe mo mp mq mg b">preferences-&gt;File Sharing</code>将其绑定挂载到docker中</p><p id="9b6c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">下载引导脚本:</p><pre class="mb mc md me gt mf mg mh mi aw mj bi"><span id="75dc" class="lp km iq mg b gy mk ml l mm mn">wget https://cdn.rawgit.com/kubernetes-sigs/kubeadm-dind-cluster/master/fixed/dind-cluster-v1.11.sh<br/>chmod +x dind-cluster-v1.11.sh<br/>mv dind-cluster-v1.11.sh /usr/local/bin/dind-cluster.sh</span></pre><blockquote class="mr ms mt"><p id="2361" class="jn jo mu jp b jq jr js jt ju jv jw jx mv jz ka kb mw kd ke kf mx kh ki kj kk ij bi translated"><strong class="jp ir">注意</strong>:您可以选择不同的kubernetes版本(1.8、1.9、1.10、1.11)</p></blockquote><p id="97f7" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">启动集群</p><pre class="mb mc md me gt mf mg mh mi aw mj bi"><span id="e406" class="lp km iq mg b gy mk ml l mm mn"># start the cluster<br/>$ dind-cluster.sh up</span></pre><blockquote class="mr ms mt"><p id="9880" class="jn jo mu jp b jq jr js jt ju jv jw jx mv jz ka kb mw kd ke kf mx kh ki kj kk ij bi translated"><em class="iq">默认将创建1名主工人和2名工人</em></p></blockquote><p id="195d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">您可以指定节点的数量</p><pre class="mb mc md me gt mf mg mh mi aw mj bi"><span id="fa24" class="lp km iq mg b gy mk ml l mm mn">NUM_NODES=3 dind-cluster.sh up<!-- --> </span></pre><p id="3ecc" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">您还可以访问不安全的注册表</p><pre class="mb mc md me gt mf mg mh mi aw mj bi"><span id="58f0" class="lp km iq mg b gy mk ml l mm mn">DIND_INSECURE_REGISTRIES='["my-private-registry.com"]' dind-cluster.sh up</span></pre><blockquote class="mr ms mt"><p id="38a6" class="jn jo mu jp b jq jr js jt ju jv jw jx mv jz ka kb mw kd ke kf mx kh ki kj kk ij bi translated"><em class="iq">在我的例子中，脚本的输出告诉我连接到Kubernetes Web UI的Url:</em><a class="ae lo" href="http://127.0.0.1:32768/api/v1/namespaces/kube-system/services/kubernetes-dashboard:/proxy/#!/workload?namespace=default" rel="noopener ugc nofollow" target="_blank"><em class="iq">http://127 . 0 . 0 . 1:32768/API/v1/namespaces/kube-system/services/Kubernetes-dashboard:/proxy/#！/工作量？名称空间=默认</em> </a></p></blockquote><h2 id="3a59" class="lp km iq bd kn lq lr dn kr ls lt dp kv jy lu lv kz kc lw lx ld kg ly lz lh ma bi translated">拆除集群</h2><p id="5cb8" class="pw-post-body-paragraph jn jo iq jp b jq lj js jt ju lk jw jx jy ll ka kb kc lm ke kf kg ln ki kj kk ij bi translated">当您需要资源做其他事情时，您可以关闭集群</p><pre class="mb mc md me gt mf mg mh mi aw mj bi"><span id="a72c" class="lp km iq mg b gy mk ml l mm mn">dind-cluster.sh down</span></pre><p id="59f2" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果您不想以后再次启动集群，那么您需要清除所有资源。</p><pre class="mb mc md me gt mf mg mh mi aw mj bi"><span id="b28b" class="lp km iq mg b gy mk ml l mm mn">dind-cluster.sh clean</span></pre><h1 id="d961" class="kl km iq bd kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li bi translated">有用的工具</h1><h1 id="2943" class="kl km iq bd kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li bi translated">Kubernetes的别名</h1><p id="246a" class="pw-post-body-paragraph jn jo iq jp b jq lj js jt ju lk jw jx jy ll ka kb kc lm ke kf kg ln ki kj kk ij bi translated">使用Kubernetes，您将会键入大量的kubectl命令，我建议您使用一个简单的别名:</p><pre class="mb mc md me gt mf mg mh mi aw mj bi"><span id="058a" class="lp km iq mg b gy mk ml l mm mn">alias k=kubectl</span></pre><p id="6e34" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">为了保持kubectl bash的完成，您还需要更新osx上的<code class="fe mo mp mq mg b">/usr/local/etc/bash_completion.d/kubectl</code>或Linux上的<code class="fe mo mp mq mg b">/etc/bash_completion.d/kubectl</code>中的完成脚本的结尾</p><pre class="mb mc md me gt mf mg mh mi aw mj bi"><span id="026c" class="lp km iq mg b gy mk ml l mm mn">if [[ $(type -t compopt) = "builtin" ]]; then<br/>    complete -o default -F __start_kubectl kubectl<br/>    complete -o default -F __start_kubectl k<br/>else<br/>    complete -o default -o nospace -F __start_kubectl kubectl<br/>    complete -o default -o nospace -F __start_kubectl k<br/>fi</span></pre><h1 id="dbba" class="kl km iq bd kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li bi translated">切换Kubernetes上下文和名称空间</h1><p id="5b04" class="pw-post-body-paragraph jn jo iq jp b jq lj js jt ju lk jw jx jy ll ka kb kc lm ke kf kg ln ki kj kk ij bi translated">Kubectl可以通过它的配置文件<code class="fe mo mp mq mg b">.kube/config</code>管理几个Kubernetes集群，但是在它们之间切换或者改变名称空间并不容易。有一些非常有用的工具会让你在Kubernetes上的工作变得更容易。</p><p id="6d59" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><a class="ae lo" href="https://github.com/ahmetb/kubectx" rel="noopener ugc nofollow" target="_blank"> Kubectx / Kubens </a>将安装两个工具:<code class="fe mo mp mq mg b">kctx</code>和<code class="fe mo mp mq mg b">kns</code>，这将允许你轻松地改变kubernetes的上下文和名称空间。</p><pre class="mb mc md me gt mf mg mh mi aw mj bi"><span id="6e42" class="lp km iq mg b gy mk ml l mm mn">brew install kubectx --with-short-names</span></pre><p id="9da2" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在可以快速查看和更改kubernetes上下文:</p><pre class="mb mc md me gt mf mg mh mi aw mj bi"><span id="acb1" class="lp km iq mg b gy mk ml l mm mn">$ kctx dind<br/>Switched to context "dind".</span></pre><p id="83a3" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们还可以轻松地更改kubernetes名称空间:</p><pre class="mb mc md me gt mf mg mh mi aw mj bi"><span id="2be6" class="lp km iq mg b gy mk ml l mm mn">$ kubectl create namespace demo<br/>namespace/demo created<br/>$ kns demo<br/>Context "dind" modified.<br/>Active namespace is "demo".</span></pre><h1 id="6438" class="kl km iq bd kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li bi translated">使用Helm部署应用程序</h1><p id="593a" class="pw-post-body-paragraph jn jo iq jp b jq lj js jt ju lk jw jx jy ll ka kb kc lm ke kf kg ln ki kj kk ij bi translated">我们将使用<a class="ae lo" href="https://www.helm.sh/" rel="noopener ugc nofollow" target="_blank">舵</a>来部署应用程序。</p><pre class="mb mc md me gt mf mg mh mi aw mj bi"><span id="d9d4" class="lp km iq mg b gy mk ml l mm mn">brew install kubernetes-helm</span></pre><p id="edc4" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">实际上，helm使用了<code class="fe mo mp mq mg b">tiller</code>,我们必须使用以下命令在集群上安装它:</p><pre class="mb mc md me gt mf mg mh mi aw mj bi"><span id="ef7d" class="lp km iq mg b gy mk ml l mm mn">$ helm init<br/>Tiller (the Helm server-side component) has been installed into your Kubernetes Cluster.<br/>Happy Helming!</span></pre><p id="8179" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们可以使用helm在Kubernetes上部署应用程序，就像我们使用<code class="fe mo mp mq mg b">apt</code>或<code class="fe mo mp mq mg b">yum</code>在Linux上部署软件包一样。</p><p id="6fdc" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们可以搜索包:</p><pre class="mb mc md me gt mf mg mh mi aw mj bi"><span id="67ae" class="lp km iq mg b gy mk ml l mm mn">$ helm search wordpress<br/>NAME            	CHART VERSION	APP VERSION	DESCRIPTION<br/>stable/wordpress	3.0.0        	4.9.8      	Web publishing platform for building blogs and ...</span></pre><p id="5ab2" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">并安装:</p><pre class="mb mc md me gt mf mg mh mi aw mj bi"><span id="fb34" class="lp km iq mg b gy mk ml l mm mn">$ helm install stable/wordpress<br/>...<br/>...<br/>NOTES:<br/>1. Get the WordPress URL:</span><span id="2ff9" class="lp km iq mg b gy my ml l mm mn">  NOTE: It may take a few minutes for the LoadBalancer IP to be available.<br/>        Watch the status with: 'kubectl get svc --namespace demo -w hazy-hedgehog-wordpress'</span><span id="2197" class="lp km iq mg b gy my ml l mm mn">  export SERVICE_IP=$(kubectl get svc --namespace demo hazy-hedgehog-wordpress -o jsonpath='{.status.loadBalancer.ingress[0].ip}')<br/>  echo "WordPress URL: http://$SERVICE_IP/"<br/>  echo "WordPress Admin URL: http://$SERVICE_IP/admin"</span><span id="a3b9" class="lp km iq mg b gy my ml l mm mn">2. Login with the following credentials to see your blog</span><span id="641e" class="lp km iq mg b gy my ml l mm mn">  echo Username: user<br/>  echo Password: $(kubectl get secret --namespace demo hazy-hedgehog-wordpress -o jsonpath="{.data.wordpress-password}" | base64 --decode)</span></pre><p id="1f55" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">查看当前部署的内容:</p><pre class="mb mc md me gt mf mg mh mi aw mj bi"><span id="6c30" class="lp km iq mg b gy mk ml l mm mn">$ helm list<br/>NAME         	REVISION	UPDATED                 	STATUS  	CHART          	NAMESPACE<br/>hazy-hedgehog	1       	Sun Sep 30 00:24:19 2018	DEPLOYED	wordpress-3.0.0	demo</span></pre><p id="9e97" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果不再需要，请删除:</p><pre class="mb mc md me gt mf mg mh mi aw mj bi"><span id="73a2" class="lp km iq mg b gy mk ml l mm mn">$ helm delete hazy-hedgehog<br/>release "hazy-hedgehog" deleted</span></pre><h1 id="82cb" class="kl km iq bd kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li bi translated">在Kubernetes中调试应用程序</h1><h1 id="9ae8" class="kl km iq bd kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li bi translated">艰难的道路</h1><p id="5d14" class="pw-post-body-paragraph jn jo iq jp b jq lj js jt ju lk jw jx jy ll ka kb kc lm ke kf kg ln ki kj kk ij bi translated">我以前写过一篇文章<a class="ae lo" rel="noopener ugc nofollow" target="_blank" href="/debug-a-go-application-in-kubernetes-from-ide-c45ad26d8785">Debug a Go Application in Kubernetes from IDE</a>，它解释了我们如何复制一个管道以在调试模式下编译我们的应用程序，用<code class="fe mo mp mq mg b">dlv</code> go调试器创建一个特殊的容器，暴露dlv服务端口，并使用kube forward命令从我们的本地IDE连接到它。</p><p id="8ffd" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在下一节中，我们将看到更简单的替代方案。</p><h1 id="d095" class="kl km iq bd kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li bi translated">使用网真调试应用程序</h1><p id="25c0" class="pw-post-body-paragraph jn jo iq jp b jq lj js jt ju lk jw jx jy ll ka kb kc lm ke kf kg ln ki kj kk ij bi translated"><a class="ae lo" href="https://www.telepresence.io/" rel="noopener ugc nofollow" target="_blank">网真</a>用一个双向网络代理来代替在Kubernetes集群中运行的普通pod。这个pod将Kubernetes环境中的数据(例如，TCP连接、环境变量、卷)代理到本地进程。本地进程的网络被透明地覆盖，因此DNS调用和TCP连接通过代理路由到远程Kubernetes集群。</p><p id="66c2" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这将允许在我们的IDE中启动一个本地程序进行调试，该程序将能够像在Kubernetes集群中一样进行通信。</p><blockquote class="mr ms mt"><p id="2ed2" class="jn jo mu jp b jq jr js jt ju jv jw jx mv jz ka kb mw kd ke kf mx kh ki kj kk ij bi translated">这在你的计算机和kubernetes集群之间使用了一个类似vpn的解决方案，因此它可以中断你的其他连接。<br/>使用网真时，您的所有流量都被路由到隧道，因此您使用的其他应用程序可能无法正常工作</p></blockquote><h2 id="8d29" class="lp km iq bd kn lq lr dn kr ls lt dp kv jy lu lv kz kc lw lx ld kg ly lz lh ma bi translated">安装在OSX上</h2><pre class="mb mc md me gt mf mg mh mi aw mj bi"><span id="f5dc" class="lp km iq mg b gy mk ml l mm mn">brew cask install osxfuse<br/>brew install socat datawire/blackbird/telepresence</span></pre><h2 id="8254" class="lp km iq bd kn lq lr dn kr ls lt dp kv jy lu lv kz kc lw lx ld kg ly lz lh ma bi translated">试验</h2><p id="0e79" class="pw-post-body-paragraph jn jo iq jp b jq lj js jt ju lk jw jx jy ll ka kb kc lm ke kf kg ln ki kj kk ij bi translated">在这个例子中，我们创建了一个本地docker容器，它可以访问由kubernetes API挂载(并由telepresence检索)的<code class="fe mo mp mq mg b">/var/run/secrets</code>,该容器能够调用Kubernetes API</p><pre class="mb mc md me gt mf mg mh mi aw mj bi"><span id="bdad" class="lp km iq mg b gy mk ml l mm mn">telepresence --mount=/tmp/known --docker-run --rm -it -v=/tmp/known/var/run/secrets:/var/run/secrets lachlanevenson/k8s-kubectl version --short</span></pre><p id="9690" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们要求telepresence在本地目录<code class="fe mo mp mq mg b">/tmp/known</code>中挂载远程pod文件系统，并将其挂载到我们的test docker容器中。</p><h2 id="5fd8" class="lp km iq bd kn lq lr dn kr ls lt dp kv jy lu lv kz kc lw lx ld kg ly lz lh ma bi translated">用本地docker映像交换部署</h2><p id="98b6" class="pw-post-body-paragraph jn jo iq jp b jq lj js jt ju lk jw jx jy ll ka kb kc lm ke kf kg ln ki kj kk ij bi translated">远程呈现允许<strong class="jp ir">将集群中的pod部署与您的本地机器交换</strong>。</p><p id="453e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这里，我们启动了一个测试Cassandra操作符，它是使用helm部署的，这在Kubernetes集群中创建了一个部署。</p><pre class="mb mc md me gt mf mg mh mi aw mj bi"><span id="9257" class="lp km iq mg b gy mk ml l mm mn">helm install --name cassandra-operator ./helm/cassandra-operator/</span></pre><p id="c4ed" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们可以看到它已经创建了<code class="fe mo mp mq mg b">cassandra-operator</code>部署:</p><pre class="mb mc md me gt mf mg mh mi aw mj bi"><span id="db34" class="lp km iq mg b gy mk ml l mm mn">$ kubectl get deployments<br/>NAME                 DESIRED   CURRENT   UP-TO-DATE   AVAILABLE   AGE<br/>cassandra-operator   1         1         1            1           4h</span></pre><p id="3a23" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在，我们将使用telepresence将操作员部署与Cassandra操作员的本地docker映像进行交换:</p><pre class="mb mc md me gt mf mg mh mi aw mj bi"><span id="978e" class="lp km iq mg b gy mk ml l mm mn">$ telepresence --swap-deployment cassandra-operator --mount=/tmp/known --docker-run --rm -it -v=/tmp/known/var/run/secrets:/var/run/secrets sebmoule/cassandra-operator:0.1.3-master<br/>INFO[0000] Go Version: go1.10.4<br/>INFO[0000] Go OS/Arch: linux/amd64<br/>INFO[0000] operator-sdk Version: 0.0.5+git<br/>INFO[0000] cassandra-operator Version: 0.1.3<br/>INFO[0000] cassandra-operator LogLevel: debug<br/>INFO[0000] Watching db.orange.com/v1alpha1, CassandraCluster, tele, 10<br/>DEBU[0000] starting cassandraclusters controller</span></pre><ul class=""><li id="b437" class="mz na iq jp b jq jr ju jv jy nb kc nc kg nd kk ne nf ng nh bi translated"><code class="fe mo mp mq mg b">--swam-deployment</code>允许更换部署</li><li id="1fb9" class="mz na iq jp b jq ni ju nj jy nk kc nl kg nm kk ne nf ng nh bi translated"><code class="fe mo mp mq mg b">--mount=/tmp/known</code>我们用它来创建<code class="fe mo mp mq mg b">TELEPRESENCE_ROOT</code>，它将用于与kubernetes pods同步卷</li><li id="88dd" class="mz na iq jp b jq ni ju nj jy nk kc nl kg nm kk ne nf ng nh bi translated"><code class="fe mo mp mq mg b">--docker-run -v</code>我们使用docker挂载选项在本地容器中创建TELEPRESENCE_ROOT卷</li></ul><blockquote class="mr ms mt"><p id="4bf3" class="jn jo mu jp b jq jr js jt ju jv jw jx mv jz ka kb mw kd ke kf mx kh ki kj kk ij bi translated"><em class="iq">远程呈现代理示例可以使用另一幅图像。有关</em> <strong class="jp ir"> <em class="iq">网真</em> </strong> <em class="iq">的更多信息，请查看</em> <a class="ae lo" href="https://www.telepresence.io/reference/proxying.html#volumes" rel="noopener ugc nofollow" target="_blank"> <em class="iq">文档</em> </a> <em class="iq"> : </em></p><p id="d879" class="jn jo mu jp b jq jr js jt ju jv jw jx mv jz ka kb mw kd ke kf mx kh ki kj kk ij bi translated"><code class="fe mo mp mq mg b"><em class="iq">export TELEPRESENCE_REGISTRY=myprivateregistry.com/datawire</em></code></p></blockquote><h2 id="21aa" class="lp km iq bd kn lq lr dn kr ls lt dp kv jy lu lv kz kc lw lx ld kg ly lz lh ma bi translated">交换部署以使用我们的本地IDE</h2><p id="10d7" class="pw-post-body-paragraph jn jo iq jp b jq lj js jt ju lk jw jx jy ll ka kb kc lm ke kf kg ln ki kj kk ij bi translated">现在，我们将在本地机器上设置远程呈现隧道，并从Cassandra operator部署中检索Pod环境变量，以便稍后可以将它们注入到我们的IDE中。</p><pre class="mb mc md me gt mf mg mh mi aw mj bi"><span id="df44" class="lp km iq mg b gy mk ml l mm mn">telepresence --swap-deployment cassandra-operator --mount=/tmp/known --env-file cassandra-operator.env</span></pre><p id="577f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这将创建类似于以下内容的文件:</p><pre class="mb mc md me gt mf mg mh mi aw mj bi"><span id="5d04" class="lp km iq mg b gy mk ml l mm mn">$ cat cassandra-operator.env<br/>KUBERNETES_PORT=tcp://172.18.0.1:443<br/>KUBERNETES_PORT_443_TCP=tcp://172.18.0.1:443<br/>KUBERNETES_PORT_443_TCP_ADDR=172.18.0.1<br/>KUBERNETES_PORT_443_TCP_PORT=443<br/>KUBERNETES_PORT_443_TCP_PROTO=tcp<br/>KUBERNETES_SERVICE_HOST=172.18.0.1<br/>KUBERNETES_SERVICE_PORT=443<br/>KUBERNETES_SERVICE_PORT_HTTPS=443<br/>LOG_LEVEL=Debug<br/>POD_NAME=operator-cassandr-7313751b30734a338851b579db9c2608-67bb84dhb6gg<br/>TELEPRESENCE_CONTAINER=cassandra-operator<br/>TELEPRESENCE_CONTAINER_NAMESPACE=cassandra-test<br/>TELEPRESENCE_POD=operator-cassandr-7313751b30734a338851b579db9c2608-67bb84dhb6gg<br/>TELEPRESENCE_ROOT=/tmp/known<br/>WATCH_NAMESPACE=cassandra-test</span></pre><p id="57bf" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在我们可以在IDE调试器中导入这些环境变量了</p><figure class="mb mc md me gt no gh gi paragraph-image"><div class="gh gi nn"><img src="../Images/fc224629f979d6e6ae6acc3e9cbed43a.png" data-original-src="https://miro.medium.com/v2/resize:fit:986/format:webp/0*tdZp_VgXDNzdQMLx.png"/></div></figure><p id="49da" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们在本地文件系统上做了一点小小的改动，以便操作员可以找到目标文件:</p><pre class="mb mc md me gt mf mg mh mi aw mj bi"><span id="0383" class="lp km iq mg b gy mk ml l mm mn">sudo mkdir -p /var/run/secrets/kubernetes.io/<br/>sudo ln -s /tmp/known/var/run/secrets/kubernetes.io/serviceaccount /var/run/secrets/kubernetes.io/serviceaccount</span></pre><blockquote class="mr ms mt"><p id="e4eb" class="jn jo mu jp b jq jr js jt ju jv jw jx mv jz ka kb mw kd ke kf mx kh ki kj kk ij bi translated">然后，您可以单击IDE上的debug按钮，操作员将启动并像在Kubernetes集群中一样工作，您可以正常地调试它。</p></blockquote><h1 id="283d" class="kl km iq bd kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li bi translated">用于调试的KubeSquash</h1><blockquote class="mr ms mt"><p id="e6fb" class="jn jo mu jp b jq jr js jt ju jv jw jx mv jz ka kb mw kd ke kf mx kh ki kj kk ij bi translated"><a class="ae lo" href="https://github.com/solo-io/kubesquash" rel="noopener ugc nofollow" target="_blank"><em class="iq">KubeSquash</em></a><em class="iq">是一个简单的命令行工具。他们将其用户界面设计得非常简单:用一个命令“kubesquash”调用，定位所需的pod，调试会话自动启动，无需配置或部署。</em></p></blockquote><p id="57cc" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">从<a class="ae lo" href="https://github.com/solo-io/kubesquash/releases" rel="noopener ugc nofollow" target="_blank">这里</a>下载KubeSquash</p><h2 id="58a5" class="lp km iq bd kn lq lr dn kr ls lt dp kv jy lu lv kz kc lw lx ld kg ly lz lh ma bi translated">它是如何工作的</h2><p id="24c3" class="pw-post-body-paragraph jn jo iq jp b jq lj js jt ju lk jw jx jy ll ka kb kc lm ke kf kg ln ki kj kk ij bi translated">当启动kubesquash时，它将在Kubernetes集群中创建一个名称空间<code class="fe mo mp mq mg b">squash</code>,并创建一个Pod，该Pod将与Go调试器一起部署，并且能够连接到您想要调试的Pod。</p><blockquote class="mr ms mt"><p id="7f2e" class="jn jo mu jp b jq jr js jt ju jv jw jx mv jz ka kb mw kd ke kf mx kh ki kj kk ij bi translated"><em class="iq">出于调试目的，wa可以要求kubesquash保留它在集群中安装的临时pod</em></p><p id="f851" class="jn jo mu jp b jq jr js jt ju jv jw jx mv jz ka kb mw kd ke kf mx kh ki kj kk ij bi translated"><code class="fe mo mp mq mg b"><em class="iq">kubesquash -no-clean kubectl -nsquash describe pod kubectl -nsquash logs -l squash=kubesquash-container</em></code></p></blockquote><h2 id="f044" class="lp km iq bd kn lq lr dn kr ls lt dp kv jy lu lv kz kc lw lx ld kg ly lz lh ma bi translated">在命令行中使用它</h2><p id="86bb" class="pw-post-body-paragraph jn jo iq jp b jq lj js jt ju lk jw jx jy ll ka kb kc lm ke kf kg ln ki kj kk ij bi translated">如果您在无法访问互联网的私人kubernetes上使用kubesquash，您可以首先下载kubesquash图像:<code class="fe mo mp mq mg b">soloio/kubesquash-container-dlv:v0.1.6</code>并将其推送到您的私人注册表，然后要求kubesquash使用您的图像:</p><pre class="mb mc md me gt mf mg mh mi aw mj bi"><span id="1161" class="lp km iq mg b gy mk ml l mm mn">$ kubesquash --container-repo my-private-registry<br/>? Select a namespace  [Use arrows to move, type to filter]<br/>❯ default</span></pre><p id="c6af" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">Kubesquash现在要求您选择想要调试的目标名称空间，然后要求您选择目标Pod，并选择<code class="fe mo mp mq mg b">dlv</code>调试器。</p><pre class="mb mc md me gt mf mg mh mi aw mj bi"><span id="341d" class="lp km iq mg b gy mk ml l mm mn">kubesquash --container-repo registry.gitlab.si.francetelecom.fr/dfyarchicloud/dfyarchicloud-registry<br/>? Select a namespace cassandra-demo<br/>? Select a pod operator-cassandra-operator-88fd9bb9c-jwqvl<br/>? Going to attach dlv to pod operator-cassandra-operator-88fd9bb9c-jwqvl. continue? Yes</span><span id="f5c1" class="lp km iq mg b gy my ml l mm mn">If you don't see a command prompt, try pressing enter.</span><span id="c1bc" class="lp km iq mg b gy my ml l mm mn">(dlv)</span></pre><blockquote class="mr ms mt"><p id="4e3c" class="jn jo mu jp b jq jr js jt ju jv jw jx mv jz ka kb mw kd ke kf mx kh ki kj kk ij bi translated">现在，您有了一个直接连接到目标pod的调试器</p></blockquote><p id="7613" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">警告:</p><blockquote class="mr ms mt"><p id="e2b7" class="jn jo mu jp b jq jr js jt ju jv jw jx mv jz ka kb mw kd ke kf mx kh ki kj kk ij bi translated">为了让kubesquash在其他pod进程上创建具有调试功能的pod，您需要在集群上拥有特权访问权限。</p></blockquote><h2 id="05c8" class="lp km iq bd kn lq lr dn kr ls lt dp kv jy lu lv kz kc lw lx ld kg ly lz lh ma bi translated">在您的IDE中使用它</h2><p id="fecc" class="pw-post-body-paragraph jn jo iq jp b jq lj js jt ju lk jw jx jy ll ka kb kc lm ke kf kg ln ki kj kk ij bi translated">在撰写本文时，Kubesquash只支持VsCode作为IDE，它提供了一个VsCode扩展。</p><p id="7ba8" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">因为我的私有kubernetes集群不能访问互联网，所以我需要请求kubesquash为docker映像获取我的私有注册表。<br/>这在扩展中目前是不可配置的，我不得不直接修改扩展代码<code class="fe mo mp mq mg b">extension.js l 179</code>中的行:</p><pre class="mb mc md me gt mf mg mh mi aw mj bi"><span id="174a" class="lp km iq mg b gy mk ml l mm mn">let stdout = await exec(`kubesquash --container-repo myprivate-registry -machine -debug-server -pod ${selectedPod.metadata.name} -namespace ${selectedPod.metadata.namespace}`);</span></pre><p id="f64b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">为了让我的IDE能够正确地设置断点，我还需要将remotePath改为在<code class="fe mo mp mq mg b">extension.js l 202</code>中使用:</p><pre class="mb mc md me gt mf mg mh mi aw mj bi"><span id="c62c" class="lp km iq mg b gy mk ml l mm mn">remotePath: "/go/src/path/to/my/app",</span></pre><p id="858a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这样，我只需要在VsCode命令行中启动扩展:</p><pre class="mb mc md me gt mf mg mh mi aw mj bi"><span id="84ae" class="lp km iq mg b gy mk ml l mm mn">KubeSquash - debug pod</span></pre><p id="654f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">它会询问您要连接的pod。<br/>然后，我将开始下载kubernetes节点上的名称空间squash中的kubesquash docker映像，这是您的目标pod，我将在您的目标pod上附加dlv调试器。</p><p id="4b9e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">它还在本地配置您的VsCode，使其自动附加到集群中的dlv，然后您就可以在IDE中使用本地断点开始调试您的应用程序了。</p><figure class="mb mc md me gt no gh gi paragraph-image"><div role="button" tabindex="0" class="ns nt di nu bf nv"><div class="gh gi nr"><img src="../Images/0430ec26eb83d5495a46fd1793c60c11.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*YUK8WRTQfGDeaYV8WnAH0A.png"/></div></div></figure><p id="9800" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这是一个非常棒的工具！！</p><h1 id="ff71" class="kl km iq bd kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li bi translated">其他工具</h1><p id="00d2" class="pw-post-body-paragraph jn jo iq jp b jq lj js jt ju lk jw jx jy ll ka kb kc lm ke kf kg ln ki kj kk ij bi translated">还有很多其他工具我还没有测试过，你可以在这里找到一些:</p><p id="e300" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><a class="ae lo" href="https://kubernetes.io/blog/2018/05/01/developing-on-kubernetes/" rel="noopener ugc nofollow" target="_blank">https://kubernetes . io/blog/2018/05/01/developing-on-kubernetes/</a></p></div></div>    
</body>
</html>