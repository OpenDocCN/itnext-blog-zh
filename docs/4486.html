<html>
<head>
<title>Azure Kubernetes Service — Handling the custom Private DNS Zone for private clusters</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Azure Kubernetes服务—处理私有集群的自定义私有DNS区域</h1>
<blockquote>原文：<a href="https://itnext.io/azure-kubernetes-service-handling-the-custom-private-dns-zone-for-private-clusters-8f0a79f2efc2?source=collection_archive---------2-----------------------#2020-07-10">https://itnext.io/azure-kubernetes-service-handling-the-custom-private-dns-zone-for-private-clusters-8f0a79f2efc2?source=collection_archive---------2-----------------------#2020-07-10</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/2f7f40b19143a064a10ef74d549dd8d2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*AsAZA-R0OYher1GU.png"/></div></div></figure><p id="cce2" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">Azure一直在增强许多PaaS服务，以使用私有端点。私有端点是一种确保服务的所有流量都通过您的网络结构而不是通过互联网传输的方法。</p><p id="05e2" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在过去，当从内部网络访问时，大多数服务将通过互联网从公司位置路由到公共可访问的URL。虽然使用IP规则来限制访问是可能的，但是这种方法在有安全意识的组织中引起了争议。</p><p id="5c4a" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">当使用私有端点时，Azure通常需要一个Azure私有DNS区域来插入端点的DNS记录，并让您的DNS基础架构解析该记录。对于大多数服务，需要一个特定于该服务的区域，如这里所记录的<a class="ae kw" href="https://docs.microsoft.com/en-us/azure/private-link/private-endpoint-dns#azure-services-dns-zone-configuration" rel="noopener ugc nofollow" target="_blank">。</a></p><p id="0e23" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">例如，当使用Azure容器注册中心(ACR)的私有端点时，客户需要使用区域名称创建一个私有DNS区域:<em class="kx"> privatelink.azurecr.io </em>。则该区域需要链接到DNS服务器所在的虚拟网络；您可以解析端点的主机名。有关混合DNS拓扑的更多详细信息，请参考此<a class="ae kw" href="https://docs.microsoft.com/en-us/azure/private-link/private-endpoint-dns#on-premises-workloads-using-a-dns-forwarder" rel="noopener ugc nofollow" target="_blank">文档</a>。概括地说，它看起来是这样的:</p><figure class="kz la lb lc gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi ky"><img src="../Images/246520ba5c987e34696f835285d4acd4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*Xkn-7jeeaUxob3zb.png"/></div></div><figcaption class="ld le gj gh gi lf lg bd b be z dk translated">具有转发器的混合DNS基础设施</figcaption></figure><p id="cd76" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">使用AKS时，方法会有所不同，并且更难集成到您的环境中。当创建一个私有集群时，API masters变成一个私有端点，并与nodes &amp; pods放在同一个子网上。</p><blockquote class="lh"><p id="8ba7" class="li lj iq bd lk ll lm ln lo lp lq kv dk translated">Azure将在托管资源组中自动创建一个托管专用DNS区域。该区域名称由系统生成，不具有确定性。</p></blockquote><p id="d10b" class="pw-post-body-paragraph jy jz iq ka b kb lr kd ke kf ls kh ki kj lt kl km kn lu kp kq kr lv kt ku kv ij bi translated">区域名称的不确定性使得将它集成到您的DNS基础架构和链接虚拟网络变得更加困难。区域名称如下所示:</p><blockquote class="lw lx ly"><p id="9449" class="jy jz kx ka b kb kc kd ke kf kg kh ki lz kk kl km ma ko kp kq mb ks kt ku kv ij bi translated"><em class="iq">1565 c3fb-ddf 7–4310-ab3e-b 5070 dxx 1b 10 . private link . Canada central . azmk 8s . io</em></p></blockquote><p id="9dc3" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">受Pavel tuz ov<a class="ae kw" href="https://medium.com/@paveltuzov/create-a-fully-private-aks-infrastructure-with-terraform-e92358f0bf65" rel="noopener">的启发，我决定发挥创意，确保私有DNS区域在集群创建期间链接到我的DNS转发器所在的虚拟网络。</a></p><h1 id="29b1" class="mc md iq bd me mf mg mh mi mj mk ml mm mn mo mp mq mr ms mt mu mv mw mx my mz bi translated">解决办法</h1><p id="775a" class="pw-post-body-paragraph jy jz iq ka b kb na kd ke kf nb kh ki kj nc kl km kn nd kp kq kr ne kt ku kv ij bi translated">该解决方案需要剖析<em class="kx">azure RM _ kubernetes _ cluster</em>资源的<em class="kx"> private_fqdn </em>成员。使用局部变量，很容易执行逻辑，然后使用输出导出所需的数据元素以支持虚拟网络链接</p><pre class="kz la lb lc gt nf ng nh ni aw nj bi"><span id="39f8" class="nk md iq ng b gy nl nm l nn no"># Magic to generate the Private DNS zone information that is automatically created by Microsoft.<br/># Used for creation of a Private DNS zone link<br/>locals {<br/>  private_dns_zone_name = join(".", slice(split(".", azurerm_kubernetes_cluster.aks_cluster.private_fqdn), 1, length(split(".", azurerm_kubernetes_cluster.aks_cluster.private_fqdn))))<br/>  private_dns_zone_id   = "${data.azurerm_subscription.current.id}/resourceGroups/${azurerm_kubernetes_cluster.aks_cluster.node_resource_group}/providers/Microsoft.Network/privateDnsZones/${local.private_dns_zone_name}"<br/>}</span><span id="3344" class="nk md iq ng b gy np nm l nn no">resource "azurerm_kubernetes_cluster" "aks_cluster" {<br/>  # Content omitted for brevity<br/>}</span><span id="9354" class="nk md iq ng b gy np nm l nn no"># Supports the configuration of private dns zone links.<br/># May perform the linking as an opinion in this module in the future.<br/>output "managed_rg_name" {<br/>  value       = azurerm_kubernetes_cluster.aks_cluster.node_resource_group<br/>  description = "Resource Group name managed by Microsoft when creating the cluster"<br/>}<br/>output "private_dns_zone_name" {<br/>  value       = local.private_dns_zone_name<br/>  description = "Zone Name for the Private DNS Zone generated by private AKS"<br/>}<br/>output "private_dns_zone_id" {<br/>  value       = local.private_dns_zone_id<br/>  description = "Resource Id for the Private DNS Zone generated by private AKS"<br/>}</span><span id="c587" class="nk md iq ng b gy np nm l nn no"># This is to perform the network link from the module<br/>resource "azurerm_private_dns_zone_virtual_network_link" "zone_link_cac_cluster" {<br/>  name                  = "hub_link"<br/>  resource_group_name   = module.cac_aks.managed_rg_name<br/>  private_dns_zone_name = module.cac_aks.private_dns_zone_name<br/>  virtual_network_id    = azurerm_virtual_network.hub.id // The Hub needs to reach the zone<br/>}</span></pre><p id="5e57" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我猜可以修改Terraform模块来导出这些数据。在此期间，这是一个非常好的解决方法。</p><p id="e2e5" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我希望微软会让AKS遵循与其他支持私有端点的服务相同的方法。</p></div></div>    
</body>
</html>