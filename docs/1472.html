<html>
<head>
<title>How to Inspect the Configuration of a Kubernetes Node</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何检查Kubernetes节点的配置</h1>
<blockquote>原文：<a href="https://itnext.io/how-to-inspect-the-configuration-of-a-kubernetes-node-ca2b7fd2a9a3?source=collection_archive---------0-----------------------#2018-10-26">https://itnext.io/how-to-inspect-the-configuration-of-a-kubernetes-node-ca2b7fd2a9a3?source=collection_archive---------0-----------------------#2018-10-26</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="c55c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">查看Kubernetes节点的配置听起来是一件简单的事情，但是并不那么明显。</p><p id="672c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">kubelet接受的参数要么来自于<a class="ae kl" href="https://kubernetes.io/docs/reference/command-line-tools-reference/kubelet/" rel="noopener ugc nofollow" target="_blank">命令行</a>参数，要么来自于您通过<code class="fe km kn ko kp b">--config</code>传递的配置文件。似乎，直截了当地做一个<code class="fe km kn ko kp b">ps -ex | grep kubelet</code>并在文件中查看你看到的<code class="fe km kn ko kp b">--config</code>参数之后。简单吧？但是……你确定所有的论证都是正确的吗？如果Kubernetes默认了一个您不想要的值呢？如果您没有对节点的shell访问权限，该怎么办？</p><p id="2bbc" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">有一种方法可以向Kubernetes API查询节点正在运行的配置:<code class="fe km kn ko kp b">api/vi/nodes/&lt;node_name&gt;/proxy/cofigz</code>。让我们在实际部署中看看这一点。</p><h2 id="717e" class="kq kr iq bd ks kt ku dn kv kw kx dp ky jy kz la lb kc lc ld le kg lf lg lh li bi translated">部署Kubernetes集群</h2><p id="8f37" class="pw-post-body-paragraph jn jo iq jp b jq lj js jt ju lk jw jx jy ll ka kb kc lm ke kf kg ln ki kj kk ij bi translated">我这里使用的是AWS上Kubernetes (CDK)  的<a class="ae kl" href="https://jujucharms.com/canonical-kubernetes/" rel="noopener ugc nofollow" target="_blank"> <em class="lo">规范发行版，但是你可以使用任何你喜欢的云和Kubernetes安装方法。</em></a></p><pre class="lp lq lr ls gt lt kp lu lv aw lw bi"><span id="c3c6" class="kq kr iq kp b gy lx ly l lz ma">juju bootstrap aws<br/>juju deploy canonical-kubernetes</span></pre><p id="4af5" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">..并等待部署完成</p><pre class="lp lq lr ls gt lt kp lu lv aw lw bi"><span id="8781" class="kq kr iq kp b gy lx ly l lz ma">watch juju status </span></pre><h2 id="8a52" class="kq kr iq bd ks kt ku dn kv kw kx dp ky jy kz la lb kc lc ld le kg lf lg lh li bi translated">更改配置</h2><p id="67f1" class="pw-post-body-paragraph jn jo iq jp b jq lj js jt ju lk jw jx jy ll ka kb kc lm ke kf kg ln ki kj kk ij bi translated"><a class="ae kl" href="https://jujucharms.com/canonical-kubernetes/" rel="noopener ugc nofollow" target="_blank"> CDK </a>允许配置命令行参数和配置文件的额外参数。这里我们向配置文件添加参数:</p><pre class="lp lq lr ls gt lt kp lu lv aw lw bi"><span id="9559" class="kq kr iq kp b gy lx ly l lz ma">juju config kubernetes-worker kubelet-extra-config='{imageGCHighThresholdPercent: 60, imageGCLowThresholdPercent: 39}'</span></pre><p id="a8bf" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">一个很大的问题是我们如何得到<code class="fe km kn ko kp b">imageGCHighThreshholdPercent</code>的字面意思。在撰写本文时，官方的<a class="ae kl" href="https://kubernetes.io/docs/tasks/administer-cluster/kubelet-config-file/#create-the-config-file" rel="noopener ugc nofollow" target="_blank">上游文档</a>会将您指向<a class="ae kl" href="https://github.com/kubernetes/kubernetes/blob/master/pkg/kubelet/apis/config/types.go" rel="noopener ugc nofollow" target="_blank">类型定义</a>；一种相当丑陋的方法。在类型定义中有一个<code class="fe km kn ko kp b">EvictionHard</code>属性，但是，如果你看一下<a class="ae kl" href="https://kubernetes.io/docs/tasks/administer-cluster/kubelet-config-file/#create-the-config-file" rel="noopener ugc nofollow" target="_blank">上游文档</a>的例子，你会看到相同的属性是小写的。</p><h2 id="e20d" class="kq kr iq bd ks kt ku dn kv kw kx dp ky jy kz la lb kc lc ld le kg lf lg lh li bi translated">检查配置</h2><p id="fc74" class="pw-post-body-paragraph jn jo iq jp b jq lj js jt ju lk jw jx jy ll ka kb kc lm ke kf kg ln ki kj kk ij bi translated">我们需要两个弹壳。第一次我们将启动API代理，第二次我们将查询API。在第一个壳上:</p><pre class="lp lq lr ls gt lt kp lu lv aw lw bi"><span id="6c4a" class="kq kr iq kp b gy lx ly l lz ma">juju ssh kubernetes-master/0<br/>kubectl proxy</span></pre><p id="c5eb" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在我们在kubernetes-master上的<code class="fe km kn ko kp b">127.0.0.1:8001</code>处有了代理，使用第二个shell来获取节点名，我们查询API:</p><pre class="lp lq lr ls gt lt kp lu lv aw lw bi"><span id="e6ba" class="kq kr iq kp b gy lx ly l lz ma">juju ssh kubernetes-master/0<br/>kubectl get no<br/>curl -sSL "<a class="ae kl" href="http://localhost:8001/api/v1/nodes/" rel="noopener ugc nofollow" target="_blank">http://localhost:8001/api/v1/nodes/</a>&lt;node_name&gt;/proxy/configz" | python3 -m json.tool</span></pre><p id="b245" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这里是一个完整的运行:</p><pre class="lp lq lr ls gt lt kp lu lv aw lw bi"><span id="342d" class="kq kr iq kp b gy lx ly l lz ma">juju ssh kubernetes-master/0<br/>Welcome to Ubuntu 18.04.1 LTS (GNU/Linux 4.15.0-1023-aws x86_64)</span><span id="c5ab" class="kq kr iq kp b gy mb ly l lz ma">* Documentation:  <a class="ae kl" href="https://help.ubuntu.com" rel="noopener ugc nofollow" target="_blank">https://help.ubuntu.com</a><br/> * Management:     <a class="ae kl" href="https://landscape.canonical.com" rel="noopener ugc nofollow" target="_blank">https://landscape.canonical.com</a><br/> * Support:        <a class="ae kl" href="https://ubuntu.com/advantage" rel="noopener ugc nofollow" target="_blank">https://ubuntu.com/advantage</a></span><span id="f44e" class="kq kr iq kp b gy mb ly l lz ma">System information as of Mon Oct 22 10:40:40 UTC 2018</span><span id="65a7" class="kq kr iq kp b gy mb ly l lz ma">System load:  0.11               Processes:              115<br/>  Usage of /:   13.7% of 15.45GB   Users logged in:        1<br/>  Memory usage: 20%                IP address for ens5:    172.31.0.48<br/>  Swap usage:   0%                 IP address for fan-252: 252.0.48.1</span><span id="8bbf" class="kq kr iq kp b gy mb ly l lz ma">Get cloud support with Ubuntu Advantage Cloud Guest:<br/>    <a class="ae kl" href="http://www.ubuntu.com/business/services/cloud" rel="noopener ugc nofollow" target="_blank">http://www.ubuntu.com/business/services/cloud</a></span><span id="d8e9" class="kq kr iq kp b gy mb ly l lz ma">0 packages can be updated.<br/>0 updates are security updates.</span><span id="0680" class="kq kr iq kp b gy mb ly l lz ma">Last login: Mon Oct 22 10:38:14 2018 from 2.86.54.15<br/>To run a command as administrator (user "root"), use "sudo &lt;command&gt;".<br/>See "man sudo_root" for details.</span><span id="41a4" class="kq kr iq kp b gy mb ly l lz ma">ubuntu@ip-172-31-0-48:~$ kubectl get no<br/>NAME               STATUS   ROLES    AGE   VERSION<br/>ip-172-31-14-174   Ready    &lt;none&gt;   41m   v1.12.1<br/>ip-172-31-24-80    Ready    &lt;none&gt;   41m   v1.12.1<br/>ip-172-31-63-34    Ready    &lt;none&gt;   41m   v1.12.1<br/>ubuntu@ip-172-31-0-48:~$ curl -sSL "<a class="ae kl" href="http://localhost:8001/api/v1/nodes/ip-172-31-14-174/proxy/configz" rel="noopener ugc nofollow" target="_blank">http://localhost:8001/api/v1/nodes/ip-172-31-14-174/proxy/configz</a>" | python3 -m json.tool<br/>{<br/>    "kubeletconfig": {<br/>        "syncFrequency": "1m0s",<br/>        "fileCheckFrequency": "20s",<br/>        "httpCheckFrequency": "20s",<br/>        "address": "0.0.0.0",<br/>        "port": 10250,<br/>        "tlsCertFile": "/root/cdk/server.crt",<br/>        "tlsPrivateKeyFile": "/root/cdk/server.key",<br/>        "authentication": {<br/>            "x509": {<br/>                "clientCAFile": "/root/cdk/ca.crt"<br/>            },<br/>            "webhook": {<br/>                "enabled": true,<br/>                "cacheTTL": "2m0s"<br/>            },<br/>            "anonymous": {<br/>                "enabled": false<br/>            }<br/>        },<br/>        "authorization": {<br/>            "mode": "Webhook",<br/>            "webhook": {<br/>                "cacheAuthorizedTTL": "5m0s",<br/>                "cacheUnauthorizedTTL": "30s"<br/>            }<br/>        },<br/>        "registryPullQPS": 5,<br/>        "registryBurst": 10,<br/>        "eventRecordQPS": 5,<br/>        "eventBurst": 10,<br/>        "enableDebuggingHandlers": true,<br/>        "healthzPort": 10248,<br/>        "healthzBindAddress": "127.0.0.1",<br/>        "oomScoreAdj": -999,<br/>        "clusterDomain": "cluster.local",<br/>        "clusterDNS": [<br/>            "10.152.183.93"<br/>        ],<br/>        "streamingConnectionIdleTimeout": "4h0m0s",<br/>        "nodeStatusUpdateFrequency": "10s",<br/>        "nodeLeaseDurationSeconds": 40,<br/>        "imageMinimumGCAge": "2m0s",<br/>        "imageGCHighThresholdPercent": 60,<br/>        "imageGCLowThresholdPercent": 39,<br/>        "volumeStatsAggPeriod": "1m0s",<br/>        "cgroupsPerQOS": true,<br/>        "cgroupDriver": "cgroupfs",<br/>        "cpuManagerPolicy": "none",<br/>        "cpuManagerReconcilePeriod": "10s",<br/>        "runtimeRequestTimeout": "2m0s",<br/>        "hairpinMode": "promiscuous-bridge",<br/>        "maxPods": 110,<br/>        "podPidsLimit": -1,<br/>        "resolvConf": "/run/systemd/resolve/resolv.conf",<br/>        "cpuCFSQuota": true,<br/>        "cpuCFSQuotaPeriod": "100ms",<br/>        "maxOpenFiles": 1000000,<br/>        "contentType": "application/vnd.kubernetes.protobuf",<br/>        "kubeAPIQPS": 5,<br/>        "kubeAPIBurst": 10,<br/>        "serializeImagePulls": true,<br/>        "evictionHard": {<br/>            "imagefs.available": "15%",<br/>            "memory.available": "100Mi",<br/>            "nodefs.available": "10%",<br/>            "nodefs.inodesFree": "5%"<br/>        },<br/>        "evictionPressureTransitionPeriod": "5m0s",<br/>        "enableControllerAttachDetach": true,<br/>        "makeIPTablesUtilChains": true,<br/>        "iptablesMasqueradeBit": 14,<br/>        "iptablesDropBit": 15,<br/>        "failSwapOn": false,<br/>        "containerLogMaxSize": "10Mi",<br/>        "containerLogMaxFiles": 5,<br/>        "configMapAndSecretChangeDetectionStrategy": "Watch",<br/>        "enforceNodeAllocatable": [<br/>            "pods"<br/>        ]<br/>    }<br/>}</span></pre><h2 id="bf20" class="kq kr iq bd ks kt ku dn kv kw kx dp ky jy kz la lb kc lc ld le kg lf lg lh li bi translated">总结</h2><p id="35f4" class="pw-post-body-paragraph jn jo iq jp b jq lj js jt ju lk jw jx jy ll ka kb kc lm ke kf kg ln ki kj kk ij bi translated">有一种方法可以通过Kubernetes API(<em class="lo">API/v1/nodes/&lt;node _ name&gt;/proxy/configz</em>)获得在线Kubernetes节点的配置。如果您想针对Kubernetes进行编码，或者不想了解特定集群设置的复杂性，这可能会很方便。</p><h2 id="507b" class="kq kr iq bd ks kt ku dn kv kw kx dp ky jy kz la lb kc lc ld le kg lf lg lh li bi translated">参考</h2><ul class=""><li id="f7be" class="mc md iq jp b jq lj ju lk jy me kc mf kg mg kk mh mi mj mk bi translated">Kubelet配置:<a class="ae kl" href="https://kubernetes.io/docs/tasks/administer-cluster/kubelet-config-file/#create-the-config-file" rel="noopener ugc nofollow" target="_blank">https://kubernetes . io/docs/tasks/administrator-cluster/kube let-config-file/# create-the-config-file</a></li><li id="f2ce" class="mc md iq jp b jq ml ju mm jy mn kc mo kg mp kk mh mi mj mk bi translated">库伯内特的典型分布:【https://jujucharms.com/canonical-kubernetes/ T4】</li></ul></div></div>    
</body>
</html>