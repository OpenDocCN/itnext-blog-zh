<html>
<head>
<title>URI.escape is obsolete. Percent-encoding your query string</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">URI.escape已过时。对查询字符串进行百分比编码</h1>
<blockquote>原文：<a href="https://itnext.io/uri-escape-is-obsolete-percent-encoding-your-query-string-cd998c4e847c?source=collection_archive---------5-----------------------#2020-01-19">https://itnext.io/uri-escape-is-obsolete-percent-encoding-your-query-string-cd998c4e847c?source=collection_archive---------5-----------------------#2020-01-19</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="6c96" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">你在你的Ruby 2.7.0项目中遇到过这样的警告吗？</p><p id="b31b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><code class="fe kl km kn ko b">warning: URI.escape is obsolete warning: URI.encode is obsolete</code></p><p id="9d63" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">找出如何修复它！</p><figure class="kq kr ks kt gt ku gh gi paragraph-image"><div role="button" tabindex="0" class="kv kw di kx bf ky"><div class="gh gi kp"><img src="../Images/4703f27616f657dcd83372fa30b4978d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*MTspLG5EuXpkvn1P.jpeg"/></div></div></figure><h1 id="d15f" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">一点历史</h1><p id="42ab" class="pw-post-body-paragraph jn jo iq jp b jq lz js jt ju ma jw jx jy mb ka kb kc mc ke kf kg md ki kj kk ij bi translated">Ruby 2.7.0在调用<code class="fe kl km kn ko b">URI.escape</code>或者它的别名<code class="fe kl km kn ko b">URI.encode</code>时会显示一个警告。这看起来像是一个新的弃用，但事实是，这些方法已经被标记为过时...<a class="ae me" href="https://github.com/ruby/ruby/commit/238b979f1789f95262a267d8df6239806f2859cc" rel="noopener ugc nofollow" target="_blank">10年过去了</a>！如果您想知道为什么以前从来没有遇到过这个警告，这里有一个答案:以前只有当您以详细模式运行您的脚本时它才会显示，而这种情况最近才发生了变化。</p><h1 id="aa94" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">那么，为什么<code class="fe kl km kn ko b">URI.escape</code>已经过时了呢？</h1><p id="3676" class="pw-post-body-paragraph jn jo iq jp b jq lz js jt ju ma jw jx jy mb ka kb kc mc ke kf kg md ki kj kk ij bi translated">“逃离URI”这个概念的麻烦在于，URI由许多组件组成(像<code class="fe kl km kn ko b">path</code>或<code class="fe kl km kn ko b">query</code>，我们不想以同样的方式逃离它们。例如，在URI的末尾出现一个<code class="fe kl km kn ko b">#</code>字符是没问题的(当它被用作通常所说的锚，或者在URI的说法中是一个<code class="fe kl km kn ko b">fragment</code>组件)，但是当同一个<code class="fe kl km kn ko b">#</code>是用户输入的一部分时(比如在一个搜索查询中)，我们希望对它进行编码以确保正确的解释。类似地，如果查询字符串值包含其他保留字符，如<code class="fe kl km kn ko b">=</code>或<code class="fe kl km kn ko b">&amp;</code>，我们<em class="mf">确实</em>想要对它们进行转义，这样它们就不会被错误地解释为分隔符，就好像它们被用作保留字符一样。</p><p id="c290" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><code class="fe kl km kn ko b">URI.escape</code>依赖于对整个字符串的一个简单的<code class="fe kl km kn ko b">gsub</code>操作，不区分不同的组件，没有考虑到上面提到的复杂性。</p><h1 id="8195" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">怎么修？</h1><p id="d94f" class="pw-post-body-paragraph jn jo iq jp b jq lz js jt ju ma jw jx jy mb ka kb kc mc ke kf kg md ki kj kk ij bi translated">由于我还没有找到一个现有的解决方案，当给定一个完整的URI字符串时，它可以解释不同的组件，并以自己希望的方式应用不同的转义规则，所以我的建议是分别对不同的组件进行编码。最常见的(也是最敏感的)用例可能是在<code class="fe kl km kn ko b">query</code>组件中对查询字符串进行编码，所以我将重点讨论这种情况。Ruby的<code class="fe kl km kn ko b">URI</code>模块本身提供了两个方便的方法来帮助我们实现这个目标！</p><h1 id="dcd8" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">对查询字符串进行百分比编码</h1><h2 id="bf2a" class="mg lc iq bd ld mh mi dn lh mj mk dp ll jy ml mm lp kc mn mo lt kg mp mq lx mr bi translated"><code class="fe kl km kn ko b">URI.encode_www_form_component(string, enc=nil)</code></h2><p id="75a6" class="pw-post-body-paragraph jn jo iq jp b jq lz js jt ju ma jw jx jy mb ka kb kc mc ke kf kg md ki kj kk ij bi translated">这个方法将对每个保留字符进行百分比编码，只保留<code class="fe kl km kn ko b">*, -, ., 0-9, A-Z, _, a-z</code>不变。还用<code class="fe kl km kn ko b">+</code>代替空格。示例:</p><p id="7527" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如您所见，我们现在可以安全地用这种方式转义的值构建查询字符串。但是如果这看起来像是太多的手工工作，有一种简便的方法可以为您处理整个查询。介绍…</p><p id="caa9" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">界面略有不同。它采用一个<code class="fe kl km kn ko b">Enumerable</code>(通常是嵌套的<code class="fe kl km kn ko b">Array</code>或<code class="fe kl km kn ko b">Hash</code>)并相应地构建查询。它在内部使用<code class="fe kl km kn ko b">.encode_www_form_component</code>，所以编码规则保持不变。区别在于你使用的方式。示例:</p><p id="9471" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">很简单，不是吗？</p><h1 id="5bb4" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">Rails项目？</h1><h2 id="710b" class="mg lc iq bd ld mh mi dn lh mj mk dp ll jy ml mm lp kc mn mo lt kg mp mq lx mr bi translated"><code class="fe kl km kn ko b">Hash#to_query</code></h2><p id="e48f" class="pw-post-body-paragraph jn jo iq jp b jq lz js jt ju ma jw jx jy mb ka kb kc mc ke kf kg md ki kj kk ij bi translated">(又名<code class="fe kl km kn ko b">Hash.to_param</code>)</p><p id="4f65" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">Rails用这个方便的方法扩展了<code class="fe kl km kn ko b">Hash</code>类。它将以正确的格式返回一个查询字符串，并根据需要对其值进行正确编码。</p><p id="4d21" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">(注意它也是如何按字母顺序对键进行排序的。)</p><p id="bb9e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">您还可以向该方法传递一个可选的名称空间，它会将键名包含在返回的字符串中，产生类似于<code class="fe kl km kn ko b">search[q]="how to speed up your CI?"</code>的格式(但显然是百分比编码的):</p><h1 id="3193" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">总结</h1><p id="0cb3" class="pw-post-body-paragraph jn jo iq jp b jq lz js jt ju ma jw jx jy mb ka kb kc mc ke kf kg md ki kj kk ij bi translated">我希望这篇短文能消除您对在URI使用字符串编码的任何困惑。如果您在您的Ruby/Rails项目中使用任何其他方式来处理百分比编码，请在评论中告诉我们！</p><p id="7880" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果您的项目正在与缓慢的CI构建作斗争，请查看<a class="ae me" href="https://knapsackpro.com/?utm_source=medium&amp;utm_medium=blog_post&amp;utm_campaign=uri-escape-is-obsolete-percent-encoding-your-query-string" rel="noopener ugc nofollow" target="_blank">backpack Pro</a>，它可以帮助您解决这个问题。</p></div><div class="ab cl ms mt hu mu" role="separator"><span class="mv bw bk mw mx my"/><span class="mv bw bk mw mx my"/><span class="mv bw bk mw mx"/></div><div class="ij ik il im in"><p id="8ab5" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><em class="mf">原载于</em> <strong class="jp ir"> <em class="mf">沙迪雷塞克</em> </strong> <em class="mf">于2020年1月19日</em><a class="ae me" href="https://docs.knapsackpro.com/2020/uri-escape-is-obsolete-percent-encoding-your-query-string" rel="noopener ugc nofollow" target="_blank">【https://docs.knapsackpro.com】</a><em class="mf"><em class="mf">。</em></em></p></div></div>    
</body>
</html>