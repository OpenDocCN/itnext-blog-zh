<html>
<head>
<title>Node-RED OwnTracks location tracking without public IP/MQTT</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">无公共IP/MQTT的节点红色OwnTracks位置跟踪</h1>
<blockquote>原文：<a href="https://itnext.io/node-red-owntracks-location-tracking-without-public-ip-mqtt-41390e16f9e0?source=collection_archive---------3-----------------------#2019-01-09">https://itnext.io/node-red-owntracks-location-tracking-without-public-ip-mqtt-41390e16f9e0?source=collection_archive---------3-----------------------#2019-01-09</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div class="gh gi jn"><img src="../Images/4b7a286e33ed2bde39636baa626641d3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1120/format:webp/0*3UF4P-PQr2mA-jUF.png"/></div></figure><p id="c0ae" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">如果你想追踪你的位置，但不想让太多不应该知道它的公司分享，看看这个神奇的开源移动应用程序<a class="ae ks" href="https://owntracks.org/" rel="noopener ugc nofollow" target="_blank">own tracks</a>(【https://github.com/owntracks】T2)可以将手机的位置数据发送到你选择的服务器。不需要任何外部服务来聚合您的数据，允许您对收集到的位置数据做任何您想做的事情。OwnTracks可以向MQTT服务器或标准HTTP端点发送有效负载。似乎很多人都在Bluemix等云提供商上运行MQTT服务，然后将这些消息转发到他们在家里或其他有防火墙的地方运行的私有网络。</p><p id="8258" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">在这个简短的教程中，我们将使用<a class="ae ks" href="https://nodered.org/" rel="noopener ugc nofollow" target="_blank"> Node-RED </a>来接收、处理和可视化我们的位置数据。位置数据将在传输过程中使用TLS和lib钠(<a class="ae ks" href="https://download.libsodium.org/doc/secret-key_cryptography" rel="noopener ugc nofollow" target="_blank">密钥认证加密</a>)进行加密，直到到达地图:</p><figure class="ku kv kw kx gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="ky kz di la bf lb"><div class="gh gi kt"><img src="../Images/7e328f87e2dd4238765187763c099b61.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*-YM77WuwMg78-v4L.png"/></div></div></figure><p id="8d70" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">不需要路由器、防火墙配置或公共IP，因为Webhook Relay将提供一个公共端点来接收Webhook，然后通过WebSocket将它们发送到我们的Node-RED实例。</p><blockquote class="lc ld le"><p id="806e" class="ju jv lf jw b jx jy jz ka kb kc kd ke lg kg kh ki lh kk kl km li ko kp kq kr ij bi translated"><em class="iq">如果您的Node-RED可以从互联网访问，您可以跳过Webhook中继部分，只需添加一个HTTP处理程序来处理OwnTracks webhooks。检查</em> <a class="ae ks" href="https://nodered.org/docs/security" rel="noopener ugc nofollow" target="_blank"> <em class="iq">节点-红色安全文档</em> </a> <em class="iq">并确保您的实例启用了身份验证。</em></p></blockquote></div><div class="ab cl lj lk hu ll" role="separator"><span class="lm bw bk ln lo lp"/><span class="lm bw bk ln lo lp"/><span class="lm bw bk ln lo"/></div><div class="ij ik il im in"><h1 id="5c0d" class="lq lr iq bd ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn bi translated">先决条件</h1><ul class=""><li id="9be6" class="mo mp iq jw b jx mq kb mr kf ms kj mt kn mu kr mv mw mx my bi translated"><a class="ae ks" href="https://my.webhookrelay.com" rel="noopener ugc nofollow" target="_blank"> Webhook中继帐户</a> —我们将使用HTTP webhooks，而不是MQTT，这样我们就不必运行单独的服务。此外，Webhook中继使您能够在没有公共IP或配置NAT的情况下接收web hook。</li><li id="b632" class="mo mp iq jw b jx mz kb na kf nb kj nc kn nd kr mv mw mx my bi translated"><a class="ae ks" href="https://nodered.org" rel="noopener ugc nofollow" target="_blank"> Node-RED实例</a>——我假设你已经运行了它，如果没有，<a class="ae ks" href="https://nodered.org/docs/getting-started/installation" rel="noopener ugc nofollow" target="_blank">安装说明可以在这里找到</a>。</li><li id="775a" class="mo mp iq jw b jx mz kb na kf nb kj nc kn nd kr mv mw mx my bi translated">node-red-contrib-webhook relay节点，这样我们就可以订阅webhooks了。</li><li id="6b6f" class="mo mp iq jw b jx mz kb na kf nb kj nc kn nd kr mv mw mx my bi translated"><a class="ae ks" href="https://flows.nodered.org/node/node-red-contrib-owntracks" rel="noopener ugc nofollow" target="_blank">node-red-contrib-own tracks</a>节点解密位置数据。</li><li id="a3e7" class="mo mp iq jw b jx mz kb na kf nb kj nc kn nd kr mv mw mx my bi translated"><a class="ae ks" href="https://flows.nodered.org/node/node-red-contrib-web-worldmap" rel="noopener ugc nofollow" target="_blank">node-red-contrib-we b-world map</a>显示地图并在其上放置位置标记的节点。</li></ul><p id="9f82" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">你可以通过<code class="fe ne nf ng nh b">npm</code>安装节点，或者点击红色节点设置中的“管理面板”。</p><h1 id="6dff" class="lq lr iq bd ls lt ni lv lw lx nj lz ma mb nk md me mf nl mh mi mj nm ml mm mn bi translated">为webhooks创建一个公共端点并安装应用程序</h1><p id="c4f4" class="pw-post-body-paragraph ju jv iq jw b jx mq jz ka kb mr kd ke kf nn kh ki kj no kl km kn np kp kq kr ij bi translated">我们的位置数据将通过公共Webhook中继地址中继到Node-RED。因此，首先要做的是设置您的端点:</p><ol class=""><li id="65e5" class="mo mp iq jw b jx jy kb kc kf nq kj nr kn ns kr nt mw mx my bi translated">转到<a class="ae ks" href="https://webhookrelay.com/blog/2019/01/09/nodered-owntracks-direct/buckets%20page" rel="noopener ugc nofollow" target="_blank">https://my.webhookrelay.com/buckets</a>并点击<em class="lf">创建桶</em>。将其命名为“owntracks”。Buckets是一种分组机制，用于聚合webhooks并将它们分散到多个目的地。因为我们将使用WebSockets，所以不需要创建输出(如果您希望从web界面重新发送功能，您可以创建一个输出)。</li><li id="084f" class="mo mp iq jw b jx mz kb na kf nb kj nc kn nd kr nt mw mx my bi translated">一旦创建了bucket，请注意公共端点URL，其格式为<code class="fe ne nf ng nh b">https://my.webhookrelay.com/v1/webhooks/[your-unique-uuid]</code>。您需要将它提供给自己的Tracks应用程序。</li></ol><p id="5958" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">安装和配置应用程序:</p><ol class=""><li id="b95c" class="mo mp iq jw b jx jy kb kc kf nq kj nr kn ns kr nt mw mx my bi translated">前往<a class="ae ks" href="https://owntracks.org/" rel="noopener ugc nofollow" target="_blank">https://owntracks.org/</a>并根据您手机操作系统的指示进行操作。</li><li id="1803" class="mo mp iq jw b jx mz kb na kf nb kj nc kn nd kr nt mw mx my bi translated">一旦你有了应用程序，进入设置，将模式设置为HTTP，端点应该设置为你之前得到的Webhook中继输入URL。如果你想看看数据结构，先不要设置<code class="fe ne nf ng nh b">Secret encryption key</code>选项。</li></ol><p id="0b82" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">设置完这些设置后，您可以从应用程序中手动发布您的位置。Webhook日志应该开始出现在您的bucket details页面或<a class="ae ks" href="https://webhookrelay.com/blog/2019/01/09/nodered-owntracks-direct/logs" rel="noopener ugc nofollow" target="_blank">https://my.webhookrelay.com/logs</a>中。</p><h1 id="ff66" class="lq lr iq bd ls lt ni lv lw lx nj lz ma mb nk md me mf nl mh mi mj nm ml mm mn bi translated">数据结构</h1><p id="6eba" class="pw-post-body-paragraph ju jv iq jw b jx mq jz ka kb mr kd ke kf nn kh ki kj no kl km kn np kp kq kr ij bi translated">如果您没有在OwnTracks应用程序中设置“秘密加密密钥”，您可以在您的Webhook中继<a class="ae ks" href="https://webhookrelay.com/blog/2019/01/09/nodered-owntracks-direct/logs%20page" rel="noopener ugc nofollow" target="_blank">https://my.webhookrelay/logs</a>上查看web hook。有效载荷示例:</p><pre class="ku kv kw kx gt nu nh nv nw aw nx bi"><span id="5ea0" class="ny lr iq nh b gy nz oa l ob oc">{<br/> "batt": 69,<br/> "lon": 0.008261475503538551,<br/> "acc": 2000,<br/> "p": 102.94917297363281,<br/> "vac": 44,<br/> "topic": "owntracks/kr-1/EEIR6BC7-17AB-57AD-803E-651363E02256",<br/> "lat": 52.416367098924324,<br/> "conn": "w",<br/> "tst": 1546786399,<br/> "alt": 10,<br/> "_type": "location",<br/> "tid": "kr"<br/>}</span></pre><p id="b873" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">因为它是一个JSON有效负载，所以使用它要容易得多。根据<a class="ae ks" href="https://webhookrelay.com/v1/guide/socket-server.html#Schema" rel="noopener ugc nofollow" target="_blank"> Socket服务器文档</a>，当它从WebSocket出来时，我们的实际有效负载将在<code class="fe ne nf ng nh b">payload.body</code>变量中。虽然解密的数据都很好，但我们可以对其进行加密，以便在现有TLS的基础上获得额外的安全层。进入应用程序，将<code class="fe ne nf ng nh b">Secret encryption key</code>设置为您的秘密。现在，有效载荷数据应该看起来像这样:</p><pre class="ku kv kw kx gt nu nh nv nw aw nx bi"><span id="99e5" class="ny lr iq nh b gy nz oa l ob oc">{<br/> "_type": "encrypted",<br/> "data": "edxJuWXnAOWvWdIHx1wfu6/IQsRQf5Gs3XFqRY4gQU1p3NLV2Upr8u4u8Lu4p9x+nEPnONKy0Gio1qumdjJV6n+U6YUqkj9mZIUVuyHznNuLM2zzaGKuTFFQeJjo+AjRYtnlK4rSsQou6LnaDcT9lqKYZinWESNWsg6qIKcfx8jsl2f//dSDzH02VBvO0Dg5iqupf9ZWBMuQbO9/EPvBtkaaOt0c41dfQUR3+4YY8cQx+FXB9yWHPyuyKlxAU+vAgSo6QAyJE4h4z9ZuD4y5SYkZ35Rp+QS8tsI0CNTUzA551Jo4EsWl7dwcTfbYyQB+7sDU3yFhD3oLAuwPOCRdvHLlpGS0G3D6T/ujU8pKkJj5ldT8Sw=="<br/>}</span></pre><h1 id="7bef" class="lq lr iq bd ls lt ni lv lw lx nj lz ma mb nk md me mf nl mh mi mj nm ml mm mn bi translated">创造流动</h1><figure class="ku kv kw kx gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="ky kz di la bf lb"><div class="gh gi od"><img src="../Images/3bb4f39bedd75a64639835bbd3ab4e7e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*IMET-_3poJPQzR6c.png"/></div></div></figure><p id="6e00" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">一旦我们知道我们正在接收什么样的数据以及世界地图期望什么样的数据，实际的流程就很简单了。让我们看看根据node-red-contrib-we b-world map需要什么样的配置<a class="ae ks" href="https://flows.nodered.org/node/node-red-contrib-web-worldmap" rel="noopener ugc nofollow" target="_blank">:</a></p><pre class="ku kv kw kx gt nu nh nv nw aw nx bi"><span id="5276" class="ny lr iq nh b gy nz oa l ob oc">msg.payload = { name:”Jason”, lat:51.05, lon:-1.35 }</span></pre><p id="87ff" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">我们还可以包括<code class="fe ne nf ng nh b">icon</code>字段来区分多个跟踪器。</p><h1 id="9734" class="lq lr iq bd ls lt ni lv lw lx nj lz ma mb nk md me mf nl mh mi mj nm ml mm mn bi translated">步骤1:获取数据</h1><p id="f574" class="pw-post-body-paragraph ju jv iq jw b jx mq jz ka kb mr kd ke kf nn kh ki kj no kl km kn np kp kq kr ij bi translated">我们将使用<a class="ae ks" href="https://flows.nodered.org/node/node-red-contrib-webhookrelay" rel="noopener ugc nofollow" target="_blank">node-red-contrib-Webhook Relay</a>节点从正在接收OwnTracks webhooks的Webhook中继桶接收webhooks。转到<a class="ae ks" href="https://my.webhookrelay.com/tokens" rel="noopener ugc nofollow" target="_blank">令牌页面</a>，生成密钥&amp;秘密令牌对并将它们添加到节点。将bucket设置为<code class="fe ne nf ng nh b">owntracks</code>(它必须与正在接收Webhook的web hook中继中的bucket名称相匹配)。一旦到达那里，尝试部署流，并查看节点是否进入<strong class="jw ir">连接</strong>状态。</p><p id="a755" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">Webhook中继节点消息包含桶元数据、头、请求查询、方法和主体。然而，在这种情况下，我们只关心身体，所以让我们提取它。使用以下代码创建一个函数节点:</p><pre class="ku kv kw kx gt nu nh nv nw aw nx bi"><span id="46e8" class="ny lr iq nh b gy nz oa l ob oc">return {<br/> payload: msg.payload.body<br/>};</span></pre><h1 id="7066" class="lq lr iq bd ls lt ni lv lw lx nj lz ma mb nk md me mf nl mh mi mj nm ml mm mn bi translated">步骤3:解密OwnTracks位置数据</h1><p id="ca4e" class="pw-post-body-paragraph ju jv iq jw b jx mq jz ka kb mr kd ke kf nn kh ki kj no kl km kn np kp kq kr ij bi translated">一旦我们有了有效载荷，我们需要解密它。添加<a class="ae ks" href="https://flows.nodered.org/node/node-red-contrib-owntracks" rel="noopener ugc nofollow" target="_blank">node-red-contrib-own tracks</a>节点，并将步骤2的输出连接到其中。打开节点设置，设置与您在手机应用程序中设置的相同的密码(<code class="fe ne nf ng nh b">Secret encryption key</code>)。这里不需要额外的配置，它将返回原始的、解密的有效载荷。</p><h1 id="14f3" class="lq lr iq bd ls lt ni lv lw lx nj lz ma mb nk md me mf nl mh mi mj nm ml mm mn bi translated">步骤4:格式化JSON</h1><p id="d39b" class="pw-post-body-paragraph ju jv iq jw b jx mq jz ka kb mr kd ke kf nn kh ki kj no kl km kn np kp kq kr ij bi translated">在这一步中，我们可以在将解密的位置数据传递到世界地图节点之前对其进行定制。下面的例子只是添加了一个图标，但是你可以根据文档随意修改它:</p><pre class="ku kv kw kx gt nu nh nv nw aw nx bi"><span id="3479" class="ny lr iq nh b gy nz oa l ob oc">return {<br/> payload: {<br/>  name: msg.payload.tid,<br/>  lat: msg.payload.lat,<br/>  lon: msg.payload.lon,<br/>  icon: 'user-circle-o'<br/> }<br/>};</span></pre><h1 id="89ba" class="lq lr iq bd ls lt ni lv lw lx nj lz ma mb nk md me mf nl mh mi mj nm ml mm mn bi translated">步骤5:将位置数据发送到地图</h1><p id="e863" class="pw-post-body-paragraph ju jv iq jw b jx mq jz ka kb mr kd ke kf nn kh ki kj no kl km kn np kp kq kr ij bi translated">这一步相当简单。将步骤4的输出连接到<code class="fe ne nf ng nh b">worldmap</code>和<code class="fe ne nf ng nh b">tracks</code>节点。这将总是更新地图上的指针，同时发送数据到<code class="fe ne nf ng nh b">tracks</code>节点，该节点随着对象的移动在地图上画线。用增加的最大年龄配置<code class="fe ne nf ng nh b">worldmap</code>节点，并且将<code class="fe ne nf ng nh b">tracks</code>节点上的跟踪点配置为您喜欢的任何数量。</p><h1 id="74f9" class="lq lr iq bd ls lt ni lv lw lx nj lz ma mb nk md me mf nl mh mi mj nm ml mm mn bi translated">状态管理</h1><p id="2ffb" class="pw-post-body-paragraph ju jv iq jw b jx mq jz ka kb mr kd ke kf nn kh ki kj no kl km kn np kp kq kr ij bi translated">默认情况下，世界地图组件将只显示新创建的位置跟踪点的实时信息。您可以使用<strong class="jw ir">状态</strong>节点在连接新会话时从世界地图中获取状态，并重放数据。您可以根据需要将积分存储在<a class="ae ks" href="https://flows.nodered.org/node/node-red-contrib-postgres" rel="noopener ugc nofollow" target="_blank"> postgres </a>或<a class="ae ks" href="https://flows.nodered.org/node/node-red-node-sqlite" rel="noopener ugc nofollow" target="_blank"> sqlite </a>中。如果您只关心地理围栏操作，则可能不需要州。</p><h1 id="96bd" class="lq lr iq bd ls lt ni lv lw lx nj lz ma mb nk md me mf nl mh mi mj nm ml mm mn bi translated">奖励:地理围栏触发器</h1><p id="013e" class="pw-post-body-paragraph ju jv iq jw b jx mq jz ka kb mr kd ke kf nn kh ki kj no kl km kn np kp kq kr ij bi translated">您还可以将OwnTracks解密节点的摄取数据与<a class="ae ks" href="https://flows.nodered.org/node/node-red-node-geofence" rel="noopener ugc nofollow" target="_blank">节点-红色节点-地理围栏</a>节点连接，以创建基于地理围栏的触发器:</p><figure class="ku kv kw kx gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="ky kz di la bf lb"><div class="gh gi oe"><img src="../Images/91d15432e52cbe51c0bfacf340bc3535.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*vuBPPlfJ-wlzFS3K.png"/></div></div></figure><p id="53e9" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">使用它来创建当追踪器离开或进入某个区域时触发的自动操作(例如，凌晨3点你的汽车离开城镇，而你的手机在家)。</p><h1 id="4066" class="lq lr iq bd ls lt ni lv lw lx nj lz ma mb nk md me mf nl mh mi mj nm ml mm mn bi translated">奖金:家庭助理</h1><p id="5342" class="pw-post-body-paragraph ju jv iq jw b jx mq jz ka kb mr kd ke kf nn kh ki kj no kl km kn np kp kq kr ij bi translated">如果您正在使用Home Assistant，并且发现自己受到ISP的双重NAT限制，或者无法拥有公共IP，请查看我们的<a class="ae ks" href="https://webhookrelay.com/blog/2018/10/12/hassio-tls-tunnels-duckdns/" rel="noopener ugc nofollow" target="_blank">插件</a>，为远程访问创建安全的TLS直通隧道。详细文档可以在这里找到<a class="ae ks" href="https://webhookrelay.com/v1/guide/home-automation.html" rel="noopener ugc nofollow" target="_blank">。</a></p><h1 id="d284" class="lq lr iq bd ls lt ni lv lw lx nj lz ma mb nk md me mf nl mh mi mj nm ml mm mn bi translated">参考</h1><ul class=""><li id="e19f" class="mo mp iq jw b jx mq kb mr kf ms kj mt kn mu kr mv mw mx my bi translated">一篇关于解密OwnTracks位置数据的优秀文章:<a class="ae ks" href="https://www.hardill.me.uk/wordpress/2016/04/26/owntracks-encrypted-location-node-red-node/" rel="noopener ugc nofollow" target="_blank">https://www . hardill . me . uk/WordPress/2016/04/26/own tracks-encrypted-location-node-red-node/</a></li><li id="8672" class="mo mp iq jw b jx mz kb na kf nb kj nc kn nd kr mv mw mx my bi translated"><a class="ae ks" href="https://discourse.nodered.org/t/announce-node-red-contrib-webhookrelay/5989" rel="noopener ugc nofollow" target="_blank"> Webhook中继节点-红色指南</a></li></ul></div><div class="ab cl lj lk hu ll" role="separator"><span class="lm bw bk ln lo lp"/><span class="lm bw bk ln lo lp"/><span class="lm bw bk ln lo"/></div><div class="ij ik il im in"><p id="9fd2" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated"><em class="lf">原载于2019年1月9日webhookrelay.com</em><a class="ae ks" href="https://webhookrelay.com/blog/2019/01/09/nodered-owntracks-direct/" rel="noopener ugc nofollow" target="_blank"><em class="lf"/></a><em class="lf">。</em></p></div></div>    
</body>
</html>