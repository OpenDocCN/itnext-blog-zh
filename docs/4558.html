<html>
<head>
<title>qbec — The deployment tool for multiple kubernetes environments</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">qbec——多kubernetes环境的部署工具</h1>
<blockquote>原文：<a href="https://itnext.io/qbec-the-deployment-tool-for-multiple-kubernetes-environments-c39b6bd7ea07?source=collection_archive---------3-----------------------#2020-07-24">https://itnext.io/qbec-the-deployment-tool-for-multiple-kubernetes-environments-c39b6bd7ea07?source=collection_archive---------3-----------------------#2020-07-24</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="fee9" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">DevOps工程师和Kubernetes管理员经常需要将他们的应用和服务部署到多个环境中。根据设置的不同，环境可能意味着一个Kubernetes集群或同一集群中的一个名称空间，或者跨集群的名称空间的组合。部署到不同的环境可能有多种动机。将测试环境与生产环境和多区域(包括多云)部署隔离开来是多环境设置的一些常见示例。</p><p id="2cdb" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">Kubernetes生态系统有许多工具可以帮助开发人员部署应用程序。如果您通读Kubernetes文档，您将会看到可用于创建或更新Kubernetes对象的YAML文件的示例和片段。部署、服务、配置映射和秘密是最常用的Kubernetes对象。随着应用程序的增长，管理YAML文件会变得越来越复杂。<a class="ae kl" href="https://jsonnet.org/" rel="noopener ugc nofollow" target="_blank"> Jsonnet </a>已经成为管理这种复杂性的一种优雅方式。使用<a class="ae kl" href="https://qbec.io/" rel="noopener ugc nofollow" target="_blank"> qbec </a>时，整体工作流程进一步简化。</p></div><div class="ab cl km kn hu ko" role="separator"><span class="kp bw bk kq kr ks"/><span class="kp bw bk kq kr ks"/><span class="kp bw bk kq kr"/></div><div class="ij ik il im in"><p id="2a1f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><a class="ae kl" href="https://qbec.io" rel="noopener ugc nofollow" target="_blank"> qbec </a> —读作“魁北克”(加拿大省)是<em class="kt">一个在多种环境下配置和创建Kubernetes对象的工具。qbec这个名字的由来有一些历史。根据qbec的创建者，<a class="ae kl" href="https://github.com/gotwarlost" rel="noopener ugc nofollow" target="_blank">Krishnan Anantheswaran</a>——“我厌倦了所有以<code class="fe ku kv kw kx b">k</code>开头的k8s工具，它们妨碍了tab键的完成。此外，我想要一个城市名(qbec - &gt;魁北克[城市])，因为我有另一个OSS工具(我不再维护它，但通过其他人继续使用)，叫做<a class="ae kl" href="https://github.com/gotwarlost/istanbul" rel="noopener ugc nofollow" target="_blank">伊斯坦布尔</a>，它非常成功。</em></p><figure class="kz la lb lc gt ld gh gi paragraph-image"><div role="button" tabindex="0" class="le lf di lg bf lh"><div class="gh gi ky"><img src="../Images/3b6e360115763fd29f3ef8efc883a197.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*jvTaHeiUhbDfcWl55VJ_fg.png"/></div></div><figcaption class="lk ll gj gh gi lm ln bd b be z dk translated">qbec徽标(鸣谢:https://qbec.io)</figcaption></figure><p id="4c00" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">qbec是一个独立的客户端工具。它不需要在Kubernetes集群或其他地方运行任何补充的服务器组件。</p><p id="9858" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在本系列中，我们将了解qbec的各种特性，以及如何将它用于各种用例，从部署、预部署工具到捕捉常见错误、垃圾收集和CI/CD工作流。</p></div><div class="ab cl km kn hu ko" role="separator"><span class="kp bw bk kq kr ks"/><span class="kp bw bk kq kr ks"/><span class="kp bw bk kq kr"/></div><div class="ij ik il im in"><h1 id="9980" class="lo lp iq bd lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml bi translated">入门指南</h1><p id="51a7" class="pw-post-body-paragraph jn jo iq jp b jq mm js jt ju mn jw jx jy mo ka kb kc mp ke kf kg mq ki kj kk ij bi translated">qbec可以通过从<a class="ae kl" href="https://github.com/splunk/qbec/releases" rel="noopener ugc nofollow" target="_blank"> github </a>获取二进制文件来安装。</p><p id="4cfc" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">对于Linux/WSL2，运行:</p><pre class="kz la lb lc gt mr kx ms mt aw mu bi"><span id="d159" class="mv lp iq kx b gy mw mx l my mz">wget <a class="ae kl" href="https://github.com/splunk/qbec/releases/download/v0.12.1/qbec-linux-amd64.tar.gz" rel="noopener ugc nofollow" target="_blank">https://github.com/splunk/qbec/releases/download/v0.12.1/qbec-linux-amd64.tar.gz</a> # Change version to the latest released version<br/>tar xf <a class="ae kl" href="https://github.com/splunk/qbec/releases/download/v0.12.1/qbec-linux-amd64.tar.gz" rel="noopener ugc nofollow" target="_blank">qbec-linux-amd64.tar.gz</a><br/>sudo mv ./qbec /usr/local/bin/</span></pre><p id="f93f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果您使用自制软件，请运行以下命令</p><pre class="kz la lb lc gt mr kx ms mt aw mu bi"><span id="d810" class="mv lp iq kx b gy mw mx l my mz">brew tap splunk/tap<br/>brew install qbec</span></pre><p id="959f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">运行<code class="fe ku kv kw kx b">qbec version</code>以确保您的设置成功。</p></div><div class="ab cl km kn hu ko" role="separator"><span class="kp bw bk kq kr ks"/><span class="kp bw bk kq kr ks"/><span class="kp bw bk kq kr"/></div><div class="ij ik il im in"><h1 id="fb0a" class="lo lp iq bd lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml bi translated">初始化qbec应用程序</h1><p id="c6a2" class="pw-post-body-paragraph jn jo iq jp b jq mm js jt ju mn jw jx jy mo ka kb kc mp ke kf kg mq ki kj kk ij bi translated"><code class="fe ku kv kw kx b">qbec init</code>可用于初始化与qbec一起使用的应用。</p><p id="5dfd" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们将使用qbec设置一个示例应用程序，部署到运行在docker-desktop上的Kubernetes集群。也可以使用minikube、kind或任何其他Kubernetes集群。</p><figure class="kz la lb lc gt ld gh gi paragraph-image"><div role="button" tabindex="0" class="le lf di lg bf lh"><div class="gh gi na"><img src="../Images/bcd0a69068504df9ac06dbc3c62b9633.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*h31NTT6RYnag14kBtRqYfg.png"/></div></div><figcaption class="lk ll gj gh gi lm ln bd b be z dk translated">在Docker桌面上启用Kubernetes</figcaption></figure><p id="4be7" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">运行以下命令为部署设置应用程序。</p><pre class="kz la lb lc gt mr kx ms mt aw mu bi"><span id="89b8" class="mv lp iq kx b gy mw mx l my mz">qbec init --with-example my-app<br/>cd my-app</span></pre><p id="eabe" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><code class="fe ku kv kw kx b">my-app</code>文件夹包含部署应用程序所需的所有文件。</p><pre class="kz la lb lc gt mr kx ms mt aw mu bi"><span id="7d61" class="mv lp iq kx b gy mw mx l my mz">hsm@home67:~/my-app$ tree<br/>.<br/>├── components<br/>│   └── hello.jsonnet<br/>├── environments<br/>│   ├── base.libsonnet<br/>│   └── default.libsonnet<br/>├── params.libsonnet<br/>└── qbec.yaml</span></pre><p id="fcb0" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><code class="fe ku kv kw kx b">qbec.yaml</code>包含qbec的配置。qbec读取这个文件来了解不同的环境以及如何与相应的Kubernetes集群对话。</p><figure class="kz la lb lc gt ld"><div class="bz fp l di"><div class="nb nc l"/></div><figcaption class="lk ll gj gh gi lm ln bd b be z dk translated">默认环境具有连接到Kubernetes API服务器的值，并且为部署指定了名称空间。这里可以添加多个环境。</figcaption></figure><p id="6c4c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><code class="fe ku kv kw kx b">params.libsonnet</code>包含环境名到<code class="fe ku kv kw kx b">environments/&lt;env-name&gt;.libsonnet</code>下相应文件的映射。</p><figure class="kz la lb lc gt ld"><div class="bz fp l di"><div class="nb nc l"/></div><figcaption class="lk ll gj gh gi lm ln bd b be z dk translated">默认环境映射到environments/default.libsonnet中的配置</figcaption></figure><p id="44bb" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">每个环境的共享配置在<code class="fe ku kv kw kx b">environments/base.libsonnet</code>中设置，环境特定的覆盖可在相应的环境文件中设置。在上面的例子中，<code class="fe ku kv kw kx b">default.libsonnet</code>文件覆盖了<code class="fe ku kv kw kx b">default</code>环境的配置。</p><figure class="kz la lb lc gt ld"><div class="bz fp l di"><div class="nb nc l"/></div><figcaption class="lk ll gj gh gi lm ln bd b be z dk translated">默认部署的索引数据和副本数被覆盖</figcaption></figure><p id="76ed" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><code class="fe ku kv kw kx b">components</code>文件夹包含我们想要部署的所有组件。<code class="fe ku kv kw kx b">components/hello.jsonnet</code>组件包含用于部署和配置映射的Kubernetes对象定义。</p><figure class="kz la lb lc gt ld"><div class="bz fp l di"><div class="nb nc l"/></div></figure><p id="f0d2" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">接下来，我们将使用qbec部署到<code class="fe ku kv kw kx b">default</code>环境中。</p></div><div class="ab cl km kn hu ko" role="separator"><span class="kp bw bk kq kr ks"/><span class="kp bw bk kq kr ks"/><span class="kp bw bk kq kr"/></div><div class="ij ik il im in"><h1 id="b294" class="lo lp iq bd lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml bi translated">使用qbec部署</h1><p id="8425" class="pw-post-body-paragraph jn jo iq jp b jq mm js jt ju mn jw jx jy mo ka kb kc mp ke kf kg mq ki kj kk ij bi translated">使用qbec的部署非常简单，只需使用<code class="fe ku kv kw kx b">qbec apply </code>命令。</p><p id="700e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">运行<code class="fe ku kv kw kx b">qbec apply &lt;env-name&gt;</code>将应用程序部署到<code class="fe ku kv kw kx b">&lt;env-name&gt;</code>指定的环境中。</p><pre class="kz la lb lc gt mr kx ms mt aw mu bi"><span id="0286" class="mv lp iq kx b gy mw mx l my mz">hsm@home67:~/my-app$ qbec apply default # env-name is default<br/>setting cluster to docker-desktop<br/>setting context to docker-for-desktop<br/>setting context to docker-desktop<br/>cluster metadata load took 32ms<br/>1 components evaluated in 5ms</span><span id="1e2e" class="mv lp iq kx b gy nd mx l my mz">will synchronize 2 object(s)</span><span id="9bad" class="mv lp iq kx b gy nd mx l my mz">Do you want to continue [y/n]: y<br/>1 components evaluated in 2ms<br/>create configmaps demo-config -n default (source hello)<br/>create deployments demo-deploy -n default (source hello)<br/>waiting for deletion list to be returned<br/>server objects load took 612ms<br/>---<br/>stats:<br/>  created:<br/>  - configmaps demo-config -n default (source hello)<br/>  - deployments demo-deploy -n default (source hello)</span></pre><p id="da91" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">就是这样！使用<code class="fe ku kv kw kx b">kubectl</code>验证部署</p><pre class="kz la lb lc gt mr kx ms mt aw mu bi"><span id="6023" class="mv lp iq kx b gy mw mx l my mz">hsm@home67:~/my-app$ kubectl get pods<br/>NAME                          READY   STATUS    RESTARTS   AGE<br/>demo-deploy-78fd78c96-cs8lw   1/1     Running   0          58s<br/>demo-deploy-78fd78c96-n4phl   1/1     Running   0          58s</span></pre><p id="f28b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们将在后续的文章中探索更多的qbec特性。默认情况下，qbec启用了垃圾收集，并支持模拟运行。<code class="fe ku kv kw kx b">qbec diff</code>可以准确显示哪些对象会改变以及如何改变。<code class="fe ku kv kw kx b">qbec validate</code>可以对jsonnet文件中定义的kubernetes对象进行模式验证。还有更多！</p><p id="d365" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">敬请期待！</p><p id="8f74" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">同时，你可以试试qbec，在<a class="ae kl" href="https://qbec.io" rel="noopener ugc nofollow" target="_blank"> https://qbec.io </a>了解更多。</p></div></div>    
</body>
</html>