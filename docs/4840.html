<html>
<head>
<title>Kubernetes: Evicted pods and Pods Quality of Service</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Kubernetes:被驱逐的pod和pod服务质量</h1>
<blockquote>原文：<a href="https://itnext.io/kubernetes-evicted-pods-and-pods-quality-of-service-4892b45aa4c0?source=collection_archive---------4-----------------------#2020-10-03">https://itnext.io/kubernetes-evicted-pods-and-pods-quality-of-service-4892b45aa4c0?source=collection_archive---------4-----------------------#2020-10-03</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div class="gh gi jn"><img src="../Images/a1518877bcb60149e13f550b20c577b7.png" data-original-src="https://miro.medium.com/v2/resize:fit:260/format:webp/0*J5GSz5esPbOtRqaX.png"/></div></figure><p id="8a1d" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">我们有一个运行在AWS弹性Kubernetes服务上的Kubernetes集群。</p><p id="20ec" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">在此群集中，我们有一个通常运行良好的应用程序，但有时我们的监控系统会通知不健康的pod:</p><figure class="kt ku kv kw gt jr gh gi paragraph-image"><div class="gh gi ks"><img src="../Images/a675e6e645ca488f519757f5ca92dc0d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1390/format:webp/0*AlrlA5WFUNYHhs6v.png"/></div></figure><p id="b635" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">检查舱:</p><pre class="kt ku kv kw gt kx ky kz la aw lb bi"><span id="1986" class="lc ld iq ky b gy le lf l lg lh">$ kk -n eks-prod-1-web-projectname-admin-backend-ns get pod<br/>NAME READY STATUS RESTARTS AGE<br/>bttrm-web-projectname-admin-backend-64648597fc-9j29n 1/1 Running 0 43m<br/>bttrm-web-projectname-admin-backend-64648597fc-kptjj 1/1 Running 0 43m<br/>bttrm-web-projectname-admin-backend-7f4b5bdb4c-wlbjf 0/1 Evicted 0 12d<br/>bttrm-web-projectname-admin-backend-8478d778f9–5mrnc 0/1 Evicted 0 15d</span></pre><p id="f865" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">在这里，我们可以看到两个pod处于<strong class="jw ir">被逐出</strong>状态—让我们来看看发生了什么。</p><h1 id="37e9" class="li ld iq bd lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me bi translated">Kubernetes <code class="fe mf mg mh ky b">requests</code>和<code class="fe mf mg mh ky b">limits</code></h1><p id="ac11" class="pw-post-body-paragraph ju jv iq jw b jx mi jz ka kb mj kd ke kf mk kh ki kj ml kl km kn mm kp kq kr ij bi translated">因此，在Kubernetes中，我们可以用两种方式限制应用程序使用的资源——用<code class="fe mf mg mh ky b">requests</code>和<code class="fe mf mg mh ky b">limits</code>:</p><pre class="kt ku kv kw gt kx ky kz la aw lb bi"><span id="b30b" class="lc ld iq ky b gy le lf l lg lh">resources:<br/>  requests:<br/>    cpu: 100m<br/>    memory: 100Mi<br/>  limits:<br/>    cpu: 100m<br/>    memory: 100Mi</span></pre><p id="f0fd" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">这里:</p><ul class=""><li id="de7a" class="mn mo iq jw b jx jy kb kc kf mp kj mq kn mr kr ms mt mu mv bi translated"><code class="fe mf mg mh ky b">requests</code>:由<a class="ae mw" href="https://kubernetes.io/docs/concepts/scheduling-eviction/kube-scheduler/" rel="noopener ugc nofollow" target="_blank"> Kubernetes调度器</a>使用，根据请求的值选择放置pod的工作节点——节点必须有足够的空闲资源在其上运行这个pod</li><li id="025b" class="mn mo iq jw b jx mx kb my kf mz kj na kn nb kr ms mt mu mv bi translated"><code class="fe mf mg mh ky b">limits</code>:这样一个“硬限制”——一个pod可以使用的资源的最大值</li></ul><h1 id="e6e3" class="li ld iq bd lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me bi translated">Kubernetes pods QoS类别</h1><p id="5bbf" class="pw-post-body-paragraph ju jv iq jw b jx mi jz ka kb mj kd ke kf mk kh ki kj ml kl km kn mm kp kq kr ij bi translated">文档— <a class="ae mw" href="https://kubernetes.io/docs/tasks/configure-pod-container/quality-service-pod/" rel="noopener ugc nofollow" target="_blank">为pod配置服务质量</a>。</p><p id="fe20" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">Kubernetes中的pod可以属于三种服务质量(QoS)级别之一:</p><ul class=""><li id="70a0" class="mn mo iq jw b jx jy kb kc kf mp kj mq kn mr kr ms mt mu mv bi translated"><em class="nc">保证</em>:pod，有请求和限制，它们对pod中的所有容器都是相同的</li><li id="f28e" class="mn mo iq jw b jx mx kb my kf mz kj na kn nb kr ms mt mu mv bi translated"><em class="nc">可突发</em>:至少为一个容器设置了至少或个CPU或内存请求的非保证pod</li><li id="c4bf" class="mn mo iq jw b jx mx kb my kf mz kj na kn nb kr ms mt mu mv bi translated">最大努力:没有任何要求和限制的豆荚</li></ul><p id="c3a9" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">您可以使用<code class="fe mf mg mh ky b">describe pod -o wide</code>检查您的pod的QoS等级:</p><pre class="kt ku kv kw gt kx ky kz la aw lb bi"><span id="ce18" class="lc ld iq ky b gy le lf l lg lh">$ kubectl get pod appname-54545944b4-h8gmv -o yaml<br/>…<br/>resources:<br/>requests:<br/>cpu: 100m<br/>…<br/>qosClass: Burstable<br/>…</span></pre><p id="ee39" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">在这里，我们有仅用于CPU的<code class="fe mf mg mh ky b">requests</code>，因此这样的pod将属于可突发QoS类别。</p><p id="1e47" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">现在，让我们来看看QoS等级如何影响pod的寿命。</p><h1 id="26fb" class="li ld iq bd lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me bi translated">节点容差</h1><p id="ed5c" class="pw-post-body-paragraph ju jv iq jw b jx mi jz ka kb mj kd ke kf mk kh ki kj ml kl km kn mm kp kq kr ij bi translated">当集群中的Kubernetes WorkerNode开始缺少可用资源(内存、磁盘、CPU等)时，集群的调度程序首先会停止在这样的节点上添加新的pods。</p><p id="7cda" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">此外，Kubernetes还为这样的节点添加了描述其状态的特殊注释，例如— <code class="fe mf mg mh ky b">node.kubernetes.io/memory-pressure</code>。</p><p id="c8ff" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">点击此处查看完整列表— <a class="ae mw" href="https://kubernetes.io/docs/concepts/scheduling-eviction/taint-and-toleration/#taint-based-evictions" rel="noopener ugc nofollow" target="_blank">基于污点的驱逐</a>。</p><p id="044a" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">在这种情况下，这样一个节点上的<code class="fe mf mg mh ky b">kubelet</code>将开始杀死正在运行的容器，它们的pod将处于<strong class="jw ir"> <em class="nc">失败</em> </strong>状态。</p><p id="bb5e" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">例如，如果一个节点的硬盘耗尽，那么<code class="fe mf mg mh ky b">kubelet</code>将开始删除未使用的窗格及其容器，然后将删除所有未使用的图像。</p><p id="6ac6" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">如果这还不够，那么它将按照以下顺序开始杀死(实际上是— <strong class="jw ir"> <em class="nc">驱逐</em> </strong>)用户单元:</p><ul class=""><li id="24f9" class="mn mo iq jw b jx jy kb kc kf mp kj mq kn mr kr ms mt mu mv bi translated"><em class="nc">尽力而为</em> —没有任何要求和限制的pod</li><li id="4099" class="mn mo iq jw b jx mx kb my kf mz kj na kn nb kr ms mt mu mv bi translated"><em class="nc">可爆发的</em>—pod，使用在其请求中设置的更多资源</li><li id="20c8" class="mn mo iq jw b jx mx kb my kf mz kj na kn nb kr ms mt mu mv bi translated"><em class="nc">可突发的</em> — pods使用的资源比其请求中设置的要少</li></ul><p id="d2b0" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">一般来说，有保证的pod绝不能受到任何影响，但是在节点没有更多要移除并且它仍然需要资源的情况下——<code class="fe mf mg mh ky b">kubelet</code>也将开始移除这样的pod，即使它们在有保证的QoS类别下。</p><p id="1c6b" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">要找到一个pod被驱逐的真正原因，您可以检查它的事件。</p><p id="3cf1" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">现在回到我们的豆荚:</p><pre class="kt ku kv kw gt kx ky kz la aw lb bi"><span id="18c0" class="lc ld iq ky b gy le lf l lg lh">$ kk -n eks-prod-1-web-projectname-admin-backend-ns get pod<br/>NAME READY STATUS RESTARTS AGE<br/>…<br/>bttrm-web-projectname-admin-backend-7f4b5bdb4c-wlbjf 0/1 Evicted 0 14d<br/>bttrm-web-projectname-admin-backend-8478d778f9–5mrnc 0/1 Evicted 0 17d</span></pre><p id="5725" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">和他们的活动:</p><pre class="kt ku kv kw gt kx ky kz la aw lb bi"><span id="9caf" class="lc ld iq ky b gy le lf l lg lh">$ kk -n eks-prod-1-web-projectname-admin-backend-ns get pod bttrm-web-projectname-admin-backend-7f4b5bdb4c-wlbjf -o yaml<br/>…<br/>status:<br/>message: ‘The node was low on resource: memory. Container bttrm-web-projectname-admin-backend was using 1014836Ki, which exceeds its request of 300Mi. ‘<br/>phase: Failed<br/>reason: Evicted</span></pre><p id="9af7" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">这里Kubernetes告诉我们“<strong class="jw ir"> <em class="nc">容器使用了1014836Ki，这超过了它要求的300Mi </em> </strong>”。</p><p id="9bba" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">这里<em class="nc"> Ki </em> == kibibyte (1024字节，8192位)，а <em class="nc"> Mi </em> — mebibyte，т.е。1024千比字节，или 1048576字节。</p><p id="3fbc" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">让我们将1014836Ki转换为兆字节:</p><pre class="kt ku kv kw gt kx ky kz la aw lb bi"><span id="1964" class="lc ld iq ky b gy le lf l lg lh">$ echo 1014836/1024 | bc<br/>991</span></pre><p id="71ed" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">几乎千兆字节的节点内存。</p><p id="dcc4" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">让我们再次检查在此pod的部署中指定的资源:</p><pre class="kt ku kv kw gt kx ky kz la aw lb bi"><span id="1ab1" class="lc ld iq ky b gy le lf l lg lh">$ kk -n eks-prod-1-web-projectname-admin-backend-ns get deploy bttrm-web-projectname-admin-backend -o yaml<br/>…<br/>resources:<br/>  limits:<br/>    memory: 3Gi<br/>  requests:<br/>    cpu: 100<br/>    memory: 300Mi<br/>…</span></pre><p id="879e" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">因此，这里我们有ni个CPU限制，并且对CPU和内存的限制和请求不相等，那么它有QoS突发类。此外，这个节点没有运行其他吊舱，所以Kubernetes杀死了那个。</p><p id="9618" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">Grafana的图表可以向我们展示全貌—检查pod的状态历史(参见<a class="ae mw" href="https://rtfm.co.ua/en/kubernetes-a-clusters-monitoring-with-the-prometheus-operator/" rel="noopener ugc nofollow" target="_blank">Kubernetes:Prometheus操作员的集群监控</a>帖子):</p><figure class="kt ku kv kw gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="ne nf di ng bf nh"><div class="gh gi nd"><img src="../Images/b7e9e52f3aaa91273357253e8b3eabb9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*w9U9556chYPYWpYI.png"/></div></div></figure><p id="e0ca" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">于是pod在<em class="nc">运行</em>状态下在10.4.44.215 WorkerNode上工作，但是后来在19:40的时候被杀了。</p><p id="01d8" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">这次让我们检查一下WorkerNode 10.4.44.215:</p><figure class="kt ku kv kw gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="ne nf di ng bf nh"><div class="gh gi ni"><img src="../Images/dc48472ba5bf7719969eb6de6b6e06c8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*tvWVIYVhZZgi2bqD.png"/></div></div></figure><p id="b620" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">节点内存耗尽(AWS EC2 t3.medium，4GB RAM)并且<code class="fe mf mg mh ky b">kubelet</code>开始移除pod。</p><p id="83a2" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">让我们看看pod使用的资源:</p><figure class="kt ku kv kw gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="ne nf di ng bf nh"><div class="gh gi nj"><img src="../Images/312a4170eb3cf49b7014ea3f90d6b522.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*E2BB3LfrbN9jNcQ5.png"/></div></div></figure><p id="dc6a" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">实际上，我们可以看到pod收到了一些传入流量，并开始消耗大量内存。</p><p id="d895" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">节点上的记忆结束，<code class="fe mf mg mh ky b">kubelet</code>杀死了那个pod。</p><p id="0751" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">下面的问题是给开发人员的——或者这是意料之中的，我需要将应用程序移动到有更多可用内存的节点，或者他们在应用程序中有一些内存泄漏——开发人员必须修复它。</p><h1 id="4692" class="li ld iq bd lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me bi translated">有用的链接</h1><ul class=""><li id="aeba" class="mn mo iq jw b jx mi kb mj kf nk kj nl kn nm kr ms mt mu mv bi translated"><a class="ae mw" href="https://kubernetes.io/docs/concepts/policy/resource-quotas/" rel="noopener ugc nofollow" target="_blank">资源配额</a></li><li id="a33e" class="mn mo iq jw b jx mx kb my kf mz kj na kn nb kr ms mt mu mv bi translated"><a class="ae mw" href="https://kubernetes.io/docs/tasks/configure-pod-container/quality-service-pod/" rel="noopener ugc nofollow" target="_blank">配置pod的服务质量</a></li><li id="f5f8" class="mn mo iq jw b jx mx kb my kf mz kj na kn nb kr ms mt mu mv bi translated"><a class="ae mw" href="https://kubernetes.io/docs/tasks/configure-pod-container/assign-memory-resource/" rel="noopener ugc nofollow" target="_blank">给容器和pod分配内存资源</a></li><li id="38c7" class="mn mo iq jw b jx mx kb my kf mz kj na kn nb kr ms mt mu mv bi translated"><a class="ae mw" href="https://medium.com/@betz.mark/understanding-resource-limits-in-kubernetes-memory-6b41e9a955f9" rel="noopener">了解kubernetes中的资源限制:内存</a></li></ul></div><div class="ab cl nn no hu np" role="separator"><span class="nq bw bk nr ns nt"/><span class="nq bw bk nr ns nt"/><span class="nq bw bk nr ns"/></div><div class="ij ik il im in"><p id="658e" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated"><em class="nc">最初发布于</em> <a class="ae mw" href="https://rtfm.co.ua/en/kubernetes-evicted-pods-and-pods-quality-of-service/" rel="noopener ugc nofollow" target="_blank"> <em class="nc"> RTFM: Linux，devo PSисистемноеадминитиовваниованиее</em>T11<em class="nc">。</em></a></p></div></div>    
</body>
</html>