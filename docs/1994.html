<html>
<head>
<title>Kubernetes-based Microservice Observability with Istio Service Mesh: Part 1</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">基于Kubernetes的Istio服务网格的微服务可观测性:第1部分</h1>
<blockquote>原文：<a href="https://itnext.io/kubernetes-based-microservice-observability-with-istio-service-mesh-part-1-bed3dd0fac0b?source=collection_archive---------0-----------------------#2019-03-11">https://itnext.io/kubernetes-based-microservice-observability-with-istio-service-mesh-part-1-bed3dd0fac0b?source=collection_archive---------0-----------------------#2019-03-11</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="6655" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">使用Jaeger、Prometheus、Grafana和Kiali在Google Cloud的GKE和Istio服务网格上观察分布式系统</h2></div><p id="f4e6" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">在这篇由两部分组成的文章中，我们将探索Istio服务网络中的一组可观察性工具。这些工具包括耶格、基阿利、普罗米修斯和格拉夫纳。为了协助我们的探索，我们将在Google云平台上为Google Kubernetes引擎部署一个基于Go的微服务参考平台。</p><figure class="lg lh li lj gt lk gh gi paragraph-image"><div role="button" tabindex="0" class="ll lm di ln bf lo"><div class="gh gi lf"><img src="../Images/1f56c4e3637481e3951b87635d4dfcbf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*yp2_sLoiC_gWHICPzMKL8A.png"/></div></div></figure><h1 id="318a" class="lr ls it bd lt lu lv lw lx ly lz ma mb jz mc ka md kc me kd mf kf mg kg mh mi bi translated">什么是可观测性？</h1><p id="2247" class="pw-post-body-paragraph ki kj it kk b kl mj ju kn ko mk jx kq kr ml kt ku kv mm kx ky kz mn lb lc ld im bi translated">与区块链、无服务器、人工智能和人工智能、聊天机器人、网络安全和服务网格类似，可观察性是目前IT行业的热门词汇。根据维基百科，可观察性是一种衡量系统内部状态从其外部输出的知识中推断出来的程度。日志、度量和跟踪通常被称为可观察性的三大支柱。这些是我们可以观察到的系统的外部输出。</p><p id="8e44" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">辛迪·斯里德哈兰所著的《T2分布式系统可观测性》一书在第四章(T5)中很好地详述了“可观测性的三大支柱”。在继续之前，我推荐阅读这个免费的在线摘录。关于可观察性的第二个重要信息来源是<a class="ae le" href="https://www.honeycomb.io/" rel="noopener ugc nofollow" target="_blank"> honeycomb.io </a>，这是一个生产系统可观察性工具的开发者，由著名的行业思想领袖<a class="ae le" href="https://twitter.com/mipsytipsy" rel="noopener ugc nofollow" target="_blank"> Charity Majors </a>领导。honeycomb.io网站包括关于可观测性的文章、博客文章、白皮书和播客。</p><p id="b99b" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">随着现代分布式系统变得越来越复杂，观察这些系统的能力需要同样现代的工具，这些工具是在考虑到这种复杂程度的情况下设计的。传统的日志记录和监控系统往往难以应对当今的混合和多云、基于多语言、事件驱动、基于容器和无服务器、可无限扩展的短暂计算平台。</p><p id="6307" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">像<a class="ae le" href="https://istio.io/" rel="noopener ugc nofollow" target="_blank"> Istio Service Mesh </a>这样的工具试图通过提供与几个同类最佳的开源遥测工具的本机集成来解决可观测性挑战。Istio的集成包括用于分布式跟踪的<a class="ae le" href="https://www.jaegertracing.io/" rel="noopener ugc nofollow" target="_blank"> Jaeger </a>，用于分布式系统可视化的<a class="ae le" href="https://www.kiali.io/" rel="noopener ugc nofollow" target="_blank"> Kiali </a>，以及用于指标收集、监控和警报的<a class="ae le" href="https://prometheus.io/" rel="noopener ugc nofollow" target="_blank"> Prometheus </a>和<a class="ae le" href="https://grafana.com/" rel="noopener ugc nofollow" target="_blank"> Grafana </a>。结合云平台-原生监控和日志记录服务，如谷歌云平台(GCP)上的<a class="ae le" href="https://cloud.google.com/monitoring/" rel="noopener ugc nofollow" target="_blank">stack driver</a>for<a class="ae le" href="https://cloud.google.com/kubernetes-engine/" rel="noopener ugc nofollow" target="_blank">Google Kubernetes Engine</a>(GKE)，我们拥有一个完整的现代分布式应用的可观测性平台。</p><h1 id="e0dc" class="lr ls it bd lt lu lv lw lx ly lz ma mb jz mc ka md kc me kd mf kf mg kg mh mi bi translated">参考微服务平台</h1><p id="cd75" class="pw-post-body-paragraph ki kj it kk b kl mj ju kn ko mk jx kq kr ml kt ku kv mm kx ky kz mn lb lc ld im bi translated">为了展示与最新版本的Istio Service Mesh集成的可观察性工具，我们将在GCP的GKE部署一个用Go编写的参考微服务平台。我开发了参考平台来演示API管理、服务网格、可观察性、DevOps和<a class="ae le" href="https://principlesofchaos.org/" rel="noopener ugc nofollow" target="_blank">混沌工程</a>等概念。该平台由(14)个组件组成，包括(8) <a class="ae le" href="https://golang.org/" rel="noopener ugc nofollow" target="_blank">基于Go的</a>微服务，一般标记为服务A —服务H，(1)角度7，<a class="ae le" href="https://en.wikipedia.org/wiki/TypeScript" rel="noopener ugc nofollow" target="_blank">基于类型脚本的</a>前端，(4) MongoDB数据库，以及(1)用于基于事件队列的通信的RabbitMQ队列。该平台及其所有源代码都是免费和开源的。</p><p id="ceb9" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">参考平台旨在生成基于HTTP的服务到服务、基于TCP的服务到数据库(MongoDB)和基于TCP的服务到队列到服务(RabbitMQ) IPC(进程间通信)。服务A调用服务B和服务C，服务B调用服务D和服务E，服务D在RabbitMQ队列上产生一条消息，由服务F消费并写入MongoDB，以此类推。当系统被部署到运行Istio服务网格的Kubernetes集群时，可以使用Istio的可观察性工具来观察这些分布式通信。</p><h2 id="2a65" class="mo ls it bd lt mp mq dn lx mr ms dp mb kr mt mu md kv mv mw mf kz mx my mh mz bi translated">服务响应</h2><p id="8588" class="pw-post-body-paragraph ki kj it kk b kl mj ju kn ko mk jx kq kr ml kt ku kv mm kx ky kz mn lb lc ld im bi translated">在参考平台上，每个上游服务通过返回一个小的信息性JSON负载(在源代码中称为<em class="na">问候</em>)来响应来自下游服务的请求。</p><figure class="lg lh li lj gt lk gh gi paragraph-image"><div role="button" tabindex="0" class="ll lm di ln bf lo"><div class="gh gi lf"><img src="../Images/98d795290d27f625eccecea038b33eb8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*LmfoTz9lO47X8yplGMj2ug.png"/></div></div></figure><p id="d53b" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">响应在服务调用链中聚合，导致一系列服务响应返回到边缘服务，并到达基于角度的UI，在最终用户的web浏览器中运行。响应聚合功能仅用于确认服务对服务通信、Istio组件和遥测工具是否正常工作。</p><figure class="lg lh li lj gt lk gh gi paragraph-image"><div role="button" tabindex="0" class="ll lm di ln bf lo"><div class="gh gi nb"><img src="../Images/93765905cb936f4253efe73505d53641.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*9zR9c2xX7wgnLTsY2XY8JA.png"/></div></div></figure><p id="0b5a" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">每个Go微服务包含一个<code class="fe nc nd ne nf b">/ping</code>和<code class="fe nc nd ne nf b">/health</code>端点。<code class="fe nc nd ne nf b">/health</code>端点可用于配置Kubernetes活跃度和就绪性探测器。此外，边缘服务，服务A，使用<code class="fe nc nd ne nf b">access-control-allow-origin: *</code>响应头被配置用于<a class="ae le" href="https://developer.mozilla.org/en-US/docs/Web/HTTP/CORS" rel="noopener ugc nofollow" target="_blank">跨来源资源共享</a> (CORS)。CORS允许运行在最终用户的web浏览器中的Angular UI将服务称为一个<code class="fe nc nd ne nf b">/ping</code>端点，它驻留在与UI不同的子域中。下面显示的是<a class="ae le" href="https://github.com/garystafford/golang-srv-demo/blob/master/service-a/main.go" rel="noopener ugc nofollow" target="_blank">服务A </a>的Go源代码。</p><figure class="lg lh li lj gt lk"><div class="bz fp l di"><div class="ng nh l"/></div></figure><p id="62fd" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">对于这个演示，MongoDB数据库将在GCP的服务之外托管在<a class="ae le" href="https://www.mongodb.com/cloud/atlas" rel="noopener ugc nofollow" target="_blank"> MongoDB Atlas </a>上，这是一个基于云的MongoDB即服务平台。类似地，RabbitMQ队列将托管在<a class="ae le" href="https://www.cloudamqp.com/" rel="noopener ugc nofollow" target="_blank"> CloudAMQP </a>上，这是一个RabbitMQ即服务的基于云的平台。我在以前的几篇文章中使用过这两个SaaS提供者。使用外部服务将有助于我们理解Istio及其可观测性工具如何收集遥测数据，以便在Kubernetes集群和外部系统之间进行通信。</p><p id="3620" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">下面显示的是<a class="ae le" href="https://github.com/garystafford/golang-srv-demo/blob/master/service-f/main.go" rel="noopener ugc nofollow" target="_blank">服务F </a>的Go源代码，该服务使用来自RabbitMQ队列的消息，由<a class="ae le" href="https://github.com/garystafford/golang-srv-demo/blob/master/service-D/main.go" rel="noopener ugc nofollow" target="_blank">服务D </a>放置在那里，并将消息写入MongoDB。</p><figure class="lg lh li lj gt lk"><div class="bz fp l di"><div class="ng nh l"/></div></figure><h1 id="baa3" class="lr ls it bd lt lu lv lw lx ly lz ma mb jz mc ka md kc me kd mf kf mg kg mh mi bi translated">源代码</h1><p id="6b43" class="pw-post-body-paragraph ki kj it kk b kl mj ju kn ko mk jx kq kr ml kt ku kv mm kx ky kz mn lb lc ld im bi translated">这篇文章的所有源代码都可以在GitHub的两个项目中找到。基于Go的微服务源代码、所有Kubernetes资源和所有部署脚本都位于<a class="ae le" href="https://github.com/garystafford/k8s-istio-observe-backend" rel="noopener ugc nofollow" target="_blank">k8s-istio-observe-back end</a>项目存储库中。基于Angular UI <a class="ae le" href="https://en.wikipedia.org/wiki/TypeScript" rel="noopener ugc nofollow" target="_blank">类型脚本的</a>源代码位于<a class="ae le" href="https://github.com/garystafford/k8s-istio-observe-frontend" rel="noopener ugc nofollow" target="_blank">k8s-istio-observe-frontend</a>项目库中。对于这个演示，您应该不需要克隆Angular UI项目。</p><pre class="lg lh li lj gt ni nf nj nk aw nl bi"><span id="15e2" class="mo ls it nf b gy nm nn l no np">git clone --branch master --single-branch --depth 1 --no-tags \<br/>https://github.com/garystafford/k8s-istio-observe-backend.git</span></pre><p id="7ea7" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">用于Go服务和UI的Kubernetes <code class="fe nc nd ne nf b">Deployment</code>资源文件中引用的Docker图像都可以在<a class="ae le" href="https://hub.docker.com/u/garystafford/" rel="noopener ugc nofollow" target="_blank"> Docker Hub </a>上获得。Go微服务Docker映像是使用DockerHub上的官方<a class="ae le" href="https://hub.docker.com/_/golang" rel="noopener ugc nofollow" target="_blank"> Golang Alpine </a>基础映像构建的，包含Go版本1.12.0。使用Alpine映像来编译Go源代码可以确保容器尽可能小，并包含最小的攻击面。</p><h1 id="3d91" class="lr ls it bd lt lu lv lw lx ly lz ma mb jz mc ka md kc me kd mf kf mg kg mh mi bi translated">系统需求</h1><p id="9aeb" class="pw-post-body-paragraph ki kj it kk b kl mj ju kn ko mk jx kq kr ml kt ku kv mm kx ky kz mn lb lc ld im bi translated">要跟进这篇文章，您需要最新版本的<code class="fe nc nd ne nf b">gcloud</code> CLI(最低。版本。239.0.0)、Google Cloud SDK的一部分、<a class="ae le" href="https://helm.sh/" rel="noopener ugc nofollow" target="_blank"> Helm </a>和just releases<a class="ae le" href="https://github.com/istio/istio/releases/tag/1.1.3" rel="noopener ugc nofollow" target="_blank">Istio 1 . 1 . 3</a>(2019年4月15日)安装并配置在本地或您的构建机器上。</p><figure class="lg lh li lj gt lk gh gi paragraph-image"><div role="button" tabindex="0" class="ll lm di ln bf lo"><div class="gh gi nq"><img src="../Images/10b4f673e2708eb8759bbfdf19fb13a5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*e3oUDTcQbS40dccSuxE0sg.png"/></div></div></figure><h1 id="25b5" class="lr ls it bd lt lu lv lw lx ly lz ma mb jz mc ka md kc me kd mf kf mg kg mh mi bi translated">设置和安装</h1><p id="3240" class="pw-post-body-paragraph ki kj it kk b kl mj ju kn ko mk jx kq kr ml kt ku kv mm kx ky kz mn lb lc ld im bi translated">要将微服务平台部署到GKE，我们将按以下顺序进行。</p><ol class=""><li id="5890" class="nr ns it kk b kl km ko kp kr nt kv nu kz nv ld nw nx ny nz bi translated">创建MongoDB Atlas数据库集群；</li><li id="44a9" class="nr ns it kk b kl oa ko ob kr oc kv od kz oe ld nw nx ny nz bi translated">创建CloudAMQP RabbitMQ集群；</li><li id="17e6" class="nr ns it kk b kl oa ko ob kr oc kv od kz oe ld nw nx ny nz bi translated">为您自己的环境修改Kubernetes资源和脚本；</li><li id="39c1" class="nr ns it kk b kl oa ko ob kr oc kv od kz oe ld nw nx ny nz bi translated">在GCP创建GKE集群；</li><li id="9cf1" class="nr ns it kk b kl oa ko ob kr oc kv od kz oe ld nw nx ny nz bi translated">使用Helm将Istio 1.1.3部署到GKE集群；</li><li id="78b1" class="nr ns it kk b kl oa ko ob kr oc kv od kz oe ld nw nx ny nz bi translated">为平台的公开资源创建DNS记录；</li><li id="15b5" class="nr ns it kk b kl oa ko ob kr oc kv od kz oe ld nw nx ny nz bi translated">将基于Go的微服务、Angular UI以及相关资源部署到GKE；</li><li id="d9b3" class="nr ns it kk b kl oa ko ob kr oc kv od kz oe ld nw nx ny nz bi translated">对平台进行测试和故障排除；</li><li id="7cca" class="nr ns it kk b kl oa ko ob kr oc kv od kz oe ld nw nx ny nz bi translated">观察第二部分的结果！</li></ol><h1 id="1173" class="lr ls it bd lt lu lv lw lx ly lz ma mb jz mc ka md kc me kd mf kf mg kg mh mi bi translated">MongoDB Atlas集群</h1><p id="7ff6" class="pw-post-body-paragraph ki kj it kk b kl mj ju kn ko mk jx kq kr ml kt ku kv mm kx ky kz mn lb lc ld im bi translated"><a class="ae le" href="https://www.mongodb.com/cloud/atlas" rel="noopener ugc nofollow" target="_blank"> MongoDB Atlas </a>是一个完全托管的MongoDB-as-a-Service，可以在AWS、Azure和GCP上使用。Atlas是一款成熟的SaaS产品，提供高可用性、有保证的正常运行时间SLA、弹性可伸缩性、跨区域复制、企业级安全性、LDAP集成、BI连接器等等。</p><p id="fdb9" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">MongoDB Atlas目前提供四种<a class="ae le" href="https://www.mongodb.com/cloud/atlas/pricing" rel="noopener ugc nofollow" target="_blank">定价方案</a>，免费、基本、专业和企业。计划范围从最小的M0大小的MongoDB集群，具有共享RAM和512 MB存储，到大规模的M400 MongoDB集群，具有488 GB的RAM和3 TB的存储。</p><p id="5b6b" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">在这篇文章中，我在GCP的美国中部(爱荷华州)创建了一个M2大小的MongoDB集群，这个演示使用了一个用户数据库帐户。该账户将用于连接GKE上运行的八个基于Go的微服务中的四个。</p><figure class="lg lh li lj gt lk gh gi paragraph-image"><div role="button" tabindex="0" class="ll lm di ln bf lo"><div class="gh gi of"><img src="../Images/fcaacf3d986452d4b54dc1df4f9fd327.png" data-original-src="https://miro.medium.com/v2/resize:fit:1240/0*a4sPUkiRyQsNLcGO"/></div></div></figure><p id="273b" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">最初，我从M0规模的集群开始，但是计算资源不足以支持来自基于Go的微服务的大量调用。我建议至少有一个M2大小或更大的集群。</p><h1 id="8d6f" class="lr ls it bd lt lu lv lw lx ly lz ma mb jz mc ka md kc me kd mf kf mg kg mh mi bi translated">CloudAMQP RabbitMQ集群</h1><p id="fb57" class="pw-post-body-paragraph ki kj it kk b kl mj ju kn ko mk jx kq kr ml kt ku kv mm kx ky kz mn lb lc ld im bi translated"><a class="ae le" href="https://www.cloudamqp.com/" rel="noopener ugc nofollow" target="_blank"> CloudAMQP </a>在所有主要的云和应用平台上提供完全托管的RabbitMQ集群。RabbitMQ将为我们基于Go的微服务的一部分支持一个解耦的、最终一致的、基于消息的架构。在本文中，我在GCP的美国中部(爱荷华州)地区创建了一个RabbitMQ集群，与我们的GKE集群和MongoDB Atlas集群相同。我选择了RabbitMQ的最小配置免费版本。CloudAMQP还提供健壮的多节点RabbitMQ集群供生产使用。</p><h1 id="9518" class="lr ls it bd lt lu lv lw lx ly lz ma mb jz mc ka md kc me kd mf kf mg kg mh mi bi translated">修改配置</h1><p id="0e87" class="pw-post-body-paragraph ki kj it kk b kl mj ju kn ko mk jx kq kr ml kt ku kv mm kx ky kz mn lb lc ld im bi translated">在GitHub项目的Kubernetes资源文件和Bash部署脚本中，您需要更改一些配置设置。</p><h2 id="9528" class="mo ls it bd lt mp mq dn lx mr ms dp mb kr mt mu md kv mv mw mf kz mx my mh mz bi translated">MongoDB Atlas的Istio ServiceEntry</h2><p id="b669" class="pw-post-body-paragraph ki kj it kk b kl mj ju kn ko mk jx kq kr ml kt ku kv mm kx ky kz mn lb lc ld im bi translated">修改Istio <code class="fe nc nd ne nf b">ServiceEntry</code>，<a class="ae le" href="https://github.com/garystafford/golang-srv-demo/blob/master/resources/other/external-mesh-mongodb-atlas.yaml" rel="noopener ugc nofollow" target="_blank">external-mesh-MongoDB-Atlas . YAML</a>文件，添加你的MongoDB Atlas主机地址。该文件允许流量从GKE上的四个微服务流出到外部MongoDB Atlas集群。</p><pre class="lg lh li lj gt ni nf nj nk aw nl bi"><span id="5cb5" class="mo ls it nf b gy nm nn l no np">apiVersion: networking.istio.io/v1alpha3<br/>kind: ServiceEntry<br/>metadata:<br/>  name: mongodb-atlas-external-mesh<br/>spec:<br/>  hosts:<br/><strong class="nf iu">  - {{ your_host_goes_here }}</strong><br/>  ports:<br/>  - name: mongo<br/>    number: 27017<br/>    protocol: MONGO<br/>  location: MESH_EXTERNAL<br/>  resolution: NONE</span></pre><h2 id="2ec1" class="mo ls it bd lt mp mq dn lx mr ms dp mb kr mt mu md kv mv mw mf kz mx my mh mz bi translated">istio service entry for cloud amqp rabbit MQ</h2><p id="a67d" class="pw-post-body-paragraph ki kj it kk b kl mj ju kn ko mk jx kq kr ml kt ku kv mm kx ky kz mn lb lc ld im bi translated">修改Istio <code class="fe nc nd ne nf b">ServiceEntry</code>，<a class="ae le" href="https://github.com/garystafford/golang-srv-demo/blob/master/resources/other/external-mesh-cloudamqp.yaml" rel="noopener ugc nofollow" target="_blank">external-mesh-cloudamqp . YAML</a>文件，添加您的CloudAMQP主机地址。该文件允许从两个微服务到CloudAMQP集群的出口流量。</p><pre class="lg lh li lj gt ni nf nj nk aw nl bi"><span id="e2cd" class="mo ls it nf b gy nm nn l no np">apiVersion: networking.istio.io/v1alpha3<br/>kind: ServiceEntry<br/>metadata:<br/>  name: cloudamqp-external-mesh<br/>spec:<br/>  hosts:<br/><strong class="nf iu">  - {{ your_host_goes_here }}</strong><br/>  ports:<br/>  - name: rabbitmq<br/>    number: 5672<br/>    protocol: TCP<br/>  location: MESH_EXTERNAL<br/>  resolution: NONE</span></pre><h2 id="7699" class="mo ls it bd lt mp mq dn lx mr ms dp mb kr mt mu md kv mv mw mf kz mx my mh mz bi translated">Istio网关和虚拟服务资源</h2><p id="e15b" class="pw-post-body-paragraph ki kj it kk b kl mj ju kn ko mk jx kq kr ml kt ku kv mm kx ky kz mn lb lc ld im bi translated">您可以使用多种策略通过Istio将流量路由到GKE集群。我对这篇文章使用了一个域名，<code class="fe nc nd ne nf b">example-api.com</code>，和四个子域名。一组子域用于Angular UI，在<code class="fe nc nd ne nf b">dev</code>名称空间(<code class="fe nc nd ne nf b">ui.dev.example-api.com</code>)和<code class="fe nc nd ne nf b">test</code>名称空间(<code class="fe nc nd ne nf b">ui.test.example-api.com</code>)中。另一组子域用于edge API微服务，服务A，UI调用(<code class="fe nc nd ne nf b">api.dev.example-api.com</code>和<code class="fe nc nd ne nf b">api.test.example-api.com</code>)。基于URL，流量被路由到特定的Kubernetes <code class="fe nc nd ne nf b">Service</code>资源。</p><p id="5be1" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">根据<a class="ae le" href="https://istio.io/docs/reference/config/istio.networking.v1alpha3/#Gateway" rel="noopener ugc nofollow" target="_blank"> Istio </a>的说法，<code class="fe nc nd ne nf b">Gateway</code>描述了一种在网格边缘运行的负载平衡器，接收传入或传出的HTTP/TCP连接。修改Istio入口<code class="fe nc nd ne nf b">Gateway</code>，在<code class="fe nc nd ne nf b">hosts</code>部分插入您自己的域或子域。这些是端口80上允许进入网状网络的主机。</p><pre class="lg lh li lj gt ni nf nj nk aw nl bi"><span id="c58b" class="mo ls it nf b gy nm nn l no np">apiVersion: networking.istio.io/v1alpha3<br/>kind: Gateway<br/>metadata:<br/>  name: demo-gateway<br/>spec:<br/>  selector:<br/>    istio: ingressgateway<br/>  servers:<br/>  - port:<br/>      number: 80<br/>      name: http<br/>      protocol: HTTP<br/>    hosts:<br/><strong class="nf iu">    - ui.dev.example-api.com</strong><br/><strong class="nf iu">    - ui.test.example-api.com</strong><br/><strong class="nf iu">    - api.dev.example-api.com</strong><br/><strong class="nf iu">    - api.test.example-api.com</strong></span></pre><p id="521d" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">根据<a class="ae le" href="https://istio.io/docs/reference/config/istio.networking.v1alpha3/#VirtualService" rel="noopener ugc nofollow" target="_blank"> Istio </a>，一个<code class="fe nc nd ne nf b">VirtualService</code>定义了当主机被寻址时要应用的一组流量路由规则。一个<code class="fe nc nd ne nf b">VirtualService</code>被绑定到一个<code class="fe nc nd ne nf b">Gateway</code>以控制到达特定主机和端口的流量的转发。修改项目的四个Istio <code class="fe nc nd ne nf b">VirtualServices</code>，插入你自己的域或子域。下面是四个<code class="fe nc nd ne nf b">VirtualServices</code>之一的例子，在<a class="ae le" href="https://github.com/garystafford/golang-srv-demo/blob/master/resources/other/istio-gateway.yaml" rel="noopener ugc nofollow" target="_blank"> istio-gateway.yaml </a>文件中。</p><pre class="lg lh li lj gt ni nf nj nk aw nl bi"><span id="03c6" class="mo ls it nf b gy nm nn l no np">apiVersion: networking.istio.io/v1alpha3<br/>kind: VirtualService<br/>metadata:<br/>  name: angular-ui-dev<br/>spec:<br/>  hosts:<br/><strong class="nf iu">  - ui.dev.example-api.com</strong><br/>  gateways:<br/>  - demo-gateway<br/>  http:<br/>  - match:<br/>    - uri:<br/>        prefix: /<br/>    route:<br/>    - destination:<br/>        port:<br/>          number: 80<br/>        host: angular-ui.dev.svc.cluster.local</span></pre><h2 id="5f0b" class="mo ls it bd lt mp mq dn lx mr ms dp mb kr mt mu md kv mv mw mf kz mx my mh mz bi translated">库伯内特的秘密</h2><p id="d432" class="pw-post-body-paragraph ki kj it kk b kl mj ju kn ko mk jx kq kr ml kt ku kv mm kx ky kz mn lb lc ld im bi translated">该项目包含一个Kubernetes <code class="fe nc nd ne nf b">Secret</code>，<a class="ae le" href="https://github.com/garystafford/golang-srv-demo/blob/master/resources/secrets/go-srv-demo.yaml" rel="noopener ugc nofollow" target="_blank"> go-srv-demo.yaml </a>，有两个值。一个用于MongoDB Atlas连接字符串，一个用于CloudAMQP连接字符串。记住Kubernetes <code class="fe nc nd ne nf b">Secret</code>值需要<code class="fe nc nd ne nf b">base64</code>编码。</p><pre class="lg lh li lj gt ni nf nj nk aw nl bi"><span id="d267" class="mo ls it nf b gy nm nn l no np">apiVersion: v1<br/>kind: Secret<br/>metadata:<br/>  name: go-srv-config<br/>type: Opaque<br/>data:<br/><strong class="nf iu">  mongodb.conn: {{ your_base64_encoded_secret }}</strong><br/><strong class="nf iu">  rabbitmq.conn: {{ your_base64_encoded_secret }}</strong></span></pre><p id="3c8a" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">在Linux和Mac上，您可以使用<code class="fe nc nd ne nf b">base64</code>程序对连接字符串进行编码。</p><pre class="lg lh li lj gt ni nf nj nk aw nl bi"><span id="6643" class="mo ls it nf b gy nm nn l no np">&gt; echo -n "mongodb+srv://username:password@atlas-cluster.gcp.mongodb.net/test?retryWrites=true" | base64<br/><strong class="nf iu">bW9uZ29kYitzcnY6Ly91c2VybmFtZTpwYXNzd29yZEBhdGxhcy1jbHVzdGVyLmdjcC5tb25nb2RiLm5ldC90ZXN0P3JldHJ5V3JpdGVzPXRydWU=</strong><br/>  <br/>&gt; echo -n "amqp://username:password@rmq.cloudamqp.com/cluster" | base64<br/><strong class="nf iu">YW1xcDovL3VzZXJuYW1lOnBhc3N3b3JkQHJtcS5jbG91ZGFtcXAuY29tL2NsdXN0ZXI=</strong></span></pre><h2 id="e95c" class="mo ls it bd lt mp mq dn lx mr ms dp mb kr mt mu md kv mv mw mf kz mx my mh mz bi translated">Bash脚本变量</h2><p id="689f" class="pw-post-body-paragraph ki kj it kk b kl mj ju kn ko mk jx kq kr ml kt ku kv mm kx ky kz mn lb lc ld im bi translated">bash脚本，<a class="ae le" href="https://github.com/garystafford/golang-srv-demo/blob/master/part3_create_gke_cluster.sh" rel="noopener ugc nofollow" target="_blank"> part3_create_gke_cluster.sh，</a>包含一系列环境变量。至少，您需要更改所有脚本中的<code class="fe nc nd ne nf b">PROJECT</code>变量，以匹配您的GCP项目名称。</p><pre class="lg lh li lj gt ni nf nj nk aw nl bi"><span id="f4fc" class="mo ls it nf b gy nm nn l no np"># Constants - CHANGE ME!<br/><strong class="nf iu">readonly PROJECT='{{ your_gcp_project_goes_here }}'</strong><br/>readonly CLUSTER='go-srv-demo-cluster'<br/>readonly REGION='us-central1'<br/>readonly MASTER_AUTH_NETS='72.231.208.0/24'<br/>readonly GKE_VERSION='1.12.6-gke.10'<br/>readonly MACHINE_TYPE='n1-standard-2'</span></pre><p id="75dc" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">bash脚本<a class="ae le" href="https://github.com/garystafford/golang-srv-demo/blob/master/part4_install_istio.sh" rel="noopener ugc nofollow" target="_blank"> part4_install_istio.sh </a>包含了<code class="fe nc nd ne nf b">ISTIO_HOME</code>变量。该值应该对应于Istio 1.1.3的本地路径。在我的本地Mac上，该值如下所示。</p><pre class="lg lh li lj gt ni nf nj nk aw nl bi"><span id="f50f" class="mo ls it nf b gy nm nn l no np">readonly ISTIO_HOME='/Applications/istio-1.1.3'</span></pre><h1 id="3b8b" class="lr ls it bd lt lu lv lw lx ly lz ma mb jz mc ka md kc me kd mf kf mg kg mh mi bi translated">部署GKE集群</h1><p id="5282" class="pw-post-body-paragraph ki kj it kk b kl mj ju kn ko mk jx kq kr ml kt ku kv mm kx ky kz mn lb lc ld im bi translated">接下来，使用包含的bash脚本<a class="ae le" href="https://github.com/garystafford/golang-srv-demo/blob/master/part3_create_gke_cluster.sh" rel="noopener ugc nofollow" target="_blank">part 3 _ create _ gke _ cluster . sh</a>部署GKE集群。这将创建一个区域性、多区域、3节点GKE集群，使用本文发布时的最新版本GKE 1 . 12 . 6-gke . 10。该集群将部署到与MongoDB Atlas和CloudAMQP集群相同的区域，即GCP的美国中部1(爱荷华州)区域。对于SaaS提供商和主要云提供商而言，规划云资源的驻留位置对于最大限度地降低网络I/O密集型应用的延迟至关重要。</p><figure class="lg lh li lj gt lk gh gi paragraph-image"><div class="gh gi of"><img src="../Images/efe4027f218e300a4cfd341232dfe541.png" data-original-src="https://miro.medium.com/v2/resize:fit:1240/0*hL_LMAFipcQbMnSZ"/></div></figure><h1 id="bdca" class="lr ls it bd lt lu lv lw lx ly lz ma mb jz mc ka md kc me kd mf kf mg kg mh mi bi translated">使用头盔部署Istio</h1><p id="edb6" class="pw-post-body-paragraph ki kj it kk b kl mj ju kn ko mk jx kq kr ml kt ku kv mm kx ky kz mn lb lc ld im bi translated">GKE集群和相关基础设施就绪后，部署Istio。在这篇文章中，我选择了用头盔安装Istio，这是Istio推荐的。要使用Helm部署Istio，请使用附带的bash脚本，<a class="ae le" href="https://github.com/garystafford/golang-srv-demo/blob/master/part4_install_istio.sh" rel="noopener ugc nofollow" target="_blank"> part4_install_istio.sh </a>。</p><figure class="lg lh li lj gt lk gh gi paragraph-image"><div class="gh gi of"><img src="../Images/26e12e35996fc17795da5c3b526f9759.png" data-original-src="https://miro.medium.com/v2/resize:fit:1240/0*mMI3Hsu70sQeKwJO"/></div></figure><p id="7013" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">该脚本使用本地Istio 1.1.3 <code class="fe nc nd ne nf b">install/kubernetes/helm/istio</code>目录中的舵图安装Istio，该目录是作为本演示的一个要求而安装的。Istio安装脚本使用<code class="fe nc nd ne nf b">--set</code>标志覆盖<a class="ae le" href="https://github.com/istio/istio/tree/master/install/kubernetes/helm/istio" rel="noopener ugc nofollow" target="_blank"> Istio舵图表</a>中的几个默认值。Istio图表的<a class="ae le" href="https://github.com/istio/istio/tree/master/install/kubernetes/helm/istio#configuration" rel="noopener ugc nofollow" target="_blank"> GitHub项目</a>中详细列出了可用的配置值列表。这些选项启用了Istio的可观察性特性，我们将在第二部分中探讨这些特性。特征包括基亚利、格拉法纳、普罗米修斯和耶格。</p><pre class="lg lh li lj gt ni nf nj nk aw nl bi"><span id="dcab" class="mo ls it nf b gy nm nn l no np">helm install ${ISTIO_HOME}/install/kubernetes/helm/istio-init \<br/>--name istio-init \<br/>--namespace istio-system<br/><br/>helm install ${ISTIO_HOME}/install/kubernetes/helm/istio \<br/>--name istio \<br/>--namespace istio-system \<br/><strong class="nf iu">--set prometheus.enabled=true \<br/>--set grafana.enabled=true \<br/>--set kiali.enabled=true \<br/>--set tracing.enabled=true<br/></strong><br/>kubectl apply --namespace istio-system \<br/>-f ./resources/secrets/kiali.yaml</span></pre><p id="54f9" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">下面，我们看到在集群上运行的Istio相关工作负载，包括可观察性工具。</p><figure class="lg lh li lj gt lk gh gi paragraph-image"><div role="button" tabindex="0" class="ll lm di ln bf lo"><div class="gh gi of"><img src="../Images/7ccec2bdb6eb62f276258e8ff1ad6bdd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1240/0*7GVQwUzCF6Kjwm6C"/></div></div></figure><p id="7e9c" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">下面，我们看到相应的Istio相关的<code class="fe nc nd ne nf b">Service</code>资源在集群上运行。</p><figure class="lg lh li lj gt lk gh gi paragraph-image"><div role="button" tabindex="0" class="ll lm di ln bf lo"><div class="gh gi of"><img src="../Images/52ac269717cf7656f085052ca551adee.png" data-original-src="https://miro.medium.com/v2/resize:fit:1240/0*QvCy7tl9PaWNPWKZ"/></div></div></figure><h1 id="c685" class="lr ls it bd lt lu lv lw lx ly lz ma mb jz mc ka md kc me kd mf kf mg kg mh mi bi translated">修改DNS记录</h1><p id="2e28" class="pw-post-body-paragraph ki kj it kk b kl mj ju kn ko mk jx kq kr ml kt ku kv mm kx ky kz mn lb lc ld im bi translated">我们将使用DNS，而不是使用IP地址将流量路由到GKE集群及其应用程序。如前所述，我为帖子选择了一个域，<code class="fe nc nd ne nf b">example-api.com</code>，和四个子域。一组子域用于Angular UI，位于<code class="fe nc nd ne nf b">dev</code>名称空间和<code class="fe nc nd ne nf b">test</code>名称空间中。另一组子域用于边缘微服务，即API调用的服务A。基于URL，流量被路由到特定的Kubernetes <code class="fe nc nd ne nf b">Service</code>资源。</p><p id="86e4" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">部署GKE集群和Istio触发了一个<a class="ae le" href="https://cloud.google.com/load-balancing/" rel="noopener ugc nofollow" target="_blank"> Google负载平衡器</a>、四个IP地址和所有必需的防火墙规则的创建。与转发规则相关联的四个IP地址之一(如下所示)将与负载平衡器的前端相关联。</p><figure class="lg lh li lj gt lk gh gi paragraph-image"><div role="button" tabindex="0" class="ll lm di ln bf lo"><div class="gh gi of"><img src="../Images/2f7162e140190519135655438de130ac.png" data-original-src="https://miro.medium.com/v2/resize:fit:1240/0*J02Qf5slXXmsYKNj"/></div></div></figure><p id="bf3b" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">下面，我们看到了新的负载平衡器，它具有前端IP地址和由三个GKE集群工作节点组成的后端虚拟机池。如上所示，每个节点被分配一个IP地址。</p><figure class="lg lh li lj gt lk gh gi paragraph-image"><div role="button" tabindex="0" class="ll lm di ln bf lo"><div class="gh gi of"><img src="../Images/b3024846681a233132fb9dbfd937a0bb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1240/0*WrIyICmCGYACT47Y"/></div></div></figure><p id="e8bb" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">如下图所示，使用<a class="ae le" href="https://cloud.google.com/dns/" rel="noopener ugc nofollow" target="_blank"> Google Cloud DNS </a>，我已经创建了四个子域，并将负载平衡器前端的IP地址分配给了所有四个子域。到这些地址的入口流量将通过Istio入口<code class="fe nc nd ne nf b">Gateway</code>和四个Istio <code class="fe nc nd ne nf b">VirtualServices</code>路由到适当的Kubernetes <code class="fe nc nd ne nf b">Service</code>资源。使用您选择的DNS管理工具来创建四个A类型的<a class="ae le" href="https://en.wikipedia.org/wiki/List_of_DNS_record_types" rel="noopener ugc nofollow" target="_blank"> DNS记录</a>。</p><figure class="lg lh li lj gt lk gh gi paragraph-image"><div role="button" tabindex="0" class="ll lm di ln bf lo"><div class="gh gi of"><img src="../Images/5914e1466edb9e0aafe69000c17d8caa.png" data-original-src="https://miro.medium.com/v2/resize:fit:1240/0*S5LKwH9-lR-I4dhR"/></div></div></figure><h1 id="e626" class="lr ls it bd lt lu lv lw lx ly lz ma mb jz mc ka md kc me kd mf kf mg kg mh mi bi translated">部署参考平台</h1><p id="fe1e" class="pw-post-body-paragraph ki kj it kk b kl mj ju kn ko mk jx kq kr ml kt ku kv mm kx ky kz mn lb lc ld im bi translated">接下来，将八个基于Go的微服务、Angular UI以及相关的Kubernetes和Istio资源部署到GKE集群。要部署平台，请使用附带的bash部署脚本，<a class="ae le" href="https://github.com/garystafford/golang-srv-demo/blob/master/part5a_deploy_resources.sh" rel="noopener ugc nofollow" target="_blank">part5a _ deploy _ resources . sh</a>。如果出现任何故障，并且您希望删除现有资源并重新部署，而不破坏GKE集群或Istio，您可以使用<a class="ae le" href="https://github.com/garystafford/golang-srv-demo/blob/master/part5b_delete_resources.sh" rel="noopener ugc nofollow" target="_blank">part5b _ delete _ resources . sh</a>删除脚本。</p><figure class="lg lh li lj gt lk gh gi paragraph-image"><div class="gh gi of"><img src="../Images/983da0fec5cfaebf0f92f03cfd362fff.png" data-original-src="https://miro.medium.com/v2/resize:fit:1240/0*psLb8eGAcRrdZSLw"/></div></figure><p id="afc4" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">deploy脚本部署所有资源两个Kubernetes名称空间，<code class="fe nc nd ne nf b">dev</code>和<code class="fe nc nd ne nf b">test</code>。这将允许我们看到在使用可观察性工具时如何区分名称空间。</p><p id="0eca" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">下面，我们看到了刚刚部署的Istio相关资源。它们包括T2资源、四个T3资源和两个T4资源。</p><figure class="lg lh li lj gt lk gh gi paragraph-image"><div class="gh gi of"><img src="../Images/723fdd451d0d0ec4ab933fcfd8fb2eb0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1240/0*DMgBQbGiaPmp_iLo"/></div></figure><p id="b8c2" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">下面，我们看到平台的工作负载(Kubernetes <code class="fe nc nd ne nf b">Deployment</code>资源)在集群上运行。这里我们看到每个工作负载有两个pod，总共18个pod，在<code class="fe nc nd ne nf b">dev</code>名称空间中运行。每个Pod都包含已部署的微服务或UI组件，以及Istio的<a class="ae le" href="https://istio.io/docs/concepts/what-is-istio/#envoy" rel="noopener ugc nofollow" target="_blank"> Envoy代理</a>的副本。</p><figure class="lg lh li lj gt lk gh gi paragraph-image"><div role="button" tabindex="0" class="ll lm di ln bf lo"><div class="gh gi of"><img src="../Images/978e3cfc1de2737fe98b0a9f1088576e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1240/0*XSgGrQUgWtdN5JHv"/></div></div></figure><p id="d647" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">下面，我们看到相应的Kubernetes <code class="fe nc nd ne nf b">Service</code>资源在<code class="fe nc nd ne nf b">dev</code>名称空间中运行。</p><figure class="lg lh li lj gt lk gh gi paragraph-image"><div role="button" tabindex="0" class="ll lm di ln bf lo"><div class="gh gi of"><img src="../Images/61275bb0245041f5aa561dce287cd40c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1240/0*ZfIuEGF6x8RHlQZG"/></div></div></figure><p id="7ead" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">下面是在<code class="fe nc nd ne nf b">test</code>名称空间中运行的<code class="fe nc nd ne nf b">Deployment</code>资源的类似视图。同样，每个部署都有两个Pod，每个Pod包含已部署的微服务或UI组件，以及Istio的<a class="ae le" href="https://istio.io/docs/concepts/what-is-istio/#envoy" rel="noopener ugc nofollow" target="_blank"> Envoy代理</a>的副本。</p><figure class="lg lh li lj gt lk gh gi paragraph-image"><div role="button" tabindex="0" class="ll lm di ln bf lo"><div class="gh gi of"><img src="../Images/ce2db55a57bb5340b97107a78babe12e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1240/0*MokIk3hxrOOPOfrh"/></div></div></figure><h1 id="4c8b" class="lr ls it bd lt lu lv lw lx ly lz ma mb jz mc ka md kc me kd mf kf mg kg mh mi bi translated">测试平台</h1><p id="b612" class="pw-post-body-paragraph ki kj it kk b kl mj ju kn ko mk jx kq kr ml kt ku kv mm kx ky kz mn lb lc ld im bi translated">我们确实希望确保平台的八个基于Go的微服务和Angular UI正常工作，相互通信，并与外部MongoDB Atlas和CloudAMQP RabbitMQ集群通信。测试集群最简单的方法是在web浏览器中查看Angular UI。</p><figure class="lg lh li lj gt lk gh gi paragraph-image"><div role="button" tabindex="0" class="ll lm di ln bf lo"><div class="gh gi nb"><img src="../Images/93765905cb936f4253efe73505d53641.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*9zR9c2xX7wgnLTsY2XY8JA.png"/></div></div></figure><p id="e949" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">UI要求您输入服务API的边缘服务)的主机域。因为您不能使用我的子域，并且JavaScript代码在您的web浏览器本地运行，所以此选项允许您提供自己的主机域。这与您插入到UI的两个Istio <code class="fe nc nd ne nf b">VirtualService</code>中的域是相同的。这个域将您的API调用路由到在<code class="fe nc nd ne nf b">dev</code>名称空间<code class="fe nc nd ne nf b">service-a.dev.svc.cluster.local</code>或<code class="fe nc nd ne nf b">test</code>名称空间<code class="fe nc nd ne nf b">service-a.test.svc.cluster.local</code>中运行的Kubernetes服务的FQDN(完全限定的域名)。</p><figure class="lg lh li lj gt lk gh gi paragraph-image"><div role="button" tabindex="0" class="ll lm di ln bf lo"><div class="gh gi of"><img src="../Images/cd1c426af5ab1ef3feec1e3fc33fd0af.png" data-original-src="https://miro.medium.com/v2/resize:fit:1240/0*EVdnqdLcqTJTAr5X"/></div></div></figure><p id="d107" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">您也可以使用性能测试工具对平台进行负载测试。在平台加载之前，许多问题都不会出现。我最近开始使用<a class="ae le" href="https://github.com/rakyll/hey" rel="noopener ugc nofollow" target="_blank">嘿</a>，一种现代负载生成器工具，作为Apache Bench ( <code class="fe nc nd ne nf b">ab</code>)的替代品。与<code class="fe nc nd ne nf b">ab</code>不同的是，<code class="fe nc nd ne nf b">hey</code>支持HTTP/2端点，这是在GKE用Istio测试平台所需要的。下面，我将直接从<a class="ae le" href="https://cloud.google.com/shell/" rel="noopener ugc nofollow" target="_blank">谷歌云端外壳</a>运行<code class="fe nc nd ne nf b">hey</code>。该工具正在模拟25个并发用户，向服务a生成总共1000个基于HTTP/2的GET请求。</p><figure class="lg lh li lj gt lk gh gi paragraph-image"><div role="button" tabindex="0" class="ll lm di ln bf lo"><div class="gh gi nb"><img src="../Images/c08af31b868eaa209a05a0aeabfd3525.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*P1AfmdstW5gTuZ2SUaT8-A.png"/></div></div></figure><h1 id="bfa6" class="lr ls it bd lt lu lv lw lx ly lz ma mb jz mc ka md kc me kd mf kf mg kg mh mi bi translated">解决纷争</h1><p id="2e58" class="pw-post-body-paragraph ki kj it kk b kl mj ju kn ko mk jx kq kr ml kt ku kv mm kx ky kz mn lb lc ld im bi translated">如果由于某种原因UI无法显示，或者从UI到API的调用失败，并且假设所有Kubernetes和Istio资源都在GKE集群上运行(全部为绿色)，最常见的解释通常是对以下资源的错误配置:</p><ol class=""><li id="dbba" class="nr ns it kk b kl km ko kp kr nt kv nu kz nv ld nw nx ny nz bi translated">您的四条云DNS记录不正确。它们没有指向负载平衡器的前端IP地址；</li><li id="8083" class="nr ns it kk b kl oa ko ob kr oc kv od kz oe ld nw nx ny nz bi translated">您没有用正确的子域配置四个库本内特<code class="fe nc nd ne nf b">VirtualService</code>资源；</li><li id="b691" class="nr ns it kk b kl oa ko ob kr oc kv od kz oe ld nw nx ny nz bi translated">您的基于Go的微服务无法到达外部MongoDB Atlas和CloudAMQP RabbitMQ集群。很可能是Kubernetes <code class="fe nc nd ne nf b">Secret</code>构造不正确，或者两个<code class="fe nc nd ne nf b">ServiceEntry</code>资源包含了这些外部集群的错误主机信息；</li></ol><p id="821f" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">我建议通过直接调用服务API的边缘服务)并使用cURL或邮差来开始故障诊断。您应该会看到一个类似于下面的JSON响应负载。这表明问题在于用户界面，而不是应用编程接口。</p><figure class="lg lh li lj gt lk gh gi paragraph-image"><div class="gh gi of"><img src="../Images/533d6bf0faf0b9c9bf4960f92c18c5bf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1240/0*0HsCHLDeANNdM61q"/></div></figure><p id="7816" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">接下来，确认为服务D、服务F、服务G和服务h创建了四个MongoDB数据库。此外，确认正在将新文档写入数据库的集合中。</p><figure class="lg lh li lj gt lk gh gi paragraph-image"><div role="button" tabindex="0" class="ll lm di ln bf lo"><div class="gh gi of"><img src="../Images/ec2cd4cb270456d73117781e4989261f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1240/0*5SdIYlelirDyuF2t"/></div></div></figure><p id="2d5d" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">接下来，使用CloudAMQP RabbitMQ管理控制台确认新的rabbtmq队列已创建。服务D产生消息，服务F从队列中消费这些消息。</p><figure class="lg lh li lj gt lk gh gi paragraph-image"><div role="button" tabindex="0" class="ll lm di ln bf lo"><div class="gh gi of"><img src="../Images/ff022322f8ade525398a41cfa922dc65.png" data-original-src="https://miro.medium.com/v2/resize:fit:1240/0*VT7h5wf5Y5xvhMM4"/></div></div></figure><p id="78e9" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">最后，查看Stackdriver日志，看看是否有任何明显的错误。</p><figure class="lg lh li lj gt lk gh gi paragraph-image"><div role="button" tabindex="0" class="ll lm di ln bf lo"><div class="gh gi of"><img src="../Images/1bc88433684f8420d323b4fab1437e8b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1240/0*HUvnirZp4UJ34ZF2"/></div></div></figure><h1 id="f8a8" class="lr ls it bd lt lu lv lw lx ly lz ma mb jz mc ka md kc me kd mf kf mg kg mh mi bi translated">第二部分</h1><p id="e595" class="pw-post-body-paragraph ki kj it kk b kl mj ju kn ko mk jx kq kr ml kt ku kv mm kx ky kz mn lb lc ld im bi translated">在本文的<a class="ae le" href="https://medium.com/@GaryStafford/kubernetes-based-microservice-observability-with-istio-service-mesh-part-2-f25c4b474a65" rel="noopener">第二部分</a>中，我们将探索每一种可观测性工具，看看它们如何帮助我们管理我们的GKE集群和集群中运行的参考平台。</p><figure class="lg lh li lj gt lk gh gi paragraph-image"><div role="button" tabindex="0" class="ll lm di ln bf lo"><div class="gh gi of"><img src="../Images/8815aaf37c1ba81ffcffb5f09ffbfc06.png" data-original-src="https://miro.medium.com/v2/resize:fit:1240/0*ScdRTGqo4IBUizYv"/></div></div></figure><p id="8576" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">由于集群只需要几分钟就可以完全创建和部署资源，如果您想要拆除GKE集群，请运行<a class="ae le" href="https://github.com/garystafford/golang-srv-demo/blob/master/part6_tear_down.sh" rel="noopener ugc nofollow" target="_blank"> part6_tear_down.sh </a>脚本。</p><figure class="lg lh li lj gt lk gh gi paragraph-image"><div class="gh gi of"><img src="../Images/8c979a3206cc4e4e7e8d6a953ff194e0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1240/0*pO_KgMOoIJE19XAT"/></div></figure></div><div class="ab cl og oh hx oi" role="separator"><span class="oj bw bk ok ol om"/><span class="oj bw bk ok ol om"/><span class="oj bw bk ok ol"/></div><div class="im in io ip iq"><p id="dc44" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><em class="na">本文表达的所有观点都是我个人的，不一定代表我现在或过去的雇主或他们的客户的观点。</em></p></div></div>    
</body>
</html>