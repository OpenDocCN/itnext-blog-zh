<html>
<head>
<title>Enabling a Contract Testing platform with Kubernetes</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Kubernetes启用合同测试平台</h1>
<blockquote>原文：<a href="https://itnext.io/enabling-contract-testing-platform-with-kubernetes-4ab774cb8186?source=collection_archive---------3-----------------------#2022-12-15">https://itnext.io/enabling-contract-testing-platform-with-kubernetes-4ab774cb8186?source=collection_archive---------3-----------------------#2022-12-15</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><p id="a472" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><strong class="js iu">TL；DR </strong>:如何在生产级环境中开始使用带有Pact的消费者驱动合同测试平台。</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi ko"><img src="../Images/b1825fbe0ee660c5e3ac936ade550965.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*mnsw0K_f8n1YOSA-P5GgaA.jpeg"/></div></div><figcaption class="la lb gj gh gi lc ld bd b be z dk translated">再见，E2E！Hellooo疾控中心！</figcaption></figure><h1 id="a992" class="le lf it bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">动机</h1><p id="4004" class="pw-post-body-paragraph jq jr it js b jt mc jv jw jx md jz ka kb me kd ke kf mf kh ki kj mg kl km kn im bi translated">现代软件开发行业的每个人都使用<strong class="js iu"> E2E测试来对发布</strong>的新开发有信心。这些测试给了我们很高的信心<strong class="js iu">，但在持续时间和处理方面成本很高</strong>。</p><p id="9ca5" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">如你所知，<strong class="js iu">单元测试比E2E便宜，因为它们速度快但可信度低</strong>。</p><p id="7569" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><a class="ae mh" href="https://www.martinfowler.com/articles/consumerDrivenContracts.html" rel="noopener ugc nofollow" target="_blank"> <strong class="js iu">消费者驱动的契约</strong> </a> <strong class="js iu"> </strong>测试是作为E2E测试的替代而诞生的。这个想法很简单:如果我们有一个所有涉众(生产者和消费者)都熟知的接口(契约)，为什么不使用这个契约并对照它和生产者来测试消费者呢？</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi mi"><img src="../Images/92008e68f3d8bbaf681c9592fbecc7ff.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*M5Da6qhuwdqNIBqs.png"/></div></div><figcaption class="la lb gj gh gi lc ld bd b be z dk translated">资料来源:docs.pact.io /版权公约基金会</figcaption></figure><p id="a385" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">我们可以孤立地测试生产者和消费者。有道理，对吧？</p></div><div class="ab cl mj mk hx ml" role="separator"><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo"/></div><div class="im in io ip iq"><h1 id="2be9" class="le lf it bd lg lh mq lj lk ll mr ln lo lp ms lr ls lt mt lv lw lx mu lz ma mb bi translated">合同测试和契约</h1><p id="5336" class="pw-post-body-paragraph jq jr it js b jt mc jv jw jx md jz ka kb me kd ke kf mf kh ki kj mg kl km kn im bi translated">据我所知，现在做疾控中心检测的选择不多。</p><p id="22ec" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">我们可以列举两个开源解决方案。一个是<a class="ae mh" href="https://spring.io/projects/spring-cloud-contract" rel="noopener ugc nofollow" target="_blank">春云契约</a>另一个是<a class="ae mh" href="https://pact.io/" rel="noopener ugc nofollow" target="_blank">契约</a>。</p><p id="1e5f" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">Spring Cloud Contract与Java Spring框架紧密耦合。</p><p id="f712" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><strong class="js iu">然而，Pack更多的是平台/语言不可知的</strong>。您可以使用JSON(及其模式)来编写“契约”。</p><p id="84c8" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">比起Java，我更喜欢Python，所以你可以猜到今天要谈论的框架。玩笑归玩笑，由于微服务架构上的最佳应用，我更喜欢不可知的解决方案。</p><p id="22a3" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">Pact规范是一个JSON文件，其中指定了请求(带有头、有效负载等)以及预期的响应。</p><p id="7f2f" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">你可以手动写，但是没人写。最后，您使用一个框架，当测试第一次运行时，pact规范被创建。</p><p id="8193" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">事实上，我们从消费者的角度开始编写测试。我们定义请求以及我们需要什么来响应请求。</p><p id="ad8c" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">除了创建Pact规范，<strong class="js iu">框架还运行一个模拟服务器</strong>，在那里您的消费者代码可以正常运行。</p><p id="095a" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">该框架将使用之前在提供者代码测试期间编写的<strong class="js iu"> pact规范来验证契约</strong>(接口)。</p><p id="2cea" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">正如您所想象的，关于如何管理pact规范生命周期，有一些权衡。我们什么时候把这些文件放在哪里？这些文件的管理可能有点奇怪。因此，Pact背后的人为此创造了一个解决方案。</p><h1 id="5a1c" class="le lf it bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">介绍契约经纪人</h1><p id="ca0f" class="pw-post-body-paragraph jq jr it js b jt mc jv jw jx md jz ka kb me kd ke kf mf kh ki kj mg kl km kn im bi translated">Pact foundation创建了一个存储库管理器来处理Pact规范、<a class="ae mh" href="https://github.com/pact-foundation/pact_broker" rel="noopener ugc nofollow" target="_blank"> <strong class="js iu">、pact broker </strong> </a>的注册和检索。</p><p id="2028" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">您可以自托管pact broker或使用其SaaS服务:<a class="ae mh" href="https://pactflow.io/" rel="noopener ugc nofollow" target="_blank"> <strong class="js iu"> pactflow.io </strong> </a></p><p id="7bb3" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">我们的想法是将它部署在您的基础架构下，以便它可以用于您的CI渠道。</p><p id="63c1" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">当CDC消费者测试开始执行时，要做的第一件事是下载Pact规范(如果存在的话)。如果不存在或者不需要更新(自从上次执行以来测试已经改变了)，更新它。</p><p id="c833" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">另一方面，当执行CDC提供者端测试时，会下载Pact规范并根据提供者实现进行验证。</p><p id="b3f4" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">所以，首先要做的是。我们开始在K8S集群下部署一个契约代理。</p><h1 id="9964" class="le lf it bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">Kubernetes手下的契约经纪人</h1><p id="508e" class="pw-post-body-paragraph jq jr it js b jt mc jv jw jx md jz ka kb me kd ke kf mf kh ki kj mg kl km kn im bi translated">Pact broker需要一个Postgres数据库来存储规范及其元数据。</p><p id="bb9b" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">在Kubernetes中部署Postgres数据库非常简单，这超出了本文的范围。在我的例子中，我将为这种服务使用一个共享的Postgres部署。</p><h2 id="1d16" class="mv lf it bd lg mw mx dn lk my mz dp lo kb na nb ls kf nc nd lw kj ne nf ma ng bi translated">K8S清单</h2><p id="6e01" class="pw-post-body-paragraph jq jr it js b jt mc jv jw jx md jz ka kb me kd ke kf mf kh ki kj mg kl km kn im bi translated">我们创建一个YAML一体化清单文件</p><figure class="kp kq kr ks gt kt"><div class="bz fp l di"><div class="nh ni l"/></div></figure><p id="1e95" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">我们应用它</p><pre class="kp kq kr ks gt nj nk nl bn nm nn bi"><span id="b36e" class="no lf it nk b be np nq l nr ns">kubectl apply -f pact-broker.yml</span></pre><p id="c4cf" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">因为它是内部服务，所以没有必要创建入口资源。</p><p id="a053" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">为了测试它，我们可以做一个简单的端口转发</p><pre class="kp kq kr ks gt nj nk nl bn nm nn bi"><span id="9fd0" class="no lf it nk b be np nq l nr ns">kubectl port-forward -n pact pod/pact-broker-6fd6c49854-rjhch 9292</span></pre><p id="1062" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">如果我们在我们最喜欢的浏览器中打开URL <code class="fe nt nu nv nk b">localhost:9292</code>,我们会默认查看带有示例的pact broker WebUI。</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi nw"><img src="../Images/20c83a67c1a65fda0c17309adb81611d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*hmqbY4t8ZpnCsvl2wbkDhg.png"/></div></div><figcaption class="la lb gj gh gi lc ld bd b be z dk translated">契约代理入口点</figcaption></figure><p id="4fa1" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">我们可以使用下面的HTTP调用来检索“示例应用程序”消费者和“示例API”提供者之间的最新约定</p><pre class="kp kq kr ks gt nj nk nl bn nm nn bi"><span id="9bdc" class="no lf it nk b be np nq l nr ns">http localhost:9292/pacts/provider/Example%20API/consumer/Example%20App/latest</span></pre><p id="c181" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">这是结果(没有HAL元数据)</p><pre class="kp kq kr ks gt nj nk nl bn nm nn bi"><span id="f745" class="no lf it nk b be np nq l nr ns">{<br/>    "consumer": {<br/>        "name": "Example App"<br/>    },<br/>    "createdAt": "2022-12-13T20:49:39+00:00",<br/>    "interactions": [<br/>        {<br/>            "_id": "ef69ceef4d7fb82af014da950a3d9028a905c4de",<br/>            "description": "a request for an alligator",<br/>            "providerState": "there is an alligator named Mary",<br/>            "request": {<br/>                "headers": {<br/>                    "Accept": "application/json"<br/>                },<br/>                "method": "get",<br/>                "path": "/alligators/Mary"<br/>            },<br/>            "response": {<br/>                "body": {<br/>                    "name": "Mary"<br/>                },<br/>                "headers": {<br/>                    "Content-Type": "application/json;charset=utf-8"<br/>                },<br/>                "matchingRules": {<br/>                    "$.body.name": {<br/>                        "match": "type"<br/>                    }<br/>                },<br/>                "status": 200<br/>            }<br/>        },<br/>        {<br/>            "_id": "4b3c23c364f420e1d1296d56a47695de0428d0af",<br/>            "description": "a request for an alligator",<br/>            "providerState": "there is not an alligator named Mary",<br/>            "request": {<br/>                "headers": {<br/>                    "Accept": "application/json"<br/>                },<br/>                "method": "get",<br/>                "path": "/alligators/Mary"<br/>            },<br/>            "response": {<br/>                "headers": {},<br/>                "status": 404<br/>            }<br/>        },<br/>        {<br/>            "_id": "e57e7ac251a8bd078fcb81cad1e577cbafebcef5",<br/>            "description": "a request for an alligator",<br/>            "providerState": "an error occurs retrieving an alligator",<br/>            "request": {<br/>                "headers": {<br/>                    "Accept": "application/json"<br/>                },<br/>                "method": "get",<br/>                "path": "/alligators/Mary"<br/>            },<br/>            "response": {<br/>                "body": {<br/>                    "error": "Argh!!!"<br/>                },<br/>                "headers": {<br/>                    "Content-Type": "application/json;charset=utf-8"<br/>                },<br/>                "status": 500<br/>            }<br/>        }<br/>    ],<br/>    "metadata": {<br/>        "pactSpecification": {<br/>            "version": "2.0.0"<br/>        }<br/>    },<br/>    "provider": {<br/>        "name": "Example API"<br/>    }<br/>}</span></pre><p id="17fb" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">到目前为止一切顺利。我们来做个演示吧！</p><h1 id="b6a3" class="le lf it bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">简单的演示</h1><p id="033f" class="pw-post-body-paragraph jq jr it js b jt mc jv jw jx md jz ka kb me kd ke kf mf kh ki kj mg kl km kn im bi translated">是时候创建一个简单的Python API项目了。</p><p id="4392" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">对于Python，可以使用官方包<code class="fe nt nu nv nk b">pact-python</code>。</p><p id="6682" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">我已经创建了这个演示回购= &gt;<a class="ae mh" href="https://github.com/jmrobles/pact-python-demo" rel="noopener ugc nofollow" target="_blank">https://github.com/jmrobles/pact-python-demo</a></p><p id="8837" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">这很简单，但很能说明问题。</p><p id="1052" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">我不详述所有的细节，我将突出最有趣的部分。</p><h2 id="5299" class="mv lf it bd lg mw mx dn lk my mz dp lo kb na nb ls kf nc nd lw kj ne nf ma ng bi translated">消费者方面</h2><p id="86d4" class="pw-post-body-paragraph jq jr it js b jt mc jv jw jx md jz ka kb me kd ke kf mf kh ki kj mg kl km kn im bi translated"><strong class="js iu"> quotes_consumer.py </strong></p><pre class="kp kq kr ks gt nj nk nl bn nm nn bi"><span id="7b27" class="no lf it nk b be np nq l nr ns">import requests<br/><br/><br/>class QuoteConsumer:<br/><br/>    QUOTES_EP =  '/api/v1/quotes'<br/><br/>    def __init__(self, host: str):<br/><br/>        self.host = host<br/><br/>    def get_random_quote(self) -&gt; str:<br/><br/>        response = requests.get(self.host + self.QUOTES_EP)<br/>        data = response.json()<br/>        return f"{data['quote']}, {data['author']}"<br/><br/><br/>    def put_my_quote(self, quote: str, author: str) -&gt; bool:<br/><br/>        response = requests.post(self.host + self.QUOTES_EP, json={'quote': quote, 'author': author})<br/>        return response.status_code == 201<br/><br/><br/>if __name__ == '__main__':<br/><br/>    # Put a quote<br/>    if not put_my_quote(quote, 'Today is a great day to do CDC testing', 'Aristestoles'):<br/>        print('Something went wrong!')<br/><br/>    # Get a quote<br/>    print(f'Quote of the day =&gt; {get_random_quote()}')</span></pre><p id="ef8a" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">我们开始定义我们的消费者。一个简单的CLI工具，以获得随机报价，并把一个固定的。对，是玩具:)</p><p id="9ba7" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">这里重要的是，我们的消费者在构造函数中传递主机，这样我们就可以注入pact模拟服务器。</p><p id="95a1" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><strong class="js iu">test _ quotes _ consumer . py</strong></p><pre class="kp kq kr ks gt nj nk nl bn nm nn bi"><span id="db7a" class="no lf it nk b be np nq l nr ns">from quotes_consumer import QuoteConsumer<br/><br/>PACT_MOCK_HOST = "localhost"<br/>PACT_MOCK_PORT = 1234<br/><br/>def test_get_quote(pact):<br/><br/>    consumer = QuoteConsumer(f'http://{PACT_MOCK_HOST}:{PACT_MOCK_PORT}')<br/><br/>    expected = {<br/>        'quote': 'A quote',<br/>        'author': 'Anonymous'<br/>    }<br/><br/>    (<br/>        pact.given("A fixed quote")<br/>        .upon_receiving("a request for the quote")<br/>        .with_request("get", "/api/v1/quotes")<br/>        .will_respond_with(200, body=expected)<br/>    )<br/>    with pact:<br/>        quote = consumer.get_random_quote()<br/>        assert quote == 'A quote, Anonymous'<br/>        pact.verify()<br/><br/>def test_create_quote(pact):<br/><br/>    consumer = QuoteConsumer(f'http://{PACT_MOCK_HOST}:{PACT_MOCK_PORT}')<br/><br/>    quote = {<br/>        'quote': 'To test or to test',<br/>        'author': 'A tester'<br/>    }<br/><br/>    (<br/>        pact.given("A quote to add")<br/>        .upon_receiving("a request for adding the new quote")<br/>        .with_request("post", "/api/v1/quotes", body=quote, headers={'Content-type': 'application/json'})<br/>        <br/>        .will_respond_with(201)<br/>    )<br/><br/>    with pact:<br/><br/>        is_created = consumer.put_my_quote(quote['quote'], quote['author'])<br/>        assert is_created<br/>        pact.verify()</span></pre><p id="6928" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">这个更有意思。这里我们定义了两个pytest测试，它们指定了我们所期望的，然后，在“pact”对象的上下文中，我们测试我们的代码。</p><p id="8fab" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">“契约”是<code class="fe nt nu nv nk b">conftest.py</code>中的一个固定项目</p><p id="418e" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><strong class="js iu"> conftest.py </strong></p><pre class="kp kq kr ks gt nj nk nl bn nm nn bi"><span id="795e" class="no lf it nk b be np nq l nr ns">import atexit<br/>import os<br/><br/>import pytest<br/><br/>from pact import Consumer, Provider<br/><br/>PACT_BROKER_URL = "http://localhost:9292"<br/>PACT_MOCK_HOST = "localhost"<br/>PACT_MOCK_PORT = 1234<br/><br/>PACT_DIR = os.path.dirname(os.path.realpath(__file__))<br/><br/>def pytest_addoption(parser):<br/>    parser.addoption(<br/>        "--publish-pact", type=str, action="store", help="Upload generated pact file to pact broker with version"<br/>    )<br/><br/>    parser.addoption("--provider-url", type=str, action="store", help="The url to our provider.")<br/><br/><br/>@pytest.fixture(scope="session")<br/>def pact(request):<br/><br/>    version = request.config.getoption("--publish-pact")<br/>    publish = True if version else False<br/><br/>    pact = Consumer("QuoteCLI", version=version).has_pact_with(<br/>        Provider("QuoteServer"),<br/>        host_name=PACT_MOCK_HOST,<br/>        port=PACT_MOCK_PORT,<br/>        pact_dir=PACT_DIR,<br/>        publish_to_broker=publish,<br/>        broker_base_url=PACT_BROKER_URL,<br/>    )<br/><br/>    pact.start_service()<br/><br/>    atexit.register(pact.stop_service)<br/><br/>    yield pact<br/><br/>    pact.stop_service()<br/><br/>    pact.publish_to_broker = False</span></pre><p id="0b2e" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">这个文件负责添加将契约发布到代理中的选项，为消费者-提供者对创建一个契约对象，并启动/完成模拟服务器。</p><p id="8e43" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">如果我们用<code class="fe nt nu nv nk b">run_pytest.sh</code>运行它，必须出现一个新的契约规范JSON，并且该契约也应该在我们的代理中注册。</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi nx"><img src="../Images/35649de765a12ea7af172e8fcab4425e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Q3_27Zf3pPDcUOSVKFaCcA.png"/></div></div><figcaption class="la lb gj gh gi lc ld bd b be z dk translated">我们的契约规范得到了控制</figcaption></figure><h2 id="2e33" class="mv lf it bd lg mw mx dn lk my mz dp lo kb na nb ls kf nc nd lw kj ne nf ma ng bi translated">提供商方</h2><p id="4f99" class="pw-post-body-paragraph jq jr it js b jt mc jv jw jx md jz ka kb me kd ke kf mf kh ki kj mg kl km kn im bi translated">现在是时候实现一个后端来满足我们的契约了。</p><p id="f392" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">我使用了<code class="fe nt nu nv nk b">fastapi</code>作为API框架。</p><p id="2115" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">quote_server.py</p><pre class="kp kq kr ks gt nj nk nl bn nm nn bi"><span id="3b18" class="no lf it nk b be np nq l nr ns">import random<br/><br/>from fastapi import FastAPI, APIRouter<br/>from pydantic import BaseModel<br/><br/>class Quote(BaseModel):<br/><br/>    quote: str<br/>    author: str<br/><br/>router = APIRouter()<br/><br/>app = FastAPI()<br/><br/>quotes = []<br/><br/>@app.get('/api/v1/quotes')<br/>def get_random_quote():<br/>    return random.choice(quotes)<br/><br/>@app.post('/api/v1/quotes', status_code=201)<br/>def create_new_quote(quote: Quote):<br/>    quotes.append({'quote': quote.quote, 'author': quote.author})<br/>    return ''</span></pre><p id="811b" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">这里唯一有趣的是，我们没有使用数据库或类似的东西。<code class="fe nt nu nv nk b">quotes</code>数组将是我们的内存存储。</p><p id="8000" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><strong class="js iu"> pact_quotes_server.py </strong></p><pre class="kp kq kr ks gt nj nk nl bn nm nn bi"><span id="f5a7" class="no lf it nk b be np nq l nr ns">import uvicorn<br/>from fastapi import APIRouter<br/>from pydantic import BaseModel<br/><br/>from quote_server import app, quotes, router as main_router<br/><br/>pact_router = APIRouter()<br/><br/><br/>class ProviderState(BaseModel):<br/>    state: str  # noqa: E999<br/><br/><br/>@pact_router.post("/_pact/provider_states")<br/>async def provider_states(provider_state: ProviderState):<br/>    mapping = {<br/>        "A fixed quote": setup_fixed_quote,<br/>        "A quote to add": setup_add_quote,<br/>    }<br/>    mapping[provider_state.state]()<br/><br/>    return {"result": mapping[provider_state.state]}<br/><br/><br/># Make sure the app includes both routers. This needs to be done after the<br/># declaration of the provider_states<br/>app.include_router(main_router)<br/>app.include_router(pact_router)<br/><br/><br/>def run_server():<br/>    uvicorn.run(app)<br/><br/><br/>def setup_fixed_quote():<br/><br/>    quotes.clear()<br/>    quotes.append({'quote': 'A quote', 'author': 'Anonymous'})<br/><br/><br/>def setup_add_quote():<br/><br/>    quotes.clear()</span></pre><p id="00ef" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">依我拙见，这是这个项目最奇怪的部分。</p><p id="9a36" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">这里，我们基于原始提供者创建了一个fastapi服务器，但是增加了存储测试中定义的每个交互的状态和fixture映射的功能。</p><p id="802f" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">正如您所看到的，根据测试规范，我们修改了<code class="fe nt nu nv nk b">quotes</code>数组来包含测试所需的数据。</p><p id="923b" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><strong class="js iu"> test_quotes_provider.py </strong></p><pre class="kp kq kr ks gt nj nk nl bn nm nn bi"><span id="7f39" class="no lf it nk b be np nq l nr ns">from multiprocessing import Process<br/><br/>import pytest<br/>from pact import Verifier<br/><br/>from pact_quotes_server import run_server<br/><br/><br/>PACT_BROKER_URL = "http://localhost:9292"<br/>PROVIDER_URL = "http://localhost:8000"<br/><br/>@pytest.fixture(scope="module")<br/>def server():<br/>    proc = Process(target=run_server, args=(), daemon=True)<br/>    proc.start()<br/><br/>    yield proc<br/><br/>    proc.kill()<br/><br/><br/>def test_quote_service(server):<br/><br/>    verifier = Verifier(provider="QuoteServer", provider_base_url=PROVIDER_URL)<br/>    success, logs = verifier.verify_with_broker(<br/>        broker_url=PACT_BROKER_URL,<br/>        verbose=True,<br/>        provider_states_setup_url=f"{PROVIDER_URL}/_pact/provider_states",<br/>        enable_pending=False,<br/>        publish_verification_results=True,<br/>        publish_version="1"<br/>    )<br/>    assert success == 0</span></pre><p id="393d" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">这更像是样板代码。我们只是实例我们的特殊供应商之前显示，并执行契约验证方法对我们的经纪人。我们用<code class="fe nt nu nv nk b">publish_version</code>和<code class="fe nt nu nv nk b">publish_verification_result</code>表示我们也想将验证结果存储在我们的代理中。</p><p id="15c7" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">用<code class="fe nt nu nv nk b">run_pytest.sh</code>执行之后，我们可以再次检查WebUI瞧！验证效果很好！</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi ny"><img src="../Images/d46a44da09e3a3c77e64e1c1fc8955c2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*0WROUaVoUyFnz07Ztf6sFA.png"/></div></div><figcaption class="la lb gj gh gi lc ld bd b be z dk translated">成功的测试握手</figcaption></figure><h1 id="8423" class="le lf it bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">结论</h1><p id="efa5" class="pw-post-body-paragraph jq jr it js b jt mc jv jw jx md jz ka kb me kd ke kf mf kh ki kj mg kl km kn im bi translated">CDC测试是一个相对较新的范例/技术。Sam Newman等一些微服务作者在他的畅销书《构建微服务》中讨论了这一点。</p><p id="031e" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">取消昂贵的E2E测试的承诺，嗯，我认为我们可以减少他们的数量，但不是全部。对于一些需要测试安全性、时间约束等的测试，我们仍然需要在最接近生产环境的环境中执行它们。</p><p id="17f8" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">在我看来，在将CDC和Pact投入生产之前，有一些事情需要改进或了解。可能我会尝试在一个真实的项目中应用它，看看挑战和潜在的解决方案。</p><p id="6eea" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">如果你想知道更多关于CDC测试的信息，请随时通知我们。</p></div></div>    
</body>
</html>