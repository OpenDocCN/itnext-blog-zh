<html>
<head>
<title>GitHub Actions: Hide And Set Angular Environment Variables</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">GitHub动作:隐藏和设置角度环境变量</h1>
<blockquote>原文：<a href="https://itnext.io/github-actions-hide-and-set-angular-environment-variables-e753d06d16a8?source=collection_archive---------1-----------------------#2020-04-11">https://itnext.io/github-actions-hide-and-set-angular-environment-variables-e753d06d16a8?source=collection_archive---------1-----------------------#2020-04-11</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="eba4" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">如何在你的repo中隐藏Angular environments变量，并在构建时使用GitHub动作设置这些变量</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/9ab395e5a57068cf30e5992583d4b760.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*D8K_z16GbcE3t3YqgvPbEQ.png"/></div></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">照片由<a class="ae ky" href="https://unsplash.com/@jae462?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> jae bano </a>在<a class="ae ky" href="https://unsplash.com/s/photos/free?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄</figcaption></figure><p id="320a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我每天分享<a class="ae ky" href="https://medium.com/@david.dalbusco/one-trick-a-day-d-34-469a0336a07e" rel="noopener">一招</a>直到原定的2020年4月19日瑞士新冠肺炎隔离期结束。离第一个里程碑还有八天。希望更好的日子就在前面。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><p id="446e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">昨天我突然想起我还必须创建一个<a class="ae ky" href="https://github.com/features/actions" rel="noopener ugc nofollow" target="_blank"> GitHub Actions </a>来构建和部署我们项目的编辑器<a class="ae ky" href="https://deckdeckgo.com" rel="noopener ugc nofollow" target="_blank"> DeckDeckGo </a>。</p><p id="e55a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">即使大部分集成已经自动化，这个特性仍然在我的待办事项列表中，因为在能够正确完成这个任务之前，我必须混淆一些生产令牌。</p><p id="c460" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">当我思考这个问题时，我问自己，最近我是否真的已经在另一个项目中解决了这个特性？你猜怎么着，我确实有😉，而是装在一个<a class="ae ky" href="https://angular.io" rel="noopener ugc nofollow" target="_blank">有棱角的</a>原型里。几周前，为了帮我在苏黎世找到一套公寓，我为自己开发了一个小项目。</p><p id="266e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这就是为什么我今天与你分享这个新的技巧。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="39d7" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">概念</h1><p id="46f1" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">Angular，开箱即用，由于我们的<code class="fe mz na nb nc b">angular.json</code>的属性<code class="fe mz na nb nc b">fileReplacements</code>，让我们处理环境变量。默认情况下，您的项目很可能包含两个文件，一个是<code class="fe mz na nb nc b">environment.ts</code>，另一个是用于您的生产构建的<code class="fe mz na nb nc b">environment.prod.ts</code>。</p><p id="ddb2" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">想法如下:在<code class="fe mz na nb nc b">environment.prod.ts</code>我们将定义不带任何值的键，允许我们在我们的公共<a class="ae ky" href="https://github.com" rel="noopener ugc nofollow" target="_blank"> GitHub </a> repo中安全地推送这些键。然后，在系统变量的帮助下，在GitHub操作中构建之前设置这些变量。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="2143" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">安装环境. ts</h1><p id="2880" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">首先，让我们先设置我们的<code class="fe mz na nb nc b">environment.ts</code>文件。我们的目标是混淆一个令牌，比如说我们想要隐藏我们的<a class="ae ky" href="https://firebase.google.com" rel="noopener ugc nofollow" target="_blank"> Firebase </a> Api密钥。</p><p id="c224" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">与解决方案并不相关，但是我们也在您的配置中注入了应用程序的<code class="fe mz na nb nc b">version</code>和<code class="fe mz na nb nc b">name</code>。注意，这需要激活<code class="fe mz na nb nc b">tsconfig.json.</code>中的编译器选项<code class="fe mz na nb nc b">resolveJsonModule</code>到<code class="fe mz na nb nc b">true</code></p><p id="50e4" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们的<code class="fe mz na nb nc b">environment.ts</code>:</p><pre class="kj kk kl km gt nd nc ne nf aw ng bi"><span id="0d21" class="nh md it nc b gy ni nj l nk nl">import {name, version} from '../../package.json';<br/><br/>export const environment<strong class="nc iu"><em class="nm"> </em></strong>= {<br/>  production: false,<br/>  firebase: {<br/>    apiKey: 'the-key-you-can-expose',<br/>  },<br/>  name,<br/>  version<br/>};</span></pre><p id="4c1f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">而我们的<code class="fe mz na nb nc b">environment.prod.ts</code>包含了<code class="fe mz na nb nc b">'undefined'</code>为隐藏值。这是一个字符串背后的原因是，如果在构建时没有定义键，我们即将到来的解析器将注入这样的值。</p><pre class="kj kk kl km gt nd nc ne nf aw ng bi"><span id="5db9" class="nh md it nc b gy ni nj l nk nl">export const environment<strong class="nc iu"><em class="nm"> </em></strong>= {<br/>   production: true,<br/>   firebase: {<br/>        apiKey: 'undefined'<br/>    },<br/>    name: 'enviro-replace',<br/>    version: '0.0.1'<br/>};</span></pre></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h2 id="8a3d" class="nh md it bd me nn no dn mi np nq dp mm li nr ns mo lm nt nu mq lq nv nw ms nx bi translated">隐藏发展变量</h2><p id="d97d" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">在前面的设置中，我修改了我们同意在开发配置中公开密钥的事实，但是您可能也想隐藏它。在这种情况下，我建议将这些值提取到一个单独的本地文件中，您在<code class="fe mz na nb nc b">.gitignore</code>中明确忽略了这个文件。</p><p id="2e16" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">例如，假设我们创建了一个新文件<code class="fe mz na nb nc b">firebase.environment.ts</code>，在其中我们移动了配置，并添加到Git忽略的文件列表中。</p><pre class="kj kk kl km gt nd nc ne nf aw ng bi"><span id="b82a" class="nh md it nc b gy ni nj l nk nl">export const firebase<strong class="nc iu"><em class="nm"> </em></strong>= {<br/>    firebase: {<br/>        apiKey: 'the-key-you-can-expose',<br/>    }<br/>};</span></pre><p id="438d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">然后我们可以更新我们的<code class="fe mz na nb nc b">environment.ts</code>如下:</p><pre class="kj kk kl km gt nd nc ne nf aw ng bi"><span id="5212" class="nh md it nc b gy ni nj l nk nl">import {firebase} from './firebase.environment';<br/><br/>import {name, version} from '../../package.json';<br/><br/>export const environment = {<br/>  production: false,<br/>  ...firebase,<br/>  name,<br/>  version<br/>};</span></pre></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="b8ea" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">构建前更新变量</h1><p id="4421" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">我们的生产环境在这一点上包含了一个隐藏的值<code class="fe mz na nb nc b">'undefined'</code>，我们必须在构建我们的应用程序之前替换它。</p><p id="ddc3" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">为此，我们可以使用Riccardo Andreatta 的<a class="ae ky" href="https://medium.com/@ferie/how-to-pass-environment-variables-at-building-time-in-an-angular-application-using-env-files-4ae1a80383c" rel="noopener">文章</a>中描述的“魔法文件”👍。</p><p id="e3b3" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们创建一个新的脚本<code class="fe mz na nb nc b">./config.index.ts</code>。基本上，它会用新值覆盖我们的<code class="fe mz na nb nc b">environment.prod.ts</code>文件，特别是我们将在您的环境或GiHub Actions secret store中定义的值。</p><p id="b280" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在这个解析器中，我们注意到两件有趣的事情:</p><ol class=""><li id="cb70" class="ny nz it lb b lc ld lf lg li oa lm ob lq oc lu od oe of og bi translated">它也包含环境变量。这意味着，如果您要向配置中添加一个新的密钥，您也必须更新脚本。</li><li id="3ac3" class="ny nz it lb b lc oh lf oi li oj lm ok lq ol lu od oe of og bi translated">我们使用环境进程<code class="fe mz na nb nc b">process.env.FIREBASE_API_KEY</code>来注入一个值，我们将从我们的环境或者从GitHub动作中获取这个值，用我们想要隐藏的有效键来覆盖环境。</li></ol><pre class="kj kk kl km gt nd nc ne nf aw ng bi"><span id="0e5d" class="nh md it nc b gy ni nj l nk nl">import {writeFile} from 'fs';<br/><br/>import {name, version} from '../package.json';<br/><br/>const targetPath = './src/environments/environment.prod.ts';<br/><br/>const envConfigFile = `export const environment = {<br/>   production: true,<br/>   firebase: {<br/>        apiKey: '${process.env.FIREBASE_API_KEY}'<br/>    },<br/>    name: '${name}',<br/>    version: '${version}'<br/>};<br/>`;<br/><br/>writeFile(targetPath, envConfigFile, 'utf8', (err) =&gt; {<br/>  if (err) {<br/>    return console.log(err);<br/>  }<br/>});</span></pre><p id="648d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">最后，我们可以将脚本的执行添加到我们的<code class="fe mz na nb nc b">package.json</code>:</p><pre class="kj kk kl km gt nd nc ne nf aw ng bi"><span id="e86b" class="nh md it nc b gy ni nj l nk nl">"scripts": {<br/>  "config": <br/>     "ts-node -O '{\"module\": \"commonjs\"}' ./config.index.ts",<br/>  "build": "npm run config &amp;&amp; ng build --prod",<br/>}</span></pre></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="ad49" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">测试</h1><p id="cf0d" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">我们都准备好了，现在可以试一试。让我们先运行一个构建，什么都不做。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi om"><img src="../Images/1e491dee35113ba8f2c7684571e5039d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*JMobhDqd7gnda8JQ1etzQw.png"/></div></div></figure><p id="f711" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">正如你所注意到的，我们的<code class="fe mz na nb nc b">apiKey</code>剩余等于<code class="fe mz na nb nc b">'undefined'</code>，因此对我们的构建无效。</p><p id="327b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在让我们尝试定义一个环境变量(<code class="fe mz na nb nc b">export FIREBASE_API_KEY="this is my prod key"</code>)并再次运行我们的构建。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi om"><img src="../Images/e05e63781f79cbf3a4c7e9065f7278ce.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*BU5qNiYe0mr3JcjdUHc9bQ.png"/></div></div></figure><p id="3ac1" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">Tada，我们环境变量已经被设置并用于我们的构建🎉。</p><p id="8fdf" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">此时，您可能会问自己“是的，但是David，如果我们这样做，那么每次我们运行构建时，我们的<code class="fe mz na nb nc b">environment.prod.ts</code>文件都将被修改”。对此我会回答“是的，你是对的…但是我们的目标是用GitHub动作来自动构建，以便不再在本地运行高效的构建，因此修改对我们的日常工作流来说不是问题😇".</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="3cc9" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">GitHub操作</h1><p id="11e0" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">最后一点，GitHub动作的自动化。</p><p id="7a10" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我不打算讨论如何创建这样的脚本，<a class="ae ky" href="https://twitter.com/julienrenaux" rel="noopener ugc nofollow" target="_blank"> Julien Renaux </a>在他的<a class="ae ky" href="https://julienrenaux.fr/2019/11/25/building-deploying-stenciljs-apps-firebase-hosting-github-actions/" rel="noopener ugc nofollow" target="_blank">博客文章</a>中很好地讨论了这个主题，或者你可以查看我的Angular相关的<a class="ae ky" href="https://github.com/peterpeterparker/watamato/blob/master/.github/workflows/app.yml" rel="noopener ugc nofollow" target="_blank"> app.yml </a> GitHub actions。</p><p id="6389" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我假设你的脚本已经准备好了，并且你已经在你的repos' secrets中定义了一个<code class="fe mz na nb nc b">FIREBASE_API_KEY</code>。</p><p id="7c08" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">应用程序的相关构建序列可能如下所示:</p><pre class="kj kk kl km gt nd nc ne nf aw ng bi"><span id="fabc" class="nh md it nc b gy ni nj l nk nl">jobs:<br/>  build:<br/>    name: Build<br/>    runs-on: ubuntu-latest<br/>    steps:<br/>      - name: Checkout Repo<br/>        uses: actions/checkout@master<br/>      - name: Install Dependencies<br/>        run: npm ci<br/>      - name: Build<br/>        run: npm run build</span></pre><p id="db15" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们现在“只”需要添加以下内容:</p><pre class="kj kk kl km gt nd nc ne nf aw ng bi"><span id="7314" class="nh md it nc b gy ni nj l nk nl">jobs:<br/>  build:<br/>    name: Build<br/>    runs-on: ubuntu-latest<br/>    steps:<br/>      - name: Checkout Repo<br/>        uses: actions/checkout@master<br/>      - name: Install Dependencies<br/>        run: npm ci<br/>      - name: Build<br/>        run: npm run build<br/>        env:<br/>          FIREBASE_API_KEY: ${{ secrets.FIREBASE_API_KEY }}</span></pre><p id="9874" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">已经这样了。这样做，GitHub Actions将为我们的构建设置相关的环境变量，我们上面的脚本和配置将处理剩下的事情。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="2f5c" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">摘要</h1><p id="2cf9" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">GitHub操作非常方便，过去和现在都是我持续集成工作流程的重要资产。</p><p id="e859" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">呆在家里，注意安全！</p><p id="9d0d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">大卫</p></div></div>    
</body>
</html>