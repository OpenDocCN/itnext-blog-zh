<html>
<head>
<title>React Push notifications (with hooks)</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">反应推送通知(带挂钩)</h1>
<blockquote>原文：<a href="https://itnext.io/react-push-notifications-with-hooks-d293d36f4836?source=collection_archive---------0-----------------------#2019-08-30">https://itnext.io/react-push-notifications-with-hooks-d293d36f4836?source=collection_archive---------0-----------------------#2019-08-30</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><h2 id="27f8" class="io ip iq bd b dl ir is it iu iv iw dk ix translated" aria-label="kicker paragraph">react . js Javascript推送通知入门指南</h2><div class=""/><div class=""><h2 id="b652" class="pw-subtitle-paragraph jw iz iq bd b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn dk translated">推送通知如何工作以及如何回应</h2></div><p id="3f56" class="pw-post-body-paragraph ko kp iq kq b kr ks ka kt ku kv kd kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated">这篇文章是使用<em class="lk">钩子</em>创建<em class="lk">推送通知</em>和<em class="lk">反应</em>的指南。结束时，您将创建一个有效的推送通知系统。在此期间，您可以玩<a class="ae ll" href="https://push-notifications-react.netlify.app/" rel="noopener ugc nofollow" target="_blank">演示</a>或浏览最终结果的<a class="ae ll" href="https://github.com/Spyna/push-notification-demo" rel="noopener ugc nofollow" target="_blank">源代码</a>。</p><p id="ca92" class="pw-post-body-paragraph ko kp iq kq b kr ks ka kt ku kv kd kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated">我最近用普通JavaScript写了一篇关于Web推送通知的文章，这是React版本。如果你想知道推送通知的理论和流程，我建议你读一下那篇文章，这样我们就可以直接跳到代码了。</p><p id="5f69" class="pw-post-body-paragraph ko kp iq kq b kr ks ka kt ku kv kd kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated">本文分为两部分:</p><ol class=""><li id="2a62" class="lm ln iq kq b kr ks ku kv kx lo lb lp lf lq lj lr ls lt lu bi translated">处理<em class="lk">推送通知</em></li><li id="43f7" class="lm ln iq kq b kr lv ku lw kx lx lb ly lf lz lj lr ls lt lu bi translated">处理<em class="lk">反应app </em></li></ol><h1 id="feb6" class="ma mb iq bd mc md me mf mg mh mi mj mk kf ml kg mm ki mn kj mo kl mp km mq mr bi translated">处理推送通知</h1><figure class="mt mu mv mw gt mx gh gi paragraph-image"><div role="button" tabindex="0" class="my mz di na bf nb"><div class="gh gi ms"><img src="../Images/3fd3025ffbeaf1df8606d5dc2a6469bb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*U6Ztd1rZpQMdZXMo"/></div></div><figcaption class="ne nf gj gh gi ng nh bd b be z dk translated">照片由<a class="ae ll" href="https://unsplash.com/@timmossholder?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">蒂姆·莫斯霍尔德</a>在<a class="ae ll" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄</figcaption></figure><p id="c814" class="pw-post-body-paragraph ko kp iq kq b kr ks ka kt ku kv kd kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated">要使用推送通知，您必须:</p><ul class=""><li id="5e80" class="lm ln iq kq b kr ks ku kv kx lo lb lp lf lq lj ni ls lt lu bi translated">检查浏览器是否支持通知</li><li id="a979" class="lm ln iq kq b kr lv ku lw kx lx lb ly lf lz lj ni ls lt lu bi translated">注册服务人员</li><li id="776e" class="lm ln iq kq b kr lv ku lw kx lx lb ly lf lz lj ni ls lt lu bi translated">请求用户许可</li><li id="401d" class="lm ln iq kq b kr lv ku lw kx lx lb ly lf lz lj ni ls lt lu bi translated">(可选)创建一个<em class="lk">通知订阅</em></li><li id="aa24" class="lm ln iq kq b kr lv ku lw kx lx lb ly lf lz lj ni ls lt lu bi translated">(可选)将订阅发送到<em class="lk">推送服务器</em></li><li id="58c5" class="lm ln iq kq b kr lv ku lw kx lx lb ly lf lz lj ni ls lt lu bi translated">显示<em class="lk">推送通知</em></li></ul><p id="1f95" class="pw-post-body-paragraph ko kp iq kq b kr ks ka kt ku kv kd kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated">好像很多东西，先说第一个吧。</p><h2 id="4193" class="nj mb iq bd mc nk nl dn mg nm nn dp mk kx no np mm lb nq nr mo lf ns nt mq iw bi translated">检查浏览器是否支持通知</h2><p id="074b" class="pw-post-body-paragraph ko kp iq kq b kr nu ka kt ku nv kd kw kx nw kz la lb nx ld le lf ny lh li lj ij bi translated">您希望仅在浏览器支持时使用通知。创建一个执行这项检查的函数。</p><pre class="mt mu mv mw gt nz oa ob oc aw od bi"><span id="8653" class="nj mb iq oa b gy oe of l og oh">function isPushNotificationSupported() {<br/>  return "serviceWorker" in navigator &amp;&amp; "PushManager" in window;<br/>}</span></pre><p id="6f33" class="pw-post-body-paragraph ko kp iq kq b kr ks ka kt ku kv kd kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated">该函数检查<code class="fe oi oj ok oa b">PushManager</code>和<code class="fe oi oj ok oa b">serviceWorker</code>是否存在。它返回真或假；</p><p id="9940" class="pw-post-body-paragraph ko kp iq kq b kr ks ka kt ku kv kd kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated">我们需要一个<code class="fe oi oj ok oa b">serviceWorker</code>来处理通知，所以接下来要做的就是注册一个。</p><h2 id="6327" class="nj mb iq bd mc nk nl dn mg nm nn dp mk kx no np mm lb nq nr mo lf ns nt mq iw bi translated">注册服务人员</h2><p id="edbf" class="pw-post-body-paragraph ko kp iq kq b kr nu ka kt ku nv kd kw kx nw kz la lb nx ld le lf ny lh li lj ij bi translated">这个函数注册了一个文件<code class="fe oi oj ok oa b">sw.js</code>，它应该在我们项目的根目录下，所以在我们的react-app的文件夹<code class="fe oi oj ok oa b">public</code>中。就目前而言，它将是一个空文件。</p><pre class="mt mu mv mw gt nz oa ob oc aw od bi"><span id="1daf" class="nj mb iq oa b gy oe of l og oh">function registerServiceWorker() {<br/>  return navigator.serviceWorker.register("/sw.js");<br/>}</span></pre><p id="1617" class="pw-post-body-paragraph ko kp iq kq b kr ks ka kt ku kv kd kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated">该函数返回一个解决<code class="fe oi oj ok oa b">serviceWorkerRegistration</code>的承诺。</p><h2 id="d814" class="nj mb iq bd mc nk nl dn mg nm nn dp mk kx no np mm lb nq nr mo lf ns nt mq iw bi translated">请求用户许可</h2><p id="32fc" class="pw-post-body-paragraph ko kp iq kq b kr nu ka kt ku nv kd kw kx nw kz la lb nx ld le lf ny lh li lj ij bi translated">没有用户的同意不能发送通知，让我们创建一个询问许可的函数。</p><pre class="mt mu mv mw gt nz oa ob oc aw od bi"><span id="478e" class="nj mb iq oa b gy oe of l og oh">async function askUserPermission() {<br/>  return await Notification.requestPermission();<br/>}</span></pre><p id="b709" class="pw-post-body-paragraph ko kp iq kq b kr ks ka kt ku kv kd kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated">该函数返回用户同意的结果，可以是:<code class="fe oi oj ok oa b">default</code>、<code class="fe oi oj ok oa b">denied</code>和<code class="fe oi oj ok oa b">granted</code>中的一个。<code class="fe oi oj ok oa b">default</code>表示用户没有给出任何响应。</p><p id="099c" class="pw-post-body-paragraph ko kp iq kq b kr ks ka kt ku kv kd kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated">如果这个函数的结果是<code class="fe oi oj ok oa b">granted</code>，我们可以进入下一步。</p><h2 id="7b14" class="nj mb iq bd mc nk nl dn mg nm nn dp mk kx no np mm lb nq nr mo lf ns nt mq iw bi translated">推还是不推？</h2><p id="3570" class="pw-post-body-paragraph ko kp iq kq b kr nu ka kt ku nv kd kw kx nw kz la lb nx ld le lf ny lh li lj ij bi translated">此时，我们正处于十字路口！我们必须决定是否要:</p><ul class=""><li id="b136" class="lm ln iq kq b kr ks ku kv kx lo lb lp lf lq lj ni ls lt lu bi translated">(只是)显示通知</li><li id="e717" class="lm ln iq kq b kr lv ku lw kx lx lb ly lf lz lj ni ls lt lu bi translated">(发送)推送通知</li></ul><figure class="mt mu mv mw gt mx gh gi paragraph-image"><div role="button" tabindex="0" class="my mz di na bf nb"><div class="gh gi ol"><img src="../Images/641e61d32908f987c02aebdc1e906f7b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*jF6UpP1OJ8fgnue6"/></div></div><figcaption class="ne nf gj gh gi ng nh bd b be z dk translated">乔恩·泰森在<a class="ae ll" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</figcaption></figure><p id="e798" class="pw-post-body-paragraph ko kp iq kq b kr ks ka kt ku kv kd kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated">推送通知是你可能在Twitter、脸书、WhatsApp和类似的应用上看到的那些。当你的朋友给你写消息时，你会收到通知，即使脸书或WhatsApp没有打开。</p><p id="4afc" class="pw-post-body-paragraph ko kp iq kq b kr ks ka kt ku kv kd kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated">如果需要这种通知，继续阅读，否则可以跳过接下来的章节，直接阅读关于“发送通知”的部分。</p><h2 id="f332" class="nj mb iq bd mc nk nl dn mg nm nn dp mk kx no np mm lb nq nr mo lf ns nt mq iw bi translated">创建通知订阅</h2><p id="c9e6" class="pw-post-body-paragraph ko kp iq kq b kr nu ka kt ku nv kd kw kx nw kz la lb nx ld le lf ny lh li lj ij bi translated">要接收推送通知，您需要:</p><ul class=""><li id="8e4c" class="lm ln iq kq b kr ks ku kv kx lo lb lp lf lq lj ni ls lt lu bi translated"><strong class="kq ja"> <em class="lk">推送服务</em> </strong>:管理和接收通知(浏览器提供推送服务)</li><li id="8d46" class="lm ln iq kq b kr lv ku lw kx lx lb ly lf lz lj ni ls lt lu bi translated">一个<strong class="kq ja"> <em class="lk">推送订阅</em> </strong>:提供订阅URL端点，允许取消订阅推送服务。</li><li id="48e6" class="lm ln iq kq b kr lv ku lw kx lx lb ly lf lz lj ni ls lt lu bi translated">a <strong class="kq ja"> <em class="lk">推送服务器</em> </strong>:向推送订阅端点发送推送消息的服务器，由浏览器<em class="lk">推送服务处理。</em></li></ul><p id="349d" class="pw-post-body-paragraph ko kp iq kq b kr ks ka kt ku kv kd kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated">为了创建推送订阅，我们使用之前注册的服务工作者。</p><pre class="mt mu mv mw gt nz oa ob oc aw od bi"><span id="983a" class="nj mb iq oa b gy oe of l og oh">async function createNotificationSubscription() {<br/>  //wait for service worker installation to be ready<br/>  const serviceWorker = await navigator.serviceWorker.ready;<br/>  // subscribe and return the subscription<br/>  return await serviceWorker.pushManager.subscribe({<br/>    userVisibleOnly: true,<br/>    applicationServerKey: pushServerPublicKey<br/>  });<br/>}</span></pre><p id="e264" class="pw-post-body-paragraph ko kp iq kq b kr ks ka kt ku kv kd kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated">指令<code class="fe oi oj ok oa b">navigator.service.worker.ready</code>等待服务人员准备好使用，因为在我们注册后，它可能处于其他状态，如<code class="fe oi oj ok oa b">waiting</code>、<code class="fe oi oj ok oa b">installing</code>。如果注册失败，这个承诺永远无法解决。</p><p id="42fc" class="pw-post-body-paragraph ko kp iq kq b kr ks ka kt ku kv kd kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated">我们使用<code class="fe oi oj ok oa b"><a class="ae ll" href="https://developer.mozilla.org/en-US/docs/Web/API/PushManager" rel="noopener ugc nofollow" target="_blank">PushManager</a></code>接口来创建订阅，并向方法<code class="fe oi oj ok oa b">subscribe</code>传递两个参数:</p><ul class=""><li id="2388" class="lm ln iq kq b kr ks ku kv kx lo lb lp lf lq lj ni ls lt lu bi translated"><code class="fe oi oj ok oa b">userVisibleOnly</code>:布尔值，表示返回的推送订阅将仅用于其效果对用户可见的消息。</li><li id="aeaf" class="lm ln iq kq b kr lv ku lw kx lx lb ly lf lz lj ni ls lt lu bi translated"><code class="fe oi oj ok oa b">applicationServerKey</code>:一个<a class="ae ll" href="https://en.wikipedia.org/wiki/Elliptic_Curve_Digital_Signature_Algorithm" rel="noopener ugc nofollow" target="_blank"> ECDSA </a>(椭圆曲线数字签名算法)P-256公钥，推送服务器将用它来认证你的应用。如果指定，来自应用程序服务器的所有消息都必须使用<a class="ae ll" href="https://tools.ietf.org/html/rfc8292" rel="noopener ugc nofollow" target="_blank"> VAPID </a>身份验证方案，并包含用相应私钥签名的JWT。这个密钥<strong class="kq ja"> <em class="lk">与您用来加密数据的密钥</em> </strong>不同。</li></ul><p id="d216" class="pw-post-body-paragraph ko kp iq kq b kr ks ka kt ku kv kd kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated">稍后我将向您展示如何为推送服务器(私有的)和应用程序(公共的)创建一个密钥对(私有的和公共的)。</p><p id="6ff5" class="pw-post-body-paragraph ko kp iq kq b kr ks ka kt ku kv kd kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated">该函数返回<code class="fe oi oj ok oa b">PushSubscription</code>，一个包含推送服务器/服务的惟一端点的对象，以及一些其他信息。每个浏览器使用不同的推送服务，生成不同的端点。在chrome中，端点将类似于:</p><pre class="mt mu mv mw gt nz oa ob oc aw od bi"><span id="a8e7" class="nj mb iq oa b gy oe of l og oh"><a class="ae ll" href="https://fcm.googleapis.com/fcm/send/fXjr1iIPn00:....." rel="noopener ugc nofollow" target="_blank">https://fcm.googleapis.com/fcm/send/fXjr1iIPn00:.....</a></span></pre><p id="b706" class="pw-post-body-paragraph ko kp iq kq b kr ks ka kt ku kv kd kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated">在firefox中</p><pre class="mt mu mv mw gt nz oa ob oc aw od bi"><span id="26ff" class="nj mb iq oa b gy oe of l og oh"><a class="ae ll" href="https://updates.push.services.mozilla.com/wpush/v2/gAAAAABdZ80ZW5..." rel="noopener ugc nofollow" target="_blank">https://updates.push.services.mozilla.com/wpush/v2/gAAAAABdZ80ZW5...</a></span></pre><p id="346f" class="pw-post-body-paragraph ko kp iq kq b kr ks ka kt ku kv kd kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated">如果我们向该端点发送推送消息，我们会收到推送通知，因此不要将其发送给陌生人。端点和推送订阅的信息需要被发送到<em class="lk">推送服务器</em>，以便它可以使用它来发送消息。</p><h2 id="d328" class="nj mb iq bd mc nk nl dn mg nm nn dp mk kx no np mm lb nq nr mo lf ns nt mq iw bi translated">将订阅发送到推送服务器</h2><p id="5734" class="pw-post-body-paragraph ko kp iq kq b kr nu ka kt ku nv kd kw kx nw kz la lb nx ld le lf ny lh li lj ij bi translated">没有标准的方式将推送订阅发送到<em class="lk">推送服务器</em>。</p><p id="8338" class="pw-post-body-paragraph ko kp iq kq b kr ks ka kt ku kv kd kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated">Twitter使用其API传递一个JSON，如下所示:</p><figure class="mt mu mv mw gt mx gh gi paragraph-image"><div role="button" tabindex="0" class="my mz di na bf nb"><div class="gh gi om"><img src="../Images/269e2d18c2893fc98eb349ffc7c810d9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*eGZD44D9_0Wf2Ae8Tih-nQ.png"/></div></div><figcaption class="ne nf gj gh gi ng nh bd b be z dk translated">Twitter传递这些数据来订阅推送服务器。请注意身份验证标头</figcaption></figure><p id="9249" class="pw-post-body-paragraph ko kp iq kq b kr ks ka kt ku kv kd kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated">脸书使用了一种形式:</p><figure class="mt mu mv mw gt mx gh gi paragraph-image"><div role="button" tabindex="0" class="my mz di na bf nb"><div class="gh gi on"><img src="../Images/cc441eefa60d8a4ae042f9cc05fe52bc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*q0dwN6Tj02e67eO-Ri2b_A.png"/></div></div><figcaption class="ne nf gj gh gi ng nh bd b be z dk translated">脸书用来向推送服务器发送订阅的网络请求</figcaption></figure><p id="e8e3" class="pw-post-body-paragraph ko kp iq kq b kr ks ka kt ku kv kd kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated">需要注意的是，它们都发送订阅端点，并且提交是安全的。</p><p id="c54d" class="pw-post-body-paragraph ko kp iq kq b kr ks ka kt ku kv kd kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated">在本教程中，我们将使用一个我构建并部署在互联网上的演示推送服务器。我的推送服务器很虚设，没有认证，也不保存你的订阅数据。源代码是公开的，你可以在这里找到它。</p><figure class="mt mu mv mw gt mx gh gi paragraph-image"><div role="button" tabindex="0" class="my mz di na bf nb"><div class="gh gi oo"><img src="../Images/4a1dabf51d5d18f4c189cbed874302f7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*6yTzT5QsIWrveXL7G8dEYg.png"/></div></div><figcaption class="ne nf gj gh gi ng nh bd b be z dk translated">演示推送服务器的API</figcaption></figure><p id="5ac7" class="pw-post-body-paragraph ko kp iq kq b kr ks ka kt ku kv kd kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated">你可以在这个地址使用它<a class="ae ll" href="https://push-notification-demo-server.herokuapp.com/api-docs/#/" rel="noopener ugc nofollow" target="_blank">，它公开了两个端点:</a></p><ul class=""><li id="5f0f" class="lm ln iq kq b kr ks ku kv kx lo lb lp lf lq lj ni ls lt lu bi translated"><code class="fe oi oj ok oa b">POST /subscription</code>:领取订阅。</li><li id="7e28" class="lm ln iq kq b kr lv ku lw kx lx lb ly lf lz lj ni ls lt lu bi translated"><code class="fe oi oj ok oa b">GET /subscription/{id}</code>:触发所请求订阅的推送通知。</li></ul><p id="bf13" class="pw-post-body-paragraph ko kp iq kq b kr ks ka kt ku kv kd kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated">演示推送服务器是在node中用一个名为<a class="ae ll" href="https://www.npmjs.com/package/web-push" rel="noopener ugc nofollow" target="_blank"> web-push </a>的库实现的，我用这个库创建了订阅的公钥。要知道如何自己创建一个，请看一下这个库。</p><p id="434d" class="pw-post-body-paragraph ko kp iq kq b kr ks ka kt ku kv kd kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated">让我们创建一个调用推送服务器的函数。</p><pre class="mt mu mv mw gt nz oa ob oc aw od bi"><span id="2feb" class="nj mb iq oa b gy oe of l og oh">async function postSubscription(subscription) {<br/>  const response = await fetch(`<a class="ae ll" href="https://push-notification-demo-server.herokuapp.com/subscription`" rel="noopener ugc nofollow" target="_blank">https://push-notification-demo-server.herokuapp.com/subscription`</a>, {<br/>    credentials: "omit",<br/>    headers: { "content-type": "application/json;charset=UTF-8", "sec-fetch-mode": "cors" },<br/>    body: JSON.stringify(subscription),<br/>    method: "POST",<br/>    mode: "cors"<br/>  });<br/>  return await response.json();<br/>}</span></pre><p id="fbb5" class="pw-post-body-paragraph ko kp iq kq b kr ks ka kt ku kv kd kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated">参数<code class="fe oi oj ok oa b">subscription</code>正是我们之前创建的函数<code class="fe oi oj ok oa b">createNotificationSubscription</code>的响应。</p><p id="7d96" class="pw-post-body-paragraph ko kp iq kq b kr ks ka kt ku kv kd kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated">一旦你向<em class="lk">推送服务器</em>发送订阅，它就会向<em class="lk">推送服务</em>(浏览器的)发送<em class="lk">推送消息</em>。</p><h2 id="3f06" class="nj mb iq bd mc nk nl dn mg nm nn dp mk kx no np mm lb nq nr mo lf ns nt mq iw bi translated">(发送推送消息)</h2><p id="107d" class="pw-post-body-paragraph ko kp iq kq b kr nu ka kt ku nv kd kw kx nw kz la lb nx ld le lf ny lh li lj ij bi translated">推送服务器公开了<code class="fe oi oj ok oa b">GET /subscription/{id}</code>端点，该端点触发通知并发送推送消息。服务器的代码是这样的:</p><pre class="mt mu mv mw gt nz oa ob oc aw od bi"><span id="59c7" class="nj mb iq oa b gy oe of l og oh">...<br/>sendNotification(<br/>      pushSubscription,<br/>      JSON.stringify({<br/>        title: "New Product Available ",<br/>        text: "HEY! Take a look at this brand new t-shirt!",<br/>        image: "/images/jason-leung-HM6TMmevbZQ-unsplash.jpg",<br/>        tag: "new-product",<br/>        url: "/new-product-jason-leung-HM6TMmevbZQ-unsplash.html"<br/>      })<br/>    )<br/>...</span></pre><p id="bbc0" class="pw-post-body-paragraph ko kp iq kq b kr ks ka kt ku kv kd kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated">该代码片段向推送订阅的端点发送推送消息，该消息的有效负载包含一个对象的字符串表示，该对象具有:<code class="fe oi oj ok oa b">title</code>、<code class="fe oi oj ok oa b">text</code>、<code class="fe oi oj ok oa b">image</code>、<code class="fe oi oj ok oa b">url</code>、<code class="fe oi oj ok oa b">tag</code>和<code class="fe oi oj ok oa b">url</code>。所有这些信息都被插入到推送消息中并被发送。这意味着当推送服务(应用程序)收到消息时，它可以访问它们。</p><h2 id="8915" class="nj mb iq bd mc nk nl dn mg nm nn dp mk kx no np mm lb nq nr mo lf ns nt mq iw bi translated">接收推送消息</h2><p id="8ba7" class="pw-post-body-paragraph ko kp iq kq b kr nu ka kt ku nv kd kw kx nw kz la lb nx ld le lf ny lh li lj ij bi translated">当从<em class="lk">推送服务器</em>发送<em class="lk">推送消息</em>时，服务人员可以阅读该消息。要做到这一点，您必须在服务工作器中为推送事件创建一个监听器，让我们在服务工作器文件中完成这项工作。</p><pre class="mt mu mv mw gt nz oa ob oc aw od bi"><span id="042a" class="nj mb iq oa b gy oe of l og oh">function receivePushNotification(event) {<br/>  console.log("[Service Worker] Push Received.");</span><span id="ed59" class="nj mb iq oa b gy op of l og oh">const { image, tag, url, title, text } = event.data.json();</span><span id="6033" class="nj mb iq oa b gy op of l og oh">const options = {<br/>    data: url,<br/>    body: text,<br/>    icon: image,<br/>    vibrate: [200, 100, 200],<br/>    tag: tag,<br/>    image: image,<br/>    badge: "<a class="ae ll" href="https://spyna.it/icons/favicon.ico" rel="noopener ugc nofollow" target="_blank">/favicon.ico</a>",<br/>    actions: [{ action: "Detail", title: "View", icon: "<a class="ae ll" href="https://via.placeholder.com/128/ff0000" rel="noopener ugc nofollow" target="_blank">https://via.placeholder.com/128/ff0000</a>" }]<br/>  };<br/>  event.waitUntil(self.registration.showNotification(title, options));<br/>}<br/>self.addEventListener("push", receivePushNotification);</span></pre><p id="79d3" class="pw-post-body-paragraph ko kp iq kq b kr ks ka kt ku kv kd kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated">这个代码片段向<code class="fe oi oj ok oa b">push</code>事件添加了一个<code class="fe oi oj ok oa b">eventListener</code>。侦听器是一个使用推送事件的函数。方法<code class="fe oi oj ok oa b">event.data.json()</code>将消息有效负载转换成一个对象。接下来，方法<code class="fe oi oj ok oa b">selft.registration.showNotification</code>向用户设备显示通知。这些选项是不言自明的，你可以在这里找到它们。</p><p id="5610" class="pw-post-body-paragraph ko kp iq kq b kr ks ka kt ku kv kd kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated">用户可以点击通知。要接收用户点击，您需要在服务工作器中添加一个监听器:</p><pre class="mt mu mv mw gt nz oa ob oc aw od bi"><span id="0c8d" class="nj mb iq oa b gy oe of l og oh">function openPushNotification(event) {<br/>  console.log("Notification click Received.",    event.notification.data);<br/>   event.notification.close();<br/>  //do something<br/>}<br/>self.addEventListener("notificationclick", openPushNotification);</span></pre><h1 id="8b2e" class="ma mb iq bd mc md me mf mg mh mi mj mk kf ml kg mm ki mn kj mo kl mp km mq mr bi translated">把东西放在一起</h1><p id="1036" class="pw-post-body-paragraph ko kp iq kq b kr nu ka kt ku nv kd kw kx nw kz la lb nx ld le lf ny lh li lj ij bi translated">我们已经学会了如何:</p><ul class=""><li id="1494" class="lm ln iq kq b kr ks ku kv kx lo lb lp lf lq lj ni ls lt lu bi translated">检查浏览器是否支持<em class="lk">推送通知</em></li><li id="4f35" class="lm ln iq kq b kr lv ku lw kx lx lb ly lf lz lj ni ls lt lu bi translated">注册服务人员</li><li id="68e3" class="lm ln iq kq b kr lv ku lw kx lx lb ly lf lz lj ni ls lt lu bi translated">请求用户同意显示<em class="lk">推送通知</em></li><li id="b792" class="lm ln iq kq b kr lv ku lw kx lx lb ly lf lz lj ni ls lt lu bi translated">创建<em class="lk">推送通知订阅</em></li><li id="9998" class="lm ln iq kq b kr lv ku lw kx lx lb ly lf lz lj ni ls lt lu bi translated">向<em class="lk">推送服务器</em>发送<em class="lk">推送通知订阅</em></li><li id="39ff" class="lm ln iq kq b kr lv ku lw kx lx lb ly lf lz lj ni ls lt lu bi translated">在<em class="lk">服务器</em>中接收<em class="lk">推送消息</em>并显示</li><li id="682a" class="lm ln iq kq b kr lv ku lw kx lx lb ly lf lz lj ni ls lt lu bi translated">处理<em class="lk">通知点击</em>事件</li></ul><p id="5a71" class="pw-post-body-paragraph ko kp iq kq b kr ks ka kt ku kv kd kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated">下面是包含所有这些函数的代码:</p><p id="5834" class="pw-post-body-paragraph ko kp iq kq b kr ks ka kt ku kv kd kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated">这个脚本还包含返回当前推送通知订阅的函数<code class="fe oi oj ok oa b">getUserSubscription</code>(如果有的话),我们将在本文的第二部分使用它。</p><p id="a8ed" class="pw-post-body-paragraph ko kp iq kq b kr ks ka kt ku kv kd kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated">这是服务人员的代码<code class="fe oi oj ok oa b">sw.js</code></p><p id="135d" class="pw-post-body-paragraph ko kp iq kq b kr ks ka kt ku kv kd kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated">推送通知部分到此为止，下面开始React部分。</p></div><div class="ab cl oq or hu os" role="separator"><span class="ot bw bk ou ov ow"/><span class="ot bw bk ou ov ow"/><span class="ot bw bk ou ov"/></div><div class="ij ik il im in"><h1 id="1649" class="ma mb iq bd mc md ox mf mg mh oy mj mk kf oz kg mm ki pa kj mo kl pb km mq mr bi translated">创建React应用</h1><p id="c231" class="pw-post-body-paragraph ko kp iq kq b kr nu ka kt ku nv kd kw kx nw kz la lb nx ld le lf ny lh li lj ij bi translated">第二步也是最后一步:创建一个React应用程序。</p><figure class="mt mu mv mw gt mx gh gi paragraph-image"><div role="button" tabindex="0" class="my mz di na bf nb"><div class="gh gi pc"><img src="../Images/e2e406b6cda846708e0ce8f38b198c1a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*3ujurvE6vYrHWuUz"/></div></div><figcaption class="ne nf gj gh gi ng nh bd b be z dk translated">奥斯卡·伊尔迪兹在<a class="ae ll" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>拍摄的照片</figcaption></figure><p id="b4e4" class="pw-post-body-paragraph ko kp iq kq b kr ks ka kt ku kv kd kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated">创建React应用程序的最快方法是使用<code class="fe oi oj ok oa b">create-react-app</code>，运行:</p><pre class="mt mu mv mw gt nz oa ob oc aw od bi"><span id="0463" class="nj mb iq oa b gy oe of l og oh">npm install -g create-react-app<br/># alternatively use npx</span><span id="27d1" class="nj mb iq oa b gy op of l og oh">create-react-app push-notifications<br/># npx create-react-app push-notifications</span><span id="f058" class="nj mb iq oa b gy op of l og oh">cd push-notifications<br/>npm run eject</span></pre><p id="f63d" class="pw-post-body-paragraph ko kp iq kq b kr ks ka kt ku kv kd kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated">可选地，你可以运行<code class="fe oi oj ok oa b">eject</code>脚本，这允许你对应用程序有更多的控制。</p><p id="5822" class="pw-post-body-paragraph ko kp iq kq b kr ks ka kt ku kv kd kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated">接下来，我们将创建:</p><ul class=""><li id="4c0b" class="lm ln iq kq b kr ks ku kv kx lo lb lp lf lq lj ni ls lt lu bi translated">使用<code class="fe oi oj ok oa b">push-notification.js</code>中定义的函数的自定义<em class="lk">反应钩子</em></li><li id="a075" class="lm ln iq kq b kr lv ku lw kx lx lb ly lf lz lj ni ls lt lu bi translated">使用自定义钩子的<em class="lk">反应</em>表示<em class="lk">组件</em>。</li></ul><h2 id="e3ae" class="nj mb iq bd mc nk nl dn mg nm nn dp mk kx no np mm lb nq nr mo lf ns nt mq iw bi translated">钩子</h2><p id="ad9f" class="pw-post-body-paragraph ko kp iq kq b kr nu ka kt ku nv kd kw kx nw kz la lb nx ld le lf ny lh li lj ij bi translated">创建一个名为<code class="fe oi oj ok oa b">usePushNotifications.js</code>的文件，并将其放在source文件夹中。</p><p id="72a5" class="pw-post-body-paragraph ko kp iq kq b kr ks ka kt ku kv kd kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated">这是完整的注释代码:</p><p id="66c0" class="pw-post-body-paragraph ko kp iq kq b kr ks ka kt ku kv kd kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated">它的作用:</p><ul class=""><li id="9a78" class="lm ln iq kq b kr ks ku kv kx lo lb lp lf lq lj ni ls lt lu bi translated">检查浏览器是否支持推送通知</li><li id="91e9" class="lm ln iq kq b kr lv ku lw kx lx lb ly lf lz lj ni ls lt lu bi translated">如果支持推送通知，会注册服务人员</li><li id="f008" class="lm ln iq kq b kr lv ku lw kx lx lb ly lf lz lj ni ls lt lu bi translated">检索已注册服务工作线程是否有任何推送通知订阅</li><li id="7205" class="lm ln iq kq b kr lv ku lw kx lx lb ly lf lz lj ni ls lt lu bi translated">定义一个点击处理程序<code class="fe oi oj ok oa b">onClickAskUserPermission</code>来询问用户权限，并将其导出，这样就可以在组件中使用了</li><li id="f0d7" class="lm ln iq kq b kr lv ku lw kx lx lb ly lf lz lj ni ls lt lu bi translated">定义并导出点击处理程序<code class="fe oi oj ok oa b">onClickSubscribeToPushNotification</code>来创建推送通知订阅。</li><li id="78d2" class="lm ln iq kq b kr lv ku lw kx lx lb ly lf lz lj ni ls lt lu bi translated">定义并导出一个点击处理程序<code class="fe oi oj ok oa b">onClickSendSubscriptionToPushServer</code>，它将<em class="lk">推送订阅</em>发送到<em class="lk">推送服务器。</em></li><li id="4c8a" class="lm ln iq kq b kr lv ku lw kx lx lb ly lf lz lj ni ls lt lu bi translated">定义并导出点击处理程序<code class="fe oi oj ok oa b">onclickSendNotification</code>，它请求<em class="lk">推送服务器</em>发送<em class="lk">推送消息</em>。</li></ul><p id="7a7b" class="pw-post-body-paragraph ko kp iq kq b kr ks ka kt ku kv kd kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated">这个钩子函数不接受任何参数，返回一个包含组件使用推送通知所需的所有内容的对象。</p><p id="cd77" class="pw-post-body-paragraph ko kp iq kq b kr ks ka kt ku kv kd kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated">使用析构，你可以这样使用它:</p><pre class="mt mu mv mw gt nz oa ob oc aw od bi"><span id="551f" class="nj mb iq oa b gy oe of l og oh">const {<br/>    userConsent,<br/>    pushNotificationSupported,<br/>    userSubscription,<br/>    onClickAskUserPermission,<br/>    onClickSusbribeToPushNotification,<br/>    onClickSendSubscriptionToPushServer,<br/>    pushServerSubscriptionId,<br/>    onClickSendNotification,<br/>    error,<br/>    loading<br/>  } = usePushNotifications();</span></pre><p id="1a79" class="pw-post-body-paragraph ko kp iq kq b kr ks ka kt ku kv kd kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated">相当于<code class="fe oi oj ok oa b">const usePushNotifications = usePushNotifications()</code> <code class="fe oi oj ok oa b">const userConsent = usePushNotifications.userConsent</code>。</p><h2 id="c6fb" class="nj mb iq bd mc nk nl dn mg nm nn dp mk kx no np mm lb nq nr mo lf ns nt mq iw bi translated">反应组分</h2><p id="9419" class="pw-post-body-paragraph ko kp iq kq b kr nu ka kt ku nv kd kw kx nw kz la lb nx ld le lf ny lh li lj ij bi translated">现在我们已经有了所有的“业务逻辑”,我们可以为演示创建一个React组件。</p><p id="9a7e" class="pw-post-body-paragraph ko kp iq kq b kr ks ka kt ku kv kd kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated">让我们从导入所有需要的东西开始:</p><pre class="mt mu mv mw gt nz oa ob oc aw od bi"><span id="c0c4" class="nj mb iq oa b gy oe of l og oh">import React from "react";<br/>import usePushNotifications from "./usePushNotifications";</span><span id="2c0e" class="nj mb iq oa b gy op of l og oh">export default function PushNotificationDemo() {<br/>  const {<br/>    userConsent,<br/>    pushNotificationSupported,<br/>    userSubscription,<br/>    onClickAskUserPermission,<br/>    onClickSusbribeToPushNotification,<br/>    onClickSendSubscriptionToPushServer,<br/>    pushServerSubscriptionId,<br/>    onClickSendNotification,<br/>    error,<br/>    loading<br/>  } = usePushNotifications();</span><span id="5136" class="nj mb iq oa b gy op of l og oh">return &lt;div&gt;&lt;/div&gt;;<br/>}</span></pre><p id="fee5" class="pw-post-body-paragraph ko kp iq kq b kr ks ka kt ku kv kd kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated">接下来，我们想要显示一个错误或者一个加载消息，当东西正在加载的时候，当有一个错误的时候。在<code class="fe oi oj ok oa b">return &lt;div&gt;&lt;/div&gt;</code>之前增加以下内容:</p><pre class="mt mu mv mw gt nz oa ob oc aw od bi"><span id="004d" class="nj mb iq oa b gy oe of l og oh">if (<strong class="oa ja">error</strong>) {<br/>  return  (<br/>    &lt;section className="app-error"&gt;<br/>      &lt;h2&gt;{error.name}&lt;/h2&gt;<br/>      &lt;p&gt;Error message : {error.message}&lt;/p&gt;<br/>      &lt;p&gt;Error code : {error.code}&lt;/p&gt;<br/>    &lt;/section&gt;)<br/>}</span><span id="e046" class="nj mb iq oa b gy op of l og oh">if (<strong class="oa ja">loading</strong>) {<br/>  return "Loading, please stand by";<br/>}</span></pre><p id="8b3c" class="pw-post-body-paragraph ko kp iq kq b kr ks ka kt ku kv kd kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated">接下来，我们要展示的是同意是否被授予，以及推送通知是否被支持，以及询问用户同意的按钮。用以下内容替换<code class="fe oi oj ok oa b">return &lt;div&gt;&lt;/div&gt;</code>:</p><pre class="mt mu mv mw gt nz oa ob oc aw od bi"><span id="e5c5" class="nj mb iq oa b gy oe of l og oh">return (<br/>    &lt;div&gt;<br/>      &lt;p&gt;Push notification are {!<strong class="oa ja">pushNotificationSupported</strong> &amp;&amp; "NOT"} supported by your device.&lt;/p&gt;<br/>      &lt;p&gt;<br/>        User consent to recevie push notificaitons is &lt;strong&gt;{<strong class="oa ja">userConsent</strong>}&lt;/strong&gt;.<br/>      &lt;/p&gt;<br/>      &lt;button onClick={<strong class="oa ja">onClickAskUserPermission</strong>}&gt;Ask user permission&lt;/button&gt;<br/>    &lt;/div&gt;<br/>  );</span></pre><p id="a6a7" class="pw-post-body-paragraph ko kp iq kq b kr ks ka kt ku kv kd kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated">接下来，我们添加按钮来创建通知订阅:</p><pre class="mt mu mv mw gt nz oa ob oc aw od bi"><span id="f7e8" class="nj mb iq oa b gy oe of l og oh">&lt;button onClick={<strong class="oa ja">onClickSusbribeToPushNotification</strong>}&gt;Create Notification subscription&lt;/button&gt;</span></pre><p id="82be" class="pw-post-body-paragraph ko kp iq kq b kr ks ka kt ku kv kd kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated">接下来，轮到发送通知订阅的按钮了</p><pre class="mt mu mv mw gt nz oa ob oc aw od bi"><span id="194c" class="nj mb iq oa b gy oe of l og oh">&lt;button onClick={<strong class="oa ja">onClickSendSubscriptionToPushServer</strong>}&gt;Send subscription to push server&lt;/button&gt;</span></pre><p id="7a04" class="pw-post-body-paragraph ko kp iq kq b kr ks ka kt ku kv kd kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated">最后是发送通知的按钮</p><pre class="mt mu mv mw gt nz oa ob oc aw od bi"><span id="1150" class="nj mb iq oa b gy oe of l og oh">&lt;button onClick={<strong class="oa ja">onClickSendNotification</strong>}&gt;Send a notification&lt;/button&gt;</span></pre><p id="7e78" class="pw-post-body-paragraph ko kp iq kq b kr ks ka kt ku kv kd kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated">这是完整的代码:</p><p id="c203" class="pw-post-body-paragraph ko kp iq kq b kr ks ka kt ku kv kd kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated">在不到40行代码中，您就拥有了一个完整管理推送通知的干净组件。</p><p id="1852" class="pw-post-body-paragraph ko kp iq kq b kr ks ka kt ku kv kd kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated">添加一些风格和一些小的改进，我想出了这个演示，你可以在https://push-notifications-react.netlify.app/的<a class="ae ll" href="https://push-notifications-react.netlify.app/" rel="noopener ugc nofollow" target="_blank">玩。或者，如果你更喜欢阅读代码，它可在本次回购</a>中<a class="ae ll" href="https://github.com/Spyna/push-notification-demo/tree/master/front-end-react" rel="noopener ugc nofollow" target="_blank">获得。</a></p><figure class="mt mu mv mw gt mx gh gi paragraph-image"><div class="gh gi pd"><img src="../Images/594c16be9b769e842ffd79504a9396bf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1200/1*1zkK0livJ_J3CDK4wSr3Ng.gif"/></div><figcaption class="ne nf gj gh gi ng nh bd b be z dk translated">最终结果是:推送通知起作用了</figcaption></figure><p id="4f93" class="pw-post-body-paragraph ko kp iq kq b kr ks ka kt ku kv kd kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated">恭喜你！！😎你坚持到了最后。如果你喜欢👌这篇文章，点击下面按钮👏。这对我意义重大，也有助于其他人了解这个故事。</p><p id="b968" class="pw-post-body-paragraph ko kp iq kq b kr ks ka kt ku kv kd kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated">洛伦佐·斯皮纳的更多故事:</p><div class="pg ph gp gr pi pj"><a rel="noopener  ugc nofollow" target="_blank" href="/an-introduction-to-web-push-notifications-a701783917ce"><div class="pk ab fo"><div class="pl ab pm cl cj pn"><h2 class="bd ja gy z fp po fr fs pp fu fw iz bi translated">JavaScript网页推送通知简介</h2><div class="pq l"><h3 class="bd b gy z fp po fr fs pp fu fw dk translated">如何实现Web推送通知，初学者入门，让推送通知简单易懂。与……</h3></div><div class="pr l"><p class="bd b dl z fp po fr fs pp fu fw dk translated">itnext.io</p></div></div><div class="ps l"><div class="pt l pu pv pw ps px nc pj"/></div></div></a></div><div class="pg ph gp gr pi pj"><a href="https://medium.com/@spyna/the-truth-about-amazon-job-interview-b940a2190585" rel="noopener follow" target="_blank"><div class="pk ab fo"><div class="pl ab pm cl cj pn"><h2 class="bd ja gy z fp po fr fs pp fu fw iz bi translated">如何在亚马逊找到工作</h2><div class="pq l"><h3 class="bd b gy z fp po fr fs pp fu fw dk translated">我们听说了很多关于亚马逊招聘流程的故事，有些是真的，有些不是。我想分享我的…</h3></div><div class="pr l"><p class="bd b dl z fp po fr fs pp fu fw dk translated">medium.com</p></div></div><div class="ps l"><div class="py l pu pv pw ps px nc pj"/></div></div></a></div><p id="7820" class="pw-post-body-paragraph ko kp iq kq b kr ks ka kt ku kv kd kw kx ky kz la lb lc ld le lf lg lh li lj ij bi translated">感谢<a class="pe pf ep" href="https://medium.com/u/bbd794a7fa3a?source=post_page-----d293d36f4836--------------------------------" rel="noopener" target="_blank">艾迪刘</a>的错别字纠正。</p></div></div>    
</body>
</html>