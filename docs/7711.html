<html>
<head>
<title>How WeChat Stores One Trillion Social Connections with NebulaGraph Database</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">微信如何用NebulaGraph数据库存储一万亿社交连接</h1>
<blockquote>原文：<a href="https://itnext.io/how-wechat-stores-one-trillion-social-connections-with-nebulagraph-database-393f5d634319?source=collection_archive---------2-----------------------#2022-12-29">https://itnext.io/how-wechat-stores-one-trillion-social-connections-with-nebulagraph-database-393f5d634319?source=collection_archive---------2-----------------------#2022-12-29</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/31774d549e3e8d243d75a02d9d9c41ff.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*RVYsi4ThTVl0C3Vd.png"/></div></div></figure><p id="214d" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">微信是世界上处理大规模异构图的社交网络应用之一。要处理的数据集包含以下内容:</p><ul class=""><li id="f8f1" class="kw kx iq ka b kb kc kf kg kj ky kn kz kr la kv lb lc ld le bi translated">一万亿个边/连接</li><li id="d47b" class="kw kx iq ka b kb lf kf lg kj lh kn li kr lj kv lb lc ld le bi translated">总共150TB的数据集</li><li id="ce95" class="kw kx iq ka b kb lf kf lg kj lh kn li kr lj kv lb lc ld le bi translated">每小时更新1000亿次连接</li></ul><p id="16f7" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">这是一个巨大的挑战。微信的团队发现了<a class="ae lk" href="https://nebula-graph.io" rel="noopener ugc nofollow" target="_blank"> NebulaGraph </a>，这是一个开源的分布式图形数据库，通过数据库中的深度定制能力，终于实现了一些有用的按需功能。包括大数据存储、大数据集快速性能的数据导入、版本控制、秒级回滚、毫秒级的数据库访问。</p><h1 id="f8dc" class="ll lm iq bd ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi bi translated">巨型互联网公司面临的挑战</h1><p id="4f1a" class="pw-post-body-paragraph jy jz iq ka b kb mj kd ke kf mk kh ki kj ml kl km kn mm kp kq kr mn kt ku kv ij bi translated">大多数知名的图数据库需要更有能力处理真正的大数据。例如<a class="ae lk" href="https://neo4j.com/" rel="noopener ugc nofollow" target="_blank"> Neo4j </a>的社区版提供单主机服务，在知识图谱领域被广泛采用。然而，当涉及到非常大的数据集时，这个解决方案需要修改。在当今的商业世界中，大型数据集越来越常见。</p><p id="7848" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">此外，如果您选择多拷贝实施，还需要考虑数据一致性和灾难恢复问题。<a class="ae lk" href="https://janusgraph.org/" rel="noopener ugc nofollow" target="_blank">骏利图</a>通过使用外部元数据管理、kv存储和索引，解决了大数据存储问题。然而，这种表现受到了广泛的批评。因此，微信团队评估的大多数图形数据库解决方案在性能方面都比Janus Graph好很多倍。</p><p id="1717" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">一些互联网公司建立自己的数据库。这些自主开发的解决方案迎合了他们自己的业务需求，而不是一般的图形场景。因此，它们只支持有限比例的查询语法。</p><h1 id="f383" class="ll lm iq bd ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi bi translated">蚂蚁金服的GeaBase</h1><p id="b4ae" class="pw-post-body-paragraph jy jz iq ka b kb mj kd ke kf mk kh ki kj ml kl km kn mm kp kq kr mn kt ku kv ij bi translated">GeaBase是另一种选择，主要用于金融行业。它具有自主开发的查询语言、下推计算和毫秒级延迟。它的主要应用场景包括金融机构中的风险管理。为此，它支持拥有数万亿条边/关系的交易网络，存储实时交易数据，以及实时欺诈检测。</p><p id="2fe6" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">对于推荐引擎也很有用。这包括股票和证券推荐等应用。它的Ant Forest具有存储数万亿个节点的能力、强大的数据一致性和低延迟查询。它还具有动态图形CNN的GNN特性，用于基于动态图形的在线推理。</p><h1 id="1e8d" class="ll lm iq bd ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi bi translated">阿里巴巴的图片</h1><p id="0d06" class="pw-post-body-paragraph jy jz iq ka b kb mj kd ke kf mk kh ki kj ml kl km kn mm kp kq kr mn kt ku kv ij bi translated">还有iGraph，一个图形索引和查询系统。它存储用户行为信息，作为阿里巴巴四大骨干中间平台之一。iGraph采用Gremlin作为其图形查询语言，用于电子商务关系的实时查询。</p><h1 id="f9ab" class="ll lm iq bd ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi bi translated">来自字节跳动的ByteGraph(又名抖音)</h1><p id="48ae" class="pw-post-body-paragraph jy jz iq ka b kb mj kd ke kf mk kh ki kj ml kl km kn mm kp kq kr mn kt ku kv ij bi translated">通过向kv层添加缓存层，ByteGraph将关系拆分为B+树，以便高效访问边和数据采样。结构就像脸书的道。</p><h1 id="f9c6" class="ll lm iq bd ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi bi translated">微信大数据解决方案的架构</h1><p id="d256" class="pw-post-body-paragraph jy jz iq ka b kb mj kd ke kf mk kh ki kj ml kl km kn mm kp kq kr mn kt ku kv ij bi translated">微信团队想出了以下架构来解决大数据存储和处理问题。</p><figure class="mo mp mq mr gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi gj"><img src="../Images/fbfa796173d0a40628c72517a882664e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*rCdVHhER01KlkEEF.png"/></div></div></figure><h1 id="72d7" class="ll lm iq bd ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi bi translated">为什么是星云图数据库？</h1><p id="ab82" class="pw-post-body-paragraph jy jz iq ka b kb mj kd ke kf mk kh ki kj ml kl km kn mm kp kq kr mn kt ku kv ij bi translated">从上面的架构可以看出，图形数据库是解决方案的主要组成部分。微信最终选择了NebulaGraph作为其探索图形数据库之旅的起点。</p><p id="847e" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">微信发现NebulaGraph最有潜力<strong class="ka ir">处理基于数据集分区和独立关系存储能力的海量数据集存储需求</strong>。它还具有基于强一致性存储引擎的下推计算和MPP优化。最后，该团队在图形数据库领域拥有丰富的经验，并拥有成熟的大数据抽象模型。</p><h1 id="700a" class="ll lm iq bd ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi bi translated">实践中的问题</h1><h1 id="198b" class="ll lm iq bd ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi bi translated">内存不足</h1><p id="c652" class="pw-post-body-paragraph jy jz iq ka b kb mj kd ke kf mk kh ki kj ml kl km kn mm kp kq kr mn kt ku kv ij bi translated">微信团队遇到了内存问题。本质上，这是一个性能与资源的问题。在处理大规模数据集的应用中，内存占用是一个不可忽视的问题。RocksDB中有几个组件会影响内存的使用。有块缓存、索引和布隆过滤器。还有迭代器钉住的内存表和内存块。因此，微信团队开始优化内存利用率。它始于块缓存优化。为此，它采用全局LRU缓存来控制机器中所有RocksDB实例的缓存占用。</p><p id="88b6" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">然后团队做了一个bloom filter优化。edge被设计为一个键值对，存储在RocksDB中。如果所有密钥都存储在bloom过滤器中，并且每个密钥占用10位，那么整个过滤器所需的内存将大大超过机器内存。</p><p id="7997" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">该团队观察到，大多数情况下，请求是为了获取特定节点的边列表。因此，该团队采用了前缀布隆过滤器。另一个优化是为顶点上的属性创建索引，为大多数请求提供加速。最后，单主机过滤器的内存占用是千兆字节级的，而不会牺牲大多数请求的速度。</p><h1 id="5594" class="ll lm iq bd ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi bi translated">版本控制</h1><p id="8116" class="pw-post-body-paragraph jy jz iq ka b kb mj kd ke kf mk kh ki kj ml kl km kn mm kp kq kr mn kt ku kv ij bi translated">对于版本控制，实际上有几个业务需求。它提供图形数据快速回滚、定期完整数据导入和对最新版本数据的自动访问。该小组将数据源分为两类。</p><p id="02f3" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">比如循环数据，按天生成相似用户列表，数据导入成功后生效。然后是历史数据和实时数据。例如，按天刷新历史数据，团队将历史数据与实时数据结合起来作为要导入的完整数据。</p><p id="125a" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">以下是RockDB中的数据存储模型。</p><p id="fbce" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">顶点存储模型:</p><figure class="mo mp mq mr gt jr gh gi paragraph-image"><div class="gh gi ms"><img src="../Images/c1ca58c2802873c4b60b132a477cdacb.png" data-original-src="https://miro.medium.com/v2/resize:fit:918/format:webp/0*qWDuUY5w3MwuUQY8.png"/></div></figure><p id="543d" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">边缘存储模型:</p><figure class="mo mp mq mr gt jr gh gi paragraph-image"><div class="gh gi mt"><img src="../Images/9f64a875f7c6947ea64f7b3131d446e0.png" data-original-src="https://miro.medium.com/v2/resize:fit:926/format:webp/0*yVsmG_uknbHjoTED.png"/></div></figure><p id="5f62" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">时间戳用作实时数据的版本控制方法。手动指定导入数据的版本。在实践中，团队有三个版本控制选项。第一个是reverse_versions，其中的版本列表是为了回滚而保存的。第二个是active_version，用户请求访问该版本。最后是max_version，在某个版本之后数据被反转。反向数据是历史数据和实时数据的结合。</p><p id="18a9" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">使用这三个选项，团队可以有效地管理离线和在线数据。下次压缩时，不再使用的数据将从磁盘中清除。这样，应用程序无需在后台就可以更新数据版本。数据回滚可以在几秒钟内完成。</p><p id="500d" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">以下是一些例子:</p><ul class=""><li id="31eb" class="kw kx iq ka b kb kc kf kg kj ky kn kz kr la kv lb lc ld le bi translated">保留三个版本的数据并激活其中一个</li></ul><p id="5a29" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><code class="fe mu mv mw mx b">alter edge friend reserve_versions = 1 2 3 active_version = 1</code></p><ul class=""><li id="e18f" class="kw kx iq ka b kb kc kf kg kj ky kn kz kr la kv lb lc ld le bi translated">数据来源是历史数据和实时书面数据</li></ul><p id="ef6e" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><code class="fe mu mv mw mx b">alter edge friend max_version = 1592147484</code></p><h1 id="285c" class="ll lm iq bd ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi bi translated">快速完整数据导入</h1><p id="7c5d" class="pw-post-body-paragraph jy jz iq ka b kb mj kd ke kf mk kh ki kj ml kl km kn mm kp kq kr mn kt ku kv ij bi translated">进行大规模的数据导入是一种常见的做法。没有任何优化的导入请求不仅会影响生产中的请求，而且需要一天以上的时间才能完成。因此，提高进口速度成为迫切要求。SST摄取是实现快速导入的常用方法。微信团队采用了类似的东西。</p><p id="d0c2" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">该团队通过调度Spark任务离线生成SST文件。存储节点提取所需的数据，并将数据接收到图形数据库中。然后，可以通过版本控制请求访问最新的版本数据。导入过程需要几个小时才能完成，速度很快。并且它不影响对图形数据库的请求，因为计算主要是离线的。</p><h1 id="be61" class="ll lm iq bd ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi bi translated">共享-无</h1><p id="0c27" class="pw-post-body-paragraph jy jz iq ka b kb mj kd ke kf mk kh ki kj ml kl km kn mm kp kq kr mn kt ku kv ij bi translated">无共享架构是一种被广泛讨论的确保水平可伸缩性的方法。在实践中实现该架构需要编程技能。元缓存用<code class="fe mu mv mw mx b">shared_ptr</code>封装，并且被频繁访问，这使得它成为原子操作冲突的温床。为了实现无共享，微信团队将每个元缓存复制为一个本地线程。这个<a class="ae lk" href="https://github.com/vesoft-inc/nebula/pull/2165" rel="noopener ugc nofollow" target="_blank">拉动请求</a>提供了细节。</p><p id="abcd" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">实现图形数据库的利用是一个漫长的过程。这是一个在很大程度上通过克服障碍继续取得成功的过程。</p><h1 id="2c38" class="ll lm iq bd ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi bi translated">探索图形数据库？</h1><p id="01d7" class="pw-post-body-paragraph jy jz iq ka b kb mj kd ke kf mk kh ki kj ml kl km kn mm kp kq kr mn kt ku kv ij bi translated">查看<a class="ae lk" href="https://nebula-graph.io/" rel="noopener ugc nofollow" target="_blank"> <strong class="ka ir">星云图数据库</strong> </a>，加入<strong class="ka ir">开源</strong>社区，在<a class="ae lk" href="https://bit.ly/3SmvFu2" rel="noopener ugc nofollow" target="_blank"> Slack </a>发掘更多图形数据库的实际用例。</p></div></div>    
</body>
</html>