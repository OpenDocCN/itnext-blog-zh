<html>
<head>
<title>AWS Elastic Kubernetes Service: a cluster creation automation, part 2 — Ansible, eksctl</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">AWS弹性Kubernetes服务:集群创建自动化，第2部分— Ansible，eksctl</h1>
<blockquote>原文：<a href="https://itnext.io/aws-elastic-kubernetes-service-a-cluster-creation-automation-part-2-ansible-eksctl-9f9c5336fc1d?source=collection_archive---------4-----------------------#2020-05-01">https://itnext.io/aws-elastic-kubernetes-service-a-cluster-creation-automation-part-2-ansible-eksctl-9f9c5336fc1d?source=collection_archive---------4-----------------------#2020-05-01</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div class="gh gi jn"><img src="../Images/c5056cdb01c13a253e361f2910aa4119.png" data-original-src="https://miro.medium.com/v2/resize:fit:260/format:webp/0*oqilpishMydwiwU9.png"/></div></figure><p id="4f8c" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">第一部分— <a class="ae ks" href="https://rtfm.co.ua/en/aws-elastic-kubernetes-service-a-cluster-creation-automation-part-1-cloudformation/" rel="noopener ugc nofollow" target="_blank"> AWS Elastic Kubernetes服务:集群创建自动化，第1部分—云形成</a>。</p><p id="cdae" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">要提醒的是，整个想法是创建一个自动化流程来创建EKS集群:</p><ol class=""><li id="83fe" class="kt ku iq jw b jx jy kb kc kf kv kj kw kn kx kr ky kz la lb bi translated">Ansible使用<a class="ae ks" href="https://rtfm.co.ua/ansible-modul-cloudformation/" rel="noopener ugc nofollow" target="_blank"> cloudformation模块</a>创建一个基础设施</li><li id="aba1" class="kt ku iq jw b jx lc kb ld kf le kj lf kn lg kr ky kz la lb bi translated">通过使用CloudFormation堆栈的输出，模板中的Ansible将为<code class="fe lh li lj lk b">eksctl</code>生成一个集群配置文件</li><li id="6279" class="kt ku iq jw b jx lc kb ld kf le kj lf kn lg kr ky kz la lb bi translated">Ansible用这个配置文件调用<code class="fe lh li lj lk b">eksctl</code>来创建一个EKS集群</li></ol><p id="6317" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">所有这一切都将从一个詹金斯工作使用一个Docker图像与AWS命令行界面，Ansible和<code class="fe lh li lj lk b">eksctl</code>。也许这将是这个系列的第三部分。</p><p id="59dd" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">写完这篇文章后得到的所有文件都可以在<a class="ae ks" href="https://rtfm.co.ua/goto/https://github.com/setevoy2/eksctl-cf-ansible/tree/rdy" rel="noopener ugc nofollow" target="_blank"> eksctl-cf-ansible </a> Github存储库中找到。此处的链接指向一个分支，它与下面的代码完全相同。</p></div><div class="ab cl ll lm hu ln" role="separator"><span class="lo bw bk lp lq lr"/><span class="lo bw bk lp lq lr"/><span class="lo bw bk lp lq"/></div><div class="ij ik il im in"><p id="08f6" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated"><strong class="jw ir">内容</strong></p><ul class=""><li id="0397" class="kt ku iq jw b jx jy kb kc kf kv kj kw kn kx kr ls kz la lb bi translated"><a class="ae ks" href="https://rtfm.co.ua/en/aws-elastic-kubernetes-service-a-cluster-creation-automation-part-2-ansible-eksctl/#AWS_Authentification" rel="noopener ugc nofollow" target="_blank"> AWS认证</a></li><li id="08b4" class="kt ku iq jw b jx lc kb ld kf le kj lf kn lg kr ls kz la lb bi translated"><a class="ae ks" href="https://rtfm.co.ua/en/aws-elastic-kubernetes-service-a-cluster-creation-automation-part-2-ansible-eksctl/#Ansible_CloudFormation" rel="noopener ugc nofollow" target="_blank">不稳定的云形成</a></li><li id="f132" class="kt ku iq jw b jx lc kb ld kf le kj lf kn lg kr ls kz la lb bi translated"><a class="ae ks" href="https://rtfm.co.ua/en/aws-elastic-kubernetes-service-a-cluster-creation-automation-part-2-ansible-eksctl/#CloudFormation_Parameters_and_Ansible_variables" rel="noopener ugc nofollow" target="_blank">云形成参数和变量</a></li><li id="2fb3" class="kt ku iq jw b jx lc kb ld kf le kj lf kn lg kr ls kz la lb bi translated"><a class="ae ks" href="https://rtfm.co.ua/en/aws-elastic-kubernetes-service-a-cluster-creation-automation-part-2-ansible-eksctl/#The_CloudFormation_role" rel="noopener ugc nofollow" target="_blank">造云作用</a></li><li id="4e1e" class="kt ku iq jw b jx lc kb ld kf le kj lf kn lg kr ls kz la lb bi translated"><a class="ae ks" href="https://rtfm.co.ua/en/aws-elastic-kubernetes-service-a-cluster-creation-automation-part-2-ansible-eksctl/#Ansible_eksctl" rel="noopener ugc nofollow" target="_blank"> Ansible eksctl </a></li><li id="330d" class="kt ku iq jw b jx lc kb ld kf le kj lf kn lg kr ls kz la lb bi translated"><a class="ae ks" href="https://rtfm.co.ua/en/aws-elastic-kubernetes-service-a-cluster-creation-automation-part-2-ansible-eksctl/#Cluster_config_%E2%80%93_eksclusterconfig_yml" rel="noopener ugc nofollow" target="_blank">集群配置— eks-cluster-config.yml </a></li><li id="597d" class="kt ku iq jw b jx lc kb ld kf le kj lf kn lg kr ls kz la lb bi translated"><a class="ae ks" href="https://rtfm.co.ua/en/aws-elastic-kubernetes-service-a-cluster-creation-automation-part-2-ansible-eksctl/#eksctl_create_vs_update" rel="noopener ugc nofollow" target="_blank"> eksctl创建与更新</a></li><li id="e02a" class="kt ku iq jw b jx lc kb ld kf le kj lf kn lg kr ls kz la lb bi translated"><a class="ae ks" href="https://rtfm.co.ua/en/aws-elastic-kubernetes-service-a-cluster-creation-automation-part-2-ansible-eksctl/#TEST_CloudFormation_EKS_Custom_parameters" rel="noopener ugc nofollow" target="_blank">测试:CloudFormation &amp; &amp; EKS自定义参数</a></li><li id="56a6" class="kt ku iq jw b jx lc kb ld kf le kj lf kn lg kr ls kz la lb bi translated"><a class="ae ks" href="https://rtfm.co.ua/en/aws-elastic-kubernetes-service-a-cluster-creation-automation-part-2-ansible-eksctl/#P_S_awsauth_ConfigMap" rel="noopener ugc nofollow" target="_blank"> P.S. aws-auth配置图</a></li><li id="b04b" class="kt ku iq jw b jx lc kb ld kf le kj lf kn lg kr ls kz la lb bi translated"><a class="ae ks" href="https://rtfm.co.ua/en/aws-elastic-kubernetes-service-a-cluster-creation-automation-part-2-ansible-eksctl/#Useful_links" rel="noopener ugc nofollow" target="_blank">有用的链接</a></li><li id="0547" class="kt ku iq jw b jx lc kb ld kf le kj lf kn lg kr ls kz la lb bi translated"><a class="ae ks" href="https://rtfm.co.ua/en/aws-elastic-kubernetes-service-a-cluster-creation-automation-part-2-ansible-eksctl/#Kubernetes" rel="noopener ugc nofollow" target="_blank"> Kubernetes </a></li><li id="cbc6" class="kt ku iq jw b jx lc kb ld kf le kj lf kn lg kr ls kz la lb bi translated"><a class="ae ks" href="https://rtfm.co.ua/en/aws-elastic-kubernetes-service-a-cluster-creation-automation-part-2-ansible-eksctl/#Ansible" rel="noopener ugc nofollow" target="_blank">可回答的</a></li><li id="e2cc" class="kt ku iq jw b jx lc kb ld kf le kj lf kn lg kr ls kz la lb bi translated"><a class="ae ks" href="https://rtfm.co.ua/en/aws-elastic-kubernetes-service-a-cluster-creation-automation-part-2-ansible-eksctl/#AWS" rel="noopener ugc nofollow" target="_blank"> AWS </a></li><li id="db85" class="kt ku iq jw b jx lc kb ld kf le kj lf kn lg kr ls kz la lb bi translated"><a class="ae ks" href="https://rtfm.co.ua/en/aws-elastic-kubernetes-service-a-cluster-creation-automation-part-2-ansible-eksctl/#EKS" rel="noopener ugc nofollow" target="_blank"> EKS </a></li><li id="3bf5" class="kt ku iq jw b jx lc kb ld kf le kj lf kn lg kr ls kz la lb bi translated"><a class="ae ks" href="https://rtfm.co.ua/en/aws-elastic-kubernetes-service-a-cluster-creation-automation-part-2-ansible-eksctl/#CloudFormation" rel="noopener ugc nofollow" target="_blank">云形成</a></li></ul></div><div class="ab cl ll lm hu ln" role="separator"><span class="lo bw bk lp lq lr"/><span class="lo bw bk lp lq lr"/><span class="lo bw bk lp lq"/></div><div class="ij ik il im in"><h2 id="be97" class="lt lu iq bd lv lw lx dn ly lz ma dp mb kf mc md me kj mf mg mh kn mi mj mk ml bi translated">AWS认证</h2><p id="6b3a" class="pw-post-body-paragraph ju jv iq jw b jx mm jz ka kb mn kd ke kf mo kh ki kj mp kl km kn mq kp kq kr ij bi translated">有必要事先考虑一下认证，不要从头开始改造一切(我就是这么做的)。</p><p id="779b" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">此外，强烈推荐阅读<a class="ae ks" href="https://rtfm.co.ua/en/kubernetes-part-4-aws-eks-authentification-aws-iam-authenticator-and-aws-iam/" rel="noopener ugc nofollow" target="_blank"> Kubernetes:第4部分— AWS EKS认证、aws-iam-authenticator和AWS IAM </a>帖子，因为在当前的帖子中会用到很多在那里描述的东西。</p><p id="85bb" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">因此，我们需要一些AWS身份验证机制，因为我们需要进行身份验证:</p><ul class=""><li id="b9b9" class="kt ku iq jw b jx jy kb kc kf kv kj kw kn kx kr ls kz la lb bi translated">对其在云形成中的T21作用负责</li><li id="0cdb" class="kt ku iq jw b jx lc kb ld kf le kj lf kn lg kr ls kz la lb bi translated">负责eksctl的角色</li><li id="f686" class="kt ku iq jw b jx lc kb ld kf le kj lf kn lg kr ls kz la lb bi translated">能够执行AWS CLI命令</li></ul><p id="e744" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">这里最不明显的问题是，用于创建EKS集群的IAM用户变成了它的“超级管理员”,您不能更改它。</p><p id="3bfd" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">例如，在上一部分中，我们使用以下命令创建了集群:</p><pre class="ms mt mu mv gt mw lk mx my aw mz bi"><span id="0ae7" class="lt lu iq lk b gy na nb l nc nd">$ eksctl --profile arseniy create cluster -f eks-cluster-config.yml</span></pre><p id="b1c9" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">现在，您可以检查CloudWatch中的认证器日志，那里的第一个条目——您将看到来自具有<code class="fe lh li lj lk b">kubernetes-admin</code>权限的<code class="fe lh li lj lk b">system:masters</code>组的root-suer:</p><figure class="ms mt mu mv gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="nf ng di nh bf ni"><div class="gh gi ne"><img src="../Images/80fc4bcb0250bbc5fb16b8f810ad4c1a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*YZ7_BGH54gjhoSs9.png"/></div></div></figure><p id="01ed" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">那么，我们可以用什么来进行AWS认证呢？？</p><ol class=""><li id="12ea" class="kt ku iq jw b jx jy kb kc kf kv kj kw kn kx kr ky kz la lb bi translated">访问密钥— AWS_ACCESS_KEY_ID和AWS_SECRET_ACCESS_KEY</li><li id="b50b" class="kt ku iq jw b jx lc kb ld kf le kj lf kn lg kr ky kz la lb bi translated"><a class="ae ks" href="https://rtfm.co.ua/en/aws-cli-named-profiles/" rel="noopener ugc nofollow" target="_blank"> AWS CLI命名配置文件</a></li><li id="a5b6" class="kt ku iq jw b jx lc kb ld kf le kj lf kn lg kr ky kz la lb bi translated"><a class="ae ks" href="https://rtfm.co.ua/en/aws-iam-users-keys-rotation-ec2-iam-roles-and-jenkins/" rel="noopener ugc nofollow" target="_blank"> AWS IAM EC2实例概要</a>(另见<a class="ae ks" href="https://rtfm.co.ua/aws-iam-assumerole-opisanie-primery/" rel="noopener ugc nofollow" target="_blank"> AWS: IAM AssumeRole — описание，примеры </a>，<em class="mr"> Rus </em>)</li></ol><p id="9530" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">但是由于我们将在这里使用Jenkins我们可以使用它的IAM EC2实例角色和必要的权限。</p><p id="df25" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">现在，我实现了下一个计划:</p><ul class=""><li id="2d08" class="kt ku iq jw b jx jy kb kc kf kv kj kw kn kx kr ls kz la lb bi translated">使用eks管理策略手动创建名为<em class="mr"> eks-root </em>的IAM用户</li><li id="cd85" class="kt ku iq jw b jx lc kb ld kf le kj lf kn lg kr ls kz la lb bi translated">Jenkins将使用其IAM实例角色和EKS管理策略创建必要的资源，并将成为AWS帐户中所有EKS集群的“超级管理员”</li><li id="5da5" class="kt ku iq jw b jx lc kb ld kf le kj lf kn lg kr ls kz la lb bi translated">在Ansible中，我们将添加<code class="fe lh li lj lk b">eksctl create iamidentitymapping</code>(参见<a class="ae ks" href="https://eksctl.io/usage/iam-identity-mappings/" rel="noopener ugc nofollow" target="_blank">管理IAM用户和角色</a>)来添加其他用户。</li></ul><p id="c303" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">现在查看<em class="mr">AWS-auth</em>T3:</p><pre class="ms mt mu mv gt mw lk mx my aw mz bi"><span id="b393" class="lt lu iq lk b gy na nb l nc nd">$ eksctl --profile arseniy --region eu-west-2 get iamidentitymapping --cluster eks-dev<br/>ARN USERNAME GROUPS<br/>arn:aws:iam::534***385:role/eksctl-eks-dev-nodegroup-worker-n-NodeInstanceRole-UNGXZXVBL3ZP system:node:{{EC2PrivateDNSName}} system:bootstrappers,system:nodes</span></pre><p id="1ed4" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">或者用这个:</p><pre class="ms mt mu mv gt mw lk mx my aw mz bi"><span id="16dc" class="lt lu iq lk b gy na nb l nc nd">$ kubectl -n kube-system get cm aws-auth -o yaml<br/>apiVersion: v1<br/>data:<br/>mapRoles: |<br/>- groups:<br/>- system:bootstrappers<br/>- system:nodes<br/>rolearn: arn:aws:iam::534***385:role/eksctl-eks-dev-nodegroup-worker-n-NodeInstanceRole-UNGXZXVBL3ZP<br/>username: system:node:{{EC2PrivateDNSName}}<br/>mapUsers: |<br/>[]<br/>kind: ConfigMap<br/>…</span></pre><p id="3e71" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">现在让我们手动执行所有操作，以避免在自动化创建过程中出现意外:</p><ol class=""><li id="5f3b" class="kt ku iq jw b jx jy kb kc kf kv kj kw kn kx kr ky kz la lb bi translated">创建IAM用户</li><li id="1be6" class="kt ku iq jw b jx lc kb ld kf le kj lf kn lg kr ky kz la lb bi translated">创建“EKS管理”策略</li><li id="683c" class="kt ku iq jw b jx lc kb ld kf le kj lf kn lg kr ky kz la lb bi translated">将此策略附加到此用户</li><li id="a438" class="kt ku iq jw b jx lc kb ld kf le kj lf kn lg kr ky kz la lb bi translated">使用此用户配置本地AWS CLI配置文件</li><li id="42d2" class="kt ku iq jw b jx lc kb ld kf le kj lf kn lg kr ky kz la lb bi translated">为此AWS CLI配置文件配置本地<code class="fe lh li lj lk b">kubectl</code></li><li id="450a" class="kt ku iq jw b jx lc kb ld kf le kj lf kn lg kr ky kz la lb bi translated">执行<code class="fe lh li lj lk b">eksctl create iamidentitymapping</code></li><li id="f861" class="kt ku iq jw b jx lc kb ld kf le kj lf kn lg kr ky kz la lb bi translated">执行<code class="fe lh li lj lk b">kubectl get nodes</code>检查访问</li></ol><p id="448f" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">继续—创建用户:</p><pre class="ms mt mu mv gt mw lk mx my aw mz bi"><span id="d92a" class="lt lu iq lk b gy na nb l nc nd">$ aws --profile arseniy --region eu-west-2 iam create-user --user-name eks-root<br/>{<br/>“User”: {<br/>“Path”: “/”,<br/>“UserName”: “eks-root”,<br/>“UserId”: “AID***PSA”,<br/>“Arn”: “arn:aws:iam::534***385:user/eks-root”,<br/>“CreateDate”: “2020–03–30T12:24:28Z”<br/>}<br/>}</span></pre><p id="ea92" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">他的访问密钥:</p><pre class="ms mt mu mv gt mw lk mx my aw mz bi"><span id="709c" class="lt lu iq lk b gy na nb l nc nd">$ aws --profile arseniy --region eu-west-2 iam create-access-key --user-name eks-root<br/>{<br/>“AccessKey”: {<br/>“UserName”: “eks-root”,<br/>“AccessKeyId”: “AKI****45Y”,<br/>“Status”: “Active”,<br/>“SecretAccessKey”: “Qrr***xIT”,<br/>“CreateDate”: “2020–03–30T12:27:28Z”<br/>}<br/>}</span></pre><p id="426c" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">配置本地AWS CLI配置文件:</p><pre class="ms mt mu mv gt mw lk mx my aw mz bi"><span id="8557" class="lt lu iq lk b gy na nb l nc nd">$ aws configure --profile eks-root<br/>AWS Access Key ID [None]: AKI***45Y<br/>AWS Secret Access Key [None]: Qrr***xIT<br/>Default region name [None]: eu-west-2<br/>Default output format [None]: json</span></pre><p id="5955" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">立即尝试访问—必须被拒绝:</p><pre class="ms mt mu mv gt mw lk mx my aw mz bi"><span id="6218" class="lt lu iq lk b gy na nb l nc nd">$ aws --profile eks-roo eks list-clusters<br/>An error occurred (AccessDeniedException) when calling the ListClusters operation […]</span></pre><p id="f9ab" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">创建一个策略，下面是一些<a class="ae ks" href="https://docs.aws.amazon.com/eks/latest/userguide/security_iam_id-based-policy-examples.html" rel="noopener ugc nofollow" target="_blank">的例子&gt; &gt; &gt; </a>(以后可以作为嵌套栈添加到CloudFormation栈中，同样的，SecurityGroups也会被管理)，保存到一个专用文件<code class="fe lh li lj lk b">../../cloudformation/files/eks-root-policy.json</code>:</p><pre class="ms mt mu mv gt mw lk mx my aw mz bi"><span id="a491" class="lt lu iq lk b gy na nb l nc nd">{<br/>    "Version": "2012-10-17",<br/>    "Statement": [<br/>        {<br/>            "Effect": "Allow",<br/>            "Action": [<br/>                "eks:*"<br/>            ],<br/>            "Resource": "*"<br/>        }<br/>    ]<br/>}</span></pre><p id="fc00" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">将此策略添加到AWS IAM:</p><pre class="ms mt mu mv gt mw lk mx my aw mz bi"><span id="d311" class="lt lu iq lk b gy na nb l nc nd">$ aws --profile arseniy --region eu-west-2 iam create-policy --policy-name eks-root-policy --policy-document file://../../cloudformation/files/eks-root-policy.json<br/>{<br/>“Policy”: {<br/>“PolicyName”: “eks-root-policy”,<br/>“PolicyId”: “ANPAXY5JMBMEROIOD22GM”,<br/>“Arn”: “arn:aws:iam::534***385:policy/eks-root-policy”,<br/>“Path”: “/”,<br/>“DefaultVersionId”: “v1”,<br/>“AttachmentCount”: 0,<br/>“PermissionsBoundaryUsageCount”: 0,<br/>“IsAttachable”: true,<br/>“CreateDate”: “2020–03–30T12:44:58Z”,<br/>“UpdateDate”: “2020–03–30T12:44:58Z”<br/>}<br/>}</span></pre><p id="4ab5" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">将策略附加到上面创建的用户:</p><pre class="ms mt mu mv gt mw lk mx my aw mz bi"><span id="8b3b" class="lt lu iq lk b gy na nb l nc nd">$ aws --profile arseniy --region eu-west-2 iam attach-user-policy --user-name eks-root --policy-arn arn:aws:iam::534***385:policy/eks-root-policy</span></pre><p id="fbc6" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">检查:</p><pre class="ms mt mu mv gt mw lk mx my aw mz bi"><span id="e982" class="lt lu iq lk b gy na nb l nc nd">$ aws --profile arseniy --region eu-west-2 iam list-attached-user-policies --user-name eks-root --output text<br/>ATTACHEDPOLICIES arn:aws:iam::534***385:policy/eks-root-policy eks-root-policy</span></pre><p id="3811" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">再次尝试访问:</p><pre class="ms mt mu mv gt mw lk mx my aw mz bi"><span id="1e4d" class="lt lu iq lk b gy na nb l nc nd">$ aws --profile eks-root --region eu-west-2 eks list-clusters --output text<br/>CLUSTERS eks-dev</span></pre><p id="dcb0" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">在另一个地区:</p><pre class="ms mt mu mv gt mw lk mx my aw mz bi"><span id="b68d" class="lt lu iq lk b gy na nb l nc nd">$ aws --profile eks-root --region us-east-2 eks list-clusters --output text<br/>CLUSTERS eksctl-bttrm-eks-production-1<br/>CLUSTERS mobilebackend-dev-eks-0-cluster</span></pre><p id="e56b" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">接下来的任务最好在一个完全没有配置访问权限的机器上完成，例如，从RTFM博客的服务器上:-)</p><p id="ba2e" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">安装AWS CLI:</p><pre class="ms mt mu mv gt mw lk mx my aw mz bi"><span id="f9a1" class="lt lu iq lk b gy na nb l nc nd">root@rtfm-do-production:/home/setevoy# pip install awscli</span></pre><p id="3c1b" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">配置默认配置文件:</p><pre class="ms mt mu mv gt mw lk mx my aw mz bi"><span id="efb7" class="lt lu iq lk b gy na nb l nc nd">root@rtfm-do-production:/home/setevoy# aws configure</span></pre><p id="7a67" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">检查对AWS EKS的一般访问——在我们的IAM策略中，我们已经授予了对<code class="fe lh li lj lk b"><a class="ae ks" href="https://docs.aws.amazon.com/eks/latest/APIReference/API_ListClusters.html" rel="noopener ugc nofollow" target="_blank">eks:ListClusters</a></code> API调用的权限，因此它必须正常工作:</p><pre class="ms mt mu mv gt mw lk mx my aw mz bi"><span id="ddad" class="lt lu iq lk b gy na nb l nc nd">root@rtfm-do-production:/home/setevoy# aws eks list-clusters — output text<br/>CLUSTERS eks-dev</span></pre><p id="80e4" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">好吧。</p><p id="25d7" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">安装<code class="fe lh li lj lk b">eksctl</code>:</p><pre class="ms mt mu mv gt mw lk mx my aw mz bi"><span id="1ad6" class="lt lu iq lk b gy na nb l nc nd">root@rtfm-do-production:/home/setevoy# curl --silent --location “https://github.com/weaveworks/eksctl/releases/latest/download/eksctl_$(uname -s)_amd64.tar.gz” | tar xz -C /tmp<br/>root@rtfm-do-production:/home/setevoy# mv /tmp/eksctl /usr/local/bin</span></pre><p id="8213" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">重复<code class="fe lh li lj lk b">eks:ListClusters</code> -也必须工作，因为<code class="fe lh li lj lk b">eksctl</code>将使用上面配置的<em class="mr">默认</em> AWS CLI配置文件:</p><pre class="ms mt mu mv gt mw lk mx my aw mz bi"><span id="7a80" class="lt lu iq lk b gy na nb l nc nd">root@rtfm-do-production:/home/setevoy# eksctl get cluster<br/>NAME REGION<br/>eks-dev eu-west-2</span></pre><p id="d927" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">安装<code class="fe lh li lj lk b">kubectl</code>:</p><pre class="ms mt mu mv gt mw lk mx my aw mz bi"><span id="681f" class="lt lu iq lk b gy na nb l nc nd">root@rtfm-do-production:/home/setevoy# curl -LO <a class="ae ks" href="https://storage.googleapis.com/kubernetes-release/release/`curl" rel="noopener ugc nofollow" target="_blank">https://storage.googleapis.com/kubernetes-release/release/`curl</a> -s <a class="ae ks" href="https://storage.googleapis.com/kubernetes-release/release/stable.txt`/bin/linux/amd64/kubectl" rel="noopener ugc nofollow" target="_blank">https://storage.googleapis.com/kubernetes-release/release/stable.txt`/bin/linux/amd64/kubectl</a></span><span id="6094" class="lt lu iq lk b gy nj nb l nc nd">root@rtfm-do-production:/home/setevoy# chmod +x ./kubectl</span><span id="046c" class="lt lu iq lk b gy nj nb l nc nd">root@rtfm-do-production:/home/setevoy# mv ./kubectl /usr/local/bin/kubectl</span></pre><p id="bd03" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">安装<code class="fe lh li lj lk b">aws-iam-authenticator</code>让<code class="fe lh li lj lk b">kubectl</code>在AWS中执行认证:</p><pre class="ms mt mu mv gt mw lk mx my aw mz bi"><span id="37e3" class="lt lu iq lk b gy na nb l nc nd">root@rtfm-do-production:/home/setevoy# curl -o aws-iam-authenticator <a class="ae ks" href="https://amazon-eks.s3.us-west-2.amazonaws.com/1.15.10/2020-02-22/bin/linux/amd64/aws-iam-authenticator" rel="noopener ugc nofollow" target="_blank">https://amazon-eks.s3.us-west-2.amazonaws.com/1.15.10/2020-02-22/bin/linux/amd64/aws-iam-authenticator</a></span><span id="4655" class="lt lu iq lk b gy nj nb l nc nd">root@rtfm-do-production:/home/setevoy# chmod +x ./aws-iam-authenticator</span><span id="3d55" class="lt lu iq lk b gy nj nb l nc nd">root@rtfm-do-production:/home/setevoy# mv aws-iam-authenticator /usr/local/bin/</span></pre><p id="98b6" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">配置kubectl:</p><pre class="ms mt mu mv gt mw lk mx my aw mz bi"><span id="e124" class="lt lu iq lk b gy na nb l nc nd">root@rtfm-do-production:/home/setevoy# aws eks update-kubeconfig --name eks-dev<br/>Updated context arn:aws:eks:eu-west-2:534***385:cluster/eks-dev in /root/.kube/config</span></pre><p id="8d4f" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">尝试在群集上执行命令—肯定是授权错误:</p><pre class="ms mt mu mv gt mw lk mx my aw mz bi"><span id="4934" class="lt lu iq lk b gy na nb l nc nd">root@rtfm-do-production:/home/setevoy# kubectl get nodes<br/>error: You must be logged in to the server (Unauthorized)</span><span id="ea1b" class="lt lu iq lk b gy nj nb l nc nd">root@rtfm-do-production:/home/setevoy# kubectl get pod<br/>error: You must be logged in to the server (Unauthorized)</span></pre><p id="20f6" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">回到工作PC，将<em class="mr"> eks-root </em>用户添加到<em class="mr"> aws-auth </em> <code class="fe lh li lj lk b">ConfigMap</code>:</p><pre class="ms mt mu mv gt mw lk mx my aw mz bi"><span id="1ba9" class="lt lu iq lk b gy na nb l nc nd">$ eksctl --profile arseniy --region eu-west-2 create iamidentitymapping --cluster eks-dev --arn arn:aws:iam::534***385:user/eks-root --group system:masters --username eks-root<br/>[ℹ] eksctl version 0.16.0<br/>[ℹ] using region eu-west-2<br/>[ℹ] adding identity “arn:aws:iam::534***385:user/eks-root” to auth ConfigMap</span></pre><p id="e82b" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">检查一下:</p><pre class="ms mt mu mv gt mw lk mx my aw mz bi"><span id="4bda" class="lt lu iq lk b gy na nb l nc nd">$ eksctl --profile arseniy --region eu-west-2 get iamidentitymapping --cluster eks-dev<br/>ARN USERNAME GROUPS<br/>arn:aws:iam::534***385:role/eksctl-eks-dev-nodegroup-worker-n-NodeInstanceRole-UNGXZXVBL3ZP system:node:{{EC2PrivateDNSName}} system:bootstrappers,system:nodes<br/>arn:aws:iam::534***385:user/eks-root eks-root system:masters</span></pre><p id="5127" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">回到测试主机并再次尝试访问:</p><pre class="ms mt mu mv gt mw lk mx my aw mz bi"><span id="ec31" class="lt lu iq lk b gy na nb l nc nd">root@rtfm-do-production:/home/setevoy# kubectl get node<br/>NAME STATUS ROLES AGE VERSION<br/>ip-10–0–40–30.eu-west-2.compute.internal Ready &lt;none&gt; 133m v1.15.10-eks-bac369<br/>ip-10–0–63–187.eu-west-2.compute.internal Ready &lt;none&gt; 133m v1.15.10-eks-bac369</span></pre><p id="14b2" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">再来看看别的，同样以<em class="mr">AWS-auth</em>T8】为例:</p><pre class="ms mt mu mv gt mw lk mx my aw mz bi"><span id="d1db" class="lt lu iq lk b gy na nb l nc nd">root@rtfm-do-production:/home/setevoy# kubectl -n kube-system get cm aws-auth -o yaml<br/>apiVersion: v1<br/>data:<br/>mapRoles: |<br/>- groups:<br/>- system:bootstrappers<br/>- system:nodes<br/>rolearn: arn:aws:iam::534***385:role/eksctl-eks-dev-nodegroup-worker-n-NodeInstanceRole-UNGXZXVBL3ZP<br/>username: system:node:{{EC2PrivateDNSName}}<br/>mapUsers: |<br/>- groups:- system:masters<br/>userarn: arn:aws:iam::534***385:user/eks-root<br/>username: eks-root<br/>kind: ConfigMap<br/>…</span></pre><p id="2db3" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">添加了我们用户的<code class="fe lh li lj lk b">mapUsers</code>——这里一切都好。</p><p id="1bb4" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">稍后我们可以使用这个<em class="mr"> aws-auth </em>来添加新用户，或者将任务添加到Ansible来执行<code class="fe lh li lj lk b">eksctl create iamidentitymapping</code>，或者我们可以生成自己的<code class="fe lh li lj lk b">ConfigMap</code>并上传到EKS。</p><p id="592a" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">我将从我们的詹金斯主机继续执行任务，因为我们在任何地方都有<code class="fe lh li lj lk b"><a class="ae ks" href="https://rtfm.co.ua/vim-prevrashhaem-redaktor-v-ide-plaginy-i-vot-eto-vot-vsyo/" rel="noopener ugc nofollow" target="_blank">vim</a></code>可用。</p><h2 id="bf68" class="lt lu iq bd lv lw lx dn ly lz ma dp mb kf mc md me kj mf mg mh kn mi mj mk ml bi translated">易变云形成</h2><h2 id="ad8a" class="lt lu iq bd lv lw lx dn ly lz ma dp mb kf mc md me kj mf mg mh kn mi mj mk ml bi translated">云形成参数和可变变量</h2><p id="93c7" class="pw-post-body-paragraph ju jv iq jw b jx mm jz ka kb mn kd ke kf mo kh ki kj mp kl km kn mq kp kq kr ij bi translated">在开始以下任务之前，让我们考虑一下上一部分中CloudFormation堆栈中使用的参数，以及我们需要在Ansible中包含什么。</p><p id="f71b" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">首先想到的是act，我们将为QA团队提供<em class="mr">开发</em>、<em class="mr">阶段</em>、<em class="mr">生产</em>集群+动态(让他们能够从Jenkins作业创建专用的定制集群来测试某些东西)，因此参数必须足够灵活，以便在任何地区使用任何VPC网络创建堆栈。</p><p id="1b6d" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">因此，我们将拥有:</p><ul class=""><li id="7926" class="kt ku iq jw b jx jy kb kc kf kv kj kw kn kx kr ls kz la lb bi translated">所有的通用参数:</li><li id="9f4a" class="kt ku iq jw b jx lc kb ld kf le kj lf kn lg kr ls kz la lb bi translated">地区</li><li id="6f9e" class="kt ku iq jw b jx lc kb ld kf le kj lf kn lg kr ls kz la lb bi translated">AWS访问/机密(或<a class="ae ks" href="https://rtfm.co.ua/aws-rotaciya-klyuchej-iam-polzovatelej-ec2-iam-roles-i-jenkins/" rel="noopener ugc nofollow" target="_blank"> IAM EC2实例配置文件</a>)</li><li id="01a6" class="kt ku iq jw b jx lc kb ld kf le kj lf kn lg kr ls kz la lb bi translated">环境的专用参数:</li><li id="4302" class="kt ku iq jw b jx lc kb ld kf le kj lf kn lg kr ls kz la lb bi translated">环境(发展、阶段、生产)</li><li id="e384" class="kt ku iq jw b jx lc kb ld kf le kj lf kn lg kr ls kz la lb bi translated">VPC·CIDR(10 . 0 . 0 . 0/16、10.1.0.0/16等)</li><li id="71ac" class="kt ku iq jw b jx lc kb ld kf le kj lf kn lg kr ls kz la lb bi translated">Kubernetes工作节点访问的SSH密钥</li><li id="4512" class="kt ku iq jw b jx lc kb ld kf le kj lf kn lg kr ls kz la lb bi translated">用于Kubernetes工作节点的AWSес2实例类型(t3.nano、c5.9xlarge等)</li></ul><p id="829a" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">特别值得注意的是栈和簇的命名。</p><p id="03cf" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">因此，我们将为在Ansible行动手册和角色中“全局”使用的名称，以及我们稍后将在AWS控制台中看到的名称:</p><ol class=""><li id="f959" class="kt ku iq jw b jx jy kb kc kf kv kj kw kn kx kr ky kz la lb bi translated">一个环境名— <em class="mr"> dev </em>，<em class="mr"> stage </em>，<em class="mr"> prod </em></li><li id="b75a" class="kt ku iq jw b jx lc kb ld kf le kj lf kn lg kr ky kz la lb bi translated">我们从<em class="mr"> cloudformation </em>角色创建的cloudformation堆栈名称(根堆栈及其嵌套堆栈)</li><li id="87e6" class="kt ku iq jw b jx lc kb ld kf le kj lf kn lg kr ky kz la lb bi translated">创建集群及其WorkerNodes堆栈时由<code class="fe lh li lj lk b">eksctl</code>创建的CloudFromation堆栈名称</li><li id="4a11" class="kt ku iq jw b jx lc kb ld kf le kj lf kn lg kr ky kz la lb bi translated">和一个EKS集群名</li></ol><p id="b014" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated"><code class="fe lh li lj lk b">eksctl</code>当然，会在幕后做一些事情，会给这里的名字附加一些前缀——后缀。</p><p id="dd29" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">例如，在为EKS集群本身创建堆栈时，它将为其CloudFormation堆栈名称添加<em class="mr"> eksctl- </em>前缀，并将添加<em class="mr"> -cluster </em>后缀，对于其WokerNodes堆栈，将使用集群配置文件中的前缀<em class="mr"> eksctl- </em>和后缀<em class="mr">-node group</em>+worker nodes组的名称。</p><p id="477c" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">但是，集群本身的命名将与我们在<code class="fe lh li lj lk b">eks-cluster-config.yml</code>中设置的完全一样。</p><p id="2ed5" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">所以，让我们一起抓住——我们将使用哪些变量:</p><ul class=""><li id="5df3" class="kt ku iq jw b jx jy kb kc kf kv kj kw kn kx kr ls kz la lb bi translated"><code class="fe lh li lj lk b">env</code>:</li><li id="a8d5" class="kt ku iq jw b jx lc kb ld kf le kj lf kn lg kr ls kz la lb bi translated">格式:字符串"<em class="mr"> dev </em>"</li><li id="81b9" class="kt ku iq jw b jx lc kb ld kf le kj lf kn lg kr ls kz la lb bi translated">描述:用于组合其他变量的值</li><li id="216f" class="kt ku iq jw b jx lc kb ld kf le kj lf kn lg kr ls kz la lb bi translated">结果:<em class="mr">开发</em></li><li id="6a36" class="kt ku iq jw b jx lc kb ld kf le kj lf kn lg kr ls kz la lb bi translated"><code class="fe lh li lj lk b">eks_cluster_name</code>:</li><li id="63af" class="kt ku iq jw b jx lc kb ld kf le kj lf kn lg kr ls kz la lb bi translated">格式:<code class="fe lh li lj lk b">bttrm-eks-${env}</code></li><li id="834d" class="kt ku iq jw b jx lc kb ld kf le kj lf kn lg kr ls kz la lb bi translated">描述:将设置<code class="fe lh li lj lk b">eks-cluster-config.yml</code> cluster-config中的<code class="fe lh li lj lk b">metadata: name:</code>,用于为其他变量和CloudFormation标签合成值</li><li id="d6d6" class="kt ku iq jw b jx lc kb ld kf le kj lf kn lg kr ls kz la lb bi translated">结果:<em class="mr"> bttrm-eks-dev </em></li><li id="8f05" class="kt ku iq jw b jx lc kb ld kf le kj lf kn lg kr ls kz la lb bi translated"><code class="fe lh li lj lk b">cf_stack_name</code>:</li><li id="bdc1" class="kt ku iq jw b jx lc kb ld kf le kj lf kn lg kr ls kz la lb bi translated">格式:<code class="fe lh li lj lk b">eksctl-${eks_cluster_name}-stack</code></li><li id="82f7" class="kt ku iq jw b jx lc kb ld kf le kj lf kn lg kr ls kz la lb bi translated">描述:使用- <em class="mr">堆栈</em>我们注意到这里只包含AWS相关资源，没有EKS</li><li id="b73d" class="kt ku iq jw b jx lc kb ld kf le kj lf kn lg kr ls kz la lb bi translated">结果:<code class="fe lh li lj lk b">eksctl-bttrm-eks-dev-stack</code></li><li id="5439" class="kt ku iq jw b jx lc kb ld kf le kj lf kn lg kr ls kz la lb bi translated">【自动】(T11):</li><li id="9228" class="kt ku iq jw b jx lc kb ld kf le kj lf kn lg kr ls kz la lb bi translated">格式:<code class="fe lh li lj lk b">eksctl-${cluster_name}-cluster</code></li><li id="b25e" class="kt ku iq jw b jx lc kb ld kf le kj lf kn lg kr ls kz la lb bi translated">描述:将由<code class="fe lh li lj lk b">eksctl</code>自己创建一个CloudFormation堆栈，记住这一点</li><li id="318d" class="kt ku iq jw b jx lc kb ld kf le kj lf kn lg kr ls kz la lb bi translated">结果:<code class="fe lh li lj lk b">eksctl-bttrm-eks-dev-cluster</code></li><li id="5865" class="kt ku iq jw b jx lc kb ld kf le kj lf kn lg kr ls kz la lb bi translated">【自动】(T15):</li><li id="e288" class="kt ku iq jw b jx lc kb ld kf le kj lf kn lg kr ls kz la lb bi translated">格式:<code class="fe lh li lj lk b">eksctl-${cluster_name}-nodegroup-${worker-nodes-name}</code>，其中<em class="mr"> worker-nodes-name </em> -是cluster-config <code class="fe lh li lj lk b">eks-cluster-config.yml</code>中<code class="fe lh li lj lk b">nodeGroups: - name:</code>的值</li><li id="8974" class="kt ku iq jw b jx lc kb ld kf le kj lf kn lg kr ls kz la lb bi translated">描述:将由<code class="fe lh li lj lk b">eksctl</code>自己创建一个CloudFormation堆栈，记住这一点</li><li id="ca60" class="kt ku iq jw b jx lc kb ld kf le kj lf kn lg kr ls kz la lb bi translated">结果:<code class="fe lh li lj lk b">eksctl-bttrm-eks-dev-cluster</code></li></ul><p id="b19e" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">对于不同环境的不同文件，目前可以使用通用的<code class="fe lh li lj lk b">group_vars/all.yml</code>，稍后将会看到如何将它们分开。</p><p id="faec" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">创建目录:</p><pre class="ms mt mu mv gt mw lk mx my aw mz bi"><span id="d83a" class="lt lu iq lk b gy na nb l nc nd">$ mkdir group_vars</span></pre><p id="801e" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">创建<code class="fe lh li lj lk b">all.yml</code>文件并设置初始值:</p><pre class="ms mt mu mv gt mw lk mx my aw mz bi"><span id="b83d" class="lt lu iq lk b gy na nb l nc nd">###################<br/># ANSIBLE globals #<br/>###################<br/><br/>ansible_connection: local<br/><br/>#####################<br/># ENV-specific vars #<br/>#####################<br/><br/>env: "dev"<br/><br/>#################<br/># ROLES globals #<br/>#################<br/><br/>region: "eu-west-2"<br/><br/># (THIS) eks_cluster_name: used for EKS service to set an exactly cluster's name - "{{ eks_cluster_name }}"<br/># (AUTO) eks_cluster_stack_name: used for CloudFormation service to format a stack's name as "eksctl-{{ eks_cluster_name }}-cluster"<br/># (AUTO) eks_nodegroup_stack_name: used for CloudFormation service to format a stack's name as "eksctl-{{ eks_cluster_name }}-nodegroup-{{ worker-nodes-name }}"<br/>eks_cluster_name: "bttrm-eks-{{ env }}"<br/><br/># used bythe cloudformation role to st a stack's name<br/>cf_stack_name: "eksctl-{{ eks_cluster_name }}-stack"<br/><br/>##################<br/># ROLES specific #<br/>##################<br/><br/># cloudforation role<br/>vpc_cidr_block: "10.0.0.0/16"</span></pre><p id="a45f" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">此外，在这里放置共享变量，如<code class="fe lh li lj lk b">region</code>——它将由<em class="mr">云形成</em>和<em class="mr"> eksctl </em>角色使用，而<code class="fe lh li lj lk b">vpc_cidr_block</code>——仅在<em class="mr">云形成</em>中使用。</p><h2 id="6a67" class="lt lu iq bd lv lw lx dn ly lz ma dp mb kf mc md me kj mf mg mh kn mi mj mk ml bi translated">云形成的作用</h2><p id="48a7" class="pw-post-body-paragraph ju jv iq jw b jx mm jz ka kb mn kd ke kf mo kh ki kj mp kl km kn mq kp kq kr ij bi translated">在我们完成了<a class="ae ks" href="https://rtfm.co.ua/en/aws-elastic-kubernetes-service-a-cluster-creation-automation-part-1-cloudformation/" rel="noopener ugc nofollow" target="_blank">前一部分</a>中的模板后，我们必须有以下目录和文件结构:</p><pre class="ms mt mu mv gt mw lk mx my aw mz bi"><span id="fd88" class="lt lu iq lk b gy na nb l nc nd">$ tree<br/>.<br/>└── roles<br/>├── cloudformation<br/>│ ├── files<br/>│ │ ├── eks-azs-networking.json<br/>│ │ ├── eks-region-networking.json<br/>│ │ └── eks-root.json<br/>│ ├── tasks<br/>│ └── templates<br/>└── eksctl<br/>├── tasks<br/>└── templates<br/>└── eks-cluster-config.yml</span></pre><p id="f250" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">现在，在存储库根目录下创建一个新文件<code class="fe lh li lj lk b">eks-cluster.yml</code>——这将是我们可行的剧本。</p><p id="a655" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">在那里添加<em class="mr">云形成</em>执行:</p><pre class="ms mt mu mv gt mw lk mx my aw mz bi"><span id="2ee8" class="lt lu iq lk b gy na nb l nc nd">- hosts:<br/>  - all<br/>  become:<br/>    true<br/>  roles:<br/>    - role: cloudformation<br/>      tags: infra</span></pre><p id="f924" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">添加<code class="fe lh li lj lk b">tags</code>以便以后能够独立运行角色——这将有助于我们开始为<code class="fe lh li lj lk b">eksctl</code>编写角色。</p><p id="7960" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">创建一个<code class="fe lh li lj lk b">roles/cloudformation/tasks/main.yml</code>文件——在这里添加<code class="fe lh li lj lk b"><a class="ae ks" href="https://rtfm.co.ua/ansible-modul-cloudformation/" rel="noopener ugc nofollow" target="_blank">cloudformation</a></code>模块执行，并通过<code class="fe lh li lj lk b">template_parameters</code>—来自<code class="fe lh li lj lk b">vpc_cidr_block</code>变量的<code class="fe lh li lj lk b">VPCCIDRBlock</code>和来自<code class="fe lh li lj lk b">eks_cluster_name</code>变量的<code class="fe lh li lj lk b">EKSClusterName</code>参数为我们的模板设置必要的参数:</p><pre class="ms mt mu mv gt mw lk mx my aw mz bi"><span id="0594" class="lt lu iq lk b gy na nb l nc nd">- name: "Create EKS {{ cf_stack_name | upper }} CloudFormation stack"<br/>  cloudformation:<br/>    region: "{{ region }}"<br/>    stack_name: "{{ cf_stack_name }}"<br/>    state: "present"<br/>    disable_rollback: true<br/>    template: "/tmp/packed-eks-stacks.json"<br/>    template_parameters:<br/>      VPCCIDRBlock: "{{ vpc_cidr_block }}"<br/>      EKSClusterName: {{ eks_cluster_name }},<br/>    tags:<br/>      Stack: "{{ cf_stack_name }}"<br/>      Env: "{{ env }}"<br/>      EKS-cluster: "{{ eks_cluster_name }}"</span></pre><p id="1b81" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">半年没用Ansible忘得一干二净(</p><p id="5d5a" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">谷歌搜索“<em class="mr">易变库存</em>”——并阅读<a class="ae ks" href="https://rtfm.co.ua/goto/https://docs.ansible.com/ansible/latest/user_guide/playbooks_best_practices.html" rel="noopener ugc nofollow" target="_blank">最佳实践</a></p><p id="cb92" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">在存储库根目录中，创建一个带有一些默认值的<code class="fe lh li lj lk b">ansible.cfg</code>文件:</p><pre class="ms mt mu mv gt mw lk mx my aw mz bi"><span id="1b00" class="lt lu iq lk b gy na nb l nc nd">[defaults]<br/>gather_facts = no<br/>inventory = hosts.yml</span></pre><p id="58fb" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">在同一个地方创建一个库存文件— <code class="fe lh li lj lk b">hosts.yml</code>:</p><pre class="ms mt mu mv gt mw lk mx my aw mz bi"><span id="c41b" class="lt lu iq lk b gy na nb l nc nd">all:<br/>  hosts:<br/>    "localhost"</span></pre><p id="d9b0" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">当使用本地主机时，Ansible不会在任何地方使用SSH所有的任务都将在本地完成。</p><p id="dd3b" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">检查语法:</p><pre class="ms mt mu mv gt mw lk mx my aw mz bi"><span id="549f" class="lt lu iq lk b gy na nb l nc nd">admin@jenkins-production:~/devops-kubernetes$ ansible-playbook eks-cluster.yml — syntax-check<br/>playbook: eks-cluster.yml</span></pre><p id="e867" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">好看吗？生成模板的文件(在Jenkins pipeline中，必须有一个额外的阶段:</p><pre class="ms mt mu mv gt mw lk mx my aw mz bi"><span id="fe7a" class="lt lu iq lk b gy na nb l nc nd">admin@jenkins-production:~/devops-kubernetes$ cd roles/cloudformation/files/</span><span id="2204" class="lt lu iq lk b gy nj nb l nc nd">admin@jenkins-production:~/devops-kubernetes/roles/cloudformation/files$ aws --region eu-west-2 cloudformation package --template-file eks-root.json --output-template /tmp/packed-eks-stacks.json --s3-bucket eks-cloudformation-eu-west-2 --use-json</span><span id="90c0" class="lt lu iq lk b gy nj nb l nc nd">Successfully packaged artifacts and wrote output template to file /tmp/packed-eks-stacks.json.</span></pre><p id="b003" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">执行以下命令来部署打包的模板</p><pre class="ms mt mu mv gt mw lk mx my aw mz bi"><span id="e45b" class="lt lu iq lk b gy na nb l nc nd">$ aws cloudformation deploy --template-file /tmp/packed-eks-stacks.json --stack-name &lt;YOUR STACK NAME&gt;</span></pre><p id="bdfd" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">运行堆栈创建:</p><pre class="ms mt mu mv gt mw lk mx my aw mz bi"><span id="16c3" class="lt lu iq lk b gy na nb l nc nd">admin@jenkins-production:~/devops-kubernetes$ ansible-playbook eks-cluster.yml<br/>…<br/>TASK [cloudformation : Setting the Stack name] ****<br/>ok: [localhost]<br/>TASK [cloudformation : Create EKS EKSCTL-BTTRM-EKS-DEV-STACK CloudFormation stack] ****<br/>changed: [localhost]<br/>PLAY RECAP ****<br/>localhost : ok=3 changed=1 unreachable=0 failed=0 skipped=0 rescued=0 ignored=0</span></pre><p id="902b" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">检查:</p><figure class="ms mt mu mv gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="nf ng di nh bf ni"><div class="gh gi nk"><img src="../Images/32003a648aea24e09e4d261bd18a2b7d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*fF4DzSOcR-MskC25.png"/></div></div></figure><p id="eaaa" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">堆栈的名称被设置为<em class="mr">eks CTL-Bt trm-eks-dev-stack</em>—很好。</p><p id="4b91" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">现在，可以开始为<code class="fe lh li lj lk b">eksctl</code>编写一个角色来创建集群本身。</p><h2 id="faf4" class="lt lu iq bd lv lw lx dn ly lz ma dp mb kf mc md me kj mf mg mh kn mi mj mk ml bi translated">可回答的<code class="fe lh li lj lk b">eksctl</code></h2><p id="2c63" class="pw-post-body-paragraph ju jv iq jw b jx mm jz ka kb mn kd ke kf mo kh ki kj mp kl km kn mq kp kq kr ij bi translated">我们已经有了集群配置文件——让我们将其重命名为<code class="fe lh li lj lk b">.j2</code>(注意它是Jinja的文件可转换模板引擎):</p><pre class="ms mt mu mv gt mw lk mx my aw mz bi"><span id="ae22" class="lt lu iq lk b gy na nb l nc nd">admin@jenkins-production:~/devops-kubernetes$ mv roles/eksctl/templates/eks-cluster-config.yml roles/eksctl/templates/eks-cluster-config.yml.j2</span></pre><p id="a160" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">从在第一个角色中创建的CloudFormation堆栈中，我们需要在这里传递一组值— VPC ID、子网ID等，以便在集群配置中为<code class="fe lh li lj lk b">eksctl</code>设置值。</p><p id="8069" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">让我们使用Ansible模块<code class="fe lh li lj lk b"><a class="ae ks" href="https://rtfm.co.ua/goto/https://docs.ansible.com/ansible/latest/modules/cloudformation_info_module.html" rel="noopener ugc nofollow" target="_blank">cloudformation_info</a></code>来收集关于所创建的堆栈的信息。</p><p id="e119" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">添加它，将其输出保存到<code class="fe lh li lj lk b">stack_info</code>变量，然后将检查其内容。</p><p id="1d4f" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">创建一个新文件<code class="fe lh li lj lk b">roles/eksctl/tasks/main.yml</code>:</p><pre class="ms mt mu mv gt mw lk mx my aw mz bi"><span id="c43a" class="lt lu iq lk b gy na nb l nc nd">- cloudformation_info:<br/>    region: "{{ region }}"<br/>    stack_name: "cf_stack_name"<br/>  register: stack_info<br/><br/>- debug:<br/>    msg: "{{ stack_info }}"</span></pre><p id="3243" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">将<code class="fe lh li lj lk b">eksctl</code>角色执行添加到<code class="fe lh li lj lk b">eks-cluster.yml</code>剧本中，添加<code class="fe lh li lj lk b">tags</code>:</p><pre class="ms mt mu mv gt mw lk mx my aw mz bi"><span id="b86a" class="lt lu iq lk b gy na nb l nc nd">- hosts:<br/>  - all<br/>  become:<br/>    true<br/>  roles:<br/>    - role: cloudformation<br/>      tags: infra<br/>    - role: eksctl<br/>      tags: eks</span></pre><p id="27e0" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">使用<code class="fe lh li lj lk b">--tags eks</code>运行，仅执行<code class="fe lh li lj lk b">eksctl</code>角色:</p><pre class="ms mt mu mv gt mw lk mx my aw mz bi"><span id="9c87" class="lt lu iq lk b gy na nb l nc nd">admin@jenkins-production:~/devops-kubernetes$ ansible-playbook — tags eks eks-cluster.yml<br/>…<br/>TASK [eksctl : cloudformation_info] ****<br/>ok: [localhost]<br/>TASK [eksctl : debug] ****<br/>ok: [localhost] =&gt; {<br/>“msg”: {<br/>“changed”: false,<br/>“cloudformation”: {<br/>“eksctl-bttrm-eks-dev-stack”: {<br/>“stack_description”: {<br/>…<br/>“outputs”: [<br/>{<br/>“description”: “EKS VPC ID”,<br/>“output_key”: “VPCID”,<br/>“output_value”: “vpc-042082cd2d011f44d”<br/>},<br/>…</span></pre><p id="a7c1" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">酷毙了。</p><p id="cf71" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">现在—让我们只切割<code class="fe lh li lj lk b">{ "outputs" }</code>块。</p><p id="7d0d" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">更新任务—从<code class="fe lh li lj lk b">stack_info</code>到<code class="fe lh li lj lk b">msg</code>只传递<code class="fe lh li lj lk b">stack_outputs</code>:</p><pre class="ms mt mu mv gt mw lk mx my aw mz bi"><span id="1fc4" class="lt lu iq lk b gy na nb l nc nd">- cloudformation_info:<br/>    region: "{{ region }}"<br/>    stack_name: "{{ cf_stack_name }}"<br/>  register: stack_info<br/><br/>- debug:<br/>    msg: "{{ stack_info.cloudformation[cf_stack_name].stack_outputs }}"</span></pre><p id="491f" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">运行:</p><pre class="ms mt mu mv gt mw lk mx my aw mz bi"><span id="05b7" class="lt lu iq lk b gy na nb l nc nd">admin@jenkins-production:~/devops-kubernetes$ ansible-playbook — tags eks eks-cluster.yml<br/>…<br/>TASK [eksctl : debug] ****<br/>ok: [localhost] =&gt; {<br/>“msg”: {<br/>“APrivateSubnetID”: “subnet-0471e7c28a3770828”,<br/>“APublicSubnetID”: “subnet-07a0259b33ddbcb4c”,<br/>“AStackAZ”: “eu-west-2a”,<br/>“BPrivateSubnetID”: “subnet-0fa6eece43b2b6644”,<br/>“BPublicSubnetID”: “subnet-072c107cef77fe859”,<br/>“BStackAZ”: “eu-west-2b”,<br/>“VPCID”: “vpc-042082cd2d011f44d”<br/>}<br/>}<br/>…</span></pre><p id="48f6" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">尼尔！</p><p id="8599" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">现在，让我们尝试将这些值设置为变量，以使用它们从模板生成集群配置。</p><p id="3260" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">更新<code class="fe lh li lj lk b">roles/eksctl/tasks/main.yml</code>，增加一个<code class="fe lh li lj lk b">vpc_id</code>变量，通过<code class="fe lh li lj lk b">debug</code>打印出来，检查其值:</p><pre class="ms mt mu mv gt mw lk mx my aw mz bi"><span id="d13c" class="lt lu iq lk b gy na nb l nc nd">- cloudformation_info:<br/>    region: "{{ region }}"<br/>    stack_name: "{{ cf_stack_name }}"<br/>  register: stack_info<br/><br/>- debug:<br/>    msg: "{{ stack_info.cloudformation[cf_stack_name].stack_outputs }}"<br/><br/>- set_fact:<br/>    vpc_id: "{{ stack_info.cloudformation[cf_stack_name].stack_outputs.VPCID }}"<br/><br/>- debug:<br/>    msg: "{{ vpc_id }}"<br/><br/>- name: "Check template's content"<br/>  debug:<br/>    msg: "{{ lookup('template', './eks-cluster-config.yml.j2') }}"</span></pre><p id="2249" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">在<em class="mr">中，通过直接调用<code class="fe lh li lj lk b"><a class="ae ks" href="https://rtfm.co.ua/goto/https://docs.ansible.com/ansible/latest/modules/template_module.html" rel="noopener ugc nofollow" target="_blank">template</a></code>模块检查模板内容</em>，让我们检查一下模板文件的结果文件。</p><p id="b21e" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">编辑<code class="fe lh li lj lk b">roles/eksctl/templates/eks-cluster-config.yml.j2</code> -设置<code class="fe lh li lj lk b">{{ vpc_id }}</code>:</p><pre class="ms mt mu mv gt mw lk mx my aw mz bi"><span id="bd3b" class="lt lu iq lk b gy na nb l nc nd">apiVersion: eksctl.io/v1alpha5<br/>kind: ClusterConfig<br/>metadata:<br/>  name: eks-dev<br/>  region: eu-west-2<br/>  version: "1.15"<br/>nodeGroups:<br/>  - name: worker-nodes<br/>    instanceType: t3.medium<br/>    desiredCapacity: 2<br/>    privateNetworking: true<br/>vpc:<br/>  id: "{{ vpc_id }}"<br/>  subnets:<br/>    public:<br/>      eu-west-2a:<br/>...</span></pre><p id="1340" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">检查:</p><pre class="ms mt mu mv gt mw lk mx my aw mz bi"><span id="22a0" class="lt lu iq lk b gy na nb l nc nd">admin@jenkins-production:~/devops-kubernetes$ ansible-playbook — tags eks eks-cluster.yml<br/>…<br/>TASK [eksctl : debug] ****<br/>ok: [localhost] =&gt; {<br/>“msg”: {<br/>“APrivateSubnetID”: “subnet-0471e7c28a3770828”,<br/>“APublicSubnetID”: “subnet-07a0259b33ddbcb4c”,<br/>“AStackAZ”: “eu-west-2a”,<br/>“BPrivateSubnetID”: “subnet-0fa6eece43b2b6644”,<br/>“BPublicSubnetID”: “subnet-072c107cef77fe859”,<br/>“BStackAZ”: “eu-west-2b”,<br/>“VPCID”: “vpc-042082cd2d011f44d”<br/>}<br/>}<br/>TASK [eksctl : set_fact] ****ok: [localhost]<br/>TASK [eksctl : debug] ****<br/>ok: [localhost] =&gt; {<br/>“msg”: “vpc-042082cd2d011f44d”<br/>}<br/>TASK [eksctl : Check the template’s content] ****<br/>ok: [localhost] =&gt; {<br/>“msg”: “apiVersion: eksctl.io/v1alpha5\nkind: ClusterConfig\nmetadata:\n name: eks-dev\n region: eu-west-2\n version: \”1.15\”\nnodeGroups:\n — name: worker-nodes\n instanceType: t3.medium\n desiredCapacity: 2\n privateNetworking: true\nvpc:\n id: \”vpc-042082cd2d011f44d\”\n […]</span></pre><p id="573c" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated"><em class="mr">VPC:\ n ID:\ " VPC-VPC-042082 CD 2d 011 f 44d \ "</em>—很好，我们在模板中获得了我们的VPC ID。</p><p id="70f7" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">添加其他变量，使模板看起来像这样:</p><pre class="ms mt mu mv gt mw lk mx my aw mz bi"><span id="69bb" class="lt lu iq lk b gy na nb l nc nd">apiVersion: eksctl.io/v1alpha5<br/>kind: ClusterConfig<br/>metadata:<br/>  name: "{{ eks_cluster_name }}"<br/>  region: "{{ region }}"<br/>  version: "{{ k8s_version }}"<br/>nodeGroups:<br/>  - name: "{{ k8s_worker_nodes_group_name }}"<br/>    instanceType: "{{ k8s_worker_nodes_instance_type }}"<br/>    desiredCapacity: {{ k8s_worker_nodes_capacity }}<br/>    privateNetworking: true<br/>vpc:<br/>  id: "{{ vpc_id }}"<br/>  subnets:<br/>    public:<br/>      {{ a_stack_az }}:<br/>        id: "{{ a_stack_pub_subnet }}"<br/>      {{ b_stack_az }}:<br/>        id: "{{ b_stack_pub_subnet }}"<br/>    private:<br/>      {{ a_stack_az }}:<br/>        id: "{{ a_stack_priv_subnet }}"<br/>      {{ b_stack_az }}:<br/>        id: "{{ b_stack_priv_subnet }}"<br/>  nat:<br/>    gateway: Disable<br/>cloudWatch:<br/>  clusterLogging:<br/>    enableTypes: ["*"]</span></pre><p id="1582" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">接下来，需要为Ansible添加额外的变量，以便在该模板中使用:</p><ul class=""><li id="7fd9" class="kt ku iq jw b jx jy kb kc kf kv kj kw kn kx kr ls kz la lb bi translated">已经添加了eks_cluster_name </li><li id="8cdc" class="kt ku iq jw b jx lc kb ld kf le kj lf kn lg kr ls kz la lb bi translated"><em class="mr"> vpc_id </em> —已经添加</li><li id="6963" class="kt ku iq jw b jx lc kb ld kf le kj lf kn lg kr ls kz la lb bi translated">对于availability zone-а堆栈，需要添加:</li><li id="b554" class="kt ku iq jw b jx lc kb ld kf le kj lf kn lg kr ls kz la lb bi translated"><em class="mr">堆栈发布子网</em></li><li id="c3bb" class="kt ku iq jw b jx lc kb ld kf le kj lf kn lg kr ls kz la lb bi translated"><em class="mr">堆栈私有子网</em></li><li id="75ef" class="kt ku iq jw b jx lc kb ld kf le kj lf kn lg kr ls kz la lb bi translated">对于availability zone-в，需要添加:</li><li id="36c2" class="kt ku iq jw b jx lc kb ld kf le kj lf kn lg kr ls kz la lb bi translated"><em class="mr"> a_stack_pub_subnet </em></li><li id="3972" class="kt ku iq jw b jx lc kb ld kf le kj lf kn lg kr ls kz la lb bi translated"><em class="mr">堆栈私有子网</em></li><li id="f3b9" class="kt ku iq jw b jx lc kb ld kf le kj lf kn lg kr ls kz la lb bi translated"><em class="mr">区域</em>——已经添加，稍后将从Jenkins参数中设置</li><li id="b687" class="kt ku iq jw b jx lc kb ld kf le kj lf kn lg kr ls kz la lb bi translated"><em class="mr"> kubernetes_version </em></li><li id="e10b" class="kt ku iq jw b jx lc kb ld kf le kj lf kn lg kr ls kz la lb bi translated"><em class="mr">kubernetes _ worker _ nodes _ group _ name</em></li><li id="562e" class="kt ku iq jw b jx lc kb ld kf le kj lf kn lg kr ls kz la lb bi translated"><em class="mr">kubernetes _ worker _ nodes _ instance _ type</em></li><li id="0915" class="kt ku iq jw b jx lc kb ld kf le kj lf kn lg kr ls kz la lb bi translated"><em class="mr">kubernetes _ worker _ nodes _ capacity</em></li></ul><p id="b4f8" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">在<code class="fe lh li lj lk b">roles/eksctl/tasks/main.yml</code>中增加<code class="fe lh li lj lk b">set_facts</code>:</p><pre class="ms mt mu mv gt mw lk mx my aw mz bi"><span id="3e5e" class="lt lu iq lk b gy na nb l nc nd">- cloudformation_info:<br/>    region: "{{ region }}"<br/>    stack_name: "{{ cf_stack_name }}"<br/>  register: stack_info<br/><br/>- debug:<br/>    msg: "{{ stack_info.cloudformation[cf_stack_name].stack_outputs }}"<br/><br/>- set_fact:<br/>    vpc_id: "{{ stack_info.cloudformation[cf_stack_name].stack_outputs.VPCID }}"<br/>    a_stack_az: "{{ stack_info.cloudformation[cf_stack_name].stack_outputs.AStackAZ }}"<br/>    a_stack_pub_subnet: "{{ stack_info.cloudformation[cf_stack_name].stack_outputs.APublicSubnetID }}"<br/>    a_stack_priv_subnet: "{{ stack_info.cloudformation[cf_stack_name].stack_outputs.APrivateSubnetID }}"<br/>    b_stack_az: "{{ stack_info.cloudformation[cf_stack_name].stack_outputs.BStackAZ }}"<br/>    b_stack_pub_subnet: "{{ stack_info.cloudformation[cf_stack_name].stack_outputs.BPublicSubnetID }}"<br/>    b_stack_priv_subnet: "{{ stack_info.cloudformation[cf_stack_name].stack_outputs.BPrivateSubnetID }}"<br/><br/>- name: "Check the template's content"<br/>  debug:<br/>    msg: "{{ lookup('template', './eks-cluster-config.yml.j2') }}"</span></pre><p id="6123" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">在<code class="fe lh li lj lk b">group_vars/all.yml</code>中为<em class="mr"> eksctl </em>角色添加值:</p><pre class="ms mt mu mv gt mw lk mx my aw mz bi"><span id="8cbe" class="lt lu iq lk b gy na nb l nc nd">...<br/>##################<br/># ROLES specific #<br/>##################<br/><br/># cloudforation role<br/>vpc_cidr_block: "10.0.0.0/16"<br/><br/># eksctl role<br/>k8s_version: 1.15<br/>k8s_worker_nodes_group_name: "worker-nodes"<br/>k8s_worker_nodes_instance_type: "t3.medium"<br/>k8s_worker_nodes_capacity: 2</span></pre><p id="373d" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">让我们先通过调用模板目录来检查一下:</p><pre class="ms mt mu mv gt mw lk mx my aw mz bi"><span id="1bdf" class="lt lu iq lk b gy na nb l nc nd">…<br/>TASK [eksctl : Check the template’s content] ****<br/>ok: [localhost] =&gt; {<br/>“msg”: “apiVersion: eksctl.io/v1alpha5\nkind: ClusterConfig\nmetadata:\n name: \”bttrm-eks-dev\”\n region: \”eu-west-2\”\n version: \”1.15\”\nnodeGroups:\n — name: \”worker-nodes\”\n instanceType: \”t3.medium\”\n desiredCapacity: 2\n privateNetworking: true\nvpc:\n id: \”vpc-042082cd2d011f44d\”\n subnets:\n public:\n eu-west-2a:\n id: \”subnet-07a0259b33ddbcb4c\”\n eu-west-2b:\n id: \”subnet-072c107cef77fe859\”\n private:\n eu-west-2a:\n id: \”subnet-0471e7c28a3770828\”\n eu-west-2b:\n id: \”subnet-0fa6eece43b2b6644\”\n nat:\n gateway: Disable\ncloudWatch:\n clusterLogging:\n enableTypes: [\”*\”]\n”<br/>}<br/>…</span></pre><p id="47b5" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">“管用！”。</p><p id="8011" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">嗯——不是运行<code class="fe lh li lj lk b">eksctl</code>的时候了。</p><h2 id="7f4d" class="lt lu iq bd lv lw lx dn ly lz ma dp mb kf mc md me kj mf mg mh kn mi mj mk ml bi translated">集群配置— <code class="fe lh li lj lk b">eks-cluster-config.yml</code></h2><p id="ef26" class="pw-post-body-paragraph ju jv iq jw b jx mm jz ka kb mn kd ke kf mo kh ki kj mp kl km kn mq kp kq kr ij bi translated">在调用<code class="fe lh li lj lk b">eksctl</code>之前，需要从模板中生成配置。</p><p id="ea65" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">在<code class="fe lh li lj lk b">roles/eksctl/tasks/main.yml</code>的末尾添加<code class="fe lh li lj lk b">template</code>，并通过使用<code class="fe lh li lj lk b">role/eksctl/templates/eks-cluster-config.yml.j2</code>在<code class="fe lh li lj lk b">/tmp</code>目录下生成一个<code class="fe lh li lj lk b">eks-cluster-config.yml</code>文件:</p><pre class="ms mt mu mv gt mw lk mx my aw mz bi"><span id="57e2" class="lt lu iq lk b gy na nb l nc nd">...<br/>- name: "Generate eks-cluster-config.yml"<br/>  template:<br/>    src: "eks-cluster-config.yml.j2"<br/>    dest: /tmp/eks-cluster-config.yml</span></pre><h2 id="e90b" class="lt lu iq bd lv lw lx dn ly lz ma dp mb kf mc md me kj mf mg mh kn mi mj mk ml bi translated"><code class="fe lh li lj lk b">eksctl</code> <em class="nl">创建</em> vs <em class="nl">更新</em></h2><p id="824f" class="pw-post-body-paragraph ju jv iq jw b jx mm jz ka kb mn kd ke kf mo kh ki kj mp kl km kn mq kp kq kr ij bi translated"><em class="mr">注意:实际上，eksctl的更新将执行版本升级而不是配置更新，但我将把这部分留在这里只是为了举例</em></p><p id="f39f" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">顺便问一下，如果集群已经存在了呢？当我们通过<code class="fe lh li lj lk b">create</code>时，作业将失败。</p><p id="bb5d" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">嗯——我们可以添加一个检查，如果集群已经存在，然后创建一个变量来存储值<em class="mr"> create </em>或<em class="mr"> update </em>，类似于我在<a class="ae ks" href="https://rtfm.co.ua/bash-skript-sozdaniya-aws-cloudformation-steka/" rel="noopener ugc nofollow" target="_blank">bash:скииптсозданияAWS cloud formationстекаа</a>中所做的。</p><p id="d982" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">因此，需要:</p><ol class=""><li id="d0ec" class="kt ku iq jw b jx jy kb kc kf kv kj kw kn kx kr ky kz la lb bi translated">获取AWS区域中EKS集群的列表</li><li id="9c73" class="kt ku iq jw b jx lc kb ld kf le kj lf kn lg kr ky kz la lb bi translated">尝试在此列表中查找正在创建的集群的名称</li><li id="d8ea" class="kt ku iq jw b jx lc kb ld kf le kj lf kn lg kr ky kz la lb bi translated">如果<strong class="jw ir">未找到</strong>，则设定值<em class="mr">创建</em></li><li id="fd84" class="kt ku iq jw b jx lc kb ld kf le kj lf kn lg kr ky kz la lb bi translated">如果找到，则设定值<em class="mr">更新</em></li></ol><p id="9f48" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">让我们试着这样做:</p><pre class="ms mt mu mv gt mw lk mx my aw mz bi"><span id="a5d7" class="lt lu iq lk b gy na nb l nc nd"># populate a clusters_exist list with names of clusters devided by TAB "\t"<br/>- name: "Getting existing clusters list"<br/>  shell: "aws --region {{ region }} eks list-clusters --query '[clusters'] --output text"<br/>  register: clusters_exist<br/><br/>- debug:<br/>    msg: "{{ clusters_exist.stdout }}"<br/><br/># create a list from the clusters_exist<br/>- set_fact:<br/>    found_clusters_list: "{{ clusters_exist.stdout.split('\t') }}"<br/><br/>- debug:<br/>    msg: "{{ found_clusters_list }}"<br/><br/># check if a cluster's name is found in the existing clusters  list<br/>- fail:<br/>    msg: "{{ eks_cluster_name }} already exist in the {{ region }}"<br/>  when: eks_cluster_name not in found_clusters_list<br/><br/>- meta: end_play<br/>...</span></pre><p id="0aa8" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">测试期间的那些任务添加到<code class="fe lh li lj lk b">roles/eksctl/tasks/main.yml</code>的开头，并在它们之后停止执行——添加<code class="fe lh li lj lk b">- meta: end_play</code>。</p><p id="55a9" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">在<code class="fe lh li lj lk b">fail</code>条件下，现在设置“<strong class="jw ir">而不是</strong>”，因为我们现在只是测试，还没有创建集群:</p><pre class="ms mt mu mv gt mw lk mx my aw mz bi"><span id="cf2f" class="lt lu iq lk b gy na nb l nc nd">…<br/>TASK [eksctl : debug] *****<br/>ok: [localhost] =&gt; {<br/>“msg”: “eks-dev”<br/>}<br/>TASK [eksctl : set_fact] ****<br/>ok: [localhost]<br/>TASK [eksctl : debug] ****<br/>ok: [localhost] =&gt; {<br/>“msg”: [<br/>“eks-dev”<br/>]<br/>}<br/>TASK [eksctl : fail] ****<br/>fatal: [localhost]: FAILED! =&gt; {“changed”: false, “msg”: “bttrm-eks-dev already exist in the eu-west-2”}<br/>…</span></pre><p id="e530" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">酷毙了。</p><p id="3f1e" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">现在，添加一个带有“<em class="mr"> create </em>或“<em class="mr"> update </em>”的<code class="fe lh li lj lk b">eksctl_action</code>变量，这取决于是否找到了集群:</p><pre class="ms mt mu mv gt mw lk mx my aw mz bi"><span id="3172" class="lt lu iq lk b gy na nb l nc nd"># populate a clusters_exist list with names of clusters devided by TAB "\t"<br/>- name: "Getting existing clusters list"<br/>  shell: "aws --region {{ region }} eks list-clusters --query '[clusters'] --output text"<br/>  register: clusters_exist<br/><br/>- debug:<br/>    msg: "{{ clusters_exist.stdout }}"<br/><br/># create a list from the clusters_exist<br/>- set_fact:<br/>    found_clusters_list: "{{ clusters_exist.stdout.split('\t') }}"<br/><br/>- debug:<br/>    msg: "{{ found_clusters_list }}"<br/><br/>- set_fact:<br/>    eksctl_action: "{{ 'create' if (eks_cluster_name not in found_clusters_list) else 'update' }}"<br/>   <br/>- debug:<br/>    var: eksctl_action<br/><br/># check if a cluster's name is found in the existing clusters  list<br/>- fail:<br/>    msg: "{{ eks_cluster_name }} already exist in the {{ region }}"<br/>  when: eks_cluster_name not in found_clusters_list<br/><br/>...</span></pre><p id="0b04" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">检查:</p><pre class="ms mt mu mv gt mw lk mx my aw mz bi"><span id="2564" class="lt lu iq lk b gy na nb l nc nd">…<br/>TASK [eksctl : debug] ****<br/>ok: [localhost] =&gt; {<br/>“eksctl_action”: “create”<br/>}<br/>…</span></pre><p id="a984" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">接下来，将它添加到<code class="fe lh li lj lk b">eksctl</code>任务中——将<code class="fe lh li lj lk b">{{ eksctl_action }}</code>添加到它的参数中，而不是直接使用“<em class="mr"> create </em>”:</p><pre class="ms mt mu mv gt mw lk mx my aw mz bi"><span id="f45a" class="lt lu iq lk b gy na nb l nc nd">- cloudformation_info:<br/>    region: "{{ region }}"<br/>    stack_name: "{{ cf_stack_name }}"<br/>  register: stack_info<br/><br/>- set_fact:<br/>    vpc_id: "{{ stack_info.cloudformation[cf_stack_name].stack_outputs.VPCID }}"<br/>    a_stack_az: "{{ stack_info.cloudformation[cf_stack_name].stack_outputs.AStackAZ }}"<br/>    a_stack_pub_subnet: "{{ stack_info.cloudformation[cf_stack_name].stack_outputs.APublicSubnetID }}"<br/>    a_stack_priv_subnet: "{{ stack_info.cloudformation[cf_stack_name].stack_outputs.APrivateSubnetID }}"<br/>    b_stack_az: "{{ stack_info.cloudformation[cf_stack_name].stack_outputs.BStackAZ }}"<br/>    b_stack_pub_subnet: "{{ stack_info.cloudformation[cf_stack_name].stack_outputs.BPublicSubnetID }}"<br/>    b_stack_priv_subnet: "{{ stack_info.cloudformation[cf_stack_name].stack_outputs.BPrivateSubnetID }}"<br/> <br/>- name: "Generate eks-cluster-config.yml"<br/>  template:<br/>    src: "eks-cluster-config.yml.j2"<br/>    dest: /tmp/eks-cluster-config.yml<br/><br/># populate a clusters_exist list with names of clusters devided by TAB "\t"<br/>- name: "Getting existing clusters list"<br/>  command: "aws --region {{ region }} eks list-clusters --query '[clusters'] --output text"<br/>  register: clusters_exist<br/><br/># create a list from the clusters_exist<br/>- set_fact:<br/>    found_clusters_list: "{{ clusters_exist.stdout.split('\t') }}"<br/><br/>- name: "Setting eksctl action to either Create or Update"<br/>  set_fact:<br/>    eksctl_action: "{{ 'create' if (eks_cluster_name not in found_clusters_list) else 'update' }}"<br/><br/>- name: "Running eksctl eksctl_action {{ eksctl_action | upper }} cluster with name {{ eks_cluster_name | upper }}"<br/>  command: "eksctl {{ eksctl_action }} cluster -f /tmp/eks-cluster-config.yml"</span></pre><p id="95d2" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">关键时刻到了。:-)</p><p id="e40e" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">运行:</p><pre class="ms mt mu mv gt mw lk mx my aw mz bi"><span id="3629" class="lt lu iq lk b gy na nb l nc nd">admin@jenkins-production:~/devops-kubernetes$ ansible-playbook — tags eks eks-cluster.yml<br/>…<br/>TASK [eksctl : cloudformation_info] ****<br/>ok: [localhost]<br/>TASK [eksctl : set_fact] ****<br/>ok: [localhost]<br/>TASK [eksctl : Generate eks-cluster-config.yml] ****<br/>ok: [localhost]<br/>TASK [eksctl : Getting existing clusters list] ****<br/>changed: [localhost]<br/>TASK [eksctl : set_fact] ****<br/>ok: [localhost]<br/>TASK [eksctl : Setting eksctl action to either Create or Update] ****<br/>ok: [localhost]<br/>TASK [eksctl : Running eksctl eksctl_action CREATE cluster with name BTTRM-EKS-DEV]</span></pre><p id="4a7a" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">堆栈和集群正在创建，堆栈的名称是<em class="mr">eks CTL-Bt trm-dev-cluster</em>——一切如我们计划的那样:</p><figure class="ms mt mu mv gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="nf ng di nh bf ni"><div class="gh gi nm"><img src="../Images/021f411126f0ff50a06dbc3926697d24.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*2112O0MXICSoM0G7.png"/></div></div></figure><p id="39ac" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">万岁！</p><p id="52ed" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">只剩最后一项测试了。</p><h2 id="6901" class="lt lu iq bd lv lw lx dn ly lz ma dp mb kf mc md me kj mf mg mh kn mi mj mk ml bi translated">测试:云形成和EKS自定义参数</h2><p id="f21d" class="pw-post-body-paragraph ju jv iq jw b jx mm jz ka kb mn kd ke kf mo kh ki kj mp kl km kn mq kp kq kr ij bi translated">最新要测试的是我们写的所有东西的灵活性。</p><p id="4d5e" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">例如，一个QA团队想要用VPC CIDR <em class="mr"> 10.1.0.0/16 </em>创建一个名为<em class="mr"> qa-test </em>的全新集群。</p><p id="155d" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">更新<code class="fe lh li lj lk b">group_vars/all.yml</code>，设置:</p><ul class=""><li id="f5ca" class="kt ku iq jw b jx jy kb kc kf kv kj kw kn kx kr ls kz la lb bi translated"><code class="fe lh li lj lk b">env</code>:<em class="mr">dev</em>&gt;<em class="mr">QA-test</em></li><li id="1996" class="kt ku iq jw b jx lc kb ld kf le kj lf kn lg kr ls kz la lb bi translated"><code class="fe lh li lj lk b">region</code>:<em class="mr">欧盟-西方-2</em>&gt;<em class="mr">欧盟-西方-3 </em>”</li><li id="71b2" class="kt ku iq jw b jx lc kb ld kf le kj lf kn lg kr ls kz la lb bi translated"><code class="fe lh li lj lk b">vpc_cidr_block</code>:<em class="mr">10 . 0 . 0 . 0/16</em>&gt;<em class="mr">10 . 1 . 0 . 0/16</em></li></ul><pre class="ms mt mu mv gt mw lk mx my aw mz bi"><span id="d92c" class="lt lu iq lk b gy na nb l nc nd">...<br/>env: "qa-test"<br/>...<br/>region: "eu-west-3"<br/>...<br/>vpc_cidr_block: "10.1.0.0/16"</span></pre><p id="d5cb" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">重新打包模板以重新生成<code class="fe lh li lj lk b">packed-eks-stack.json</code>:</p><pre class="ms mt mu mv gt mw lk mx my aw mz bi"><span id="7448" class="lt lu iq lk b gy na nb l nc nd">admin@jenkins-production:~/devops-kubernetes$ cd roles/cloudformation/files/</span><span id="d354" class="lt lu iq lk b gy nj nb l nc nd">admin@jenkins-production:~/devops-kubernetes/roles/cloudformation/files$ aws — region eu-west-3 cloudformation package — template-file eks-root.json — output-template packed-eks-stacks.json — s3-bucket eks-cloudformation-eu-west-3 — use-json</span></pre><p id="a3b4" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">不带<code class="fe lh li lj lk b">--tags</code>运行Ansible，从头开始创建CloudFormation堆栈和EKS集群:</p><pre class="ms mt mu mv gt mw lk mx my aw mz bi"><span id="ca52" class="lt lu iq lk b gy na nb l nc nd">admin@jenkins-production:~/devops-kubernetes$ ansible-playbook eks-cluster.yml<br/>…<br/>TASK [cloudformation : Create EKS EKSCTL-BTTRM-EKS-QA-TEST-STACK CloudFormation stack] ****<br/>changed: [localhost]<br/>TASK [eksctl : cloudformation_info] ****<br/>ok: [localhost]<br/>TASK [eksctl : set_fact] ****<br/>ok: [localhost]<br/>TASK [eksctl : Generate eks-cluster-config.yml] ****<br/>changed: [localhost]<br/>TASK [eksctl : Getting existing clusters list] ****<br/>changed: [localhost]<br/>TASK [eksctl : set_fact] ****<br/>ok: [localhost]<br/>TASK [eksctl : Setting eksctl action to either Create or Update] ****<br/>ok: [localhost]<br/>TASK [eksctl : Running eksctl eksctl_action CREATE cluster with name BTTRM-EKS-QA-TEST] ****<br/>…</span></pre><p id="cdd3" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">等等，检查:</p><figure class="ms mt mu mv gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="nf ng di nh bf ni"><div class="gh gi nn"><img src="../Images/bf89a2c60ac3742be8315ad77b4d32d9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*59-SvG_27Sep0lMX.png"/></div></div></figure><p id="3cf7" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">耶！</p><p id="fa24" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">其实——就这些。</p><p id="b9dd" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">最后的事情将是创建一个詹金斯工作。</p><p id="6278" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">哦，等等！忘了<code class="fe lh li lj lk b">ConfigMap</code>。</p><h2 id="4e5b" class="lt lu iq bd lv lw lx dn ly lz ma dp mb kf mc md me kj mf mg mh kn mi mj mk ml bi translated">另外，aws-auth <code class="fe lh li lj lk b">ConfigMap</code></h2><p id="15d3" class="pw-post-body-paragraph ju jv iq jw b jx mm jz ka kb mn kd ke kf mo kh ki kj mp kl km kn mq kp kq kr ij bi translated">无论你多么努力，你都会忘记一些事情。</p><p id="8523" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">所以——需要添加<em class="mr"> eks-root </em>，在这篇文章开始时创建的用户到我们正在创建的集群中。</p><p id="3696" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">它可以用一个命令和两个变量来完成。</p><p id="b3f4" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated"><em class="mr">注意:实际上，这将在每次供应运行时追加用户，因此在我的最终解决方案中，我以另一种方式完成了它，但现在我将它“按原样”保留在这里，稍后将添加更好的方式。</em></p><p id="eb9c" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">在<code class="fe lh li lj lk b">group_vars/all.yml</code>中添加一个用户的ARN:</p><pre class="ms mt mu mv gt mw lk mx my aw mz bi"><span id="9626" class="lt lu iq lk b gy na nb l nc nd">...<br/>eks_root_user_name: "eks-root"<br/>eks_root_user_arn: "arn:aws:iam::534***385:user/eks-root"</span></pre><p id="910e" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">并在<code class="fe lh li lj lk b">roles/eksctl/tasks/main.yml</code> -将他添加到集群中:</p><pre class="ms mt mu mv gt mw lk mx my aw mz bi"><span id="58cc" class="lt lu iq lk b gy na nb l nc nd">...<br/>- name: "Update aws-auth ConfigMap with the EKS root user {{ eks_root_user_name | upper }}"<br/>  command: "eksctl create iamidentitymapping --cluster {{ eks_cluster_name }} --arn {{ eks_root_user_arn }} --group system:masters --username {{  eks_root_user_name }}"</span></pre><p id="25aa" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">运行:</p><pre class="ms mt mu mv gt mw lk mx my aw mz bi"><span id="c58d" class="lt lu iq lk b gy na nb l nc nd">…<br/>TASK [eksctl : Running eksctl eksctl_action UPDATE cluster with name BTTRM-EKS-QA-TEST] ****<br/>changed: [localhost]<br/>TASK [eksctl : Update aws-auth ConfigMap with the EKS root user EKS-ROOT] ****<br/>changed: [localhost]<br/>…</span></pre><p id="19ab" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">回到RTFM的服务器，在那里我们只有<em class="mr"> eks-root </em>用户有“干净”的访问权，更新它的<code class="fe lh li lj lk b">~/.kube/config</code>:</p><pre class="ms mt mu mv gt mw lk mx my aw mz bi"><span id="cd89" class="lt lu iq lk b gy na nb l nc nd">root@rtfm-do-production:/home/setevoy# aws — region eu-west-3 eks update-kubeconfig — name bttrm-eks-qa-test<br/>Added new context arn:aws:eks:eu-west-3:534***385:cluster/bttrm-eks-qa-test to /root/.kube/config</span></pre><p id="9c69" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">尝试访问节点信息:</p><pre class="ms mt mu mv gt mw lk mx my aw mz bi"><span id="407b" class="lt lu iq lk b gy na nb l nc nd">root@rtfm-do-production:/home/setevoy# kubectl get node<br/>NAME STATUS ROLES AGE VERSION<br/>ip-10–1–40–182.eu-west-3.compute.internal Ready &lt;none&gt; 94m v1.15.10-eks-bac369<br/>ip-10–1–52–14.eu-west-3.compute.internal Ready &lt;none&gt; 94m v1.15.10-eks-bac369</span></pre><p id="d4ef" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">和豆荚:</p><pre class="ms mt mu mv gt mw lk mx my aw mz bi"><span id="1c8f" class="lt lu iq lk b gy na nb l nc nd">root@rtfm-do-production:/home/setevoy# kubectl get pod -n kube-system<br/>NAME READY STATUS RESTARTS AGE<br/>aws-node-rgpn5 1/1 Running 0 95m<br/>aws-node-xtr6m 1/1 Running 0 95m<br/>coredns-7ddddf5cc7–5w5wt 1/1 Running 0 102m<br/>…</span></pre><p id="5876" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">完成了。</p><h2 id="a1c3" class="lt lu iq bd lv lw lx dn ly lz ma dp mb kf mc md me kj mf mg mh kn mi mj mk ml bi translated">有用的链接</h2><h2 id="ae6b" class="lt lu iq bd lv lw lx dn ly lz ma dp mb kf mc md me kj mf mg mh kn mi mj mk ml bi translated">库伯内特斯</h2><ul class=""><li id="9aca" class="kt ku iq jw b jx mm kb mn kf no kj np kn nq kr ls kz la lb bi translated"><a class="ae ks" href="https://rtfm.co.ua/goto/https://www.weave.works/blog/introduction-to-kubernetes-pod-networking--part-1" rel="noopener ugc nofollow" target="_blank">Kubernetes Pod网络简介</a></li><li id="6924" class="kt ku iq jw b jx lc kb ld kf le kj lf kn lg kr ls kz la lb bi translated"><a class="ae ks" href="https://rtfm.co.ua/goto/https://www.weave.works/technologies/kubernetes-on-aws/" rel="noopener ugc nofollow" target="_blank"> Kubernetes on AWS:部署指南和最佳实践</a></li><li id="ac82" class="kt ku iq jw b jx lc kb ld kf le kj lf kn lg kr ls kz la lb bi translated"><a class="ae ks" href="https://rtfm.co.ua/goto/https://rancher.com/learning-paths/how-to-manage-kubernetes-with-kubectl/" rel="noopener ugc nofollow" target="_blank">如何用Kubectl管理Kubernetes】</a></li><li id="a1bd" class="kt ku iq jw b jx lc kb ld kf le kj lf kn lg kr ls kz la lb bi translated"><a class="ae ks" href="https://rtfm.co.ua/goto/https://kubernetes.io/docs/setup/best-practices/cluster-large/" rel="noopener ugc nofollow" target="_blank">建设大型集群</a></li><li id="9774" class="kt ku iq jw b jx lc kb ld kf le kj lf kn lg kr ls kz la lb bi translated"><a class="ae ks" href="https://rtfm.co.ua/goto/https://learnk8s.io/production-best-practices" rel="noopener ugc nofollow" target="_blank"> Kubernetes生产最佳实践</a></li></ul><h2 id="77b3" class="lt lu iq bd lv lw lx dn ly lz ma dp mb kf mc md me kj mf mg mh kn mi mj mk ml bi translated">Ansible</h2><ul class=""><li id="559d" class="kt ku iq jw b jx mm kb mn kf no kj np kn nq kr ls kz la lb bi translated"><a class="ae ks" href="https://rtfm.co.ua/goto/https://docs.ansible.com/ansible/latest/user_guide/playbooks_best_practices.html" rel="noopener ugc nofollow" target="_blank">最佳实践</a></li><li id="c18c" class="kt ku iq jw b jx lc kb ld kf le kj lf kn lg kr ls kz la lb bi translated"><a class="ae ks" href="https://rtfm.co.ua/goto/https://www.trek10.com/blog/ansible-cloudformation/" rel="noopener ugc nofollow" target="_blank">可行&amp;复杂工作流程的云形成</a></li></ul><h2 id="887d" class="lt lu iq bd lv lw lx dn ly lz ma dp mb kf mc md me kj mf mg mh kn mi mj mk ml bi translated">自动警报系统</h2><p id="e0c0" class="pw-post-body-paragraph ju jv iq jw b jx mm jz ka kb mn kd ke kf mo kh ki kj mp kl km kn mq kp kq kr ij bi translated">EKS</p><ul class=""><li id="c354" class="kt ku iq jw b jx jy kb kc kf kv kj kw kn kx kr ls kz la lb bi translated"><a class="ae ks" href="https://rtfm.co.ua/goto/https://www.codementor.io/@slavko/kubernetes-cluster-on-aws-eks-lecygk6rl" rel="noopener ugc nofollow" target="_blank">EKS自动气象站上的kubernetes集群</a></li><li id="b1dc" class="kt ku iq jw b jx lc kb ld kf le kj lf kn lg kr ls kz la lb bi translated"><a class="ae ks" href="https://rtfm.co.ua/goto/https://www.stackrox.com/post/2020/02/eks-vs-gke-vs-aks/" rel="noopener ugc nofollow" target="_blank"> EKS vs GKE vs AKS —评估云中的Kubernetes</a></li><li id="7e5a" class="kt ku iq jw b jx lc kb ld kf le kj lf kn lg kr ls kz la lb bi translated"><a class="ae ks" href="https://rtfm.co.ua/goto/https://s3.amazonaws.com/aws-quickstart/quickstart-amazon-eks/doc/amazon-eks-architecture.pdf" rel="noopener ugc nofollow" target="_blank">模块化和可扩展的亚马逊EKS架构</a></li><li id="71fa" class="kt ku iq jw b jx lc kb ld kf le kj lf kn lg kr ls kz la lb bi translated"><a class="ae ks" href="https://rtfm.co.ua/goto/https://www.agilepartner.net/en/build-a-kubernetes-cluster-with-eksctl/" rel="noopener ugc nofollow" target="_blank">使用eksctl构建kubernetes集群</a></li><li id="6a65" class="kt ku iq jw b jx lc kb ld kf le kj lf kn lg kr ls kz la lb bi translated"><a class="ae ks" href="https://rtfm.co.ua/goto/https://docs.aws.amazon.com/en_us/eks/latest/userguide/sec-group-reqs.html" rel="noopener ugc nofollow" target="_blank">亚马逊EKS安全组注意事项</a></li></ul><p id="f75f" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">云的形成</p><ul class=""><li id="1299" class="kt ku iq jw b jx jy kb kc kf kv kj kw kn kx kr ls kz la lb bi translated"><a class="ae ks" href="https://rtfm.co.ua/goto/https://programmaticponderings.com/2019/07/30/managing-aws-infrastructure-as-code-using-ansible-cloudformation-and-codebuild/" rel="noopener ugc nofollow" target="_blank">使用Ansible、CloudFormation和CodeBuild将AWS基础设施作为代码进行管理</a></li><li id="ac83" class="kt ku iq jw b jx lc kb ld kf le kj lf kn lg kr ls kz la lb bi translated"><a class="ae ks" href="https://rtfm.co.ua/goto/https://cloudacademy.com/blog/understanding-nested-cloudformation-stacks/" rel="noopener ugc nofollow" target="_blank">嵌套CloudFormation堆栈:开发者和系统管理员指南</a></li><li id="ad84" class="kt ku iq jw b jx lc kb ld kf le kj lf kn lg kr ls kz la lb bi translated"><a class="ae ks" href="https://rtfm.co.ua/goto/https://medium.com/@janethavishka/walkthrough-with-nested-cloudformation-stacks-d7709b568162" rel="noopener ugc nofollow">嵌套云形成堆栈的演练</a></li><li id="d7e7" class="kt ku iq jw b jx lc kb ld kf le kj lf kn lg kr ls kz la lb bi translated"><a class="ae ks" href="https://rtfm.co.ua/goto/https://aws.amazon.com/ru/premiumsupport/knowledge-center/cloudformation-parameters-nested-stacks/" rel="noopener ugc nofollow" target="_blank">如何将CommaDelimitedList参数传递给AWS CloudFormation中的嵌套堆栈？</a></li><li id="861d" class="kt ku iq jw b jx lc kb ld kf le kj lf kn lg kr ls kz la lb bi translated"><a class="ae ks" href="https://rtfm.co.ua/goto/https://aws.amazon.com/ru/premiumsupport/knowledge-center/multiple-values-list-parameter-cli/" rel="noopener ugc nofollow" target="_blank">如何在AWS CloudFormation模板中为单个参数使用多个值？</a></li><li id="d66d" class="kt ku iq jw b jx lc kb ld kf le kj lf kn lg kr ls kz la lb bi translated"><a class="ae ks" href="https://rtfm.co.ua/goto/https://sanderknape.com/2018/08/two-years-with-cloudformation-lessons-learned/" rel="noopener ugc nofollow" target="_blank">云形成两年:经验教训</a></li><li id="0cfb" class="kt ku iq jw b jx lc kb ld kf le kj lf kn lg kr ls kz la lb bi translated"><a class="ae ks" href="https://rtfm.co.ua/goto/https://www.jamesqmurphy.com/blog/2019/10/nested-stack" rel="noopener ugc nofollow" target="_blank">使用嵌套堆栈缩小膨胀的云形成模板</a></li><li id="a0cf" class="kt ku iq jw b jx lc kb ld kf le kj lf kn lg kr ls kz la lb bi translated"><a class="ae ks" href="https://rtfm.co.ua/goto/https://sbstjn.com/cloudformation.html#nested-stacks" rel="noopener ugc nofollow" target="_blank">云形成最佳实践</a></li><li id="298a" class="kt ku iq jw b jx lc kb ld kf le kj lf kn lg kr ls kz la lb bi translated"><a class="ae ks" href="https://rtfm.co.ua/goto/https://garbe.io/blog/2017/07/17/cloudformation-hacks/" rel="noopener ugc nofollow" target="_blank"> 7个可怕的云形成黑客</a></li><li id="65fa" class="kt ku iq jw b jx lc kb ld kf le kj lf kn lg kr ls kz la lb bi translated"><a class="ae ks" href="https://rtfm.co.ua/goto/https://jayendrapatil.com/aws-cloudformation-best-practices-certification/" rel="noopener ugc nofollow" target="_blank"> AWS云信息最佳实践—认证</a></li><li id="a3dc" class="kt ku iq jw b jx lc kb ld kf le kj lf kn lg kr ls kz la lb bi translated"><a class="ae ks" href="https://rtfm.co.ua/goto/https://blog.shikisoft.com/aws-cloudformation-no-value-pseudo-parameter/" rel="noopener ugc nofollow" target="_blank">在CloudFormation上使用AWS::NoValue有条件地定义资源属性</a></li></ul></div><div class="ab cl ll lm hu ln" role="separator"><span class="lo bw bk lp lq lr"/><span class="lo bw bk lp lq lr"/><span class="lo bw bk lp lq"/></div><div class="ij ik il im in"><p id="c950" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated"><em class="mr">最初发表于</em> <a class="ae ks" href="https://rtfm.co.ua/en/aws-elastic-kubernetes-service-a-cluster-creation-automation-part-2-ansible-eksctl/" rel="noopener ugc nofollow" target="_blank"> <em class="mr"> RTFM: Linux，devo PSисистемноеадмииитиованиииованиде</em></a><em class="mr">。</em></p></div></div>    
</body>
</html>