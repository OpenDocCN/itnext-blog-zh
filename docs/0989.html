<html>
<head>
<title>Kubernetes in production — PodDisruptionBudget</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">生产中的Kubernetes生产中断预算</h1>
<blockquote>原文：<a href="https://itnext.io/kubernetes-in-production-poddisruptionbudget-1380009aaede?source=collection_archive---------1-----------------------#2018-06-29">https://itnext.io/kubernetes-in-production-poddisruptionbudget-1380009aaede?source=collection_archive---------1-----------------------#2018-06-29</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="7e00" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如何管理Kubernetes中的中断？设置适当的滚动更新策略规范只能解决一种类型的中断。</p><p id="76ea" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">其他中断呢？</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi kl"><img src="../Images/08f72371c95f1b3c392b71791dd8e02f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*xAlGVTdwU0hvWFVV5CR1sA.png"/></div></div><figcaption class="kx ky gj gh gi kz la bd b be z dk translated">我的宝贝着火了[来源:谷歌图片]</figcaption></figure></div><div class="ab cl lb lc hu ld" role="separator"><span class="le bw bk lf lg lh"/><span class="le bw bk lf lg lh"/><span class="le bw bk lf lg"/></div><div class="ij ik il im in"><h1 id="d1a6" class="li lj iq bd lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf bi translated">自愿和非自愿中断</h1><p id="29a2" class="pw-post-body-paragraph jn jo iq jp b jq mg js jt ju mh jw jx jy mi ka kb kc mj ke kf kg mk ki kj kk ij bi translated">pod不会消失，直到有人(一个人或一个控制者)破坏它们，或者出现不可避免的硬件或系统软件错误。</p><p id="dcb1" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们将这些不可避免的情况称为对应用程序的非自愿中断。例如:</p><ul class=""><li id="b5bd" class="mm mn iq jp b jq jr ju jv jy mo kc mp kg mq kk mr ms mt mu bi translated">支持节点的物理机的硬件故障</li><li id="a541" class="mm mn iq jp b jq mv ju mw jy mx kc my kg mz kk mr ms mt mu bi translated">集群管理员误删除了虚拟机(实例)</li><li id="ecf1" class="mm mn iq jp b jq mv ju mw jy mx kc my kg mz kk mr ms mt mu bi translated">云提供商或虚拟机管理程序故障导致虚拟机消失</li><li id="776b" class="mm mn iq jp b jq mv ju mw jy mx kc my kg mz kk mr ms mt mu bi translated">严重的恐慌</li><li id="7e8d" class="mm mn iq jp b jq mv ju mw jy mx kc my kg mz kk mr ms mt mu bi translated">由于群集网络分区，节点从群集中消失</li><li id="57ca" class="mm mn iq jp b jq mv ju mw jy mx kc my kg mz kk mr ms mt mu bi translated">由于节点<a class="ae na" href="https://kubernetes.io/docs/tasks/administer-cluster/out-of-resource/" rel="noopener ugc nofollow" target="_blank">资源不足</a>而驱逐pod。</li></ul><p id="2e71" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">除了资源不足的情况，大多数用户应该熟悉所有这些情况；它们不是Kubernetes特有的。</p><p id="23aa" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们称其他情况为<em class="ml">自愿中断</em>。这些操作包括由应用程序所有者发起的操作和由集群管理员发起的操作。典型的应用程序所有者操作包括:</p><ul class=""><li id="b633" class="mm mn iq jp b jq jr ju jv jy mo kc mp kg mq kk mr ms mt mu bi translated">删除管理pod的部署或其他控制器</li><li id="a870" class="mm mn iq jp b jq mv ju mw jy mx kc my kg mz kk mr ms mt mu bi translated">更新部署的pod模板导致重新启动</li><li id="ee1a" class="mm mn iq jp b jq mv ju mw jy mx kc my kg mz kk mr ms mt mu bi translated">直接删除pod(例如意外删除)</li></ul><p id="2fb6" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">集群管理员操作包括:</p><ul class=""><li id="b53f" class="mm mn iq jp b jq jr ju jv jy mo kc mp kg mq kk mr ms mt mu bi translated"><a class="ae na" href="https://kubernetes.io/docs/tasks/administer-cluster/safely-drain-node/" rel="noopener ugc nofollow" target="_blank">排空节点</a>进行维修或升级。</li><li id="83c6" class="mm mn iq jp b jq mv ju mw jy mx kc my kg mz kk mr ms mt mu bi translated">从集群中排出一个节点以缩小集群(了解<a class="ae na" href="https://kubernetes.io/docs/tasks/administer-cluster/cluster-management/#cluster-autoscaler" rel="noopener ugc nofollow" target="_blank">集群自动缩放</a>)。</li><li id="3430" class="mm mn iq jp b jq mv ju mw jy mx kc my kg mz kk mr ms mt mu bi translated">从一个节点上移除一个pod以允许在该节点上安装其他东西。</li></ul></div><div class="ab cl lb lc hu ld" role="separator"><span class="le bw bk lf lg lh"/><span class="le bw bk lf lg lh"/><span class="le bw bk lf lg"/></div><div class="ij ik il im in"><h1 id="824c" class="li lj iq bd lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf bi translated">处理中断</h1><p id="439d" class="pw-post-body-paragraph jn jo iq jp b jq mg js jt ju mh jw jx jy mi ka kb kc mj ke kf kg mk ki kj kk ij bi translated">以下是一些减轻非自愿中断的方法:</p><ul class=""><li id="a494" class="mm mn iq jp b jq jr ju jv jy mo kc mp kg mq kk mr ms mt mu bi translated">确保你的pod <a class="ae na" href="https://kubernetes.io/docs/tasks/configure-pod-container/assign-cpu-ram-container" rel="noopener ugc nofollow" target="_blank">请求它需要的资源</a>。</li><li id="5fdc" class="mm mn iq jp b jq mv ju mw jy mx kc my kg mz kk mr ms mt mu bi translated">如果您需要更高的可用性，请复制您的应用程序。(了解如何运行复制的<a class="ae na" href="https://kubernetes.io/docs/tasks/run-application/run-stateless-application-deployment/" rel="noopener ugc nofollow" target="_blank">无状态</a>和<a class="ae na" href="https://kubernetes.io/docs/tasks/run-application/run-replicated-stateful-application/" rel="noopener ugc nofollow" target="_blank">有状态</a>应用程序。)</li><li id="7b68" class="mm mn iq jp b jq mv ju mw jy mx kc my kg mz kk mr ms mt mu bi translated">为了在运行复制的应用程序时获得更高的可用性，可以跨机架(使用<a class="ae na" href="https://kubernetes.io/docs/user-guide/node-selection/#inter-pod-affinity-and-anti-affinity-beta-feature" rel="noopener ugc nofollow" target="_blank">反亲缘</a>)或跨区域(如果使用<a class="ae na" href="https://kubernetes.io/docs/setup/multiple-zones" rel="noopener ugc nofollow" target="_blank">多区域集群</a>)分布应用程序。)</li></ul><h1 id="0581" class="li lj iq bd lk ll nb ln lo lp nc lr ls lt nd lv lw lx ne lz ma mb nf md me mf bi translated">PodDisruptionBudget</h1><p id="b4dd" class="pw-post-body-paragraph jn jo iq jp b jq mg js jt ju mh jw jx jy mi ka kb kc mj ke kf kg mk ki kj kk ij bi translated">应用程序所有者可以为每个应用程序创建一个<code class="fe ng nh ni nj b"><strong class="jp ir">PodDisruptionBudget</strong></code>对象(PDB)。PDB限制了因自愿中断而同时停机的复制应用程序的数量。例如，基于仲裁的应用程序希望确保运行的副本数量永远不会低于仲裁所需的数量。web前端可能希望确保为负载提供服务的副本数量永远不会低于总数的某个百分比。</p><p id="d6c7" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">集群管理器和托管提供商应该使用考虑Pod中断预算的工具，通过调用<a class="ae na" href="https://kubernetes.io/docs/tasks/administer-cluster/safely-drain-node/#the-eviction-api" rel="noopener ugc nofollow" target="_blank">驱逐API </a>而不是直接删除Pod。例如<code class="fe ng nh ni nj b"><strong class="jp ir">kubectl drain</strong></code>命令和Kubernetes-on-GCE集群升级脚本(<code class="fe ng nh ni nj b"><strong class="jp ir">cluster/gce/upgrade.sh</strong></code>)。</p><p id="8daa" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">当集群管理员想要清空一个节点时，他们使用<code class="fe ng nh ni nj b"><strong class="jp ir">kubectl drain</strong></code>命令。该工具试图驱逐机器上的所有pod。驱逐请求可以被暂时拒绝，并且该工具周期性地重试所有失败的请求，直到所有pod被终止，或者直到达到可配置的超时。</p><p id="fd69" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">使用minAvailable的PDB示例:</p><pre class="km kn ko kp gt nk nj nl nm aw nn bi"><span id="4040" class="no lj iq nj b gy np nq l nr ns"><strong class="nj ir">apiVersion: policy/v1beta1<br/>kind: PodDisruptionBudget<br/>metadata:<br/>  name: zk-pdb<br/>spec:<br/>  minAvailable: 2<br/>  selector:<br/>    matchLabels:<br/>      app: zookeeper</strong></span></pre><p id="1dbf" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">使用maxUnavailable的PDB示例(Kubernetes 1.7或更高版本):</p><pre class="km kn ko kp gt nk nj nl nm aw nn bi"><span id="c2cb" class="no lj iq nj b gy np nq l nr ns"><strong class="nj ir">apiVersion: policy/v1beta1<br/>kind: PodDisruptionBudget<br/>metadata:<br/>  name: zk-pdb<br/>spec:<br/>  maxUnavailable: 1<br/>  selector:<br/>    matchLabels:<br/>      app: zookeeper</strong></span></pre></div><div class="ab cl lb lc hu ld" role="separator"><span class="le bw bk lf lg lh"/><span class="le bw bk lf lg lh"/><span class="le bw bk lf lg"/></div><div class="ij ik il im in"><h1 id="bd4b" class="li lj iq bd lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf bi translated">舵</h1><p id="4e9b" class="pw-post-body-paragraph jn jo iq jp b jq mg js jt ju mh jw jx jy mi ka kb kc mj ke kf kg mk ki kj kk ij bi translated">在你的图表中使用这个！</p><p id="4470" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">templates/pdb.yaml:</p><pre class="km kn ko kp gt nk nj nl nm aw nn bi"><span id="a178" class="no lj iq nj b gy np nq l nr ns"><strong class="nj ir">{{- if .Values.budget.minAvailable -}}</strong><br/>apiVersion: policy/v1beta1<br/>kind: PodDisruptionBudget<br/>metadata:<br/>  name: {{ template "app.fullname" . }}<br/>  namespace: {{ .Values.namespace }}<br/>  labels:<br/>    app: {{ template "app.name" . }}<br/>    chart: {{ .Chart.Name }}-{{ .Chart.Version | replace "+" "_" }}<br/>    release: {{ .Release.Name }}<br/>    heritage: {{ .Release.Service }}<br/>spec:<br/>  selector:<br/>    matchLabels:<br/>      app: {{ template "app.name" . }}<br/>      env: {{ .Values.env.name }}<br/>  minAvailable: <strong class="nj ir">{{ .Values.budget.minAvailable }}</strong><br/><strong class="nj ir">{{- end -}}</strong></span></pre><p id="1373" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">假设您有一个包含2个副本的服务，即使在节点升级和其他操作任务期间，您也需要至少1个副本可用。</p><p id="99fc" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">安装/升级您的版本:</p><pre class="km kn ko kp gt nk nj nl nm aw nn bi"><span id="cef1" class="no lj iq nj b gy np nq l nr ns">helm upgrade --install --debug "$RELEASE_NAME" -f helm/values.yaml \ <strong class="nj ir">--set replicas=2,budget.minAvailable=1</strong> myrepo/mychart</span></pre><p id="97ac" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">kubectl描述pdb "$RELEASE_NAME "</p><pre class="km kn ko kp gt nk nj nl nm aw nn bi"><span id="91a2" class="no lj iq nj b gy np nq l nr ns">Name: mysvc-prod<br/>Namespace: prod<br/>Min available: 1<br/>Selector: app=myservice,env=prod<br/>Status:<br/><strong class="nj ir"> Allowed disruptions: 1<br/> Current: 2<br/> Desired: 1<br/> Total: 2</strong><br/>Events: &lt;none&gt;</span></pre><p id="da42" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在一个pod运行的情况下排空一个节点:</p><pre class="km kn ko kp gt nk nj nl nm aw nn bi"><span id="2e67" class="no lj iq nj b gy np nq l nr ns">kubectl drain --delete-local-data --force --ignore-daemonsets gke-mycluster-prod-pool-2fca4c85-k6g5</span><span id="c6ac" class="no lj iq nj b gy nt nq l nr ns">node "gke-mycluster-prod-pool-2fca4c85-k6g5" already cordoned<br/>WARNING: Deleting pods with local storage: sqlproxy-67f695889d-t778w; Ignoring DaemonSet-managed pods: fluentd-gcp-v3.0.0-llp5s; Deleting pods not managed by ReplicationController, ReplicaSet, Job, DaemonSet or StatefulSet: kube-proxy-gke-testing-dev-pool-2fca4c85-k6g5<br/>pod "tiller-deploy-7b7b795779-rcvkd" evicted<br/><strong class="nj ir">pod "mysvc-prod-6856d59f9b-lzrtf" evicted</strong><br/>node "gke-mycluster-prod-pool-2fca4c85-k6g5" drained</span></pre><p id="a3d2" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">再次:kubectl描述pdb "$RELEASE_NAME "</p><pre class="km kn ko kp gt nk nj nl nm aw nn bi"><span id="e380" class="no lj iq nj b gy np nq l nr ns">Name: mysvc-prod<br/>Namespace: prod<br/>Min available: 1<br/>Selector: app=myservice,env=prod<br/>Status:<br/><strong class="nj ir"> Allowed disruptions: 0<br/> Current: 1<br/> Desired: 1<br/> Total: 2</strong><br/>Events: &lt;none&gt;</span></pre><p id="16f4" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">Tadaaa！我们在没有任何服务中断的情况下清空了一个节点。</p><h1 id="3bd3" class="li lj iq bd lk ll nb ln lo lp nc lr ls lt nd lv lw lx ne lz ma mb nf md me mf bi translated">只有一个副本的PDB？</h1><p id="cdc1" class="pw-post-body-paragraph jn jo iq jp b jq mg js jt ju mh jw jx jy mi ka kb kc mj ke kf kg mk ki kj kk ij bi translated">如果我们只有一个副本，那么<a class="ae na" href="https://github.com/kubernetes/kubernetes/issues/48307" rel="noopener ugc nofollow" target="_blank"> <strong class="jp ir"> kubectl漏极将会阻塞</strong> </a> <strong class="jp ir">总是</strong>。节点消耗/升级需要手动解决。</p><p id="c60a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">您可能会期望驱逐API会尝试增加一个副本以符合minAvailable条件，但结果是排水管堵塞了，您有责任自己解决这种情况。是<strong class="jp ir"> bug还是特性</strong>？Kubernetes社区说，如果你想要HA，你根本不应该在生产中使用1个副本，这是公平的:)</p><p id="ba7f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">尽管如此，它还是做了预期的事情。</p><p id="5466" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果您不希望您的kubectl排出被阻塞，您可能希望使用PDB来部署多个副本。</p><p id="a933" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">编辑您的模板/pdb.yaml:</p><pre class="km kn ko kp gt nk nj nl nm aw nn bi"><span id="b1f0" class="no lj iq nj b gy np nq l nr ns">{{- if .Values.budget.minAvailable -}}<br/><strong class="nj ir">{{- if gt .Values.replicaCount 1 -}}</strong><br/>apiVersion: policy/v1beta1<br/>kind: PodDisruptionBudget<br/>metadata:<br/>...<br/><strong class="nj ir">{{- end -}}</strong><br/>{{- end -}}</span></pre></div><div class="ab cl lb lc hu ld" role="separator"><span class="le bw bk lf lg lh"/><span class="le bw bk lf lg lh"/><span class="le bw bk lf lg"/></div><div class="ij ik il im in"><h1 id="ba85" class="li lj iq bd lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf bi translated">如何在集群上执行破坏性操作</h1><p id="878c" class="pw-post-body-paragraph jn jo iq jp b jq mg js jt ju mh jw jx jy mi ka kb kc mj ke kf kg mk ki kj kk ij bi translated">如果您是集群管理员，并且需要在集群中的所有节点上执行中断性操作，例如节点或系统软件升级，以下是一些选项:</p><h2 id="f65d" class="no lj iq bd lk nu nv dn lo nw nx dp ls jy ny nz lw kc oa ob ma kg oc od me oe bi translated">接受升级期间的停机时间。</h2><h2 id="1ca9" class="no lj iq bd lk nu nv dn lo nw nx dp ls jy ny nz lw kc oa ob ma kg oc od me oe bi translated">故障转移到另一个完整的副本群集。</h2><ul class=""><li id="f4ba" class="mm mn iq jp b jq mg ju mh jy of kc og kg oh kk mr ms mt mu bi translated">没有停机时间，但对于复制的节点和协调切换的人工工作来说，成本可能很高。</li></ul><h2 id="25ca" class="no lj iq bd lk nu nv dn lo nw nx dp ls jy ny nz lw kc oa ob ma kg oc od me oe bi translated">编写容许中断的应用程序并使用pdb。</h2><ul class=""><li id="b82f" class="mm mn iq jp b jq mg ju mh jy of kc og kg oh kk mr ms mt mu bi translated">没有停机时间。</li><li id="8627" class="mm mn iq jp b jq mv ju mw jy mx kc my kg mz kk mr ms mt mu bi translated">最小的资源重复。</li><li id="4e8a" class="mm mn iq jp b jq mv ju mw jy mx kc my kg mz kk mr ms mt mu bi translated">允许更自动化的集群管理。</li><li id="3062" class="mm mn iq jp b jq mv ju mw jy mx kc my kg mz kk mr ms mt mu bi translated">编写容许中断的应用程序是棘手的，但是容许自愿中断的工作与支持自动伸缩和容许非自愿中断的工作有很大的重叠。</li></ul></div><div class="ab cl lb lc hu ld" role="separator"><span class="le bw bk lf lg lh"/><span class="le bw bk lf lg lh"/><span class="le bw bk lf lg"/></div><div class="ij ik il im in"><p id="e6b3" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">来源:<br/>文档<a class="ae na" href="https://kubernetes.io/docs/concepts/workloads/pods/disruptions/" rel="noopener ugc nofollow" target="_blank">https://kubernetes . io/docs/concepts/workloads/pods/disruptions/</a><br/>魔法</p></div></div>    
</body>
</html>