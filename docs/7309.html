<html>
<head>
<title>Use AWS App Runner, DynamoDB and CDK to deploy and run a Cloud native Go app</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用AWS App Runner、DynamoDB和CDK部署和运行云原生Go应用</h1>
<blockquote>原文：<a href="https://itnext.io/use-aws-app-runner-dynamodb-and-cdk-to-deploy-and-run-a-cloud-native-go-app-d4f2945610f6?source=collection_archive---------4-----------------------#2022-08-17">https://itnext.io/use-aws-app-runner-dynamodb-and-cdk-to-deploy-and-run-a-cloud-native-go-app-d4f2945610f6?source=collection_archive---------4-----------------------#2022-08-17</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><figure class="ip iq gp gr ir is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi io"><img src="../Images/c8401cfb95d4f80046da673ec3b101b0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*scUq1n9bC60eT_ZUfLaxVw.png"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">由DynamoDB支持的AWS App Runner上的Go应用程序</figcaption></figure><div class=""/><div class=""><h2 id="c644" class="pw-subtitle-paragraph kc je jf bd b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt dk translated">…并运行基准测试来测试自动扩展</h2></div><p id="f192" class="pw-post-body-paragraph ku kv jf kw b kx ky kg kz la lb kj lc ld le lf lg lh li lj lk ll lm ln lo lp ij bi translated">前面，我介绍了如何使用DynamoDB、AWS Lambda和API Gateway在AWS上构建一个无服务器的URL shortener应用程序。</p><div class="ip iq gp gr ir lq"><a href="https://betterprogramming.pub/build-a-serverless-url-shortener-with-go-ca198cb4d627" rel="noopener  ugc nofollow" target="_blank"><div class="lr ab fo"><div class="ls ab lt cl cj lu"><h2 class="bd jg gy z fp lv fr fs lw fu fw je bi translated">用Go建立一个无服务器的网址缩写器</h2><div class="lx l"><h3 class="bd b gy z fp lv fr fs lw fu fw dk translated">使用AWS Lambda、DynamoDB和API网关</h3></div><div class="ly l"><p class="bd b dl z fp lv fr fs lw fu fw dk translated">better编程. pub</p></div></div><div class="lz l"><div class="ma l mb mc md lz me ix lq"/></div></div></a></div><p id="18d4" class="pw-post-body-paragraph ku kv jf kw b kx ky kg kz la lb kj lc ld le lf lg lh li lj lk ll lm ln lo lp ij bi translated">在这篇博文中，我们将把它作为REST API部署在<a class="ae mf" href="https://docs.aws.amazon.com/apprunner/latest/dg/what-is-apprunner.html" rel="noopener ugc nofollow" target="_blank"> AWS App Runner </a>上，并继续使用<code class="fe mg mh mi mj b">DynamoDB</code>作为数据库。AWS App Runner是一种计算服务，可以轻松地从容器映像(或源代码)部署应用程序，管理它们的可伸缩性、部署管道等。</p><p id="1aa6" class="pw-post-body-paragraph ku kv jf kw b kx ky kg kz la lb kj lc ld le lf lg lh li lj lk ll lm ln lo lp ij bi translated">借助本博客中的一个实例，你将:</p><ul class=""><li id="77f8" class="mk ml jf kw b kx ky la lb ld mm lh mn ll mo lp mp mq mr ms bi translated">了解AWS App Runner，如何将其与<code class="fe mg mh mi mj b">DynamoDB</code>集成</li><li id="e9a5" class="mk ml jf kw b kx mt la mu ld mv lh mw ll mx lp mp mq mr ms bi translated">运行简单的基准测试，探索您的应用程序运行者服务的可伸缩性特征，以及<code class="fe mg mh mi mj b">DynamoDB</code></li><li id="ece3" class="mk ml jf kw b kx mt la mu ld mv lh mw ll mx lp mp mq mr ms bi translated">使用<a class="ae mf" href="https://docs.aws.amazon.com/cdk/v2/guide/work-with-cdk-go.html" rel="noopener ugc nofollow" target="_blank"> AWS CDK Go </a>应用“基础设施即代码”并部署整个堆栈，包括数据库、应用程序和其他AWS资源。</li><li id="b610" class="mk ml jf kw b kx mt la mu ld mv lh mw ll mx lp mp mq mr ms bi translated">另请参见<a class="ae mf" href="https://pkg.go.dev/github.com/aws/aws-sdk-go-v2/service/dynamodb" rel="noopener ugc nofollow" target="_blank"> DynamoDB Go SDK </a> (v2)的运行以及一些基本操作，如<code class="fe mg mh mi mj b">PutItem</code>、<code class="fe mg mh mi mj b">GetItem</code>。</li></ul></div><div class="ab cl my mz hu na" role="separator"><span class="nb bw bk nc nd ne"/><span class="nb bw bk nc nd ne"/><span class="nb bw bk nc nd"/></div><div class="ij ik il im in"><h1 id="08a1" class="nf ng jf bd nh ni nj nk nl nm nn no np kl nq km nr ko ns kp nt kr nu ks nv nw bi translated">让我们从部署URL shortener应用程序开始</h1><blockquote class="nx ny nz"><p id="300a" class="ku kv oa kw b kx ky kg kz la lb kj lc ob le lf lg oc li lj lk od lm ln lo lp ij bi translated"><em class="jf">在你开始之前，确保你已经安装了</em> <a class="ae mf" href="https://go.dev/dl/" rel="noopener ugc nofollow" target="_blank"> <em class="jf"> Go编程语言</em></a><em class="jf">(</em><strong class="kw jg"><em class="jf">v 1.16</em></strong><em class="jf">或更高版本)和</em><a class="ae mf" href="https://docs.aws.amazon.com/cdk/v2/guide/getting_started.html#getting_started_install" rel="noopener ugc nofollow" target="_blank"><em class="jf">AWS CDK</em></a><em class="jf">。</em></p></blockquote><p id="5908" class="pw-post-body-paragraph ku kv jf kw b kx ky kg kz la lb kj lc ld le lf lg lh li lj lk ll lm ln lo lp ij bi translated">克隆项目并切换到正确的目录:</p><pre class="oe of og oh gt oi mj oj ok aw ol bi"><span id="bc23" class="om ng jf mj b gy on oo l op oq">git clone https://github.com/abhirockzz/apprunner-dynamodb-golang<br/>cd cdk</span></pre><p id="7a6a" class="pw-post-body-paragraph ku kv jf kw b kx ky kg kz la lb kj lc ld le lf lg lh li lj lk ll lm ln lo lp ij bi translated"><strong class="kw jg">开始部署… </strong></p><p id="e736" class="pw-post-body-paragraph ku kv jf kw b kx ky kg kz la lb kj lc ld le lf lg lh li lj lk ll lm ln lo lp ij bi translated">运行<code class="fe mg mh mi mj b">cdk deploy</code>并提供您的确认以继续。随后的部分将为您提供CDK代码的浏览，让您更好地理解正在发生的事情。</p><pre class="oe of og oh gt oi mj oj ok aw ol bi"><span id="f62c" class="om ng jf mj b gy on oo l op oq">cdk deploy</span></pre><figure class="oe of og oh gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi or"><img src="../Images/8ce0a5a7cf1580be5607d7aaaf757e54.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*Webppga3HhV_CSUK.png"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">CDK部署(启动)</figcaption></figure><p id="63ca" class="pw-post-body-paragraph ku kv jf kw b kx ky kg kz la lb kj lc ld le lf lg lh li lj lk ll lm ln lo lp ij bi translated">这将开始创建我们的应用程序所需的AWS资源。</p><blockquote class="nx ny nz"><p id="e9fd" class="ku kv oa kw b kx ky kg kz la lb kj lc ob le lf lg oc li lj lk od lm ln lo lp ij bi translated"><em class="jf">如果您想查看将在后台使用的AWS CloudFormation模板，运行</em> <code class="fe mg mh mi mj b"><em class="jf">cdk synth</em></code> <em class="jf">并检查</em> <code class="fe mg mh mi mj b"><em class="jf">cdk.out</em></code> <em class="jf">文件夹</em></p></blockquote><p id="6b6e" class="pw-post-body-paragraph ku kv jf kw b kx ky kg kz la lb kj lc ld le lf lg lh li lj lk ll lm ln lo lp ij bi translated">您可以在终端中跟踪进度或导航到AWS控制台:<code class="fe mg mh mi mj b">CloudFormation &gt; Stacks &gt; DynamoDBAppRunnerStack</code></p><figure class="oe of og oh gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi or"><img src="../Images/5ae52dfee55e74186bbac9846b818927.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*AmX9wRn52NR06lJq.png"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">云形成堆栈资源</figcaption></figure><p id="eceb" class="pw-post-body-paragraph ku kv jf kw b kx ky kg kz la lb kj lc ld le lf lg lh li lj lk ll lm ln lo lp ij bi translated">一旦创建了所有的资源，您就应该拥有<code class="fe mg mh mi mj b">DynamoDB</code>表、App Runner服务(以及相关的IAM角色等)。).</p><p id="0f07" class="pw-post-body-paragraph ku kv jf kw b kx ky kg kz la lb kj lc ld le lf lg lh li lj lk ll lm ln lo lp ij bi translated"><strong class="kw jg">App Runner上的URL shortener服务</strong></p><p id="2389" class="pw-post-body-paragraph ku kv jf kw b kx ky kg kz la lb kj lc ld le lf lg lh li lj lk ll lm ln lo lp ij bi translated">您应该会看到刚刚部署的App Runner服务的登录页面。</p><figure class="oe of og oh gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi or"><img src="../Images/04ad4dd372333228e573d94b879a8cc3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*V1yRj_lo8iK_Ip4W.png"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">App Runner服务概述</figcaption></figure><p id="abba" class="pw-post-body-paragraph ku kv jf kw b kx ky kg kz la lb kj lc ld le lf lg lh li lj lk ll lm ln lo lp ij bi translated">还要查看<strong class="kw jg">配置</strong>下的<strong class="kw jg">服务设置</strong>，它显示了环境变量(由CDK在运行时配置)以及我们指定的计算资源(1 <code class="fe mg mh mi mj b">VCPU</code>和2 <code class="fe mg mh mi mj b">GB</code></p><figure class="oe of og oh gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi or"><img src="../Images/89e5fb204f412b6f6df673414d116029.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*KdER2tzdSNferxBv.png"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">App Runner服务设置</figcaption></figure></div><div class="ab cl my mz hu na" role="separator"><span class="nb bw bk nc nd ne"/><span class="nb bw bk nc nd ne"/><span class="nb bw bk nc nd"/></div><div class="ij ik il im in"><h1 id="ffc6" class="nf ng jf bd nh ni nj nk nl nm nn no np kl nq km nr ko ns kp nt kr nu ks nv nw bi translated">我们的网址缩写已经准备好了！</h1><p id="cd2a" class="pw-post-body-paragraph ku kv jf kw b kx os kg kz la ot kj lc ld ou lf lg lh ov lj lk ll ow ln lo lp ij bi translated">该应用程序相对简单，公开了两个端点:</p><ol class=""><li id="3f1f" class="mk ml jf kw b kx ky la lb ld mm lh mn ll mo lp ox mq mr ms bi translated">创建URL的短链接</li><li id="cd5e" class="mk ml jf kw b kx mt la mu ld mv lh mw ll mx lp ox mq mr ms bi translated">通过短链接访问原始URL</li></ol><p id="d904" class="pw-post-body-paragraph ku kv jf kw b kx ky kg kz la lb kj lc ld le lf lg lh li lj lk ll lm ln lo lp ij bi translated">要试用该应用程序，您需要通过App Runner服务获得端点URL提供者。它在堆栈输出中可用(在终端或AWS CloudFormation控制台的<strong class="kw jg">输出</strong>选项卡中，用于您的堆栈):</p><figure class="oe of og oh gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi or"><img src="../Images/94325e07d79143a180c61e9c9afbc164.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*3CKFGirpsGIQSfQK.png"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">App Runner URL</figcaption></figure><p id="64f1" class="pw-post-body-paragraph ku kv jf kw b kx ky kg kz la lb kj lc ld le lf lg lh li lj lk ll lm ln lo lp ij bi translated">首先，将App Runner服务端点导出为环境变量，</p><pre class="oe of og oh gt oi mj oj ok aw ol bi"><span id="4cad" class="om ng jf mj b gy on oo l op oq">export APP_URL=&lt;enter App Runner service URL&gt;</span><span id="9b1d" class="om ng jf mj b gy oy oo l op oq"># example<br/>export APP_URL=https://jt6jjprtyi.us-east-1.awsapprunner.com</span></pre><p id="5df1" class="pw-post-body-paragraph ku kv jf kw b kx ky kg kz la lb kj lc ld le lf lg lh li lj lk ll lm ln lo lp ij bi translated">使用您希望通过一个短链接访问的URL来调用它。</p><pre class="oe of og oh gt oi mj oj ok aw ol bi"><span id="f8e9" class="om ng jf mj b gy on oo l op oq">curl -i -X POST -d 'https://abhirockzz.github.io/' $APP_URL</span><span id="c89d" class="om ng jf mj b gy oy oo l op oq"># output<br/>HTTP/1.1 200 OK<br/>Date: Thu, 21 Jul 2022 11:03:40 GMT<br/>Content-Length: 25<br/>Content-Type: text/plain; charset=utf-8</span><span id="b5b6" class="om ng jf mj b gy oy oo l op oq">{"ShortCode":"ae1e31a6"}</span></pre><p id="3c65" class="pw-post-body-paragraph ku kv jf kw b kx ky kg kz la lb kj lc ld le lf lg lh li lj lk ll lm ln lo lp ij bi translated">您应该得到一个带有简短代码的<code class="fe mg mh mi mj b">JSON</code>响应，并在<code class="fe mg mh mi mj b">DynamoDB</code>表中看到一个条目:</p><figure class="oe of og oh gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi or"><img src="../Images/15384912a1bf09bb71fbd81ff3ae60cb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*qrID-orlEELEK-nP.png"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">DynamoDB记录</figcaption></figure><p id="6fca" class="pw-post-body-paragraph ku kv jf kw b kx ky kg kz la lb kj lc ld le lf lg lh li lj lk ll lm ln lo lp ij bi translated">您可以使用其他一些URL继续测试应用程序。</p><p id="6a29" class="pw-post-body-paragraph ku kv jf kw b kx ky kg kz la lb kj lc ld le lf lg lh li lj lk ll lm ln lo lp ij bi translated"><strong class="kw jg">访问与短代码相关联的URL</strong></p><p id="a623" class="pw-post-body-paragraph ku kv jf kw b kx ky kg kz la lb kj lc ld le lf lg lh li lj lk ll lm ln lo lp ij bi translated">…在浏览器中输入以下内容<code class="fe mg mh mi mj b">http://&lt;enter APP_URL&gt;/&lt;shortcode&gt;</code></p><p id="3eab" class="pw-post-body-paragraph ku kv jf kw b kx ky kg kz la lb kj lc ld le lf lg lh li lj lk ll lm ln lo lp ij bi translated">比如你输入<code class="fe mg mh mi mj b">https://jt6jjprtyi.us-east-1.awsapprunner.com/ae1e31a6</code>，就会被重定向到原来的网址。</p><p id="068c" class="pw-post-body-paragraph ku kv jf kw b kx ky kg kz la lb kj lc ld le lf lg lh li lj lk ll lm ln lo lp ij bi translated">也可以用<code class="fe mg mh mi mj b">curl</code>。这里有一个例子:</p><pre class="oe of og oh gt oi mj oj ok aw ol bi"><span id="e27c" class="om ng jf mj b gy on oo l op oq">export APP_URL=https://jt6jjprtyi.us-east-1.awsapprunner.com</span><span id="0a4d" class="om ng jf mj b gy oy oo l op oq">curl -i $APP_URL/ae1e31a6</span><span id="94c1" class="om ng jf mj b gy oy oo l op oq"># output<br/>HTTP/1.1 302 Found<br/>Location: https://abhirockzz.github.io/<br/>Date: Thu, 21 Jul 2022 11:07:58 GMT<br/>Content-Length: 0</span></pre></div><div class="ab cl my mz hu na" role="separator"><span class="nb bw bk nc nd ne"/><span class="nb bw bk nc nd ne"/><span class="nb bw bk nc nd"/></div><div class="ij ik il im in"><h1 id="d5ae" class="nf ng jf bd nh ni nj nk nl nm nn no np kl nq km nr ko ns kp nt kr nu ks nv nw bi translated">自动缩放正在运行</h1><p id="9728" class="pw-post-body-paragraph ku kv jf kw b kx os kg kz la ot kj lc ld ou lf lg lh ov lj lk ll ow ln lo lp ij bi translated">App Runner和<code class="fe mg mh mi mj b">DynamoDB</code>都能够根据工作负载进行伸缩。</p><p id="bf14" class="pw-post-body-paragraph ku kv jf kw b kx ky kg kz la lb kj lc ld le lf lg lh li lj lk ll lm ln lo lp ij bi translated"><strong class="kw jg"> AWS应用程序运行器</strong></p><p id="cf09" class="pw-post-body-paragraph ku kv jf kw b kx ky kg kz la lb kj lc ld le lf lg lh li lj lk ll lm ln lo lp ij bi translated">AWS App Runner会自动增加实例数量以响应流量的增加，并在流量减少时减少实例数量。</p><blockquote class="nx ny nz"><p id="1142" class="ku kv oa kw b kx ky kg kz la lb kj lc ob le lf lg oc li lj lk od lm ln lo lp ij bi translated"><em class="jf">这基于自动扩展配置，由以下用户定义的属性驱动——最大并发、最大大小和最小大小。详见</em> <a class="ae mf" href="https://docs.aws.amazon.com/apprunner/latest/dg/manage-autoscaling.html" rel="noopener ugc nofollow" target="_blank"> <em class="jf">管理App Runner自动缩放</em> </a></p></blockquote><p id="fcfd" class="pw-post-body-paragraph ku kv jf kw b kx ky kg kz la lb kj lc ld le lf lg lh li lj lk ll lm ln lo lp ij bi translated">以下是URL shortener App Runner服务的自动缩放配置:</p><figure class="oe of og oh gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi or"><img src="../Images/c36c9117a6f67c282f52e7b62e7ed65c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*vrRWFksk22sap0Ce.png"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">App Runner自动扩展配置</figcaption></figure><p id="210e" class="pw-post-body-paragraph ku kv jf kw b kx ky kg kz la lb kj lc ld le lf lg lh li lj lk ll lm ln lo lp ij bi translated"><strong class="kw jg"> DynamoDB </strong></p><p id="8795" class="pw-post-body-paragraph ku kv jf kw b kx ky kg kz la lb kj lc ld le lf lg lh li lj lk ll lm ln lo lp ij bi translated">在<a class="ae mf" href="https://docs.aws.amazon.com/amazondynamodb/latest/developerguide/HowItWorks.ReadWriteCapacityMode.html#HowItWorks.OnDemand" rel="noopener ugc nofollow" target="_blank">按需模式</a>的情况下，<code class="fe mg mh mi mj b">DynamoDB</code>会在您的工作负载上升或下降到任何先前达到的流量水平时立即适应它们。<a class="ae mf" href="https://docs.aws.amazon.com/amazondynamodb/latest/developerguide/HowItWorks.ReadWriteCapacityMode.html#HowItWorks.ProvisionedThroughput.Manual" rel="noopener ugc nofollow" target="_blank">调配模式</a>要求我们指定您的应用所需的每秒读写次数，但您可以使用自动缩放功能来自动调整您的表的调配容量，以响应流量变化。</p></div><div class="ab cl my mz hu na" role="separator"><span class="nb bw bk nc nd ne"/><span class="nb bw bk nc nd ne"/><span class="nb bw bk nc nd"/></div><div class="ij ik il im in"><h1 id="092b" class="nf ng jf bd nh ni nj nk nl nm nn no np kl nq km nr ko ns kp nt kr nu ks nv nw bi translated">让我们运行一些测试</h1><p id="685c" class="pw-post-body-paragraph ku kv jf kw b kx os kg kz la ot kj lc ld ou lf lg lh ov lj lk ll ow ln lo lp ij bi translated">我们可以运行一个简单的基准测试，并见证我们的服务如何反应。我将使用名为<a class="ae mf" href="https://github.com/rakyll/hey#installation" rel="noopener ugc nofollow" target="_blank">嘿</a>的负载测试工具，但是你也可以使用Apache Bench等。</p><p id="df52" class="pw-post-body-paragraph ku kv jf kw b kx ky kg kz la lb kj lc ld le lf lg lh li lj lk ll lm ln lo lp ij bi translated">这是我们要做的:</p><ol class=""><li id="fd2b" class="mk ml jf kw b kx ky la lb ld mm lh mn ll mo lp ox mq mr ms bi translated">从一个简单的测试开始，检查响应。</li><li id="f102" class="mk ml jf kw b kx mt la mu ld mv lh mw ll mx lp ox mq mr ms bi translated">增加负载，使其超过为<code class="fe mg mh mi mj b">DynamoDB</code>表提供的容量。</li><li id="0588" class="mk ml jf kw b kx mt la mu ld mv lh mw ll mx lp ox mq mr ms bi translated">更新<code class="fe mg mh mi mj b">DynamoDB</code>表容量并重复。</li></ol><p id="5eb2" class="pw-post-body-paragraph ku kv jf kw b kx ky kg kz la lb kj lc ld le lf lg lh li lj lk ll lm ln lo lp ij bi translated"><a class="ae mf" href="https://github.com/rakyll/hey#installation" rel="noopener ugc nofollow" target="_blank">安装hey </a>并与<code class="fe mg mh mi mj b">50</code>工作人员同时执行基本测试— <code class="fe mg mh mi mj b">200</code>请求(按照默认设置):</p><pre class="oe of og oh gt oi mj oj ok aw ol bi"><span id="c52b" class="om ng jf mj b gy on oo l op oq">hey $APP_URL/&lt;enter the short code&gt;</span><span id="397f" class="om ng jf mj b gy oy oo l op oq">#example<br/>hey <a class="ae mf" href="https://jt6jjprtyi.us-east-1.awsapprunner.com/ae1e31a6" rel="noopener ugc nofollow" target="_blank">https://jt6jjprtyi.us-east-1.awsapprunner.com/ae1e31a6</a></span></pre><p id="151a" class="pw-post-body-paragraph ku kv jf kw b kx ky kg kz la lb kj lc ld le lf lg lh li lj lk ll lm ln lo lp ij bi translated">这应该在我们堆栈的容量范围之内。让我们把它提升到<code class="fe mg mh mi mj b">500</code>并发工作器来执行<em class="oa">持续</em>4分钟的请求。</p><pre class="oe of og oh gt oi mj oj ok aw ol bi"><span id="fe91" class="om ng jf mj b gy on oo l op oq">hey -c 500 -z 4m $APP_URL/&lt;enter the short code&gt;</span><span id="9da7" class="om ng jf mj b gy oy oo l op oq">#example<br/>hey -c 500 -z 4m <a class="ae mf" href="https://jt6jjprtyi.us-east-1.awsapprunner.com/ae1e31a6" rel="noopener ugc nofollow" target="_blank">https://jt6jjprtyi.us-east-1.awsapprunner.com/ae1e31a6</a></span></pre><p id="70ad" class="pw-post-body-paragraph ku kv jf kw b kx ky kg kz la lb kj lc ld le lf lg lh li lj lk ll lm ln lo lp ij bi translated"><strong class="kw jg">dynamo db做的怎么样？</strong></p><p id="257e" class="pw-post-body-paragraph ku kv jf kw b kx ky kg kz la lb kj lc ld le lf lg lh li lj lk ll lm ln lo lp ij bi translated">在<code class="fe mg mh mi mj b">DynamoDB</code>控制台的<strong class="kw jg">表容量指标</strong>下，检查<strong class="kw jg">读取使用量(平均单位/秒)</strong>:</p><figure class="oe of og oh gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi or"><img src="../Images/350563cbaac404d0f0c76d66abc05a58.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*h7frUIp1SEK9QB-Q.png"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">DynamoDB节流</figcaption></figure><p id="c16a" class="pw-post-body-paragraph ku kv jf kw b kx ky kg kz la lb kj lc ld le lf lg lh li lj lk ll lm ln lo lp ij bi translated">更重要的是，检查<strong class="kw jg">读取节流事件(计数)</strong>:</p><figure class="oe of og oh gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi or"><img src="../Images/94f53d986746b7e6fcfdaa22caae10e6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*GSqbHOZu7kgWQslp.png"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">DynamoDB节流</figcaption></figure><p id="4c8e" class="pw-post-body-paragraph ku kv jf kw b kx ky kg kz la lb kj lc ld le lf lg lh li lj lk ll lm ln lo lp ij bi translated">由于我们的表处于<code class="fe mg mh mi mj b">Provisioned</code>容量模式(有5个<code class="fe mg mh mi mj b">RCU</code>和<code class="fe mg mh mi mj b">WCU</code>，请求受到限制，其中一些失败了。</p><p id="5b86" class="pw-post-body-paragraph ku kv jf kw b kx ky kg kz la lb kj lc ld le lf lg lh li lj lk ll lm ln lo lp ij bi translated">编辑表格，将其模式更改为<strong class="kw jg">按需</strong>，重新运行负载测试。您现在应该不会看到节流错误，因为<code class="fe mg mh mi mj b">DynamoDB</code>会根据负载自动伸缩。</p><figure class="oe of og oh gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi or"><img src="../Images/09d80dff9ceb81e8b60c36359d265190.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*mvYvrlWDD66Go8w9.png"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">更新DynamoDB容量</figcaption></figure><p id="4e87" class="pw-post-body-paragraph ku kv jf kw b kx ky kg kz la lb kj lc ld le lf lg lh li lj lk ll lm ln lo lp ij bi translated"><strong class="kw jg">App Runner怎么样？？</strong></p><p id="53a2" class="pw-post-body-paragraph ku kv jf kw b kx ky kg kz la lb kj lc ld le lf lg lh li lj lk ll lm ln lo lp ij bi translated">在App Runner控制台的<strong class="kw jg">指标</strong>设置中，检查<strong class="kw jg">活动实例</strong>计数。</p><figure class="oe of og oh gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi or"><img src="../Images/155e5d3f5d43353aeef8eb01934f8614.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*SFyw981eivRPbl8T.png"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">App Runner自动缩放</figcaption></figure><blockquote class="nx ny nz"><p id="2daa" class="ku kv oa kw b kx ky kg kz la lb kj lc ob le lf lg oc li lj lk od lm ln lo lp ij bi translated"><em class="jf">您还可以跟踪其他指标，试验各种负载能力</em></p></blockquote><p id="d40b" class="pw-post-body-paragraph ku kv jf kw b kx ky kg kz la lb kj lc ld le lf lg lh li lj lk ll lm ln lo lp ij bi translated">好了，现在你已经看到了<strong class="kw jg">应用程序做了什么</strong>并且检查了堆栈的基本可伸缩性特征，让我们继续讨论<strong class="kw jg">如何做</strong>。</p><p id="c234" class="pw-post-body-paragraph ku kv jf kw b kx ky kg kz la lb kj lc ld le lf lg lh li lj lk ll lm ln lo lp ij bi translated">但是，在那之前…</p><p id="213f" class="pw-post-body-paragraph ku kv jf kw b kx ky kg kz la lb kj lc ld le lf lg lh li lj lk ll lm ln lo lp ij bi translated"><strong class="kw jg">别忘了删除资源！</strong></p><p id="b8e3" class="pw-post-body-paragraph ku kv jf kw b kx ky kg kz la lb kj lc ld le lf lg lh li lj lk ll lm ln lo lp ij bi translated">完成后，要删除所有服务，只需使用:</p><pre class="oe of og oh gt oi mj oj ok aw ol bi"><span id="cedb" class="om ng jf mj b gy on oo l op oq">cdk destroy</span></pre></div><div class="ab cl my mz hu na" role="separator"><span class="nb bw bk nc nd ne"/><span class="nb bw bk nc nd ne"/><span class="nb bw bk nc nd"/></div><div class="ij ik il im in"><h1 id="2b49" class="nf ng jf bd nh ni nj nk nl nm nn no np kl nq km nr ko ns kp nt kr nu ks nv nw bi translated">AWS CDK代码演练…</h1><p id="50b9" class="pw-post-body-paragraph ku kv jf kw b kx os kg kz la ot kj lc ld ou lf lg lh ov lj lk ll ow ln lo lp ij bi translated">我们将讨论<code class="fe mg mh mi mj b">NewDynamoDBAppRunnerStack</code>函数的关键部分，它定义了URL shortener应用程序所需的整个堆栈(<em class="oa">为了简洁起见，我省略了一些代码</em>)。</p><blockquote class="nx ny nz"><p id="54b1" class="ku kv oa kw b kx ky kg kz la lb kj lc ob le lf lg oc li lj lk od lm ln lo lp ij bi translated"><em class="jf">可以参考</em> <a class="ae mf" href="https://github.com/abhirockzz/apprunner-dynamodb-golang/tree/master/cdk" rel="noopener ugc nofollow" target="_blank"> <em class="jf"> GitHub </em> </a>上的完整代码</p></blockquote><p id="1a9d" class="pw-post-body-paragraph ku kv jf kw b kx ky kg kz la lb kj lc ld le lf lg lh li lj lk ll lm ln lo lp ij bi translated">我们首先定义一个<code class="fe mg mh mi mj b">DynamoDB</code>表，用<code class="fe mg mh mi mj b">shorturl</code>作为分区键(我们的例子不需要范围/排序键)。请注意，<code class="fe mg mh mi mj b">BillingMode</code>属性决定了表容量模式，在本例中是<strong class="kw jg">提供的</strong>(带有5个<code class="fe mg mh mi mj b">RCU</code>和<code class="fe mg mh mi mj b">WCU</code>)。如前一节所示，这是有意选择的。</p><pre class="oe of og oh gt oi mj oj ok aw ol bi"><span id="e046" class="om ng jf mj b gy on oo l op oq">func NewDynamoDBAppRunnerStack(scope constructs.Construct, id string, props *DynamoDBAppRunnerStackProps) awscdk.Stack {<br/>  //....<br/>    dynamoDBTable := awsdynamodb.NewTable(stack, jsii.String("dynamodb-short-urls-table"),<br/>        &amp;awsdynamodb.TableProps{<br/>            PartitionKey: &amp;awsdynamodb.Attribute{<br/>                Name: jsii.String(shortCodeDynamoDBAttributeName),<br/>                Type: awsdynamodb.AttributeType_STRING,<br/>            },<br/>            BillingMode:   awsdynamodb.BillingMode_PROVISIONED,<br/>            ReadCapacity:  jsii.Number(5),<br/>            WriteCapacity: jsii.Number(5),<br/>            RemovalPolicy: awscdk.RemovalPolicy_DESTROY,<br/>        })<br/>  //...</span></pre><p id="e418" class="pw-post-body-paragraph ku kv jf kw b kx ky kg kz la lb kj lc ld le lf lg lh li lj lk ll lm ln lo lp ij bi translated">然后，我们用<a class="ae mf" href="https://pkg.go.dev/github.com/aws/aws-cdk-go/awscdk/v2/awsiam#NewRole" rel="noopener ugc nofollow" target="_blank"> awsiam。NewRole </a>定义一个新的IAM角色，并添加一个允许App Runner执行<code class="fe mg mh mi mj b">DynamoDB</code>中的操作的策略。在这种情况下，我们提供粒度权限- <a class="ae mf" href="https://docs.aws.amazon.com/amazondynamodb/latest/APIReference/API_GetItem.html" rel="noopener ugc nofollow" target="_blank"> GetItem </a>和<a class="ae mf" href="https://docs.aws.amazon.com/amazondynamodb/latest/APIReference/API_PutItem.html" rel="noopener ugc nofollow" target="_blank"> PutItem </a>。</p><pre class="oe of og oh gt oi mj oj ok aw ol bi"><span id="72ec" class="om ng jf mj b gy on oo l op oq">//...<br/>apprunnerDynamoDBIAMrole := awsiam.NewRole(stack, jsii.String("role-apprunner-dynamodb"),<br/>        &amp;awsiam.RoleProps{<br/>            AssumedBy: awsiam.NewServicePrincipal(jsii.String("tasks.apprunner.amazonaws.com"), nil),<br/>        })</span><span id="d8fc" class="om ng jf mj b gy oy oo l op oq">apprunnerDynamoDBIAMrole.AddToPolicy(awsiam.NewPolicyStatement(&amp;awsiam.PolicyStatementProps{<br/>        Effect:    awsiam.Effect_ALLOW,<br/>        Actions:   jsii.Strings("dynamodb:GetItem", "dynamodb:PutItem"),<br/>        Resources: jsii.Strings(*dynamoDBTable.TableArn())}))</span></pre><p id="e0b9" class="pw-post-body-paragraph ku kv jf kw b kx ky kg kz la lb kj lc ld le lf lg lh li lj lk ll lm ln lo lp ij bi translated"><a class="ae mf" href="https://pkg.go.dev/github.com/aws/aws-cdk-go/awscdk/v2/awsecrassets#NewDockerImageAsset" rel="noopener ugc nofollow" target="_blank"> awsecrassets。NewDockerImageAsset </a>允许创建我们的应用程序Docker映像并将其推送到ECR——只需一行代码。</p><pre class="oe of og oh gt oi mj oj ok aw ol bi"><span id="d43b" class="om ng jf mj b gy on oo l op oq">//...<br/>appDockerImage := awsecrassets.NewDockerImageAsset(stack, jsii.String("app-image"),<br/>        &amp;awsecrassets.DockerImageAssetProps{<br/>            Directory: jsii.String(appDirectory)})</span></pre><p id="6b2a" class="pw-post-body-paragraph ku kv jf kw b kx ky kg kz la lb kj lc ld le lf lg lh li lj lk ll lm ln lo lp ij bi translated">一旦所有的部分都准备好了，我们就定义了App Runner服务。注意它是如何引用应用程序所需的信息的:</p><ul class=""><li id="f6a0" class="mk ml jf kw b kx ky la lb ld mm lh mn ll mo lp mp mq mr ms bi translated"><code class="fe mg mh mi mj b">DynamoDB</code>表的名称(先前定义的)被植入为<code class="fe mg mh mi mj b">TABLE_NAME</code> env var(应用程序所需的)</li><li id="e245" class="mk ml jf kw b kx mt la mu ld mv lh mw ll mx lp mp mq mr ms bi translated">我们定义的Docker图像被<code class="fe mg mh mi mj b">Asset</code>属性直接使用</li><li id="36f4" class="mk ml jf kw b kx mt la mu ld mv lh mw ll mx lp mp mq mr ms bi translated">我们定义的IAM角色作为实例角色附加到<a class="ae mf" href="https://docs.aws.amazon.com/apprunner/latest/dg/security_iam_service-with-iam.html" rel="noopener ugc nofollow" target="_blank"> App Runner服务</a></li></ul><blockquote class="nx ny nz"><p id="1f3d" class="ku kv oa kw b kx ky kg kz la lb kj lc ob le lf lg oc li lj lk od lm ln lo lp ij bi translated"><em class="jf">实例角色是一个可选角色，App Runner使用它来为服务的计算实例所需的AWS服务操作提供权限。</em></p></blockquote><p id="23c7" class="pw-post-body-paragraph ku kv jf kw b kx ky kg kz la lb kj lc ld le lf lg lh li lj lk ll lm ln lo lp ij bi translated">请注意，已经使用了<a class="ae mf" href="https://pkg.go.dev/github.com/aws/aws-cdk-go/awscdkapprunneralpha/v2" rel="noopener ugc nofollow" target="_blank"> L2 App Runner CDK构造</a>的<strong class="kw jg"> alpha </strong>版本，这与基于<a class="ae mf" href="https://pkg.go.dev/github.com/aws/aws-cdk-go/awscdk/v2/awsapprunner" rel="noopener ugc nofollow" target="_blank"> CloudFormation的L1构造</a>相比要简单得多。它提供了一个方便的<a class="ae mf" href="https://pkg.go.dev/github.com/aws/aws-cdk-go/awscdkapprunneralpha/v2#NewService" rel="noopener ugc nofollow" target="_blank"> NewService </a>函数，您可以用它来定义App Runner服务，包括源(在本例中是本地可用的)、IAM角色(实例和访问)等。</p><pre class="oe of og oh gt oi mj oj ok aw ol bi"><span id="158a" class="om ng jf mj b gy on oo l op oq">//...<br/>app := awscdkapprunneralpha.NewService(stack, jsii.String("apprunner-url-shortener"),<br/>        &amp;awscdkapprunneralpha.ServiceProps{<br/>            Source: awscdkapprunneralpha.NewAssetSource(<br/>                &amp;awscdkapprunneralpha.AssetProps{<br/>                    ImageConfiguration: &amp;awscdkapprunneralpha.ImageConfiguration{Environment: &amp;map[string]*string{<br/>                        "TABLE_NAME": dynamoDBTable.TableName(),<br/>                        "AWS_REGION": dynamoDBTable.Env().Region},<br/>                        Port: jsii.Number(appPort)},<br/>                    Asset: appDockerImage}),<br/>            InstanceRole: apprunnerDynamoDBIAMrole,<br/>            Memory:       awscdkapprunneralpha.Memory_TWO_GB(),<br/>            Cpu:          awscdkapprunneralpha.Cpu_ONE_VCPU(),<br/>        })</span><span id="d640" class="om ng jf mj b gy oy oo l op oq">    app.ApplyRemovalPolicy(awscdk.RemovalPolicy_DESTROY)</span></pre></div><div class="ab cl my mz hu na" role="separator"><span class="nb bw bk nc nd ne"/><span class="nb bw bk nc nd ne"/><span class="nb bw bk nc nd"/></div><div class="ij ik il im in"><h1 id="b16f" class="nf ng jf bd nh ni nj nk nl nm nn no np kl nq km nr ko ns kp nt kr nu ks nv nw bi translated">包裹</h1><p id="048e" class="pw-post-body-paragraph ku kv jf kw b kx os kg kz la ot kj lc ld ou lf lg lh ov lj lk ll ow ln lo lp ij bi translated">这就把我们带到了这篇博文的结尾！您探索了一个URL shortener应用程序，它公开了REST APIs，使用<code class="fe mg mh mi mj b">DynamoDB</code>作为其持久存储，并将其部署到AWS App Runner。然后，我们研究了各个服务如何根据工作负载进行弹性伸缩。最后，我们还研究了AWS CDK代码，它使得将应用程序及其基础设施定义为(Go)代码成为可能。</p><p id="9459" class="pw-post-body-paragraph ku kv jf kw b kx ky kg kz la lb kj lc ld le lf lg lh li lj lk ll lm ln lo lp ij bi translated">快乐大厦！</p></div></div>    
</body>
</html>