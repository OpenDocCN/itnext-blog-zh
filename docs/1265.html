<html>
<head>
<title>Using wildcard certificates with cert-manager in Kubernetes and replicating across all namespaces</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在Kubernetes的cert-manager中使用通配符证书并跨所有名称空间复制</h1>
<blockquote>原文：<a href="https://itnext.io/using-wildcard-certificates-with-cert-manager-in-kubernetes-and-replicating-across-all-namespaces-5ed1ea30bb93?source=collection_archive---------2-----------------------#2018-08-24">https://itnext.io/using-wildcard-certificates-with-cert-manager-in-kubernetes-and-replicating-across-all-namespaces-5ed1ea30bb93?source=collection_archive---------2-----------------------#2018-08-24</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><figure class="gl gn jr js jt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi jq"><img src="../Images/927e88ab8c2f3b133fe8c0d045b2df51.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*JZHBzysk3hst0taNJpyPBg.png"/></div></div></figure><p id="4d0e" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">基于<a class="ae kz" href="https://goo.gl/XGYRXH" rel="noopener ugc nofollow" target="_blank">这个</a>以前的故事，我们开始为不同的应用程序管理几个证书，这变得越来越难维护(而且我们达到了Let's-ecnrypt的速率限制)，所以通过<a class="la lb ep" href="https://medium.com/u/615b72822d37?source=post_page-----5ed1ea30bb93--------------------------------" rel="noopener" target="_blank"> Lucas Collino </a>我们找到了一种使用通配符证书的方法(正如推荐的)。</p><p id="091d" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">这允许创建适合我们支持的所有应用程序的单个*.mycompany.com证书。</p><p id="69c7" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">证书存储在kube-system名称空间的一个秘密中，我们在所有名称空间中复制了这个秘密，因此开发人员可以在他们自己的名称空间中访问它。</p><p id="48b9" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">本指南假设您已经遵循了<a class="ae kz" href="https://goo.gl/XGYRXH" rel="noopener ugc nofollow" target="_blank">上一个</a>，并且您已经有了Helm和cert-manager。</p><h1 id="9ac6" class="lc ld it bd le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz bi translated">创建通配符证书</h1><pre class="ma mb mc md gt me mf mg mh aw mi bi"><span id="9b74" class="mj ld it mf b gy mk ml l mm mn">$ cat management-mycompany-com.yaml <br/>---</span><span id="6e57" class="mj ld it mf b gy mo ml l mm mn">apiVersion: certmanager.k8s.io/v1alpha1<br/>kind: Certificate<br/>metadata:<br/> name: management-mycompany-com<br/> namespace: kube-system<br/>spec:<br/> secretName: management-mycompany-com-tls<br/> issuerRef:<br/>   name: letsencryptdns<br/>   kind: ClusterIssuer<br/> dnsNames:<br/>   - '*.management.mycompany.com'<br/> acme:<br/>   config:<br/>     - dns01:<br/>         provider: dns<br/>       domains:<br/>         - '*.management.mycompany.com'</span></pre><p id="4c00" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">几分钟后，你应该有秘密创建。</p><pre class="ma mb mc md gt me mf mg mh aw mi bi"><span id="b48f" class="mj ld it mf b gy mk ml l mm mn">$ kubectl get certificates -n kube-system<br/>NAME AGE<br/>sandbox-mycompany-com 5m<br/>$ kubectl describe certificate sandbox-mycompany-com -n kube-system</span><span id="b6e5" class="mj ld it mf b gy mo ml l mm mn">...    Message:               Certificate issued successfully...<br/>$ kubectl get secret sandbox-mycompany-com-tls -n kube-system<br/>NAME TYPE DATA AGE<br/>sandbox-mycompany-com-tls kubernetes.io/tls 2 5m</span></pre><h1 id="559b" class="lc ld it bd le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz bi translated">在所有名称空间中复制秘密</h1><p id="599f" class="pw-post-body-paragraph kb kc it kd b ke mp kg kh ki mq kk kl km mr ko kp kq ms ks kt ku mt kw kx ky im bi translated">我们使用<a class="ae kz" href="https://github.com/mittwald/kubernetes-replicator" rel="noopener ugc nofollow" target="_blank">这个工具</a>跨所有名称空间复制带有证书的秘密。</p><p id="0381" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">首先创建一个名为replicatedsecret.yaml的文件，其中包含</p><pre class="ma mb mc md gt me mf mg mh aw mi bi"><span id="097d" class="mj ld it mf b gy mk ml l mm mn">apiVersion: v1<br/>kind: Secret<br/>metadata:<br/>  name: auxsecret<br/>  annotations:<br/>    replicator.v1.mittwald.de/replicate-from: kube-system/auxsecret<br/>data: {}</span></pre><p id="54c0" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">然后创建一个小脚本，用于每个名称空间并完成工作:</p><pre class="ma mb mc md gt me mf mg mh aw mi bi"><span id="3e52" class="mj ld it mf b gy mk ml l mm mn">$echo "Enter secret to replicate (ex: sandbox-mycompany-com-tls)"<br/>read secret</span><span id="b55a" class="mj ld it mf b gy mo ml l mm mn">sed "s/auxsecret/$secret/g" replicatedsecret.yaml &gt; replicatedsecret-$secret.yaml</span><span id="3ad1" class="mj ld it mf b gy mo ml l mm mn">NS=$(kubectl get ns | grep -v kube-system | awk '{ print $1 }' | tail -n +2)</span><span id="42f5" class="mj ld it mf b gy mo ml l mm mn">#Get NS - kube-system<br/>for i in $NS; do<br/>  echo $i<br/>  kubectl apply -f replicatedsecret-$secret.yaml -n $i<br/>done</span></pre><p id="114f" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">您可以在您的名称空间上验证您是否复制了secret sandbox-my company-com-TLS；)</p><p id="ec7f" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">另一种方法应该是遵循本指南<a class="ae kz" href="https://www.revsys.com/tidbits/copying-kubernetes-secrets-between-namespaces/" rel="noopener ugc nofollow" target="_blank">https://www . rev sys . com/tidbits/copy-kubernetes-secrets-between-namespaces</a></p><h1 id="d086" class="lc ld it bd le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz bi translated">创建一个测试入口</h1><p id="fc21" class="pw-post-body-paragraph kb kc it kd b ke mp kg kh ki mq kk kl km mr ko kp kq ms ks kt ku mt kw kx ky im bi translated">在默认名称空间中启动nginx，并为它创建一个服务。</p><p id="30ab" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">运行<code class="fe mu mv mw mf b">kubectl run nginx --image nginx</code> <br/>和<code class="fe mu mv mw mf b">kubectl expose deploy nginx --port 80</code></p><p id="51e3" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">您刚刚在默认名称空间中启动了一个包含nginx的pod，并提供了一个名为nginx的服务。</p><p id="5d3d" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">创建ingress.yaml</p><pre class="ma mb mc md gt me mf mg mh aw mi bi"><span id="149f" class="mj ld it mf b gy mk ml l mm mn">apiVersion: extensions/v1beta1<br/>kind: Ingress<br/>metadata:<br/>  annotations:<br/>    ingress.kubernetes.io/ssl-redirect: "false"<br/>    kubernetes.io/ingress.class: nginx<br/>  labels:<br/>    app: nginx<br/>  name: nginx-sandbox-mycompany-com<br/>  namespace: default<br/>spec:<br/>  tls:<br/>  - hosts:<br/>    - nginx.sandbox.mycompany.com<br/>    secretName: nginx-sandbox-mycompany-com-tls<br/>  rules:<br/>  - host: nginx.sandbox.mycompany.com<br/>    http:<br/>      paths:<br/>      - backend:<br/>          serviceName: nginx<br/>          servicePort: http<br/>        path: /</span></pre><p id="4cb0" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">运行<code class="fe mu mv mw mf b">kubectl create -f ingress.yaml</code> -我们刚刚创建了入口。证书应该在大约30秒内准备好。</p><p id="cd39" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">现在，整个流量都通过https，我们已经从“让我们加密”中获得了有效证书。</p><p id="7e9a" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">所以，就这样了。我希望你觉得它有用，并且步骤容易遵循。如果我遗漏了什么，请评论和/或提问——我很乐意得到您的反馈。</p></div></div>    
</body>
</html>