<html>
<head>
<title>How to use parallel jobs on Semaphore CI 2.0 to run fast CI builds</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何在Semaphore CI 2.0上使用并行作业来运行快速CI构建</h1>
<blockquote>原文：<a href="https://itnext.io/how-to-use-parallel-jobs-on-semaphore-ci-2-0-to-run-fast-ci-builds-adbbb17cdad7?source=collection_archive---------7-----------------------#2019-03-25">https://itnext.io/how-to-use-parallel-jobs-on-semaphore-ci-2-0-to-run-fast-ci-builds-adbbb17cdad7?source=collection_archive---------7-----------------------#2019-03-25</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="d8b9" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">Semaphore CI 2.0允许用并行作业配置您的CI构建任务。通过这种方式，您可以同时运行几个互不依赖的不同命令。但是我们也可以使用并行作业将您的测试套件分割成几个作业，这样可以节省时间。我将向您展示如何为Ruby或JavaScript项目(Rails / Node项目)加速CI构建。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi kl"><img src="../Images/8c169eb4ed8d65c9afdb1a488e68d725.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*qUBbXkVlzzK3esf6.png"/></div></div><figcaption class="kx ky gj gh gi kz la bd b be z dk translated">信号量CI 2.0</figcaption></figure><p id="5da3" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">使用Semaphore CI 2.0 ，您不必像在其他CI提供者中那样为可以并行运行的容器数量付费。相反，他们计算运行容器所花费的工作时间。这就产生了运行更多并行任务的动机，以便快速执行我们的测试，并且仍然将bill保持在一个相似的水平，就好像我们只是在一个容器中运行所有的测试，浪费了我们自己的时间。</p><h1 id="c628" class="lc ld iq bd le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz bi translated">让我们通过并行作业节省时间</h1><p id="1e8c" class="pw-post-body-paragraph jn jo iq jp b jq ma js jt ju mb jw jx jy mc ka kb kc md ke kf kg me ki kj kk ij bi translated">为了用我们的测试以最佳方式运行并行作业，我们需要确保每个作业在相似的时间完成工作。这样就不会出现像作业执行太多测试或太慢测试这样的瓶颈。缓慢的工作可能会影响并使我们的整个CI构建更慢。尤其是端到端测试(E2E)可能会非常慢，并且它们的执行时间可能会有所不同。</p><p id="2e95" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">您可以使用<a class="ae lb" href="https://knapsackpro.com/?utm_source=medium&amp;utm_medium=blog&amp;utm_campaign=run-parallel-jobs-on-semaphore-ci-2-0-to-get-faster-ci-build-time" rel="noopener ugc nofollow" target="_blank">背包Pro队列模式</a>，以动态的方式在并行任务之间分割测试，以确保所有任务在相似的时间完成工作。您可以在本文最后的视频中了解更多关于队列模式可以解决的其他问题，但是现在让我们跳到信号量CI 2.0演示示例和我们可以使用的配置示例。</p><figure class="km kn ko kp gt kq"><div class="bz fp l di"><div class="mf mg l"/></div></figure><p id="82e1" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在这里，您可以找到用于项目的信号量CI 2.0配置，使用:</p><ul class=""><li id="8c9d" class="mh mi iq jp b jq jr ju jv jy mj kc mk kg ml kk mm mn mo mp bi translated"><a class="ae lb" href="https://docs.knapsackpro.com/2019/run-parallel-jobs-on-semaphore-ci-2-0-to-get-faster-ci-build-time#ruby-on-rails-config-for-semaphore-20" rel="noopener ugc nofollow" target="_blank"> Ruby on Rails </a> (RSpec，也支持其他测试运行程序，如Minitest、Cucumber等等)</li><li id="ad83" class="mh mi iq jp b jq mq ju mr jy ms kc mt kg mu kk mm mn mo mp bi translated">Cypress.io中的JavaScript测试端到端测试运行程序</li><li id="c28b" class="mh mi iq jp b jq mq ju mr jy ms kc mt kg mu kk mm mn mo mp bi translated"><a class="ae lb" href="https://docs.knapsackpro.com/2019/run-parallel-jobs-on-semaphore-ci-2-0-to-get-faster-ci-build-time#jest-config-for-semaphore-20" rel="noopener ugc nofollow" target="_blank">玩笑式的JavaScript测试</a></li></ul><h1 id="4f18" class="lc ld iq bd le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz bi translated">Semaphore 2.0的Ruby on Rails配置</h1><p id="7438" class="pw-post-body-paragraph jn jo iq jp b jq ma js jt ju mb jw jx jy mc ka kb kc md ke kf kg me ki kj kk ij bi translated">gem支持Semaphore CI 2.0提供的环境变量来运行您的测试。您必须在<code class="fe mv mw mx my b">.semaphore/semaphore.yml</code>配置文件中定义一些东西。</p><ul class=""><li id="1578" class="mh mi iq jp b jq jr ju jv jy mj kc mk kg ml kk mm mn mo mp bi translated">你需要设置<code class="fe mv mw mx my b">KNAPSACK_PRO_TEST_SUITE_TOKEN_RSPEC</code>。如果你不想在yml文件中提交秘密，那么你可以<a class="ae lb" href="https://docs.semaphoreci.com/article/66-environment-variables-and-secrets" rel="noopener ugc nofollow" target="_blank">遵循这个指南</a>。</li><li id="5f21" class="mh mi iq jp b jq mq ju mr jy ms kc mt kg mu kk mm mn mo mp bi translated">您需要创建尽可能多的具有唯一名称的作业(节点0 —背包专业版、节点1 —背包专业版等),以运行尽可能多的并行作业。如果您的测试套件很长，您应该使用更多的并行作业。</li><li id="2230" class="mh mi iq jp b jq mq ju mr jy ms kc mt kg mu kk mm mn mo mp bi translated">如果您有2个并行任务，您需要为每个任务设置<code class="fe mv mw mx my b">KNAPSACK_PRO_CI_NODE_TOTAL=2</code>。</li><li id="344a" class="mh mi iq jp b jq mq ju mr jy ms kc mt kg mu kk mm mn mo mp bi translated">您需要为节点0设置从0开始的作业索引，如<code class="fe mv mw mx my b">KNAPSACK_PRO_CI_NODE_INDEX=0</code>。</li></ul><p id="9a83" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">下面你可以找到Rails项目的完整信号量CI 2.0配置。</p><pre class="km kn ko kp gt mz my na nb aw nc bi"><span id="7596" class="nd ld iq my b gy ne nf l ng nh"><em class="ni"># .semaphore/semaphore.yml</em><br/><em class="ni"># Use the latest stable version of Semaphore 2.0 YML syntax:</em><br/>version: v1.0<br/><br/><em class="ni"># Name your pipeline. In case you connect multiple pipelines with promotions,</em><br/><em class="ni"># the name will help you differentiate between, for example, a CI build phase</em><br/><em class="ni"># and delivery phases.</em><br/>name: Demo Rails 5 app<br/><br/><em class="ni"># An agent defines the environment in which your code runs.</em><br/><em class="ni"># It is a combination of one of available machine types and operating</em><br/><em class="ni"># system images.</em><br/><em class="ni"># See https://docs.semaphoreci.com/article/20-machine-types</em><br/><em class="ni"># and https://docs.semaphoreci.com/article/32-ubuntu-1804-image</em><br/>agent:<br/>  machine:<br/>    type: e1-standard-2<br/>    os_image: ubuntu1804<br/><br/><em class="ni"># Blocks are the heart of a pipeline and are executed sequentially.</em><br/><em class="ni"># Each block has a task that defines one or more jobs. Jobs define the</em><br/><em class="ni"># commands to execute.</em><br/><em class="ni"># See https://docs.semaphoreci.com/article/62-concepts</em><br/>blocks:<br/>  - name: Setup<br/>    task:<br/>      env_vars:<br/>        - name: RAILS_ENV<br/>          value: test<br/>      jobs:<br/>        - name: bundle<br/>          commands:<br/>          <em class="ni"># Checkout code from Git repository. This step is mandatory if the</em><br/>          <em class="ni"># job is to work with your code.</em><br/>          <em class="ni"># Optionally you may use --use-cache flag to avoid roundtrip to</em><br/>          <em class="ni"># remote repository.</em><br/>          <em class="ni"># See https://docs.semaphoreci.com/article/54-toolbox-reference#libcheckout</em><br/>          - checkout<br/>          <em class="ni"># Restore dependencies from cache.</em><br/>          <em class="ni"># Read about caching: https://docs.semaphoreci.com/article/54-toolbox-reference#cache</em><br/>          - cache restore gems-$SEMAPHORE_GIT_BRANCH-$(checksum Gemfile.lock),gems-$SEMAPHORE_GIT_BRANCH-,gems-master-<br/>          <em class="ni"># Set Ruby version:</em><br/>          - sem-version ruby 2.6.1<br/>          - bundle install --jobs=4 --retry=3 --path vendor/bundle<br/>          <em class="ni"># Store the latest version of dependencies in cache,</em><br/>          <em class="ni"># to be used in next blocks and future workflows:</em><br/>          - cache store gems-$SEMAPHORE_GIT_BRANCH-$(checksum Gemfile.lock) vendor/bundle<br/><br/>  - name: RSpec tests<br/>    task:<br/>      env_vars:<br/>        - name: RAILS_ENV<br/>          value: test<br/>        - name: PGHOST<br/>          value: 127.0.0.1<br/>        - name: PGUSER<br/>          value: postgres<br/>        - name: KNAPSACK_PRO_TEST_SUITE_TOKEN_RSPEC<br/>          value: your_api_token_here<br/>      <em class="ni"># This block runs two jobs in parallel and they both share common</em><br/>      <em class="ni"># setup steps. We can group them in a prologue.</em><br/>      <em class="ni"># See https://docs.semaphoreci.com/article/50-pipeline-yaml#prologue</em><br/>      prologue:<br/>        commands:<br/>          - checkout<br/>          - cache restore gems-$SEMAPHORE_GIT_BRANCH-$(checksum Gemfile.lock),gems-$SEMAPHORE_GIT_BRANCH-,gems-master-<br/>          <em class="ni"># Start Postgres database service.</em><br/>          <em class="ni"># See https://docs.semaphoreci.com/article/54-toolbox-reference#sem-service</em><br/>          - sem-service start postgres<br/>          - sem-version ruby 2.6.1<br/>          - bundle install --jobs=4 --retry=3 --path vendor/bundle<br/>          - bundle exec rake db:setup<br/><br/>      jobs:<br/>      - name: Node 0 - Knapsack Pro<br/>        commands:<br/>          - KNAPSACK_PRO_CI_NODE_TOTAL=2 KNAPSACK_PRO_CI_NODE_INDEX=0 bundle exec rake knapsack_pro:queue:rspec<br/><br/>      - name: Node 1 - Knapsack Pro<br/>        commands:<br/>          - KNAPSACK_PRO_CI_NODE_TOTAL=2 KNAPSACK_PRO_CI_NODE_INDEX=1 bundle exec rake knapsack_pro:queue:rspec</span></pre><h1 id="08da" class="lc ld iq bd le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz bi translated">Semaphore 2.0的Cypress.io配置</h1><p id="7f26" class="pw-post-body-paragraph jn jo iq jp b jq ma js jt ju mb jw jx jy mc ka kb kc md ke kf kg me ki kj kk ij bi translated"><code class="fe mv mw mx my b">@knapsack-pro/cypress</code>支持Semaphore CI 2.0提供的环境变量来运行您的测试。你必须在<code class="fe mv mw mx my b">.semaphore/semaphore.yml</code>配置文件中定义一些东西。</p><ul class=""><li id="d364" class="mh mi iq jp b jq jr ju jv jy mj kc mk kg ml kk mm mn mo mp bi translated">你需要设置<code class="fe mv mw mx my b">KNAPSACK_PRO_TEST_SUITE_TOKEN_CYPRESS</code>。如果你不想在yml文件中提交秘密，那么你可以<a class="ae lb" href="https://docs.semaphoreci.com/article/66-environment-variables-and-secrets" rel="noopener ugc nofollow" target="_blank">遵循这个指南</a>。</li><li id="fc4f" class="mh mi iq jp b jq mq ju mr jy ms kc mt kg mu kk mm mn mo mp bi translated">您需要创建尽可能多的具有唯一名称的作业(节点0 —背包专业版、节点1 —背包专业版等),以运行尽可能多的并行作业。如果您的测试套件很长，您应该使用更多的并行作业。</li><li id="cedc" class="mh mi iq jp b jq mq ju mr jy ms kc mt kg mu kk mm mn mo mp bi translated">如果您有2个并行任务，您需要为每个任务设置<code class="fe mv mw mx my b">KNAPSACK_PRO_CI_NODE_TOTAL=2</code>。</li><li id="d906" class="mh mi iq jp b jq mq ju mr jy ms kc mt kg mu kk mm mn mo mp bi translated">您需要像<code class="fe mv mw mx my b">KNAPSACK_PRO_CI_NODE_INDEX=0</code>一样为节点0设置从0开始的作业索引。</li></ul><p id="2421" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">下面你可以找到信号量CI 2.0配置的示例部分。</p><pre class="km kn ko kp gt mz my na nb aw nc bi"><span id="dfd4" class="nd ld iq my b gy ne nf l ng nh">blocks:<br/>  - name: Cypress tests<br/>    task:<br/>      env_vars:<br/>        - name: KNAPSACK_PRO_TEST_SUITE_TOKEN_CYPRESS<br/>          value: your_api_token_here<br/>      prologue:<br/>        commands:<br/>          - checkout<br/>          - nvm install --lts carbon<br/>          - sem-version node --lts carbon<br/><br/>      jobs:<br/>        - name: Node 0 - Knapsack Pro<br/>          commands:<br/>            - KNAPSACK_PRO_CI_NODE_TOTAL=2 KNAPSACK_PRO_CI_NODE_INDEX=0 $(npm bin)/knapsack-pro-cypress<br/><br/>        - name: Node 1 - Knapsack Pro<br/>          commands:<br/>            - KNAPSACK_PRO_CI_NODE_TOTAL=2 KNAPSACK_PRO_CI_NODE_INDEX=1 $(npm bin)/knapsack-pro-cypress</span></pre><h1 id="5b9e" class="lc ld iq bd le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz bi translated">信号量2.0的Jest配置</h1><p id="75b6" class="pw-post-body-paragraph jn jo iq jp b jq ma js jt ju mb jw jx jy mc ka kb kc md ke kf kg me ki kj kk ij bi translated"><code class="fe mv mw mx my b">@knapsack-pro/jest</code>支持Semaphore CI 2.0提供的环境变量来运行您的测试。您必须在<code class="fe mv mw mx my b">.semaphore/semaphore.yml</code>配置文件中定义一些东西。</p><ul class=""><li id="e64b" class="mh mi iq jp b jq jr ju jv jy mj kc mk kg ml kk mm mn mo mp bi translated">你需要设置<code class="fe mv mw mx my b">KNAPSACK_PRO_TEST_SUITE_TOKEN_JEST</code>。如果你不想在yml文件中提交秘密，那么你可以<a class="ae lb" href="https://docs.semaphoreci.com/article/66-environment-variables-and-secrets" rel="noopener ugc nofollow" target="_blank">遵循这个指南</a>。</li><li id="b4ec" class="mh mi iq jp b jq mq ju mr jy ms kc mt kg mu kk mm mn mo mp bi translated">您需要创建尽可能多的具有唯一名称的作业(节点0 —背包专业版、节点1 —背包专业版等),以运行尽可能多的并行作业。如果您的测试套件很长，您应该使用更多的并行作业。</li><li id="a663" class="mh mi iq jp b jq mq ju mr jy ms kc mt kg mu kk mm mn mo mp bi translated">如果您有2个并行作业，您需要为每个作业设置<code class="fe mv mw mx my b">KNAPSACK_PRO_CI_NODE_TOTAL=2</code>。</li><li id="e7cb" class="mh mi iq jp b jq mq ju mr jy ms kc mt kg mu kk mm mn mo mp bi translated">您需要为节点0设置从0开始的作业索引，就像<code class="fe mv mw mx my b">KNAPSACK_PRO_CI_NODE_INDEX=0</code>一样。</li></ul><p id="0579" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">下面你可以找到信号量CI 2.0配置的示例部分。</p><pre class="km kn ko kp gt mz my na nb aw nc bi"><span id="d700" class="nd ld iq my b gy ne nf l ng nh">blocks:<br/>  - name: Cypress tests<br/>    task:<br/>      env_vars:<br/>        - name: KNAPSACK_PRO_TEST_SUITE_TOKEN_JEST<br/>          value: your_api_token_here<br/>      prologue:<br/>        commands:<br/>          - checkout<br/>          - nvm install --lts carbon<br/>          - sem-version node --lts carbon<br/><br/>      jobs:<br/>        - name: Node 0 - Knapsack Pro<br/>          commands:<br/>            - KNAPSACK_PRO_CI_NODE_TOTAL=2 KNAPSACK_PRO_CI_NODE_INDEX=0 $(npm bin)/knapsack-pro-jest<br/><br/>        - name: Node 1 - Knapsack Pro<br/>          commands:<br/>            - KNAPSACK_PRO_CI_NODE_TOTAL=2 KNAPSACK_PRO_CI_NODE_INDEX=1 $(npm bin)/knapsack-pro-jest</span></pre><p id="250f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如您所见，由于利用了Semaphore CI 2.0上的并行作业，您的CI构建可以快得多。您可以查看<a class="ae lb" href="https://knapsackpro.com/?utm_source=medium&amp;utm_medium=blog&amp;utm_campaign=run-parallel-jobs-on-semaphore-ci-2-0-to-get-faster-ci-build-time" rel="noopener ugc nofollow" target="_blank">背包Pro CI并行化工具</a>，并在下面的视频中了解更多关于队列模式及其解决的问题。</p><figure class="km kn ko kp gt kq"><div class="bz fp l di"><div class="mf mg l"/></div></figure></div><div class="ab cl nj nk hu nl" role="separator"><span class="nm bw bk nn no np"/><span class="nm bw bk nn no np"/><span class="nm bw bk nn no"/></div><div class="ij ik il im in"><p id="ee08" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">【docs.knapsackpro.com】最初发表于<a class="ae lb" href="https://docs.knapsackpro.com/2019/run-parallel-jobs-on-semaphore-ci-2-0-to-get-faster-ci-build-time" rel="noopener ugc nofollow" target="_blank"><em class="ni"/></a><em class="ni">。</em></p></div></div>    
</body>
</html>