<html>
<head>
<title>How to migrate from Vue 2.0 to Vue 3.0 Composition API with TS (Part 3: Create a global store)</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何使用TS从Vue 2.0迁移到Vue 3.0组合API(第3部分:创建全局存储)</h1>
<blockquote>原文：<a href="https://itnext.io/how-to-migrate-from-vue-2-0-to-vue-3-0-composition-api-with-ts-part-3-create-a-global-store-aabdfa45a687?source=collection_archive---------1-----------------------#2020-01-20">https://itnext.io/how-to-migrate-from-vue-2-0-to-vue-3-0-composition-api-with-ts-part-3-create-a-global-store-aabdfa45a687?source=collection_archive---------1-----------------------#2020-01-20</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><figure class="gl gn jr js jt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi jq"><img src="../Images/5ec9f0183a0854380956eb678c67bca3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*7sDKJjnuO9QyjnM7BvfDEA.png"/></div></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated">VueFes Japan 2018尤雨溪Vue3.0更新</figcaption></figure><p id="3870" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">2019年10月，Vue 3.0 pre-alpha终于发布。所以用Vue 3.0做生产是迟早的事。</p><p id="2ee9" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">为了做好准备，我想分享一下如何从Vue 2.0迁移到Vue 3.0。因为现在大量的Vue用户已经引入了TypeScript，所以本文也使用TypeScript。</p><p id="9c14" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">迁移有3个步骤，如下所示。</p><ol class=""><li id="a7dd" class="ld le it kh b ki kj km kn kq lf ku lg ky lh lc li lj lk ll bi translated"><a class="ae lm" href="https://medium.com/@egctoru/how-to-properly-use-vue-3-0-composition-api-with-typescript-b4bb74d2bcd8" rel="noopener">将Vue 3.0注入Vue 2.0 </a></li><li id="1df1" class="ld le it kh b ki ln km lo kq lp ku lq ky lr lc li lj lk ll bi translated"><a class="ae lm" href="https://medium.com/@egctoru/how-to-properly-use-vue-3-0-composition-api-with-typescript-part-2-usage-73606fb1b296" rel="noopener">将Vue 2.0代码替换为Vue 3.0 </a></li><li id="a405" class="ld le it kh b ki ln km lo kq lp ku lq ky lr lc li lj lk ll bi translated"><a class="ae lm" href="https://medium.com/@egctoru/how-to-migrate-from-vue-2-0-to-vue-3-0-composition-api-with-ts-part-3-create-a-global-store-aabdfa45a687" rel="noopener">使用Vue 3.0组合API创建全球商店</a></li></ol><p id="dcc5" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">因为这个话题有点长，我把它分成了3篇文章。本文是最后一篇。如果您想从特定部分开始，请随意进入页面。</p><h1 id="ffc0" class="ls lt it bd lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp bi translated">使用Vue 3.0组合API创建全球商店</h1><p id="4d5f" class="pw-post-body-paragraph kf kg it kh b ki mq kk kl km mr ko kp kq ms ks kt ku mt kw kx ky mu la lb lc im bi translated">你已经在上一篇文章的<a class="ae lm" href="https://medium.com/@egctoru/how-to-migrate-from-vue-2-0-to-vue-3-0-composition-api-with-ts-part-2-replace-73606fb1b296" rel="noopener">中将Vue 2.0代码替换为Vue 3.0！如果你跳过了前一篇文章，你想检查实际代码，请检查我的回购。</a></p><pre class="mv mw mx my gt mz na nb nc aw nd bi"><span id="0d8c" class="ne lt it na b gy nf ng l nh ni">git clone <a class="ae lm" href="https://github.com/egurinko/vue3.0-composition-api-demo.git" rel="noopener ugc nofollow" target="_blank">https://github.com/egurinko/vue3.0-composition-api-demo.git</a><br/>git checkout feature/finish_replace_vue2_with_vue3</span></pre><p id="18aa" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated"><code class="fe nj nk nl na b">feature/finish_replace_vue2_with_vue3</code>分支有替换Vue 2.0代码后的代码。</p><h2 id="4210" class="ne lt it bd lu nm nn dn ly no np dp mc kq nq nr mg ku ns nt mk ky nu nv mo nw bi translated">复合函数中的状态和函数是局部的。</h2><p id="1b1c" class="pw-post-body-paragraph kf kg it kh b ki mq kk kl km mr ko kp kq ms ks kt ku mt kw kx ky mu la lb lc im bi translated">如果您已经使用了像Vuex这样的状态管理，您通常会认为您想要全局共享状态和动作，因为从父节点向子节点传递数据有点困难，尤其是对于大型应用程序。</p><p id="c557" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">在构图功能上怎么样？？有可能在全球范围内分享它们吗？？答案是“没有”。</p><p id="fa64" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">例如，如果在列表组件和编辑组件中调用<code class="fe nj nk nl na b">useTodos</code>复合函数，则状态不共享。它只是在每个组件中创建不同的实例。</p><p id="db5b" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">因为复合函数只是函数，函数有自己的作用域。你需要一些全局共享状态的东西。</p><p id="6861" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">那么，如何使状态和函数全球化呢？？</p><h2 id="01a8" class="ne lt it bd lu nm nn dn ly no np dp mc kq nq nr mg ku ns nt mk ky nu nv mo nw bi translated">依赖注入和提供/注入</h2><p id="73ac" class="pw-post-body-paragraph kf kg it kh b ki mq kk kl km mr ko kp kq ms ks kt ku mt kw kx ky mu la lb lc im bi translated">Provide和inject一起使用，允许祖先组件充当其所有后代的依赖注入器，只要它们在同一个父组件中。这意味着如果你在应用程序的根组件中提供存储，所有组件都可以使用它，哈！</p><p id="35d8" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">因为有点难以理解，所以让我们用<code class="fe nj nk nl na b">useTodos.ts</code>创建全球商店。</p><ol class=""><li id="80d1" class="ld le it kh b ki kj km kn kq lf ku lg ky lh lc li lj lk ll bi translated">将useTodos.ts及其类型移动到/src/store <br/>下组织文件结构，我们先来做！<br/><code class="fe nj nk nl na b">src/composables/useTodos.ts</code>=&gt;<code class="fe nj nk nl na b">src/store/useTodos.ts</code><br/><code class="fe nj nk nl na b">src/composables/types/UseTodos.ts</code>=&gt;<code class="fe nj nk nl na b">src/store/types/UseTodos.ts</code></li></ol><p id="5223" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">2.定义注射键</p><p id="572d" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">为了决定你在每个组件中注入什么，你需要定义注入键。所以让我们把它定义为<code class="fe nj nk nl na b">useTodos</code>。</p><pre class="mv mw mx my gt mz na nb nc aw nd bi"><span id="2e1c" class="ne lt it na b gy nf ng l nh ni">// src/store/useTodos</span><span id="c3f7" class="ne lt it na b gy nx ng l nh ni">...</span><span id="898b" class="ne lt it na b gy nx ng l nh ni">import { reactive, onMounted, computed, toRefs, InjectionKey } from "@vue/composition-api";</span><span id="f8eb" class="ne lt it na b gy nx ng l nh ni">...</span><span id="cacd" class="ne lt it na b gy nx ng l nh ni">export type UseTodos = ReturnType&lt;typeof useTodos&gt;;<br/>export const TodosKey: InjectionKey&lt;UseTodos&gt; = Symbol("UseTodos");</span></pre><p id="9277" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">如果您有多个合成功能要共享，只需重复相同的过程。</p><p id="4de0" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">在我们的todos演示应用程序中，只放置了一个逻辑。但是随着应用程序变得越来越大，存储目录中逻辑也越来越多。因此，为了组织文件存储，让我们将存储合并为一个。</p><p id="f176" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">创建<code class="fe nj nk nl na b">src/store/index.ts</code>。</p><pre class="mv mw mx my gt mz na nb nc aw nd bi"><span id="c061" class="ne lt it na b gy nf ng l nh ni">// src/store/index.ts</span><span id="8e05" class="ne lt it na b gy nx ng l nh ni">import { InjectionKey } from "@vue/composition-api";<br/>import { useTodos } from "./useTodos";</span><span id="4580" class="ne lt it na b gy nx ng l nh ni">export default function store() {<br/>  return {<br/>    ...useTodos()<br/>  };<br/>}</span><span id="0e1d" class="ne lt it na b gy nx ng l nh ni">export type Store = ReturnType&lt;typeof store&gt;;<br/>export const StoreKey: InjectionKey&lt;Store&gt; = Symbol("Store");</span></pre><p id="43ee" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">3.创建提供程序组件以注入存储</p><p id="e2a9" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">正如您已经读到的，您需要根祖先来注入存储。所以创建<code class="fe nj nk nl na b">components/Provider.vue</code>。</p><pre class="mv mw mx my gt mz na nb nc aw nd bi"><span id="32d7" class="ne lt it na b gy nf ng l nh ni">// src/components/Provider.vue</span><span id="e7af" class="ne lt it na b gy nx ng l nh ni">&lt;template&gt;<br/>  &lt;div&gt;<br/>    &lt;slot /&gt;<br/>  &lt;/div&gt;<br/>&lt;/template&gt;</span><span id="030b" class="ne lt it na b gy nx ng l nh ni">&lt;script lang="ts"&gt;<br/>import { provide } from "@vue/composition-api";<br/>import store, { StoreKey } from "../store";</span><span id="9ce8" class="ne lt it na b gy nx ng l nh ni">export default {<br/>  setup() {<br/>    provide(StoreKey, store());<br/>    return {};<br/>  }<br/>};<br/>&lt;/script&gt;</span></pre><p id="87e2" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">如果使用slot，就不必指定子组件。</p><p id="744f" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">4.用提供者包装你的应用程序</p><p id="b1d0" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">在应用程序的顶层节点(可能是App.vue)，用提供者包装组件，使所有组件成为父子关系。</p><pre class="mv mw mx my gt mz na nb nc aw nd bi"><span id="7bf8" class="ne lt it na b gy nf ng l nh ni">// src/App.vue</span><span id="962e" class="ne lt it na b gy nx ng l nh ni">&lt;template&gt;<br/>  &lt;Provider&gt;<br/>    &lt;div id="app"&gt;<br/>      &lt;router-view /&gt;<br/>    &lt;/div&gt;<br/>  &lt;/Provider&gt;<br/>&lt;/template&gt;</span><span id="9ac2" class="ne lt it na b gy nx ng l nh ni">&lt;script lang="ts"&gt;<br/>import Vue from "vue";<br/>import { createComponent } from "@vue/composition-api";<br/>import Provider from "./components/Provider.vue";</span><span id="a1fc" class="ne lt it na b gy nx ng l nh ni">export default createComponent({<br/>  components: {<br/>    Provider<br/>  }<br/>});<br/>&lt;/script&gt;</span></pre><p id="966a" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">5.在儿童中使用注射储存</p><p id="fba6" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">因为你已经为全球商店提供了<code class="fe nj nk nl na b">provide</code>，你所要做的就是在你需要的地方用<code class="fe nj nk nl na b">inject</code>注射钥匙。在演示todo应用程序中，List.vue想要使用它。</p><pre class="mv mw mx my gt mz na nb nc aw nd bi"><span id="2ecb" class="ne lt it na b gy nf ng l nh ni">// src/pages/List.vue</span><span id="4960" class="ne lt it na b gy nx ng l nh ni">...</span><span id="71f4" class="ne lt it na b gy nx ng l nh ni">&lt;script lang="ts"&gt;<br/>import { ...something, inject } from "@vue/composition-api";<br/>import { StoreKey, Store } from "../store";</span><span id="e606" class="ne lt it na b gy nx ng l nh ni">export default createComponent({<br/>  setup(){<br/>    const store = inject(StoreKey);<br/>    if(!store) return;<br/>    <br/>    const {<br/>      todos,<br/>      newTodo,<br/>      filterBy,<br/>      filteredTodos,<br/>      numOfTodos, <br/>      addTodo,<br/>      handleClickFilterBy,<br/>      completeTodo,<br/>      deleteTodo<br/>    } = store;<br/>    <br/>    return { // what you need }<br/>  }<br/>})</span></pre><p id="a5ee" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">最终你得到了一个全球商店！！</p><h2 id="2cf3" class="ne lt it bd lu nm nn dn ly no np dp mc kq nq nr mg ku ns nt mk ky nu nv mo nw bi translated">检入其他组件</h2><p id="545d" class="pw-post-body-paragraph kf kg it kh b ki mq kk kl km mr ko kp kq ms ks kt ku mt kw kx ky mu la lb lc im bi translated">pages目录中还有一个组件。所以让我们检查一下我们的工作。</p><pre class="mv mw mx my gt mz na nb nc aw nd bi"><span id="b391" class="ne lt it na b gy nf ng l nh ni">// src/pages/Edit.vue</span><span id="fdc4" class="ne lt it na b gy nx ng l nh ni">&lt;template&gt;<br/>  &lt;div class="list-container m-auto my-10 bg-white rounded p-10"&gt;<br/>    {{ todos[0].name }}<br/>  &lt;/div&gt;<br/>&lt;/template&gt;</span><span id="7780" class="ne lt it na b gy nx ng l nh ni">&lt;script lang="ts"&gt;<br/>import Vue from "vue";<br/>import { createComponent, inject } from "@vue/composition-api";<br/>import { StoreKey, Store } from "../store";</span><span id="bd36" class="ne lt it na b gy nx ng l nh ni">export default createComponent({<br/>  setup(props, context) {<br/>    const store = inject(StoreKey);<br/>    if (!store) return;</span><span id="00a7" class="ne lt it na b gy nx ng l nh ni">    const { todos } = store;<br/>    <br/>    return { todos };<br/>  }<br/>});</span></pre><figure class="mv mw mx my gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi ny"><img src="../Images/d7029d2863480f30a3021844303602eb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*kRDwwLmGiIfQ16tIJWglFg.png"/></div></div></figure><p id="224c" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">完美！是全球商店！！</p><h2 id="9660" class="ne lt it bd lu nm nn dn ly no np dp mc kq nq nr mg ku ns nt mk ky nu nv mo nw bi translated">下一关</h2><p id="5f29" class="pw-post-body-paragraph kf kg it kh b ki mq kk kl km mr ko kp kq ms ks kt ku mt kw kx ky mu la lb lc im bi translated">在本文中，没有提到动作和异步任务。但是当你使用Vuex时，你可以将动作、突变、状态分离到不同的文件中。如果你这样做了，你的全球商店会变得更加整洁有序！！</p><h2 id="24c8" class="ne lt it bd lu nm nn dn ly no np dp mc kq nq nr mg ku ns nt mk ky nu nv mo nw bi translated">利弊</h2><p id="4545" class="pw-post-body-paragraph kf kg it kh b ki mq kk kl km mr ko kp kq ms ks kt ku mt kw kx ky mu la lb lc im bi translated">这种存储模式的神奇之处绝对是对TypeScript的良好兼容性。你可以在任何地方查看商店的类型。</p><p id="b3b0" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">不利的一面是，当你想从一个全局状态引用另一个全局状态时，很难做到干净利落。</p></div><div class="ab cl nz oa hx ob" role="separator"><span class="oc bw bk od oe of"/><span class="oc bw bk od oe of"/><span class="oc bw bk od oe"/></div><div class="im in io ip iq"><p id="0b08" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">在本文中，我解释了如何用Vue 3.0组合API创建一个全局商店。如果你想知道更多基本的东西，可以去看看前面的文章。</p><ol class=""><li id="1c09" class="ld le it kh b ki kj km kn kq lf ku lg ky lh lc li lj lk ll bi translated"><a class="ae lm" href="https://medium.com/@egctoru/how-to-properly-use-vue-3-0-composition-api-with-typescript-b4bb74d2bcd8" rel="noopener">将Vue 3.0注入Vue 2.0 </a></li><li id="4d72" class="ld le it kh b ki ln km lo kq lp ku lq ky lr lc li lj lk ll bi translated"><a class="ae lm" href="https://medium.com/@egctoru/how-to-properly-use-vue-3-0-composition-api-with-typescript-part-2-usage-73606fb1b296" rel="noopener">将Vue 2.0代码替换为Vue 3.0 </a>(现在在这里！)</li><li id="7acb" class="ld le it kh b ki ln km lo kq lp ku lq ky lr lc li lj lk ll bi translated"><a class="ae lm" href="https://medium.com/@egctoru/how-to-migrate-from-vue-2-0-to-vue-3-0-composition-api-with-ts-part-3-create-a-global-store-aabdfa45a687" rel="noopener">使用Vue 3.0组合API创建全球商店</a></li></ol></div></div>    
</body>
</html>