<html>
<head>
<title>How to use Async with thread-unsafe objects?</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何对线程不安全的对象使用异步？</h1>
<blockquote>原文：<a href="https://itnext.io/how-to-use-async-with-thread-unsafe-objects-345e97a27bb6?source=collection_archive---------6-----------------------#2020-09-05">https://itnext.io/how-to-use-async-with-thread-unsafe-objects-345e97a27bb6?source=collection_archive---------6-----------------------#2020-09-05</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/62da9892a160ea6bbec14d794131a62b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*JQWqRV7RM1p9mqDhS4uurQ.png"/></div></div></figure><p id="7651" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">异步方法通常比普通的单线程方法更受欢迎，因为它不会阻塞主线程，并且很容易并行执行。</p><p id="c17c" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">虽然不建议使用Task.run(()=&gt;{})，因为它会不断创建更多的线程，但是当它用于线程不安全的对象时，它甚至不会工作，并且可能会引发异常。在本文中，我们将采用一个真实的场景，为线程不安全的对象couchbase MutableDocument提供一个异步写版本。</p><p id="a336" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">下面是向可变文档添加字符串的普通api</p><pre class="kw kx ky kz gt la lb lc ld aw le bi"><span id="f230" class="lf lg iq lb b gy lh li l lj lk">var mutableDocument=new MutableDocument("doc1");</span><span id="e538" class="lf lg iq lb b gy ll li l lj lk">mutableDocument.SetString("Username", "ahmed");</span></pre><p id="0ecd" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">现在让我们测试任务。如果情况真的很糟糕，就采取行动</p><pre class="kw kx ky kz gt la lb lc ld aw le bi"><span id="3092" class="lf lg iq lb b gy lh li l lj lk">static async Task WriteToDocumentAsync(MutableDocument doc, string key, string value)</span><span id="723f" class="lf lg iq lb b gy ll li l lj lk">{</span><span id="7ce2" class="lf lg iq lb b gy ll li l lj lk">await Task.Run(() =&gt;  doc.SetValue(key, value));</span><span id="c0f0" class="lf lg iq lb b gy ll li l lj lk">}</span></pre><p id="caf9" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">现在让我们测试一下</p><pre class="kw kx ky kz gt la lb lc ld aw le bi"><span id="95d8" class="lf lg iq lb b gy lh li l lj lk">await Task.WhenAll(<br/>             WriteToDocumentAsync(document, "UserName", "ahmed"),<br/>             WriteToDocumentAsync(document, "password", "pass"),<br/>             WriteToDocumentAsync(document, "birthdate", "14 392"),<br/>             WriteToDocumentAsync(document, "nationality","egypt"),<br/>             WriteToDocumentAsync(document, "livein", "vienna"),<br/>             WriteToDocumentAsync(document, "job", "se"),<br/>             WriteToDocumentAsync(document, "language", "arabic"),<br/>             WriteToDocumentAsync(document, "language2", "french"),<br/>             WriteToDocumentAsync(document, "language3","english"),<br/>             WriteToDocumentAsync(document, "UserName1", "ahmed"),<br/>             WriteToDocumentAsync(document, "password1", "pass"),<br/>             WriteToDocumentAsync(document, "birthdate1", "14392"),<br/>             WriteToDocumentAsync(document, "nationality1","egypt"),<br/>             WriteToDocumentAsync(document, "livein1", "vienna"),<br/>             WriteToDocumentAsync(document, "job1", "se"),<br/>             WriteToDocumentAsync(document, "language1", "arabic"),<br/>             WriteToDocumentAsync(document, "language21", "french"),<br/>             WriteToDocumentAsync(document, "language31","english" ));</span></pre><p id="3a49" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">然后嘣！！！！这段代码将在文档对象中抛出空引用异常。</p><p id="4dd6" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">大多数人把异步编程和并行编程混为一谈，这里我们不打算讨论并行编程，因为对于线程不安全的对象来说这是不可能的。</p><h1 id="5e04" class="lm lg iq bd ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi bi translated">实现编写器模式</h1><p id="afe6" class="pw-post-body-paragraph jy jz iq ka b kb mj kd ke kf mk kh ki kj ml kl km kn mm kp kq kr mn kt ku kv ij bi translated">异步编程:消费者线程(大多数情况下是UI线程)要求后台线程完成一项工作，并在完成时通知他。</p><p id="da86" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">所以在我们的例子中，我们需要一个后台线程来接收多个文档写请求(方法调用),对它们进行排队，然后一个接一个地执行它们。</p><figure class="kw kx ky kz gt jr"><div class="bz fp l di"><div class="mo mp l"/></div></figure><p id="02be" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">_currentThread:是将执行所有写请求的后台线程。</p><p id="8d6a" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">_channel:是系统的对象。线程。在调用者线程和我们的后台线程之间充当通信的通道。</p><p id="1821" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">WriteToDocumentAsync方法:向_channel发送消息(请求)，TaskCompletionSource用于等待执行并接收结果。</p><p id="566a" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">Start方法:是_currentThread方法逐个处理写请求，一直等到通道关闭。</p><p id="78bf" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">Dispose:确保_channel已关闭(完成),以允许_currentThread被释放。</p><p id="7c21" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">现在，您可以使用</p><figure class="kw kx ky kz gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mq"><img src="../Images/637f9e0a872291a214ab0aadf652cc3a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*NY_HuYq0T_u32AAC0j3S7g.png"/></div></div></figure><h1 id="152d" class="lm lg iq bd ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi bi translated">标杆管理</h1><figure class="kw kx ky kz gt jr gh gi paragraph-image"><div class="gh gi mr"><img src="../Images/6fe0f4bb41cfcc479e8cc4b94277c337.png" data-original-src="https://miro.medium.com/v2/resize:fit:1288/format:webp/1*3u3D1iUCMVbD6n8ii5S8mg.png"/></div></figure><p id="bd7c" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">很明显，异步版本带来了大约150%的性能开销，所以请仅在您需要时使用它，相信将来会实现更多的性能增强。</p><p id="d74c" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在twitter和medium上关注我，了解更多技术和科学内容</p><p id="8521" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><a class="ae ms" href="https://twitter.com/MCC_Ahmed" rel="noopener ugc nofollow" target="_blank">https://twitter.com/MCC_Ahmed</a></p><p id="4ecd" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">如果你想支持我更多的技术和科学内容，你可以在</p><div class="mt mu gp gr mv mw"><a href="https://ko-fi.com/ahmedfouad" rel="noopener  ugc nofollow" target="_blank"><div class="mx ab fo"><div class="my ab mz cl cj na"><h2 class="bd ir gy z fp nb fr fs nc fu fw ip bi translated">给艾哈迈德·福阿德买杯咖啡。ko-fi.com/ahmedfouad</h2><div class="nd l"><h3 class="bd b gy z fp nb fr fs nc fu fw dk translated">给我买杯咖啡</h3></div><div class="ne l"><p class="bd b dl z fp nb fr fs nc fu fw dk translated">ko-fi.com</p></div></div><div class="nf l"><div class="ng l nh ni nj nf nk jw mw"/></div></div></a></div></div></div>    
</body>
</html>