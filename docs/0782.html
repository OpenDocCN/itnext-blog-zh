<html>
<head>
<title>Pinning your OpenShift cluster to a specific minor release</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">将OpenShift集群绑定到特定的次要版本</h1>
<blockquote>原文：<a href="https://itnext.io/pinning-your-openshift-cluster-to-a-specific-minor-release-c110a1bbc7ec?source=collection_archive---------4-----------------------#2018-05-28">https://itnext.io/pinning-your-openshift-cluster-to-a-specific-minor-release-c110a1bbc7ec?source=collection_archive---------4-----------------------#2018-05-28</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/6e66317939d882d031d2bd3964cf910c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Cz9qwaZLr5GUOta4MqpoCA.jpeg"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">迈克尔·克里斯滕森在<a class="ae kc" href="https://unsplash.com/?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</figcaption></figure><p id="d8b5" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">大约一个月前，Kubernetes项目发布了一个<a class="ae kc" href="https://kubernetes.io/blog/2018/04/04/fixing-subpath-volume-vulnerability/" rel="noopener ugc nofollow" target="_blank"> <strong class="kf ir">安全补丁</strong> </a>，不幸地破坏了我们的OpenShift集群。这个问题表现在<a class="ae kc" href="https://github.com/kubernetes/kubernetes/issues/61076#issuecomment-372554309" rel="noopener ugc nofollow" target="_blank">无法为容器卷挂载</a>创建卷子路径，这最终使我们的管道陷入停顿。</p><p id="e11f" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在我们的3.7.22集群中配置新节点后，我们就受到了影响，这在过去是无缝运行的，没有任何问题。然而，这一次，要么是新的次要包被破坏，要么是该错误已经进入了所有OpenShift 3.x rpm包。</p><p id="2cf9" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">幸运的是，到目前为止，我们没有失去任何支持我们度过这个问题的主要节点。幸运的是，RedHat (3.7.44)最近发布了对该错误的修复，但这一次我们将努力确保我们能够控制应用于集群中节点的rpm包版本。</p><h2 id="f77c" class="lb lc iq bd ld le lf dn lg lh li dp lj ko lk ll lm ks ln lo lp kw lq lr ls lt bi translated"><strong class="ak">强制特定的OpenShift包版本。</strong></h2><p id="be72" class="pw-post-body-paragraph kd ke iq kf b kg lu ki kj kk lv km kn ko lw kq kr ks lx ku kv kw ly ky kz la ij bi translated">根据文档，安装程序使用以下可用清单事实来强制安装特定的软件包版本:</p><pre class="lz ma mb mc gt md me mf mg aw mh bi"><span id="75f0" class="lb lc iq me b gy mi mj l mk ml">[OSEv3:vars]</span><span id="c6ad" class="lb lc iq me b gy mm mj l mk ml">openshift_release=v3.7.44</span><span id="889a" class="lb lc iq me b gy mm mj l mk ml"># Value <a class="ae kc" href="https://github.com/openshift/openshift-ansible/blob/0ffb616c01a37862da73a80bdfd2ffc826ef808a/roles/openshift_cli/tasks/main.yml#L3" rel="noopener ugc nofollow" target="_blank">appended to the yum package</a> install<br/>openshift_pkg_version=-3.7.44</span><span id="26cc" class="lb lc iq me b gy mm mj l mk ml"># Prevents an unsupported docker version from being installed<br/>enable_docker_excluder=true</span><span id="9fe8" class="lb lc iq me b gy mm mj l mk ml"># Still figuring out <a class="ae kc" href="https://github.com/openshift/openshift-ansible/blob/release-3.7/roles/openshift_excluder/README.md" rel="noopener ugc nofollow" target="_blank">why this is needed</a>: <br/>enable_openshift_excluder=true</span></pre><p id="c6b0" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">然而，Ansible installer playbook中存在一个问题，即预安装例程通过检查可用的软件包版本而不是已安装的版本而失败。换句话说，如果<strong class="kf ir">rhel-7-server-ose-3.7-rpms</strong>repo中有比<strong class="kf ir"> openshift_pkg_version </strong>中指定的版本更高的软件包，集群安装将不会运行。</p><p id="de1f" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">为了克服这一点，我们只需通过<strong class="kf ir"> /etc/yum.conf </strong>文件排除更高的包版本。安装之前，每个节点上都必须有此设置:</p><pre class="lz ma mb mc gt md me mf mg aw mh bi"><span id="c4b4" class="lb lc iq me b gy mi mj l mk ml">[main]</span><span id="ac11" class="lb lc iq me b gy mm mj l mk ml">#  One entry for every upper version (*-openshift*3.7.47 *-openshift*3.7.48)</span><span id="f362" class="lb lc iq me b gy mm mj l mk ml">exclude= *openshift*3.7.46</span></pre><p id="da71" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">最后，我们必须从运行安装程序的主机上的ansi ble<a class="ae kc" href="/usr/share/ansible/openshift-ansible/roles/openshift_health_checker/library/aos_version.py" rel="noopener ugc nofollow" target="_blank"><strong class="kf ir">open shift _ health _ checker</strong></a>模块中的<a class="ae kc" href="/usr/share/ansible/openshift-ansible/roles/openshift_health_checker/library/aos_version.py" rel="noopener ugc nofollow" target="_blank"> <strong class="kf ir"> aos_version.py </strong> </a>文件中删除以下行；否则，安装程序将忽略我们刚刚在上一步中配置的排除设置。</p><pre class="lz ma mb mc gt md me mf mg aw mh bi"><span id="6d06" class="lb lc iq me b gy mi mj l mk ml"># /usr/share/ansible/openshift-ansible/roles/openshift_health_checker/library/aos_version.py</span><span id="cd92" class="lb lc iq me b gy mm mj l mk ml"># yb.conf.disable_excludes = ['all']</span></pre><p id="9077" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">同样，我不清楚这种可疑逻辑的原因，但最终结果是删除该行允许安装程序继续工作。</p><p id="6d8d" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">一旦安装程序完成，跨节点运行一个<strong class="kf ir"> yum list | grep openshift </strong>来确认软件包安装在正确的版本上。</p><pre class="lz ma mb mc gt md me mf mg aw mh bi"><span id="68b7" class="lb lc iq me b gy mi mj l mk ml">$ ansible all -m shell -a 'yum list | grep openshift'<br/>10.90.66.117 | SUCCESS | rc=0 &gt;&gt;<br/>atomic-openshift.x86_64         3.7.44-2.git.0.6b061d4.el7<br/>atomic-openshift-clients.x86_64 3.7.44-2.git.0.6b061d4.el7<br/>atomic-openshift-clients-redistributable.x86_64<br/>atomic-openshift-cluster-capacity.x86_64<br/>atomic-openshift-descheduler.x86_64<br/>atomic-openshift-docker-excluder.noarch<br/>atomic-openshift-dockerregistry.x86_64<br/>atomic-openshift-excluder.noarch<br/>atomic-openshift-federation-services.x86_64<br/>atomic-openshift-master.x86_64  3.7.44-2.git.0.6b061d4.el7<br/>atomic-openshift-node.x86_64    3.7.44-2.git.0.6b061d4.el7<br/>atomic-openshift-node-problem-detector.x86_64<br/>atomic-openshift-pod.x86_64     3.7.44-2.git.0.6b061d4.el7<br/>atomic-openshift-sdn-ovs.x86_64 3.7.44-2.git.0.6b061d4.el7<br/>atomic-openshift-service-catalog.x86_64<br/>atomic-openshift-template-service-broker.x86_64<br/>atomic-openshift-tests.x86_64   3.7.44-2.git.0.6b061d4.el7<br/>atomic-openshift-utils.noarch   3.7.44-1.git.9.684c638.el7<br/>golang-github-openshift-oauth-proxy.x86_64<br/>golang-github-openshift-prometheus-alert-buffer.x86_64<br/>hawkular-openshift-agent.x86_64 1.2.2-1.el7           rhel-7-server-ose-3.7-rpms<br/>jenkins-plugin-openshift-client.x86_64<br/>jenkins-plugin-openshift-login.x86_64<br/>jenkins-plugin-openshift-pipeline.x86_64<br/>jenkins-plugin-openshift-sync.x86_64<br/>nodejs-openshift-auth-proxy.noarch<br/>openshift-ansible.noarch        3.7.44-1.git.9.684c638.el7<br/>openshift-ansible-callback-plugins.noarch<br/>openshift-ansible-docs.noarch   3.7.44-1.git.9.684c638.el7<br/>openshift-ansible-filter-plugins.noarch<br/>openshift-ansible-lookup-plugins.noarch<br/>openshift-ansible-playbooks.noarch<br/>openshift-ansible-roles.noarch  3.7.44-1.git.9.684c638.el7<br/>openshift-elasticsearch-plugin.noarch<br/>openshift-eventrouter.x86_64    0.1-1.git5bd9251.el7  rhel-7-server-ose-3.7-rpms<br/>openshift-external-storage-efs-provisioner.x86_64<br/>openshift-external-storage-local-provisioner.x86_64<br/>openshift-external-storage-snapshot-controller.x86_64<br/>openshift-external-storage-snapshot-provisioner.x86_64<br/>python2-openshift.noarch        1:0.3.4-2.el7         rhel-7-server-ose-3.7-rpms<br/>tuned-profiles-atomic-openshift-node.x86_64</span></pre><h2 id="555b" class="lb lc iq bd ld le lf dn lg lh li dp lj ko lk ll lm ks ln lo lp kw lq lr ls lt bi translated">包扎</h2><p id="9425" class="pw-post-body-paragraph kd ke iq kf b kg lu ki kj kk lv km kn ko lw kq kr ks lx ku kv kw ly ky kz la ij bi translated">我认为我们可以认为自己是幸运的，这次我们能够在没有任何重大并发症的情况下幸存下来。话虽如此，但它确实触发了一个警报信号，提醒我们在托管这些平台时，不应该忽视适当的内务管理实践。</p><p id="40ad" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们的最终目标是更深入地挖掘OpenShift playbook安装程序，并找出一种创建黄金ami的方法，以便我们能够提供真正相同的节点，即使我们闭着眼睛也可以信任这些节点。</p><p id="3c39" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在那之前，动手干活吧。</p><p id="ceb3" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">干杯</p></div></div>    
</body>
</html>