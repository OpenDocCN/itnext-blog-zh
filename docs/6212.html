<html>
<head>
<title>OPA — Validating Policies</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">OPA —验证策略</h1>
<blockquote>原文：<a href="https://itnext.io/opa-validating-policies-d6d05992e13a?source=collection_archive---------4-----------------------#2021-09-20">https://itnext.io/opa-validating-policies-d6d05992e13a?source=collection_archive---------4-----------------------#2021-09-20</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/6938ef300fd79eee170742a3f2d17b2c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*qyJritNAMjVEDRPZ.jpg"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">LGTM竖起大拇指！</figcaption></figure><p id="3dd4" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">制定OPA策略需要结合使用减压阀语言和YAML配置。要验证策略是否有效，有几种方法:</p><ul class=""><li id="74d9" class="la lb iq ke b kf kg kj kk kn lc kr ld kv le kz lf lg lh li bi translated"><strong class="ke ir">单元测试</strong> —用单元测试验证一组独立的断言。像大多数语言一样，减压阀也有一个单元测试框架。基于rego语言对于新手的复杂性，我再怎么强调单元测试的使用也不为过。单元测试可能是另一篇博客的主题。</li><li id="eae8" class="la lb iq ke b kf lj kj lk kn ll kr lm kv ln kz lf lg lh li bi translated"><strong class="ke ir">部署到集群</strong> —创建您的rego，将其打包到OPA YAML中，并使用kubectl或您选择的方法提交到集群</li><li id="e672" class="la lb iq ke b kf lj kj lk kn ll kr lm kv ln kz lf lg lh li bi translated"><strong class="ke ir">使用验证工具</strong> —验证可以检查语法错误、语言和语义。</li></ul><p id="b70c" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">在这篇博客中，我将重点介绍如何使用验证工具向策略工程师提供快速反馈。这个工具非常有价值，因为我在很长一段时间内都没有可用的集群。它引发了许多即使部署到集群也不会发现的错误。</p><h1 id="7795" class="lo lp iq bd lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml bi translated">策略验证工具</h1><p id="ef0d" class="pw-post-body-paragraph kc kd iq ke b kf mm kh ki kj mn kl km kn mo kp kq kr mp kt ku kv mq kx ky kz ij bi translated">Google在其Forsetti合规引擎中广泛使用OPA，也在Anthos策略控制器中使用它。因此，他们开发了一个<a class="ae mr" href="https://github.com/GoogleCloudPlatform/policy-library#linting-policies" rel="noopener ugc nofollow" target="_blank">工具</a>来支持与您的策略相关的rego和YAML的本地验证。</p><p id="ef73" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">在下面的例子中，我将在docker容器中运行这个工具，这样我就不用担心安装它了(我相信它是基于Java的)。下面的命令将当前工作目录中的一些文件夹挂载到容器中，以便它可以读取YAML文件和库(如果有的话)。</p><pre class="ms mt mu mv gt mw mx my mz aw na bi"><span id="df0b" class="nb lp iq mx b gy nc nd l ne nf">docker run -it --rm \<br/>		-v "$(CURDIR):/workspace" \<br/>		-w=/workspace \<br/>		gcr.io/config-validator/pollicy-tool:latest \<br/>		lint \<br/>		--policies /workspace/yaml \<br/>		--libs /workspace/lib</span></pre><p id="9d34" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">该工具的结果可能有些冗长。一个问题一个问题地通读，并在过程中解决它们。请记住，该工具在遇到第一个错误时就会退出。</p><p id="add8" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">我已经将该工具集成到这个示例库<a class="ae mr" href="https://github.com/patpicos/rego_doc_gen" rel="noopener ugc nofollow" target="_blank">的makefile中</a></p><h1 id="5ba6" class="lo lp iq bd lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml bi translated">发现的示例问题</h1><h2 id="85c2" class="nb lp iq bd lq ng nh dn lu ni nj dp ly kn nk nl mc kr nm nn mg kv no np mk nq bi translated">OPA期望</h2><p id="6166" class="pw-post-body-paragraph kc kd iq ke b kf mm kh ki kj mn kl km kn mo kp kq kr mp kt ku kv mq kx ky kz ij bi translated">我最初开发的许多策略都是以rego世界中相当常见的格式完成的。然而，OPA希望最终的答案采用不同的格式</p><pre class="ms mt mu mv gt mw mx my mz aw na bi"><span id="9410" class="nb lp iq mx b gy nc nd l ne nf">deny[msg] {<br/>  1 == 1<br/>  msg := "This is raised violation"<br/>}</span></pre><p id="bc0c" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">我必须将我的违规转换成如下所示，以便OPA Gatekeeper揭露您的违规</p><pre class="ms mt mu mv gt mw mx my mz aw na bi"><span id="9449" class="nb lp iq mx b gy nc nd l ne nf">violation[{"msg": msg}] {<br/>  1 == 1<br/>  msg := "This is raised violation"<br/>}</span></pre><h2 id="1902" class="nb lp iq bd lq ng nh dn lu ni nj dp ly kn nk nl mc kr nm nn mg kv no np mk nq bi translated">约束模板验证</h2><p id="3e52" class="pw-post-body-paragraph kc kd iq ke b kf mm kh ki kj mn kl km kn mo kp kq kr mp kt ku kv mq kx ky kz ij bi translated">在我开始使用Konstraint从rego代码生成ConstraintTemplates之前，我是手工构建它的。</p><p id="583d" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">验证策略工具做的一件事是确保CRD名字是骆驼大小写，并且名字是小写版本。</p><pre class="ms mt mu mv gt mw mx my mz aw na bi"><span id="5137" class="nb lp iq mx b gy nc nd l ne nf">apiVersion: templates.gatekeeper.sh/v1beta1<br/>kind: ConstraintTemplate<br/>metadata:<br/>  creationTimestamp: null<br/>  name: policyone   # Must be lowercase version of the spec.crd.spec.names.kind<br/>spec:<br/>  crd:<br/>    spec:<br/>      names:<br/>        kind: PolicyOne</span></pre><h2 id="5205" class="nb lp iq bd lq ng nh dn lu ni nj dp ly kn nk nl mc kr nm nn mg kv no np mk nq bi translated">无效的减压阀函数</h2><p id="1e00" class="pw-post-body-paragraph kc kd iq ke b kf mm kh ki kj mn kl km kn mo kp kq kr mp kt ku kv mq kx ky kz ij bi translated">在我的一个策略中，我使用了regex.match。验证器抱怨说这不是一个有效的函数，尽管它在文档中。我不得不改用re_match()函数。</p><p id="98ff" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">这是一个非常模糊的问题，除了这篇文章之外，几乎没有什么细节</p><h1 id="67ee" class="lo lp iq bd lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml bi translated">结论</h1><p id="49c6" class="pw-post-body-paragraph kc kd iq ke b kf mm kh ki kj mn kl km kn mo kp kq kr mp kt ku kv mq kx ky kz ij bi translated">如您所见，策略工具在rego逻辑和YAML语义方面都做了非常深入的验证。它为开发人员提供了快速的反馈，而无需访问非常强大的集群。</p></div></div>    
</body>
</html>