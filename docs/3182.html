<html>
<head>
<title>Express.js Backend with TypeScript, Swagger UI, and Docker Compose</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">带有TypeScript、Swagger UI和Docker编写的Express.js后端</h1>
<blockquote>原文：<a href="https://itnext.io/express-js-backend-with-typescript-swagger-ui-and-docker-compose-f77143860bc8?source=collection_archive---------0-----------------------#2019-10-19">https://itnext.io/express-js-backend-with-typescript-swagger-ui-and-docker-compose-f77143860bc8?source=collection_archive---------0-----------------------#2019-10-19</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><p id="0d76" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">这是一个详尽的教程，用来创建一个简单的符合OpenAPI规范的后端应用程序。</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi ko"><img src="../Images/8bfc67310e42b332c7048da4464133eb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*hohK6EONXCAy4mTRkT8K8A.png"/></div></div></figure><h1 id="a542" class="la lb it bd lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx bi translated">创建简单的Express.js应用程序</h1><p id="2f52" class="pw-post-body-paragraph jq jr it js b jt ly jv jw jx lz jz ka kb ma kd ke kf mb kh ki kj mc kl km kn im bi translated"><em class="md">你可以从</em> <a class="ae me" href="https://github.com/aerabi/simple-express" rel="noopener ugc nofollow" target="_blank"> <em class="md">这个资源库</em> </a> <em class="md">下载simple Express.js app模板，直接跳转到下一节“添加TSOA”。</em></p><p id="7542" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">从一个空白项目开始。在项目的根目录下创建一个文件夹<code class="fe mf mg mh mi b">src</code>，并在其中创建一个名为<code class="fe mf mg mh mi b">main.ts</code>的文件。用下面的代码填充<code class="fe mf mg mh mi b">main.ts</code>，这是Express.js的<a class="ae me" href="https://expressjs.com/en/starter/hello-world.html" rel="noopener ugc nofollow" target="_blank">标准Hello World代码</a>:</p><figure class="kp kq kr ks gt kt"><div class="bz fp l di"><div class="mj mk l"/></div></figure><p id="d16b" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">用节点包管理器安装<code class="fe mf mg mh mi b">express</code>，编译代码，并运行它:</p><pre class="kp kq kr ks gt ml mi mm mn aw mo bi"><span id="05a5" class="mp lb it mi b gy mq mr l ms mt">$ npm install express<br/>$ npm install typescript<br/>$ tsc src/main.ts<br/>$ node src/main.js</span></pre><h2 id="fe8a" class="mp lb it bd lc mu mv dn lg mw mx dp lk kb my mz lo kf na nb ls kj nc nd lw ne bi translated">结构化项目</h2><p id="7ff1" class="pw-post-body-paragraph jq jr it js b jt ly jv jw jx lz jz ka kb ma kd ke kf mb kh ki kj mc kl km kn im bi translated">如您所见，编译后的版本(<code class="fe mf mg mh mi b">.js</code>文件)生成在与您的TypeScript文件相同的文件夹中。我们希望将源文件从编译的JS中分离出来。此外，我们希望更好地跟踪我们的第三方软件包。</p><p id="a450" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">对于后者，我们应该创建一个<code class="fe mf mg mh mi b">package.json</code>文件，放在项目的根文件夹中。运行下面的命令就可以了，我们只需要回答相应的问题:</p><pre class="kp kq kr ks gt ml mi mm mn aw mo bi"><span id="1520" class="mp lb it mi b gy mq mr l ms mt">$ npm init</span></pre><p id="efea" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">初始化软件包后，所有已安装的软件包将作为[生产]依赖项列出。以下命令将把<code class="fe mf mg mh mi b">typescript</code>移动到开发依赖项中:</p><pre class="kp kq kr ks gt ml mi mm mn aw mo bi"><span id="dfd1" class="mp lb it mi b gy mq mr l ms mt">$ npm install typescript --save-dev</span></pre><p id="ff8c" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">在我的例子中，产生的<code class="fe mf mg mh mi b">package.json</code>文件如下所示:</p><figure class="kp kq kr ks gt kt"><div class="bz fp l di"><div class="mj mk l"/></div></figure><p id="e05d" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">现在，在<code class="fe mf mg mh mi b">src</code>下创建一个TypeScript配置文件，即<code class="fe mf mg mh mi b">tsconfig.json</code>，并填充以下内容:</p><figure class="kp kq kr ks gt kt"><div class="bz fp l di"><div class="mj mk l"/></div></figure><p id="9dba" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">使用下面的命令将编译<code class="fe mf mg mh mi b">src</code>下的所有TypeScript文件，并将它们放在<code class="fe mf mg mh mi b">dist</code>文件夹下。</p><pre class="kp kq kr ks gt ml mi mm mn aw mo bi"><span id="3e2a" class="mp lb it mi b gy mq mr l ms mt">$ tsc -p src</span></pre><p id="ae2c" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">现在，要运行服务器，请执行以下操作:</p><pre class="kp kq kr ks gt ml mi mm mn aw mo bi"><span id="6092" class="mp lb it mi b gy mq mr l ms mt">$ node dist/main.js</span></pre><p id="d080" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">在添加了定制的<code class="fe mf mg mh mi b">package.json</code>脚本、TSLint规则和<code class="fe mf mg mh mi b">.gitignore</code>之后，项目看起来会像<a class="ae me" href="https://github.com/aerabi/simple-express" rel="noopener ugc nofollow" target="_blank">这个</a>。</p><h1 id="7912" class="la lb it bd lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx bi translated">添加TSOA</h1><p id="7db6" class="pw-post-body-paragraph jq jr it js b jt ly jv jw jx lz jz ka kb ma kd ke kf mb kh ki kj mc kl km kn im bi translated"><a class="ae me" href="https://github.com/lukeautry/tsoa" rel="noopener ugc nofollow" target="_blank"><strong class="js iu">TSOA</strong></a>(<strong class="js iu">T</strong>type<strong class="js iu">S</strong>script<strong class="js iu">O</strong>pen<strong class="js iu">A</strong>PI)是一款开源工具，用于生成兼容OpenAPI的REST端点和生成Swagger配置文件，以及用于Express.js等中间件的路由器</p><p id="78d4" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">首先将包添加到我们的项目中:</p><pre class="kp kq kr ks gt ml mi mm mn aw mo bi"><span id="7de1" class="mp lb it mi b gy mq mr l ms mt">$ npm install tsoa --save-dev<br/>$ npm install @types/node --save-dev</span></pre><h2 id="fea0" class="mp lb it bd lc mu mv dn lg mw mx dp lk kb my mz lo kf na nb ls kj nc nd lw ne bi translated">创建控制器并生成路线</h2><p id="13fa" class="pw-post-body-paragraph jq jr it js b jt ly jv jw jx lz jz ka kb ma kd ke kf mb kh ki kj mc kl km kn im bi translated">创建<code class="fe mf mg mh mi b">src/controllers/index.controller.ts</code>并用以下代码填充它:</p><figure class="kp kq kr ks gt kt"><div class="bz fp l di"><div class="mj mk l"/></div></figure><p id="66cf" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">将<code class="fe mf mg mh mi b">"experimentalDecorators": true</code>选项添加到<code class="fe mf mg mh mi b">src/tsconfig.json</code>文件中，为TypeScript启用decorators:</p><figure class="kp kq kr ks gt kt"><div class="bz fp l di"><div class="mj mk l"/></div></figure><p id="c7a9" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">将配置文件<code class="fe mf mg mh mi b">tsoa.json</code>添加到项目根目录:</p><figure class="kp kq kr ks gt kt"><div class="bz fp l di"><div class="mj mk l"/></div></figure><p id="d142" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">生成路线并放入<code class="fe mf mg mh mi b">src/routes</code>:</p><pre class="kp kq kr ks gt ml mi mm mn aw mo bi"><span id="b71b" class="mp lb it mi b gy mq mr l ms mt">$ mkdir -p src/routes<br/>$ tsoa routes</span></pre><p id="2c14" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">从生成的routes文件中导入<code class="fe mf mg mh mi b">RegisterRoutes</code>,并通过向其传递Express.js应用程序来调用它:</p><figure class="kp kq kr ks gt kt"><div class="bz fp l di"><div class="mj mk l"/></div></figure><p id="515c" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">现在，用户可以启动服务器并访问端点:</p><pre class="kp kq kr ks gt ml mi mm mn aw mo bi"><span id="66f7" class="mp lb it mi b gy mq mr l ms mt">$ npm run server</span></pre><p id="2cfe" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">端点的URL是<code class="fe mf mg mh mi b">/api/v1/</code>和<code class="fe mf mg mh mi b">/api/v1/msg/</code>:</p><pre class="kp kq kr ks gt ml mi mm mn aw mo bi"><span id="3f2b" class="mp lb it mi b gy mq mr l ms mt">$ curl localhost:3000/api/v1/<br/>$ curl localhost:3000/api/v1/msg/</span></pre><h2 id="9e34" class="mp lb it bd lc mu mv dn lg mw mx dp lk kb my mz lo kf na nb ls kj nc nd lw ne bi translated">生成Swagger配置</h2><p id="cc6a" class="pw-post-body-paragraph jq jr it js b jt ly jv jw jx lz jz ka kb ma kd ke kf mb kh ki kj mc kl km kn im bi translated">创建文件夹<code class="fe mf mg mh mi b">api/dist</code>并使用TSOA生成Swagger配置:</p><pre class="kp kq kr ks gt ml mi mm mn aw mo bi"><span id="7b84" class="mp lb it mi b gy mq mr l ms mt">$ mkdir -p api &amp;&amp; mkdir -p api/dist <br/>$ tsoa swagger</span></pre><p id="227d" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">现在可以使用Docker启动Swagger UI了:</p><pre class="kp kq kr ks gt ml mi mm mn aw mo bi"><span id="d7ab" class="mp lb it mi b gy mq mr l ms mt">$ docker run -p 8080:8080 -v ${PWD}/api/dist:/swagger -e SWAGGER_JSON=/swagger/swagger.json swaggerapi/swagger-ui</span></pre><p id="4214" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">在浏览器上打开<a class="ae me" href="http://localhost:8080" rel="noopener ugc nofollow" target="_blank"> localhost:8080 </a>看霸气的UI。端点被正确列出(至少，这是预期的行为)，但是如果您尝试它们，Swagger UI会说:</p><pre class="kp kq kr ks gt ml mi mm mn aw mo bi"><span id="bd03" class="mp lb it mi b gy mq mr l ms mt">TypeError: Failed to fetch</span></pre><p id="9417" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">打开浏览器的控制台，人们会发现原来的错误是:</p><pre class="kp kq kr ks gt ml mi mm mn aw mo bi"><span id="cdbf" class="mp lb it mi b gy mq mr l ms mt">GET <a class="ae me" href="https://localhost:3000/api/v1/" rel="noopener ugc nofollow" target="_blank">https://localhost:3000/api/v1/</a> net::ERR_CONNECTION_REFUSED</span></pre><p id="2fc6" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">这是因为Swagger UI正在尝试使用HTTPS，这是目前不可用的。</p><h2 id="5b5c" class="mp lb it bd lc mu mv dn lg mw mx dp lk kb my mz lo kf na nb ls kj nc nd lw ne bi translated">支持HTTPS</h2><p id="ce4e" class="pw-post-body-paragraph jq jr it js b jt ly jv jw jx lz jz ka kb ma kd ke kf mb kh ki kj mc kl km kn im bi translated">要使用HTTPS，您必须拥有SSL证书。请在本地创建它们，或者从像<a class="ae me" href="https://letsencrypt.org/" rel="noopener ugc nofollow" target="_blank">让我们加密</a>这样的网站下载它们。假设您已经准备好了证书，将<code class="fe mf mg mh mi b">crt</code>文件和私钥放在一个子文件夹中，比如说<code class="fe mf mg mh mi b">cert</code>。那么您的<code class="fe mf mg mh mi b">main.ts</code>将变成如下:</p><figure class="kp kq kr ks gt kt"><div class="bz fp l di"><div class="mj mk l"/></div></figure><h2 id="ff49" class="mp lb it bd lc mu mv dn lg mw mx dp lk kb my mz lo kf na nb ls kj nc nd lw ne bi translated">添加TSOA构建脚本</h2><p id="b9d6" class="pw-post-body-paragraph jq jr it js b jt ly jv jw jx lz jz ka kb ma kd ke kf mb kh ki kj mc kl km kn im bi translated">为了更容易地生成路由器和Swagger配置，应该在<code class="fe mf mg mh mi b">package.json</code>中创建自定义脚本。将以下脚本添加到您的<code class="fe mf mg mh mi b">package.json</code>文件中:</p><figure class="kp kq kr ks gt kt"><div class="bz fp l di"><div class="mj mk l"/></div></figure><p id="7d80" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">现在，我们可以使用以下命令构建路由、进行配置和编译:</p><pre class="kp kq kr ks gt ml mi mm mn aw mo bi"><span id="615d" class="mp lb it mi b gy mq mr l ms mt">$ npm run build:all</span></pre><h1 id="375e" class="la lb it bd lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx bi translated">添加Docker</h1><p id="59b7" class="pw-post-body-paragraph jq jr it js b jt ly jv jw jx lz jz ka kb ma kd ke kf mb kh ki kj mc kl km kn im bi translated">为了更容易部署，建议使用Docker-Compose。但是，要做到这一点，我们首先需要为我们的web应用程序构建一个图像。</p><h2 id="487e" class="mp lb it bd lc mu mv dn lg mw mx dp lk kb my mz lo kf na nb ls kj nc nd lw ne bi translated">为Express.js应用程序添加Dockerfile</h2><p id="d3c6" class="pw-post-body-paragraph jq jr it js b jt ly jv jw jx lz jz ka kb ma kd ke kf mb kh ki kj mc kl km kn im bi translated">将以下内容作为<code class="fe mf mg mh mi b">Dockerfile</code>添加到项目根:</p><figure class="kp kq kr ks gt kt"><div class="bz fp l di"><div class="mj mk l"/></div></figure><p id="c762" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">使用构建映像，并使用以下命令运行它:</p><pre class="kp kq kr ks gt ml mi mm mn aw mo bi"><span id="b512" class="mp lb it mi b gy mq mr l ms mt">$ docker build -t aerabi/exptress-ts .<br/>$ docker run -p 3000:3000 aerabi/express-ts</span></pre><h2 id="823a" class="mp lb it bd lc mu mv dn lg mw mx dp lk kb my mz lo kf na nb ls kj nc nd lw ne bi translated">添加Docker-撰写配置</h2><p id="b39f" class="pw-post-body-paragraph jq jr it js b jt ly jv jw jx lz jz ka kb ma kd ke kf mb kh ki kj mc kl km kn im bi translated">现在我们可以使用web应用程序Docker映像在根上创建一个Docker-Compose配置，即<code class="fe mf mg mh mi b">docker-compose.yaml</code>:</p><figure class="kp kq kr ks gt kt"><div class="bz fp l di"><div class="mj mk l"/></div></figure><p id="e305" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">现在，可以使用以下命令运行整个包:</p><pre class="kp kq kr ks gt ml mi mm mn aw mo bi"><span id="e8d2" class="mp lb it mi b gy mq mr l ms mt">$ docker-compose up</span></pre><h1 id="a018" class="la lb it bd lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx bi translated">结论</h1><p id="f46a" class="pw-post-body-paragraph jq jr it js b jt ly jv jw jx lz jz ka kb ma kd ke kf mb kh ki kj mc kl km kn im bi translated">演示了使用Express.js和TypeScript、TSOA和Swagger UI的分步教程。最终项目的一个版本可以在<a class="ae me" href="https://github.com/aerabi/express-ts-swagger-docker" rel="noopener ugc nofollow" target="_blank">的Github库</a>中找到。</p></div></div>    
</body>
</html>