<html>
<head>
<title>Deploy a Kubernetes Cluster on OpenStack using Kubespray</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Kubespray在OpenStack上部署Kubernetes集群</h1>
<blockquote>原文：<a href="https://itnext.io/deploy-a-kubernetes-cluster-on-openstack-using-kubespray-39b230b13d62?source=collection_archive---------2-----------------------#2019-03-12">https://itnext.io/deploy-a-kubernetes-cluster-on-openstack-using-kubespray-39b230b13d62?source=collection_archive---------2-----------------------#2019-03-12</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><figure class="gl gn jr js jt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi jq"><img src="../Images/38067016443b94913ba168873f28d397.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*oRUsjY0iizMyIwyx8GpSeQ.jpeg"/></div></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated">照片由<a class="ae kf" href="https://www.pexels.com/@albinberlin?utm_content=attributionCopyText&amp;utm_medium=referral&amp;utm_source=pexels" rel="noopener ugc nofollow" target="_blank">阿尔宾柏林</a>从<a class="ae kf" href="https://www.pexels.com/photo/black-sail-ship-on-body-of-water-906982/?utm_content=attributionCopyText&amp;utm_medium=referral&amp;utm_source=pexels" rel="noopener ugc nofollow" target="_blank">派克斯</a>拍摄</figcaption></figure><p id="6c59" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">Kubernetes已经迅速成为部署、扩展和管理容器应用程序的开源标准解决方案。它提供了高度的灵活性和多功能性。但是什么导致了一个大而强大的文档，这可能是压倒一个或另一个，当试图找到他的安装的相关部分。这就是为什么Kubernetes有一个陡峭的学习曲线。在群集规划之后，接着是安装，这也有其缺陷。出于这个原因，有一些部署工具，比如<a class="ae kf" href="https://github.com/kubernetes-sigs/kubespray" rel="noopener ugc nofollow" target="_blank"> Kubespray </a>，可以让这项工作变得更加容易。这个故事是关于在OpenStack云(Open Telekom Cloud)上使用Kubespray自动部署Kubernetes集群的。</p><p id="c0d6" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">Kubespray用于Kubernetes的自动部署，它是一个供应、配置和应用程序部署工具Ansible。Kubespray还提供了一个库，用于在不同的云平台上提供资源。为此，使用基础设施作为代码工具Terraform。Kubespray项目目前为云提供商AWS、OpenStack和Packet提供<a class="ae kf" href="https://github.com/kubernetes-sigs/kubespray/tree/master/contrib/terraform" rel="noopener ugc nofollow" target="_blank"> Terraform支持</a>。这个工具与<a class="ae kf" href="https://github.com/kubernetes-sigs/kubespray/tree/master/contrib/terraform/openstack" rel="noopener ugc nofollow" target="_blank"> OpenStack库</a>一起用于提供这个故事中的基础设施。</p><h1 id="9535" class="le lf it bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">要求</h1><p id="e924" class="pw-post-body-paragraph kg kh it ki b kj mc kl km kn md kp kq kr me kt ku kv mf kx ky kz mg lb lc ld im bi translated">首先，我们看一下部署的先决条件。这些分为Kubespray和provider库的需求。</p><p id="3848" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">Kubespray需要以下组件:</p><ul class=""><li id="7f01" class="mh mi it ki b kj kk kn ko kr mj kv mk kz ml ld mm mn mo mp bi translated"><em class="mq"> Python 2.7(或更新版本)</em></li><li id="9fd2" class="mh mi it ki b kj mr kn ms kr mt kv mu kz mv ld mm mn mo mp bi translated"><em class="mq"> Ansible 2.7(或更新版本)</em></li><li id="1106" class="mh mi it ki b kj mr kn ms kr mt kv mu kz mv ld mm mn mo mp bi translated"><em class="mq"> Jinja 2.9(或更新版本)</em></li></ul><p id="2595" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">OpenStack提供程序库要求:</p><ul class=""><li id="17a7" class="mh mi it ki b kj kk kn ko kr mj kv mk kz ml ld mm mn mo mp bi translated"><em class="mq"> Terraform 0.11(或更新版本)</em></li></ul><p id="9bfd" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">要安装Terraform，需要从<a class="ae kf" href="https://www.terraform.io/downloads.html" rel="noopener ugc nofollow" target="_blank">哈希公司网站</a>下载合适的软件包。打开包装。然后，解包二进制文件的路径必须存储在path变量中。使用命令“terraform”，您可以测试安装是否成功。更多信息可在以下<a class="ae kf" href="https://learn.hashicorp.com/terraform/getting-started/install.html" rel="noopener ugc nofollow" target="_blank">链接</a>下找到。</p><p id="390f" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">根据操作系统的不同，只需几个命令就可以安装Ansible。请参考以下Ansible <a class="ae kf" href="https://docs.ansible.com/ansible/latest/installation_guide/intro_installation.html" rel="noopener ugc nofollow" target="_blank">文档</a>。在这个故事中，我使用了Ubuntu，Ansible的安装如下。</p><pre class="mw mx my mz gt na nb nc nd aw ne bi"><span id="c21d" class="nf lf it nb b gy ng nh l ni nj">sudo apt update<br/>sudo apt install ansible</span></pre><p id="bd8a" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">之后，必须安装库贝斯雷的依赖项。这是通过以下命令完成的。首先需要克隆存储库。</p><pre class="mw mx my mz gt na nb nc nd aw ne bi"><span id="58fd" class="nf lf it nb b gy ng nh l ni nj">git clone <a class="ae kf" href="https://github.com/kubernetes-sigs/kubespray" rel="noopener ugc nofollow" target="_blank">https://github.com/kubernetes-sigs/kubespray</a><br/>sudo pip install -r requirements.txt</span></pre><p id="dba2" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">要使用开放电信云，有必要使用主目录中的<code class="fe nk nl nm nb b">.ostackrc</code>设置您的访问数据，并加载环境变量。</p><h1 id="440d" class="le lf it bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">集群规划</h1><p id="6285" class="pw-post-body-paragraph kg kh it ki b kj mc kl km kn md kp kq kr me kt ku kv mf kx ky kz mg lb lc ld im bi translated">由于其高度灵活性，Kubernetes提供了多种可能性来使集群适应您自己的需求。对众多可能性的考虑并不是这个故事的一部分。但可在Kubernetes文档中的— <a class="ae kf" href="https://kubernetes.io/docs/setup/scratch/" rel="noopener ugc nofollow" target="_blank">从头创建自定义集群</a>下阅读。对于示例性部署，我们将创建一个由一个主节点和两个工作节点组成的集群，etcd也运行在主节点上。同样，群集将没有浮动IP，因此无法从Internet访问。</p><p id="e999" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">另一个选择是CNI(集装箱网络接口)。有几种可供选择(纤毛、印花布、法兰绒、编织网等)。对于我们的例子，我们使用法兰绒，这是现成的。Calico也是一种可能，只需要配置<a class="ae kf" href="https://github.com/kubernetes-sigs/kubespray/blob/master/docs/openstack.md" rel="noopener ugc nofollow" target="_blank"> OpenStack中子端口</a>即可实现服务和吊舱子网。</p><p id="8976" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">为了在部署后使用Kubernetes仪表板控制集群，我们还将安装它。</p><h1 id="1cf7" class="le lf it bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">设置群集配置</h1><p id="a6bc" class="pw-post-body-paragraph kg kh it ki b kj mc kl km kn md kp kq kr me kt ku kv mf kx ky kz mg lb lc ld im bi translated">以下命令必须在存储库目录中执行，因此用一个有意义的名称填充变量$CLUSTER是很重要的。</p><pre class="mw mx my mz gt na nb nc nd aw ne bi"><span id="6721" class="nf lf it nb b gy ng nh l ni nj">cp -LRp contrib/terraform/openstack/sample-inventory \<br/>inventory/$CLUSTER<br/>cd inventory/$CLUSTER<br/>ln -s ../../contrib/terraform/openstack/hosts<br/>ln -s ../../contrib</span></pre><p id="f37c" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">运行命令后，有必要编辑<code class="fe nk nl nm nb b">inventory/$CLUSTER/cluster.tfvars</code>文件。</p><figure class="mw mx my mz gt ju"><div class="bz fp l di"><div class="nn no l"/></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated"><a class="ae kf" href="https://medium.com/@Robert.N" rel="noopener">罗伯特·纽曼</a>要点</figcaption></figure><p id="f4ef" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">变量的描述可以在下面的<a class="ae kf" href="https://github.com/kubernetes-sigs/kubespray/tree/master/contrib/terraform/openstack" rel="noopener ugc nofollow" target="_blank">链接</a>中找到。对于这个例子，我们将创建一个包含一个Kubernetes主节点和两个worker节点的集群。他们将基于最新的CentOS 7和“s2.exlarge.4”风格。etcd也将安装在主设备上。</p><h1 id="2a7b" class="le lf it bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">基础设施部署</h1><p id="5a9a" class="pw-post-body-paragraph kg kh it ki b kj mc kl km kn md kp kq kr me kt ku kv mf kx ky kz mg lb lc ld im bi translated">现在，我们已经准备好使用Terraform部署我们的集群基础设施。为了更好地了解情况，下图显示了部署后的情况。这个会在故事过程中延伸。</p><figure class="mw mx my mz gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi np"><img src="../Images/2cf616d99b3cb1be08f29c9a7ab3dc7c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*fg8n7FooQIBO0cls-pzdQQ.png"/></div></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated">罗伯特·诺依曼<a class="ae kf" href="https://medium.com/@Robert.N" rel="noopener">拍摄的图片</a></figcaption></figure><p id="c668" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">要启动Terraform部署，请转到<code class="fe nk nl nm nb b">inventory/$CLUSTER/</code>目录并运行以下命令。首先，我们需要安装所需的插件。这将通过<code class="fe nk nl nm nb b">init</code>参数和插件的路径来完成。</p><pre class="mw mx my mz gt na nb nc nd aw ne bi"><span id="e044" class="nf lf it nb b gy ng nh l ni nj">terraform init ../../contrib/terraform/openstack</span></pre><p id="2e71" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">这可真够快的。在这个阶段，Terraform已经准备好部署基础设施。这可以通过<code class="fe nk nl nm nb b">apply</code>论证来实现。</p><pre class="mw mx my mz gt na nb nc nd aw ne bi"><span id="aa6a" class="nf lf it nb b gy ng nh l ni nj">terraform apply -var-file=cluster.tfvars ../../contrib/terraform/openstack</span></pre><p id="42ed" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">几秒钟后，Terraform应该显示如下结果，并且实例是可访问的。</p><pre class="mw mx my mz gt na nb nc nd aw ne bi"><span id="bbdf" class="nf lf it nb b gy ng nh l ni nj">Apply complete! Resources: 3 added, 0 changed, 0 destroyed.</span></pre><p id="3b10" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">要检查服务器是否可以访问，可以执行下面的Ansible命令。在此之前，我们必须切换到存储库的根文件夹。</p><pre class="mw mx my mz gt na nb nc nd aw ne bi"><span id="7af7" class="nf lf it nb b gy ng nh l ni nj">$ ansible -i inventory/$CLUSTER/hosts -m ping all<br/>example-k8s_node-1 | SUCCESS =&gt; {<br/>    "changed": false,<br/>    "ping": "pong"<br/>}<br/>example-etcd-1 | SUCCESS =&gt; {<br/>    "changed": false,<br/>    "ping": "pong"<br/>}<br/>example-k8s-master-1 | SUCCESS =&gt; {<br/>    "changed": false,<br/>    "ping": "pong"<br/>}</span></pre><h1 id="179c" class="le lf it bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">Kubernetes集群部署</h1><p id="4575" class="pw-post-body-paragraph kg kh it ki b kj mc kl km kn md kp kq kr me kt ku kv mf kx ky kz mg lb lc ld im bi translated">基础设施已经部署，下一步是安装Kubernetes集群。首先，我们需要配置集群变量。其中一个文件是<code class="fe nk nl nm nb b">inventory/$CLUSTER/group_vars/all/all.yml</code>。该文件中的重要内容是将<code class="fe nk nl nm nb b">cloud_provider</code>设置为“openstack ”,并将<code class="fe nk nl nm nb b">bin_dir</code>设置为二进制文件将要安装的路径。对于示例集群，我们使用以下配置。</p><figure class="mw mx my mz gt ju"><div class="bz fp l di"><div class="nn no l"/></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated">罗伯特·诺依曼的要旨</figcaption></figure><p id="9d7d" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">接下来，我们需要配置<code class="fe nk nl nm nb b">inventory/$CLUSTER/group_vars/k8s-cluster/k8s-cluster.yml</code>文件。将<code class="fe nk nl nm nb b">kube_network_plugin</code>变量编辑为法兰绒或印花布(需要配置<a class="ae kf" href="https://github.com/kubernetes-sigs/kubespray/blob/master/docs/openstack.md" rel="noopener ugc nofollow" target="_blank"> OpenStack中子端口</a>)。在我们的例子中，我们使用现成的法兰绒。我们还配置了变量<code class="fe nk nl nm nb b">resolvconf_mode</code>，我们将使用“docker_dns”。通过这个值，Kubespray将设置<a class="ae kf" href="https://github.com/kubernetes-sigs/kubespray/blob/master/docs/dns-stack.md#resolvconf_mode" rel="noopener ugc nofollow" target="_blank"> docker守护进程标志</a>。我们的集群的配置示例如下所示。</p><figure class="mw mx my mz gt ju"><div class="bz fp l di"><div class="nn no l"/></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated">要旨由<a class="ae kf" href="https://medium.com/@Robert.N" rel="noopener">罗伯特·诺依曼</a></figcaption></figure><p id="50e2" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">最后，我们需要编辑<code class="fe nk nl nm nb b">inventory/$CLUSTER/group_vars/k8s-cluster/addons.yml</code>，通过将变量<code class="fe nk nl nm nb b">dashboard_enabled</code>设置为“true”来启用仪表板安装。您可以使用下面的配置示例。</p><figure class="mw mx my mz gt ju"><div class="bz fp l di"><div class="nn no l"/></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated">罗伯特·诺依曼的要旨</figcaption></figure><p id="cad6" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">在配置编辑之后，我们需要通过下面的命令使用配置的参数运行Ansible-Playbook。</p><pre class="mw mx my mz gt na nb nc nd aw ne bi"><span id="3522" class="nf lf it nb b gy ng nh l ni nj">ansible-playbook --become -i inventory/$CLUSTER/hosts cluster.yml</span></pre><p id="0f30" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">Ansible经过几个步骤，如果所有步骤都成功，您的集群看起来如下图所示。</p><figure class="mw mx my mz gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi nq"><img src="../Images/1ba5a4c98cb6a19318b0ac212e1858f7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*A10ccnO3FRTWRdkjFBNq_Q.png"/></div></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated">图片由<a class="ae kf" href="https://medium.com/@Robert.N" rel="noopener">罗伯特·诺依曼</a></figcaption></figure><h1 id="646f" class="le lf it bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">测试</h1><p id="553e" class="pw-post-body-paragraph kg kh it ki b kj mc kl km kn md kp kq kr me kt ku kv mf kx ky kz mg lb lc ld im bi translated">为了测试您的集群，您必须登录到Kubernetes主服务器，切换到根用户并使用kubectl工具通过<code class="fe nk nl nm nb b">kubectl cluster-info</code> <strong class="ki iu"> </strong>命令获取集群信息。它将显示集群中主服务器和服务的端点信息。如果您的集群看起来不错，您需要通过以下命令创建一个Kubernetes仪表板用户。</p><pre class="mw mx my mz gt na nb nc nd aw ne bi"><span id="62d6" class="nf lf it nb b gy ng nh l ni nj"># Create service account<br/>kubectl create serviceaccount cluster-admin-dashboard-sa<br/><br/># Bind ClusterAdmin role to the service account<br/>kubectl create clusterrolebinding cluster-admin-dashboard-sa \<br/>  --clusterrole=cluster-admin \<br/>  --serviceaccount=default:cluster-admin-dashboard-sa<br/><br/># Parse the token<br/>kubectl describe secret $(kubectl -n kube-system get secret | awk '/^cluster-admin-dashboard-sa-token-/{print $1}') | awk '$1=="token:"{print $2}'</span></pre><p id="f8a3" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">使用令牌，现在可以登录到控制面板。但是首先您需要创建一个到Kubernetes主服务器的隧道，因为仪表板仍然在端口8001对本地主机开放。之后，您可以在URL <code class="fe nk nl nm nb b">localhost:8001</code>下访问仪表板。现在，您可以使用您的令牌登录，方法是选择“令牌”并输入它。</p><figure class="mw mx my mz gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi nr"><img src="../Images/704bd2014f2e3ab690daf3361d5d266f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*N_1l8PU7WOfZitCJ.png"/></div></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated">罗伯特·诺依曼拍摄的图片</figcaption></figure><p id="013c" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">现在我们已经准备好使用Kubernetes集群了。本教程展示了在OpenStack云上部署Kubernetes集群是多么容易，以及如何维护它。</p></div></div>    
</body>
</html>