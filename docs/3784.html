<html>
<head>
<title>Enlarge a disk and partition of any Linux VM without a reboot</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">无需重启即可扩大任何Linux虚拟机的磁盘和分区</h1>
<blockquote>原文：<a href="https://itnext.io/enlarge-a-disk-and-partition-of-any-linux-vm-without-a-reboot-fbe0e9b6f23b?source=collection_archive---------5-----------------------#2020-02-24">https://itnext.io/enlarge-a-disk-and-partition-of-any-linux-vm-without-a-reboot-fbe0e9b6f23b?source=collection_archive---------5-----------------------#2020-02-24</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><h1 id="7758" class="jn jo iq bd jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk bi translated">无需重启即可扩大任何Linux虚拟机的磁盘和分区</h1><p id="4ee9" class="pw-post-body-paragraph kl km iq kn b ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">几天前，我们的一位<a class="ae lj" href="https://www.opvizor.com" rel="noopener ugc nofollow" target="_blank">性能分析器</a>客户在一次研讨会上询问我们如何处理数据随时间的增长，以及他们如何调整数据分区的大小。像许多其他客户一样，他们希望确保磁盘不会很快被填满。</p><p id="be85" class="pw-post-body-paragraph kl km iq kn b ko lk kq kr ks ll ku kv kw lm ky kz la ln lc ld le lo lg lh li ij bi translated">另一方面，我们的目标是，客户不需要增加数据磁盘的容量，而我们的自动调整大小功能以一种非常方便的方式解决了这个问题:</p><p id="1dad" class="pw-post-body-paragraph kl km iq kn b ko lk kq kr ks ll ku kv kw lm ky kz la ln lc ld le lo lg lh li ij bi translated"><strong class="kn ir">只需要简单地调整虚拟设备的虚拟磁盘大小，我们设备中的脚本会自动处理其他所有事情。</strong></p><p id="4e86" class="pw-post-body-paragraph kl km iq kn b ko lk kq kr ks ll ku kv kw lm ky kz la ln lc ld le lo lg lh li ij bi translated">这可以在虚拟机使用几乎任何现代linux发行版运行时完成——只要确保没有快照处于活动状态！</p><p id="7696" class="pw-post-body-paragraph kl km iq kn b ko lk kq kr ks ll ku kv kw lm ky kz la ln lc ld le lo lg lh li ij bi translated"><em class="lp">第一次在生产系统上遵循该指南时，我们会推荐备份(没有快照)。</em></p><p id="5b25" class="pw-post-body-paragraph kl km iq kn b ko lk kq kr ks ll ku kv kw lm ky kz la ln lc ld le lo lg lh li ij bi translated">Performance Analyzer足够智能，可以检测到这种变化，并扩大分区和分区中包含的文件系统。</p><p id="d395" class="pw-post-body-paragraph kl km iq kn b ko lk kq kr ks ll ku kv kw lm ky kz la ln lc ld le lo lg lh li ij bi translated">所有这些都在cron作业中完成:</p><ul class=""><li id="4245" class="lq lr iq kn b ko lk ks ll kw ls la lt le lu li lv lw lx ly bi translated">检测引导或数据磁盘的大小</li><li id="590a" class="lq lr iq kn b ko lz ks ma kw mb la mc le md li lv lw lx ly bi translated">调整最后一个分区的大小以添加新空间</li></ul><h1 id="70a1" class="jn jo iq bd jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk bi translated">但这背后的魔力是什么？</h1><p id="14bd" class="pw-post-body-paragraph kl km iq kn b ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">我们没有提到的一件事——<strong class="kn ir">没有LVM一切都完了</strong>！</p><p id="ae59" class="pw-post-body-paragraph kl km iq kn b ko lk kq kr ks ll ku kv kw lm ky kz la ln lc ld le lo lg lh li ij bi translated">让我们进入一些细节:</p><p id="2076" class="pw-post-body-paragraph kl km iq kn b ko lk kq kr ks ll ku kv kw lm ky kz la ln lc ld le lo lg lh li ij bi translated">性能分析器装置具有两个磁盘的配置。第一个磁盘保存操作系统，第二个磁盘保存数据。我们跳过了交换分区，在根文件系统中有一个交换文件。这是可以接受的，因为我们无论如何都要避免交换。</p><p id="6297" class="pw-post-body-paragraph kl km iq kn b ko lk kq kr ks ll ku kv kw lm ky kz la ln lc ld le lo lg lh li ij bi translated">重要的是要知道，只有磁盘中最后或唯一的分区(绿色)可以直接调整大小。<br/>性能分析器的磁盘布局如下所示:</p><figure class="mf mg mh mi gt mj gh gi paragraph-image"><div class="gh gi me"><img src="../Images/4b3b526e7b26fc756eb2984058724fd9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1032/format:webp/0*NyXaEnL3apO4wCib.png"/></div></figure><p id="1562" class="pw-post-body-paragraph kl km iq kn b ko lk kq kr ks ll ku kv kw lm ky kz la ln lc ld le lo lg lh li ij bi translated">如果您想扩大第二个磁盘，只需更改虚拟机配置并增加那里的磁盘。如果该选项呈灰色，请确保删除现有快照。</p><figure class="mf mg mh mi gt mj gh gi paragraph-image"><div role="button" tabindex="0" class="mn mo di mp bf mq"><div class="gh gi mm"><img src="../Images/5a0c706d227439b104a63ecabb692cb6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*8WEBBvG6VKeEqOKh.png"/></div></div></figure><p id="3aa9" class="pw-post-body-paragraph kl km iq kn b ko lk kq kr ks ll ku kv kw lm ky kz la ln lc ld le lo lg lh li ij bi translated">尽管磁盘被调整了大小，但是Linux内核并不知道这种变化。</p><figure class="mf mg mh mi gt mj gh gi paragraph-image"><div role="button" tabindex="0" class="mn mo di mp bf mq"><div class="gh gi mr"><img src="../Images/844c6a911646511f84ad644a846e2750.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*pmsHIAMRzyuSHnqa.png"/></div></div></figure><p id="3f6d" class="pw-post-body-paragraph kl km iq kn b ko lk kq kr ks ll ku kv kw lm ky kz la ln lc ld le lo lg lh li ij bi translated">要让内核知道，可以以root用户身份发出以下命令:</p><pre class="mf mg mh mi gt ms mt mu mv aw mw bi"><span id="400c" class="mx jo iq mt b gy my mz l na nb">echo 1 &gt; /sys/class/block/sdb/device/rescan</span></pre><p id="7556" class="pw-post-body-paragraph kl km iq kn b ko lk kq kr ks ll ku kv kw lm ky kz la ln lc ld le lo lg lh li ij bi translated">这将触发设备sdb的重新扫描。如果您调整了另一个磁盘的大小，请用您更改的磁盘号替换sdb。您可以按照syslog中的过程操作，您应该会看到类似下面的几行:</p><pre class="mf mg mh mi gt ms mt mu mv aw mw bi"><span id="1321" class="mx jo iq mt b gy my mz l na nb">[89741.613318] sd 2:0:1:0: [sdb] 106954752 512-byte logical blocks: (54.8 GB/51.0 GiB) [89741.613393] sdb: detected capacity change from 53687091200 to 54760833024</span></pre><p id="a0b3" class="pw-post-body-paragraph kl km iq kn b ko lk kq kr ks ll ku kv kw lm ky kz la ln lc ld le lo lg lh li ij bi translated">当内核完成重新扫描时(通常在几分之一秒内)，它会意识到更大的磁盘:</p><figure class="mf mg mh mi gt mj gh gi paragraph-image"><div role="button" tabindex="0" class="mn mo di mp bf mq"><div class="gh gi mr"><img src="../Images/99563827dfb0ae267f8917b2f219fc4a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*6gNdy51ve89LxKpG.png"/></div></div></figure><p id="8dee" class="pw-post-body-paragraph kl km iq kn b ko lk kq kr ks ll ku kv kw lm ky kz la ln lc ld le lo lg lh li ij bi translated">分区不会自动调整，还需要分两步调整大小</p><ul class=""><li id="155c" class="lq lr iq kn b ko lk ks ll kw ls la lt le lu li lv lw lx ly bi translated">调整分区大小</li><li id="3ba7" class="lq lr iq kn b ko lz ks ma kw mb la mc le md li lv lw lx ly bi translated">让内核知道更大的分区</li></ul><p id="5af2" class="pw-post-body-paragraph kl km iq kn b ko lk kq kr ks ll ku kv kw lm ky kz la ln lc ld le lo lg lh li ij bi translated">通常，fdisk是第一步的首选工具，而partprobe(或reboot)是第二步的首选工具。但是事情发生了变化，你可以使用一个很棒的软件，叫做<a class="ae lj" href="http://manpages.ubuntu.com/manpages/cosmic/man1/growpart.1.html" rel="noopener ugc nofollow" target="_blank"><strong class="kn ir"><em class="lp"/></strong></a></p><p id="6f7d" class="pw-post-body-paragraph kl km iq kn b ko lk kq kr ks ll ku kv kw lm ky kz la ln lc ld le lo lg lh li ij bi translated">是<strong class="kn ir"> cloud-utils-package </strong>的一部分，应该可以在你的发行版的仓库中获得，以防它还没有安装在你的操作系统中。Debian或Ubuntu:</p><pre class="mf mg mh mi gt ms mt mu mv aw mw bi"><span id="2acc" class="mx jo iq mt b gy my mz l na nb">sudo apt-get install -y cloud-utils</span></pre><p id="9d0d" class="pw-post-body-paragraph kl km iq kn b ko lk kq kr ks ll ku kv kw lm ky kz la ln lc ld le lo lg lh li ij bi translated">使用growpart，将分区扩大到最大大小并通知内核更改后的分区大小是一行代码:</p><pre class="mf mg mh mi gt ms mt mu mv aw mw bi"><span id="fe1b" class="mx jo iq mt b gy my mz l na nb">growpart /dev/sdb 1</span></pre><p id="f932" class="pw-post-body-paragraph kl km iq kn b ko lk kq kr ks ll ku kv kw lm ky kz la ln lc ld le lo lg lh li ij bi translated">第一个参数是磁盘设备，第二个参数是要调整大小的分区的数量。运行growpart后，您的磁盘如下所示:</p><figure class="mf mg mh mi gt mj gh gi paragraph-image"><div role="button" tabindex="0" class="mn mo di mp bf mq"><div class="gh gi mr"><img src="../Images/5e9cd122abc1de8fb25e01c6b49ed0c1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*CbeFO14aboS4ny0h.png"/></div></div></figure><p id="11e7" class="pw-post-body-paragraph kl km iq kn b ko lk kq kr ks ll ku kv kw lm ky kz la ln lc ld le lo lg lh li ij bi translated">现在分区的大小已经调整，内核已经在使用新的分区表了。</p><p id="03df" class="pw-post-body-paragraph kl km iq kn b ko lk kq kr ks ll ku kv kw lm ky kz la ln lc ld le lo lg lh li ij bi translated">最后缺失的部分是文件系统。由于我们在Performance Analyzer中使用Ubuntu上的ext4文件系统，这也是一个单行程序，甚至可以在挂载的文件系统上运行:</p><pre class="mf mg mh mi gt ms mt mu mv aw mw bi"><span id="d013" class="mx jo iq mt b gy my mz l na nb">resize2fs /dev/sdb1</span></pre><p id="9287" class="pw-post-body-paragraph kl km iq kn b ko lk kq kr ks ll ku kv kw lm ky kz la ln lc ld le lo lg lh li ij bi translated">如果您使用任何其他文件系统，您需要检查合适的工具来调整大小。</p><figure class="mf mg mh mi gt mj gh gi paragraph-image"><div role="button" tabindex="0" class="mn mo di mp bf mq"><div class="gh gi mr"><img src="../Images/cf2c0d178558368b30cd93c60f787436.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*nYtpudu3LO2m7Y6h.png"/></div></div></figure><p id="6abd" class="pw-post-body-paragraph kl km iq kn b ko lk kq kr ks ll ku kv kw lm ky kz la ln lc ld le lo lg lh li ij bi translated">就这样，磁盘、分区和文件系统都调整了大小，您可以立即使用新获得的磁盘空间，无需重新启动或使用LVM。</p><h1 id="7b18" class="jn jo iq bd jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk bi translated">将碎片拼在一起</h1><p id="86d5" class="pw-post-body-paragraph kl km iq kn b ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">Opvizor通过创建每5分钟运行一次的cron作业来自动化这一过程。该作业检查性能分析器的一个磁盘的大小是否改变，并调整该磁盘上的分区和文件系统的大小。</p><h1 id="1bcd" class="jn jo iq bd jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk bi translated">/etc/cron . d/size _ disk</h1><p id="39f8" class="pw-post-body-paragraph kl km iq kn b ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">例如，以root用户身份每5分钟运行一次disk_resize脚本，只需将下面一行添加到/etc/cron.d/resize_disk中</p><pre class="mf mg mh mi gt ms mt mu mv aw mw bi"><span id="2439" class="mx jo iq mt b gy my mz l na nb">*/5 * * * * root /usr/local/bin/disk_resize.sh</span></pre><h1 id="6593" class="jn jo iq bd jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk bi translated">disk_resize.sh</h1><p id="9460" class="pw-post-body-paragraph kl km iq kn b ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">脚本/usr/local/bin/disk_resize.sh本身看起来像是:</p><pre class="mf mg mh mi gt ms mt mu mv aw mw bi"><span id="d646" class="mx jo iq mt b gy my mz l na nb">#!/bin/bash<br/>LOGFILE=/data/log/speed/resize.log<br/>LOCKFILE=/tmp/enlarge.lock<br/>export PATH=/usr/sbin:/usr/bin:/sbin:/bin<br/><br/><br/>NEEDREBOOT=0<br/><br/>dotlockfile -r 0 $LOCKFILE || exit 1<br/><br/>echo 1 &gt; /sys/class/block/sda/device/rescan<br/>sleep 5<br/>GROWPART_OUT=`growpart /dev/sda 2`<br/>if [ $? -eq 0 ]; then<br/>    echo `date` &gt;&gt; $LOGFILE<br/>    echo "trying to resize fs" &gt;&gt; $LOGFILE<br/>    echo $GROWPART_OUT &gt;&gt; $LOGFILE<br/>    resize2fs /dev/sda2 &gt;&gt; $LOGFILE 2&gt;&amp;1<br/>    echo `date` &gt;&gt; $LOGFILE<br/>    echo "resize done" &gt;&gt; $LOGFILE<br/>    #TODO: need reboot<br/>    NEEDREBOOT=1<br/>fi<br/><br/>echo 1 2&gt;/dev/null &gt;/sys/class/block/sdb/device/rescan<br/>sleep 5<br/>GROWPART_OUT=`growpart /dev/sdb 1`<br/>if [ $? -eq 0 ]; then<br/>    echo `date` &gt;&gt; $LOGFILE<br/>    echo "trying to resize fs" &gt;&gt; $LOGFILE<br/>    echo $GROWPART_OUT &gt;&gt; $LOGFILE<br/>    resize2fs /dev/sdb1 &gt;&gt; $LOGFILE 2&gt;&amp;1<br/>    echo `date` &gt;&gt; $LOGFILE<br/>    echo "resize done" &gt;&gt; $LOGFILE<br/>    #TODO: need reboot<br/>    NEEDREBOOT=1<br/>fi<br/><br/>dotlockfile -u $LOCKFILE<br/><br/>if [ $NEEDREBOOT -eq "1" ]; then<br/>    /sbin/reboot<br/>fi</span></pre></div><div class="ab cl nc nd hu ne" role="separator"><span class="nf bw bk ng nh ni"/><span class="nf bw bk ng nh ni"/><span class="nf bw bk ng nh"/></div><div class="ij ik il im in"><p id="960f" class="pw-post-body-paragraph kl km iq kn b ko lk kq kr ks ll ku kv kw lm ky kz la ln lc ld le lo lg lh li ij bi translated"><em class="lp">原载于2020年2月24日https://www.opvizor.com</em><a class="ae lj" href="https://www.opvizor.com/enlarge-a-disk-and-partition-of-any-linux-vm-without-a-reboot" rel="noopener ugc nofollow" target="_blank"><em class="lp"/></a><em class="lp">。</em></p></div></div>    
</body>
</html>