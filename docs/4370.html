<html>
<head>
<title>How Gcloud’s billing issue caused a business shutdown for one day</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Gcloud的计费问题如何导致一天的业务关闭</h1>
<blockquote>原文：<a href="https://itnext.io/how-gclouds-billing-issue-caused-a-business-shutdown-for-one-day-948962ecc50e?source=collection_archive---------0-----------------------#2020-06-18">https://itnext.io/how-gclouds-billing-issue-caused-a-business-shutdown-for-one-day-948962ecc50e?source=collection_archive---------0-----------------------#2020-06-18</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="ea00" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">解决方案多云？我们从那次经历中学到了什么</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/e537d2e3effbf0e5dd1fb2ff7ab48490.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*bDyo5KEbxgZVaudy-xiErg.jpeg"/></div></div></figure><p id="a1cf" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated"><strong class="kw iu">2020年12月12日更新</strong>经过多月，自5月以来，这一问题终于得到解决，错误入账的款项已归还。我们由此了解了GCP计费的详细情况，这样我们就可以直接告诉支持人员这个问题。还要创建GCP开单预警。我们还为GCP使用了一个完全独立的银行账户，这样账单错误就不会造成完全的金钱损失。我们也正在迁移多云，以便至少有一个后备方案。不管怎样，很高兴这一切都结束了。</p><p id="606c" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated"><strong class="kw iu">2020年9月9日更新</strong>谷歌承诺偿还他们错误的账单金额，但至今仍未兑现。自4月以来，我们每周都与支持部门联系，以收回资金。非常可悲的是谷歌并不急于解决这个问题。</p><p id="abcf" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">平台是<a class="ae lq" href="https://killer.sh" rel="noopener ugc nofollow" target="_blank"> killer.sh </a>，一个针对Kubernetes CKA和CKAD认证的模拟器。在参加真正的认证之前，用户可以在这里测试他们的知识。</p><p id="42c6" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">CKA和CKAD认证是动手实践考试。与会者可以进入一个环境，在这个环境中，<code class="fe lr ls lt lu b">kubectl</code>必须用于与多个k8s集群进行交互并解决各种任务。</p><h1 id="df2a" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">黑仔简单地说</h1><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi mn"><img src="../Images/794448b45a065869280d24c361e9c37d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*tBMLUXQwGqQQQonpuYzG_Q.png"/></div></div></figure><p id="5ab0" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">每个用户都可以访问浏览器终端。这个浏览器终端提供了对一个环境的访问，该环境中有各种其他虚拟机和Kubernetes集群。</p><p id="e539" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">这些环境是GCP计算实例，可能非常大，最高可达30CPU和30GB内存。因此，只要不使用，我们就暂停这些实例。我们使用这个API方法来挂起计算实例。</p><h1 id="ae45" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">该事件</h1><h2 id="a88d" class="mo lw it bd lx mp mq dn mb mr ms dp mf ld mt mu mh lh mv mw mj ll mx my ml mz bi translated">发生了什么事？</h2><p id="0e0f" class="pw-post-body-paragraph ku kv it kw b kx na ju kz la nb jx lc ld nc lf lg lh nd lj lk ll ne ln lo lp im bi translated">几周前，我们注意到Gcloud突然每天都向<strong class="kw iu">收费，而我们通常每两个月才支付<strong class="kw iu">一次。</strong>我们的应用、行为或用户数量没有变化。所以我们联系了Gcloud计费支持。</strong></p><h2 id="37f7" class="mo lw it bd lx mp mq dn mb mr ms dp mf ld mt mu mh lh mv mw mj ll mx my ml mz bi translated">一级Gcloud支持响应</h2><p id="2880" class="pw-post-body-paragraph ku kv it kw b kx na ju kz la nb jx lc ld nc lf lg lh nd lj lk ll ne ln lo lp im bi translated">我们通过聊天联系了Gcloud计费支持，这很快，但遗憾的是非常低效。我们说，我们没有改变任何东西，但突然每天支付我们原本每两个月才支付的费用。</p><p id="5be6" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">支持者进行了调查，前后花了两个小时讨论这个问题。然后他们说一切都很正常，很好，我们只是突然用了这么多。他们就如何理解Gcloud计费系统给了我们一些提示。</p><h2 id="9ead" class="mo lw it bd lx mp mq dn mb mr ms dp mf ld mt mu mh lh mv mw mj ll mx my ml mz bi translated">接下来我们做了什么？</h2><p id="df33" class="pw-post-body-paragraph ku kv it kw b kx na ju kz la nb jx lc ld nc lf lg lh nd lj lk ll ne ln lo lp im bi translated">我们确实<strong class="kw iu">关闭了<a class="ae lq" href="https://killer.sh" rel="noopener ugc nofollow" target="_blank"> https://killer.sh </a>的完整平台</strong>。</p><p id="7623" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">因为我们认为我们对成本做了疯狂的错误计算，这是我们的错误。也许有一些我们从未见过的隐藏的指控。如果问题仅仅是某个Gcloud服务(如compute)关闭了，至少我们知道这不是我们的错，并且它可能会在某个时间被修复。但不是这个问题。</p><p id="3f71" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">在与支持人员聊了几个小时后，我们得出结论，这肯定是我们的错，我们需要花大量的时间来调查此事。这意味着我们必须终止所有正在运行的用户会话(计算虚拟机),并阻止新用户付费、注册和使用平台。因为我们每跑一个小时就会损失很多钱。</p><h2 id="47b7" class="mo lw it bd lx mp mq dn mb mr ms dp mf ld mt mu mh lh mv mw mj ll mx my ml mz bi translated">我们在进一步调查中发现了什么？</h2><p id="70dc" class="pw-post-body-paragraph ku kv it kw b kx na ju kz la nb jx lc ld nc lf lg lh nd lj lk ll ne ln lo lp im bi translated">关机后，我们确实深入挖掘了Gcloud的计费数据。我们使用了:</p><ul class=""><li id="d2f0" class="nf ng it kw b kx ky la lb ld nh lh ni ll nj lp nk nl nm nn bi translated">账单/交易(详细列出每笔小额费用)</li><li id="6f6f" class="nf ng it kw b kx no la np ld nq lh nr ll ns lp nk nl nm nn bi translated">计费/计费导出(能够对所有费用使用SQL查询)</li></ul><p id="6626" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">我们发现基本上是这样的:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nt"><img src="../Images/c2930b11d8e499478f58b9182c968146.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*DYsBPYIf8yYitwzbxM33xA.png"/></div></div><figcaption class="nu nv gj gh gi nw nx bd b be z dk translated">苏黎世的悬浮内存</figcaption></figure><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ny"><img src="../Images/fbc7f2f41790aa2949de1b7f715b2b37.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Xr57OhDB1-eosfwZsIa96g.png"/></div></div><figcaption class="nu nv gj gh gi nw nx bd b be z dk translated">苏黎世在用RAM</figcaption></figure><p id="ad11" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">你可以看到悬挂内存比使用中的内存贵得离谱。没道理？没道理啊！</p><h2 id="e229" class="mo lw it bd lx mp mq dn mb mr ms dp mf ld mt mu mh lh mv mw mj ll mx my ml mz bi translated">第一级支持对调查结果有什么看法？</h2><p id="29f1" class="pw-post-body-paragraph ku kv it kw b kx na ju kz la nb jx lc ld nc lf lg lh nd lj lk ll ne ln lo lp im bi translated">我们带着我们的发现回到了Gcloud Billing Support，之后他们将此问题上报给了一个特殊团队(我们称他们为二级支持)。</p><p id="64ec" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">我们被告知他们会在24小时内回复。他们确实在3天后做出了回应。</p><h2 id="a3fb" class="mo lw it bd lx mp mq dn mb mr ms dp mf ld mt mu mh lh mv mw mj ll mx my ml mz bi translated">我们的临时解决方案</h2><p id="1148" class="pw-post-body-paragraph ku kv it kw b kx na ju kz la nb jx lc ld nc lf lg lh nd lj lk ll ne ln lo lp im bi translated">因为我们(自己)发现挂起的RAM突然完全定价过高，所以我们简单地禁用了虚拟机的挂起，并再次启用了对我们平台的访问。这意味着用户能够再次使用他们的Kubernetes CKA/CKAD模拟器会议。</p><p id="f1da" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated"><strong class="kw iu">但这样做我们实际上损失了金钱</strong>，因为我们无法在用户不使用虚拟机时暂停它们。</p><h2 id="2dfd" class="mo lw it bd lx mp mq dn mb mr ms dp mf ld mt mu mh lh mv mw mj ll mx my ml mz bi translated">二级Gcloud支持给了我们什么回应？</h2><p id="52f2" class="pw-post-body-paragraph ku kv it kw b kx na ju kz la nb jx lc ld nc lf lg lh nd lj lk ll ne ln lo lp im bi translated">3天后支持人员回来说是Gcloud的错。他们会:</p><ol class=""><li id="5c85" class="nf ng it kw b kx ky la lb ld nh lh ni ll nj lp nz nl nm nn bi translated">偿还他们错误记账的钱</li><li id="d261" class="nf ng it kw b kx no la np ld nq lh nr ll ns lp nz nl nm nn bi translated">除此之外，用同样的金额补偿我们的麻烦，以及开发时间和虚拟机使用方面的更多成本</li><li id="9698" class="nf ng it kw b kx no la np ld nq lh nr ll ns lp nz nl nm nn bi translated">告诉我们(在我们提出要求后),暂停RAM的价格现已恢复正常</li><li id="4797" class="nf ng it kw b kx no la np ld nq lh nr ll ns lp nz nl nm nn bi translated">请(在我们请求后)给我们发送一份包含错误费用概述的CSV</li></ol><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi oa"><img src="../Images/a165743b371af4a5b7296aedb9baacc6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*LPfDGkBgh1KzhBQdTBpPDw.png"/></div></div><figcaption class="nu nv gj gh gi nw nx bd b be z dk translated">显示挂起内存的正确和错误价格</figcaption></figure><p id="9d3a" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">所以如果我的计算没错，对于苏黎士，<strong class="kw iu"> Gcloud突然多充了730倍</strong>。</p><h2 id="b2a6" class="mo lw it bd lx mp mq dn mb mr ms dp mf ld mt mu mh lh mv mw mj ll mx my ml mz bi translated">现在是什么情况？</h2><p id="a6fc" class="pw-post-body-paragraph ku kv it kw b kx na ju kz la nb jx lc ld nc lf lg lh nd lj lk ll ne ln lo lp im bi translated">一切都恢复正常，我们可以再次使用暂停功能。但我们现在每天都在监控账单报告，并彻底检查每一份寄出的账单。</p><p id="7fc9" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">我想知道如果这次加注不那么疯狂，可能只是翻倍，会发生什么？我们可能没有注意到这一点，并会支付更多…</p><h1 id="bb3e" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">防止这种情况的解决方案是什么？</h1><ol class=""><li id="4220" class="nf ng it kw b kx na la nb ld ob lh oc ll od lp nz nl nm nn bi translated">甚至在事故发生之前就深入了解您的账单</li><li id="b27e" class="nf ng it kw b kx no la np ld nq lh nr ll ns lp nz nl nm nn bi translated">向您的Gcloud计算实例添加标签，以便您可以在计费导出SQL查询中跟踪这些实例</li><li id="ecfe" class="nf ng it kw b kx no la np ld nq lh nr ll ns lp nz nl nm nn bi translated">设置计费预算和警报，以便您知道何时发生异常计费</li><li id="acf0" class="nf ng it kw b kx no la np ld nq lh nr ll ns lp nz nl nm nn bi translated">能够告诉第一级Gcloud计费支持到底是什么问题，因为他们可能没有受过这方面的培训</li></ol><h2 id="2747" class="mo lw it bd lx mp mq dn mb mr ms dp mf ld mt mu mh lh mv mw mj ll mx my ml mz bi translated">多云</h2><p id="4bc0" class="pw-post-body-paragraph ku kv it kw b kx na ju kz la nb jx lc ld nc lf lg lh nd lj lk ll ne ln lo lp im bi translated">在我看来，唯一真正的解决方案是走向多云。如果发生这种情况，能够将你提供的每项服务从一个云提供商转移到另一个云提供商将会给你带来极大的灵活性。此外，如果发生与计费无关的云提供商正常停机。</p><p id="20b3" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">但是迁移到多云平台很难，需要更多的时间，而且对于小型平台来说可能不可行。</p><h1 id="2d5c" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">结论</h1><p id="de48" class="pw-post-body-paragraph ku kv it kw b kx na ju kz la nb jx lc ld nc lf lg lh nd lj lk ll ne ln lo lp im bi translated">我不得不说，我总体上非常喜欢Gcloud，并建议人们和公司使用它。它非常好用，而且比AWS等更容易使用。但是这件事真的让我对GCP失去了很大的信心。</p><p id="c5d3" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">支持人员花了3天时间才得到结果，这仅仅是因为我们做了深入调查并发现了实际问题。但是GCP赔偿了我们错误的账单金额，此外还赔偿了一些损失。</p><p id="4ddc" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">这绝对是一个令人伤脑筋的问题，我们真的想防止再次发生。</p></div></div>    
</body>
</html>