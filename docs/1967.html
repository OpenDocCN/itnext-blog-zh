<html>
<head>
<title>Geocoding using Mapbox, Rails 5 and NuxtJS/VueJS</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Mapbox、Rails 5和NuxtJS/VueJS进行地理编码</h1>
<blockquote>原文：<a href="https://itnext.io/geocoding-using-mapbox-rails-5-and-nuxtjs-vuejs-68d2c74f75f9?source=collection_archive---------5-----------------------#2019-03-04">https://itnext.io/geocoding-using-mapbox-rails-5-and-nuxtjs-vuejs-68d2c74f75f9?source=collection_archive---------5-----------------------#2019-03-04</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="1faa" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">地理编码是取经纬度确定地址，或者取地址产生经纬度坐标的过程。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi kl"><img src="../Images/05b6d58bd7be8e719e70da6dcd00025e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*sX0vjLfOEVj62X1TDW5M_g.png"/></div></div></figure><p id="6be0" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">应用程序需要使用地理编码器有很多原因。对于现在为服务的<a class="ae kx" href="http://nowserving.us" rel="noopener ugc nofollow" target="_blank">，我们在注册过程中使用它，并且只需点击“查找我”就可以轻松找到附近的餐馆。</a></p><p id="323b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">让我们开始编码吧！</p><h2 id="61df" class="ky kz iq bd la lb lc dn ld le lf dp lg jy lh li lj kc lk ll lm kg ln lo lp lq bi translated">Rails API</h2><p id="12c7" class="pw-post-body-paragraph jn jo iq jp b jq lr js jt ju ls jw jx jy lt ka kb kc lu ke kf kg lv ki kj kk ij bi translated">我们需要获取<code class="fe lw lx ly lz b">mapbox-sdk</code>并将其添加到gem文件中。</p><pre class="km kn ko kp gt ma lz mb mc aw md bi"><span id="6132" class="ky kz iq lz b gy me mf l mg mh"><em class="mi">gem </em><strong class="lz ir">'mapbox-sdk'</strong>, <strong class="lz ir">'~&gt;2'</strong></span></pre><p id="8719" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">创建一个简单的初始化器来设置应用程序中的访问令牌(例如<code class="fe lw lx ly lz b">config/initializers/mapbox.rb</code></p><pre class="km kn ko kp gt ma lz mb mc aw md bi"><span id="b0a7" class="ky kz iq lz b gy me mf l mg mh"><strong class="lz ir"><em class="mi">Mapbox</em></strong>.access_token = MAPBOX_ACCESS_TOKEN</span></pre><p id="f6a9" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">接下来，让我们添加几条路线:</p><pre class="km kn ko kp gt ma lz mb mc aw md bi"><span id="c5f4" class="ky kz iq lz b gy me mf l mg mh"><em class="mi">namespace </em><strong class="lz ir">:address_search do<br/>  </strong><em class="mi">get </em><strong class="lz ir">'expand'</strong>, <strong class="lz ir">to</strong>: <strong class="lz ir">'expand'<br/>  </strong><em class="mi">get </em><strong class="lz ir">'parse'</strong>, <strong class="lz ir">to</strong>: <strong class="lz ir">'parse'<br/>end</strong></span></pre><p id="a563" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">还有一个<code class="fe lw lx ly lz b">address_search_controller.rb</code>:</p><pre class="km kn ko kp gt ma lz mb mc aw md bi"><span id="c9d2" class="ky kz iq lz b gy me mf l mg mh"><strong class="lz ir">class <em class="mi">AddressSearchController </em></strong>&lt; <strong class="lz ir"><em class="mi">ApplicationController</em><br/><br/>  </strong><em class="mi"># Take an addresss and return lat/lng<br/>  </em><strong class="lz ir">def </strong><em class="mi">expand<br/>    </em><strong class="lz ir">begin<br/>      @addresses </strong>= <strong class="lz ir"><em class="mi">Mapbox</em></strong>::<strong class="lz ir"><em class="mi">Geocoder</em></strong>.geocode_forward(address_params[<strong class="lz ir">:a</strong>]) <strong class="lz ir">unless </strong>address_params[<strong class="lz ir">:a</strong>].nil?<br/>      <em class="mi">render </em><strong class="lz ir">template</strong>: <strong class="lz ir">'address_search/result'<br/>    rescue <em class="mi">StandardError<br/>      </em></strong><em class="mi">render </em><strong class="lz ir">json</strong>: { <strong class="lz ir">errors</strong>: [<strong class="lz ir">'Unable to perform forward geocoding'</strong>] }<br/>    <strong class="lz ir">end<br/>  end<br/><br/>  </strong><em class="mi"># Take lat/lng array and return a postal address<br/>  </em><strong class="lz ir">def </strong><em class="mi">parse<br/>    </em><strong class="lz ir">begin<br/>      @location </strong>= { <strong class="lz ir">latitude</strong>: <em class="mi">address_params</em>[<strong class="lz ir">:latitude</strong>].to_f, <strong class="lz ir">longitude</strong>: <em class="mi">address_params</em>[<strong class="lz ir">:longitude</strong>].to_f }<br/>      <strong class="lz ir">@addresses </strong>= <strong class="lz ir"><em class="mi">Mapbox</em></strong>::<strong class="lz ir"><em class="mi">Geocoder</em></strong>.geocode_reverse(<strong class="lz ir">@location</strong>)<br/>      <em class="mi">render </em><strong class="lz ir">template</strong>: <strong class="lz ir">'address_search/result'<br/>    rescue <em class="mi">StandardError<br/>      </em></strong><em class="mi">render </em><strong class="lz ir">json</strong>: { <strong class="lz ir">errors</strong>: [<strong class="lz ir">'Unable to perform reverse geocoding'</strong>] }<br/>    <strong class="lz ir">end<br/>  end<br/><br/>  </strong><em class="mi">private<br/><br/>  </em><strong class="lz ir">def </strong><em class="mi">address_params<br/>    </em>params.permit(<strong class="lz ir">:a</strong>, <strong class="lz ir">:latitude, :longitude</strong>)<br/>  <strong class="lz ir">end<br/>end</strong></span></pre><p id="0d25" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">expand方法使用<code class="fe lw lx ly lz b">a</code>查询参数，并要求地理编码器服务返回一个纬度/经度数组。对于从lat/lng获取地址，我们期待类似<code class="fe lw lx ly lz b">{ latitude: 0, longitude: 0 }</code>的散列。</p><p id="2fd4" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">您可能不希望在这里呈现模板，但在我的例子中，我希望总是返回一个数组，因此确保这一点的最佳方式是使用jbuilder一行程序来呈现它:</p><pre class="km kn ko kp gt ma lz mb mc aw md bi"><span id="cf59" class="ky kz iq lz b gy me mf l mg mh">json.array! <strong class="lz ir">@addresses</strong></span></pre><p id="785b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">和一个请求规范:</p><pre class="km kn ko kp gt ma lz mb mc aw md bi"><span id="c70b" class="ky kz iq lz b gy me mf l mg mh"><strong class="lz ir"><em class="mi">RSpec</em></strong>.<em class="mi">describe </em><strong class="lz ir">'Address Search' do</strong><br/><br/>  <em class="mi">it </em><strong class="lz ir">'parses an address and returns latitude and longitude' do<br/>    </strong><em class="mi">get </em><strong class="lz ir">'/api/v1/address_search/expand'</strong>, <strong class="lz ir">params</strong>: { <strong class="lz ir">a</strong>: <strong class="lz ir">'401 B St, San Diego CA' </strong>}<br/>    expect(response).to be_successful<br/>  <strong class="lz ir">end<br/><br/>  </strong><em class="mi">it </em><strong class="lz ir">'parses latitude and longitude and returns an address' do<br/>    </strong><em class="mi">get </em><strong class="lz ir">'/api/v1/address_search/parse'</strong>, <strong class="lz ir">params</strong>: { <strong class="lz ir">longitude</strong>: 127.0, <strong class="lz ir">latitude</strong>: -43.64}<br/>    expect(response).to be_successful<br/>  <strong class="lz ir">end<br/>end</strong></span></pre><h2 id="ee84" class="ky kz iq bd la lb lc dn ld le lf dp lg jy lh li lj kc lk ll lm kg ln lo lp lq bi translated">前端</h2><p id="a74c" class="pw-post-body-paragraph jn jo iq jp b jq lr js jt ju ls jw jx jy lt ka kb kc lu ke kf kg lv ki kj kk ij bi translated">我们正在为我们的UI使用令人敬畏的NuxtJS框架。如果你以前没用过，一定要看看。如果不会用，也不用担心；这段代码没有Nuxt也能很好地工作。</p><p id="e817" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们使用Vuex动作来调用我们的后端，所以我们有一个存储我们的Mapbox配置。</p><pre class="km kn ko kp gt ma lz mb mc aw md bi"><span id="136c" class="ky kz iq lz b gy me mf l mg mh"><strong class="lz ir">export const </strong>actions = {<br/>  locate({ commit }, { longitude, latitude }) {<br/>    <strong class="lz ir">return this</strong>.<strong class="lz ir">$axios</strong>.get(<strong class="lz ir">'/address_search/parse'</strong>, { <strong class="lz ir">params</strong>: { <strong class="lz ir">longitude</strong>: longitude, <strong class="lz ir">latitude</strong>: latitude } })<br/>  },<br/>  coordinate({ commit }, params) {<br/>    <strong class="lz ir">return this</strong>.<strong class="lz ir">$axios</strong>.get(<strong class="lz ir">'/address_search/expand'</strong>, { <strong class="lz ir">params</strong>: { <strong class="lz ir">a</strong>: params } })<br/>  }<br/>}</span></pre><p id="e195" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">为了演示，我们使用<code class="fe lw lx ly lz b">vue-i18n, vue-notify, bootstrap-vue</code>和<code class="fe lw lx ly lz b">vue-fontawesome</code>。</p><pre class="km kn ko kp gt ma lz mb mc aw md bi"><span id="a9a1" class="ky kz iq lz b gy me mf l mg mh">&lt;<strong class="lz ir">template</strong>&gt;<br/>  &lt;<strong class="lz ir">b-btn<br/>    v-b-tooltip.hover="</strong>true<strong class="lz ir">"<br/>    :data-state="state"<br/>    :variant="</strong>btnVariant<strong class="lz ir">"<br/>    :title="locationLabel"<br/>    type="button"<br/>    @click="</strong>findMe<strong class="lz ir">"</strong>&gt;<br/>    &lt;<strong class="lz ir">font-awesome-icon v-if="state</strong> === 1<strong class="lz ir">" :icon="</strong>['far', 'spinner']<strong class="lz ir">" spin </strong>/&gt;<br/>    &lt;<strong class="lz ir">font-awesome-icon v-else :icon="</strong>['far', 'location-arrow']<strong class="lz ir">" </strong>/&gt;<br/>  &lt;/<strong class="lz ir">b-btn</strong>&gt;<br/>&lt;/<strong class="lz ir">template</strong>&gt;<br/>&lt;<strong class="lz ir">script</strong>&gt;<br/><strong class="lz ir">import </strong>{ FontAwesomeIcon } <strong class="lz ir">from '@fortawesome/vue-fontawesome'<br/><br/>export default </strong>{<br/>  <strong class="lz ir">components</strong>: {<br/>    FontAwesomeIcon<br/>  },<br/>  <strong class="lz ir">props</strong>: {<br/>    <strong class="lz ir">locationLabel</strong>: {<br/>      <strong class="lz ir">default</strong>: <strong class="lz ir">'Find my current location'</strong>,<br/>      <strong class="lz ir">type</strong>: <strong class="lz ir"><em class="mi">String<br/>    </em></strong>}<br/>  },<br/>  data() {<br/>    <strong class="lz ir">return </strong>{<br/>      <strong class="lz ir">state</strong>: 0<strong class="lz ir"><br/>    </strong>}<br/>  },<br/>  <strong class="lz ir">computed</strong>: {<br/>    btnVariant() {<br/>      <strong class="lz ir">switch </strong>(<strong class="lz ir">this</strong>.<strong class="lz ir">state</strong>) {<br/>        <strong class="lz ir">case </strong>0:<br/>          <strong class="lz ir">return 'outline-primary'<br/>        case </strong>1:<br/>          <strong class="lz ir">return 'info'<br/>        case </strong>2:<br/>          <strong class="lz ir">return 'success'<br/>        default</strong>:<br/>          <strong class="lz ir">return 'outline-primary'<br/>      </strong>}<br/>    }<br/>  },<br/>  <strong class="lz ir">methods</strong>: {<br/>    findMe() {<br/>      <strong class="lz ir">const </strong>vm = <strong class="lz ir">this<br/>      this</strong>.<strong class="lz ir">state </strong>= 1<br/>      <strong class="lz ir">if </strong>(!<strong class="lz ir"><em class="mi">navigator</em></strong>.<strong class="lz ir">geolocation</strong>) {<br/>        vm.<strong class="lz ir">$notify</strong>({ <strong class="lz ir">text</strong>: vm.<strong class="lz ir">$t</strong>(<strong class="lz ir">'geolocation.not_supported'</strong>), <strong class="lz ir">group</strong>: <strong class="lz ir">'alerts' </strong>})<br/>        <strong class="lz ir">return<br/>      </strong>}<br/><br/>      <strong class="lz ir">function </strong><em class="mi">success</em>(position) {<br/>        <strong class="lz ir">const </strong>accuracy = position.<strong class="lz ir">coords</strong>.<strong class="lz ir">accuracy<br/>        </strong>vm.<strong class="lz ir">$store</strong>.<strong class="lz ir">dispatch</strong>(<strong class="lz ir">'mapbox/locate'</strong>, {<br/>          <strong class="lz ir">latitude</strong>: position.<strong class="lz ir">coords</strong>.<strong class="lz ir">latitude</strong>,<br/>          <strong class="lz ir">longitude</strong>: position.<strong class="lz ir">coords</strong>.<strong class="lz ir">longitude</strong>,<br/>          <strong class="lz ir">accuracy</strong>: accuracy<br/>        })<br/>          .then((resp) =&gt; {<strong class="lz ir"><br/>            </strong>vm.<strong class="lz ir">state </strong>= 2<br/>            vm.$emit(<strong class="lz ir">'result'</strong>, { <strong class="lz ir">name</strong>: resp.<strong class="lz ir">data</strong>[0].<strong class="lz ir">features</strong>[0].place_name, <strong class="lz ir">center</strong>: resp.<strong class="lz ir">data</strong>[0].<strong class="lz ir">features</strong>[0].<strong class="lz ir">center </strong>})<br/>          })<br/>          .catch(() =&gt; {<br/>            vm.<strong class="lz ir">state </strong>= 0<br/>            vm.<strong class="lz ir">$notify</strong>({ <strong class="lz ir">text</strong>: vm.<strong class="lz ir">$t</strong>(<strong class="lz ir">'geolocation.not_found'</strong>), <strong class="lz ir">type</strong>: <strong class="lz ir">'warning'</strong>, <strong class="lz ir">group</strong>: <strong class="lz ir">'alerts' </strong>})<br/>          })<br/>      }<br/><br/>      <strong class="lz ir">function </strong><em class="mi">error</em>() {<br/>        vm.<strong class="lz ir">$notify</strong>({ <strong class="lz ir">text</strong>: vm.<strong class="lz ir">$t</strong>(<strong class="lz ir">'geolocation.not_found'</strong>), <strong class="lz ir">group</strong>: <strong class="lz ir">'alerts'</strong>, <strong class="lz ir">type</strong>: <strong class="lz ir">'warning' </strong>})<br/>      }<br/><br/>      <strong class="lz ir"><em class="mi">navigator</em></strong>.<strong class="lz ir">geolocation</strong>.getCurrentPosition(<em class="mi">success</em>, <em class="mi">error</em>)<br/>    }<br/>  }<br/>}<br/>&lt;/<strong class="lz ir">script</strong>&gt;</span></pre><p id="27dd" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这里发生了很多事情，所以让我们把它们都分解一下。</p><p id="2423" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">位置按钮有三种状态；默认状态、活动状态和成功状态。computed属性处理每个状态的css类的更改。</p><p id="af65" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">悬停时还会显示一个工具提示，说明浏览器将请求允许向后端发送位置信息。</p><p id="509f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">点击时调用<code class="fe lw lx ly lz b">findMe</code>方法。其中我们有两个成功和错误的回调，浏览器内置的<code class="fe lw lx ly lz b"><a class="ae kx" href="https://developer.mozilla.org/en-US/docs/Web/API/Geolocation/getCurrentPosition" rel="noopener ugc nofollow" target="_blank">getCurrentPosition</a></code>需要正确工作。当浏览器向<code class="fe lw lx ly lz b">success</code>回调函数提供纬度和经度时，我们可以使用Vuex动作将其发送到后端。一旦后端响应到来，组件就会发出一个包含地址名称和坐标的结果事件。如果权限被拒绝，我们会显示一个错误通知。如果浏览器不支持定位服务，我们也会通知用户。</p><h2 id="899c" class="ky kz iq bd la lb lc dn ld le lf dp lg jy lh li lj kc lk ll lm kg ln lo lp lq bi translated">结论</h2><p id="5e0f" class="pw-post-body-paragraph jn jo iq jp b jq lr js jt ju ls jw jx jy lt ka kb kc lu ke kf kg lv ki kj kk ij bi translated">恭喜你有了一个完全实现的正向和反向地理编码解决方案的API！</p></div></div>    
</body>
</html>