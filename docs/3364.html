<html>
<head>
<title>Vertx cluster on ECS</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">ECS上的Vertx集群</h1>
<blockquote>原文：<a href="https://itnext.io/vertx-cluster-on-ecs-9b05eae5816c?source=collection_archive---------4-----------------------#2019-11-28">https://itnext.io/vertx-cluster-on-ecs-9b05eae5816c?source=collection_archive---------4-----------------------#2019-11-28</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><figure class="is it gp gr iu iv gh gi paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="gh gi ir"><img src="../Images/39d70a9249c63c1af62f98a8f93d5563.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*O6MmAkiWsqAKgw-D5fjSjg.jpeg"/></div></div></figure><div class=""/><p id="119e" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">Vertx是一个用于高负载应用的异步框架，它使用Netty、新的I/O和事件总线。Vertx设计用于微服务，许多vertx实例可以在一个集群中运行，以实现高可用性。</p><p id="0098" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">ECS是一个面向docker的AWS服务，它比Kubernetes简单得多，允许在集群中运行docker容器。</p><p id="afb4" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">这里我们将创建一个Vertx集群，它将在ECS集群中运行，使用ECS集群和服务名称进行节点发现。</p><p id="6de2" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">我们的应用程序将由三个<code class="fe kz la lb lc b">verticles</code>(类似于<code class="fe kz la lb lc b">akka</code>中的<code class="fe kz la lb lc b">Actor </code>)—<code class="fe kz la lb lc b"> HttpVerticle</code>组成，它们监听HTTP“健康检查”请求，并使用事件总线向另外两个垂直领域发送消息。消息内容将是包含IP地址的字符串，因此通过打印我们的“本地”IP地址和接收到的消息内容，我们可以看到消息是由另一个集群成员发送的。</p><p id="402e" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">让我们开始，我们将使用Kotlin:</p><figure class="ld le lf lg gt iv"><div class="bz fp l di"><div class="lh li l"/></div></figure><figure class="ld le lf lg gt iv"><div class="bz fp l di"><div class="lh li l"/></div></figure><p id="f061" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">现在，棘手的部分——创建一个Vertx集群并向AWS询问当前IP。<br/>接收IP的代码使用的是仅在ECS中工作的<a class="ae lj" href="http://169.254.170.2/v2/metadata" rel="noopener ugc nofollow" target="_blank">http://169 . 254 . 170 . 2/v2/metadata</a>端点<a class="ae lj" href="https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/ec2-instance-metadata.html" rel="noopener ugc nofollow" target="_blank">。<br/>对于Vertx集群，我们使用hazelcast作为集群管理器</a></p><figure class="ld le lf lg gt iv"><div class="bz fp l di"><div class="lh li l"/></div></figure><p id="c44f" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">对于ECS中的hazelcast集群发现，我们将使用这个<a class="ae lj" href="https://github.com/lightspeed-hospitality/hazelcast-aws-ecs" rel="noopener ugc nofollow" target="_blank">库</a>。这个库似乎没有太多的支持，它仍然在版本<code class="fe kz la lb lc b">1.0-SNAPSHOT</code>中，但是它在做它的工作。你不能在公共的maven库中找到它，所以你需要自己编译它</p><p id="975e" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">ecs-cluster.xml:</p><figure class="ld le lf lg gt iv"><div class="bz fp l di"><div class="lh li l"/></div></figure><p id="cf0a" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated"><strong class="kd jf">替换示例XML文件中的集群和服务名称</strong></p><p id="1d5a" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">在这个文件中有一个对<code class="fe kz la lb lc b">“com.ikentoo.hazelcast.AwsEcsDiscoveryStrategy”</code>的引用，它必须在类路径中。</p><p id="02e8" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">现在您需要构建您的docker映像并将其发布到您的Docker注册中心。<br/> Dockerfile:</p><figure class="ld le lf lg gt iv"><div class="bz fp l di"><div class="lh li l"/></div></figure><p id="3021" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">现在—重要的部分—创建一个<a class="ae lj" href="https://medium.com/boltops/gentle-introduction-to-how-aws-ecs-works-with-example-tutorial-cea3d27ce63d" rel="noopener"> ECS任务定义和服务</a>。至少在两个实例中运行此服务，以查看它们如何相互通信。</p><p id="c1cf" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">这个过程在本文中<a class="ae lj" href="https://medium.com/boltops/gentle-introduction-to-how-aws-ecs-works-with-example-tutorial-cea3d27ce63d" rel="noopener">有很好的描述，但是要注意以下几点:<br/> 1。您应该为ECS任务分配一个AIM角色，它包含<code class="fe kz la lb lc b">ecs:ListTasks</code>和<code class="fe kz la lb lc b">ecs:DescribeTasks</code>权限<br/> 2。请小心执行运行状况检查任务。我建议给它一个<code class="fe kz la lb lc b">100 </code>秒的启动时间，以确保服务器在ECS开始检查它之前启动<br/> 3。在安全组中打开端口<code class="fe kz la lb lc b">5701 </code>和<code class="fe kz la lb lc b">15701 </code>(事件总线端口，在源代码中硬编码)<br/> 4。再次检查您的集群名和服务名是否与cluster.xml文件中的相同</a></p><p id="40ae" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">如果一切正常，您将在cloudwatch日志中看到类似这样的内容</p><figure class="ld le lf lg gt iv"><div class="bz fp l di"><div class="lh li l"/></div></figure><p id="7599" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">所有源代码包括一个gradle构建文件你可以在这里找到<a class="ae lj" href="https://gitlab.com/bernshtam-articles/vertx-ecs-cluster" rel="noopener ugc nofollow" target="_blank"/>。<strong class="kd jf">注意！</strong>它假设您的maven库中有一个artefact <code class="fe kz la lb lc b">group: 'com.ikentoo', name: 'hazelcast-aws-ecs', version: '1.0-SNAPSHOT’</code>！</p><p id="9ac7" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">参考文献:<br/> 1。<a class="ae lj" href="https://medium.com/@pedrojuarez/ec2-ecs-instance-metadata-2939d7a6f2ce" rel="noopener">如何从ECS容器</a>内部获取主机ip和端口<br/> 2。<a class="ae lj" href="https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/ec2-instance-metadata.html" rel="noopener ugc nofollow" target="_blank">实例元数据和用户数据</a> <br/> 3。<a class="ae lj" href="https://stackoverflow.com/questions/32815708/how-to-set-up-hazelcast-in-a-ecs-ec2-container-service-environment" rel="noopener ugc nofollow" target="_blank">如何在ECS (EC2容器服务)环境下设置hazelcast？</a> <br/> 4。<a class="ae lj" href="https://github.com/iKentoo/hazelcast-aws-ecs" rel="noopener ugc nofollow" target="_blank">hazel cast-AWS-ECS</a>T12】5。<a class="ae lj" href="https://github.com/hazelcast/hazelcast-aws" rel="noopener ugc nofollow" target="_blank"> hazelcast-aws </a> —他们说他们支持ECS，但是我没能运行它<br/> 6。<a class="ae lj" href="https://github.com/hazelcast/hazelcast-aws/issues/86" rel="noopener ugc nofollow" target="_blank"> Fargate support #86 </a> —在这里我看到了对<a class="ae lj" href="https://github.com/iKentoo/hazelcast-aws-ecs" rel="noopener ugc nofollow" target="_blank">hazel cast-AWS-ECS</a><br/>7的引用。<a class="ae lj" href="https://medium.com/boltops/gentle-introduction-to-how-aws-ecs-works-with-example-tutorial-cea3d27ce63d" rel="noopener">用例子温和的介绍AWS ECS如何工作教程</a> <br/> 8。<a class="ae lj" href="https://medium.com/boltops/gentle-introduction-to-how-aws-ecs-works-with-example-tutorial-cea3d27ce63d" rel="noopener">教程:使用AWS CLI </a> <br/> 9创建带有Fargate任务的集群。<a class="ae lj" href="https://gitlab.com/bernshtam-articles/vertx-ecs-cluster" rel="noopener ugc nofollow" target="_blank">本文来源</a></p></div></div>    
</body>
</html>