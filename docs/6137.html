<html>
<head>
<title>Scaling Bitcoin Node with Kubernetes</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Kubernetes扩展比特币节点</h1>
<blockquote>原文：<a href="https://itnext.io/scaling-bitcoin-node-with-kubernetes-64d6017a047d?source=collection_archive---------7-----------------------#2021-08-30">https://itnext.io/scaling-bitcoin-node-with-kubernetes-64d6017a047d?source=collection_archive---------7-----------------------#2021-08-30</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><figure class="gl gn jr js jt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi jq"><img src="../Images/1e2f38617324e73102923dec6d7a62f7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*avO7m_GTwHewTGe6PU2gOw.png"/></div></div></figure><p id="17a9" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">基于区块链的解决方案在过去几年变得非常流行，为了获得区块链的数据，你必须通过私人托管的区块链节点进行某种数据访问，或者从https://blockpulsar.com的<a class="ae kz" href="https://blockpulsar.com/" rel="noopener ugc nofollow" target="_blank">获取数据</a></p><p id="1914" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">私人托管是相当昂贵的，但这是一种权衡，你自己管理一切，并控制你想要的区域发行版或API，而不是通过简单的订阅获得它，让其他专业人士管理技术资料。</p><p id="0430" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">如果你有某种项目需要一个私人托管的比特币节点，那么很可能直接在虚拟服务器上进行原始配置是一个非常糟糕的想法，特别是如果有太多可扩展的解决方案可以配置你的云环境。</p><h1 id="b255" class="la lb it bd lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx bi translated">将比特币节点放入Docker容器</h1><p id="b5f1" class="pw-post-body-paragraph kb kc it kd b ke ly kg kh ki lz kk kl km ma ko kp kq mb ks kt ku mc kw kx ky im bi translated">本质上，比特币节点是某种基本的C++服务器应用程序，如果你想努力推动它并从中获得最大收益，它是相当存储密集型和CPU密集型的。最难解决的部分是为了能够运行节点而必须装载的大量Docker卷。</p><p id="3804" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">在撰写本文时，BTC节点需要大约450GB的存储容量来获取完整的区块链，并作为一个容器正常运行。这已经非常昂贵，而且几乎不可能在标准的Macbook Pro上运行来进行开发测试。这就是为什么确保您的Kubernetes环境能够访问至少500GB以使部署正常进行非常重要。</p><p id="cac3" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">首先，让我们使用<code class="fe md me mf mg b">debian:buster</code>作为基础映像，在那里建立BTC节点是很容易的，并且作为Docker基础映像发行版它是很受欢迎的，所以我们在研究一些潜在问题时不会有任何问题</p><pre class="mh mi mj mk gt ml mg mm mn aw mo bi"><span id="2826" class="mp lb it mg b gy mq mr l ms mt">FROM debian:buster<br/>WORKDIR /root</span></pre><p id="e38b" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">保留<code class="fe md me mf mg b">/root</code>作为我们的入口点，因为我们在容器内作为根用户工作，BTC节点将从<code class="fe md me mf mg b">/root/.bitcoin</code>基础卷工作。</p><p id="28c2" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">因为我们想看起来有点花哨，并确保我们已经正确编译了BTC节点，所以我们将下载源代码，并在构建过程中直接在容器内编译它们</p><pre class="mh mi mj mk gt ml mg mm mn aw mo bi"><span id="a480" class="mp lb it mg b gy mq mr l ms mt">RUN apt update &amp;&amp; apt install --yes wget &amp;&amp; \ <br/>   wget https://bitcoin.org/bin/bitcoin-core-0.21.1/bitcoin-0.21.1.tar.gz &amp;&amp; \ <br/>   tar xzf bitcoin-0.21.1.tar.gz &amp;&amp; mv bitcoin-0.21.1 bitcoin &amp;&amp; \   <br/>   rm -rf bitcoin-0.21.1.tar.gz</span></pre><p id="bd1e" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">当然，您可以为BTC节点版本创建一个环境变量，就像从环境变量中替换<code class="fe md me mf mg b">0.21.1</code>版本一样，以使版本升级更加容易。</p><p id="2f83" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">老实说，BTC节点有大量的库依赖项，之所以会这样，是因为在C++服务器开发过程中，你有相当多的外部库可以使用，而不是自己构建所有的东西，所以我们必须安装依赖项并最终编译节点</p><pre class="mh mi mj mk gt ml mg mm mn aw mo bi"><span id="a438" class="mp lb it mg b gy mq mr l ms mt">RUN apt install --yes build-essential autoconf libtool pkg-config \<br/>    bsdmainutils libboost-all-dev libevent-dev<br/><br/>RUN cd bitcoin &amp;&amp; ./autogen.sh &amp;&amp; ./configure --disable-wallet &amp;&amp; \<br/>    make -j4 &amp;&amp; make install &amp;&amp; cd /root &amp;&amp; rm -rf bitcoin &amp;&amp; apt clean</span></pre><p id="fb70" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">请注意，我们将每一步作为单独的<code class="fe md me mf mg b">RUN</code>命令来执行，以修复图像层，并确保如果没有更改，我们会缓存内容。例如，如果您只构建了一次，那么只有在您更改BTC节点版本或从系统中删除基础映像时，才会构建第二次。</p><p id="c404" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">为BTC节点构建这种半可扩展的Kubernetes系统的主要部分可能是将存储作为单独的卷挂载到Docker容器的目录中，但问题是比特币节点也将其配置保存在同一个文件夹中，因此如果我们挂载该卷，我们将会丢失BTC节点配置。所以，我们必须将配置从本地磁盘复制到<code class="fe md me mf mg b">/root/bitcoin.conf</code>中，稍后将它指定为一个单独的配置文件。</p><pre class="mh mi mj mk gt ml mg mm mn aw mo bi"><span id="583b" class="mp lb it mg b gy mq mr l ms mt">COPY ./bitcoin.conf /root/bitcoin.conf<br/><br/>EXPOSE 8332 8333<br/><br/>CMD /bin/bash -c "bitcoind --conf=/root/bitcoin.conf"</span></pre><p id="42c2" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">Rest非常简单，只需运行一个docker容器，该容器已经预先定义了公开的端口和启动命令。</p><h1 id="b30f" class="la lb it bd lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx bi translated">多个副本的简单Kubernetes配置</h1><p id="cd7f" class="pw-post-body-paragraph kb kc it kd b ke ly kg kh ki lz kk kl km ma ko kp kq mb ks kt ku mc kw kx ky im bi translated">当然，作为基础，我们必须定义Kubernetes服务本身，以确保它在Kubernetes集群内部是可达的，但它在这里完全是常规的服务配置，还不是特定于BTC节点的！</p><pre class="mh mi mj mk gt ml mg mm mn aw mo bi"><span id="a804" class="mp lb it mg b gy mq mr l ms mt"># btc.service.yml<br/>apiVersion: v1<br/>kind: Service<br/>metadata:<br/>  name: bitcoin<br/>spec:<br/>  selector:<br/>    app: bitcoin<br/>  ports:<br/>    - protocol: TCP<br/>      name: http<br/>      port: 8332<br/>      targetPort: 8332</span></pre><p id="f39a" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">唯一的事情是，我们的目标是从BTC节点获取通用RPC API的端口8332。</p><p id="1d2a" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">配置的第二部分是定义<code class="fe md me mf mg b">StorageClass</code>，根据云提供商或专用服务器配置，这将有所不同，但我们必须有一个存储类，我们可以在多个副本之间重复使用，以便为每个BTC节点副本创建一个新卷。这个例子是在谷歌云中制作东西。</p><pre class="mh mi mj mk gt ml mg mm mn aw mo bi"><span id="3e57" class="mp lb it mg b gy mq mr l ms mt"># btc.storage.class.yml<br/>kind: StorageClass<br/>apiVersion: storage.k8s.io/v1<br/>metadata:<br/>  name: bitcoin-disk<br/>provisioner: kubernetes.io/gce-pd<br/>parameters:<br/>  type: pd-ssd<br/>  zone: us-central1-a<br/>allowVolumeExpansion: true</span></pre><p id="d0b9" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">定义并应用存储类后，我们可以继续定义实际的pods配置，这不是常规部署，但正是<code class="fe md me mf mg b">StatefulSet</code>确保我们为每个副本复制分配的资源。它主要用于数据库或缓存实例，但不要忘记BTC节点包含区块链，这也是一种数据库，它当然是一种有状态的应用程序。</p><pre class="mh mi mj mk gt ml mg mm mn aw mo bi"><span id="7a83" class="mp lb it mg b gy mq mr l ms mt"># btc.stateful.set.yml<br/>apiVersion: apps/v1<br/>kind: StatefulSet<br/>metadata:<br/>  name: bitcoin<br/>spec:<br/>  serviceName: bitcoin<br/>  replicas: 1 # Scale as match as you want<br/>  revisionHistoryLimit: 1<br/>  selector:<br/>    matchLabels:<br/>      app: bitcoin<br/>  template:<br/>    metadata:<br/>      labels:<br/>        app: bitcoin<br/>    spec:<br/>      restartPolicy: Always<br/>      containers:<br/>        - name: bitcoin<br/>          image: &lt;your BTC Node Image&gt;<br/>          volumeMounts:<br/>            - name: bitcoin<br/>              mountPath: /root/.bitcoin<br/>  volumeClaimTemplates:<br/>    - metadata:<br/>        name: bitcoin<br/>      spec:<br/>        accessModes: [ "ReadWriteOnce" ]<br/>        storageClassName: bitcoin-disk<br/>        resources:<br/>          requests:<br/>            storage: 500Gi</span></pre><p id="ff7f" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">就是这样！在此之后，您可以通过更改<code class="fe md me mf mg b">replicas</code>数字，根据所需的计数来扩展BTC节点，但请记住，每个副本将需要额外的500GB存储和更多资源来处理BTC节点事务。</p><p id="9213" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">要考虑的一个极端情况是，无论何时尝试扩展BTC节点，都要确保在它前面有某种负载平衡。我知道Kubernetes从服务到Pod级别都内置了它，但根据来自<a class="ae kz" href="https://blockpulsar.com/" rel="noopener ugc nofollow" target="_blank">https://blockpulsar.com</a>的经验，有时BTC节点看起来很健康，但它无法获取某些部分的数据。因此，维护生产状态BTC节点比管理标准服务要痛苦得多。</p><h1 id="b663" class="la lb it bd lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx bi translated">结论</h1><p id="52fd" class="pw-post-body-paragraph kb kc it kd b ke ly kg kh ki lz kk kl km ma ko kp kq mb ks kt ku mc kw kx ky im bi translated">大多数基于区块链的应用程序需要使用直接RPC API从区块链节点获取数据，这增加了将这些数据放在云基础架构中的需求，并且维护和设置成本很高。</p><p id="d5c7" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">如果您在BTC节点的基础上构建了资源和自动化来保持其最新并正确处理负载平衡，那么扩展它并不困难。一些云基础设施提供商甚至限制如何匹配每个帐户可以使用的存储，这是本地托管BTC节点的另一个限制，因为与它们相关的大部分成本归结为扩展每个节点的存储空间。这就是为什么有像https://blockpulsar.com T2 T3这样的服务，通过提供使用比特币区块链API的干净API来做所有复杂的基础设施工作。</p></div></div>    
</body>
</html>