<html>
<head>
<title>Injecting a client-side script in GraphQL Playground in Apollo Server</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在Apollo服务器的GraphQL Playground中注入客户端脚本</h1>
<blockquote>原文：<a href="https://itnext.io/injecting-a-client-side-script-in-graphql-playground-in-apollo-server-d23b6e3c901b?source=collection_archive---------1-----------------------#2018-12-22">https://itnext.io/injecting-a-client-side-script-in-graphql-playground-in-apollo-server-d23b6e3c901b?source=collection_archive---------1-----------------------#2018-12-22</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><p id="6526" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">只是个黑客。</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi ko"><img src="../Images/826d9946c1894cd307c36cd598478775.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*6LBS3YegfH7ocdQb80IChw.png"/></div></div></figure><p id="8943" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">这是一篇解释我如何在Playground中注入客户端脚本的短文。请注意，在我找到更好的方法之前，这只是一个变通解决方案。</p><h2 id="2e21" class="la lb it bd lc ld le dn lf lg lh dp li kb lj lk ll kf lm ln lo kj lp lq lr ls bi translated">背景</h2><p id="f591" class="pw-post-body-paragraph jq jr it js b jt lt jv jw jx lu jz ka kb lv kd ke kf lw kh ki kj lx kl km kn im bi translated">在用Apollo Server开发GraphQL服务器时，GraphQL Playground是你很可能会用到的工具。现在，假设我们有一个Apollo服务器，它使用HTTP头中的令牌进行身份验证。幸运的是，Playground有一个编辑器来指定HTTP头。但是，如果我们需要调用OAuth provider来获取accessToken，该怎么办呢？当然，我们可以运行<code class="fe ly lz ma mb b">curl</code>来获得一个令牌，在终端中复制它并粘贴到浏览器中。如果我们只需在浏览器中登录，应该会容易得多。</p></div><div class="ab cl mc md hx me" role="separator"><span class="mf bw bk mg mh mi"/><span class="mf bw bk mg mh mi"/><span class="mf bw bk mg mh"/></div><div class="im in io ip iq"><p id="c97b" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">快速查看一下Apollo服务器代码和Playground代码，似乎没有配置来注入一个在浏览器中运行的脚本。虽然不确定是否有推荐的方法，但我尝试修补它。</p><h2 id="5428" class="la lb it bd lc ld le dn lf lg lh dp li kb lj lk ll kf lm ln lo kj lp lq lr ls bi translated">示例代码</h2><p id="90c2" class="pw-post-body-paragraph jq jr it js b jt lt jv jw jx lu jz ka kb lv kd ke kf lw kh ki kj lx kl km kn im bi translated">下面是基于Apollo服务器教程的代码。它只是在HTML中添加了一个字符串。</p><pre class="kp kq kr ks gt mj mb mk ml aw mm bi"><span id="f2e2" class="la lb it mb b gy mn mo l mp mq">const { ApolloServer, gql } = require('apollo-server-express');<br/>const express = require('express');<br/>const interceptor = require('express-interceptor');<br/><br/>const typeDefs = gql`<br/>  type Query {<br/>    "A simple type for getting started!"<br/>    hello: String<br/>  }<br/>`;<br/><br/>const resolvers = {<br/>  Query: {<br/>    hello: () =&gt; 'world',<br/>  },<br/>};<br/><br/>const server = new ApolloServer({<br/>  typeDefs,<br/>  resolvers,<br/>});<br/><br/>const app = express();<br/>const port = process.env.PORT || 3000;<br/><br/>const <strong class="mb iu">SCRIPT_TO_INJECT</strong> = `<br/>  &lt;script&gt;<br/>    window.addEventListener('load', () =&gt; {<br/>      console.log('script injected');<br/>      <strong class="mb iu">const store = window.s;</strong><br/>      setTimeout(() =&gt; {<br/>        const headers = '{"Authorization": "Bearer token"}';<br/>        store.dispatch({ type: 'EDIT_HEADERS', payload: { headers } });<br/>      }, 2000);<br/>    });<br/>  &lt;/script&gt;<br/>`;<br/>const <strong class="mb iu">END_BODY</strong> = '\n  &lt;/body&gt;\n  &lt;/html&gt;';<br/>app.use(interceptor((req, res) =&gt; ({<br/>  isInterceptable: () =&gt; <strong class="mb iu">/text\/html/</strong>.test(res.get('content-type')),<br/>  intercept: (body, send) =&gt; {<br/>    send(body.replace(<strong class="mb iu">END_BODY</strong>, <strong class="mb iu">SCRIPT_TO_INJECT</strong> + <strong class="mb iu">END_BODY</strong>));<br/>  },<br/>})));<br/><br/>server.applyMiddleware({ app });<br/><br/>app.get('/', (req, res) =&gt; {<br/>  res.redirect(server.graphqlPath);<br/>});<br/><br/>app.listen(port, () =&gt; {<br/>  console.log(`Open http://localhost:${port}${server.graphqlPath}`);<br/>});</span></pre><p id="875e" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">这里好看的是Playground把Redux store曝光为<code class="fe ly lz ma mb b">window.s</code>。请注意，字符串替换并不健壮，如果Playground更改了HTML中的空格，它将不起作用。</p><h2 id="c989" class="la lb it bd lc ld le dn lf lg lh dp li kb lj lk ll kf lm ln lo kj lp lq lr ls bi translated">怎么跑</h2><p id="6570" class="pw-post-body-paragraph jq jr it js b jt lt jv jw jx lu jz ka kb lv kd ke kf lw kh ki kj lx kl km kn im bi translated">您可以查看GitHub存储库并运行这个示例。</p><div class="mr ms gp gr mt mu"><a href="https://github.com/dai-shi/apollo-server-patch-playground-example" rel="noopener  ugc nofollow" target="_blank"><div class="mv ab fo"><div class="mw ab mx cl cj my"><h2 class="bd iu gy z fp mz fr fs na fu fw is bi translated">戴-史/阿波罗-服务器-补丁-游乐场-示例</h2><div class="nb l"><h3 class="bd b gy z fp mz fr fs na fu fw dk translated">用Apollo Server修补GraphQL Playground的一个例子——戴式/Apollo-Server-patch-Playground——example</h3></div><div class="nc l"><p class="bd b dl z fp mz fr fs na fu fw dk translated">github.com</p></div></div><div class="nd l"><div class="ne l nf ng nh nd ni ky mu"/></div></div></a></div><p id="0bb9" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">也可以在codesandbox中运行。</p><div class="mr ms gp gr mt mu"><a href="https://codesandbox.io/s/github/dai-shi/apollo-server-patch-playground-example/tree/master/?module=%2Fsrc%2Fserver.js" rel="noopener  ugc nofollow" target="_blank"><div class="mv ab fo"><div class="mw ab mx cl cj my"><h2 class="bd iu gy z fp mz fr fs na fu fw is bi translated">阿波罗-服务器-补丁-游乐场-示例-代码沙盒</h2><div class="nb l"><h3 class="bd b gy z fp mz fr fs na fu fw dk translated">用Apollo服务器修补GraphQL Playground的一个例子</h3></div><div class="nc l"><p class="bd b dl z fp mz fr fs na fu fw dk translated">codesandbox.io</p></div></div><div class="nd l"><div class="nj l nf ng nh nd ni ky mu"/></div></div></a></div><p id="5271" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">(直到现在，我才意识到CodeSandbox有能力运行阿波罗服务器。多好啊！)</p><h2 id="01ee" class="la lb it bd lc ld le dn lf lg lh dp li kb lj lk ll kf lm ln lo kj lp lq lr ls bi translated">最终注释</h2><p id="c79b" class="pw-post-body-paragraph jq jr it js b jt lt jv jw jx lu jz ka kb lv kd ke kf lw kh ki kj lx kl km kn im bi translated">正如我提到的，这只是写作时的一种变通方法。我很确定这不是我们想要的，并希望寻找一个推荐的解决方案。</p></div></div>    
</body>
</html>