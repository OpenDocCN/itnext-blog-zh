<html>
<head>
<title>Clean pattern for handling roles and permissions in large-scale React apps</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">大规模React应用中处理角色和权限的清晰模式</h1>
<blockquote>原文：<a href="https://itnext.io/clean-pattern-for-handling-roles-and-permissions-in-large-scale-react-apps-99531869ad71?source=collection_archive---------1-----------------------#2021-05-16">https://itnext.io/clean-pattern-for-handling-roles-and-permissions-in-large-scale-react-apps-99531869ad71?source=collection_archive---------1-----------------------#2021-05-16</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><figure class="gl gn jr js jt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi jq"><img src="../Images/b5edc08220895e862e4afd8d8a5023df.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*aUWiUAVCtmbSrUj3iJCf4Q.png"/></div></div></figure><p id="6d9e" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">在这篇文章中，我们将讨论如何在React中管理精细的角色和权限。</p><p id="1139" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">任何React应用程序在开始时都非常整洁，直到您开始在它上面放置条件逻辑。当您开始添加粒度权限和角色时，情况会变得更糟。</p><p id="44b0" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">当使用简单的条件句或<code class="fe kz la lb lc b">switch</code>语句时，处理所有这些细微差别是一场噩梦。有一个更好的方法来做这件事。</p><h1 id="c65b" class="ld le it bd lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma bi translated">模式概述</h1><p id="7f8d" class="pw-post-body-paragraph kb kc it kd b ke mb kg kh ki mc kk kl km md ko kp kq me ks kt ku mf kw kx ky im bi translated">如果分解一下，模式就简单了。它包括构建一个门控包装器，并定义一组具有角色、范围和权限的映射。</p><p id="4f2a" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">门控包装接受用户查看受保护组件必须拥有的范围数组。我们还将为某些边缘情况提供一些便利的道具。</p><h1 id="33ae" class="ld le it bd lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma bi translated">辅导的</h1><h2 id="74b8" class="mg le it bd lf mh mi dn lj mj mk dp ln km ml mm lr kq mn mo lv ku mp mq lz mr bi translated">门控组件</h2><p id="a436" class="pw-post-body-paragraph kb kc it kd b ke mb kg kh ki mc kk kl km md ko kp kq me ks kt ku mf kw kx ky im bi translated">我们将从添加门控组件开始。姑且称之为<code class="fe kz la lb lc b">PermissionsGate</code>:</p><figure class="ms mt mu mv gt ju"><div class="bz fp l di"><div class="mw mx l"/></div></figure><p id="03e1" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated"><code class="fe kz la lb lc b">PermssionsGate</code>承接<code class="fe kz la lb lc b">children</code>和<code class="fe kz la lb lc b">scopes</code>房产。我们使用<code class="fe kz la lb lc b">scopes</code>来声明用户必须拥有哪些权限才能查看<code class="fe kz la lb lc b">PermissionsGate</code>的内容。</p><p id="dfa5" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated"><code class="fe kz la lb lc b">useGetRole</code>是您必须定义的自定义挂钩，它返回当前用户的角色。</p><p id="058d" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated"><code class="fe kz la lb lc b">hasPermission</code>根据所需的范围和用户的权限，返回是否授予用户访问权限的布尔值。</p><h2 id="7fbb" class="mg le it bd lf mh mi dn lj mj mk dp ln km ml mm lr kq mn mo lv ku mp mq lz mr bi translated">角色和权限的映射</h2><p id="d90b" class="pw-post-body-paragraph kb kc it kd b ke mb kg kh ki mc kk kl km md ko kp kq me ks kt ku mf kw kx ky im bi translated">现在让我们定义我们需要的范围、用户角色和权限映射。我们将它们放在一个单独的<code class="fe kz la lb lc b">permission-maps.js</code>文件中:</p><figure class="ms mt mu mv gt ju"><div class="bz fp l di"><div class="mw mx l"/></div></figure><p id="3033" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">我们有三张地图:</p><ul class=""><li id="c7df" class="my mz it kd b ke kf ki kj km na kq nb ku nc ky nd ne nf ng bi translated"><code class="fe kz la lb lc b">ROLES</code> -我们应用程序中的所有用户角色。</li><li id="30b1" class="my mz it kd b ke nh ki ni km nj kq nk ku nl ky nd ne nf ng bi translated"><code class="fe kz la lb lc b">SCOPES</code> -我们传递给门控包装器的作用域。</li><li id="7ffc" class="my mz it kd b ke nh ki ni km nj kq nk ku nl ky nd ne nf ng bi translated"><code class="fe kz la lb lc b">PERMISSIONS</code> -映射定义了每个用户角色拥有的范围集。</li></ul><p id="3ffc" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">现在让我们看看<code class="fe kz la lb lc b">PermissionsGate</code>的运行情况。假设用户必须是编辑才能查看下面的页面:</p><figure class="ms mt mu mv gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi nm"><img src="../Images/f3c22cb96b76686b57d2fd754f54b304.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*TWsc5CtVZLi2vzsyU4MyYA.png"/></div></div><figcaption class="nn no gj gh gi np nq bd b be z dk translated">私人内容</figcaption></figure><p id="0683" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">我们需要做的就是用<code class="fe kz la lb lc b">PermissionsGate</code>包装受保护的内容，并提供查看内容所需的范围。</p><figure class="ms mt mu mv gt ju"><div class="bz fp l di"><div class="mw mx l"/></div></figure><p id="71e6" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">客户端API是干净的，如果将来业务需求发生变化，可以很容易地调整范围。</p><h1 id="f79f" class="ld le it bd lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma bi translated">其他使用案例</h1><p id="6fa6" class="pw-post-body-paragraph kb kc it kd b ke mb kg kh ki mc kk kl km md ko kp kq me ks kt ku mf kw kx ky im bi translated">到目前为止，一切顺利。但是我们可以进一步改进<code class="fe kz la lb lc b">PermissionsGate</code>。让我们对其进行修改，以涵盖经常出现的另外两种用例:</p><ul class=""><li id="591f" class="my mz it kd b ke kf ki kj km na kq nb ku nc ky nd ne nf ng bi translated">如果用户没有正确的权限，则显示自定义错误消息。</li><li id="727e" class="my mz it kd b ke nh ki ni km nj kq nk ku nl ky nd ne nf ng bi translated">如果用户没有正确的权限，则沿着组件树向下传递一组自定义的道具。</li></ul><p id="7531" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">先说第一个。在某些情况下，如果用户没有适当的权限，我们希望显示一个自定义的错误组件。我们可以通过给我们的<code class="fe kz la lb lc b">PermissionsGate</code>添加一个道具来做到这一点。姑且称之为<code class="fe kz la lb lc b">RenderError</code>:</p><figure class="ms mt mu mv gt ju"><div class="bz fp l di"><div class="mw mx l"/></div></figure><p id="2983" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">让我们来看看它的实际应用:</p><figure class="ms mt mu mv gt ju"><div class="bz fp l di"><div class="mw mx l"/></div></figure><p id="551d" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">这是我们现在看到的:</p><figure class="ms mt mu mv gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi nr"><img src="../Images/19aeffc79ee39b3eb672f31a8dbafe86.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*rKeUM-qGsihi2q81CEuVjQ.png"/></div></div><figcaption class="nn no gj gh gi np nq bd b be z dk translated">自定义错误消息</figcaption></figure><p id="77fd" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated"><code class="fe kz la lb lc b">PermissionsGate</code>没有呈现受保护的组件，而是呈现我们自定义的错误消息。这是因为我们需要<code class="fe kz la lb lc b">canCreate</code>范围来查看内容，而我们的用户没有。</p><p id="5286" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">让我们继续第二个用例。有时候，你不一定想藏孩子。相反，您可能希望通过传递一组自定义的道具来让孩子们知道。一个例子是，如果用户不是编辑者，可以通过提供一个<code class="fe kz la lb lc b">disabled</code>属性来禁用输入。</p><p id="6012" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">要将自定义道具传递给孩子，我们可以使用<a class="ae ns" href="https://reactjs.org/docs/react-api.html#cloneelement" rel="noopener ugc nofollow" target="_blank"> React.cloneElement </a>:</p><figure class="ms mt mu mv gt ju"><div class="bz fp l di"><div class="mw mx l"/></div></figure><p id="8c41" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">你可以这样使用它:</p><figure class="ms mt mu mv gt ju"><div class="bz fp l di"><div class="mw mx l"/></div></figure><p id="a25a" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">对于没有<code class="fe kz la lb lc b">SCOPE.canEdit</code>范围的任何人，我们的输入将被禁用。</p><p id="192b" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">现在我们的<code class="fe kz la lb lc b">PermissionsGate</code>准备好了！通过处理这两个边缘案例，我们确保了我们可以接受任何抛给我们的与权限相关的需求。</p><h1 id="d6d6" class="ld le it bd lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma bi translated">结论</h1><p id="a009" class="pw-post-body-paragraph kb kc it kd b ke mb kg kh ki mc kk kl km md ko kp kq me ks kt ku mf kw kx ky im bi translated">有了我们的门控组件，我们有了一个清晰的可扩展的解决方案，让我们可以根据需要细化权限。</p><p id="1cac" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">根据您的服务器和数据库设置，您的门控包装器和权限映射的实现可能略有不同。但主要原则保持不变。</p><p id="8e8b" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">作为一个快速提醒:永远不要只依赖于检查前端应用程序的权限。永远记住在服务器上添加额外的权限验证。</p></div><div class="ab cl nt nu hx nv" role="separator"><span class="nw bw bk nx ny nz"/><span class="nw bw bk nx ny nz"/><span class="nw bw bk nx ny"/></div><div class="im in io ip iq"><p id="b089" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated"><em class="oa">原载于2021年5月16日https://isamatov.com</em><a class="ae ns" href="https://isamatov.com/react-permissions-and-roles/" rel="noopener ugc nofollow" target="_blank"><em class="oa"/></a><em class="oa">。</em></p></div></div>    
</body>
</html>