<html>
<head>
<title>Dynamic AWS S3 Notification Configuration using Terraform</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Terraform的动态自动气象站S3通知配置</h1>
<blockquote>原文：<a href="https://itnext.io/dynamic-aws-s3-notification-configuration-using-terraform-43a74998e97a?source=collection_archive---------2-----------------------#2021-06-08">https://itnext.io/dynamic-aws-s3-notification-configuration-using-terraform-43a74998e97a?source=collection_archive---------2-----------------------#2021-06-08</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="5741" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这是你期望的简单的东西，嗯，简单。直到他们不再是。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi kl"><img src="../Images/0b03b867828bbbaecb7c08ef0e5376da.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*BWHk3RbzVKDTvGkY"/></div></div><figcaption class="kx ky gj gh gi kz la bd b be z dk translated">詹姆斯·哈里逊在<a class="ae lb" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</figcaption></figure><p id="3866" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">所以情况是这样的:</p><ul class=""><li id="9ace" class="lc ld iq jp b jq jr ju jv jy le kc lf kg lg kk lh li lj lk bi translated">我有一个aws <strong class="jp ir"> s3桶</strong></li><li id="9452" class="lc ld iq jp b jq ll ju lm jy ln kc lo kg lp kk lh li lj lk bi translated">我从这个桶中为objectCreated事件动态创建了多个<strong class="jp ir">消费者</strong></li><li id="82ba" class="lc ld iq jp b jq ll ju lm jy ln kc lo kg lp kk lh li lj lk bi translated"><strong class="jp ir">每个消费者订阅该桶上的特定前缀。也就是说，服务1将只监听srv1/ path上的新文件。service2将仅侦听srv2/ path上的新文件，依此类推。</strong></li></ul><p id="ec09" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">因为一个SNS不能区分s3前缀，所以我需要多个SNS主题——每个服务一个</p><p id="5976" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">手动操作—非常简单，只需创建另一对SNS/sq，我就可以开始了。但手动过程属于1995年的黑暗时代，我需要使用IaaC自动完成，在这种情况下使用Terraform。</p><h1 id="ab8f" class="lq lr iq bd ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn bi translated">简单，我们开始吧！</h1><p id="2a32" class="pw-post-body-paragraph jn jo iq jp b jq mo js jt ju mp jw jx jy mq ka kb kc mr ke kf kg ms ki kj kk ij bi translated">所以我去了那里，确切地知道我需要做什么。创建一个terraform文件来管理s3存储桶、sns主题及其策略，并使用正确的前缀(/srv1、/srv2等)将每个sns主题附加到存储桶</p><p id="9b1d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">像任何优秀的程序员一样——我想复制粘贴东西只是为了让它运行，所以我谷歌了“aws s3 sns notification terrafom”并点击了第一个链接(非常方便的是terraform documentations)。这是链接:</p><blockquote class="mt mu mv"><p id="8c8a" class="jn jo mw jp b jq jr js jt ju jv jw jx mx jz ka kb my kd ke kf mz kh ki kj kk ij bi translated"><a class="ae lb" href="https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/s3_bucket_notification" rel="noopener ugc nofollow" target="_blank">https://registry . terra form . io/providers/hashi corp/AWS/latest/docs/resources/S3 _ bucket _ notification</a></p></blockquote><p id="b9c4" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">那一页上一句简单的话吸引了我的目光，也伤了我的心:</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi na"><img src="../Images/b8eadf07d3059cef6a22fa1f8693e333.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*xhMknuPeY_oG3v6vHjUouQ.png"/></div></div></figure><p id="21de" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这一切意味着什么？？</p><h1 id="6ce5" class="lq lr iq bd ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn bi translated">没那么容易…</h1><p id="564c" class="pw-post-body-paragraph jn jo iq jp b jq mo js jt ju mp jw jx jy mq ka kb kc mr ke kf kg ms ki kj kk ij bi translated">这意味着我可以在桶上附加一个aws_s3_bucket_notification。这也意味着，我必须提前知道我将拥有的所有主题，因为我必须将它们作为terraform代码的一部分来编写。</p><p id="d64f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">但是我之前说了，我有一个动态的消费者名单，我不可能提前全部知道，我是不是被套牢了？</p><h1 id="018a" class="lq lr iq bd ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn bi translated">创意时间</h1><p id="4f29" class="pw-post-body-paragraph jn jo iq jp b jq mo js jt ju mp jw jx jy mq ka kb kc mr ke kf kg ms ki kj kk ij bi translated">所以在考虑了一会儿之后，我试着使用aws api，获取配置并更新它。因此，如果我可以使用API来做这件事，并得到我想要的，我当然可以自动化它！</p><p id="a696" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我花了很少的试错时间编写了一个python脚本，它接受很少的参数——bucket name、sns arn和相关的前缀。脚本从aws API获取当前配置，检查订阅是否已经存在，如果不存在就添加它。</p><p id="fae0" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><em class="mw">如果有人需要python文件，我很乐意分享它</em></p><p id="add3" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在我只需要运行作为Terraform一部分的脚本。</p><h2 id="c654" class="nb lr iq bd ls nc nd dn lw ne nf dp ma jy ng nh me kc ni nj mi kg nk nl mm nm bi translated">地形空资源和本地执行<code class="fe nn no np nq b">provisioner</code></h2><blockquote class="mt mu mv"><p id="43cd" class="jn jo mw jp b jq jr js jt ju jv jw jx mx jz ka kb my kd ke kf mz kh ki kj kk ij bi translated"><code class="fe nn no np nq b">null_resource</code>资源实现了标准的资源生命周期，但是没有采取进一步的行动。</p><p id="9906" class="jn jo mw jp b jq jr js jt ju jv jw jx mx jz ka kb my kd ke kf mz kh ki kj kk ij bi translated"><code class="fe nn no np nq b">triggers</code>参数允许指定任意一组值，当这些值被更改时，将导致资源被替换。</p></blockquote><p id="a5c5" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">基本上null_resource可以做任何事情，它在云中没有后台资源，它有一个触发器和一个provisioner，一旦触发器改变，provisioner就会运行。</p><p id="a80c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">所以我在有SNS主题的地方添加了一个空资源，传递bucket名称、sns arn和前缀，就这样！</p><pre class="km kn ko kp gt nr nq ns nt aw nu bi"><span id="21e2" class="nb lr iq nq b gy nv nw l nx ny">provider "null" {}</span><span id="991a" class="nb lr iq nq b gy nz nw l nx ny">resource "null_resource" "s3_object_created_subscription" {</span><span id="66e9" class="nb lr iq nq b gy nz nw l nx ny">  triggers = {<br/>     prefix = var.prefix<br/>  }</span><span id="e926" class="nb lr iq nq b gy nz nw l nx ny">  provisioner "local-exec" {<br/>     command = "python ${var.bucket_name} ${var.sns_arn} ${var.prefix}"<br/>  }<br/>}</span></pre><p id="a5e2" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这一小段代码可以从许多terraform状态文件中运行，并将一个sns附加到一个bucket，可以使用我需要的任何前缀和多少前缀。像任何terraform资源一样，它有状态，所以它只运行一次，除非你改变前缀。</p><h1 id="43db" class="lq lr iq bd ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn bi translated">结论</h1><p id="ab3b" class="pw-post-body-paragraph jn jo iq jp b jq mo js jt ju mp jw jx jy mq ka kb kc mr ke kf kg ms ki kj kk ij bi translated">我知道那是个骗局。它可能会中断，因为s3 API最终是一致的。但这并不困扰我，因为我没有大量的并行变化。</p><p id="6da0" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">与使用多个存储桶相比，其背后的原因是我解决的存储桶限制。亚马逊目前只允许每个账户1000桶。那实际上是很多桶。但是一旦你有多个服务，比如说30个，每个服务至少需要1个存储桶，并且你有动态测试环境，你可以很容易地看到你是如何达到这个限制的。</p></div></div>    
</body>
</html>