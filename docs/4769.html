<html>
<head>
<title/>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1/>
<blockquote>原文：<a href="https://itnext.io/angular-creating-custom-validator-for-reactive-form-field-54d70057990a?source=collection_archive---------1-----------------------#2020-09-12">https://itnext.io/angular-creating-custom-validator-for-reactive-form-field-54d70057990a?source=collection_archive---------1-----------------------#2020-09-12</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><figure class="is it gp gr iu iv gh gi paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="gh gi ir"><img src="../Images/597fdc5a4bfe57daa734bed5596dcb9a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*zCXOTbZcK3nRoPxNSfdG-A.jpeg"/></div></div></figure><p id="4941" class="pw-post-body-paragraph jc jd je jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka im bi translated">Angular流行的反应式表单功能附带了一个Validator类，其中包含一些非常基本的表单字段内置验证器，如<em class="kb"> required、email、minLength和maxLength </em>。但有时我们需要验证基本规则无法涵盖的更复杂的规则。</p><p id="a129" class="pw-post-body-paragraph jc jd je jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka im bi translated">幸运的是，为表单域创建和分配一个自定义验证器是非常容易的。</p><h1 id="140d" class="kc kd je bd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz bi translated">示例案例</h1><p id="daf4" class="pw-post-body-paragraph jc jd je jf b jg la ji jj jk lb jm jn jo lc jq jr js ld ju jv jw le jy jz ka im bi translated">我想创建一个包含自定义反应式表单字段的表单，以接受电话号码。你可以在这里看到如何用材料设计<a class="ae lf" rel="noopener ugc nofollow" target="_blank" href="/creating-a-custom-form-field-control-compatible-with-reactive-forms-and-angular-material-cf195905b451">创建一个定制的反应式表单域。</a></p><p id="0313" class="pw-post-body-paragraph jc jd je jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka im bi translated">我的字段有两个参数:国家和实际电话号码。</p><p id="481d" class="pw-post-body-paragraph jc jd je jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka im bi translated">当我从下拉列表中选择一个国家时，我的程序会将这个国家转换成一个国家代码。<br/>例如:希腊30，日本81，美国1等</p><p id="403c" class="pw-post-body-paragraph jc jd je jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka im bi translated">电话号码对象示例:</p><pre class="lg lh li lj gt lk ll lm ln aw lo bi"><span id="ac47" class="lp kd je ll b gy lq lr l ls lt">{<br/>   "country_code" : "30", <br/>   "national_number" : "2123456789", <br/>   "flag_class" : "gr"<br/>}</span></pre><p id="0311" class="pw-post-body-paragraph jc jd je jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka im bi translated">我想创建一个验证器，检查国家代码是否存在，以及输入的数字是否是该国家的有效数字。</p><figure class="lg lh li lj gt iv gh gi paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="gh gi lu"><img src="../Images/c82f927de38583a7202511285d6997fa.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*9sjAHaZJ-uDmzy9vQU2mbA.png"/></div></div><figcaption class="lv lw gj gh gi lx ly bd b be z dk translated">我预览我的电话领域</figcaption></figure><h1 id="aa48" class="kc kd je bd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz bi translated">创建自定义验证程序</h1><p id="a51c" class="pw-post-body-paragraph jc jd je jf b jg la ji jj jk lb jm jn jo lc jq jr js ld ju jv jw le jy jz ka im bi translated">让我们从创建一个新文件开始。我建议您创建一个新文件夹来保存您所有的验证器。</p><p id="2c2c" class="pw-post-body-paragraph jc jd je jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka im bi translated">首先，我将创建并导出一个箭头函数，它接受一个<code class="fe lz ma mb ll b">FormControl</code>参数并返回一个<code class="fe lz ma mb ll b">ValidatorFn</code>。</p><pre class="lg lh li lj gt lk ll lm ln aw lo bi"><span id="d3db" class="lp kd je ll b gy lq lr l ls lt">export const <strong class="ll mc">phoneNumberValidator</strong>: ValidatorFn = (control: FormControl) =&gt; {}</span></pre><p id="e873" class="pw-post-body-paragraph jc jd je jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka im bi translated">每次我将这个验证器设置为表单控件时，我的函数都会将这个控件作为参数。<br/>我的函数必须返回:</p><ol class=""><li id="878e" class="md me je jf b jg jh jk jl jo mf js mg jw mh ka mi mj mk ml bi translated">一个<code class="fe lz ma mb ll b">{[key]: [value]}</code>表达式，如果存在错误</li><li id="04c2" class="md me je jf b jg mm jk mn jo mo js mp jw mq ka mi mj mk ml bi translated"><code class="fe lz ma mb ll b">null</code>如果有效</li></ol><p id="7b25" class="pw-post-body-paragraph jc jd je jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka im bi translated">在我的例子中，我使用<code class="fe lz ma mb ll b"><a class="ae lf" href="https://github.com/ruimarinho/google-libphonenumber" rel="noopener ugc nofollow" target="_blank">google-libphonenumber</a></code>库有两个原因:</p><ol class=""><li id="3784" class="md me je jf b jg jh jk jl jo mf js mg jw mh ka mi mj mk ml bi translated">获取国家代码</li><li id="233e" class="md me je jf b jg mm jk mn jo mo js mp jw mq ka mi mj mk ml bi translated">检查所提供的号码是否是所选国家的有效电话号码</li></ol><p id="badc" class="pw-post-body-paragraph jc jd je jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka im bi translated">在本文中，我将重点讨论第二个问题。</p><h2 id="5eb4" class="lp kd je bd ke mr ms dn ki mt mu dp km jo mv mw kq js mx my ku jw mz na ky nb bi translated">在验证器中使用google-libphonenumber</h2><p id="67e7" class="pw-post-body-paragraph jc jd je jf b jg la ji jj jk lb jm jn jo lc jq jr js ld ju jv jw le jy jz ka im bi translated">首先，我需要导入库。然后我必须创建一个<code class="fe lz ma mb ll b">PhoneNumberUtil</code>实例来使用它的功能。现在我已经准备好开始验证过程了。</p><pre class="lg lh li lj gt lk ll lm ln aw lo bi"><span id="8ac8" class="lp kd je ll b gy lq lr l ls lt"><strong class="ll mc">import * as googlePhoneLib from 'google-libphonenumber';</strong></span><span id="423d" class="lp kd je ll b gy nc lr l ls lt">export const phoneNumberValidator: ValidatorFn = (control: FormControl) =&gt; {<br/>   <strong class="ll mc">const phoneUtil = googlePhoneLib.PhoneNumberUtil.getInstance();</strong><br/>   ...<br/>}</span></pre><p id="1833" class="pw-post-body-paragraph jc jd je jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka im bi translated">我将按以下顺序检查:</p><ul class=""><li id="58b8" class="md me je jf b jg jh jk jl jo mf js mg jw mh ka nd mj mk ml bi translated">我只想验证国家编号中是否有值。我这样做是因为在这个验证器中，我只想检查提供的值是否是有效的电话号码。如果没有提供值，我为这个验证器返回<code class="fe lz ma mb ll b">null</code>。</li></ul><pre class="lg lh li lj gt lk ll lm ln aw lo bi"><span id="b20b" class="lp kd je ll b gy lq lr l ls lt">...<br/>export function phoneNumberValidator(control: FormControl): ValidatorFn {<br/>   const phoneUtil = googlePhoneLib.PhoneNumberUtil.getInstance();</span><span id="9264" class="lp kd je ll b gy nc lr l ls lt"><strong class="ll mc">  if(!control.value || control.value.national_number) {<br/>      return null;<br/>  }</strong><br/>}</span></pre><ul class=""><li id="9bdb" class="md me je jf b jg jh jk jl jo mf js mg jw mh ka nd mj mk ml bi translated">如果有值，我将检查国家代码和国家号码是否确实都是<strong class="jf mc">号码</strong>。如果检查失败，验证器将返回一个错误。</li></ul><pre class="lg lh li lj gt lk ll lm ln aw lo bi"><span id="3a08" class="lp kd je ll b gy lq lr l ls lt">...<br/>export function phoneNumberValidator(control: FormControl): ValidatorFn {<br/>   ...<br/>   <br/>   <strong class="ll mc">if(isNaN(parseInt(control.value.country_code)) || isNaN(parseInt(control.value.national_number))) {<br/>      return {<br/>         phone: true<br/>      };<br/>   }</strong></span><span id="6718" class="lp kd je ll b gy nc lr l ls lt">}</span></pre><ul class=""><li id="85e1" class="md me je jf b jg jh jk jl jo mf js mg jw mh ka nd mj mk ml bi translated">如果它们通过，我将使用库来检查组合号码(国家代码和国家号码)是否有效。首先，我使用<code class="fe lz ma mb ll b">parse</code>方法创建库想要的数字。它有两个参数:T4的国号和选择的国旗类别。然后我使用库的<code class="fe lz ma mb ll b">isValidNumber</code>方法来检查数字是否有效。</li></ul><pre class="lg lh li lj gt lk ll lm ln aw lo bi"><span id="9aec" class="lp kd je ll b gy lq lr l ls lt">...</span><span id="7e6b" class="lp kd je ll b gy nc lr l ls lt">export const phoneNumberValidator: ValidatorFn = (control: FormControl) =&gt; {<br/>  ...</span><span id="b04b" class="lp kd je ll b gy nc lr l ls lt">  <strong class="ll mc">const number = phoneUtil.parse(control.value.national_number, control.value.flag_class.toUpperCase());</strong></span><span id="2b22" class="lp kd je ll b gy nc lr l ls lt"><strong class="ll mc">   const isValid = phoneUtil.isValidNumber(number);</strong></span><span id="e447" class="lp kd je ll b gy nc lr l ls lt">...</span><span id="9091" class="lp kd je ll b gy nc lr l ls lt">}</span></pre><ul class=""><li id="1c86" class="md me je jf b jg jh jk jl jo mf js mg jw mh ka nd mj mk ml bi translated">如果数字有效，我返回<code class="fe lz ma mb ll b">null</code>，否则我返回一个错误。</li></ul><pre class="lg lh li lj gt lk ll lm ln aw lo bi"><span id="d7f2" class="lp kd je ll b gy lq lr l ls lt">...</span><span id="b616" class="lp kd je ll b gy nc lr l ls lt">export const phoneNumberValidator: ValidatorFn = (control: FormControl) =&gt; {<br/>   ...</span><span id="6195" class="lp kd je ll b gy nc lr l ls lt">   const number = phoneUtil.parse(control.value.national_number, control.value.flag_class.toUpperCase());<br/>   const isValid = phoneUtil.isValidNumber(number);</span><span id="7364" class="lp kd je ll b gy nc lr l ls lt"><strong class="ll mc">   return !isValid ? {</strong><br/><strong class="ll mc">      phone: true<br/>   } : null;</strong></span><span id="ab43" class="lp kd je ll b gy nc lr l ls lt">}</span></pre><h2 id="0724" class="lp kd je bd ke mr ms dn ki mt mu dp km jo mv mw kq js mx my ku jw mz na ky nb bi translated">最终文件</h2><p id="77a8" class="pw-post-body-paragraph jc jd je jf b jg la ji jj jk lb jm jn jo lc jq jr js ld ju jv jw le jy jz ka im bi translated">这里可以看到最终代码<a class="ae lf" href="https://gist.github.com/vadal/d82da34e4174bbd7aa43f2cdc59a27d8" rel="noopener ugc nofollow" target="_blank">。</a></p><p id="02fc" class="pw-post-body-paragraph jc jd je jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka im bi translated">在下面的代码中，我还创建了一个单独的函数<code class="fe lz ma mb ll b">isNumber</code>,以使代码更有组织性和可读性。</p><figure class="lg lh li lj gt iv"><div class="bz fp l di"><div class="ne nf l"/></div></figure><h1 id="5317" class="kc kd je bd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz bi translated">使用自定义验证程序</h1><p id="eed4" class="pw-post-body-paragraph jc jd je jf b jg la ji jj jk lb jm jn jo lc jq jr js ld ju jv jw le jy jz ka im bi translated">现在是时候在表单中使用新的验证器了。使用它和任何内置的验证器一样简单:</p><pre class="lg lh li lj gt lk ll lm ln aw lo bi"><span id="5595" class="lp kd je ll b gy lq lr l ls lt">import { Component, OnInit } from '@angular/core';<br/>import { FormBuilder, FormControl, FormGroup, Validators } from '@angular/forms';<br/>import { <!-- -->phoneNumberValidator<!-- --> } from './validators/<!-- -->phone-umber<!-- -->.validator';<br/><br/>@Component({<br/>  ...<br/>})</span><span id="9fd2" class="lp kd je ll b gy nc lr l ls lt">export class MyComponent implements OnInit {<br/>  myForm: FormGroup;<br/>  constructor() {}</span><span id="a6cf" class="lp kd je ll b gy nc lr l ls lt">  ngOnInit() {<br/>     <strong class="ll mc">this.myForm = new FormGroup({<br/>       "phone": new FormControl('', phoneNumberValidator)<br/>     });</strong><br/>  }</span></pre><h1 id="6c0b" class="kc kd je bd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz bi translated">结论</h1><p id="7aa2" class="pw-post-body-paragraph jc jd je jf b jg la ji jj jk lb jm jn jo lc jq jr js ld ju jv jw le jy jz ka im bi translated">构建自定义验证器使得反应式表单更加强大。</p><p id="c9af" class="pw-post-body-paragraph jc jd je jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka im bi translated">在我的下一篇文章中，我将介绍如何创建一个自定义表单验证器，它可以检查多个字段，并将其错误应用到每个字段。</p><p id="5956" class="pw-post-body-paragraph jc jd je jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka im bi translated">希望你觉得这个指南有用！</p></div></div>    
</body>
</html>