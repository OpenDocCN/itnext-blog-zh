<html>
<head>
<title>Save Your Kubernetes Cluster From DoS</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">从DoS保存您的Kubernetes集群</h1>
<blockquote>原文：<a href="https://itnext.io/save-your-kubernetes-cluster-from-dos-4b8855126ca1?source=collection_archive---------3-----------------------#2020-07-06">https://itnext.io/save-your-kubernetes-cluster-from-dos-4b8855126ca1?source=collection_archive---------3-----------------------#2020-07-06</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><p id="3209" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">Kubernetes已经成为容器编排工具的市场领导者。根据<a class="ae ko" href="https://www.cncf.io/wp-content/uploads/2020/03/CNCF_Survey_Report.pdf" rel="noopener ugc nofollow" target="_blank"> 2019年CNCF调查</a>，<strong class="js iu"> 78%的受访者在生产中使用Kubernetes，比去年的58%大幅上升</strong></p><p id="47f0" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">虽然容器已经成为部署应用程序的标准，但是kubernetes已经成为容器管理的标准。</p><h1 id="6209" class="kp kq it bd kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm bi translated">Kubernetes集群中的DoS</h1><p id="3f4b" class="pw-post-body-paragraph jq jr it js b jt ln jv jw jx lo jz ka kb lp kd ke kf lq kh ki kj lr kl km kn im bi translated">考虑一个Kubernetes集群，它有3个工作节点，每个节点有10GB的内存。假设开发人员最终错误地部署了一些pods，这几乎消耗了节点中所有可用的cpu和内存。因此在服务于来自消费者的流量的其他应用荚中引起资源争用。这也可能是由于黑客故意将高资源消耗的容器注入系统造成的。</p><p id="63cf" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">为了更好地理解这种情况，假设一个节点有10GB的容器可分配内存，并且有5个应用程序单元共享可用内存。每个应用程序单元平均消耗1GB内存，这使得节点以50%到60%的内存利用率运行。现在，在同一个节点中部署一个消耗10GB内存的pod将导致噪音邻居问题。这会导致其他应用程序单元中的资源争用，进而增加这些服务的延迟，或者在更糟糕的情况下使服务变得不可用。</p><p id="3616" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">当开发人员在代码中犯了一个错误，导致内存泄漏并不断增加内存使用量时，也可能会发生这种情况。</p><figure class="lt lu lv lw gt lx gh gi paragraph-image"><div role="button" tabindex="0" class="ly lz di ma bf mb"><div class="gh gi ls"><img src="../Images/fd0a22635ca50e09baecf0c6a39b6aa8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*60EHfdnbAhJqixl8E-0i3Q.jpeg"/></div></div></figure><h1 id="b45e" class="kp kq it bd kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm bi translated">Kubernetes的有效资源管理</h1><p id="a4b1" class="pw-post-body-paragraph jq jr it js b jt ln jv jw jx lo jz ka kb lp kd ke kf lq kh ki kj lr kl km kn im bi translated">这就是为什么开发人员应该更加关注他们开发的服务所需的资源，并在Kubernetes集群中部署服务时配置所需的最低内存和cpu。可以相应地配置资源请求，以在保证最小资源的节点中调度pod。</p><p id="8326" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">例如，如果服务至少需要2个cpu和3GB内存，则在pod规范中，按如下方式配置资源请求:</p><pre class="lt lu lv lw gt me mf mg mh aw mi bi"><span id="b6e0" class="mj kq it mf b gy mk ml l mm mn">apiVersion: v1</span><span id="0f30" class="mj kq it mf b gy mo ml l mm mn">kind: Pod</span><span id="d1fc" class="mj kq it mf b gy mo ml l mm mn">metadata:</span><span id="4725" class="mj kq it mf b gy mo ml l mm mn">  name: demo-service</span><span id="859e" class="mj kq it mf b gy mo ml l mm mn">  namespace: demo</span><span id="d7fe" class="mj kq it mf b gy mo ml l mm mn">spec:</span><span id="2d40" class="mj kq it mf b gy mo ml l mm mn">  containers:</span><span id="18ae" class="mj kq it mf b gy mo ml l mm mn">  - name: demo-container</span><span id="f721" class="mj kq it mf b gy mo ml l mm mn">    image: demo-service-image</span><span id="c28c" class="mj kq it mf b gy mo ml l mm mn">    resources:</span><span id="5d14" class="mj kq it mf b gy mo ml l mm mn">      requests:</span><span id="3fec" class="mj kq it mf b gy mo ml l mm mn">        cpu: "2"</span><span id="d28c" class="mj kq it mf b gy mo ml l mm mn">        memory: "3G"</span></pre><p id="50e4" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">同样重要的是，开发人员还应该配置他们的服务可以消耗的最大资源。这有助于避免其他服务单元中的噪音邻居问题。</p><p id="9185" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">比方说同样的<code class="fe mp mq mr mf b">demo-service</code>应该不会消耗超过4个cpu和5 GB内存。在这种情况下，将资源限制添加到上述pod规格中。</p><pre class="lt lu lv lw gt me mf mg mh aw mi bi"><span id="2ac9" class="mj kq it mf b gy mk ml l mm mn">apiVersion: v1</span><span id="2abb" class="mj kq it mf b gy mo ml l mm mn">kind: Pod</span><span id="20b7" class="mj kq it mf b gy mo ml l mm mn">metadata:</span><span id="809d" class="mj kq it mf b gy mo ml l mm mn">  name: demo-service</span><span id="5675" class="mj kq it mf b gy mo ml l mm mn">  namespace: demo</span><span id="1836" class="mj kq it mf b gy mo ml l mm mn">spec:</span><span id="d5ca" class="mj kq it mf b gy mo ml l mm mn">  containers:</span><span id="785f" class="mj kq it mf b gy mo ml l mm mn">  - name: demo-container</span><span id="5567" class="mj kq it mf b gy mo ml l mm mn">    image: demo-service-image</span><span id="7b18" class="mj kq it mf b gy mo ml l mm mn">    resources:</span><span id="65a4" class="mj kq it mf b gy mo ml l mm mn">      requests:</span><span id="5aad" class="mj kq it mf b gy mo ml l mm mn">        cpu: "2"</span><span id="ffd9" class="mj kq it mf b gy mo ml l mm mn">        memory: "3G"</span><span id="da44" class="mj kq it mf b gy mo ml l mm mn">      limits:</span><span id="9561" class="mj kq it mf b gy mo ml l mm mn">        cpu: "4"</span><span id="cd3b" class="mj kq it mf b gy mo ml l mm mn">        memory: "5G"</span></pre><p id="34f8" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">强烈建议根据服务需求在Kubernetes集群中部署的pod中配置资源请求和限制。</p><p id="44db" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">话虽如此，只是为了安全起见，我们需要在Kubernetes集群中添加一些策略，以确保pods不会过度利用资源，从而导致嘈杂的邻居问题，从而避免部署在集群中的应用程序被拒绝服务。</p><h1 id="c588" class="kp kq it bd kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm bi translated">从DoS保存您的Kubernetes集群</h1><p id="76e4" class="pw-post-body-paragraph jq jr it js b jt ln jv jw jx lo jz ka kb lp kd ke kf lq kh ki kj lr kl km kn im bi translated">上述问题的一个解决方案是在资源上设置某种配额，这些资源将被配置为pods中的请求和限制。这是为了确保没有人过度配置资源请求和限制，从而避免节点中资源的过度利用(超过某个阈值)。</p><p id="298e" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">Kubernetes提供了ResourceQuota来实现这一点，因为它在验证阶段注入了一个准入控制器。默认情况下，大多数kubernetes发行版都支持ResourceQuota。即使在其他情况下，也可以通过在kube-apiserver的<code class="fe mp mq mr mf b">--enable-admission-plugins</code>标志中添加<code class="fe mp mq mr mf b">ResourceQuota</code>来启用它。</p><p id="7531" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">启用ResourceQuota准入插件后，根据需要为每个命名空间添加配额。例如，要仅分配10GB的内存用于在名称空间中部署服务，请创建一个资源配额，如下所示:</p><pre class="lt lu lv lw gt me mf mg mh aw mi bi"><span id="87b4" class="mj kq it mf b gy mk ml l mm mn">apiVersion: v1</span><span id="4ef1" class="mj kq it mf b gy mo ml l mm mn">kind: ResourceQuota</span><span id="1a2c" class="mj kq it mf b gy mo ml l mm mn">metadata:</span><span id="e565" class="mj kq it mf b gy mo ml l mm mn">  name: demo-resourcequota</span><span id="cc02" class="mj kq it mf b gy mo ml l mm mn">spec:</span><span id="aedb" class="mj kq it mf b gy mo ml l mm mn">  hard:</span><span id="93b2" class="mj kq it mf b gy mo ml l mm mn">    limits.memory: 10G</span></pre><p id="4987" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">该资源配额确保所有pod的资源限制中的内存总和不超过10GB内存。任何创建或修改请求都将由ResourceQuota准入控制器在验证阶段进行验证。如果不符合现有的资源配额，该请求将被拒绝。</p><p id="9e31" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">现在部署内存限制为2GB的pod，如下所示:</p><pre class="lt lu lv lw gt me mf mg mh aw mi bi"><span id="8ed7" class="mj kq it mf b gy mk ml l mm mn">apiVersion: v1</span><span id="e8df" class="mj kq it mf b gy mo ml l mm mn">kind: Pod</span><span id="2367" class="mj kq it mf b gy mo ml l mm mn">metadata:</span><span id="236f" class="mj kq it mf b gy mo ml l mm mn">  name: myapp-pod</span><span id="bb69" class="mj kq it mf b gy mo ml l mm mn">  labels:</span><span id="ad28" class="mj kq it mf b gy mo ml l mm mn">    app: myapp</span><span id="36fa" class="mj kq it mf b gy mo ml l mm mn">spec:</span><span id="66cb" class="mj kq it mf b gy mo ml l mm mn">  containers:</span><span id="bcc7" class="mj kq it mf b gy mo ml l mm mn">  - name: myapp-container</span><span id="fe68" class="mj kq it mf b gy mo ml l mm mn">    image: busybox:1.28</span><span id="bd4f" class="mj kq it mf b gy mo ml l mm mn">    command: ['sh', '-c', 'echo The app is running! &amp;&amp; sleep 3600']</span><span id="382f" class="mj kq it mf b gy mo ml l mm mn">    resources:</span><span id="7824" class="mj kq it mf b gy mo ml l mm mn">      limits:</span><span id="8b9e" class="mj kq it mf b gy mo ml l mm mn">        memory: 2G</span></pre><p id="3ab7" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">通过运行<code class="fe mp mq mr mf b">kubectl describe resourcequota demo-resourcequota</code>，可以看到2GB的内存限制已经用完了配置的配额。</p><figure class="lt lu lv lw gt lx gh gi paragraph-image"><div role="button" tabindex="0" class="ly lz di ma bf mb"><div class="gh gi ms"><img src="../Images/a8e693c2c8527f23c3137823e235637d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*uWZpgULtbWzcoUyp.png"/></div></div></figure><p id="eb34" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">当部署另一个内存限制为9GB的pod时，它将失败，因为它将超过10GB的配额。</p><figure class="lt lu lv lw gt lx gh gi paragraph-image"><div role="button" tabindex="0" class="ly lz di ma bf mb"><div class="gh gi mt"><img src="../Images/80a31eb227eec558d270c0984ff15f94.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*hfJ3X0Hbbjy4XjWe.png"/></div></div></figure><p id="326e" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">群集管理员应该配置ResourceQuota中的值，以便不会过度利用节点。</p><p id="89bc" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">在kubernetes集群中，在pod规范中提及资源请求和限制并不是强制性的，如果没有提及，就意味着pod对资源的消耗没有限制。它可以消耗节点中所有可用的资源。因此，不建议跳过pod规范中的资源请求和限制。</p><p id="8f66" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">有了ResourceQuota，如果缺少资源配额所需的请求或资源限制，任何pod创建或更新都将被拒绝。例如，上述资源配额不允许创建或更新没有配置内存资源限制的pod。</p><figure class="lt lu lv lw gt lx gh gi paragraph-image"><div role="button" tabindex="0" class="ly lz di ma bf mb"><div class="gh gi mu"><img src="../Images/22234d11ed8021731353de699661b41e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*fjBhNQPS-nu_tkJp.png"/></div></div></figure><p id="397a" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">为了确保所有的pod都有一些默认的资源请求或限制，我们可以在名称空间中创建LimitRanger。</p><p id="8b55" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">LimitRanger也是一个准入控制器，它将参与变异阶段。如果任何pod规范没有资源请求或限制，它将添加相同名称空间的LimitRanger中提到的资源请求和限制。</p><p id="330b" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">在命名空间中创建LimitRanger，如下所示:</p><pre class="lt lu lv lw gt me mf mg mh aw mi bi"><span id="f095" class="mj kq it mf b gy mk ml l mm mn">apiVersion: v1</span><span id="7d15" class="mj kq it mf b gy mo ml l mm mn">kind: LimitRange</span><span id="bf93" class="mj kq it mf b gy mo ml l mm mn">metadata:</span><span id="5683" class="mj kq it mf b gy mo ml l mm mn">  name: default-requests-limits</span><span id="9fa9" class="mj kq it mf b gy mo ml l mm mn">  namespace: demo</span><span id="d33a" class="mj kq it mf b gy mo ml l mm mn">spec:</span><span id="cb08" class="mj kq it mf b gy mo ml l mm mn">  limits:</span><span id="f63d" class="mj kq it mf b gy mo ml l mm mn">  - default:</span><span id="8c86" class="mj kq it mf b gy mo ml l mm mn">      memory: 1Gi</span><span id="8422" class="mj kq it mf b gy mo ml l mm mn">    defaultRequest:</span><span id="96f0" class="mj kq it mf b gy mo ml l mm mn">      memory: 500Mi</span><span id="bdba" class="mj kq it mf b gy mo ml l mm mn">    type: Container</span></pre><p id="40a6" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">然后在相同的名称空间中应用没有资源请求和限制的pod，如下所示:</p><pre class="lt lu lv lw gt me mf mg mh aw mi bi"><span id="29d5" class="mj kq it mf b gy mk ml l mm mn">apiVersion: v1</span><span id="74e8" class="mj kq it mf b gy mo ml l mm mn">kind: Pod</span><span id="a682" class="mj kq it mf b gy mo ml l mm mn">metadata:</span><span id="4087" class="mj kq it mf b gy mo ml l mm mn">name: myapp-no-resources-pod</span><span id="0e2f" class="mj kq it mf b gy mo ml l mm mn">labels:</span><span id="085b" class="mj kq it mf b gy mo ml l mm mn">app: myapp</span><span id="1350" class="mj kq it mf b gy mo ml l mm mn">spec:</span><span id="5987" class="mj kq it mf b gy mo ml l mm mn">containers:</span><span id="1417" class="mj kq it mf b gy mo ml l mm mn">- name: myapp-container</span><span id="a48a" class="mj kq it mf b gy mo ml l mm mn">image: busybox:1.28</span><span id="a74d" class="mj kq it mf b gy mo ml l mm mn">command: ['sh', '-c', 'echo The app is running! &amp;&amp; sleep 3600']</span></pre><p id="54eb" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">现在，获取运行在K8s集群中的上述pod的yaml。LimitRanger <code class="fe mp mq mr mf b">default-requests-limits</code>中提到的资源请求和限制被添加到<code class="fe mp mq mr mf b">.spec.resources</code>中。</p><pre class="lt lu lv lw gt me mf mg mh aw mi bi"><span id="7575" class="mj kq it mf b gy mk ml l mm mn">...</span><span id="bf55" class="mj kq it mf b gy mo ml l mm mn">spec:</span><span id="17a2" class="mj kq it mf b gy mo ml l mm mn">  containers:</span><span id="4afe" class="mj kq it mf b gy mo ml l mm mn">  - command:</span><span id="0577" class="mj kq it mf b gy mo ml l mm mn">    - sh</span><span id="b8e8" class="mj kq it mf b gy mo ml l mm mn">    - -c</span><span id="84b3" class="mj kq it mf b gy mo ml l mm mn">    - echo The app is running! &amp;&amp; sleep 3600</span><span id="3fd2" class="mj kq it mf b gy mo ml l mm mn">    image: busybox:1.28</span><span id="5ddc" class="mj kq it mf b gy mo ml l mm mn">    imagePullPolicy: IfNotPresent</span><span id="bb45" class="mj kq it mf b gy mo ml l mm mn">    name: myapp-container</span><span id="0578" class="mj kq it mf b gy mo ml l mm mn">    resources:</span><span id="318d" class="mj kq it mf b gy mo ml l mm mn">      limits:</span><span id="736d" class="mj kq it mf b gy mo ml l mm mn">        memory: 1G</span><span id="c25f" class="mj kq it mf b gy mo ml l mm mn">      requests:</span><span id="8dd6" class="mj kq it mf b gy mo ml l mm mn">        memory: 500Mi</span><span id="eab2" class="mj kq it mf b gy mo ml l mm mn">...</span></pre><p id="0c87" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">再次运行<code class="fe mp mq mr mf b">kubectl describe resourcequota demo-resourcequota</code>并查看3GB内存限制已超出配置的配额。</p><figure class="lt lu lv lw gt lx gh gi paragraph-image"><div role="button" tabindex="0" class="ly lz di ma bf mb"><div class="gh gi mv"><img src="../Images/cc57ec072fb03595ba50e32417404c38.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*-rOsZwpPQfQomsBO.png"/></div></div></figure><h1 id="388f" class="kp kq it bd kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm bi translated">结论</h1><p id="cc7d" class="pw-post-body-paragraph jq jr it js b jt ln jv jw jx lo jz ka kb lp kd ke kf lq kh ki kj lr kl km kn im bi translated">因此，根据需求配置ResourceQuota和LimitRanger，Kubernetes集群中的所有应用程序都可以避免嘈杂的邻居问题和拒绝服务</p></div><div class="ab cl mw mx hx my" role="separator"><span class="mz bw bk na nb nc"/><span class="mz bw bk na nb nc"/><span class="mz bw bk na nb"/></div><div class="im in io ip iq"><p id="09e9" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><em class="nd">原发布于</em><a class="ae ko" href="https://www.prabhujayakumar.dev/blog/save-your-k8s-cluster-from-dos/" rel="noopener ugc nofollow" target="_blank"><em class="nd">https://www . prabhujayakumar . dev</em></a><em class="nd">。</em></p></div></div>    
</body>
</html>