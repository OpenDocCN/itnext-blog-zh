<html>
<head>
<title>Authentication Using JWT in MEAN Stack</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在均值堆栈中使用JWT的认证</h1>
<blockquote>原文：<a href="https://itnext.io/authentication-using-jwt-in-mean-stack-6b425247b7d8?source=collection_archive---------2-----------------------#2020-09-27">https://itnext.io/authentication-using-jwt-in-mean-stack-6b425247b7d8?source=collection_archive---------2-----------------------#2020-09-27</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="8170" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">GitHub网址:<a class="ae kl" href="https://github.com/mehulk05/Blog-using-mean" rel="noopener ugc nofollow" target="_blank">T3【https://github.com/mehulk05/Blog-using-mean】T5</a></p><p id="3a38" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现场试玩:<a class="ae kl" href="https://mehulk05.github.io/Blog-using-mean/#/" rel="noopener ugc nofollow" target="_blank"><strong class="jp ir">https://mehulk05.github.io/Blog-using-mean/#/</strong></a></p><p id="6a17" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">博客:<strong class="jp ir"/><a class="ae kl" href="https://blogs-by-mehul.blogspot.com/2021/01/authentication-using-jwt-in-mean-stack.html" rel="noopener ugc nofollow" target="_blank"><strong class="jp ir">https://blogs-by-mehul . blogspot . com/2021/01/authentic ation-using-jwt-in-mean-stack . html</strong></a></p><h1 id="bb75" class="km kn iq bd ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj bi translated">现场演示</h1><figure class="ll lm ln lo gt lp gh gi paragraph-image"><div class="gh gi lk"><img src="../Images/98c4354c84e5831dec669b91cea6c064.png" data-original-src="https://miro.medium.com/v2/resize:fit:1280/1*KvjQDIN5ZUO4iTHvr0BLBA.gif"/></div><figcaption class="ls lt gj gh gi lu lv bd b be z dk translated">认证演示</figcaption></figure><p id="b1ad" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><a class="ae kl" href="https://jwt.io/" rel="noopener ugc nofollow" target="_blank"> JSON Web Token </a>是在你的MEAN stack应用中实现认证系统的最佳标准之一。在这篇文章中，我们将只是看看在平均堆栈应用程序中使用JWT认证。</p><h1 id="6877" class="km kn iq bd ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj bi translated">什么是JSON Web Token？</h1><p id="debc" class="pw-post-body-paragraph jn jo iq jp b jq lw js jt ju lx jw jx jy ly ka kb kc lz ke kf kg ma ki kj kk ij bi translated">JSON Web Token (JWT)是一个开放标准(<a class="ae kl" href="https://tools.ietf.org/html/rfc7519" rel="noopener ugc nofollow" target="_blank"> RFC 7519 </a>)，它定义了一种紧凑且独立的方式，以JSON对象的形式在各方之间安全地传输信息</p><h1 id="b331" class="km kn iq bd ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj bi translated">什么时候应该使用JSON Web令牌？</h1><p id="177a" class="pw-post-body-paragraph jn jo iq jp b jq lw js jt ju lx jw jx jy ly ka kb kc lz ke kf kg ma ki kj kk ij bi translated">以下是JSON Web令牌有用的一些场景:</p><ul class=""><li id="8a78" class="mb mc iq jp b jq jr ju jv jy md kc me kg mf kk mg mh mi mj bi translated">授权:这是使用JWT最常见的场景。用户登录后，每个后续请求都将包含JWT，允许用户访问该令牌允许的路由、服务和资源。单点登录是目前广泛使用JWT的一个特性，因为它的开销很小，并且能够很容易地跨不同的域使用。</li><li id="40be" class="mb mc iq jp b jq mk ju ml jy mm kc mn kg mo kk mg mh mi mj bi translated"><strong class="jp ir">信息交换</strong> : JSON Web令牌是一种安全传输信息的好方法。</li></ul><p id="57e1" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在其紧凑的形式中，JSON Web令牌由点(<code class="fe mp mq mr ms b">.</code>)分隔的三个部分组成，它们是:</p><ul class=""><li id="9768" class="mb mc iq jp b jq jr ju jv jy md kc me kg mf kk mg mh mi mj bi translated">页眉</li><li id="ca5a" class="mb mc iq jp b jq mk ju ml jy mm kc mn kg mo kk mg mh mi mj bi translated">有效载荷</li><li id="1f07" class="mb mc iq jp b jq mk ju ml jy mm kc mn kg mo kk mg mh mi mj bi translated">签名</li></ul><p id="42fd" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">因此，JWT通常如下所示。</p><p id="3ac1" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><code class="fe mp mq mr ms b">xxxxx.yyyyy.zzzzz</code></p><p id="b484" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">因为jwt可以被签名——例如，使用公钥/私钥对——所以您可以确保发送者就是他们所说的那个人。此外，由于签名是使用头部和有效载荷计算的，因此您还可以验证内容没有被篡改。</p><h1 id="26ce" class="km kn iq bd ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj bi translated">服务器端部分:创建一个JWT</h1><figure class="ll lm ln lo gt lp"><div class="bz fp l di"><div class="mt mu l"/></div></figure><p id="66f9" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">所以代码片段有一个注册路径，它将检查用户是否存在。如果用户不存在，它将进一步使用bycrypt模块加密密码，并在创建完用户后返回200状态码。</p><p id="78ab" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">下一步是登录路径，这里它将检查用户的电子邮件和密码是否匹配。如果在这里找到匹配的用户，我们将执行一个重要的步骤。在这里，我们将创建我们的JWT令牌。</p><pre class="ll lm ln lo gt mv ms mw mx aw my bi"><span id="6483" class="mz kn iq ms b gy na nb l nc nd">const token = jwt.sign(<br/>        { email: fetchedUser.email, userId: fetchedUser._id },<br/>        "secret_this_should_be_longer",<br/>        { expiresIn: "1h" }<br/>      );</span><span id="58cf" class="mz kn iq ms b gy ne nb l nc nd">res.status(200).json({<br/>        token: token,<br/>        expiresIn: 3600,<br/>        userId: fetchedUser._id<br/>      });</span></pre><ul class=""><li id="cdf7" class="mb mc iq jp b jq jr ju jv jy md kc me kg mf kk mg mh mi mj bi translated">因此，我们在这里创建JWT令牌，其中“sign”方法的第一个参数是需要放入有效负载(然后放入令牌本身)的信息。</li><li id="1dd6" class="mb mc iq jp b jq mk ju ml jy mm kc mn kg mo kk mg mh mi mj bi translated">第二个参数是用于创建摘要的密钥。</li><li id="0b14" class="mb mc iq jp b jq mk ju ml jy mm kc mn kg mo kk mg mh mi mj bi translated">第三是期权表示。在本例中，我以秒为单位设置了令牌的到期日期。</li></ul><h1 id="33e4" class="km kn iq bd ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj bi translated">服务器端部分:检查和验证一个JWT(中间件)</h1><pre class="ll lm ln lo gt mv ms mw mx aw my bi"><span id="554d" class="mz kn iq ms b gy na nb l nc nd">// <strong class="ms ir">check-auth.js </strong><br/>const jwt = require("jsonwebtoken");</span><span id="6496" class="mz kn iq ms b gy ne nb l nc nd">module.exports = (req, res, next) =&gt; {<br/>  try {</span><span id="f5cd" class="mz kn iq ms b gy ne nb l nc nd"> const token = req.headers.authorization.split(" ")[1];<br/> const decodedToken = jwt.verify(<br/>   token,<br/>   "secret_this_should_be_longer"<br/>);</span><span id="672f" class="mz kn iq ms b gy ne nb l nc nd"> req.userData = {<br/>         email: decodedToken.email,<br/>         userId: decodedToken.userId <br/>   };</span><span id="9790" class="mz kn iq ms b gy ne nb l nc nd">    next();<br/>  } catch (error) {<br/>    res.status(401).json({ message: "Auth failed!" });<br/>  }<br/>};</span></pre><p id="475e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这里是另一个Node.js片段，用<a class="ae kl" href="https://expressjs.com/" rel="noopener ugc nofollow" target="_blank"> Express.js </a>中间件实现，它拦截所有请求并检查JWT的存在。</p><p id="a092" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们使用一个常见的实现，它期望将JWT传递到HTTP头中，以检查令牌是否包含所需的数据</p><p id="0bb2" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">作为验证例程的结果，如果令牌过期，我们将发送HTTP 401 Unauthorized，如果报头中缺少令牌，我们将发送HTTP 400 Bad请求。</p><h1 id="04ab" class="km kn iq bd ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj bi translated">客户端部分:</h1><p id="f4ec" class="pw-post-body-paragraph jn jo iq jp b jq lw js jt ju lx jw jx jy ly ka kb kc lz ke kf kg ma ki kj kk ij bi translated">在客户端，我们使用angular作为我们的前端。这里我们有两个选择。首先，我们可以使用HTTP拦截器将令牌附加到每个Http请求上。第二，我们可以在服务文件中附加令牌，仅用于登录和注册请求。此后，我们可以有身份验证，对于post请求，我们可以在后端使用我们的中间件。</p><figure class="ll lm ln lo gt lp"><div class="bz fp l di"><div class="mt mu l"/></div></figure><h1 id="41d5" class="km kn iq bd ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj bi translated">通过AJAX通信，使用角度拦截器添加JWT</h1><figure class="ll lm ln lo gt lp"><div class="bz fp l di"><div class="mt mu l"/></div></figure><p id="df16" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在这个代码片段中，我们使用了一个<a class="ae kl" href="https://angular.io/api/common/http/HttpInterceptor" rel="noopener ugc nofollow" target="_blank">角度拦截器</a>，这是一个将令牌附加到每个HTTP请求的好方法。</p><p id="32f3" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">有一些关于如何使用拦截器的注释，所有的注释都是依赖于应用程序上下文的，所以把这个片段看作是一个关于如何添加它的例子。</p><p id="19ab" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">正如您所看到的，我们使用了名为“authorization”的HTTP头和“Bearer”前缀，因为服务器希望它后面跟着我们从后端接收到的令牌。</p><p id="d1b9" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在本例中，我们在本地存储中存储和读取令牌。像以前一样，这只是一个想法，你可能更喜欢一个<code class="fe mp mq mr ms b">SessionStorage</code>或其他东西。</p><h1 id="ad36" class="km kn iq bd ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj bi translated">如果用户通过身份验证，将后端限制为只能读写</h1><p id="1dbb" class="pw-post-body-paragraph jn jo iq jp b jq lw js jt ju lx jw jx jy ly ka kb kc lz ke kf kg ma ki kj kk ij bi translated">此外，如果我们想限制我们的后端只读写数据库，只有当用户被认证，我们可以使用我们创建的中间件做到这一点。查看下面的片段。</p><pre class="ll lm ln lo gt mv ms mw mx aw my bi"><span id="2d8a" class="mz kn iq ms b gy na nb l nc nd">router.get("/mypost", <br/>checkAuth,<br/>(req, res, next) =&gt; {<br/>    Post.find({creator: req.userData.userId}).then(post =&gt; {<br/>      if (post) {<br/>        res.status(200).json({<br/>            message: "Posts fetched successfully!",<br/>            posts: post<br/>        });<br/>      }<br/>    })<br/>    .catch(e=&gt;{<br/>        console.log(e)<br/>    });<br/>  });<br/></span></pre><p id="b056" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这里的<strong class="jp ir"> checkAuth </strong>是我们已经创建的中间件，它将检查请求中的令牌。</p><pre class="ll lm ln lo gt mv ms mw mx aw my bi"><span id="6923" class="mz kn iq ms b gy na nb l nc nd">{creator: req.userData.userId}</span></pre><p id="f2b2" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在上面的代码行中，我们从中间件中获取创建者，我们将解码后的令牌存储在userID中。如果令牌存在，则只处理请求。</p><h1 id="d2f0" class="km kn iq bd ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj bi translated">演示:</h1><figure class="ll lm ln lo gt lp gh gi paragraph-image"><div role="button" tabindex="0" class="ng nh di ni bf nj"><div class="gh gi nf"><img src="../Images/d7f1f6af49ed0dc49026ccfb7e2a1a18.png" data-original-src="https://miro.medium.com/v2/resize:fit:1342/format:webp/1*WN31y8TbltAeJR2B5PVEfA.png"/></div></div><figcaption class="ls lt gj gh gi lu lv bd b be z dk translated">认证演示</figcaption></figure><figure class="ll lm ln lo gt lp gh gi paragraph-image"><div class="gh gi nk"><img src="../Images/306f9089bd814b7a76041a48183fd9d7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1230/format:webp/1*gUXa7Qy-rs-u_EBiQ1QC0w.png"/></div><figcaption class="ls lt gj gh gi lu lv bd b be z dk translated">演示:用户名或密码不正确</figcaption></figure><figure class="ll lm ln lo gt lp gh gi paragraph-image"><div class="gh gi nl"><img src="../Images/d2d627da489840f6d7d798aff875b55c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1386/format:webp/1*nivJ5bPE_ED-9FbGoI8Sbg.png"/></div><figcaption class="ls lt gj gh gi lu lv bd b be z dk translated">演示:登录后的令牌</figcaption></figure><h1 id="fa67" class="km kn iq bd ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj bi translated">结论</h1><p id="fcf0" class="pw-post-body-paragraph jn jo iq jp b jq lw js jt ju lx jw jx jy ly ka kb kc lz ke kf kg ma ki kj kk ij bi translated">JSON Web Token得到了很好的支持。在<a class="ae kl" href="https://jwt.io/" rel="noopener ugc nofollow" target="_blank">官网</a>上，你可以找到几乎任何语言的库和工具来使用它，从<a class="ae kl" href="https://www.python.org/" rel="noopener ugc nofollow" target="_blank"> Python </a>到。NET apps，以及<a class="ae kl" href="https://www.java.com/" rel="noopener ugc nofollow" target="_blank"> Java </a>到Node.js .这里我们已经使用MEAN stack app完成了完整的认证系统。</p><p id="9e8f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">您将需要几个小时来实现一个健壮的身份验证方法，但这绝对是值得的。您可以在下面找到相同代码的Github repo</p><div class="nm nn gp gr no np"><a href="https://github.com/mehulk05/Blog-using-mean" rel="noopener  ugc nofollow" target="_blank"><div class="nq ab fo"><div class="nr ab ns cl cj nt"><h2 class="bd ir gy z fp nu fr fs nv fu fw ip bi translated">mehulk 05/博客使用均值</h2><div class="nw l"><h3 class="bd b gy z fp nu fr fs nv fu fw dk translated">此时您不能执行该操作。您已使用另一个标签页或窗口登录。您已在另一个选项卡中注销，或者…</h3></div><div class="nx l"><p class="bd b dl z fp nu fr fs nv fu fw dk translated">github.com</p></div></div><div class="ny l"><div class="nz l oa ob oc ny od lq np"/></div></div></a></div><p id="872e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">此外，阅读使用平均堆栈的CRUD操作</strong></p><div class="nm nn gp gr no np"><a href="https://medium.com/@mehulkothari05/crud-operation-using-mean-stack-7dfa2f51ec8c" rel="noopener follow" target="_blank"><div class="nq ab fo"><div class="nr ab ns cl cj nt"><h2 class="bd ir gy z fp nu fr fs nv fu fw ip bi translated">使用平均堆栈的CRUD操作</h2><div class="nw l"><h3 class="bd b gy z fp nu fr fs nv fu fw dk translated">github:https://github . com/me hulk 05/Blog-using-mean</h3></div><div class="nx l"><p class="bd b dl z fp nu fr fs nv fu fw dk translated">medium.com</p></div></div><div class="ny l"><div class="oe l oa ob oc ny od lq np"/></div></div></a></div></div></div>    
</body>
</html>