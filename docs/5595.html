<html>
<head>
<title>Image Classification API With NodeJS, TensorflowJS, And MobileNet Model</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">具有NodeJS、TensorflowJS和MobileNet模型的影像分类API</h1>
<blockquote>原文：<a href="https://itnext.io/image-classification-api-with-nodejs-tensorflowjs-and-mobilenet-model-45e3a79a5876?source=collection_archive---------2-----------------------#2021-04-12">https://itnext.io/image-classification-api-with-nodejs-tensorflowjs-and-mobilenet-model-45e3a79a5876?source=collection_archive---------2-----------------------#2021-04-12</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/9820fc216dfbbb05c2050a29dd9454e5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*VYqTeLeBMufNxCU4TVh67w.png"/></div></div></figure><p id="ce59" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">现在，通过TensorFlow.js，开发人员可以使用JavaScript轻松运行机器学习模型。使用<a class="ae kw" href="https://github.com/tensorflow/tfjs-models/" rel="noopener ugc nofollow" target="_blank">预先训练的模型</a>，您可以轻松完成复杂的任务，不需要从头开始构建模型的知识。</p><p id="e629" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">TensorFlow.js首次作为web浏览器的前端库。但是现在，<a class="ae kw" href="https://github.com/tensorflow/tfjs" rel="noopener ugc nofollow" target="_blank"> tfjs </a>(又名TensorFlow.js)支持在后端JavaScript — Nodejs中使用。这意味着您可以通过Nodejs而不是Python创建一个可以使用TensorFlow模型的web服务。</p><p id="b1f8" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">按照<a class="ae kw" href="https://github.com/tensorflow/tfjs-models/tree/master/mobilenet#via-npm" rel="noopener ugc nofollow" target="_blank">这个示例代码</a>，我们将构建一个包含API的web服务。API将返回用户上传到服务器的图像的分类。</p><p id="f95f" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">这个项目基于<a class="ae kw" href="https://levelup.gitconnected.com/tdd-with-typescript-and-jest-starter-project-cca94fd089f5" rel="noopener ugc nofollow" target="_blank">这篇文章</a>，需要你关于Typescript，Nodejs，Express的知识。</p><h1 id="a17e" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">带有express的简单web服务</h1><p id="9153" class="pw-post-body-paragraph jy jz iq ka b kb lv kd ke kf lw kh ki kj lx kl km kn ly kp kq kr lz kt ku kv ij bi translated">这部分的目标是创建一个api来处理文件上传到expressjs服务器。</p><p id="56b7" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">结帐代码库:</p><pre class="ma mb mc md gt me mf mg mh aw mi bi"><span id="d841" class="mj ky iq mf b gy mk ml l mm mn">$ git clone <a class="ae kw" href="https://github.com/hoangsetup/ts-jest-tdd-starter.git" rel="noopener ugc nofollow" target="_blank">https://github.com/hoangsetup/ts-jest-tdd-starter.git</a> ts-image-classification</span><span id="189b" class="mj ky iq mf b gy mo ml l mm mn">// Open project with VSCode<br/>$ code ts-image-classification</span></pre><p id="f3fe" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">安装依赖项:</p><pre class="ma mb mc md gt me mf mg mh aw mi bi"><span id="17c0" class="mj ky iq mf b gy mk ml l mm mn">$ npm install express express-fileupload -S</span><span id="5ee3" class="mj ky iq mf b gy mo ml l mm mn">// Install type definations, dev helper<br/>$ npm install @types/express @types/express-fileupload nodemon -D</span></pre><p id="0ba9" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我用<a class="ae kw" href="https://www.npmjs.com/package/express-fileupload" rel="noopener ugc nofollow" target="_blank"> express-fileupload </a>来处理上传文件，你可以用你喜欢的包。</p><p id="9b54" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">快速申请:</p><pre class="ma mb mc md gt me mf mg mh aw mi bi"><span id="6cf3" class="mj ky iq mf b gy mk ml l mm mn">// src/app.ts<br/>import express from 'express';<br/>import fileUpload from 'express-fileupload';<br/>import controller from './image-classification/controller';</span><span id="6140" class="mj ky iq mf b gy mo ml l mm mn">const app = express();<br/>app.use(fileUpload());</span><span id="ff06" class="mj ky iq mf b gy mo ml l mm mn">app.post('/classify', controller.classifyImage);</span><span id="cf67" class="mj ky iq mf b gy mo ml l mm mn">export default app;</span></pre><p id="2d8e" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">这是一个简单的express应用程序，我们只有一条路线— <code class="fe mp mq mr mf b">POST /classify</code>。这个文件中重要的事情是应用<code class="fe mp mq mr mf b">fileUpload</code>中间件。</p><p id="4d79" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">服务器:</p><pre class="ma mb mc md gt me mf mg mh aw mi bi"><span id="5093" class="mj ky iq mf b gy mk ml l mm mn">// src/server.ts<br/>import app from './app';</span><span id="6189" class="mj ky iq mf b gy mo ml l mm mn">const port = process.env.PORT || 3000;<br/>app.listen(port, () =&gt; {<br/>  console.log(`Server is listening on: ${port}`);<br/>});</span></pre><p id="e968" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">控制器:</p><pre class="ma mb mc md gt me mf mg mh aw mi bi"><span id="5bdc" class="mj ky iq mf b gy mk ml l mm mn">// src/image-classification/controller.ts<br/>import { Request, Response } from 'express';<br/>import { UploadedFile } from 'express-fileupload';</span><span id="c7e7" class="mj ky iq mf b gy mo ml l mm mn">class Controller {<br/>  async classifyImage(req: Request, res: Response) {<br/>    const imageObject = req.files?.image as UploadedFile;<br/>    res.json({ filename: imageObject.name });<br/>  }<br/>}</span><span id="047e" class="mj ky iq mf b gy mo ml l mm mn">export default new Controller();</span></pre><p id="1a99" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">使用nodemon监视和重启应用程序:</p><pre class="ma mb mc md gt me mf mg mh aw mi bi"><span id="b49f" class="mj ky iq mf b gy mk ml l mm mn">// nodemon.json<br/>{<br/>  "watch": [<br/>    "src"<br/>  ],<br/>  "ext": "ts",<br/>  "ignore": [<br/>    "dist",<br/>    "node_modules",<br/>    ".git",<br/>    "src/**/*.spec.ts"<br/>  ],<br/>  "exec": "ts-node ./src/server.ts"<br/>}</span></pre><p id="f0f5" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">现在，以监视模式启动服务器:</p><pre class="ma mb mc md gt me mf mg mh aw mi bi"><span id="e927" class="mj ky iq mf b gy mk ml l mm mn">$ npx nodemon</span><span id="9ad6" class="mj ky iq mf b gy mo ml l mm mn">[nodemon] restarting due to changes...<br/>[nodemon] starting `ts-node ./src/server.ts`<br/>Server is listening on: 3000</span></pre><p id="60f9" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">尝试上传一个文件到服务，向<code class="fe mp mq mr mf b">POST /classify</code>发送一个请求，请求体为<code class="fe mp mq mr mf b">form-data</code>，其中包含一个关键字<code class="fe mp mq mr mf b">image</code>:</p><pre class="ma mb mc md gt me mf mg mh aw mi bi"><span id="ad66" class="mj ky iq mf b gy mk ml l mm mn">$ curl --location --request POST 'localhost:3000/classify' \<br/>--form 'image=@"/absolute_path_to_file/rabbit.png"'</span><span id="fffc" class="mj ky iq mf b gy mo ml l mm mn">{"filename":"rabbit.png"}</span></pre><h1 id="414e" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">带有MobileNet模型的TFJS</h1><p id="7099" class="pw-post-body-paragraph jy jz iq ka b kb lv kd ke kf lw kh ki kj lx kl km kn ly kp kq kr lz kt ku kv ij bi translated">安装依赖项:</p><pre class="ma mb mc md gt me mf mg mh aw mi bi"><span id="245c" class="mj ky iq mf b gy mk ml l mm mn">$ npm install @tensorflow/tfjs @tensorflow/tfjs-node @tensorflow-models/mobilenet</span></pre><ul class=""><li id="e3e0" class="ms mt iq ka b kb kc kf kg kj mu kn mv kr mw kv mx my mz na bi translated">@tensorflow/tfjs — <a class="ae kw" href="https://www.npmjs.com/package/@tensorflow/tfjs" rel="noopener ugc nofollow" target="_blank">核心TensorFlow.js库</a></li><li id="9312" class="ms mt iq ka b kb nb kf nc kj nd kn ne kr nf kv mx my mz na bi translated">@ tensor flow/tfjs-node—<a class="ae kw" href="https://www.npmjs.com/package/@tensorflow/tfjs-node" rel="noopener ugc nofollow" target="_blank">tensor flow . js node . js扩展</a></li><li id="3f58" class="ms mt iq ka b kb nb kf nc kj nd kn ne kr nf kv mx my mz na bi translated">@ tensor flow-models/mobilenet—<a class="ae kw" href="https://github.com/tensorflow/tfjs-models/tree/master/mobilenet" rel="noopener ugc nofollow" target="_blank">用于图像分类的MobileNet模型</a>是一个深度神经网络，经过训练可以<a class="ae kw" href="https://github.com/tensorflow/tfjs-models/blob/master/mobilenet/src/imagenet_classes.ts" rel="noopener ugc nofollow" target="_blank">识别1000个不同的类别</a>。</li></ul><h2 id="180a" class="mj ky iq bd kz ng nh dn ld ni nj dp lh kj nk nl ll kn nm nn lp kr no np lt nq bi translated">加载张量流模型</h2><p id="6937" class="pw-post-body-paragraph jy jz iq ka b kb lv kd ke kf lw kh ki kj lx kl km kn ly kp kq kr lz kt ku kv ij bi translated">在mobilenet的自述文件中，下面的示例代码<a class="ae kw" href="https://github.com/tensorflow/tfjs-models/tree/master/mobilenet#via-npm" rel="noopener ugc nofollow" target="_blank">用于加载模型。</a></p><pre class="ma mb mc md gt me mf mg mh aw mi bi"><span id="d8b0" class="mj ky iq mf b gy mk ml l mm mn">import * as mobilenet from '@tensorflow-models/mobilenet';<br/><br/>// Load the model<br/>const model = await mobilenet.load();</span></pre><p id="c6f1" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">默认模型— <a class="ae kw" href="https://github.com/tensorflow/models/blob/master/research/slim/nets/mobilenet_v1.md" rel="noopener ugc nofollow" target="_blank">将加载MobileNet_v1_1.0_224 </a>。模型由<a class="ae kw" href="https://tfhub.dev/google/tfjs-model/imagenet/mobilenet_v1_100_224/classification/1/default/1" rel="noopener ugc nofollow" target="_blank"> tfhub.dev </a>提供。</p><p id="d523" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我们可以通过向<code class="fe mp mq mr mf b">load</code>函数提供option对象来决定加载哪个模型版本，如下图所示:</p><pre class="ma mb mc md gt me mf mg mh aw mi bi"><span id="50e1" class="mj ky iq mf b gy mk ml l mm mn">mobilenetModel = await mobilenet.load({<br/>    version: 1 | 2,<br/>    alpha?: 0.25 | .50 | .75 | 1.0,<br/>    modelUrl?: string<br/>    inputRange?: [number, number]<br/>  }<br/>)</span></pre><h2 id="6a58" class="mj ky iq bd kz ng nh dn ld ni nj dp lh kj nk nl ll kn nm nn lp kr no np lt nq bi translated">从本地加载张量流模型</h2><p id="014e" class="pw-post-body-paragraph jy jz iq ka b kb lv kd ke kf lw kh ki kj lx kl km kn ly kp kq kr lz kt ku kv ij bi translated">如果我们想使用自己创建的自定义模型，或者只是想在没有互联网连接的情况下提供服务。或者在我的例子中，<code class="fe mp mq mr mf b">load</code>函数花了很多时间来下载模型，有时会出现<code class="fe mp mq mr mf b">Timed out</code>错误。</p><p id="6adf" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">对于这种情况，我们必须更新<code class="fe mp mq mr mf b">load</code>函数的选项来触发文件系统加载器，而不是尝试使用HTTP请求加载器。</p><pre class="ma mb mc md gt me mf mg mh aw mi bi"><span id="b97a" class="mj ky iq mf b gy mk ml l mm mn">mobilenetModel = await mobilenet.load({<br/>  version: 2,<br/>  alpha: 1.0,<br/>  modelUrl:<br/>  'file://absolute_path_to_the_model/model.json',<br/>});</span></pre><p id="3ee3" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">从<a class="ae kw" href="https://tfhub.dev" rel="noopener ugc nofollow" target="_blank"> https://tfhub.dev </a>中找到并下载模型，比如我们使用<a class="ae kw" href="https://tfhub.dev/google/tfjs-model/imagenet/mobilenet_v1_100_224/classification/1/default/1" rel="noopener ugc nofollow" target="_blank"> mobilenet_v1_100_224 </a>模型。</p><figure class="ma mb mc md gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nr"><img src="../Images/7b772f60cda78db643ec5955dbe6b198.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*7cj18xME7KGtVI6rGWg_XQ.png"/></div></div><figcaption class="ns nt gj gh gi nu nv bd b be z dk translated">JS的下载模型</figcaption></figure><p id="4193" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">将下载的模型提取到某个地方，然后将绝对路径更新为“file://absolute _ path _ to _ the _ model/model . JSON ”(需要file:// protocol)。</p><h2 id="ee5f" class="mj ky iq bd kz ng nh dn ld ni nj dp lh kj nk nl ll kn nm nn lp kr no np lt nq bi translated">Mobilenet分类</h2><p id="55e5" class="pw-post-body-paragraph jy jz iq ka b kb lv kd ke kf lw kh ki kj lx kl km kn ly kp kq kr lz kt ku kv ij bi translated">我们必须从图像缓冲区生成Tensor3D。现在@tensorflow/tfjs-node支持用<code class="fe mp mq mr mf b">decodeImage</code>函数来完成，而不是通过“手动”来完成。</p><pre class="ma mb mc md gt me mf mg mh aw mi bi"><span id="7533" class="mj ky iq mf b gy mk ml l mm mn">const tfimage = tfnode.node.decodeImage(imageBuffer) as tfnode.Tensor3D;</span></pre><p id="28c3" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">然后只需通过<code class="fe mp mq mr mf b">tfimage</code>到<code class="fe mp mq mr mf b">classify</code>函数加载移动网络模型</p><pre class="ma mb mc md gt me mf mg mh aw mi bi"><span id="77fd" class="mj ky iq mf b gy mk ml l mm mn">mobilenetModel.classify(tfimage);</span></pre><p id="a06c" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我们不需要在对一幅图像进行分类时每次都加载模型。让我们将模型缓存到一个变量中。</p><p id="e929" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">完整代码:</p><p id="4234" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><code class="fe mp mq mr mf b">src/utils/mobilenet-classification.util.ts</code></p><figure class="ma mb mc md gt jr"><div class="bz fp l di"><div class="nw nx l"/></div></figure><h1 id="ca42" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">获得预测</h1><p id="5b2d" class="pw-post-body-paragraph jy jz iq ka b kb lv kd ke kf lw kh ki kj lx kl km kn ly kp kq kr lz kt ku kv ij bi translated">这是本文的最后一部分，只是把所有的事情联系在一起。</p><p id="398a" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在控制器中，让我们将上传的图像传递给<code class="fe mp mq mr mf b">MobilenetClassifiction</code>实例的分类函数。</p><p id="1260" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><code class="fe mp mq mr mf b">src/controller.ts</code></p><figure class="ma mb mc md gt jr"><div class="bz fp l di"><div class="nw nx l"/></div></figure><p id="5967" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">catch块在分类的时候捕捉一些普通的错误，比如:图片太大或者上传的文件不是图片。</p><p id="1d79" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">用一个简单的图片试试我们的服务:</p><figure class="ma mb mc md gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi ny"><img src="../Images/d3389687914ad3ba862f241cd018866b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*CC9oG1nAZ7LbD2ysyldU5w.jpeg"/></div></div><figcaption class="ns nt gj gh gi nu nv bd b be z dk translated">cat.jpg—<a class="ae kw" href="https://www.bbc.com/news/uk-england-stoke-staffordshire-52047832" rel="noopener ugc nofollow" target="_blank">图片来源</a></figcaption></figure><pre class="ma mb mc md gt me mf mg mh aw mi bi"><span id="e258" class="mj ky iq mf b gy mk ml l mm mn">curl --location --request POST 'localhost:3000/classify' \<br/>--form 'image=@"/Users/cat.lover/Downloads/cat.jpg"'</span></pre><p id="808d" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">如果一切正常，下面的输出应该被打印到控制台(格式化)。</p><pre class="ma mb mc md gt me mf mg mh aw mi bi"><span id="b0d6" class="mj ky iq mf b gy mk ml l mm mn">[<br/>    {<br/>        "className": "tabby, tabby cat",<br/>        "probability": 0.4520637094974518<br/>    },<br/>    {<br/>        "className": "tiger cat",<br/>        "probability": 0.24747788906097412<br/>    },<br/>    {<br/>        "className": "Egyptian cat",<br/>        "probability": 0.10491712391376495<br/>    }<br/>]</span></pre><p id="bf12" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">第一个请求将花费更多的时间来加载模型。</p><h1 id="a119" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">摘要</h1><p id="10f4" class="pw-post-body-paragraph jy jz iq ka b kb lv kd ke kf lw kh ki kj lx kl km kn ly kp kq kr lz kt ku kv ij bi translated">正如您所看到的，TFJS和预先训练的模型为Javascript开发人员提供了强大的力量。我们可以用最少的努力和JS代码行来创建一个复杂的机器学习任务的webservice。</p><p id="850d" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">本文使用的源代码发布于<a class="ae kw" href="https://github.com/codetheworld-io/ts-image-classification" rel="noopener ugc nofollow" target="_blank"> Github </a>。</p><p id="c755" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">感谢您的阅读！</p></div></div>    
</body>
</html>