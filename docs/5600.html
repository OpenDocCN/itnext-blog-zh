<html>
<head>
<title>UDP Listener in Swift</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Swift中的UDP监听器</h1>
<blockquote>原文：<a href="https://itnext.io/udp-listener-in-swift-1e4a0c0aa461?source=collection_archive---------1-----------------------#2021-04-14">https://itnext.io/udp-listener-in-swift-1e4a0c0aa461?source=collection_archive---------1-----------------------#2021-04-14</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="3165" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">关于如何用Swift实现UDP监听器的教程。</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/8482858d051fbf3e2d34c4313903b914.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*08X7TNVmkjPhAR7VlNNw1A.png"/></div></div></figure><p id="f7a3" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">在这篇文章中，我将展示使用<a class="ae lq" href="https://developer.apple.com/documentation/network" rel="noopener ugc nofollow" target="_blank">苹果网络框架</a>实现UDP监听器的必要步骤。SwiftUI-View将显示所有传入的UDP消息。所有代码都可以在一个方便的XCode-Playground中找到。</p><p id="04fc" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">“另一边”是一个UDP发送者，我在之前的帖子中已经解释过了:</p><div class="lr ls gp gr lt lu"><a href="https://twissmueller.medium.com/network-framework-swiftui-and-ryze-tello-7b844b8d1225" rel="noopener follow" target="_blank"><div class="lv ab fo"><div class="lw ab lx cl cj ly"><h2 class="bd iu gy z fp lz fr fs ma fu fw is bi translated">使用Swift发送和接收UDP报文</h2><div class="mb l"><h3 class="bd b gy z fp lz fr fs ma fu fw dk translated">苹果网络框架的一个实例</h3></div><div class="mc l"><p class="bd b dl z fp lz fr fs ma fu fw dk translated">twissmueller.medium.com</p></div></div><div class="md l"><div class="me l mf mg mh md mi ks lu"/></div></div></a></div><p id="67c1" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">本文分为以下几个部分:</p><ul class=""><li id="7bcb" class="mj mk it kw b kx ky la lb ld ml lh mm ll mn lp mo mp mq mr bi translated">创建监听器</li><li id="c104" class="mj mk it kw b kx ms la mt ld mu lh mv ll mw lp mo mp mq mr bi translated">接受新连接</li><li id="1d45" class="mj mk it kw b kx ms la mt ld mu lh mv ll mw lp mo mp mq mr bi translated">接收消息</li><li id="a6db" class="mj mk it kw b kx ms la mt ld mu lh mv ll mw lp mo mp mq mr bi translated">启动监听器</li><li id="966b" class="mj mk it kw b kx ms la mt ld mu lh mv ll mw lp mo mp mq mr bi translated">测试监听器</li></ul><p id="17f4" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">我创建了一个XCode-Playground，在SwitUI-View中显示所有收到的消息。这里有一个小视频展示了它的作用。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="mx my l"/></div></figure><p id="f60a" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated"><strong class="kw iu">完整的Xcode游乐场可以从这里下载:</strong><a class="ae lq" href="https://www.buymeacoffee.com/twissmueller/e/28132" rel="noopener ugc nofollow" target="_blank"><strong class="kw iu">Swift中的UDP监听器</strong> </a></p><h2 id="c840" class="mz na it bd nb nc nd dn ne nf ng dp nh ld ni nj nk lh nl nm nn ll no np nq nr bi translated">创建监听器</h2><p id="83d7" class="pw-post-body-paragraph ku kv it kw b kx ns ju kz la nt jx lc ld nu lf lg lh nv lj lk ll nw ln lo lp im bi translated">一切都基于<code class="fe nx ny nz oa b"><a class="ae lq" href="https://developer.apple.com/documentation/network/nwlistener" rel="noopener ugc nofollow" target="_blank">NWListener</a></code>，它被描述为</p><blockquote class="ob oc od"><p id="21a7" class="ku kv oe kw b kx ky ju kz la lb jx lc of le lf lg og li lj lk oh lm ln lo lp im bi translated">"用来监听传入网络连接的对象."</p></blockquote><p id="70c1" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">让我们从实例化一个开始。</p><pre class="kj kk kl km gt oi oa oj ok aw ol bi"><span id="85a1" class="mz na it oa b gy om on l oo op">var listener: NWListener?<br/><br/>do {<br/>    listener = try NWListener(using: .udp, on: port)<br/>} catch {<br/>    print("exception upon creating listener")<br/>}</span></pre><p id="fcbf" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">接下来，需要定义<code class="fe nx ny nz oa b"><a class="ae lq" href="https://developer.apple.com/documentation/network/nwlistener/2998670-stateupdatehandler" rel="noopener ugc nofollow" target="_blank">stateUpdateHandler</a></code>的行为。其描述如下:</p><blockquote class="ob oc od"><p id="6dff" class="ku kv oe kw b kx ky ju kz la lb jx lc of le lf lg og li lj lk oh lm ln lo lp im bi translated">"接收侦听器状态更新的处理程序."</p></blockquote><pre class="kj kk kl km gt oi oa oj ok aw ol bi"><span id="1e13" class="mz na it oa b gy om on l oo op">listener?.stateUpdateHandler = {(newState) in<br/>    switch newState {<br/>    case .ready:<br/>        print("ready")<br/>    default:<br/>        break<br/>    }<br/>}</span></pre><h2 id="2d75" class="mz na it bd nb nc nd dn ne nf ng dp nh ld ni nj nk lh nl nm nn ll no np nq nr bi translated">接受新连接</h2><p id="6f49" class="pw-post-body-paragraph ku kv it kw b kx ns ju kz la nt jx lc ld nu lf lg lh nv lj lk ll nw ln lo lp im bi translated">现在，侦听器可以处理状态更新，但是当一个新的连接被创建时，乐趣就开始了。</p><p id="b2d6" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">需要实现另一个处理程序。它就是<code class="fe nx ny nz oa b"><a class="ae lq" href="https://developer.apple.com/documentation/network/nwlistener/ 2998663-newconnectionhandler" rel="noopener ugc nofollow" target="_blank">newConnectionHandler</a></code>，在文档中解释为</p><blockquote class="ob oc od"><p id="2e8e" class="ku kv oe kw b kx ky ju kz la lb jx lc of le lf lg og li lj lk oh lm ln lo lp im bi translated">"接收入站连接的处理程序."</p></blockquote><p id="e8f1" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">让我们不要忽略连接实际上是“开始”的最后一行。</p><pre class="kj kk kl km gt oi oa oj ok aw ol bi"><span id="5ecc" class="mz na it oa b gy om on l oo op">listener?.newConnectionHandler = {(newConnection) in<br/>    newConnection.stateUpdateHandler = {newState in<br/>        switch newState {<br/>        case .ready:<br/>            print("ready")<br/>        default:<br/>            break<br/>        }<br/>    }<br/>    newConnection.start(queue: DispatchQueue(label: "newconn"))<br/>}</span></pre><h2 id="6753" class="mz na it bd nb nc nd dn ne nf ng dp nh ld ni nj nk lh nl nm nn ll no np nq nr bi translated">接收消息</h2><p id="7a3a" class="pw-post-body-paragraph ku kv it kw b kx ns ju kz la nt jx lc ld nu lf lg lh nv lj lk ll nw ln lo lp im bi translated">当连接就绪时，需要为<a class="ae lq" href="https://developer.apple.com/documentation/network/nwconnection/3020638-receivemessage" rel="noopener ugc nofollow" target="_blank"> <strong class="kw iu">接收消息</strong> </a>分配一个处理程序:</p><p id="f599" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">"为完整的消息安排单个接收完成处理程序，而不是一个字节范围. "</p><p id="d473" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">这让生活变得简单多了！</p><pre class="kj kk kl km gt oi oa oj ok aw ol bi"><span id="2427" class="mz na it oa b gy om on l oo op">connection.receiveMessage { (data, context, isComplete, error) in<br/>    // Decode and continue processing data<br/>}</span></pre><h2 id="c16a" class="mz na it bd nb nc nd dn ne nf ng dp nh ld ni nj nk lh nl nm nn ll no np nq nr bi translated">启动监听器</h2><p id="b0e2" class="pw-post-body-paragraph ku kv it kw b kx ns ju kz la nt jx lc ld nu lf lg lh nv lj lk ll nw ln lo lp im bi translated">用<code class="fe nx ny nz oa b"><a class="ae lq" href="https://developer.apple.com/documentation/network/nwlistener/2998669-start" rel="noopener ugc nofollow" target="_blank">start</a></code>启动监听器的一切都准备好了，描述如下:</p><blockquote class="ob oc od"><p id="53b2" class="ku kv oe kw b kx ky ju kz la lb jx lc of le lf lg og li lj lk oh lm ln lo lp im bi translated">"注册侦听，并设置传递所有侦听器事件的队列."</p></blockquote><pre class="kj kk kl km gt oi oa oj ok aw ol bi"><span id="d3ff" class="mz na it oa b gy om on l oo op">listener?.start(queue: .main)</span></pre><h2 id="6796" class="mz na it bd nb nc nd dn ne nf ng dp nh ld ni nj nk lh nl nm nn ll no np nq nr bi translated">测试监听器</h2><p id="75b0" class="pw-post-body-paragraph ku kv it kw b kx ns ju kz la nt jx lc ld nu lf lg lh nv lj lk ll nw ln lo lp im bi translated">一切就绪并开始运行后，是时候测试代码了。最简单的方法是启动终端应用程序，并键入以下内容:</p><pre class="kj kk kl km gt oi oa oj ok aw ol bi"><span id="d642" class="mz na it oa b gy om on l oo op">echo -n "Hello UDP-World" | nc -4u -w1 -localhost 1024</span></pre><p id="c27b" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">对于那些不太熟悉命令行的人，我已经从所用工具的手册页中提供了一些解释。</p><p id="3d66" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">首先，消息是用<code class="fe nx ny nz oa b">echo</code>创建的。</p><p id="4ed5" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">什么是<code class="fe nx ny nz oa b">echo</code>？</p><blockquote class="ob oc od"><p id="a656" class="ku kv oe kw b kx ky ju kz la lb jx lc of le lf lg og li lj lk oh lm ln lo lp im bi translated">" echo实用程序将任何指定的操作数写入标准输出，用单个空格(<code class="fe nx ny nz oa b">') characters and followed by a newline (</code>\ n’)字符分隔。</p></blockquote><p id="0a04" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">鉴于<code class="fe nx ny nz oa b">-n</code>参数被记录为</p><blockquote class="ob oc od"><p id="52b3" class="ku kv oe kw b kx ky ju kz la lb jx lc of le lf lg og li lj lk oh lm ln lo lp im bi translated">"不要打印尾随换行符。这也可以通过在由Cor修订的IEEE Std 1003.1-2001(‘POSIX . 1’)中附加<code class="fe nx ny nz oa b">\c' to the end of the string, as is done by iBCS2 compatible systems. Note that this option as well as the effect of</code>\ c’are实现定义来实现。1-2002.强烈建议以最大的可移植性为目标的应用程序使用printf(1)来取消换行符。"</p></blockquote><p id="9044" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">通过管道命令<code class="fe nx ny nz oa b">|</code>，该消息被送入另一个工具，该工具通过网络发送该消息:<code class="fe nx ny nz oa b">netcat</code>或简称<code class="fe nx ny nz oa b">nc</code>:</p><blockquote class="ob oc od"><p id="59e0" class="ku kv oe kw b kx ky ju kz la lb jx lc of le lf lg og li lj lk oh lm ln lo lp im bi translated">nc(或netcat)实用程序几乎用于世界上任何涉及TCP或UDP的事情。它可以打开TCP连接，发送UDP数据包，监听任意TCP和UDP端口，进行端口扫描，并处理IPv4和IPv6。与telnet(1)不同，nc很好地编写了脚本，并将错误消息分离到标准错误中，而不是像telnet(1)那样发送到标准输出中</p></blockquote><p id="82d5" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">正在使用以下参数:</p><p id="678d" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated"><code class="fe nx ny nz oa b">-4</code>:强制nc仅使用IPv4地址。</p><p id="2f83" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated"><code class="fe nx ny nz oa b">-u</code>:使用UDP代替TCP的默认选项。</p><p id="7a2a" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated"><code class="fe nx ny nz oa b">-w timeout</code>:如果连接和stdin空闲时间超过超时秒，则连接会自动关闭。-w标志对-l选项没有影响，也就是说，不管有没有-w标志，nc都会永远监听连接。默认情况下没有超时。</p><h2 id="768c" class="mz na it bd nb nc nd dn ne nf ng dp nh ld ni nj nk lh nl nm nn ll no np nq nr bi translated">结论</h2><p id="9fbe" class="pw-post-body-paragraph ku kv it kw b kx ns ju kz la nt jx lc ld nu lf lg lh nv lj lk ll nw ln lo lp im bi translated">有了这段代码，你现在应该能够接收来自任何发送者的UDP消息，并处理你的应用程序应该做的任何事情的传入消息。</p><p id="577a" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated"><strong class="kw iu">完整的Xcode游乐场可以从这里下载:</strong> <a class="ae lq" href="https://www.buymeacoffee.com/twissmueller/e/28132" rel="noopener ugc nofollow" target="_blank"> <strong class="kw iu">雨燕中的UDP监听器</strong> </a></p><p id="bd47" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">感谢您的阅读！</p><ul class=""><li id="92dc" class="mj mk it kw b kx ky la lb ld ml lh mm ll mn lp mo mp mq mr bi translated">如果你喜欢这个，请<a class="ae lq" href="https://twissmueller.medium.com/" rel="noopener">在Medium </a>上跟随我</li><li id="ceeb" class="mj mk it kw b kx ms la mt ld mu lh mv ll mw lp mo mp mq mr bi translated">给我买杯咖啡让我继续前进</li><li id="0d8e" class="mj mk it kw b kx ms la mt ld mu lh mv ll mw lp mo mp mq mr bi translated">通过<a class="ae lq" href="https://twissmueller.medium.com/membership" rel="noopener">在这里注册</a>来支持我和其他媒体作者</li></ul><p id="7d58" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated"><a class="ae lq" href="https://twissmueller.medium.com/membership" rel="noopener">https://twissmueller.medium.com/membership</a></p><h2 id="2636" class="mz na it bd nb nc nd dn ne nf ng dp nh ld ni nj nk lh nl nm nn ll no np nq nr bi translated">资源</h2><ul class=""><li id="6182" class="mj mk it kw b kx ns la nt ld oq lh or ll os lp mo mp mq mr bi translated"><a class="ae lq" href="https://developer.apple.com/documentation/network/nwlistener" rel="noopener ugc nofollow" target="_blank"> NWListener </a></li><li id="c50a" class="mj mk it kw b kx ms la mt ld mu lh mv ll mw lp mo mp mq mr bi translated"><a class="ae lq" href="https://developer.apple.com/documentation/network/nwconnection" rel="noopener ugc nofollow" target="_blank">NW连接</a></li><li id="bd15" class="mj mk it kw b kx ms la mt ld mu lh mv ll mw lp mo mp mq mr bi translated"><a class="ae lq" href="https://marklucking.medium.com/naked-networking-with-swiftui-3f20b809d7f4" rel="noopener">使用SwiftUI进行裸联网</a></li></ul></div></div>    
</body>
</html>