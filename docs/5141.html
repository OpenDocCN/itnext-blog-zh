<html>
<head>
<title>CKS Exam Series #3 Immutable Pods</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">CKS考试系列#3不可变豆荚</h1>
<blockquote>原文：<a href="https://itnext.io/cks-exam-series-3-immutable-pods-3812cf76cff4?source=collection_archive---------0-----------------------#2020-12-21">https://itnext.io/cks-exam-series-3-immutable-pods-3812cf76cff4?source=collection_archive---------0-----------------------#2020-12-21</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="39b5" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">Kubernetes CKS示例考试问题系列</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/0b4636daffcb81ed1b2b37e49b2316ae.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*pKkK2mm8WZ7MiBj9C70awg.png"/></div></div></figure><blockquote class="kr ks kt"><p id="716a" class="ku kv kw kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated"><a class="ae lr" href="https://killer.sh/r?d=cks-series" rel="noopener ugc nofollow" target="_blank"> CKS考试系列</a> | <a class="ae lr" href="https://killer.sh/r?d=cka-series" rel="noopener ugc nofollow" target="_blank"> CKA考试系列</a> | <a class="ae lr" href="https://killer.sh/r?d=ckad-series" rel="noopener ugc nofollow" target="_blank"> CKAD考试系列</a></p></blockquote><p id="5ef5" class="pw-post-body-paragraph ku kv iq kx b ky kz jr la lb lc ju ld ls lf lg lh lt lj lk ll lu ln lo lp lq ij bi translated"><strong class="kx ir"> #####更新####更新</strong></p><p id="70de" class="pw-post-body-paragraph ku kv iq kx b ky kz jr la lb lc ju ld ls lf lg lh lt lj lk ll lu ln lo lp lq ij bi translated"><strong class="kx ir">此挑战不会在此更新，将移至:</strong></p><p id="32df" class="pw-post-body-paragraph ku kv iq kx b ky kz jr la lb lc ju ld ls lf lg lh lt lj lk ll lu ln lo lp lq ij bi translated"><a class="ae lr" href="https://killercoda.com/killer-shell-cks" rel="noopener ugc nofollow" target="_blank">https://killercoda.com/killer-shell-cks</a></p><p id="fb12" class="pw-post-body-paragraph ku kv iq kx b ky kz jr la lb lc ju ld ls lf lg lh lt lj lk ll lu ln lo lp lq ij bi translated"><strong class="kx ir"> #####更新####更新</strong></p><p id="6393" class="pw-post-body-paragraph ku kv iq kx b ky kz jr la lb lc ju ld ls lf lg lh lt lj lk ll lu ln lo lp lq ij bi">~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</p><p id="8923" class="pw-post-body-paragraph ku kv iq kx b ky kz jr la lb lc ju ld ls lf lg lh lt lj lk ll lu ln lo lp lq ij bi translated">→查看Udemy上的<a class="ae lr" href="https://killer.sh/r?d=cks-course" rel="noopener ugc nofollow" target="_blank"> <strong class="kx ir">全CKS课程</strong> </a></p><p id="1b1b" class="pw-post-body-paragraph ku kv iq kx b ky kz jr la lb lc ju ld ls lf lg lh lt lj lk ll lu ln lo lp lq ij bi">~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</p><h1 id="a2ce" class="lv lw iq bd lx ly lz ma mb mc md me mf jw mg jx mh jz mi ka mj kc mk kd ml mm bi translated">内容</h1><ol class=""><li id="854c" class="mn mo iq kx b ky mp lb mq ls mr lt ms lu mt lq mu mv mw mx bi translated"><a class="ae lr" href="https://wuestkamp.medium.com/cks-exam-series-1-create-cluster-security-best-practices-50e35aaa67ae?source=friends_link&amp;sk=8bc466dae0ea90412251e32d4eaf7539" rel="noopener">创建集群&amp;安全最佳实践</a></li><li id="1be6" class="mn mo iq kx b ky my lb mz ls na lt nb lu nc lq mu mv mw mx bi translated"><a class="ae lr" href="https://wuestkamp.medium.com/cks-exam-series-2-pods-and-secrets-3d92a6fba331?source=friends_link&amp;sk=379fa6e196233c73ef7845d84a3aa34d" rel="noopener">豆荚、秘密和服务账户</a></li><li id="8f2a" class="mn mo iq kx b ky my lb mz ls na lt nb lu nc lq mu mv mw mx bi translated"><a class="ae lr" href="https://wuestkamp.medium.com/cks-exam-series-3-immutable-pods-3812cf76cff4?source=friends_link&amp;sk=ed1231a0382d97bd5c8267afe75f14ac" rel="noopener">不可变豆荚</a></li><li id="ff89" class="mn mo iq kx b ky my lb mz ls na lt nb lu nc lq mu mv mw mx bi translated"><a class="ae lr" href="https://wuestkamp.medium.com/cks-exam-series-4-crash-that-apiserver-5f4d3d503028?source=friends_link&amp;sk=3ccd9bf1b728e85f86157ef1af23d455" rel="noopener">崩溃Apiserver &amp;检查日志</a></li><li id="b5dd" class="mn mo iq kx b ky my lb mz ls na lt nb lu nc lq mu mv mw mx bi translated"><a class="ae lr" href="https://wuestkamp.medium.com/cks-exam-series-5-imagepolicywebhook-8d09f1ceee70?source=friends_link&amp;sk=93017beeae20f640f52db41d20d3ffcd" rel="noopener">ImagePolicyWebhook/admission controller</a></li><li id="289b" class="mn mo iq kx b ky my lb mz ls na lt nb lu nc lq mu mv mw mx bi translated"><a class="ae lr" href="https://wuestkamp.medium.com/cks-exam-series-6-users-and-certificatesigningrequests-368a5b2c6a3f" rel="noopener">用户和证书签名请求</a></li><li id="e224" class="mn mo iq kx b ky my lb mz ls na lt nb lu nc lq mu mv mw mx bi translated"><a class="ae lr" href="https://wuestkamp.medium.com/cks-exam-series-7-serviceaccount-tokens-1158c93612d4?source=friends_link&amp;sk=1064eaf2f3d4d03576bcde207eaf7cfb" rel="noopener">服务帐户令牌安装</a></li><li id="2927" class="mn mo iq kx b ky my lb mz ls na lt nb lu nc lq mu mv mw mx bi translated"><a class="ae lr" href="https://wuestkamp.medium.com/cks-exam-series-8-rbac-db8a0984059e?source=friends_link&amp;sk=8a1abe2d51275faed47f3d36858b14d5" rel="noopener">基于角色的访问控制(RBAC) </a></li><li id="1291" class="mn mo iq kx b ky my lb mz ls na lt nb lu nc lq mu mv mw mx bi translated"><a class="ae lr" href="https://wuestkamp.medium.com/cks-exam-series-9-rbac-v2-23ee24dd77cd?source=friends_link&amp;sk=2a6027eb75fbcf7876216cab222fa953" rel="noopener">基于角色的访问控制(RBAC) v2 </a></li><li id="186a" class="mn mo iq kx b ky my lb mz ls na lt nb lu nc lq mu mv mw mx bi translated"><a class="ae lr" href="https://wuestkamp.medium.com/cks-exam-series-10-container-hardening-177588b8bbfe?source=friends_link&amp;sk=dbdddc1ee9321a946ee2e3f778c0711a" rel="noopener">容器硬化</a></li><li id="cc7b" class="mn mo iq kx b ky my lb mz ls na lt nb lu nc lq mu mv mw mx bi translated"><a class="ae lr" href="https://wuestkamp.medium.com/cks-exam-series-11-networkpolicies-default-deny-and-allowlist-b2ce4186551f?source=friends_link&amp;sk=bdcc071a32f26b93d6c4a51b9a9436a7" rel="noopener">网络策略(默认拒绝+允许列表)</a></li></ol><h1 id="3ccc" class="lv lw iq bd lx ly lz ma mb mc md me mf jw mg jx mh jz mi ka mj kc mk kd ml mm bi translated">规则！</h1><ol class=""><li id="10df" class="mn mo iq kx b ky mp lb mq ls mr lt ms lu mt lq mu mv mw mx bi translated">速度要快，避免从头开始手动创建yaml</li><li id="fc57" class="mn mo iq kx b ky my lb mz ls na lt nb lu nc lq mu mv mw mx bi translated">仅使用<a class="ae lr" href="https://kubernetes.io/docs/home/" rel="noopener ugc nofollow" target="_blank">kubernetes.io/docs</a>进行帮助。</li><li id="95d2" class="mn mo iq kx b ky my lb mz ls na lt nb lu nc lq mu mv mw mx bi translated">完成您的解决方案后，请查看我们的解决方案。你可能有一个更好的！</li></ol><h1 id="fe83" class="lv lw iq bd lx ly lz ma mb mc md me mf jw mg jx mh jz mi ka mj kc mk kd ml mm bi translated">今天的任务:让豆荚不变</h1><ol class=""><li id="635d" class="mn mo iq kx b ky mp lb mq ls mr lt ms lu mt lq mu mv mw mx bi translated">用图像<code class="fe nd ne nf ng b">bash:5.1.0</code>的两个容器<code class="fe nd ne nf ng b">c1</code>和<code class="fe nd ne nf ng b">c2</code>创建<em class="kw">Pod</em>T0】，确保容器保持运行</li><li id="a19e" class="mn mo iq kx b ky my lb mz ls na lt nb lu nc lq mu mv mw mx bi translated">用3个副本创建映像<code class="fe nd ne nf ng b">nginx:1.19.6</code>的<em class="kw">部署</em> <code class="fe nd ne nf ng b">snow</code></li><li id="191a" class="mn mo iq kx b ky my lb mz ls na lt nb lu nc lq mu mv mw mx bi translated">强制<em class="kw"> Pod </em> <code class="fe nd ne nf ng b">holiday</code>的容器<code class="fe nd ne nf ng b">c2</code>不可变运行:在运行期间不能更改任何文件</li><li id="466b" class="mn mo iq kx b ky my lb mz ls na lt nb lu nc lq mu mv mw mx bi translated">确保<em class="kw">部署</em> <code class="fe nd ne nf ng b">snow</code>的容器不可变运行。然后使必要的路径可写，以便Nginx工作。</li><li id="b172" class="mn mo iq kx b ky my lb mz ls na lt nb lu nc lq mu mv mw mx bi translated">核实一切</li></ol><p id="cb14" class="pw-post-body-paragraph ku kv iq kx b ky kz jr la lb lc ju ld ls lf lg lh lt lj lk ll lu ln lo lp lq ij bi">.</p><p id="42cd" class="pw-post-body-paragraph ku kv iq kx b ky kz jr la lb lc ju ld ls lf lg lh lt lj lk ll lu ln lo lp lq ij bi">.</p><p id="5e45" class="pw-post-body-paragraph ku kv iq kx b ky kz jr la lb lc ju ld ls lf lg lh lt lj lk ll lu ln lo lp lq ij bi">.</p><p id="5c1d" class="pw-post-body-paragraph ku kv iq kx b ky kz jr la lb lc ju ld ls lf lg lh lt lj lk ll lu ln lo lp lq ij bi">.</p><p id="838c" class="pw-post-body-paragraph ku kv iq kx b ky kz jr la lb lc ju ld ls lf lg lh lt lj lk ll lu ln lo lp lq ij bi">.</p><h1 id="d367" class="lv lw iq bd lx ly lz ma mb mc md me mf jw mg jx mh jz mi ka mj kc mk kd ml mm bi translated">解决办法</h1><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nh ni l"/></div></figure><h2 id="0e1c" class="nj lw iq bd lx nk nl dn mb nm nn dp mf ls no np mh lt nq nr mj lu ns nt ml nu bi">1.</h2><pre class="kg kh ki kj gt nv ng nw nx aw ny bi"><span id="ee25" class="nj lw iq ng b gy nz oa l ob oc">alias k=kubectl</span><span id="d169" class="nj lw iq ng b gy od oa l ob oc">k run holiday --image=bash:5.1.0 --command -oyaml --dry-run=client -- sh -c 'sleep 1d' &gt; holiday.yaml</span><span id="7cc3" class="nj lw iq ng b gy od oa l ob oc">vim holiday.yaml</span></pre><p id="2e4a" class="pw-post-body-paragraph ku kv iq kx b ky kz jr la lb lc ju ld ls lf lg lh lt lj lk ll lu ln lo lp lq ij bi translated">添加第二个容器并更改容器名称:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="oe ni l"/></div></figure><h2 id="c83f" class="nj lw iq bd lx nk nl dn mb nm nn dp mf ls no np mh lt nq nr mj lu ns nt ml nu bi">2.</h2><pre class="kg kh ki kj gt nv ng nw nx aw ny bi"><span id="357c" class="nj lw iq ng b gy nz oa l ob oc">k create deploy snow --image=nginx:1.19.6 -oyaml --dry-run=client &gt; snow.yaml</span><span id="ed9d" class="nj lw iq ng b gy od oa l ob oc">vim snow.yaml</span></pre><p id="9d3f" class="pw-post-body-paragraph ku kv iq kx b ky kz jr la lb lc ju ld ls lf lg lh lt lj lk ll lu ln lo lp lq ij bi translated">更改副本:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="oe ni l"/></div></figure><h2 id="c796" class="nj lw iq bd lx nk nl dn mb nm nn dp mf ls no np mh lt nq nr mj lu ns nt ml nu bi">3.</h2><pre class="kg kh ki kj gt nv ng nw nx aw ny bi"><span id="a445" class="nj lw iq ng b gy nz oa l ob oc">vim holiday.yaml</span></pre><p id="ca87" class="pw-post-body-paragraph ku kv iq kx b ky kz jr la lb lc ju ld ls lf lg lh lt lj lk ll lu ln lo lp lq ij bi translated">在容器级别添加SecurityContext:</p><pre class="kg kh ki kj gt nv ng nw nx aw ny bi"><span id="0246" class="nj lw iq ng b gy nz oa l ob oc">apiVersion: v1<br/>kind: Pod<br/>metadata:<br/>  creationTimestamp: null<br/>  labels:<br/>    run: holiday<br/>  name: holiday<br/>spec:<br/>  containers:<br/>  - command:<br/>    - sh<br/>    - -c<br/>    - sleep 1d<br/>    image: bash:5.1.0<br/>    name: c1<br/>    resources: {}<br/>  - command:<br/>    - sh<br/>    - -c<br/>    - sleep 1d<br/>    image: bash:5.1.0<br/>    name: c2<br/>    resources: {}<br/><strong class="ng ir">    securityContext:<br/>      readOnlyRootFilesystem: true</strong><br/>  dnsPolicy: ClusterFirst<br/>  restartPolicy: Always<br/>status: {}</span></pre><h2 id="5084" class="nj lw iq bd lx nk nl dn mb nm nn dp mf ls no np mh lt nq nr mj lu ns nt ml nu bi">4.</h2><p id="8986" class="pw-post-body-paragraph ku kv iq kx b ky mp jr la lb mq ju ld ls of lg lh lt og lk ll lu oh lo lp lq ij bi translated">这个想法是将所有文件系统设为只读，然后启动<em class="kw"> Pod </em>并检查容器日志中的错误。基于这些错误，我们可以创建用于写入的emptyDir卷。错误可能如下所示:</p><pre class="kg kh ki kj gt nv ng nw nx aw ny bi"><span id="324e" class="nj lw iq ng b gy nz oa l ob oc">"/var/cache/nginx/client_temp" failed (30: Read-only file system)<br/>nginx: [emerg] mkdir() "/var/cache/nginx/client_temp" failed (30: Read-only file system)</span></pre><p id="8ad7" class="pw-post-body-paragraph ku kv iq kx b ky kz jr la lb lc ju ld ls lf lg lh lt lj lk ll lu ln lo lp lq ij bi translated">只要有Docker，我们就可以做类似这样的事情:</p><pre class="kg kh ki kj gt nv ng nw nx aw ny bi"><span id="2c9d" class="nj lw iq ng b gy nz oa l ob oc">docker run -d --read-only --tmpfs /var/cache nginx</span></pre><p id="6b85" class="pw-post-body-paragraph ku kv iq kx b ky kz jr la lb lc ju ld ls lf lg lh lt lj lk ll lu ln lo lp lq ij bi translated">在<em class="kw">部署</em>中要做到这一点:</p><pre class="kg kh ki kj gt nv ng nw nx aw ny bi"><span id="d7ed" class="nj lw iq ng b gy nz oa l ob oc">vim snow.yaml</span></pre><p id="aca3" class="pw-post-body-paragraph ku kv iq kx b ky kz jr la lb lc ju ld ls lf lg lh lt lj lk ll lu ln lo lp lq ij bi translated">添加卷和卷装载:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="oe ni l"/></div></figure><h2 id="4ed8" class="nj lw iq bd lx nk nl dn mb nm nn dp mf ls no np mh lt nq nr mj lu ns nt ml nu bi">5.</h2><pre class="kg kh ki kj gt nv ng nw nx aw ny bi"><span id="5772" class="nj lw iq ng b gy nz oa l ob oc">k exec holiday -c c1 -- touch /tmp/test # works<br/>k exec holiday -c c2 -- touch /tmp/test # error</span><span id="b17f" class="nj lw iq ng b gy od oa l ob oc">k get deploy snow # should show 3 ready replicas<br/>k exec snow-575cd78c85-ldplw -- touch /tmp/test # error<br/>k exec snow-575cd78c85-ldplw -- touch /var/cache/nginx/test # works</span></pre><h1 id="4ad9" class="lv lw iq bd lx ly lz ma mb mc md me mf jw mg jx mh jz mi ka mj kc mk kd ml mm bi translated">你有不同的解决方法？</h1><p id="d750" class="pw-post-body-paragraph ku kv iq kx b ky mp jr la lb mq ju ld ls of lg lh lt og lk ll lu oh lo lp lq ij bi translated">请在下面留言告诉我们！</p><h1 id="9727" class="lv lw iq bd lx ly lz ma mb mc md me mf jw mg jx mh jz mi ka mj kc mk kd ml mm bi translated">— — —结尾————</h1><p id="7fa4" class="pw-post-body-paragraph ku kv iq kx b ky mp jr la lb mq ju ld ls of lg lh lt og lk ll lu oh lo lp lq ij bi translated">本次会议到此为止。下次再见，祝学习愉快！</p><h1 id="ca0a" class="lv lw iq bd lx ly lz ma mb mc md me mf jw mg jx mh jz mi ka mj kc mk kd ml mm bi translated">准备好加入黑仔壳牌了吗？</h1><h2 id="0d9a" class="nj lw iq bd lx nk nl dn mb nm nn dp mf ls no np mh lt nq nr mj lu ns nt ml nu bi translated">完整的CKS课程</h2><figure class="kg kh ki kj gt kk gh gi paragraph-image"><a href="https://killer.sh/r?d=cks-course"><div class="gh gi oi"><img src="../Images/b16ab8b3bd72db1ad641b82f067bdd80.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ULNkfS7aG-FdPA_OEtLbJQ.png"/></div></a><figcaption class="oj ok gj gh gi ol om bd b be z dk translated"><a class="ae lr" href="https://killer.sh/r?d=cks-course" rel="noopener ugc nofollow" target="_blank">链接</a></figcaption></figure><h2 id="5451" class="nj lw iq bd lx nk nl dn mb nm nn dp mf ls no np mh lt nq nr mj lu ns nt ml nu bi translated">…或者CKS模拟器</h2><figure class="kg kh ki kj gt kk gh gi paragraph-image"><a href="https://killer.sh/cks"><div class="gh gi on"><img src="../Images/4c118b1471bd606fc46cd5569df4f944.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*Ery6hxFdiGJ6wSlP.png"/></div></a><figcaption class="oj ok gj gh gi ol om bd b be z dk translated"><a class="ae lr" href="https://killer.sh/cks" rel="noopener ugc nofollow" target="_blank">https://killer.sh/cks</a></figcaption></figure></div></div>    
</body>
</html>