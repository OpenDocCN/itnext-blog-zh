<html>
<head>
<title>Network Isolated AKS — Part 2: How do I get in?</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">网络隔离AK—第2部分:我如何进入？</h1>
<blockquote>原文：<a href="https://itnext.io/network-isolated-aks-part-2-how-do-i-get-in-1c01d0c1b115?source=collection_archive---------3-----------------------#2021-05-24">https://itnext.io/network-isolated-aks-part-2-how-do-i-get-in-1c01d0c1b115?source=collection_archive---------3-----------------------#2021-05-24</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="eb24" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">隔离AK(和PaaS ),而不将自己束缚在</strong>中</p><p id="9902" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在<a class="ae kl" href="https://geekzter.medium.com/network-isolated-aks-part-1-controlling-network-traffic-2cd0e045352d" rel="noopener">第1部分</a>中，我解释了如何创建一个网络隔离的AK。这将尽可能多的流量限制在专用网络上，并将公共流量限制在必要的范围内(例如，您的应用程序监听端口443)。那么，将应用程序部署到AKS也是必不可少的，那么如何满足这一点呢？</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="ks kt di ku bf kv"><div class="gh gi km"><img src="../Images/ae87637edd21915a8caa337994b9b5ff.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*xldEXwxTrZ_1RKOUbb0-IA.png"/></div></div></figure><p id="d0fd" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在第2部分中，在描述我选择的方案(Azure Pipeline Scale Set Agents)之前，我将首先介绍我考虑过的几个方案。注意，虽然我主要关注AKS，但是这种方法适用于任何VNet封装的服务。</p><h1 id="fc8a" class="ky kz iq bd la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv bi translated">部署组和环境</h1><p id="5440" class="pw-post-body-paragraph jn jo iq jp b jq lw js jt ju lx jw jx jy ly ka kb kc lz ke kf kg ma ki kj kk ij bi translated">对于在Azure虚拟机上配置和部署应用程序，Azure Pipelines有一个称为<a class="ae kl" href="https://docs.microsoft.com/en-us/azure/devops/pipelines/release/deployment-groups/" rel="noopener ugc nofollow" target="_blank">部署组</a>(传统管道)和<a class="ae kl" href="https://docs.microsoft.com/en-us/azure/devops/pipelines/process/environments-virtual-machines" rel="noopener ugc nofollow" target="_blank">环境</a> (YAML管道)的特性。这利用了安装在虚拟机上的代理，因此您可以直接从管道定位这些虚拟机。这些代理向Azure Pipelines注册以变得可用，并开始轮询作业。这种部署模式的副作用是Azure管道可以到达虚拟机所在的虚拟网络(事实上，这在Azure外部也可以工作，例如内部)。</p><p id="b829" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">由于Kubernetes 也有一个<a class="ae kl" href="https://docs.microsoft.com/en-us/azure/devops/pipelines/process/environments-kubernetes" rel="noopener ugc nofollow" target="_blank">环境风格，您可能希望这也能解决网络连接性问题(我一开始就是这样做的)。然而情况并非如此，因为Kubernetes环境不使用代理。相反，这是一种定位已经在Azure Pipeline服务连接中注册的Kubernetes集群的便捷方式。因此，虽然这是将Kubernetes清单部署集成到Azure管道中的一个好方法，但它在连接性方面没有任何作用。Azure管道将无法连接到您的孤立AK。因此，我们需要看得更远。</a></p><h1 id="5039" class="ky kz iq bd la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv bi translated">带焊剂的GitOps</h1><p id="ba0b" class="pw-post-body-paragraph jn jo iq jp b jq lw js jt ju lx jw jx jy ly ka kb kc lz ke kf kg ma ki kj kk ij bi translated">一种流行的CI/CD方法称为GitOps，它通过源代码控制强制所有的更改，不允许直接的“kubectl apply”。相反，更改被推送到Git，代理轮询更改并在更改存在时提取它们。然后，代理将这些更改应用到基础设施——在本例中是Kubernetes。当我说“代理”时，它不是传统意义上的代理，而是与Kubernetes本地集成的工具。最流行的方法是使用<a class="ae kl" href="https://fluxcd.io/docs/" rel="noopener ugc nofollow" target="_blank">通量</a>。</p><p id="7f24" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这是一个拉模式，类似于Azure Pipelines中的部署组和环境，并且在运行时只需要出站访问。然而，您需要在Flux运行之前设置它本身。因此，你仍然面临着一个引导问题，即如何首先进入一个锁定的AKS集群。</p><h1 id="42ff" class="ky kz iq bd la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv bi translated">定垢剂</h1><p id="038d" class="pw-post-body-paragraph jn jo iq jp b jq lw js jt ju lx jw jx jy ly ka kb kc lz ke kf kg ma ki kj kk ij bi translated">要访问受限于虚拟网络的AKS或任何PaaS服务(您希望为其设置CI/CD ),您需要确保CI/CD作业在同一个虚拟网络中的代理上运行，或者在可以访问的(对等)虚拟网络中运行。在Azure DevOps中，这可以通过<a class="ae kl" href="https://docs.microsoft.com/en-us/azure/devops/pipelines/agents/v2-linux?view=azure-devops" rel="noopener ugc nofollow" target="_blank">自托管代理</a>来完成。虽然这很有效，但我发现您需要积极地管理这些代理的生命周期，以便为CI/CD提供稳定、可靠(因此是可重复的)的基础架构。<a class="ae kl" href="https://docs.github.com/en/actions/hosting-your-own-runners/about-self-hosted-runners" rel="noopener ugc nofollow" target="_blank"> GitHub runners </a>遵循同样的管理个体代理的模式。</p><p id="c54c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">相反，我使用规模设置代理，并发现他们是非常可靠的。创建秤台很简单，在<a class="ae kl" href="https://docs.microsoft.com/en-us/azure/devops/pipelines/agents/scale-set-agents" rel="noopener ugc nofollow" target="_blank">文档</a>中有描述。</p><h2 id="c07e" class="mb kz iq bd la mc md dn le me mf dp li jy mg mh lm kc mi mj lq kg mk ml lu mm bi translated">使用cloud-init创建代理</h2><p id="1f7b" class="pw-post-body-paragraph jn jo iq jp b jq lw js jt ju lx jw jx jy ly ka kb kc lz ke kf kg ma ki kj kk ij bi translated">为了创建Ubuntu代理，我使用了Terraform和<a class="ae kl" href="https://cloud-init.io/" rel="noopener ugc nofollow" target="_blank"> cloud-init </a>。下面是用于定制代理的云配置文件:</p><figure class="kn ko kp kq gt kr"><div class="bz fp l di"><div class="mn mo l"/></div><figcaption class="mp mq gj gh gi mr ms bd b be z dk translated">云配置</figcaption></figure><p id="bd53" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">云配置YAML包括要安装的包，包含一些防止与dpkg冲突的代码(这可能导致cloud-init失败)，并设置机器环境变量，这些变量可以在代理作业中使用，以发现代理所在的虚拟网络的上下文。</p><p id="4b44" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">下面列出了用于创建比例集的terraform资源:</p><figure class="kn ko kp kq gt kr"><div class="bz fp l di"><div class="mn mo l"/></div><figcaption class="mp mq gj gh gi mr ms bd b be z dk translated">在Terraform中配置cloudinit</figcaption></figure><h2 id="c7b8" class="mb kz iq bd la mc md dn le me mf dp li jy mg mh lm kc mi mj lq kg mk ml lu mm bi translated">竞争条件和并发性</h2><p id="7fcf" class="pw-post-body-paragraph jn jo iq jp b jq lw js jt ju lx jw jx jy ly ka kb kc lz ke kf kg ma ki kj kk ij bi translated">我遇到的一个挑战是可预测地运行cloud-init。虚拟机扩展的竞争条件会导致cloud-init失败。事物运行的顺序是不确定的。因此，需要注意确保资源调配活动以可预测的顺序运行，而不是并发运行。通常，在Terraform中，这将通过depends_on属性来完成。然而，我们正在处理一个虚拟机规模集，其中各个实例由Azure创建，并由Azure DevOps编排。在Terraform部署时没有提供实际的实例。</p><p id="5f94" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">为了加强cloud-init的依赖性，我创建了一个CustomScript VM扩展，它首先等待cloud-init完成。这是自定义脚本:</p><pre class="kn ko kp kq gt mt mu mv mw aw mx bi"><span id="f150" class="mb kz iq mu b gy my mz l na nb">/usr/bin/cloud-init status --long --wait ; systemctl status cloud-final.service --full --no-pager --wait</span></pre><p id="0637" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">然后，我对其他VM扩展使用“provision_after_extensions”属性(而不是“depends_on”)，以确保它们在cloud-init完成后运行:</p><figure class="kn ko kp kq gt kr"><div class="bz fp l di"><div class="mn mo l"/></div><figcaption class="mp mq gj gh gi mr ms bd b be z dk translated">Azure虚拟机规模集云初始化竞争条件修复</figcaption></figure><p id="4b68" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">有了这些依赖关系，就可以可靠地创建比例集实例。</p><h2 id="8319" class="mb kz iq bd la mc md dn le me mf dp li jy mg mh lm kc mi mj lq kg mk ml lu mm bi translated">注册代理池</h2><p id="d860" class="pw-post-body-paragraph jn jo iq jp b jq lw js jt ju lx jw jx jy ly ka kb kc lz ke kf kg ma ki kj kk ij bi translated">从秤台创建代理池是一种手动方法(此处记录了<a class="ae kl" href="https://docs.microsoft.com/en-us/azure/devops/pipelines/agents/scale-set-agents?view=azure-devops#create-the-scale-set-agent-pool" rel="noopener ugc nofollow" target="_blank">和</a>)。从代理池页面(https://dev.azure.com/&lt;组织&gt;/_设置/代理池)添加池:</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="ks kt di ku bf kv"><div class="gh gi nc"><img src="../Images/f87c8eeff98e79a245fb30244b762a16.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*KxsriabAeTlBO3qat70EbA.png"/></div></div></figure><p id="ef2a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">提供您的秤台的详细信息。实例需要一段时间来调配资源，之后它们应该会联机并可用于作业:</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="ks kt di ku bf kv"><div class="gh gi nd"><img src="../Images/1732bbe066dc57250884b8764222dda6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*W_nK2B_kJolHzmqRlZmFYw.png"/></div></div></figure><h1 id="c099" class="ky kz iq bd la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv bi translated">使用scale set代理进入AKS</h1><p id="ab34" class="pw-post-body-paragraph jn jo iq jp b jq lw js jt ju lx jw jx jy ly ka kb kc lz ke kf kg ma ki kj kk ij bi translated">当规模设置代理完成调配后，我们已将此图的下半部分放置到位:</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="ks kt di ku bf kv"><div class="gh gi ne"><img src="../Images/473099a5265ead1afbe898bc6348c8d5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*TkwKdH1Z811jxFmL.png"/></div></div><figcaption class="mp mq gj gh gi mr ms bd b be z dk translated">秤台代理连接</figcaption></figure><p id="ed6f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">那么和上半部分的连接怎么样呢？这是代理上运行的管道的工作。下面是设置Terraform输入变量的关键部分:</p><figure class="kn ko kp kq gt kr"><div class="bz fp l di"><div class="mn mo l"/></div><figcaption class="mp mq gj gh gi mr ms bd b be z dk translated">Azure VM scale为Terraform输入设置环境变量</figcaption></figure><p id="d30e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">底部的部分，例如修正Terraform输入变量的情况，在早先关于这个主题的<a class="ae kl" href="https://geekzter.medium.com/using-terraform-with-azure-azure-pipelines-github-actions-86e043bd0d9e" rel="noopener">博客文章</a>中有所涉及。</p><h2 id="da00" class="mb kz iq bd la mc md dn le me mf dp li jy mg mh lm kc mi mj lq kg mk ml lu mm bi translated">配置虚拟网络</h2><p id="a7eb" class="pw-post-body-paragraph jn jo iq jp b jq lw js jt ju lx jw jx jy ly ka kb kc lz ke kf kg ma ki kj kk ij bi translated">使用scale set代理公开geek zter _ AGENT _ VIRTUAL _ NETWORK _ ID环境变量，这足以将其传递到Terraform:</p><pre class="kn ko kp kq gt mt mu mv mw aw mx bi"><span id="03e8" class="mb kz iq mu b gy my mz l na nb">$env:TF_VAR_peer_network_id ??= $env:GEEKZTER_AGENT_VIRTUAL_NETWORK_ID</span></pre><h2 id="2f3c" class="mb kz iq bd la mc md dn le me mf dp li jy mg mh lm kc mi mj lq kg mk ml lu mm bi translated">从管道内部窥视:流血的抽象</h2><p id="ac60" class="pw-post-body-paragraph jn jo iq jp b jq lw js jt ju lx jw jx jy ly ka kb kc lz ke kf kg ma ki kj kk ij bi translated">对等主机代理所在的虚拟网络是一个非常抽象的概念。这将影响代理上运行的任何作业，而不仅仅是建立对等关系的作业。那么，我们如何降低一个代理影响另一个代理的风险呢？没有防弹解决方案，但我通过为自动调配的虚拟网络的地址空间创建随机CIDR来限制风险，并使用作业ID植入随机值:</p><pre class="kn ko kp kq gt mt mu mv mw aw mx bi"><span id="2476" class="mb kz iq mu b gy my mz l na nb">$env:TF_VAR_address_space ??= "$([IPAddress]::Parse(`<br/>    [String] (`<br/>      167772160 + (`<br/>        65536*(`<br/>          Get-Random -Minimum 0 -Maximum 255 -SetSeed $(Build.BuildId)`<br/>        )`<br/>      )`<br/>    )`<br/>  ) | Select-Object -ExpandProperty IPAddressToString)/16"</span></pre><p id="b5dd" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这应该会降低后续作业生成相同值的可能性。注意，我在192.168.0.0/24中运行我的比例集代理，它不会与上面生成的CIDR冲突。</p><h2 id="f1e4" class="mb kz iq bd la mc md dn le me mf dp li jy mg mh lm kc mi mj lq kg mk ml lu mm bi translated">部署带对等功能的AKS</h2><p id="5ca3" class="pw-post-body-paragraph jn jo iq jp b jq lw js jt ju lx jw jx jy ly ka kb kc lz ke kf kg ma ki kj kk ij bi translated">有了上述内容，为<a class="ae kl" href="https://github.com/geekzter/azure-aks" rel="noopener ugc nofollow" target="_blank"> azure-aks </a>设置了<a class="ae kl" href="https://github.com/geekzter/azure-aks/blob/main/terraform/variables.tf" rel="noopener ugc nofollow" target="_blank"> Terraform变量</a>，并且Terraform将创建对等，作为<a class="ae kl" href="https://github.com/geekzter/azure-aks" rel="noopener ugc nofollow" target="_blank"> azure-aks </a>部署的一部分:</p><figure class="kn ko kp kq gt kr"><div class="bz fp l di"><div class="mn mo l"/></div><figcaption class="mp mq gj gh gi mr ms bd b be z dk translated">来自Azure虚拟机规模设置代理的Terraform VNet对等</figcaption></figure><h2 id="71f6" class="mb kz iq bd la mc md dn le me mf dp li jy mg mh lm kc mi mj lq kg mk ml lu mm bi translated">部署应用程序</h2><p id="42bc" class="pw-post-body-paragraph jn jo iq jp b jq lw js jt ju lx jw jx jy ly ka kb kc lz ke kf kg ma ki kj kk ij bi translated">虚拟网络对等化和AKS调配完成后，部署应用程序就像往常一样:</p><figure class="kn ko kp kq gt kr"><div class="bz fp l di"><div class="mn mo l"/></div></figure><h1 id="728b" class="ky kz iq bd la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv bi translated">完整的源代码和演示</h1><p id="88ca" class="pw-post-body-paragraph jn jo iq jp b jq lw js jt ju lx jw jx jy ly ka kb kc lz ke kf kg ma ki kj kk ij bi translated">你可以在GitHub的<a class="ae kl" href="https://github.com/geekzter/azure-aks" rel="noopener ugc nofollow" target="_blank"> geekzter/azure-aks </a>找到使用上述控件部署AKS的完整项目。这包括一个<a class="ae kl" href="https://github.com/geekzter/azure-aks/blob/main/pipelines/azure-aks-ci.yml" rel="noopener ugc nofollow" target="_blank"> YAML Azure Pipeline </a>，以及手册说明。</p><h1 id="06c1" class="ky kz iq bd la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv bi translated">其他资源</h1><p id="c2b9" class="pw-post-body-paragraph jn jo iq jp b jq lw js jt ju lx jw jx jy ly ka kb kc lz ke kf kg ma ki kj kk ij bi translated">在<a class="ae kl" href="https://docs.microsoft.com/en-us/azure/architecture/reference-architectures/" rel="noopener ugc nofollow" target="_blank">docs.microsoft.com</a>发布了一个名为<a class="ae kl" href="https://docs.microsoft.com/en-us/azure/architecture/reference-architectures/containers/aks/secure-baseline-aks" rel="noopener ugc nofollow" target="_blank">基线架构的参考架构，用于Azure Kubernetes服务(AKS) </a>。</p><p id="0e5e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果您正在使用企业级登录区(云采用框架)，并且想要插入其中，您可以使用<a class="ae kl" href="https://github.com/Azure/caf-terraform-landingzones-starter/tree/starter/enterprise_scale/construction_sets/aks/online/aks_secure_baseline" rel="noopener ugc nofollow" target="_blank"> AKS构造集</a>来创建一个AKS登录区。</p></div></div>    
</body>
</html>