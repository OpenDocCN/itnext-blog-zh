<html>
<head>
<title>WebSocket Load Testing with Artillery.io</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用cannon . io进行WebSocket负载测试</h1>
<blockquote>原文：<a href="https://itnext.io/websocket-load-testing-with-artillery-io-b8b7ecbcd7ed?source=collection_archive---------1-----------------------#2020-04-20">https://itnext.io/websocket-load-testing-with-artillery-io-b8b7ecbcd7ed?source=collection_archive---------1-----------------------#2020-04-20</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><p id="a61b" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">这篇文章背后的故事始于在树莓Pi 3 B上的<a class="ae ko" href="https://developer.microsoft.com/en-us/windows/iot/" rel="noopener ugc nofollow" target="_blank"> Windows物联网核心</a>上测试<a class="ae ko" href="https://docs.microsoft.com/en-us/aspnet/core/fundamentals/websockets?view=aspnetcore-3.1" rel="noopener ugc nofollow" target="_blank">ASP.NET核心WebSocket </a>性能的想法。网；都是关于用<a class="ae ko" href="https://artillery.io/docs/" rel="noopener ugc nofollow" target="_blank">cannon . io</a>进行WebSocket负载测试。</p></div><div class="ab cl kp kq hx kr" role="separator"><span class="ks bw bk kt ku kv"/><span class="ks bw bk kt ku kv"/><span class="ks bw bk kt ku"/></div><div class="im in io ip iq"><h2 id="3b85" class="kw kx it bd ky kz la dn lb lc ld dp le kb lf lg lh kf li lj lk kj ll lm ln lo bi translated">什么是炮兵io？</h2><p id="5edd" class="pw-post-body-paragraph jq jr it js b jt lp jv jw jx lq jz ka kb lr kd ke kf ls kh ki kj lt kl km kn im bi translated">火炮是一个先进的，强大的和易于使用的负载测试和功能测试工具包。使用它来发布在高负载下保持高性能和弹性的可扩展应用程序。它支持从延迟到并发用户的各种报告。</p><figure class="lv lw lx ly gt lz gh gi paragraph-image"><div role="button" tabindex="0" class="ma mb di mc bf md"><div class="gh gi lu"><img src="../Images/d467c5bdb20d008779148bda5549c622.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*WH5quJySRHkpM9Ksn_XWmA.png"/></div></div></figure></div><div class="ab cl kp kq hx kr" role="separator"><span class="ks bw bk kt ku kv"/><span class="ks bw bk kt ku kv"/><span class="ks bw bk kt ku"/></div><div class="im in io ip iq"><h2 id="d827" class="kw kx it bd ky kz la dn lb lc ld dp le kb lf lg lh kf li lj lk kj ll lm ln lo bi translated">炮兵入门. io</h2><p id="9d75" class="pw-post-body-paragraph jq jr it js b jt lp jv jw jx lq jz ka kb lr kd ke kf ls kh ki kj lt kl km kn im bi translated">cannon是用<a class="ae ko" href="http://nodejs.org/" rel="noopener ugc nofollow" target="_blank"> Node.js </a>编写的，这意味着它已经是跨平台的，你可以很容易地开始使用它，而不需要任何其他依赖。在开始使用它之前，确保你已经在你的机器上安装了<a class="ae ko" href="https://nodejs.org/en/download/" rel="noopener ugc nofollow" target="_blank">node . js 10 . 16 . 3</a>(LTS版本)或更高版本。</p><p id="f750" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">要安装火炮，运行以下命令:</p><ul class=""><li id="9520" class="mg mh it js b jt ju jx jy kb mi kf mj kj mk kn ml mm mn mo bi translated">npm用户</li></ul><pre class="lv lw lx ly gt mp mq mr ms aw mt bi"><span id="8406" class="kw kx it mq b gy mu mv l mw mx">npm install -g artillery</span></pre><ul class=""><li id="31f8" class="mg mh it js b jt ju jx jy kb mi kf mj kj mk kn ml mm mn mo bi translated">纱线用户</li></ul><pre class="lv lw lx ly gt mp mq mr ms aw mt bi"><span id="680d" class="kw kx it mq b gy mu mv l mw mx">yarn global add artillery</span></pre><p id="7b47" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">💡如果不知道<a class="ae ko" href="https://yarnpkg.com/" rel="noopener ugc nofollow" target="_blank">纱包管理器</a>是什么，用npm安装。</p><p id="b0b0" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">安装可能需要一些时间。运行<code class="fe my mz na mq b">artillery — version</code>命令检查安装是否正确。我使用的是1.6版本，这是我写这篇文章时的最新版本。</p><figure class="lv lw lx ly gt lz gh gi paragraph-image"><div role="button" tabindex="0" class="ma mb di mc bf md"><div class="gh gi nb"><img src="../Images/ed550808a6b74da29b745864bbc7c1f3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*jzSdYLatrS9PF_tEe87vTA.png"/></div></div><figcaption class="nc nd gj gh gi ne nf bd b be z dk translated">火炮-版本输出</figcaption></figure></div><div class="ab cl kp kq hx kr" role="separator"><span class="ks bw bk kt ku kv"/><span class="ks bw bk kt ku kv"/><span class="ks bw bk kt ku"/></div><div class="im in io ip iq"><h2 id="01cd" class="kw kx it bd ky kz la dn lb lc ld dp le kb lf lg lh kf li lj lk kj ll lm ln lo bi translated">设计负载测试方案</h2><p id="f1f7" class="pw-post-body-paragraph jq jr it js b jt lp jv jw jx lq jz ka kb lr kd ke kf ls kh ki kj lt kl km kn im bi translated">首先，在尝试配置任何负载测试器来测试您的服务之前，有必要设计您的负载测试场景。我有一个简单的echo WebSocket服务器，运行在Windows物联网核心和Raspberry Pi上。</p><p id="fe72" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">我喜欢将我的负载测试场景分为两个阶段:</p><ul class=""><li id="5979" class="mg mh it js b jt ju jx jy kb mi kf mj kj mk kn ml mm mn mo bi translated">预热web套接字服务</li><li id="b5b6" class="mg mh it js b jt ng jx nh kb ni kf nj kj nk kn ml mm mn mo bi translated">尝试实现服务、操作系统和硬件的全部容量</li><li id="a613" class="mg mh it js b jt ng jx nh kb ni kf nj kj nk kn ml mm mn mo bi translated">错误率应低于1%</li><li id="bcb3" class="mg mh it js b jt ng jx nh kb ni kf nj kj nk kn ml mm mn mo bi translated">每个虚拟用户应该发送一个问候，等待3秒钟，然后发送另一个消息</li></ul><p id="1523" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">Artillerry.io测试剖面是YAML<a class="ae ko" href="https://en.wikipedia.org/wiki/YAML" rel="noopener ugc nofollow" target="_blank">格式。我开始在YAML文件中创建我的测试场景概要文件。</a></p><pre class="lv lw lx ly gt mp mq mr ms aw mt bi"><span id="7489" class="kw kx it mq b gy mu mv l mw mx">config:<br/>  target: "ws://10.10.10.1:5000/ws"</span></pre><p id="c1c2" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">将目标更改为您的WebSocket服务地址。如果你有一个安全的WebSocket服务，不要忘记使用<code class="fe my mz na mq b">wss://</code>协议。</p><p id="69e9" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><strong class="js iu">错误率应低于1个百分点:</strong></p><pre class="lv lw lx ly gt mp mq mr ms aw mt bi"><span id="0fc3" class="kw kx it mq b gy mu mv l mw mx">config:<br/>  target: "ws://10.10.10.1:5000/ws"<br/>  ensure:<br/>    maxErrorRate: 1</span></pre><p id="6553" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">确保选项有什么作用？当在CI/CD管道中运行火炮时，当条件不满足时，用非零代码让火炮退出可能是有用的。根据我的设想，最大错误率不应大于1 %;通过在<code class="fe my mz na mq b">ensure</code>内添加<code class="fe my mz na mq b">maxErrorRate:1</code>，在测试过程中满足了这一要求。</p><p id="91ff" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">💡cannon . io支持大量保障因素，你可以在<a class="ae ko" href="https://artillery.io/docs/script-reference/#setting-success-conditions-with-ensure" rel="noopener ugc nofollow" target="_blank">官方文档</a>上找到。</p><p id="1f84" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><strong class="js iu">负载测试期间的不同阶段:</strong></p><pre class="lv lw lx ly gt mp mq mr ms aw mt bi"><span id="6c63" class="kw kx it mq b gy mu mv l mw mx">config:<br/>    target: "ws://10.10.10.1:5000/ws"<br/>    ensure:<br/>      maxErrorRate: 1<br/>    phases:<br/>      - duration: 20<br/>        arrivalRate: 5<br/>        rampTo: 10<br/>        name: "Warming up"<br/>      - duration: 60<br/>        arrivalRate: 10<br/>        rampTo: 100<br/>        name: "Max load"</span></pre><p id="2bf8" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">我定义了两个阶段:热身和最大负荷。</p><p id="fde1" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">💡<em class="nl">您可以定义任意多的不同阶段，但不要忘记为它们定义一个名称。</em></p><p id="6efe" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">第一阶段运行<strong class="js iu"> 20 </strong>秒，到达速率为<strong class="js iu"> 5 </strong>，这意味着每秒有<strong class="js iu"> 5 </strong>个新用户加入测试。通过<strong class="js iu"> rampUp </strong>选项，火炮将到达率从<strong class="js iu"> 5 </strong>增加到<strong class="js iu"> 10 </strong>。第二阶段运行时间为<strong class="js iu"> 60 </strong>秒，每秒应向<strong class="js iu"> 100 </strong>添加<strong class="js iu"> 10 </strong>个新用户。</p><p id="03bf" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">负载测试概要文件的最后一部分是定义操作或场景。在我的场景中，每个虚拟用户首先发送一条hello消息，他们等待3秒钟，然后发送另一条消息。</p><pre class="lv lw lx ly gt mp mq mr ms aw mt bi"><span id="bd6f" class="kw kx it mq b gy mu mv l mw mx">config:<br/>    target: "ws://10.10.10.1:5000/ws"<br/>    ensure:<br/>      maxErrorRate: 1<br/>    phases:<br/>      - duration: 20<br/>        arrivalRate: 5<br/>        rampTo: 10<br/>        name: "Warming up"<br/>      - duration: 60<br/>        arrivalRate: 10<br/>        rampTo: 100<br/>        name: "Max load"<br/>scenarios:<br/>  - engine: "ws"<br/>    flow:<br/>      - send: "hello"<br/>      - think: 3<br/>      - send: "how are you?"</span></pre><p id="7ad1" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">如果您仔细查看场景部分，您会发现首先我将引擎定义为WebSocket。在流程内部，起初每个虚拟用户发送一个“你好”，它等待3秒钟；然后它发送“你好吗？”为服务干杯。</p><p id="ce31" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">现在，将文件保存为<code class="fe my mz na mq b">loadtest.yml</code>。要运行测试，请运行以下命令:</p><pre class="lv lw lx ly gt mp mq mr ms aw mt bi"><span id="e00a" class="kw kx it mq b gy mu mv l mw mx">artillery run .\loadtest.yml --output result.json</span></pre><p id="6d34" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">它让cannon使用您的测试概要文件运行测试，并将报告以<strong class="js iu"> JSON </strong>格式保存为<strong class="js iu"> result.json </strong>。如果你的YAML文件格式正确，你会看到如下视频:</p><figure class="lv lw lx ly gt lz gh gi paragraph-image"><div role="button" tabindex="0" class="ma mb di mc bf md"><div class="gh gi nm"><img src="../Images/7ddbf5290425f8d153f91d4c6996d5bd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*T8XXCXoGJHdCgdKuGdxpzA.gif"/></div></div></figure><p id="6c3a" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">您可以从控制台的负载测试中读取一些有用的信息，但是我们要求cannon将结果保存在一个JSON文件中。cannon可以将JSON结果转换成人性化的HTML报告。</p><pre class="lv lw lx ly gt mp mq mr ms aw mt bi"><span id="231b" class="kw kx it mq b gy mu mv l mw mx">artillery report .\result.json</span></pre><p id="99b9" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">通过运行上面的命令，它将生成HTML报告并在浏览器中打开它。</p><figure class="lv lw lx ly gt lz gh gi paragraph-image"><div role="button" tabindex="0" class="ma mb di mc bf md"><div class="gh gi nn"><img src="../Images/7a68ec5563c35e8136905f45d9715465.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*3pm0X9QSsdrdhQJ5ZOPDqw.png"/></div></div></figure><p id="6a54" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">关于每秒请求、延迟、并发用户等的不同图表。</p></div><div class="ab cl kp kq hx kr" role="separator"><span class="ks bw bk kt ku kv"/><span class="ks bw bk kt ku kv"/><span class="ks bw bk kt ku"/></div><div class="im in io ip iq"><h2 id="8680" class="kw kx it bd ky kz la dn lb lc ld dp le kb lf lg lh kf li lj lk kj ll lm ln lo bi translated"><strong class="ak">结论</strong></h2><p id="08d2" class="pw-post-body-paragraph jq jr it js b jt lp jv jw jx lq jz ka kb lr kd ke kf ls kh ki kj lt kl km kn im bi translated">cannon是一个强大的工具，可以对你的WebSockets进行负载测试。它易于配置，并且支持您的负载测试场景的各种配置。你可以在<a class="ae ko" href="https://artillery.io/docs/ws-reference/" rel="noopener ugc nofollow" target="_blank">官方文件</a>中了解更多关于它的特性。</p><p id="122f" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">负载测试愉快！</p></div></div>    
</body>
</html>