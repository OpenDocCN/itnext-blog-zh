# 缩短身份证的练习

> 原文：<https://itnext.io/an-exercise-in-shortening-ids-902b723fdd91?source=collection_archive---------2----------------------->

![](img/608b01d0151d8b0cfad9020749e8a2eb.png)

在 Web 平台上，我们经常处理数字和二进制标签或标识符(id ),我们经常在 URIs 使用它们作为 API 端点或文件名。在这个过程中出现了几个问题:

1.  顺序 id 简化了 id 发现，并可能导致被称为“不安全的直接对象引用” [](#1226) (如果缺少访问控制)的漏洞。它们还会泄露它们识别的数据的大小和速度，从而导致商业情报泄露。
2.  像 UUID 或 MongoDB 的 ObjectId 这样的随机 ID 更好。但是，它们比用于存储的顺序 id 大 2 到 4 倍，并且它们的默认十六进制编码对于 URI 来说不是最佳的，即，导致比必要的字符串更长。

公开 id 的一个流行的解决方案是将一个单独的随机 id 作为“公共”id 存储在一个“私有”序列 id 旁边。这种方法有两个主要问题:

1.  我们必须存储和索引一个大得多的额外字段。
2.  就架构而言，它通过将特定于应用程序的关注点与我们的领域实体相混合，违反了关注点的分离。

如果我们能够以这样一种方式对现有的 id 进行编码:

1.  混淆视听，使它们变得相当难以预测；
2.  在 URI 允许的情况下尽量缩短；
3.  比其他选择做得更快？

下面是由[object 64](https://github.com/zandaqo/objectid64)实施的一个此类解决方案的简要概述。

# Base64

我们对 URI 兼容字符串的要求将我们限制在以下 66 个字符的集合中[:`A-Z a-z 0-9 - _ . ~`。自然，我们会将数字向下舍入到最接近的 2 的幂，剩下 64 个字符。](#d157)

使用现成的 Base64 编码器不会混淆太多。然而，我们可以用可配置的字母表编写自己的编码器，其中改变字符的排列产生不同的编码:

应该注意的是，这不是加密:它只是混淆和缩短 id 足以劝阻业余爱好者。当需要真正隐藏 ids 时，使用加密，但是要注意它对性能的影响。

# 钻头旋转

为了用 Base64 编码数字 id(即数字)，我们可以使用带除法和模运算的经典基本转换算法。然而，由于我们的基数是 2 的幂，我们可以通过使用按位移位代替除法和按位 and 代替模 [](#ce93) 来大大加快实现速度(在合成基准测试中编码速度快 2 到 5 倍):

同样，我们可以通过使用 JavaScript 现在内置的`bigint`类型来处理 64 位顺序 id。

# UUID 起酥油

在野外使用的 UUID 和 ObjectId 的十六进制编码对于我们的 URI 编码用例来说是次优的，我们可以使用效率提高 25%的 base64[⁴](#a235)(即产生更短的字符串)。虽然我们可以使用上面的 Base 转换算法从 Base16 转换到 Base64，但我们可以通过创建一个查找表来做得更好。

请注意，Base16 使用编码 4 位的 16 个字符(2⁴ = 16)，而 Base64 使用编码 6 位的 64 个字符(2⁶ = 64)。因此，三个十六进制字符可以编码 12 位，与两个 Base64 字符相同。由于十六进制三元组的数量限制为 16 = 64 = 4096，我们可以创建一个合理的查找表，将每个三元组链接到一对等效的 Base64 字符，并使用它在不进行任何计算的情况下从一个碱基转换到另一个碱基。

通过从十六进制转换为 Base64，我们将 ObjectId 从 24 个字符缩短为 16 个字符，将 UUID 从 36 个字符缩短为 22 个字符:

而且比其他选择更快，尽管是以牺牲一点内存来换取速度。

当然，如果我们得到二进制形式的 id，我们可以完全放弃十六进制编码，直接编码成 Base64:

因此，一个简单的使 ids URL 友好的任务引导我们考虑架构，深入学习编码和基本转换，使用位旋转技巧和记忆化。最后，你对 id 的选择不应该被它们在 URIs 的样子所左右，甚至不应该被它们暴露的安全问题所左右——你总是可以编码(或加密)成你喜欢的形状。

【**1**】[不安全直接物体参考预防小抄](https://cheatsheetseries.owasp.org/cheatsheets/Insecure_Direct_Object_Reference_Prevention_Cheat_Sheet.html)

[ **2** ] [RFC 4648](https://datatracker.ietf.org/doc/html/rfc4648)

[ **3** ] [钻头旋转齿](http://graphics.stanford.edu/~seander/bithacks.html#ModulusDivisionEasy)

[ **4** ] [二进制到文本编码](https://en.wikipedia.org/wiki/Binary-to-text_encoding#Encoding_plain_text)