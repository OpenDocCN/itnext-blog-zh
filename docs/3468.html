<html>
<head>
<title>Run Rsyslog server in Kubernetes</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在Kubernetes中运行Rsyslog服务器</h1>
<blockquote>原文：<a href="https://itnext.io/run-rsyslog-server-in-kubernetes-bb51a7a6e227?source=collection_archive---------3-----------------------#2019-12-21">https://itnext.io/run-rsyslog-server-in-kubernetes-bb51a7a6e227?source=collection_archive---------3-----------------------#2019-12-21</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/0b941bc7df5161ed3672bbbd7d30a28d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*UnrkdMdY3XBHOUSx9H-sJw.png"/></div></div></figure><p id="73d9" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在我的<a class="ae kw" href="https://medium.com/@sudheer.chamarthi/dockerize-rsyslog-server-f8f9754c37d5?source=your_stories_page---------------------------" rel="noopener">上一篇文章</a>中，我解释了如何对接Rsyslog服务器并将其作为容器运行。现在，在本文中，让我们看看如何使用像Kubernetes这样的容器编排工具，在没有任何人工干预的情况下动态地管理和扩展Rsyslog服务器。</p></div><div class="ab cl kx ky hu kz" role="separator"><span class="la bw bk lb lc ld"/><span class="la bw bk lb lc ld"/><span class="la bw bk lb lc"/></div><div class="ij ik il im in"><h2 id="1cf2" class="le lf iq bd lg lh li dn lj lk ll dp lm kj ln lo lp kn lq lr ls kr lt lu lv lw bi translated">建立和推动您的图像Docker注册表</h2><p id="412f" class="pw-post-body-paragraph jy jz iq ka b kb lx kd ke kf ly kh ki kj lz kl km kn ma kp kq kr mb kt ku kv ij bi translated">构建并推送你的Docker镜像到Docker注册中心，比如DockerHub或ECR。在本文中，我将把我的图像推送到DockerHub。下面是我以前文章的Dockerfile文件的副本。</p><figure class="mc md me mf gt jr"><div class="bz fp l di"><div class="mg mh l"/></div><figcaption class="mi mj gj gh gi mk ml bd b be z dk translated">Dockerfile文件</figcaption></figure></div><div class="ab cl kx ky hu kz" role="separator"><span class="la bw bk lb lc ld"/><span class="la bw bk lb lc ld"/><span class="la bw bk lb lc"/></div><div class="ij ik il im in"><p id="3bd5" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">建立形象。</p><pre class="mc md me mf gt mm mn mo mp aw mq bi"><span id="b646" class="le lf iq mn b gy mr ms l mt mu">docker build -t sudheerc1190/rsyslog .</span></pre><p id="8bcb" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">按下Dockerhub</p><pre class="mc md me mf gt mm mn mo mp aw mq bi"><span id="87c1" class="le lf iq mn b gy mr ms l mt mu">docker push sudheerc1190/rsyslog:latest</span></pre><p id="c3e7" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">请注意，我已经登录到我的Docker注册表。</p><h2 id="f72c" class="le lf iq bd lg lh li dn lj lk ll dp lm kj ln lo lp kn lq lr ls kr lt lu lv lw bi translated">创建单独的名称空间</h2><p id="cb7f" class="pw-post-body-paragraph jy jz iq ka b kb lx kd ke kf ly kh ki kj lz kl km kn ma kp kq kr mb kt ku kv ij bi translated">如果您想要隔离Syslog服务器，请创建一个单独的名称空间，否则您可以在自己选择的名称空间中运行它。部署以下文件以创建rsyslog名称空间</p><figure class="mc md me mf gt jr"><div class="bz fp l di"><div class="mg mh l"/></div><figcaption class="mi mj gj gh gi mk ml bd b be z dk translated">namespace.yaml</figcaption></figure><pre class="mc md me mf gt mm mn mo mp aw mq bi"><span id="1d0c" class="le lf iq mn b gy mr ms l mt mu">kubectl apply -f namespace.yaml</span></pre><h2 id="c360" class="le lf iq bd lg lh li dn lj lk ll dp lm kj ln lo lp kn lq lr ls kr lt lu lv lw bi translated">创建持久存储</h2><p id="86e8" class="pw-post-body-paragraph jy jz iq ka b kb lx kd ke kf ly kh ki kj lz kl km kn ma kp kq kr mb kt ku kv ij bi translated">因为我们的rsyslog服务器从不同种类的应用程序和设备收集日志，所以保存这些数据非常重要。在这个例子中，我将使用AWS EFS来保存数据。</p><p id="41cd" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">如果您的集群中尚未配置efs-provisioner，您可以按照这里的<a class="ae kw" href="https://aws.amazon.com/premiumsupport/knowledge-center/eks-pods-efs/" rel="noopener ugc nofollow" target="_blank">步骤</a>进行配置。我已经配置了我的EFS置备程序。</p><p id="3274" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">部署以下YAML文件以创建持久卷和持久声明。</p><figure class="mc md me mf gt jr"><div class="bz fp l di"><div class="mg mh l"/></div><figcaption class="mi mj gj gh gi mk ml bd b be z dk translated">efs.yaml</figcaption></figure><blockquote class="mv mw mx"><p id="647e" class="jy jz my ka b kb kc kd ke kf kg kh ki mz kk kl km na ko kp kq nb ks kt ku kv ij bi translated"><strong class="ka ir">注</strong>:将fs-xxxx换成有效的EFS ID。</p></blockquote><pre class="mc md me mf gt mm mn mo mp aw mq bi"><span id="53a4" class="le lf iq mn b gy mr ms l mt mu">kubectl apply -f namespace.yaml</span></pre><p id="0b40" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">此外，我确实听说人们对EFS的性能很少关注，但EFS随着最近的功能增加已经改进了很多。如果你有任何关于EFS性能的问题，你可以参考这个AWS文档<a class="ae kw" href="https://docs.aws.amazon.com/efs/latest/ug/performance.html" rel="noopener ugc nofollow" target="_blank">亚马逊EFS性能</a></p><h2 id="0c25" class="le lf iq bd lg lh li dn lj lk ll dp lm kj ln lo lp kn lq lr ls kr lt lu lv lw bi translated">创建Rsyslog部署</h2><p id="f1c5" class="pw-post-body-paragraph jy jz iq ka b kb lx kd ke kf ly kh ki kj lz kl km kn ma kp kq kr mb kt ku kv ij bi translated">部署以下YAML以创建rsyslog部署，其中包含三个具有永久EFS卷的副本。</p><figure class="mc md me mf gt jr"><div class="bz fp l di"><div class="mg mh l"/></div><figcaption class="mi mj gj gh gi mk ml bd b be z dk translated">部署. yaml</figcaption></figure><pre class="mc md me mf gt mm mn mo mp aw mq bi"><span id="9b70" class="le lf iq mn b gy mr ms l mt mu">kubectl apply -f <a class="ae kw" href="https://gist.github.com/sudheerchamarthi/8f362b72b1f7959009a7fc1d19e91af6" rel="noopener ugc nofollow" target="_blank">deployment</a>.yaml</span></pre><p id="2abf" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">验证部署状态。您可以在这里看到，我的3个副本都在运行</p><pre class="mc md me mf gt mm mn mo mp aw mq bi"><span id="5c4a" class="le lf iq mn b gy mr ms l mt mu">kubectl get deployment -n rsyslog<br/>NAME                 READY   UP-TO-DATE   AVAILABLE   AGE<br/>rsyslog-deployment   3/3     3            3           3m19s</span></pre><h2 id="b9c8" class="le lf iq bd lg lh li dn lj lk ll dp lm kj ln lo lp kn lq lr ls kr lt lu lv lw bi translated">向服务公开部署</h2><p id="1563" class="pw-post-body-paragraph jy jz iq ka b kb lx kd ke kf ly kh ki kj lz kl km kn ma kp kq kr mb kt ku kv ij bi translated">公开服务，以便该集群中的任何其他pod都可以访问和发布日志。</p><figure class="mc md me mf gt jr"><div class="bz fp l di"><div class="mg mh l"/></div><figcaption class="mi mj gj gh gi mk ml bd b be z dk translated">service.yaml</figcaption></figure><pre class="mc md me mf gt mm mn mo mp aw mq bi"><span id="1860" class="le lf iq mn b gy mr ms l mt mu">kubectl apply -f service.yaml</span></pre><h2 id="254a" class="le lf iq bd lg lh li dn lj lk ll dp lm kj ln lo lp kn lq lr ls kr lt lu lv lw bi translated">向NLB公开服务</h2><p id="abf2" class="pw-post-body-paragraph jy jz iq ka b kb lx kd ke kf ly kh ki kj lz kl km kn ma kp kq kr mb kt ku kv ij bi translated">让我们将服务公开给NLB，这样我们就可以开始接受来自整个环境中运行的应用程序的日志。暴露于NLB还帮助我们创建VPC端点，并安全地允许我们接受同一地区任何VPC之间的连接。</p><p id="6dee" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">部署以下内容，并等待几分钟，直到NLB配置成功。</p><figure class="mc md me mf gt jr"><div class="bz fp l di"><div class="mg mh l"/></div><figcaption class="mi mj gj gh gi mk ml bd b be z dk translated">nlb-ingress.yaml</figcaption></figure><pre class="mc md me mf gt mm mn mo mp aw mq bi"><span id="ae4b" class="le lf iq mn b gy mr ms l mt mu">kubectl apply -f nlb-ingress.yaml</span></pre><p id="6735" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">几分钟后，描述服务并复制NLB端点。</p><pre class="mc md me mf gt mm mn mo mp aw mq bi"><span id="2cb1" class="le lf iq mn b gy mr ms l mt mu">kubectl get svc -n rsyslog</span></pre><p id="002a" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">现在我们有了Rsyslog服务器，可以接受来自应用程序的日志了。我们来测试一下。</p><h2 id="b2e4" class="le lf iq bd lg lh li dn lj lk ll dp lm kj ln lo lp kn lq lr ls kr lt lu lv lw bi translated">测试</h2><p id="a150" class="pw-post-body-paragraph jy jz iq ka b kb lx kd ke kf ly kh ki kj lz kl km kn ma kp kq kr mb kt ku kv ij bi translated">运行以下Docker容器，该容器将日志流式传输到Syslog服务器(用您的NLB端点替换NLB端点)。</p><pre class="mc md me mf gt mm mn mo mp aw mq bi"><span id="1348" class="le lf iq mn b gy mr ms l mt mu">docker run --log-driver syslog --log-opt syslog-address=tcp://&lt;NLBENDPOINT&gt;:514 alpine echo hello world</span></pre><p id="d78d" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">现在进入rsyslog pod并导航到/var/log/remote/</p><pre class="mc md me mf gt mm mn mo mp aw mq bi"><span id="d16d" class="le lf iq mn b gy mr ms l mt mu">kubectl get pods -n rsyslog</span></pre><p id="6c16" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">将任何pod名称和exec复制到其中(替换pod Name)。</p><pre class="mc md me mf gt mm mn mo mp aw mq bi"><span id="bafb" class="le lf iq mn b gy mr ms l mt mu">kubectl -n rsyslog exec -it &lt;podname&gt; -- ls /var/log/remote/2019/12/21/</span></pre><p id="b3f8" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">耶！我能看到我的日志。</p><h2 id="e858" class="le lf iq bd lg lh li dn lj lk ll dp lm kj ln lo lp kn lq lr ls kr lt lu lv lw bi translated">缩放比例</h2><p id="9837" class="pw-post-body-paragraph jy jz iq ka b kb lx kd ke kf ly kh ki kj lz kl km kn ma kp kq kr mb kt ku kv ij bi translated">现在我们已经让rsyslog作为Kubernetes部署完美地工作了。我们可以使用HPA轻松扩展到单元。</p><h2 id="c040" class="le lf iq bd lg lh li dn lj lk ll dp lm kj ln lo lp kn lq lr ls kr lt lu lv lw bi translated">额外资源</h2><p id="cb22" class="pw-post-body-paragraph jy jz iq ka b kb lx kd ke kf ly kh ki kj lz kl km kn ma kp kq kr mb kt ku kv ij bi translated">所有YAML的文件都可以在这里找到:<a class="ae kw" href="https://github.com/sudheerchamarthi/rsyslogd.git" rel="noopener ugc nofollow" target="_blank">https://github.com/sudheerchamarthi/rsyslogd.git</a></p></div></div>    
</body>
</html>