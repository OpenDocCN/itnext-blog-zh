<html>
<head>
<title>Need A Container Image Registry And Helm Chart Repository ? Go Harbor !</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">需要一个容器图像注册表和舵图表存储库？去海港！</h1>
<blockquote>原文：<a href="https://itnext.io/need-a-container-image-registry-and-helm-chart-repository-go-harbor-b0c0d4eafd3b?source=collection_archive---------0-----------------------#2019-11-25">https://itnext.io/need-a-container-image-registry-and-helm-chart-repository-go-harbor-b0c0d4eafd3b?source=collection_archive---------0-----------------------#2019-11-25</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="3cdf" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">CNCF孵化项目概述</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/d37093bca036a165813dc0c3b2a7a724.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*FEChFwTaaiClBo8qBypm1g.jpeg"/></div></div></figure><p id="6182" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated"><a class="ae lq" href="https://goharbor.io" rel="noopener ugc nofollow" target="_blank">港湾</a>是CNCF的项目，目前处于孵化阶段。这是一个容器图像注册和掌舵图表存储库，非常注重安全性。看看这个令人印象深刻的功能列表:</p><ul class=""><li id="9e0e" class="lr ls it kw b kx ky la lb ld lt lh lu ll lv lp lw lx ly lz bi translated">安全和漏洞分析</li><li id="7588" class="lr ls it kw b kx ma la mb ld mc lh md ll me lp lw lx ly lz bi translated">内容登录和验证</li><li id="483a" class="lr ls it kw b kx ma la mb ld mc lh md ll me lp lw lx ly lz bi translated">多租户</li><li id="4b98" class="lr ls it kw b kx ma la mb ld mc lh md ll me lp lw lx ly lz bi translated">跨多个实例的映像复制</li><li id="9765" class="lr ls it kw b kx ma la mb ld mc lh md ll me lp lw lx ly lz bi translated">RBAC</li><li id="ab6e" class="lr ls it kw b kx ma la mb ld mc lh md ll me lp lw lx ly lz bi translated">API和Web用户界面</li></ul><p id="edea" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">在这篇文章中，我们将看到如何用TLS来设置Harbor，并展示它的一些特性。</p></div><div class="ab cl mf mg hx mh" role="separator"><span class="mi bw bk mj mk ml"/><span class="mi bw bk mj mk ml"/><span class="mi bw bk mj mk"/></div><div class="im in io ip iq"><h1 id="2ce8" class="mm mn it bd mo mp mq mr ms mt mu mv mw jz mx ka my kc mz kd na kf nb kg nc nd bi translated">先决条件</h1><p id="8b64" class="pw-post-body-paragraph ku kv it kw b kx ne ju kz la nf jx lc ld ng lf lg lh nh lj lk ll ni ln lo lp im bi translated">在任何云提供商上启动虚拟机(有很多选择，其中包括我最喜欢的:<a class="ae lq" href="https://digitalocean.com" rel="noopener ugc nofollow" target="_blank">数字海洋</a>、<a class="ae lq" href="https://civo.com" rel="noopener ugc nofollow" target="_blank"> Civo </a>、<a class="ae lq" href="https://www.exoscale.com/" rel="noopener ugc nofollow" target="_blank"> Exoscale </a>、…)。</p><p id="16ad" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">安装Docker，这可以通过以下命令快速完成:</p><pre class="kj kk kl km gt nj nk nl nm aw nn bi"><span id="07c5" class="no mn it nk b gy np nq l nr ns">$ curl https://get.docker.com | sh</span></pre><p id="d613" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">使用以下命令安装Docker Compose:</p><pre class="kj kk kl km gt nj nk nl nm aw nn bi"><span id="0886" class="no mn it nk b gy np nq l nr ns">$ sudo curl -L "<a class="ae lq" href="https://github.com/docker/compose/releases/download/1.24.1/docker-compose-$(uname" rel="noopener ugc nofollow" target="_blank">https://github.com/docker/compose/releases/download/1.24.1/docker-compose-$(uname</a> -s)-$(uname -m)" -o /usr/local/bin/docker-compose</span><span id="1def" class="no mn it nk b gy nt nq l nr ns">$ sudo chmod +x /usr/local/bin/docker-compose</span></pre><p id="b1ca" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">注意:Harbor是一个与Docker Compose一起运行的微服务应用程序，它包括以下组件:</p><ul class=""><li id="7025" class="lr ls it kw b kx ky la lb ld lt lh lu ll lv lp lw lx ly lz bi translated">一种数据库系统</li><li id="d522" class="lr ls it kw b kx ma la mb ld mc lh md ll me lp lw lx ly lz bi translated">雷迪斯</li><li id="ac76" class="lr ls it kw b kx ma la mb ld mc lh md ll me lp lw lx ly lz bi translated">克莱尔</li><li id="a82d" class="lr ls it kw b kx ma la mb ld mc lh md ll me lp lw lx ly lz bi translated">比格</li><li id="db0e" class="lr ls it kw b kx ma la mb ld mc lh md ll me lp lw lx ly lz bi translated">海图博物馆</li><li id="fd60" class="lr ls it kw b kx ma la mb ld mc lh md ll me lp lw lx ly lz bi translated">码头工人/配送</li><li id="c7b1" class="lr ls it kw b kx ma la mb ld mc lh md ll me lp lw lx ly lz bi translated">码头工人/公证人</li><li id="c232" class="lr ls it kw b kx ma la mb ld mc lh md ll me lp lw lx ly lz bi translated">舵</li><li id="34f1" class="lr ls it kw b kx ma la mb ld mc lh md ll me lp lw lx ly lz bi translated">斯瓦格-ui</li></ul><p id="0592" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">为了保护注册表，我们需要创建一个TLS证书。在这篇文章的例子中，我们已经创建了一个证书，所以注册表可以在<em class="nu">https://registry . tech whale . io</em>上使用</p><p id="7d2b" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">注意:在这个<a class="ae lq" rel="noopener ugc nofollow" target="_blank" href="/wildcard-lets-encrypt-certificate-2b6133a1acdf">以前的帖子</a>中，我们展示了如何使用DNS-01挑战创建一个通配符证书</p></div><div class="ab cl mf mg hx mh" role="separator"><span class="mi bw bk mj mk ml"/><span class="mi bw bk mj mk ml"/><span class="mi bw bk mj mk"/></div><div class="im in io ip iq"><h1 id="084f" class="mm mn it bd mo mp mq mr ms mt mu mv mw jz mx ka my kc mz kd na kf nb kg nc nd bi translated">安装港口</h1><p id="cf77" class="pw-post-body-paragraph ku kv it kw b kx ne ju kz la nf jx lc ld ng lf lg lh nh lj lk ll ni ln lo lp im bi translated">首先，我们下载最新的版本(在撰写本文时是1.9.3 ),并解压归档文件:</p><pre class="kj kk kl km gt nj nk nl nm aw nn bi"><span id="a0e4" class="no mn it nk b gy np nq l nr ns">$ curl -L <a class="ae lq" href="https://github.com/goharbor/harbor/releases/download/v1.9.3/harbor-online-installer-v1.9.3.tgz" rel="noopener ugc nofollow" target="_blank">https://github.com/goharbor/harbor/releases/download/v1.9.3/harbor-online-installer-v1.9.3.tgz</a> -o harbor.tgz</span><span id="2603" class="no mn it nk b gy nt nq l nr ns">$ tar xvf harbor.tgz</span></pre><p id="b1b3" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">接下来，我们需要通过<em class="nu"> harbor.yml </em>文件来配置Harbor。在本例中，我们仅更改:</p><ul class=""><li id="5500" class="lr ls it kw b kx ky la lb ld lt lh lu ll lv lp lw lx ly lz bi translated">主机名作为注册表可在<em class="nu"> registry.techwhale.io </em>上访问</li><li id="f757" class="lr ls it kw b kx ma la mb ld mc lh md ll me lp lw lx ly lz bi translated">提供域证书和私有密钥的https配置(我们之前分别将这些文件复制到了<em class="nu"> /etc/ssl/certs </em>和<em class="nu"> /etc/ssl/private </em>文件夹中)</li></ul><pre class="kj kk kl km gt nj nk nl nm aw nn bi"><span id="476a" class="no mn it nk b gy np nq l nr ns"># The hostname to access admin UI and registry service.<br/>hostname: registry.techwhale.io</span><span id="3df9" class="no mn it nk b gy nt nq l nr ns"># http related config<br/>http:<br/>  port: 80</span><span id="fa7a" class="no mn it nk b gy nt nq l nr ns"># https related config<br/>https:<br/>  port: 443<br/>  certificate: /etc/ssl/certs/registry-fullchain.pem<br/>  private_key: /etc/ssl/private/registry-privkey.pem</span></pre><p id="5db3" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">一旦配置完成，我们就可以运行<em class="nu"> install.sh </em> shell脚本来安装Harbor了。有几个选项可用:</p><ul class=""><li id="1d50" class="lr ls it kw b kx ky la lb ld lt lh lu ll lv lp lw lx ly lz bi translated">-使用-公证人，公证人确保创建和验证与容器图像相关的数字签名</li><li id="372b" class="lr ls it kw b kx ma la mb ld mc lh md ll me lp lw lx ly lz bi translated">-用-clair，<a class="ae lq" href="https://github.com/quay/clair" rel="noopener ugc nofollow" target="_blank"> Clair </a>扫描二进制图像，检查它们是否包含现有的<a class="ae lq" href="https://cve.mitre.org" rel="noopener ugc nofollow" target="_blank"> CVE </a></li><li id="e329" class="lr ls it kw b kx ma la mb ld mc lh md ll me lp lw lx ly lz bi translated">- with-chartmuseum，<a class="ae lq" href="https://github.com/helm/chartmuseum" rel="noopener ugc nofollow" target="_blank"> ChartMuseum </a>主持舵图</li></ul><p id="d602" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">在本例中，我们将只安装带有Clair scanner和ChartMuseum的Harbor。</p><pre class="kj kk kl km gt nj nk nl nm aw nn bi"><span id="fde3" class="no mn it nk b gy np nq l nr ns">$ sudo ./install.sh --with-clair --with-chartmuseum</span></pre><p id="67b6" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">然后，使用Docker Compose，我们确保所有组件都在运行:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nv"><img src="../Images/d962eabe3eab60713fb6a539109aabb6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*F2HXd-QaXtwsw9nwLCKT2A.png"/></div></div><figcaption class="nw nx gj gh gi ny nz bd b be z dk translated">通过Harbor运行的组件</figcaption></figure><p id="7b57" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">我们现在可以访问<em class="nu">https://registry . tech whale . io</em>上的界面</p><p id="cec2" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">注意:默认凭证为<em class="nu">admin</em>/<em class="nu">harbor 12345</em>，请确保在首次登录时或在安装前更改<em class="nu"> harbor.yml </em>配置文件中的密码</p><div class="kj kk kl km gt ab cb"><figure class="oa kn ob oc od oe of paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><img src="../Images/8e5316c747f3363fdd825b01966b7189.png" data-original-src="https://miro.medium.com/v2/resize:fit:1002/format:webp/1*kx-w3QG4c78WgZabvd0wxA.png"/></div></figure><figure class="oa kn ob oc od oe of paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><img src="../Images/5723cb13bcd40a0dbd32d725cd6f00cb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1002/format:webp/1*iVV3z8Rk3JMBJO9RisSyDw.png"/></div></figure></div><p id="409c" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">我们登陆<em class="nu">项目</em>页面，默认<em class="nu">库</em>项目已经在安装过程中创建。现在让我们创建一个新项目并展示如何使用它。</p></div><div class="ab cl mf mg hx mh" role="separator"><span class="mi bw bk mj mk ml"/><span class="mi bw bk mj mk ml"/><span class="mi bw bk mj mk"/></div><div class="im in io ip iq"><h1 id="7b30" class="mm mn it bd mo mp mq mr ms mt mu mv mw jz mx ka my kc mz kd na kf nb kg nc nd bi translated">创建项目</h1><p id="cd84" class="pw-post-body-paragraph ku kv it kw b kx ne ju kz la nf jx lc ld ng lf lg lh nh lj lk ll ni ln lo lp im bi translated">首先，从项目菜单中，我们创建一个名为<em class="nu"> demo </em>的新项目，让我们考虑这个项目用于托管微服务应用程序的组件。</p><div class="kj kk kl km gt ab cb"><figure class="oa kn ob oc od oe of paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><img src="../Images/13f03b9c2d5a412037f84dff1069828c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1000/format:webp/1*gXPzTitjAcgwja1RrhyWzQ.png"/></div></figure><figure class="oa kn ob oc od oe of paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><img src="../Images/a6e0fe0d1c5f5d9c3cbed5fdbad4a7be.png" data-original-src="https://miro.medium.com/v2/resize:fit:1000/format:webp/1*KNwTLGe7tDchM3-bDgALkw.png"/></div><figcaption class="nw nx gj gh gi ny nz bd b be z dk og di oh oi translated">创建新项目</figcaption></figure></div><p id="7866" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">对于每个项目，一个<em class="nu">总结</em>菜单提供主要信息:</p><ul class=""><li id="62c5" class="lr ls it kw b kx ky la lb ld lt lh lu ll lv lp lw lx ly lz bi translated">容器映像存储库的数量</li><li id="ef61" class="lr ls it kw b kx ma la mb ld mc lh md ll me lp lw lx ly lz bi translated">托管的舵图表的数量</li><li id="8c1b" class="lr ls it kw b kx ma la mb ld mc lh md ll me lp lw lx ly lz bi translated">项目的成员(我们没有在默认的管理员之上创建额外的用户)</li></ul><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi oj"><img src="../Images/538b45d845626a98acbe49b8f5ed9c27.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*9BuFbJJCQYJjv_nhPwmqMQ.png"/></div></div><figcaption class="nw nx gj gh gi ny nz bd b be z dk translated">项目摘要视图</figcaption></figure><p id="8f91" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">对于每个项目，水平导航菜单定义了不同的可用功能:</p><ul class=""><li id="f1d9" class="lr ls it kw b kx ky la lb ld lt lh lu ll lv lp lw lx ly lz bi translated">存储库:项目中托管的容器图像存储库</li><li id="b554" class="lr ls it kw b kx ma la mb ld mc lh md ll me lp lw lx ly lz bi translated">舵轮图:Kubernetes在项目中托管的舵轮图</li><li id="178f" class="lr ls it kw b kx ma la mb ld mc lh md ll me lp lw lx ly lz bi translated">成员:属于项目及其相关角色的用户</li><li id="52f3" class="lr ls it kw b kx ma la mb ld mc lh md ll me lp lw lx ly lz bi translated">标签:可以添加到容器图像中并用于过滤的字符串</li><li id="df0e" class="lr ls it kw b kx ma la mb ld mc lh md ll me lp lw lx ly lz bi translated">日志:显示在存储库上执行的所有操作</li><li id="d182" class="lr ls it kw b kx ma la mb ld mc lh md ll me lp lw lx ly lz bi translated">机器人帐户:定义某种可以执行自动任务的系统用户(推/拉容器图像和舵图)</li><li id="1598" class="lr ls it kw b kx ma la mb ld mc lh md ll me lp lw lx ly lz bi translated">标签保留:定义移除图像标签的规则</li><li id="d3b9" class="lr ls it kw b kx ma la mb ld mc lh md ll me lp lw lx ly lz bi translated">Webhook:用于在项目中执行某个操作时通知外部HTTP端点(推/拉/删除图像、扫描成功/失败、上传/下载/删除舵图)。例如，使用webhook，我们可以触发一个新图像的重新部署</li><li id="c9f1" class="lr ls it kw b kx ma la mb ld mc lh md ll me lp lw lx ly lz bi translated">配置:用于指定项目可见性(公共可用或限制给定的一组用户)和一些与CVE扫描相关的选项</li></ul><h2 id="f6b5" class="no mn it bd mo ok ol dn ms om on dp mw ld oo op my lh oq or na ll os ot nc ou bi translated">项目配置</h2><p id="1834" class="pw-post-body-paragraph ku kv it kw b kx ne ju kz la nf jx lc ld ng lf lg lh nh lj lk ll ni ln lo lp im bi translated">在项目的“配置”选项卡中，我们检查了以下选项:</p><ul class=""><li id="6bd8" class="lr ls it kw b kx ky la lb ld lt lh lu ll lv lp lw lx ly lz bi translated"><em class="nu">“推送时自动扫描图像”，</em>以便每次新图像被推送到注册表时，对照已知的CVE进行分析(CVE内部数据库定期更新)</li><li id="fbb5" class="lr ls it kw b kx ma la mb ld mc lh md ll me lp lw lx ly lz bi translated"><em class="nu">“阻止易受攻击的映像运行”</em>，这样如果发现某些漏洞(本例中仅高漏洞)就无法拉取映像</li></ul><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ov"><img src="../Images/993516b42dd0d1b9849c28506016e339.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*wK5Xy819n2iPu0uO5nQudw.png"/></div></div><figcaption class="nw nx gj gh gi ny nz bd b be z dk translated">项目配置</figcaption></figure><h2 id="d3d3" class="no mn it bd mo ok ol dn ms om on dp mw ld oo op my lh oq or na ll os ot nc ou bi translated">容器图像注册表</h2><p id="d3bf" class="pw-post-body-paragraph ku kv it kw b kx ne ju kz la nf jx lc ld ng lf lg lh nh lj lk ll ni ln lo lp im bi translated">我们现在将把一个容器映像推送到项目中。从<em class="nu">存储库</em>菜单中，我们选择<em class="nu">推送图像</em>下拉菜单，这表明在将图像推送到项目之前必须如何对其进行标记。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ow"><img src="../Images/2595ca5a6662a7a9d2518544733e274c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*PoTJbh0aFKEJnsBI35NfeA.png"/></div></div><figcaption class="nw nx gj gh gi ny nz bd b be z dk translated">项目的存储库菜单</figcaption></figure><p id="5c25" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">假设我们的<em class="nu">演示</em>项目用于托管一个微服务应用程序的所有组件，其中一个名为<em class="nu"> api </em>的微服务已经打包在一个标记为<em class="nu"> api:0.1 </em>的本地映像中。</p><p id="9583" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">为了将此图像推送到项目中，我们首先需要对其进行标记，使其包含注册表的URL:</p><pre class="kj kk kl km gt nj nk nl nm aw nn bi"><span id="f396" class="no mn it nk b gy np nq l nr ns">$ docker image tag api:1.2 registry.techwhale.io/demo/api:0.1</span></pre><p id="0e30" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">注意:标记一个图像仅仅意味着给它一个额外的参考</p><p id="da54" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">接下来，我们需要登录以授权Docker守护进程与注册表进行通信:</p><pre class="kj kk kl km gt nj nk nl nm aw nn bi"><span id="aeba" class="no mn it nk b gy np nq l nr ns">$ docker login -u admin registry.techwhale.io</span></pre><p id="1770" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">然后，我们可以将图像推送到项目中:</p><pre class="kj kk kl km gt nj nk nl nm aw nn bi"><span id="8ff2" class="no mn it nk b gy np nq l nr ns">$ docker image push registry.techwhale.io/demo/api:0.1</span></pre><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ox"><img src="../Images/e4f9aa0824ee287d03563a7758035ca3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*tXQnsYs9AiTPvvzK1PHxsQ.png"/></div></div></figure><p id="b87e" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">然后我们可以在<em class="nu">演示/api </em>存储库中看到新的图像</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ow"><img src="../Images/552d9656d76c70b449a8383094f022c8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*QJJCng8Azdn-ZpDbeKUwDw.png"/></div></div></figure><p id="37d4" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">点击存储库，我们得到已经推送的标签列表。在与标签相关的信息中，<em class="nu">漏洞</em>列给出了图像推送后扫描运行的状态。正如我们在下面的截图中看到的，图像<em class="nu"> demo/api:1.0 </em>包含几个漏洞:</p><ul class=""><li id="9018" class="lr ls it kw b kx ky la lb ld lt lh lu ll lv lp lw lx ly lz bi translated">5高</li><li id="baa0" class="lr ls it kw b kx ma la mb ld mc lh md ll me lp lw lx ly lz bi translated">16中等</li><li id="f126" class="lr ls it kw b kx ma la mb ld mc lh md ll me lp lw lx ly lz bi translated">10低</li></ul><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ow"><img src="../Images/8143535553a253e188b59c3717b199d3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*7DSClgyMTvNo8-FNKdbh6w.png"/></div></div><figcaption class="nw nx gj gh gi ny nz bd b be z dk translated">图像扫描的结果</figcaption></figure><p id="2646" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">知道一个图像是否包含一些漏洞非常重要，但也很难判断我们是否应该继续使用它。这取决于几个因素:它是对外部世界公开还是只在内部运行，该漏洞能否被利用，…</p><p id="29fd" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">让我们从另一台机器上提取这个图像(首先需要登录):</p><pre class="kj kk kl km gt nj nk nl nm aw nn bi"><span id="c594" class="no mn it nk b gy np nq l nr ns"><strong class="nk iu">$ docker image pull registry.techwhale.io/demo/api:0.1</strong><br/>Error response from daemon: unknown: The severity of vulnerability of the image: "high" is equal or higher than the threshold in project setting: "high".</span></pre><p id="3779" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">正如我们所料，此图像不能被拉，因为它包含高漏洞。这来自于我们在项目配置中选择的选项。</p><h2 id="4261" class="no mn it bd mo ok ol dn ms om on dp mw ld oo op my lh oq or na ll os ot nc ou bi translated">舵图储存库</h2><p id="3885" class="pw-post-body-paragraph ku kv it kw b kx ne ju kz la nf jx lc ld ng lf lg lh nh lj lk ll ni ln lo lp im bi translated">Harbor也可以作为一个舵轮图表库，现在让我们看看如何推动一个图表。</p><p id="b178" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">首先，我们在本地安装helm客户端:(下面的例子使用MacOS版本)</p><pre class="kj kk kl km gt nj nk nl nm aw nn bi"><span id="8955" class="no mn it nk b gy np nq l nr ns">$ curl -O https://get.helm.sh/helm-v3.0.0-darwin-amd64.tar.gz</span><span id="b6ad" class="no mn it nk b gy nt nq l nr ns">$ tar -zxvf helm-v3.0.0-darwin-amd64.tar.gz</span><span id="bba6" class="no mn it nk b gy nt nq l nr ns">$ mv darwin-amd64/helm /usr/local/bin/</span></pre><p id="64f6" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">注意:<a class="ae lq" href="https://helm.sh/blog/helm-3-released/" rel="noopener ugc nofollow" target="_blank">版本3刚刚发布</a>，Helm现在只是客户端，集群中不再有Tiller服务器</p><p id="759a" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">假设我们已经将我们的<em class="nu"> api </em>打包到一个舵图中:</p><pre class="kj kk kl km gt nj nk nl nm aw nn bi"><span id="8a55" class="no mn it nk b gy np nq l nr ns">$ tree api<br/>api<br/>├── Chart.yaml<br/>├── charts<br/>├── templates<br/>│ ├── NOTES.txt<br/>│ ├── _helpers.tpl<br/>│ ├── deployment.yaml<br/>│ ├── service.yaml<br/>│ └── tests<br/>│ └── test-connection.yaml<br/>└── values.yaml<br/>3 directories, 9 files</span></pre><p id="8a3a" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">接下来，我们可以用下面的命令将图表打包成一个<em class="nu">tar.gz</em>档案:</p><pre class="kj kk kl km gt nj nk nl nm aw nn bi"><span id="33c3" class="no mn it nk b gy np nq l nr ns">$ helm package ./api<br/>Successfully packaged chart and saved it to: /Users/luc/api-0.1.0.tgz</span></pre><p id="10fb" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">然后，我们可以从<em class="nu">舵图表</em>选项卡上传图表</p><div class="kj kk kl km gt ab cb"><figure class="oa kn ob oc od oe of paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><img src="../Images/4b83a16be252c14b9fb6b03e4989ab20.png" data-original-src="https://miro.medium.com/v2/resize:fit:1002/format:webp/1*UvF7iF-e3FpieFnpayD6jQ.png"/></div></figure><figure class="oa kn ob oc od oe of paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><img src="../Images/08bda09fcc3f396caaea74df8f685584.png" data-original-src="https://miro.medium.com/v2/resize:fit:1002/format:webp/1*iVKTL0RtRuP4GrTmqOPyuw.png"/></div><figcaption class="nw nx gj gh gi ny nz bd b be z dk og di oh oi translated">在项目中上传图表</figcaption></figure></div><p id="9f93" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">一旦图表在我们的远程存储库中，让我们尝试从远程机器将它安装到Kubernetes集群上。</p><p id="d636" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">首先我们需要在那台机器上安装头盔(<a class="ae lq" href="https://helm.sh/docs/intro/install/" rel="noopener ugc nofollow" target="_blank">https://helm.sh/docs/intro/install/</a>)</p><p id="11c3" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">接下来，我们需要将存储库添加到Helm客户端，可以从其中获得图表:</p><pre class="kj kk kl km gt nj nk nl nm aw nn bi"><span id="5b4c" class="no mn it nk b gy np nq l nr ns">$  helm repo add \<br/>   --username=admin \<br/>   --password=XXX myrepo \<br/>   https://registry.techwhale.io/chartrepo</span></pre><p id="98b9" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">然后，我们可以将图表部署到helm客户端可以访问的Kubernetes集群:</p><pre class="kj kk kl km gt nj nk nl nm aw nn bi"><span id="b64d" class="no mn it nk b gy np nq l nr ns">$ helm install api api<br/>NAME: api<br/>LAST DEPLOYED: Sat Nov 23 16:37:42 2019<br/>NAMESPACE: default<br/>STATUS: deployed<br/>REVISION: 1<br/>NOTES:<br/>1. Get the application URL by running these commands:<br/>  export POD_NAME=$(kubectl get pods --namespace default -l "app.kubernetes.io/name=api,app.kubernetes.io/instance=api" -o jsonpath="{.items[0].metadata.name}")<br/>  echo "Visit <a class="ae lq" href="http://127.0.0.1:8080" rel="noopener ugc nofollow" target="_blank">http://127.0.0.1:8080</a> to use your application"<br/>  kubectl --namespace default port-forward $POD_NAME 8080:80</span></pre></div><div class="ab cl mf mg hx mh" role="separator"><span class="mi bw bk mj mk ml"/><span class="mi bw bk mj mk ml"/><span class="mi bw bk mj mk"/></div><div class="im in io ip iq"><h1 id="3543" class="mm mn it bd mo mp mq mr ms mt mu mv mw jz mx ka my kc mz kd na kf nb kg nc nd bi translated">清除</h1><p id="0246" class="pw-post-body-paragraph ku kv it kw b kx ne ju kz la nf jx lc ld ng lf lg lh nh lj lk ll ni ln lo lp im bi translated">注册表是一个Docker编写应用程序。它可以用通常的命令删除:</p><pre class="kj kk kl km gt nj nk nl nm aw nn bi"><span id="e08e" class="no mn it nk b gy np nq l nr ns">$ docker-compose down -v</span></pre><p id="efc9" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">默认情况下，所有数据都存储在<em class="nu"> /data/database </em>和<em class="nu"> /data/registry </em>文件夹中(这可以在<em class="nu"> harbor.yml </em>文件中配置)。</p><pre class="kj kk kl km gt nj nk nl nm aw nn bi"><span id="8960" class="no mn it nk b gy np nq l nr ns">$ rm -r /data/database<br/>$ rm -r /data/registry</span></pre></div><div class="ab cl mf mg hx mh" role="separator"><span class="mi bw bk mj mk ml"/><span class="mi bw bk mj mk ml"/><span class="mi bw bk mj mk"/></div><div class="im in io ip iq"><h1 id="d1e6" class="mm mn it bd mo mp mq mr ms mt mu mv mw jz mx ka my kc mz kd na kf nb kg nc nd bi translated">摘要</h1><p id="438e" class="pw-post-body-paragraph ku kv it kw b kx ne ju kz la nf jx lc ld ng lf lg lh nh lj lk ll ni ln lo lp im bi translated">在这篇文章中，我们解释了如何安装Harbor，并看到这是一个使用默认选项的非常简单的过程。我们给出了容器图像注册和舵图表存储库的例子，但只是触及了表面，因为有许多可用的功能和配置选项:图像签名和RBAC是我们可以在下一篇文章中说明的一些。</p></div></div>    
</body>
</html>