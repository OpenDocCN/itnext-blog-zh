<html>
<head>
<title>Custom Error Page for Nginx Ingress Controller</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Nginx入口控制器的自定义错误页面</h1>
<blockquote>原文：<a href="https://itnext.io/custom-error-page-for-nginx-ingress-controller-cca4cfa82bb9?source=collection_archive---------3-----------------------#2019-05-05">https://itnext.io/custom-error-page-for-nginx-ingress-controller-cca4cfa82bb9?source=collection_archive---------3-----------------------#2019-05-05</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><figure class="gl gn jr js jt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi jq"><img src="../Images/3fdd11c0958a3e9e8512b7b0ec487a1e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*TEiowefg8wEd06R8.jpg"/></div></div></figure><p id="c5ce" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">有时我们不想使用Nginx入口控制器的默认错误页面。例如，作为基本安全需求的一部分，我们不能暴露Nginx服务器的指纹，如下所示。</p><figure class="la lb lc ld gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi kz"><img src="../Images/6380a28569b88beabb8c632d365b7e9b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*2qO1yGvHUs-4YjOW9uCPEg.png"/></div></div></figure><h2 id="627b" class="le lf it bd lg lh li dn lj lk ll dp lm km ln lo lp kq lq lr ls ku lt lu lv lw bi translated">测试应用程序</h2><p id="b6bd" class="pw-post-body-paragraph kb kc it kd b ke lx kg kh ki ly kk kl km lz ko kp kq ma ks kt ku mb kw kx ky im bi translated">为了说明这一点，让我们创建一个实现了以下HTTP处理程序的示例应用程序。它接受一个URL参数，并根据这个参数返回HTTP状态。</p><pre class="la lb lc ld gt mc md me mf aw mg bi"><span id="ce3e" class="le lf it md b gy mh mi l mj mk">func errHandler(w http.ResponseWriter, r *http.Request) {<br/> code := r.FormValue("code")t <br/> status, err := strconv.Atoi(code)<br/> if err != nil {<br/>  log.Printf("Failed to convert status:%v", err)<br/>  w.WriteHeader(500)<br/>  fmt.Fprintf(w, "Unknown code")<br/>  return<br/> }</span><span id="ac95" class="le lf it md b gy ml mi l mj mk"> w.WriteHeader(status)<br/> fmt.Fprintf(w, "Code=%s", code)<br/>}</span></pre><p id="ac81" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">构建docker映像，推入docker hub，使用以下入口、服务和部署将其部署到我的测试K3s实例中。(<em class="mm">我已经从K3s中移除了默认的traefik入口控制器，使用默认设置部署了nginx入口舵图表。)</em></p><pre class="la lb lc ld gt mc md me mf aw mg bi"><span id="9ed1" class="le lf it md b gy mh mi l mj mk">apiVersion: extensions/v1beta1<br/>kind: Ingress<br/>metadata:<br/>  annotations:<br/>    kubernetes.io/ingress.class: nginx<br/>    ingress.kubernetes.io/rewrite-target: /<br/>  labels:<br/>    app: err-status-test<br/>  name: err-status-test<br/>spec:<br/>  backend:<br/>    serviceName: err-status-test<br/>    servicePort: 80<br/>  rules:<br/>  - host: err-test.192.168.64.5.nip.io<br/>    http:<br/>      paths:<br/>      - path: /<br/>        backend:<br/>          serviceName: err-status-test<br/>          servicePort: 8080<br/>---<br/>apiVersion: v1<br/>kind: Service<br/>metadata:<br/>  name: err-status-test<br/>  labels:<br/>    app: err-status-test<br/>spec:<br/>  type: NodePort<br/>  ports:<br/>  - port: 80<br/>    targetPort: 8080<br/>    protocol: TCP<br/>    name: http<br/>  selector:<br/>    app: err-status-test<br/>---<br/>apiVersion: apps/v1<br/>kind: Deployment<br/>metadata:<br/>  name: err-status-test<br/>  labels:<br/>    app: err-status-test<br/>spec:<br/>  replicas: 1<br/>  selector:<br/>    matchLabels:<br/>      app: err-status-test<br/>  template:<br/>    metadata:<br/>      labels:<br/>        app: err-status-test<br/>    spec:<br/>      containers:<br/>      - name: err-status-test<br/>        image: zhiminwen/error-test-app<br/>        imagePullPolicy: Always</span></pre><p id="b102" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">现在用错误代码413测试它，我们看到它像预期的那样工作，</p><pre class="la lb lc ld gt mc md me mf aw mg bi"><span id="b7b5" class="le lf it md b gy mh mi l mj mk">curl -i "<a class="ae mn" href="http://err-test.192.168.64.5.nip.io/err?code=413" rel="noopener ugc nofollow" target="_blank">http://err-test.192.168.64.5.nip.io/err?code=413</a>"<br/>HTTP/1.1 413 Request Entity Too Large<br/>Server: nginx/1.15.10<br/>Date: Sun, 05 May 2019 10:59:18 GMT<br/>Content-Type: text/plain; charset=utf-8<br/>Content-Length: 8<br/>Connection: keep-alive</span><span id="c8b5" class="le lf it md b gy ml mi l mj mk">Code=413</span></pre><h2 id="eb07" class="le lf it bd lg lh li dn lj lk ll dp lm km ln lo lp kq lq lr ls ku lt lu lv lw bi translated">默认Nginx默认后端有问题</h2><p id="8031" class="pw-post-body-paragraph kb kc it kd b ke lx kg kh ki ly kk kl km lz ko kp kq ma ks kt ku mb kw kx ky im bi translated">要更新默认错误页面，请编辑nginx-ingress-controller的配置映射。插入一个带有HTTP状态码的新键<code class="fe mo mp mq md b"><a class="ae mn" href="https://kubernetes.github.io/ingress-nginx/user-guide/nginx-configuration/configmap/#custom-http-errors" rel="noopener ugc nofollow" target="_blank">custom-http-errors</a></code>，我们要改变它的错误页面，比如，</p><pre class="la lb lc ld gt mc md me mf aw mg bi"><span id="7afa" class="le lf it md b gy mh mi l mj mk">apiVersion: v1<br/>kind: ConfigMap<br/>data:<br/>  <strong class="md iu">custom-http-errors: 404,413,503</strong><br/>  enable-vts-status: "false"<br/>metadata:<br/>  labels:<br/>    app: nginx-ingress<br/>    chart: nginx-ingress-1.6.0<br/>    component: controller<br/>    heritage: Tiller<br/>    release: nginx-ingress<br/>  name: nginx-ingress-controller<br/>  namespace: kube-system</span></pre><p id="5627" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">现在，再次启动测试命令，</p><pre class="la lb lc ld gt mc md me mf aw mg bi"><span id="b139" class="le lf it md b gy mh mi l mj mk">curl -i "<a class="ae mn" href="http://err-test.192.168.64.5.nip.io/err?code=413" rel="noopener ugc nofollow" target="_blank">http://err-test.192.168.64.5.nip.io/err?code=413</a>"<br/>HTTP/1.1 404 Not Found<br/>Server: nginx/1.15.10<br/>Date: Sun, 05 May 2019 11:36:04 GMT<br/>Content-Type: text/plain; charset=utf-8<br/>Content-Length: 21<br/>Connection: close</span><span id="5f04" class="le lf it md b gy ml mi l mj mk">default backend - 404</span></pre><p id="fbc5" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">这是<strong class="kd iu">不是</strong>我们想要的。Nginx入口控制器正确地捕获了我们想要定制的HTTP状态代码。然而，默认的Nginx“default-back end”<em class="mm">(图片:k8s.gcr.io/defaultbackend:1.4)</em>只是简单地返回404状态，而不管应用程序打算返回的实际状态代码。如果状态代码用于其他目的，这将导致问题。</p><h2 id="48a3" class="le lf it bd lg lh li dn lj lk ll dp lm km ln lo lp kq lq lr ls ku lt lu lv lw bi translated">自定义错误后端</h2><p id="6b5d" class="pw-post-body-paragraph kb kc it kd b ke lx kg kh ki ly kk kl km lz ko kp kq ma ks kt ku mb kw kx ky im bi translated">阅读Nginx入口控制器<a class="ae mn" href="https://kubernetes.github.io/ingress-nginx/user-guide/custom-errors/" rel="noopener ugc nofollow" target="_blank">文档</a>，需要自定义错误后端来解决此问题。基本上，自定义错误后端应该处理从入口控制器传递的HTTP头值，如X-Code、X-Format等，并将状态代码直接返回给请求者。</p><blockquote class="mr"><p id="4707" class="ms mt it bd mu mv mw mx my mz na ky dk translated">自定义后端应该返回正确的HTTP状态代码，而不是<code class="fe mo mp mq md b">200</code>。NGINX不会改变来自自定义默认后端的响应。</p></blockquote><p id="caac" class="pw-post-body-paragraph kb kc it kd b ke nb kg kh ki nc kk kl km nd ko kp kq ne ks kt ku nf kw kx ky im bi translated">Nginx入口控制器Github repo在路径<code class="fe mo mp mq md b"><a class="ae mn" href="https://github.com/kubernetes/ingress-nginx/tree/master/images/custom-error-pages" rel="noopener ugc nofollow" target="_blank">images/custom-error-pages</a></code>下提供了自定义错误后端的示例实现。</p><p id="36c2" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">由于我并不真的需要为其他平台进行交叉编译，所以我只编译了Linux amd64的二进制文件，修改了Dockerfile，如下所示，</p><pre class="la lb lc ld gt mc md me mf aw mg bi"><span id="6a03" class="le lf it md b gy mh mi l mj mk">FROM alpine<br/>COPY /rootfs /</span><span id="c470" class="le lf it md b gy ml mi l mj mk">ADD custom-error-pages /<br/>CMD ["/custom-error-pages"]</span></pre><p id="c6f9" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">构建映像并推入docker hub。在K3s中使用以下CRD重新部署Nginx头盔图</p><pre class="la lb lc ld gt mc md me mf aw mg bi"><span id="1497" class="le lf it md b gy mh mi l mj mk">apiVersion: k3s.cattle.io/v1<br/>kind: HelmChart<br/>metadata:<br/>  name: nginx-ingress<br/>  namespace: kube-system<br/>spec:<br/>  chart: stable/nginx-ingress<br/>  targetNamespace: kube-system<br/>  valuesContent: |-<br/>    defaultBackend:<br/>      enabled: true<br/>      name: default-backend<br/>      image:<br/>        repository: zhiminwen/custom-error-page<br/>        tag: latest</span></pre><h2 id="ac83" class="le lf it bd lg lh li dn lj lk ll dp lm km ln lo lp kq lq lr ls ku lt lu lv lw bi translated">再次测试</h2><p id="9e3e" class="pw-post-body-paragraph kb kc it kd b ke lx kg kh ki ly kk kl km lz ko kp kq ma ks kt ku mb kw kx ky im bi translated">再次启动相同的curl命令</p><pre class="la lb lc ld gt mc md me mf aw mg bi"><span id="0e40" class="le lf it md b gy mh mi l mj mk">➜ curl -i "<a class="ae mn" href="http://err-test.192.168.64.5.nip.io/err?code=413" rel="noopener ugc nofollow" target="_blank">http://err-test.192.168.64.5.nip.io/err?code=413</a>"<br/>HTTP/1.1 413 Request Entity Too Large<br/>Server: nginx/1.15.10<br/>Date: Sun, 05 May 2019 12:09:21 GMT<br/>Content-Type: */*<br/>Transfer-Encoding: chunked<br/>Connection: close</span><span id="9f67" class="le lf it md b gy ml mi l mj mk">4xx html</span></pre><p id="8049" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">我们有带有正确HTTP状态代码的自定义错误页面。</p><p id="3041" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">既然我们陷住了503状态，让我们按比例缩小副本，<code class="fe mo mp mq md b">k scale deploy err-status-test --replicas=0</code></p><p id="0e0d" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">现在，如果我们再次访问该应用程序，我们将看到自定义错误页面，其状态代码显示为预期的503。</p><figure class="la lb lc ld gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi ng"><img src="../Images/a8c0c0ceae33c99b99cd125804641fde.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*BdrGRrTvoosNByd1GFLf7w.png"/></div></div></figure></div></div>    
</body>
</html>