<html>
<head>
<title>Knative — Kubernetes-native PaaS with Serverless</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">knative—Kubernetes—无服务器的本地PaaS</h1>
<blockquote>原文：<a href="https://itnext.io/knative-kubernetes-native-paas-with-serverless-a1e0a0612943?source=collection_archive---------2-----------------------#2019-08-28">https://itnext.io/knative-kubernetes-native-paas-with-serverless-a1e0a0612943?source=collection_archive---------2-----------------------#2019-08-28</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><figure class="gl gn jr js jt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi jq"><img src="../Images/213d00952c46cb1237d2b2a05ae4bebc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*obfgJOC6Y7S2lSX6eHklIA.png"/></div></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated">knative——Kubernetes PaaS使用Gloo API Gateway实现无服务器体验</figcaption></figure><p id="9a8b" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">Kubernetes无疑已经成为部署容器的主导平台。Kubernetes通过其核心API和定制控制器提供了编排几乎任何东西的能力，定制控制器通过<a class="ae ld" href="https://kubernetes.io/docs/concepts/extend-kubernetes/api-extension/custom-resources/" rel="noopener ugc nofollow" target="_blank"> Kubernetes定制资源</a>扩展其API。</p><p id="6b96" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">然而，Kubernetes仍然将控制权留给用户，让他们来决定如何部署、配置、管理和扩展应用程序。关于应用如何扩展、保护和暴露给流量的决策留给用户来配置。因此，Kubernetes与传统的平台即服务(如Cloud Foundry和Heroku)截然不同。</p><p id="6264" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">PaaSes面向应用程序开发人员，具有简化的用户体验，主要关注单个应用程序的配置。PaaS后端对用户透明地管理路由、部署和遥测。</p><p id="c7d9" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">PaaS处理从源到部署的工作流，构建用户的容器映像，推出新的部署，并配置新的路由和DNS子域，以允许流量到达部署的容器。这一切都由一个<code class="fe le lf lg lh b">git push</code>引发。</p><p id="153e" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">Kubernetes(有意地)只提供了这类平台的构建模块，把弥合差距的工作留给了它的社区。正如凯尔西·海塔尔所说:</p><figure class="li lj lk ll gt ju"><div class="bz fp l di"><div class="lm ln l"/></div></figure><p id="7561" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">作为回应，我们已经看到Kubernetes发行版和托管解决方案的爆炸式增长，这些解决方案试图向Kubernetes提供PaaS，如OpenShift和Rancher。随着对Kube-PaaS市场份额的争夺越来越激烈，谷歌和Pivotal已经通过2018年7月宣布的Knative进入了这个圈子。</p><p id="11ba" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">Knative由Google和Pivotal合作构建，IBM、Red Hat和Solo.io等公司也有少量贡献，它为Kubernetes提供了类似PaaS的体验，并为无服务器应用程序提供了一流的支持。与Kubernetes发行版不同，Knative可以作为附加组件安装到任何兼容的Kubernetes集群中，并通过自定义资源进行配置。</p><h2 id="3390" class="lo lp it bd lq lr ls dn lt lu lv dp lw kq lx ly lz ku ma mb mc ky md me mf mg bi translated">什么是Knative？</h2><p id="95ac" class="pw-post-body-paragraph kf kg it kh b ki mh kk kl km mi ko kp kq mj ks kt ku mk kw kx ky ml la lb lc im bi translated">Knative自我描述为“基于Kubernetes的平台，用于部署和管理现代无服务器工作负载”。Knative将自己标榜为“无服务器工作负载”的平台，主动地根据并发HTTP请求的比例自动缩放容器。不使用的服务最终会缩减到零，提供“无服务器”式的按需扩展。</p><p id="8ecc" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">Knative由一组控制器<em class="mm">组成，这些控制器可以安装到任何Kubernetes集群</em>上，这些集群提供以下功能:</p><ul class=""><li id="5d73" class="mn mo it kh b ki kj km kn kq mp ku mq ky mr lc ms mt mu mv bi translated">从源代码构建容器化的应用程序(由Knative的<em class="mm"> Build </em>组件提供)</li><li id="383a" class="mn mo it kh b ki mw km mx kq my ku mz ky na lc ms mt mu mv bi translated">将应用程序暴露给外部流量(由<em class="mm">服务</em>组件提供)</li><li id="4664" class="mn mo it kh b ki mw km mx kq my ku mz ky na lc ms mt mu mv bi translated">基于需求部署和自动扩展应用程序(由<em class="mm">服务</em>组件提供)</li><li id="fb90" class="mn mo it kh b ki mw km mx kq my ku mz ky na lc ms mt mu mv bi translated">定义可以触发应用程序执行的事件源(由<em class="mm">事件</em>组件提供)</li></ul><p id="51d5" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated"><em class="mm">服务</em>是核心项目，管理托管应用的部署、自动伸缩和流量路由。安装Knative后，仍然可以访问完整的Kubernetes API，允许用户以“传统”方式管理应用程序，以及通过使用他们习惯的相同API原语(pod、服务等)来调试他们的Knative服务。).</p><p id="4bac" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated"><em class="mm"> Serving </em>还可以在用户推送更新版本的应用程序时自动执行蓝绿色流量路由，在新旧版本的应用程序之间分流流量。</p><p id="78fb" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">Knative本身依赖于安装的兼容入口控制器。在撰写本文时，<a class="ae ld" href="https://gloo.solo.io" rel="noopener ugc nofollow" target="_blank"> Gloo API网关</a>和<a class="ae ld" href="https://istio.io" rel="noopener ugc nofollow" target="_blank"> Istio服务网格</a>是唯一可用的兼容入口控制器。Knative将配置可用入口，以将流量路由到Knative管理的应用程序。</p><p id="a5c1" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">因为Knative仅依赖于网关，所以对于希望使用Knative而不必安装和管理Istio控制平面的用户来说，Istio服务网格可能是更大的依赖性。</p><p id="2e7b" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">由于这个原因，许多用户选择Gloo作为他们的Knative网关，提供与Istio同等的功能(用于Knative ),同时大大减少了资源占用和操作开销。</p><p id="3fb3" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">让我们通过一个快速演示来看看Knative的实际应用。我将使用在GKE上运行的新集群:</p><pre class="li lj lk ll gt nb lh nc nd aw ne bi"><span id="2b68" class="lo lp it lh b gy nf ng l nh ni">kubectl get namespace</span><span id="25e8" class="lo lp it lh b gy nj ng l nh ni">NAME          STATUS   AGE<br/>default       Active   21h<br/>kube-public   Active   21h<br/>kube-system   Active   21h</span></pre><p id="b4d1" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">从部署Knative和Gloo开始。这可以按任何顺序进行:</p><pre class="li lj lk ll gt nb lh nc nd aw ne bi"><span id="eb0a" class="lo lp it lh b gy nf ng l nh ni"># deploy Knative-Serving<br/>kubectl apply -f \<br/> <a class="ae ld" href="https://github.com/knative/serving/releases/download/v0.8.0/serving-core.yaml" rel="noopener ugc nofollow" target="_blank">https://github.com/knative/serving/releases/download/v0.8.0/serving-core.yaml</a></span><span id="8090" class="lo lp it lh b gy nj ng l nh ni">namespace/knative-serving created<br/># ...</span><span id="bc0f" class="lo lp it lh b gy nj ng l nh ni"># deploy Gloo<br/>kubectl apply -f \<br/>  <a class="ae ld" href="https://github.com/solo-io/gloo/releases/download/v0.18.22/gloo-knative.yaml" rel="noopener ugc nofollow" target="_blank">https://github.com/solo-io/gloo/releases/download/v0.18.22/gloo-knative.yaml</a></span><span id="089b" class="lo lp it lh b gy nj ng l nh ni">namespace/gloo-system created<br/># ...</span></pre><p id="646a" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">验证所有单元都在运行:</p><pre class="li lj lk ll gt nb lh nc nd aw ne bi"><span id="1eea" class="lo lp it lh b gy nf ng l nh ni">kubectl get pod -n knative-serving</span><span id="ab72" class="lo lp it lh b gy nj ng l nh ni">NAME                              READY   STATUS    RESTARTS   AGE<br/>activator-5dd55958cc-fkp7r        1/1     Running   0          7m32s<br/>autoscaler-fd66459b7-7d5s2        1/1     Running   0          7m31s<br/>autoscaler-hpa-85b5667df4-mdjch   1/1     Running   0          7m32s<br/>controller-85c8bb7ffd-nj9cs       1/1     Running   0          7m29s<br/>webhook-5bd79b5c8b-7czrm          1/1     Running   0          7m29s</span><span id="7899" class="lo lp it lh b gy nj ng l nh ni">kubectl get pod -n gloo-system</span><span id="d635" class="lo lp it lh b gy nj ng l nh ni">NAME                                      READY   STATUS    RESTARTS   AGE<br/>discovery-69548c8475-fvh7q                1/1     Running   0          44s<br/>gloo-5b6954d7c7-7rfk9                     1/1     Running   0          45s<br/>ingress-6c46cdf6f6-jwj7m                  1/1     Running   0          44s<br/>knative-external-proxy-7dd7665869-x9xkg   1/1     Running   0          44s<br/>knative-internal-proxy-7775476875-9xvdg   1/1     Running   0          44s</span></pre><p id="05cc" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">Gloo现在准备开始路由。让我们创建一个自动缩放的Knative服务(kservice)并将一些流量路由到它。</p><p id="51b3" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">Knative Services提供了一种比传统的部署+服务+入口模式更简单的方式将应用部署到Kubernetes。我们将使用以下示例:</p><pre class="li lj lk ll gt nb lh nc nd aw ne bi"><span id="eada" class="lo lp it lh b gy nf ng l nh ni">apiVersion: serving.knative.dev/v1alpha1<br/>kind: Service<br/>metadata:<br/> name: helloworld-go<br/> namespace: default<br/>spec:<br/> template:<br/>   spec:<br/>     containers:<br/>       - image: gcr.io/knative-samples/helloworld-go<br/>         env:<br/>           - name: TARGET<br/>             Value: Knative user</span></pre><p id="443d" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">我将把它粘贴到一个文件中，然后部署到我的Kubernetes集群中，如下所示:</p><pre class="li lj lk ll gt nb lh nc nd aw ne bi"><span id="0b20" class="lo lp it lh b gy nf ng l nh ni">kubectl apply -f ksvc.yaml -n default</span></pre><p id="c2d0" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">我们可以看到在部署我们的“hello world-go”<em class="mm">KService</em>之后，Knative在我们的集群中创建了哪些资源:</p><pre class="li lj lk ll gt nb lh nc nd aw ne bi"><span id="7d8f" class="lo lp it lh b gy nf ng l nh ni">kubectl get pod -n default</span><span id="4318" class="lo lp it lh b gy nj ng l nh ni">NAME                                              READY   STATUS    RESTARTS   AGE<br/>helloworld-go-fjp75-deployment-678b965ccb-sfpn8   2/2     Running   0          68s</span></pre><p id="c64a" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">带有我们的<em class="mm"> helloworld-go </em>映像的pod在部署kservice时冷启动。最终，如果没有流量到达我们的pod，支持这一点的部署将缩减到零。相反，如果并发请求超过一个可配置的阈值，pod实例将被扩大。</p><pre class="li lj lk ll gt nb lh nc nd aw ne bi"><span id="d371" class="lo lp it lh b gy nf ng l nh ni">kubectl get ingresses.networking.internal.knative.dev -n default</span><span id="1b42" class="lo lp it lh b gy nj ng l nh ni">NAME            READY   REASON<br/>helloworld-go   True</span></pre><p id="42d1" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">Knative使用内部Knative API中的特殊“ingress”资源配置其入口。Gloo使用这个API作为自己的配置，以便提供类似PaaS的功能，包括蓝绿色部署、自动TLS终止、超时和其他高级路由功能。</p><p id="9504" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">一段时间后，我们会看到我们的豆荚消失(除非我们用流量撞他们):</p><pre class="li lj lk ll gt nb lh nc nd aw ne bi"><span id="6298" class="lo lp it lh b gy nf ng l nh ni">kubectl get pod -n default           <br/>                                                <br/>No resources found.</span><span id="9d22" class="lo lp it lh b gy nj ng l nh ni">kubectl get deployment -n default</span><span id="d502" class="lo lp it lh b gy nj ng l nh ni">NAME                             DESIRED   CURRENT   UP-TO-DATE   AVAILABLE   AGE<br/>helloworld-go-fjp75-deployment   0         0         0            0           9m46s</span></pre><p id="302c" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">最后，我们可以用一些流量来打击他们。使用<code class="fe le lf lg lh b">glooctl</code>获取Knative代理的URL特别容易:</p><pre class="li lj lk ll gt nb lh nc nd aw ne bi"><span id="1a08" class="lo lp it lh b gy nf ng l nh ni">glooctl proxy url --name knative-external-proxy</span><span id="f2f1" class="lo lp it lh b gy nj ng l nh ni"><a class="ae ld" href="http://35.190.151.188:80" rel="noopener ugc nofollow" target="_blank">http://35.190.151.188:80</a></span></pre><p id="448f" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">如果没有安装<code class="fe le lf lg lh b">glooctl</code>，我们可以从kube服务中查找地址/端口:</p><pre class="li lj lk ll gt nb lh nc nd aw ne bi"><span id="8b29" class="lo lp it lh b gy nf ng l nh ni">kubectl get svc -n gloo-system knative-external-proxy</span><span id="a4b9" class="lo lp it lh b gy nj ng l nh ni">NAME                     TYPE           CLUSTER-IP     EXTERNAL-IP      PORT(S)                      AGE<br/>knative-external-proxy   LoadBalancer   10.16.11.157   35.190.151.188   80:32168/TCP,443:30729/TCP   77m</span></pre><p id="73bb" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">使用cURL发送一些流量:</p><pre class="li lj lk ll gt nb lh nc nd aw ne bi"><span id="d1b3" class="lo lp it lh b gy nf ng l nh ni">curl -H "Host: helloworld-go.default.example.com" <a class="ae ld" href="http://35.190.151.188" rel="noopener ugc nofollow" target="_blank">http://35.190.151.188</a></span><span id="4ef7" class="lo lp it lh b gy nj ng l nh ni">Hello Knative user!</span></pre><p id="8067" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">Knative使用Gloo作为高性能、全功能的API网关，在开箱即用的Kubernetes之上为开发人员提供了类似PaaS的体验。这篇文章仅仅触及了Knative的皮毛；在定制和附加特性方面有更多的功能可用。它也仅仅触及了Gloo的表面！</p><p id="b2fc" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">虽然Knative还很年轻，但Knative团队已经达到了六周的发布节奏，并且更多高级功能已经开始从管道中出现，如自动TLS配置和控制平面自动缩放。作为多家重量级云公司之间的合作以及谷歌新的Cloud Run产品的支柱，Knative几乎肯定会成为将无服务器和PaaS引入Kubernetes的卓越选择之一。敬请关注！</p><p id="ad73" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">要了解更多信息:</p><ul class=""><li id="3ef3" class="mn mo it kh b ki kj km kn kq mp ku mq ky mr lc ms mt mu mv bi translated">查看<a class="ae ld" href="https://knative.dev/docs/" rel="noopener ugc nofollow" target="_blank"> <strong class="kh iu"> Knative文档</strong> </a>并了解更多关于Knative和</li><li id="6780" class="mn mo it kh b ki mw km mx kq my ku mz ky na lc ms mt mu mv bi translated"><a class="ae ld" href="https://gloo.solo.io" rel="noopener ugc nofollow" target="_blank"> <strong class="kh iu">阅读Gloo文档</strong> </a>了解更多关于它所运行的基于Envoy的API网关的信息</li><li id="b27b" class="mn mo it kh b ki mw km mx kq my ku mz ky na lc ms mt mu mv bi translated"><a class="ae ld" href="https://www.meetup.com/Solo-io-Online-Meetup/events/263828132/" rel="noopener ugc nofollow" target="_blank"> <strong class="kh iu">加入8月29日的在线聚会</strong> </a>观看现场演示并加入讨论</li></ul></div></div>    
</body>
</html>