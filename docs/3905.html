<html>
<head>
<title>Need to Build Event-Driven Architecture in the Azure? Easy with Azure Event Grid and Azure function!</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">需要在Azure中构建事件驱动的架构？使用Azure事件网格和Azure函数很容易！</h1>
<blockquote>原文：<a href="https://itnext.io/event-driven-and-microservices-architecture-with-azure-function-and-azure-event-grid-51bd612d99b6?source=collection_archive---------2-----------------------#2020-03-23">https://itnext.io/event-driven-and-microservices-architecture-with-azure-function-and-azure-event-grid-51bd612d99b6?source=collection_archive---------2-----------------------#2020-03-23</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><figure class="is it gp gr iu iv gh gi paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="gh gi ir"><img src="../Images/6e8859fdc43e352c61c92e01d3b69194.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*sJZHaxB24xVQXuzqv_HwAg.jpeg"/></div></div></figure><div class=""/><p id="0464" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">由于所有部署步骤的自动化，在大型组织中构建和支持基础架构可能是一项具有挑战性的任务，例如，为拥有一组虚拟机的部门创建云环境，这些虚拟机包含预安装的软件、实用程序、服务等，它们可能有自己的依赖项，如数据库和存储、与日志分析和其他日志服务的连接。实用程序和服务也可能具有外部依赖性。因此，您需要一种机制来检查并确保建立了所需的连接，安装了依赖项，触发了正确的自动化操作手册。该机制应该提醒管理员出错，执行备份。</p><p id="8b54" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">为了建立这个机制，我将使用以下azure资源。</p><p id="b902" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated"><a class="ae kz" href="https://docs.microsoft.com/en-us/azure/event-grid/concepts" rel="noopener ugc nofollow" target="_blank"> <strong class="kd jf">事件网格</strong> </a>是作为主事件事件处理器的关键组件，包含:</p><ul class=""><li id="3240" class="la lb je kd b ke kf ki kj km lc kq ld ku le ky lf lg lh li bi translated">主题是代表生成事件的组件的azure资源。</li><li id="49f0" class="la lb je kd b ke lj ki lk km ll kq lm ku ln ky lf lg lh li bi translated">订阅/端点是处理事件的azure资源。</li></ul><p id="0c2f" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">下图显示了发布者组件、事件、主题和订阅者/端点之间的关系。</p><figure class="lp lq lr ls gt iv gh gi paragraph-image"><div class="gh gi lo"><img src="../Images/819a0fe15dc4fbcd7a121cd494de2ef7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1388/format:webp/1*FWCoi88lk_C0qtVnO6yq5w.png"/></div></figure><p id="2907" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">事件网格包含:</p><ul class=""><li id="92d2" class="la lb je kd b ke kf ki kj km lc kq ld ku le ky lf lg lh li bi translated"><a class="ae kz" href="https://docs.microsoft.com/en-us/azure/event-grid/manage-event-delivery" rel="noopener ugc nofollow" target="_blank">死信队列</a>和重试策略——如果消息无法到达端点，那么您还应该配置重试策略</li><li id="2a21" class="la lb je kd b ke lj ki lk km ll kq lm ku ln ky lf lg lh li bi translated"><a class="ae kz" href="https://docs.microsoft.com/en-us/azure/event-grid/event-filtering" rel="noopener ugc nofollow" target="_blank">事件过滤</a> —允许事件网格将特定事件类型传递到端点的规则。例如:当在主题容器(资源组、订阅等)中创建新的VM时，事件将被捕获并交付给端点(服务总线队列、存储队列)</li></ul><figure class="lp lq lr ls gt iv gh gi paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="gh gi lt"><img src="../Images/90625dae8342a116f849a20662e686ba.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ykza4L4YTK2CvTtMLYQ5dw.png"/></div></div></figure><p id="0e28" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated"><strong class="kd jf">队列存储账户</strong></p><p id="b767" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">正被用作主事件存储。当事件将通过事件网格生成时，最终目的地将是一个队列。</p><p id="9b40" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated"><strong class="kd jf"> Azure功能</strong></p><p id="c33a" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">用作微服务的功能，包含验证所需资源和连接的逻辑。每个功能还可以包含用于存储配置或状态管理数据的数据库。</p><p id="5c3a" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">在一个相当高层次的架构描述之后，我将在下面提供更多的细节。</p><h1 id="fcea" class="lu lv je bd lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp mq mr bi translated">体系结构</h1><figure class="lp lq lr ls gt iv gh gi paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="gh gi ms"><img src="../Images/8f37839c13c149ad35358d149bf98732.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*uuzp_UtSFGcgmWFbuYhSEw.jpeg"/></div></div></figure><p id="5f0e" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">正如您已经注意到的，事件网格与一个订阅相链接，该订阅监听与新虚拟机创建相关的事件。有必要在这里添加过滤，否则，每当在订阅或目标资源组中创建任何资源时，事件网格都会生成消息。所有交付的事件都在存储队列中交付。在我的项目中，我使用了三个队列:</p><ul class=""><li id="0c2e" class="la lb je kd b ke kf ki kj km lc kq ld ku le ky lf lg lh li bi translated">主队列是事件网格中所有消息的目的地。</li><li id="e401" class="la lb je kd b ke lj ki lk km ll kq lm ku ln ky lf lg lh li bi translated">重试队列接收在验证的第一步中失败并计划在以后重试的所有邮件。</li><li id="2a4c" class="la lb je kd b ke lj ki lk km ll kq lm ku ln ky lf lg lh li bi translated">成功队列用于所有成功处理的消息。在我的项目中，我将这个队列用于将来的统计和报告。</li></ul><p id="75cc" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">此外，一个存储帐户链接到Azure Log Analytics以同步所有日志和警报，例如，如果重试队列中的消息多于预期，则Log Analytics会将此记录为错误警报管理员。</p><p id="dc9c" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">下一个组件是Azure function应用程序，它包含几个带有验证、消息处理和触发runbook的逻辑的Azure函数。</p><p id="2c4d" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated"><strong class="kd jf">验证功能</strong>与主事件队列链接。当事件网格向主队列发送消息时，该函数被自动触发。</p><p id="d125" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated"><strong class="kd jf">重试功能</strong>基于定时器触发，将持续运行以检查打算重试的失败消息(在重试事件队列中)。</p><p id="6aef" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated"><strong class="kd jf"> API函数</strong> (HTTP trigger)意在从runbook、Admin UI等触发(重新运行)整个流程。</p><p id="c113" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">整个功能工作流程描述如下。</p><figure class="lp lq lr ls gt iv gh gi paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="gh gi mt"><img src="../Images/daf34f317d8e953cdae1f32d4d415141.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Av7ehBaBLgBd5RGHQncRtw.jpeg"/></div></div></figure><h1 id="19de" class="lu lv je bd lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp mq mr bi translated">架构代码库</h1><p id="80a5" class="pw-post-body-paragraph kb kc je kd b ke mu kg kh ki mv kk kl km mw ko kp kq mx ks kt ku my kw kx ky im bi translated">函数app是在PowerShell ( <a class="ae kz" href="https://docs.microsoft.com/en-us/powershell/module/microsoft.powershell.core/about/about_classes?view=powershell-7" rel="noopener ugc nofollow" target="_blank"> Powershell类</a>)上编写的，使用了OOP的原理。这种方法允许我们构建模块化的良好支持的代码，并随时添加或删除功能。</p><p id="faa3" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">为什么我选择PowerShell而不是c#或JavaScript？主要原因是一个基于PS的解决方案不仅可以得到开发者的支持，还可以得到云管理员和系统工程师的支持。</p><h2 id="0c93" class="mz lv je bd lw na nb dn ma nc nd dp me km ne nf mi kq ng nh mm ku ni nj mq nk bi translated">Azure功能app</h2><p id="7a8f" class="pw-post-body-paragraph kb kc je kd b ke mu kg kh ki mv kk kl km mw ko kp kq mx ks kt ku my kw kx ky im bi translated">我已经根据消费计划将解决方案放在一个azure function应用程序容器中，这样它就不会使用太多的资源，另一方面，如果需要更多的CPU能力或内存，它可以自动扩展。</p><p id="d605" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">每个函数都包含一个表示函数和绑定配置文件的运行文件，可以在该文件中设置函数触发器。解决方案还包含通用类(模块),代码可在与云资源相关的功能和操作之间重复使用，例如<em class="nl">AutomationAccountManager</em>模块包含触发runbook的功能等。</p><figure class="lp lq lr ls gt iv gh gi paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="gh gi nm"><img src="../Images/ee88a0aa2d7b4b45d2fc670fa921be3c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*bWm3mIqomBT_eWFxILJwrA.png"/></div></div></figure><p id="51dc" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">下面你可以看到主<em class="nl">验证函数</em>例子的代码示例。</p><figure class="lp lq lr ls gt iv"><div class="bz fp l di"><div class="nn no l"/></div></figure><p id="dafe" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">如您所见，我在文件头中引用了<em class="nl">公共</em>模块，然后使用<em class="nl"> param </em>指令、<em class="nl">T5】添加了输入绑定，因此当新的VM将被创建并且事件数据将被放入主队列时，该函数将被触发，并且<em class="nl"> $QueueItem </em>变量接收有效载荷(此处为<a class="ae kz" href="https://gist.github.com/Boriszn/bf8b4dc96d665345feaab9682b873ba2" rel="noopener ugc nofollow" target="_blank">事件网格有效载荷的示例)，包括关于VM的信息。</a></em></p><h2 id="594b" class="mz lv je bd lw na nb dn ma nc nd dp me km ne nf mi kq ng nh mm ku ni nj mq nk bi translated">公共类/模块</h2><ul class=""><li id="00d2" class="la lb je kd b ke mu ki mv km np kq nq ku nr ky lf lg lh li bi translated"><strong class="kd jf">验证模块</strong>包含用于检查数据库服务器连接的逻辑，但是您可以在其中放置其他验证逻辑。首先，它检查参数，将密码转换为安全字符串并构建<a class="ae kz" href="https://docs.microsoft.com/en-us/dotnet/api/system.management.automation.pscredential?view=pscore-6.2.0" rel="noopener ugc nofollow" target="_blank"> <em class="nl"> PSCredential对象</em> </a>，然后设置<em class="nl"> SimplySql模块</em>(如果它不存在的话)(<a class="ae kz" href="https://www.powershellgallery.com/packages/SimplySql/1.6.2" rel="noopener ugc nofollow" target="_blank"> SimplySql </a>包含建立连接和执行数据库查询的逻辑)</li></ul><figure class="lp lq lr ls gt iv"><div class="bz fp l di"><div class="nn no l"/></div></figure><ul class=""><li id="4093" class="la lb je kd b ke kf ki kj km lc kq ld ku le ky lf lg lh li bi translated"><a class="ae kz" href="https://github.com/Boriszn/AzureValidationMiddleware/blob/master/src/AzureValidationMiddlewareFunctionApp/common/AutomationRunbookManager.psm1" rel="noopener ugc nofollow" target="_blank"> <strong class="kd jf">自动化账户管理器</strong> </a> <strong class="kd jf"> </strong>是包含触发运行手册的逻辑的模块，检索虚拟机的私有IP，当然还可以包含与自动化账户相关的其他逻辑，例如基于模板创建运行手册、删除等。</li><li id="1e5b" class="la lb je kd b ke lj ki lk km ll kq lm ku ln ky lf lg lh li bi translated"><a class="ae kz" href="https://github.com/Boriszn/AzureValidationMiddleware/blob/master/src/AzureValidationMiddlewareFunctionApp/common/Configuration.psm1" rel="noopener ugc nofollow" target="_blank"> <strong class="kd jf">配置</strong> </a> <strong class="kd jf"> </strong>从本地和主设置配置文件中检索配置选项，还提供在本地配置设置和生产/测试环境之间切换的逻辑。我将在下面的<strong class="kd jf"> CI/CD架构和管道</strong>部分详细解释配置。</li><li id="c7f3" class="la lb je kd b ke lj ki lk km ll kq lm ku ln ky lf lg lh li bi translated"><a class="ae kz" href="https://github.com/Boriszn/AzureValidationMiddleware/blob/master/src/AzureValidationMiddlewareFunctionApp/common/AuthorisationTokenManager.psm1" rel="noopener ugc nofollow" target="_blank"><strong class="kd jf">authorization manager</strong></a><strong class="kd jf"/>是一个提供对Azure资源的访问的模块。基于Azure托管身份并使用基于JWT令牌的OAuth2协议。允许功能应用程序的本地开发。要使用这个选项，您需要获得JWT令牌并在模块中添加更新auth变量。带AuthorisationManager的MSI将在<strong class="kd jf"> CI/CD架构和管道</strong>部分详细说明。</li><li id="7d23" class="la lb je kd b ke lj ki lk km ll kq lm ku ln ky lf lg lh li bi translated"><a class="ae kz" href="https://github.com/Boriszn/AzureValidationMiddleware/blob/master/src/AzureValidationMiddlewareFunctionApp/common/QueueManager.psm1" rel="noopener ugc nofollow" target="_blank"><strong class="kd jf">queue manager</strong></a><strong class="kd jf"/>代表azure存储帐户队列资源，包含获取队列消息、添加/创建消息的操作。</li></ul><h1 id="b471" class="lu lv je bd lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp mq mr bi translated">CI/CD架构和管道</h1><p id="992d" class="pw-post-body-paragraph kb kc je kd b ke mu kg kh ki mv kk kl km mw ko kp kq mx ks kt ku my kw kx ky im bi translated">在我开始解释CI/CD架构和管道之前，让我们先来看看Azure托管身份主题。</p><h2 id="a297" class="mz lv je bd lw na nb dn ma nc nd dp me km ne nf mi kq ng nh mm ku ni nj mq nk bi translated">托管身份</h2><p id="a9a7" class="pw-post-body-paragraph kb kc je kd b ke mu kg kh ki mv kk kl km mw ko kp kq mx ks kt ku my kw kx ky im bi translated">管理身份(MSI)是一种服务，允许您的应用程序或功能访问其他azure资源。基于主账户和OAuth的MSI。在我的情况下，我需要从功能应用程序接收存储队列的访问权限。</p><p id="a492" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">为您的资源启用MSI时，Azure将在与此资源关联的Active Directory中创建服务主体，但此主体帐户没有权限，因此我们需要显式分配权限。这将是管道的最后一步。</p><p id="bf30" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">创建主体并分配所需权限后，MSI将基于基于OAuth2令牌的算法工作。在访问存储队列之前，函数应用服务主体发送凭证信息以从AAD接收JWT令牌。最后，函数在访问队列存储之前发送这个令牌进行验证。整个过程可以在下图中找到。</p><figure class="lp lq lr ls gt iv gh gi paragraph-image"><div class="gh gi ns"><img src="../Images/48c8c5ea8d23f78768b0115daf9f5b29.png" data-original-src="https://miro.medium.com/v2/resize:fit:1284/format:webp/1*WaepUI3XZSQ6fuD-dp_z-A.png"/></div></figure><p id="5a97" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">MSI的详细信息超出了本文的范围，不过在这里<a class="ae kz" href="https://docs.microsoft.com/en-us/azure/active-directory/managed-identities-azure-resources/overview" rel="noopener ugc nofollow" target="_blank">和</a>这里<a class="ae kz" href="https://blogs.endjin.com/2019/01/managing-applications-using-azure-ad-service-principals-and-managed-identities/" rel="noopener ugc nofollow" target="_blank">你可以获得关于这个主题的更多信息和示例。</a></p><p id="b104" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">如何在基于powershell的函数app中实现这一过程，有两种选择:</p><ol class=""><li id="4188" class="la lb je kd b ke kf ki kj km lc kq ld ku le ky nt lg lh li bi translated">使用<a class="ae kz" href="https://github.com/Boriszn/AzureValidationMiddleware/blob/master/src/AzureValidationMiddlewareFunctionApp/profile.ps1" rel="noopener ugc nofollow" target="_blank"><strong class="kd jf"><em class="nl">profile . PS1</em></strong></a><em class="nl"/>文件包含几行代码，其中函数做这个认证。这种方法的缺点是这个选项并不总是在本地有效。</li><li id="8810" class="la lb je kd b ke lj ki lk km ll kq lm ku ln ky nt lg lh li bi translated">创建自己的类/模块来实现MSI认证过程。你可以看到下面的例子。</li></ol><figure class="lp lq lr ls gt iv"><div class="bz fp l di"><div class="nn no l"/></div></figure><p id="3e50" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated"><code class="fe nu nv nw nx b">AuthenticationTokenManager</code>使用MSI执行认证，并允许在本地和“真实”环境之间切换。对于当地的发展，它需要JWT令牌。您可以使用这个命令<code class="fe nu nv nw nx b">az account get-access-token --resource 'https://resource.azure.net'</code>获得它。</p><h2 id="6e42" class="mz lv je bd lw na nb dn ma nc nd dp me km ne nf mi kq ng nh mm ku ni nj mq nk bi translated">CI管道</h2><figure class="lp lq lr ls gt iv gh gi paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="gh gi ny"><img src="../Images/797b18f94ac4166c317d86ce3f0a43bc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Vj1PjfTD2Kpde6Swcsdr0Q.png"/></div></div></figure><p id="60d8" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">管道设置所有需要的基础设施。首先，它创建带有主题的事件网格，并设置容器来观察订阅/资源组(<a class="ae kz" href="https://docs.microsoft.com/en-us/azure/event-grid/event-sources" rel="noopener ugc nofollow" target="_blank">此处</a>您可以找到事件网格源)，它还为事件存储创建带有三个队列的存储队列帐户。代码的最后一步，配置<a class="ae kz" href="https://docs.microsoft.com/bs-latn-ba/azure/event-grid/event-filtering" rel="noopener ugc nofollow" target="_blank">事件网格订阅过滤器</a>仅在新虚拟机出现时起作用:</p><pre class="lp lq lr ls gt nz nx oa ob aw oc bi"><span id="f320" class="mz lv je nx b gy od oe l of og">az eventgrid event-subscription create \</span><span id="0083" class="mz lv je nx b gy oh oe l of og">....</span><span id="70d9" class="mz lv je nx b gy oh oe l of og">--included-event-types Microsoft.Resources.ResourceWriteSuccess \</span><span id="5cc2" class="mz lv je nx b gy oh oe l of og">--advanced-filter data.operationName StringContains 'Microsoft.Compute/virtualMachines/write'</span></pre><p id="576a" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">如果您需要高级和更高性能的事件存储，您也可以选择Azure Service Bus而不是Storage Queue，它支持事务、过滤、事件转发、死信队列、主题(<a class="ae kz" href="https://docs.microsoft.com/en-us/azure/service-bus-messaging/service-bus-messaging-overview#advanced-features" rel="noopener ugc nofollow" target="_blank">此处为</a>所有高级服务总线特性的列表)。</p><p id="494f" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">下一步是将功能应用程序部署为资源，并启用托管身份(MSI)。</p><pre class="lp lq lr ls gt nz nx oa ob aw oc bi"><span id="36e2" class="mz lv je nx b gy od oe l of og">"identity": {</span><span id="ba2f" class="mz lv je nx b gy oh oe l of og">    "type": "SystemAssigned"</span><span id="f3fe" class="mz lv je nx b gy oh oe l of og">},</span></pre><p id="cfba" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">这包括存储项目文件和应用程序日志所需的存储帐户的部署。</p><p id="3c7b" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">之后，我们需要从key-vault中读取秘密，这被认为是存储和检索秘密的最佳实践，如主数据库帐户、存储和虚拟机密码等。，但是我们将跳过示例中的步骤。</p><p id="51b4" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">最后一步是压缩(zip)函数的文件源，并将归档部署到函数应用程序容器中，这是我们之前创建的。</p><p id="3492" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated"><a class="ae kz" href="https://github.com/Boriszn/AzureValidationMiddleware/blob/master/src/Deployment/AzureValidationMiddlewareFunctionAppDeployResources.yaml" rel="noopener ugc nofollow" target="_blank"> <strong class="kd jf">在这里</strong> </a>你可以找到已经配置好的管道，可以导入到你的Azure DevOps项目中。</p><h1 id="c297" class="lu lv je bd lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp mq mr bi translated">丰富</h1><ul class=""><li id="13c9" class="la lb je kd b ke mu ki mv km np kq nq ku nr ky lf lg lh li bi translated">对于重试功能，我正在使用计时器功能，其中我正在基于Cron作业格式配置轮询间隔(<code class="fe nu nv nw nx b">0 */5 * * * *</code>每5分钟)，它可以替换为具有重试策略的<a class="ae kz" href="https://docs.microsoft.com/en-us/azure/azure-functions/functions-bindings-storage-queue?tabs=csharp#trigger---polling-algorithm" rel="noopener ugc nofollow" target="_blank">队列触发</a>功能或<a class="ae kz" href="http://Trigger - polling algorithm" rel="noopener ugc nofollow" target="_blank">触发轮询</a>。下面是一个配置示例:</li></ul><pre class="lp lq lr ls gt nz nx oa ob aw oc bi"><span id="bb78" class="mz lv je nx b gy od oe l of og">{<br/>    "version": "2.0",<br/>    "extensions": {<br/>        "queues": {<br/>            "maxPollingInterval": "00:05:00",<br/>            "visibilityTimeout" : "00:00:60",<br/>            "batchSize": 16,<br/>            "maxDequeueCount": 3,<br/>            "newBatchThreshold": 5<br/>        }<br/>    }<br/>}</span></pre><ul class=""><li id="9012" class="la lb je kd b ke kf ki kj km lc kq ld ku le ky lf lg lh li bi translated">配置文件与授权模块。除了使用授权模块，您还可以使用profile.ps1和身份验证脚本部分</li></ul><pre class="lp lq lr ls gt nz nx oa ob aw oc bi"><span id="2755" class="mz lv je nx b gy od oe l of og">....<br/>if ($env:MSI_SECRET -and (Get-Module -ListAvailable Az.Accounts)) {      </span><span id="e0b6" class="mz lv je nx b gy oh oe l of og">   Connect-AzAccount -Identity</span><span id="5e2e" class="mz lv je nx b gy oh oe l of og">}<br/>....</span></pre><p id="ae82" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">但是，此选项可能在本地环境中不起作用，您应该配置MSI环境变量。</p><ul class=""><li id="91f2" class="la lb je kd b ke kf ki kj km lc kq ld ku le ky lf lg lh li bi translated">添加azure函数代理以修改URL格式</li></ul><h1 id="9649" class="lu lv je bd lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp mq mr bi translated">结论</h1><p id="d199" class="pw-post-body-paragraph kb kc je kd b ke mu kg kh ki mv kk kl km mw ko kp kq mx ks kt ku my kw kx ky im bi translated">在本文中，我描述了如何构建事件驱动架构来管理虚拟机、相关实用程序和组件。</p><p id="8453" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">所提出的解决方案可以在以下场景中重复使用:</p><ul class=""><li id="791e" class="la lb je kd b ke kf ki kj km lc kq ld ku le ky lf lg lh li bi translated">密钥库和SSL证书管理(检查证书到期时间，记录和通知，自动更新证书)</li><li id="9c70" class="la lb je kd b ke lj ki lk km ll kq lm ku ln ky lf lg lh li bi translated">创建自定义逻辑以构建云费用报告</li><li id="5265" class="la lb je kd b ke lj ki lk km ll kq lm ku ln ky lf lg lh li bi translated">云资源备份、检查可用性和日志(使用日志分析或其他工具)</li><li id="9e90" class="la lb je kd b ke lj ki lk km ll kq lm ku ln ky lf lg lh li bi translated">资源清理管理</li><li id="b65a" class="la lb je kd b ke lj ki lk km ll kq lm ku ln ky lf lg lh li bi translated">容器管理解决方案</li></ul><h2 id="c2d3" class="mz lv je bd lw na nb dn ma nc nd dp me km ne nf mi kq ng nh mm ku ni nj mq nk bi translated">源代码</h2><div class="is it gp gr iu oi"><a href="https://github.com/Boriszn/AzureValidationMiddleware" rel="noopener  ugc nofollow" target="_blank"><div class="oj ab fo"><div class="ok ab ol cl cj om"><h2 class="bd jf gy z fp on fr fs oo fu fw jd bi translated">Boris Zn/AzureValidationMiddleware</h2><div class="op l"><h3 class="bd b gy z fp on fr fs oo fu fw dk translated">使用Azure函数、Azure事件网格和Azure队列构建的Azure验证中间件解决方案展示了…</h3></div><div class="oq l"><p class="bd b dl z fp on fr fs oo fu fw dk translated">github.com</p></div></div><div class="or l"><div class="os l ot ou ov or ow ja oi"/></div></div></a></div></div><div class="ab cl ox oy hx oz" role="separator"><span class="pa bw bk pb pc pd"/><span class="pa bw bk pb pc pd"/><span class="pa bw bk pb pc"/></div><div class="im in io ip iq"><h1 id="3984" class="lu lv je bd lw lx pe lz ma mb pf md me mf pg mh mi mj ph ml mm mn pi mp mq mr bi translated">奖金</h1><p id="fe0b" class="pw-post-body-paragraph kb kc je kd b ke mu kg kh ki mv kk kl km mw ko kp kq mx ks kt ku my kw kx ky im bi translated">因为这个主题在云和软件架构领域非常有用和流行。此外，这些方法解决了许多业务问题。考虑到这一点，我决定开设一门实用的互动课程。它基于我为企业客户构建EDA架构的经验。</p><p id="1c55" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">课程中可以<strong class="kd jf">玩代码</strong>，测试架构<strong class="kd jf">，直接</strong>运行管道！您可以在下面找到一个链接并注册该课程。</p><div class="is it gp gr iu oi"><a href="https://www.educative.io/courses/event-driven-microservices-azure" rel="noopener  ugc nofollow" target="_blank"><div class="oj ab fo"><div class="ok ab ol cl cj om"><h2 class="bd jf gy z fp on fr fs oo fu fw jd bi translated">在Azure中构建事件驱动和微服务架构-交互式学习</h2><div class="op l"><h3 class="bd b gy z fp on fr fs oo fu fw dk translated">构建云基础架构可能是一项具有挑战性的任务。您的软件中有许多依赖项，而且…</h3></div><div class="oq l"><p class="bd b dl z fp on fr fs oo fu fw dk translated">www.educative.io</p></div></div><div class="or l"><div class="pj l ot ou ov or ow ja oi"/></div></div></a></div></div></div>    
</body>
</html>