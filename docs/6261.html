<html>
<head>
<title>Level Up Your Argo CD Game with ApplicationSet</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用ApplicationSet升级你的Argo CD游戏</h1>
<blockquote>原文：<a href="https://itnext.io/level-up-your-argo-cd-game-with-applicationset-ccd874977c4c?source=collection_archive---------1-----------------------#2021-10-03">https://itnext.io/level-up-your-argo-cd-game-with-applicationset-ccd874977c4c?source=collection_archive---------1-----------------------#2021-10-03</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/bbc19c268c415fede49c389d92f8d67b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*dg_-ZMKRh_ngxKhKxYx2og.png"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">如何在不真正部署Argo CD应用程序的情况下部署Argo CD应用程序</figcaption></figure><p id="1015" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">在Kubernetes生态系统中，我最喜欢的工具之一是Argo CD。它采用了GitOps的理论概念，并把它变成了一个实用的、用户友好的工具，并提供了一个UI来启动。知道它正在监视您的Git存储库(期望的状态)，不断地将它与Kubernetes中的清单(实时状态)进行比较，并提醒您任何偏差，这正是DevOps工程师需要的自动化类型。</p><p id="0692" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">如果你对Argo CD不熟悉，我强烈推荐<a class="ae la" href="https://argo-cd.readthedocs.io/en/stable/" rel="noopener ugc nofollow" target="_blank">探索它</a>并把它加入你的军火库。博客的其余部分假设你已经基本熟悉。</p><h1 id="8d25" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">应用程序太多的问题</h1><p id="088b" class="pw-post-body-paragraph kc kd iq ke b kf lz kh ki kj ma kl km kn mb kp kq kr mc kt ku kv md kx ky kz ij bi translated">正如我在<a class="ae la" rel="noopener ugc nofollow" target="_blank" href="/the-kubernetes-ownership-model-50802b9f264">的Kubernetes所有权模型</a>中所解释的，我使用Argo CD来部署一系列商业应用程序。随着应用程序的数量开始增长，一个独特的问题出现了。管理所有Argo光盘应用资源变得一塌糊涂。我通过舵图部署Argo CD，所以我可以使用<a class="ae la" href="https://github.com/argoproj/argo-helm/blob/argo-cd-3.22.1/charts/argo-cd/values.yaml#L838" rel="noopener ugc nofollow" target="_blank">值. yaml </a>到<em class="me">声明</em>Argo CD应用程序资源。但是想象一下，在一个values.yaml中有数百个应用程序规范，这可不好玩。</p><p id="8ffa" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">最初，Argo CD用户社区提出了一个有趣的解决方案。因为Argo CD应用程序CustomResourceDefinition (CRD)只是一个源(Git存储库)和一个目的地(Kubernetes集群)的组合，所以它可以用来部署<em class="me">另一个</em> Argo CD应用程序本身！这被称为应用模式的<a class="ae la" href="https://argo-cd.readthedocs.io/en/stable/operator-manual/cluster-bootstrapping/#app-of-apps-pattern" rel="noopener ugc nofollow" target="_blank">应用。现在，我不需要在values.yaml中声明所有这些应用程序，而是只需要声明一个应用程序(应用程序中的应用程序),并将所有其他应用程序的规范移到Git存储库中。</a></p><p id="a8db" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">虽然这很酷，但是请注意，它并没有真正解决问题。它只是把问题转移到了别处。如果你够聪明，你可以将那些应用程序转移到由另一个团队管理的Git存储库中，并把它变成其他人的问题；-)</p><h1 id="76cd" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">Argo光盘应用程序集</h1><p id="d726" class="pw-post-body-paragraph kc kd iq ke b kf lz kh ki kj ma kl km kn mb kp kq kr mc kt ku kv md kx ky kz ij bi translated">Argo CD团队注意到App of Apps模式的创新使用，并将其转化为一个更通用、更强大的解决方案，称为<a class="ae la" href="https://argo-cd.readthedocs.io/en/stable/user-guide/application-set/" rel="noopener ugc nofollow" target="_blank"> ApplicationSet </a>。这是<em class="me">生成</em> Argo光盘应用程序的另一个CRD。</p><p id="b298" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">应用程序CRD由源和目的地组成，应用程序集CRD由<a class="ae la" href="https://argocd-applicationset.readthedocs.io/en/stable/Generators/" rel="noopener ugc nofollow" target="_blank">生成器</a>和应用程序模板组成。生成器<em class="me">生成</em>键值参数，这些参数在应用程序模板中被替换，以呈现实际的应用程序资源。</p><figure class="mg mh mi mj gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mf"><img src="../Images/0a0d738589561f2dbaffb9acbfeaef88.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*9TqkaPE7tjdxFwzaq2Qj_g.png"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">Argo光盘应用程序集</figcaption></figure><h1 id="2fea" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">何时使用Argo光盘应用程序集</h1><p id="6dc5" class="pw-post-body-paragraph kc kd iq ke b kf lz kh ki kj ma kl km kn mb kp kq kr mc kt ku kv md kx ky kz ij bi translated">首先，如果你没有“太多应用”的问题，你不需要使用ApplicationSet。其次，如果你有太多的应用程序，考虑一下这些应用程序中的一些是否在功能上<em class="me">相似。问一个问题，ArgoCD应用程序代表什么？</em></p><ol class=""><li id="9f86" class="mk ml iq ke b kf kg kj kk kn mm kr mn kv mo kz mp mq mr ms bi translated">也许应用程序代表您系统中的“租户”。如果每个租户都需要部署一组pod，那么您需要一个ArgoCD应用程序。</li><li id="8a12" class="mk ml iq ke b kf mt kj mu kn mv kr mw kv mx kz mp mq mr ms bi translated">也许应用程序代表你公司的“团队”。作为一个平台团队，您希望为每个DevOps团队部署一组pods。</li><li id="5c76" class="mk ml iq ke b kf mt kj mu kn mv kr mw kv mx kz mp mq mr ms bi translated">也许应用程序代表了部署在每个Kubernetes集群中的“工具组合”。</li><li id="3491" class="mk ml iq ke b kf mt kj mu kn mv kr mw kv mx kz mp mq mr ms bi translated">也许应用程序代表了软件生命周期的“环境”。</li></ol><p id="6641" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">在上述所有场景中，您都有许多相似的应用程序，并且需要…</p><ol class=""><li id="53f8" class="mk ml iq ke b kf kg kj kk kn mm kr mn kv mo kz mp mq mr ms bi translated">从不同的Git存储库/分支部署。</li><li id="47d3" class="mk ml iq ke b kf mt kj mu kn mv kr mw kv mx kz mp mq mr ms bi translated">或者部署到多个/不同的Kubernetes集群。</li><li id="1457" class="mk ml iq ke b kf mt kj mu kn mv kr mw kv mx kz mp mq mr ms bi translated">或者部署到同一个Kubernetes集群的不同名称空间。</li></ol><p id="01a2" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">所有这些用例都可以通过ApplicationSet轻松实现。</p><h1 id="39cc" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">用什么“发电机”？</h1><p id="e6a7" class="pw-post-body-paragraph kc kd iq ke b kf lz kh ki kj ma kl km kn mb kp kq kr mc kt ku kv md kx ky kz ij bi translated">有许多可用的生成器，但我更喜欢的是Git文件生成器。这将键值参数生成逻辑委托给了一个JSON/YAML文件，您猜对了，这是一个Git存储库(我知道这很疯狂)。</p><p id="5592" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">下面是一个JSON文件示例(它可以包含任何参数，没有限制):</p><pre class="mg mh mi mj gt my mz na nb aw nc bi"><span id="8b77" class="nd lc iq mz b gy ne nf l ng nh">{<br/>  "tenant": {<br/>    "owner": "contact@tenant.com",<br/>    "name": "tenant",<br/>    "id": "tenantId",<br/>    "region": "eastus2"<br/>  },<br/>  "k8s_cluster": {<br/>    "owner": "admin@company.com",<br/>    "name": "customer-prod",<br/>    "address": "https://1.2.3.4"<br/>  }<br/>}</span></pre><p id="564b" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">上面定义的参数可用于应用程序集，如下所示:</p><pre class="mg mh mi mj gt my mz na nb aw nc bi"><span id="1c48" class="nd lc iq mz b gy ne nf l ng nh">apiVersion: argoproj.io/v1alpha1<br/>kind: ApplicationSet<br/>metadata:<br/>  name: tenant-apps<br/>spec:<br/>  generators:<br/>    - git:<br/>        repoURL: git@github.com:example-tenant-apps.git<br/>        revision: HEAD<br/>        files:<br/>          - path: "argocd/tenant-discovery/**/config.json"<br/>  template:<br/>    metadata:<br/>      name: '{{tenant.name}}'<br/>    spec:<br/>      project: default<br/>      source:<br/>        repoURL: git@github.com:example-tenant-configurations.git<br/>        targetRevision: HEAD<br/>        path: '{{tenant.region}}/tenants/{{tenant.name}}'<br/>        helm:<br/>          valueFiles:<br/>            - values.{{tenant.name}}.yaml<br/>      destination:<br/>        server: '{{k8s_cluster.address}}'<br/>        namespace: prod<br/>      syncPolicy: { }</span></pre><p id="5361" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">请注意应用程序模板部分。像<code class="fe ni nj nk mz b">values.{{tenant.name}}.yaml</code>这样的一些字段是通过将被生成器替换的参数来填充的。其他字段如<code class="fe ni nj nk mz b">namespace: prod</code>是硬编码的，对所有应用程序都是一样的。您希望您的应用程序集是静态的还是动态的，这完全取决于您。</p><p id="169e" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">另一个有趣的特性是，<em class="me">可以通过在路径字段中使用<code class="fe ni nj nk mz b">**</code>来发现</em>多个JSON/YAML文件。添加一个新租户只需要在<code class="fe ni nj nk mz b">argocd/tenant-discovery</code>下添加另一个带有自己的<code class="fe ni nj nk mz b">config.json</code>的文件夹。生成器将自动发现新的租户并创建另一个Argo CD应用程序资源。</p><h1 id="7c42" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">以声明方式部署应用程序集<em class="nl"/></h1><p id="5963" class="pw-post-body-paragraph kc kd iq ke b kf lz kh ki kj ma kl km kn mb kp kq kr mc kt ku kv md kx ky kz ij bi translated">虽然Argo CD应用程序可以使用Argo CD舵图以声明方式<em class="me">部署</em>，但它还不支持应用程序集部署。别担心，阿尔戈光盘来拯救！记住Argo CD应用程序可以用来部署任何东西，包括应用程序集本身！</p><p id="2606" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">这可以在上面的标题图像中看到。应用程序<code class="fe ni nj nk mz b">prod-appsets</code>部署多个ApplicationSet资源，这些资源又部署多个应用程序。Argo CD能够处理这种情况，并正确管理所有应用程序的生命周期。</p><h1 id="7416" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">应用程序集演示</h1><p id="eddc" class="pw-post-body-paragraph kc kd iq ke b kf lz kh ki kj ma kl km kn mb kp kq kr mc kt ku kv md kx ky kz ij bi translated">想要在您自己的集群中快速尝试应用程序集部署吗？查看GitHub repo并按照自述文件中的说明进行操作。</p><div class="nm nn gp gr no np"><a href="https://github.com/xsreality/argocd-applicationset-demo" rel="noopener  ugc nofollow" target="_blank"><div class="nq ab fo"><div class="nr ab ns cl cj nt"><h2 class="bd ir gy z fp nu fr fs nv fu fw ip bi translated">GitHub-xs reality/argocd-ApplicationSet-Demo:Argo CD ApplicationSet的演示库…</h2><div class="nw l"><h3 class="bd b gy z fp nu fr fs nv fu fw dk translated">此存储库包含使用ApplicationSet控制器部署Argo CD应用程序的示例配置…</h3></div><div class="nx l"><p class="bd b dl z fp nu fr fs nv fu fw dk translated">github.com</p></div></div><div class="ny l"><div class="nz l oa ob oc ny od jw np"/></div></div></a></div><h1 id="f349" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">结论</h1><p id="2455" class="pw-post-body-paragraph kc kd iq ke b kf lz kh ki kj ma kl km kn mb kp kq kr mc kt ku kv md kx ky kz ij bi translated">Argo CD是一个基于GitOps的强大的持续部署工具。与ApplicationSet相结合，它使您能够部署许多应用程序，而不必在任何地方显式声明它们。利用它为多种环境、团队、客户或您能想到的任何东西部署应用程序！如果你正在使用ApplicationSet，我想知道更多关于它的信息。</p></div></div>    
</body>
</html>