<html>
<head>
<title>Don’t let Angular Universal break you (or your app). Some tips to keep your sanity.</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">不要让Angular Universal击垮你(或你的应用)。一些让你保持理智的建议。</h1>
<blockquote>原文：<a href="https://itnext.io/dont-let-angular-universal-break-you-or-your-app-some-tips-to-keep-your-sanity-5bf263495bb9?source=collection_archive---------0-----------------------#2019-11-02">https://itnext.io/dont-let-angular-universal-break-you-or-your-app-some-tips-to-keep-your-sanity-5bf263495bb9?source=collection_archive---------0-----------------------#2019-11-02</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><p id="167e" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">服务器端渲染(SSR)并不是没有警告。调试和热修复几乎是必然的。</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi ko"><img src="../Images/1de120d9e5e93c3efa55f941f6d2a5bb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*lxJxTNqmOLgy0_pEe71hOQ.jpeg"/></div></div></figure><p id="9641" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">你想给<strong class="js iu">提供两全其美的东西</strong>。你想要一个单页面应用程序(SPA)，使用一个现代框架构建，比如Angular，它具有令人难以置信的动态渲染、可扩展的基于组件的架构、令人难以置信的工具和渐进式Web应用程序(<a class="ae la" href="https://developers.google.com/web/progressive-web-apps" rel="noopener ugc nofollow" target="_blank"> PWA </a>)功能。</p><p id="6dc7" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">但是你也想要高质量的搜索引擎优化(SEO ),你意识到这严重依赖于搜索引擎及其机器人抓取和索引你的网站的能力。<strong class="js iu">然而</strong>，尽管声称AJAX爬虫及其javascript渲染能力正在变得越来越好，但你动态插入的<code class="fe lb lc ld le b">&lt;meta&gt;</code>标签不会出现在社交卡片上，google fetch或<code class="fe lb lc ld le b">$ curl <a class="ae la" href="https://yoursite" rel="noopener ugc nofollow" target="_blank">https://yoursite</a>here.com</code>的预览会告诉你，你实际上并没有一个你发誓花了一年时间开发的网站。</p><p id="a6d5" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">此外，您意识到快速显示内容对用户参与度至关重要，并希望将您的chrome lighthouse分数提升到一个新的水平。</p><blockquote class="lf lg lh"><p id="6184" class="jq jr li js b jt ju jv jw jx jy jz ka lj kc kd ke lk kg kh ki ll kk kl km kn im bi translated"><a class="ae la" href="https://www.thinkwithgoogle.com/marketing-resources/data-measurement/mobile-page-speed-new-industry-benchmarks" rel="noopener ugc nofollow" target="_blank">如果页面加载时间超过3秒，53%的移动网站访问会被放弃。</a></p></blockquote><p id="b098" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><strong class="js iu">服务器端渲染</strong>是一个可行的解决方案，可以解决很多与你的<strong class="js iu"> SEO </strong> &amp; <strong class="js iu">性能</strong>相关的问题。然而，重要的是要事先了解你需要做的改变，这样可以省去你很多麻烦，知道为什么一切都很好…直到你上了服务器(或者更糟；<strong class="js iu">展开</strong></p></div><div class="ab cl lm ln hx lo" role="separator"><span class="lp bw bk lq lr ls"/><span class="lp bw bk lq lr ls"/><span class="lp bw bk lq lr"/></div><div class="im in io ip iq"><h1 id="3747" class="lt lu it bd lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp mq bi translated">什么是<strong class="ak">角万能？</strong></h1><p id="7c0b" class="pw-post-body-paragraph jq jr it js b jt mr jv jw jx ms jz ka kb mt kd ke kf mu kh ki kj mv kl km kn im bi translated"><strong class="js iu">角度通用</strong>是<strong class="js iu">服务器端渲染</strong> (SSR)的角度特定解决方案。SSR是通过服务器动态呈现应用程序静态版本的过程。Angular Universal的魔力可以从它通过平滑的服务器到客户端的转换引导客户端的方式中看出；考虑到应用程序的延迟加载和动态特性；生成也是可发现的高性能应用程序。该指南可在<a class="ae la" href="https://angular.io/guide/universal" rel="noopener ugc nofollow" target="_blank">这里</a>找到</p><div class="mw mx gp gr my mz"><a href="https://angular.io/guide/universal" rel="noopener  ugc nofollow" target="_blank"><div class="na ab fo"><div class="nb ab nc cl cj nd"><h2 class="bd iu gy z fp ne fr fs nf fu fw is bi translated">角度通用</h2><div class="ng l"><h3 class="bd b gy z fp ne fr fs nf fu fw dk translated">Angular是一个构建移动和桌面web应用程序的平台。加入数百万开发者的社区…</h3></div><div class="nh l"><p class="bd b dl z fp ne fr fs nf fu fw dk translated">angular.io</p></div></div></div></a></div><h1 id="220c" class="lt lu it bd lv lw ni ly lz ma nj mc md me nk mg mh mi nl mk ml mm nm mo mp mq bi translated"><strong class="ak">准备您的代码(isPlatformBrowser是您的朋友)</strong></h1><p id="d3a0" class="pw-post-body-paragraph jq jr it js b jt mr jv jw jx ms jz ka kb mt kd ke kf mu kh ki kj mv kl km kn im bi translated">如果要在服务器上成功呈现代码，需要对代码进行一些重要的更改。每个代码库都是不同的，所以细节也会不同。然而，您通常可以将SSR特定的注意事项分成几个规则。</p><ol class=""><li id="00f9" class="nn no it js b jt ju jx jy kb np kf nq kj nr kn ns nt nu nv bi translated"><strong class="js iu">不要</strong>直接访问<strong class="js iu"> DOM </strong>(没有浏览器无法访问<code class="fe lb lc ld le b">document</code> / <code class="fe lb lc ld le b">window</code>)。</li><li id="1bcf" class="nn no it js b jt nw jx nx kb ny kf nz kj oa kn ns nt nu nv bi translated"><strong class="js iu">限制</strong> / <strong class="js iu">移除</strong>使用<code class="fe lb lc ld le b">setInterval</code>或类似<strong class="js iu">定时</strong>功能</li><li id="5a49" class="nn no it js b jt nw jx nx kb ny kf nz kj oa kn ns nt nu nv bi translated">确保你的依赖关系与SSR兼容。</li><li id="79b8" class="nn no it js b jt nw jx nx kb ny kf nz kj oa kn ns nt nu nv bi translated">SSR呈现应用程序的初始状态。举个例子，如果你的图片被延迟加载，使用下一个步骤(<strong class="js iu"> 5 </strong>)提供一个兼容SSR的替代方法来确保内容在那里。</li><li id="3182" class="nn no it js b jt nw jx nx kb ny kf nz kj oa kn ns nt nu nv bi translated">如果您需要阻止某些代码在服务器上运行，请将它包装在<code class="fe lb lc ld le b">isPlatformBrowser(this.platformID) {}</code>中</li></ol><pre class="kp kq kr ks gt ob le oc od aw oe bi"><span id="24de" class="of lu it le b gy og oh l oi oj">constructor(@Inject(PLATFORM_ID) private platformID: Object) {<br/>        <br/>    // run main initialisation code</span><span id="e789" class="of lu it le b gy ok oh l oi oj">    if (isPlatformBrowser(this.platformID)) {<br/>       this.observable$ = interval(1000)... // safe to run code</span><span id="6fde" class="of lu it le b gy ok oh l oi oj">    }<br/>    // OR the alternative</span><span id="1c1c" class="of lu it le b gy ok oh l oi oj">    if (isPlatformServer(this.platformID)) {</span><span id="17b7" class="of lu it le b gy ok oh l oi oj">       // run server side code <br/>    }</span><span id="4f9e" class="of lu it le b gy ok oh l oi oj">}</span></pre><h1 id="068e" class="lt lu it bd lv lw ni ly lz ma nj mc md me nk mg mh mi nl mk ml mm nm mo mp mq bi translated">要记住的事情(提示)</h1><p id="59d5" class="pw-post-body-paragraph jq jr it js b jt mr jv jw jx ms jz ka kb mt kd ke kf mu kh ki kj mv kl km kn im bi translated">调试角度通用问题包括:</p><ul class=""><li id="7342" class="nn no it js b jt ju jx jy kb np kf nq kj nr kn ol nt nu nv bi translated">查看源代码中的预防性修复(代码不兼容问题)。</li><li id="e476" class="nn no it js b jt nw jx nx kb ny kf nz kj oa kn ol nt nu nv bi translated">测试应用程序生产版本的渲染过程，在生产环境中进行<strong class="js iu">和</strong>测试。这些要点很重要，因为一切看起来都很好，工作正常，直到您在更改后访问您的实时网站，发现它要么没有呈现，没有无数的错误，要么遇到网关超时相关的错误。</li></ul><p id="d027" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><strong class="js iu">记住</strong></p><ul class=""><li id="99a1" class="nn no it js b jt ju jx jy kb np kf nq kj nr kn ol nt nu nv bi translated">您的应用程序将在每个路由请求上被渲染两次，因此请记住，除非您使用缓存，否则您将会重复数据请求(XHR)。</li><li id="6f10" class="nn no it js b jt nw jx nx kb ny kf nz kj oa kn ol nt nu nv bi translated">为了真正看到SEO的改进，确保填充<code class="fe lb lc ld le b">&lt;meta&gt;</code>标签所需的数据尽快得到解决。</li><li id="adb2" class="nn no it js b jt nw jx nx kb ny kf nz kj oa kn ol nt nu nv bi translated">任何<code class="fe lb lc ld le b">window of undefined</code>错误通常意味着你要么必须1。<strong class="js iu">嘲笑</strong>那些功能/行为，否则你必须2。<strong class="js iu">阻止</strong>服务器到达该代码(isPlatformBrowser)。从1号<strong class="js iu">开始</strong>。，但是如果它不容易被模仿或者你真的不需要服务器端的功能，那么<strong class="js iu"> No 2 </strong>。</li></ul><h1 id="97aa" class="lt lu it bd lv lw ni ly lz ma nj mc md me nk mg mh mi nl mk ml mm nm mo mp mq bi translated">如何收回你的灵魂(调试/修复)</h1><ul class=""><li id="a82e" class="nn no it js b jt mr jx ms kb om kf on kj oo kn ol nt nu nv bi translated">请注意某些<strong class="js iu"> RXJS运算符</strong>，如<code class="fe lb lc ld le b">timer()</code>、<code class="fe lb lc ld le b">interval()</code>，因为它们在SSR的控制下会导致网关超时。</li><li id="d741" class="nn no it js b jt nw jx nx kb ny kf nz kj oa kn ol nt nu nv bi translated">测试SSR时，使用<strong class="js iu">木偶师</strong>或类似的无头浏览器。</li><li id="ceb4" class="nn no it js b jt nw jx nx kb ny kf nz kj oa kn ol nt nu nv bi translated">当在服务器环境中测试时，<strong class="js iu">关闭javascript </strong>以发现您的应用程序的SSR版本的全部功能。</li><li id="6cee" class="nn no it js b jt nw jx nx kb ny kf nz kj oa kn ol nt nu nv bi translated">在服务器平台上，对服务器请求使用绝对URL。</li><li id="caa5" class="nn no it js b jt nw jx nx kb ny kf nz kj oa kn ol nt nu nv bi translated">检查你的依赖关系<strong class="js iu"> github问题标签</strong>中已知的不兼容性。</li><li id="f5ac" class="nn no it js b jt nw jx nx kb ny kf nz kj oa kn ol nt nu nv bi translated">准备好几天来质疑你的知识、能力，以及你是否应该把你的代码扔进垃圾箱。</li></ul><figure class="kp kq kr ks gt kt"><div class="bz fp l di"><div class="op oq l"/></div></figure><h1 id="0c24" class="lt lu it bd lv lw ni ly lz ma nj mc md me nk mg mh mi nl mk ml mm nm mo mp mq bi translated">我一路上发现的一些宝石</h1><p id="fcad" class="pw-post-body-paragraph jq jr it js b jt mr jv jw jx ms jz ka kb mt kd ke kf mu kh ki kj mv kl km kn im bi translated"><strong class="js iu">TransferHTTPCacheModule</strong></p><div class="mw mx gp gr my mz"><a href="https://github.com/angular/universal/blob/master/docs/transfer-http.md" rel="noopener  ugc nofollow" target="_blank"><div class="na ab fo"><div class="nb ab nc cl cj nd"><h2 class="bd iu gy z fp ne fr fs nf fu fw is bi translated">角度/通用</h2><div class="ng l"><h3 class="bd b gy z fp ne fr fs nf fu fw dk translated">TransferHttpCacheModule安装了一个Http拦截器，它可以避免客户端上重复的HttpClient GET请求，用于…</h3></div><div class="nh l"><p class="bd b dl z fp ne fr fs nf fu fw dk translated">github.com</p></div></div><div class="or l"><div class="os l ot ou ov or ow ky mz"/></div></div></a></div><p id="965c" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><strong class="js iu">多米诺骨牌</strong></p><div class="mw mx gp gr my mz"><a href="https://www.npmjs.com/package/domino" rel="noopener  ugc nofollow" target="_blank"><div class="na ab fo"><div class="nb ab nc cl cj nd"><h2 class="bd iu gy z fp ne fr fs nf fu fw is bi translated">多米诺骨牌</h2><div class="ng l"><h3 class="bd b gy z fp ne fr fs nf fu fw dk translated">基于Mozilla 's dom.js的服务器端DOM实现</h3></div><div class="nh l"><p class="bd b dl z fp ne fr fs nf fu fw dk translated">www.npmjs.com</p></div></div><div class="or l"><div class="ox l ot ou ov or ow ky mz"/></div></div></a></div><p id="0035" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><strong class="js iu">木偶师</strong></p><div class="mw mx gp gr my mz"><a href="https://developers.google.com/web/tools/puppeteer" rel="noopener  ugc nofollow" target="_blank"><div class="na ab fo"><div class="nb ab nc cl cj nd"><h2 class="bd iu gy z fp ne fr fs nf fu fw is bi translated">木偶师|网络开发者工具|谷歌开发者</h2><div class="ng l"><h3 class="bd b gy z fp ne fr fs nf fu fw dk translated">Puppeteer是一个节点库，它提供了一个高级API来控制无头Chrome或DevTools上的Chrome</h3></div><div class="nh l"><p class="bd b dl z fp ne fr fs nf fu fw dk translated">developers.google.com</p></div></div><div class="or l"><div class="oy l ot ou ov or ow ky mz"/></div></div></a></div><p id="a498" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><strong class="js iu"> SSR兼容Flex布局</strong></p><div class="mw mx gp gr my mz"><a href="https://github.com/angular/flex-layout/wiki/Using-SSR-with-Flex-Layout" rel="noopener  ugc nofollow" target="_blank"><div class="na ab fo"><div class="nb ab nc cl cj nd"><h2 class="bd iu gy z fp ne fr fs nf fu fw is bi translated">角度/柔性布局</h2><div class="ng l"><h3 class="bd b gy z fp ne fr fs nf fu fw dk translated">为角度应用程序提供HTML UI布局；使用Flexbox和响应API - angular/flex-layout</h3></div><div class="nh l"><p class="bd b dl z fp ne fr fs nf fu fw dk translated">github.com</p></div></div><div class="or l"><div class="oz l ot ou ov or ow ky mz"/></div></div></a></div></div></div>    
</body>
</html>