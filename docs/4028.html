<html>
<head>
<title>Back up and restore EKS Kubernetes cluster resources</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">备份和恢复EKS Kubernetes集群资源</h1>
<blockquote>原文：<a href="https://itnext.io/back-up-and-restore-eks-cluster-resources-5926f24d15e5?source=collection_archive---------4-----------------------#2020-04-13">https://itnext.io/back-up-and-restore-eks-cluster-resources-5926f24d15e5?source=collection_archive---------4-----------------------#2020-04-13</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><figure class="gl gn jr js jt ju gh gi paragraph-image"><div class="gh gi jq"><img src="../Images/adc73847b4fe9d5f1fcd10ffc310a51f.png" data-original-src="https://miro.medium.com/v2/resize:fit:530/format:webp/1*E--ZNP9o9KQhybLyH9VFGw.jpeg"/></div></figure><p id="7cfd" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">备份至关重要。在集群上执行重要任务之前，最好备份Kubernetes集群资源。有一个名为Velero的工具，它允许您以一种简单的方式备份Kubernetes集群资源。在这篇博客中，我将向您展示如何使用Velero工具备份您的EKS集群资源。</p><p id="d8c2" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">Velero是一个备份和恢复Kubernetes集群资源和持久卷的工具。Velero可用作以下工具:</p><ul class=""><li id="ffe6" class="kv kw it jz b ka kb ke kf ki kx km ky kq kz ku la lb lc ld bi translated">灾难恢复</li><li id="8d5d" class="kv kw it jz b ka le ke lf ki lg km lh kq li ku la lb lc ld bi translated">数据迁移</li><li id="525a" class="kv kw it jz b ka le ke lf ki lg km lh kq li ku la lb lc ld bi translated">数据保护</li></ul><p id="ec9a" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated"><strong class="jz iu">先决条件</strong></p><ol class=""><li id="593d" class="kv kw it jz b ka kb ke kf ki kx km ky kq kz ku lj lb lc ld bi translated">AWS CLI需要在执行Velero命令的机器上进行配置。</li><li id="d046" class="kv kw it jz b ka le ke lf ki lg km lh kq li ku lj lb lc ld bi translated">Kubectl需要配置EKS集群，您需要在那里进行备份。</li></ol><p id="ac3e" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated"><strong class="jz iu">安装Velero客户端</strong></p><p id="c979" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">要使用Velero，我们需要将Velero客户机安装到本地机器上，并将Velero服务器安装到Kubernetes集群上。</p><figure class="ll lm ln lo gt ju gh gi paragraph-image"><div class="gh gi lk"><img src="../Images/81aaeed3e348117781f8e2623a108506.png" data-original-src="https://miro.medium.com/v2/resize:fit:752/format:webp/1*6kqRz2ZmSEprLvwmDqYUdg.png"/></div></figure><ol class=""><li id="72b6" class="kv kw it jz b ka kb ke kf ki kx km ky kq kz ku lj lb lc ld bi translated">下载<a class="ae lp" href="https://github.com/vmware-tanzu/velero/releases/tag/v1.3.2" rel="noopener ugc nofollow" target="_blank">最新发布的</a> tarball。</li><li id="4b75" class="kv kw it jz b ka le ke lf ki lg km lh kq li ku lj lb lc ld bi translated">提取tarball。</li></ol><p id="b70d" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated"><code class="fe lq lr ls lt b">1 tar -xvf &lt;RELEASE-TARBALL-NAME&gt;.tar.gz</code></p><p id="d344" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">3.将提取的<strong class="jz iu"> Velero </strong>二进制文件移动到$PATH中的某个位置。(例如:/usr/local/bin)</p><p id="56b4" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">我们可以使用S3来保存EKS集群的所有备份。因此，让我们用Velero工具配置AWS S3。</p><p id="aedc" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">4.在客户机中设置一个bucket名称和AWS区域作为环境变量。</p><pre class="ll lm ln lo gt lu lt lv lw aw lx bi"><span id="7b6f" class="ly lz it lt b gy ma mb l mc md">BUCKET=&lt;YOUR_BUCKET_NAME&gt; <br/>REGION=&lt;YOUR_REGION&gt;</span></pre><p id="ec6a" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">5.在给定区域创建s3存储桶。</p><pre class="ll lm ln lo gt lu lt lv lw aw lx bi"><span id="7594" class="ly lz it lt b gy ma mb l mc md">aws s3api create-bucket \    <br/>--bucket $BUCKET \     <br/>--region $REGION \     <br/>--create-bucket-configuration LocationConstraint=$REGION</span></pre><p id="4c0a" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">6.创建以下策略，以附加到EKS集群中的<strong class="jz iu"> worker-node-role </strong>。以便Velero服务器可以与s3存储桶通信来备份资源。</p><pre class="ll lm ln lo gt lu lt lv lw aw lx bi"><span id="7f4b" class="ly lz it lt b gy ma mb l mc md">cat &gt; velero-policy.json &lt;&lt;EOF<br/>{<br/>    "Version": "2012-10-17",<br/>    "Statement": [<br/>        {<br/>            "Effect": "Allow",<br/>            "Action": [<br/>                "ec2:DescribeVolumes",<br/>                "ec2:DescribeSnapshots",<br/>                "ec2:CreateTags",<br/>                "ec2:CreateVolume",<br/>                "ec2:CreateSnapshot",<br/>                "ec2:DeleteSnapshot"<br/>            ],<br/>            "Resource": "*"<br/>        },<br/>        {<br/>            "Effect": "Allow",<br/>            "Action": [<br/>                "s3:GetObject",<br/>                "s3:DeleteObject",<br/>                "s3:PutObject",<br/>                "s3:AbortMultipartUpload",<br/>                "s3:ListMultipartUploadParts"<br/>            ],<br/>            "Resource": [<br/>                "arn:aws:s3:::${BUCKET}/*"<br/>            ]<br/>        },<br/>        {<br/>            "Effect": "Allow",<br/>            "Action": [<br/>                "s3:ListBucket"<br/>            ],<br/>            "Resource": [<br/>                "arn:aws:s3:::${BUCKET}"<br/>            ]<br/>        }<br/>    ]<br/>}<br/>EOF</span></pre><p id="3b16" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">7.将上述策略附加到worker-node-role。(在应用之前，您需要找到与您需要进行备份的EKS集群相对应的worker节点角色)</p><pre class="ll lm ln lo gt lu lt lv lw aw lx bi"><span id="6a50" class="ly lz it lt b gy ma mb l mc md">aws iam put-user-policy \   <br/>--user-name &lt;worker-node-role&gt; \   <br/>--policy-name velero \   <br/>--policy-document file://velero-policy.json</span></pre><p id="820c" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">8.在Kubernetes集群中安装Velero服务器。</p><p id="03c2" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">在客户端机器上运行下面的命令，它将在配置了kubectl上下文的Kubernetes集群中安装Velero。</p><p id="3585" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">用适当的信息替换AWS-ACCOUNT-ID和WORKER-NODE-ROLE。</p><pre class="ll lm ln lo gt lu lt lv lw aw lx bi"><span id="faa8" class="ly lz it lt b gy ma mb l mc md">velero install \     <br/>--provider aws \     <br/>--plugins velero/velero-plugin-for-aws:v1.0.1 \     <br/>--bucket $BUCKET \     <br/>--backup-location-config region=$REGION \     <br/>--snapshot-location-config region=$REGION \     <br/>--pod-annotations iam.amazonaws.com/role=arn:aws:iam::<strong class="lt iu">&lt;AWS-ACCOUNT-ID&gt;</strong>:role/<strong class="lt iu">&lt;WORKER-NODE-ROLE&gt;</strong> \     <br/>--no-secret</span></pre><p id="e90f" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated"><strong class="jz iu">备份集群数据</strong></p><p id="dc4d" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">运行以下命令来备份集群命名空间的数据。您可以备份每个命名空间、每个应用程序或每个群集的资源。在这里，我将备份每个命名空间的资源。有关备份策略的更多信息，请使用<a class="ae lp" href="https://velero.io/docs/master/index.html" rel="noopener ugc nofollow" target="_blank"> Velero官方文档</a>。</p><p id="f47a" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated"><code class="fe lq lr ls lt b">1 velero backup create &lt;backup-name&gt; --include-namespaces &lt;namespace&gt;</code></p><p id="76e6" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">这将在配置的S3存储桶中创建一个备份数据对象。</p><p id="3dc3" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated"><strong class="jz iu">恢复集群数据</strong></p><p id="200f" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">运行以下命令，从现有备份中还原数据。</p><p id="23e0" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated"><code class="fe lq lr ls lt b">1 velero restore create &lt;restore-name&gt; --from-backup &lt;backup-name&gt;</code></p><p id="a294" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">希望现在你能清楚地了解如何备份你的Kubernetes资源并上传到AWS S3。干杯！！</p></div></div>    
</body>
</html>