<html>
<head>
<title>AWS: Web Application Firewall overview, configuration, and its monitoring</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">AWS: Web应用防火墙概述、配置及其监控</h1>
<blockquote>原文：<a href="https://itnext.io/aws-web-application-firewall-overview-configuration-and-its-monitoring-1e1eea0604e5?source=collection_archive---------5-----------------------#2021-07-19">https://itnext.io/aws-web-application-firewall-overview-configuration-and-its-monitoring-1e1eea0604e5?source=collection_archive---------5-----------------------#2021-07-19</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/d7b04ab8d0a13f0c18f017050ab75330.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*kxhBUoieJ_Br1m9n6ScjaA.jpeg"/></div></div></figure><p id="3420" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><a class="ae kw" href="https://docs.aws.amazon.com/waf/latest/developerguide/waf-chapter.html" rel="noopener ugc nofollow" target="_blank"> AWS WAF </a> (Web应用程序防火墙)是一种AWS服务，用于监控传入流量，以保护Web应用程序免受SQL注入等可疑活动的影响。可以附加到AWS应用程序负载平衡器、AWS CloudFront发行版、Amazon API网关和AWS AppSync GraphQL API。</p><p id="d895" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">如果发现任何符合WAF规则的请求，它将被阻止，其发送者将得到403响应。</p><p id="fc46" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">AWS晶圆由四个主要组件组成:</p><ul class=""><li id="8831" class="kx ky iq ka b kb kc kf kg kj kz kn la kr lb kv lc ld le lf bi translated"><strong class="ka ir"> Web ACL </strong>:访问控制列表，它保存了检查传入请求的规则列表</li><li id="0031" class="kx ky iq ka b kb lg kf lh kj li kn lj kr lk kv lc ld le lf bi translated"><strong class="ka ir"> IP集合</strong>:可以附加到ACL的IP范围列表</li><li id="cddd" class="kx ky iq ka b kb lg kf lh kj li kn lj kr lk kv lc ld le lf bi translated"><strong class="ka ir">规则</strong>:规则本身，描述了哪些请求以及如何检查。这些规则可以是阻止IP设置、报头检查、请求正文内容检查等。</li><li id="925a" class="kx ky iq ka b kb lg kf lh kj li kn lj kr lk kv lc ld le lf bi translated"><strong class="ka ir">规则组</strong>:这样的规则也可以被分组以在ACL中使用，另外，AWS提供了一组已经预定义的组— <a class="ae kw" href="https://rtfm.co.ua/en/?p=26525#Managed_Rule_groups" rel="noopener ugc nofollow" target="_blank"> AWS管理的规则</a>，以及来自其市场的组</li></ul><p id="a5fb" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">AWS WAF有其ACL容量:每个列表可以容纳多达1500 WCU (WAF容量单位)。我们将在<a class="ae kw" href="https://rtfm.co.ua/en/aws-web-application-firewall-overview-configuration-and-its-monitoring/#AWS_WAF_limitations" rel="noopener ugc nofollow" target="_blank"> AWS WAF限制</a>中讨论WAF的限制。另外，检查<a class="ae kw" href="https://docs.aws.amazon.com/waf/latest/developerguide/how-aws-waf-works.html#aws-waf-capacity-units" rel="noopener ugc nofollow" target="_blank"> AWS WAF Web ACL容量单位(WCU) </a>。</p><p id="d158" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">最不方便的限制是一个应用负载平衡器只能连接一个ACL。</p><p id="09ec" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">此外，我询问了AWS团队关于性能的问题——将WAF ACL附加到ALB/CloudFront是否会影响其响应时间，但无论如何，ACL或其中的规则数量都不会影响目标。</p><p id="a392" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">因此，在这篇文章中，我们将在Kubernetes中启动一个测试应用程序，介绍主要的WAF概念，了解如何为ACL配置规则，创建这样一个ACL，并使用CloudWatch和с Prometheus配置其监控。</p><h1 id="cc47" class="ll lm iq bd ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi bi translated"><strong class="ak">内容</strong></h1><ul class=""><li id="57c4" class="kx ky iq ka b kb mj kf mk kj ml kn mm kr mn kv lc ld le lf bi translated"><a class="ae kw" href="https://rtfm.co.ua/en/aws-web-application-firewall-overview-configuration-and-its-monitoring/#A_testing_application" rel="noopener ugc nofollow" target="_blank">测试应用</a></li><li id="15b5" class="kx ky iq ka b kb lg kf lh kj li kn lj kr lk kv lc ld le lf bi translated"><a class="ae kw" href="https://rtfm.co.ua/en/aws-web-application-firewall-overview-configuration-and-its-monitoring/#AWS_WAF_configuration" rel="noopener ugc nofollow" target="_blank"> AWS晶圆配置</a></li><li id="0096" class="kx ky iq ka b kb lg kf lh kj li kn lj kr lk kv lc ld le lf bi translated"><a class="ae kw" href="https://rtfm.co.ua/en/aws-web-application-firewall-overview-configuration-and-its-monitoring/#Create_a_Web_ACL" rel="noopener ugc nofollow" target="_blank">创建Web ACL </a></li><li id="c237" class="kx ky iq ka b kb lg kf lh kj li kn lj kr lk kv lc ld le lf bi translated"><a class="ae kw" href="https://rtfm.co.ua/en/aws-web-application-firewall-overview-configuration-and-its-monitoring/#IP_set" rel="noopener ugc nofollow" target="_blank"> IP设置</a></li><li id="199e" class="kx ky iq ka b kb lg kf lh kj li kn lj kr lk kv lc ld le lf bi translated"><a class="ae kw" href="https://rtfm.co.ua/en/aws-web-application-firewall-overview-configuration-and-its-monitoring/#Create_ACL_Rules" rel="noopener ugc nofollow" target="_blank">创建ACL规则</a></li><li id="bf32" class="kx ky iq ka b kb lg kf lh kj li kn lj kr lk kv lc ld le lf bi translated"><a class="ae kw" href="https://rtfm.co.ua/en/aws-web-application-firewall-overview-configuration-and-its-monitoring/#Limiting_access_by_a_URI_and_rules_priority" rel="noopener ugc nofollow" target="_blank">通过URI和规则优先级限制访问</a></li><li id="7fc7" class="kx ky iq ka b kb lg kf lh kj li kn lj kr lk kv lc ld le lf bi translated"><a class="ae kw" href="https://rtfm.co.ua/en/aws-web-application-firewall-overview-configuration-and-its-monitoring/#SQL_injection_block" rel="noopener ugc nofollow" target="_blank"> SQL注入街区</a></li><li id="4efa" class="kx ky iq ka b kb lg kf lh kj li kn lj kr lk kv lc ld le lf bi translated"><a class="ae kw" href="https://rtfm.co.ua/en/aws-web-application-firewall-overview-configuration-and-its-monitoring/#Managed_Rule_groups" rel="noopener ugc nofollow" target="_blank">托管规则组</a></li><li id="03a0" class="kx ky iq ka b kb lg kf lh kj li kn lj kr lk kv lc ld le lf bi translated"><a class="ae kw" href="https://rtfm.co.ua/en/aws-web-application-firewall-overview-configuration-and-its-monitoring/#Rule_groups_and_an_ACL_deletion" rel="noopener ugc nofollow" target="_blank">规则组和ACL删除</a></li><li id="e44a" class="kx ky iq ka b kb lg kf lh kj li kn lj kr lk kv lc ld le lf bi translated"><a class="ae kw" href="https://rtfm.co.ua/en/aws-web-application-firewall-overview-configuration-and-its-monitoring/#AWS_WAF_limitations" rel="noopener ugc nofollow" target="_blank"> AWS晶圆限制</a></li><li id="39e6" class="kx ky iq ka b kb lg kf lh kj li kn lj kr lk kv lc ld le lf bi translated"><a class="ae kw" href="https://rtfm.co.ua/en/aws-web-application-firewall-overview-configuration-and-its-monitoring/#AWS_WAF_monitoring" rel="noopener ugc nofollow" target="_blank"> AWS晶圆监控</a></li><li id="705e" class="kx ky iq ka b kb lg kf lh kj li kn lj kr lk kv lc ld le lf bi translated"><a class="ae kw" href="https://rtfm.co.ua/en/aws-web-application-firewall-overview-configuration-and-its-monitoring/#AWS_CloudWatch_metrics_and_Prometheus" rel="noopener ugc nofollow" target="_blank"> AWS CloudWatch metrics和Prometheus </a></li><li id="3345" class="kx ky iq ka b kb lg kf lh kj li kn lj kr lk kv lc ld le lf bi translated"><a class="ae kw" href="https://rtfm.co.ua/en/aws-web-application-firewall-overview-configuration-and-its-monitoring/#AWS_WAF_logs" rel="noopener ugc nofollow" target="_blank"> AWS晶圆日志</a></li><li id="9ca8" class="kx ky iq ka b kb lg kf lh kj li kn lj kr lk kv lc ld le lf bi translated"><a class="ae kw" href="https://rtfm.co.ua/en/aws-web-application-firewall-overview-configuration-and-its-monitoring/#AWS_Kinesis_Data_Firehose_delivery_stream" rel="noopener ugc nofollow" target="_blank"> AWS Kinesis数据消防水管输送流</a></li><li id="422a" class="kx ky iq ka b kb lg kf lh kj li kn lj kr lk kv lc ld le lf bi translated"><a class="ae kw" href="https://rtfm.co.ua/en/aws-web-application-firewall-overview-configuration-and-its-monitoring/#WAF_ACL_logging" rel="noopener ugc nofollow" target="_blank"> WAF ACL记录</a></li><li id="c646" class="kx ky iq ka b kb lg kf lh kj li kn lj kr lk kv lc ld le lf bi translated"><a class="ae kw" href="https://rtfm.co.ua/en/aws-web-application-firewall-overview-configuration-and-its-monitoring/#AWS_ALB_Kubernetes_Ingress_and_AWS_WAF" rel="noopener ugc nofollow" target="_blank"> AWS ALB、Kubernetes Ingress和AWS WAF </a></li><li id="1d78" class="kx ky iq ka b kb lg kf lh kj li kn lj kr lk kv lc ld le lf bi translated"><a class="ae kw" href="https://rtfm.co.ua/en/aws-web-application-firewall-overview-configuration-and-its-monitoring/#Useful_links" rel="noopener ugc nofollow" target="_blank">有用链接</a></li></ul><h1 id="7dfe" class="ll lm iq bd ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi bi translated">测试应用程序</h1><p id="463a" class="pw-post-body-paragraph jy jz iq ka b kb mj kd ke kf mk kh ki kj mo kl km kn mp kp kq kr mq kt ku kv ij bi translated">让我们使用一个简单的Kubernetes部署，它将创建一个包含Nginx、服务和入口资源的Kubernetes Pod。这个带有<a class="ae kw" href="https://rtfm.co.ua/aws-migraciya-aws-alb-ingress-controller-v1-na-aws-load-balancer-controller-v2/" rel="noopener ugc nofollow" target="_blank"> AWS负载平衡器控制器</a>的入口将创建一个AWS应用负载平衡器。</p><pre class="mr ms mt mu gt mv mw mx my aw mz bi"><span id="468c" class="na lm iq mw b gy nb nc l nd ne">---<br/>apiVersion: v1<br/>kind: Namespace<br/>metadata:<br/>  name: test-namespace<br/>---<br/>apiVersion: apps/v1<br/>kind: Deployment<br/>metadata:<br/>  name: test-deployment<br/>  namespace: test-namespace<br/>  labels:<br/>    app: test<br/>    version: v1<br/>spec:<br/>  replicas: 1<br/>  selector:<br/>    matchLabels:<br/>      app: test<br/>  template:<br/>    metadata:<br/>      labels:<br/>        app: test<br/>        version: v1<br/>    spec:<br/>      containers:<br/>      - name: web<br/>        image: nginxdemos/hello<br/>        ports:<br/>        - containerPort: 80<br/>        resources:<br/>          requests:<br/>            cpu: 100m<br/>            memory: 100Mi<br/>        readinessProbe:<br/>          httpGet:<br/>            path: /<br/>            port: 80<br/>---<br/>apiVersion: v1<br/>kind: Service<br/>metadata:<br/>  name: test-svc<br/>  namespace: test-namespace<br/>spec:<br/>  type: NodePort<br/>  selector:<br/>    app: test<br/>  ports:<br/>    - name: http<br/>      protocol: TCP<br/>      port: 80<br/>      targetPort: 80<br/>---<br/>apiVersion: extensions/v1beta1<br/>kind: Ingress<br/>metadata:<br/>  name: test-ingress<br/>  namespace: test-namespace<br/>  annotations:<br/>    kubernetes.io/ingress.class: alb<br/>    alb.ingress.kubernetes.io/scheme: internet-facing<br/>    alb.ingress.kubernetes.io/listen-ports: '[{"HTTP": 80}]'<br/>    alb.ingress.kubernetes.io/inbound-cidrs: 0.0.0.0/0<br/>    external-dns.alpha.kubernetes.io/hostname: "testapp.dev.example.com"<br/>spec:<br/>  rules:<br/>  - http:<br/>      paths:<br/>      - backend:<br/>          serviceName: test-svc<br/>          servicePort: 80</span></pre><p id="df7b" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">部署它，并检查入口及其ALB:</p><pre class="mr ms mt mu gt mv mw mx my aw mz bi"><span id="d12f" class="na lm iq mw b gy nb nc l nd ne">$ kubectl -n test-namespace get ingress<br/>NAME CLASS HOSTS ADDRESS PORTS AGE<br/>test-ingress &lt;none&gt; * aadca942-***.us-east-2.elb.amazonaws.com 80 46s</span></pre><p id="f835" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">检查ALB的响应:</p><pre class="mr ms mt mu gt mv mw mx my aw mz bi"><span id="9df0" class="na lm iq mw b gy nb nc l nd ne">$ curl -I testapp.dev.example.com<br/>HTTP/1.1 200 OK</span></pre><p id="5f09" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">这里一切正常，我们去AWS WAF吧。</p><h1 id="abac" class="ll lm iq bd ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi bi translated">AWS晶片配置</h1><h2 id="9b31" class="na lm iq bd ln nf ng dn lr nh ni dp lv kj nj nk lz kn nl nm md kr nn no mh np bi translated">创建Web ACL</h2><p id="9896" class="pw-post-body-paragraph jy jz iq ka b kb mj kd ke kf mk kh ki kj mo kl km kn mp kp kq kr mq kt ku kv ij bi translated">进入AWS控制台&gt; WAF，点击<em class="nq">创建web ACL </em>:</p><figure class="mr ms mt mu gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nr"><img src="../Images/e8704b8c0e9fa396ec8b39f93687e275.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*YUiig2lOM71ofc31.png"/></div></div></figure><p id="2b83" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在这种情况下，我们会附加一个AWS ALB，所以一开始(！)选择一个必要的AWS区域，然后设置一个ACL名称，该名称也将用于CloudWatch指标，它们将在下面的<a class="ae kw" href="https://rtfm.co.ua/en/aws-web-application-firewall-overview-configuration-and-its-monitoring/#AWS_CloudWatch_metrics_and_Prometheus" rel="noopener ugc nofollow" target="_blank"> AWS CloudWatch指标和Prometheus </a>主题中讨论:</p><figure class="mr ms mt mu gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi ns"><img src="../Images/f75e029a847c07b8115873476aab4876.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*V35FWd1KafIO6E9_.png"/></div></div></figure><p id="a919" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">接下来，找到要保护的ALB:</p><figure class="mr ms mt mu gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nt"><img src="../Images/baa76d7cf7c1c9c92941f5e60df4173c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*yjz-V9ajLXrY5y8B.png"/></div></div></figure><figure class="mr ms mt mu gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nu"><img src="../Images/4ddc24f74de68bb615200f3eb68acc7d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*KBWfhx-82iIFlzQA.png"/></div></div></figure><p id="1bf2" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">从现在开始，发送到这个AWS ALB的每个请求将首先通过ACL的规则链发送，然后它将被403错误拒绝，或者将被传递到这个负载平衡器后面的应用程序。</p><p id="9983" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我们稍后将添加规则，现在只保留默认操作设置为<em class="nq">允许</em>:</p><figure class="mr ms mt mu gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nv"><img src="../Images/05cac65baf3a9329a86ca3d6a719e75b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*Gs-iys7f92AhgFXJ.png"/></div></div></figure><p id="fe03" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在这里，您还可以配置其他操作:</p><ul class=""><li id="b0a2" class="kx ky iq ka b kb kc kf kg kj kz kn la kr lb kv lc ld le lf bi translated">对于<em class="nq"> Allow </em>:添加一个自定义头，它将被附加到通过所有检查并被发送到应用程序的所有请求上</li><li id="0641" class="kx ky iq ka b kb lg kf lh kj li kn lj kr lk kv lc ld le lf bi translated">对于<em class="nq">块</em>:在这里，我们可以设置一个自定义响应代码，该代码将返回给所有被阻止的客户端，或者可以指定一个自定义头和/或响应体:</li></ul><figure class="mr ms mt mu gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nw"><img src="../Images/e3472c3c4af50bc1f4df9162afc6e1f7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*Iqq6Rrfhhi61PcyO.png"/></div></div></figure><figure class="mr ms mt mu gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nw"><img src="../Images/094a1a3da63c853f960f4cdf10cd4f2a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*AA4qMnKTwBuhQvVx.png"/></div></div></figure><p id="7be8" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">再说一遍，现在只保留这里的默认设置，因为这可以在以后进行配置。</p><p id="8fe8" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">与常见的防火墙类似，您可以在ACL中配置规则优先级:将应用第一个匹配请求的规则:</p><figure class="mr ms mt mu gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nx"><img src="../Images/381919272524dfa82bdc2a35df652caa.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*3KGqGkHmlhLSGTbd.png"/></div></div></figure><p id="282b" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">现在也跳过。</p><p id="2e96" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">CloudWatch将稍后配置，所以也跳过它:</p><figure class="mr ms mt mu gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi ny"><img src="../Images/9e39f04834054d12d108e902e32fbbd0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*VFD5MdJRLQC_Fnuj.png"/></div></div></figure><p id="1205" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">运行<code class="fe nz oa ob mw b">curl</code>到测试ALB以获得一些流量和图表:</p><pre class="mr ms mt mu gt mv mw mx my aw mz bi"><span id="09bd" class="na lm iq mw b gy nb nc l nd ne">$ watch -n 1 curl -I testapp.dev.example.com</span></pre><figure class="mr ms mt mu gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi oc"><img src="../Images/035678debef13b55ed812731f33f5509.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*rnozDhodwiPwmXXQ.png"/></div></div></figure><h2 id="662d" class="na lm iq bd ln nf ng dn lr nh ni dp lv kj nj nk lz kn nl nm md kr nn no mh np bi translated">IP集</h2><p id="abc2" class="pw-post-body-paragraph jy jz iq ka b kb mj kd ke kf mk kh ki kj mo kl km kn mp kp kq kr mq kt ku kv ij bi translated"><em class="nq"> IP集合</em>允许创建一组IP或IP范围，可在以后的规则中使用。</p><p id="8a4d" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">例如，我们可以创建一组office IPs来制定允许规则。参见<a class="ae kw" href="https://docs.aws.amazon.com/waf/latest/developerguide/waf-ip-set-creating.html" rel="noopener ugc nofollow" target="_blank">创建IP集</a>:</p><figure class="mr ms mt mu gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi od"><img src="../Images/d9339824d5b10682ff7286d33b7fbca5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*WeWXRzAsEZ_E-gjp.png"/></div></div></figure><p id="698d" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">请注意这里的AWS区域:对于CloudFront，您必须选择<em class="nq"> CloudFront (Global) </em>，对于所有其他区域—一个安全资源所在的区域。</p><p id="eea1" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">获取您当前的IP(我的办公室):</p><pre class="mr ms mt mu gt mv mw mx my aw mz bi"><span id="1f5b" class="na lm iq mw b gy nb nc l nd ne">$ curl ifconfig.me<br/>194.***.***.29</span></pre><p id="4a77" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">创建一个IP集，使用<code class="fe nz oa ob mw b">/29</code>掩码包含我们所有的office IPs:</p><figure class="mr ms mt mu gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi oe"><img src="../Images/02bde82345220a4eb3de529ead3245d6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*fD_H_Z3dmBWyAW0V.png"/></div></div></figure><p id="a359" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">现在，让我们来看看规则。</p><h2 id="e2c3" class="na lm iq bd ln nf ng dn lr nh ni dp lv kj nj nk lz kn nl nm md kr nn no mh np bi translated">创建ACL规则</h2><p id="cc33" class="pw-post-body-paragraph jy jz iq ka b kb mj kd ke kf mk kh ki kj mo kl km kn mp kp kq kr mq kt ku kv ij bi translated">选择上面创建的ACL，点击<em class="nq">添加规则</em>，选择<em class="nq">添加我自己的规则</em>:</p><figure class="mr ms mt mu gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi od"><img src="../Images/3103f861156ff1afcb37dd0bcf7083ec.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*itlfM6CKtCkRggTu.png"/></div></div></figure><p id="8a73" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">让我们添加一个简单的规则:阻止所有来自我们办公室的请求。</p><p id="1c95" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">选择<em class="nq">规则类型</em> == IP集，因为我们将使用之前创建的IP集，设置规则的名称，选择您的IP集，使用<em class="nq">源IP地址</em>，以及默认操作— <em class="nq">阻止</em>:</p><figure class="mr ms mt mu gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi of"><img src="../Images/5c3570b16f5604253502a955f29d1d40.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*1vE3GOjKwwFTbVpe.png"/></div></div></figure><p id="7a42" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">如果将动作设置为<em class="nq">计数，</em> WAF将只对符合规则的请求进行计数，而不进行阻塞活动。可用于在应用规则之前进行测试:</p><figure class="mr ms mt mu gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi og"><img src="../Images/eaa9f0ae660bd4511e39da60995baf03.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*pq_x9vxQiYqF4GqX.png"/></div></div></figure><p id="3b73" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">几秒钟后，我们会收到403条回复:</p><pre class="mr ms mt mu gt mv mw mx my aw mz bi"><span id="8f66" class="na lm iq mw b gy nb nc l nd ne">$ curl -I testapp.dev.example.com<br/>HTTP/1.1 403 Forbidden</span></pre><p id="c529" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">现在，让我们尝试做一些更有趣的事情:只允许来自办公室的流量，但阻止来自世界的所有其他请求。</p><p id="7830" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">由于没有办法用0.0.0.0/0 CIDR创建IP集，所以让我们用不同的方法来创建:将ACL的默认动作更改为<em class="nq"> Block </em>，并将office的IP集使用为Allowed规则。</p><p id="69e2" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">编辑<em class="nq">默认web ACL操作</em>:</p><figure class="mr ms mt mu gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi oh"><img src="../Images/9ea802af0c0da8b32ce3eadb8d81ea4d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*VTIpEKZK23EdDNvx.png"/></div></div></figure><figure class="mr ms mt mu gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi oi"><img src="../Images/29e48af63fbb5142b5f9e6a879a9fbd4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*RYhItJPuaeo0a8Zh.png"/></div></div></figure><p id="f342" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">从不同于办公室的地方检查访问，例如从rtfm.co.ua所在的<a class="ae kw" href="https://rtfm.co.ua/" rel="noopener ugc nofollow" target="_blank">服务器。在15–20中，将应用新设置:</a></p><figure class="mr ms mt mu gt jr gh gi paragraph-image"><div class="gh gi oj"><img src="../Images/d778e7c86e9e2149668c0c2eaf199871.png" data-original-src="https://miro.medium.com/v2/resize:fit:1092/format:webp/0*JPr9Pp2g-6Z1bxlJ.png"/></div></figure><p id="ab55" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">回到ACL <em class="nq">测试-办公室-规则</em>，从办公室将<em class="nq">阻塞</em>改为<em class="nq">允许</em>:</p><figure class="mr ms mt mu gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi ok"><img src="../Images/ab4c9fe39ccc41aae45581cba3cadafa.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*njzI_91XzJ2NlXCk.png"/></div></div></figure><figure class="mr ms mt mu gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi ol"><img src="../Images/eee631b9604e38fde8af40acfeda0da0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*NN_gg-rRP2waxtGA.png"/></div></div></figure><p id="a586" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">从办公室检查它现在是否工作:</p><figure class="mr ms mt mu gt jr gh gi paragraph-image"><div class="gh gi om"><img src="../Images/fbe0eadbaee81c25237241a68b8f4bf0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1240/format:webp/0*vktEk2mwBvxeMzMw.png"/></div></figure><h2 id="f60c" class="na lm iq bd ln nf ng dn lr nh ni dp lv kj nj nk lz kn nl nm md kr nn no mh np bi translated">通过URI和规则优先级限制访问</h2><p id="48ad" class="pw-post-body-paragraph jy jz iq ka b kb mj kd ke kf mk kh ki kj mo kl km kn mp kp kq kr mq kt ku kv ij bi translated">好吧，但是如果我们只想阻止公众访问某个特定的URI，比如说<em class="nq"> /status </em>，但是允许它从办公室访问，该怎么办呢？</p><p id="c9ca" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">为此，我们需要:</p><ol class=""><li id="2eed" class="kx ky iq ka b kb kc kf kg kj kz kn la kr lb kv on ld le lf bi translated">将默认动作设置回<em class="nq">允许</em></li><li id="f097" class="kx ky iq ka b kb lg kf lh kj li kn lj kr lk kv on ld le lf bi translated">添加一条规则允许<em class="nq">/状态</em>的URI离开办公室</li><li id="9f31" class="kx ky iq ka b kb lg kf lh kj li kn lj kr lk kv on ld le lf bi translated">添加一条规则来阻止<em class="nq">/状态</em> URI进入这个世界</li></ol><p id="5ae9" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">回到ACL的默认操作，将其改回<em class="nq"> Allow，</em>从而允许从任何地方访问ALB:</p><figure class="mr ms mt mu gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi oo"><img src="../Images/7929e5a9fd19fcd73ef0aa33b0496fe6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*Nv78K8lUW-e5Zey2.png"/></div></div></figure><p id="1955" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">现在，我们需要两个额外的规则:一个从办公室允许，一个从世界上阻止。让我们从阻塞规则开始。</p><p id="06d2" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">此时，使用<em class="nq">规则生成器</em>，调用规则为<em class="nq"> block-status-uri-world </em>，在<em class="nq">语句</em>中选择<em class="nq"> URI路径</em>，设置一个值为<em class="nq"> /status </em>，在<em class="nq">动作</em>中设置<em class="nq"> Block </em>:</p><figure class="mr ms mt mu gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi op"><img src="../Images/096e9bb32004775a8c69e3509bbbdf1c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*eOZupHRF1aNZDDo3.png"/></div></div></figure><figure class="mr ms mt mu gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi of"><img src="../Images/931f15f330187d0d17b42b344d2146c1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*XyeUWlYiHbPlPzn1.png"/></div></div></figure><p id="b66a" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">现在检查入口。</p><p id="3e0d" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">从办公室到/:</p><pre class="mr ms mt mu gt mv mw mx my aw mz bi"><span id="2818" class="na lm iq mw b gy nb nc l nd ne">15:33:29 [setevoy@setevoy-arch-work ~] $ curl -I testapp.dev.example.com<br/>HTTP/1.1 200 OK</span></pre><p id="b08e" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">以及从另一个IP到/:</p><pre class="mr ms mt mu gt mv mw mx my aw mz bi"><span id="a20e" class="na lm iq mw b gy nb nc l nd ne">root@rtfm-do-production-d10:~# curl -I testapp.dev.example.com<br/>HTTP/1.1 200 OK</span></pre><p id="bff2" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">从办公室到<em class="nq">/状态</em>:</p><pre class="mr ms mt mu gt mv mw mx my aw mz bi"><span id="c48f" class="na lm iq mw b gy nb nc l nd ne">16:08:42 [setevoy@setevoy-arch-work ~] $ curl -I testapp.dev.example.com/status<br/>HTTP/1.1 403 Forbidden</span></pre><p id="e414" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">从世界上来说:</p><pre class="mr ms mt mu gt mv mw mx my aw mz bi"><span id="0800" class="na lm iq mw b gy nb nc l nd ne">root@rtfm-do-production-d10:~# curl -I testapp.dev.example.com/status<br/>HTTP/1.1 403 Forbidden</span></pre><p id="ff70" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">好:现在我们已经授予了从任何地方访问网站根目录的权限，并且从任何地方都阻止了<em class="nq"> /status </em>。现在，让我们允许从办公室进行<em class="nq"> /status </em>访问。</p><p id="7a50" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">回到规则，添加另一个规则，姑且称之为<em class="nq">allow-status-uri-office</em>:</p><figure class="mr ms mt mu gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nu"><img src="../Images/f5f54e474c8ec39af5f492706da22d23.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*QjCrhZ9ODL73q4iq.png"/></div></div></figure><p id="7b5e" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">构建规则的条件:</p><ol class=""><li id="0648" class="kx ky iq ka b kb kc kf kg kj kz kn la kr lb kv on ld le lf bi translated">如果URI = =<em class="nq">/状态</em></li><li id="32d5" class="kx ky iq ka b kb lg kf lh kj li kn lj kr lk kv on ld le lf bi translated">如果IP = =<em class="nq">test-Bt trm-office-IP-set</em></li><li id="2013" class="kx ky iq ka b kb lg kf lh kj li kn lj kr lk kv on ld le lf bi translated">然后<em class="nq">允许</em></li></ol><figure class="mr ms mt mu gt jr gh gi paragraph-image"><div class="gh gi oq"><img src="../Images/dc355f658ffec099c4dd336c99d365db.png" data-original-src="https://miro.medium.com/v2/resize:fit:1324/format:webp/0*ZKPs1QjHjmn6hS8j.png"/></div></figure><p id="0fc1" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">顺便说一下，请注意<em class="nq"> Capacity </em>字段:这里我们可以看到ACL中总共1500个可用的wcu中有多少个将被规则消耗。</p><p id="c9ae" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">因此，我们添加了一个允许规则，但现在它将不起作用，因为我们有了第一个规则<em class="nq"> block-status-uri-world </em>，它将阻止对<em class="nq"> /status，</em>的所有请求，甚至来自办公室的请求:</p><figure class="mr ms mt mu gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi or"><img src="../Images/5a7fbbca2b00fa6d0f7019460abbb080.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*jucxstHiCv7mWfIR.png"/></div></div></figure><p id="ec3b" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">要解决这个问题，请将<em class="nq">allow-status-uri-office</em>移到列表的开头:</p><figure class="mr ms mt mu gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi or"><img src="../Images/a5f0e55835511cfef889cfebe33480f0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*EWbekqO9gW1KeD4I.png"/></div></div></figure><p id="01e6" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">所以接下来的重点是:</p><figure class="mr ms mt mu gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi os"><img src="../Images/324452b963d74d2de8303324b6b5f2a0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*A1eajd0b46UCuG01.png"/></div></div></figure><p id="3631" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">检查办公室外的访问:</p><pre class="mr ms mt mu gt mv mw mx my aw mz bi"><span id="2313" class="na lm iq mw b gy nb nc l nd ne">root@rtfm-do-production-d10:~# curl -I testapp.dev.example.com/status<br/>HTTP/1.1 403 Forbidden</span></pre><p id="c2e9" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">很好，被屏蔽了。现在，在办公室里:</p><pre class="mr ms mt mu gt mv mw mx my aw mz bi"><span id="7655" class="na lm iq mw b gy nb nc l nd ne">16:18:00 [setevoy@setevoy-arch-work ~] $ curl -I testapp.dev.example.com/status<br/>HTTP/1.1 200 OK</span></pre><p id="f88b" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">这是可行的。</p><h2 id="2cc0" class="na lm iq bd ln nf ng dn lr nh ni dp lv kj nj nk lz kn nl nm md kr nn no mh np bi translated">SQL注入街区</h2><p id="4b1c" class="pw-post-body-paragraph jy jz iq ka b kb mj kd ke kf mk kh ki kj mo kl km kn mp kp kq kr mq kt ku kv ij bi translated">其中一个最讨厌的攻击类型是SQL注入，这绝对值得被禁止。</p><p id="ffdd" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在AWS WAF管理的规则中，我们有一个来自AWS本身及其合作伙伴的预定义规则列表，您也可以自己创建这样的块。</p><p id="5bde" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">创建一个名为<em class="nq"> sqli-test </em>的新规则:</p><figure class="mr ms mt mu gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi ot"><img src="../Images/bb08a6a15cc31ae242578ad4d8e9b2fa.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*X28fMwa8JnSPiULA.png"/></div></div></figure><p id="ac25" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">定义其条件:</p><ul class=""><li id="6907" class="kx ky iq ka b kb kc kf kg kj kz kn la kr lb kv lc ld le lf bi translated">检查<em class="nq">查询</em></li><li id="a9ca" class="kx ky iq ka b kb lg kf lh kj li kn lj kr lk kv lc ld le lf bi translated">在<em class="nq">匹配类型中，</em>选择<em class="nq">包含SQL注入攻击</em></li></ul><p id="f11a" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在动作中，保留默认的<em class="nq">块</em>，在<em class="nq">自定义响应</em>中，让我们设置<em class="nq"> 405 —不允许的方法</em>，以迷惑攻击者(尽管在这里设置200可能更有趣:-):</p><figure class="mr ms mt mu gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi ou"><img src="../Images/6f1472f6935417b4178ec8d6762350fe.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*Euk6WRZwnq5y_hbq.png"/></div></div></figure><p id="23c9" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">保存该规则，并使用在<a class="ae kw" href="https://portswigger.net/web-security/sql-injection" rel="noopener ugc nofollow" target="_blank">中搜索的请求<code class="fe nz oa ob mw b">products?category=Gifts'--</code>查看此处的</a>:</p><pre class="mr ms mt mu gt mv mw mx my aw mz bi"><span id="581d" class="na lm iq mw b gy nb nc l nd ne">$ curl -I “http://testapp.dev.example.com/products?category=Gifts'--"<br/>HTTP/1.1 405 Not Allowed</span></pre><p id="5eb5" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">耶！我们已经阻止了SQL注入对我们应用程序的尝试！</p><h2 id="a95a" class="na lm iq bd ln nf ng dn lr nh ni dp lv kj nj nk lz kn nl nm md kr nn no mh np bi translated">托管规则组</h2><p id="94c3" class="pw-post-body-paragraph jy jz iq ka b kb mj kd ke kf mk kh ki kj mo kl km kn mp kp kq kr mq kt ku kv ij bi translated">让我们看看AWS及其合作伙伴建议在他们现有的规则中使用什么。</p><p id="882d" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">选择了<em class="nq">添加托管规则组</em>:</p><figure class="mr ms mt mu gt jr gh gi paragraph-image"><div class="gh gi ov"><img src="../Images/62da85de7826a4008ea56dc714f9fab6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1006/format:webp/0*oUgd-TpdwoV8qkKx.png"/></div></figure><figure class="mr ms mt mu gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi ow"><img src="../Images/46e2e5793f2f5e76ed2a45dbb5c4ec5c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*puL3F1tI4fDZv3h4.png"/></div></div></figure><p id="063c" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在AWS管理的规则组中，您可以找到来自AWS的规则列表，其余的是可以在AWS市场上购买的付费规则。</p><p id="5654" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">查看文档了解规则描述— <a class="ae kw" href="https://docs.aws.amazon.com/waf/latest/developerguide/aws-managed-rule-groups-list.html" rel="noopener ugc nofollow" target="_blank"> AWS托管规则规则组列表</a>。</p><p id="a0cc" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">例如，<em class="nq">已知错误输入</em>规则将检查请求的<code class="fe nz oa ob mw b">Host</code>报头，如果它包含<em class="nq"> localhost、</em>，那么来自互联网的此类请求将被阻止，因为有效请求不能包含它。</p><p id="ea1e" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">将其添加到ACL中:</p><figure class="mr ms mt mu gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi of"><img src="../Images/5e2666828e69a5b325a57d74a5dc06ad.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*DrQUVujl5TbkyY2-.png"/></div></div></figure><p id="45bf" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">此外，您可以在这里为该组配置默认操作，或者添加一个过滤器以仅选择部分请求:</p><figure class="mr ms mt mu gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi ox"><img src="../Images/fd82124cd88010ad8565382af5996555.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*CXuvtkSNvKDhJRs4.png"/></div></div></figure><p id="b417" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">同样，请注意<em class="nq">容量</em>，因为该组将使用ACL的1500个限制中的全部200个wcu。</p><p id="2ed5" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">保存，检查优先级:</p><figure class="mr ms mt mu gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi oe"><img src="../Images/175f744110265b704a52c62789d2ede5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*IECfry4oDGCaCzOI.png"/></div></div></figure><p id="f68e" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">检查访问:</p><pre class="mr ms mt mu gt mv mw mx my aw mz bi"><span id="a013" class="na lm iq mw b gy nb nc l nd ne">$ curl -I testapp.dev.example.com<br/>HTTP/1.1 200 OK</span></pre><p id="c944" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">并为<code class="fe nz oa ob mw b">Host</code>头- <em class="nq">本地主机</em>添加无效值:</p><pre class="mr ms mt mu gt mv mw mx my aw mz bi"><span id="a119" class="na lm iq mw b gy nb nc l nd ne">$ curl -H “Host: localhost” -I testapp.dev.example.com<br/>HTTP/1.1 403 Forbidden</span></pre><p id="4f67" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">现在被封了。</p><h2 id="bc5e" class="na lm iq bd ln nf ng dn lr nh ni dp lv kj nj nk lz kn nl nm md kr nn no mh np bi translated">规则组和ACL删除</h2><p id="276e" class="pw-post-body-paragraph jy jz iq ka b kb mj kd ke kf mk kh ki kj mo kl km kn mp kp kq kr mq kt ku kv ij bi translated">有一点需要注意:如果一个规则是直接从一个ACL创建的，当这个ACL将被删除时，该规则也将被删除。</p><p id="af8a" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">要永久保存您自己的规则，请使用<em class="nq">规则组</em>:</p><figure class="mr ms mt mu gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi oy"><img src="../Images/d5bd7ea439aa85f3586662f96c1c78c6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*cGWppvf46k534slO.png"/></div></div></figure><p id="8cd1" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">然后，在组中创建您的规则，并将该组附加到您的ACL。</p><h1 id="c82e" class="ll lm iq bd ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi bi translated">AWS晶圆限制</h1><p id="43b7" class="pw-post-body-paragraph jy jz iq ka b kb mj kd ke kf mk kh ki kj mo kl km kn mp kp kq kr mq kt ku kv ij bi translated">查看所有限制— <a class="ae kw" href="https://docs.aws.amazon.com/waf/latest/developerguide/limits.html" rel="noopener ugc nofollow" target="_blank"> AWS晶圆配额</a>。</p><p id="1ba2" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">对我来说，主要是:</p><ul class=""><li id="bf3d" class="kx ky iq ka b kb kc kf kg kj kz kn la kr lb kv lc ld le lf bi translated">每个负载平衡器一个ACL:在规划ACL时要记住这一点。</li><li id="bd61" class="kx ky iq ka b kb lg kf lh kj li kn lj kr lk kv lc ld le lf bi translated">WCU每个ACL的限制:1500，但可以通过技术支持请求增加，但这将影响其成本:</li><li id="d0e2" class="kx ky iq ka b kb lg kf lh kj li kn lj kr lk kv lc ld le lf bi translated">如果您有一个使用0到1，500 WCU的web ACL，那么您的所有请求将按每百万次请求0.60美元收费(正常费率)</li><li id="f167" class="kx ky iq ka b kb lg kf lh kj li kn lj kr lk kv lc ld le lf bi translated">如果您有一个使用1，501到2，000 WCU的web ACL，那么您的所有请求将被收取每百万请求0.80美元的费用</li><li id="b77d" class="kx ky iq ka b kb lg kf lh kj li kn lj kr lk kv lc ld le lf bi translated">如果您有一个使用2，001到2，500 WCU的web ACL，那么您的所有请求将按每百万请求1.00美元收费。</li><li id="b9e9" class="kx ky iq ka b kb lg kf lh kj li kn lj kr lk kv lc ld le lf bi translated">每个帐户的最大IP集:100</li><li id="53ed" class="kx ky iq ka b kb lg kf lh kj li kn lj kr lk kv lc ld le lf bi translated">每秒可通过WAF ACL传递的最大请求数(对于ALB): 25.000</li><li id="5083" class="kx ky iq ka b kb lg kf lh kj li kn lj kr lk kv lc ld le lf bi translated">可以检查的最大正文大小:8 kb</li><li id="7630" class="kx ky iq ka b kb lg kf lh kj li kn lj kr lk kv lc ld le lf bi translated">针对(<code class="fe nz oa ob mw b">AssociateWebACL</code>和<code class="fe nz oa ob mw b">DisassociateWebACL</code>)对AWS的最大API调用:每秒2次</li></ul><h1 id="3860" class="ll lm iq bd ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi bi translated">AWS晶圆监控</h1><p id="4520" class="pw-post-body-paragraph jy jz iq ka b kb mj kd ke kf mk kh ki kj mo kl km kn mp kp kq kr mq kt ku kv ij bi translated">好了，我们已经了解了如何阻止请求，创建了ACL，并进行了测试。所有作品。</p><p id="7090" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">但是监视它的活动是很好的，甚至当事情变得奇怪时发出警报。</p><h2 id="8070" class="na lm iq bd ln nf ng dn lr nh ni dp lv kj nj nk lz kn nl nm md kr nn no mh np bi translated">AWS CloudWatch metrics和Prometheus</h2><p id="c389" class="pw-post-body-paragraph jy jz iq ka b kb mj kd ke kf mk kh ki kj mo kl km kn mp kp kq kr mq kt ku kv ij bi translated">我们可以去的第一个地方是CloudWatch和WAFV2指标:</p><figure class="mr ms mt mu gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi oz"><img src="../Images/d9744c470f6019a66ec060a844405c5e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*2qzebwNixiUmq45U.png"/></div></div></figure><p id="87ac" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在此选择我们的ACL或特定规则:</p><figure class="mr ms mt mu gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi pa"><img src="../Images/e69e39bc212e1962d77cb147ec569a56.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*siuOf6dV-raIdqbf.png"/></div></div></figure><p id="030c" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">这是我们被阻止的请求。</p><p id="9d2e" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">接下来，我们可以用<a class="ae kw" href="https://rtfm.co.ua/prometheus-cloudwatch-exporter-sbor-metrik-iz-aws-i-grafiki-v-grafana/" rel="noopener ugc nofollow" target="_blank"> cloudwatch-exporter </a>将它们收集到Prometheus实例中:</p><pre class="mr ms mt mu gt mv mw mx my aw mz bi"><span id="e0cb" class="na lm iq mw b gy nb nc l nd ne">region: us-east-2<br/><br/>metrics:<br/><br/> - aws_namespace: AWS/WAFV2<br/>   aws_metric_name: BlockedRequests<br/>   aws_dimensions: [Region,Rule,WebACL]</span></pre><p id="3725" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">用SQL注入运行我们的测试请求，或者甚至在循环中运行它:</p><pre class="mr ms mt mu gt mv mw mx my aw mz bi"><span id="be56" class="na lm iq mw b gy nb nc l nd ne">$ while true; do curl -I “http://testapp.dev.example.com/products?category=Gifts'--"; sleep 1; done</span></pre><p id="4942" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">检查普罗米修斯中的图表:</p><figure class="mr ms mt mu gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi pb"><img src="../Images/992871896b21fa5e581fcc21f298284f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*I3U1irb8wwEGSsD1.png"/></div></div></figure><p id="2f5c" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">现在我们也可以在这里看到被阻塞的请求。</p><p id="caaf" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">让我们添加一个测试警报:检查过去5分钟内<code class="fe nz oa ob mw b">aws_wafv2_blocked_requests_sum</code>指标的平均每秒增加量:</p><pre class="mr ms mt mu gt mv mw mx my aw mz bi"><span id="6e42" class="na lm iq mw b gy nb nc l nd ne">- alert: "WAFBlockedRequestsAlert"<br/>  expr: rate(aws_wafv2_blocked_requests_sum{rule!="ALL"}[5m]) &gt; 0<br/>  for: 1s<br/>  labels:<br/>    severity: warning<br/>  annotations:<br/>    summary: "AWS WAF blocked requests detected"<br/>    description: "ACL name: `{{ $labels.web_acl }}`\nRule name: `{{ $labels.rule }}"<br/>    tags: test, aws, security, databases</span></pre><p id="5aff" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">如果它的值将大于零，那么WAF阻止了某人，并且我们将被通知它:</p><figure class="mr ms mt mu gt jr gh gi paragraph-image"><div class="gh gi pc"><img src="../Images/2748f32b828a41b5906d9c0c96671263.png" data-original-src="https://miro.medium.com/v2/resize:fit:1184/format:webp/0*q7o6o4CO-hb3dwWw.png"/></div></figure><h2 id="1ebb" class="na lm iq bd ln nf ng dn lr nh ni dp lv kj nj nk lz kn nl nm md kr nn no mh np bi translated">AWS晶圆日志</h2><p id="b56f" class="pw-post-body-paragraph jy jz iq ka b kb mj kd ke kf mk kh ki kj mo kl km kn mp kp kq kr mq kt ku kv ij bi translated">参见<a class="ae kw" href="https://docs.aws.amazon.com/waf/latest/developerguide/logging.html" rel="noopener ugc nofollow" target="_blank">管理web ACL的日志</a>。</p><p id="5443" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">为了记录WAF活动，我们需要一个AWS S3桶，和一个AWS Kinesis数据消防水管输送流。</p><h2 id="311b" class="na lm iq bd ln nf ng dn lr nh ni dp lv kj nj nk lz kn nl nm md kr nn no mh np bi translated">自动气象站Kinesis数据消防软管传输流</h2><p id="161a" class="pw-post-body-paragraph jy jz iq ka b kb mj kd ke kf mk kh ki kj mo kl km kn mp kp kq kr mq kt ku kv ij bi translated">转到Kinesis，创建一个新的数据消防站流:</p><figure class="mr ms mt mu gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi pd"><img src="../Images/ab31e4bdbbdeb4fef0186bbb119bdd95.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*2AhURpXRLOpsmOIi.png"/></div></div></figure><p id="f7a8" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">其名称必须以<em class="nq"> aws-waf-logs- </em>前缀开头，还要设置<em class="nq">直放或其他来源</em>，点击<em class="nq">下一个</em>:</p><figure class="mr ms mt mu gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi pe"><img src="../Images/b31822e6e4019730637dbfbbafb654e6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*X_FoyXHvbYvVxGOr.png"/></div></div></figure><p id="f461" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">跳过下一页上的所有内容，在下一页上为<em class="nq">目的地</em>选择S3，选择现有的，或者创建一个新的S3桶:</p><figure class="mr ms mt mu gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi pf"><img src="../Images/5c48e3317393719b59df0ce63761331e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*s37TeNneuXkyhopm.png"/></div></div></figure><figure class="mr ms mt mu gt jr gh gi paragraph-image"><div class="gh gi pg"><img src="../Images/30a70fc15921c8c74e705ce5e5a5b6d6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1230/format:webp/0*f-tTHduelwUI0dXH.png"/></div></figure><p id="5b66" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在这里，您还可以设置一个前缀，将来自不同ACL的日志保存在同一个S3存储桶中:</p><figure class="mr ms mt mu gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi ph"><img src="../Images/f1b91c42426d01b079273ea98011a180.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*DpCJbpKmYOEX8jNu.png"/></div></div></figure><p id="80e5" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在下一页上，目前可以保留默认值:</p><figure class="mr ms mt mu gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi pi"><img src="../Images/ccdf2b546eec5bfaf9c449642751abb8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*D9mILb0yNb-pBDYs.png"/></div></div></figure><p id="8f44" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">检查设置并点击<em class="nq">创建交付流</em>:</p><figure class="mr ms mt mu gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi ph"><img src="../Images/a8a7c41ccdb342a9005c5cbb40d4d0a6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*9nrZmEYIS0AM2PfX.png"/></div></div></figure><h2 id="d788" class="na lm iq bd ln nf ng dn lr nh ni dp lv kj nj nk lz kn nl nm md kr nn no mh np bi translated">WAF ACL记录</h2><p id="f46d" class="pw-post-body-paragraph jy jz iq ka b kb mj kd ke kf mk kh ki kj mo kl km kn mp kp kq kr mq kt ku kv ij bi translated">回到WAF ACL的<em class="nq">记录和指标</em>选项卡，点击<em class="nq">启用记录</em>:</p><figure class="mr ms mt mu gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi pj"><img src="../Images/1fa791effdd7a23f009e76534a08023e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*kmr_rxSK58zM6yAj.png"/></div></div></figure><p id="a190" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">选择您在上面创建的流，可以选择为字段配置过滤器:</p><figure class="mr ms mt mu gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi pk"><img src="../Images/543c0d02090071f1b7f751a05753baaa.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*Ms-8RRmeQrSpUsS6.png"/></div></div></figure><p id="2086" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">等待5-10分钟，您的日志将被发送到存储桶:</p><figure class="mr ms mt mu gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi pl"><img src="../Images/074d0aa56f2fc6d43ebeb2ff0707ac96.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*VOAFSmG5MRs54DZ5.png"/></div></div></figure><p id="bf8a" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">及其内容:</p><pre class="mr ms mt mu gt mv mw mx my aw mz bi"><span id="382a" class="na lm iq mw b gy nb nc l nd ne">$ tail -5 aws-waf-logs-test-stream-1–2021–07–16–08–19–20-d9c8f13e-2ffb-41e5–84d4–7e771d60f8e6<br/>{“timestamp”:1626423836381,”formatVersion”:1,”webaclId”:”arn:aws:wafv2:us-east-2:534***385:regional/webacl/test-acl/36d796cd-4767–45b3–9f03–711f6ac4ca08",”terminatingRuleId”:”test-sqli”,”terminatingRuleType”:”REGULAR”,”action”:”BLOCK”,”terminatingRuleMatchDetails”:[{“conditionType”:”SQL_INJECTION”,”location”:”QUERY_STRING”,”matchedData”:[“category=Gifts”,” — “]}],”httpSourceName”:”ALB”,”httpSourceId”:”534***385-app/k8s-testname-testingr-ce71203b0d/ca9edcc886933ca9",”ruleGroupList”:[{“ruleGroupId”:”AWS#AWSManagedRulesKnownBadInputsRuleSet”,”terminatingRule”:null,”nonTerminatingMatchingRules”:[],”excludedRules”:null}],”rateBasedRuleList”:[],”nonTerminatingMatchingRules”:[],”requestHeadersInserted”:null,”responseCodeSent”:405,”httpRequest”:{“clientIp”:”194.***.***.29",”country”:”UA”,”headers”:[{“name”:”Host”,”value”:”testapp.dev.example.com”},{“name”:”User-Agent”,”value”:”curl/7.77.0"},{“name”:”Accept”,”value”:”*/*”}],”uri”:”/products”,”args”:”category=Gifts’ — “,”httpVersion”:”HTTP/1.1",”httpMethod”:”HEAD”,”requestId”:”1–60f1421c-1ab92f9f5bc7be7f39a70c08"}}</span></pre><p id="5b49" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">现在，您可以将它们收集到Logz.io之类的服务中，参见<a class="ae kw" href="https://app.logz.io/#/dashboard/send-your-data/log-sources/s3-bucket" rel="noopener ugc nofollow" target="_blank">配置Logz.io以从S3桶中获取日志</a>。</p><p id="558a" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">尚不支持CloudWatch Logs，但计划会添加。</p><h1 id="3994" class="ll lm iq bd ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi bi translated">AWS ALB、Kubernetes Ingress和AWS WAF</h1><p id="4608" class="pw-post-body-paragraph jy jz iq ka b kb mj kd ke kf mk kh ki kj mo kl km kn mp kp kq kr mq kt ku kv ij bi translated">因此，我们有一个ACL:</p><figure class="mr ms mt mu gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi pm"><img src="../Images/900493f17a1941838f693fa92b229efd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*V7ROBSYqtL3KsezE.png"/></div></div></figure><p id="df76" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我们需要将这个ACL附加到一个ALB，它是用<a class="ae kw" href="https://rtfm.co.ua/aws-migraciya-aws-alb-ingress-controller-v1-na-aws-load-balancer-controller-v2/" rel="noopener ugc nofollow" target="_blank"> AWS负载平衡器控制器</a>从Kubernetes入口创建的。</p><p id="5a66" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">为此，我们可以使用它的<code class="fe nz oa ob mw b"><a class="ae kw" href="https://kubernetes-sigs.github.io/aws-load-balancer-controller/v2.1/guide/ingress/annotations/#wafv2-acl-arn" rel="noopener ugc nofollow" target="_blank">alb.ingress.kubernetes.io/wafv2-acl-arn</a></code>。</p><p id="095c" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">为您的ACL启用ARNs显示:</p><figure class="mr ms mt mu gt jr gh gi paragraph-image"><div class="gh gi pn"><img src="../Images/3fbff4baac209ea95be4caad97ea3969.png" data-original-src="https://miro.medium.com/v2/resize:fit:1110/format:webp/0*vxM9gfomlr8bBzUr.png"/></div></figure><figure class="mr ms mt mu gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nw"><img src="../Images/38c4eb7a3e74f43aa7e28cb0d4f2ad9c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*WD5vgLoCmXX6hV_c.png"/></div></div></figure><figure class="mr ms mt mu gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi pm"><img src="../Images/a953755d0aec7b806fcaafbb855684eb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*ToMNXYOI60AonulS.png"/></div></div></figure><p id="6e47" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">更新您的入口:</p><pre class="mr ms mt mu gt mv mw mx my aw mz bi"><span id="ff8b" class="na lm iq mw b gy nb nc l nd ne">apiVersion: extensions/v1beta1<br/>kind: Ingress<br/>metadata:<br/>  name: test-ingress<br/>  namespace: test-namespace<br/>  annotations:<br/>    kubernetes.io/ingress.class: alb<br/>    alb.ingress.kubernetes.io/scheme: internet-facing<br/>    alb.ingress.kubernetes.io/listen-ports: '[{"HTTP": 80}]'<br/>    alb.ingress.kubernetes.io/inbound-cidrs: 0.0.0.0/0<br/>    alb.ingress.kubernetes.io/wafv2-acl-arn: "arn:aws:wafv2:us-east-2:534***385:regional/webacl/test-acl/36d796cd-4767-45b3-9f03-711f6ac4ca08"<br/>...</span></pre><p id="c063" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">应用:</p><pre class="mr ms mt mu gt mv mw mx my aw mz bi"><span id="df2b" class="na lm iq mw b gy nb nc l nd ne">$ kubectl apply -f test-deployment.yaml</span></pre><p id="3e15" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">检查ACL — <em class="nq">关联的AWS资源</em>:</p><figure class="mr ms mt mu gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi po"><img src="../Images/ace0909af78b455600ea368fd1e0e8d2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*QGzc4HkvUr-R-LwJ.png"/></div></div></figure><p id="a5fa" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">完成了。</p><h1 id="f878" class="ll lm iq bd ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi bi translated">有用的链接</h1><ul class=""><li id="0c04" class="kx ky iq ka b kb mj kf mk kj ml kn mm kr mn kv lc ld le lf bi translated"><a class="ae kw" href="https://aws.amazon.com/ru/solutions/implementations/aws-waf-security-automations/" rel="noopener ugc nofollow" target="_blank"> AWS晶圆安全自动化</a></li><li id="a1e4" class="kx ky iq ka b kb lg kf lh kj li kn lj kr lk kv lc ld le lf bi translated"><a class="ae kw" href="https://repository.stcloudstate.edu/cgi/viewcontent.cgi?referer=&amp;httpsredir=1&amp;article=1094&amp;context=msia_etds" rel="noopener ugc nofollow" target="_blank">使用AWS WAF防止SQL注入攻击</a></li><li id="a83b" class="kx ky iq ka b kb lg kf lh kj li kn lj kr lk kv lc ld le lf bi translated"><a class="ae kw" href="https://medium.com/@comp87/deep-dive-into-the-aws-web-application-firewall-waf-14148ea0d3d" rel="noopener">深入研究AWS网络应用防火墙(WAF) </a></li><li id="70d0" class="kx ky iq ka b kb lg kf lh kj li kn lj kr lk kv lc ld le lf bi translated"><a class="ae kw" href="https://github.com/amazon-archives/aws-waf-sample" rel="noopener ugc nofollow" target="_blank">AWS WAF规则集示例</a></li><li id="1163" class="kx ky iq ka b kb lg kf lh kj li kn lj kr lk kv lc ld le lf bi translated"><a class="ae kw" href="https://aws.amazon.com/ru/blogs/big-data/analyzing-aws-waf-logs-with-amazon-es-amazon-athena-and-amazon-quicksight/" rel="noopener ugc nofollow" target="_blank">使用Amazon ES、Amazon Athena和Amazon QuickSight分析AWS WAF日志</a></li></ul></div><div class="ab cl pp pq hu pr" role="separator"><span class="ps bw bk pt pu pv"/><span class="ps bw bk pt pu pv"/><span class="ps bw bk pt pu"/></div><div class="ij ik il im in"><p id="fa8b" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><em class="nq">最初发布于</em> <a class="ae kw" href="https://rtfm.co.ua/en/aws-web-application-firewall-overview-configuration-and-its-monitoring/" rel="noopener ugc nofollow" target="_blank"> <em class="nq"> RTFM: Linux、DevOps、系统管理</em> </a> <em class="nq">。</em></p></div></div>    
</body>
</html>