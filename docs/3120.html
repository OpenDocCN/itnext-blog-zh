<html>
<head>
<title>Capturing Metrics with Go’s Reverse Proxy</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用Go的反向代理捕捉指标</h1>
<blockquote>原文：<a href="https://itnext.io/capturing-metrics-with-gos-reverse-proxy-5c36cb20cb20?source=collection_archive---------5-----------------------#2019-10-07">https://itnext.io/capturing-metrics-with-gos-reverse-proxy-5c36cb20cb20?source=collection_archive---------5-----------------------#2019-10-07</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><figure class="gl gn jr js jt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi jq"><img src="../Images/b4530cebc85cfc68d0bbcedbdab14e28.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*4psnS3cx9NHgBnUQQZHkHA.png"/></div></div></figure><p id="a83a" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">我不得不从我无法直接访问的服务中获取指标。go标准库附带了一个反向代理实现🤯。通过将客户端请求代理到服务，我能够在不修改服务本身的情况下捕获指标。</p><h1 id="11f4" class="kz la it bd lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw bi translated">什么是反向代理？</h1><blockquote class="lx ly lz"><p id="6d6d" class="kb kc ma kd b ke kf kg kh ki kj kk kl mb kn ko kp mc kr ks kt md kv kw kx ky im bi translated"><em class="it">“在</em> <a class="ae me" href="https://en.wikipedia.org/wiki/Computer_network" rel="noopener ugc nofollow" target="_blank"> <em class="it">计算机网络</em> </a> <em class="it">中，反向代理是一种</em> <a class="ae me" href="https://en.wikipedia.org/wiki/Proxy_server" rel="noopener ugc nofollow" target="_blank"> <em class="it">代理服务器</em> </a> <em class="it">，代表客户端从一个或多个服务器检索资源。然后，这些资源被返回给客户端，就好像它们来自代理服务器本身一样。”</em></p><p id="da91" class="kb kc ma kd b ke kf kg kh ki kj kk kl mb kn ko kp mc kr ks kt md kv kw kx ky im bi translated"><em class="it">来自</em> <a class="ae me" href="https://en.wikipedia.org/wiki/Reverse_proxy" rel="noopener ugc nofollow" target="_blank"> <em class="it">维基百科</em> </a></p></blockquote><p id="47b6" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">本质上，反向代理将流量从客户端转发到代理后面的一组服务器。反向代理有许多应用。负载平衡、TLS终止和A/B测试只是其中的一部分。反向代理对于在HTTP服务周围插入工具也很有用，而不必修改服务本身。</p><figure class="mg mh mi mj gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi mf"><img src="../Images/4a1410d1bc180cfbabfc0851e56b1a5d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*D0jBcZaMmpUhskenZAmdwQ.png"/></div></div><figcaption class="mk ml gj gh gi mm mn bd b be z dk translated">反向代理网络图</figcaption></figure><p id="cdf9" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">如果你想了解更多关于代理的知识，我推荐你去看看马特·克莱恩的<a class="ae me" href="https://blog.envoyproxy.io/introduction-to-modern-network-load-balancing-and-proxying-a57f6ff80236" rel="noopener ugc nofollow" target="_blank">现代网络负载平衡和代理介绍</a>。Matt是<a class="ae me" href="https://www.envoyproxy.io/" rel="noopener ugc nofollow" target="_blank"> Envoy Proxy </a>的创建者，这是一个健壮的代理服务器，支持像<a class="ae me" href="https://istio.io/" rel="noopener ugc nofollow" target="_blank"> Istio </a>这样的服务网格工具。他的文章很好地概括了现代负载平衡器和代理所使用的方法。</p><h1 id="aec1" class="kz la it bd lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw bi translated">简单Go反向代理</h1><p id="2a94" class="pw-post-body-paragraph kb kc it kd b ke mo kg kh ki mp kk kl km mq ko kp kq mr ks kt ku ms kw kx ky im bi translated">出于很多原因，Go是我最喜欢的编程语言之一。该语言的设计者关注简单性、实用性和性能。这些考虑使Go成为一种乐趣。这种语言闪耀着网络任务的光芒。部分原因是难以置信的全面的标准库，在其他常见的实现中包括一个反向代理。</p><p id="d410" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">在go中滚动自己的代理就像</p><figure class="mg mh mi mj gt ju"><div class="bz fp l di"><div class="mt mu l"/></div></figure><p id="d851" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">对，就是这样。我们在这里挖吧。<a class="ae me" href="https://golang.org/pkg/net/http/httputil/#NewSingleHostReverseProxy" rel="noopener ugc nofollow" target="_blank"> <em class="ma"> httputil。newsinglehosterverseproxy</em></a>方法返回一个包含以下方法的<a class="ae me" href="https://golang.org/pkg/net/http/httputil/#ReverseProxy" rel="noopener ugc nofollow" target="_blank"> <em class="ma"> ReverseProxy </em> </a>结构。</p><figure class="mg mh mi mj gt ju"><div class="bz fp l di"><div class="mt mu l"/></div></figure><p id="0b7f" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">我们需要做的就是配置代理，并将其连接到一个标准的go HTTP服务器，以获得一个工作的反向代理，如下所示。</p><figure class="mg mh mi mj gt ju"><div class="bz fp l di"><div class="mt mu l"/></div></figure><p id="14b7" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">就是这样！该服务器可以代理HTTP请求和web套接字连接。您会注意到我已经配置了<em class="ma">代理。导演</em>场。<em class="ma">反向推进。Director </em>是一个功能，它在转发传入的请求之前对其进行修改。签名如下:</p><figure class="mg mh mi mj gt ju"><div class="bz fp l di"><div class="mt mu l"/></div></figure><p id="dd35" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">director函数的一个常见用例是修改请求头。Go编程语言的一个原则是，类型应该有合理的默认值，并且可以立即使用。遵循这个原则，默认的director实现由<em class="ma"> httputil返回。newsinglehosterverseproxy</em>负责设置请求方案、主机和路径。我不想复制代码，所以我包装了这个实现。<strong class="kd iu">注意</strong>:我必须重置<em class="ma">请求。处理HTTPS端点的主机</em>字段。我还包含了一个通过<a class="ae me" href="https://golang.org/pkg/net/http/#Header.Set" rel="noopener ugc nofollow" target="_blank"> <em class="ma"> req设置请求头的例子。设置</em> </a>，它将使用传递给方法的值覆盖头值。</p><h1 id="5428" class="kz la it bd lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw bi translated">捕获指标</h1><p id="4d6e" class="pw-post-body-paragraph kb kc it kd b ke mo kg kh ki mp kk kl km mq ko kp kq mr ks kt ku ms kw kx ky im bi translated">让我们扩展我们的简单代理来读取和报告关于下游服务响应的指标。为此，我们将返回到<em class="ma"> httputil。再次反转Proxy </em>结构。它公开了一个结构字段<em class="ma"> ReverseProxy。ModifyResponse </em>,它让我们在HTTP响应返回客户端之前访问它。</p><figure class="mg mh mi mj gt ju"><div class="bz fp l di"><div class="mt mu l"/></div></figure><p id="6933" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">Go将HTTP主体实现为<em class="ma"> io。读者的，因此，你只能读一遍。如果您希望在转发请求或响应之前对其进行解析，您需要将主体复制到字节缓冲区中，并重置主体。一个明显的缺点是我们在内存中无限制地缓冲整个响应。如果您收到大量响应，这可能会导致生产中的内存问题，但对于我的用例来说，这不是问题。这里有一个解析和重置响应体的快速实现。</em></p><figure class="mg mh mi mj gt ju"><div class="bz fp l di"><div class="mt mu l"/></div></figure><p id="ec75" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">随着请求体问题的解决，获取度量就变得简单了。</p><figure class="mg mh mi mj gt ju"><div class="bz fp l di"><div class="mt mu l"/></div></figure><p id="a111" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">就是这样！capture metrics函数对于我的用例来说非常具体，所以我将把它留给您来实现。我代理了一个通过HTTP端点可用的深度学习模型。我最终使用了<a class="ae me" href="https://github.com/prometheus/client_golang" rel="noopener ugc nofollow" target="_blank"> Prometheus客户端</a>库来从模型中导出关于预测类标签的度量。</p><p id="24d6" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">指标捕获代理的完整代码如下</p><figure class="mg mh mi mj gt ju"><div class="bz fp l di"><div class="mt mu l"/></div></figure><p id="6dc8" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">Go的标准库完成了所有繁重的工作。从这里开始，您可以将代理扩展到任意数量的用例。</p><p id="467b" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">如果你觉得这有用，请在下面留下评论。</p></div><div class="ab cl mv mw hx mx" role="separator"><span class="my bw bk mz na nb"/><span class="my bw bk mz na nb"/><span class="my bw bk mz na"/></div><div class="im in io ip iq"><p id="529f" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated"><em class="ma">原载于</em> <a class="ae me" href="https://www.sidneyw.com/go-reverse-proxy/" rel="noopener ugc nofollow" target="_blank"> <em class="ma">我的博客</em> </a> <em class="ma">。</em></p></div></div>    
</body>
</html>