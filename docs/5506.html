<html>
<head>
<title>Automated HA Kubernetes deployment on RockPis</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">RockPis上的自动化HA Kubernetes部署</h1>
<blockquote>原文：<a href="https://itnext.io/automated-ha-kubernetes-deployment-on-rock-pis-d56af4d086ae?source=collection_archive---------3-----------------------#2021-03-19">https://itnext.io/automated-ha-kubernetes-deployment-on-rock-pis-d56af4d086ae?source=collection_archive---------3-----------------------#2021-03-19</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="e394" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">了解如何在Rock Pis上创建HA Kubernetes集群。</p><div class="kl km kn ko gt ab cb"><figure class="kp kq kr ks kt ku kv paragraph-image"><div role="button" tabindex="0" class="kw kx di ky bf kz"><img src="../Images/5555d09dd08ca23e6125196f44764443.png" data-original-src="https://miro.medium.com/v2/resize:fit:668/format:webp/1*QK_g6Rw8u6Wi4TrC8-hHpw.jpeg"/></div></figure><figure class="kp kq kr ks kt ku kv paragraph-image"><div role="button" tabindex="0" class="kw kx di ky bf kz"><img src="../Images/ba4f32c6b9edf6ba87e41aa577ece2f4.png" data-original-src="https://miro.medium.com/v2/resize:fit:668/format:webp/1*vmBNy0pe3WprAcBtVhejRA.jpeg"/></div></figure><figure class="kp kq kr ks kt ku kv paragraph-image"><div role="button" tabindex="0" class="kw kx di ky bf kz"><img src="../Images/2b346026a6017f8149f896c63db95293.png" data-original-src="https://miro.medium.com/v2/resize:fit:668/format:webp/1*Aq_7DXYw0WYikfwHQEWI-w.jpeg"/></div></figure></div><div class="ab cb"><figure class="kp kq lc ks kt ku kv paragraph-image"><div role="button" tabindex="0" class="kw kx di ky bf kz"><img src="../Images/b8fe4160073aa09ea6385a81df5a2770.png" data-original-src="https://miro.medium.com/v2/resize:fit:440/format:webp/1*vGlgZCICN45XwIMAbkO-Dw.jpeg"/></div></figure><figure class="kp kq ld ks kt ku kv paragraph-image"><div role="button" tabindex="0" class="kw kx di ky bf kz"><img src="../Images/e835f5faf1f575d9300c9462cc4d3888.png" data-original-src="https://miro.medium.com/v2/resize:fit:782/format:webp/1*VoaWEUXJmFxnWX223kf-uA.jpeg"/></div></figure><figure class="kp kq ld ks kt ku kv paragraph-image"><div role="button" tabindex="0" class="kw kx di ky bf kz"><img src="../Images/b6097f5b39286a880da56306d31f4f5f.png" data-original-src="https://miro.medium.com/v2/resize:fit:782/format:webp/1*k9U8LlG9EvOqrkPBmacagQ.jpeg"/></div></figure></div><h1 id="72e5" class="le lf iq bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">先决条件</h1><p id="c614" class="pw-post-body-paragraph jn jo iq jp b jq mc js jt ju md jw jx jy me ka kb kc mf ke kf kg mg ki kj kk ij bi translated">建议至少有4个岩石Pis。本指南使用3个作为主节点，其余的作为工作节点。您可以添加更多的Rock Pis来创建额外的主节点或工作节点。</p><p id="03ed" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">安装以下CLI工具，以便能够遵循本指南中的步骤:</p><ul class=""><li id="da98" class="mh mi iq jp b jq jr ju jv jy mj kc mk kg ml kk mm mn mo mp bi translated"><a class="ae mq" href="https://docs.ansible.com/ansible/latest/installation_guide/intro_installation.html" rel="noopener ugc nofollow" target="_blank"> Ansible </a></li><li id="40f7" class="mh mi iq jp b jq mr ju ms jy mt kc mu kg mv kk mm mn mo mp bi translated"><a class="ae mq" href="https://kubernetes.io/docs/tasks/tools/install-kubectl/" rel="noopener ugc nofollow" target="_blank">库贝克特尔</a></li></ul><h1 id="2874" class="le lf iq bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">闪存操作系统</h1><p id="62d8" class="pw-post-body-paragraph jn jo iq jp b jq mc js jt ju md jw jx jy me ka kb kc mf ke kf kg mg ki kj kk ij bi translated">从<a class="ae mq" href="https://wiki.radxa.com/Rockpi4/downloads" rel="noopener ugc nofollow" target="_blank">下载</a>的flash工具etcher。为您的主机操作系统选择正确的版本。</p><p id="3d66" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">从可用的<a class="ae mq" href="https://wiki.radxa.com/Rockpi4/downloads" rel="noopener ugc nofollow" target="_blank">列表</a>中找到并下载您的首选操作系统，并使用etcher将您下载的操作系统刷新到您的microSD/eMMC/SSD。</p><p id="c348" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">可以在<a class="ae mq" href="https://wiki.radxa.com/Rockpi4/getting_started" rel="noopener ugc nofollow" target="_blank">入门</a>中找到刷新设备的说明。</p><h1 id="ffb0" class="le lf iq bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">准备</h1><p id="de7f" class="pw-post-body-paragraph jn jo iq jp b jq mc js jt ju md jw jx jy me ka kb kc mf ke kf kg mg ki kj kk ij bi translated">在我们可以使用Ansible引导Kubernetes之前，我们需要做一些小的更改——目前，这是手动的——但是，它确实需要在引导后在每个设备中完成。</p><ol class=""><li id="fe12" class="mh mi iq jp b jq jr ju jv jy mj kc mk kg ml kk mw mn mo mp bi translated">设备的SSH</li><li id="643a" class="mh mi iq jp b jq mr ju ms jy mt kc mu kg mv kk mw mn mo mp bi translated">安装所需的软件包:</li></ol><pre class="kl km kn ko gt mx my mz na aw nb bi"><span id="f49f" class="nc lf iq my b gy nd ne l nf ng">sudo apt-get update<br/>sudo apt-get install -y wget</span></pre><p id="d2c8" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><em class="nh">注意:您可能会看到一些无法验证的签名错误，这是意料之中的，也正是此操作将解决的问题。</em></p><p id="c804" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">3.使用vim或nano编辑<code class="fe ni nj nk my b">/etc/apt/sources.list.d/apt-radxa-com.list</code>,如下所示:</p><pre class="kl km kn ko gt mx my mz na aw nb bi"><span id="6437" class="nc lf iq my b gy nd ne l nf ng">deb <a class="ae mq" href="http://apt.radxa.com/buster-stable/" rel="noopener ugc nofollow" target="_blank">http://apt.radxa.com/buster-stable/</a> buster main<br/>deb <a class="ae mq" href="http://apt.radxa.com/buster-testing/" rel="noopener ugc nofollow" target="_blank">http://apt.radxa.com/buster-testing/</a> buster main</span></pre><p id="c4f7" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">4.执行以下命令:</p><pre class="kl km kn ko gt mx my mz na aw nb bi"><span id="9772" class="nc lf iq my b gy nd ne l nf ng">wget -O - apt.radxa.com/buster-testing/public.key|sudo apt-key add -<br/>wget -O - apt.radxa.com/buster-stable/public.key|sudo apt-key add -</span></pre><p id="e1ef" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">确保在每台设备上重复此操作！！</p><h1 id="817f" class="le lf iq bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">设置Kubernetes集群</h1><p id="c75c" class="pw-post-body-paragraph jn jo iq jp b jq mc js jt ju md jw jx jy me ka kb kc mf ke kf kg mg ki kj kk ij bi translated">现在我们已经运行了所有的Rock Pi节点，您现在需要更新Ansible <a class="ae mq" href="https://github.com/raspbernetes/k8s-cluster-installation/blob/master/ansible/inventory" rel="noopener ugc nofollow" target="_blank"> inventory </a>文件中的值。</p><p id="6b1d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">下面是我如何配置3个主节点和1个工作节点的例子。本例中的<strong class="jp ir"> ansible_user </strong>和<strong class="jp ir"> ansible_ssh_pass </strong>的值只有默认的Rock Pi ssh凭证。</p><pre class="kl km kn ko gt mx my mz na aw nb bi"><span id="5eec" class="nc lf iq my b gy nd ne l nf ng">[cluster:children]<br/>masters<br/>workers</span><span id="c470" class="nc lf iq my b gy nl ne l nf ng">[k8s:children]<br/>masters<br/>workers</span><span id="b69c" class="nc lf iq my b gy nl ne l nf ng">[masters]<br/>k8s-master-01 hostname=k8s-master-01 ansible_host=192.168.1.111 ansible_user=rock ansible_ssh_pass=rock</span><span id="a633" class="nc lf iq my b gy nl ne l nf ng">k8s-master-02 hostname=k8s-master-02 ansible_host=192.168.1.112 ansible_user=rock ansible_ssh_pass=rock</span><span id="5f47" class="nc lf iq my b gy nl ne l nf ng">k8s-master-03 hostname=k8s-master-03 ansible_host=192.168.1.113 ansible_user=rock ansible_ssh_pass=rock</span><span id="b253" class="nc lf iq my b gy nl ne l nf ng">[workers]<br/>k8s-worker-01 hostname=k8s-worker-01 ansible_host=192.168.1.114 ansible_user=rock ansible_ssh_pass=rock</span><span id="166c" class="nc lf iq my b gy nl ne l nf ng">k8s-worker-02 hostname=k8s-worker-02 ansible_host=192.168.1.116 ansible_user=rock ansible_ssh_pass=rock</span><span id="6a97" class="nc lf iq my b gy nl ne l nf ng">k8s-worker-03 hostname=k8s-worker-03 ansible_host=192.168.1.117 ansible_user=rock ansible_ssh_pass=rock</span></pre><p id="d1c4" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">为所有主机配置清单后，我们还必须配置最后一件事。我们需要分配一个VIP(“虚拟IP”)，用于跨HA主节点进行负载平衡。</p><p id="0b1d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">打开<a class="ae mq" href="https://github.com/raspbernetes/k8s-cluster-installation/blob/master/ansible/group_vars/masters.yml" rel="noopener ugc nofollow" target="_blank"> masters.yml </a>，将<code class="fe ni nj nk my b">keepalived_vip</code>值配置为一个未分配的IP。对于我的配置，我使用<code class="fe ni nj nk my b">192.168.1.200</code>。</p><p id="266d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">运行以下命令来验证SSH连接。</p><pre class="kl km kn ko gt mx my mz na aw nb bi"><span id="0560" class="nc lf iq my b gy nd ne l nf ng">env ANSIBLE_CONFIG=ansible/ansible.cfg ansible all -m ping</span></pre><p id="2dd5" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">成功的响应应该如下所示:</p><pre class="kl km kn ko gt mx my mz na aw nb bi"><span id="d5b5" class="nc lf iq my b gy nd ne l nf ng">k8s-master-01 | SUCCESS =&gt; {<br/>...<br/>"ping": "pong"<br/>...<br/>}</span></pre><p id="6149" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><em class="nh">注意:如果每次ping的输出都返回成功，那么您可以继续，否则可能会出现库存文件配置错误或网络连接问题。</em></p><p id="f17c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在我们已经测试了网络连接，我们可以运行自动化脚本，这些脚本将负责使用以下内容部署Kubernetes:</p><pre class="kl km kn ko gt mx my mz na aw nb bi"><span id="833f" class="nc lf iq my b gy nd ne l nf ng">env ANSIBLE_CONFIG=ansible/ansible.cfg ansible-playbook \<br/>  --extra-vars "ansible_become_pass=rock" \<br/>  ansible/playbooks/all.yml</span></pre><p id="0af2" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">成功完成后，您可以使用<code class="fe ni nj nk my b">kubectl</code>与您的Kubernetes集群互动:</p><pre class="kl km kn ko gt mx my mz na aw nb bi"><span id="29de" class="nc lf iq my b gy nd ne l nf ng">kubectl get nodes --kubeconfig ansible/playbooks/output/k8s-config.yaml</span></pre><p id="8516" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">预期的输出应该如下所示:</p><pre class="kl km kn ko gt mx my mz na aw nb bi"><span id="3ee3" class="nc lf iq my b gy nd ne l nf ng">NAME            STATUS   ROLES                  AGE     VERSION<br/>k8s-master-01   Ready    control-plane,master   3h45m   v1.20.2<br/>k8s-master-02   Ready    control-plane,master   3h44m   v1.20.2<br/>k8s-master-03   Ready    control-plane,master   3h44m   v1.20.2<br/>k8s-worker-01   Ready    &lt;none&gt;                 3h44m   v1.20.2</span></pre><p id="9636" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">恭喜</strong>！现在，您已经有了一个在Rock Pis上运行的Kubernetes集群。</p></div></div>    
</body>
</html>