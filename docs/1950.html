<html>
<head>
<title>Upgrading Kubernetes Cluster with Kops, and Things to Watch Out For</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Kops升级Kubernetes集群，以及需要注意的事项</h1>
<blockquote>原文：<a href="https://itnext.io/upgrading-kubernetes-cluster-with-kops-and-things-to-watch-out-for-8b5e7dff71c0?source=collection_archive---------6-----------------------#2019-02-28">https://itnext.io/upgrading-kubernetes-cluster-with-kops-and-things-to-watch-out-for-8b5e7dff71c0?source=collection_archive---------6-----------------------#2019-02-28</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/a2b859667a2957df85b3ddf578c4d157.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*5BUo9SV9idWAKP85w8L3Eg.png"/></div></div></figure><p id="9652" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">好吧！我想为一年多来的无所作为道歉。非常尴尬的是，我完全放弃了这个好习惯。不管怎样，今天我想分享一个不太高级也很简短的关于如何用kops升级Kubernetes的演练。</p><p id="f5b8" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在Buffer，自从我们在<a class="ae kw" href="https://aws.amazon.com/eks/" rel="noopener ugc nofollow" target="_blank"> AWS EKS </a>之前开始我们的旅程以来，我们在AWS EC2实例上托管我们自己的k8s(简称Kubernetes)集群。为了有效地做到这一点，我们使用<a class="ae kw" href="https://github.com/kubernetes/kops" rel="noopener ugc nofollow" target="_blank"> kops </a>。这是一个非常棒的工具，可以管理集群管理的几乎所有方面，从创建、升级、更新到删除。它从未让我们失望。</p><h1 id="0b62" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">如何开始？</h1><p id="6de8" class="pw-post-body-paragraph jy jz iq ka b kb lv kd ke kf lw kh ki kj lx kl km kn ly kp kq kr lz kt ku kv ij bi translated">好吧，升级集群总是让人紧张，尤其是生产集群。相信我，我也经历过！有句话叫，<strong class="ka ir">希望不是策略</strong>。因此，我并不希望事情进展顺利，相反，我总是有偏见，如果你跳过测试，事情就会变得糟糕。另外，祝你好运，向人们解释集群现在停机是因为有人决定尝试一下，看看会发生什么。</p><p id="18a1" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">那我们该怎么办？</p><p id="b161" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">简单！我们在运行生产集群的版本中创建一个新的集群，添加一个基本的测试web应用程序，并在升级期间向它发送流量，以确保服务不会中断。让我试着为你更详细地分解这些步骤。</p><ul class=""><li id="04cb" class="ma mb iq ka b kb kc kf kg kj mc kn md kr me kv mf mg mh mi bi translated">升级会中断任何正在运行的应用程序吗</li><li id="2d5f" class="ma mb iq ka b kb mj kf mk kj ml kn mm kr mn kv mf mg mh mi bi translated">新版本能很好地与现有的EC2实例类型兼容吗</li></ul><p id="9103" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">(有些情况下，使用新的AWS AMI的升级版本不能与特定的实例类型一起工作，导致集群范围的暂停，并且无法创建容器)</p><ul class=""><li id="c8a4" class="ma mb iq ka b kb kc kf kg kj mc kn md kr me kv mf mg mh mi bi translated">从我们正在升级的版本<code class="fe mo mp mq mr b">from</code>和<code class="fe mo mp mq mr b">to</code>来看，基础服务还能顺利工作吗？</li><li id="b606" class="ma mb iq ka b kb mj kf mk kj ml kn mm kr mn kv mf mg mh mi bi translated">我们研究关键的网络组件，如<code class="fe mo mp mq mr b">flannel</code>和<code class="fe mo mp mq mr b">kube-dns</code>。如果我们发现任何问题，我们应该后退一步，全面调查任何问题。</li></ul><h1 id="c01b" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">创建新的测试集群</h1><p id="25ba" class="pw-post-body-paragraph jy jz iq ka b kb lv kd ke kf lw kh ki kj lx kl km kn ly kp kq kr lz kt ku kv ij bi translated">在AWS上用kops创建一个集群最初有点棘手，因为必须创建一些关键的AWS资源。这里是关于如何做的指南。你只需要做一次，永远。之后，创建一个集群就像使用这个命令一样简单</p><pre class="ms mt mu mv gt mw mr mx my aw mz bi"><span id="bb17" class="na ky iq mr b gy nb nc l nd ne">kops create cluster \ <br/>--name steven.k8s.com \ <br/>--cloud aws \ <br/>--master-size m4.large \ <br/>--master-zones=us-east-1b,us-east-1c,us-east-1d \ <br/>--node-size m4.xlarge \ <br/>--zones=us-east-1a,us-east-1b,us-east-1c,us-east-1d,us-east-1e,us-east-1f \ <br/>--node-count=3 \ <br/>--kubernetes-version=1.11.6 \ <br/>--vpc=vpc-1234567 \ <br/>--network-cidr=10.0.0.0/16 \ <br/>--networking=flannel \ <br/>--authorization=RBAC \ <br/>--ssh-public-key="~/.ssh/kube_aws_rsa.pub" \ <br/>--yes</span></pre><p id="0e90" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">需要注意的是，我们正在尝试将生产集群升级到新版本，因此我们希望测试集群尽可能靠近生产集群。请确保<code class="fe mo mp mq mr b">--kubernetes-version</code>是当前的生产版本，并在<code class="fe mo mp mq mr b">--networking</code>中使用相同的覆盖网络。保持实例类型不变以避免任何兼容性问题也是很好的。我以前对主节点的m5 EC2实例有一些问题。要点是进行模拟升级，就像它是生产集群一样。</p><p id="eb38" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">一旦它被创造出来。向它部署一个基本的web服务。我们将使用它来建立一些基线测试结果。</p><h1 id="2cc0" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">测试服务</h1><p id="7d5f" class="pw-post-body-paragraph jy jz iq ka b kb lv kd ke kf lw kh ki kj lx kl km kn ly kp kq kr lz kt ku kv ij bi translated">在这一步中，我们将希望获得一些基准结果，以更好地确定它在集群升级期间是否受到影响，而不是调整一些参数(稍后将详细介绍)。</p><p id="32df" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">为此我通常使用<a class="ae kw" href="https://httpd.apache.org/docs/2.4/programs/ab.html" rel="noopener ugc nofollow" target="_blank"> Apache基准</a></p><p id="9491" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><code class="fe mo mp mq mr b">ab -n 100000 -c 10 -l http://&lt;URL to the service&gt;</code></p><p id="88a1" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">这将向服务抛出100000个并发数为10的请求。让它运行并将结果复制下来。我们会将它们与集群升级过程中的结果进行比较，以确保没有服务受到影响，这在生产升级过程中至关重要。</p><h1 id="7ef0" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">试运行升级</h1><h1 id="759d" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">集群升级模拟</h1><pre class="ms mt mu mv gt mw mr mx my aw mz bi"><span id="30b5" class="na ky iq mr b gy nb nc l nd ne">kops edit cluster <br/># Update the version number <br/>kops update cluster steven.k8s.com</span></pre><h1 id="3ff2" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">集群升级(无间隔)</h1><pre class="ms mt mu mv gt mw mr mx my aw mz bi"><span id="d65e" class="na ky iq mr b gy nb nc l nd ne">kops update cluster steven.k8s.com --yes <br/>kops rolling-update cluster <br/>kops rolling-update cluster --yes</span></pre><p id="a980" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">发出上述命令后，群集将启动滚动更新过程，每次关闭1个节点。这是我们一直在等待的时刻。我们想知道测试服务在这个过程中是否继续运行。现在，当升级正在进行中，让我们扔一些流量</p><p id="5779" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><code class="fe mo mp mq mr b">ab -n 100000 -c 10 -l http://&lt;URL to the service&gt;</code></p><p id="63a1" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">结果应该与基线结果相似，如果不相似，我们可以考虑添加一个时间间隔，以便在节点创建/终止期间有更多的时间。这肯定有助于减少中断，但会延长整个过程。为了确保稳定性，我很乐意做出这样的权衡。</p><p id="0257" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我们可以使用以下命令来添加时间间隔。</p><h1 id="f04c" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">集群升级(每10分钟一次)</h1><pre class="ms mt mu mv gt mw mr mx my aw mz bi"><span id="0f20" class="na ky iq mr b gy nb nc l nd ne">kops update cluster steven.k8s.com --yes <br/>kops rolling-update cluster <br/>kops rolling-update cluster --master-interval=10m --node interval=10m --yes -v 10</span></pre><h1 id="fd05" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">最终检查</h1><p id="4b4f" class="pw-post-body-paragraph jy jz iq ka b kb lv kd ke kf lw kh ki kj lx kl km kn ly kp kq kr lz kt ku kv ij bi translated">一旦我们确信升级不会影响现有的服务，我们就接近真正的升级了。这只是一个小清单，以确保所有重要的东西在升级后仍然工作</p><ul class=""><li id="ce9c" class="ma mb iq ka b kb kc kf kg kj mc kn md kr me kv mf mg mh mi bi translated">库贝法兰绒</li><li id="8a6a" class="ma mb iq ka b kb mj kf mk kj ml kn mm kr mn kv mf mg mh mi bi translated">kube-dns</li><li id="d73c" class="ma mb iq ka b kb mj kf mk kj ml kn mm kr mn kv mf mg mh mi bi translated">kube-DNS-自动缩放器</li><li id="fec4" class="ma mb iq ka b kb mj kf mk kj ml kn mm kr mn kv mf mg mh mi bi translated">dns控制器</li><li id="79d6" class="ma mb iq ka b kb mj kf mk kj ml kn mm kr mn kv mf mg mh mi bi translated">kube-apiserver</li><li id="fe4a" class="ma mb iq ka b kb mj kf mk kj ml kn mm kr mn kv mf mg mh mi bi translated">kube-控制器-管理器</li><li id="18e8" class="ma mb iq ka b kb mj kf mk kj ml kn mm kr mn kv mf mg mh mi bi translated">kube代理ip</li><li id="4dfc" class="ma mb iq ka b kb mj kf mk kj ml kn mm kr mn kv mf mg mh mi bi translated">etcd-服务器-事件x 3</li><li id="d9ec" class="ma mb iq ka b kb mj kf mk kj ml kn mm kr mn kv mf mg mh mi bi translated">etcd-服务器-ip x 3</li></ul><p id="0927" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">如果所有的舱都正常工作。我们应该为真正的行动做好准备。</p><h1 id="d680" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">生产集群上的实际升级</h1><p id="f810" class="pw-post-body-paragraph jy jz iq ka b kb lv kd ke kf lw kh ki kj lx kl km kn ly kp kq kr lz kt ku kv ij bi translated">升级持续时间的计算方法是节点数量x两者之间的时间间隔。更可靠的时间间隔是10分钟，因此如果我们有一个由50个节点组成的集群，所需时间将是500分钟。一定要安排那么多时间。</p><p id="5b32" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">一旦时间确定，测试步骤通过，我们就准备好了！</p><h1 id="8f77" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">常见问题</h1><p id="e4a0" class="pw-post-body-paragraph jy jz iq ka b kb lv kd ke kf lw kh ki kj lx kl km kn ly kp kq kr lz kt ku kv ij bi translated">升级期间群集不验证当一个或多个节点拒绝进入就绪状态，或者在<code class="fe mo mp mq mr b">kube-system</code>命名空间中有任何未就绪的pod时，会发生这种情况。问题解决后，我们可以使用此命令进行验证。</p><p id="f2c0" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><code class="fe mo mp mq mr b">kops validate cluster</code></p><p id="20a5" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在<code class="fe mo mp mq mr b">kube-system</code>内部有挥之不去的失败吊舱而不被注意是很常见的。删除失败的吊舱甚至部署将修复它。</p><h1 id="e1bc" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">升级受阻</h1><p id="d781" class="pw-post-body-paragraph jy jz iq ka b kb lv kd ke kf lw kh ki kj lx kl km kn ly kp kq kr lz kt ku kv ij bi translated"><code class="fe mo mp mq mr b">kops</code>的滚动升级工作方式是一次取下一个节点，用一个具有较新版本的新节点替换。这种方法通常在特定部署需要至少一个正在运行(可用)的pod来确保基本可用性，并且仅设置一个副本之前有效。用这样一个正在运行的pod移除一个节点将导致<code class="fe mo mp mq mr b">availability budget</code>冲突，导致驱逐失败，从而导致集群升级停止。要解决这个问题，只需删除有问题的pod，升级将继续逐出节点。</p><p id="ad8e" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我们通常在各种名称空间的nginx入口控制器上看到这种类型的违规。使用详细日志选项升级集群将有助于识别这种类型的违规(请注意<code class="fe mo mp mq mr b">-v 10</code>选项)</p><p id="046b" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><code class="fe mo mp mq mr b">kops rolling-update cluster --master-interval=10m --node-interval=10m --yes -v 10</code></p><p id="7c51" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">如果升级因其他未知原因停止，我建议使用以下命令清空节点</p><p id="9755" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><code class="fe mo mp mq mr b">kubectl drain --ignore-daemonsets --delete-local-data --force &lt;NODE&gt;</code></p><p id="acf1" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">然后，您可以通过AWS EC2控制台手动终止节点。</p><h1 id="33ad" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">结束语</h1><p id="91d3" class="pw-post-body-paragraph jy jz iq ka b kb lv kd ke kf lw kh ki kj lx kl km kn ly kp kq kr lz kt ku kv ij bi translated">根据我对kops的经验，由于滚动更新的本质，升级通常是非常安全的。如果您希望在进程中恢复到原始版本，您可以简单地终止进程(<code class="fe mo mp mq mr b">kops rolling-update cluster</code>)并编辑版本，然后重启<code class="fe mo mp mq mr b">rolling-update</code>命令。我只有感谢<code class="fe mo mp mq mr b">kops</code>团队，感谢所有的顺利体验。正因为如此，Buffer作为一家公司能够对Kubernetes有如此高的信心，并且已经将我们的大部分服务迁移到了Kubernetes。</p></div><div class="ab cl nf ng hu nh" role="separator"><span class="ni bw bk nj nk nl"/><span class="ni bw bk nj nk nl"/><span class="ni bw bk nj nk"/></div><div class="ij ik il im in"><p id="1358" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><em class="nm">原载于</em><a class="ae kw" href="https://gist.github.com/stevenc81/e8d86d68a2aff69b7268938fa1f711fe" rel="noopener ugc nofollow" target="_blank"><em class="nm">gist.github.com</em></a><em class="nm">。</em></p></div></div>    
</body>
</html>