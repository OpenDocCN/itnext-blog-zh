<html>
<head>
<title>Firebase Cloud Functions — Firestore Triggers</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Firebase云功能— Firestore触发器</h1>
<blockquote>原文：<a href="https://itnext.io/cloud-functions-firestore-triggers-d6fa30169ec8?source=collection_archive---------2-----------------------#2020-08-25">https://itnext.io/cloud-functions-firestore-triggers-d6fa30169ec8?source=collection_archive---------2-----------------------#2020-08-25</a></blockquote><div><div class="fc ii ij ik il im"/><div class="in io ip iq ir"><div class=""/><figure class="gm go js jt ju jv gi gj paragraph-image"><div role="button" tabindex="0" class="jw jx di jy bf jz"><div class="gi gj jr"><img src="../Images/d071a01c632d81816c99b895469c1f7a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*jRo2hIs5gj5GLh9TZKnSpg.png"/></div></div></figure><p id="491a" class="pw-post-body-paragraph kc kd iu ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz in bi la translated"><span class="l lb lc ld bm le lf lg lh li di"> C </span> loud Functions是Firebase提供的一项功能，用于在Google基础设施上运行服务器代码，以响应由Firebase事件和HTTPS请求触发的事件。开发人员不必处理维护和可伸缩性问题。Firebase会自动扩展计算资源，以匹配用户的使用模式。每个功能都在自己的环境中独立运行，并有自己的配置。开发人员只需编写业务逻辑，并让谷歌为我们处理服务器。</p><p id="2afa" class="pw-post-body-paragraph kc kd iu ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz in bi translated">有很多可用的Firebase事件，其中之一是Firestore事件。一旦在特定集合中创建、更新和删除了任何文档，Firestore就会通知云功能。它有助于在文档初始化时添加额外信息，在文档更新时验证信息，并在管理员/用户的信息被删除时通知他们。</p><p id="52d6" class="pw-post-body-paragraph kc kd iu ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz in bi translated">实现并不难，但需要一些技巧。让我们看看这里！</p></div><div class="ab cl lj lk hy ll" role="separator"><span class="lm bw bk ln lo lp"/><span class="lm bw bk ln lo lp"/><span class="lm bw bk ln lo"/></div><div class="in io ip iq ir"><h1 id="e988" class="lq lr iu bd ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn bi translated">简介</h1><figure class="mp mq mr ms gu jv gi gj paragraph-image"><div role="button" tabindex="0" class="jw jx di jy bf jz"><div class="gi gj mo"><img src="../Images/878506fffa2e77e6ee25c1fe1132a150.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*gX-goFBvgy2OKNzk0hWnZw.png"/></div></div></figure><h2 id="9bb7" class="mt lr iu bd ls mu mv dn lw mw mx dp ma kn my mz me kr na nb mi kv nc nd mm ne bi translated">1.onCreate</h2><figure class="mp mq mr ms gu jv"><div class="bz fq l di"><div class="nf ng l"/></div></figure><p id="1bd0" class="pw-post-body-paragraph kc kd iu ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz in bi translated">一旦创建了特定集合中的新文档，就会触发<code class="fe nh ni nj nk b">onCreate</code>(第8行的<code class="fe nh ni nj nk b">fooCollection</code>)。回调包含一个<code class="fe nh ni nj nk b">QueryDocumentSnapshot</code>和一个<code class="fe nh ni nj nk b">EventContext</code>。可以从它们中检索文档id和文档数据，以便进一步检查(参见第11行到第17行)。</p><h2 id="4b8a" class="mt lr iu bd ls mu mv dn lw mw mx dp ma kn my mz me kr na nb mi kv nc nd mm ne bi translated">2.onUpdate</h2><figure class="mp mq mr ms gu jv"><div class="bz fq l di"><div class="nf ng l"/></div></figure><p id="f9fe" class="pw-post-body-paragraph kc kd iu ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz in bi translated"><code class="fe nh ni nj nk b">onUpdate</code>在特定集合中的文档的字段被更新时被触发。它返回一个包含原始数据和新数据的<code class="fe nh ni nj nk b"><a class="ae nl" href="https://firebase.google.com/docs/reference/functions/cloud_functions_.change" rel="noopener ugc nofollow" target="_blank"><em class="nm">Change</em></a>&lt;<em class="nm">QueryDocumentSnapshot</em>&gt;</code>。</p><p id="7f62" class="pw-post-body-paragraph kc kd iu ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz in bi translated">子集合文档中的更改不会触发其父文档的<code class="fe nh ni nj nk b">onUpdate</code>事件。</p><blockquote class="nn no np"><p id="93ae" class="kc kd nm ke b kf kg kh ki kj kk kl km nq ko kp kq nr ks kt ku ns kw kx ky kz in bi translated"><code class="fe nh ni nj nk b">onUpdate</code>当客户端使用完全相同的值更新文档时，不会触发事件。换句话说，只有当任何一个字段值更改为另一个值时，才会触发它。</p></blockquote><h2 id="1781" class="mt lr iu bd ls mu mv dn lw mw mx dp ma kn my mz me kr na nb mi kv nc nd mm ne bi translated">3.onDelete</h2><figure class="mp mq mr ms gu jv"><div class="bz fq l di"><div class="nf ng l"/></div></figure><p id="b411" class="pw-post-body-paragraph kc kd iu ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz in bi translated"><code class="fe nh ni nj nk b">onDelete</code>在删除单据时触发。语法与<code class="fe nh ni nj nk b">onCreate</code>的语法相同。用例可以是使用<a class="ae nl" href="https://sendgrid.com/marketing/sendgrid-services-cro/?extProvId=5&amp;extPu=49397-gaw&amp;extLi=10112337553&amp;sem_adg=102556643438&amp;extCr=102556643438-437015015279&amp;extSi=&amp;extTg=&amp;keyword=sendgrid&amp;extAP=&amp;extMT=e&amp;utm_medium=cpc&amp;utm_source=google&amp;gclid=Cj0KCQjw7ZL6BRCmARIsAH6XFDI5ABmR9JmTDh92pb49DSe0NgOH9CzbNashbrySFvwjGduZXzLqTtoaAjNaEALw_wcB" rel="noopener ugc nofollow" target="_blank"> Sendgrid </a>在管理员从系统中删除用户帐户后向用户发送电子邮件。</p><h2 id="d523" class="mt lr iu bd ls mu mv dn lw mw mx dp ma kn my mz me kr na nb mi kv nc nd mm ne bi translated">4.onWrite</h2><figure class="mp mq mr ms gu jv"><div class="bz fq l di"><div class="nf ng l"/></div><figcaption class="nt nu gk gi gj nv nw bd b be z dk translated">onCreate:Google . firestore . document . create on update:Google . firestore . document . update on delete:Google . firestore . document . write</figcaption></figure><p id="1d1c" class="pw-post-body-paragraph kc kd iu ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz in bi translated">当<code class="fe nh ni nj nk b">onCreate</code>、<code class="fe nh ni nj nk b">onUpdate</code>、&amp;、<code class="fe nh ni nj nk b">onDelete</code>中的任意一个被触发时，就会触发<code class="fe nh ni nj nk b">onWrite</code>。为了区分它们，可以使用<code class="fe nh ni nj nk b">eventType</code>(参见第7行到第12行)。可能的值可以是:</p><ol class=""><li id="191f" class="nx ny iu ke b kf kg kj kk kn nz kr oa kv ob kz oc od oe of bi translated">onCreate: <code class="fe nh ni nj nk b">google.firestore.document.create</code></li><li id="0647" class="nx ny iu ke b kf og kj oh kn oi kr oj kv ok kz oc od oe of bi translated">更新日期:<code class="fe nh ni nj nk b">google.firestore.document.update</code></li><li id="c43e" class="nx ny iu ke b kf og kj oh kn oi kr oj kv ok kz oc od oe of bi translated">onDelete: <code class="fe nh ni nj nk b">google.firestore.document.delete</code></li></ol><p id="3001" class="pw-post-body-paragraph kc kd iu ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz in bi translated">为防止重复处理，不建议同时执行<code class="fe nh ni nj nk b">onWrite</code>和<code class="fe nh ni nj nk b">onCreate</code>、<code class="fe nh ni nj nk b">onUpdate</code>和<code class="fe nh ni nj nk b">onDelete</code>中的任何一个。</p></div><div class="ab cl lj lk hy ll" role="separator"><span class="lm bw bk ln lo lp"/><span class="lm bw bk ln lo lp"/><span class="lm bw bk ln lo"/></div><div class="in io ip iq ir"><h1 id="f950" class="lq lr iu bd ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn bi translated">本地Firebase仿真器UI</h1><p id="e841" class="pw-post-body-paragraph kc kd iu ke b kf ol kh ki kj om kl km kn on kp kq kr oo kt ku kv op kx ky kz in bi translated">Firebase将在2020年发布一个本地Firebase模拟器UI，它可以同时模拟云功能和Firestore。因此，在部署到Firebase server之前，您可以在本地测试所有触发器。更多信息见下面的文章。</p><div class="oq or gq gs os ot"><a rel="noopener  ugc nofollow" target="_blank" href="/cloud-functions-firestore-triggers-d6fa30169ec8"><div class="ou ab fp"><div class="ov ab ow cl cj ox"><h2 class="bd iv gz z fq oy fs ft oz fv fx it bi translated">云功能— Firestore触发器</h2><div class="pa l"><h3 class="bd b gz z fq oy fs ft oz fv fx dk translated">云功能是Firebase提供的一个特性，用于在Google基础设施上运行后端代码，以响应…</h3></div><div class="pb l"><p class="bd b dl z fq oy fs ft oz fv fx dk translated">itnext.io</p></div></div><div class="pc l"><div class="pd l pe pf pg pc ph ka ot"/></div></div></a></div></div><div class="ab cl lj lk hy ll" role="separator"><span class="lm bw bk ln lo lp"/><span class="lm bw bk ln lo lp"/><span class="lm bw bk ln lo"/></div><div class="in io ip iq ir"><h1 id="58e7" class="lq lr iu bd ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn bi translated">限制和技巧</h1><ol class=""><li id="56e3" class="nx ny iu ke b kf ol kj om kn pi kr pj kv pk kz oc od oe of bi translated">每个云Firestore触发器的超时时间只有10秒</li><li id="ff4f" class="nx ny iu ke b kf og kj oh kn oi kr oj kv ok kz oc od oe of bi translated">不保证触发的顺序。快速变化会以意想不到的顺序触发函数调用。</li><li id="81d9" class="nx ny iu ke b kf og kj oh kn oi kr oj kv ok kz oc od oe of bi translated">在云函数中执行的读写不受安全规则的控制，它们可以访问数据库的任何部分。</li></ol></div><div class="ab cl lj lk hy ll" role="separator"><span class="lm bw bk ln lo lp"/><span class="lm bw bk ln lo lp"/><span class="lm bw bk ln lo"/></div><div class="in io ip iq ir"><h1 id="55b9" class="lq lr iu bd ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn bi translated">阅读材料:</h1><h2 id="0858" class="mt lr iu bd ls mu mv dn lw mw mx dp ma kn my mz me kr na nb mi kv nc nd mm ne bi translated">1.云Firestore触发官方文档</h2><div class="oq or gq gs os ot"><a href="https://firebase.google.com/docs/functions/firestore-events" rel="noopener  ugc nofollow" target="_blank"><div class="ou ab fp"><div class="ov ab ow cl cj ox"><h2 class="bd iv gz z fq oy fs ft oz fv fx it bi translated">云Firestore触发器| Firebase</h2><div class="pa l"><h3 class="bd b gz z fq oy fs ft oz fv fx dk translated">通过云功能，您可以在云Firestore中处理事件，而无需更新客户端代码。您可以制作云…</h3></div><div class="pb l"><p class="bd b dl z fq oy fs ft oz fv fx dk translated">firebase.google.com</p></div></div><div class="pc l"><div class="pl l pe pf pg pc ph ka ot"/></div></div></a></div><h1 id="9d3b" class="lq lr iu bd ls lt pm lv lw lx pn lz ma mb po md me mf pp mh mi mj pq ml mm mn bi translated">2.幂等函数</h1><div class="oq or gq gs os ot"><a href="https://cloud.google.com/blog/products/serverless/cloud-functions-pro-tips-building-idempotent-functions" rel="noopener  ugc nofollow" target="_blank"><div class="ou ab fp"><div class="ov ab ow cl cj ox"><h2 class="bd iv gz z fq oy fs ft oz fv fx it bi translated">云函数专家提示:构建幂等函数</h2><div class="pa l"><h3 class="bd b gz z fq oy fs ft oz fv fx dk translated">编辑描述</h3></div><div class="pb l"><p class="bd b dl z fq oy fs ft oz fv fx dk translated">cloud.google.com</p></div></div><div class="pc l"><div class="pr l pe pf pg pc ph ka ot"/></div></div></a></div></div><div class="ab cl lj lk hy ll" role="separator"><span class="lm bw bk ln lo lp"/><span class="lm bw bk ln lo lp"/><span class="lm bw bk ln lo"/></div><div class="in io ip iq ir"><figure class="mp mq mr ms gu jv gi gj paragraph-image"><div class="ab gv cl ps"><img src="../Images/9c1e78c631a979c614ef7e3ba18a74dc.png" data-original-src="https://miro.medium.com/v2/format:webp/0*QW2R91UxqbYEUmLO.png"/></div></figure><p id="b8f9" class="pw-post-body-paragraph kc kd iu ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz in bi translated">欢迎您通过<a class="ae nl" href="https://twitter.com/myrick_chow" rel="noopener ugc nofollow" target="_blank">Twitter @ my rik _ chow</a>关注我，了解更多信息和文章。感谢您阅读这篇文章。祝您愉快！😄</p></div></div>    
</body>
</html>