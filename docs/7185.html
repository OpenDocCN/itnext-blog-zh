<html>
<head>
<title>Non deterministic null_provider behaviour in terraform</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">terraform中不确定的null_provider行为</h1>
<blockquote>原文：<a href="https://itnext.io/non-deterministic-null-resource-provider-behaviour-in-terraform-f5aaba64179f?source=collection_archive---------1-----------------------#2022-07-08">https://itnext.io/non-deterministic-null-resource-provider-behaviour-in-terraform-f5aaba64179f?source=collection_archive---------1-----------------------#2022-07-08</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><figure class="ip iq gp gr ir is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi io"><img src="../Images/f502e50dee626de20ea47a491b677994.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*fDmLV9-mieSAoN3YEcMdtA.jpeg"/></div></div></figure><div class=""/><p id="cbed" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我们非常依赖terraform在AWS云上设置我们的基础设施。我们需要提供<code class="fe kw kx ky kz b">EC2</code>实例，并在创建时用一些引导代码和代理设置对它们进行配置，以便它们可供我们的内部用户使用。这个引导脚本是使用一个<code class="fe kw kx ky kz b">null_resource</code>应用的，这个<code class="fe kw kx ky kz b">null_resource</code>可以通过terraform的<code class="fe kw kx ky kz b">null_provider</code>获得。我们有一个平台，允许我们的内部用户为多种用例(数据科学、面向Web的应用程序等)构建不同类型的<code class="fe kw kx ky kz b">EC2</code>实例。)</p><figure class="la lb lc ld gt is"><div class="bz fp l di"><div class="le lf l"/></div><figcaption class="lg lh gj gh gi li lj bd b be z dk translated">null_resource我们用来配置新创建的EC2实例的代码</figcaption></figure><p id="6b33" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">这些实例有一个与它们相关的<code class="fe kw kx ky kz b">cloud-init</code>模板，该模板在实例初始化时安装了各种工具，这是我们的用户经常要求的。bootstrap脚本也使用其中的一些工具来下载包并对它们进行配置。<code class="fe kw kx ky kz b">unzip</code>是我们用来提取打包的tarballs并从源代码安装的工具之一。但是我们很快注意到这个<code class="fe kw kx ky kz b">null_resource</code>经常失败，并抱怨<code class="fe kw kx ky kz b">unzip</code>不可用。简单地重新运行作业就可以解决问题，但是最大的问题是为什么它会出现在第一个位置！</p><figure class="la lb lc ld gt is"><div class="bz fp l di"><div class="le lf l"/></div><figcaption class="lg lh gj gh gi li lj bd b be z dk translated">我们会在游戏机上不断出现的错误。这是我们没有接触到的地球形态丑陋的一面！s</figcaption></figure><p id="7fd7" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我坐下来深入研究这个问题，花了相当长的时间才意识到它的发生并不是不确定的；该错误有时是可重现的，而其他时候代码完全正常。很快就清楚了，这是terraform的一面，我联系了谷歌搜索，看看我是不是一个人。几个点击<a class="ae lk" href="https://github.com/hashicorp/terraform/issues/16656" rel="noopener ugc nofollow" target="_blank">这里和那里</a>证明我不是一个人，这实际上是一个非常令人讨厌的，但从terraform的<code class="fe kw kx ky kz b">null_provider</code>已知的行为。</p><div class="ip iq gp gr ir ll"><a href="https://github.com/hashicorp/terraform/issues/16656" rel="noopener  ugc nofollow" target="_blank"><div class="lm ab fo"><div class="ln ab lo cl cj lp"><h2 class="bd jc gy z fp lq fr fs lr fu fw ja bi translated">remote-exec provisioner: apt-get安装偶尔会失败问题#16656 hashicorp/terraform</h2><div class="ls l"><h3 class="bd b gy z fp lq fr fs lr fu fw dk translated">此时您不能执行该操作。您已使用另一个标签页或窗口登录。您已在另一个选项卡中注销，或者…</h3></div><div class="lt l"><p class="bd b dl z fp lq fr fs lr fu fw dk translated">github.com</p></div></div><div class="lu l"><div class="lv l lw lx ly lu lz ix ll"/></div></div></a></div><p id="2730" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><a class="ae lk" href="https://unix.stackexchange.com/a/471192/398090" rel="noopener ugc nofollow" target="_blank">显然</a><code class="fe kw kx ky kz b">null_resource</code>不会等待<code class="fe kw kx ky kz b">cloud_init</code>结束，并且会假设因为<code class="fe kw kx ky kz b">EC2</code>实例已经被创建，它可以继续运行<code class="fe kw kx ky kz b">null_resource</code>。这个动作甚至会绕过我们为解决这个问题而引入到资源中的<code class="fe kw kx ky kz b">depends_on</code>属性，因为根据terraform，实例已经被创建了。实际的修正是在引导脚本中引入下面的代码头，允许脚本等到<code class="fe kw kx ky kz b">cloud_init</code>完成安装。</p><figure class="la lb lc ld gt is"><div class="bz fp l di"><div class="le lf l"/></div><figcaption class="lg lh gj gh gi li lj bd b be z dk translated">游戏规则改变者<a class="ae lk" href="https://github.com/hashicorp/terraform/issues/16656#issuecomment-444379459" rel="noopener ugc nofollow" target="_blank">评论</a>关于地形问题！</figcaption></figure><div class="ip iq gp gr ir ll"><a href="https://unix.stackexchange.com/questions/315502/how-to-disable-apt-daily-service-on-ubuntu-cloud-vm-image/471192#471192" rel="noopener  ugc nofollow" target="_blank"><div class="lm ab fo"><div class="ln ab lo cl cj lp"><h2 class="bd jc gy z fp lq fr fs lr fu fw ja bi translated">如何在Ubuntu云VM镜像上禁用' apt-daily.service '？</h2><div class="ls l"><h3 class="bd b gy z fp lq fr fs lr fu fw dk translated">Ubuntu 16.04服务器VM镜像显然每12小时左右启动一次“apt-daily . service”；该服务执行…</h3></div><div class="lt l"><p class="bd b dl z fp lq fr fs lr fu fw dk translated">unix.stackexchange.com</p></div></div><div class="lu l"><div class="ma l lw lx ly lu lz ix ll"/></div></div></a></div></div></div>    
</body>
</html>