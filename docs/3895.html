<html>
<head>
<title>A bug collapsing the whole service mesh</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">一个破坏整个服务网的错误</h1>
<blockquote>原文：<a href="https://itnext.io/a-bug-collapsing-the-whole-service-mesh-57dd87ff053?source=collection_archive---------1-----------------------#2020-03-20">https://itnext.io/a-bug-collapsing-the-whole-service-mesh-57dd87ff053?source=collection_archive---------1-----------------------#2020-03-20</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><figure class="gl gn jr js jt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi jq"><img src="../Images/5f44462a049f8d54ec24baa87e4eb58b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*3cDaDZtQw5rxOlMh.jpg"/></div></div></figure><p id="700a" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">我正准备用IBM CloudPak演示Knative和Istio的特性，以便在open shift Container Platform(OCP)4.2上应用。一切都很顺利，Knative服务能够缩小到零个pod，并在流量到来时自动激活，直到我打开跟踪功能并使用Kiali可视化流量。</p><h1 id="5487" class="kz la it bd lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw bi translated">1.打开Kiali</h1><p id="f34b" class="pw-post-body-paragraph kb kc it kd b ke lx kg kh ki ly kk kl km lz ko kp kq ma ks kt ku mb kw kx ky im bi translated">要启用Kiali，请修改名为basic-install的CRD ServiceMeshControlPlane，以启用Kiali。要启用跟踪，必须使用特使边车来捕获跟踪和监控数据。让我们启用sidecarInjectorWebhook，这样sidecar就可以在创建时注入到Pod中。</p><pre class="mc md me mf gt mg mh mi mj aw mk bi"><span id="7467" class="ml la it mh b gy mm mn l mo mp">spec:<br/>  istio:<br/>    kiali:<br/>      enabled: true<br/>    tracing:<br/>      enabled: true<br/>    global:<br/>      defaultPodDisruptionBudget:<br/>        enabled: false<br/>      disablePolicyChecks: false<br/>      multitenant: true<br/>      omitSidecarInjectorConfigMap: false<br/>      proxy:<br/>        autoInject: disabled<br/>    grafana:<br/>      enabled: true<br/>    sidecarInjectorWebhook:<br/>      enabled: true<br/>    mixer:<br/>      enabled: true<br/>      policy:<br/>        enabled: false<br/>      telemetry:<br/>        enabled: true<br/>    prometheus:<br/>      enabled: true</span></pre><p id="0577" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">请注意，遥测和普罗米修斯启用了监测指标。</p><p id="0087" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">在改变之后，操作员魔术开始工作，Kiali UI正在工作。webhook开始将sidecar注入到加入服务网格的名称空间的Pod中。一切似乎都很好。</p><p id="4abc" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">然而…</p><h1 id="2724" class="kz la it bd lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw bi translated"><strong class="ak"> 2。Knative activator进入崩溃循环</strong></h1><p id="716e" class="pw-post-body-paragraph kb kc it kd b ke lx kg kh ki ly kk kl km lz ko kp kq ma ks kt ku mb kw kx ky im bi translated">由于knative-serving名称空间是服务网格的成员，并且操作者OpenShift无服务器操作者协调Knative activator的部署以具有以下注释，</p><pre class="mc md me mf gt mg mh mi mj aw mk bi"><span id="2559" class="ml la it mh b gy mm mn l mo mp">sidecar.istio.io/inject: 'true'</span></pre><p id="bcb6" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">activator pod将注入istio边车，现在activator pod无法正常工作，并在初始启动阶段失败，出现以下错误。</p><pre class="mc md me mf gt mg mh mi mj aw mk bi"><span id="3aa5" class="ml la it mh b gy mm mn l mo mp">Error loading/parsing logging configuration:Get https://172.30.0.1:443/api/v1/namespaces/knative-serving/configmaps/config-logging: http: server gave HTTP response to HTTPS client</span></pre><p id="7d8b" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">当激活器失败时，它作为下面的功能失败，Knative服务将不再工作。</p><ol class=""><li id="7b5e" class="mq mr it kd b ke kf ki kj km ms kq mt ku mu ky mv mw mx my bi translated"><em class="mz">接收&amp;不活动修订的缓冲请求。</em></li><li id="e3a7" class="mq mr it kd b ke na ki nb km nc kq nd ku ne ky mv mw mx my bi translated"><em class="mz">向自动缩放器报告指标。</em></li><li id="c449" class="mq mr it kd b ke na ki nb km nc kq nd ku ne ky mv mw mx my bi translated"><em class="mz">在自动缩放器根据报告的指标缩放修订后，重试对修订的请求。</em></li></ol><h1 id="e099" class="kz la it bd lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw bi translated"><strong class="ak"> 3。模拟问题</strong></h1><p id="84ea" class="pw-post-body-paragraph kb kc it kd b ke lx kg kh ki ly kk kl km lz ko kp kq ma ks kt ku mb kw kx ky im bi translated">让我们试着重复这个问题。在同一命名空间中，使用与activator pod相同的服务帐户创建一个debug pod。</p><pre class="mc md me mf gt mg mh mi mj aw mk bi"><span id="bed1" class="ml la it mh b gy mm mn l mo mp">apiVersion: v1<br/>kind: Pod<br/>metadata:<br/>  labels:<br/>    run: debug<br/>  annotations:<br/>    sidecar.istio.io/inject: 'true'<br/>  name: debug<br/>spec:<br/>  serviceAccountName: controller<br/>  containers:<br/>  - image: curlimages/curl<br/>    name: debug<br/>    command:<br/>      - sh<br/>      - -c<br/>      - 'sleep 3600; exit'<br/>  restartPolicy: Never</span></pre><p id="0636" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">exec进入pod，运行以下命令，</p><pre class="mc md me mf gt mg mh mi mj aw mk bi"><span id="e161" class="ml la it mh b gy mm mn l mo mp">export CACERT=/run/secrets/kubernetes.io/serviceaccount/ca.crt</span><span id="c2a6" class="ml la it mh b gy nf mn l mo mp">export TOKEN=$(cat /run/secrets/kubernetes.io/serviceaccount/token)</span><span id="d60b" class="ml la it mh b gy nf mn l mo mp">curl -H "Authorization: Bearer $TOKEN" --cacert $CACERT https://172.30.0.1/api/v1/namespaces/knative-serving/configmaps/config-logging</span></pre><p id="b335" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">那我就有错误了</p><pre class="mc md me mf gt mg mh mi mj aw mk bi"><span id="bf13" class="ml la it mh b gy mm mn l mo mp">curl: (35) error:1408F10B:SSL routines:ssl3_get_record:wrong version number</span></pre><p id="044c" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">它与activator pod相同。正常的http响应是对https请求的回应。</p><h2 id="ef42" class="ml la it bd lb ng nh dn lf ni nj dp lj km nk nl ln kq nm nn lr ku no np lv nq bi translated">测试1。正常的http运行正常吗？</h2><p id="8a2c" class="pw-post-body-paragraph kb kc it kd b ke lx kg kh ki ly kk kl km lz ko kp kq ma ks kt ku mb kw kx ky im bi translated">答案如下图是肯定的。</p><pre class="mc md me mf gt mg mh mi mj aw mk bi"><span id="dcae" class="ml la it mh b gy mm mn l mo mp">kubectl -n knative-serving exec debug -i -c debug -- sh -c 'curl <a class="ae nr" href="http://httpbin.org/headers'" rel="noopener ugc nofollow" target="_blank">http://httpbin.org/headers'</a></span><span id="3070" class="ml la it mh b gy nf mn l mo mp">...</span><span id="4ba0" class="ml la it mh b gy nf mn l mo mp">{<br/>  "headers": {<br/>    "Accept": "*/*",<br/>    "Content-Length": "0",<br/>    "Host": "httpbin.org",<br/>    "User-Agent": "curl/7.69.1-DEV",<br/>    "X-Amzn-Trace-Id": "Root=1-5e747c1d-41fbfb8274a15620acf0d30b",<br/>    "X-B3-Sampled": "0",<br/>    "X-B3-Spanid": "c645c09f1ab9c9c0",<br/>    "X-B3-Traceid": "685234a1177a2ebcc645c09f1ab9c9c0",<br/>    "X-Envoy-Expected-Rq-Timeout-Ms": "15000",<br/>    "X-Istio-Attributes":nVnLmtuYXRpdmUtc2VydmluZw=="<br/>  }<br/>}</span></pre><h2 id="c93b" class="ml la it bd lb ng nh dn lf ni nj dp lj km nk nl ln kq nm nn lr ku no np lv nq bi translated">测试2。https在工作吗？</h2><pre class="mc md me mf gt mg mh mi mj aw mk bi"><span id="4242" class="ml la it mh b gy mm mn l mo mp">kubectl -n knative-serving exec debug -i -c debug -- sh -c 'curl <a class="ae nr" href="http://httpbin.org/headers'" rel="noopener ugc nofollow" target="_blank">https://httpbin.org/headers'</a></span><span id="9e18" class="ml la it mh b gy nf mn l mo mp">curl: (35) error:1408F10B:SSL routines:ssl3_get_record:wrong version number<br/>command terminated with exit code 35</span></pre><p id="37d7" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">https不工作。</p><h2 id="1189" class="ml la it bd lb ng nh dn lf ni nj dp lj km nk nl ln kq nm nn lr ku no np lv nq bi translated">测试3。服务网格中的http在工作吗？</h2><p id="ceb5" class="pw-post-body-paragraph kb kc it kd b ke lx kg kh ki ly kk kl km lz ko kp kq ma ks kt ku mb kw kx ky im bi translated">上述测试是针对外部服务的。在activator的错误消息中，172.30.0.1指的是kubernetes.default的服务。默认名称空间实际上不在服务网格中，这是用以下命令显示的，</p><pre class="mc md me mf gt mg mh mi mj aw mk bi"><span id="8f64" class="ml la it mh b gy mm mn l mo mp">oc -n istio-system get smmr<br/>NAME      MEMBERS<br/>default   [knative-serving tekton-pipelines kabanero plant-by-websphere plant-by-websphere-dev redis-service]</span></pre><p id="f23b" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">因此，让我们在服务网格中找出一些服务，比如说knative-serving，</p><pre class="mc md me mf gt mg mh mi mj aw mk bi"><span id="4944" class="ml la it mh b gy mm mn l mo mp">oc -n knative-serving get svc</span><span id="8aa0" class="ml la it mh b gy nf mn l mo mp">NAME                TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)                     AGE<br/>activator-service   ClusterIP   172.30.99.179    &lt;none&gt;        80/TCP,81/TCP,9090/TCP      10d<br/><strong class="mh iu">autoscaler          ClusterIP   172.30.108.136   &lt;none&gt;        8080/TCP,9090/TCP,443/TCP   10d</strong><br/>controller          ClusterIP   172.30.218.61    &lt;none&gt;        9090/TCP                    10d<br/>webhook             ClusterIP   172.30.125.111   &lt;none&gt;        443/TCP                     10d</span></pre><p id="910f" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">选择自动缩放服务。</p><pre class="mc md me mf gt mg mh mi mj aw mk bi"><span id="69f9" class="ml la it mh b gy mm mn l mo mp">kubectl -n knative-serving exec debug -i -c debug -- sh -c 'curl -s <a class="ae nr" href="http://autoscaler.knative-serving:8080'" rel="noopener ugc nofollow" target="_blank">http://autoscaler.knative-serving:8080'</a><br/>Bad Request</span></pre><p id="ff04" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">http服务器已响应，网格内HTTP服务正在工作。</p><h2 id="13e4" class="ml la it bd lb ng nh dn lf ni nj dp lj km nk nl ln kq nm nn lr ku no np lv nq bi translated">测试4。服务网格中的https是否正常工作？</h2><pre class="mc md me mf gt mg mh mi mj aw mk bi"><span id="8352" class="ml la it mh b gy mm mn l mo mp">kubectl -n knative-serving exec debug -i -c debug -- sh -c 'curl -ks <a class="ae nr" href="http://autoscaler.knative-serving:8080'" rel="noopener ugc nofollow" target="_blank">https://autoscaler.knative-serving'</a></span><span id="32d8" class="ml la it mh b gy nf mn l mo mp">{<br/>  "kind": "Status",<br/>  "apiVersion": "v1",<br/>  "metadata": {</span><span id="d9d5" class="ml la it mh b gy nf mn l mo mp">},<br/>  "status": "Failure",<br/>  "message": "forbidden: User \"system:anonymous\" cannot get path \"/\"",<br/>  "reason": "Forbidden",<br/>  "details": {</span><span id="8f4d" class="ml la it mh b gy nf mn l mo mp">},<br/>  "code": 403<br/>}</span></pre><p id="675d" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">所以https in-mesh也在工作。</p><h1 id="5044" class="kz la it bd lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw bi translated">4.回避问题</h1><p id="3465" class="pw-post-body-paragraph kb kc it kd b ke lx kg kh ki ly kk kl km lz ko kp kq ma ks kt ku mb kw kx ky im bi translated">通过上面的一组测试，问题的行为是清楚的，服务网格之外的HTTPS服务不能被正确访问。走查非常简单，让默认名称空间加入服务网格。</p><p id="99f8" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">编辑<em class="mz"> ServiceMeshMemberRoll </em>以添加<em class="mz">默认</em>名称空间。我们应该有如下的东西，</p><pre class="mc md me mf gt mg mh mi mj aw mk bi"><span id="5e52" class="ml la it mh b gy mm mn l mo mp">oc -n istio-system get smmr default<br/>NAME      MEMBERS<br/>default   [knative-serving tekton-pipelines kabanero plant-by-websphere plant-by-websphere-dev redis-service default]</span></pre><p id="a96c" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">过了一会儿，激活器吊舱恢复正常。唷！</p><h1 id="ea08" class="kz la it bd lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw bi translated">5.真正的罪犯</h1><p id="5fcd" class="pw-post-body-paragraph kb kc it kd b ke lx kg kh ki ly kk kl km lz ko kp kq ma ks kt ku mb kw kx ky im bi translated">绕场就是绕场。真正的问题是什么？经过一番搜索，本期日志(【https://github.com/istio/istio/issues/14264】T4)描述了真正的问题。</p><p id="5a83" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">首先，确定代理。</p><pre class="mc md me mf gt mg mh mi mj aw mk bi"><span id="b602" class="ml la it mh b gy mm mn l mo mp">istioctl  proxy-status<br/>NAME                                                              CDS        LDS        EDS        RDS        PILOT                            VERSION<br/>activator-67f8b69697-sqwgb.knative-serving                        SYNCED     SYNCED     SYNCED     SYNCED     istio-pilot-59fc69bd66-t7zbr     1.1.11*<br/>cluster-local-gateway-6647b96c4d-8t9bp.istio-system               SYNCED     SYNCED     SYNCED     SYNCED     istio-pilot-59fc69bd66-t7zbr     1.1.11*<br/>debug.knative-serving                                             SYNCED     SYNCED     SYNCED     SYNCED     istio-pilot-59fc69bd66-t7zbr     1.1.11*<br/>istio-ingressgateway-8465bbf788-x52pk.istio-system                SYNCED     SYNCED     SYNCED     SYNCED     istio-pilot-59fc69bd66-t7zbr     1.1.11*<br/>pbw-dev-v1-deployment-5bc69b6f49-gfqqd.plant-by-websphere-dev     SYNCED     SYNCED     SYNCED     SYNCED     istio-pilot-59fc69bd66-t7zbr     1.1.11*<br/>pbw-v1-deployment-5bc474485b-vgszq.plant-by-websphere             SYNCED     SYNCED     SYNCED     SYNCED     istio-pilot-59fc69bd66-t7zbr     1.1.11*<br/>pbw-v2-deployment-6c7b986d8-bgbc4.plant-by-websphere              SYNCED     SYNCED     SYNCED     SYNCED     istio-pilot-59fc69bd66-t7zbr     1.1.11*</span></pre><p id="a151" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">然后，特别寻找443这个名字，</p><pre class="mc md me mf gt mg mh mi mj aw mk bi"><span id="2e77" class="ml la it mh b gy mm mn l mo mp">istioctl -n knative-serving proxy-config routes activator-67f8b69697-sqwgb.knative-serving --name 443 -o json<br/>[<br/>    {<br/>        "name": "443",<br/>        "virtualHosts": [<br/>            {<br/>                "name": "tekton-dashboard.tekton-pipelines.svc.cluster.local:443",<br/>                "domains": [<br/>                    "tekton-dashboard.tekton-pipelines.svc.cluster.local",<br/>                    "tekton-dashboard.tekton-pipelines.svc.cluster.local:443",<br/>                    "tekton-dashboard.tekton-pipelines",<br/>                    "tekton-dashboard.tekton-pipelines:443",<br/>                    "tekton-dashboard.tekton-pipelines.svc.cluster",<br/>                    "tekton-dashboard.tekton-pipelines.svc.cluster:443",<br/>                    "tekton-dashboard.tekton-pipelines.svc",<br/>                    "tekton-dashboard.tekton-pipelines.svc:443",<br/>                    "172.30.118.86",<br/>                    "172.30.118.86:443"<br/>                ],</span></pre><p id="9e8d" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">请注意，虚拟主机同时具有普通http和443。检查K8s服务，</p><pre class="mc md me mf gt mg mh mi mj aw mk bi"><span id="00d1" class="ml la it mh b gy mm mn l mo mp">kubectl -n tekton-pipelines get svc tekton-dashboard -o yaml</span><span id="f840" class="ml la it mh b gy nf mn l mo mp">...<br/>spec:<br/>  clusterIP: 172.30.118.86<br/>  ports:<br/>  - name: http<br/>    port: 443<br/>    protocol: TCP<br/>    targetPort: 8443<br/>  selector:<br/>    app: tekton-dashboard<br/>  sessionAffinity: None<br/>  type: ClusterIP<br/>...</span></pre><p id="0d5f" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">443被命名为http。这是罪魁祸首。编辑它，并将“http”重命名为“https”以解决问题。(<em class="mz">我们不需要让默认名称空间成为服务网格中的成员</em>)</p><p id="1b90" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">Istio中问题的根本原因记录在问题日志<a class="ae nr" href="https://github.com/istio/istio/issues/16458" rel="noopener ugc nofollow" target="_blank">https://github.com/istio/istio/issues/16458</a>中。它现在还开着。</p></div></div>    
</body>
</html>