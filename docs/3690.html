<html>
<head>
<title>The Essential Guide to Upgrading From Cert-Manager v0.4</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">从Cert-Manager v0.4升级的基本指南</h1>
<blockquote>原文：<a href="https://itnext.io/the-essential-guide-to-upgrading-from-cert-manager-v0-4-56d2a4ae32c2?source=collection_archive---------3-----------------------#2020-02-03">https://itnext.io/the-essential-guide-to-upgrading-from-cert-manager-v0-4-56d2a4ae32c2?source=collection_archive---------3-----------------------#2020-02-03</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><figure class="gl gn jr js jt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi jq"><img src="../Images/0cdd8a5e3763f5cd8e94104a5ebd8923.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*fkk93kEc_njgVJZv"/></div></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated">罗伯特·v·鲁杰罗在<a class="ae kf" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</figcaption></figure><h1 id="6599" class="kg kh it bd ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld bi translated">什么是证书管理器？</h1><p id="1113" class="pw-post-body-paragraph le lf it lg b lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated">Cert-manager是由<a class="ae kf" href="https://cert-manager.io/docs/" rel="noopener ugc nofollow" target="_blank"> Jetstack </a>提供的开源Kubernetes-native控制器。它可以为您颁发和管理群集中的所有证书，并在证书即将到期时取出LetsEncrypt证书并进行更新。Cert-manager非常受欢迎，许多组织使用它来降低为加密内部点对点通信或为入口控制器公开的公共端点生成证书而颁发证书的复杂性。</p><p id="ba6b" class="pw-post-body-paragraph le lf it lg b lh mc lj lk ll md ln lo lp me lr ls lt mf lv lw lx mg lz ma mb im bi translated">当我在2018年夏天开始学习Kubernetes时，我第一次被介绍给cert-manager。当时，我们使用最新版本之一的<code class="fe mh mi mj mk b">v0.4.0</code>，在集群内发布和管理我们的证书。那年9月，我们研究了如何使用<code class="fe mh mi mj mk b">v0.5.0</code>，它对如何使用Helm安装cert-manager进行了突破性的改变。由于v0.4版本仍然相当新，我们决定跳过v0.5，以后再来看。</p><p id="5208" class="pw-post-body-paragraph le lf it lg b lh mc lj lk ll md ln lo lp me lr ls lt mf lv lw lx mg lz ma mb im bi translated">现在是2020年2月。后来有了新的工作和角色，我再次和我的老朋友cert-manager一起管理Kubernetes环境。我现在正在做的项目还在运行<code class="fe mh mi mj mk b">v0.4.1</code>，比最新发布的<code class="fe mh mi mj mk b">v0.13.0</code>落后多<em class="ml">英里。为什么我们还没有升级？这很大程度上是一句谚语“如果它没坏，就不要修理它。”还有，不能从v0.4跳到更高的版本；您必须按顺序进行，因为每个次要版本都有突破性的变化(尽管并不总是如此)。</em></p><h1 id="8a7e" class="kg kh it bd ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld bi translated">我为什么要升级？</h1><p id="5d43" class="pw-post-body-paragraph le lf it lg b lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated">回到2018年，我们注意到我们受到LetsEncrypt的速率限制。由于我们每天都要在沙盒环境中部署数十次，并且每次都要为多个域重新创建证书(我知道这很不礼貌)，我们认为我们的测试有点过于激进了。原来<a class="ae kf" href="https://blog.jetstack.io/blog/cert-manager-0.6/" rel="noopener ugc nofollow" target="_blank">这实际上是cert-manager </a>早期版本中的一个问题，从<code class="fe mh mi mj mk b">v0.6.0</code>开始，每个版本都在逐步解决这个问题。</p><p id="a11c" class="pw-post-body-paragraph le lf it lg b lh mc lj lk ll md ln lo lp me lr ls lt mf lv lw lx mg lz ma mb im bi translated">此外，cert-manager的Helm chart的早期版本包括CustomResourceDefinitions。CustomResourceDefinitions，或CRDs，允许您扩展Kubernetes的API并创建自己的资源。例如，如果您为证书创建了一个资源定义，并将其捆绑到一个图表中，则CRD由Helm拥有和管理。如果您随后在该图表上运行<code class="fe mh mi mj mk b">helm uninstall</code>，Helm将删除CRD，这将提示Kubernetes API删除与其相关联的所有对象。这意味着在旧版本的图表中，您的证书固有地绑定到Cert-manager的安装中，如果您卸载它，您的证书也会随之卸载。奇怪的是，如果您运行<code class="fe mh mi mj mk b">helm upgrade</code>并且对其中一个CRD进行了更改，Helm很可能不会考虑该更改，升级将会失败。James Munnelly (来自Jetstack)在本期GitHub上总结了将CRDs从头盔图中移除的所有原因。</p><h1 id="86ce" class="kg kh it bd ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld bi translated">升级难吗？</h1><p id="9a40" class="pw-post-body-paragraph le lf it lg b lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated">升级说明似乎表明从<code class="fe mh mi mj mk b">v0.4.1</code>到<code class="fe mh mi mj mk b">v0.7.2</code>应该是一个安全的跳跃。任何v0.7以后的版本都需要额外的基础工作，我将在这篇文章的后面介绍。</p></div><div class="ab cl mo mp hx mq" role="separator"><span class="mr bw bk ms mt mu"/><span class="mr bw bk ms mt mu"/><span class="mr bw bk ms mt"/></div><div class="im in io ip iq"><figure class="mw mx my mz gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi mv"><img src="../Images/c5146b444af0f302e44e036def8e93ee.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*TweFyKxdcjmDiMJq"/></div></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated">感觉我终于从深渊中浮出来了！安东尼·泰瑞尔在<a class="ae kf" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</figcaption></figure><h1 id="ae00" class="kg kh it bd ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld bi translated">第1部分:从v0.4到v0.7.2</h1><p id="667f" class="pw-post-body-paragraph le lf it lg b lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated">正如我之前提到的，由于Helm对CRD的处理不当——cert-manager严重依赖CRD来正常运行——jet stack决定从Helm chart中完全删除他们的CRD模板。现在，在通过<code class="fe mh mi mj mk b">kubectl apply -f</code>安装舵图之前，你必须手动安装它们<em class="ml">。同样，如果您想完全删除cert-manager，您将必须卸载Helm chart，然后运行<code class="fe mh mi mj mk b">kubectl delete -f</code>来删除所有的CRD。这是一个仔细阅读文档并向自动化脚本添加额外步骤的问题。</em></p><p id="ed46" class="pw-post-body-paragraph le lf it lg b lh mc lj lk ll md ln lo lp me lr ls lt mf lv lw lx mg lz ma mb im bi translated">另一点要提到的是，Jetstack强烈建议您将cert-manager <em class="ml">安装到它自己的名称空间</em>中，并对其进行标记，这样cert-manager就不会尝试验证它自己的自签名证书，否则会失败。你可以在这里阅读更多关于这个<a class="ae kf" href="https://cert-manager-munnerz.readthedocs.io/en/stable/admin/resource-validation-webhook.html#tls-configuration" rel="noopener ugc nofollow" target="_blank">的内容。</a></p><p id="e53b" class="pw-post-body-paragraph le lf it lg b lh mc lj lk ll md ln lo lp me lr ls lt mf lv lw lx mg lz ma mb im bi translated">下面是我们从v0.4升级到v0.7.2的步骤:</p><ol class=""><li id="b74e" class="na nb it lg b lh mc ll md lp nc lt nd lx ne mb nf ng nh ni bi translated">备份证书，颁发者，群集颁发者</li><li id="a9d9" class="na nb it lg b lh nj ll nk lp nl lt nm lx nn mb nf ng nh ni bi translated">从kube-system名称空间中删除旧版本的cert-manager(如果您在那里安装了它)</li><li id="d357" class="na nb it lg b lh nj ll nk lp nl lt nm lx nn mb nf ng nh ni bi translated">通过kubectl为证书管理器安装新的CustomResourceDefinitions</li><li id="ad2f" class="na nb it lg b lh nj ll nk lp nl lt nm lx nn mb nf ng nh ni bi translated">创建<code class="fe mh mi mj mk b">cert-manager</code>名称空间并用<code class="fe mh mi mj mk b">certmanager.k8s.io/disable-validation="true"</code>标记它</li><li id="08f9" class="na nb it lg b lh nj ll nk lp nl lt nm lx nn mb nf ng nh ni bi translated">将带有新舵图的新版本证书管理器安装到名为<code class="fe mh mi mj mk b">cert-manager</code>的专用命名空间中</li><li id="05fd" class="na nb it lg b lh nj ll nk lp nl lt nm lx nn mb nf ng nh ni bi translated">恢复我们之前创建的备份</li></ol><p id="58a1" class="pw-post-body-paragraph le lf it lg b lh mc lj lk ll md ln lo lp me lr ls lt mf lv lw lx mg lz ma mb im bi translated">下面是第一步(1)的样子:</p><figure class="mw mx my mz gt ju"><div class="bz fp l di"><div class="no np l"/></div></figure><p id="8fd2" class="pw-post-body-paragraph le lf it lg b lh mc lj lk ll md ln lo lp me lr ls lt mf lv lw lx mg lz ma mb im bi translated">然后，我们可以删除旧版本的cert-manager (2 ),并确保Helm也删除了与cert-manager关联的所有CustomResourceDefinitions:</p><figure class="mw mx my mz gt ju"><div class="bz fp l di"><div class="no np l"/></div></figure><p id="1714" class="pw-post-body-paragraph le lf it lg b lh mc lj lk ll md ln lo lp me lr ls lt mf lv lw lx mg lz ma mb im bi translated">上述错误意味着cert-manager不再存在于我们的群集中。在升级之前，请检查以确保没有与以前版本的cert-manager关联的旧ClusterRoleBindings、ClusterRoles和ServiceAccounts。这可能会与您即将安装的新版本冲突。运行以下命令以确保它们已被删除:</p><figure class="mw mx my mz gt ju"><div class="bz fp l di"><div class="no np l"/></div></figure><p id="4d70" class="pw-post-body-paragraph le lf it lg b lh mc lj lk ll md ln lo lp me lr ls lt mf lv lw lx mg lz ma mb im bi translated">完成后，我们可以为版本<code class="fe mh mi mj mk b">v0.7.2</code>应用新的CRDs (3)(不再与图表捆绑在一起)，然后将所需版本的cert-manager (4，5)安装到cert-manager名称空间中:</p><figure class="mw mx my mz gt ju"><div class="bz fp l di"><div class="no np l"/></div></figure><p id="b2e4" class="pw-post-body-paragraph le lf it lg b lh mc lj lk ll md ln lo lp me lr ls lt mf lv lw lx mg lz ma mb im bi translated">最后，我们将通过运行“ku bectl apply-f cert-manager-backup . YAML”从我们的备份(6)中恢复集群颁发者、颁发者和证书</p><p id="7488" class="pw-post-body-paragraph le lf it lg b lh mc lj lk ll md ln lo lp me lr ls lt mf lv lw lx mg lz ma mb im bi translated">现在，我们已经从一个极其过时的版本的头盔跳到了<code class="fe mh mi mj mk b">v0.7.2</code>！<strong class="lg iu">为了让整个过程对你来说更容易，我起草了一个脚本，应该可以一步到位:</strong></p><figure class="mw mx my mz gt ju"><div class="bz fp l di"><div class="no np l"/></div></figure><h1 id="7f1f" class="kg kh it bd ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld bi translated">第2部分:从v0.7.2到v0.12</h1><p id="7bac" class="pw-post-body-paragraph le lf it lg b lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated">这里是Jetstack提供的文档，它概括了每次升级所需的步骤。每个版本都有不同的需求，其中一些是可选的，后来变成了需求。因此，我不建议跳过多个版本，因为您可能会将自己置于以后环境崩溃的风险中:</p><p id="1453" class="pw-post-body-paragraph le lf it lg b lh mc lj lk ll md ln lo lp me lr ls lt mf lv lw lx mg lz ma mb im bi translated">从v0.7到v0.8: <a class="ae kf" href="https://cert-manager.io/docs/installation/upgrading/upgrading-0.7-0.8/" rel="noopener ugc nofollow" target="_blank">将ACME发行者和证书更新为新格式</a>(不要求，但强烈建议)</p><p id="f585" class="pw-post-body-paragraph le lf it lg b lh mc lj lk ll md ln lo lp me lr ls lt mf lv lw lx mg lz ma mb im bi translated">从v0.8到v0.9: <a class="ae kf" href="https://cert-manager.io/docs/installation/upgrading/upgrading-0.8-0.9/" rel="noopener ugc nofollow" target="_blank">在应用升级之前删除证书管理器部署</a> <em class="ml"/></p><p id="aa26" class="pw-post-body-paragraph le lf it lg b lh mc lj lk ll md ln lo lp me lr ls lt mf lv lw lx mg lz ma mb im bi translated">v0.9到v0.10: <a class="ae kf" href="https://cert-manager.io/docs/installation/upgrading/upgrading-0.9-0.10/" rel="noopener ugc nofollow" target="_blank">删除webhook的发布者和证书资源</a>(仅当使用静态清单时)</p><p id="6c5f" class="pw-post-body-paragraph le lf it lg b lh mc lj lk ll md ln lo lp me lr ls lt mf lv lw lx mg lz ma mb im bi translated">从v0.10到v0.11:在将升级到v0.11 <em class="ml">之前，必须升级ACME发行者和证书<em class="ml">。</em>此外，还有反映新API的注释更改。<a class="ae kf" href="https://cert-manager.io/docs/installation/upgrading/upgrading-0.10-0.11/" rel="noopener ugc nofollow" target="_blank">所有这些都可以在这里找到。</a></em></p><p id="2316" class="pw-post-body-paragraph le lf it lg b lh mc lj lk ll md ln lo lp me lr ls lt mf lv lw lx mg lz ma mb im bi translated">v0.11到v0.12: <a class="ae kf" href="https://cert-manager.io/docs/installation/upgrading/upgrading-0.11-0.12/" rel="noopener ugc nofollow" target="_blank">删除webhook API服务</a></p><p id="a979" class="pw-post-body-paragraph le lf it lg b lh mc lj lk ll md ln lo lp me lr ls lt mf lv lw lx mg lz ma mb im bi translated">从v0.12到v0.3: <a class="ae kf" href="https://cert-manager.io/docs/installation/upgrading/upgrading-0.12-0.13/" rel="noopener ugc nofollow" target="_blank">不需要特殊的升级步骤！</a></p><h1 id="6b38" class="kg kh it bd ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld bi translated">进一步故障排除</h1><p id="5bb8" class="pw-post-body-paragraph le lf it lg b lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated">从备份中恢复证书时，您可能会注意到以下错误:<code class="fe mh mi mj mk b">spec.dnsNames in body must be of type array: "null"</code>。虽然我还不知道为什么会发生这种情况，但是解决它很容易。在我们之前创建的备份中，找到有问题的证书资源中的<code class="fe mh mi mj mk b">dnsNames</code>属性。将其从空值更改为空数组:</p><pre class="mw mx my mz gt nq mk nr ns aw nt bi"><span id="ed53" class="nu kh it mk b gy nv nw l nx ny">apiVersion: certmanager.k8s.io/v1alpha1<br/>kind: Certificate<br/>metadata:<br/>  name: test-ca-crt<br/>spec:<br/>  secretName: test-ca-crt<br/>  commonName: test-ca-certificate<br/>  issuerRef:<br/>    name: ca-issuer<br/>    kind: Issuer<br/>  dnsNames: &lt;---change this to the following below<br/>  dnsNames: []</span></pre><p id="6168" class="pw-post-body-paragraph le lf it lg b lh mc lj lk ll md ln lo lp me lr ls lt mf lv lw lx mg lz ma mb im bi translated">这个GitHub用户很好地分析了如何根据模式验证证书，以及为什么这个特殊的案例会给你一个错误。</p><p id="f806" class="pw-post-body-paragraph le lf it lg b lh mc lj lk ll md ln lo lp me lr ls lt mf lv lw lx mg lz ma mb im bi translated">如果您想回滚到cert-manager的早期版本，您可能还会遇到无法删除<code class="fe mh mi mj mk b">cert-manager</code>名称空间的问题。这可以通过运行<code class="fe mh mi mj mk b">kubectl delete -f</code>删除您随图表安装的所有CRD，并将URL传递给您安装的图表版本的CRD来解决。Jetstack有一个正确删除cert-manager的指南，以及为什么会出现这种情况的解释<a class="ae kf" href="https://cert-manager.io/docs/installation/uninstall/kubernetes/#namespace-stuck-in-terminating-state" rel="noopener ugc nofollow" target="_blank">这里</a>。</p></div></div>    
</body>
</html>