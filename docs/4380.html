<html>
<head>
<title>Stripe, React and Serverless — Part 2</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">条带化、反应式和无服务器—第2部分</h1>
<blockquote>原文：<a href="https://itnext.io/stripe-react-and-serverless-part-2-9d14ec122f10?source=collection_archive---------7-----------------------#2020-06-19">https://itnext.io/stripe-react-and-serverless-part-2-9d14ec122f10?source=collection_archive---------7-----------------------#2020-06-19</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><figure class="ip iq gp gr ir is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi io"><img src="../Images/e6545d82326bedf6ebd5fe44100de498.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*-pxPmUmKDaN3lHECNSnXFg.png"/></div></div></figure><div class=""/><p id="5dc1" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在本系列文章中，我们将讨论如何使用React和无服务器将<a class="ae kw" href="https://sigmetic.io" rel="noopener ugc nofollow" target="_blank"> Sigmetic </a>与Stripe集成。</p><p id="212f" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在<a class="ae kw" href="https://sigmetic.io/blog/stripe-react-serverless-part1" rel="noopener ugc nofollow" target="_blank">第1部分</a>中，我们使用<a class="ae kw" href="https://www.serverless.com/" rel="noopener ugc nofollow" target="_blank">无服务器</a>实现了后端。<br/>在第2部分中，我们将使用<a class="ae kw" href="https://stripe.com/en-dk/payments/elements" rel="noopener ugc nofollow" target="_blank">条带元素</a>在React中集成前端。</p><h1 id="c01d" class="kx ky jb bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">先决条件</h1><p id="7d7a" class="pw-post-body-paragraph jy jz jb ka b kb lv kd ke kf lw kh ki kj lx kl km kn ly kp kq kr lz kt ku kv ij bi translated"><strong class="ka jc"> React应用</strong></p><p id="782b" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我们假设您在React中有一个前端，这是您让客户订阅您的服务的地方。<br/>Stripe最酷的一点是，我们可以在应用程序中本地收集支付信息，而不是重定向到第三方或嵌入iframe表单，这些表单看起来与UI的其余部分完全不同。</p><p id="b398" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">为此我们将使用<a class="ae kw" href="https://stripe.com/en-dk/payments/elements" rel="noopener ugc nofollow" target="_blank">条纹元素</a>。对于<a class="ae kw" href="https://sigmetic.io" rel="noopener ugc nofollow" target="_blank"> Sigmetic </a>，我们有一个如下所示的升级页面</p><figure class="mb mc md me gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi ma"><img src="../Images/1865bc3dc613da81174e61e66c10087c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*WaZI9D0y9HtqfQ86.png"/></div></div></figure><p id="7ec8" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">有了这三样东西，让我们开始吧🔥</p><h1 id="d97b" class="kx ky jb bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">条带管理器</h1><p id="6c96" class="pw-post-body-paragraph jy jz jb ka b kb lv kd ke kf lw kh ki kj lx kl km kn ly kp kq kr lz kt ku kv ij bi translated">为了让您的生活更轻松，我们建议您编写一组实用函数，您可以使用它们向我们在第1部分中实现的云函数发出请求。</p><p id="398b" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">对于<a class="ae kw" href="https://sigmetic.io" rel="noopener ugc nofollow" target="_blank"> Sigmetic </a>，我们用一组<em class="mj">静态</em>方法创建了一个类<code class="fe mf mg mh mi b">StripeManager</code>。<br/>通过这种方式，你可以在整个应用程序中访问类似<code class="fe mf mg mh mi b">StripeManager.createSubscription();</code>的方法。</p><p id="5890" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">如果你更喜欢那个模式，你也可以导出单个函数，然后像这样导入:<br/> <code class="fe mf mg mh mi b">import * as StripeManager from '../services/StripeManager'</code> <br/>。</p><p id="470f" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在这篇文章中，我们将跟随班级。</p><p id="78f5" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">因此，在适当的地方创建一个新文件，比如<code class="fe mf mg mh mi b">src/services/StripeManager.ts</code>，并创建一个新的类定义。</p><figure class="mb mc md me gt is"><div class="bz fp l di"><div class="mk ml l"/></div></figure><h1 id="27d7" class="kx ky jb bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">数据库ˌ资料库</h1><p id="f154" class="pw-post-body-paragraph jy jz jb ka b kb lv kd ke kf lw kh ki kj lx kl km kn ly kp kq kr lz kt ku kv ij bi translated">我们假设您有一个包含用户的数据库。<br/>现在是时候扩展您的用户模型，加入3个新领域了:</p><ul class=""><li id="a3be" class="mm mn jb ka b kb kc kf kg kj mo kn mp kr mq kv mr ms mt mu bi translated"><code class="fe mf mg mh mi b">customerID</code></li><li id="ff42" class="mm mn jb ka b kb mv kf mw kj mx kn my kr mz kv mr ms mt mu bi translated"><code class="fe mf mg mh mi b">paymentMethodID</code></li><li id="8459" class="mm mn jb ka b kb mv kf mw kj mx kn my kr mz kv mr ms mt mu bi translated"><code class="fe mf mg mh mi b">subscriptionID</code></li><li id="d918" class="mm mn jb ka b kb mv kf mw kj mx kn my kr mz kv mr ms mt mu bi translated"><code class="fe mf mg mh mi b">hasPaidPlan</code></li></ul><p id="02f1" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">对于<a class="ae kw" href="https://sigmetic.io" rel="noopener ugc nofollow" target="_blank"> Sigmetic </a>，我们使用GraphQL和DynamoDB。</p><blockquote class="na nb nc"><p id="a0df" class="jy jz mj ka b kb kc kd ke kf kg kh ki nd kk kl km ne ko kp kq nf ks kt ku kv ij bi translated">阅读更多关于<a class="ae kw" href="https://sigmetic.io/blog/sigmetic-grads-stack" rel="noopener ugc nofollow" target="_blank">毕业生的信息:Sigmetic </a>的技术堆栈</p></blockquote><p id="c795" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我们将提到何时对数据库进行写/读操作，但是我们不会在本文中进一步讨论实现细节。</p><h1 id="df21" class="kx ky jb bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">创建新客户</h1><p id="358b" class="pw-post-body-paragraph jy jz jb ka b kb lv kd ke kf lw kh ki kj lx kl km kn ly kp kq kr lz kt ku kv ij bi translated">首先，让我们创建一个表示Stripe客户的接口。创建一个新文件<code class="fe mf mg mh mi b">src/interfaces/IStripeCustomer</code>:</p><figure class="mb mc md me gt is"><div class="bz fp l di"><div class="mk ml l"/></div></figure><blockquote class="na nb nc"><p id="3519" class="jy jz mj ka b kb kc kd ke kf kg kh ki nd kk kl km ne ko kp kq nf ks kt ku kv ij bi translated"><em class="jb">💡</em>提示:使用<a class="ae kw" href="http://json2ts.com/" rel="noopener ugc nofollow" target="_blank"> json2ts </a>从json快速创建TypeScript接口。</p></blockquote><p id="2994" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">现在，让我们创建一个创建新客户的方法</p><figure class="mb mc md me gt is"><div class="bz fp l di"><div class="mk ml l"/></div></figure><p id="3993" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">现在，让我们创建一个检索customerID的方法，如果不存在，使用上面的方法创建一个新的方法。</p><figure class="mb mc md me gt is"><div class="bz fp l di"><div class="mk ml l"/></div></figure><h1 id="f70a" class="kx ky jb bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">创建订阅</h1><p id="bc9f" class="pw-post-body-paragraph jy jz jb ka b kb lv kd ke kf lw kh ki kj lx kl km kn ly kp kq kr lz kt ku kv ij bi translated">同样，让我们为条带订阅创建一个新接口:创建一个新文件<code class="fe mf mg mh mi b">src/interfaces/IStripeSubscription</code>:</p><figure class="mb mc md me gt is"><div class="bz fp l di"><div class="mk ml l"/></div></figure><p id="cd3d" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">然后，让我们创建一个创建新订阅的方法:</p><figure class="mb mc md me gt is"><div class="bz fp l di"><div class="mk ml l"/></div></figure><p id="d953" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">现在，让我们添加一个更新订阅的方法。</p><figure class="mb mc md me gt is"><div class="bz fp l di"><div class="mk ml l"/></div></figure><p id="0b0f" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">最后，一个用于检索订阅</p><figure class="mb mc md me gt is"><div class="bz fp l di"><div class="mk ml l"/></div></figure><h1 id="3906" class="kx ky jb bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">更新付款方式</h1><p id="f29b" class="pw-post-body-paragraph jy jz jb ka b kb lv kd ke kf lw kh ki kj lx kl km kn ly kp kq kr lz kt ku kv ij bi translated">好了，现在我们只需要多一些方法。</p><p id="35e6" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">让我们添加一个用于更新支付方式的:</p><figure class="mb mc md me gt is"><div class="bz fp l di"><div class="mk ml l"/></div></figure><p id="4f40" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我们还希望能够检索支付信息，所以让我们为此也添加一个方法:</p><figure class="mb mc md me gt is"><div class="bz fp l di"><div class="mk ml l"/></div></figure><h1 id="e6c8" class="kx ky jb bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">重试发票</h1><p id="e715" class="pw-post-body-paragraph jy jz jb ka b kb lv kd ke kf lw kh ki kj lx kl km kn ly kp kq kr lz kt ku kv ij bi translated">好吧！剩下的就是重试发票支付的方法。</p><figure class="mb mc md me gt is"><div class="bz fp l di"><div class="mk ml l"/></div></figure><p id="44d9" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">就是这样！💪<br/>stripe manager完成了！</p><h1 id="4c45" class="kx ky jb bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">付款表格</h1><p id="9179" class="pw-post-body-paragraph jy jz jb ka b kb lv kd ke kf lw kh ki kj lx kl km kn ly kp kq kr lz kt ku kv ij bi translated">现在，让我们进入有趣的部分:付款形式。<br/>在React代码方面，我们将在这里做一些简化。但我们会确保这一点是明确的。</p><p id="21c9" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">首先，你需要去你的Stripe <em class="mj">仪表盘- &gt;开发者- &gt; API密匙</em>并抓取<em class="mj"> public </em>密匙。让我们将它存储在一个<code class="fe mf mg mh mi b">.env</code>文件中:</p><pre class="mb mc md me gt ng mi nh ni aw nj bi"><span id="9e20" class="nk ky jb mi b gy nl nm l nn no">REACT_APP_STRIPE_KEY=&lt;PUT-YOUR-KEY-HERE&gt;</span></pre><p id="2d57" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">接下来，让我们安装几个条带依赖项:</p><pre class="mb mc md me gt ng mi nh ni aw nj bi"><span id="5720" class="nk ky jb mi b gy nl nm l nn no">npm install @stripe/react-stripe-js @stripe/stripe-js</span></pre><p id="33d8" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">让我们为付款表单创建一个新组件:<code class="fe mf mg mh mi b">src/component/upgrade.tsx</code></p><p id="f9ed" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">现在，我们开始导入所需的依赖项:</p><figure class="mb mc md me gt is"><div class="bz fp l di"><div class="mk ml l"/></div></figure><blockquote class="na nb nc"><p id="631c" class="jy jz mj ka b kb kc kd ke kf kg kh ki nd kk kl km ne ko kp kq nf ks kt ku kv ij bi translated"><em class="jb"> ℹ️ </em>您还可以为整张信用卡导入单个元素:<em class="jb"><br/></em><code class="fe mf mg mh mi b">import { CardElement } from '@stripe/react-stripe-js'</code><em class="jb"><br/></em>在本例中，我们将为卡号、到期日和cvc <em class="jb">使用单个元素。</em></p></blockquote><p id="f156" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">让我们开始创建React组件:</p><figure class="mb mc md me gt is"><div class="bz fp l di"><div class="mk ml l"/></div></figure><p id="a9d1" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">组件将成为支付表单的容器。<br/>表单被包装在由<code class="fe mf mg mh mi b">react-stripe-react</code>提供的<code class="fe mf mg mh mi b">Elements</code>组件中。<br/>我们需要将Stripe上的“promisified”实例传递给该组件。</p><p id="c182" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">现在，让我们创建<code class="fe mf mg mh mi b">CheckoutForm</code>组件:</p><figure class="mb mc md me gt is"><div class="bz fp l di"><div class="mk ml l"/></div></figure><p id="f313" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">您应该能够看到您的付款表单呈现😎</p><p id="bdbd" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">现在，让我们实现那个<code class="fe mf mg mh mi b">handleSubmitPayment</code>函数:</p><figure class="mb mc md me gt is"><div class="bz fp l di"><div class="mk ml l"/></div></figure><p id="ba6d" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">最后，让我们实现<code class="fe mf mg mh mi b">handleRetryPayment</code>函数:</p><figure class="mb mc md me gt is"><div class="bz fp l di"><div class="mk ml l"/></div></figure><p id="274a" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">就是这样！😎<br/>付款表单现在应该可以工作了！<br/>现在你只需要添加一些样式，也许是一些额外的卡片名称输入的错误处理，等等。</p><h1 id="3c78" class="kx ky jb bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">管理当前订阅</h1><p id="6e9b" class="pw-post-body-paragraph jy jz jb ka b kb lv kd ke kf lw kh ki kj lx kl km kn ly kp kq kr lz kt ku kv ij bi translated">我们需要创建的最后一件事是让用户管理他们的订阅。<br/>至少，他们应该能够取消他们的订阅，看到和改变他们的支付方式。</p><p id="6eb8" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">让我们在一个新的组件中实现它。<br/>对于<a class="ae kw" href="https://sigmetic.io" rel="noopener ugc nofollow" target="_blank"> Sigmetic </a>，我们有这样的东西:</p><figure class="mb mc md me gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi np"><img src="../Images/729ce5891be7a642c4161bb29be0bec6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*tx0a2NpEkOGnElAF.png"/></div></div></figure><p id="3cbe" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">让我们创建一个新组件:<code class="fe mf mg mh mi b">src/components/Plan.tsx</code></p><figure class="mb mc md me gt is"><div class="bz fp l di"><div class="mk ml l"/></div></figure><p id="c05e" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我们在这里跳过了许多标记和样式——这将完全取决于您😉</p><p id="3361" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">让我们实现<code class="fe mf mg mh mi b">handleCancelSubscription</code>方法:</p><figure class="mb mc md me gt is"><div class="bz fp l di"><div class="mk ml l"/></div></figure><p id="6ffd" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">很直接，对吧！<br/>最后，让我们实现<code class="fe mf mg mh mi b">UpdateForm</code>组件。</p><figure class="mb mc md me gt is"><div class="bz fp l di"><div class="mk ml l"/></div></figure><p id="6000" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">最后是<code class="fe mf mg mh mi b">handleUpdatePaymentMethod</code>功能:</p><figure class="mb mc md me gt is"><div class="bz fp l di"><div class="mk ml l"/></div></figure><h1 id="9a09" class="kx ky jb bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">舍入</h1><p id="4756" class="pw-post-body-paragraph jy jz jb ka b kb lv kd ke kf lw kh ki kj lx kl km kn ly kp kq kr lz kt ku kv ij bi translated">好了🎉🎉<br/>我们完成了集成！</p><p id="7c6c" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">当然，我们忽略了相当多的样式、数据库连接等。这些是特定于您的应用程序的，与本文没有太大关系。</p><p id="cb06" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">正如开头提到的——有很多不同的方法来处理这个问题，这篇文章简单地解释了我们在<a class="ae kw" href="https://sigmetic.io" rel="noopener ugc nofollow" target="_blank"> Sigmetic </a>是如何处理的！</p><p id="2f5b" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">你有没有看到什么不寻常、奇怪或不安全的事情？请不要犹豫伸出手来！！我们想知道。</p><p id="2cc4" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">有什么问题或困惑吗？也请联系我们——我们很乐意回答任何可能出现的问题🔥</p></div></div>    
</body>
</html>