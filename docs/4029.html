<html>
<head>
<title>Azure DevOps Pipelines: Conditionals in YAML</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Azure DevOps管道:YAML的条件</h1>
<blockquote>原文：<a href="https://itnext.io/azure-devops-pipelines-conditionals-in-yaml-735cc7d4c226?source=collection_archive---------5-----------------------#2020-04-13">https://itnext.io/azure-devops-pipelines-conditionals-in-yaml-735cc7d4c226?source=collection_archive---------5-----------------------#2020-04-13</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="56dc" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在本周的帖子中，我们将介绍一些让任务和作业有条件运行的方法。这将包括诸如依赖于其他作业的作业的管道变量等选项。这篇文章将使用一个在过去几周的文章中构建的示例Azure DevOps项目。如果你想看这个集结，看看下面的帖子。</p><p id="ac47" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><a class="ae kl" href="https://elanderson.net/2020/02/getting-started-with-azure-devops/" rel="noopener ugc nofollow" target="_blank">Azure devo PS入门</a><br/><a class="ae kl" href="https://elanderson.net/2020/03/pipeline-creation-in-azure-devops/" rel="noopener ugc nofollow" target="_blank">Azure devo PS中的管道创建</a> <br/> <a class="ae kl" href="https://elanderson.net/2020/03/azure-devops-publish-asp-net-core/" rel="noopener ugc nofollow" target="_blank"> Azure DevOps为ASP.NET核心发布工件</a> <br/> <a class="ae kl" href="https://elanderson.net/2020/03/azure-devops-pipelines-multiple-jobs-in-yaml/" rel="noopener ugc nofollow" target="_blank"> Azure DevOps管道:YAML的多个作业</a> <br/> <a class="ae kl" href="https://elanderson.net/2020/03/azure-devops-pipelines-reuseable-yaml/" rel="noopener ugc nofollow" target="_blank"> Azure DevOps管道:可重用YAML </a> <br/> <a class="ae kl" href="https://elanderson.net/2020/04/azure-devops-pipelines-use-yaml-across-repos/" rel="noopener ugc nofollow" target="_blank"> Azure DevOps管道:跨Repos使用YAML</a></p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div class="gh gi km"><img src="../Images/2a29acdaa8d332d6935e79ece509d32b.png" data-original-src="https://miro.medium.com/v2/resize:fit:600/format:webp/0*ogTTPe4dvC5G1moY.png"/></div></figure><h2 id="7724" class="ku kv iq bd kw kx ky dn kz la lb dp lc jy ld le lf kc lg lh li kg lj lk ll lm bi translated">YAML样本</h2><p id="841a" class="pw-post-body-paragraph jn jo iq jp b jq ln js jt ju lo jw jx jy lp ka kb kc lq ke kf kg lr ki kj kk ij bi translated">下面的YAML是基于以前帖子中的YAML，通过使用一些有条件地运行一些任务或作业的方法的例子进行了扩展。这是完整的参考文件，文章的其余部分将根据需要调出文件的特定部分。</p><pre class="kn ko kp kq gt ls lt lu lv aw lw bi"><span id="b085" class="ku kv iq lt b gy lx ly l lz ma">resources:      <br/>  repositories: <br/>  - repository: Shared<br/>    name: Playground/Shared<br/>    type: git <br/>    ref: master #branch name<br/><br/>trigger: none<br/><br/>variables:<br/>  buildConfiguration: 'Release'<br/><br/>jobs:<br/>- job: WebApp1<br/>  displayName: 'Build WebApp1'<br/>  pool:<br/>    vmImage: 'ubuntu-latest'<br/><br/>  steps:<br/>  - template: buildCoreWebProject.yml@Shared<br/>    parameters:<br/>      buildConFiguration: $(buildConfiguration)<br/>      project: WebApp1.csproj<br/>      artifactName: WebApp1<br/><br/>- job: WebApp2<br/>  displayName: 'Build WebApp2'<br/>  condition: and(succeeded(), eq(variables['BuildWebApp2'], 'true'))<br/>  pool:<br/>    vmImage: 'ubuntu-latest'<br/><br/>  steps:<br/>  - template: build.yml<br/>    parameters:<br/>      buildConFiguration: $(buildConfiguration)<br/>      project: WebApp2.csproj<br/>      artifactName: WebApp2<br/>      <br/>- job: DependentJob<br/>  displayName: 'Build Dependent Job'<br/>  pool:<br/>    vmImage: 'ubuntu-latest'<br/><br/>  dependsOn:<br/>  - WebApp1<br/>  - WebApp2<br/><br/>  steps:<br/>  - template: buildCoreWebProject.yml@Shared<br/>    parameters:<br/>      buildConFiguration: $(buildConfiguration)<br/>      project: WebApp1.csproj<br/>      artifactName: WebApp1Again</span></pre><h2 id="adf6" class="ku kv iq bd kw kx ky dn kz la lb dp lc jy ld le lf kc lg lh li kg lj lk ll lm bi translated">作业相关性</h2><p id="95c1" class="pw-post-body-paragraph jn jo iq jp b jq ln js jt ju lo jw jx jy lp ka kb kc lq ke kf kg lr ki kj kk ij bi translated">管道越复杂，管道越有可能在其他作业完成之前无法运行某个作业。上面的YAML定义了三个不同的作业，WebApp1、WebApp2和DependentJob。我相信您现在已经猜到第三份工作是有依赖关系的工作。为了使一个作业依赖于其他作业，我们使用<strong class="jp ir"> dependsOn </strong>元素，并列出在相关作业运行之前必须完成的作业。以下是示例DependentJob的YAML，其中突出显示了<strong class="jp ir">依赖于</strong>部分。</p><pre class="kn ko kp kq gt ls lt lu lv aw lw bi"><span id="ed59" class="ku kv iq lt b gy lx ly l lz ma">- job: DependentJob<br/>  displayName: 'Build Dependent Job'<br/>  pool:<br/>    vmImage: 'ubuntu-latest'<br/><br/>  dependsOn:<br/>  - WebApp1<br/>  - WebApp2<br/><br/>  steps:<br/>  - template: buildCoreWebProject.yml@Shared<br/>    parameters:<br/>      buildConFiguration: $(buildConfiguration)<br/>      project: WebApp1.csproj<br/>      artifactName: WebApp1Again</span></pre><p id="62c7" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">通过上述设置，只有在WebApp1和WebApp2作业都成功完成的情况下，DependentJob才会运行。</p><h2 id="789b" class="ku kv iq bd kw kx ky dn kz la lb dp lc jy ld le lf kc lg lh li kg lj lk ll lm bi translated">情况</h2><p id="95f1" class="pw-post-body-paragraph jn jo iq jp b jq ln js jt ju lo jw jx jy lp ka kb kc lq ke kf kg lr ki kj kk ij bi translated">条件是控制作业或任务是否运行的一种方式。以下示例是在作业级别，但同样的概念也适用于任务级别。注意突出显示的<strong class="jp ir">状态</strong>。</p><pre class="kn ko kp kq gt ls lt lu lv aw lw bi"><span id="9858" class="ku kv iq lt b gy lx ly l lz ma">- job: WebApp2<br/>  displayName: 'Build WebApp2'<br/>  condition: and(succeeded(), eq(variables['BuildWebApp2'], 'true'))<br/>  pool:<br/>    vmImage: 'ubuntu-latest'<br/><br/>  steps:<br/>  - template: build.yml<br/>    parameters:<br/>      buildConFiguration: $(buildConfiguration)<br/>      project: WebApp2.csproj<br/>      artifactName: WebApp2</span></pre><p id="16ee" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果<strong class="jp ir"> BuildWebApp2 </strong>变量不为真，上述条件将导致WebApp2作业被跳过。有关如何使用条件的更多详细信息，请参见<a class="ae kl" href="https://docs.microsoft.com/en-us/azure/devops/pipelines/process/conditions?view=azure-devops&amp;tabs=yaml" rel="noopener ugc nofollow" target="_blank">条件文档</a>。</p><h2 id="647e" class="ku kv iq bd kw kx ky dn kz la lb dp lc jy ld le lf kc lg lh li kg lj lk ll lm bi translated">创建管道变量</h2><p id="5f97" class="pw-post-body-paragraph jn jo iq jp b jq ln js jt ju lo jw jx jy lp ka kb kc lq ke kf kg lr ki kj kk ij bi translated">本文的其余部分将介绍如何创建一个管道变量，然后运行一些示例构建，以展示以上YAML中定义的依赖和条件如何影响管道结果。</p><p id="0ec9" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们从已经在编辑的现有管道开始。要添加(或编辑)变量，点击屏幕右上角的<strong class="jp ir">变量</strong>按钮。</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="mc md di me bf mf"><div class="gh gi mb"><img src="../Images/9f555d1d3ddea08f88c8d8f3ee1118b6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*3R1RMWRYkvNfMlgN.png"/></div></div></figure><p id="c65f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">将显示弹出的变量。如果我们有现有的变量，它们显示在这里。点击<strong class="jp ir">新变量</strong>按钮添加一个新变量。</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="mc md di me bf mf"><div class="gh gi mg"><img src="../Images/e32958e433c195c290d75a0be36489d4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*aj46xHuDQyW5HNHT.png"/></div></div></figure><p id="bf49" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们正在添加一个变量，它将控制名为<strong class="jp ir"> BuildWebApp2 </strong>的WebApp2的构建，该变量默认为<strong class="jp ir"> true </strong>的值。此外，确保选中<strong class="jp ir">让用户在运行此管道时覆盖此值</strong>复选框，以便我们在运行管道时编辑此变量。然后点击<strong class="jp ir">确定</strong>按钮。</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="mc md di me bf mf"><div class="gh gi mh"><img src="../Images/419500aa73019e295cb9553af348b557.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*MaiUelwpmiklfGdv.png"/></div></div></figure><p id="f6a2" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">回到变量对话框，点击<strong class="jp ir">保存</strong>按钮。</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="mc md di me bf mf"><div class="gh gi mi"><img src="../Images/27d98fc1536cd26c22f43f5743894690.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*4_fz8OUj34SWEDR4.png"/></div></div></figure><h2 id="38c3" class="ku kv iq bd kw kx ky dn kz la lb dp lc jy ld le lf kc lg lh li kg lj lk ll lm bi translated">启动管道时编辑变量</h2><p id="2762" class="pw-post-body-paragraph jn jo iq jp b jq ln js jt ju lo jw jx jy lp ka kb kc lq ke kf kg lr ki kj kk ij bi translated">现在我们的管道有了一个变量，当在<strong class="jp ir">高级选项</strong>下运行管道时，你会看到<strong class="jp ir">变量</strong>部分显示我们的管道定义了1个变量。点击<strong class="jp ir">变量</strong>查看/编辑将用于本次管道运行的变量。</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="mc md di me bf mf"><div class="gh gi mj"><img src="../Images/c9592130bff7988039f372c8509cbcca.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*iuTjn2q9m7ZPvoHY.png"/></div></div></figure><p id="d1d0" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在Variables部分，您将看到一个已定义变量的列表，以及一个添加新变量的选项，这些变量只存在于管道的这一段中。单击<strong class="jp ir"> BuildWebApp2 </strong>变量，编辑将用于管道运行的值。</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="mc md di me bf mf"><div class="gh gi mk"><img src="../Images/086254b8a7f8bedd692f94869f0a8f81.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*B04HfuY46m1FFeju.png"/></div></div></figure><p id="adeb" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在“更新变量”对话框中，您可以更改变量的值。完成后点击<strong class="jp ir">更新</strong>按钮。</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="mc md di me bf mf"><div class="gh gi mj"><img src="../Images/42a0d82196ae0f3b4658eba57ddb9038.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*tKNjjh3hhDpsmLIH.png"/></div></div></figure><h2 id="8bc3" class="ku kv iq bd kw kx ky dn kz la lb dp lc jy ld le lf kc lg lh li kg lj lk ll lm bi translated">来自YAML样本的管道结果</h2><p id="326a" class="pw-post-body-paragraph jn jo iq jp b jq ln js jt ju lo jw jx jy lp ka kb kc lq ke kf kg lr ki kj kk ij bi translated">下面是我们的示例管道在将<strong class="jp ir"> BuildWebApp2 </strong>变量设置为false时的样子。如您所见，该作业将被跳过。</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="mc md di me bf mf"><div class="gh gi mb"><img src="../Images/3c9dc27d9797403da9f6fabda7110950.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*OqJdIk2dUuHIy6uS.png"/></div></div></figure><p id="4b31" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">接下来是管道运行的完整结果。您可以看到依赖于构建的作业也被跳过，因为构建WebApp1和构建WebApp2必须成功完成才能运行。</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="mc md di me bf mf"><div class="gh gi mb"><img src="../Images/b859de586911fef26def5be8198e0b62.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*R3SzmE9bYXZHFolq.png"/></div></div></figure><p id="b58b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">将BuildWebApp2变量改回true并再次运行管道会导致所有作业成功运行。</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="mc md di me bf mf"><div class="gh gi mb"><img src="../Images/c772b8233aa4625327587744407ba039.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*S75MtCls0pSwyaOk.png"/></div></div></figure><h2 id="4106" class="ku kv iq bd kw kx ky dn kz la lb dp lc jy ld le lf kc lg lh li kg lj lk ll lm bi translated">包扎</h2><p id="e2cb" class="pw-post-body-paragraph jn jo iq jp b jq ln js jt ju lo jw jx jy lp ka kb kc lq ke kf kg lr ki kj kk ij bi translated">希望这有助于向您介绍一些控制管道的方法。与其他所有东西一样，Azure DevOps相关的东西正在发生很大的变化，新的选项一直在涌现。例如，在写这篇文章的时候，团队刚刚宣布了运行时参数,这看起来比在管道运行之间频繁变化的值的变量更好。</p></div><div class="ab cl ml mm hu mn" role="separator"><span class="mo bw bk mp mq mr"/><span class="mo bw bk mp mq mr"/><span class="mo bw bk mp mq"/></div><div class="ij ik il im in"><p id="a2b3" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><em class="ms">原载于</em> <a class="ae kl" href="https://elanderson.net/2020/04/azure-devops-pipelines-conditionals-in-yaml/" rel="noopener ugc nofollow" target="_blank"> <em class="ms">安德森</em> </a> <em class="ms">。</em></p></div></div>    
</body>
</html>