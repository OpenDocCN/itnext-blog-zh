<html>
<head>
<title>Kubernetes multi-cluster networking made simple</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Kubernetes简化了多集群网络</h1>
<blockquote>原文：<a href="https://itnext.io/kubernetes-multi-cluster-networking-made-simple-c8f26827813?source=collection_archive---------1-----------------------#2018-12-19">https://itnext.io/kubernetes-multi-cluster-networking-made-simple-c8f26827813?source=collection_archive---------1-----------------------#2018-12-19</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="dfb3" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">TL；DR: </strong>为了便于扩展，Kubernetes多集群网络应该简单。如果您不想担心复杂的路由、覆盖网络、隧道或者必须加密集群之间的流量(假设您的应用程序已经在这样做)，那么透明地运行IPv6应该会有所帮助。</p><p id="46f3" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我刚从<a class="ae kl" href="https://events.linuxfoundation.org/events/kubecon-cloudnativecon-north-america-2018/" rel="noopener ugc nofollow" target="_blank"> Kubecon NA 2018 </a>回来，在那里我有机会参加了非常鼓舞人心的会议，从不同角度介绍了Kubernetes多集群网络。其中包括:</p><ul class=""><li id="169a" class="km kn iq jp b jq jr ju jv jy ko kc kp kg kq kk kr ks kt ku bi translated"><a class="ae kl" href="https://codelabs.developers.google.com/codelabs/istio-multi-burst/#0" rel="noopener ugc nofollow" target="_blank">使用Istio Multicluster在集群之间“爆发”工作负载</a> ( <a class="ae kl" href="https://twitter.com/colnels" rel="noopener ugc nofollow" target="_blank">科林·尼尔森</a>)</li><li id="1381" class="km kn iq jp b jq kv ju kw jy kx kc ky kg kz kk kr ks kt ku bi translated"><a class="ae kl" href="https://www.youtube.com/watch?v=-gPnYTI70FE" rel="noopener ugc nofollow" target="_blank">一路向下的集群:疯狂的多集群拓扑</a> ( <a class="ae kl" href="https://www.oort.io/" rel="noopener ugc nofollow" target="_blank">马特·考尔菲尔德</a>)</li><li id="6d38" class="km kn iq jp b jq kv ju kw jy kx kc ky kg kz kk kr ks kt ku bi translated"><a class="ae kl" href="https://www.youtube.com/watch?v=nNjWrAjzgr8" rel="noopener ugc nofollow" target="_blank">跨Kubernetes集群运行分布式系统</a> : ( <a class="ae kl" href="https://twitter.com/alexwritescode" rel="noopener ugc nofollow" target="_blank"> Alex Robinson </a>)</li><li id="c547" class="km kn iq jp b jq kv ju kw jy kx kc ky kg kz kk kr ks kt ku bi translated"><a class="ae kl" href="https://www.youtube.com/watch?v=U34lQ8KbQow" rel="noopener ugc nofollow" target="_blank">跨云提供商连接Kubernetes集群</a> ( <a class="ae kl" href="https://twitter.com/tgraf__" rel="noopener ugc nofollow" target="_blank">托马斯·格拉夫</a>)</li></ul><p id="096a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我无法停止思考IPv6将给多集群网络带来的好处。毕竟凯尔西在他的主题演讲中说过:</p><blockquote class="la"><p id="98ba" class="lb lc iq bd ld le lf lg lh li lj kk dk translated">人们无视过去，一事无成。然后灯泡灭了，说；嘿，也许这是一个新问题，但也许旧的解决方案就是答案。这就是诀窍。</p><p id="5c3a" class="lb lc iq bd ld le lf lg lh li lj kk dk translated">―凯尔西·海塔尔</p></blockquote><h1 id="6725" class="ll lm iq bd ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi bi translated"><strong class="ak">多集群网络(私有IPv4地址空间)</strong></h1><p id="6107" class="pw-post-body-paragraph jn jo iq jp b jq mj js jt ju mk jw jx jy ml ka kb kc mm ke kf kg mn ki kj kk ij bi translated">如果你不熟悉Kubernetes —单集群—联网，可以参考我之前的帖子；<a class="ae kl" href="https://medium.com/@nicolasleiva/kubernetes-networking-behind-the-scenes-39a1ab1792bb" rel="noopener"> Kubernetes联网:幕后</a>或者查看这些<a class="ae kl" href="https://github.com/nleiva/kubernetes-networking-links" rel="noopener ugc nofollow" target="_blank"> Kubernetes联网链接</a>。</p><p id="4ced" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在，为什么要运行多个集群。嗯，我不打算在这里讨论这个问题，因为Matt Caulfield在他的演讲中很好地解释了原因，而Thomas Graf在他的演讲中展示了非常有说服力的使用案例；高可用性、共享服务、疏散(集群升级)等。</p><figure class="mp mq mr ms gt mt gh gi paragraph-image"><div role="button" tabindex="0" class="mu mv di mw bf mx"><div class="gh gi mo"><img src="../Images/39b4570f3daa86e8ba9e70bf52c601d4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*He2n5K7120iu4ZjSx5_7Tg.png"/></div></div></figure><p id="138e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">那么，怎样才能实现舱对舱的通信呢？首先，我们需要定义如何将<code class="fe na nb nc nd b">pod</code>网络路由到本地集群之外，这不是你的<code class="fe na nb nc nd b">CNI</code>插件通常会做的事情。您还需要制定一个寻址方案，因为您不希望在您的集群之间运行重叠的IP地址，否则这将不起作用…我们是在通过隧道传输流量吗？运行新的覆盖网络？加密流量以便在互联网上传输？这个清单还在继续。</p><p id="a460" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">听起来太复杂了，不是吗？然而，请记住，这主要是因为我们的<code class="fe na nb nc nd b">pod</code>网络使用了私有IPv4地址。为什么？因为根本没有足够的公共IPv4地址来应对微服务的激增。</p><p id="716b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">让我们看看支持这一点的不同拓扑。</p><h2 id="e391" class="ne lm iq bd ln nf ng dn lr nh ni dp lv jy nj nk lz kc nl nm md kg nn no mh np bi translated">2簇？</h2><p id="5da7" class="pw-post-body-paragraph jn jo iq jp b jq mj js jt ju mk jw jx jy ml ka kb kc mm ke kf kg mn ki kj kk ij bi translated">1个VPN隧道，小菜一碟。可能是在两个云提供商之间，或者只是其中一个和您的本地集群之间。如果您在同一个云提供商中有两个集群，您通常<strong class="jp ir">不需要这样做。</strong></p><figure class="mp mq mr ms gt mt gh gi paragraph-image"><div role="button" tabindex="0" class="mu mv di mw bf mx"><div class="gh gi nq"><img src="../Images/f1f7195058c435fee510418641fbaf4e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*nIaCrCTNWy5y3hTdM1D_5Q.png"/></div></div></figure><p id="51c6" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">可能有2个VPN隧道用于冗余。还是可控的。</p><figure class="mp mq mr ms gt mt gh gi paragraph-image"><div role="button" tabindex="0" class="mu mv di mw bf mx"><div class="gh gi nq"><img src="../Images/0e770b5db94cc5d20b249fb346ab2f2a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*8D0FdJBBpQetRaeLJ_d4AQ.png"/></div></div></figure><h2 id="3163" class="ne lm iq bd ln nf ng dn lr nh ni dp lv jy nj nk lz kc nl nm md kg nn no mh np bi translated">3簇？</h2><p id="de24" class="pw-post-body-paragraph jn jo iq jp b jq mj js jt ju mk jw jx jy ml ka kb kc mm ke kf kg mn ki kj kk ij bi translated">也许你的分布式应用需要一个仲裁器？如果你还建立了冗余连接，你或许可以称之为“<em class="nr">成功的连体三角形</em>”。同样，不一定是三个不同的云提供商。</p><figure class="mp mq mr ms gt mt gh gi paragraph-image"><div role="button" tabindex="0" class="mu mv di mw bf mx"><div class="gh gi nq"><img src="../Images/fe65e1518091a3f10b68b8258d774bd1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*5xsoQ3m94Y32VGBPSECncQ.png"/></div></div></figure><h2 id="c61c" class="ne lm iq bd ln nf ng dn lr nh ni dp lv jy nj nk lz kc nl nm md kg nn no mh np bi">3+ ?</h2><p id="4879" class="pw-post-body-paragraph jn jo iq jp b jq mj js jt ju mk jw jx jy ml ka kb kc mm ke kf kg mn ki kj kk ij bi translated">您的拓扑有不同的设计方案；轴辐式、全网状等。所有这些都各有利弊。</p><p id="2776" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">轮毂和辐条</strong></p><figure class="mp mq mr ms gt mt gh gi paragraph-image"><div role="button" tabindex="0" class="mu mv di mw bf mx"><div class="gh gi ns"><img src="../Images/20e8a8019d08114bd40f03acf256eb20.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Mvu-h4E9w8CWbf2GJz6AsQ.png"/></div></div></figure><p id="61e0" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">全网状</strong></p><figure class="mp mq mr ms gt mt gh gi paragraph-image"><div role="button" tabindex="0" class="mu mv di mw bf mx"><div class="gh gi nt"><img src="../Images/98073dbdcd4a4c44a27814ad1933d270.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*CTb_SExqKeAC9qWLj3QusQ.png"/></div></div></figure><p id="94a4" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在不成为运营噩梦的情况下，这个规模还能扩大多少？在这种情况下，一个完整的网格要求<code class="fe na nb nc nd b">N*(N-1)/2</code>与<code class="fe na nb nc nd b">N</code>的互连等于集群的数量。</p><p id="e509" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">有一些解决方案试图解决这个问题，比如<code class="fe na nb nc nd b">SD-WAN</code>。但是为了这篇文章，让我们看看如果我们只使用公共IPv6地址会是什么样子。</p><h1 id="f689" class="ll lm iq bd ln lo lp lq lr ls lt lu lv lw nu ly lz ma nv mc md me nw mg mh mi bi translated"><strong class="ak">多集群联网(公共IPv6地址空间)</strong></h1><p id="c99b" class="pw-post-body-paragraph jn jo iq jp b jq mj js jt ju mk jw jx jy ml ka kb kc mm ke kf kg mn ki kj kk ij bi translated">为什么使用IPv6？因为"<em class="nr">我们可以为地球表面的每一个原子分配一个公共IPv6地址，并且仍然有足够的地址来再分配100多个地球</em>"[<a class="ae kl" href="https://itknowledgeexchange.techtarget.com/whatis/ipv6-addresses-how-many-is-that-in-numbers/" rel="noopener ugc nofollow" target="_blank">源</a></p><p id="f59c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">让我们看看这是什么样子，并讨论对特殊路由、加密或隧道以及冗余连接的需求。我们需要这些吗？有哪些弊端？客观地看，这是一个3集群设置的拓扑结构。</p><figure class="mp mq mr ms gt mt gh gi paragraph-image"><div role="button" tabindex="0" class="mu mv di mw bf mx"><div class="gh gi nx"><img src="../Images/ab65a9856fcdfbc5d544a08e0744e976.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*xEuRtkwWSsNA0vMsI2tsiw.png"/></div></div></figure><h2 id="a698" class="ne lm iq bd ln nf ng dn lr nh ni dp lv jy nj nk lz kc nl nm md kg nn no mh np bi translated">按指定路线发送</h2><p id="c4b0" class="pw-post-body-paragraph jn jo iq jp b jq mj js jt ju mk jw jx jy ml ka kb kc mm ke kf kg mn ki kj kk ij bi translated">我们将跨地区联网移交给您的底层基础设施/互联网。不需要特殊的路由，不需要在集群之间建立冗余连接。它可能扩展到任意数量的集群…一切都是免费的；有什么条件？是时候谈谈安全问题了。</p><h2 id="7ec6" class="ne lm iq bd ln nf ng dn lr nh ni dp lv jy nj nk lz kc nl nm md kg nn no mh np bi translated">安全性</h2><p id="4484" class="pw-post-body-paragraph jn jo iq jp b jq mj js jt ju mk jw jx jy ml ka kb kc mm ke kf kg mn ki kj kk ij bi translated">我知道你在想什么…我们正在把我们的内部基础设施暴露给互联网。⚠️</p><p id="5749" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">嗯，除非你正在设置类似于<a class="ae kl" href="https://cloud.google.com/kubernetes-engine/docs/how-to/private-clusters" rel="noopener ugc nofollow" target="_blank">私有集群</a>的东西，否则你的<code class="fe na nb nc nd b">pods</code>通常可以通过网络地址转换(<a class="ae kl" href="https://en.wikipedia.org/wiki/Network_address_translation" rel="noopener ugc nofollow" target="_blank"> NAT </a>)访问互联网，而<a class="ae kl" href="https://en.wikipedia.org/wiki/Network_address_translation" rel="noopener ugc nofollow" target="_blank"> NAT </a>并不会真正阻止数据包。NAT根本不足以保护您的基础设施。然而，它确实隐藏了内部寻址，代价是将转换状态保存在其他地方。</p><p id="789f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">让我们运行这里<a class="ae kl" href="https://kubernetes.io/docs/tasks/debug-application-cluster/get-shell-running-container/#getting-a-shell-to-a-container" rel="noopener ugc nofollow" target="_blank">描述的示例</a>来在托管的Kubernetes集群中创建一个<code class="fe na nb nc nd b">ngnix</code> pod。</p><pre class="mp mq mr ms gt ny nd nz oa aw ob bi"><span id="f6d5" class="ne lm iq nd b gy oc od l oe of">kubectl create -f <a class="ae kl" href="https://k8s.io/examples/application/shell-demo.yaml" rel="noopener ugc nofollow" target="_blank">https://k8s.io/examples/application/shell-demo.yaml</a><br/>kubectl exec -it shell-demo -- /bin/bash<br/>apt-get update<br/>apt-get install iputils-ping iproute2 -y</span></pre><p id="4344" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在尝试ping一个公共网站(<code class="fe na nb nc nd b">apt-get</code>那时已经接入互联网)</p><pre class="mp mq mr ms gt ny nd nz oa aw ob bi"><span id="95a6" class="ne lm iq nd b gy oc od l oe of">root@shell-demo:/# <strong class="nd ir">ping azure.microsoft.com -c 1</strong><br/>PING l-0007.l-msedge.net (13.107.42.16) 56(84) bytes of data.<br/>64 bytes from 13.107.42.16 (13.107.42.16): icmp_seq=1 ttl=119 time=3.09 ms</span><span id="47f2" class="ne lm iq nd b gy og od l oe of">--- l-0007.l-msedge.net ping statistics ---<br/>1 packets transmitted, 1 received, 0% packet loss, time 0ms<br/>rtt min/avg/max/mdev = 3.094/3.094/3.094/0.000 ms</span></pre><p id="8e11" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">所以你在一定程度上与互联网相连。</p><p id="2145" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">另一方面，如果你担心有人通过IPv6从互联网访问你的<code class="fe na nb nc nd b">pods</code>，请记住你有多层安全措施来隔离他们。例如，在AWS中，您有<a class="ae kl" href="https://docs.aws.amazon.com/vpc/latest/userguide/vpc-network-acls.html" rel="noopener ugc nofollow" target="_blank"> ACL </a>用于控制进出一个或多个子网的流量，因此您可以阻止任何不是来自您的另一个子网的流量进入您的子网。那么您的节点/虚拟机将有一个<a class="ae kl" href="https://docs.aws.amazon.com/vpc/latest/userguide/VPC_SecurityGroups.html" rel="noopener ugc nofollow" target="_blank">安全组</a>，因此您也可以在实例级别限制访问。最后，但同样重要的是，你还可以在Kubernetes中应用一个<a class="ae kl" href="https://kubernetes.io/docs/concepts/services-networking/network-policies/" rel="noopener ugc nofollow" target="_blank">网络策略</a>来在pod级别保护你。</p><figure class="mp mq mr ms gt mt gh gi paragraph-image"><div role="button" tabindex="0" class="mu mv di mw bf mx"><div class="gh gi oh"><img src="../Images/3720d983481d81b269480b8c69e9c53c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*M7F4VSxi3dDaywfVEYdgHw.png"/></div></div></figure><p id="7c14" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">AWS将为您的<code class="fe na nb nc nd b">VPC</code>提供一个<code class="fe na nb nc nd b">/56</code> IPv6子网。那相当于<strong class="jp ir">256</strong>T3】IPv6子网。例如，您的<a class="ae kl" href="https://docs.aws.amazon.com/vpc/latest/userguide/vpc-network-acls.html" rel="noopener ugc nofollow" target="_blank"> ACL </a>可能只允许分配给不同<code class="fe na nb nc nd b">VPC</code>或Kubernetes集群的<code class="fe na nb nc nd b">/56</code>之间的流量。所以你的<code class="fe na nb nc nd b">pods</code>实际上只能被其他<code class="fe na nb nc nd b">pods</code>访问。然后可以使用<a class="ae kl" href="https://docs.aws.amazon.com/vpc/latest/userguide/VPC_SecurityGroups.html" rel="noopener ugc nofollow" target="_blank">安全组</a>和<a class="ae kl" href="https://kubernetes.io/docs/concepts/services-networking/network-policies/" rel="noopener ugc nofollow" target="_blank">网络策略</a>来应用更细粒度的策略。</p><p id="8758" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">至于隧道、VPN连接、覆盖网络等。与<a class="ae kl" href="https://en.wikipedia.org/wiki/Network_address_translation" rel="noopener ugc nofollow" target="_blank"> NAT </a>相同；它们隐藏您的端点，代价是IPsec的性能损失、数据包开销等。如果您可以接受在您的pods中使用公共IPv6地址(+ <a class="ae kl" href="https://docs.aws.amazon.com/vpc/latest/userguide/vpc-network-acls.html" rel="noopener ugc nofollow" target="_blank"> ACL </a>)，那么前面的技术都不是严格必需的。我知道这可能不适用于所有人，没关系，这是一种交换。</p><h2 id="faf3" class="ne lm iq bd ln nf ng dn lr nh ni dp lv jy nj nk lz kc nl nm md kg nn no mh np bi translated">处理IPv6地址</h2><p id="d5d6" class="pw-post-body-paragraph jn jo iq jp b jq mj js jt ju mk jw jx jy ml ka kb kc mm ke kf kg mn ki kj kk ij bi translated">是啊，我知道。记住一个IPv4地址已经够难的了，所以128位长的IPv6地址听起来不太可能。</p><p id="5dc8" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">好吧，虽然每个<code class="fe na nb nc nd b">pod</code>都有自己的IP地址，但是这些IP地址并不稳定，因为<code class="fe na nb nc nd b">pods</code>死了也不会复活。由于这个原因，Kubernetes有了一个<code class="fe na nb nc nd b">Service</code>的概念，它定义了一个由<code class="fe na nb nc nd b">Label Selector</code>决定的<code class="fe na nb nc nd b">pods</code>的逻辑集合。[ <a class="ae kl" href="https://kubernetes.io/docs/concepts/services-networking/service/" rel="noopener ugc nofollow" target="_blank"> Kubernetes服务</a> ]。此外，在Kubernetes " <em class="nr">中，集群中定义的每个服务都被分配了一个DNS名称</em> " [ <a class="ae kl" href="https://kubernetes.io/docs/concepts/services-networking/dns-pod-service/#what-things-get-dns-names" rel="noopener ugc nofollow" target="_blank">服务的DNS</a>]。</p><p id="4bce" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这意味着您的<code class="fe na nb nc nd b">pods</code>将通过他们的<code class="fe na nb nc nd b">Service</code> DNS名称到达，因此您实际上不需要处理地址本身，这一切都发生在幕后。</p><p id="c3f5" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在针对Kubernetes集群的<a class="ae kl" href="https://github.com/leblancd/community/blob/fc4d40bac4ca76d9c46fa7335ea74a186388c313/keps/sig-network/0013-20180612-ipv4-ipv6-dual-stack.md#configuration-of-endpoint-ip-family-in-service-definitions" rel="noopener ugc nofollow" target="_blank"> IPv4/IPv6双栈功能提案</a>中，它们说明了如何为Kubernetes <code class="fe na nb nc nd b">Service</code>指定地址族。</p><pre class="mp mq mr ms gt ny nd nz oa aw ob bi"><span id="39ae" class="ne lm iq nd b gy oc od l oe of">endpointFamily: &lt;ipv4|ipv6|dual-stack&gt;       [Default: dual-stack]</span></pre><p id="5247" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">示例:</p><pre class="mp mq mr ms gt ny nd nz oa aw ob bi"><span id="973f" class="ne lm iq nd b gy oc od l oe of">spec:<br/>  selector:<br/>    app: MyApp<br/>  ports:<br/>  - protocol: TCP<br/>    port: 80<br/>    targetPort: 9376<br/>  endpointFamily: ipv6</span></pre><h1 id="5cf1" class="ll lm iq bd ln lo lp lq lr ls lt lu lv lw nu ly lz ma nv mc md me nw mg mh mi bi translated"><strong class="ak">当前挑战</strong></h1><h2 id="f52c" class="ne lm iq bd ln nf ng dn lr nh ni dp lv jy nj nk lz kc nl nm md kg nn no mh np bi translated">Kubernetes IPv6支持</h2><p id="526b" class="pw-post-body-paragraph jn jo iq jp b jq mj js jt ju mk jw jx jy ml ka kb kc mm ke kf kg mn ki kj kk ij bi translated">好消息是他们在这一领域取得了非常好的进展，仅支持IPv6在Kubernetes版中是<code class="fe na nb nc nd b">Alpha</code>[<a class="ae kl" href="https://github.com/kubernetes/enhancements/issues/508" rel="noopener ugc nofollow" target="_blank">IPv6支持增加了#508 </a> ]并且应该在K8s 1.13中是<code class="fe na nb nc nd b">Beta</code>。【<a class="ae kl" href="https://github.com/kubernetes/enhancements/issues/508#issuecomment-411178780" rel="noopener ugc nofollow" target="_blank">评论</a>】。还有提案提出“<a class="ae kl" href="https://github.com/kubernetes/kubernetes/issues/62822" rel="noopener ugc nofollow" target="_blank">增加IPv4/IPv6双栈支持和感知# 62822</a>”[<a class="ae kl" href="https://github.com/kubernetes/community/pull/2254" rel="noopener ugc nofollow" target="_blank">PR</a>，<a class="ae kl" href="https://github.com/kubernetes/enhancements/blob/1a03c720c3426efb16a68942bc8db37ac2b957f7/keps/sig-network/0013-20180612-ipv4-ipv6-dual-stack.md" rel="noopener ugc nofollow" target="_blank"> KEP </a>。</p><p id="e8e3" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">为什么是双栈？不幸的是，现在已经快2020年了，但仍然有一些关键服务不支持IPv6就像您的<code class="fe na nb nc nd b">pods</code>可能需要访问的一些包、源代码和容器库。👎</p><p id="089b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">从好的方面来看，目前有一些<code class="fe na nb nc nd b">CNI</code>插件已经能够在<code class="fe na nb nc nd b">pod</code>上配置双栈地址。然而，重要的是要记住，根据<code class="fe na nb nc nd b">PodStatus</code> V1核心API的定义，Kubernetes每个<code class="fe na nb nc nd b">pod</code>只知道一个地址。双栈提议称，他们将保留<code class="fe na nb nc nd b">PodIP</code>字段，但也会添加一个新数组<code class="fe na nb nc nd b">PodIPs</code>，用于存储额外的<code class="fe na nb nc nd b">pod</code>IP[<a class="ae kl" href="https://github.com/kubernetes/kubernetes/pull/69029" rel="noopener ugc nofollow" target="_blank">PR</a>]。</p><pre class="mp mq mr ms gt ny nd nz oa aw ob bi"><span id="bf4d" class="ne lm iq nd b gy oc od l oe of">type PodStatus struct {<br/>        ...<br/>        HostIP     string<br/>        PodIP      string<br/>        PodIPs     []PodIPInfo<br/>        ...    <br/>}</span></pre><p id="92ec" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">和</p><pre class="mp mq mr ms gt ny nd nz oa aw ob bi"><span id="d0da" class="ne lm iq nd b gy oc od l oe of">type PodIPInfo struct {<br/>        IP         string<br/>        Properties map[string]string<br/>    }</span></pre><p id="3b07" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在过去，当使用双栈集群时，我所做的是使IPv6地址成为分配给<code class="fe na nb nc nd b">pod</code>的IPv4地址的散列函数，因此我只需要跟踪其中一个并自动导出另一个。这大概是不推荐的，但是如果你好奇的话，我在我的Gophercon lightning talk演示中是这么做的:<a class="ae kl" href="https://www.youtube.com/watch?v=0SXPsLvB0UI" rel="noopener ugc nofollow" target="_blank">容器网络接口和Go </a>。</p><p id="4d0e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">最后，同样重要的是，Kube-proxy将被修改为并行驱动<code class="fe na nb nc nd b">iptables</code>和<code class="fe na nb nc nd b">ip6tables</code>(如果不使用<code class="fe na nb nc nd b">eBPF</code>)。另一方面，<code class="fe na nb nc nd b">Service</code>集群内的访问将通过所有IPv4服务IP或所有IPv6服务IP来完成。确保您检查了建议书的<a class="ae kl" href="https://github.com/kubernetes/enhancements/blob/1a03c720c3426efb16a68942bc8db37ac2b957f7/keps/sig-network/0013-20180612-ipv4-ipv6-dual-stack.md#non-goals" rel="noopener ugc nofollow" target="_blank">非目标</a>。</p><h2 id="99ca" class="ne lm iq bd ln nf ng dn lr nh ni dp lv jy nj nk lz kc nl nm md kg nn no mh np bi translated">云提供商IPv6支持</h2><p id="392c" class="pw-post-body-paragraph jn jo iq jp b jq mj js jt ju mk jw jx jy ml ka kb kc mm ke kf kg mn ki kj kk ij bi translated">云服务提供商对虚拟机/实例的IPv6支持充其量也只是凤毛麟角。我希望能够进行IPv6子网路由，以便为每个虚拟机实例分配不同的IPv6子网。AWS在IPv6支持方面走在了前面，但是它不会让你分解他们在VPC中分配给你的<code class="fe na nb nc nd b">/56</code>，分配给你实例的个人<code class="fe na nb nc nd b">/64</code>[<a class="ae kl" href="https://forums.aws.amazon.com/thread.jspa?messageID=799319#799319" rel="noopener ugc nofollow" target="_blank">论坛</a>。</p><figure class="mp mq mr ms gt mt gh gi paragraph-image"><div role="button" tabindex="0" class="mu mv di mw bf mx"><div class="gh gi oi"><img src="../Images/19ed945b415d833d9633725c3f417610.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*1nFU0QoV6zpy7_DnTPerJg.png"/></div></div></figure><p id="5fea" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">AWS支持团队帮助我完成了一个工作区，通过使用<a class="ae kl" href="https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/using-eni.html" rel="noopener ugc nofollow" target="_blank"> ENI </a>将虚拟机上的<code class="fe na nb nc nd b">/64</code>的较小块用作<code class="fe na nb nc nd b">pod</code>网络。虽然使用小于<code class="fe na nb nc nd b">/64</code>的子网不是推荐的做法，甚至可能无法与<a class="ae kl" href="https://docs.docker.com/v17.09/engine/userguide/networking/default_network/ipv6/#how-ipv6-works-on-docker" rel="noopener ugc nofollow" target="_blank"> Docker </a>一起使用，因为"<em class="nr">Docker容器的子网至少应该有</em> <code class="fe na nb nc nd b"><em class="nr">/80</em></code> <em class="nr">的大小， 因此，IPv6地址可以以容器的MAC地址结束，并且您可以防止Docker层</em>中的NDP邻居缓存无效问题”，这至少会让我在此期间做一些实验。 我将单独写一篇文章描述这是如何工作的➡️如何在AWS上运行支持IPv6的Docker容器。</p><p id="bfbe" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">另一方面，如果您正在运行一个托管的Kubernetes集群，那么IPv6可能需要更长的时间，因为它们运行的Kubernetes版本将只包含成熟的特性。比如GCP说:"<em class="nr">为确保稳定性和生产质量，普通GKE集群仅启用</em> <code class="fe na nb nc nd b"><em class="nr">beta</em></code> <em class="nr">或更高版本的功能。</em> <code class="fe na nb nc nd b"><em class="nr">Alpha</em></code> <em class="nr">功能无法在普通集群上启用，因为它们无法投入生产或升级</em>。GCP文件。因此，IPv6在GCP是一个禁忌，因为他们甚至不支持它。</p><h1 id="6637" class="ll lm iq bd ln lo lp lq lr ls lt lu lv lw nu ly lz ma nv mc md me nw mg mh mi bi translated"><strong class="ak">结论</strong></h1><p id="0fc4" class="pw-post-body-paragraph jn jo iq jp b jq mj js jt ju mk jw jx jy ml ka kb kc mm ke kf kg mn ki kj kk ij bi translated">虽然要实现这一点还需要做一些工作，但我相信这是值得的，并且有助于控制复杂性。IPv6的好处不仅适用于单个集群，也适用于多集群Kubernetes系统。如果您知道一家支持IPv6的云提供商，请告诉我。</p><p id="a359" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">延伸阅读:</p><ul class=""><li id="1a55" class="km kn iq jp b jq jr ju jv jy ko kc kp kg kq kk kr ks kt ku bi translated"><a class="ae kl" rel="noopener ugc nofollow" target="_blank" href="/kubernetes-networking-behind-the-scenes-39a1ab1792bb?source=friends_link&amp;sk=b5b666c68375f7c60f76faa8571baa21"> Kubernetes网络:幕后</a></li><li id="d144" class="km kn iq jp b jq kv ju kw jy kx kc ky kg kz kk kr ks kt ku bi translated"><a class="ae kl" href="https://medium.com/@nleiva/how-to-run-ipv6-enabled-docker-containers-on-aws-87e090ab0397?source=friends_link&amp;sk=126bd9850d2fc46a2ff99bee89c735ca" rel="noopener">如何在AWS上运行支持IPv6的Docker容器</a></li><li id="f44b" class="km kn iq jp b jq kv ju kw jy kx kc ky kg kz kk kr ks kt ku bi translated"><a class="ae kl" href="https://nleiva.medium.com/three-reasons-we-need-ipv6-in-kubernetes-69b6f3cbadb7" rel="noopener">我们需要IPv6的三个原因…在Kubernetes </a></li></ul></div></div>    
</body>
</html>