<html>
<head>
<title>Using the Azure Application gateway WAF with Istio-1</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">将Azure应用程序网关WAF与Istio-1一起使用</h1>
<blockquote>原文：<a href="https://itnext.io/using-application-gateway-waf-with-istio-315b907b8ed7?source=collection_archive---------2-----------------------#2022-08-31">https://itnext.io/using-application-gateway-waf-with-istio-315b907b8ed7?source=collection_archive---------2-----------------------#2022-08-31</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><h1 id="bf32" class="jn jo iq bd jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk bi translated">目的</h1><p id="4353" class="pw-post-body-paragraph kl km iq kn b ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">当我使用Istio 101 撰写关于<a class="ae lj" rel="noopener ugc nofollow" target="_blank" href="/traffic-management-using-istio-b49663da3e8d">流量管理的上一篇文章时，我想到的一件事是“你能否利用</a><a class="ae lj" href="https://docs.microsoft.com/en-us/azure/web-application-firewall/ag/ag-overview" rel="noopener ugc nofollow" target="_blank"> Azure应用网关WAF </a>(或<a class="ae lj" href="https://cloud.google.com/blog/products/identity-security/new-waf-capabilities-in-cloud-armor" rel="noopener ugc nofollow" target="_blank"> GCP的GCP装甲</a>)和其他安全功能，同时不放弃<a class="ae lj" href="https://istio.io/latest/docs/concepts/" rel="noopener ugc nofollow" target="_blank"> Istio服务网格功能</a>”</p><p id="db70" class="pw-post-body-paragraph kl km iq kn b ko lk kq kr ks ll ku kv kw lm ky kz la ln lc ld le lo lg lh li ij bi translated"><a class="ae lj" href="https://istio.io/latest/docs/ops/best-practices/security/#specialized-web-application-firewall-waf" rel="noopener ugc nofollow" target="_blank"> Istio文档</a>指出“它们可以部署在Istio入口网关的前面，以规范进入网格的请求。”，所以我想通过测试来尝试一下。</p><p id="7146" class="pw-post-body-paragraph kl km iq kn b ko lk kq kr ks ll ku kv kw lm ky kz la ln lc ld le lo lg lh li ij bi translated"><strong class="kn ir">使用Azure应用网关入口控制器时，不能使用Istio入口网关。它可以存在，但流量不会通过Istio入口网关路由。但是您仍然可以利用与Istio入口网关无关的其他Istio服务网格功能。</strong></p><h1 id="a60b" class="jn jo iq bd jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk bi translated">测试环境设置</h1><ul class=""><li id="422f" class="lp lq iq kn b ko kp ks kt kw lr la ls le lt li lu lv lw lx bi translated">使用<a class="ae lj" href="https://docs.microsoft.com/en-us/azure/aks/learn/quick-kubernetes-deploy-portal?tabs=azure-cli" rel="noopener ugc nofollow" target="_blank">文档</a>创建一个AKS集群。</li><li id="bb6a" class="lp lq iq kn b ko ly ks lz kw ma la mb le mc li lu lv lw lx bi translated">使用来自<a class="ae lj" href="https://portal.azure.com/" rel="noopener ugc nofollow" target="_blank">门户</a>的说明连接到AKS集群</li></ul><figure class="me mf mg mh gt mi gh gi paragraph-image"><div role="button" tabindex="0" class="mj mk di ml bf mm"><div class="gh gi md"><img src="../Images/b717109f5235c574b4c8286ab846f392.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*32bKOmUf2B-VH3JJIDpXkw.png"/></div></div><figcaption class="mp mq gj gh gi mr ms bd b be z dk translated">图1</figcaption></figure><ul class=""><li id="b2af" class="lp lq iq kn b ko lk ks ll kw mt la mu le mv li lu lv lw lx bi translated">运行以下shell脚本来设置istiod。您可以跳过设置Istio Ingress独立特使代理的最后3个命令，因为您不会使用Istio Ingress网关</li></ul><figure class="me mf mg mh gt mi"><div class="bz fp l di"><div class="mw mx l"/></div></figure><ul class=""><li id="803a" class="lp lq iq kn b ko lk ks ll kw mt la mu le mv li lu lv lw lx bi translated">运行下面的脚本来部署BookInfo应用程序(由Istio提供用于演示目的)。</li></ul><figure class="me mf mg mh gt mi"><div class="bz fp l di"><div class="mw mx l"/></div></figure><ul class=""><li id="5dd9" class="lp lq iq kn b ko lk ks ll kw mt la mu le mv li lu lv lw lx bi translated">为应用程序创建入口资源。</li></ul><figure class="me mf mg mh gt mi"><div class="bz fp l di"><div class="mw mx l"/></div></figure><pre class="me mf mg mh gt my mz na nb aw nc bi"><span id="4b7b" class="nd jo iq mz b gy ne nf l ng nh">kubectl apply -f bookinfo-agic.yaml -n appbi</span></pre><p id="b647" class="pw-post-body-paragraph kl km iq kn b ko lk kq kr ks ll ku kv kw lm ky kz la ln lc ld le lo lg lh li ij bi translated">观察注释“<em class="ni">kubernetes.io/ingress.class: azure/应用程序网关</em>”被设置为将入口控制器配置为应用程序网关入口控制器。</p><figure class="me mf mg mh gt mi gh gi paragraph-image"><div role="button" tabindex="0" class="mj mk di ml bf mm"><div class="gh gi nj"><img src="../Images/f2f8feb599a978d9a3aaea196ba0f682.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*9fjHsbmWpkRAPyBiFtrCvA.png"/></div></div></figure><p id="2daa" class="pw-post-body-paragraph kl km iq kn b ko lk kq kr ks ll ku kv kw lm ky kz la ln lc ld le lo lg lh li ij bi translated"><a class="ae lj" href="https://docs.microsoft.com/en-us/azure/application-gateway/ingress-controller-overview" rel="noopener ugc nofollow" target="_blank"> AGIC </a>通过Kubernetes <a class="ae lj" href="https://kubernetes.io/docs/user-guide/ingress/" rel="noopener ugc nofollow" target="_blank">入口资源</a>以及服务和部署/pod进行配置。AGIC持续监视入口资源中配置的服务的服务端点，并运行ARM模板来更新应用网关配置(如果有更新)。</p><blockquote class="nk nl nm"><p id="2c22" class="kl km ni kn b ko lk kq kr ks ll ku kv nn lm ky kz no ln lc ld np lo lg lh li ij bi translated">应用网关直接使用pods的私有IP与pods对话，不需要NodePort或KubeProxy服务。这也为您的部署带来了更好的性能。</p></blockquote><ul class=""><li id="061a" class="lp lq iq kn b ko lk ks ll kw mt la mu le mv li lu lv lw lx bi translated">按照<a class="ae lj" href="https://docs.microsoft.com/en-us/azure/application-gateway/tutorial-ingress-controller-add-on-existing" rel="noopener ugc nofollow" target="_blank">文档</a>为您创建的AKS集群启用AGIC。集成成功后，您可以查看入口控制器的日志，以查看应用网关是否更新了配置。</li></ul><pre class="me mf mg mh gt my mz na nb aw nc bi"><span id="c540" class="nd jo iq mz b gy ne nf l ng nh">kubectl logs deployment/ingress-appgw-deployment -n kube-system -f</span></pre><p id="5b0c" class="pw-post-body-paragraph kl km iq kn b ko lk kq kr ks ll ku kv kw lm ky kz la ln lc ld le lo lg lh li ij bi translated">此外，从Azure门户查看应用程序网关实例的配置。</p><p id="82cc" class="pw-post-body-paragraph kl km iq kn b ko lk kq kr ks ll ku kv kw lm ky kz la ln lc ld le lo lg lh li ij bi translated">启用WAF(如果尚未启用)。</p><h1 id="85ad" class="jn jo iq bd jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk bi translated">配置Istio特定的资源</h1><p id="282c" class="pw-post-body-paragraph kl km iq kn b ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">您将为“reviews”应用程序配置虚拟服务和目标规则资源，因为它有3个不同的版本，并且您可以测试当请求进入服务网格时，Istio Envoy代理是否接管。有关申请的详细信息，请参考我的<a class="ae lj" href="https://medium.com/p/b49663da3e8d" rel="noopener">旧帖子</a>。</p><ul class=""><li id="cc07" class="lp lq iq kn b ko lk ks ll kw mt la mu le mv li lu lv lw lx bi translated">为“评论”应用程序配置虚拟服务</li></ul><figure class="me mf mg mh gt mi"><div class="bz fp l di"><div class="mw mx l"/></div></figure><pre class="me mf mg mh gt my mz na nb aw nc bi"><span id="44b8" class="nd jo iq mz b gy ne nf l ng nh">kubectl apply -f vs-reviews.yaml -n appbi</span></pre><p id="ce8f" class="pw-post-body-paragraph kl km iq kn b ko lk kq kr ks ll ku kv kw lm ky kz la ln lc ld le lo lg lh li ij bi translated">这将创建一个新的虚拟服务“评论”。</p><ul class=""><li id="bc37" class="lp lq iq kn b ko lk ks ll kw mt la mu le mv li lu lv lw lx bi translated">为“评论”应用程序配置目标规则</li></ul><figure class="me mf mg mh gt mi"><div class="bz fp l di"><div class="mw mx l"/></div></figure><pre class="me mf mg mh gt my mz na nb aw nc bi"><span id="5160" class="nd jo iq mz b gy ne nf l ng nh">kubectl apply -f dr-reviews.yaml -n appbi</span></pre><p id="cc3b" class="pw-post-body-paragraph kl km iq kn b ko lk kq kr ks ll ku kv kw lm ky kz la ln lc ld le lo lg lh li ij bi translated">这将创建一个新的目标规则“reviews”。</p><h1 id="667e" class="jn jo iq bd jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk bi translated">测试</h1><ul class=""><li id="78c3" class="lp lq iq kn b ko kp ks kt kw lr la ls le lt li lu lv lw lx bi translated">获取应用程序网关的公共IP，并将其作为“bookinfo.app.io”添加到客户机上的hosts文件中。观察书评区显示不同的“书评”用户界面，即v1没有星星，v2有黑星，v3有红星。经常查看刷新应用程序页面时显示的UI。</li><li id="4cbf" class="lp lq iq kn b ko ly ks lz kw ma la mb le mc li lu lv lw lx bi translated">你可以添加故障注入(参考我的<a class="ae lj" rel="noopener ugc nofollow" target="_blank" href="/traffic-management-using-istio-b49663da3e8d">旧帖子</a>来了解这一点)，看看它如何影响应用程序。</li></ul><h1 id="fc97" class="jn jo iq bd jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk bi translated">入口请求流</h1><p id="e9cb" class="pw-post-body-paragraph kl km iq kn b ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">下图显示了流量如何通过应用程序网关和服务于web应用程序的服务网格从客户端流向pods。</p><figure class="me mf mg mh gt mi gh gi paragraph-image"><div role="button" tabindex="0" class="mj mk di ml bf mm"><div class="gh gi nq"><img src="../Images/4dea18b15ce65d520419a8ec7e95b98e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*pw1MP4T2gDQp5Mqdy56slg.png"/></div></div><figcaption class="mp mq gj gh gi mr ms bd b be z dk translated">图2</figcaption></figure><p id="a146" class="pw-post-body-paragraph kl km iq kn b ko lk kq kr ks ll ku kv kw lm ky kz la ln lc ld le lo lg lh li ij bi translated"><strong class="kn ir">观察到流量直接到达productpage应用程序的端点pod，并且当与productpage应用程序相关的pod尝试到达其他服务时，服务网格进入画面。</strong></p><h1 id="b461" class="jn jo iq bd jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk bi translated">结果</h1><ul class=""><li id="38dc" class="lp lq iq kn b ko kp ks kt kw lr la ls le lt li lu lv lw lx bi translated">将应用网关(AGIC)与带有Istio服务网格的WAF配合使用是一种有效的配置。</li><li id="cd25" class="lp lq iq kn b ko ly ks lz kw ma la mb le mc li lu lv lw lx bi translated">通过这种配置，您可以充分利用这两个领域的优势。</li><li id="ca3b" class="lp lq iq kn b ko ly ks lz kw ma la mb le mc li lu lv lw lx bi translated">该测试针对非常简单的应用程序，对于复杂的应用程序，结果可能会有所不同。</li></ul><h2 id="5986" class="nd jo iq bd jp nr ns dn jt nt nu dp jx kw nv nw kb la nx ny kf le nz oa kj ob bi translated">限制</h2><ul class=""><li id="c9c0" class="lp lq iq kn b ko kp ks kt kw lr la ls le lt li lu lv lw lx bi translated"><strong class="kn ir">当流量通过Istio入口网关进入时，您将无法使用这些功能。</strong></li><li id="9d55" class="lp lq iq kn b ko ly ks lz kw ma la mb le mc li lu lv lw lx bi translated"><strong class="kn ir">流量在首次接入时直接到达pod，服务网格仅用于pod之间的内部通信。</strong></li></ul></div><div class="ab cl oc od hu oe" role="separator"><span class="of bw bk og oh oi"/><span class="of bw bk og oh oi"/><span class="of bw bk og oh"/></div><div class="ij ik il im in"><h2 id="20b6" class="nd jo iq bd jp nr ns dn jt nt nu dp jx kw nv nw kb la nx ny kf le nz oa kj ob bi translated">请阅读我的下一篇文章,在这篇文章中，我正在尝试另一种配置，你将学会如何摆脱上述限制之一</h2></div></div>    
</body>
</html>