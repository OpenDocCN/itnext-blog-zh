<html>
<head>
<title>ASP.NET Core 3.1 Web.config Transform for Production</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">面向生产的ASP.NET核心3.1 Web.config转型</h1>
<blockquote>原文：<a href="https://itnext.io/asp-net-core-3-1-web-config-transform-for-production-6a38ce06e832?source=collection_archive---------4-----------------------#2020-02-10">https://itnext.io/asp-net-core-3-1-web-config-transform-for-production-6a38ce06e832?source=collection_archive---------4-----------------------#2020-02-10</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="36c8" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我最近将一个应用程序从ASP.NET Core 2.2升级到了3.1，同时这个应用程序被转移到了一个新的服务器上。旁注，如果可以的话，不要同时做两个大的改变，因为这样会让追踪问题的原因变得更加困难。有问题的应用程序最初是使用ASP.NET核心React模板创建的。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi kl"><img src="../Images/ab72ccf3c26a336eefbf6954c4614ef1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*zoup2JaQarWY4z7F2zd-bA.png"/></div></div></figure><h2 id="c776" class="kx ky iq bd kz la lb dn lc ld le dp lf jy lg lh li kc lj lk ll kg lm ln lo lp bi translated">错误</h2><p id="90f5" class="pw-post-body-paragraph jn jo iq jp b jq lq js jt ju lr jw jx jy ls ka kb kc lt ke kf kg lu ki kj kk ij bi translated">经过上面的更改后，网站开始返回以下错误。</p><blockquote class="lv lw lx"><p id="9c3d" class="jn jo ly jp b jq jr js jt ju jv jw jx lz jz ka kb ma kd ke kf mb kh ki kj kk ij bi translated">HTTP错误500.0 — ANCM进程内处理程序加载失败</p></blockquote><p id="3884" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">为了诊断这个问题，我通过将<strong class="jp ir"> stdoutLogEnabled </strong>改为true来启用标准输出日志。下面是启用了日志记录的应用程序的web配置中的一行。</p><pre class="km kn ko kp gt mc md me mf aw mg bi"><span id="6c58" class="kx ky iq md b gy mh mi l mj mk">&lt;aspNetCore processPath="dotnet" arguments=".\YourApplication.dll" stdoutLogEnabled="true" stdoutLogFile=".\logs\stdout"&gt;</span></pre><h2 id="1d08" class="kx ky iq bd kz la lb dn lc ld le dp lf jy lg lh li kc lj lk ll kg lm ln lo lp bi translated">原因</h2><p id="505e" class="pw-post-body-paragraph jn jo iq jp b jq lq js jt ju lr jw jx jy ls ka kb kc lt ke kf kg lu ki kj kk ij bi translated">日志显示应用程序试图使用React开发服务器启动应用程序的React部分，React开发服务器使用npm。下面是来自<strong class="jp ir">启动</strong>类的<strong class="jp ir">配置</strong>函数的相关代码。</p><pre class="km kn ko kp gt mc md me mf aw mg bi"><span id="81f3" class="kx ky iq md b gy mh mi l mj mk">app.UseSpa(spa =&gt;<br/>           {<br/>               spa.Options.SourcePath = "ClientApp";<br/><br/>               if (env.IsDevelopment())<br/>               {<br/>                   spa.UseReactDevelopmentServer(npmScript: "start");<br/>               }<br/>           });</span></pre><p id="4e7c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">从突出显示的区域可以看出，Reac开发服务器应该只在环境设置为development时使用，果然，web.config具有ASPNETCORE_ENVIRONMENT的环境变量，并且值为Development，如下例所示。</p><pre class="km kn ko kp gt mc md me mf aw mg bi"><span id="f12c" class="kx ky iq md b gy mh mi l mj mk">&lt;?xml version="1.0" encoding="utf-8"?&gt;<br/>&lt;configuration&gt;<br/>  &lt;location path="." inheritInChildApplications="false"&gt;<br/>    &lt;system.webServer&gt;<br/>      &lt;handlers&gt;<br/>        &lt;add name="aspNetCore" path="*" verb="*" modules="AspNetCoreModuleV2" resourceType="Unspecified" /&gt;<br/>      &lt;/handlers&gt;<br/>      &lt;aspNetCore processPath="dotnet" arguments="YourApplication.dll" stdoutLogEnabled="false" stdoutLogFile=".\logs\stdout" hostingModel="InProcess"&gt;<br/>        &lt;environmentVariables&gt;<br/>          &lt;environmentVariable name="ASPNETCORE_ENVIRONMENT" value="Development" /&gt;<br/>        &lt;/environmentVariables&gt;<br/>      &lt;/aspNetCore&gt;<br/>    &lt;/system.webServer&gt;<br/>  &lt;/location&gt;<br/>&lt;/configuration&gt;</span></pre><h2 id="dd32" class="kx ky iq bd kz la lb dn lc ld le dp lf jy lg lh li kc lj lk ll kg lm ln lo lp bi translated">修复</h2><p id="fa77" class="pw-post-body-paragraph jn jo iq jp b jq lq js jt ju lr jw jx jy ls ka kb kc lt ke kf kg lu ki kj kk ij bi translated">我的本能反应是找到一种方法，当应用程序以发布模式发布时，改变该变量的值。这帮助我找到了微软的文档。</p><p id="53fb" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">对于这个修复，我使用了基于构建配置转换。为此，我添加了一个名为<strong class="jp ir"> web的新文件。发布.配置</strong>。有了这个新文件，文件中的转换将在发布构建运行时执行。下面是我用来将ASPNETCORE_ENVIRONMENT设置为生产环境的转换。</p><pre class="km kn ko kp gt mc md me mf aw mg bi"><span id="afd5" class="kx ky iq md b gy mh mi l mj mk">&lt;?xml version="1.0" encoding="utf-8"?&gt;<br/>&lt;configuration xmlns:xdt="http://schemas.microsoft.com/XML-Document-Transform"&gt;<br/>  &lt;location&gt;<br/>    &lt;system.webServer&gt;<br/>      &lt;aspNetCore&gt;<br/>        &lt;environmentVariables&gt;<br/>          &lt;environmentVariable xdt:Transform="Replace" xdt:Locator="Match(name)" name="ASPNETCORE_ENVIRONMENT" value="Production" /&gt;<br/>        &lt;/environmentVariables&gt;<br/>      &lt;/aspNetCore&gt;<br/>    &lt;/system.webServer&gt;<br/>  &lt;/location&gt;<br/>&lt;/configuration&gt;</span></pre><p id="c211" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">重要的是，转换的结构要与实际web.config中的结构相匹配，否则转换将无法找到需要转换的元素，在本例中，我们在configuration/location/system . web server/aspNetCore/environment variables下寻找元素。</p><p id="ffed" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在我们的例子中，我们告诉转换我们想要替换元素(xdt:Transform="Replace ")，该元素将名称(xdt:Locator = " Match(name)")ASPNETCORE _ ENVIRONMENT与值Production相匹配。</p><h2 id="723c" class="kx ky iq bd kz la lb dn lc ld le dp lf jy lg lh li kc lj lk ll kg lm ln lo lp bi translated">包扎</h2><p id="6e8c" class="pw-post-body-paragraph jn jo iq jp b jq lq js jt ju lr jw jx jy ls ka kb kc lt ke kf kg lu ki kj kk ij bi translated">这只是web.config转换的一个小例子。<a class="ae ml" href="https://docs.microsoft.com/en-us/aspnet/core/host-and-deploy/iis/transform-webconfig" rel="noopener ugc nofollow" target="_blank">官方文档</a>给了我一个关于转换能做什么的总体高层次的概念，但是对于我需要做的事情不是很有帮助。如果文档没有涵盖您的用例，请准备好进行大量的搜索。</p><p id="c1e3" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">附注在我上面提到的应用程序中，结果是。NET Core 2.1不包含ASPNETCORE_ENVIRONMENT的值，这就是为什么它以前不是一个问题。</p></div><div class="ab cl mm mn hu mo" role="separator"><span class="mp bw bk mq mr ms"/><span class="mp bw bk mq mr ms"/><span class="mp bw bk mq mr"/></div><div class="ij ik il im in"><p id="2c7d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><em class="ly">原载于</em><a class="ae ml" href="https://elanderson.net/2020/02/asp-net-core-3-1-web-config-transform-for-production/" rel="noopener ugc nofollow" target="_blank"><em class="ly"/></a><em class="ly">。</em></p></div></div>    
</body>
</html>