<html>
<head>
<title>Ephemeral Jobs Monitoring Using Prometheus PushGateway</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Prometheus PushGateway监控临时作业</h1>
<blockquote>原文：<a href="https://itnext.io/ephemeral-jobs-monitoring-using-prometheus-pushgateway-917b33486564?source=collection_archive---------2-----------------------#2020-07-14">https://itnext.io/ephemeral-jobs-monitoring-using-prometheus-pushgateway-917b33486564?source=collection_archive---------2-----------------------#2020-07-14</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><figure class="gl gn jr js jt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi jq"><img src="../Images/02eed4ad084366141b3949df2c779120.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*mhMKB_iWA2Kz6L0qTT_i9w.png"/></div></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated">普罗米修斯建筑</figcaption></figure><p id="23e7" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">在软件系统中，我们通常希望增加一些临时服务或任务，一旦执行了特定的任务，这些服务或任务就可以被终止。例如，如果我们希望每天早上发送用户通知，那么我们不希望该服务整天运行，而是希望服务可以在特定时间启动、执行任务和关闭，从而有效地节省资源和成本。</p><p id="3861" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">与任何其他长期运行的服务一样，这些短暂的(或Kubernetes术语批处理或Cron)作业也需要被监控，以收集关键指标，并在出现问题时进行更改。</p><p id="c14f" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">本文描述了我们如何通过解释来监控这些短命的作业</p><ul class=""><li id="4f43" class="ld le it kh b ki kj km kn kq lf ku lg ky lh lc li lj lk ll bi translated">普罗米修斯有什么问题</li><li id="6f7a" class="ld le it kh b ki lm km ln kq lo ku lp ky lq lc li lj lk ll bi translated">什么是PushGateway &amp;为什么它是必要的</li><li id="9191" class="ld le it kh b ki lm km ln kq lo ku lp ky lq lc li lj lk ll bi translated">使用示例应用程序进行演示</li></ul></div><div class="ab cl lr ls hx lt" role="separator"><span class="lu bw bk lv lw lx"/><span class="lu bw bk lv lw lx"/><span class="lu bw bk lv lw"/></div><div class="im in io ip iq"><h1 id="6a03" class="ly lz it bd ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp mq mr ms mt mu mv bi translated">普罗米修斯建筑公司:</h1><p id="ac24" class="pw-post-body-paragraph kf kg it kh b ki mw kk kl km mx ko kp kq my ks kt ku mz kw kx ky na la lb lc im bi translated">关于<a class="ae nb" href="https://prometheus.io/" rel="noopener ugc nofollow" target="_blank">普罗米修斯</a>的简短介绍如果你还不知道，</p><blockquote class="nc nd ne"><p id="d6e9" class="kf kg nf kh b ki kj kk kl km kn ko kp ng kr ks kt nh kv kw kx ni kz la lb lc im bi translated">Prometheus是一个基于开源指标的监控系统，可以记录多维时序数据。它支持强大的查询、仪表板和警报。提供多种集成以连接到各种系统。</p></blockquote><h2 id="059e" class="nj lz it bd ma nk nl dn me nm nn dp mi kq no np mm ku nq nr mq ky ns nt mu nu bi translated">它是如何工作的？</h2><p id="0928" class="pw-post-body-paragraph kf kg it kh b ki mw kk kl km mx ko kp kq my ks kt ku mz kw kx ky na la lb lc im bi translated">Prometheus使用拉模型(也称为抓取)来收集指标，这意味着Prometheus服务器将通过调用其配置的HTTP端点来获取这些指标，从而联系指定的服务。</p><p id="88da" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">例如，<code class="fe nv nw nx ny b">prometheus.yml</code>文件中定义的以下配置告诉Prometheus服务器在指定的端点上每隔5s获取一次指标</p><pre class="nz oa ob oc gt od ny oe of aw og bi"><span id="b3d5" class="nj lz it ny b gy oh oi l oj ok">scrape_configs:</span><span id="cb8e" class="nj lz it ny b gy ol oi l oj ok">- job_name: 'auth_server'</span><span id="bec4" class="nj lz it ny b gy ol oi l oj ok">scrape_interval: 5s</span><span id="cf2d" class="nj lz it ny b gy ol oi l oj ok">static_configs:</span><span id="cdd7" class="nj lz it ny b gy ol oi l oj ok">- targets: ['auth.server.com:8080/metrics']</span></pre><h2 id="1e78" class="nj lz it bd ma nk nl dn me nm nn dp mi kq no np mm ku nq nr mq ky ns nt mu nu bi translated">问题？</h2><p id="6ff3" class="pw-post-body-paragraph kf kg it kh b ki mw kk kl km mx ko kp kq my ks kt ku mz kw kx ky na la lb lc im bi translated">Scarping对长期运行的服务有好处，因为这些服务将在很长一段时间内可供Prometheus服务器发出请求并收集它们的指标。这种架构很好，它有助于实现其他一些好处，如健康检查、无瓶颈等。</p><p id="98f1" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">但是对于像K8s Batch/Cron Jobs这样的短命服务，当Prometheus决定收集指标时，这些pod可能早就被终止了</p><p id="d66f" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">对于这些类型的用例，推送模型是必要的，以便这些服务可以在需要时(例如，在关机期间)发布其度量</p></div><div class="ab cl lr ls hx lt" role="separator"><span class="lu bw bk lv lw lx"/><span class="lu bw bk lv lw lx"/><span class="lu bw bk lv lw"/></div><div class="im in io ip iq"><h1 id="bbf3" class="ly lz it bd ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp mq mr ms mt mu mv bi translated">PushGateway</h1><figure class="nz oa ob oc gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi om"><img src="../Images/0e5de2f0e2bebfc924950c1ef0444bf4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*FHXfdY52QLmd-NNFrdVi3w.png"/></div></div></figure><p id="9ab0" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">首先<a class="ae nb" href="https://github.com/prometheus/pushgateway" rel="noopener ugc nofollow" target="_blank"> PushGateway </a>不是另一个监控系统或某种类型，而是一个中间指标缓存。</p><blockquote class="nc nd ne"><p id="4786" class="kf kg nf kh b ki kj kk kl km kn ko kp ng kr ks kt nh kv kw kx ni kz la lb lc im bi translated">Prometheus Pushgateway允许临时和批处理作业向Prometheus公开它们的指标。</p></blockquote><p id="cedb" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">因此，它是一个中介服务，在它关闭之前，客户端(作业)可以按需推送指标，稍后Prometheus可以像往常一样从PushGateway获取这些指标。对于请求，它使用与Prometheus相同的度量格式。</p><p id="87dd" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">Pushgateway仅推荐用于短期服务。要知道确切的原因，请检查一下<a class="ae nb" href="https://prometheus.io/docs/practices/pushing/" rel="noopener ugc nofollow" target="_blank"> <strong class="kh iu">何时使用PushGateway </strong> </a></p></div><div class="ab cl lr ls hx lt" role="separator"><span class="lu bw bk lv lw lx"/><span class="lu bw bk lv lw lx"/><span class="lu bw bk lv lw"/></div><div class="im in io ip iq"><h1 id="63ad" class="ly lz it bd ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp mq mr ms mt mu mv bi translated">演示</h1><p id="e685" class="pw-post-body-paragraph kf kg it kh b ki mw kk kl km mx ko kp kq my ks kt ku mz kw kx ky na la lb lc im bi translated">让我们看一些推送网关的演示，</p><h2 id="06d2" class="nj lz it bd ma nk nl dn me nm nn dp mi kq no np mm ku nq nr mq ky ns nt mu nu bi translated">设置</h2><p id="eabc" class="pw-post-body-paragraph kf kg it kh b ki mw kk kl km mx ko kp kq my ks kt ku mz kw kx ky na la lb lc im bi translated">首先，我们需要设置我们的环境，包括启动和运行Prometheus &amp; Pushgateway实例，为了进行演示，我创建了一个简单的<code class="fe nv nw nx ny b">docker-compose</code>文件来设置这些环境。</p><figure class="nz oa ob oc gt ju"><div class="bz fp l di"><div class="on oo l"/></div></figure><p id="19d8" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">这里我配置了两个服务</p><ul class=""><li id="ab9c" class="ld le it kh b ki kj km kn kq lf ku lg ky lh lc li lj lk ll bi translated">Prometheus服务器将在端口9090上运行</li><li id="f235" class="ld le it kh b ki lm km ln kq lo ku lp ky lq lc li lj lk ll bi translated">推动网关服务器在端口9091上运行</li></ul><p id="d0c6" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">此外，我们需要告诉Prometheus从PushGateway获取指标，这可以在<code class="fe nv nw nx ny b">prometheus.yml</code>中完成，</p><figure class="nz oa ob oc gt ju"><div class="bz fp l di"><div class="on oo l"/></div></figure><p id="64da" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">第一项工作是让Prometheus废弃它自己的指标，第二项工作是我们定义在目标<code class="fe nv nw nx ny b">host.docker.internal:9091</code>收集推送网关指标，因为推送网关运行在docker容器中，我们需要将主机定义为<code class="fe nv nw nx ny b">host.docker.internal</code></p><p id="d3e0" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">运行以下命令启动这些服务，</p><pre class="nz oa ob oc gt od ny oe of aw og bi"><span id="0901" class="nj lz it ny b gy oh oi l oj ok">docker-compose up</span></pre><p id="cd38" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">现在Prometheus &amp; PushGateway服务器应该启动了，请查看http://localhost:9090&amp;<a class="ae nb" href="http://localhost:9091" rel="noopener ugc nofollow" target="_blank">http://localhost:9091</a>。</p><p id="99de" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">此外，如果您检查http://localhost:9090/targets，您可以看到这两个目标是健康的，这意味着Prometheus可以从推送网关服务器删除指标，</p><figure class="nz oa ob oc gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi op"><img src="../Images/8052d090029a1ce589dcd099b4daf7bf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*bYUlT67t5WpKTXDN62e14g.png"/></div></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated">普罗米修斯目标仪表板</figcaption></figure><h2 id="d034" class="nj lz it bd ma nk nl dn me nm nn dp mi kq no np mm ku nq nr mq ky ns nt mu nu bi translated">示例应用程序</h2><p id="9f40" class="pw-post-body-paragraph kf kg it kh b ki mw kk kl km mx ko kp kq my ks kt ku mz kw kx ky na la lb lc im bi translated">我已经创建了一个示例Spring Boot控制台应用程序，它可以被视为一个短命的作业，它将启动，执行一个任务，并在最后关闭。<br/>此应用程序可以打包并配置为作为Kubernetes批处理/Cron作业或通过任何其他系统触发。</p><p id="fe3b" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">为了收集指标，我们使用<a class="ae nb" href="https://micrometer.io/docs/concepts#_purpose" rel="noopener ugc nofollow" target="_blank">千分尺</a>。</p><pre class="nz oa ob oc gt od ny oe of aw og bi"><span id="543f" class="nj lz it ny b gy oh oi l oj ok">&lt;!-- Micrometer --&gt;<br/>&lt;dependency&gt;<br/>   &lt;groupId&gt;io.micrometer&lt;/groupId&gt;<br/>   &lt;artifactId&gt;<strong class="ny iu">micrometer-core</strong>&lt;/artifactId&gt;<br/>&lt;/dependency&gt;<br/>&lt;dependency&gt;<br/>   &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;<br/>   &lt;artifactId&gt;spring-boot-starter-aop&lt;/artifactId&gt;<br/>&lt;/dependency&gt;<br/><br/>&lt;dependency&gt;<br/>   &lt;groupId&gt;io.micrometer&lt;/groupId&gt;<br/>   &lt;artifactId&gt;<strong class="ny iu">micrometer-registry-prometheus</strong>&lt;/artifactId&gt;<br/>&lt;/dependency&gt;<br/><br/>&lt;dependency&gt;<br/>   &lt;groupId&gt;io.prometheus&lt;/groupId&gt;<br/>   &lt;artifactId&gt;<strong class="ny iu">simpleclient_pushgateway</strong>&lt;/artifactId&gt;<br/>   &lt;version&gt;0.9.0&lt;/version&gt;<br/>&lt;/dependency&gt;</span></pre><p id="249a" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">Micrometer为最流行的监控系统提供了一个简单的仪器客户端外观，因此我们可以将指标发送到其他几个外部系统，包括Prometheus。为此，我们还包括了Prometheus和PushGateway依赖项。默认情况下，micrometer还收集JVM指标。</p><pre class="nz oa ob oc gt od ny oe of aw og bi"><span id="bf7c" class="nj lz it ny b gy oh oi l oj ok">@Slf4j<br/>@SpringBootApplication<br/>@RequiredArgsConstructor<br/>public class Application implements CommandLineRunner {<br/><br/>    private final HelloService service;<br/><br/>    public static void main(String[] args) {<br/>        SpringApplication.<em class="nf">run</em>(Application.class, args);<br/>    }<br/><br/>    @Override<br/>    public void run(String... args) {<br/><br/>        for (int i = 0; i &lt; 5; i++) {<br/>            <em class="nf">log</em>.info("{} - {}", i, service.getHello());<br/>        }<br/>    }<br/>}</span></pre><p id="a471" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">应用程序在启动时将简单地调用HelloService几次并终止。我们通过以下方式跟踪我们在HelloService.java的指标</p><figure class="nz oa ob oc gt ju"><div class="bz fp l di"><div class="on oo l"/></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated">HelloService.java</figcaption></figure><p id="2909" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">这里我们有两个指标，</p><p id="70b1" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated"><code class="fe nv nw nx ny b">hello.counter</code> —这是一个<a class="ae nb" href="https://prometheus.io/docs/concepts/metric_types/#counter" rel="noopener ugc nofollow" target="_blank">计数器</a>，它将在每次调用<code class="fe nv nw nx ny b">getHello()</code>方法时递增</p><p id="938d" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated"><code class="fe nv nw nx ny b">hello-process</code>——测量<code class="fe nv nw nx ny b">getHello()</code>方法执行需要多长时间，这可以通过简单地从千分尺添加<code class="fe nv nw nx ny b">@Timed</code>注释来实现。</p><p id="de25" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">使用<code class="fe nv nw nx ny b">mvn spring-boot:run</code>命令运行应用程序，</p><figure class="nz oa ob oc gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi oq"><img src="../Images/61af95c9c8d6b313a9f811f25cebac57.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ZxRIHKGuglIv5eZgSRy5ZA.png"/></div></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated">应用程序日志</figcaption></figure><p id="298c" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">从日志中，我们可以看到hello服务被调用了几次，在端点处作为关闭挂钩的一部分，<code class="fe nv nw nx ny b">PushGatewayTaskScheduler</code>被执行，这将把任何未决的指标推送到PushGateway。</p><p id="d3b8" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">当我们检查位于<a class="ae nb" href="http://localhost:90901," rel="noopener ugc nofollow" target="_blank"> http://localhost:909 </a> 1的PushGateway仪表板时，我们可以看到我们的所有指标都被成功推送，</p><figure class="nz oa ob oc gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi or"><img src="../Images/da7d6486571cde4843492511d59b0491.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*j2klPwElfLvRMR87UBa_oA.png"/></div></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated">PushGateway仪表板</figcaption></figure><p id="fac7" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">最后但同样重要的是，我们可以在Prometheus仪表板中检查这些指标也是从PushGateway成功获取的。</p><figure class="nz oa ob oc gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi os"><img src="../Images/d0cc50f5651723a69f29b46052b182a9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*QrjI53n0aj3yBLSzo9gW0Q.png"/></div></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated">普罗米修斯仪表板</figcaption></figure><p id="48bf" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">最棒的是，我们不需要添加任何自定义代码或使用另一个监控系统来监控这些短暂的作业。</p><p id="8181" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">Github提供了示例代码，</p><div class="ot ou gp gr ov ow"><a href="https://github.com/ramesh-dev/prometheus-pushgateway-demo" rel="noopener  ugc nofollow" target="_blank"><div class="ox ab fo"><div class="oy ab oz cl cj pa"><h2 class="bd iu gy z fp pb fr fs pc fu fw is bi translated">Ramesh-dev/普罗米修斯-pushgateway-demo</h2><div class="pd l"><h3 class="bd b gy z fp pb fr fs pc fu fw dk translated">这是一个演示应用程序，使用Spring Boot 2.2与千分尺发布指标到普罗米修斯使用普罗米修斯推…</h3></div><div class="pe l"><p class="bd b dl z fp pb fr fs pc fu fw dk translated">github.com</p></div></div><div class="pf l"><div class="pg l ph pi pj pf pk jz ow"/></div></div></a></div><p id="d3f4" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated"><strong class="kh iu">注意:</strong>示例代码还实现了将指标推送到PushGateway服务器，该服务器使用Nginx反向代理启用了基本身份验证</p><ul class=""><li id="0d5c" class="ld le it kh b ki kj km kn kq lf ku lg ky lh lc li lj lk ll bi translated">使用docker-compose为Nginx服务器提供和配置基本认证</li><li id="837a" class="ld le it kh b ki lm km ln kq lo ku lp ky lq lc li lj lk ll bi translated">定义自定义spring配置以支持基本身份验证，因为Prometheus库自动配置还不支持它，请查看示例代码中的<em class="nf">pushgateway configuration</em></li></ul></div><div class="ab cl lr ls hx lt" role="separator"><span class="lu bw bk lv lw lx"/><span class="lu bw bk lv lw lx"/><span class="lu bw bk lv lw"/></div><div class="im in io ip iq"><h1 id="8364" class="ly lz it bd ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp mq mr ms mt mu mv bi translated">结论</h1><p id="dc18" class="pw-post-body-paragraph kf kg it kh b ki mw kk kl km mx ko kp kq my ks kt ku mz kw kx ky na la lb lc im bi translated">当您希望使用当前的Prometheus设置来监控临时和批处理作业时，PushGateway非常有用，因此您不必专门为这个用例设置或使用另一个监控解决方案。</p><p id="2372" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">快乐监控…</p></div></div>    
</body>
</html>