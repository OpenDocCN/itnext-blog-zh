<html>
<head>
<title>Horizontal Pod Autoscaling with Custom Metric from Different Namespace</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用来自不同命名空间的自定义指标进行水平窗格自动缩放</h1>
<blockquote>原文：<a href="https://itnext.io/horizontal-pod-autoscaling-with-custom-metric-from-different-namespace-f19f8446143b?source=collection_archive---------4-----------------------#2020-06-21">https://itnext.io/horizontal-pod-autoscaling-with-custom-metric-from-different-namespace-f19f8446143b?source=collection_archive---------4-----------------------#2020-06-21</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><figure class="gl gn jr js jt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi jq"><img src="../Images/a73db0c1e9c81a4805b8754c5c9b9c46.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*n9TJjxX2FQ8qGrA1.jpg"/></div></div></figure><p id="509e" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">基于自定义指标的水平窗格自动缩放通常要求自定义指标在窗格运行的名称空间中可用。现在，假设客户指标出现在不同的名称空间中，我们如何利用该指标实现HPA？</p><h2 id="9005" class="kz la it bd lb lc ld dn le lf lg dp lh km li lj lk kq ll lm ln ku lo lp lq lr bi translated">普罗米修斯适配器</h2><p id="bb97" class="pw-post-body-paragraph kb kc it kd b ke ls kg kh ki lt kk kl km lu ko kp kq lv ks kt ku lw kw kx ky im bi translated">首先，让我们安装Prometheus适配器来提供定制指标。给定以下值. yaml，</p><pre class="lx ly lz ma gt mb mc md me aw mf bi"><span id="b9d0" class="kz la it mc b gy mg mh l mi mj">metricsRelistInterval: 1m<br/>listenPort: 6443<br/>prometheus:<br/>  url: http://prometheus-operated.monitoring.svc<br/>  port: 9090<br/>rbac:<br/>  create: true</span><span id="bc0c" class="kz la it mc b gy mk mh l mi mj">serviceAccount:<br/>  create: true<br/>  name: prom-adaptor<br/>rules:<br/>  default: false</span></pre><p id="3af1" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">将图表安装在命名空间中，比如monitoring，</p><pre class="lx ly lz ma gt mb mc md me aw mf bi"><span id="d4cd" class="kz la it mc b gy mg mh l mi mj">helm install prom-adaptor stable/prometheus-adapter -f values.yaml -n monitoring</span></pre><h2 id="a062" class="kz la it bd lb lc ld dn le lf lg dp lh km li lj lk kq ll lm ln ku lo lp lq lr bi translated">创建普罗米修斯服务监视器</h2><p id="cd65" class="pw-post-body-paragraph kb kc it kd b ke ls kg kh ki lt kk kl km lu ko kp kq lv ks kt ku lw kw kx ky im bi translated">使用Prometheus操作符，创建定制的ServiceMonitor CRD资源，以便可以监视MQ队列深度(参见我的<a class="ae ml" href="https://medium.com/@zhimin.wen/programing-exec-into-a-pod-5f2a70bd93bb" rel="noopener">上一篇论文</a>了解更多细节)</p><pre class="lx ly lz ma gt mb mc md me aw mf bi"><span id="686d" class="kz la it mc b gy mg mh l mi mj">apiVersion: monitoring.coreos.com/v1<br/>kind: ServiceMonitor<br/>metadata:<br/>  name: qmon-svc-mon<br/>  namespace: monitoring<br/>  labels:<br/>    app: abt<br/>spec:<br/>  selector:<br/>    matchLabels:<br/>      app: abt<br/>  endpoints:<br/>  - port: metrics<br/>    metricRelabelings:<br/>    - sourceLabels: [namespace]<br/>      regex: '(.*)'<br/><strong class="mc iu">      replacement: myapp<br/>      targetLabel: target_namespace</strong></span></pre><p id="4e92" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">请注意，我们通过使用metricRelabelings添加了一个自定义标签“target_namespace”，其固定值为“myapp”。收集的指标将有一个额外的标签，如下所示，</p><p id="b90e" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated"><code class="fe mm mn mo mc b">{…, target_namespace=“myapp”}</code></p><h2 id="9677" class="kz la it bd lb lc ld dn le lf lg dp lh km li lj lk kq ll lm ln ku lo lp lq lr bi translated">自定义指标规则</h2><p id="c301" class="pw-post-body-paragraph kb kc it kd b ke ls kg kh ki lt kk kl km lu ko kp kq lv ks kt ku lw kw kx ky im bi translated">现在，我们更新configMap，命名为图表的发布名称，以提供我们的自定义指标规则。</p><pre class="lx ly lz ma gt mb mc md me aw mf bi"><span id="5803" class="kz la it mc b gy mg mh l mi mj">kind: ConfigMap<br/>apiVersion: v1<br/>metadata:<br/>  #release name of the chart<br/>  name: prom-adaptor-prometheus-adapter<br/>  namespace: monitoring<br/>data:<br/>  config.yaml: |<br/>    rules:<br/>    - seriesQuery: 'mq_mon_queue_depth' <br/>      resources:<br/>        overrides:<br/><strong class="mc iu">          target_namespace:<br/>            resource: "namespace"</strong><br/>          pod: <br/>            resource: "pod"<br/>          service: <br/>            resource: "service"<br/>      name:<br/>        matches: "^mq_mon_queue_depth"<br/>        as: "mq_queue_depth" <br/>      metricsQuery: 'mq_mon_queue_depth{queue_name="myqueue"}'</span></pre><p id="1da7" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">我们将度量重命名为mq_quque_depth，并查询感兴趣的特定队列的度量。我们还覆盖了资源，名称空间将遵循我们定义为target_namsepace的自定义标签，该标签设置为“myapp”。我们将服务名映射到公开监控的服务，即“qmon-svc”。</p><p id="e8b9" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">然后，将在“myapp”的名称空间中为虚拟服务“qmon-svc”定义一个名为“mq_queue_depth”的度量。使用kubectl命令进行测试，</p><pre class="lx ly lz ma gt mb mc md me aw mf bi"><span id="9377" class="kz la it mc b gy mg mh l mi mj">kubectl get --raw /apis/custom.metrics.k8s.io/v1beta1/namespaces/myapp/services/qmon-svc/mq_queue_depth</span></pre><p id="938d" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">格式化的JSON是，</p><pre class="lx ly lz ma gt mb mc md me aw mf bi"><span id="d680" class="kz la it mc b gy mg mh l mi mj">{<br/>  "kind": "MetricValueList",<br/>  "apiVersion": "custom.metrics.k8s.io/v1beta1",<br/>  "metadata": {<br/>    "selfLink": "/apis/custom.metrics.k8s.io/v1beta1/namespaces/myapp/services/qmon-svc/mq_queue_depth"<br/>  },<br/>  "items": [<br/>    {<br/>      "describedObject": {<br/>        "kind": "Service",<br/>        "namespace": "myapp",<br/>        "name": "qmon-svc",<br/>        "apiVersion": "/v1"<br/>      },<br/>      "metricName": "mq_queue_depth",<br/>      "timestamp": "2020-06-21T08:35:58Z",<br/>      "value": "8",<br/>      "selector": null<br/>    }<br/>  ]<br/>}</span></pre><h2 id="4321" class="kz la it bd lb lc ld dn le lf lg dp lh km li lj lk kq ll lm ln ku lo lp lq lr bi translated">HPA资源</h2><p id="7b0a" class="pw-post-body-paragraph kb kc it kd b ke ls kg kh ki lt kk kl km lu ko kp kq lv ks kt ku lw kw kx ky im bi translated">有了这个指标，我们可以用对象的类型来定义HPA资源。</p><pre class="lx ly lz ma gt mb mc md me aw mf bi"><span id="e126" class="kz la it mc b gy mg mh l mi mj">apiVersion: autoscaling/v2beta2<br/>kind: HorizontalPodAutoscaler<br/>metadata:<br/>  name: hpa-by-q-depth<br/>  namespace: myapp<br/>spec:<br/>  scaleTargetRef:<br/>    apiVersion: apps/v1<br/>    kind: Deployment<br/>    name: my-app-deploy<br/>  minReplicas: 1<br/>  maxReplicas: 10<br/>  metrics:<br/>  - type: Object<br/>    object:<br/>      metric:<br/>        name: mq_queue_depth<br/>      describedObject:<br/>        apiVersion: v1<br/>        kind: Service<br/>        name: qmon-svc<br/>      target:<br/>        type: Value<br/>        averageValue: 200</span></pre><p id="b143" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">我们预计，当队列深度较高时，pod将自动缩放到目标值，即每个pod将平均分配和处理200个队列深度值。</p></div></div>    
</body>
</html>