<html>
<head>
<title>Kubernetes: Service, load balancing, kube-proxy, and iptables</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Kubernetes:服务、负载平衡、kube代理和iptables</h1>
<blockquote>原文：<a href="https://itnext.io/kubernetes-service-load-balancing-kube-proxy-and-iptables-da3ebf1c802a?source=collection_archive---------1-----------------------#2020-11-01">https://itnext.io/kubernetes-service-load-balancing-kube-proxy-and-iptables-da3ebf1c802a?source=collection_archive---------1-----------------------#2020-11-01</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/469483022e8126c5337e3a2cc044070b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*QBuagr7tdmL-Gso3D70cPg.png"/></div></div></figure><p id="f60c" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">有一天我想知道Kubernetes中的pod之间的负载平衡是如何工作的？</p><p id="5514" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">也就是说，我们有一个外部负载平衡器。然后是服务。在它的后面——豆荚。</p><p id="74e8" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">当我们接收来自世界各地的网络数据包，并且我们有几个pod时会发生什么——流量将如何在它们之间分配？</p><ul class=""><li id="bb88" class="kw kx iq ka b kb kc kf kg kj ky kn kz kr la kv lb lc ld le bi translated"><a class="ae lf" href="https://rtfm.co.ua/en/kubernetes-service-load-balancing-kube-proxy-and-iptables/#kubeproxy" rel="noopener ugc nofollow" target="_blank"> kube-proxy </a></li><li id="8ca4" class="kw kx iq ka b kb lg kf lh kj li kn lj kr lk kv lb lc ld le bi translated"><a class="ae lf" href="https://rtfm.co.ua/en/kubernetes-service-load-balancing-kube-proxy-and-iptables/#User_space_proxy_mode" rel="noopener ugc nofollow" target="_blank">用户空间代理模式</a></li><li id="54f2" class="kw kx iq ka b kb lg kf lh kj li kn lj kr lk kv lb lc ld le bi translated"><a class="ae lf" href="https://rtfm.co.ua/en/kubernetes-service-load-balancing-kube-proxy-and-iptables/#iptables_proxy_mode" rel="noopener ugc nofollow" target="_blank"> iptables代理模式</a></li><li id="a525" class="kw kx iq ka b kb lg kf lh kj li kn lj kr lk kv lb lc ld le bi translated"><a class="ae lf" href="https://rtfm.co.ua/en/kubernetes-service-load-balancing-kube-proxy-and-iptables/#IPVS_proxy_mode" rel="noopener ugc nofollow" target="_blank"> IPVS代理模式</a></li><li id="d2bd" class="kw kx iq ka b kb lg kf lh kj li kn lj kr lk kv lb lc ld le bi translated"><a class="ae lf" href="https://rtfm.co.ua/en/kubernetes-service-load-balancing-kube-proxy-and-iptables/#kubeproxy_config" rel="noopener ugc nofollow" target="_blank">kube-代理配置</a></li><li id="5ec8" class="kw kx iq ka b kb lg kf lh kj li kn lj kr lk kv lb lc ld le bi translated"><a class="ae lf" href="https://rtfm.co.ua/en/kubernetes-service-load-balancing-kube-proxy-and-iptables/#Kubernetes_Pod_loadbalancing" rel="noopener ugc nofollow" target="_blank"> Kubernetes Pod负载平衡</a></li><li id="ee12" class="kw kx iq ka b kb lg kf lh kj li kn lj kr lk kv lb lc ld le bi translated"><a class="ae lf" href="https://rtfm.co.ua/en/kubernetes-service-load-balancing-kube-proxy-and-iptables/#AWS_LoadBalancer_traffic_modes" rel="noopener ugc nofollow" target="_blank"> AWS负载平衡器流量模式</a></li><li id="d818" class="kw kx iq ka b kb lg kf lh kj li kn lj kr lk kv lb lc ld le bi translated"><a class="ae lf" href="https://rtfm.co.ua/en/kubernetes-service-load-balancing-kube-proxy-and-iptables/#kubeproxy_and_iptables" rel="noopener ugc nofollow" target="_blank"> kube-proxy和iptables </a></li><li id="f199" class="kw kx iq ka b kb lg kf lh kj li kn lj kr lk kv lb lc ld le bi translated"><a class="ae lf" href="https://rtfm.co.ua/en/kubernetes-service-load-balancing-kube-proxy-and-iptables/#iptablesrules" rel="noopener ugc nofollow" target="_blank"> iptables规则</a></li></ul><h1 id="0bda" class="ll lm iq bd ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi bi translated"><code class="fe mj mk ml mm b">kube-proxy</code></h1><p id="82e8" class="pw-post-body-paragraph jy jz iq ka b kb mn kd ke kf mo kh ki kj mp kl km kn mq kp kq kr mr kt ku kv ij bi translated">所以。服务与其pod之间的路由规则由<code class="fe mj mk ml mm b">kube-proxy</code>服务控制，该服务可以工作在以下三种模式之一-<strong class="ka ir"><em class="ms"/></strong><strong class="ka ir"><em class="ms">iptables代理模式</em></strong><em class="ms"/><strong class="ka ir"><em class="ms">IPVS代理模式</em> </strong>。</p><h2 id="d46f" class="mt lm iq bd ln mu mv dn lr mw mx dp lv kj my mz lz kn na nb md kr nc nd mh ne bi translated">用户空间代理模式</h2><p id="c61b" class="pw-post-body-paragraph jy jz iq ka b kb mn kd ke kf mo kh ki kj mp kl km kn mq kp kq kr mr kt ku kv ij bi translated">链接:</p><ul class=""><li id="5379" class="kw kx iq ka b kb kc kf kg kj ky kn kz kr la kv lb lc ld le bi translated"><a class="ae lf" href="https://kubernetes.io/docs/concepts/services-networking/service/#proxy-mode-userspace" rel="noopener ugc nofollow" target="_blank">用户空间代理模式</a></li><li id="2d6e" class="kw kx iq ka b kb lg kf lh kj li kn lj kr lk kv lb lc ld le bi translated"><a class="ae lf" href="https://arthurchiao.art/blog/cracking-k8s-node-proxy/#ch_4" rel="noopener ugc nofollow" target="_blank">实现:通过用户空间套接字的代理</a></li></ul><p id="bf75" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">不推荐使用的模式，以前是默认模式。</p><p id="5cca" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">当使用此模式时，<code class="fe mj mk ml mm b">kube-proxy</code>监视集群中的变化，对于每个新服务，将在WorkerNode上打开一个TCP端口。</p><p id="faa2" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">然后，该工作节点上的<code class="fe mj mk ml mm b">iptables</code>开始将流量从该端口路由到<code class="fe mj mk ml mm b">kube-proxy</code>服务，该服务使用<a class="ae lf" href="https://rtfm.co.ua/nginx-http-proksi-load-balancing-bufery-i-keshirovanie/#nginx_upstream_chg" rel="noopener ugc nofollow" target="_blank">循环</a>方法充当代理服务，即通过将流量发送到其后端列表中的下一个pod。在此期间，如果第一个pod没有响应，<code class="fe mj mk ml mm b">kube-proxy</code>可以尝试向另一个pod发送数据包。</p><figure class="ng nh ni nj gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nf"><img src="../Images/096b75ecb2b3f40a78df39e8b374a1aa.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*m2dqKXTsMlz0-70y.png"/></div></div></figure><h2 id="ea81" class="mt lm iq bd ln mu mv dn lr mw mx dp lv kj my mz lz kn na nb md kr nc nd mh ne bi translated">iptables代理模式</h2><p id="8312" class="pw-post-body-paragraph jy jz iq ka b kb mn kd ke kf mo kh ki kj mp kl km kn mq kp kq kr mr kt ku kv ij bi translated">链接:</p><ul class=""><li id="ca1f" class="kw kx iq ka b kb kc kf kg kj ky kn kz kr la kv lb lc ld le bi translated"><a class="ae lf" href="https://kubernetes.io/docs/concepts/services-networking/service/#proxy-mode-iptables" rel="noopener ugc nofollow" target="_blank"> iptables代理模式</a></li><li id="576e" class="kw kx iq ka b kb lg kf lh kj li kn lj kr lk kv lb lc ld le bi translated"><a class="ae lf" href="https://arthurchiao.art/blog/cracking-k8s-node-proxy/#ch_5" rel="noopener ugc nofollow" target="_blank">实现:通过iptables代理</a></li></ul><p id="a9b5" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我们的情况，我们将在本帖中调查。目前，是默认选项。</p><p id="ae22" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">当使用这种模式时，<code class="fe mj mk ml mm b">kube-proxy</code>监视集群中的变化，并为每个新服务打开一个WorkerNode上的TCP端口。</p><p id="0457" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">然后，这个WorkerNode上的<code class="fe mj mk ml mm b">iptables</code>将流量从这个端口发送到Kubernetes服务，这实际上是<code class="fe mj mk ml mm b">iptables</code>规则中的一个链，通过这个链，流量直接到达这个服务的后端pods。在此期间，随机选择一个目标吊舱。</p><p id="ddea" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">由于所有必要的操作都由<code class="fe mj mk ml mm b"><a class="ae lf" href="https://www.netfilter.org/" rel="noopener ugc nofollow" target="_blank">netfilter</a></code>模块在内核中执行，这种模式对系统资源来说更便宜。此外，这种模式工作更快、更可靠，因为没有“中间件”——<code class="fe mj mk ml mm b">kube-proxy</code>本身。</p><p id="1985" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">但是，如果发送数据包的第一个pod没有响应，则连接失败，而在<em class="ms">用户空间代理模式下</em> <code class="fe mj mk ml mm b">kube-proxy</code>会尝试将数据包发送到另一个pod。</p><p id="5543" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">这就是正确配置<a class="ae lf" href="https://kubernetes.io/docs/tasks/configure-pod-container/configure-liveness-readiness-startup-probes/" rel="noopener ugc nofollow" target="_blank">准备就绪探测器</a>如此重要的原因，这样Kubernetes就不会向没有准备好接受流量的pod发送流量。</p><p id="1087" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">此外，这种模式对于调试来说更加复杂，因为在<em class="ms">用户空间代理模式</em>中，<code class="fe mj mk ml mm b">kube-proxy</code>将把它的日志写到<code class="fe mj mk ml mm b">/var/log/kube-proxy</code>中，而使用<code class="fe mj mk ml mm b">netfilter</code>时，你必须调试内核本身。</p><figure class="ng nh ni nj gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nk"><img src="../Images/17155b288bc9e3706408ee00eae02024.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*sT8v61ppVjmj2YE2.png"/></div></div></figure><h2 id="5bb1" class="mt lm iq bd ln mu mv dn lr mw mx dp lv kj my mz lz kn na nb md kr nc nd mh ne bi translated">IPVS代理模式</h2><p id="55e2" class="pw-post-body-paragraph jy jz iq ka b kb mn kd ke kf mo kh ki kj mp kl km kn mq kp kq kr mr kt ku kv ij bi translated">链接:</p><ul class=""><li id="ceb1" class="kw kx iq ka b kb kc kf kg kj ky kn kz kr la kv lb lc ld le bi translated"><a class="ae lf" href="https://kubernetes.io/docs/concepts/services-networking/service/#proxy-mode-ipvs" rel="noopener ugc nofollow" target="_blank"> IPVS代理模式</a></li><li id="456f" class="kw kx iq ka b kb lg kf lh kj li kn lj kr lk kv lb lc ld le bi translated"><a class="ae lf" href="https://arthurchiao.art/blog/cracking-k8s-node-proxy/#ch_6" rel="noopener ugc nofollow" target="_blank">实施:通过IPVS的代理</a></li><li id="0464" class="kw kx iq ka b kb lg kf lh kj li kn lj kr lk kv lb lc ld le bi translated"><a class="ae lf" href="https://kubernetes.io/blog/2018/07/09/ipvs-based-in-cluster-load-balancing-deep-dive/" rel="noopener ugc nofollow" target="_blank">基于IPVS的集群内负载平衡深度探讨</a></li></ul><p id="9d30" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">和最近的模式。它使用了<code class="fe mj mk ml mm b"><a class="ae lf" href="https://man7.org/linux/man-pages/man7/netlink.7.html" rel="noopener ugc nofollow" target="_blank">netlink</a></code>内核模块，并为新的Kubernetes服务创建了新的IPVS规则。</p><p id="5abe" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">主要是负载平衡模式的多样性:</p><ul class=""><li id="57de" class="kw kx iq ka b kb kc kf kg kj ky kn kz kr la kv lb lc ld le bi translated"><code class="fe mj mk ml mm b">rr</code>:循环赛</li><li id="b843" class="kw kx iq ka b kb lg kf lh kj li kn lj kr lk kv lb lc ld le bi translated"><code class="fe mj mk ml mm b">lc</code>:最少连接数(打开的连接数最少)</li><li id="3b4e" class="kw kx iq ka b kb lg kf lh kj li kn lj kr lk kv lb lc ld le bi translated"><code class="fe mj mk ml mm b">dh</code>:目的散列</li><li id="d313" class="kw kx iq ka b kb lg kf lh kj li kn lj kr lk kv lb lc ld le bi translated"><code class="fe mj mk ml mm b">sh</code>:源哈希</li><li id="2dee" class="kw kx iq ka b kb lg kf lh kj li kn lj kr lk kv lb lc ld le bi translated"><code class="fe mj mk ml mm b">sed</code>:最短预期延迟</li><li id="ad89" class="kw kx iq ka b kb lg kf lh kj li kn lj kr lk kv lb lc ld le bi translated"><code class="fe mj mk ml mm b">nq</code>:从不排队</li></ul><figure class="ng nh ni nj gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nk"><img src="../Images/f9db6459e4195c55f7a1f96c9e4d5173.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*m5soTJ9RFwWMZACY.png"/></div></div></figure><h2 id="e851" class="mt lm iq bd ln mu mv dn lr mw mx dp lv kj my mz lz kn na nb md kr nc nd mh ne bi translated"><code class="fe mj mk ml mm b">kube-proxy</code>配置</h2><p id="0bb7" class="pw-post-body-paragraph jy jz iq ka b kb mn kd ke kf mo kh ki kj mp kl km kn mq kp kq kr mr kt ku kv ij bi translated">让我们检查一下在AWS Lastic Kubernetes服务集群中使用了哪种模式。</p><p id="0beb" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">找到<code class="fe mj mk ml mm b">kube-proxy</code>吊舱:</p><pre class="ng nh ni nj gt nl mm nm nn aw no bi"><span id="1a7e" class="mt lm iq mm b gy np nq l nr ns">$ kubectl -n kube-system get pod -l k8s-app=kube-proxy -o wide<br/>NAME READY STATUS RESTARTS AGE IP NODE NOMINATED NODE READINESS GATES<br/>kube-proxy-4prtt 1/1 Running 1 158d 10.3.42.245 ip-10–3–42–245.us-east-2.compute.internal &lt;none&gt; &lt;none&gt;<br/>kube-proxy-5b7pd 1/1 Running 0 60d 10.3.58.133 ip-10–3–58–133.us-east-2.compute.internal &lt;none&gt; &lt;none&gt;<br/>…<br/>kube-proxy-tgl52 1/1 Running 0 59d 10.3.59.159 ip-10–3–59–159.us-east-2.compute.internal &lt;none&gt; &lt;none&gt;</span></pre><p id="5f99" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在集群的每个WorkerNode上，我们都有一个专用的<code class="fe mj mk ml mm b">kube-proxy</code>实例，并附带了<em class="ms">kube-proxy-config</em>config map:</p><pre class="ng nh ni nj gt nl mm nm nn aw no bi"><span id="ab98" class="mt lm iq mm b gy np nq l nr ns">$ kubectl -n kube-system get pod kube-proxy-4prtt -o yaml<br/>apiVersion: v1<br/>kind: Pod<br/>…<br/>spec:<br/>…<br/>containers:<br/>…<br/>volumeMounts:<br/>…<br/>- mountPath: /var/lib/kube-proxy-config/<br/>name: config<br/>…<br/>volumes:<br/>…<br/>- configMap:<br/>defaultMode: 420<br/>name: kube-proxy-config<br/>name: config</span></pre><p id="116a" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">检查此配置图内容:</p><pre class="ng nh ni nj gt nl mm nm nn aw no bi"><span id="333c" class="mt lm iq mm b gy np nq l nr ns">$ kubectl -n kube-system get cm kube-proxy-config -o yaml<br/>apiVersion: v1<br/>data:<br/>config: |-<br/>…<br/>mode: “iptables”<br/>…</span></pre><p id="4bcd" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">现在，当我们更熟悉<code class="fe mj mk ml mm b">kube-proxy</code>模式时——让我们更深入地看看它是如何工作的，以及<code class="fe mj mk ml mm b">iptables</code>在这里做什么。</p><h1 id="fb87" class="ll lm iq bd ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi bi translated">Kubernetes Pod负载平衡</h1><p id="b303" class="pw-post-body-paragraph jy jz iq ka b kb mn kd ke kf mo kh ki kj mp kl km kn mq kp kq kr mr kt ku kv ij bi translated">在我们的旅程中，让我们以一个带有入口(AWS应用程序负载平衡器，ALB)的真实应用程序为例，它向Kubernetes服务发送流量:</p><pre class="ng nh ni nj gt nl mm nm nn aw no bi"><span id="bc50" class="mt lm iq mm b gy np nq l nr ns">$ kubectl -n eks-dev-1-appname-ns get ingress appname-backend-ingress -o yaml<br/>…<br/>- backend:<br/>serviceName: appname-backend-svc<br/>servicePort: 80<br/>…</span></pre><p id="9b4b" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">检查服务本身:</p><pre class="ng nh ni nj gt nl mm nm nn aw no bi"><span id="4453" class="mt lm iq mm b gy np nq l nr ns">$ kubectl -n eks-dev-1-appname-ns get svc<br/>NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE<br/>appname-backend-svc NodePort 172.20.249.22 &lt;none&gt; 80:31103/TCP 63d</span></pre><p id="1e89" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">这里我们有<code class="fe mj mk ml mm b">NodePort</code>类型——它监听WorkerNode上的TCP端口。</p><p id="f4fb" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">ALB<em class="ms">e 172 ad 3 e-eks dev 1 app name-ABAC</em>ALB将流量从客户端路由到<em class="ms">e 172 ad 3 e-4c aa 286 EDF 23 ff 7 e 06d</em>AWS目标组:</p><figure class="ng nh ni nj gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nt"><img src="../Images/81d39c5a718ec92aa9c6c5ee3c5b4698.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*kTwik3EAEbQOH0WH.png"/></div></div></figure><p id="efff" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">该目标组中的ес2正在侦听我们在上面的服务详细信息中看到的31103端口:</p><figure class="ng nh ni nj gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nu"><img src="../Images/da465f5124dc6dec5191c47fed6e8f94.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*2rcyvDMhAhtsEIcD.png"/></div></div></figure><h2 id="aa54" class="mt lm iq bd ln mu mv dn lr mw mx dp lv kj my mz lz kn na nb md kr nc nd mh ne bi translated">AWS负载平衡器流量模式</h2><p id="c909" class="pw-post-body-paragraph jy jz iq ka b kb mn kd ke kf mo kh ki kj mp kl km kn mq kp kq kr mr kt ku kv ij bi translated"><a class="ae lf" href="https://docs.aws.amazon.com/eks/latest/userguide/alb-ingress.html" rel="noopener ugc nofollow" target="_blank">文档&gt; &gt; &gt; </a>。</p><p id="9d98" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">补充说明:AWS ALB支持两种流量模式——IP和实例模式。</p><ul class=""><li id="82ab" class="kw kx iq ka b kb kc kf kg kj ky kn kz kr la kv lb lc ld le bi translated"><strong class="ka ir"> <em class="ms">实例模式</em> </strong>:默认模式，要求Kubernetes服务具有NodePort类型，并将流量路由到WorkerNode的TCP端口</li><li id="a3b5" class="kw kx iq ka b kb lg kf lh kj li kn lj kr lk kv lb lc ld le bi translated"><strong class="ka ir"> <em class="ms"> IP模式</em> </strong>:在此模式下，ALB的目标直接是Kubernetes Pods，而不是Kubernetes Worker节点。</li></ul><p id="68bf" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">现在，我们需要访问其中一个节点—连接到一个堡垒主机，然后连接到一个工作节点:</p><pre class="ng nh ni nj gt nl mm nm nn aw no bi"><span id="0058" class="mt lm iq mm b gy np nq l nr ns">ubuntu@ip-10–3–29–14:~$ ssh ec2-user@10.3.49.200 -i .ssh/bttrm-eks-nodegroup-us-east-2.pem<br/>Last login: Thu May 28 06:25:27 2020 from ip-10–3–29–32.us-east-2.compute.internal<br/>__| __|_ )<br/>_| ( / Amazon Linux 2 AMI<br/>___|\___|___|<br/>39 package(s) needed for security, out of 64 available<br/>Run “sudo yum update” to apply all updates.<br/>[ec2-user@ip-10–3–49–200 ~]$ sudo -s<br/>[root@ip-10–3–49–200 ec2-user]#</span></pre><h2 id="7827" class="mt lm iq bd ln mu mv dn lr mw mx dp lv kj my mz lz kn na nb md kr nc nd mh ne bi translated">k <code class="fe mj mk ml mm b">ube-proxy</code>和<code class="fe mj mk ml mm b">iptables</code></h2><p id="dcf1" class="pw-post-body-paragraph jy jz iq ka b kb mn kd ke kf mo kh ki kj mp kl km kn mq kp kq kr mr kt ku kv ij bi translated">因此，一个来自客户端的数据包到达了WorkerNode。</p><p id="906d" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在该节点上，<code class="fe mj mk ml mm b">kube-proxy</code>服务绑定在分配的端口上，因此没有其他服务会使用它，并且它还创建了一组<code class="fe mj mk ml mm b">iptables</code>规则:</p><pre class="ng nh ni nj gt nl mm nm nn aw no bi"><span id="822b" class="mt lm iq mm b gy np nq l nr ns">[root@ip-10–3–49–200 ec2-user]# netstat -anp | grep 31103<br/>tcp6 0 0 :::31103 :::* LISTEN 4287/kube-proxy</span></pre><p id="46b4" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">数据包到达<em class="ms"> 31107 </em>端口，在那里开始被<code class="fe mj mk ml mm b">iptables</code>过滤器跟踪。</p><h2 id="deba" class="mt lm iq bd ln mu mv dn lr mw mx dp lv kj my mz lz kn na nb md kr nc nd mh ne bi translated"><code class="fe mj mk ml mm b">iptables</code>规则</h2><p id="395c" class="pw-post-body-paragraph jy jz iq ka b kb mn kd ke kf mo kh ki kj mp kl km kn mq kp kq kr mr kt ku kv ij bi translated">链接:</p><ul class=""><li id="3eae" class="kw kx iq ka b kb kc kf kg kj ky kn kz kr la kv lb lc ld le bi translated"><a class="ae lf" href="https://www.frozentux.net/iptables-tutorial/chunkyhtml/c962.html" rel="noopener ugc nofollow" target="_blank">工作台和链条的移动</a></li><li id="f631" class="kw kx iq ka b kb lg kf lh kj li kn lj kr lk kv lb lc ld le bi translated"><a class="ae lf" href="https://upload.wikimedia.org/wikipedia/commons/3/37/Netfilter-packet-flow.svg" rel="noopener ugc nofollow" target="_blank">网络过滤器和通用网络中的数据包流</a></li><li id="9671" class="kw kx iq ka b kb lg kf lh kj li kn lj kr lk kv lb lc ld le bi translated"><a class="ae lf" href="https://www.digitalocean.com/community/tutorials/a-deep-dive-into-iptables-and-netfilter-architecture" rel="noopener ugc nofollow" target="_blank">深入探究Iptables和Netfilter架构</a></li></ul><p id="6b43" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">Linux内核接受这个包，并将其发送到<code class="fe mj mk ml mm b">nat</code>表的<code class="fe mj mk ml mm b">PREROUTING</code>链:</p><figure class="ng nh ni nj gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nv"><img src="../Images/09943f93f12bc6e613bb824d3ffa2afd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*NtoF1xYa0rR0Rpjf.png"/></div></div></figure><p id="1ea9" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">参见<a class="ae lf" href="https://twitter.com/thockin/status/1191766983735296000" rel="noopener ugc nofollow" target="_blank">描述kube-proxy iptables规则</a>。</p><p id="949e" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">检查<code class="fe mj mk ml mm b">nat</code>工作台及其<code class="fe mj mk ml mm b">PREROUTING</code>链中的规则:</p><pre class="ng nh ni nj gt nl mm nm nn aw no bi"><span id="63a2" class="mt lm iq mm b gy np nq l nr ns">[root@ip-10–3–49–200 ec2-user]# iptables -t nat -L PREROUTING | column -t<br/>Chain PREROUTING (policy ACCEPT)<br/>target prot opt source destination<br/>KUBE-SERVICES all — anywhere anywhere /* kubernetes service portals */</span></pre><p id="f3b4" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">这里我们有一个<code class="fe mj mk ml mm b">target</code>到下面的链-<code class="fe mj mk ml mm b">KUBE-SERVICES</code>,它有下一个链- <code class="fe mj mk ml mm b">KUBE-NODEPORTS</code>作为最后一个规则，它为类型为<code class="fe mj mk ml mm b">NodePort</code>的服务捕获数据包:</p><pre class="ng nh ni nj gt nl mm nm nn aw no bi"><span id="b9d1" class="mt lm iq mm b gy np nq l nr ns">[root@ip-10–3–49–200 ec2-user]# iptables -t nat -L KUBE-SERVICES -n | column -t<br/>…<br/>KUBE-NODEPORTS all — 0.0.0.0/0 0.0.0.0/0 /* kubernetes service nodeports; NOTE: this must be the last rule in th<br/>is chain */ ADDRTYPE match dst-type LOCAL<br/>…</span></pre><p id="4c2e" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">检查此链中的规则:</p><pre class="ng nh ni nj gt nl mm nm nn aw no bi"><span id="9757" class="mt lm iq mm b gy np nq l nr ns">[root@ip-10–3–49–200 ec2-user]# iptables -t nat -L KUBE-NODEPORTS -n | column -t | grep 31103<br/>KUBE-MARK-MASQ tcp — 0.0.0.0/0 0.0.0.0/0 /* eks-dev-1-appname-ns/appnamed-backend-svc: */ tcp dpt:31103<br/>KUBE-SVC-TII5GQPKXWC65SRC tcp — 0.0.0.0/0 0.0.0.0/0 /* eks-dev-1-appname-ns/appname-backend-svc: */ tcp dpt:31103</span></pre><p id="2cf5" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">这里它正在拦截<code class="fe mj mk ml mm b">dpt:31103</code> ( <em class="ms">目的端口31103 </em>)的数据包，并将它们发送到下一个链- <code class="fe mj mk ml mm b">KUBE-SVC-TII5GQPKXWC65SRC</code>，现在检查:</p><pre class="ng nh ni nj gt nl mm nm nn aw no bi"><span id="7089" class="mt lm iq mm b gy np nq l nr ns">[root@ip-10–3–49–200 ec2-user]# iptables -t nat -L KUBE-SVC-TII5GQPKXWC65SRC | column -t<br/>Chain KUBE-SVC-TII5GQPKXWC65SRC (2 references)<br/>target prot opt source destination<br/>KUBE-SEP-N36I6W2ULZA2XU52 all — anywhere anywhere statistic mode random probability 0.50000000000<br/>KUBE-SEP-4NFMB5GS6KDP7RHJ all — anywhere anywhere</span></pre><p id="7c40" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在这里，我们可以看到接下来的两个链，这是“路由魔术”发生的地方——数据包将随机发送到这些链中的一个，每个链的“权重”为0.5到1.0(T0)，根据Kubernetes的官方文档<a class="ae lf" href="https://kubernetes.io/docs/concepts/services-networking/service/#proxy-mode-iptables" rel="noopener ugc nofollow" target="_blank"/>:</p><blockquote class="nw nx ny"><p id="e2f2" class="jy jz ms ka b kb kc kd ke kf kg kh ki nz kk kl km oa ko kp kq ob ks kt ku kv ij bi translated">默认情况下，iptables模式下的kube-proxy随机选择一个后端。</p></blockquote><p id="5c0a" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">另请参见<a class="ae lf" href="https://scalingo.com/blog/iptables" rel="noopener ugc nofollow" target="_blank">将IPTables转变为TCP负载平衡器以获得乐趣和利润</a>。</p><p id="7b4b" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">检查那些链条。</p><p id="ea4f" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">第一个:</p><pre class="ng nh ni nj gt nl mm nm nn aw no bi"><span id="749a" class="mt lm iq mm b gy np nq l nr ns">[root@ip-10–3–49–200 ec2-user]# iptables -t nat -L KUBE-SEP-N36I6W2ULZA2XU52 -n | column -t<br/>Chain KUBE-SEP-N36I6W2ULZA2XU52 (1 references)<br/>target prot opt source destination<br/>KUBE-MARK-MASQ all — 10.3.34.219 0.0.0.0/0<br/>DNAT tcp — 0.0.0.0/0 0.0.0.0/0 tcp to:10.3.34.219:3001</span></pre><p id="f43f" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">第二个是:</p><pre class="ng nh ni nj gt nl mm nm nn aw no bi"><span id="2032" class="mt lm iq mm b gy np nq l nr ns">[root@ip-10–3–49–200 ec2-user]# iptables -t nat -L KUBE-SEP-4NFMB5GS6KDP7RHJ -n | column -t<br/>Chain KUBE-SEP-4NFMB5GS6KDP7RHJ (1 references)<br/>target prot opt source destination<br/>KUBE-MARK-MASQ all — 10.3.57.124 0.0.0.0/0<br/>DNAT tcp — 0.0.0.0/0 0.0.0.0/0 tcp to:10.3.57.124:3001</span></pre><p id="7323" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">这里我们可以看到<code class="fe mj mk ml mm b">DNAT</code>(目的地NAT)链正在将数据包发送到一个IP和<em class="ms"> 3001 </em>端口，这实际上是我们的<code class="fe mj mk ml mm b">ContainerPort</code>——检查部署:</p><pre class="ng nh ni nj gt nl mm nm nn aw no bi"><span id="5747" class="mt lm iq mm b gy np nq l nr ns">$ kubectl -n eks-dev-1-appname-ns get deploy appname-backend -o json | jq ‘.spec.template.spec.containers[].ports[].containerPort’<br/>3001</span></pre><p id="fbd5" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">去看我们的豆荚IP。</p><p id="48b9" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">找到豆荚:</p><pre class="ng nh ni nj gt nl mm nm nn aw no bi"><span id="a072" class="mt lm iq mm b gy np nq l nr ns">$ kubectl -n eks-dev-1-appname-ns get pod<br/>NAME READY STATUS RESTARTS AGE<br/>appname-backend-768ddf9f54–2nrp5 1/1 Running 0 3d<br/>appname-backend-768ddf9f54-pm9bh 1/1 Running 0 3d</span></pre><p id="ecdf" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">和第一个pod的IP:</p><pre class="ng nh ni nj gt nl mm nm nn aw no bi"><span id="c9fe" class="mt lm iq mm b gy np nq l nr ns">$ kubectl -n eks-dev-1-appname-ns get pod appname-backend-768ddf9f54–2nrp5 — template={{.status.podIP}}<br/>10.3.34.219</span></pre><p id="b4c4" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">第二个是:</p><pre class="ng nh ni nj gt nl mm nm nn aw no bi"><span id="702f" class="mt lm iq mm b gy np nq l nr ns">$ kubectl -n eks-dev-1-appname-ns get pod appname-backend-768ddf9f54-pm9bh — template={{.status.podIP}}<br/>10.3.57.124</span></pre><p id="42e3" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">是不是很棒？:-)如此简单——又如此伟大。</p><p id="d523" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">现在，让我们尝试扩展我们的部署，看看<code class="fe mj mk ml mm b">KUBE-SVC-TII5GQPKXWC65SRC</code>将如何改变以反映扩展。</p><p id="6c6e" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">查找部署:</p><pre class="ng nh ni nj gt nl mm nm nn aw no bi"><span id="ea65" class="mt lm iq mm b gy np nq l nr ns">$ kubectl -n eks-dev-1-appname-ns get deploy<br/>NAME READY UP-TO-DATE AVAILABLE AGE<br/>appname-backend 2/2 2 2 64d</span></pre><p id="7605" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">将其从两个扩展到三个:</p><pre class="ng nh ni nj gt nl mm nm nn aw no bi"><span id="4f6b" class="mt lm iq mm b gy np nq l nr ns">$ kubectl -n eks-dev-1-appname-ns scale deploy appname-backend — replicas=3<br/>deployment.extensions/appname-backend scaled</span></pre><p id="a461" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">查看<code class="fe mj mk ml mm b">iptables</code>规则:</p><pre class="ng nh ni nj gt nl mm nm nn aw no bi"><span id="a66b" class="mt lm iq mm b gy np nq l nr ns">[root@ip-10–3–49–200 ec2-user]# iptables -t nat -L KUBE-SVC-TII5GQPKXWC65SRC | column -t<br/>Chain KUBE-SVC-TII5GQPKXWC65SRC (2 references)<br/>target prot opt source destination<br/>KUBE-SEP-N36I6W2ULZA2XU52 all — anywhere anywhere statistic mode random probability 0.33332999982<br/>KUBE-SEP-HDIQCDRXRXBGRR55 all — anywhere anywhere statistic mode random probability 0.50000000000<br/>KUBE-SEP-4NFMB5GS6KDP7RHJ all — anywhere anywhere</span></pre><p id="1e66" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">现在我们可以看到我们的<code class="fe mj mk ml mm b">KUBE-SVC-TII5GQPKXWC65SRC</code>有三个规则:第一个是0.33332999982 random，因为后面还有两个规则，然后第二个是0.5 weight，最后一个没有任何规则。</p><p id="e291" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">检查<a class="ae lf" href="http://ipset.netfilter.org/iptables-extensions.man.html#lbCD" rel="noopener ugc nofollow" target="_blank"> iptables统计模块</a>。</p><p id="0f35" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">其实，“<em class="ms">那都是乡亲们！</em></p><h1 id="353c" class="ll lm iq bd ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi bi translated">有用的链接</h1><ul class=""><li id="4bc3" class="kw kx iq ka b kb mn kf mo kj oc kn od kr oe kv lb lc ld le bi translated"><a class="ae lf" href="https://rtfm.co.ua/kubernetes-clusterip-vs-nodeport-vs-loadbalancer-services-i-ingress-obzor-primery/" rel="noopener ugc nofollow" target="_blank"> Kubernetes:集群IP vs节点端口vs负载平衡器，服务и入口— обзор，примеры </a></li><li id="48e0" class="kw kx iq ka b kb lg kf lh kj li kn lj kr lk kv lb lc ld le bi translated"><a class="ae lf" href="https://www.stackrox.com/post/2020/01/kubernetes-networking-demystified/" rel="noopener ugc nofollow" target="_blank"> Kubernetes网络揭秘:简要指南</a></li><li id="20bb" class="kw kx iq ka b kb lg kf lh kj li kn lj kr lk kv lb lc ld le bi translated"><a class="ae lf" href="https://www.digitalocean.com/community/tutorials/a-deep-dive-into-iptables-and-netfilter-architecture" rel="noopener ugc nofollow" target="_blank">深入探究Iptables和Netfilter架构</a></li><li id="3486" class="kw kx iq ka b kb lg kf lh kj li kn lj kr lk kv lb lc ld le bi translated"><a class="ae lf" href="https://www.frozentux.net/iptables-tutorial/chunkyhtml/c962.html" rel="noopener ugc nofollow" target="_blank">工作台和链条的移动</a></li><li id="95b0" class="kw kx iq ka b kb lg kf lh kj li kn lj kr lk kv lb lc ld le bi translated"><a class="ae lf" href="https://scalingo.com/blog/iptables" rel="noopener ugc nofollow" target="_blank">将IPTables变成一个有趣的TCP负载均衡器</a></li><li id="5a93" class="kw kx iq ka b kb lg kf lh kj li kn lj kr lk kv lb lc ld le bi translated"><a class="ae lf" href="https://arthurchiao.art/blog/cracking-k8s-node-proxy/" rel="noopener ugc nofollow" target="_blank">破解kubernetes节点代理(又名kube-proxy) </a></li><li id="4a5d" class="kw kx iq ka b kb lg kf lh kj li kn lj kr lk kv lb lc ld le bi translated"><a class="ae lf" href="https://medium.com/@benmeier_/a-quick-minimal-ipvs-load-balancer-demo-d5cc42d0deb4" rel="noopener">一个最小的IPVS负载平衡器演示</a></li><li id="ba84" class="kw kx iq ka b kb lg kf lh kj li kn lj kr lk kv lb lc ld le bi translated"><a class="ae lf" href="https://medium.com/@selfieblue/how-to-enable-ipvs-mode-on-aws-eks-7159ec676965" rel="noopener">如何在AWS EKS上启用IPVS模式？</a></li><li id="ed75" class="kw kx iq ka b kb lg kf lh kj li kn lj kr lk kv lb lc ld le bi translated"><a class="ae lf" href="https://rancher.com/load-balancing-in-kubernetes" rel="noopener ugc nofollow" target="_blank">Kubernetes中的负载平衡</a></li></ul></div><div class="ab cl of og hu oh" role="separator"><span class="oi bw bk oj ok ol"/><span class="oi bw bk oj ok ol"/><span class="oi bw bk oj ok"/></div><div class="ij ik il im in"><p id="3413" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><em class="ms">最初发布于</em> <a class="ae lf" href="https://rtfm.co.ua/en/jenkins-redis-deployment-and-helm-subchart-values/" rel="noopener ugc nofollow" target="_blank"> <em class="ms"> RTFM: Linux、DevOps和系统管理</em> </a> <em class="ms">。</em></p></div></div>    
</body>
</html>