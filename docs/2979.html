<html>
<head>
<title>A common way of managing configurations for multiple environments (and clouds)</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">管理多种环境(和云)配置的通用方式</h1>
<blockquote>原文：<a href="https://itnext.io/a-standard-way-of-managing-configurations-for-multiple-environments-and-clouds-ee8d54703efc?source=collection_archive---------1-----------------------#2019-09-10">https://itnext.io/a-standard-way-of-managing-configurations-for-multiple-environments-and-clouds-ee8d54703efc?source=collection_archive---------1-----------------------#2019-09-10</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="bf7d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">灵感来自<a class="ae kl" href="https://www.weave.works/technologies/gitops/" rel="noopener ugc nofollow" target="_blank"> GitOps </a>...</p><p id="fddb" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">本文旨在分享解决与配置管理相关的一些挑战的想法和解决方案，尤其是在云环境中。希望你觉得这本书有帮助。</p><p id="5fcd" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">本文中描述的方法是几年前概念化的，然后在许多项目中实现和使用，为生产级系统和应用程序构建配置管理组件。</p><h1 id="0650" class="km kn iq bd ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj bi translated">使用案例</h1><p id="4262" class="pw-post-body-paragraph jn jo iq jp b jq lk js jt ju ll jw jx jy lm ka kb kc ln ke kf kg lo ki kj kk ij bi translated">这个问题很常见，多年来，我们不仅在基于云的部署和环境中看到了它，在本地类型的部署中也看到了它，类似于“隔壁机架中有3个刀片”。这个问题适用于任何有不止一个环境的部署，比如DEV、QA、STG、PROD等等。</p><p id="eb3e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">正如您可能已经猜到的，问题在于配置数据及其管理。Wiki详细讨论了<a class="ae kl" href="https://en.m.wikipedia.org/wiki/Configuration_management" rel="noopener ugc nofollow" target="_blank">配置管理</a>(CM)——CM计划和管理、控制、状态，等等，但是作为架构师和开发工程师，我总是谈论细节(嗯，那就是你知道的人在哪里..)以及如何以最快、最有效的方式完成这项工作。</p><p id="5ad6" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">所以，让我们开始吧...</p><p id="be17" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">当我提到配置数据时，我指的是不同类型的数据:</p><ul class=""><li id="621b" class="lp lq iq jp b jq jr ju jv jy lr kc ls kg lt kk lu lv lw lx bi translated">取一次，用多次</li><li id="1681" class="lp lq iq jp b jq ly ju lz jy ma kc mb kg mc kk lu lv lw lx bi translated">不时取来，多次使用</li><li id="46df" class="lp lq iq jp b jq ly ju lz jy ma kc mb kg mc kk lu lv lw lx bi translated">每次使用时提取</li></ul><p id="2f3b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我不打算深究每种类型的配置数据的细节及其使用案例——如果你是经验丰富的工程师，你很可能对这些很熟悉，如果你不是，<a class="ae kl" href="http://google.com" rel="noopener ugc nofollow" target="_blank">谷歌</a>随时可以提供帮助:)</p><p id="64e2" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">首先，当你开始考虑如何管理你的应用或服务的基本配置参数时，问题就出现了，比如端口号、数据库连接字符串或你的consult DNS——我的意思是你不能硬编码它们！好吧，有办法解决这个问题(配置文件，等等。).但是，如果您的应用程序被容器化或在虚拟机中运行，会发生什么呢？这意味着，为了更改一个配置参数，您必须重新部署应用程序。或者，如果你改变了应用生态系统中的一个东西，它也会级联地重新部署其他组件——有点昂贵，不是吗？现在，随着项目的进行，您会增加解决方案的复杂性，您必须考虑如何管理越来越多的配置，例如Hadoop集群、Spark集群和正在运行的作业，以及整个技术生态系统来运行具有负载平衡和服务发现的Web服务，此外，除此之外，您还会有CI/CD管道，它有自己的配置。现在，将所有这些乘以你可能拥有的环境数量(即<code class="fe md me mf mg b">development</code>、<code class="fe md me mf mg b">prod</code>、<code class="fe md me mf mg b">staging</code>、<code class="fe md me mf mg b">sandbox #1</code>、<code class="fe md me mf mg b">sandbox #2</code>、<code class="fe md me mf mg b">engineering</code>等)。).而且，如果这还不够的话，可以添加安全性和审计(谁在什么时候做了什么)这样的未来。</p><p id="7d4c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">最烦人的是，不再有单一版本的真理了——在应用程序或系统的生命周期中，您的配置开始漂移，而且您通常没有清晰的记录，不知道是谁更改了什么。</p><p id="b48f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">当我们交付分析项目时，CM的复杂性达到了一个全新的水平——使数据科学家能够开发、培训和部署模型(有时相当复杂),而无需一群工程师全天候支持他们。换句话说，分析平台必须强大而稳定，同时还要满足数据科学家的需求，以避免在云消费账单上看到5-6位数的数字。</p><p id="2b40" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在某个时候，我将不得不找时间写文章来描述我们如何构建基于开源、完全容器化和可扩展的分析平台来管理分析模型的整个生命周期(这为我们的一个客户每月节省了数十万美元的云成本…真的不是开玩笑)。</p><p id="69c1" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果以上所述还不够，我们遇到了一些客户的需求，即跨多个云平台(即GCP + Azure + AWS)实施应用程序或各种it组件，这意味着云和应用程序级别的配置管理。</p><p id="27b4" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">总而言之，我们已经确定了对配置数据的需求:</p><ul class=""><li id="2b9a" class="lp lq iq jp b jq jr ju jv jy lr kc ls kg lt kk lu lv lw lx bi translated">真相只有一个版本。</li><li id="140b" class="lp lq iq jp b jq ly ju lz jy ma kc mb kg mc kk lu lv lw lx bi translated">拥有变更的精确记录，以及触发变更的参考(换句话说，审计跟踪)。</li><li id="a9c3" class="lp lq iq jp b jq ly ju lz jy ma kc mb kg mc kk lu lv lw lx bi translated">实现关注点分离，即应用程序应该忙于实现业务逻辑，而不是管理配置。</li><li id="37c9" class="lp lq iq jp b jq ly ju lz jy ma kc mb kg mc kk lu lv lw lx bi translated">管理各种复杂的配置数据，包括嵌套配置。</li><li id="7e4e" class="lp lq iq jp b jq ly ju lz jy ma kc mb kg mc kk lu lv lw lx bi translated">尽可能与云无关，因此支持跨多个云提供商部署的应用程序。</li><li id="0974" class="lp lq iq jp b jq ly ju lz jy ma kc mb kg mc kk lu lv lw lx bi translated">简化部署过程。</li><li id="6efa" class="lp lq iq jp b jq ly ju lz jy ma kc mb kg mc kk lu lv lw lx bi translated">所有级别的配置数据—应用程序、系统、基础架构、部署、时间表等等。</li></ul><p id="8ece" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">咳...</p></div><div class="ab cl mh mi hu mj" role="separator"><span class="mk bw bk ml mm mn"/><span class="mk bw bk ml mm mn"/><span class="mk bw bk ml mm"/></div><div class="ij ik il im in"><h1 id="5a5e" class="km kn iq bd ko kp mo kr ks kt mp kv kw kx mq kz la lb mr ld le lf ms lh li lj bi translated">这一切有解决办法吗？</h1><p id="4df5" class="pw-post-body-paragraph jn jo iq jp b jq lk js jt ju ll jw jx jy lm ka kb kc ln ke kf kg lo ki kj kk ij bi translated">幸运的是，是的。在本文中，我将描述我们提出的解决上述需求的解决方案。</p><p id="87c1" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">解决方案亮点如下</p><ul class=""><li id="d1e9" class="lp lq iq jp b jq jr ju jv jy lr kc ls kg lt kk lu lv lw lx bi translated">集中式配置服务以HA容量运行，使配置数据用户(客户端)能够使用密钥检索它。配置服务可以作为容器部署在独立的节点/机器或Kubernetes集群中。</li><li id="fcd8" class="lp lq iq jp b jq ly ju lz jy ma kc mb kg mc kk lu lv lw lx bi translated">通过API检索的配置数据，以键值对的形式。例如，一个应用程序为了检索Cassandra数据库端口号，将发出一个类似于</li></ul><blockquote class="mt mu mv"><p id="9ea5" class="jn jo mw jp b jq jr js jt ju jv jw jx mx jz ka kb my kd ke kf mz kh ki kj kk ij bi translated"><code class="fe md me mf mg b">curl <a class="ae kl" href="http://config-service.mydomain/api/v1/cassandra/sandbox/cassandra_port" rel="noopener ugc nofollow" target="_blank">http://config-service.mydomain/api/v1/cassandra/sandbox/cassandra_port</a></code></p><p id="b4cf" class="jn jo mw jp b jq jr js jt ju jv jw jx mx jz ka kb my kd ke kf mz kh ki kj kk ij bi translated">其中<code class="fe md me mf mg b">cassandra</code>是应用配置，<code class="fe md me mf mg b">sandbox</code>是环境，<code class="fe md me mf mg b">cassandra_port</code>是配置参数键。</p></blockquote><ul class=""><li id="239a" class="lp lq iq jp b jq jr ju jv jy lr kc ls kg lt kk lu lv lw lx bi translated">配置数据以JSON格式存储，可能采用平面布局的形式，或者相当复杂和嵌套的形式。</li><li id="a1e6" class="lp lq iq jp b jq ly ju lz jy ma kc mb kg mc kk lu lv lw lx bi translated"><strong class="jp ir">我们使用Github服务作为后端来存储配置数据。对于每个部署的环境(开发、qa等)，我们都有一个相应的Git分支。</strong>环境与分支机构的联动不仅限于一对一。例如，您可能有一个涉及几个分支的开发环境:一个用于部署，一个用于应用程序A，一个用于基础设施。正常情况下，分支不会合并。这种方法允许我们对其中一个分支中的配置数据进行更改，这些更改会立即传播到给定环境中运行的应用和服务。此外，跟踪谁做了什么更改也变得非常简单。GitHub配置数据报告可以是公共的，也可以是私有的。此外，除了GitHub，你还可以使用GitLab、GCP源代码管理等等。</li><li id="79dd" class="lp lq iq jp b jq ly ju lz jy ma kc mb kg mc kk lu lv lw lx bi translated">根据设计，配置服务具有可插拔的架构——我们可以将其插入任何后端，如Consul、Cassandra或Git-compatible。</li><li id="b5c2" class="lp lq iq jp b jq ly ju lz jy ma kc mb kg mc kk lu lv lw lx bi translated">它很容易与一个秘密管理后端集成，如哈希公司金库，Azure密钥金库和AWS KMS。</li></ul><p id="5083" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">配置服务架构的概要。</p><figure class="nb nc nd ne gt nf gh gi paragraph-image"><div role="button" tabindex="0" class="ng nh di ni bf nj"><div class="gh gi na"><img src="../Images/e6248f219357a258fb0c44b3ab7509cb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*tzpXPK2PK4UXXrqOdQ8cRQ.jpeg"/></div></div></figure></div><div class="ab cl mh mi hu mj" role="separator"><span class="mk bw bk ml mm mn"/><span class="mk bw bk ml mm mn"/><span class="mk bw bk ml mm"/></div><div class="ij ik il im in"><h1 id="7125" class="km kn iq bd ko kp mo kr ks kt mp kv kw kx mq kz la lb mr ld le lf ms lh li lj bi translated">具体是怎么运作的？</h1><p id="2646" class="pw-post-body-paragraph jn jo iq jp b jq lk js jt ju ll jw jx jy lm ka kb kc ln ke kf kg lo ki kj kk ij bi translated">让我们详细地看一个例子，以便更好地理解这个解决方案。</p><p id="6cb6" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">假设我们有一个应用程序部署在我们正在试验的<code class="fe md me mf mg b">sandbox</code>环境和我们正在开发和测试的<code class="fe md me mf mg b">dev</code>环境中。该应用程序需要连接到Cassandra数据库并做一些事情，我们为每个环境都有不同的Cassandra部署。因此，在配置数据回购中我们将有2个Git分支:<code class="fe md me mf mg b">dev</code>和<code class="fe md me mf mg b">sandbox.</code></p><p id="6308" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在<code class="fe md me mf mg b">dev </code>分支中，<code class="fe md me mf mg b">cassandra.json</code>文件是这样的</p><figure class="nb nc nd ne gt nf gh gi paragraph-image"><div class="gh gi nm"><img src="../Images/de0bb6b5c623c8c16ad95768f444e7ee.png" data-original-src="https://miro.medium.com/v2/resize:fit:888/format:webp/1*Di8ZrtpTrubw6lVzG0nCVg.png"/></div></figure><p id="13b7" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在<code class="fe md me mf mg b">sandbox </code>分支中，<code class="fe md me mf mg b">cassandra.json</code>文件看起来像这样</p><figure class="nb nc nd ne gt nf gh gi paragraph-image"><div class="gh gi nn"><img src="../Images/bf36ef97e20f9ba063fa1171b396c03e.png" data-original-src="https://miro.medium.com/v2/resize:fit:846/format:webp/1*CiLBx7pDrzz3BomQAMd7PA.png"/></div></figure><p id="1d47" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">差别不大，但键<code class="fe md me mf mg b">cassandra_service</code>包含不同的值——嗯，Cassandra有不同的部署(<code class="fe md me mf mg b">dev</code>和<code class="fe md me mf mg b">sandbox</code>)，我需要确保我的应用程序连接到Cassandra，因为该应用程序跨环境部署并完成它的工作。</p><p id="3712" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">话虽如此，如果我们这样打一个<code class="fe md me mf mg b">curl</code>电话:<code class="fe md me mf mg b">curl <a class="ae kl" href="http://config-service.mydomain/api/v1/cassandra/sandbox/cassandra_service." rel="noopener ugc nofollow" target="_blank">http://config-service.mydomain/api/v1/cassandra/sandbox/cassandra_service</a></code></p><p id="72a7" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">它将返回环境<code class="fe md me mf mg b">sandbox</code>的键<code class="fe md me mf mg b">cassandra_service</code>的值，即<code class="fe md me mf mg b">cassandra.dc1</code></p><p id="9bdb" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果我们调用<code class="fe md me mf mg b">dev</code>环境的端点(<code class="fe md me mf mg b"><a class="ae kl" href="http://config-service.mydomain/api/v1/cassandra/sandbox/cassandra_service." rel="noopener ugc nofollow" target="_blank">http://config-service.mydomain/api/v1/cassandra/dev/cassandra_service</a></code>)并检索同一个键的值<code class="fe md me mf mg b">cassandra.dc</code>，也会发生同样的情况。</p><p id="294a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">因此，您的应用程序使用相同的键从特定于当前运行环境的配置服务中检索配置数据，这使得将应用程序部署到不同的环境变得非常容易。您所要做的就是设置一个全局环境变量(在CI/CD的情况下，这可以在Jenkins级别完成)来识别环境并将其传递给<code class="fe md me mf mg b">curl</code> call。</p><p id="d15a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">演示这一点的快速片段:</p><pre class="nb nc nd ne gt no mg np nq aw nr bi"><span id="3c8e" class="ns kn iq mg b gy nt nu l nv nw">$ export ENV=sandbox<br/>$ echo $(curl <a class="ae kl" href="http://config-service.mydomain/api/v1/cassandra/sandbox/cassandra_service." rel="noopener ugc nofollow" target="_blank">http://config-service.mydomain/api/v1/cassandra/${ENV}/cassandra_service</a>)</span><span id="4369" class="ns kn iq mg b gy nx nu l nv nw">cassandra.dc1</span><span id="20a3" class="ns kn iq mg b gy nx nu l nv nw">$ export ENV=dev<br/>$ echo $(curl <a class="ae kl" href="http://config-service.mydomain/api/v1/cassandra/sandbox/cassandra_service." rel="noopener ugc nofollow" target="_blank">http://config-service.mydomain/api/v1/cassandra/${ENV}/cassandra_service</a>)</span><span id="2152" class="ns kn iq mg b gy nx nu l nv nw">cassandra.dc</span></pre><h1 id="34f4" class="km kn iq bd ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj bi translated">在许多云上部署许多应用，但仍然使用相同的配置</h1><p id="1de6" class="pw-post-body-paragraph jn jo iq jp b jq lk js jt ju ll jw jx jy lm ka kb kc ln ke kf kg lo ki kj kk ij bi translated">如果您需要在一个以上的云提供商上部署多个应用程序，就像我在一次项目中遇到的情况一样，并且您仍然希望维护一个单一的存储库来满足您所有的配置数据需求，这里有一个部署模型的快速绘图。</p><figure class="nb nc nd ne gt nf gh gi paragraph-image"><div class="gh gi ny"><img src="../Images/c3ea5e86fdccea839012e6d7681e9c8e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1224/format:webp/1*rDFuvTfmKPltjxmJTJsMVw.jpeg"/></div><figcaption class="nz oa gj gh gi ob oc bd b be z dk translated">多云部署模型</figcaption></figure><p id="f225" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">多云部署模式提供了配置数据管理方式的一致性，并建立了配置的单一版本。</p><p id="a0c6" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">无论您是在Kubernetes上的容器中部署配置服务，在VM中运行它，还是在您的笔记本电脑上本地运行它，您仍然连接到同一个配置后端(在本例中是git repo ),因此它保证了配置的一致性。</p></div><div class="ab cl mh mi hu mj" role="separator"><span class="mk bw bk ml mm mn"/><span class="mk bw bk ml mm mn"/><span class="mk bw bk ml mm"/></div><div class="ij ik il im in"><h1 id="d659" class="km kn iq bd ko kp mo kr ks kt mp kv kw kx mq kz la lb mr ld le lf ms lh li lj bi translated">配置服务部署</h1><p id="907e" class="pw-post-body-paragraph jn jo iq jp b jq lk js jt ju ll jw jx jy lm ka kb kc ln ke kf kg lo ki kj kk ij bi translated">快速注意:请记住，所描述的部署过程是非常轻量级的，旨在演示功能点。生产级部署看起来会更复杂一些。</p><p id="c7d3" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">首先，在我们部署任何东西之前，我们必须设置Git后端来托管我们所有的配置数据。我确实设置了<a class="ae kl" href="https://github.com/OlegGorj/config-data" rel="noopener ugc nofollow" target="_blank">Git repo</a>(OlegGorj/config-data)用于演示目的，它包含多个分支(开发、生产、沙箱)和一堆配置数据文件。</p><p id="2dd5" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">接下来，我们将在本地机器上部署配置服务——关于如何在本地和Google云平台上部署的所有代码和说明都可以在这里找到<a class="ae kl" href="https://github.com/OlegGorj/service-config-data" rel="noopener ugc nofollow" target="_blank"/>。如果您想为这项工作做出贡献，请随时给我写信或在git上发表一个问题。非常感谢任何帮助和建议:)</p><p id="b7d1" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">第一步是检查我们在git后端提交了哪些配置数据。我将使用<code class="fe md me mf mg b">test.json</code>来演示配置服务的执行(<a class="ae kl" href="https://github.com/OlegGorj/config-data/blob/sandbox/test.json" rel="noopener ugc nofollow" target="_blank">https://github . com/oleggorj/config-data/blob/sandbox/test . JSON</a>)</p><pre class="nb nc nd ne gt no mg np nq aw nr bi"><span id="7f47" class="ns kn iq mg b gy nt nu l nv nw">{  "hello": "world"}</span></pre><p id="67af" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">安装主软件包和依赖项:</p><pre class="nb nc nd ne gt no mg np nq aw nr bi"><span id="2515" class="ns kn iq mg b gy nt nu l nv nw">git clone https://github.com/OlegGorj/service-config-data.git<br/>cd service-config-data</span></pre><p id="add6" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">设置GOPATH:</p><pre class="nb nc nd ne gt no mg np nq aw nr bi"><span id="29db" class="ns kn iq mg b gy nt nu l nv nw">echo $GOPATH<br/>export GOPATH=$GOPATH:$PWD<br/>echo $GOPATH</span></pre><p id="9cde" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">确保安装了所有依赖项</p><pre class="nb nc nd ne gt no mg np nq aw nr bi"><span id="9168" class="ns kn iq mg b gy nt nu l nv nw">make deps</span></pre><p id="87ce" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">此时，您的目录应该具有以下结构:</p><pre class="nb nc nd ne gt no mg np nq aw nr bi"><span id="f7a4" class="ns kn iq mg b gy nt nu l nv nw">├── config-data<br/>├── pkg<br/>│   ├── darwin_amd64<br/>│   └── dep<br/>│       └── sources<br/>└── service-config-data<br/>    │   ├── github.com<br/>    │   │   ├── oleggorj<br/>    │   │   │   └── service-common-lib<br/>    │   │   ├── subosito<br/>    │   │   └── tidwall<br/>    │   ├── gitutil<br/>    │   ├── handlers<br/>    │   └── helpers<br/>    ├── vars-gcp.mk<br/>    ├── vars.mk<br/>    └── watch.sh</span></pre><p id="4570" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">构建<code class="fe md me mf mg b">service-config-data</code>服务二进制文件:</p><pre class="nb nc nd ne gt no mg np nq aw nr bi"><span id="1ebb" class="ns kn iq mg b gy nt nu l nv nw">make build</span></pre><p id="c4a6" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">要让服务在本地机器上运行(确保docker正在运行):</p><pre class="nb nc nd ne gt no mg np nq aw nr bi"><span id="1c69" class="ns kn iq mg b gy nt nu l nv nw">make run</span></pre><p id="0d38" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在，测试服务是否正确运行—打开一个新的终端窗口并运行:</p><pre class="nb nc nd ne gt no mg np nq aw nr bi"><span id="44ef" class="ns kn iq mg b gy nt nu l nv nw">$ curl <a class="ae kl" href="http://localhost:8000/api/v2/test/sandbox/hello" rel="noopener ugc nofollow" target="_blank">http://localhost:8000/api/v2/test/sandbox/hello</a></span><span id="d0ef" class="ns kn iq mg b gy nx nu l nv nw">world</span></pre><p id="f8e6" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">服务API允许一个指定输出格式的可选参数(<code class="fe md me mf mg b">?out</code>)。例如，要获取JSON格式的配置数据，运行:</p><pre class="nb nc nd ne gt no mg np nq aw nr bi"><span id="38fd" class="ns kn iq mg b gy nt nu l nv nw">$ curl <a class="ae kl" href="http://localhost:8000/api/v2/test/sandbox/hello?out=json" rel="noopener ugc nofollow" target="_blank">http://localhost:8000/api/v2/test/sandbox/hello?out=json</a></span><span id="c008" class="ns kn iq mg b gy nx nu l nv nw">"world"</span></pre><h1 id="d7c0" class="km kn iq bd ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj bi translated">如何使用配置服务</h1><h2 id="1643" class="ns kn iq bd ko od oe dn ks of og dp kw jy oh oi la kc oj ok le kg ol om li on bi translated"><code class="fe md me mf mg b">config-data</code>储存库</h2><p id="9a24" class="pw-post-body-paragraph jn jo iq jp b jq lk js jt ju ll jw jx jy lm ka kb kc ln ke kf kg lo ki kj kk ij bi translated">考虑分支<code class="fe md me mf mg b">sandbox</code>中配置文件<code class="fe md me mf mg b"><a class="ae kl" href="https://github.com/OlegGorj/config-data/blob/sandbox/k8s-cluster.json" rel="noopener ugc nofollow" target="_blank">k8s-cluster.json</a></code>的一个例子，如下所示</p><pre class="nb nc nd ne gt no mg np nq aw nr bi"><span id="962c" class="ns kn iq mg b gy nt nu l nv nw">{<br/>  "name" : "jx-sandbox",<br/>  "k8s-name" : "k8s-sandbox",<br/>  "apps": [<br/>    {<br/>      "name" : "jenkins",<br/>      "app-type" : "devops"<br/>    },<br/>    {<br/>      "name" : "grafana",<br/>      "app-type" : "devops"<br/>    },<br/>    {<br/>      "name" : "cassandra",<br/>      "app-type" : "storage"<br/>    }<br/>  ],<br/>  "env" : "sandbox",<br/>  "region" : "us-east",<br/>  "git-org" : "",<br/>  "kubectl-ver" : "v1.13.0",<br/>  "helm-ver": "v2.1.3",<br/>  "docker-ver" : "1.12.6",<br/>  "cloud-provider":{<br/>    "name": "ibmcloud",<br/>    "api-endpoint" : "https://api.us-east.bluemix.net"<br/>  }<br/>}</span></pre><p id="5572" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">假设在本地运行配置服务容器(<a class="ae kl" href="http://localhost:8000/" rel="noopener ugc nofollow" target="_blank"> http://localhost:8000 </a>)</p><h2 id="890e" class="ns kn iq bd ko od oe dn ks of og dp kw jy oh oi la kc oj ok le kg ol om li on bi translated"><code class="fe md me mf mg b">service-config-data</code>服务的几个用例</h2><p id="936d" class="pw-post-body-paragraph jn jo iq jp b jq lk js jt ju ll jw jx jy lm ka kb kc ln ke kf kg lo ki kj kk ij bi translated">希望这些例子不言自明:)</p><pre class="nb nc nd ne gt no mg np nq aw nr bi"><span id="c3c3" class="ns kn iq mg b gy nt nu l nv nw">$ curl http://localhost:8000/api/v2/k8s-cluster/sandbox/region</span><span id="5a84" class="ns kn iq mg b gy nx nu l nv nw">us-east</span><span id="ba46" class="ns kn iq mg b gy nx nu l nv nw">$ curl http://localhost:8000/api/v2/k8s-cluster/sandbox/apps</span><span id="9dd8" class="ns kn iq mg b gy nx nu l nv nw">[<br/>  {<br/>    "name" : "jenkins",<br/>    "app-type" : "devops"<br/>  },<br/>  {<br/>    "name" : "grafana",<br/>    "app-type" : "devops"<br/>  },<br/>  {<br/>    "name" : "cassandra",<br/>    "app-type" : "storage"<br/>  }<br/>]</span><span id="8a67" class="ns kn iq mg b gy nx nu l nv nw">$ curl http://localhost:8000/api/v2/k8s-cluster/sandbox/apps.@</span><span id="d077" class="ns kn iq mg b gy nx nu l nv nw">3</span><span id="5804" class="ns kn iq mg b gy nx nu l nv nw">$ curl http://localhost:8000/api/v2/k8s-cluster/sandbox/apps.2</span><span id="ca36" class="ns kn iq mg b gy nx nu l nv nw">{      "name" : "cassandra",      "app-type" : "storage"    }</span><span id="8c99" class="ns kn iq mg b gy nx nu l nv nw">$ curl http://localhost:8000/api/v2/k8s-cluster/sandbox/apps.@.name</span><span id="da6a" class="ns kn iq mg b gy nx nu l nv nw">["jenkins","grafana","cassandra"]</span><span id="0d45" class="ns kn iq mg b gy nx nu l nv nw">$ curl http://localhost:8000/api/v2/k8s-cluster/sandbox/apps.1.name</span><span id="ede7" class="ns kn iq mg b gy nx nu l nv nw">["grafana"]</span><span id="8f03" class="ns kn iq mg b gy nx nu l nv nw">$ curl http://localhost:8000/api/v2/k8s-cluster/sandbox/apps.@(name=="cassandra").app-type</span><span id="3c0d" class="ns kn iq mg b gy nx nu l nv nw">storage</span><span id="821e" class="ns kn iq mg b gy nx nu l nv nw">$ curl http://localhost:8000/api/v2/k8s-cluster/sandbox/apps.@(app-type=="devops")@.name</span><span id="be05" class="ns kn iq mg b gy nx nu l nv nw">["jenkins","grafana"]</span></pre><h1 id="443f" class="km kn iq bd ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj bi translated">使用Helm chart在Kubernetes集群上部署服务</h1><p id="874d" class="pw-post-body-paragraph jn jo iq jp b jq lk js jt ju ll jw jx jy lm ka kb kc ln ke kf kg lo ki kj kk ij bi translated">确保根据模板<code class="fe md me mf mg b">./service-config/src/github.com/oleggorj/service-common-lib/docker/values-template.yaml</code>填充值文件<code class="fe md me mf mg b">./service-config/values.yaml</code></p><p id="822f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">关于<code class="fe md me mf mg b">values.yaml</code>中应该有什么值的更多细节，请参考<code class="fe md me mf mg b">Makefile </code>部分<code class="fe md me mf mg b">deploy</code>——它生成<code class="fe md me mf mg b">values.yaml</code></p><p id="2083" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">通过执行以下命令来部署服务:</p><pre class="nb nc nd ne gt no mg np nq aw nr bi"><span id="100d" class="ns kn iq mg b gy nt nu l nv nw">cd service-config-data/charts<br/>helm upgrade — install config-service — values ./service-config/values.yaml — namespace default ./service-config/</span></pre><p id="572c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">清理:</p><pre class="nb nc nd ne gt no mg np nq aw nr bi"><span id="d72a" class="ns kn iq mg b gy nt nu l nv nw">helm del —-purge config-service</span></pre><h1 id="1e2b" class="km kn iq bd ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj bi translated">与詹金斯一起部署</h1><p id="10dd" class="pw-post-body-paragraph jn jo iq jp b jq lk js jt ju ll jw jx jy lm ka kb kc ln ke kf kg lo ki kj kk ij bi translated">如果您想与Jenkins一起运行此部署，请参考<a class="ae kl" href="https://github.com/OlegGorj/service-config-data/blob/master/Jenkinsfile" rel="noopener ugc nofollow" target="_blank"> Jenkinsfile </a>。</p><h1 id="cd46" class="km kn iq bd ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj bi translated">下一步和有用的未来</h1><p id="a43c" class="pw-post-body-paragraph jn jo iq jp b jq lk js jt ju ll jw jx jy lm ka kb kc ln ke kf kg lo ki kj kk ij bi translated">随着我们的发展，我正在为这项服务添加新的未来，这里有一个快速路线图。</p><ul class=""><li id="1438" class="lp lq iq jp b jq jr ju jv jy lr kc ls kg lt kk lu lv lw lx bi translated">将Git上提交的配置转换为Kubernetes集群上的配置映射并保持同步的选项</li><li id="eb54" class="lp lq iq jp b jq ly ju lz jy ma kc mb kg mc kk lu lv lw lx bi translated">包装依赖自动化</li><li id="6269" class="lp lq iq jp b jq ly ju lz jy ma kc mb kg mc kk lu lv lw lx bi translated">与KMS和保险库集成，管理机密</li><li id="0432" class="lp lq iq jp b jq ly ju lz jy ma kc mb kg mc kk lu lv lw lx bi translated">插件有不同类型的后端，而不是Git</li><li id="06f5" class="lp lq iq jp b jq ly ju lz jy ma kc mb kg mc kk lu lv lw lx bi translated">支持各种配置数据输出格式的服务(纯文本、JSON、XML、Yaml、CSV)</li></ul><p id="0899" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果你能想到这里没有涉及的未来或用例，请随意发送电子邮件，在下面发表评论或在我的Git上提出问题。</p><p id="fc1b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">干杯！</p></div></div>    
</body>
</html>