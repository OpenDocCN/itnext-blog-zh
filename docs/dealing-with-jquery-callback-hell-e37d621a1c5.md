# 异步表单:避免 jQuery 回调地狱

> 原文：<https://itnext.io/dealing-with-jquery-callback-hell-e37d621a1c5?source=collection_archive---------4----------------------->

![](img/e9c56d5bb947696166e22ee39f196303.png)

[图片来源](https://ancient-strengthening-technique-novel.fandom.com/wiki/Hell_Icefire_Phoenix)

唉，jQuery 还没死。曾经受人喜爱的最先进的图书馆，现在感觉像是开发人员屁股上的一根大刺。不管怎样，有数以千计的项目仍然在使用它，而我目前不幸地在其中一个项目上工作。

所以，我有一张登记表。以下是我需要做的:

1.  验证所有信息在服务器端都是正确的
2.  触发 2FA 协议，通过 Twilio 收集和验证用户的电话
3.  令牌化条带卡详细信息并设置订阅
4.  注册用户
5.  如果以上一切正常，登录用户并重定向到他们的个人资料

当然，所有这些都是一个没有任何步骤或会话存储的整体表单。为了火上浇油，整个事情是一个基于插件的架构，其中各个部分由各种插件注入，这些插件可以被启用和/或禁用。

遗憾的是，试图用原生 jQuery(甚至是普通的 DOM)事件处理程序来完成所有这些工作实在是太难了。

a)没有办法确保在表单发送到服务器之前执行验证处理程序，或者确保成功处理程序不会过早或过晚触发，

b)对于处理程序中的承诺，你无能为力——例如，如果你需要与服务器对话并等待其响应，然后再继续处理下一个处理程序，即事件处理程序是同步的，你所能做的就是返回`true`或`false`。

c)很难处理错误，因为回调返回值的二进制性质。

那你是做什么的？

如果我们可以这样做(我在这里使用 RequireJS)会怎么样？

在上面的例子中，我们有一个页面，它有一个表单和两个 AMD 模块，它们在不同的时间被加载，但是它们都想在表单的实例上注册它们的处理程序。我们的构造函数包装了`form`，并允许我们注册`onSubmit`、`onSend`、`onSuccess`和`onError`处理程序。我们希望所有的`onSubmit`处理程序都是异步的，我们希望它们都在数据被发送到服务器之前运行。一旦所有的`onSubmit`处理程序成功解析，也就是说，当我们验证了所有的表单数据，标记了我们的条纹卡输入，执行了我们的 2FA，我们就可以将数据发送到服务器。`onSend`处理程序负责与服务器对话。一旦所有这些都异步完成，我们就可以执行我们的`onSuccess`处理程序，即告诉用户数据已经发送，并将他们重定向到另一个页面。如果有错误，我们希望用`onError`处理程序优雅地处理它们。

让我们创建我们的`ajax/Form`模块，它将利用 jQuery `Deferrable`来实现我们想要的:

就是这样。我希望您下次在碰壁试图获取遗留 jQuery 代码时可以尝试一下用异步逻辑提交复杂表单。