<html>
<head>
<title>How Graph Database works with fbthrift by NebulaGraph Clients</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">图形数据库如何通过NebulaGraph客户端与FB thirty一起工作</h1>
<blockquote>原文：<a href="https://itnext.io/how-graph-database-works-with-fbthrift-by-nebulagraph-clients-54f3131829fc?source=collection_archive---------7-----------------------#2022-10-17">https://itnext.io/how-graph-database-works-with-fbthrift-by-nebulagraph-clients-54f3131829fc?source=collection_archive---------7-----------------------#2022-10-17</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/8cfad596dbfae5147143ebb2aecade21.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ssT8DzwnFxDsKyNQi623jA.jpeg"/></div></div></figure><h1 id="14a7" class="jy jz iq bd ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv bi translated">概观</h1><p id="7dd6" class="pw-post-body-paragraph kw kx iq ky b kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt ij bi translated">NebulaGraph客户端为用户提供多种编程语言的API，与NebulaGraph进行交互，并将服务器返回的数据结构重新打包，以便更好地使用。</p><p id="33c5" class="pw-post-body-paragraph kw kx iq ky b kz lu lb lc ld lv lf lg lh lw lj lk ll lx ln lo lp ly lr ls lt ij bi translated">目前，NebulaGraph客户端支持C++、Java、Python、Golang和Rust。</p><h1 id="7d0e" class="jy jz iq bd ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv bi translated">服务交流框架</h1><p id="3b0f" class="pw-post-body-paragraph kw kx iq ky b kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt ij bi translated">NebulaGraph客户端使用<code class="fe lz ma mb mc b">fbthrift</code><a class="ae md" href="https://github.com/facebook/fbthrift" rel="noopener ugc nofollow" target="_blank">https://github.com/facebook/fbthrift</a>作为服务器和客户端之间服务通信的RPC框架，实现跨语言交互。</p><p id="2455" class="pw-post-body-paragraph kw kx iq ky b kz lu lb lc ld lv lf lg lh lw lj lk ll lx ln lo lp ly lr ls lt ij bi translated">总体而言，fbthrift是:</p><ol class=""><li id="35be" class="me mf iq ky b kz lu ld lv lh mg ll mh lp mi lt mj mk ml mm bi translated">代码生成器:fbthrift有一个代码生成器，可以生成数据结构，这些数据结构可以在不同的语言中使用thrift进行序列化。</li><li id="6853" class="me mf iq ky b kz mn ld mo lh mp ll mq lp mr lt mj mk ml mm bi translated">序列化框架:fbthrift有一组协议来序列化代码生成器生成的结构。</li><li id="101e" class="me mf iq ky b kz mn ld mo lh mp ll mq lp mr lt mj mk ml mm bi translated">一个RPC框架:fbthrift有一个框架在客户端和服务器之间发送消息，并在接收不同语言的消息时调用应用程序定义的函数。</li></ol><h1 id="9cb9" class="jy jz iq bd ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv bi translated">例子</h1><p id="78b8" class="pw-post-body-paragraph kw kx iq ky b kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt ij bi translated">以Golang客户端为例，展示fbthrift在NebulaGraph中的应用。</p><ol class=""><li id="0115" class="me mf iq ky b kz lu ld lv lh mg ll mh lp mi lt mj mk ml mm bi translated">服务器中<code class="fe lz ma mb mc b">Vertex</code>结构的定义:</li></ol><figure class="ms mt mu mv gt jr"><div class="bz fp l di"><div class="mw mx l"/></div></figure><p id="b33c" class="pw-post-body-paragraph kw kx iq ky b kz lu lb lc ld lv lf lg lh lw lj lk ll lx ln lo lp ly lr ls lt ij bi translated">2.在<code class="fe lz ma mb mc b">src/interface/common.thrift</code>中定义一些数据结构:</p><figure class="ms mt mu mv gt jr"><div class="bz fp l di"><div class="mw mx l"/></div></figure><p id="4f07" class="pw-post-body-paragraph kw kx iq ky b kz lu lb lc ld lv lf lg lh lw lj lk ll lx ln lo lp ly lr ls lt ij bi translated">在上面的例子中，我们定义了一个顶点结构。<code class="fe lz ma mb mc b">(cpp.type = "nebula::Vertex")</code>表示该结构对应服务器的<code class="fe lz ma mb mc b">nebula::Vertex</code>。</p><p id="72d7" class="pw-post-body-paragraph kw kx iq ky b kz lu lb lc ld lv lf lg lh lw lj lk ll lx ln lo lp ly lr ls lt ij bi translated">3.fbthrift会自动生成Golang中的数据结构:</p><figure class="ms mt mu mv gt jr"><div class="bz fp l di"><div class="mw mx l"/></div></figure><p id="5ea1" class="pw-post-body-paragraph kw kx iq ky b kz lu lb lc ld lv lf lg lh lw lj lk ll lx ln lo lp ly lr ls lt ij bi translated">4.在<code class="fe lz ma mb mc b">MATCH (v:Person) WHERE id(v) == "ABC" RETURN v</code>中，客户端向服务器请求一个顶点(<code class="fe lz ma mb mc b">nebula::Vertex</code>)。服务器找到后会<strong class="ky ir">序列化</strong>它。服务器找到这个顶点后，会<strong class="ky ir">序列化</strong>，通过RPC通信框架的<code class="fe lz ma mb mc b">transport</code>发送给客户端。当客户端接收到这些数据后，会被<strong class="ky ir">反序列化</strong>，生成客户端定义的相应数据结构(<code class="fe lz ma mb mc b">type Vertex struct</code>)。</p><h1 id="1235" class="jy jz iq bd ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv bi translated">客户</h1><p id="d8f2" class="pw-post-body-paragraph kw kx iq ky b kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt ij bi translated">在本节中，我们将以nebula-go为例，介绍客户端的不同模块及其主要接口。</p><ol class=""><li id="c7f2" class="me mf iq ky b kz lu ld lv lh mg ll mh lp mi lt mj mk ml mm bi translated"><strong class="ky ir">配置</strong>提供整个配置选项。</li></ol><figure class="ms mt mu mv gt jr"><div class="bz fp l di"><div class="mw mx l"/></div></figure><p id="1fa0" class="pw-post-body-paragraph kw kx iq ky b kz lu lb lc ld lv lf lg lh lw lj lk ll lx ln lo lp ly lr ls lt ij bi translated"><strong class="ky ir"> 2。Session </strong>提供用户直接调用的接口。</p><figure class="ms mt mu mv gt jr"><div class="bz fp l di"><div class="mw mx l"/></div></figure><ul class=""><li id="6310" class="me mf iq ky b kz lu ld lv lh mg ll mh lp mi lt my mk ml mm bi translated">接口的定义如下:</li></ul><figure class="ms mt mu mv gt jr"><div class="bz fp l di"><div class="mw mx l"/></div></figure><p id="fdef" class="pw-post-body-paragraph kw kx iq ky b kz lu lb lc ld lv lf lg lh lw lj lk ll lx ln lo lp ly lr ls lt ij bi translated"><strong class="ky ir"> 3。连接池</strong>管理所有的连接。主要界面如下:</p><figure class="ms mt mu mv gt jr"><div class="bz fp l di"><div class="mw mx l"/></div></figure><p id="e686" class="pw-post-body-paragraph kw kx iq ky b kz lu lb lc ld lv lf lg lh lw lj lk ll lx ln lo lp ly lr ls lt ij bi translated"><strong class="ky ir"> 4。连接</strong>将<strong class="ky ir">节俭</strong>的网络打包，并提供以下接口:</p><figure class="ms mt mu mv gt jr"><div class="bz fp l di"><div class="mw mx l"/></div></figure><p id="8980" class="pw-post-body-paragraph kw kx iq ky b kz lu lb lc ld lv lf lg lh lw lj lk ll lx ln lo lp ly lr ls lt ij bi translated"><strong class="ky ir"> 5。负载平衡</strong>在连接池中使用。</p><ul class=""><li id="04aa" class="me mf iq ky b kz lu ld lv lh mg ll mh lp mi lt my mk ml mm bi translated">策略:轮询</li></ul><h1 id="a9f0" class="jy jz iq bd ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv bi translated">模块的相互作用</h1><figure class="ms mt mu mv gt jr gh gi paragraph-image"><div class="gh gi mz"><img src="../Images/2be408773361ed743bdf3232a51c5154.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*QYiWDErVpvM3Aw1H.png"/></div></figure><ol class=""><li id="e29f" class="me mf iq ky b kz lu ld lv lh mg ll mh lp mi lt mj mk ml mm bi translated">连接池</li></ol><ul class=""><li id="e771" class="me mf iq ky b kz lu ld lv lh mg ll mh lp mi lt my mk ml mm bi translated">初始化:</li><li id="6416" class="me mf iq ky b kz mn ld mo lh mp ll mq lp mr lt my mk ml mm bi translated">使用时，用户需要创建并初始化一个<strong class="ky ir">连接池</strong>。在初始化过程中，连接池将在用户指定的NebulaGraph服务地址建立一个<strong class="ky ir">连接</strong>。如果在集群部署方法中部署了多个图形服务，连接池将使用<strong class="ky ir">轮询策略</strong>来平衡负载，并为每个地址建立几乎相等数量的连接。</li><li id="5881" class="me mf iq ky b kz mn ld mo lh mp ll mq lp mr lt my mk ml mm bi translated">管理连接:</li><li id="1d99" class="me mf iq ky b kz mn ld mo lh mp ll mq lp mr lt my mk ml mm bi translated">连接池中维护两个队列，<strong class="ky ir">空闲连接队列</strong>和<strong class="ky ir">活动连接队列</strong>。连接池将定期检测过期的空闲连接并关闭它们。这两个队列会使用<strong class="ky ir">读写锁</strong>来保证添加或删除元素时多线程执行的正确性。</li><li id="2260" class="me mf iq ky b kz mn ld mo lh mp ll mq lp mr lt my mk ml mm bi translated">当会话请求连接到连接池时，它将检查空闲连接队列中是否有可用的连接。如果有任何可用的连接，它们将直接返回到会话供用户使用。如果没有可用的连接，并且当前的连接总数没有超过配置中定义的最大连接数，则会为会话创建一个新连接。如果达到最大连接数，将返回错误。</li><li id="1dde" class="me mf iq ky b kz mn ld mo lh mp ll mq lp mr lt my mk ml mm bi translated">通常，只有在关闭程序时才需要关闭连接池。当程序关闭时，池中的所有连接都将被断开。</li></ul><p id="335c" class="pw-post-body-paragraph kw kx iq ky b kz lu lb lc ld lv lf lg lh lw lj lk ll lx ln lo lp ly lr ls lt ij bi translated">2.会议</p><ul class=""><li id="cbdc" class="me mf iq ky b kz lu ld lv lh mg ll mh lp mi lt my mk ml mm bi translated"><strong class="ky ir">会话</strong>通过连接池生成。用户需要提供密码进行身份验证。认证成功后，用户将获得一个会话实例，并通过会话中的连接与服务器进行通信。最常用的接口是<code class="fe lz ma mb mc b">execute()</code>。如果在执行过程中出现错误，客户端将检查错误类型。如果是网络错误，它将<strong class="ky ir">自动重新连接</strong>并再次尝试执行该语句。</li><li id="47d9" class="me mf iq ky b kz mn ld mo lh mp ll mq lp mr lt my mk ml mm bi translated">注意，会话<strong class="ky ir">不支持被多个线程同时使用</strong>。正确的做法是多线程应用多个会话，每个线程使用一个会话。</li><li id="2d4c" class="me mf iq ky b kz mn ld mo lh mp ll mq lp mr lt my mk ml mm bi translated">当会话被释放时，它持有的连接将被放回连接池的<strong class="ky ir">空闲连接队列</strong>中，以便它可以在以后被其他会话重用。</li></ul><p id="6c92" class="pw-post-body-paragraph kw kx iq ky b kz lu lb lc ld lv lf lg lh lw lj lk ll lx ln lo lp ly lr ls lt ij bi translated">3.关系</p><ul class=""><li id="aceb" class="me mf iq ky b kz lu ld lv lh mg ll mh lp mi lt my mk ml mm bi translated">每个连接示例都是等效的，可以由任何会话持有。<strong class="ky ir">这个设计的目的是允许这些连接被不同的会话重用</strong>，减少重复启用和禁用传输。</li><li id="e63d" class="me mf iq ky b kz mn ld mo lh mp ll mq lp mr lt my mk ml mm bi translated">该连接会将客户端的请求发送到服务器，并将结果返回给会话。</li></ul><p id="6a7e" class="pw-post-body-paragraph kw kx iq ky b kz lu lb lc ld lv lf lg lh lw lj lk ll lx ln lo lp ly lr ls lt ij bi translated">4.例子</p><figure class="ms mt mu mv gt jr"><div class="bz fp l di"><div class="mw mx l"/></div></figure><h1 id="6352" class="jy jz iq bd ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv bi translated"><strong class="ak">返回的数据结构</strong></h1><p id="5720" class="pw-post-body-paragraph kw kx iq ky b kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt ij bi translated">客户端将返回的查询结果通过部分复杂的服务器进行打包，并增加了一个方便使用的接口。</p><figure class="ms mt mu mv gt jr gh gi paragraph-image"><div class="gh gi mz"><img src="../Images/c7cee5986ccec64bbf8b4d829f2daead.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*geJ1ayGtuKTrsyQg.png"/></div></figure><p id="dc1c" class="pw-post-body-paragraph kw kx iq ky b kz lu lb lc ld lv lf lg lh lw lj lk ll lx ln lo lp ly lr ls lt ij bi translated"><code class="fe lz ma mb mc b">nebula::Value</code>在客户端会打包成<code class="fe lz ma mb mc b">ValueWrapper</code>，通过接口转换成其他结构。(即<code class="fe lz ma mb mc b">node = ValueWrapper.asNode()</code>)</p><h1 id="0039" class="jy jz iq bd ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv bi translated">数据结构分析</h1><p id="de98" class="pw-post-body-paragraph kw kx iq ky b kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt ij bi translated">对于<code class="fe lz ma mb mc b">MATCH p= (v:player{name:"Tim Duncan"})-[]-&gt;(v2) RETURN p</code>，返回的结果是:</p><figure class="ms mt mu mv gt jr"><div class="bz fp l di"><div class="mw mx l"/></div></figure><p id="d1d5" class="pw-post-body-paragraph kw kx iq ky b kz lu lb lc ld lv lf lg lh lw lj lk ll lx ln lo lp ly lr ls lt ij bi translated">我们可以看到返回的结果包含一行，它的类型是一个路径。此时，您可以执行如下操作来获取路径(v2)的目标顶点的属性。</p><figure class="ms mt mu mv gt jr"><div class="bz fp l di"><div class="mw mx l"/></div></figure><h1 id="18e9" class="jy jz iq bd ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv bi translated">客户地址</h1><p id="88fe" class="pw-post-body-paragraph kw kx iq ky b kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt ij bi translated">客户端的GitHub地址如下:</p><ul class=""><li id="8034" class="me mf iq ky b kz lu ld lv lh mg ll mh lp mi lt my mk ml mm bi translated"><a class="ae md" href="https://github.com/vesoft-inc/nebula-cpp" rel="noopener ugc nofollow" target="_blank">https://github.com/vesoft-inc/nebula-cpp</a></li><li id="297c" class="me mf iq ky b kz mn ld mo lh mp ll mq lp mr lt my mk ml mm bi translated"><a class="ae md" href="https://github.com/vesoft-inc/nebula-java" rel="noopener ugc nofollow" target="_blank">https://github.com/vesoft-inc/nebula-java</a></li><li id="5427" class="me mf iq ky b kz mn ld mo lh mp ll mq lp mr lt my mk ml mm bi translated"><a class="ae md" href="https://github.com/vesoft-inc/nebula-python" rel="noopener ugc nofollow" target="_blank">https://github.com/vesoft-inc/nebula-python</a></li><li id="5b15" class="me mf iq ky b kz mn ld mo lh mp ll mq lp mr lt my mk ml mm bi translated"><a class="ae md" href="https://github.com/vesoft-inc/nebula-go" rel="noopener ugc nofollow" target="_blank">https://github.com/vesoft-inc/nebula-go</a></li><li id="de72" class="me mf iq ky b kz mn ld mo lh mp ll mq lp mr lt my mk ml mm bi translated"><a class="ae md" href="https://github.com/vesoft-inc/nebula-rust" rel="noopener ugc nofollow" target="_blank">https://github.com/vesoft-inc/nebula-rust</a></li></ul><p id="47ae" class="pw-post-body-paragraph kw kx iq ky b kz lu lb lc ld lv lf lg lh lw lj lk ll lx ln lo lp ly lr ls lt ij bi translated">如果您在使用NebulaGraph的过程中遇到任何问题，请参考<a class="ae md" href="https://docs.nebula-graph.io" rel="noopener ugc nofollow" target="_blank"> NebulaGraph数据库手册</a>解决问题。详细记录了图形数据库和图形数据库星云图的知识点和具体用法。</p><p id="2b79" class="pw-post-body-paragraph kw kx iq ky b kz lu lb lc ld lv lf lg lh lw lj lk ll lx ln lo lp ly lr ls lt ij bi translated">如果你想和星云图社区的其他人讨论这个问题，请加入我们的休闲频道！</p></div></div>    
</body>
</html>