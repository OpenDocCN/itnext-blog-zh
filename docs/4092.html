<html>
<head>
<title>Kubernetes: monitoring with Prometheus — exporters, a Service Discovery, and its roles</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Kubernetes:使用Prometheus-exporters进行监控，服务发现及其作用</h1>
<blockquote>原文：<a href="https://itnext.io/kubernetes-monitoring-with-prometheus-exporters-a-service-discovery-and-its-roles-ce63752e5a1?source=collection_archive---------0-----------------------#2020-04-26">https://itnext.io/kubernetes-monitoring-with-prometheus-exporters-a-service-discovery-and-its-roles-ce63752e5a1?source=collection_archive---------0-----------------------#2020-04-26</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/b6a8a642a20000766d22d063b6b262a9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*hV6a9puShCHDc3oqEdlapA.png"/></div></div></figure><p id="b441" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我们的Kubernetes集群的下一个任务是设置它对Prometheus的监控。</p><p id="2bd0" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">这一任务因以下事实而变得复杂，即需要监控全部资源:</p><ul class=""><li id="57db" class="kw kx iq ka b kb kc kf kg kj ky kn kz kr la kv lb lc ld le bi translated">从基础设施方面——ес2个工作节点实例，它们的CPU、内存、网络、磁盘等</li><li id="6542" class="kw kx iq ka b kb lf kf lg kj lh kn li kr lj kv lb lc ld le bi translated">Kubernetes本身的关键服务——它的API服务器统计、etcd、调度程序</li><li id="5848" class="kw kx iq ka b kb lf kf lg kj lh kn li kr lj kv lb lc ld le bi translated">部署、pod和容器状态</li><li id="8a5d" class="kw kx iq ka b kb lf kf lg kj lh kn li kr lj kv lb lc ld le bi translated">并且需要从集群中运行的应用程序收集一些指标</li></ul><p id="b4a9" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">要监控所有这些，可以使用以下工具:</p><ul class=""><li id="7797" class="kw kx iq ka b kb kc kf kg kj ky kn kz kr la kv lb lc ld le bi translated"><code class="fe lk ll lm ln b"><a class="ae lo" href="https://github.com/kubernetes-sigs/metrics-server" rel="noopener ugc nofollow" target="_blank">metrics-server</a></code> -集群的CPU、内存、文件描述符、磁盘等</li><li id="1370" class="kw kx iq ka b kb lf kf lg kj lh kn li kr lj kv lb lc ld le bi translated"><code class="fe lk ll lm ln b"><a class="ae lo" href="https://github.com/google/cadvisor" rel="noopener ugc nofollow" target="_blank">cAdvisor</a></code>-Docker守护进程指标-容器监控</li><li id="4bc9" class="kw kx iq ka b kb lf kf lg kj lh kn li kr lj kv lb lc ld le bi translated"><code class="fe lk ll lm ln b"><a class="ae lo" href="https://github.com/kubernetes/kube-state-metrics" rel="noopener ugc nofollow" target="_blank">kube-state-metrics</a></code> -部署、单元、节点</li><li id="1ad2" class="kw kx iq ka b kb lf kf lg kj lh kn li kr lj kv lb lc ld le bi translated"><code class="fe lk ll lm ln b"><a class="ae lo" href="https://github.com/prometheus/node_exporter" rel="noopener ugc nofollow" target="_blank">node-exporter</a></code> : EC2实例指标——CPU、内存、网络</li></ul><p id="f036" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><strong class="ka ir">我们将在这篇文章中做些什么？</strong></p><ul class=""><li id="d1e3" class="kw kx iq ka b kb kc kf kg kj ky kn kz kr la kv lb lc ld le bi translated">会启动普罗米修斯服务器</li><li id="d10b" class="kw kx iq ka b kb lf kf lg kj lh kn li kr lj kv lb lc ld le bi translated">启动Redis服务器和<code class="fe lk ll lm ln b">redis-exporter</code>来获取Redis服务器指标</li><li id="2e61" class="kw kx iq ka b kb lf kf lg kj lh kn li kr lj kv lb lc ld le bi translated">将为普罗米修斯号增加一个集群角色</li><li id="0c4d" class="kw kx iq ka b kb lf kf lg kj lh kn li kr lj kv lb lc ld le bi translated">将配置Prometheus Kubernetes服务发现以收集指标:</li><li id="f1a2" class="kw kx iq ka b kb lf kf lg kj lh kn li kr lj kv lb lc ld le bi translated">将对Prometheus Kubernetes服务发现角色发表看法</li><li id="0c14" class="kw kx iq ka b kb lf kf lg kj lh kn li kr lj kv lb lc ld le bi translated">将增加更多出口商:</li><li id="0d60" class="kw kx iq ka b kb lf kf lg kj lh kn li kr lj kv lb lc ld le bi translated">节点导出器</li><li id="ef66" class="kw kx iq ka b kb lf kf lg kj lh kn li kr lj kv lb lc ld le bi translated">kube-状态-度量</li><li id="8fe9" class="kw kx iq ka b kb lf kf lg kj lh kn li kr lj kv lb lc ld le bi translated">метрики cAdvisor</li><li id="c454" class="kw kx iq ka b kb lf kf lg kj lh kn li kr lj kv lb lc ld le bi translated">和度量服务器</li></ul><p id="97e2" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><strong class="ka ir">这一切将如何进行？</strong></p><p id="c65c" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">将使用<a class="ae lo" href="https://rtfm.co.ua/prometehus-obzor-federation-monitoring-docker-swarm-i-nastrojki-alertmanager/#Prometheus_crossservice_federation" rel="noopener ugc nofollow" target="_blank">普罗米修斯联盟</a>:</p><ul class=""><li id="2f65" class="kw kx iq ka b kb kc kf kg kj ky kn kz kr la kv lb lc ld le bi translated">我的项目中已经有Prometheus-Grafana堆栈，用于监控现有资源——这将是我们的“中央”Prometheus服务器，它将从Kubernetes集群中的其他Prometheus服务器获取指标(我们所有的AWS VPC网络通过<a class="ae lo" href="https://rtfm.co.ua/aws-nastrojka-vpc-peering/" rel="noopener ugc nofollow" target="_blank"> VPC对等</a>互连，指标将通过私有子网传输)</li><li id="4606" class="kw kx iq ka b kb lf kf lg kj lh kn li kr lj kv lb lc ld le bi translated">在EKS集群中，我们将启动额外的Prometheus服务器，该服务器将从集群和导出器中提取指标，然后将它们移交给“中央”Prometheus</li></ul><p id="93a8" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><code class="fe lk ll lm ln b"><strong class="ka ir">helm install</strong></code></p><p id="b9e0" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在99%指南中，我在一次调查中发现Kubernetes和Prometheus监控的所有安装和配置都被限制在唯一的一个"<code class="fe lk ll lm ln b">helm install</code>"命令中。</p><p id="04da" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><a class="ae lo" href="https://helm.sh/" rel="noopener ugc nofollow" target="_blank"> Helm </a>它当然很棒——一个模板，一个工具中的包管理器，但问题是它将在引擎盖下做很多事情，但现在我想知道那里到底发生了什么。</p><p id="4912" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">事实上，这是<a class="ae lo" href="https://rtfm.co.ua/en/aws-elastic-kubernetes-service-a-cluster-creation-automation-part-1-cloudformation/" rel="noopener ugc nofollow" target="_blank"> AWS Elastic Kubernetes服务的以下部分:集群创建自动化，第1部分—云形成</a>(英语中的<em class="lp"/>)和<a class="ae lo" href="https://rtfm.co.ua/aws-elastic-kubernetes-service-avtomatizaciya-sozdaniya-klastera-chast-2-ansible-eksctl/" rel="noopener ugc nofollow" target="_blank"> AWS: Elastic Kubernetes服务—автоматизациясозданиякластеиа，часть 2 — Ansible，eksctl </a>(俄语中的<em class="lp">仍然是</em>)，所以在这篇文章中会有一些答案。</p><p id="c058" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">此处使用的版本:</p><ul class=""><li id="cd70" class="kw kx iq ka b kb kc kf kg kj ky kn kz kr la kv lb lc ld le bi translated">kubernetes:(AWS EKS):1 . 15 . 11版</li><li id="10fc" class="kw kx iq ka b kb lf kf lg kj lh kn li kr lj kv lb lc ld le bi translated">普罗米修斯:2.17.1</li><li id="d478" class="kw kx iq ka b kb lf kf lg kj lh kn li kr lj kv lb lc ld le bi translated">kubectl:1 . 18 . 0版</li></ul><p id="0cf9" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><strong class="ka ir">内容</strong></p><ul class=""><li id="a1c3" class="kw kx iq ka b kb kc kf kg kj ky kn kz kr la kv lb lc ld le bi translated"><a class="ae lo" href="https://rtfm.co.ua/en/kubernetes-monitoring-with-prometheus-exporters-a-service-discovery-and-its-roles/#kubectl_context" rel="noopener ugc nofollow" target="_blank"> kubectl上下文</a></li><li id="a56d" class="kw kx iq ka b kb lf kf lg kj lh kn li kr lj kv lb lc ld le bi translated"><a class="ae lo" href="https://rtfm.co.ua/en/kubernetes-monitoring-with-prometheus-exporters-a-service-discovery-and-its-roles/#ConfigMap_Reloader" rel="noopener ugc nofollow" target="_blank">配置图重新加载器</a></li><li id="26b0" class="kw kx iq ka b kb lf kf lg kj lh kn li kr lj kv lb lc ld le bi translated"><a class="ae lo" href="https://rtfm.co.ua/en/kubernetes-monitoring-with-prometheus-exporters-a-service-discovery-and-its-roles/#Start_Prometheus_server_in_Kubernetes" rel="noopener ugc nofollow" target="_blank">在Kubernetes中启动Prometheus服务器</a></li><li id="008a" class="kw kx iq ka b kb lf kf lg kj lh kn li kr lj kv lb lc ld le bi translated"><a class="ae lo" href="https://rtfm.co.ua/en/kubernetes-monitoring-with-prometheus-exporters-a-service-discovery-and-its-roles/#Namespace" rel="noopener ugc nofollow" target="_blank">命名空间</a></li><li id="b32f" class="kw kx iq ka b kb lf kf lg kj lh kn li kr lj kv lb lc ld le bi translated"><a class="ae lo" href="https://rtfm.co.ua/en/kubernetes-monitoring-with-prometheus-exporters-a-service-discovery-and-its-roles/#The_prometheus_yml_ConfigMap" rel="noopener ugc nofollow" target="_blank">普罗米修斯. yml配置图</a></li><li id="a3ea" class="kw kx iq ka b kb lf kf lg kj lh kn li kr lj kv lb lc ld le bi translated"><a class="ae lo" href="https://rtfm.co.ua/en/kubernetes-monitoring-with-prometheus-exporters-a-service-discovery-and-its-roles/#Prometheus_Deployment_and_a_LoadBalancer_Service" rel="noopener ugc nofollow" target="_blank"> Prometheus部署和负载平衡器服务</a></li><li id="3c8e" class="kw kx iq ka b kb lf kf lg kj lh kn li kr lj kv lb lc ld le bi translated"><a class="ae lo" href="https://rtfm.co.ua/en/kubernetes-monitoring-with-prometheus-exporters-a-service-discovery-and-its-roles/#Monitoring_configuration" rel="noopener ugc nofollow" target="_blank">监控配置</a></li><li id="cd83" class="kw kx iq ka b kb lf kf lg kj lh kn li kr lj kv lb lc ld le bi translated"><a class="ae lo" href="https://rtfm.co.ua/en/kubernetes-monitoring-with-prometheus-exporters-a-service-discovery-and-its-roles/#Redis_redisexporter" rel="noopener ugc nofollow" target="_blank">Redis&amp;T27】Redis _ exporter</a></li><li id="fe1f" class="kw kx iq ka b kb lf kf lg kj lh kn li kr lj kv lb lc ld le bi translated"><a class="ae lo" href="https://rtfm.co.ua/en/kubernetes-monitoring-with-prometheus-exporters-a-service-discovery-and-its-roles/#Prometheus_ClusterRole,_ServiceAccount,_and_ClusterRoleBinding" rel="noopener ugc nofollow" target="_blank"> Prometheus ClusterRole、ServiceAccount和ClusterRoleBinding </a></li><li id="611e" class="kw kx iq ka b kb lf kf lg kj lh kn li kr lj kv lb lc ld le bi translated"><a class="ae lo" href="https://rtfm.co.ua/en/kubernetes-monitoring-with-prometheus-exporters-a-service-discovery-and-its-roles/#Prometheus_Kubernetes_Service_Discovery" rel="noopener ugc nofollow" target="_blank"> Prometheus Kubernetes服务发现</a></li><li id="f53c" class="kw kx iq ka b kb lf kf lg kj lh kn li kr lj kv lb lc ld le bi translated"><a class="ae lo" href="https://rtfm.co.ua/en/kubernetes-monitoring-with-prometheus-exporters-a-service-discovery-and-its-roles/#kubernetessdconfig_roles" rel="noopener ugc nofollow" target="_blank"> kubernetes_sd_config角色</a></li><li id="90df" class="kw kx iq ka b kb lf kf lg kj lh kn li kr lj kv lb lc ld le bi translated"><a class="ae lo" href="https://rtfm.co.ua/en/kubernetes-monitoring-with-prometheus-exporters-a-service-discovery-and-its-roles/#node_role" rel="noopener ugc nofollow" target="_blank">节点角色</a></li><li id="329f" class="kw kx iq ka b kb lf kf lg kj lh kn li kr lj kv lb lc ld le bi translated"><a class="ae lo" href="https://rtfm.co.ua/en/kubernetes-monitoring-with-prometheus-exporters-a-service-discovery-and-its-roles/#pod_role" rel="noopener ugc nofollow" target="_blank"> pod角色</a></li><li id="95d7" class="kw kx iq ka b kb lf kf lg kj lh kn li kr lj kv lb lc ld le bi translated"><a class="ae lo" href="https://rtfm.co.ua/en/kubernetes-monitoring-with-prometheus-exporters-a-service-discovery-and-its-roles/#nodeexporter_metrics" rel="noopener ugc nofollow" target="_blank">节点-导出器指标</a></li><li id="e40c" class="kw kx iq ka b kb lf kf lg kj lh kn li kr lj kv lb lc ld le bi translated"><a class="ae lo" href="https://rtfm.co.ua/en/kubernetes-monitoring-with-prometheus-exporters-a-service-discovery-and-its-roles/#kubestatemetrics" rel="noopener ugc nofollow" target="_blank"> kube状态指标</a></li><li id="ca45" class="kw kx iq ka b kb lf kf lg kj lh kn li kr lj kv lb lc ld le bi translated">管理员</li><li id="9d46" class="kw kx iq ka b kb lf kf lg kj lh kn li kr lj kv lb lc ld le bi translated"><a class="ae lo" href="https://rtfm.co.ua/en/kubernetes-monitoring-with-prometheus-exporters-a-service-discovery-and-its-roles/#metricsserver" rel="noopener ugc nofollow" target="_blank">指标-服务器</a></li></ul></div><div class="ab cl lq lr hu ls" role="separator"><span class="lt bw bk lu lv lw"/><span class="lt bw bk lu lv lw"/><span class="lt bw bk lu lv"/></div><div class="ij ik il im in"><h2 id="c5bb" class="lx ly iq bd lz ma mb dn mc md me dp mf kj mg mh mi kn mj mk ml kr mm mn mo mp bi translated"><code class="fe lk ll lm ln b">kubectl</code>上下文</h2><p id="0f20" class="pw-post-body-paragraph jy jz iq ka b kb mq kd ke kf mr kh ki kj ms kl km kn mt kp kq kr mu kt ku kv ij bi translated">首先，配置对集群的访问——为您的<code class="fe lk ll lm ln b">kubectl</code>添加一个新的上下文:</p><pre class="mv mw mx my gt mz ln na nb aw nc bi"><span id="441d" class="lx ly iq ln b gy nd ne l nf ng">$ aws --region eu-west-2 eks update-kubeconfig --name bttrm-eks-dev-2<br/>Added new context arn:aws:eks:eu-west-2:534***385:cluster/bttrm-eks-dev-2 to /home/admin/.kube/config</span></pre><p id="cfe9" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">或者切换到已经存在的(如果有的话):</p><pre class="mv mw mx my gt mz ln na nb aw nc bi"><span id="6b22" class="lx ly iq ln b gy nd ne l nf ng">$ kubectl config get-contexts<br/>…<br/>arn:aws:eks:eu-west-2:534****385:cluster/bttrm-eks-dev-1<br/>…<br/>kubectl config use-context arn:aws:eks:eu-west-2:534***385:cluster/bttrm-eks-dev-2<br/>Switched to context “arn:aws:eks:eu-west-2:534***385:cluster/bttrm-eks-dev-2”.</span></pre></div><div class="ab cl lq lr hu ls" role="separator"><span class="lt bw bk lu lv lw"/><span class="lt bw bk lu lv lw"/><span class="lt bw bk lu lv"/></div><div class="ij ik il im in"><h2 id="d91a" class="lx ly iq bd lz ma mb dn mc md me dp mf kj mg mh mi kn mj mk ml kr mm mn mo mp bi translated"><code class="fe lk ll lm ln b">ConfigMap</code>重装机</h2><p id="18ed" class="pw-post-body-paragraph jy jz iq ka b kb mq kd ke kf mr kh ki kj ms kl km kn mt kp kq kr mu kt ku kv ij bi translated">因为我们现在要对未来的普罗米修斯号的<code class="fe lk ll lm ln b">ConfigMap</code>做很多改动，增加<a class="ae lo" href="https://rtfm.co.ua/en/kubernetes-configmaps-and-secrets-on-a-gorush-server-example/" rel="noopener ugc nofollow" target="_blank">重装器</a>，所以吊舱会在没有我们干预的情况下立即应用这些改动。</p><p id="6f84" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">创建目录:</p><pre class="mv mw mx my gt mz ln na nb aw nc bi"><span id="e66b" class="lx ly iq ln b gy nd ne l nf ng">$ mkdir -p roles/reloader/tasks</span></pre><p id="6b85" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">这里只有一个任务——重装机安装。会用到<code class="fe lk ll lm ln b">kubectl</code>，用Ansible <code class="fe lk ll lm ln b"><a class="ae lo" href="https://docs.ansible.com/ansible/latest/modules/command_module.html" rel="noopener ugc nofollow" target="_blank">command</a></code>模块调用。</p><p id="8d1b" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在<code class="fe lk ll lm ln b">roles/reloader/tasks/main.yml</code>中添加以下内容:</p><pre class="mv mw mx my gt mz ln na nb aw nc bi"><span id="2e38" class="lx ly iq ln b gy nd ne l nf ng">- name: "Install Reloader"<br/>  command: "kubectl apply -f https://raw.githubusercontent.com/stakater/Reloader/master/deployments/kubernetes/reloader.yaml"</span></pre><p id="dea4" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">现在够了——我只是没有时间去深究<code class="fe lk ll lm ln b"><a class="ae lo" href="https://docs.ansible.com/ansible/latest/modules/k8s_module.html" rel="noopener ugc nofollow" target="_blank">k8s</a></code>和它与<code class="fe lk ll lm ln b">python-requests</code>进口的问题。</p><p id="3196" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">将此角色添加到行动手册中:</p><pre class="mv mw mx my gt mz ln na nb aw nc bi"><span id="c0a7" class="lx ly iq ln b gy nd ne l nf ng">- hosts:<br/>  - all<br/>  become:<br/>    true<br/>  roles:<br/>    - role: cloudformation<br/>      tags: infra<br/>    - role: eksctl<br/>      tags: eks<br/>    - role: reloader<br/>      tags: reloader</span></pre><p id="456e" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">运行:</p><pre class="mv mw mx my gt mz ln na nb aw nc bi"><span id="4603" class="lx ly iq ln b gy nd ne l nf ng">$ ansible-playbook eks-cluster.yml --tags reloader</span></pre><p id="3ab7" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">并检查:</p><pre class="mv mw mx my gt mz ln na nb aw nc bi"><span id="c3c7" class="lx ly iq ln b gy nd ne l nf ng">$ kubectl get po<br/>NAME READY STATUS RESTARTS AGE]<br/>reloader-reloader-55448df76c-9l9j7 1/1 Running 0 3m20s</span></pre></div><div class="ab cl lq lr hu ls" role="separator"><span class="lt bw bk lu lv lw"/><span class="lt bw bk lu lv lw"/><span class="lt bw bk lu lv"/></div><div class="ij ik il im in"><h2 id="1c98" class="lx ly iq bd lz ma mb dn mc md me dp mf kj mg mh mi kn mj mk ml kr mm mn mo mp bi translated">在Kubernetes启动Prometheus服务器</h2><p id="a8ab" class="pw-post-body-paragraph jy jz iq ka b kb mq kd ke kf mr kh ki kj ms kl km kn mt kp kq kr mu kt ku kv ij bi translated">首先，让我们启动集群中的普罗米修斯本身。</p><p id="92d5" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">它的配置文件将被保存为一个<code class="fe lk ll lm ln b">ConfigMap</code>对象。</p><p id="3a6b" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">集群已经创建好了，将来一切都将由Ansible管理，所以在这里添加它的目录结构</p><pre class="mv mw mx my gt mz ln na nb aw nc bi"><span id="335d" class="lx ly iq ln b gy nd ne l nf ng">$ mkdir -p roles/monitoring/{tasks,templates}</span></pre></div><div class="ab cl lq lr hu ls" role="separator"><span class="lt bw bk lu lv lw"/><span class="lt bw bk lu lv lw"/><span class="lt bw bk lu lv"/></div><div class="ij ik il im in"><h2 id="12ba" class="lx ly iq bd lz ma mb dn mc md me dp mf kj mg mh mi kn mj mk ml kr mm mn mo mp bi translated">名称空间</h2><p id="1964" class="pw-post-body-paragraph jy jz iq ka b kb mq kd ke kf mr kh ki kj ms kl km kn mt kp kq kr mu kt ku kv ij bi translated">所有与监控相关的资源都将保存在一个专用的Kubernetes名称空间中。</p><p id="1d7c" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在<code class="fe lk ll lm ln b">roles/monitoring/templates/</code>目录下添加一个配置文件，比如称它为<code class="fe lk ll lm ln b">prometheus-ns.yml.j2</code>:</p><pre class="mv mw mx my gt mz ln na nb aw nc bi"><span id="eabf" class="lx ly iq ln b gy nd ne l nf ng">---<br/>apiVersion: v1<br/>kind: Namespace<br/>metadata:<br/>  name: monitoring</span></pre><p id="716f" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">添加一个新文件<code class="fe lk ll lm ln b">roles/monitoring/tasks/main.yml</code>来创建名称空间:</p><pre class="mv mw mx my gt mz ln na nb aw nc bi"><span id="016c" class="lx ly iq ln b gy nd ne l nf ng">- name: "Create the Monitoring Namespace"<br/>  command: "kubectl apply -f roles/monitoring/templates/prometheus-ns.yml.j2"</span></pre><p id="2f9a" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">将角色添加到行动手册中:</p><pre class="mv mw mx my gt mz ln na nb aw nc bi"><span id="bd57" class="lx ly iq ln b gy nd ne l nf ng">- hosts:<br/>  - all<br/>  become:<br/>    true<br/>  roles:<br/>    - role: cloudformation<br/>      tags: infra<br/>    - role: eksctl<br/>      tags: eks<br/>    - role: reloader<br/>      tags: reloader<br/>    - role: monitoring<br/>      tags: monitoring</span></pre><p id="f1da" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">运行以测试:</p><pre class="mv mw mx my gt mz ln na nb aw nc bi"><span id="d277" class="lx ly iq ln b gy nd ne l nf ng">$ ansible-playbook eks-cluster.yml — tags monitoring</span></pre><p id="7d7e" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">检查:</p><pre class="mv mw mx my gt mz ln na nb aw nc bi"><span id="d5f2" class="lx ly iq ln b gy nd ne l nf ng">$ kubectl get ns<br/>NAME STATUS AGE<br/>default Active 24m<br/>kube-node-lease Active 25m<br/>kube-public Active 25m<br/>kube-system Active 25m<br/>monitoring Active 32s</span></pre></div><div class="ab cl lq lr hu ls" role="separator"><span class="lt bw bk lu lv lw"/><span class="lt bw bk lu lv lw"/><span class="lt bw bk lu lv"/></div><div class="ij ik il im in"><h2 id="3961" class="lx ly iq bd lz ma mb dn mc md me dp mf kj mg mh mi kn mj mk ml kr mm mn mo mp bi translated"><code class="fe lk ll lm ln b">prometheus.yml</code>配置图</h2><p id="bc35" class="pw-post-body-paragraph jy jz iq ka b kb mq kd ke kf mr kh ki kj ms kl km kn mt kp kq kr mu kt ku kv ij bi translated">如前所述，Prometheus配置数据将保存在<code class="fe lk ll lm ln b">ConfigMap</code>中。</p><p id="4412" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">创建一个名为<code class="fe lk ll lm ln b">roles/monitoring/templates/prometheus-configmap.yml.j2</code>的新文件——这是一个最小的配置:</p><pre class="mv mw mx my gt mz ln na nb aw nc bi"><span id="f6e6" class="lx ly iq ln b gy nd ne l nf ng">---<br/>apiVersion: v1<br/>kind: ConfigMap<br/>metadata:<br/>  name: prometheus-config<br/>  namespace: monitoring<br/>data:<br/>  prometheus.yml: |<br/>    global:<br/>      scrape_interval:     15s<br/>      external_labels:<br/>        monitor: 'eks-dev-monitor'<br/>    scrape_configs:<br/>      - job_name: 'prometheus'<br/>        scrape_interval: 5s<br/>        static_configs:<br/>          - targets: ['localhost:9090']</span></pre><p id="60cf" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">将其添加到<code class="fe lk ll lm ln b">roles/monitoring/tasks/main.yml</code>:</p><pre class="mv mw mx my gt mz ln na nb aw nc bi"><span id="054c" class="lx ly iq ln b gy nd ne l nf ng">- name: "Create the Monitoring Namespace"<br/>  command: "kubectl apply -f roles/monitoring/templates/prometheus-ns.yml.j2"<br/><br/>- name: "Create prometheus.yml ConfigMap"<br/>  command: "kubectl apply -f roles/monitoring/templates/prometheus-configmap.yml.j2"</span></pre><p id="c7d6" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">现在可以再检查一次——向上涂抹并检查<code class="fe lk ll lm ln b">ConfigMap</code>内容:</p><pre class="mv mw mx my gt mz ln na nb aw nc bi"><span id="ad42" class="lx ly iq ln b gy nd ne l nf ng">$ kubectl -n monitoring get configmap prometheus-config -o yaml<br/>apiVersion: v1<br/>data:<br/>prometheus.yml: |<br/>global:<br/>scrape_interval: 15s<br/>external_labels:<br/>monitor: ‘eks-dev-monitor’<br/>scrape_configs:<br/>- job_name: ‘prometheus’<br/>scrape_interval: 5s<br/>static_configs:<br/>- targets: [‘localhost:9090’]<br/>kind: ConfigMap<br/>…</span></pre></div><div class="ab cl lq lr hu ls" role="separator"><span class="lt bw bk lu lv lw"/><span class="lt bw bk lu lv lw"/><span class="lt bw bk lu lv"/></div><div class="ij ik il im in"><h2 id="3fb5" class="lx ly iq bd lz ma mb dn mc md me dp mf kj mg mh mi kn mj mk ml kr mm mn mo mp bi translated">Prometheus部署和负载平衡器服务</h2><p id="ec70" class="pw-post-body-paragraph jy jz iq ka b kb mq kd ke kf mr kh ki kj ms kl km kn mt kp kq kr mu kt ku kv ij bi translated">现在我们可以启动普罗米修斯号了。</p><p id="2385" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">创建其部署文件— <code class="fe lk ll lm ln b">roles/monitoring/templates/prometheus-deployment.yml.j2</code>:</p><pre class="mv mw mx my gt mz ln na nb aw nc bi"><span id="2e78" class="lx ly iq ln b gy nd ne l nf ng">---<br/>apiVersion: apps/v1<br/>kind: Deployment<br/>metadata:<br/>  name: prometheus-server<br/>  labels:<br/>    app: prometheus<br/>  namespace: monitoring<br/>  annotations:<br/>    reloader.stakater.com/auto: "true"<br/>#    service.beta.kubernetes.io/aws-load-balancer-internal: "true"  <br/>spec:<br/>  replicas: 2<br/>  selector:<br/>    matchLabels: <br/>      app: prometheus<br/>  template:<br/>    metadata:<br/>      labels:<br/>        app: prometheus<br/>    spec:<br/>      containers:<br/>      - name: prometheus-server<br/>        image: prom/prometheus<br/>        volumeMounts:<br/>          - name: prometheus-config-volume<br/>            mountPath: /etc/prometheus/prometheus.yml<br/>            subPath: prometheus.yml<br/>        ports:<br/>        - containerPort: 9090<br/>      volumes:<br/>        - name: prometheus-config-volume<br/>          configMap:<br/>            name: prometheus-config<br/>---<br/>kind: Service<br/>apiVersion: v1<br/>metadata:<br/>  name: prometheus-server-alb<br/>  namespace: monitoring<br/>spec:<br/>  selector:<br/>    app: prometheus<br/>  ports:<br/>    - protocol: TCP<br/>      port: 80<br/>      targetPort: 9090<br/>  type: LoadBalancer</span></pre><p id="c584" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">这里:</p><ol class=""><li id="255e" class="kw kx iq ka b kb kc kf kg kj ky kn kz kr la kv nh lc ld le bi translated">用普罗米修斯制造两个豆荚</li><li id="d3a9" class="kw kx iq ka b kb lf kf lg kj lh kn li kr lj kv nh lc ld le bi translated">附上<em class="lp">Prometheus-config</em>T15】</li><li id="e6a5" class="kw kx iq ka b kb lf kf lg kj lh kn li kr lj kv nh lc ld le bi translated">用<code class="fe lk ll lm ln b">LoadBalancer</code>类型创建一个<code class="fe lk ll lm ln b">Service</code>来访问9090端口上的Prometheus服务器——这将创建一个经典类型的AWS负载平衡器(不是应用程序LB ),在80端口上有一个监听器</li></ol><p id="84b8" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">此处的注释:</p><ul class=""><li id="a0d6" class="kw kx iq ka b kb kc kf kg kj ky kn kz kr la kv lb lc ld le bi translated"><em class="lp">reloader.stakater.com/auto:真</em> —用于重装服务</li><li id="d6b7" class="kw kx iq ka b kb lf kf lg kj lh kn li kr lj kv lb lc ld le bi translated"><em class="lp">service.beta.kubernetes.io/aws-load-balancer-internal:真</em>可以评论，就目前而言，稍后<code class="fe lk ll lm ln b">Internal</code>将用于配置<a class="ae lo" href="https://rtfm.co.ua/aws-nastrojka-vpc-peering/" rel="noopener ugc nofollow" target="_blank"> VPC对等</a>和<a class="ae lo" href="https://rtfm.co.ua/prometehus-obzor-federation-monitoring-docker-swarm-i-nastrojki-alertmanager/" rel="noopener ugc nofollow" target="_blank">普罗米修斯联盟</a>，此时让我们使用面向互联网</li></ul><p id="c12d" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">添加到<code class="fe lk ll lm ln b">tasks</code>:</p><pre class="mv mw mx my gt mz ln na nb aw nc bi"><span id="7f53" class="lx ly iq ln b gy nd ne l nf ng">...<br/>- name: "Deploy Prometheus server and its LoadBalancer"<br/>  command: "kubectl apply -f roles/monitoring/templates/prometheus-deployment.yml.j2"</span></pre><p id="2b14" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">运行:</p><pre class="mv mw mx my gt mz ln na nb aw nc bi"><span id="4d22" class="lx ly iq ln b gy nd ne l nf ng">$ ansible-playbook eks-cluster.yml --tags monitoring<br/>…<br/>TASK [monitoring : Deploy Prometheus server and its LoadBalancer] ****<br/>changed: [localhost]<br/>…</span></pre><p id="b562" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">检查舱:</p><pre class="mv mw mx my gt mz ln na nb aw nc bi"><span id="3aa9" class="lx ly iq ln b gy nd ne l nf ng">$ kubectl -n monitoring get pod<br/>NAME READY STATUS RESTARTS AGE<br/>prometheus-server-85989544df-pgb8c 1/1 Running 0 38s<br/>prometheus-server-85989544df-zbrsx 1/1 Running 0 38s</span></pre><p id="0d80" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">负载平衡器服务:</p><pre class="mv mw mx my gt mz ln na nb aw nc bi"><span id="b402" class="lx ly iq ln b gy nd ne l nf ng">$ kubectl -n monitoring get svc<br/>NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE<br/>prometheus-server-alb LoadBalancer 172.20.160.199 ac690710a9747460abc19cd999812af8–1463800400.eu-west-2.elb.amazonaws.com 80:30190/TCP 42s</span></pre><p id="6110" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">或者在AWS仪表板中:</p><figure class="mv mw mx my gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi ni"><img src="../Images/9c2d2264904a230f8bb50a253257332b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*r0QvhgyePfzJVwyg.png"/></div></div></figure><p id="2414" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">选中它—在浏览器中打开:</p><figure class="mv mw mx my gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nj"><img src="../Images/4352834eab3b7576b1b2606e85e09142.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*4m7_9iMe5liwuxNm.png"/></div></div></figure><p id="db95" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">如果负载平衡器有任何问题，可以在这里使用端口转发:</p><pre class="mv mw mx my gt mz ln na nb aw nc bi"><span id="9725" class="lx ly iq ln b gy nd ne l nf ng">$ kubectl -n monitoring port-forward prometheus-server-85989544df-pgb8c 9090:9090<br/>Forwarding from 127.0.0.1:9090 -&gt; 9090<br/>Forwarding from [::1]:9090 -&gt; 9090</span></pre><p id="4e84" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">这样，就可以使用http://<em class="lp">localhost:9090</em>URL访问Prometheus。</p></div><div class="ab cl lq lr hu ls" role="separator"><span class="lt bw bk lu lv lw"/><span class="lt bw bk lu lv lw"/><span class="lt bw bk lu lv"/></div><div class="ij ik il im in"><h2 id="2cf9" class="lx ly iq bd lz ma mb dn mc md me dp mf kj mg mh mi kn mj mk ml kr mm mn mo mp bi translated">监控配置</h2><p id="44fb" class="pw-post-body-paragraph jy jz iq ka b kb mq kd ke kf mr kh ki kj ms kl km kn mt kp kq kr mu kt ku kv ij bi translated">好了，我们已经启动了普罗米修斯，现在我们可以收集一些指标了。</p><p id="777b" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">让我们从最简单的任务开始——启动某个服务，一个它的导出器，并配置Prometheus来收集它的指标。</p><h2 id="bfa2" class="lx ly iq bd lz ma mb dn mc md me dp mf kj mg mh mi kn mj mk ml kr mm mn mo mp bi translated">雷迪斯&amp;&amp; <code class="fe lk ll lm ln b">redis_exporter</code></h2><p id="e3f4" class="pw-post-body-paragraph jy jz iq ka b kb mq kd ke kf mr kh ki kj ms kl km kn mt kp kq kr mu kt ku kv ij bi translated">为此，我们可以使用Redis服务器和<code class="fe lk ll lm ln b"><a class="ae lo" href="https://github.com/oliver006/redis_exporter" rel="noopener ugc nofollow" target="_blank">redis_exporter</a></code>。</p><p id="c888" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">创建一个新的部署文件<code class="fe lk ll lm ln b">roles/monitoring/templates/tests/redis-server-and-exporter-deployment.yml.j2</code>:</p><pre class="mv mw mx my gt mz ln na nb aw nc bi"><span id="a24a" class="lx ly iq ln b gy nd ne l nf ng">---<br/>apiVersion: extensions/v1beta1<br/>kind: Deployment<br/>metadata:<br/>  name: redis<br/>spec:<br/>  replicas: 1<br/>  template:<br/>    metadata:<br/>      annotations:<br/>        prometheus.io/scrape: "true"<br/>      labels:<br/>        app: redis<br/>    spec:<br/>      containers:<br/>      - name: redis<br/>        image: redis<br/>        resources:<br/>          requests:<br/>            cpu: 100m<br/>            memory: 100Mi<br/>        ports:<br/>        - containerPort: 6379<br/>      - name: redis-exporter<br/>        image: oliver006/redis_exporter:latest<br/>        resources:<br/>          requests:<br/>            cpu: 100m<br/>            memory: 100Mi<br/>        ports:<br/>        - containerPort: 9121<br/>---<br/>kind: Service<br/>apiVersion: v1<br/>metadata:<br/>  name: redis<br/>spec:<br/>  selector:<br/>    app: redis<br/>  ports:<br/>  - name: redis<br/>    protocol: TCP<br/>    port: 6379<br/>    targetPort: 6379<br/>  - name: prom<br/>    protocol: TCP<br/>    port: 9121<br/>    targetPort: 9121</span></pre><p id="dd92" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">此处的注释:</p><ul class=""><li id="70e0" class="kw kx iq ka b kb kc kf kg kj ky kn kz kr la kv lb lc ld le bi translated"><em class="lp">prometheus.io/scrape</em>—用于pod和服务中的过滤器，请参见本帖子更新的<a class="ae lo" href="https://rtfm.co.ua/?p=23859#kubernetessdconfig_roles" rel="noopener ugc nofollow" target="_blank">角色</a>部分</li><li id="6f12" class="kw kx iq ka b kb lf kf lg kj lh kn li kr lj kv lb lc ld le bi translated"><em class="lp">prometheus.io/port</em>—可在此指定非默认端口</li><li id="262c" class="kw kx iq ka b kb lf kf lg kj lh kn li kr lj kv lb lc ld le bi translated">prometheus.io/path<em class="lp">——出口商的指标路径可以在这里从默认的<code class="fe lk ll lm ln b">/metrics</code>更改</em></li></ul><p id="c3f3" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">参见<a class="ae lo" href="https://www.weave.works/docs/cloud/latest/tasks/monitor/configuration-k8s/#per-pod-prometheus-annotations" rel="noopener ugc nofollow" target="_blank">每舱普罗米修斯标注</a>。</p><p id="b622" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">注意，我们没有在这里设置名称空间Redis服务及其导出器将在默认的名称空间中创建，我们很快就会看到会发生什么。</p><p id="c61c" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">手动部署它，这是一项测试任务，无需添加到Ansible:</p><pre class="mv mw mx my gt mz ln na nb aw nc bi"><span id="ce25" class="lx ly iq ln b gy nd ne l nf ng">$ kubectl apply -f roles/monitoring/templates/tests/redis-server-and-exporter-deployment.yml.j2<br/>deployment.extensions/redis created<br/>service/redis created</span></pre><p id="7084" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">检查一下——必须有两个容器在运行。</p><p id="c54e" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在默认命名空间中找到一个pod:</p><pre class="mv mw mx my gt mz ln na nb aw nc bi"><span id="07b0" class="lx ly iq ln b gy nd ne l nf ng">$ kubectl get pod<br/>NAME READY STATUS RESTARTS AGE<br/>redis-698cd557d5-xmncv 2/2 Running 0 10s<br/>reloader-reloader-55448df76c-9l9j7 1/1 Running 0 23m</span></pre><p id="7208" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">和里面的容器:</p><pre class="mv mw mx my gt mz ln na nb aw nc bi"><span id="dae5" class="lx ly iq ln b gy nd ne l nf ng">$ kubectl get pod redis-698cd557d5-xmncv -o jsonpath=’{.spec.containers[*].name}’<br/>redis redis-exporter</span></pre><p id="67d6" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">好吧。</p><p id="b1dd" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">现在，从该导出器添加指标集合—更新<code class="fe lk ll lm ln b">prometheus-configmap.yml.j2</code>配置图—添加新目标，<em class="lp"> redis </em>:</p><pre class="mv mw mx my gt mz ln na nb aw nc bi"><span id="9d8f" class="lx ly iq ln b gy nd ne l nf ng">---<br/>apiVersion: v1<br/>kind: ConfigMap<br/>metadata:<br/>  name: prometheus-config<br/>  namespace: monitoring<br/>data:<br/>  prometheus.yml: |<br/><br/>    global:<br/>      scrape_interval:     15s<br/>      external_labels:<br/>        monitor: 'eks-dev-monitor'<br/>    <br/>    scrape_configs:<br/>      <br/>      - job_name: 'prometheus'<br/>        scrape_interval: 5s<br/>        static_configs:<br/>          - targets: ['localhost:9090']<br/><br/>      - job_name: 'redis'<br/>        static_configs:<br/>          - targets: ['redis:9121']</span></pre><p id="448c" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">展开，检查普罗米修斯的<em class="lp">目标</em>:</p><figure class="mv mw mx my gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nk"><img src="../Images/d793d578c84ccff66b54bb5a9afbe2ae.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*dY2Lm9p3mukdVt-_.png"/></div></div></figure><p id="8a43" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">不错——这里出现了一个新的目标。</p><p id="3366" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">但是为什么用<strong class="ka ir"> <em class="lp">得到</em> </strong> <a class="ae lo" href="http://redis:9121/metrics:" rel="noopener ugc nofollow" target="_blank"> <strong class="ka ir"> <em class="lp">却失败了呢http://redis:9121/metrics:</em></strong></a><strong class="ka ir"><em class="lp">拨tcp:查找redis上172.20.0.10:53:没有这样的主机</em> </strong>错误？</p><h2 id="37ee" class="lx ly iq bd lz ma mb dn mc md me dp mf kj mg mh mi kn mj mk ml kr mm mn mo mp bi translated">Prometheus ClusterRole、ServiceAccount和ClusterRoleBinding</h2><p id="945a" class="pw-post-body-paragraph jy jz iq ka b kb mq kd ke kf mr kh ki kj ms kl km kn mt kp kq kr mu kt ku kv ij bi translated">我们记得，我们在<em class="lp">监控</em>名称空间中启动了我们的普罗米修斯:</p><pre class="mv mw mx my gt mz ln na nb aw nc bi"><span id="0444" class="lx ly iq ln b gy nd ne l nf ng">$ kubectl get ns monitoring<br/>NAME STATUS AGE<br/>monitoring Active 25m</span></pre><p id="6940" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">而在Redis部署中，我们没有设置名称空间，因此，它的pod是在默认的名称空间中创建的:</p><pre class="mv mw mx my gt mz ln na nb aw nc bi"><span id="5927" class="lx ly iq ln b gy nd ne l nf ng">$ kubectl -n default get pod<br/>NAME READY STATUS RESTARTS AGE<br/>redis-698cd557d5-xmncv 2/2 Running 0 12m</span></pre><p id="a9c2" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">或者这样:</p><pre class="mv mw mx my gt mz ln na nb aw nc bi"><span id="25ef" class="lx ly iq ln b gy nd ne l nf ng">$ kubectl get pod redis-698cd557d5-xmncv -o jsonpath=’{.metadata.namespace}’<br/>default</span></pre><p id="216a" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">要使Prometheus能够访问集群上的所有名称空间，需要添加一个<code class="fe lk ll lm ln b">ClusterRole</code>、<code class="fe lk ll lm ln b">ServiceAccount</code>和<code class="fe lk ll lm ln b">ClusterRoleBinding</code>，请参见<a class="ae lo" href="https://rtfm.co.ua/en/kubernetes-part-5-rbac-authorization-with-a-role-and-rolebinding-example/" rel="noopener ugc nofollow" target="_blank">Kubernetes:part 5——具有角色和角色绑定示例的RBAC授权</a>帖子了解更多详细信息。</p><p id="a701" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">此外，该服务帐户将用于<a class="ae lo" href="https://rtfm.co.ua/en/kubernetes-monitoring-with-prometheus-exporters-a-service-discovery-and-its-roles/#Prometheus_Kubernetes_Service_Discovery" rel="noopener ugc nofollow" target="_blank"> Prometheus Kubernetes服务发现</a>。</p><p id="ef34" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">添加一个<code class="fe lk ll lm ln b">roles/monitoring/templates/prometheus-rbac.yml.j2</code>文件:</p><pre class="mv mw mx my gt mz ln na nb aw nc bi"><span id="fac3" class="lx ly iq ln b gy nd ne l nf ng">---<br/>apiVersion: rbac.authorization.k8s.io/v1beta1<br/>kind: ClusterRole<br/>metadata:<br/>  name: prometheus<br/>rules:<br/>- apiGroups: [""]<br/>  resources:<br/>  - services<br/>  - endpoints<br/>  - pods<br/>  - nodes<br/>  - nodes/proxy<br/>  - nodes/metrics<br/>  verbs: ["get", "list", "watch"]<br/>- apiGroups:<br/>  - extensions<br/>  resources:<br/>  - ingresses<br/>  verbs: ["get", "list", "watch"]<br/>---<br/>apiVersion: v1<br/>kind: ServiceAccount<br/>metadata:<br/>  name: prometheus<br/>  namespace: monitoring<br/>---  <br/>apiVersion: rbac.authorization.k8s.io/v1beta1<br/>kind: ClusterRoleBinding<br/>metadata:<br/>  name: prometheus<br/>roleRef:<br/>  apiGroup: rbac.authorization.k8s.io<br/>  kind: ClusterRole<br/>  name: prometheus<br/>subjects:<br/>- kind: ServiceAccount<br/>  name: prometheus<br/>  namespace: monitoring</span></pre><p id="9a90" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在创建ConfigMap之后和部署Prometheus服务器之前添加其执行:</p><pre class="mv mw mx my gt mz ln na nb aw nc bi"><span id="5fbe" class="lx ly iq ln b gy nd ne l nf ng">- name: "Create the Monitoring Namespace"<br/>  command: "kubectl apply -f roles/monitoring/templates/prometheus-ns.yml.j2"<br/><br/>- name: "Create prometheus.yml ConfigMap"<br/>  command: "kubectl apply -f roles/monitoring/templates/prometheus-configmap.yml.j2"<br/><br/>- name: "Create Prometheus ClusterRole"<br/>  command: "kubectl apply -f roles/monitoring/templates/prometheus-rbac.yml.j2"<br/><br/>- name: "Deploy Prometheus server and its LoadBalancer"<br/>  command: "kubectl apply -f roles/monitoring/templates/prometheus-deployment.yml.j2"</span></pre><p id="934d" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">更新<code class="fe lk ll lm ln b">prometheus-deployment.yml</code>——在其<code class="fe lk ll lm ln b">spec</code>中增加<code class="fe lk ll lm ln b">serviceAccountName</code>:</p><pre class="mv mw mx my gt mz ln na nb aw nc bi"><span id="a0eb" class="lx ly iq ln b gy nd ne l nf ng">...<br/>  template:<br/>    metadata:<br/>      labels:<br/>        app: prometheus<br/>    spec:<br/>      serviceAccountName: prometheus<br/>      containers:<br/>      - name: prometheus-server<br/>        image: prom/prometheus<br/>...</span></pre><p id="e2a0" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">除此之外，要调用另一个名称空间中的pod，我们需要使用指定名称空间的FQDN，在这种情况下，访问Redis导出器的地址将是<em class="lp">Redis . default . SVC . cluster . local</em>，请参见服务和pod的<a class="ae lo" href="https://kubernetes.io/docs/concepts/services-networking/dns-pod-service/" rel="noopener ugc nofollow" target="_blank">DNS</a>。</p><p id="1374" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">更新配置映射—更改Redis地址:</p><pre class="mv mw mx my gt mz ln na nb aw nc bi"><span id="60f3" class="lx ly iq ln b gy nd ne l nf ng">...<br/>    scrape_configs:<br/><br/>      - job_name: 'prometheus'<br/>        scrape_interval: 5s<br/>        static_configs:<br/>          - targets: ['localhost:9090']<br/><br/>      - job_name: 'redis'<br/>        static_configs:<br/>          - targets: ['redis.default.svc.cluster.local:9121']</span></pre><p id="d093" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">使用Ansible部署以更新所有内容:</p><pre class="mv mw mx my gt mz ln na nb aw nc bi"><span id="ca56" class="lx ly iq ln b gy nd ne l nf ng">$ ansible-playbook eks-cluster.yml --tags monitoring</span></pre><p id="a97a" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">现在检查<em class="lp">目标</em>:</p><figure class="mv mw mx my gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nl"><img src="../Images/3f5b794a87b880cbf10049fd6363acea.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*uS93MkkRv1dB58CF.png"/></div></div></figure><p id="e1ec" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">和指标:</p><figure class="mv mw mx my gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nm"><img src="../Images/8d2a9611c724942f6b677d5d8d02caf3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*xoYOEo2ZiTuistdP.png"/></div></div></figure><h2 id="cdd6" class="lx ly iq bd lz ma mb dn mc md me dp mf kj mg mh mi kn mj mk ml kr mm mn mo mp bi translated">Prometheus Kubernetes服务发现</h2><p id="73c7" class="pw-post-body-paragraph jy jz iq ka b kb mq kd ke kf mr kh ki kj ms kl km kn mt kp kq kr mu kt ku kv ij bi translated">在Prometheus中是一件好事，但是如果您必须从数百个这样的服务中收集指标呢？</p><p id="c601" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">解决方案是使用<code class="fe lk ll lm ln b"><a class="ae lo" href="https://rtfm.co.ua/goto/https://prometheus.io/docs/prometheus/1.8/configuration/configuration/#kubernetes_sd_config" rel="noopener ugc nofollow" target="_blank">kubernetes_sd_config</a></code>功能。</p><h2 id="5325" class="lx ly iq bd lz ma mb dn mc md me dp mf kj mg mh mi kn mj mk ml kr mm mn mo mp bi translated"><code class="fe lk ll lm ln b">kubernetes_sd_config</code>角色</h2><p id="0e31" class="pw-post-body-paragraph jy jz iq ka b kb mq kd ke kf mr kh ki kj ms kl km kn mt kp kq kr mu kt ku kv ij bi translated">Prometheus中的Kubernetes SD有一个所谓的“角色”集合，它定义了如何收集和显示指标。</p><p id="57b0" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">每个这样的角色都有自己的标签集，参见<a class="ae lo" href="https://prometheus.io/docs/prometheus/latest/configuration/configuration/#kubernetes_sd_config" rel="noopener ugc nofollow" target="_blank">文档</a>:</p><ul class=""><li id="d915" class="kw kx iq ka b kb kc kf kg kj ky kn kz kr la kv lb lc ld le bi translated"><em class="lp">节点</em>:将在每个集群的WorkerNode кластера上通过一个目标，将收集kubelet的度量</li><li id="83a3" class="kw kx iq ka b kb lf kf lg kj lh kn li kr lj kv lb lc ld le bi translated"><em class="lp">服务</em>:查找并返回每个服务及其端口</li><li id="5fbf" class="kw kx iq ka b kb lf kf lg kj lh kn li kr lj kv lb lc ld le bi translated"><em class="lp"> pod </em>:所有的pod和将返回它的容器作为目标来获取度量</li><li id="303f" class="kw kx iq ka b kb lf kf lg kj lh kn li kr lj kv lb lc ld le bi translated"><em class="lp">端点</em>:将从每个端点为集群中的每个服务创建目标</li><li id="e2aa" class="kw kx iq ka b kb lf kf lg kj lh kn li kr lj kv lb lc ld le bi translated"><em class="lp">入口</em>:将为每个入口的每个路径创建目标</li></ul><p id="eb6a" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">区别仅在于返回的标签，以及每个这样的目标将使用什么地址。</p><p id="9a23" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">配置示例(更多信息见本文末尾):</p><ul class=""><li id="e706" class="kw kx iq ka b kb kc kf kg kj ky kn kz kr la kv lb lc ld le bi translated"><a class="ae lo" href="https://github.com/prometheus/prometheus/blob/master/documentation/examples/prometheus-kubernetes.yml" rel="noopener ugc nofollow" target="_blank">Prometheus/documentation/examples/Prometheus-kubernetes . yml</a></li><li id="ad93" class="kw kx iq ka b kb lf kf lg kj lh kn li kr lj kv lb lc ld le bi translated"><a class="ae lo" href="https://linuxacademy.com/blog/kubernetes/running-prometheus-on-kubernetes/" rel="noopener ugc nofollow" target="_blank">在Kubernetes上运行普罗米修斯</a></li></ul><p id="27c8" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">此外，要使用SSL/TLS加密连接到集群的API服务器，需要指定服务器的中央授权证书来验证它，请参见<a class="ae lo" href="https://kubernetes.io/docs/tasks/access-application-cluster/access-cluster/#accessing-the-api-from-a-pod" rel="noopener ugc nofollow" target="_blank">从Pod访问API</a>。</p><p id="68da" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">对于API服务器上的授权，我们将使用来自<code class="fe lk ll lm ln b">bearer_token_file</code>的令牌，它是从<code class="fe lk ll lm ln b">serviceAccountName: prometheus</code>挂载的，这是我们在上面的部署中设置的。</p><p id="9bd3" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><strong class="ka ir">节点角色</strong></p><p id="09e6" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">让我们看看每个这样的角色会有什么。</p><p id="19bf" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">从n <em class="lp"> ode </em>角色开始——添加到<code class="fe lk ll lm ln b">scrape_configs</code>，可以从<a class="ae lo" href="https://github.com/prometheus/prometheus/blob/master/documentation/examples/prometheus-kubernetes.yml#L59" rel="noopener ugc nofollow" target="_blank">示例</a>中复制粘贴:</p><pre class="mv mw mx my gt mz ln na nb aw nc bi"><span id="ae8d" class="lx ly iq ln b gy nd ne l nf ng">...<br/>      - job_name: 'kubernetes-nodes'<br/>        scheme: https<br/>        tls_config:<br/>          ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt<br/>        bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token<br/><br/>        kubernetes_sd_configs:<br/>        - role: node</span></pre><p id="26d8" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">现在不需要重新标记—只需运行并检查目标</p><figure class="mv mw mx my gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nn"><img src="../Images/0c355fcafadaa9e9c07bff8f4019a9ad.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*09wKaO4eW4rIR0cx.png"/></div></div></figure><p id="38aa" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">检查<em class="lp">状态&gt;服务发现</em>发现的目标和标签</p><figure class="mv mw mx my gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi no"><img src="../Images/4be5a2993ccb432f01ae9ec1b5490f92.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*ZfLyCcEtsPoRX6Z6.png"/></div></div></figure><p id="cc93" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">和<em class="lp"> kubelet_* </em>指标:</p><figure class="mv mw mx my gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi np"><img src="../Images/3863598c816c550ea4befa9697b99842.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*MOUysse2jv-Gs-z3.png"/></div></div></figure><p id="8766" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">添加一些重新标签，参见标签的<code class="fe lk ll lm ln b"><a class="ae lo" href="https://prometheus.io/docs/prometheus/latest/configuration/configuration/#relabel_config" rel="noopener ugc nofollow" target="_blank">relabel_config</a></code>和<a class="ae lo" href="https://www.robustperception.io/life-of-a-label" rel="noopener ugc nofollow" target="_blank">寿命。</a></p><p id="6116" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">他们在那里建议什么？</p><pre class="mv mw mx my gt mz ln na nb aw nc bi"><span id="835e" class="lx ly iq ln b gy nd ne l nf ng">...<br/>        relabel_configs:<br/>        - action: labelmap<br/>          regex: __meta_kubernetes_node_label_(.+)<br/>        - target_label: __address__<br/>          replacement: kubernetes.default.svc:443<br/>        - source_labels: [__meta_kubernetes_node_name]<br/>          regex: (.+)<br/>          target_label: __metrics_path__<br/>          replacement: /api/v1/nodes/${1}/proxy/metrics<br/>...</span></pre><ol class=""><li id="f730" class="kw kx iq ka b kb kc kf kg kj ky kn kz kr la kv nh lc ld le bi translated">收集标签<code class="fe lk ll lm ln b">__meta_kubernetes_node_label_alpha_eksctl_io_cluster_name</code>、<code class="fe lk ll lm ln b">__meta_kubernetes_node_label_alpha_eksctl_io_nodegroup_name</code>等，用<code class="fe lk ll lm ln b">(.+)</code>选择——会得到<code class="fe lk ll lm ln b">alpha_eksctl_io_cluster_name</code>、<code class="fe lk ll lm ln b">alpha_eksctl_io_nodegroup_name</code>等标签</li><li id="f70b" class="kw kx iq ka b kb lf kf lg kj lh kn li kr lj kv nh lc ld le bi translated">更新<code class="fe lk ll lm ln b">__address__</code>标签——设置<em class="lp">kubernetes . default . SVC:443</em>值来创建调用目标的地址</li><li id="9765" class="kw kx iq ka b kb lf kf lg kj lh kn li kr lj kv nh lc ld le bi translated">从<code class="fe lk ll lm ln b">__meta_kubernetes_node_name</code>获取一个值并更新<code class="fe lk ll lm ln b">__metrics_path__</code>标签——设置<em class="lp">/API/v1/nodes/_ _ meta _ kubernetes _ node _ name/proxy/metrics</em></li></ol><p id="6345" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">因此，Prometheus将向<em class="lp">kubernetes . default . SVC:443/API/v1/nodes/IP-10–1–57–13 . eu-west-2 . compute . internal/proxy/metrics</em>构造一个请求，并将从这个WorkerNode获取指标。</p><p id="8088" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">更新，检查:</p><figure class="mv mw mx my gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nq"><img src="../Images/3dfef8082b16e76f1c229f97f53a7ff4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*OXXkgf2Me4R4hnBE.png"/></div></div></figure><p id="8e75" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">不错！</p><p id="d76b" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><strong class="ka ir">荚的作用</strong></p><p id="93ab" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">现在，让我们看看来自相同资源的<em class="lp"> pod </em>角色示例:</p><pre class="mv mw mx my gt mz ln na nb aw nc bi"><span id="6469" class="lx ly iq ln b gy nd ne l nf ng">...<br/>      - job_name: 'kubernetes-pods'<br/>        kubernetes_sd_configs:<br/>        - role: pod<br/><br/>        relabel_configs:<br/>        - action: labelmap<br/>          regex: __meta_kubernetes_pod_label_(.+)<br/>        - source_labels: [__meta_kubernetes_namespace]<br/>          action: replace<br/>          target_label: kubernetes_namespace<br/>        - source_labels: [__meta_kubernetes_pod_name]<br/>          action: replace<br/>          target_label: kubernetes_pod_name</span></pre><p id="580d" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">检查:</p><figure class="mv mw mx my gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nr"><img src="../Images/1cdf63cc70754a2b36f470ac4e14cf33.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*RDobbWed-ALgywF2.png"/></div></div></figure><p id="8a4b" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">所有节点都找到了，但为什么这么多？</p><p id="df92" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">下面我们来补充一下<em class="lp">prometheus.io/scrape:的【真实】</em>注解检查:</p><pre class="mv mw mx my gt mz ln na nb aw nc bi"><span id="0229" class="lx ly iq ln b gy nd ne l nf ng">...<br/>        relabel_configs:<br/>        - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_scrape]<br/>          action: keep<br/>          regex: true<br/>...</span></pre><p id="98a1" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">已经添加到我们的Redis中，例如:</p><pre class="mv mw mx my gt mz ln na nb aw nc bi"><span id="152f" class="lx ly iq ln b gy nd ne l nf ng">...<br/>  template:<br/>    metadata:<br/>      annotations:<br/>        prometheus.io/scrape: "true"<br/><br/>...</span></pre><p id="382b" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">结果是:</p><figure class="mv mw mx my gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi ns"><img src="../Images/237e971c4d5b6109002a0f2b28d8d4b4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*qCkPEL4qReCHUu9u.png"/></div></div></figure><p id="ba96" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><a class="ae lo" href="http://10.1.44.135:6379/metrics" rel="noopener ugc nofollow" target="_blank"><em class="lp">http://10 . 1 . 44 . 135:6379/metrics</em></a>—是没有度量的Redis服务器。</p><p id="5117" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">您想删除它吗？再添加一个过滤器:</p><pre class="mv mw mx my gt mz ln na nb aw nc bi"><span id="964f" class="lx ly iq ln b gy nd ne l nf ng">...<br/>        - source_labels: [__meta_kubernetes_pod_container_name]<br/>          action: keep<br/>          regex: .*-exporter<br/>...</span></pre><p id="b4b9" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">也就是说，我们将只收集在<code class="fe lk ll lm ln b">__meta_kubernetes_pod_container_name</code>标签中带有“<em class="lp"> -exporter </em>”字符串的指标。</p><p id="ce3d" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">检查:</p><figure class="mv mw mx my gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nt"><img src="../Images/f92e6d034cf9aff36cd7bf864258d878.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*IbqeArp5hW1MKmk5.png"/></div></div></figure><p id="368b" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">好的—我们已经看到了Prometheus Kubernetes服务发现中的角色是如何工作的。</p><p id="5894" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我们还剩下什么？</p><ul class=""><li id="3f2d" class="kw kx iq ka b kb kc kf kg kj ky kn kz kr la kv lb lc ld le bi translated">节点导出器</li><li id="85da" class="kw kx iq ka b kb lf kf lg kj lh kn li kr lj kv lb lc ld le bi translated">kube-状态-度量</li><li id="1332" class="kw kx iq ka b kb lf kf lg kj lh kn li kr lj kv lb lc ld le bi translated">管理员</li><li id="c5e9" class="kw kx iq ka b kb lf kf lg kj lh kn li kr lj kv lb lc ld le bi translated">度量-服务器</li></ul><h2 id="a36e" class="lx ly iq bd lz ma mb dn mc md me dp mf kj mg mh mi kn mj mk ml kr mm mn mo mp bi translated">节点导出器指标</h2><p id="bda3" class="pw-post-body-paragraph jy jz iq ka b kb mq kd ke kf mr kh ki kj ms kl km kn mt kp kq kr mu kt ku kv ij bi translated">添加<code class="fe lk ll lm ln b"><a class="ae lo" href="https://github.com/prometheus/node_exporter" rel="noopener ugc nofollow" target="_blank">node_exporter</a></code>来从EC2实例收集指标。</p><p id="6ae7" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">因为需要在每个WorkerNode上放置一个带有exporter的pod这里使用<code class="fe lk ll lm ln b"><a class="ae lo" href="https://rtfm.co.ua/kubernetes-znakomstvo-chast-1-arxitektura-i-osnovnye-komponenty-obzor/#DaemonSet" rel="noopener ugc nofollow" target="_blank">DaemonSet</a></code>类型。</p><p id="6e4e" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">创建一个<code class="fe lk ll lm ln b">roles/monitoring/templates/prometheus-node-exporter.yml.j2</code>文件——这将在<em class="lp"> monitoring </em>名称空间中的每个WorkerNode上旋转一个pod，并将添加一个服务，使Prometheus可以从端点获取指标:</p><pre class="mv mw mx my gt mz ln na nb aw nc bi"><span id="09be" class="lx ly iq ln b gy nd ne l nf ng">---<br/>apiVersion: extensions/v1beta1<br/>kind: DaemonSet<br/>metadata:<br/>  name: node-exporter<br/>  labels:<br/>    name: node-exporter<br/>  namespace: monitoring<br/>spec:<br/>  template:<br/>    metadata:<br/>      labels:<br/>        name: node-exporter<br/>        app: node-exporter<br/>      annotations:<br/>         prometheus.io/scrape: "true"<br/>    spec:<br/>      hostPID: true<br/>      hostIPC: true<br/>      hostNetwork: true<br/>      containers:<br/>        - ports:<br/>            - containerPort: 9100<br/>              protocol: TCP<br/>          resources:<br/>            requests:<br/>              cpu: 0.15<br/>          securityContext:<br/>            privileged: true<br/>          image: prom/node-exporter<br/>          args:<br/>            - --path.procfs<br/>            - /host/proc<br/>            - --path.sysfs<br/>            - /host/sys<br/>            - --collector.filesystem.ignored-mount-points<br/>            - '"^/(sys|proc|dev|host|etc)($|/)"'<br/>          name: node-exporter<br/>          volumeMounts:<br/>            - name: dev<br/>              mountPath: /host/dev<br/>            - name: proc<br/>              mountPath: /host/proc<br/>            - name: sys<br/>              mountPath: /host/sys<br/>            - name: rootfs<br/>              mountPath: /rootfs<br/>      volumes:<br/>        - name: proc<br/>          hostPath:<br/>            path: /proc<br/>        - name: dev<br/>          hostPath:<br/>            path: /dev<br/>        - name: sys<br/>          hostPath:<br/>            path: /sys<br/>        - name: rootfs<br/>          hostPath:<br/>            path: /<br/><br/>---<br/>kind: Service<br/>apiVersion: v1<br/>metadata:<br/>  name: node-exporter<br/>  namespace: monitoring<br/>spec:<br/>  selector:<br/>    app: node-exporter<br/>  ports:<br/>  - name: node-exporter<br/>    protocol: TCP<br/>    port: 9100<br/>    targetPort: 9100</span></pre><p id="3db4" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">将其执行添加到<code class="fe lk ll lm ln b">roles/monitoring/tasks/main.yml</code>文件中:</p><pre class="mv mw mx my gt mz ln na nb aw nc bi"><span id="165f" class="lx ly iq ln b gy nd ne l nf ng">...<br/>- name: "Deploy node-exporter to WorkerNodes"<br/>  command: "kubectl apply -f roles/monitoring/templates/prometheus-node-exporter.yml.j2"</span></pre><p id="c82f" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">让我们考虑一下现在如何收集指标。</p><p id="929f" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">第一个问题是——这里使用哪个角色？我们需要指定<em class="lp"> 9100 </em>端口——这样我们就不能使用<code class="fe lk ll lm ln b">node</code>角色——它没有端口值:</p><pre class="mv mw mx my gt mz ln na nb aw nc bi"><span id="bbe3" class="lx ly iq ln b gy nd ne l nf ng">$ kubectl -n monitoring get node<br/>NAME STATUS ROLES AGE VERSION<br/>ip-10–1–47–175.eu-west-2.compute.internal Ready &lt;none&gt; 3h36m v1.15.10-eks-bac369<br/>ip-10–1–57–13.eu-west-2.compute.internal Ready &lt;none&gt; 3h37m v1.15.10-eks-bac369</span></pre><p id="2996" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">服务角色呢？</p><blockquote class="nu nv nw"><p id="682a" class="jy jz lp ka b kb kc kd ke kf kg kh ki nx kk kl km ny ko kp kq nz ks kt ku kv ij bi translated">该地址将被设置为服务的Kubernetes DNS名称和相应的服务端口</p></blockquote><p id="db6d" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">让我们看看:</p><pre class="mv mw mx my gt mz ln na nb aw nc bi"><span id="16b4" class="lx ly iq ln b gy nd ne l nf ng">$ kubectl -n monitoring get svc<br/>NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE<br/>node-exporter ClusterIP 172.20.242.99 &lt;none&gt; 9100/TCP 37m</span></pre><p id="3682" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">好的，那么<code class="fe lk ll lm ln b"><a class="ae lo" href="https://prometheus.io/docs/prometheus/latest/configuration/configuration/#service" rel="noopener ugc nofollow" target="_blank">service</a></code>角色的标签呢？一切都好，但是它没有Worker节点上的pod标签——我们需要从每个Worker节点上的每个<code class="fe lk ll lm ln b">node_exporter</code> pod收集指标。</p><p id="766f" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">让我们更进一步——<code class="fe lk ll lm ln b">endpoints</code>角色:</p><pre class="mv mw mx my gt mz ln na nb aw nc bi"><span id="0d01" class="lx ly iq ln b gy nd ne l nf ng">$ kubectl -n monitoring get endpoints<br/>NAME ENDPOINTS AGE<br/>node-exporter 10.1.47.175:9100,10.1.57.13:9100 44m<br/>prometheus-server-alb 10.1.45.231:9090,10.1.53.46:9090 3h24m</span></pre><p id="10f9" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">10.1.47.175:9100，10.1.57.13:9100。</p><p id="c484" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">所以——我们可以使用也有<code class="fe lk ll lm ln b">__meta_kubernetes_endpoint_node_name</code>标签的<code class="fe lk ll lm ln b">endpoints</code>角色。</p><p id="5c5f" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">试试看:</p><pre class="mv mw mx my gt mz ln na nb aw nc bi"><span id="81d8" class="lx ly iq ln b gy nd ne l nf ng">...<br/>      - job_name: 'node-exporter'<br/>        kubernetes_sd_configs:<br/>          - role: endpoints<br/>        relabel_configs:<br/>        - source_labels: [__meta_kubernetes_endpoints_name]<br/>          regex: 'node-exporter'<br/>          action: keep</span></pre><p id="cc76" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">检查目标:</p><figure class="mv mw mx my gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi oa"><img src="../Images/41d0ed45bb08daa98c8452c179522b42.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*4hP59_qxrOgZp3E1.png"/></div></div></figure><p id="f9a6" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">和指标:</p><figure class="mv mw mx my gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi ob"><img src="../Images/88edeaffb36bc0092891c4e6db27414d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*hZM7j0zZMPwpT9C6.png"/></div></div></figure><p id="f599" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">参见<a class="ae lo" href="https://rtfm.co.ua/grafana-sozdanie-dashboard/" rel="noopener ugc nofollow" target="_blank"> Grafana: создание仪表板</a>帖子中<code class="fe lk ll lm ln b">node_exporter</code>的请求示例(俄语)。</p><h2 id="5017" class="lx ly iq bd lz ma mb dn mc md me dp mf kj mg mh mi kn mj mk ml kr mm mn mo mp bi translated"><code class="fe lk ll lm ln b">kube-state-metrics</code></h2><p id="99b9" class="pw-post-body-paragraph jy jz iq ka b kb mq kd ke kf mr kh ki kj ms kl km kn mt kp kq kr mu kt ku kv ij bi translated">为了收集关于Kubernetes资源的指标，我们可以使用<code class="fe lk ll lm ln b"><a class="ae lo" href="https://github.com/kubernetes/kube-state-metrics" rel="noopener ugc nofollow" target="_blank">kube-state-metrics</a></code>。</p><p id="8231" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">将其安装添加到<code class="fe lk ll lm ln b">roles/monitoring/tasks/main.yml</code>:</p><pre class="mv mw mx my gt mz ln na nb aw nc bi"><span id="57bb" class="lx ly iq ln b gy nd ne l nf ng">...<br/>- git:<br/>    repo: 'https://github.com/kubernetes/kube-state-metrics.git'<br/>    dest: /tmp/kube-state-metrics<br/><br/>- name: "Install kube-state-metrics"<br/>  command: "kubectl apply -f /tmp/kube-state-metrics/examples/standard/"</span></pre><p id="58a2" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">部署本身可以在<a class="ae lo" href="https://github.com/kubernetes/kube-state-metrics/blob/master/examples/standard/deployment.yaml" rel="noopener ugc nofollow" target="_blank">https://github . com/kubernetes/kube-state-metrics/blob/master/examples/standard/deployment . YAML</a>文件中观察到。</p><p id="86a5" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我们可以在这里跳过服务发现，因为我们将拥有唯一的<code class="fe lk ll lm ln b">kube-state-metrics</code>服务，所以使用<code class="fe lk ll lm ln b">static_configs</code>:</p><pre class="mv mw mx my gt mz ln na nb aw nc bi"><span id="7c0c" class="lx ly iq ln b gy nd ne l nf ng">...<br/>      - job_name: 'kube-state-metrics'<br/>        static_configs:<br/>          - targets: ['kube-state-metrics.kube-system.svc.cluster.local:8080']</span></pre><p id="8a0e" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">检查目标:</p><figure class="mv mw mx my gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi oc"><img src="../Images/108ec112e8ff00dadd16161d9d7499ee.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*XMQDP-joMy3GCO6Z.png"/></div></div></figure><p id="70cf" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">和指标，例如— <code class="fe lk ll lm ln b">kube_deployment_status_replicas_available</code>:</p><figure class="mv mw mx my gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi od"><img src="../Images/6718b1b15d7135f9eca34d2b586d40af.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*EqYj4e-Zv8dnUCmc.png"/></div></div></figure><h2 id="6d85" class="lx ly iq bd lz ma mb dn mc md me dp mf kj mg mh mi kn mj mk ml kr mm mn mo mp bi translated">管理员</h2><p id="1873" class="pw-post-body-paragraph jy jz iq ka b kb mq kd ke kf mr kh ki kj ms kl km kn mt kp kq kr mu kt ku kv ij bi translated"><code class="fe lk ll lm ln b"><a class="ae lo" href="https://github.com/google/cadvisor" rel="noopener ugc nofollow" target="_blank">cAdvisor</a></code>太有名了——收集容器数据的最广泛使用的系统。</p><p id="3eb0" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">它已经不受Kubernetes的限制，所以不需要专门的记者——只需获取tits指标。在同一个<a class="ae lo" href="https://github.com/prometheus/prometheus/blob/master/documentation/examples/prometheus-kubernetes.yml#L102" rel="noopener ugc nofollow" target="_blank">https://github . com/Prometheus/Prometheus/blob/master/documentation/examples/Prometheus-kubernetes . yml # L102</a>文件中可以找到一个示例。</p><p id="1ff2" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">更新<code class="fe lk ll lm ln b">roles/monitoring/templates/prometheus-configmap.yml.j2</code>:</p><pre class="mv mw mx my gt mz ln na nb aw nc bi"><span id="cee2" class="lx ly iq ln b gy nd ne l nf ng">...<br/>      - job_name: 'cAdvisor'<br/>        scheme: https<br/>        tls_config:<br/>          ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt<br/>        bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token<br/>        kubernetes_sd_configs:<br/>        - role: node<br/><br/>        relabel_configs:<br/>        - action: labelmap<br/>          regex: __meta_kubernetes_node_label_(.+)<br/>        - target_label: __address__<br/>          replacement: kubernetes.default.svc:443<br/>        - source_labels: [__meta_kubernetes_node_name]<br/>          regex: (.+)<br/>          target_label: __metrics_path__<br/>          replacement: /api/v1/nodes/${1}/proxy/metrics/cadvisor</span></pre><p id="1efa" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">部署，检查:</p><figure class="mv mw mx my gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi oe"><img src="../Images/2b71fe17845c1ddc6c9adee65e090445.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*j5p0eJaokd1hVPV2.png"/></div></div></figure><p id="9473" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我们的集群中有两个Kubernetes WorkerNode，我们可以看到这两个节点的指标——很好:</p><figure class="mv mw mx my gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi of"><img src="../Images/592ac0df6c7824c4d8e991d801b1d51d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*hIirU1kWQV-T5O8O.png"/></div></div></figure><h2 id="3d40" class="lx ly iq bd lz ma mb dn mc md me dp mf kj mg mh mi kn mj mk ml kr mm mn mo mp bi translated"><code class="fe lk ll lm ln b">metrics-server</code></h2><p id="ef2d" class="pw-post-body-paragraph jy jz iq ka b kb mq kd ke kf mr kh ki kj ms kl km kn mt kp kq kr mu kt ku kv ij bi translated">它也有出口商，但我现在不需要他们——只需安装它使Kubernetes限制工作并使用<code class="fe lk ll lm ln b">kubectl top</code>。</p><p id="3463" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">之前它的安装有点复杂，见<a class="ae lo" href="https://rtfm.co.ua/en/kubernetes-running-metrics-server-in-aws-eks-for-a-kubernetes-pod-autoscaler/" rel="noopener ugc nofollow" target="_blank"> Kubernetes:在AWS EKS为Kubernetes Pod自动缩放器运行metrics-server</a>，但是现在在EKS上它开箱即用。</p><p id="f3e3" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">更新<code class="fe lk ll lm ln b">roles/monitoring/tasks/main.yml</code>:</p><pre class="mv mw mx my gt mz ln na nb aw nc bi"><span id="6ede" class="lx ly iq ln b gy nd ne l nf ng">...<br/>- git:<br/>    repo: "https://github.com/kubernetes-sigs/metrics-server.git"<br/>    dest: "/tmp/metrics-server"<br/><br/>- name: "Install metrics-server"<br/>  command: "kubectl apply -f /tmp/metrics-server/deploy/kubernetes/"<br/>...</span></pre><p id="dfdd" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">部署，检查<code class="fe lk ll lm ln b">kube-system</code>名称空间中的窗格:</p><pre class="mv mw mx my gt mz ln na nb aw nc bi"><span id="2707" class="lx ly iq ln b gy nd ne l nf ng">$ kubectl -n kube-system get pod<br/>NAME READY STATUS RESTARTS AGE<br/>aws-node-s7pvq 1/1 Running 0 4h42m<br/>…<br/>kube-proxy-v9lmh 1/1 Running 0 4h42m<br/>kube-state-metrics-6c4d4dd64–78bpb 1/1 Running 0 31m<br/>metrics-server-7668599459-nt4pf 1/1 Running 0 44s</span></pre><p id="4a82" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">吊舱在这里——很好。</p><p id="847e" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">几分钟后试试<code class="fe lk ll lm ln b">top node</code>:</p><pre class="mv mw mx my gt mz ln na nb aw nc bi"><span id="4815" class="lx ly iq ln b gy nd ne l nf ng">$ kubectl top node<br/>NAME CPU(cores) CPU% MEMORY(bytes) MEMORY%<br/>ip-10–1–47–175.eu-west-2.compute.internal 47m 2% 536Mi 14%<br/>ip-10–1–57–13.eu-west-2.compute.internal 58m 2% 581Mi 15%</span></pre><p id="8762" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">对于吊舱:</p><pre class="mv mw mx my gt mz ln na nb aw nc bi"><span id="9382" class="lx ly iq ln b gy nd ne l nf ng">$ kubectl top pod<br/>NAME CPU(cores) MEMORY(bytes)<br/>redis-6d9cf9d8cb-dfnn6 2m 5Mi<br/>reloader-reloader-55448df76c-wsrfv 1m 7Mi</span></pre><p id="bc04" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">就这些了，总的来说。</p><h2 id="f16a" class="lx ly iq bd lz ma mb dn mc md me dp mf kj mg mh mi kn mj mk ml kr mm mn mo mp bi translated">有用的链接</h2><ul class=""><li id="9114" class="kw kx iq ka b kb mq kf mr kj og kn oh kr oi kv lb lc ld le bi translated"><a class="ae lo" href="https://sysdig.com/blog/kubernetes-monitoring-prometheus/" rel="noopener ugc nofollow" target="_blank"> Kubernetes用普罗米修斯监控-终极指南</a></li><li id="500c" class="kw kx iq ka b kb lf kf lg kj lh kn li kr lj kv lb lc ld le bi translated"><a class="ae lo" href="https://banzaicloud.com/blog/prometheus-federation/" rel="noopener ugc nofollow" target="_blank">使用Prometheus监控多个联合集群—安全的方式</a></li><li id="6410" class="kw kx iq ka b kb lf kf lg kj lh kn li kr lj kv lb lc ld le bi translated"><a class="ae lo" href="https://www.weave.works/blog/monitoring-kubernetes-infrastructure/" rel="noopener ugc nofollow" target="_blank">使用Prometheus监控您的Kubernetes基础设施</a></li><li id="098d" class="kw kx iq ka b kb lf kf lg kj lh kn li kr lj kv lb lc ld le bi translated"><a class="ae lo" href="https://blog.argoproj.io/volume-monitoring-in-kubernetes-with-prometheus-3a185e4c4035" rel="noopener ugc nofollow" target="_blank">使用Prometheus在Kubernetes进行音量监控</a></li><li id="5057" class="kw kx iq ka b kb lf kf lg kj lh kn li kr lj kv lb lc ld le bi translated">用头盔+迷你库贝尝试普罗米修斯操作者</li><li id="9598" class="kw kx iq ka b kb lf kf lg kj lh kn li kr lj kv lb lc ld le bi translated"><a class="ae lo" href="https://chris-vermeulen.com/how-to-monitor-your-kubernetes-cluster-with-prometheus-and-grafana--the-whole--long--story-/" rel="noopener ugc nofollow" target="_blank">如何使用Prometheus和Grafana监控您的Kubernetes集群</a></li><li id="0f01" class="kw kx iq ka b kb lf kf lg kj lh kn li kr lj kv lb lc ld le bi translated"><a class="ae lo" href="https://kubedb.com/docs/0.12.0/guides/redis/monitoring/using-builtin-prometheus/" rel="noopener ugc nofollow" target="_blank">用内置的普罗米修斯监控Redis】</a></li><li id="6b7a" class="kw kx iq ka b kb lf kf lg kj lh kn li kr lj kv lb lc ld le bi translated"><a class="ae lo" href="https://www.replex.io/blog/kubernetes-in-production-the-ultimate-guide-to-monitoring-resource-metrics" rel="noopener ugc nofollow" target="_blank">Kubernetes in Production:Prometheus资源指标监控终极指南</a></li><li id="757e" class="kw kx iq ka b kb lf kf lg kj lh kn li kr lj kv lb lc ld le bi translated"><a class="ae lo" href="https://phoenixnap.com/kb/prometheus-kubernetes-monitoring" rel="noopener ugc nofollow" target="_blank">如何用普罗米修斯监控库伯内特斯</a></li><li id="83f9" class="kw kx iq ka b kb lf kf lg kj lh kn li kr lj kv lb lc ld le bi translated"><a class="ae lo" href="https://programming.vip/docs/cluster-monitoring-using-prometheus-grafana-node-exporter.html" rel="noopener ugc nofollow" target="_blank">使用Prometheus + grafana +节点导出器</a></li><li id="8ab8" class="kw kx iq ka b kb lf kf lg kj lh kn li kr lj kv lb lc ld le bi translated"><a class="ae lo" href="https://linuxacademy.com/blog/kubernetes/running-prometheus-on-kubernetes/" rel="noopener ugc nofollow" target="_blank">在Kubernetes上运行普罗米修斯</a></li><li id="456d" class="kw kx iq ka b kb lf kf lg kj lh kn li kr lj kv lb lc ld le bi translated"><a class="ae lo" href="https://developer.sh/posts/prometheus-self-discovery" rel="noopener ugc nofollow" target="_blank">普罗米修斯在库伯涅特斯上的自我发现</a></li><li id="fba1" class="kw kx iq ka b kb lf kf lg kj lh kn li kr lj kv lb lc ld le bi translated"><a class="ae lo" href="https://theithollow.com/2019/02/04/kubernetes-endpoints/" rel="noopener ugc nofollow" target="_blank"> Kubernetes —端点</a></li></ul><h2 id="ee61" class="lx ly iq bd lz ma mb dn mc md me dp mf kj mg mh mi kn mj mk ml kr mm mn mo mp bi translated">配置</h2><ul class=""><li id="ec5b" class="kw kx iq ka b kb mq kf mr kj og kn oh kr oi kv lb lc ld le bi translated"><a class="ae lo" href="https://github.com/do-community/doks-monitoring/blob/master/manifest/prometheus-configmap.yaml" rel="noopener ugc nofollow" target="_blank">doks-monitoring/manifest/Prometheus-config map . YAML</a></li><li id="4602" class="kw kx iq ka b kb lf kf lg kj lh kn li kr lj kv lb lc ld le bi translated"><a class="ae lo" href="https://github.com/prometheus/prometheus/blob/master/documentation/examples/prometheus-kubernetes.yml" rel="noopener ugc nofollow" target="_blank">Prometheus/documentation/examples/Prometheus-kubernetes . yml</a></li><li id="e472" class="kw kx iq ka b kb lf kf lg kj lh kn li kr lj kv lb lc ld le bi translated"><a class="ae lo" href="https://github.com/helm/charts/blob/master/stable/prometheus/templates/server-configmap.yaml" rel="noopener ugc nofollow" target="_blank">charts/stable/Prometheus/templates/server-config map . YAML</a></li></ul><h2 id="f536" class="lx ly iq bd lz ma mb dn mc md me dp mf kj mg mh mi kn mj mk ml kr mm mn mo mp bi translated">混杂的</h2><ul class=""><li id="177f" class="kw kx iq ka b kb mq kf mr kj og kn oh kr oi kv lb lc ld le bi translated"><a class="ae lo" href="https://grafana.com/grafana/plugins/grafana-kubernetes-app" rel="noopener ugc nofollow" target="_blank">用于Kubernetes的Grafana应用程序</a></li></ul></div><div class="ab cl lq lr hu ls" role="separator"><span class="lt bw bk lu lv lw"/><span class="lt bw bk lu lv lw"/><span class="lt bw bk lu lv"/></div><div class="ij ik il im in"><p id="28fc" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><em class="lp">原发表于</em> <a class="ae lo" href="https://rtfm.co.ua/en/kubernetes-monitoring-with-prometheus-exporters-a-service-discovery-and-its-roles/" rel="noopener ugc nofollow" target="_blank"> <em class="lp"> RTFM: Linux，devo PSисистемноеадммитииииииованниое</em></a>T30。</p></div></div>    
</body>
</html>