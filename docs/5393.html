<html>
<head>
<title>CircleCI parallel testing RSpec with JUnit XML reports merged</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">CircleCI并行测试RSpec与JUnit XML报告合并</h1>
<blockquote>原文：<a href="https://itnext.io/circleci-parallel-testing-rspec-with-junit-xml-reports-merged-5f91e773ff3e?source=collection_archive---------3-----------------------#2021-02-23">https://itnext.io/circleci-parallel-testing-rspec-with-junit-xml-reports-merged-5f91e773ff3e?source=collection_archive---------3-----------------------#2021-02-23</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="d913" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">您将学习如何在<strong class="jp ir"> CircleCI </strong>上用并行作业为您的<strong class="jp ir"> Ruby on Rails </strong>项目运行<strong class="jp ir"> RSpec </strong>测试，以缩短您的CI构建的运行时间。此外，您将学习如何配置<strong class="jp ir"> JUnit </strong> formatter来为您的测试生成XML报告，以便在CircleCI web UI中很好地显示失败的RSpec测试示例。最后，您将看到如何自动检测慢速spec文件，并在并行作业之间划分它们的测试示例，以消除花费太多时间运行测试的瓶颈作业。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi kl"><img src="../Images/c7b51b6027f60b865dd8cfe6ae1ca42e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*YMDEp_VjI16j3W6o.jpeg"/></div></div></figure><h1 id="b15a" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">Ruby gems来配置您的RoR项目</h1><p id="83fc" class="pw-post-body-paragraph jn jo iq jp b jq lv js jt ju lw jw jx jy lx ka kb kc ly ke kf kg lz ki kj kk ij bi translated">以下是您需要的关键要素:</p><ul class=""><li id="edf6" class="ma mb iq jp b jq jr ju jv jy mc kc md kg me kk mf mg mh mi bi translated"><a class="ae mj" href="https://github.com/sj26/rspec_junit_formatter" rel="noopener ugc nofollow" target="_blank">rspec _ JUnit _ formatter</a>—这是一个ruby gem，它为已执行的测试生成一个XML报告，其中包含关于测试失败的信息。CircleCI可以自动读取该报告，并将其显示在CircleCI web UI中。无需再浏览冗长的RSpec输出——只需查看<code class="fe mk ml mm mn b">TESTS</code>选项卡中突出显示的不合格规格:)</li></ul><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi mo"><img src="../Images/87028f195192f4a74dd295e0e659a47d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*t-pzeI50Hd39MKpz.png"/></div></div></figure><ul class=""><li id="d50e" class="ma mb iq jp b jq jr ju jv jy mc kc md kg me kk mf mg mh mi bi translated"><a class="ae mj" href="https://knapsackpro.com/?utm_source=medium&amp;utm_medium=blog_post&amp;utm_campaign=rspec-testing-parallel-jobs-with-circleci-and-junit-xml-report" rel="noopener ugc nofollow" target="_blank">backpack _ pro</a>—这是一个Ruby gem，用于在并行CI作业上运行测试，以确保所有作业在相似的时间完成工作，从而尽可能地节省您的时间并消除瓶颈。</li><li id="fb8e" class="ma mb iq jp b jq mp ju mq jy mr kc ms kg mt kk mf mg mh mi bi translated">背包Pro使用<a class="ae mj" href="https://docs.knapsackpro.com/2020/how-to-speed-up-ruby-and-javascript-tests-with-ci-parallelisation" rel="noopener ugc nofollow" target="_blank">队列模式在并行作业</a>之间动态拆分测试文件。</li><li id="a471" class="ma mb iq jp b jq mp ju mq jy mr kc ms kg mt kk mf mg mh mi bi translated">backpack Pro还可以<a class="ae mj" href="https://knapsackpro.com/faq/question/how-to-split-slow-rspec-test-files-by-test-examples-by-individual-it?utm_source=medium&amp;utm_medium=blog_post&amp;utm_campaign=rspec-testing-parallel-jobs-with-circleci-and-junit-xml-report" rel="noopener ugc nofollow" target="_blank">检测你的慢速RSpec测试文件，并通过测试实例</a>在并行作业之间进行划分。如果您想在CircleCI:上并行容器之间分割工作，您不必手动将大的spec文件分割成较小的文件</li></ul><p id="17c5" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">把以上宝石加到你的<code class="fe mk ml mm mn b">Gemfile</code>里就行了。</p><pre class="km kn ko kp gt mu mn mv mw aw mx bi"><span id="5a7f" class="my ky iq mn b gy mz na l nb nc">group :test <strong class="mn ir">do</strong><br/>  gem 'rspec'<br/>  gem 'rspec_junit_formatter'<br/><strong class="mn ir">end</strong><br/><br/>group :test, :development <strong class="mn ir">do</strong><br/>  gem 'knapsack_pro'<br/><strong class="mn ir">end</strong></span></pre><p id="9b6a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">对于<a class="ae mj" href="https://knapsackpro.com/?utm_source=medium&amp;utm_medium=blog_post&amp;utm_campaign=rspec-testing-parallel-jobs-with-circleci-and-junit-xml-report" rel="noopener ugc nofollow" target="_blank">背包专业版，你需要一个API令牌</a>，你需要按照<a class="ae mj" href="https://docs.knapsackpro.com/knapsack_pro-ruby/guide/" rel="noopener ugc nofollow" target="_blank">安装指南</a>来配置你的项目。</p><p id="e0c9" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果您在队列模式下使用CircleCI的<code class="fe mk ml mm mn b">knapsack_pro</code> gem，您可能想要收集元数据，比如关于您的RSpec测试套件的JUnit XML报告。CircleCI的重要步骤是将XML报告复制到<code class="fe mk ml mm mn b">$CIRCLE_TEST_REPORTS</code>目录。下面是你的<code class="fe mk ml mm mn b">spec_helper.rb</code>文件的完整配置(来自FAQ 的<a class="ae mj" href="https://knapsackpro.com/faq/question/how-to-use-junit-formatter?utm_source=medium&amp;utm_medium=blog_post&amp;utm_campaign=rspec-testing-parallel-jobs-with-circleci-and-junit-xml-report#how-to-use-junit-formatter-with-knapsack_pro-queue-mode" rel="noopener ugc nofollow" target="_blank">源代码):</a></p><pre class="km kn ko kp gt mu mn mv mw aw mx bi"><span id="e769" class="my ky iq mn b gy mz na l nb nc"><em class="nd"># spec_helper.rb or rails_helper.rb</em><br/><br/><em class="nd"># This must be the same path as value for rspec --out argument</em><br/><em class="nd"># Note: the path should not contain '~' sign, for instance path ~/project/tmp/rspec.xml may not work.</em><br/><em class="nd"># Please use full path instead.</em><br/>TMP_RSPEC_XML_REPORT <strong class="mn ir">=</strong> 'tmp/rspec.xml'<br/><em class="nd"># move results to FINAL_RSPEC_XML_REPORT</em><br/><em class="nd"># so that the results won't accumulate with duplicated xml tags in TMP_RSPEC_XML_REPORT</em><br/>FINAL_RSPEC_XML_REPORT <strong class="mn ir">=</strong> 'tmp/rspec_final_results.xml'<br/><br/>KnapsackPro<strong class="mn ir">::</strong>Hooks<strong class="mn ir">::</strong>Queue.<strong class="mn ir">after_subset_queue</strong> <strong class="mn ir">do</strong> <strong class="mn ir">|</strong>queue_id, subset_queue_id<strong class="mn ir">|</strong><br/>  <strong class="mn ir">if</strong> File.<strong class="mn ir">exist?</strong>(TMP_RSPEC_XML_REPORT)<br/>    FileUtils.<strong class="mn ir">mv</strong>(TMP_RSPEC_XML_REPORT, FINAL_RSPEC_XML_REPORT)<br/>  <strong class="mn ir">end</strong><br/><strong class="mn ir">end</strong></span></pre><p id="1730" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">您需要上述逻辑来将XML报告从一个地方移动到另一个地方，以避免意外损坏您的XML文件。当backpack Pro在队列模式下运行您的测试时，它会从backpack Pro队列API中获取一组测试文件，然后运行它并生成XML报告。之后，从Queue API获取另一组测试文件，并在磁盘上更新XML报告。如果报告已经存在于磁盘上，它可能会由于覆盖同一个文件而损坏。这就是为什么在来自Queue API的每组测试被执行之后，您需要将文件移动到不同的位置。</p><h1 id="d20c" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">RSpec的CircleCI YML配置</h1><p id="0832" class="pw-post-body-paragraph jn jo iq jp b jq lv js jt ju lw jw jx jy lx ka kb kc ly ke kf kg lz ki kj kk ij bi translated">这是完整的rcleCI YML配置文件，用于RSpec、backpackage Pro和JUnit格式化程序。</p><pre class="km kn ko kp gt mu mn mv mw aw mx bi"><span id="a9d0" class="my ky iq mn b gy mz na l nb nc"><em class="nd"># Ruby CircleCI 2.0 configuration file</em><br/><em class="nd">#</em><br/><em class="nd"># Check </em><a class="ae mj" href="https://circleci.com/docs/2.0/language-ruby/" rel="noopener ugc nofollow" target="_blank"><em class="nd">https://circleci.com/docs/2.0/language-ruby/</em></a><em class="nd"> for more details</em><br/><em class="nd">#</em><br/>version: 2<br/>jobs:<br/>  build:<br/>    parallelism: 10<br/>    <em class="nd"># </em><a class="ae mj" href="https://circleci.com/docs/2.0/configuration-reference/#resource_class" rel="noopener ugc nofollow" target="_blank"><em class="nd">https://circleci.com/docs/2.0/configuration-reference/#resource_class</em></a><br/>    resource_class: small<br/>    docker:<br/>      <em class="nd"># specify the version you desire here</em><br/>      - image: circleci/ruby:2.7.1-node-browsers<br/>        environment:<br/>          PGHOST: 127.0.0.1<br/>          PGUSER: my_db_user<br/>          RAILS_ENV: test<br/>          <em class="nd"># Split slow RSpec test files by test examples</em><br/>          <em class="nd"># </em><a class="ae mj" href="https://knapsackpro.com/faq/question/how-to-split-slow-rspec-test-files-by-test-examples-by-individual-it" rel="noopener ugc nofollow" target="_blank"><em class="nd">https://knapsackpro.com/faq/question/how-to-split-slow-rspec-test-files-by-test-examples-by-individual-it</em></a><br/>          KNAPSACK_PRO_RSPEC_SPLIT_BY_TEST_EXAMPLES: true<br/><br/>      <em class="nd"># Specify service dependencies here if necessary</em><br/>      <em class="nd"># CircleCI maintains a library of pre-built images</em><br/>      <em class="nd"># documented at </em><a class="ae mj" href="https://circleci.com/docs/2.0/circleci-images/" rel="noopener ugc nofollow" target="_blank"><em class="nd">https://circleci.com/docs/2.0/circleci-images/</em></a><br/>      - image: circleci/postgres:10.6-alpine-ram<br/>        environment:<br/>          POSTGRES_DB: my_db_name<br/>          POSTGRES_PASSWORD: ""<br/>          POSTGRES_USER: my_db_user<br/>          <em class="nd"># Rails verifies Time Zone in DB is the same as time zone of the Rails app</em><br/>          TZ: "Europe/Warsaw"<br/><br/>      - image: redis:6.0.7<br/><br/>    working_directory: ~/repo<br/>    environment:<br/>      TZ: "Europe/Warsaw"<br/><br/>    steps:<br/>      - checkout<br/><br/>      <em class="nd"># Download and cache dependencies</em><br/>      - restore_cache:<br/>          keys:<br/>          - v2-dependencies-bundler-{{ checksum "Gemfile.lock" }}-{{ checksum ".ruby-version" }}<br/>          <em class="nd"># fallback to using the latest cache if no exact match is found</em><br/>          - v2-dependencies-bundler-<br/><br/>      - run:<br/>          name: install ruby dependencies<br/>          command: |<br/>            bundle install --jobs=4 --retry=3 --path vendor/bundle<br/><br/>      - save_cache:<br/>          paths:<br/>            - ./vendor/bundle<br/>          key: v2-dependencies-bundler-{{ checksum "Gemfile.lock" }}-{{ checksum ".ruby-version" }}<br/><br/>      <em class="nd"># Database setup</em><br/>      - run: bin/rails db:prepare<br/><br/>      - run:<br/>          name: run tests<br/>          command: |<br/>            export CIRCLE_TEST_REPORTS=/tmp/test-results<br/>            mkdir $CIRCLE_TEST_REPORTS<br/>            bundle exec rake "knapsack_pro:queue:rspec[--format documentation --format RspecJunitFormatter --out tmp/rspec.xml]"<br/><br/>      <em class="nd"># collect reports</em><br/>      - store_test_results:<br/>          path: /tmp/test-results<br/>      - store_artifacts:<br/>          path: /tmp/test-results<br/>          destination: test-results</span></pre><h1 id="43d8" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">摘要</h1><p id="ddcc" class="pw-post-body-paragraph jn jo iq jp b jq lv js jt ju lw jw jx jy lx ka kb kc ly ke kf kg lz ki kj kk ij bi translated">你刚刚学会了如何让你的CircleCI构建更快！现在，您的RSpec测试可以在许多并行机器上自动运行，以节省您的时间。如果有帮助或者有任何问题，请告诉我们。欢迎<a class="ae mj" href="https://knapsackpro.com/?utm_source=medium&amp;utm_medium=blog_post&amp;utm_campaign=rspec-testing-parallel-jobs-with-circleci-and-junit-xml-report" rel="noopener ugc nofollow" target="_blank">在背包专业版</a>或下面报名，亲自尝试。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div class="gh gi ne"><img src="../Images/eb71fbc49cd1ba62860bb2b183dff105.png" data-original-src="https://miro.medium.com/v2/resize:fit:160/format:webp/0*PCW-zzQzWBTMw9SA.png"/></div></figure></div><div class="ab cl nf ng hu nh" role="separator"><span class="ni bw bk nj nk nl"/><span class="ni bw bk nj nk nl"/><span class="ni bw bk nj nk"/></div><div class="ij ik il im in"><p id="739f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><em class="nd">原载于2021年2月23日https://docs.knapsackpro.com</em><em class="nd"/><a class="ae mj" href="https://docs.knapsackpro.com/2021/rspec-testing-parallel-jobs-with-circleci-and-junit-xml-report" rel="noopener ugc nofollow" target="_blank"><em class="nd">。</em></a></p></div></div>    
</body>
</html>