<html>
<head>
<title>Exploring Geospatial Data with NebulaGraph Database</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用星云图数据库探索地理空间数据</h1>
<blockquote>原文：<a href="https://itnext.io/exploring-geospatial-data-with-nebulagraph-database-f2ed2948b3a9?source=collection_archive---------1-----------------------#2022-11-25">https://itnext.io/exploring-geospatial-data-with-nebulagraph-database-f2ed2948b3a9?source=collection_archive---------1-----------------------#2022-11-25</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/fce72b4852cdb264be3fa51575e5a3fa.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*BQNnCO5G5rKWkWX7.jpg"/></div></div></figure><h1 id="498d" class="jy jz iq bd ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv bi translated">什么是地理空间数据？</h1><p id="202c" class="pw-post-body-paragraph kw kx iq ky b kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt ij bi translated">地理空间数据是与地理空间实体(如点、线和多边形)相关的信息。</p><p id="a25d" class="pw-post-body-paragraph kw kx iq ky b kz lu lb lc ld lv lf lg lh lw lj lk ll lx ln lo lp ly lr ls lt ij bi translated">NebulaGraph 2.6支持地理空间数据。您可以在NebulaGraph中存储、计算和检索地理空间数据。地理是NebulaGraph支持的数据类型。它由代表地理空间数据的纬度和经度组成。</p><h1 id="0b43" class="jy jz iq bd ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv bi translated">如何在NebulaGraph中使用地理空间数据？</h1><p id="f5bd" class="pw-post-body-paragraph kw kx iq ky b kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt ij bi translated"><strong class="ky ir">创建模式</strong></p><p id="4ad6" class="pw-post-body-paragraph kw kx iq ky b kz lu lb lc ld lv lf lg lh lw lj lk ll lx ln lo lp ly lr ls lt ij bi translated">以下示例显示了如何创建标记。您可以用相同的方式创建边类型。</p><p id="6240" class="pw-post-body-paragraph kw kx iq ky b kz lu lb lc ld lv lf lg lh lw lj lk ll lx ln lo lp ly lr ls lt ij bi translated">NebulaGraph目前支持三种类型的地理空间数据:点、线串和多边形。以下显示了如何创建地理类型和插入地理空间数据。</p><pre class="lz ma mb mc gt md me mf bn mg mh bi"><span id="02e0" class="mi jz iq me b be mj mk l ml mm">CREATE TAG any_shape(geo geography);<br/>CREATE TAG only_point(geo geography(point));<br/>CREATE TAG only_linestring(geo geography(linestring));<br/>CREATE TAG only_polygon(geo geography(polygon));</span></pre><p id="17bd" class="pw-post-body-paragraph kw kx iq ky b kz lu lb lc ld lv lf lg lh lw lj lk ll lx ln lo lp ly lr ls lt ij bi translated">当没有指定地理类型时，意味着可以存储任何类型的数据；指定了类型，就意味着只能存储该类型的地理空间数据，比如<code class="fe mn mo mp me b">geography (point)</code>，就意味着只能存储点的空间信息。</p><p id="87c9" class="pw-post-body-paragraph kw kx iq ky b kz lu lb lc ld lv lf lg lh lw lj lk ll lx ln lo lp ly lr ls lt ij bi translated"><strong class="ky ir">插入数据</strong></p><p id="8427" class="pw-post-body-paragraph kw kx iq ky b kz lu lb lc ld lv lf lg lh lw lj lk ll lx ln lo lp ly lr ls lt ij bi translated">在<code class="fe mn mo mp me b">any_shape</code>标签的<code class="fe mn mo mp me b">geo</code>列中插入数据。</p><pre class="lz ma mb mc gt md me mf bn mg mh bi"><span id="59d9" class="mi jz iq me b be mj mk l ml mm">INSERT VERTEX any_shape(geo) VALUES "101":(ST_GeogFromText("POINT(120.12 30.16)"));<br/>INSERT VERTEX any_shape(geo) VALUES "102":(ST_GeogFromText("LINESTRING(3 8, 4.7 73.23)"));<br/>INSERT VERTEX any_shape(geo) VALUES "103":(ST_GeogFromText("POLYGON((75.3 45.4, 112.5 53.6, 122.7 25.5, 93.9 28.6, 75.3 45.4))"));</span></pre><p id="d3e6" class="pw-post-body-paragraph kw kx iq ky b kz lu lb lc ld lv lf lg lh lw lj lk ll lx ln lo lp ly lr ls lt ij bi translated">在<code class="fe mn mo mp me b">only_point</code>标签的<code class="fe mn mo mp me b">geo</code>栏中插入数据。</p><pre class="lz ma mb mc gt md me mf bn mg mh bi"><span id="47c0" class="mi jz iq me b be mj mk l ml mm">INSERT VERTEX only_point(geo) VALUES "201":(ST_Point(120.12，30.16)"));;</span></pre><p id="b5c2" class="pw-post-body-paragraph kw kx iq ky b kz lu lb lc ld lv lf lg lh lw lj lk ll lx ln lo lp ly lr ls lt ij bi translated">在<code class="fe mn mo mp me b">only_linestring</code>标签的<code class="fe mn mo mp me b">geo</code>栏中插入数据。</p><pre class="lz ma mb mc gt md me mf bn mg mh bi"><span id="cd0d" class="mi jz iq me b be mj mk l ml mm">INSERT VERTEX only_linestring(geo) VALUES "302":(ST_GeogFromText("LINESTRING(3 8, 4.7 73.23)"));</span></pre><p id="3468" class="pw-post-body-paragraph kw kx iq ky b kz lu lb lc ld lv lf lg lh lw lj lk ll lx ln lo lp ly lr ls lt ij bi translated">在<code class="fe mn mo mp me b">only_polygon</code>标签的<code class="fe mn mo mp me b">geo</code>栏中插入数据。</p><pre class="lz ma mb mc gt md me mf bn mg mh bi"><span id="8c8f" class="mi jz iq me b be mj mk l ml mm">INSERT VERTEX only_polygon(geo) VALUES "403":(ST_GeogFromText("POLYGON((75.3 45.4, 112.5 53.6, 122.7 25.5, 93.9 28.6, 75.3 45.4))"));</span></pre><p id="a62b" class="pw-post-body-paragraph kw kx iq ky b kz lu lb lc ld lv lf lg lh lw lj lk ll lx ln lo lp ly lr ls lt ij bi translated">当插入的数据不符合指定类型的要求时，数据插入会失败。</p><pre class="lz ma mb mc gt md me mf bn mg mh bi"><span id="5b62" class="mi jz iq me b be mj mk l ml mm">(root@nebula) [geo]&gt; INSERT VERTEX only_polygon(geo) VALUES "404":(ST_GeogFromText("POINT((75.3 45.4))"));<br/>[ERROR (-1005)]: Wrong value type: ST_GeogFromText("POINT((75.3 45.4))")</span></pre><p id="a8c9" class="pw-post-body-paragraph kw kx iq ky b kz lu lb lc ld lv lf lg lh lw lj lk ll lx ln lo lp ly lr ls lt ij bi translated">我们可以看到地理空间数据的插入方式比较奇特，与<code class="fe mn mo mp me b">int</code>、<code class="fe mn mo mp me b">string</code>、<code class="fe mn mo mp me b">bool</code>等基本类型的插入有很大不同。</p><p id="a2a9" class="pw-post-body-paragraph kw kx iq ky b kz lu lb lc ld lv lf lg lh lw lj lk ll lx ln lo lp ly lr ls lt ij bi translated">以<code class="fe mn mo mp me b">ST_GeogFromText("POINT(120.12 30.16)")</code>为例，<code class="fe mn mo mp me b">ST_GeogFromText</code>是地理位置信息解析函数，接受WKT(公知文本)标准格式的字符串类型的地理位置数据。</p><p id="42b0" class="pw-post-body-paragraph kw kx iq ky b kz lu lb lc ld lv lf lg lh lw lj lk ll lx ln lo lp ly lr ls lt ij bi translated"><code class="fe mn mo mp me b">POINT(120.12 30.16)</code>代表东经120° 12′北纬30° 16′的地理点；<code class="fe mn mo mp me b">ST_GeogFromText</code>函数从WKT参数解析并构造一个地理数据对象，然后<code class="fe mn mo mp me b">INSERT</code>语句将其存储在WKB(众所周知的二进制)标准的NebulaGraph中。</p><h1 id="2c24" class="jy jz iq bd ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv bi translated">地理空间功能</h1><p id="13d7" class="pw-post-body-paragraph kw kx iq ky b kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt ij bi translated">NebulaGraph支持的地理空间功能可分为以下主要类别:</p><ul class=""><li id="f6c6" class="mq mr iq ky b kz lu ld lv lh ms ll mt lp mu lt mv mw mx my bi translated">构造函数</li><li id="cda3" class="mq mr iq ky b kz mz ld na lh nb ll nc lp nd lt mv mw mx my bi translated"><code class="fe mn mo mp me b">ST_Point(longitude, latitude)</code>:基于经纬度对构造一个<code class="fe mn mo mp me b">geography point</code>对象。</li><li id="8a8f" class="mq mr iq ky b kz mz ld na lh nb ll nc lp nd lt mv mw mx my bi translated">解析函数</li><li id="d69b" class="mq mr iq ky b kz mz ld na lh nb ll nc lp nd lt mv mw mx my bi translated"><code class="fe mn mo mp me b">ST_GeogFromText(wkt_string)</code>:从WKT文本中解析<code class="fe mn mo mp me b">geography</code>对象。</li><li id="3561" class="mq mr iq ky b kz mz ld na lh nb ll nc lp nd lt mv mw mx my bi translated"><code class="fe mn mo mp me b">ST_GeogFromWKB(wkb_string)</code>:从WKB文本中解析<code class="fe mn mo mp me b">geography</code>对象。#尚不支持，因为NebulaGraph尚不支持二进制字符串。</li><li id="7ec6" class="mq mr iq ky b kz mz ld na lh nb ll nc lp nd lt mv mw mx my bi translated">格式设置功能</li><li id="2bce" class="mq mr iq ky b kz mz ld na lh nb ll nc lp nd lt mv mw mx my bi translated"><code class="fe mn mo mp me b">ST_AsText(geography)</code>:以WKT文本格式输出<code class="fe mn mo mp me b">geography</code>对象。</li><li id="715d" class="mq mr iq ky b kz mz ld na lh nb ll nc lp nd lt mv mw mx my bi translated"><code class="fe mn mo mp me b">ST_AsBinary(geography)</code>:以WKB文本格式输出<code class="fe mn mo mp me b">geography</code>对象。#尚不支持，因为NebulaGraph尚不支持二进制字符串。</li><li id="01b7" class="mq mr iq ky b kz mz ld na lh nb ll nc lp nd lt mv mw mx my bi translated">转换函数</li><li id="cf31" class="mq mr iq ky b kz mz ld na lh nb ll nc lp nd lt mv mw mx my bi translated"><code class="fe mn mo mp me b">ST_Centroid(geography)</code>:计算<code class="fe mn mo mp me b">geography</code>物体的重心，该物体为<code class="fe mn mo mp me b">geography point</code>物体。</li><li id="0720" class="mq mr iq ky b kz mz ld na lh nb ll nc lp nd lt mv mw mx my bi translated">谓词函数</li><li id="819e" class="mq mr iq ky b kz mz ld na lh nb ll nc lp nd lt mv mw mx my bi translated"><code class="fe mn mo mp me b">ST_Intersects(geography_1, geography_2)</code>:判断两个<code class="fe mn mo mp me b">geography</code>对象是否相交。</li><li id="222a" class="mq mr iq ky b kz mz ld na lh nb ll nc lp nd lt mv mw mx my bi translated"><code class="fe mn mo mp me b">ST_Covers(geography_1, geography_2)</code>:判断第一个<code class="fe mn mo mp me b">geography</code>对象是否完全覆盖第二个对象。</li><li id="4bca" class="mq mr iq ky b kz mz ld na lh nb ll nc lp nd lt mv mw mx my bi translated"><code class="fe mn mo mp me b">ST_CoveredBy(geography_1, geography_2)</code>:ST _ Covers的逆。</li><li id="9865" class="mq mr iq ky b kz mz ld na lh nb ll nc lp nd lt mv mw mx my bi translated"><code class="fe mn mo mp me b">ST_DWithin(geography_1, geography_2, distance_in_meters)</code>:判断两个<code class="fe mn mo mp me b">geography</code>物体之间的最短距离是否小于给定距离。</li><li id="01ca" class="mq mr iq ky b kz mz ld na lh nb ll nc lp nd lt mv mw mx my bi translated">度量函数</li><li id="229e" class="mq mr iq ky b kz mz ld na lh nb ll nc lp nd lt mv mw mx my bi translated"><code class="fe mn mo mp me b">ST_Distance(geography_1, geography_2)</code>:计算两个<code class="fe mn mo mp me b">geography</code>物体之间的距离。</li></ul><p id="3e95" class="pw-post-body-paragraph kw kx iq ky b kz lu lb lc ld lv lf lg lh lw lj lk ll lx ln lo lp ly lr ls lt ij bi translated">这些函数接口遵循OpenGIS简单要素访问和ISO SQL/MM标准。详情见<a class="ae ne" href="https://docs.nebula-graph.io/3.3.0/3.ngql-guide/6.functions-and-expressions/14.geo/" rel="noopener ugc nofollow" target="_blank"> NebulaGraph文档。</a></p><h1 id="140d" class="jy jz iq bd ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv bi translated">地理空间索引</h1><p id="fc23" class="pw-post-body-paragraph kw kx iq ky b kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt ij bi translated">什么是地理空间索引？</p><p id="6f45" class="pw-post-body-paragraph kw kx iq ky b kz lu lb lc ld lv lf lg lh lw lj lk ll lx ln lo lp ly lr ls lt ij bi translated">地理空间索引是可用于基于谓词<code class="fe mn mo mp me b">ST_Intersects</code>和<code class="fe mn mo mp me b">ST_Covers</code>函数快速过滤数据的索引。</p><p id="c54f" class="pw-post-body-paragraph kw kx iq ky b kz lu lb lc ld lv lf lg lh lw lj lk ll lx ln lo lp ly lr ls lt ij bi translated">NebulaGraph使用谷歌S2图书馆作为地理空间索引。</p><p id="6dc7" class="pw-post-body-paragraph kw kx iq ky b kz lu lb lc ld lv lf lg lh lw lj lk ll lx ln lo lp ly lr ls lt ij bi translated">S2图书馆将地球表面投影成一个相切的正方形，然后递归地将正方形的每个正方形表面翻四倍n次，并使用一条空间填充曲线，即希尔伯特曲线，来连接这些小正方形网格的中心。</p><p id="afa0" class="pw-post-body-paragraph kw kx iq ky b kz lu lb lc ld lv lf lg lh lw lj lk ll lx ln lo lp ly lr ls lt ij bi translated">当n无限大时，这条希尔伯特曲线几乎填满了正方形。</p><p id="ae92" class="pw-post-body-paragraph kw kx iq ky b kz lu lb lc ld lv lf lg lh lw lj lk ll lx ln lo lp ly lr ls lt ij bi translated">S2图书馆使用30阶希尔伯特曲线。</p><figure class="lz ma mb mc gt jr gh gi paragraph-image"><div class="gh gi nf"><img src="../Images/568e8066fc2751b6e71b705fc3b89ef6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1134/format:webp/0*4RL7WCGHPfHBX_Zn.jpeg"/></div></figure><p id="e8f3" class="pw-post-body-paragraph kw kx iq ky b kz lu lb lc ld lv lf lg lh lw lj lk ll lx ln lo lp ly lr ls lt ij bi translated">下图显示地球上充满了希尔伯特曲线。</p><figure class="lz ma mb mc gt jr gh gi paragraph-image"><div class="gh gi ng"><img src="../Images/b7d7c89d6819faa02269105d778f9e2b.png" data-original-src="https://miro.medium.com/v2/resize:fit:758/format:webp/0*4ycRoh7Gb4D-oi5P.jpeg"/></div></figure><p id="ea53" class="pw-post-body-paragraph kw kx iq ky b kz lu lb lc ld lv lf lg lh lw lj lk ll lx ln lo lp ly lr ls lt ij bi translated">可以看出，地球表面是由这些希尔伯特曲线划分成单元的。对于地球表面的任何地理形状，如城市、河流或人的位置，我们可以使用几个这样的单元来完全覆盖地理形状。</p><p id="a26c" class="pw-post-body-paragraph kw kx iq ky b kz lu lb lc ld lv lf lg lh lw lj lk ll lx ln lo lp ly lr ls lt ij bi translated">每个单元由一个唯一的int64 CellID标识。因此，地理对象的空间索引是构造成完全覆盖地理形状的一组S2像元。</p><p id="86a5" class="pw-post-body-paragraph kw kx iq ky b kz lu lb lc ld lv lf lg lh lw lj lk ll lx ln lo lp ly lr ls lt ij bi translated">当构建地理空间对象的索引时，构建完全覆盖索引对象的不同S2单元的集合。基于空间谓词函数的索引查询通过找到覆盖被查询对象的一组S2单元和覆盖被索引对象的S2单元之间的交集来快速过滤掉大量不相关的地理对象。</p><h2 id="552b" class="nh jz iq bd ka ni nj dn ke nk nl dp ki lh nm nn km ll no np kq lp nq nr ku ns bi translated"><strong class="ak">创建地理索引</strong></h2><pre class="lz ma mb mc gt md me mf bn mg mh bi"><span id="b5cc" class="mi jz iq me b be mj mk l ml mm">CREATE TAG any_shape_geo_index on any_shape(geo)</span></pre><p id="0551" class="pw-post-body-paragraph kw kx iq ky b kz lu lb lc ld lv lf lg lh lw lj lk ll lx ln lo lp ly lr ls lt ij bi translated">对于类型为<code class="fe mn mo mp me b">point</code>的地理空间数据，可以用30阶的S2单元来表示，因此一个点对应一个索引条目；对于类型为<code class="fe mn mo mp me b">inestring</code>和<code class="fe mn mo mp me b">polygon</code>的地理空间数据，我们使用不同级别的多个S2单元来覆盖它，因此它将对应于多个索引条目。</p><p id="2d08" class="pw-post-body-paragraph kw kx iq ky b kz lu lb lc ld lv lf lg lh lw lj lk ll lx ln lo lp ly lr ls lt ij bi translated">空间索引用于加速所有地理谓词的查找，例如:</p><pre class="lz ma mb mc gt md me mf bn mg mh bi"><span id="8007" class="mi jz iq me b be mj mk l ml mm">LOOKUP ON any_shape WHERE ST_Intersects(any_shape.geo, ST_GeogFromText("LINESTRING(3 8, 4.7 73.23)"));</span></pre><p id="6d9d" class="pw-post-body-paragraph kw kx iq ky b kz lu lb lc ld lv lf lg lh lw lj lk ll lx ln lo lp ly lr ls lt ij bi translated">当<code class="fe mn mo mp me b">any_shape</code>的<code class="fe mn mo mp me b">geo</code>列上没有空间索引时，该语句会先将<code class="fe mn mo mp me b">any_shape</code>的所有数据读入内存，然后用它来计算是否与点(3.0，8.0)相交，一般开销较大。当<code class="fe mn mo mp me b">any_shape</code>中的数据量较大时，计算开销将无法接受。</p><p id="84c4" class="pw-post-body-paragraph kw kx iq ky b kz lu lb lc ld lv lf lg lh lw lj lk ll lx ln lo lp ly lr ls lt ij bi translated">当<code class="fe mn mo mp me b">any_shape</code>的<code class="fe mn mo mp me b">geo</code>列有空间索引时，该语句将首先使用空间索引过滤掉与该行相交的大部分数据，但在读入内存时仍会有一些可能相交，因此仍有一个计算要做。这样，空间索引以较小的代价快速过滤掉大部分不太可能相交的数据，小部分被过滤掉，大大降低了计算开销。</p></div></div>    
</body>
</html>