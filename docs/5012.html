<html>
<head>
<title>Terragrunt — The glue around Terraform</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">terra grunt——围绕Terraform的粘合剂</h1>
<blockquote>原文：<a href="https://itnext.io/terragrunt-the-glue-around-terraform-ae15e2addb66?source=collection_archive---------1-----------------------#2020-11-16">https://itnext.io/terragrunt-the-glue-around-terraform-ae15e2addb66?source=collection_archive---------1-----------------------#2020-11-16</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div class="gh gi jn"><img src="../Images/5992be47db1fb46c391bbe792d8818c5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1156/format:webp/1*3pZw-nhSzDxyzPJktpA0fA.png"/></div><figcaption class="ju jv gj gh gi jw jx bd b be z dk translated">Terragrunt徽标</figcaption></figure><p id="5254" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我已经有一段时间没有发帖了，这主要是因为我最近非常忙。我们面临的挑战之一是协调多个平台堆栈的部署。</p><p id="3977" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">Terraform作为一种基础设施，与Code DSL一样出色。但是，在构建部署相互依赖的环境方面，它有所欠缺。当您想要管理着陆区的所有基础设施(云平台核心基础设施的基础部署)时，这变得非常具有挑战性。</p><p id="6bc0" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在继续之前，让我澄清一下我将使用的一些术语:</p><ul class=""><li id="cb28" class="kw kx iq ka b kb kc kf kg kj ky kn kz kr la kv lb lc ld le bi translated">模块— Terraform模块封装了部署堆栈组件的逻辑。一个堆栈可以有多个模块来构成解决方案。多个模块可以在一个更大的模块中连接在一起，以构建一个堆栈。例如，您可以在用于创建Azure DevOps代理的更大模块中组合存储帐户、资源组、托管身份和虚拟机。</li><li id="8a29" class="kw kx iq ka b kb lf kf lg kj lh kn li kr lj kv lb lc ld le bi translated">堆栈—提供有限功能的多个云资源。堆栈应该有自己的状态文件。示例:核心网络、DNS区域、DNS转发器、管理组层次结构、集中日志记录。通常，您会为每个环境(开发、质量保证、生产)多次部署一个堆栈</li></ul><p id="a00f" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">Terragrunt的部署范围是一个terraform模块(上面定义的较大的模块)。它能够使用依赖关系拼接多个堆栈。</p><p id="37e9" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">最初，我考虑使用远程状态在部署之间共享信息。然而，在大规模管理环境方面还存在其他问题(我稍后会谈到这些问题)。我继续寻找，遇到了Gruntwork的一个工具，叫做Terragrunt。经过一个快速的概念验证(3个小时的拼凑)，我确信这个工具有腿。让我们来看看什么是Terragrunt。</p><blockquote class="lk ll lm"><p id="117f" class="jy jz ln ka b kb kc kd ke kf kg kh ki lo kk kl km lp ko kp kq lq ks kt ku kv ij bi translated">Terragrunt是一个瘦包装器，它提供了额外的工具来保持您的配置干燥，使用多个Terraform模块，以及管理远程状态</p></blockquote><p id="ebe0" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">让我们深入了解这些功能。我计划有额外的博客条目来单独涵盖它们。</p><ul class=""><li id="acfb" class="kw kx iq ka b kb kc kf kg kj ky kn kz kr la kv lb lc ld le bi translated"><strong class="ka ir">分层结构</strong> —部署基础架构的组件本质上是分层的。在代码中组织这些组件遵循类似的方法。这允许您用层次结构配置您的terragrunt代码，并从树中的更高层继承配置；因此随后干燥。</li></ul><figure class="ls lt lu lv gt jr gh gi paragraph-image"><div class="gh gi lr"><img src="../Images/da58adf0f31d1824a860263a8e91bbbe.png" data-original-src="https://miro.medium.com/v2/resize:fit:516/format:webp/1*TsNnlJnCGjT2D1oXY1Si6A.png"/></div><figcaption class="ju jv gj gh gi jw jx bd b be z dk translated">Terragrunt分级结构</figcaption></figure><ul class=""><li id="8c4c" class="kw kx iq ka b kb kc kf kg kj ky kn kz kr la kv lb lc ld le bi translated"><strong class="ka ir">动态远程状态管理</strong> —假设您有10个组件需要管理，这些组件的两个实例分别用于生产和非生产。你现在必须管理大约20个状态文件。因此，您需要为每个组件创建一个后端配置。这很快变得难以处理。Terragrunt提供了使用<em class="ln"> remote_state </em>资源动态生成后端配置的能力，并使用函数创建远程状态键。</li></ul><figure class="ls lt lu lv gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="lx ly di lz bf ma"><div class="gh gi lw"><img src="../Images/4ad9aeeec73be1c07e8c6187b8bbf5ee.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*YXBabhWxEPuxyjhdciYGEw.png"/></div></div><figcaption class="ju jv gj gh gi jw jx bd b be z dk translated">远程状态动态生成</figcaption></figure><ul class=""><li id="0cbb" class="kw kx iq ka b kb kc kf kg kj ky kn kz kr la kv lb lc ld le bi translated"><strong class="ka ir">将值传入模块时的完整DSL表达能力</strong> —变量为您的模块提供了一个契约。对于vanilla Terraform，这些值必须提前计算，并且不是动态的。使用terragrunt，当“计算”模块的输入时，您可以完全使用Terraform语言；从而大大减少了在Terraform之外生成数据的工作。</li><li id="f28c" class="kw kx iq ka b kb lf kf lg kj lh kn li kr lj kv lb lc ld le bi translated"><strong class="ka ir">模块间依赖管理</strong> —让我们面对现实吧，Terraform基本上是一个图形引擎，用于确定模块中资源的部署顺序。Terragrunt通过提供模块/栈之间的图形/依赖关系管理，将这个图形引擎推向了一个新的高度。它允许使用依赖资源将输出数据从一个模块传递到下一个模块。</li></ul><figure class="ls lt lu lv gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="lx ly di lz bf ma"><div class="gh gi mb"><img src="../Images/5859e94c40ebca0c17ff28c04ecd33c3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*cqgVllayDTraLGM77rKeKg.png"/></div></div><figcaption class="ju jv gj gh gi jw jx bd b be z dk translated">DSL表达和依赖管理</figcaption></figure><ul class=""><li id="7e4e" class="kw kx iq ka b kb kc kf kg kj ky kn kz kr la kv lb lc ld le bi translated"><strong class="ka ir">多订阅/账户支持</strong> — Terraform主要专注于将组件部署到单一范围，如Azure订阅或AWS账户。可以在提供者配置中创建别名来解决这个问题，但是这很快就会变得难以管理。Terragrunt允许环境变量的生成传递到Terraform CLI从而允许多订阅支持。</li></ul><figure class="ls lt lu lv gt jr gh gi paragraph-image"><div class="gh gi mc"><img src="../Images/748c3c9a87940934f2869dd08e64ca2c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1262/format:webp/1*-RmIC8qh388f3MctsTfDVQ.png"/></div><figcaption class="ju jv gj gh gi jw jx bd b be z dk translated">多订阅管理</figcaption></figure><ul class=""><li id="e4b4" class="kw kx iq ka b kb kc kf kg kj ky kn kz kr la kv lb lc ld le bi translated"><strong class="ka ir"> Terraform代码生成</strong> — Terragrunt能够在规划/应用/销毁阶段动态生成配置文件。这对于生成后端配置很有用。类似地，您可以使用<em class="ln"> generate </em>资源来创建提供者配置。通过生成配置，您能够减少代码重复并遵循DRY原则(不要重复自己)。</li><li id="07ae" class="kw kx iq ka b kb lf kf lg kj lh kn li kr lj kv lb lc ld le bi translated"><strong class="ka ir">多组件规划/应用/销毁</strong> — Terraform专注于单个堆栈部署。Terragrunt根据Terragrunt代码中定义的依赖关系对其进行了扩展，以处理多个堆栈。您可以计划全部(并不完美，将在以后的文章中详细介绍)、应用全部和销毁全部。Terragrunt构建元图，并以适当的顺序应用它。</li><li id="0e86" class="kw kx iq ka b kb lf kf lg kj lh kn li kr lj kv lb lc ld le bi translated"><strong class="ka ir">它只是工作</strong> —好吧，那不是一种能力。但是，开发人员的体验是最重要的，Terragrunt通过保持DSL Terraform-like做到了这一点。如果你熟悉Terraform，扩展技能到Terragrunt是非常容易掌握的。</li></ul><p id="2c87" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">因此，尽管其中一些功能听起来有些神秘，请继续关注Terragrunt这个博客系列。我将通过代码示例来分解每个功能。</p><p id="1c1e" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">如果你好奇的话，可以看看https://terragrunt.gruntwork.io/docs/的<a class="ae md" href="https://terragrunt.gruntwork.io/docs/" rel="noopener ugc nofollow" target="_blank"/></p></div></div>    
</body>
</html>