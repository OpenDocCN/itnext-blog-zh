<html>
<head>
<title>The possible delay pitfall between React’s useState and useEffect</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">React的useState和useEffect之间可能的延迟陷阱</h1>
<blockquote>原文：<a href="https://itnext.io/the-possible-delay-pitfall-between-reacts-usestate-and-useeffect-383ef1e053d9?source=collection_archive---------1-----------------------#2021-02-08">https://itnext.io/the-possible-delay-pitfall-between-reacts-usestate-and-useeffect-383ef1e053d9?source=collection_archive---------1-----------------------#2021-02-08</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="4615" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><em class="kl">免责声明:我没有深入了解到底是什么导致了这个问题，我只是想向您介绍我最近遇到的情况，希望这能帮助到一些人。</em></p><h1 id="9cd8" class="km kn iq bd ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj bi translated">虫子</h1><p id="e91b" class="pw-post-body-paragraph jn jo iq jp b jq lk js jt ju ll jw jx jy lm ka kb kc ln ke kf kg lo ki kj kk ij bi translated">我用路由器创建了一个简单的react应用程序，并实现了一个最小的可观察对象(取自<a class="ae lp" href="https://blog.betomorrow.com/replacing-redux-with-observables-and-react-hooks-acdbbaf5ba80" rel="noopener ugc nofollow" target="_blank">这里是</a>)来设置和监听值的变化(用作应用程序的全局状态)。</p><p id="bdc9" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">应用程序启动后，我立即调用了一个异步函数来改变全局状态(仅仅是<code class="fe lq lr ls lt b">setTimeout(() =&gt; { globalState.set(...) })</code>)。</p><p id="708a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我让React组件跟踪全局状态的变化，并将其存储在组件的状态中。我用当前的全局状态(也就是T1)初始化了本地状态。</p><p id="f8ed" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">因此..我期望一旦我改变了全局状态，我将在组件的状态中看到最新的值(<code class="fe lq lr ls lt b">Secondary value</code>)。</p><p id="7bc1" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">结果是不一致的，我不能依赖它。</p><figure class="lv lw lx ly gt lz gh gi paragraph-image"><div class="gh gi lu"><img src="../Images/f7d3565216cb47cd4d53f284c9eeea96.png" data-original-src="https://miro.medium.com/v2/resize:fit:1028/1*Xjd6YtCoEcayYHo18QDpSA.gif"/></div></figure><p id="d70f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这让我抓狂。<br/>我知道“次要值”应该出现，因为这是全局状态的最新值。</p><p id="f67c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">为什么组件没有捕捉到这种变化？</p><h1 id="9026" class="km kn iq bd ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj bi translated">原因</h1><p id="5e5a" class="pw-post-body-paragraph jn jo iq jp b jq lk js jt ju ll jw jx jy lm ka kb kc ln ke kf kg lo ki kj kk ij bi translated">经过一整天的研究和根本原因的缩小，我发现当一个组件的<code class="fe lq lr ls lt b">useState</code>和<code class="fe lq lr ls lt b">useEffect</code>相继运行时-</p><figure class="lv lw lx ly gt lz gh gi paragraph-image"><div role="button" tabindex="0" class="md me di mf bf mg"><div class="gh gi mc"><img src="../Images/8deb43f68dd573a499c4751812737d1d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*qmWYwhl-HzQoDXKJfdoNJw.png"/></div></div><figcaption class="mh mi gj gh gi mj mk bd b be z dk translated">相应地，控制台日志来自useState和useEffect。</figcaption></figure><p id="0614" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在某些情况下，异步操作可能介于两者之间。</p><figure class="lv lw lx ly gt lz gh gi paragraph-image"><div role="button" tabindex="0" class="md me di mf bf mg"><div class="gh gi ml"><img src="../Images/266473172b0438cd0789bf84015ffc16.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*_efVJ92LqNES4tPGyPeZjA.png"/></div></div><figcaption class="mh mi gj gh gi mj mk bd b be z dk translated">每个人都讨厌这些。</figcaption></figure><p id="753a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我期待事情会这样发展:</p><figure class="lv lw lx ly gt lz gh gi paragraph-image"><div role="button" tabindex="0" class="md me di mf bf mg"><div class="gh gi mm"><img src="../Images/292908ffd8521d76ccb9f4669586033c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*RCcVbvLkLsMHBKvRyV4miw.png"/></div></div></figure><p id="ec96" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">但我得到了这个:</p><figure class="lv lw lx ly gt lz gh gi paragraph-image"><div role="button" tabindex="0" class="md me di mf bf mg"><div class="gh gi mn"><img src="../Images/8df32d6679857e55431618b9e3212a36.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*UpYGtUVAogJghwmSUa6Ofg.png"/></div></div><figcaption class="mh mi gj gh gi mj mk bd b be z dk translated">没有雷兰德！</figcaption></figure><h1 id="f447" class="km kn iq bd ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj bi translated">解决方案</h1><p id="d7a0" class="pw-post-body-paragraph jn jo iq jp b jq lk js jt ju ll jw jx jy lm ka kb kc ln ke kf kg lo ki kj kk ij bi translated">在我的例子中，我所要做的就是在我们订阅之前确保我们有最新的值。</p><figure class="lv lw lx ly gt lz gh gi paragraph-image"><div role="button" tabindex="0" class="md me di mf bf mg"><div class="gh gi mo"><img src="../Images/7030a1d608e6014b9d7b577f72a31fa5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*V_ZPpQm7B17a-fcDdFQy5Q.png"/></div></div></figure><p id="00a5" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">下面是该行为的完整演示(查看控制台日志，并刷新预览页面)。</p><figure class="lv lw lx ly gt lz"><div class="bz fp l di"><div class="mp mq l"/></div><figcaption class="mh mi gj gh gi mj mk bd b be z dk translated">刷新试玩感受我的痛苦~😫</figcaption></figure><h1 id="adef" class="km kn iq bd ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj bi translated">结论</h1><p id="b848" class="pw-post-body-paragraph jn jo iq jp b jq lk js jt ju ll jw jx jy lm ka kb kc ln ke kf kg lo ki kj kk ij bi translated">这就是我解决这个问题的方法。<br/>您可能没有导致这种情况的确切结构，但是现在您知道您需要检查另外一个地方。😄</p></div></div>    
</body>
</html>