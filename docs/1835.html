<html>
<head>
<title>Prometheus With Grafana Using Ansible</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">普罗米修斯与Grafana使用Ansible</h1>
<blockquote>原文：<a href="https://itnext.io/prometheus-with-grafana-using-ansible-549e575c9dfa?source=collection_archive---------4-----------------------#2019-02-08">https://itnext.io/prometheus-with-grafana-using-ansible-549e575c9dfa?source=collection_archive---------4-----------------------#2019-02-08</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/33516c5487fcb2ccddb3f20188c853ac.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*A19q2t1RBhOS3SfY"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">斯蒂芬·道森在<a class="ae kc" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</figcaption></figure><p id="1091" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">当一个强大的度量收集工具遇到一个令人敬畏的可视化工具时，就会释放出一个有效的监控系统的真正力量。<a class="ae kc" href="https://prometheus.io/" rel="noopener ugc nofollow" target="_blank"> Prometheus </a>是一个强大的指标收集和警报系统。Grafana 是最好的可视化工具之一，可以和Prometheus一起使用。我们可以在Grafana中创建一个包含多个图表的仪表板。Grafana已经与Prometheus进行了开箱即用的集成。我们只需要设置普罗米修斯作为数据源，我们就可以开始了。</p><p id="b1e3" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在本文中，我们将设置Grafana仪表板，它从Prometheus服务器获取数据。我们已经看到了如何设置给定链接可以引用的<a class="ae kc" rel="noopener ugc nofollow" target="_blank" href="/monitoring-with-prometheus-using-ansible-812bf710ef43"> Prometheus </a>和<a class="ae kc" rel="noopener ugc nofollow" target="_blank" href="/prometheus-with-alertmanager-f2a1f7efabd6"> AlertManager </a>。我们将看到Grafana设置Ansible和数据源设置，这样Grafana可以轻松地从Prometheus访问数据，我们可以在仪表板中使用这些数据。</p><p id="ce50" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">Grafana设置步骤如下:</p><ol class=""><li id="7380" class="lb lc iq kf b kg kh kk kl ko ld ks le kw lf la lg lh li lj bi translated">安装和配置Grafana</li><li id="405a" class="lb lc iq kf b kg lk kk ll ko lm ks ln kw lo la lg lh li lj bi translated">将Prometheus数据源添加到Grafana</li><li id="9993" class="lb lc iq kf b kg lk kk ll ko lm ks ln kw lo la lg lh li lj bi translated">从Prometheus metrics创建仪表板。</li></ol><p id="ce06" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">让我们使用Ansible设置Grafana。我们将使用ansible的yum模块，通过在<a class="ae kc" href="https://grafana.com/grafana/download" rel="noopener ugc nofollow" target="_blank"> Grafana网站</a>上找到的链接来安装Grafana。</p><pre class="lp lq lr ls gt lt lu lv lw aw lx bi"><span id="2cb0" class="ly lz iq lu b gy ma mb l mc md">- name: Install grafana<br/>  yum:<br/>    name: <a class="ae kc" href="https://s3-us-west-2.amazonaws.com/grafana-releases/release/grafana-{{" rel="noopener ugc nofollow" target="_blank">https://s3-us-west-2.amazonaws.com/grafana-releases/release/grafana-{{</a> version }}-1.x86_64.rpm<br/>    state: latest</span></pre><p id="ac7e" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">一旦Grafana安装完毕，我们将把Grafana配置文件复制到所需的目的地，并重启Grafana服务器。</p><pre class="lp lq lr ls gt lt lu lv lw aw lx bi"><span id="81fb" class="ly lz iq lu b gy ma mb l mc md">- name: "Grafana configuration file copy"<br/>  template:<br/>    src: "grafana.conf.j2"<br/>    dest: /etc/grafana/grafana.ini<br/>  notify: event_restart_grafana</span><span id="da60" class="ly lz iq lu b gy me mb l mc md">- name: "Grafana server started"<br/>  service:<br/>    name: grafana-server<br/>    enabled: true<br/>    state: started</span></pre><p id="b452" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">一切准备就绪后，我们验证Grafana在端口3000上是可访问的，端口3000是Grafana的默认端口。</p><pre class="lp lq lr ls gt lt lu lv lw aw lx bi"><span id="6bb7" class="ly lz iq lu b gy ma mb l mc md">- name: "Check if Grafana is accessible."<br/>  uri:<br/>    url: <a class="ae kc" href="http://127.0.0.1:3000" rel="noopener ugc nofollow" target="_blank">http://127.0.0.1:3000</a><br/>    method: GET<br/>    status_code: 200</span></pre><p id="5d1d" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">到目前为止，我们已经在我们的实例上安装并运行了Grafana，我们可以通过使用端口3000(默认端口)访问所需的IP来看到这一点。</p><p id="d262" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">使用以下步骤将数据源设置到Grafana上的Prometheus:</p><ol class=""><li id="bb5f" class="lb lc iq kf b kg kh kk kl ko ld ks le kw lf la lg lh li lj bi translated">转到<a class="ae kc" href="http://grafanaIp:3000" rel="noopener ugc nofollow" target="_blank"> http://grafanaIp:3000 </a></li></ol><figure class="lp lq lr ls gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mf"><img src="../Images/94ebe7920f8202c2cb2b42625140de37.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*LhCHJh5ZgzIAYQHG9kW24Q.png"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">Grafana登录屏幕</figcaption></figure><p id="2fe0" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">2.输入用户名“admin”和密码“admin”。单击登录。然后提供一个新密码，该密码将在以后的登录尝试中使用。</p><figure class="lp lq lr ls gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mg"><img src="../Images/34de486ecea56e09b7af1a6c38263ba3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*-xNA5Q12ttXhGlUwB4FzYQ.png"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">Grafana更新密码屏幕</figcaption></figure><p id="2e45" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">3.点击屏幕上的“数据源”。</p><figure class="lp lq lr ls gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mh"><img src="../Images/c12ed771d12f0bb3f9f2e6a7188a2860.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*3RB5uOdGAOLP6zadUIEe-g.png"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">Grafana数据源屏幕</figcaption></figure><p id="ec54" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">4.为我们的配置寻找Prometheus数据源。</p><figure class="lp lq lr ls gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mi"><img src="../Images/a43b727b95297baeb73f76d1b2ef137b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*rKzSyvgN4ktwbqPqnPjUBg.png"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">Grafana数据源选项屏幕</figcaption></figure><p id="f6db" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">5.单击Prometheus数据源并提供以下详细信息:</p><p id="3a13" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">名称:普罗米修斯<br/>URL:<a class="ae kc" href="http://prometheusIp:9090" rel="noopener ugc nofollow" target="_blank">http://普罗米修斯IP:9090</a>T3】基本验证:禁用，因为普罗米修斯服务器上当前已禁用</p><figure class="lp lq lr ls gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mi"><img src="../Images/f479350d3ef31421fb8dd5ff40ea2869.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*yGrfUPHftpuE0irAKvXu-w.png"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">Grafana Prometheus数据源屏幕</figcaption></figure><p id="89af" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">6.单击添加并测试连接，以验证一切正常工作。一旦完成，我们就有了一个可以使用的Prometheus数据源。</p><figure class="lp lq lr ls gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mj"><img src="../Images/424fac072fbaff08c260acbcd9883fbf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*E42IFsUAOtE_-KPx2kbBsw.png"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">Grafana数据源创建屏幕</figcaption></figure><p id="4af4" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">一旦我们完成了数据源的设置。接下来，我们需要使用Prometheus数据源设置我们的仪表板，这可以通过以下步骤完成:</p><ol class=""><li id="c0f5" class="lb lc iq kf b kg kh kk kl ko ld ks le kw lf la lg lh li lj bi translated">使用左上角的“+”转到仪表板选项</li></ol><figure class="lp lq lr ls gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mk"><img src="../Images/8fd7445a80c4ccb93fa83a9228b553ad.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*hw6GLiMrp1p6HWhiFNwThg.png"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">Grafana仪表板</figcaption></figure><p id="1440" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">2.通过单击“图表”选项，在这个新仪表板中添加图表</p><figure class="lp lq lr ls gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi ml"><img src="../Images/7157baace41293d0f8aa5dd7ec113743.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Flc1mQt_I8n42TCv_ilU6Q.png"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">Grafana仪表板屏幕</figcaption></figure><p id="d903" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">3.我们在仪表板中创建了一个需要查询和数据源的空图表。这可以通过点击“面板标题”并选择编辑选项来完成</p><figure class="lp lq lr ls gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi ml"><img src="../Images/5773da9e1c287a8afd363aeccfcadf2c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*moJwAaLOdj3v0LtKRHFrbw.png"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">Grafana图形创建屏幕</figcaption></figure><p id="3e1c" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">4.选择“普罗米修斯”作为数据源。转到查询选项，并在“查询”字段中添加输入PromQL查询“up{job='prometheus'} ”,这将绘制一个图形，显示prometheus服务器的“up”状态。我们可以根据自己的需要在这里添加任何查询。<a class="ae kc" href="https://prometheus.io/docs/prometheus/latest/querying/basics/" rel="noopener ugc nofollow" target="_blank"> PromQL </a>是Prometheus使用的一种查询语言。</p><figure class="lp lq lr ls gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mg"><img src="../Images/47f70942307d5ad17c0eb3680fd44b13.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*VzsweP6nufagcF9Qrw0fzA.png"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">Grafana图形选项屏幕</figcaption></figure><p id="7314" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">5.完成所有工作后，我们需要保存仪表板以备将来使用。这可以通过点击右上角的保存按钮并给我们的仪表板命名来完成。</p><figure class="lp lq lr ls gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mm"><img src="../Images/68d52db1c963d9855f677524a0e69468.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*wsTKNdk3hgmxR7Km_yQNBg.png"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">Grafana仪表板图形屏幕</figcaption></figure><figure class="lp lq lr ls gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mn"><img src="../Images/f79fbcf21e15ff2c338d63d3900031fa.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*QJeht781w-FGX_0gnqp00Q.png"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">Grafana保存仪表板屏幕</figcaption></figure><p id="5b79" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这样，我们实现了Grafana的设置，仪表板从Prometheus获取数据。</p><p id="a6af" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">完整的代码可以在这个git资源库中找到:<a class="ae kc" href="https://github.com/MiteshSharma/PrometheusWithGrafana" rel="noopener ugc nofollow" target="_blank">https://github.com/MiteshSharma/PrometheusWithGrafana</a></p><p id="f64e" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><strong class="kf ir"> <em class="mo"> PS:如果你喜欢这篇文章，请用掌声支持它</em> </strong>👏<strong class="kf ir"> <em class="mo">。欢呼</em> </strong></p></div></div>    
</body>
</html>