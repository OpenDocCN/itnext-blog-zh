# 洛基来救援了。

> 原文：<https://itnext.io/loki-to-the-rescue-7c3cc0989a7?source=collection_archive---------2----------------------->

![](img/25ad67bc8f388d55fd3af94866c6e8f8.png)

照片由[雅诺什·迪格尔曼](https://unsplash.com/@janoschphotos?utm_source=medium&utm_medium=referral)在 [Unsplash](https://unsplash.com?utm_source=medium&utm_medium=referral) 上拍摄

在 AWS 中用 Elasticsearch(技术上来说是 OpenSearch)玩了一周之后，我们终于有了它！再见橡皮筋！

简单介绍一下背景，目前我们将数据存储在 Elastic 中，用于长期存储和部分检索。有一个微服务将从 Elastic 提取数据供客户使用。我们可能没有像我们应该的那样使用 Elastic，或者没有以“正确”的方式配置它，但是它有点工作。上周我们遇到了一个缩放事件。这一事件促使我们决定如何纵向或横向扩展。我们决定再添加 2 个数据节点(从 2 个增加到 4 个)或增加节点的大小。我们选择了 2 个额外的数据节点，假设我们可以分散负载，AWS 将在 4 个节点之间重新平衡。我们知道的很少，没有那么多。经过相当长时间的希望，调整，摆弄不同的设置和毫无进展，我们不得不咬紧牙关，垂直增长。所以现在我们已经增加了大约 14k/月的账单，我们可以处理负载。这是不可持续的，每一次扩展活动都会成倍增加我们在 AWS 上的支出，而几乎没有回报。

# 输入 Grafana Loki

几个月来，我们一直在关注替代品，并测试了一些替代品。好家伙，我们爱上了格拉法纳洛基！

作为一个测试，我们决定通过 Grafana 头盔图把 Grafana，Prometheus 和 Loki 放入 kubernetes 星团，并尝试一下。Loki 有两种模式，单二进制或微服模式；我们选择了微服务模式的掌舵图，因为我们知道我们需要在哪里发展，我们绝对需要微服务模式。我们希望最终扩展到每天 180 多亿次活动。所以最好从正确的方向开始。

初始安装有每个 Loki 组件(网关、分配器、ingester、查询前端、查询者、压缩器)、Grafana 和 prometheus 的单个实例。

现在我们有了一个可操作的堆栈，是时候看看当我们向它扔数据时会发生什么了。这当然是令人兴奋的部分！Loki 不关心格式化、解析、索引什么的。这太棒了！！我们从每天大约 30GB 的数据开始，看看每个组件只使用一个会发生什么，让我们完全惊讶的是，什么都没有，Loki 只是查看日志，并在 Grafana 中向我们显示结果！

Loki 的一个奇怪之处是，你不索引数据，对于我们所有的数据库极客来说，它完全违背了我们所知道或信任的一切，但它是有效的。洛基在标签上工作，越少越好。最初的数据源之一是我们一个数据中心的 Fortinet 日志。我们用 fluentd 填充这些日志，并在此过程中添加了 1 个标签。在一天的日志(9.96 GB)中查询一个字符串在 9.4 秒内返回！为了与 Elastic 进行比较，相同的查询在 7.4 秒内返回，但是在磁盘上有索引，我们有 21GB 用于原始数据加上最小的索引。相比之下，我们有 9.98GB 的磁盘空间。

这一切都是通过开箱即用的配置完成的。关于 Loki 的一件事是，它确实有很多旋钮可以调节，文档也不完全清楚。然而，Grafana Slack 频道非常棒，如果您有任何问题，人们会很快做出回应。

# 我们现在去哪里？

现在，我们正在努力将数据双重输入到 Elastic 和 Loki 中，同时重构与 Elastic 对话的代码，以便将其转移到 Loki 中。一旦完成，我们将数据迁移到 Loki，我们将关闭我们的弹性实例，享受 AWS 的成本节约！

# 一个忙

如果你愿意的话，请花一分钟跟我来。我正试图通过新的媒体追随者的要求。