<html>
<head>
<title>How to record &amp; replay http traffic in Android and iOS apps</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何在Android和iOS应用中记录和回放http流量</h1>
<blockquote>原文：<a href="https://itnext.io/how-to-record-replay-http-traffic-in-android-and-ios-apps-db24a5dcc0e?source=collection_archive---------1-----------------------#2022-03-14">https://itnext.io/how-to-record-replay-http-traffic-in-android-and-ios-apps-db24a5dcc0e?source=collection_archive---------1-----------------------#2022-03-14</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="3080" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">从2022年开始，我加入了一家规模虽小但雄心勃勃的初创公司(<a class="ae kl" href="https://mobile.dev/" rel="noopener ugc nofollow" target="_blank"> mobile.dev </a>)，目标是为移动开发创造急需的基础设施。</p><p id="dd1b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们分析应用程序并运行性能基准来检测生产前的问题，在某些情况下，我们需要使用网络模拟进行仪器测试。</p><p id="2254" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我的第一个任务？弄清楚我们是否可以自己模拟网络，以便更容易地使用我们的产品。用模拟创建和维护插装测试从来都不容易——所以我们想在我们这边处理这个责任。</p><p id="722b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">今天我将分享我旅程的一小部分。特别是，如何:</p><ul class=""><li id="0ef0" class="km kn iq jp b jq jr ju jv jy ko kc kp kg kq kk kr ks kt ku bi translated">创建一个真实的模拟服务器，只需浏览一个应用程序。</li><li id="8626" class="km kn iq jp b jq kv ju kw jy kx kc ky kg kz kk kr ks kt ku bi translated">让应用程序与模拟服务器通信。</li><li id="7a52" class="km kn iq jp b jq kv ju kw jy kx kc ky kg kz kk kr ks kt ku bi translated">编辑我们喜欢的api响应</li></ul><p id="0bd7" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这对于创建理想的测试环境很有用，只需要很少甚至不需要手工操作。</p><h1 id="6468" class="la lb iq bd lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx bi translated">工作工具</h1><h2 id="4158" class="ly lb iq bd lc lz ma dn lg mb mc dp lk jy md me lo kc mf mg ls kg mh mi lw mj bi translated">SDK ❌</h2><p id="2ec3" class="pw-post-body-paragraph jn jo iq jp b jq mk js jt ju ml jw jx jy mm ka kb kc mn ke kf kg mo ki kj kk ij bi translated">在这个过程中有一些考虑因素。值得注意的是，我们考虑创建一个SDK来捕获应用程序的流量，将其存储在本地，然后再返回给用户——所有这些都是通过http拦截器完成的。</p><p id="46c6" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">赞成的意见</p><ul class=""><li id="1325" class="km kn iq jp b jq jr ju jv jy ko kc kp kg kq kk kr ks kt ku bi translated">一切都发生在应用程序内部。反应会非常快。</li><li id="8f13" class="km kn iq jp b jq kv ju kw jy kx kc ky kg kz kk kr ks kt ku bi translated">不需要额外的基础设施。</li><li id="e4a5" class="km kn iq jp b jq kv ju kw jy kx kc ky kg kz kk kr ks kt ku bi translated">易于扩展。</li></ul><p id="3010" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">骗局</p><ul class=""><li id="a704" class="km kn iq jp b jq jr ju jv jy ko kc kp kg kq kk kr ks kt ku bi translated">每个平台和框架需要维护多个SDK。</li><li id="7b87" class="km kn iq jp b jq kv ju kw jy kx kc ky kg kz kk kr ks kt ku bi translated">每个应用程序都需要SDK集成。</li><li id="76e8" class="km kn iq jp b jq kv ju kw jy kx kc ky kg kz kk kr ks kt ku bi translated">调试和修复问题变得更加困难，因为大量工作都是在客户端完成的。</li></ul><p id="beca" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这种方法虽然可行，但需要大量的资源来创建和维护。因此，我们很快放弃了这个想法，转而寻求更敏捷的解决方案。</p><h2 id="8d0a" class="ly lb iq bd lc lz ma dn lg mb mc dp lk jy md me lo kc mf mg ls kg mh mi lw mj bi translated">代理✅</h2><p id="7ed2" class="pw-post-body-paragraph jn jo iq jp b jq mk js jt ju ml jw jx jy mm ka kb kc mn ke kf kg mo ki kj kk ij bi translated">代理是监控和修改流量的最佳方式，我们的搜索导致了<a class="ae kl" href="https://mitmproxy.org/" rel="noopener ugc nofollow" target="_blank"> MITMProxy </a>。拦截和修改http流量的开源工具。</p><figure class="mq mr ms mt gt mu gh gi paragraph-image"><div role="button" tabindex="0" class="mv mw di mx bf my"><div class="gh gi mp"><img src="../Images/748756cba64523f3871a76e09d1684f3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*yDtdrUqilCbO7zBBYb6KxQ.jpeg"/></div></div></figure><p id="9b05" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">向Mitmproxy <a class="ae kl" href="https://github.com/mitmproxy/mitmproxy/graphs/contributors" rel="noopener ugc nofollow" target="_blank">的维护者</a>大喊一声，他们多年来已经构建了一个可靠的工具。如果你对它是如何工作的更感兴趣，你可以从这里开始<a class="ae kl" href="https://docs.mitmproxy.org/stable/concepts-howmitmproxyworks/" rel="noopener ugc nofollow" target="_blank"/>。</p><p id="da56" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">它是开源的，独立于平台，可以将http流量记录到一个文件中，并可以用作重播服务器。<strong class="jp ir">头奖！</strong></p><h1 id="8c21" class="la lb iq bd lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx bi translated">设置</h1><h2 id="ee6d" class="ly lb iq bd lc lz ma dn lg mb mc dp lk jy md me lo kc mf mg ls kg mh mi lw mj bi translated">代理人</h2><p id="18cb" class="pw-post-body-paragraph jn jo iq jp b jq mk js jt ju ml jw jx jy mm ka kb kc mn ke kf kg mo ki kj kk ij bi translated">在macOS上安装非常容易，每个平台都有<a class="ae kl" href="https://docs.mitmproxy.org/stable/overview-installation/" rel="noopener ugc nofollow" target="_blank">说明</a>。</p><pre class="mq mr ms mt gt nb nc nd ne aw nf bi"><span id="2fdc" class="ly lb iq nc b gy ng nh l ni nj"><strong class="nc ir">brew</strong> install mitmproxy</span></pre><p id="f992" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">Mitmproxy自带3个app:<a class="ae kl" href="https://docs.mitmproxy.org/stable/overview-getting-started/" rel="noopener ugc nofollow" target="_blank"><strong class="jp ir">mitm proxy</strong>、<strong class="jp ir"> mitmweb </strong>和<strong class="jp ir"> mitmdump </strong> </a>。我们将使用mitmweb进行演示。</p><p id="9ccb" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在让我们使用终端启动mitmproxy:</p><pre class="mq mr ms mt gt nb nc nd ne aw nf bi"><span id="52b6" class="ly lb iq nc b gy ng nh l ni nj"><strong class="nc ir">mitmweb</strong></span></pre><p id="2406" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这将:</p><ul class=""><li id="234a" class="km kn iq jp b jq jr ju jv jy ko kc kp kg kq kk kr ks kt ku bi translated">启动代理服务器<code class="fe nk nl nm nc b">127.0.0.1:8080</code></li><li id="4415" class="km kn iq jp b jq kv ju kw jy kx kc ky kg kz kk kr ks kt ku bi translated">在浏览器中启动网络界面<code class="fe nk nl nm nc b">127.0.0.1:8081</code></li></ul><figure class="mq mr ms mt gt mu gh gi paragraph-image"><div role="button" tabindex="0" class="mv mw di mx bf my"><div class="gh gi nn"><img src="../Images/e0c212dfcdf5e66995f48b5b19620e41.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*0Ayzy8Iy4jhduSjvwe1giQ.png"/></div></div><figcaption class="no np gj gh gi nq nr bd b be z dk translated">Mimproxy web控制台</figcaption></figure><h2 id="d244" class="ly lb iq bd lc lz ma dn lg mb mc dp lk jy md me lo kc mf mg ls kg mh mi lw mj bi translated">机器人</h2><p id="0f5a" class="pw-post-body-paragraph jn jo iq jp b jq mk js jt ju ml jw jx jy mm ka kb kc mn ke kf kg mo ki kj kk ij bi translated">对于Android，我将使用Android Studio附带的标准工具:</p><ul class=""><li id="426e" class="km kn iq jp b jq jr ju jv jy ko kc kp kg kq kk kr ks kt ku bi translated"><a class="ae kl" href="https://developer.android.com/studio/run/managing-avds" rel="noopener ugc nofollow" target="_blank">安卓虚拟设备(AVD) </a></li><li id="c27d" class="km kn iq jp b jq kv ju kw jy kx kc ky kg kz kk kr ks kt ku bi translated">安卓10.0(谷歌应用编程接口)</li></ul><p id="ff50" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">一旦设置了AVD，您必须安装CA证书，这将允许我们拦截<strong class="jp ir"> https </strong>流量。谢天谢地，已经有了详细的<a class="ae kl" href="https://docs.mitmproxy.org/stable/howto-install-system-trusted-ca-android/" rel="noopener ugc nofollow" target="_blank">指南</a>😊</p><p id="f6f3" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">最后，设置设备代理。使用AVD设置面板很容易做到:</p><figure class="mq mr ms mt gt mu gh gi paragraph-image"><div role="button" tabindex="0" class="mv mw di mx bf my"><div class="gh gi ns"><img src="../Images/6a9f0930bad4ad8ccc88963d12289bfe.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Oy1Zi3WF89obqsdmIdAyKg.png"/></div></div></figure><h2 id="67db" class="ly lb iq bd lc lz ma dn lg mb mc dp lk jy md me lo kc mf mg ls kg mh mi lw mj bi translated">ios</h2><p id="3f91" class="pw-post-body-paragraph jn jo iq jp b jq mk js jt ju ml jw jx jy mm ka kb kc mn ke kf kg mo ki kj kk ij bi translated">对于iOS，您有两个选项。</p><ul class=""><li id="0e5f" class="km kn iq jp b jq jr ju jv jy ko kc kp kg kq kk kr ks kt ku bi translated">您可以使用Xcode附带的iOS模拟器</li><li id="5d0f" class="km kn iq jp b jq kv ju kw jy kx kc ky kg kz kk kr ks kt ku bi translated">你可以用你的iPhone</li></ul><p id="7e62" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在iPhone上，证书安装、代理设置和访问应用程序的过程要简单一些，所以我走了这条路。</p><ul class=""><li id="3cf2" class="km kn iq jp b jq jr ju jv jy ko kc kp kg kq kk kr ks kt ku bi translated"><a class="ae kl" href="https://jasdev.me/intercepting-ios-traffic" rel="noopener ugc nofollow" target="_blank">安装证书并设置设备代理</a></li></ul><p id="496a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">注意</strong> : <em class="nt">代理启用时Appstore不会加载，所以一定要先下载app(见下文)。</em></p><p id="f96f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">应用程序</strong></p><p id="d833" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">最后但同样重要的是，我将使用一个我们都很熟悉的应用程序，<strong class="jp ir">维基百科！</strong></p><ul class=""><li id="4e77" class="km kn iq jp b jq jr ju jv jy ko kc kp kg kq kk kr ks kt ku bi translated">Android ( <a class="ae kl" href="https://github.com/wikimedia/apps-android-wikipedia" rel="noopener ugc nofollow" target="_blank">开源</a> ) ( <a class="ae kl" href="https://play.google.com/store/apps/details?id=org.wikipedia&amp;hl=en" rel="noopener ugc nofollow" target="_blank"> Playstore </a>)</li><li id="34c0" class="km kn iq jp b jq kv ju kw jy kx kc ky kg kz kk kr ks kt ku bi translated">iOS ( <a class="ae kl" href="https://github.com/wikimedia/wikipedia-ios" rel="noopener ugc nofollow" target="_blank">开源</a> ) ( <a class="ae kl" href="https://apps.apple.com/us/app/wikipedia/id324715238" rel="noopener ugc nofollow" target="_blank"> Appstore </a>)</li></ul><p id="0f42" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">对于<strong class="jp ir"> Android </strong>你可以抓取<a class="ae kl" href="https://www.apkmirror.com/apk/wikimedia-foundation/wikipedia/" rel="noopener ugc nofollow" target="_blank"> apk </a>并安装在AVD中。</p><p id="6f38" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">对于iOS系统，如果你使用模拟器，你必须从源代码开始构建。如果你用的是iphone，只需从Appstore下载应用程序。</p><p id="f391" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在有趣的部分开始了。🎉</p><h1 id="d1b5" class="la lb iq bd lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx bi translated">记录</h1><p id="0e45" class="pw-post-body-paragraph jn jo iq jp b jq mk js jt ju ml jw jx jy mm ka kb kc mn ke kf kg mo ki kj kk ij bi translated">在设置过程中，我们启动了代理，并将我们的设备连接到它。现在，我们要做的就是启动应用程序。</p><figure class="mq mr ms mt gt mu gh gi paragraph-image"><div role="button" tabindex="0" class="mv mw di mx bf my"><div class="gh gi nu"><img src="../Images/8d4801aac85f9d15a0f58b6835d9dbe4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*s2yoQgoOst9ULOrmLwXLAA.gif"/></div></div></figure><p id="8acf" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果一切设置正确，我们应该会看到应用程序发出的所有请求和响应。</p><p id="f2f9" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们还可以编辑回答。只需选择您想要编辑的通话，然后按下铅笔图标。</p><figure class="mq mr ms mt gt mu gh gi paragraph-image"><div role="button" tabindex="0" class="mv mw di mx bf my"><div class="gh gi nv"><img src="../Images/e2e47e21ea2b7b60919384388ec32e59.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*6KKMFleLCr1egmmk_ebgnA.png"/></div></div></figure><p id="d1cb" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我将编辑维基百科文章的显示标题，这样我们就可以知道重放正在工作:<strong class="jp ir"> <em class="nt">歌手大厦</em> </strong> <em class="nt"> </em>变成了<em class="nt"> </em> <strong class="jp ir"> <em class="nt">歌手大厦(Hello World) </em> </strong></p><figure class="mq mr ms mt gt mu gh gi paragraph-image"><div role="button" tabindex="0" class="mv mw di mx bf my"><div class="gh gi nw"><img src="../Images/447877e2a7a2255c1f725ae96dc150d0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*yrQrgX0Q1DO2rBOrPNjVUQ.png"/></div></div></figure><p id="c19b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">最后，我将把回放保存为<code class="fe nk nl nm nc b">app.replay</code></p><h1 id="af15" class="la lb iq bd lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx bi translated">重播</h1><p id="34bd" class="pw-post-body-paragraph jn jo iq jp b jq mk js jt ju ml jw jx jy mm ka kb kc mn ke kf kg mo ki kj kk ij bi translated">现在我们有了重放文件，我们可以停止正在运行的mitmweb <code class="fe nk nl nm nc b">ctl+C</code>实例，并以重放模式启动。</p><pre class="mq mr ms mt gt nb nc nd ne aw nf bi"><span id="5ae1" class="ly lb iq nc b gy ng nh l ni nj"><strong class="nc ir">mitmweb</strong> --server-replay app_edit.replay</span></pre><p id="d301" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这将使用<code class="fe nk nl nm nc b">app_edit.replay</code>在重放模式下启动mitmweb</p><p id="7d34" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">它的工作方式是，每次应用程序发出http请求时，mitmproxy都会尝试将请求与存储在重放文件中的请求进行匹配。</p><p id="f319" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果匹配，代理将用文件上的响应进行响应。</p><div class="mq mr ms mt gt ab cb"><figure class="nx mu ny nz oa ob oc paragraph-image"><div role="button" tabindex="0" class="mv mw di mx bf my"><img src="../Images/2b8679ea42a5eb745f41f436560c12be.png" data-original-src="https://miro.medium.com/v2/resize:fit:992/format:webp/1*7qR780TOQCcTmAmNOkJRHg.png"/></div></figure><figure class="nx mu od nz oa ob oc paragraph-image"><div role="button" tabindex="0" class="mv mw di mx bf my"><img src="../Images/dfb525b9b7dcded3ed8065d00366def1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1010/format:webp/1*JGintrGTryvACYeDAytEDA.png"/></div><figcaption class="no np gj gh gi nq nr bd b be z dk oe di of og translated">(左)普通http数据与(右)编辑重放</figcaption></figure></div><p id="324b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">就这样，我们做到了！我们能够记录应用程序的流量，编辑并回放。</p></div><div class="ab cl oh oi hu oj" role="separator"><span class="ok bw bk ol om on"/><span class="ok bw bk ol om on"/><span class="ok bw bk ol om"/></div><div class="ij ik il im in"><h1 id="8e20" class="la lb iq bd lc ld oo lf lg lh op lj lk ll oq ln lo lp or lr ls lt os lv lw lx bi translated">最后的想法</h1><p id="aaf7" class="pw-post-body-paragraph jn jo iq jp b jq mk js jt ju ml jw jx jy mm ka kb kc mn ke kf kg mo ki kj kk ij bi translated">这只是课程的介绍，还有更深层次的主题要探讨，例如:</p><ul class=""><li id="8cb3" class="km kn iq jp b jq jr ju jv jy ko kc kp kg kq kk kr ks kt ku bi translated">完全离线重放</li><li id="df31" class="km kn iq jp b jq kv ju kw jy kx kc ky kg kz kk kr ks kt ku bi translated">自定义重放逻辑</li><li id="9d18" class="km kn iq jp b jq kv ju kw jy kx kc ky kg kz kk kr ks kt ku bi translated">处理认证、过期会话、时间戳等..</li><li id="90e9" class="km kn iq jp b jq kv ju kw jy kx kc ky kg kz kk kr ks kt ku bi translated">完全自动化的过程，创建真实的模拟服务器的飞行。</li></ul><p id="be83" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果你想让我继续这个系列，请在评论中告诉我。</p></div></div>    
</body>
</html>