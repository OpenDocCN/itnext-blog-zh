<html>
<head>
<title>How does APP_INITIALIZER work? So what do you need to know about dynamic configuration in Angular?</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">APP_INITIALIZER是如何工作的？那么关于Angular中的动态配置需要了解什么呢？</h1>
<blockquote>原文：<a href="https://itnext.io/how-does-app-initializer-work-so-what-do-you-need-to-know-about-dynamic-configuration-in-angular-718e7c345971?source=collection_archive---------1-----------------------#2020-09-17">https://itnext.io/how-does-app-initializer-work-so-what-do-you-need-to-know-about-dynamic-configuration-in-angular-718e7c345971?source=collection_archive---------1-----------------------#2020-09-17</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="df6d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">当我们开发一个设计为在多种环境下运行的应用程序时，我们必须决定如何根据这些环境提供适当的变量配置</p></div><div class="ab cl kl km hu kn" role="separator"><span class="ko bw bk kp kq kr"/><span class="ko bw bk kp kq kr"/><span class="ko bw bk kp kq"/></div><div class="ij ik il im in"><h1 id="7bfc" class="ks kt iq bd ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp bi translated"><strong class="ak">TLDR；📕</strong></h1><ul class=""><li id="817c" class="lq lr iq jp b jq ls ju lt jy lu kc lv kg lw kk lx ly lz ma bi translated"><em class="mb"> environment.ts </em>不是提供环境配置的最佳方式</li><li id="78e7" class="lq lr iq jp b jq mc ju md jy me kc mf kg mg kk lx ly lz ma bi translated">不要在构建时引入环境配置</li><li id="d012" class="lq lr iq jp b jq mc ju md jy me kc mf kg mg kk lx ly lz ma bi translated">名为<em class="mb"> APP_INITIALIZER </em>的特殊注入令牌用于提供方便有效的外部配置</li><li id="6050" class="lq lr iq jp b jq mc ju md jy me kc mf kg mg kk lx ly lz ma bi translated">我已经为你准备了一个最小的例子，通过使用<em class="mb"> APP_INITIALIZER </em>来解决这个问题。你可以在<a class="ae mh" href="https://stackblitz.com/edit/angular-configuration-with-app-initializer" rel="noopener ugc nofollow" target="_blank"><strong class="jp ir"><em class="mb">stack blitz</em></strong></a>上找到</li></ul></div><div class="ab cl kl km hu kn" role="separator"><span class="ko bw bk kp kq kr"/><span class="ko bw bk kp kq kr"/><span class="ko bw bk kp kq"/></div><div class="ij ik il im in"><h1 id="0cdf" class="ks kt iq bd ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp bi translated">第一轮❓</h1><p id="04d8" class="pw-post-body-paragraph jn jo iq jp b jq ls js jt ju lt jw jx jy mi ka kb kc mj ke kf kg mk ki kj kk ij bi translated">环境变量最简单的例子是API配置。通常，我们根据目标环境使用不同的URL。例如:</p><ul class=""><li id="f214" class="lq lr iq jp b jq jr ju jv jy ml kc mm kg mn kk lx ly lz ma bi translated">戴夫:https://yourdomain.dev.org/api/resources</li><li id="47d4" class="lq lr iq jp b jq mc ju md jy me kc mf kg mg kk lx ly lz ma bi translated">测试:https://yourdomain.test.org/api/resources</li><li id="4ee3" class="lq lr iq jp b jq mc ju md jy me kc mf kg mg kk lx ly lz ma bi translated">制片人:https://yourdomain.prod.org/api/resources</li></ul><p id="3488" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在我看到的很多Angular项目中，都是利用Angular框架提供的类比文件来解决这个问题:<em class="mb"> environment.dev.ts </em>、<em class="mb"> environment.test.ts </em>和<em class="mb"> environment.prod.ts </em>。</p><p id="4885" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们示例中的这些文件如下所示</p><figure class="mo mp mq mr gt ms"><div class="bz fp l di"><div class="mt mu l"/></div></figure><p id="01e5" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">不能说这种方法很糟糕或者不符合所做的假设。但是，看看如果您选择这种方式来保留您的变量并希望完成应用程序交付到生产的整个周期会发生什么。</p><ol class=""><li id="4f6d" class="lq lr iq jp b jq jr ju jv jy ml kc mm kg mn kk mv ly lz ma bi translated">如果本地一切正常，应用程序将使用environment.dev.ts文件在开发环境中构建</li><li id="968e" class="lq lr iq jp b jq mc ju md jy me kc mf kg mg kk mv ly lz ma bi translated">如果在开发环境中一切正常，我们可以将其提升到测试环境中。为了让应用程序在测试环境中运行，这次必须使用environment.test.ts文件重新构建应用程序</li><li id="2cc0" class="lq lr iq jp b jq mc ju md jy me kc mf kg mg kk mv ly lz ma bi translated">如果应用程序已经在测试环境中测试过，并且已经准备好生产，我们必须采取相同的步骤。因此，我们需要使用environment.prod.ts重新构建应用程序</li></ol><p id="942a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">请注意一个事实。应用程序必须构建三次(<strong class="jp ir">！！！</strong>)在它从开发者手中到生产环境之前。</p><h2 id="511f" class="mw kt iq bd ku mx my dn ky mz na dp lc jy nb nc lg kc nd ne lk kg nf ng lo nh bi translated">首先得出的结论是:👈</h2><ul class=""><li id="9575" class="lq lr iq jp b jq ls ju lt jy lu kc lv kg lw kk lx ly lz ma bi translated">如果您想要交付一个小的变更到产品中，您必须重复相同的构建过程几次，这将显著地延长交付时间。</li><li id="7b0e" class="lq lr iq jp b jq mc ju md jy me kc mf kg mg kk lx ly lz ma bi translated">您永远不能确定来自开发环境或测试的测试工件将在生产环境中正确构建</li></ul><p id="502b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">基于这些结论和我自己的经验，我可以安全而诚实地告诉您，environment.ts文件并不适合保存大多数类型的配置。更准确地说:</p><p id="335f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">某些配置类型不应该在构建工件时发布。在Angular的environment.ts中存储环境相关变量是反模式。不幸的是，常见的反模式。</p><p id="6de7" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">因此，如果您选择不在environment.ts中保存您的配置，您能做什么呢？</p></div><div class="ab cl kl km hu kn" role="separator"><span class="ko bw bk kp kq kr"/><span class="ko bw bk kp kq kr"/><span class="ko bw bk kp kq"/></div><div class="ij ik il im in"><h1 id="e5bb" class="ks kt iq bd ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp bi translated">第2轮— APP_INITIALIZER方法💪</h1><p id="eacc" class="pw-post-body-paragraph jn jo iq jp b jq ls js jt ju lt jw jx jy mi ka kb kc mj ke kf kg mk ki kj kk ij bi translated">Angular的注入令牌APP_INITIALIZER提供了很大的帮助，有了它，您可以向应用程序引入额外的初始化函数。Angular框架的这一功能确保了当应用程序启动时所提供的功能被执行，而应用程序仍在被初始化。这些函数返回一个Promise对象，Angular的应用在执行之前不会被初始化。</p><p id="1f2d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这是传递配置的正确方式吗？</p><h2 id="431b" class="mw kt iq bd ku mx my dn ky mz na dp lc jy nb nc lg kc nd ne lk kg nf ng lo nh bi translated">当然啦！即使在官方的Angular框架文档中，您也可以看到:📕</h2><blockquote class="ni nj nk"><p id="d4d6" class="jn jo mb jp b jq jr js jt ju jv jw jx nl jz ka kb nm kd ke kf nn kh ki kj kk ij bi translated">例如，您可以创建一个加载语言数据或外部配置的工厂函数，并将该函数提供给<a class="ae mh" href="https://angular.io/api/core/APP_INITIALIZER" rel="noopener ugc nofollow" target="_blank"> APP_INITIALIZER </a>令牌。这样，该函数在应用程序引导过程中执行，所需的数据在启动时可用。</p></blockquote></div><div class="ab cl kl km hu kn" role="separator"><span class="ko bw bk kp kq kr"/><span class="ko bw bk kp kq kr"/><span class="ko bw bk kp kq"/></div><div class="ij ik il im in"><blockquote class="ni nj nk"><p id="2ea0" class="jn jo mb jp b jq jr js jt ju jv jw jx nl jz ka kb nm kd ke kf nn kh ki kj kk ij bi translated"><a class="ae mh" href="https://twitter.com/marcin_milewicz" rel="noopener ugc nofollow" target="_blank">如果你想了解新的伟大的棱角和前端的东西，请在Twitter上关注我</a>！<em class="iq">😄</em></p></blockquote></div><div class="ab cl kl km hu kn" role="separator"><span class="ko bw bk kp kq kr"/><span class="ko bw bk kp kq kr"/><span class="ko bw bk kp kq"/></div><div class="ij ik il im in"><h2 id="5bb2" class="mw kt iq bd ku mx my dn ky mz na dp lc jy nb nc lg kc nd ne lk kg nf ng lo nh bi translated">实际运行时配置</h2><p id="a592" class="pw-post-body-paragraph jn jo iq jp b jq ls js jt ju lt jw jx jy mi ka kb kc mj ke kf kg mk ki kj kk ij bi translated">首先，我们需要一个文件来保存配置细节，它不会是执行<em class="mb"> ng build </em>时构建的JavaScript工件的一部分。这个配置文件应该在应用程序初始化时按需下载。</p><figure class="mo mp mq mr gt ms"><div class="bz fp l di"><div class="mt mu l"/></div></figure><p id="ca6c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">对于以下假设的配置模型。</p><figure class="mo mp mq mr gt ms"><div class="bz fp l di"><div class="mt mu l"/></div></figure><p id="fe32" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们还需要一个负责下载配置并在应用程序运行时使其可用的服务。</p><figure class="mo mp mq mr gt ms"><div class="bz fp l di"><div class="mt mu l"/></div></figure><p id="2851" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">最后一步是使用带有<em class="mb"> APP_INITIALIZER </em>标记的上述方法。它用于特定<em class="mb"> NgModule </em>的providers部分。</p><p id="9de9" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">值得考虑创建一个专门用于获取配置的独立模块，而不是将以下代码添加到主app.module.ts中</p><figure class="mo mp mq mr gt ms"><div class="bz fp l di"><div class="mt mu l"/></div></figure><p id="2ca8" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><em class="mb">加载配置</em>功能带有<em class="mb">使用工厂</em>参数。函数本身看起来像这样</p><figure class="mo mp mq mr gt ms"><div class="bz fp l di"><div class="mt mu l"/></div></figure><p id="9c94" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">通过遵循上述步骤，我们可以确保我们的应用程序具有以下行为</p><ul class=""><li id="fb3f" class="lq lr iq jp b jq jr ju jv jy ml kc mm kg mn kk lx ly lz ma bi translated">当应用程序启动时，来自<em class="mb"> ConfigurationLoader </em>实例的<em class="mb"> loadConfiguration </em>运行，并开始从<em class="mb">/assets/config/configuration . JSON</em>下载配置</li><li id="47b6" class="lq lr iq jp b jq mc ju md jy me kc mf kg mg kk lx ly lz ma bi translated">应用程序会一直等待，直到从<em class="mb">/assets/config/configuration . JSON</em>加载配置</li><li id="497f" class="lq lr iq jp b jq mc ju md jy me kc mf kg mg kk lx ly lz ma bi translated">最后，通过<em class="mb"> ConfigurationLoader </em>实例的<em class="mb"> getConfiguration </em>方法，应用被初始化并且配置可用</li></ul><p id="0d5d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">神奇的是，放置在<em class="mb"> assets </em>目录中的配置在构建时没有被考虑。您可以随时修改<em class="mb">资产</em>目录的内容，而无需重新构建应用程序。因此，将应用程序交付到生产环境的方案现在看起来是这样的</p><ol class=""><li id="4285" class="lq lr iq jp b jq jr ju jv jy ml kc mm kg mn kk mv ly lz ma bi translated">如果本地一切正常，应用程序将构建在开发环境上，并且<em class="mb">/assets/config/configuration . JSON</em>文件将从外部交付</li><li id="0422" class="lq lr iq jp b jq mc ju md jy me kc mf kg mg kk mv ly lz ma bi translated">如果在开发环境中一切正常，应用程序就被提升到测试环境。为了在测试环境中运行应用程序，我们使用已经构建好的工件并替换掉<em class="mb">/assets/config/configuration . JSON</em>文件，这次它包含了特定于测试环境的配置</li><li id="3a0b" class="lq lr iq jp b jq mc ju md jy me kc mf kg mg kk mv ly lz ma bi translated">如果应用程序通过了测试环境中的测试，并准备进入生产环境，我们再次获取相同的工件，将其推送到生产环境，并为生产环境替换类似的配置文件<em class="mb">/assets/config/configuration . JSON</em>。</li></ol></div><div class="ab cl kl km hu kn" role="separator"><span class="ko bw bk kp kq kr"/><span class="ko bw bk kp kq kr"/><span class="ko bw bk kp kq"/></div><div class="ij ik il im in"><p id="32f1" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">哇！通过使用<em class="mb"> APP_INITIALIZER </em>和运行时配置方法，您能够在整个交付周期中将构建应用程序的过程限制为仅一次！坦率地说，根据最佳实践，这一次是最大次数。您还确保了您在初始环境中构建的工件与在最终环境中放置的工件是一个字节。</p></div><div class="ab cl kl km hu kn" role="separator"><span class="ko bw bk kp kq kr"/><span class="ko bw bk kp kq kr"/><span class="ko bw bk kp kq"/></div><div class="ij ik il im in"><p id="4de6" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果你想看看这个解决方案是如何工作的，我为你准备了一个关于<a class="ae mh" href="https://stackblitz.com/edit/angular-configuration-with-app-initializer" rel="noopener ugc nofollow" target="_blank"><strong class="jp ir"><em class="mb">stack blitz</em></strong></a>的实例。</p><figure class="mo mp mq mr gt ms gh gi paragraph-image"><div role="button" tabindex="0" class="np nq di nr bf ns"><div class="gh gi no"><img src="../Images/11bb06e170536b76359bff8fb8d6bf71.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*3XUVentW0YdEgmpTcEL7Fw.png"/></div></div></figure><h1 id="7154" class="ks kt iq bd ku kv nv kx ky kz nw lb lc ld nx lf lg lh ny lj lk ll nz ln lo lp bi translated">摘要📕</h1><ul class=""><li id="53c9" class="lq lr iq jp b jq ls ju lt jy lu kc lv kg lw kk lx ly lz ma bi translated"><em class="mb">环境. ts </em>是<strong class="jp ir">不是</strong>在角生态系统中提供环境配置的最佳方式。我们可以放心地将其命名为反模式。</li><li id="95f9" class="lq lr iq jp b jq mc ju md jy me kc mf kg mg kk lx ly lz ma bi translated">不要引入依赖于运行时的环境配置</li><li id="8d6f" class="lq lr iq jp b jq mc ju md jy me kc mf kg mg kk lx ly lz ma bi translated">注入令牌——APP _ INITIALIZER用于<strong class="jp ir">方便有效的</strong>外部配置在Angular生态系统中的交付。</li><li id="6a83" class="lq lr iq jp b jq mc ju md jy me kc mf kg mg kk lx ly lz ma bi translated">我已经为你准备了一个使用<strong class="jp ir"> APP_INITIALIZER </strong>解决问题的最小示例。你会在<a class="ae mh" href="https://stackblitz.com/edit/angular-configuration-with-app-initializer" rel="noopener ugc nofollow" target="_blank"><strong class="jp ir"><em class="mb">stack blitz</em></strong></a>上找到他</li></ul><h2 id="329d" class="mw kt iq bd ku mx my dn ky mz na dp lc jy nb nc lg kc nd ne lk kg nf ng lo nh bi translated">反馈很重要，在medium.com最好的方法是多次点击拍手图标👏在你的左边。如果你点击它，我会知道我的文章对你有价值，❤️，我会被鼓励写更多📙。谢谢！</h2></div><div class="ab cl kl km hu kn" role="separator"><span class="ko bw bk kp kq kr"/><span class="ko bw bk kp kq kr"/><span class="ko bw bk kp kq"/></div><div class="ij ik il im in"><blockquote class="ni nj nk"><p id="181d" class="jn jo mb jp b jq jr js jt ju jv jw jx nl jz ka kb nm kd ke kf nn kh ki kj kk ij bi translated">如果你想了解新的伟大的角度和前沿的东西，请在Twitter上关注我。<em class="iq">😄</em></p></blockquote></div></div>    
</body>
</html>