<html>
<head>
<title>Kubernetes Compliance with Open Policy Agent</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Kubernetes遵从开放策略代理</h1>
<blockquote>原文：<a href="https://itnext.io/kubernetes-compliance-with-open-policy-agent-3d282179b1e9?source=collection_archive---------2-----------------------#2018-11-18">https://itnext.io/kubernetes-compliance-with-open-policy-agent-3d282179b1e9?source=collection_archive---------2-----------------------#2018-11-18</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/446a4a65dff04bbf575ceefe4451f49c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*Fu6vDwGg8SnF4fef"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">西奥·托马迪斯在<a class="ae kc" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</figcaption></figure><p id="3607" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在一家对云基础架构实施合规性控制的企业中，EKS提出了一个有趣的挑战。</p><p id="4fe9" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">考虑一个组织政策，该政策禁止开发人员将开发环境中的服务暴露给公共互联网。在Fargate或ECS环境中，可以在云形成审查阶段强制执行该策略。但是，EKS集群的默认配置允许开发人员定义入口或服务，从而创建弹性负载平衡器。审查云形成模板不再足以确保全面的基础设施控制和可见性。</p><figure class="lc ld le lf gt jr gh gi paragraph-image"><div class="gh gi lb"><img src="../Images/52c99b2ca316c95491b39087fe24aafe.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*0sJEtMNFx0NYNbbenh_caw.jpeg"/></div></figure><p id="c298" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">为了保持所需的控制级别，有必要在堆栈中向下移动一层，并在Kubernetes级别强制执行。</p><p id="1138" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">要在EKS集群中解决这个问题，您有几个选择，取决于您对“解决”的定义:<br/> -手动检查部署到集群的所有对象，以确保它们符合标准<br/> -使用Kubernetes <a class="ae kc" href="https://kubernetes.io/docs/reference/access-authn-authz/admission-controllers/" rel="noopener ugc nofollow" target="_blank">准入控制器</a>在集群级别强制执行该策略<br/> -取消EKS通过IAM创建和管理elb的能力</p><p id="c408" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">第一个选项提供了一些保护，应该合并到代码审查过程中，但是引入了错误的空间，并且不能很好地伸缩。</p><p id="f925" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">第二种选择最终更加安全，因为它确保即使有人绕过CICD管道，策略也能得到执行。这允许开发人员获得他们可以访问的沙箱集群，同时仍然确信他们的集群配置阻止他们向公共互联网公开服务。</p><p id="237d" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">第三种选择是大锤方法，但在某些情况下可能是合适的——如果你永远不希望EKS创造一个ELB，为什么不完全取消许可呢？</p><p id="e6df" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我的目标是研究第二个选项，并使用准入控制器来实现以下场景:</p><ul class=""><li id="569f" class="lg lh iq kf b kg kh kk kl ko li ks lj kw lk la ll lm ln lo bi translated">服务无法创建负载平衡器</li><li id="c52a" class="lg lh iq kf b kg lp kk lq ko lr ks ls kw lt la ll lm ln lo bi translated">如果服务拥有所需的静态注释，它们可以创建负载平衡器</li><li id="da63" class="lg lh iq kf b kg lp kk lq ko lr ks ls kw lt la ll lm ln lo bi translated">如果服务拥有目标名称空间所需的注释，它们就可以创建负载平衡器</li></ul><h1 id="03a1" class="lu lv iq bd lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp mq mr bi translated">开放策略代理</h1><p id="3b75" class="pw-post-body-paragraph kd ke iq kf b kg ms ki kj kk mt km kn ko mu kq kr ks mv ku kv kw mw ky kz la ij bi translated"><a class="ae kc" href="https://www.openpolicyagent.org" rel="noopener ugc nofollow" target="_blank">开放策略代理</a>是一个通用策略引擎，可用于在一系列应用中实施策略。它充当一个策略中间件应用程序——策略在OPA中定义，应用程序查询OPA以做出决策。它本质上提供了策略即服务，并将策略从应用程序配置中分离出来。</p><p id="071f" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">OPA文档包含一个验证准入控制器的<a class="ae kc" href="https://www.openpolicyagent.org/docs/kubernetes-admission-control.html" rel="noopener ugc nofollow" target="_blank">示例，它在创建、删除或更新Kubernetes对象之前强制执行它们的语义验证。</a></p><p id="2148" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">准入控制器在请求被认证之后但在对象被持久存储到存储器之前被执行。对请求进行身份验证后，Kubernetes向OPA发送一个webhook。webhook响应控制是否允许请求继续。</p><figure class="lc ld le lf gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mx"><img src="../Images/dc10c51b468c7be56d5de36948b0a4d8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*0C4pDnPiOL1zmupe12PZ_Q.png"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">来源:坂仔云</figcaption></figure><p id="0faa" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">关于准入控制器架构和工作流程的更多细节，请参见<a class="ae kc" href="https://banzaicloud.com/blog/k8s-admission-webhooks/" rel="noopener ugc nofollow" target="_blank">这篇博文</a>。</p><h1 id="d9b2" class="lu lv iq bd lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp mq mr bi translated">安装OPA</h1><p id="6147" class="pw-post-body-paragraph kd ke iq kf b kg ms ki kj kk mt km kn ko mu kq kr ks mv ku kv kw mw ky kz la ij bi translated">我首先根据<a class="ae kc" href="https://www.openpolicyagent.org/docs/kubernetes-admission-control.html" rel="noopener ugc nofollow" target="_blank">文档</a>安装和配置OPA。</p><p id="3ba8" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在minikube或Docker for Mac中运行本地Kubernetes集群时，一切都是现成的。如果在AWS EKS中运行，请确保允许集群控制平面安全组访问端口443上的worker节点安全组，否则Kubernetes主服务器将无法向OPA发送webhook，并且所有kubectl命令都将超时。</p><p id="5652" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">策略是用<a class="ae kc" href="https://www.openpolicyagent.org/docs/language-reference.html" rel="noopener ugc nofollow" target="_blank">减压阀语言</a>编写的，乍一看有些不直观，策略存储在“opa”名称空间的ConfigMaps中。OPA将自动加载该名称空间中的任何配置映射。</p><h2 id="a0fe" class="my lv iq bd lw mz na dn ma nb nc dp me ko nd ne mi ks nf ng mm kw nh ni mq nj bi translated">阻止所有负载平衡器服务</h2><p id="81e1" class="pw-post-body-paragraph kd ke iq kf b kg ms ki kj kk mt km kn ko mu kq kr ks mv ku kv kw mw ky kz la ij bi translated">在示例中，OPA被配置为“默认允许”模式——除了那些被明确拒绝的请求之外，所有请求都被允许。策略文档将由对于不符合的资源评估为真的规则组成。</p><p id="ee67" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">第一条规则应该阻止创建任何LoadBalancer类型的服务。这在减压阀可以写成:</p><figure class="lc ld le lf gt jr"><div class="bz fp l di"><div class="nk nl l"/></div></figure><p id="9687" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在英语中，这条规则说:</p><ul class=""><li id="7675" class="lg lh iq kf b kg kh kk kl ko li ks lj kw lk la ll lm ln lo bi translated">如果正在创建的对象类型是服务，并且</li><li id="4f04" class="lg lh iq kf b kg lp kk lq ko lr ks ls kw lt la ll lm ln lo bi translated">如果请求操作是创建，并且</li><li id="d7f8" class="lg lh iq kf b kg lp kk lq ko lr ks ls kw lt la ll lm ln lo bi translated">如果服务类型是负载平衡器，则</li><li id="1fce" class="lg lh iq kf b kg lp kk lq ko lr ks ls kw lt la ll lm ln lo bi translated">拒绝请求。</li></ul><p id="c009" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我创建了一个示例服务来测试该策略:</p><figure class="lc ld le lf gt jr"><div class="bz fp l di"><div class="nk nl l"/></div></figure><p id="8d58" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">尝试创建此服务导致错误“不允许负载平衡器服务”。</p><h2 id="c1b7" class="my lv iq bd lw mz na dn ma nb nc dp me ko nd ne mi ks nf ng mm kw nh ni mq nj bi translated">实施注释策略</h2><p id="e9bb" class="pw-post-body-paragraph kd ke iq kf b kg ms ki kj kk mt km kn ko mu kq kr ks mv ku kv kw mw ky kz la ij bi translated">全局禁用负载平衡器是一个非常棘手的解决方案。如果我们希望允许负载平衡器，但前提是它们符合某些要求，那该怎么办？</p><p id="8522" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">Kubernetes使用服务注释来配置负载平衡器。在AWS中，这些可以用来配置安全组、SSL证书和访问日志记录。例如，可以通过用<em class="nm">serviceβkubernetes . io/AWS-load-balancer-SSL-cert = arn:AWS:ACM:…</em>注释服务来将SSL证书添加到ELB。</p><p id="d80f" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">考虑到这一点，我们可以定义一个允许负载平衡器的策略，但前提是它们使用已知的安全组。在本例中，我们将确保负载平衡器使用安全组sg-123。</p><p id="0454" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这在减压阀表现为:</p><figure class="lc ld le lf gt jr"><div class="bz fp l di"><div class="nk nl l"/></div></figure><p id="7b87" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我创建了一个示例服务，它缺少安全组注释:</p><figure class="lc ld le lf gt jr"><div class="bz fp l di"><div class="nk nl l"/></div></figure><p id="c6b1" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">尝试创建此服务失败，出现“负载平衡器类型的服务必须使用安全组sg-123”。添加缺少的注释后，服务创建成功。</p><h2 id="e26b" class="my lv iq bd lw mz na dn ma nb nc dp me ko nd ne mi ks nf ng mm kw nh ni mq nj bi translated">动态注释</h2><p id="0594" class="pw-post-body-paragraph kd ke iq kf b kg ms ki kj kk mt km kn ko mu kq kr ks mv ku kv kw mw ky kz la ij bi translated">前面的例子引入了对资源创建更细粒度的控制，但是对资源(如安全组)的硬编码引用不是一个可伸缩的解决方案。此外，所需的安全组可能会因集群环境而异。高级策略可能会说“开发环境只能暴露于公司IP范围”。以可伸缩的方式实现这一点需要可以利用动态数据的策略——在这种情况下，为特定的名称空间查找允许的安全组。</p><p id="1b32" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">幸运的是，OPA可以使用各种来源的数据，并将其纳入政策制定决策中。</p><p id="60fa" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在教程中，OPA以标记“—replicate-cluster = v1/namespaces”开始。这导致OPA不断复制Kubernetes名称空间状态，使得名称空间及其元数据在策略评估期间可用。</p><p id="ce8b" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们可以在名称空间的注释中存储任意数据。我们将使用它来存储对名称空间中允许的安全组的引用。只有当服务引用目标名称空间的正确安全组时，才允许服务。</p><p id="632f" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我创建了两个名称空间，配置如下:</p><figure class="lc ld le lf gt jr"><div class="bz fp l di"><div class="nk nl l"/></div></figure><p id="0455" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">然后，我创建了以下策略:</p><figure class="lc ld le lf gt jr"><div class="bz fp l di"><div class="nk nl l"/></div></figure><p id="8146" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">该规则将服务规范中给定的安全组与目标名称空间允许的安全组进行比较。例如，如果dev名称空间中的服务引用prod名称空间中使用的安全组，则请求被拒绝。</p><p id="b894" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">为了验证这一点，我创建了一个负载平衡服务，它使用dev名称空间的安全组:</p><figure class="lc ld le lf gt jr"><div class="bz fp l di"><div class="nk nl l"/></div></figure><p id="0465" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我在dev名称空间中创建了这个服务，没有任何错误。尝试在prod命名空间中创建相同的服务时，如预期的那样失败:</p><figure class="lc ld le lf gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nn"><img src="../Images/1a92171a3bf9d7a65c74cc4263bcfe93.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*o4osrDVF5e8pyQDaHZBpgg.png"/></div></div></figure><p id="1996" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">成功！任何将不合规的基础架构部署到群集的尝试都将失败，部署日志将解释失败的原因。</p><h1 id="3996" class="lu lv iq bd lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp mq mr bi translated">结论</h1><p id="aa13" class="pw-post-body-paragraph kd ke iq kf b kg ms ki kj kk mt km kn ko mu kq kr ks mv ku kv kw mw ky kz la ij bi translated">Kubernetes提供了在集群级别实施策略所需的原语，但是它们需要一些配置和管理。正如Kelsey Hightower所说，Kubernetes是一个搭建平台的平台。<br/> <br/> OPA有一个陡峭的学习曲线，但它提供了大量的能力和灵活性作为回报。拥有一个通用的决策即服务工具引入了一系列有趣的可能性。</p><p id="79ac" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">到目前为止，所有的例子都是在Kubernetes许可控制周期的上下文中——YAML资源定义在创建之前就被验证了。如果开发人员试图部署不兼容的基础架构，他们只会在部署失败时才发现。在构建和发布周期的早期让开发人员注意到这个问题会更有效，这样可以避免由于遵从性错误导致的<a class="ae kc" href="https://www.gocd.org/2018/01/31/continuous-delivery-metrics/" rel="noopener ugc nofollow" target="_blank">周期时间</a>的增加。</p><p id="f712" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在技术层面上，Kubernetes准入控制者只是将YAML定义交给OPA，并请求批准继续。OPA根据定义的策略验证YAML并做出决定。</p><p id="e16c" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">因为验证过程与准入控制无关，所以YAML文件可以作为用于交付Kubernetes资源的CICD过程的一部分提交给OPA。</p><p id="c899" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这意味着同一策略规则集可以在管道中的多个阶段进行验证和实施。在CICD过程中，OPA充当质量检查的角色，尽早通知开发人员他们的更改将不被允许。在Kubernetes准入控制流程中，OPA充当了一个强制工具，防止创建不兼容的基础设施。</p><p id="4ed6" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">将遵从性视为代码意味着采用软件开发过程中的最佳实践。其中之一就是不要重复自己。将策略从应用程序中分离出来，并在多个位置重用策略定义，是这个规则的一个很好的实现。</p><p id="655b" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">云原生合规性监控三巨头的最后一个组成部分是与CloudTrail等服务集成，以便在检测到不合规的基础架构时提供实时警报。然后，可以使用一个策略规则集来实现三个目标:</p><p id="11bc" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">1)预发布:CICD流程可防止开发人员交付不合规的基础架构<br/> 2)预部署:Kubernetes可防止部署不合规的基础架构<br/> 3)部署后:CloudTrail可提供审核跟踪，证明所有基础架构在创建时都是合规的，并可识别任何因政策变更而变得不合规的基础架构</p><p id="0bf5" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">第一个使部署兼容的基础设施变得容易。<br/>第二个原因是无法部署不合规的基础设施。<br/>第三个证明另外两个有效。</p><p id="72ac" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">总之，OPA是一个有趣且灵活的工具，其操作模型非常适合云原生环境。Kubernetes准入控制器代表了在集群中实施策略的理想接口。</p></div></div>    
</body>
</html>