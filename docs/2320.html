<html>
<head>
<title>Istio adventures — disabling mTLS for one namespace</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Istio adventures —禁用一个命名空间的mTLS</h1>
<blockquote>原文：<a href="https://itnext.io/istio-adventures-disabling-mtls-for-one-namespace-62f37b99855c?source=collection_archive---------3-----------------------#2019-05-06">https://itnext.io/istio-adventures-disabling-mtls-for-one-namespace-62f37b99855c?source=collection_archive---------3-----------------------#2019-05-06</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="c535" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">假设您有一个Istio安装，其中为整个集群启用了mTLS。你应该有这样的东西:</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi kl"><img src="../Images/eddeb946327351083d9ea9dbc19822e2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*yaicW6DArarzTTwtX3Zwog.png"/></div></div><figcaption class="kx ky gj gh gi kz la bd b be z dk translated">Kiali展示了一些mTLS提示——图边和报头中的锁。</figcaption></figure><p id="8beb" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在配置方面，你应该有以下几件:</p><ol class=""><li id="d447" class="lb lc iq jp b jq jr ju jv jy ld kc le kg lf kk lg lh li lj bi translated">一个MeshPolicy使服务能够以<em class="lk"> mTLS </em>模式接收连接。</li></ol><pre class="km kn ko kp gt ll lm ln lo aw lp bi"><span id="cc3d" class="lq lr iq lm b gy ls lt l lu lv">apiVersion: “authentication.istio.io/v1alpha1”<br/>kind: “MeshPolicy”<br/>metadata:<br/> name: “default”<br/>spec:<br/> peers:<br/> — mtls: {}</span></pre><p id="a6fc" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">2.一个DestinationRule使您的服务网格的所有客户端*能够在<em class="lk"> mTLS </em>中开始通信。</p><pre class="km kn ko kp gt ll lm ln lo aw lp bi"><span id="62ee" class="lq lr iq lm b gy ls lt l lu lv">apiVersion: "networking.istio.io/v1alpha3"<br/>kind: "DestinationRule"<br/>metadata:<br/>  name: "default"<br/>  namespace: "default"<br/>spec:<br/>  host: "*.local"<br/>  trafficPolicy:<br/>    tls:<br/>      mode: ISTIO_MUTUAL</span></pre><p id="e08a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">*我们通常称<a class="ae lw" href="https://istio.io/help/glossary/#workload" rel="noopener ugc nofollow" target="_blank">工作负载为</a>客户端。工作负载是服务网格上能够与其他服务或<a class="ae lw" href="https://istio.io/docs/reference/config/istio.networking.v1alpha3/#ServiceEntry" rel="noopener ugc nofollow" target="_blank"> ServiceEntries </a>(服务网格外的端点)开始通信的所有实体。</p><p id="22f1" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">关于这两个规则的完整性的更多信息，Kiali有Istio配置部分。在那里，您可以列出集群中的所有Istio对象。多亏了过滤，您可以很容易地找到上面描述的两个配置。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi kl"><img src="../Images/7f9a60c40cb091dd1bd8a7bb2336e52b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*uwHbOucNCJzdw0WZbXkOcQ.png"/></div></div></figure><h1 id="e3e6" class="lx lr iq bd ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp mq mr ms mt bi translated">我想禁用一个命名空间的mTLS，我该怎么做？</h1><p id="7659" class="pw-post-body-paragraph jn jo iq jp b jq mu js jt ju mv jw jx jy mw ka kb kc mx ke kf kg my ki kj kk ij bi translated">需要做两件不同的事情。我们将不得不再次改变客户端和服务的行为。</p><ol class=""><li id="bad8" class="lb lc iq jp b jq jr ju jv jy ld kc le kg lf kk lg lh li lj bi translated">为了使服务能够接收非mTLS连接，我们需要创建如下策略:</li></ol><pre class="km kn ko kp gt ll lm ln lo aw lp bi"><span id="3098" class="lq lr iq lm b gy ls lt l lu lv">apiVersion: "authentication.istio.io/v1alpha1"<br/>kind: "Policy"<br/>metadata:<br/>  name: "default"<br/>  namespace: "bookinfo"<br/>spec:<br/>  peers:<br/>    - mtls:<br/>        mode: PERMISSIVE</span></pre><p id="6dcf" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">许可模式允许服务接收所有类型的连接:明文或TLS。除了模式之外，这里要注意的一件有趣的事情是，策略<strong class="jp ir">必须</strong>被命名为“default ”,因为它没有<a class="ae lw" href="https://istio.io/docs/reference/config/istio.authentication.v1alpha1/#Policy" rel="noopener ugc nofollow" target="_blank">目标</a>字段。</p><p id="7794" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">为了允许所有服务接收普通连接和mTLS连接，首先应用策略是很重要的。如果您首先应用DestinationRule，您将让所有工作负载以普通方式启动连接，但是任何服务都可以响应。</p><p id="0552" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">2.关于客户端，我们需要定义一个新的DestinationRule，覆盖网状网络中声明的流量策略。</p><pre class="km kn ko kp gt ll lm ln lo aw lp bi"><span id="c4d4" class="lq lr iq lm b gy ls lt l lu lv">apiVersion: "networking.istio.io/v1alpha3"<br/>kind: "DestinationRule"<br/>metadata:<br/>  name: "disable-mtls"<br/>  namespace: "bookinfo"<br/>spec:<br/>  host: "*.bookinfo.svc.cluster.local"<br/>    trafficPolicy:<br/>      tls:<br/>        mode: DISABLE</span></pre><p id="02d7" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">Istio的覆盖机制与配置名的名称无关。在上面的代码片段中，我将DestinationRule的名称更改为一个更加自解释的名称(<em class="lk"> disable-mtls) </em>，并且它工作了。</p><p id="785c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">一旦两个配置都在服务网格中发布，您应该会看到:</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi kl"><img src="../Images/f570c2fe9d2ce37e7ee58ece8077fcc3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*a5RM3HYXsdrrFBUXO3EaUA.png"/></div></div><figcaption class="kx ky gj gh gi kz la bd b be z dk translated">IstioMesh开始从MTL过渡到普通连接</figcaption></figure><p id="d1ed" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">服务网格边缘的Open lock显示部分或全部流量未加密(不使用mTLS)。在应用之前的配置后，大多数流量仍然使用mTLS。然而，边缘的锁警告有未加密的流量通过。mTLS流量的确切数量显示在右侧面板中。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div class="gh gi mz"><img src="../Images/abaf40aa99c6296485a7ae44abad79cc.png" data-original-src="https://miro.medium.com/v2/resize:fit:560/format:webp/1*d-P7eTkAdZV3HIe2VRK50w.png"/></div><figcaption class="kx ky gj gh gi kz la bd b be z dk translated">24%的最后一分钟请求流量使用了MTL</figcaption></figure><p id="9b4d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">对命名空间禁用mTLS一段时间后，图形应该完全变绿，全部流量未加密。但是，您的网状范围mTLS仍处于启用状态。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi kl"><img src="../Images/a81e7695ef9b3c66990c74f412ae50bb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*bwhYfXGj6yPer-Am_uLm6A.png"/></div></div><figcaption class="kx ky gj gh gi kz la bd b be z dk translated">100%的流量不使用mTLS</figcaption></figure><p id="fe7b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">作为最后的检查，我强烈建议你去Istio配置部分，看看是否有任何来自Kiali的验证系统的警告。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi kl"><img src="../Images/ef1e8daceb8d44016a4f214078f09b6b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*LsS5fG1l-hYhomEipSfJig.png"/></div></div><figcaption class="kx ky gj gh gi kz la bd b be z dk translated">按bookinfo命名空间筛选的对象列表。未找到验证。</figcaption></figure><h1 id="57f9" class="lx lr iq bd ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp mq mr ms mt bi translated">一个常见的错误</h1><p id="0bfd" class="pw-post-body-paragraph jn jo iq jp b jq mu js jt ju mv jw jx jy mw ka kb kc mx ke kf kg my ki kj kk ij bi translated">当您有一个在<strong class="jp ir">严格</strong>模式下定义mTLS的网格策略时，您是说您的服务网格内的所有流量都必须使用mTLS协议。因此，当您想要禁用命名空间或服务的流量时，您不希望流量使用mTLS。所以这违背了网格策略的定义。</p><p id="ffbf" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">看看当您只指定禁用mTLS的目标规则时会发生什么(并且没有定义任何名称空间范围的策略):</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi na"><img src="../Images/6fb498884fe6f660a7c7a68c1c42171c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*NQYaf-25UvDVIQn1kHfP0w.png"/></div></div><figcaption class="kx ky gj gh gi kz la bd b be z dk translated">Istio配置—启用全网状mTLS，禁用mTLS流量的目标规则</figcaption></figure><p id="dc42" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如我们所见，我们的服务网络具有:</p><ul class=""><li id="33c2" class="lb lc iq jp b jq jr ju jv jy ld kc le kg lf kk nb lh li lj bi translated"><code class="fe nc nd ne lm b">disable-mtls</code> DestinationRule禁用<code class="fe nc nd ne lm b">bookinfo</code>命名空间的mTLS。</li><li id="04c1" class="lb lc iq jp b jq nf ju ng jy nh kc ni kg nj kk nb lh li lj bi translated"><code class="fe nc nd ne lm b">default</code> DestinationRule为服务网格中的整个连接启用mTLS。</li><li id="d3b5" class="lb lc iq jp b jq nf ju ng jy nh kc ni kg nj kk nb lh li lj bi translated"><code class="fe nc nd ne lm b">default</code> MeshPolicy严格允许所有服务上的MTL。</li></ul><p id="0d67" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这里重要的一点是DestinationRule有问题。同样重要的是:Kiali警告你。见下文:</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi kl"><img src="../Images/2f469a6d19ad8c33d429b6859993acc5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*uzJllaG_lxK6qcfTvfuveA.png"/></div></div><figcaption class="kx ky gj gh gi kz la bd b be z dk translated">Kiali验证建议添加允许非mTLS流量的许可策略</figcaption></figure><p id="96c0" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">基阿利说<code class="fe nc nd ne lm b">MeshPolicy enabling mTLS found, permissive policy is needed</code>这意味着网络策略正在强制mTLS流量，所以在这里禁用mTLS将导致错误的配置。此外，Kiali建议您添加一个许可策略。</p><p id="5a8e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">为了解决这个问题，您有两个选择:要么将MeshPolicy设置为<code class="fe nc nd ne lm b">permissive</code>模式(这不是一个好的实践),要么在<code class="fe nc nd ne lm b">permissive</code>模式下将一个策略添加到<code class="fe nc nd ne lm b">bookinfo</code>名称空间(正如我们在本文第一部分中看到的)。</p></div></div>    
</body>
</html>