<html>
<head>
<title>Loggly in ASP.NET Core using Serilog</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Serilog在ASP.NET岩心中测井</h1>
<blockquote>原文：<a href="https://itnext.io/loggly-in-asp-net-core-using-serilog-dc0e2c7d52eb?source=collection_archive---------1-----------------------#2018-03-22">https://itnext.io/loggly-in-asp-net-core-using-serilog-dc0e2c7d52eb?source=collection_archive---------1-----------------------#2018-03-22</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/6e31bb2b0fc98ed35bc82b1162c4c8d5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*o77htFt97jzliTv4ksJDpQ.png"/></div></div></figure><p id="e3e8" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><a class="ae kw" rel="noopener ugc nofollow" target="_blank" href="/loggly-in-asp-net-core-using-serilog-dc0e2c7d52eb?utm_source=medium_sharelink&amp;utm_medium=social&amp;utm_campaign=buffer">点击这里在LinkedIn上分享这篇文章</a></p><p id="876a" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我已经花了一些时间尝试在spend核心应用程序中使用Serilog实现Loggly，我想分享知识。希望能给某人省点时间:)</p><p id="5bdd" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">你可以在这里下载完整的代码:【https://github.com/stensolino/LogglySolutions T2】</p><p id="d197" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">所以让我们开始吧！</p><p id="d594" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">第一步是创建一个新的解决方案。选择ASP.NET核心Web应用程序，输入解决方案和项目名称，然后单击确定。</p><figure class="ky kz la lb gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi kx"><img src="../Images/7879d039b7b985436a855f5fecfc915c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*CVCsMUeGEOGkqUYrU_Uc5w.png"/></div></div></figure><p id="c864" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">下一步是选择项目模板。我们将使用API作为模板。选择它并单击确定。</p><figure class="ky kz la lb gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi lc"><img src="../Images/f4a1a5ef66e166655c408a6621ce7f47.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*VfnUTa7-hNSud4B-U5SFzA.png"/></div></div></figure></div><div class="ab cl ld le hu lf" role="separator"><span class="lg bw bk lh li lj"/><span class="lg bw bk lh li lj"/><span class="lg bw bk lh li"/></div><div class="ij ik il im in"><h2 id="e100" class="lk ll iq bd lm ln lo dn lp lq lr dp ls kj lt lu lv kn lw lx ly kr lz ma mb mc bi translated">默认集成记录器</h2><p id="962e" class="pw-post-body-paragraph jy jz iq ka b kb md kd ke kf me kh ki kj mf kl km kn mg kp kq kr mh kt ku kv ij bi translated">在我们继续前进之前，关于ASP.NET核心API项目中包含的默认日志程序，说几句话。当我们使用ASP.NET核心API模板创建新项目时，会创建Programs.cs文件，在其中我们可以找到WebHost。将在应用程序启动时调用的CreateDefaultBuilder(args)函数。除了其他东西，该函数将注册默认记录器。默认情况下，将启用控制台和调试提供程序，并将从appsettings.json文件中读取配置。在appsettings.json文件中，您可以看到配置被设置为“警告”日志级别。对于我们的测试用例，将其更改为“信息”级别。</p><p id="165e" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">要使用这个默认的记录器，我们只需要将它添加到我们想要使用它的构造函数中。例如，我们可以使用在项目初始化时创建的ValuesController。打开ValuesController，添加ILogger私有只读属性，并将其追加到构造函数中。</p><figure class="ky kz la lb gt jr"><div class="bz fp l di"><div class="mi mj l"/></div></figure><p id="fcf9" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">是时候运行应用程序了。如果应用程序使用IIS Express profile运行，我们的日志可以在Visual Studio的输出屏幕中跟踪。对于我们的示例，使用“LogglySolutions”运行它。Api”配置文件。</p><figure class="ky kz la lb gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mk"><img src="../Images/8c755546ee51a7d0cec41f78e5588021.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ZiramvC5NRzJADzYXUDd5g.png"/></div></div></figure><p id="8ea3" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">这样，应用程序将从打开控制台开始，我们可以在那里跟踪我们的日志:</p><figure class="ky kz la lb gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi ml"><img src="../Images/a942ae995ac7cd132dc19c4bbd0d1930.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*7zo_A6v_jW_PPbfk5rDbuQ.png"/></div></div></figure><p id="244b" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在这里，我们可以看到一些默认的日志输出和来自ValuesController的日志。</p><p id="676a" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">要禁用这些日志，我们可以在appsettings.json中将LogLevel设置为“None”。Development.json文件，当我们在开发模式下运行应用程序时，该文件将覆盖appsettings.json中的设置。仅对appsettings中的那些设置进行重写。Development.json，它不会替换文件。</p></div><div class="ab cl ld le hu lf" role="separator"><span class="lg bw bk lh li lj"/><span class="lg bw bk lh li lj"/><span class="lg bw bk lh li"/></div><div class="ij ik il im in"><h2 id="50c9" class="lk ll iq bd lm ln lo dn lp lq lr dp ls kj lt lu lv kn lw lx ly kr lz ma mb mc bi translated">禁用默认集成记录器</h2><p id="4995" class="pw-post-body-paragraph jy jz iq ka b kb md kd ke kf me kh ki kj mf kl km kn mg kp kq kr mh kt ku kv ij bi translated">在继续安装和实现Serilog之前，我们将禁用默认的记录器。这不是强制性的，但是没有理由启用两个记录器。</p><p id="c30d" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">因为默认记录器是通过调用WebHost实现的。CreateDefaultBuilder(args)方法，我们必须删除所有提供程序。打开Program.cs并将BuildWebHost方法编辑为:</p><pre class="ky kz la lb gt mm mn mo mp aw mq bi"><span id="b9c1" class="lk ll iq mn b gy mr ms l mt mu">public static IWebHost BuildWebHost(string[] args) =&gt;<br/>     WebHost.CreateDefaultBuilder(args)<br/>          <strong class="mn ir">.ConfigureLogging((hostingContext, config) =&gt;<br/>          {<br/>               config.ClearProviders();<br/>          })</strong><br/>          .UseStartup&lt;Startup&gt;()<br/>          .Build();</span></pre><p id="6c85" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">你也可以更换网络主机。CreateDefaultBuilder(args)方法并自行配置主机，并省略添加默认记录器，但这超出了本文的范围。无论如何，上面的代码会做的工作，禁用默认的记录器。</p><p id="5341" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">现在，您还可以从appsettings.json文件中删除logger配置。移除之后，我们的appsettings.json应该只包含空的json: {}。不要忘记清除appsettings。Development.json也是。</p><p id="f822" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">如果你现在运行应用程序，你会看到没有日志。</p></div><div class="ab cl ld le hu lf" role="separator"><span class="lg bw bk lh li lj"/><span class="lg bw bk lh li lj"/><span class="lg bw bk lh li"/></div><div class="ij ik il im in"><h2 id="0445" class="lk ll iq bd lm ln lo dn lp lq lr dp ls kj lt lu lv kn lw lx ly kr lz ma mb mc bi translated">安装Serilog</h2><p id="c740" class="pw-post-body-paragraph jy jz iq ka b kb md kd ke kf me kh ki kj mf kl km kn mg kp kq kr mh kt ku kv ij bi translated">现在是时候安装Serilog NuGet包了。我们需要的第一个NuGet包是Serilog.AspNetCore。您可以使用Visual Studio或通过命令安装它:</p><pre class="ky kz la lb gt mm mn mo mp aw mq bi"><span id="ba92" class="lk ll iq mn b gy mr ms l mt mu">Install-Package Serilog.AspNetCore -DependencyVersion Highest</span></pre><p id="e190" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">安装完基本的Serilog包后，下一步是安装Serilog接收器提供程序。有很多选择。我们将与Serilog一起前进。水槽。控制台，串行。同样，我们可以使用Visual Studio或命令:</p><pre class="ky kz la lb gt mm mn mo mp aw mq bi"><span id="0c0d" class="lk ll iq mn b gy mr ms l mt mu">Install-Package Serilog.Sinks.Console<br/>Install-Package Serilog.Sinks.File<br/>Install-Package Serilog.Sinks.Loggly</span></pre></div><div class="ab cl ld le hu lf" role="separator"><span class="lg bw bk lh li lj"/><span class="lg bw bk lh li lj"/><span class="lg bw bk lh li"/></div><div class="ij ik il im in"><h2 id="2398" class="lk ll iq bd lm ln lo dn lp lq lr dp ls kj lt lu lv kn lw lx ly kr lz ma mb mc bi translated">Serilog控制台提供程序实现</h2><p id="2791" class="pw-post-body-paragraph jy jz iq ka b kb md kd ke kf me kh ki kj mf kl km kn mg kp kq kr mh kt ku kv ij bi translated">我们已经准备好了实施细则。我们将从Program.cs文件开始。</p><figure class="ky kz la lb gt jr"><div class="bz fp l di"><div class="mi mj l"/></div></figure><p id="d78b" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">这里我们运行BuildWebHost(args)并将结果分配给WebHost。在构建web host时，我们为_environmentName变量赋值，我们在构建配置时使用该变量来读取appsettings.json文件特定的环境。我们还配置日志。日志记录器，配置来自appsettings.json。最后，我们运行web host。</p><p id="c952" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">下一步是将记录器配置添加到appsettings.json文件中:</p><figure class="ky kz la lb gt jr"><div class="bz fp l di"><div class="mi mj l"/></div></figure><p id="8207" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">重要的部分是WriteTo，我们在其中添加了我们想要使用的所有提供者。稍后我们将在这里添加文件和日志提供者。</p><p id="9a8b" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在我们运行应用程序来测试新的记录器之前，我们只需编辑ValuesController.cs来删除旧的记录器并添加新的记录器。它应该如下图所示:</p><figure class="ky kz la lb gt jr"><div class="bz fp l di"><div class="mi mj l"/></div></figure><p id="2605" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">如果我们运行应用程序，我们应该会在控制台中看到日志:</p><figure class="ky kz la lb gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi ml"><img src="../Images/0908ba7841953d67af1e14d970063844.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*9hJzjdpvxKu2i_YRQWHpbA.png"/></div></div></figure></div><div class="ab cl ld le hu lf" role="separator"><span class="lg bw bk lh li lj"/><span class="lg bw bk lh li lj"/><span class="lg bw bk lh li"/></div><div class="ij ik il im in"><h2 id="f016" class="lk ll iq bd lm ln lo dn lp lq lr dp ls kj lt lu lv kn lw lx ly kr lz ma mb mc bi translated">Serilog文件提供程序实现</h2><p id="96ec" class="pw-post-body-paragraph jy jz iq ka b kb md kd ke kf me kh ki kj mf kl km kn mg kp kq kr mh kt ku kv ij bi translated">添加文件提供者很简单，我们只需要将它添加到appsettings.json文件中。下面是更新后的appsettings.json:</p><figure class="ky kz la lb gt jr"><div class="bz fp l di"><div class="mi mj l"/></div></figure><p id="c604" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">如您所见，我们刚刚向“WriteTo”列表添加了新的提供者。在前面的一个步骤中，我们已经安装了Serilog滚动文件提供程序NuGet包。作为“Args ”,我们提供了“pathFormat ”,保存文件的路径和“outputTemplate ”,后者定义了日志写入的格式。</p><p id="7984" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">运行应用程序，您可以转到路径(在我的例子中是C:\LogglySolutions\)，您应该会找到新的日志文件。</p></div><div class="ab cl ld le hu lf" role="separator"><span class="lg bw bk lh li lj"/><span class="lg bw bk lh li lj"/><span class="lg bw bk lh li"/></div><div class="ij ik il im in"><h2 id="df69" class="lk ll iq bd lm ln lo dn lp lq lr dp ls kj lt lu lv kn lw lx ly kr lz ma mb mc bi translated">最后，实现seriloglogly提供程序</h2><p id="d20b" class="pw-post-body-paragraph jy jz iq ka b kb md kd ke kf me kh ki kj mf kl km kn mg kp kq kr mh kt ku kv ij bi translated">当我实现控制台和文件提供程序时，我期望Loggly provider会有相同的实现过程，但是最后没有更多的工作要做。在撰写本文时，appsettings.json还不能配置seriloglogly provider，在这里可以通过将它添加到provider列表来启用它，但是必须通过代码来完成特性配置。</p><p id="9a28" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">要实现和测试Loggly provider，您需要有一个Loggly帐户。你可以免费得到一个。</p><p id="2dba" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">第一步是为Loggly准备配置。如前所述，我们可以在appsettings.json文件中启用Loggly provider，只需添加:</p><pre class="ky kz la lb gt mm mn mo mp aw mq bi"><span id="3b96" class="lk ll iq mn b gy mr ms l mt mu">{<br/> "Name": "Loggly"<br/>}</span></pre><p id="83bf" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">控制台和滚动文件提供程序所在的提供程序列表中。</p><p id="74e4" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我们还需要loggly的附加设置，我们可以将这些附加设置添加到appsetting.json，但我们需要手动读取它。这是完整的最终appsettings.json文件，只需用您的值替换“占位符”:</p><figure class="ky kz la lb gt jr"><div class="bz fp l di"><div class="mi mj l"/></div></figure><p id="dfaa" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">如你所见，Loggly部分位于Serilog之下。这不是必需的，你可以在根级别添加它，但我只是想保持它的组织性。</p><p id="ac30" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我将创建一个类(LogglySettings ),其中将加载Loggly配置。我还在项目的根目录中创建了一个新的文件夹Settings，并将LogglySettings.cs放在其中。</p><figure class="ky kz la lb gt jr"><div class="bz fp l di"><div class="mi mj l"/></div></figure><p id="a12d" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">现在打开Program.cs并将bind Loggly配置添加到LogglySettings类:</p><pre class="ky kz la lb gt mm mn mo mp aw mq bi"><span id="ca4b" class="lk ll iq mn b gy mr ms l mt mu">var logglySettings = new LogglySettings();<br/>configuration.GetSection("Serilog:Loggly").Bind(logglySettings);</span></pre><p id="5a16" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">你也可以用其他方式来做这件事，但我更喜欢这种方式。您甚至可以在代码中输入Loggly值。一切都取决于你。</p><p id="3801" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">最后一步是配置Loggly provider。我们将在Program类中创建私有方法SetupLogglyConfiguration，并从Main方法调用该方法。下面是完整的类:</p><figure class="ky kz la lb gt jr"><div class="bz fp l di"><div class="mi mj l"/></div></figure><p id="3a33" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">SetupLogglyConfiguration方法实际上是通过代码配置的，不是从设置文件自动配置的，但是将来可能会从设置文件自动配置。我们只是使用之前创建的logglySettings来设置值。</p><p id="e988" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">仅此而已。现在，您可以运行应用程序，您应该可以在您的loggly帐户中看到日志结果:</p><figure class="ky kz la lb gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mv"><img src="../Images/c037c54a2cdf2ea8662179643a5c2db8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*5QdJXdMI9dynUhYnN18_VA.png"/></div></div></figure></div><div class="ab cl ld le hu lf" role="separator"><span class="lg bw bk lh li lj"/><span class="lg bw bk lh li lj"/><span class="lg bw bk lh li"/></div><div class="ij ik il im in"><p id="9172" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">感谢您花时间阅读本文，并请留下任何(正面和负面)评论。通过这种方式，我们为我们伟大的社区做出了贡献，我们都从中受益。</p><p id="af18" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">祝你有美好的一天！</p></div></div>    
</body>
</html>