<html>
<head>
<title>Kubernetes troubleshooting Saga Part 2: Networking and DNS connectivity</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Kubernetes故障排除系列第2部分:网络和DNS连接</h1>
<blockquote>原文：<a href="https://itnext.io/kubernetes-troubleshooting-saga-part-2-networking-and-dns-connectivity-7f11013f6148?source=collection_archive---------3-----------------------#2019-11-27">https://itnext.io/kubernetes-troubleshooting-saga-part-2-networking-and-dns-connectivity-7f11013f6148?source=collection_archive---------3-----------------------#2019-11-27</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/d27058cd3e00f73f9b913892341b4c8b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*sT3XMl2JMNTY4mri-6WAsQ.png"/></div></div></figure><h1 id="b3a5" class="jy jz iq bd ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv bi translated">简介:</h1><p id="c2c0" class="pw-post-body-paragraph kw kx iq ky b kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt ij bi translated">这是排除Kubernetes传奇故障的第二部分。这篇文章将涵盖臭名昭著的DNS间歇性延迟5秒的问题，以及如何处理Kubernetes网络。对于传奇的第一部分，请点击以下链接:</p><p id="5e8a" class="pw-post-body-paragraph kw kx iq ky b kz lu lb lc ld lv lf lg lh lw lj lk ll lx ln lo lp ly lr ls lt ij bi translated">Kubernetes故障排除系列第1部分:pod、部署和集群。</p><h1 id="60ec" class="jy jz iq bd ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv bi translated">DNS间歇延迟:</h1><p id="c592" class="pw-post-body-paragraph kw kx iq ky b kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt ij bi translated">Kubernetes在其核心服务中使用iptables，Kubernetes依靠Netfilter内核模块来建立低级集群IP负载平衡。这需要两个关键模块，IP转发和桥接。由于netfilter的一个内核错误，在重负载下，DNS会出现问题。这个话题有多个Github问题开放，比如<a class="ae lz" href="https://github.com/kubernetes/kubernetes/issues/56903" rel="noopener ugc nofollow" target="_blank"> #Kube56903 </a>。要详细了解这个问题，我推荐阅读昆汀·马楚的<a class="ae lz" href="https://blog.quentin-machu.fr/2018/06/24/5-15s-dns-lookups-on-kubernetes/" rel="noopener ugc nofollow" target="_blank">这篇</a>文章。</p><p id="a851" class="pw-post-body-paragraph kw kx iq ky b kz lu lb lc ld lv lf lg lh lw lj lk ll lx ln lo lp ly lr ls lt ij bi translated">我第一次面对这个问题是在和KOPS一起为CNI编织的时候。我在与EKS的CoreDNS合作时也看到了这个问题。因为这是一个内核错误，如果你不想给内核打补丁，只能采用变通方法。内核补丁在这里<a class="ae lz" href="https://github.com/torvalds/linux/commit/ed07d9a021df6da53456663a76999189badc432a" rel="noopener ugc nofollow" target="_blank">可用</a>在这里<a class="ae lz" href="https://github.com/torvalds/linux/commit/4e35c1cb9460240e983a01745b5f29fe3a4d8e39" rel="noopener ugc nofollow" target="_blank">可用</a>。补丁可以应用于内核版本5或更高版本。</p><h2 id="c133" class="ma jz iq bd ka mb mc dn ke md me dp ki lh mf mg km ll mh mi kq lp mj mk ku ml bi translated">DNS延迟的解决方法:</h2><p id="9ac0" class="pw-post-body-paragraph kw kx iq ky b kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt ij bi translated"><strong class="ky ir">变通方法1 </strong>:我分享的昆汀·马楚的帖子附带了一个简单的解决方案。它将在weave的Daemonset中运行额外的容器，这将在DNS调用之间带来延迟。对于使用Weave并且有合理流量的集群，我会推荐这个解决方案，因为它很容易实现。将以下配置添加到Weave的Daemonset中:</p><pre class="mm mn mo mp gt mq mr ms mt aw mu bi"><span id="f1b7" class="ma jz iq mr b gy mv mw l mx my">spec:<br/>      containers:<br/>      - name: weave-tc<br/>        image: 'qmachu/weave-tc:0.0.1'<br/>        securityContext:<br/>          privileged: true<br/>        volumeMounts:<br/>          - name: xtables-lock<br/>            mountPath: /run/xtables.lock<br/>          - name: usr-lib-tc<br/>            mountPath: /lib/tc</span><span id="71ee" class="ma jz iq mr b gy mz mw l mx my">volumes:<br/>      - hostPath:<br/>          path: /usr/lib/tc<br/>          type: ""<br/>        name: usr-lib-tc</span></pre><p id="3a66" class="pw-post-body-paragraph kw kx iq ky b kz lu lb lc ld lv lf lg lh lw lj lk ll lx ln lo lp ly lr ls lt ij bi translated"><strong class="ky ir">解决方法2: </strong>对于具有高负载和大量pods的集群，DNS缓存是一种可行的方法。<a class="ae lz" href="https://github.com/kubernetes/kubernetes/tree/master/cluster/addons/dns/nodelocaldns" rel="noopener ugc nofollow" target="_blank">这里的</a>是指向Kubernetes Nodelocal DNS缓存文档的链接。为此我找了一个Kubekon 2019的视频:</p><figure class="mm mn mo mp gt jr"><div class="bz fp l di"><div class="na nb l"/></div></figure><blockquote class="nc nd ne"><p id="fbd4" class="kw kx nf ky b kz lu lb lc ld lv lf lg ng lw lj lk nh lx ln lo ni ly lr ls lt ij bi translated"><strong class="ky ir">注意:</strong>对于这两种变通办法，请确保您有足够数量的kube-dns或core-DNS pod可用。在压力测试期间，由于kube-dns pods耗尽了资源，我的网络出现了中断。</p></blockquote><h1 id="5f5c" class="jy jz iq bd ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv bi translated">网络故障排除:</h1><p id="c3e2" class="pw-post-body-paragraph kw kx iq ky b kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt ij bi translated">我通常使用busybox部署来测试我的网络。您可以使用您喜欢的所有工具创建自己的定制映像，然后使用该映像运行部署。下面是一个使用busybox的示例部署:</p><pre class="mm mn mo mp gt mq mr ms mt aw mu bi"><span id="687d" class="ma jz iq mr b gy mv mw l mx my">apiVersion: apps/v1beta1<br/>kind: Deployment<br/>metadata:<br/>  labels:<br/>    run: busybox<br/>  name: busybox<br/>  namespace: default<br/>spec:<br/>  replicas: 2<br/>  selector:<br/>    matchLabels:<br/>      run: busybox<br/>    type: RollingUpdate<br/>  template:<br/>    metadata:<br/>      labels:<br/>        run: busybox<br/>    spec:<br/>      nodeSelector:<br/>        type: other      <br/>      containers:<br/>      - image: busybox:latest<br/>        imagePullPolicy: Always<br/>        name: busybox</span></pre><h2 id="230e" class="ma jz iq bd ka mb mc dn ke md me dp ki lh mf mg km ll mh mi kq lp mj mk ku ml bi translated">一般故障排除步骤:</h2><p id="97c8" class="pw-post-body-paragraph kw kx iq ky b kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt ij bi translated">网络是一个广泛的话题，因此我将记录排除潜在网络问题时应该采取的一般步骤:</p><ul class=""><li id="60bd" class="nj nk iq ky b kz lu ld lv lh nl ll nm lp nn lt no np nq nr bi translated">良好的起点是调试服务，请查看Kubernetes的本指南:<a class="ae lz" href="https://kubernetes.io/docs/tasks/debug-application-cluster/debug-service/" rel="noopener ugc nofollow" target="_blank">https://Kubernetes . io/docs/tasks/debug-application-cluster/debug-service/</a></li><li id="c5da" class="nj nk iq ky b kz ns ld nt lh nu ll nv lp nw lt no np nq nr bi translated">检查入口控制器的日志，例如:<br/> <code class="fe nx ny nz mr b">stern nginx-ingress</code></li><li id="23f2" class="nj nk iq ky b kz ns ld nt lh nu ll nv lp nw lt no np nq nr bi translated">确保正确创建或重新创建入口，例如:<br/> <code class="fe nx ny nz mr b">kubectl get ingress &lt;ingress name&gt;<br/>kubectl describe ingress &lt;ingress name&gt;</code></li><li id="3d8f" class="nj nk iq ky b kz ns ld nt lh nu ll nv lp nw lt no np nq nr bi translated">如果您已经更改了nginx入口的配置，或者您想要检查配置，那么您可以使用:<br/> <code class="fe nx ny nz mr b">kubectl exec -it &lt;nginx ingress pod name&gt; cat /etc/nginx/nginx.conf</code></li><li id="fc25" class="nj nk iq ky b kz ns ld nt lh nu ll nv lp nw lt no np nq nr bi translated">您可以从nginx或busybox pods测试端点:<br/> <code class="fe nx ny nz mr b">kubectl exec -it &lt;pod name&gt; curl <a class="ae lz" href="http://test-app:8080/v1/health" rel="noopener ugc nofollow" target="_blank">http://test-app/v1/health</a></code></li><li id="0879" class="nj nk iq ky b kz ns ld nt lh nu ll nv lp nw lt no np nq nr bi translated">为了确保您的负载平衡器不是问题的根本原因，您可以使用curl点击LB。<code class="fe nx ny nz mr b">kubectl describe ingress</code>将为您提供与您的服务入口相关的LB。下面是命令:<br/> <code class="fe nx ny nz mr b">curl -H “HOST: www.test-app.com" &lt;elb-ed&gt;.us-west-1.elb.amazonaws.com</code></li><li id="9abd" class="nj nk iq ky b kz ns ld nt lh nu ll nv lp nw lt no np nq nr bi translated">拥有像Istio这样的服务网格工具和像jaeger这样的跟踪工具有助于了解您的kube网络发生了什么以及瓶颈在哪里。</li><li id="4790" class="nj nk iq ky b kz ns ld nt lh nu ll nv lp nw lt no np nq nr bi translated">如果您的集群没有任何跟踪或服务网格，那么像tcpdump这样的工具会非常有用，让我们假设我们的部署没有工作，pod的ip是172.28.93.3。我们可以通过在节点运行pod上运行tcpdump来捕获相关流量:<br/> <code class="fe nx ny nz mr b">tcpdump -i any host 172.28.93.3</code></li><li id="4823" class="nj nk iq ky b kz ns ld nt lh nu ll nv lp nw lt no np nq nr bi translated">nslookup也是测试dns的便捷工具，例如:<br/> <code class="fe nx ny nz mr b">nslookup <a class="ae lz" href="http://www.test-app.com" rel="noopener ugc nofollow" target="_blank">www.test-app.com</a></code></li></ul><p id="a200" class="pw-post-body-paragraph kw kx iq ky b kz lu lb lc ld lv lf lg lh lw lj lk ll lx ln lo lp ly lr ls lt ij bi translated">除了上述步骤之外，以下是对诊断网络问题有用的资源:</p><ul class=""><li id="e064" class="nj nk iq ky b kz lu ld lv lh nl ll nm lp nn lt no np nq nr bi translated"><a class="ae lz" href="https://www.praqma.com/stories/debugging-kubernetes-networking/" rel="noopener ugc nofollow" target="_blank">https://www . praqma . com/stories/debugging-kubernetes-networking/</a></li><li id="f783" class="nj nk iq ky b kz ns ld nt lh nu ll nv lp nw lt no np nq nr bi translated"><a class="ae lz" href="https://www.alibabacloud.com/blog/how-to-inspect-kubernetes-networking_594236" rel="noopener ugc nofollow" target="_blank">https://www . Alibaba cloud . com/blog/how-to-inspect-kubernetes-networking _ 594236</a></li></ul></div></div>    
</body>
</html>