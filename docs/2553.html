<html>
<head>
<title>Routing external traffic into your Kubernetes services</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">将外部流量路由到您的Kubernetes服务</h1>
<blockquote>原文：<a href="https://itnext.io/routing-external-traffic-into-my-kubernetes-services-deb3e872f7bd?source=collection_archive---------0-----------------------#2019-06-14">https://itnext.io/routing-external-traffic-into-my-kubernetes-services-deb3e872f7bd?source=collection_archive---------0-----------------------#2019-06-14</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><p id="7bf8" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">有几种方法可以将互联网流量路由到您的Kubernetes集群。然而，在选择正确的方法时，我们需要考虑一些因素，如成本、安全性和可维护性。本文通过考虑以上事实，指导您选择更好的方法将外部流量路由到您的Kubernetes集群。</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div class="gh gi ko"><img src="../Images/3791c8246946b41370db3a78ea68f516.png" data-original-src="https://miro.medium.com/v2/resize:fit:1226/format:webp/1*tRT0AnmcieZoKUtSov98VQ.jpeg"/></div><figcaption class="kw kx gj gh gi ky kz bd b be z dk translated">到Kube服务的交通流量</figcaption></figure><p id="d731" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">在路由外部流量之前，让我们了解一下集群内部的路由机制。在Kubernetes中，所有的应用程序都在一个pod中运行。pod是一个容器，它比静态实例有更多的优点。</p><p id="d209" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">要访问pod中运行的应用程序，应该有一个专门的服务。服务和pod之间的映射由“标签选择器”机制决定。下面是一个示例yaml，它可以用来创建hello world应用程序。在那里，您可以清楚地了解“标签选择器”映射。</p><pre class="kp kq kr ks gt la lb lc ld aw le bi"><span id="1b67" class="lf lg it lb b gy lh li l lj lk"><strong class="lb iu">apiVersion</strong>: apps/v1<br/><strong class="lb iu">kind</strong>: Deployment<br/><strong class="lb iu">metadata</strong>:<br/>  <strong class="lb iu">name</strong>: <!-- -->helloworld-deployment<br/>  <strong class="lb iu">labels</strong>:<br/>    <strong class="lb iu">app</strong>: helloworld<br/><strong class="lb iu">spec</strong>:<br/>  <strong class="lb iu">replicas</strong>: 1<br/>  <strong class="lb iu">selector</strong>:<br/>    <strong class="lb iu">matchLabels</strong>:<br/>      <strong class="lb iu">app</strong>: helloworld<br/>  <strong class="lb iu">template</strong>:<br/>    <strong class="lb iu">metadata</strong>:<br/>      <strong class="lb iu">labels</strong>:<br/>        <strong class="lb iu">app</strong>: helloworld<br/>    <strong class="lb iu">spec</strong>:<br/>      <strong class="lb iu">containers</strong>:<br/>      - <strong class="lb iu">name</strong>: <!-- -->helloworld<br/>        <strong class="lb iu">image</strong>: <!-- -->dockercloud/hello-world<br/>        <strong class="lb iu">ports</strong>:<br/>        - <strong class="lb iu">containerPort</strong>: 80</span></pre><p id="6fab" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">让我们看看如何为上面的hello world应用程序创建一个Kubernetes服务。在这个例子中，我使用了<code class="fe ll lm ln lb b"><strong class="js iu">"app:helloworld"</strong></code>标签来定义我的应用程序。现在，您需要使用这个“<strong class="js iu"> helloworld </strong>”单词作为服务的选择器。然后，只有您的服务确定哪些pod由该服务负责。下面是对应于上述应用程序的示例服务，</p><pre class="kp kq kr ks gt la lb lc ld aw le bi"><span id="215c" class="lf lg it lb b gy lh li l lj lk">apiVersion: v1<br/>kind: Service<br/>metadata:<br/>  name: "service-helloworld"<br/>spec:<br/> <strong class="lb iu"> selector:<br/>    app: helloworld</strong><br/>  type: ClusterIP<br/>  ports:<br/>  - protocol: TCP<br/>    port: 80<br/>    targetPort: 80</span></pre><p id="0963" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">该规范将创建一个名为“service-helloworld”的新<code class="fe ll lm ln lb b"><strong class="js iu">Service</strong></code>，它的目标是任何带有<code class="fe ll lm ln lb b"><strong class="js iu">"app:helloworld"</strong></code>标签的<code class="fe ll lm ln lb b"><strong class="js iu">Pod</strong></code>上的TCP端口80。</p><p id="c0a9" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">在这里你可以看到上面服务的类型是“<strong class="js iu"> ClusterIP </strong>”。这是Kubernetes服务的默认类型。除此之外，还有另外两种类型的服务，称为“节点端口”和“负载平衡器”。将流量路由到Kubernetes集群的机制将取决于您在定义服务时使用的服务类型。让我们深入了解更多细节。</p><ol class=""><li id="d459" class="lo lp it js b jt ju jx jy kb lq kf lr kj ls kn lt lu lv lw bi translated">负载平衡器:使用云提供商的负载平衡器对外公开服务。(例如:在AWS中，它将为每个服务创建一个ELB，将该类型公开为“负载平衡器”。)然后，您可以使用ELB的专用DNS名称访问该服务。</li><li id="8443" class="lo lp it js b jt lx jx ly kb lz kf ma kj mb kn lt lu lv lw bi translated">NodePort:在静态端口公开每个节点IP上的服务。您可以通过请求<nodeip> : <nodeport>连接到集群外部的节点端口服务。这是服务的固定端口，其范围为30000–32767。</nodeport></nodeip></li></ol><p id="d997" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">3.ClusterIP: ClusterIP服务是默认的Kubernetes服务。在群集内部IP上公开服务。选择该值将使服务只能从集群内部访问。但是要向外部公开这些服务，您需要在集群内部部署入口控制器。</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div class="gh gi mc"><img src="../Images/14651bfa10cf68d0a79b0fefa6463d7d.png" data-original-src="https://miro.medium.com/v2/resize:fit:742/format:webp/1*aIfYGU4gsqttu5_jMAj3Ug.png"/></div></figure><p id="f492" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">考虑到上述服务类型，向集群外部公开服务的最简单方法是使用“负载平衡器”服务类型。但是这些云负载平衡器是要花钱的，默认情况下，每个负载平衡器Kubernetes服务都会创建一个单独的云负载平衡器。因此，这种服务类型非常昂贵。如果为您在k8s集群中创建的每个服务创建一个单独的ELB(如果集群在AWS中),您能承受这样的部署成本吗？</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div class="gh gi md"><img src="../Images/18ed29bad1dba9ed766acf03ffbda1f3.png" data-original-src="https://miro.medium.com/v2/resize:fit:748/format:webp/1*7QXZHBty2KNFEtcE3MeIwA.png"/></div></figure><p id="a17d" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">我们的下一个选择是“节点端口”服务类型。但是选择节点端口作为服务类型由于几个缺点而有一些缺点。因为根据设计，它绕过了Kubernetes集群提供的几乎所有网络安全性。它从30000–32767范围内动态分配一个端口。因此，不能使用80、443或8443等标准端口。由于这种动态分配，您不知道预先分配的端口。您需要在创建服务后检查分配的端口，在大多数主机上，您需要在创建服务后在防火墙中打开相关端口。</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div class="gh gi me"><img src="../Images/60ae9b36667652afb403aa9ee8100627.png" data-original-src="https://miro.medium.com/v2/resize:fit:712/format:webp/1*Y-aZGdvhOjKwurYlb-yLYw.png"/></div></figure><p id="cafe" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">最后也是最推荐的将流量路由到Kubernetes服务的方法是“ClusterIP”服务类型。使用“ClusterIP”的唯一缺点是，如果不使用代理，就无法从集群外部调用服务。因为默认情况下，“ClusterIP”只能由它自己的Kubernetes集群中的服务访问。让我们讨论一下如何获得Kubernetes ingress控制器的帮助，将ClusterIP服务公开到网络外部。</p><p id="cefe" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">下图说明了通过Kubernetes入口控制器流向ClusterIP服务的流量的基本架构。</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div class="gh gi mf"><img src="../Images/323fb9a64838f587c8417a7e90073c7a.png" data-original-src="https://miro.medium.com/v2/resize:fit:822/format:webp/1*-L8a3-Tb3GuS-J44Ih4Kkg.png"/></div></figure><p id="6d7e" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">如果您在Kubernetes集群中部署了多个服务，我推荐使用上面的方法，因为它有几个优点。</p><ol class=""><li id="b987" class="lo lp it js b jt ju jx jy kb lq kf lr kj ls kn lt lu lv lw bi translated">入口使您能够配置控制外部流量到服务的路由的规则。</li><li id="6080" class="lo lp it js b jt lx jx ly kb lz kf ma kj mb kn lt lu lv lw bi translated">您可以在Nginx入口控制器级别处理SSL/TLS端接。</li><li id="ff9f" class="lo lp it js b jt lx jx ly kb lz kf ma kj mb kn lt lu lv lw bi translated">你可以得到URI重写的支持。</li></ol><p id="adad" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">当您需要提供对Kubernetes服务的外部访问时，您需要创建一个定义连接规则的入口资源，包括URI路径和支持服务名称。然后，入口控制器自动配置前端负载平衡器来实施入口规则。</p><p id="b4f5" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">在本系列的第2部分中，让我们使用helm在您的Kubernetes集群中部署上述部署。</p><p id="1239" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">干杯！！！</p></div></div>    
</body>
</html>