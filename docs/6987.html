<html>
<head>
<title>How To Use PyTest including Real Examples And Best Practices</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何使用PyTest，包括真实示例和最佳实践</h1>
<blockquote>原文：<a href="https://itnext.io/how-to-use-pytest-including-real-examples-and-best-practices-11073e4fd514?source=collection_archive---------0-----------------------#2022-05-09">https://itnext.io/how-to-use-pytest-including-real-examples-and-best-practices-11073e4fd514?source=collection_archive---------0-----------------------#2022-05-09</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><p id="1ea1" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">你发现自己定期修复bug了吗？就像你不能休息一下，让QA或你的经理盯着你。</p><p id="32ac" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">“嘿，我成功破解了你的密码”。“它不适用于此用例”。</p><p id="5bda" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">你不是一个人，我也经历过，那很糟糕。你也没有从你的经理、客户或人力资源那里获得多少印象分。</p><p id="19f2" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">更不用说你的自尊和自信受到的打击了。</p><p id="5653" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">好吧，以下是你如何尽你所能减轻这种情况。秘方是单元测试。或者测试驱动开发(TDD)。</p><p id="46a1" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">现在每个技术面试都会检验你的单元测试知识。</p><p id="d8fb" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">作为一名自学成才的开发人员，如果没有在行业中花费大量时间，或者没有导师，很难获得最佳实践。</p><p id="68ba" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">这个博客将教你如何使用PyTest框架编写Python单元测试，最大化覆盖率，模仿外部API和服务，并将测试作为CI/CD管道的一部分。</p><p id="357d" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">都有示例代码。</p><p id="2197" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">作为一名首席Python开发人员，我从5年多的经历中学到了很多。让我们开始吧。</p><p id="335f" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">如果你想直接跳到代码，这里有一个Github 上的<a class="ae kp" href="https://github.com/ericsalesdeandrade/number-logic" rel="noopener ugc nofollow" target="_blank">链接。</a></p><figure class="kr ks kt ku gt kv gh gi paragraph-image"><div role="button" tabindex="0" class="kw kx di ky bf kz"><div class="gh gi kq"><img src="../Images/794d64de904a5737b1f2cce23dacce31.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*4UMe0F6rXeH-emJtQLkaSQ.jpeg"/></div></div><figcaption class="lc ld gj gh gi le lf bd b be z dk translated"><a class="ae kp" href="https://unsplash.com/photos/qAjJk-un3BI" rel="noopener ugc nofollow" target="_blank">信用</a></figcaption></figure><p id="2e0a" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><strong class="js iu">为什么要测试？</strong></p><ul class=""><li id="1cee" class="lg lh it js b jt ju jx jy kb li kf lj kj lk kn ll lm ln lo bi translated"><strong class="js iu">预测/模拟预期功能</strong></li><li id="b02a" class="lg lh it js b jt lp jx lq kb lr kf ls kj lt kn ll lm ln lo bi translated"><strong class="js iu">不要破坏什么工程</strong></li><li id="6d9a" class="lg lh it js b jt lp jx lq kb lr kf ls kj lt kn ll lm ln lo bi translated"><strong class="js iu">边缘案例和异常处理</strong></li></ul><p id="dd36" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><strong class="js iu">测试框架。(Pytest，Unittest &amp;其他)</strong></p><p id="f342" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><strong class="js iu">如何测试(示例代码)</strong></p><ul class=""><li id="141a" class="lg lh it js b jt ju jx jy kb li kf lj kj lk kn ll lm ln lo bi translated"><strong class="js iu"> I/O(输入、输出)测试</strong></li><li id="6c52" class="lg lh it js b jt lp jx lq kb lr kf ls kj lt kn ll lm ln lo bi translated"><strong class="js iu">功能测试</strong></li><li id="d511" class="lg lh it js b jt lp jx lq kb lr kf ls kj lt kn ll lm ln lo bi translated"><strong class="js iu">异常测试</strong></li></ul><p id="7a2d" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><strong class="js iu">其他类型的测试？</strong></p><ul class=""><li id="d141" class="lg lh it js b jt ju jx jy kb li kf lj kj lk kn ll lm ln lo bi translated"><strong class="js iu"> REST API调用</strong></li><li id="49aa" class="lg lh it js b jt lp jx lq kb lr kf ls kj lt kn ll lm ln lo bi translated"><strong class="js iu">动态生成的查询测试</strong></li></ul><p id="5ca4" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><strong class="js iu"> PyTest最佳实践</strong></p><ul class=""><li id="f45a" class="lg lh it js b jt ju jx jy kb li kf lj kj lk kn ll lm ln lo bi translated"><strong class="js iu">使用夹具作为参数</strong></li><li id="4beb" class="lg lh it js b jt lp jx lq kb lr kf ls kj lt kn ll lm ln lo bi translated"><strong class="js iu">将参数&amp;夹具存储在Conftest </strong>中</li><li id="9868" class="lg lh it js b jt lp jx lq kb lr kf ls kj lt kn ll lm ln lo bi translated"><strong class="js iu">模拟API和库响应</strong></li></ul><p id="bda3" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><strong class="js iu">作为CI/CD管道的一部分进行测试&amp; Github挂钩</strong></p><p id="d757" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><strong class="js iu">结论</strong></p><h1 id="78e5" class="lu lv it bd lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp mq mr bi translated">为什么要测试？</h1><p id="7251" class="pw-post-body-paragraph jq jr it js b jt ms jv jw jx mt jz ka kb mu kd ke kf mv kh ki kj mw kl km kn im bi translated">那么测试有什么大不了的呢？</p><p id="43d6" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">为什么不能让它工作并部署到生产中呢？在本地测试的还不够多吗？</p><p id="8a48" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">有很多关于单元测试是否重要或者集成测试是否足够的争论。</p><p id="712b" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><em class="ko">注——顾名思义，集成测试是测试一个更复杂系统的整体功能。拼图的各个部分是如何一起工作的。</em></p><p id="23ba" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">这就是我从艰难的道路中学到的东西，以及为什么测试很重要。</p><h2 id="481c" class="mx lv it bd lw my mz dn ma na nb dp me kb nc nd mi kf ne nf mm kj ng nh mq ni bi translated">预测/模拟预期功能</h2><p id="c7b6" class="pw-post-body-paragraph jq jr it js b jt ms jv jw jx mt jz ka kb mu kd ke kf mv kh ki kj mw kl km kn im bi translated">你希望一段代码完全按照你的设计去做，也就是说，对于一个给定的输入，它应该产生相同的输出。每一次</p><p id="d089" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">让我们暂时忽略机器学习和神经网络；)</p><p id="7a17" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">确保这一点的可靠方法是在将代码提交到存储库或部署到生产环境之前运行单元测试。</p><h2 id="2715" class="mx lv it bd lw my mz dn ma na nb dp me kb nc nd mi kf ne nf mm kj ng nh mq ni bi translated">不要破坏有用的东西</h2><p id="6b7b" class="pw-post-body-paragraph jq jr it js b jt ms jv jw jx mt jz ka kb mu kd ke kf mv kh ki kj mw kl km kn im bi translated">有句话很流行“如果有用，就不要碰”。</p><p id="91e1" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">代码也是如此。如果你(或你的公司)有一个可以工作的软件，你最不想做的事情就是破坏它。</p><p id="2164" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">这可能完全是无意的，因为您不知道您的更改会影响代码的其他部分。</p><p id="3518" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">单元测试有助于隔离代码的各个模块，并确保您的更改不会破坏应用程序中的其他模块。</p><h2 id="d413" class="mx lv it bd lw my mz dn ma na nb dp me kb nc nd mi kf ne nf mm kj ng nh mq ni bi translated">边缘案例和异常处理</h2><p id="e4a7" class="pw-post-body-paragraph jq jr it js b jt ms jv jw jx mt jz ka kb mu kd ke kf mv kh ki kj mw kl km kn im bi translated">如果有一件事是大多数开发人员擅长的，那就是懒惰。包括我自己。</p><p id="3479" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">我们不喜欢花时间思考或考虑可能破坏我们软件的边缘情况。我们宁愿等待它发生，然后修补它。</p><p id="3660" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">这是导致灾难的原因。代码中的错误会让你或你的公司向客户付费。</p><p id="0203" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">编写单元测试迫使你去思考你的代码可能崩溃的边缘情况，以及你应该如何解决它。</p><p id="d61b" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">它还让你思考<a class="ae kp" href="https://www.programiz.com/python-programming/exception-handling#:~:text=In%20Python%2C%20exceptions%20can%20be,we%20have%20caught%20the%20exception." rel="noopener ugc nofollow" target="_blank">异常处理</a>(代码优雅地处理错误)以及如何用有用的错误消息来处理它。</p><h1 id="5876" class="lu lv it bd lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp mq mr bi translated">测试框架。(Pytest、Unittest和其他)</h1><p id="3278" class="pw-post-body-paragraph jq jr it js b jt ms jv jw jx mt jz ka kb mu kd ke kf mv kh ki kj mw kl km kn im bi translated">有几个Python测试框架，大多数都以相同的方式工作。</p><p id="d9d6" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">你使用一个测试框架调用你的模块，传递一个预期的响应，如果你的代码的响应与预期的响应相匹配，它就通过了。如果没有，它就失败了。</p><p id="7d30" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">一些流行的框架有</p><ul class=""><li id="fde3" class="lg lh it js b jt ju jx jy kb li kf lj kj lk kn ll lm ln lo bi translated"><a class="ae kp" href="https://docs.pytest.org/en/7.1.x/" rel="noopener ugc nofollow" target="_blank"> PyTest </a></li><li id="7261" class="lg lh it js b jt lp jx lq kb lr kf ls kj lt kn ll lm ln lo bi translated"><a class="ae kp" href="https://docs.python.org/3/library/unittest.html" rel="noopener ugc nofollow" target="_blank">单元测试</a></li><li id="92a4" class="lg lh it js b jt lp jx lq kb lr kf ls kj lt kn ll lm ln lo bi translated"><a class="ae kp" href="https://docs.nose2.io/en/latest/" rel="noopener ugc nofollow" target="_blank">鼻2 </a></li><li id="5c8d" class="lg lh it js b jt lp jx lq kb lr kf ls kj lt kn ll lm ln lo bi translated"><a class="ae kp" href="https://robotframework.org/" rel="noopener ugc nofollow" target="_blank">机器人</a></li><li id="eeae" class="lg lh it js b jt lp jx lq kb lr kf ls kj lt kn ll lm ln lo bi translated"><a class="ae kp" href="https://behave.readthedocs.io/en/stable/" rel="noopener ugc nofollow" target="_blank">守规矩</a></li><li id="beaa" class="lg lh it js b jt lp jx lq kb lr kf ls kj lt kn ll lm ln lo bi translated"><a class="ae kp" href="https://support.smartbear.com/crossbrowsertesting/docs/automated-testing/frameworks/lettuce.html#:~:text=Lettuce%20is%20a%20Behavior%20Driver,with%20CrossBrowserTesting%27s%20cloud%20testing%20platform." rel="noopener ugc nofollow" target="_blank">生菜</a></li></ul><p id="0c4b" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">虽然大多数框架都很好并且易于使用，但我更喜欢PyTest模块。</p><p id="6de7" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">这是我用得最多的一款，我发现它的功能性和简单性无与伦比。</p><p id="42be" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">所以尝试一些对你来说最简单的方法。请记住，使用哪种框架并不重要，重要的是测试覆盖率和健壮性。</p><h1 id="141c" class="lu lv it bd lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp mq mr bi translated">如何测试(示例代码)</h1><p id="a4ce" class="pw-post-body-paragraph jq jr it js b jt ms jv jw jx mt jz ka kb mu kd ke kf mv kh ki kj mw kl km kn im bi translated">最后，文章的主体。你最期待的部分。实际代码。</p><p id="f425" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">整个指南使用PyTest模块进行说明，但是这些示例也可以用其他框架编写。</p><p id="98db" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">让我们考虑示例源代码— <a class="ae kp" href="http://number-logic/" rel="noopener ugc nofollow" target="_blank">数字逻辑</a>(链接到Github)</p><h2 id="7c41" class="mx lv it bd lw my mz dn ma na nb dp me kb nc nd mi kf ne nf mm kj ng nh mq ni bi translated">规范摘要</h2><ul class=""><li id="e57c" class="lg lh it js b jt ms jx mt kb nj kf nk kj nl kn ll lm ln lo bi translated">该任务的目标是获取一个包含数字列表的文件，并找到总和为指定值的3个数字。</li><li id="3e9d" class="lg lh it js b jt lp jx lq kb lr kf ls kj lt kn ll lm ln lo bi translated">Python类“<em class="ko"> NumberLogic </em>”包含一系列执行不同任务的函数(读取外部文件，将字符串转换为整数，找到总和等于指定值的数字)。</li><li id="f3a0" class="lg lh it js b jt lp jx lq kb lr kf ls kj lt kn ll lm ln lo bi translated">然后，我们将上一节中的3个数字相乘，并返回结果。</li></ul><p id="1333" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">你可以从根目录沿着路径<code class="fe nm nn no np b">src/number_logic.py</code>看一下源代码。</p><p id="8b71" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">现在让我们深入单元测试</p><p id="792c" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><strong class="js iu">关于Conftest的注意事项。</strong></p><p id="aaa1" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><code class="fe nm nn no np b">conftest.py</code>是一个与单元测试指定在同一个目录中的文件，包含了跨所有测试文件使用所需的装置和参数。</p><p id="cc23" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">下面是一个在Conftest中定义的装置的例子</p><figure class="kr ks kt ku gt kv"><div class="bz fp l di"><div class="nq nr l"/></div></figure><p id="1d2b" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">虽然这是一个非常基本的例子，但是您的<code class="fe nm nn no np b">conftest.py</code>文件可以包含您想要的任意多的夹具和参数。</p><h2 id="a057" class="mx lv it bd lw my mz dn ma na nb dp me kb nc nd mi kf ne nf mm kj ng nh mq ni bi translated">输入输出测试</h2><p id="c428" class="pw-post-body-paragraph jq jr it js b jt ms jv jw jx mt jz ka kb mu kd ke kf mv kh ki kj mw kl km kn im bi translated">处理磁盘上的文件时，一个重要的测试是输入/输出。尽管有人可能会认为这更像是一个集成测试，但我还是把它包括进来了。</p><p id="3553" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><strong class="js iu"> <em class="ko">测试1 == &gt;测试_读取_输入_文件</em> </strong></p><figure class="kr ks kt ku gt kv"><div class="bz fp l di"><div class="nq nr l"/></div></figure><p id="8f65" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">在这个测试<code class="fe nm nn no np b">test_read_input_file</code>中，我们检查脚本是否能够正确读取文件及其内容。这只是确保我们已经读取了预期的文件。</p><p id="c8cf" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><strong class="js iu"> <em class="ko">测试2 == &gt;测试_读取_输入_文件_异常</em> </strong></p><figure class="kr ks kt ku gt kv"><div class="bz fp l di"><div class="nq nr l"/></div></figure><p id="9679" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">第二个测试<code class="fe nm nn no np b">test_read_input_file_exception</code>检查如果文件不在磁盘上，我们的代码是否会引发一个<code class="fe nm nn no np b">FileNotFoundError</code>。</p><p id="b98d" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">请记住，提出例外时，请确保在问题和行动过程中包含有用的信息。</p><h2 id="16fe" class="mx lv it bd lw my mz dn ma na nb dp me kb nc nd mi kf ne nf mm kj ng nh mq ni bi translated">功能测试</h2><p id="93a6" class="pw-post-body-paragraph jq jr it js b jt ms jv jw jx mt jz ka kb mu kd ke kf mv kh ki kj mw kl km kn im bi translated"><strong class="js iu"> <em class="ko">测试3 == &gt;测试_转换_字符串_整数</em> </strong></p><figure class="kr ks kt ku gt kv"><div class="bz fp l di"><div class="nq nr l"/></div></figure><p id="2107" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">在这个测试中，我们检查作为输入传递给函数<code class="fe nm nn no np b">convert_str_int</code>的整数是否被正确地转换成字符串。</p><p id="98ca" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><strong class="js iu"> <em class="ko">测试4 == &gt;测试_检查_求和</em> </strong></p><figure class="kr ks kt ku gt kv"><div class="bz fp l di"><div class="nq nr l"/></div></figure><p id="91aa" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">在这个测试中，我们检查一个整数列表，其中3的和给出一个预定义的值(在这个例子中是2020)。</p><p id="9d8a" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><strong class="js iu"> <em class="ko">测试5== &gt;测试_乘_值</em> </strong></p><figure class="kr ks kt ku gt kv"><div class="bz fp l di"><div class="nq nr l"/></div></figure><p id="4308" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">在这个测试中，我们将这些值相乘以获得结果</p><h2 id="1642" class="mx lv it bd lw my mz dn ma na nb dp me kb nc nd mi kf ne nf mm kj ng nh mq ni bi translated">异常测试</h2><p id="e53e" class="pw-post-body-paragraph jq jr it js b jt ms jv jw jx mt jz ka kb mu kd ke kf mv kh ki kj mw kl km kn im bi translated"><strong class="js iu"> <em class="ko">测试6== &gt;测试_转换_字符串_异常</em> </strong></p><figure class="kr ks kt ku gt kv"><div class="bz fp l di"><div class="nq nr l"/></div></figure><p id="ab3e" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">在上面的测试中，我们检查了如果我们在输入中遇到一个意外的值(例如一个字符串)，我们的代码会生成一个有用的<code class="fe nm nn no np b">ValueError</code>。</p><p id="740a" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">如果我们要进行数值运算，这是很重要的。</p><p id="cf2e" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><strong class="js iu"> <em class="ko">测试7== &gt;测试_乘值_异常</em> </strong></p><figure class="kr ks kt ku gt kv"><div class="bz fp l di"><div class="nq nr l"/></div></figure><p id="8f15" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">与前面的测试类似，我们检查乘数函数的任何输入是否为非整数(并抛出一个<code class="fe nm nn no np b">ValueError</code>)。</p><h1 id="dad7" class="lu lv it bd lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp mq mr bi translated">其他类型的测试？</h1><p id="bc80" class="pw-post-body-paragraph jq jr it js b jt ms jv jw jx mt jz ka kb mu kd ke kf mv kh ki kj mw kl km kn im bi translated">上面的例子向你展示了如何将理论付诸实践，但是你还需要测试什么呢？</p><p id="fc4b" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">像生活中的大多数事情一样，人们会有不同的看法。有些人的目标是尽可能多的覆盖面，而对另一些人来说，只要基本的就够了。</p><p id="85a1" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">对于单元测试中的“单元”到底是什么，并没有一致的决定。一组类(模块)，单个类，方法，整个微服务？</p><p id="bfda" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">我喜欢把一个单元想象成一个类，或者有时是一组类。重要的是你正在测试你所写的代码的功能。</p><p id="67d3" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">不管它们是否相互排斥。</p><h2 id="64bb" class="mx lv it bd lw my mz dn ma na nb dp me kb nc nd mi kf ne nf mm kj ng nh mq ni bi translated">REST API调用</h2><p id="2a25" class="pw-post-body-paragraph jq jr it js b jt ms jv jw jx mt jz ka kb mu kd ke kf mv kh ki kj mw kl km kn im bi translated">在我的另一篇关于用AWS Lambda和API Gateway构建API的文章中，我引用了API的定义</p><blockquote class="ns nt nu"><p id="5892" class="jq jr ko js b jt ju jv jw jx jy jz ka nv kc kd ke nw kg kh ki nx kk kl km kn im bi translated">应用编程接口(API)是一组协议、例程、函数和/或命令，程序员使用它们来开发软件或促进不同系统之间的交互技术百科</p></blockquote><p id="55d0" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">简单地说，这是一个软件系统共享数据的协议。例如从数据库到网络服务器等等。</p><p id="fe52" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">在Python中进行API调用最流行的库之一是<code class="fe nm nn no np b"><a class="ae kp" href="https://docs.python-requests.org/en/latest/" rel="noopener ugc nofollow" target="_blank">Requests</a></code>库。</p><p id="5ec6" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">但是，如何测试来自其他API(您不拥有也不控制)的响应呢？</p><p id="68fe" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">关键是嘲讽。</p><p id="1d4d" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><code class="fe nm nn no np b"><a class="ae kp" href="https://medium.com/r?url=https%3A%2F%2Frequests-mock.readthedocs.io%2Fen%2Flatest%2F" rel="noopener">requests-mock</a></code>库允许您模拟API响应，从而消除了仅仅为了测试目的而对API进行外部调用的需要(这可能代价很高)。</p><p id="4911" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">更不用说它有助于确保您捕获API响应格式的变化。</p><p id="b952" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">模仿ElasticSearch中索引创建的请求示例，您还可以模仿HTTP状态代码。</p><p id="6264" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">附注:这里使用了一个<code class="fe nm nn no np b">AdminElasticSearch</code>类，只是为了举例说明。</p><figure class="kr ks kt ku gt kv"><div class="bz fp l di"><div class="nq nr l"/></div></figure><p id="5652" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">《T5》蓝皮书中有一些很好的请求嘲讽测试例子。</p><h2 id="feb7" class="mx lv it bd lw my mz dn ma na nb dp me kb nc nd mi kf ne nf mm kj ng nh mq ni bi translated">动态生成的查询测试</h2><p id="ab18" class="pw-post-body-paragraph jq jr it js b jt ms jv jw jx mt jz ka kb mu kd ke kf mv kh ki kj mw kl km kn im bi translated">如果你正在用Python构建你的后端，你可能需要使用动态生成的查询与SQL Server、Postgres或ElasticSearch等数据库进行对话。</p><p id="6324" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">这些查询是在运行时基于某些变量生成的，因此模拟生成正确的查询非常重要。</p><p id="ae61" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">如何应用这一点的一个很好的例子在<a class="ae kp" href="https://towardsdatascience.com/a-simple-approach-to-templated-sql-queries-in-python-adc4f0dc511" rel="noopener" target="_blank">这里</a>有很好的描述。</p><h1 id="6581" class="lu lv it bd lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp mq mr bi translated">PyTest最佳实践</h1><p id="d9dc" class="pw-post-body-paragraph jq jr it js b jt ms jv jw jx mt jz ka kb mu kd ke kf mv kh ki kj mw kl km kn im bi translated">既然我们已经讨论了如何测试，那么让我们快速看一下PyTest的一些最佳实践。</p><h2 id="2934" class="mx lv it bd lw my mz dn ma na nb dp me kb nc nd mi kf ne nf mm kj ng nh mq ni bi translated">使用夹具作为参数</h2><p id="f43f" class="pw-post-body-paragraph jq jr it js b jt ms jv jw jx mt jz ka kb mu kd ke kf mv kh ki kj mw kl km kn im bi translated">您会经常发现自己在测试中使用各种参数。这些可能是您的类的实例，或者可能只是一个输入测试文件。</p><p id="6c04" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">夹具的使用对此有很大帮助。Pytest fixtures允许您在测试文件本身(或<code class="fe nm nn no np b">conftest.py</code>)中定义参数，并在您的测试中使用它们。</p><p id="d083" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">这里有一个<a class="ae kp" href="https://docs.pytest.org/en/6.2.x/fixture.html" rel="noopener ugc nofollow" target="_blank">伟大的指南</a>告诉你如何开始使用PyTest Fixtures。</p><h2 id="3e9b" class="mx lv it bd lw my mz dn ma na nb dp me kb nc nd mi kf ne nf mm kj ng nh mq ni bi translated">在Conftest中存储参数和装置</h2><p id="3a7e" class="pw-post-body-paragraph jq jr it js b jt ms jv jw jx mt jz ka kb mu kd ke kf mv kh ki kj mw kl km kn im bi translated">使用<code class="fe nm nn no np b">conftest.py</code>为运行您的测试提供了一个很好的框架，允许您定义fixtures和其他元素，并在所有的测试模块中使用它们。</p><p id="768e" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">只要确保<code class="fe nm nn no np b">conftest.py</code>文件和你的测试文件放在同一个目录下。</p><h2 id="714e" class="mx lv it bd lw my mz dn ma na nb dp me kb nc nd mi kf ne nf mm kj ng nh mq ni bi translated">模拟API和库响应</h2><p id="bd06" class="pw-post-body-paragraph jq jr it js b jt ms jv jw jx mt jz ka kb mu kd ke kf mv kh ki kj mw kl km kn im bi translated">模拟API调用和其他库响应提供了一种无需实际调用就能测试功能的简便方法，节省了计算资源和成本。</p><p id="4605" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">还有几个最佳实践，所以请花些时间来查看并应用它们。</p><h1 id="225d" class="lu lv it bd lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp mq mr bi translated">作为CI/CD管道和Github挂钩的一部分进行测试</h1><p id="c1c3" class="pw-post-body-paragraph jq jr it js b jt ms jv jw jx mt jz ka kb mu kd ke kf mv kh ki kj mw kl km kn im bi translated">这是我多年来学到的一个非常重要的实践。</p><p id="b067" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">始终将单元和集成测试作为CI/CD管道的一部分。</p><p id="0ecb" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">如果您不知道什么是CI/CD，请点击此处查看文章和视频<a class="ae kp" href="https://www.synopsys.com/glossary/what-is-cicd.html" rel="noopener ugc nofollow" target="_blank"/>。</p><p id="8e64" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">但是，简而言之，CI(或持续改进)是对您的代码分支运行检查的过程，以确保它不会破坏<code class="fe nm nn no np b">main</code>或<code class="fe nm nn no np b">master</code>分支。</p><p id="7ff7" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">这些检查可以配置为执行您选择的任何检查。</p><p id="8da6" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">连续交付或连续部署(CD)是将代码分支部署到服务器到云帐户的过程。</p><p id="dd0d" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">CI/CD管道可以使用各种工具来设置，如AWS CodeBuild/CodePipeline、Jenkins、CircleCI或我最喜欢的<a class="ae kp" href="https://github.com/features/actions" rel="noopener ugc nofollow" target="_blank"> Github Actions </a>。</p><p id="39e9" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">将单元测试作为CI/CD的一部分来运行，可以确保您的最新更改不会破坏现有的功能，并减少bug进入生产软件的可能性。</p><p id="05ad" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">例如，您可以在<a class="ae kp" href="https://medium.com/@dev.soni04/github-action-for-unit-testing-57faefc9633" rel="noopener"> Github动作</a>上设置单元测试，并在本地使用<a class="ae kp" href="https://adamtheautomator.com/git-pre-commit-hook/" rel="noopener ugc nofollow" target="_blank"> Github挂钩</a>(通过<code class="fe nm nn no np b">.pre-commit-config.yaml</code>文件)。</p><figure class="kr ks kt ku gt kv"><div class="bz fp l di"><div class="nq nr l"/></div></figure><p id="ea23" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">下面的示例<code class="fe nm nn no np b">.pre-commit-config.yaml</code>—(存储在您的回购的根目录中)</p><h1 id="dd45" class="lu lv it bd lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp mq mr bi translated">结论和CTA</h1><p id="bcb5" class="pw-post-body-paragraph jq jr it js b jt ms jv jw jx mt jz ka kb mu kd ke kf mv kh ki kj mw kl km kn im bi translated">这就是了。</p><p id="cbff" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">这是一个相当全面的PyTest使用介绍和指南，包含了我作为开发人员多年来学到的一些最佳实践。</p><p id="072f" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">我们看了为什么应该对代码进行单元测试，测试框架(特别是PyTest)和一些单元测试的例子，包括模仿REST APIs。</p><p id="28b6" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">我们还探索了Pytest中的一些最佳实践——使用夹具和参数、conftest等，并将单元测试作为CI/CD管道的一部分。</p><p id="3414" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">我希望你喜欢这篇文章，如果你有任何建议或问题，不要犹豫，在评论或私人笔记中分享。</p></div></div>    
</body>
</html>