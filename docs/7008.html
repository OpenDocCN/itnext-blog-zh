<html>
<head>
<title>Deploy your app on K8s the GitOps way using Argo CD and the image updater</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Argo CD和图像更新程序以GitOps方式在K8s上部署您的应用程序</h1>
<blockquote>原文：<a href="https://itnext.io/deploy-your-app-on-k8s-the-gitops-way-using-argo-cd-and-the-image-updater-3a7a32bedaa2?source=collection_archive---------1-----------------------#2022-05-15">https://itnext.io/deploy-your-app-on-k8s-the-gitops-way-using-argo-cd-and-the-image-updater-3a7a32bedaa2?source=collection_archive---------1-----------------------#2022-05-15</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="22e5" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">开发人员不想与所有的Kubernetes内部争论。他们想要的只是轻松地部署他们的应用程序，看到它运行，并看到代码更改自动更新。有了Otomi，一个为Kubernetes提供的自托管PaaS，您只需几分钟就可以完成。在本文中，我将演示如何在启用Argo CD和Harbor的情况下使用Helm chart和Otomi部署容器映像。</p><h1 id="2038" class="kl km iq bd kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li bi translated">Otomi中支持的部署场景</h1><p id="e5bf" class="pw-post-body-paragraph jn jo iq jp b jq lj js jt ju lk jw jx jy ll ka kb kc lm ke kf kg ln ki kj kk ij bi translated">OSS <a class="ae lo" href="https://github.com/redkubes/otomi-core" rel="noopener ugc nofollow" target="_blank"> Otomi </a>附带了多个Kubernetes应用程序来支持您的首选部署场景。您可以创建自己的自定义设置。当你在Otomi中激活应用程序时，所有这些应用程序不仅仅是自动安装的，它们还被配置成开箱即用。以Argo CD为例。激活Argo CD时，Argo CD SSO将启用基于角色的访问。Otomi中的每个团队将自动访问Argo CD UI和Otomi中本地GIT存储库中的GitOps repo。Otomi还自动为团队创建一个Argo CD应用程序，监听团队的GitOps repo。因此，您唯一需要做的事情就是将您的清单推送到repo，您的应用程序就会自动部署。但这只是你可以使用/选择的一种场景；-)</p><p id="3efc" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">Otomi现在支持以下部署场景:</p><ol class=""><li id="2538" class="lp lq iq jp b jq jr ju jv jy lr kc ls kg lt kk lu lv lw lx bi translated">使用Otomi控制台激活Knative并创建Knative服务(无需编写任何YAML)</li><li id="d923" class="lp lq iq jp b jq ly ju lz jy ma kc mb kg mc kk lu lv lw lx bi translated">将Argo CD与Knative一起使用，并将Knative服务添加到GitOps repo</li><li id="09cc" class="lp lq iq jp b jq ly ju lz jy ma kc mb kg mc kk lu lv lw lx bi translated">将Harbor用作图表和图像注册表，并使用Argo CD和图像更新程序部署您的图表</li><li id="b836" class="lp lq iq jp b jq ly ju lz jy ma kc mb kg mc kk lu lv lw lx bi translated">将Harbor用作图表注册表，并使用Kubeapps部署您的图表(图表注册表在Kubeapps中自动作为图表目录提供)</li></ol><p id="1910" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">请注意，所有这些场景都是开箱即用的！</p><p id="18aa" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">让我们动手实践场景3:向Harbor添加一个图表，并使用Argo CD来部署图表，并根据图像标记自动更新图像。</p><h1 id="9c90" class="kl km iq bd kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li bi translated">使用Argo CD和图像更新程序部署您的应用程序</h1><h2 id="1b68" class="md km iq bd kn me mf dn kr mg mh dp kv jy mi mj kz kc mk ml ld kg mm mn lh mo bi translated">安装Otomi</h2><p id="6e2f" class="pw-post-body-paragraph jn jo iq jp b jq lj js jt ju lk jw jx jy ll ka kb kc lm ke kf kg ln ki kj kk ij bi translated">如果你还没有这样做，首先在Kubernetes上安装Otomi。我们已经创建了几个<a class="ae lo" href="https://github.com/redkubes/quickstart" rel="noopener ugc nofollow" target="_blank">快速启动</a>来帮助你在AWS、Digital Ocean、Azure、GCP、Linode或者只是在你的本地机器上用Otomi设置Kubernetes。完成激活步骤后，我们就可以开始了。在下面的说明中，我假设您是以拥有<code class="fe mp mq mr ms b">team-admin</code>角色的用户身份登录的。</p><h2 id="520c" class="md km iq bd kn me mf dn kr mg mh dp kv jy mi mj kz kc mk ml ld kg mm mn lh mo bi translated">1.激活阿尔戈光盘和港口</h2><p id="c488" class="pw-post-body-paragraph jn jo iq jp b jq lj js jt ju lk jw jx jy ll ka kb kc lm ke kf kg ln ki kj kk ij bi translated">要激活Argo CD和Harbor，请转到web UI (Otomi控制台)右侧菜单中的应用程序部分。在这里，您将看到所有活跃的应用程序以及您可以打开的可选应用程序。只需将Argo CD和Harbor拖放到活动应用程序窗格，然后单击<code class="fe mp mq mr ms b">Deploy Changes</code>。</p><figure class="mu mv mw mx gt my gh gi paragraph-image"><div role="button" tabindex="0" class="mz na di nb bf nc"><div class="gh gi mt"><img src="../Images/bf387d33c77cceebd0e534c427bbf8df.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*kY6Egc-aRQGqjjfNKInPEw.png"/></div></div><figcaption class="nf ng gj gh gi nh ni bd b be z dk translated">阿尔戈光盘和港口现在是活跃的</figcaption></figure><h2 id="97d8" class="md km iq bd kn me mf dn kr mg mh dp kv jy mi mj kz kc mk ml ld kg mm mn lh mo bi translated">2.在Otomi创建一个团队</h2><p id="9b71" class="pw-post-body-paragraph jn jo iq jp b jq lj js jt ju lk jw jx jy ll ka kb kc lm ke kf kg ln ki kj kk ij bi translated">如果你还没有这样做，现在首先在Otomi中创建一个团队。在右侧菜单的平台部分，点击<code class="fe mp mq mr ms b">Teams</code>和<code class="fe mp mq mr ms b">Create Team</code>。只需提供一个名称(我正在创建一个名为<code class="fe mp mq mr ms b">demo</code>的团队)。点击<code class="fe mp mq mr ms b">Submit</code>，然后点击<code class="fe mp mq mr ms b">Deploy Changes</code>。</p><h2 id="225e" class="md km iq bd kn me mf dn kr mg mh dp kv jy mi mj kz kc mk ml ld kg mm mn lh mo bi translated">3.在Harbor创建一个机器人帐户</h2><p id="ff50" class="pw-post-body-paragraph jn jo iq jp b jq lj js jt ju lk jw jx jy ll ka kb kc lm ke kf kg ln ki kj kk ij bi translated"><em class="nj">注意:</em>团队的机器人账户只能由<code class="fe mp mq mr ms b">otomi-admin</code>角色的用户创建</p><ol class=""><li id="a954" class="lp lq iq jp b jq jr ju jv jy lr kc ls kg lt kk lu lv lw lx bi translated">打开<code class="fe mp mq mr ms b">Harbor</code></li><li id="c69a" class="lp lq iq jp b jq ly ju lz jy ma kc mb kg mc kk lu lv lw lx bi translated">点击<code class="fe mp mq mr ms b">Login with OIDC Provider</code></li><li id="852a" class="lp lq iq jp b jq ly ju lz jy ma kc mb kg mc kk lu lv lw lx bi translated">填写您的用户名，然后单击保存</li><li id="c428" class="lp lq iq jp b jq ly ju lz jy ma kc mb kg mc kk lu lv lw lx bi translated">在<code class="fe mp mq mr ms b">Administration</code>下，点击<code class="fe mp mq mr ms b">Robot Accounts</code></li><li id="0a9e" class="lp lq iq jp b jq ly ju lz jy ma kc mb kg mc kk lu lv lw lx bi translated">点击<code class="fe mp mq mr ms b">+ New Robot account</code></li><li id="8cd1" class="lp lq iq jp b jq ly ju lz jy ma kc mb kg mc kk lu lv lw lx bi translated">为新的机器人帐户提供一个名称:<code class="fe mp mq mr ms b">team-demo-push</code></li><li id="f6bb" class="lp lq iq jp b jq ly ju lz jy ma kc mb kg mc kk lu lv lw lx bi translated">设置到期时间</li><li id="88f1" class="lp lq iq jp b jq ly ju lz jy ma kc mb kg mc kk lu lv lw lx bi translated">选择<code class="fe mp mq mr ms b">team-demo</code>和<code class="fe mp mq mr ms b">library</code></li><li id="08c4" class="lp lq iq jp b jq ly ju lz jy ma kc mb kg mc kk lu lv lw lx bi translated">点击<code class="fe mp mq mr ms b">Add</code></li><li id="0169" class="lp lq iq jp b jq ly ju lz jy ma kc mb kg mc kk lu lv lw lx bi translated">复制生成的令牌</li></ol><h2 id="13c6" class="md km iq bd kn me mf dn kr mg mh dp kv jy mi mj kz kc mk ml ld kg mm mn lh mo bi translated">4.向Harbor上传图表</h2><p id="148d" class="pw-post-body-paragraph jn jo iq jp b jq lj js jt ju lk jw jx jy ll ka kb kc lm ke kf kg ln ki kj kk ij bi translated">您可以在Harbor UI中完成此操作，或者直接使用helm CLI。首次登录Harbor。如果您没有使用DNS区域，让我们加密(而是使用Otomi自动生成的CA)，那么首先下载CA(在Otomi控制台中)并将CA添加到您的钥匙串中，然后重新启动Docker。你可以在这里找到说明<a class="ae lo" href="https://otomi.io/docs/installation/activation/#step-2-optional-add-the-auto-generated-ca-to-your-keychain" rel="noopener ugc nofollow" target="_blank"/>。</p><pre class="mu mv mw mx gt nk ms nl nm aw nn bi"><span id="1835" class="md km iq ms b gy no np l nq nr">helm registry login -u 'otomi-team-demo-push' -p $token harbor.&lt;your-domain&gt;</span></pre><p id="e560" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">上传<code class="fe mp mq mr ms b">hello-0.1.0.tgz</code>图表(此处下载<a class="ae lo" href="https://github.com/redkubes/workshops/blob/main/08-argocd/hello-0.1.0.tgz" rel="noopener ugc nofollow" target="_blank">此处</a>)并使用Helm CLI将其推送到图表注册表:</p><pre class="mu mv mw mx gt nk ms nl nm aw nn bi"><span id="eba8" class="md km iq ms b gy no np l nq nr">helm push hello-0.1.0.tgz oci://harbor.&lt;your-domain&gt;/library/hello</span></pre><p id="4bae" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">或者使用Harbor UI直接上传图表:</p><figure class="mu mv mw mx gt my gh gi paragraph-image"><div role="button" tabindex="0" class="mz na di nb bf nc"><div class="gh gi ns"><img src="../Images/6bcf6187dbc2cd16e189a82b50aeae84.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*nLz7Z3Q2LkahTAUalrjepg.png"/></div></div></figure><h2 id="f91f" class="md km iq bd kn me mf dn kr mg mh dp kv jy mi mj kz kc mk ml ld kg mm mn lh mo bi translated">5.在阿尔戈光盘连接一个舵repo</h2><ol class=""><li id="3969" class="lp lq iq jp b jq lj ju lk jy nt kc nu kg nv kk lu lv lw lx bi translated">打开<code class="fe mp mq mr ms b">Settings</code></li><li id="e538" class="lp lq iq jp b jq ly ju lz jy ma kc mb kg mc kk lu lv lw lx bi translated">选择<code class="fe mp mq mr ms b">Connect Repo using https</code>并使用以下输入:</li><li id="6dd1" class="lp lq iq jp b jq ly ju lz jy ma kc mb kg mc kk lu lv lw lx bi translated"><code class="fe mp mq mr ms b">Type: Helm</code></li><li id="0928" class="lp lq iq jp b jq ly ju lz jy ma kc mb kg mc kk lu lv lw lx bi translated"><code class="fe mp mq mr ms b">Name: Local Harbor</code></li><li id="8e01" class="lp lq iq jp b jq ly ju lz jy ma kc mb kg mc kk lu lv lw lx bi translated"><code class="fe mp mq mr ms b">Project: team-demo</code></li><li id="221f" class="lp lq iq jp b jq ly ju lz jy ma kc mb kg mc kk lu lv lw lx bi translated"><code class="fe mp mq mr ms b">Repository URL: harbor.&lt;your-domain&gt;/chartrepo/library</code></li><li id="5b5b" class="lp lq iq jp b jq ly ju lz jy ma kc mb kg mc kk lu lv lw lx bi translated">点击<code class="fe mp mq mr ms b">Connect</code></li></ol><figure class="mu mv mw mx gt my gh gi paragraph-image"><div role="button" tabindex="0" class="mz na di nb bf nc"><div class="gh gi nw"><img src="../Images/668f5c0b8863025110ec2e3df489c8ff.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*iCszmml0vnfmMfz6Ju9gGg.png"/></div></div></figure><h2 id="cc13" class="md km iq bd kn me mf dn kr mg mh dp kv jy mi mj kz kc mk ml ld kg mm mn lh mo bi translated">6.创建Argo CD应用程序</h2><ol class=""><li id="cad7" class="lp lq iq jp b jq lj ju lk jy nt kc nu kg nv kk lu lv lw lx bi translated">选择<code class="fe mp mq mr ms b">Applications</code>，点击<code class="fe mp mq mr ms b">Create</code>并使用以下输入:</li><li id="9454" class="lp lq iq jp b jq ly ju lz jy ma kc mb kg mc kk lu lv lw lx bi translated"><code class="fe mp mq mr ms b">Application Name: Hello</code></li><li id="94ac" class="lp lq iq jp b jq ly ju lz jy ma kc mb kg mc kk lu lv lw lx bi translated"><code class="fe mp mq mr ms b">Project: &lt;team-name&gt;</code></li><li id="dadc" class="lp lq iq jp b jq ly ju lz jy ma kc mb kg mc kk lu lv lw lx bi translated"><code class="fe mp mq mr ms b">Sync Policy: Automatic</code></li><li id="2282" class="lp lq iq jp b jq ly ju lz jy ma kc mb kg mc kk lu lv lw lx bi translated"><code class="fe mp mq mr ms b">Repository URL: harbor.&lt;your-domain&gt;/chartrepo/library</code></li><li id="7801" class="lp lq iq jp b jq ly ju lz jy ma kc mb kg mc kk lu lv lw lx bi translated"><code class="fe mp mq mr ms b">Chart: hello</code></li><li id="30f4" class="lp lq iq jp b jq ly ju lz jy ma kc mb kg mc kk lu lv lw lx bi translated"><code class="fe mp mq mr ms b">Version: 0.1.0</code></li><li id="60ad" class="lp lq iq jp b jq ly ju lz jy ma kc mb kg mc kk lu lv lw lx bi translated"><code class="fe mp mq mr ms b">Cluster URL: <a class="ae lo" href="https://kubernetes.default.svc" rel="noopener ugc nofollow" target="_blank">https://kubernetes.default.svc</a></code></li><li id="fdee" class="lp lq iq jp b jq ly ju lz jy ma kc mb kg mc kk lu lv lw lx bi translated"><code class="fe mp mq mr ms b">Namespace: &lt;team-name&gt;</code></li><li id="5345" class="lp lq iq jp b jq ly ju lz jy ma kc mb kg mc kk lu lv lw lx bi translated">点击<code class="fe mp mq mr ms b">Create</code></li></ol><p id="e162" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">您将看到hello应用程序现在已经自动部署。</p><figure class="mu mv mw mx gt my gh gi paragraph-image"><div role="button" tabindex="0" class="mz na di nb bf nc"><div class="gh gi nx"><img src="../Images/dccf62731f89c8381a2466fd9f5eb97b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*wrHaD3TR0qN-3a88zK9UUg.png"/></div></div><figcaption class="nf ng gj gh gi nh ni bd b be z dk translated">团队演示的hello应用程序已同步</figcaption></figure><figure class="mu mv mw mx gt my gh gi paragraph-image"><div role="button" tabindex="0" class="mz na di nb bf nc"><div class="gh gi ny"><img src="../Images/697be0a02236385e50f00c4eb009691e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*tboXMh-Q3Ve7GcEh9uWlgw.png"/></div></div><figcaption class="nf ng gj gh gi nh ni bd b be z dk translated">所有的资源都部署好了</figcaption></figure><p id="9f63" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">要查看该应用程序，请在Otomi中创建一个新服务(在部署该应用程序的团队中)，并将暴露入口设置为<code class="fe mp mq mr ms b">public</code>。</p><ol class=""><li id="ddad" class="lp lq iq jp b jq jr ju jv jy lr kc ls kg lt kk lu lv lw lx bi translated">在顶部栏中，选择您的团队</li><li id="40ed" class="lp lq iq jp b jq ly ju lz jy ma kc mb kg mc kk lu lv lw lx bi translated">点击侧面菜单中的<code class="fe mp mq mr ms b">Services</code></li><li id="4ad1" class="lp lq iq jp b jq ly ju lz jy ma kc mb kg mc kk lu lv lw lx bi translated">点击<code class="fe mp mq mr ms b">Create Service</code>，</li><li id="fd99" class="lp lq iq jp b jq ly ju lz jy ma kc mb kg mc kk lu lv lw lx bi translated">使用以下输入</li><li id="b52b" class="lp lq iq jp b jq ly ju lz jy ma kc mb kg mc kk lu lv lw lx bi translated"><code class="fe mp mq mr ms b">Name: hello</code></li><li id="056e" class="lp lq iq jp b jq ly ju lz jy ma kc mb kg mc kk lu lv lw lx bi translated"><code class="fe mp mq mr ms b">Service Type: Existing Kubernetes service</code></li><li id="4f94" class="lp lq iq jp b jq ly ju lz jy ma kc mb kg mc kk lu lv lw lx bi translated"><code class="fe mp mq mr ms b">Exposure: Public</code></li><li id="09bf" class="lp lq iq jp b jq ly ju lz jy ma kc mb kg mc kk lu lv lw lx bi translated">点击<code class="fe mp mq mr ms b">Submit</code>然后点击<code class="fe mp mq mr ms b">Deploy Changes</code></li></ol><h2 id="37df" class="md km iq bd kn me mf dn kr mg mh dp kv jy mi mj kz kc mk ml ld kg mm mn lh mo bi translated">7.配置Argo CD映像更新程序</h2><p id="99d2" class="pw-post-body-paragraph jn jo iq jp b jq lj js jt ju lk jw jx jy ll ka kb kc lm ke kf kg ln ki kj kk ij bi translated">为了自动更新部署的映像，我们可以配置Argo CD映像更新程序。注意:这仅在使用舵图部署时受支持。我们很幸运；-)</p><ol class=""><li id="e2bf" class="lp lq iq jp b jq jr ju jv jy lr kc ls kg lt kk lu lv lw lx bi translated">在Argo CD中，转到应用程序并点击<code class="fe mp mq mr ms b">hello</code>应用程序</li><li id="11fe" class="lp lq iq jp b jq ly ju lz jy ma kc mb kg mc kk lu lv lw lx bi translated">点击<code class="fe mp mq mr ms b">App Details</code>，然后点击<code class="fe mp mq mr ms b">Edit</code></li><li id="fc8d" class="lp lq iq jp b jq ly ju lz jy ma kc mb kg mc kk lu lv lw lx bi translated">在<code class="fe mp mq mr ms b">Annotations</code>下，添加以下注释并点击保存</li></ol><pre class="mu mv mw mx gt nk ms nl nm aw nn bi"><span id="08ca" class="md km iq ms b gy no np l nq nr">argocd-image-updater.argoproj.io/image-list:otomi/nodejs-helloworld: "~1.2"</span></pre><p id="a542" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">使用图表部署的图像版本是<code class="fe mp mq mr ms b">1.2.12</code>。然而，<code class="fe mp mq mr ms b">otomi/nodejs-helloworld</code>包含版本为<code class="fe mp mq mr ms b">1.2.13</code>的图像。现在转到hello服务的URL并刷新页面。你看到了什么？</p><h1 id="ed28" class="kl km iq bd kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li bi translated">包扎</h1><p id="d807" class="pw-post-body-paragraph jn jo iq jp b jq lj js jt ju lk jw jx jy ll ka kb kc lm ke kf kg ln ki kj kk ij bi translated">恭喜你。现在，您已经以GitOps的方式部署了您的应用程序。你现在唯一需要做的事情就是修改你的代码，构建镜像并推送它。</p><p id="7a67" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在第2部分中，我们将向party添加Knative，并展示如何创建一个导航图来部署Knative服务，不仅自动化CD，还自动化伸缩。</p><p id="09d0" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">希望你喜欢这篇文章。请亲自试用Otomi，看看使用Otomi以GitOps方式部署应用程序有多简单。</p><p id="a185" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">要支持Otomi，请在GitHub 上启动<a class="ae lo" href="https://github.com/redkubes/otomi-core" rel="noopener ugc nofollow" target="_blank"> Otomi OSS项目。谢谢大家！</a></p></div></div>    
</body>
</html>