<html>
<head>
<title>Deploying Mosquitto MQTT broker on Linux using Docker</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Docker在Linux上部署Mosquitto MQTT代理</h1>
<blockquote>原文：<a href="https://itnext.io/deploying-mosquitto-mqtt-broker-on-linux-using-docker-a9a7fa3a7404?source=collection_archive---------0-----------------------#2022-10-14">https://itnext.io/deploying-mosquitto-mqtt-broker-on-linux-using-docker-a9a7fa3a7404?source=collection_archive---------0-----------------------#2022-10-14</a></blockquote><div><div class="fc ii ij ik il im"/><div class="in io ip iq ir"><h2 id="78d8" class="is it iu bd b dl iv iw ix iy iz ja dk jb translated" aria-label="kicker paragraph">MQTT DOCKER</h2><div class=""/><div class=""><h2 id="c3dd" class="pw-subtitle-paragraph ka jd iu bd b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr dk translated"><strong class="ak">开始使用Mosquitto看似简单。我们向你展示如何避免陷阱。</strong></h2></div><figure class="kt ku kv kw gu kx gi gj paragraph-image"><div role="button" tabindex="0" class="ky kz di la bf lb"><div class="gi gj ks"><img src="../Images/f004e244704fb305eda5c3605478f931.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*UyhRBGO5Q2gc4hjo.png"/></div></div></figure><p id="45a2" class="pw-post-body-paragraph le lf iu lg b lh li ke lj lk ll kh lm ln lo lp lq lr ls lt lu lv lw lx ly lz in bi translated">Mosquitto服务器的Docker Hub页面使得部署服务器变得非常容易。您只需运行服务器，就可以立即设置监听器并发布一些消息，这一切都非常简单。但是，事实并非如此。有一个配置文件、数据和日志目录要装载到容器中，还有匿名访问服务器的权限问题。一旦这些都被妥善摆好，就很容易安装Mosquitto和踢轮胎。</p><p id="0f7a" class="pw-post-body-paragraph le lf iu lg b lh li ke lj lk ll kh lm ln lo lp lq lr ls lt lu lv lw lx ly lz in bi translated">Mosquitto是MQTT协议的消息代理。<a class="ae ma" href="https://mosquitto.org/" rel="noopener ugc nofollow" target="_blank">https://mosquitto.org/</a>它被描述为轻量级，适用于从嵌入式单板计算机(如Raspberry Pi)到大型服务器的一系列设备。Mosquitto项目还包括一个用于MQTT的C库，以及<code class="fe mb mc md me b">mosquitto_pub</code>和<code class="fe mb mc md me b">mosquitto_sub</code>客户端。</p><p id="7212" class="pw-post-body-paragraph le lf iu lg b lh li ke lj lk ll kh lm ln lo lp lq lr ls lt lu lv lw lx ly lz in bi translated">MQTT是一种使用发布-订阅(pubsub)模型分发消息的协议。按照MQTT的说法，代理是分发消息的服务。MQTT被广泛使用，协议非常精简，因此很容易在微型嵌入式微控制器上实现MQTT客户端。典型的用法是将传感器连接到像ESP32这样的微控制器上，然后通过互联网将数据传递给MQTT服务。该协议记录在:<a class="ae ma" href="https://mqtt.org/" rel="noopener ugc nofollow" target="_blank">https://mqtt.org/</a></p><p id="96c2" class="pw-post-body-paragraph le lf iu lg b lh li ke lj lk ll kh lm ln lo lp lq lr ls lt lu lv lw lx ly lz in bi translated">幸运的是，我们通常不需要自己实现MQTT，因为有许多现有的客户端库和代理服务。我们在本教程中使用的Mosquitto项目就是一个例子。</p><p id="0454" class="pw-post-body-paragraph le lf iu lg b lh li ke lj lk ll kh lm ln lo lp lq lr ls lt lu lv lw lx ly lz in bi translated">我们将看看如何使用Docker部署Mosquitto，并运行几个命令。在这个过程中，我们将讨论一些常见的部署失败。我们不打算使用MQTT或Mosquitto做任何有意义的事情，而是停留在部署和轻量级配置上。</p><h1 id="a84e" class="mf mg iu bd mh mi mj mk ml mm mn mo mp kj mq kk mr km ms kn mt kp mu kq mv mw bi translated">在Linux主机上部署Mosquitto</h1><p id="48c0" class="pw-post-body-paragraph le lf iu lg b lh mx ke lj lk my kh lm ln mz lp lq lr na lt lu lv nb lx ly lz in bi translated">在进入Docker之前，让我们快速浏览一下如何在Linux主机上部署Mosquitto。</p><p id="6236" class="pw-post-body-paragraph le lf iu lg b lh li ke lj lk ll kh lm ln lo lp lq lr ls lt lu lv lw lx ly lz in bi translated">在基于Debian的系统上，如Raspbian (Raspberry Pi OS)、Ubuntu、Debian等，这些是有用的命令:</p><pre class="kt ku kv kw gu nc me nd ne aw nf bi"><span id="ab6b" class="ng mg iu me b gz nh ni l nj nk"># Install server and client packages<br/>sudo apt install mosquitto mosquitto-clients<br/><br/># Start the server<br/>sudo systemctl enable mosquitto<br/><br/># Check its status<br/>sudo systemctl status mosquitto<br/><br/># Restart the server<br/>sudo service mosquitto restart</span></pre><p id="8a5d" class="pw-post-body-paragraph le lf iu lg b lh li ke lj lk ll kh lm ln lo lp lq lr ls lt lu lv lw lx ly lz in bi translated">这很容易做到，这是在Linux系统上运行服务器的传统方式。对于其他Linux发行版，您将使用类似的命令(例如<code class="fe mb mc md me b">yum</code>)并且可能使用不同的包名。</p><p id="7d2c" class="pw-post-body-paragraph le lf iu lg b lh li ke lj lk ll kh lm ln lo lp lq lr ls lt lu lv lw lx ly lz in bi translated">在码头工人时代，这是不推荐的。</p><p id="9ec3" class="pw-post-body-paragraph le lf iu lg b lh li ke lj lk ll kh lm ln lo lp lq lr ls lt lu lv lw lx ly lz in bi translated">基本原理是，如果有人通过Mosquitto服务中的一个bug闯入，Docker容器会限制潜在的破坏。任何入侵者都无法破坏集装箱外的任何东西。因为如果出现问题，容器很容易被破坏和重新创建，所以恢复很简单。</p><p id="38f1" class="pw-post-body-paragraph le lf iu lg b lh li ke lj lk ll kh lm ln lo lp lq lr ls lt lu lv lw lx ly lz in bi translated">Mosquitto的Docker容器包含与我们在本文其余部分讨论的完全相同的服务器和客户机程序。这意味着，如果您喜欢在主机系统上安装Mosquitto，而不是在Docker中安装，我们讨论的命令和配置文件可以直接应用。</p><h1 id="f129" class="mf mg iu bd mh mi mj mk ml mm mn mo mp kj mq kk mr km ms kn mt kp mu kq mv mw bi translated">一个简单的Docker编写的Mosquitto文件</h1><p id="6149" class="pw-post-body-paragraph le lf iu lg b lh mx ke lj lk my kh lm ln mz lp lq lr na lt lu lv nb lx ly lz in bi translated">在Mosquitto服务器的Docker Hub页面上，我们得到了这个<code class="fe mb mc md me b">docker</code>命令:</p><pre class="kt ku kv kw gu nc me nd ne aw nf bi"><span id="852d" class="ng mg iu me b gz nh ni l nj nk">$ docker run -it -p 1883:1883 -p 9001:9001 \<br/>        -v mosquitto.conf:/mosquitto/config/mosquitto.conf \<br/>        eclipse-mosquitto</span></pre><p id="0507" class="pw-post-body-paragraph le lf iu lg b lh li ke lj lk ll kh lm ln lo lp lq lr ls lt lu lv lw lx ly lz in bi translated">这有助于我们熟悉Mosquitto容器的操作。它将一个<code class="fe mb mc md me b">mosquitto.conf</code>文件挂载到容器中，并公开一对端口。看起来很简单，不是吗？</p><p id="629d" class="pw-post-body-paragraph le lf iu lg b lh li ke lj lk ll kh lm ln lo lp lq lr ls lt lu lv lw lx ly lz in bi translated">对于配置文件，我们建议使用:</p><pre class="kt ku kv kw gu nc me nd ne aw nf bi"><span id="e24b" class="ng mg iu me b gz nh ni l nj nk">persistence true<br/>persistence_location /mosquitto/data/<br/>log_dest file /mosquitto/log/mosquitto.log</span></pre><p id="179b" class="pw-post-body-paragraph le lf iu lg b lh li ke lj lk ll kh lm ln lo lp lq lr ls lt lu lv lw lx ly lz in bi translated">这样做的一个问题是，<code class="fe mb mc md me b">/mosquitto/data/</code>和<code class="fe mb mc md me b">/mosquitto/log/</code>这两个目录没有在容器之外持久化。还有一个问题我们稍后会谈到，但这是配置Mosquitto的一个很好的起点。</p><p id="4289" class="pw-post-body-paragraph le lf iu lg b lh li ke lj lk ll kh lm ln lo lp lq lr ls lt lu lv lw lx ly lz in bi translated">在使用Docker时，我更喜欢用<em class="nl"> Docker Compose </em>，因为它的灵活性。网站<code class="fe mb mc md me b">https://www.composerize.com/</code>可以帮助你将<code class="fe mb mc md me b">docker run</code>命令转换成<code class="fe mb mc md me b">docker-compose.yml</code>。经过一点调整，我们得到了这个:</p><pre class="kt ku kv kw gu nc me nd ne aw nf bi"><span id="2c14" class="ng mg iu me b gz nh ni l nj nk">services:<br/>    mosquitto:<br/>        image: eclipse-mosquitto<br/>        ports:<br/>            - 1883:1883<br/>            - 9001:9001<br/>        volumes:<br/>            - ./mosquitto.conf:/mosquitto/config/mosquitto.conf<br/>            - ./data:/mosquitto/data/<br/>            - ./log:/mosquitto/log/</span></pre><p id="69bb" class="pw-post-body-paragraph le lf iu lg b lh li ke lj lk ll kh lm ln lo lp lq lr ls lt lu lv lw lx ly lz in bi translated">这与<code class="fe mb mc md me b">docker</code>命令相同，但是它也指定了<code class="fe mb mc md me b">data</code>和<code class="fe mb mc md me b">log</code>目录的卷挂载。</p><p id="3c8c" class="pw-post-body-paragraph le lf iu lg b lh li ke lj lk ll kh lm ln lo lp lq lr ls lt lu lv lw lx ly lz in bi translated">要启动它，您需要运行:</p><pre class="kt ku kv kw gu nc me nd ne aw nf bi"><span id="530d" class="ng mg iu me b gz nh ni l nj nk">$ docker compose up</span></pre><p id="b360" class="pw-post-body-paragraph le lf iu lg b lh li ke lj lk ll kh lm ln lo lp lq lr ls lt lu lv lw lx ly lz in bi translated">注意我用了<code class="fe mb mc md me b">docker compose</code>而不是<code class="fe mb mc md me b">docker-compose</code>。旧的<code class="fe mb mc md me b">docker-compose</code>命令已被新的<code class="fe mb mc md me b">docker compose</code>命令取代。让我们祝愿<code class="fe mb mc md me b">docker-compose</code>平安退休。这个实现足够完整，在大多数情况下，您可以用空格字符替换<code class="fe mb mc md me b">-</code>来达到相同的效果。</p><p id="482c" class="pw-post-body-paragraph le lf iu lg b lh li ke lj lk ll kh lm ln lo lp lq lr ls lt lu lv lw lx ly lz in bi translated">如果需要，<code class="fe mb mc md me b">up</code>命令将下载<code class="fe mb mc md me b">eclipse-mosquitto</code>图像，设置容器等，然后启动<code class="fe mb mc md me b">docker-compose.yml</code>中描述的堆栈。默认情况下，服务将在前台启动，因此您可以看到服务器的任何日志输出。</p><pre class="kt ku kv kw gu nc me nd ne aw nf bi"><span id="a911" class="ng mg iu me b gz nh ni l nj nk">$ docker compose up -d</span></pre><p id="2656" class="pw-post-body-paragraph le lf iu lg b lh li ke lj lk ll kh lm ln lo lp lq lr ls lt lu lv lw lx ly lz in bi translated">以这种方式运行，它运行与终端分离的服务，它们将在后台运行。</p><p id="ccaa" class="pw-post-body-paragraph le lf iu lg b lh li ke lj lk ll kh lm ln lo lp lq lr ls lt lu lv lw lx ly lz in bi translated"><code class="fe mb mc md me b">up -d</code>命令几乎适用于长期的后台服务器。一个问题是，如果服务崩溃，它是否会自动重启。在云计算时代，我们被告诫要时刻为系统组件的故障做准备。目前，如果Mosquitto服务器崩溃，它不会自动重启。</p><p id="b082" class="pw-post-body-paragraph le lf iu lg b lh li ke lj lk ll kh lm ln lo lp lq lr ls lt lu lv lw lx ly lz in bi translated">要解决这个问题，请对<code class="fe mb mc md me b">docker-compose.yml</code>进行以下更改:</p><pre class="kt ku kv kw gu nc me nd ne aw nf bi"><span id="d603" class="ng mg iu me b gz nh ni l nj nk">services:<br/>    mosquitto:<br/>        image: eclipse-mosquitto<br/>        restart: unless-stopped    # Add this<br/>        ...</span></pre><p id="bcbe" class="pw-post-body-paragraph le lf iu lg b lh li ke lj lk ll kh lm ln lo lp lq lr ls lt lu lv lw lx ly lz in bi translated">标签<code class="fe mb mc md me b">restart</code>控制重启服务的条件。<code class="fe mb mc md me b">unless-stopped</code>将确保服务自动重启，除非您明确停止它。</p><p id="f930" class="pw-post-body-paragraph le lf iu lg b lh li ke lj lk ll kh lm ln lo lp lq lr ls lt lu lv lw lx ly lz in bi translated">如果你忘记创建<code class="fe mb mc md me b">mosquitto.conf</code>，你会得到这个错误:</p><blockquote class="nm nn no"><p id="97ac" class="le lf nl lg b lh li ke lj lk ll kh lm np lo lp lq nq ls lt lu nr lw lx ly lz in bi translated">来自守护程序的错误响应:无法创建shim任务:OCI运行时创建失败:runc创建失败:无法启动容器进程:容器初始化期间出错:将“/home/David/Projects/nodejs/mqtt/mosquitto . conf”挂载到位于“/mosquitto/config/mosquitto . conf”的rootfs时出错:mount/home/David/Projects/nodejs/mqtt/mosquitto . conf:/mosquitto/config/mosquitto . conf(via/proc/self/FD/6)，标志:0x 5000:0检查指定的主机路径是否存在，并且是预期的类型</p></blockquote><p id="066b" class="pw-post-body-paragraph le lf iu lg b lh li ke lj lk ll kh lm ln lo lp lq lr ls lt lu lv lw lx ly lz in bi translated">我提到这一点是因为我犯了几次这样的错误，也许其他人也会这样做。简单地创建文件，但是Docker已经创建了一个目录，您必须首先删除它。</p><h1 id="422d" class="mf mg iu bd mh mi mj mk ml mm mn mo mp kj mq kk mr km ms kn mt kp mu kq mv mw bi translated">停止、重新启动和更新容器</h1><p id="2b59" class="pw-post-body-paragraph le lf iu lg b lh mx ke lj lk my kh lm ln mz lp lq lr na lt lu lv nb lx ly lz in bi translated">使用<code class="fe mb mc md me b">docker compose</code>可以轻松管理您部署的服务。为此，您的终端会话必须在包含<code class="fe mb mc md me b">docker-compose.yml</code>文件的中。用于此目的的命令有:</p><pre class="kt ku kv kw gu nc me nd ne aw nf bi"><span id="0e1d" class="ng mg iu me b gz nh ni l nj nk"># Start the service<br/>$ docker compose up -d<br/><br/># Shut down the service<br/>$ docker compose down<br/><br/># Restart the service<br/>$ docker compose restart<br/><br/># Update the service<br/>$ docker compose stop<br/>$ docker compose pull<br/>$ docker compose up -d</span></pre><p id="f94c" class="pw-post-body-paragraph le lf iu lg b lh li ke lj lk ll kh lm ln lo lp lq lr ls lt lu lv lw lx ly lz in bi translated">如果Docker Hub上的容器映像已经更新，最后一个将更新服务。</p><h1 id="21df" class="mf mg iu bd mh mi mj mk ml mm mn mo mp kj mq kk mr km ms kn mt kp mu kq mv mw bi translated">在容器内运行Mosquitto命令</h1><p id="db69" class="pw-post-body-paragraph le lf iu lg b lh mx ke lj lk my kh lm ln mz lp lq lr na lt lu lv nb lx ly lz in bi translated">如果您运行<code class="fe mb mc md me b">docker compose ps</code>或<code class="fe mb mc md me b">docker ps -a</code>，您将看到容器已经启动。</p><p id="929e" class="pw-post-body-paragraph le lf iu lg b lh li ke lj lk ll kh lm ln lo lp lq lr ls lt lu lv lw lx ly lz in bi translated">为了查看它的运行情况，让我们听一个MQTT主题，查看日志文件，并发送一些消息。</p><p id="b8ad" class="pw-post-body-paragraph le lf iu lg b lh li ke lj lk ll kh lm ln lo lp lq lr ls lt lu lv lw lx ly lz in bi translated">在一个终端窗口中，您可以运行以下命令:</p><pre class="kt ku kv kw gu nc me nd ne aw nf bi"><span id="044a" class="ng mg iu me b gz nh ni l nj nk">$ sudo tail -f log/mosquitto.log <br/>[sudo] password for david: <br/>1665640941: Saving in-memory database to /mosquitto/data//mosquitto.db.<br/>1665641912: mosquitto version 2.0.15 terminating<br/>1665641912: Saving in-memory database to /mosquitto/data//mosquitto.db.<br/>1665642425: mosquitto version 2.0.15 starting<br/>1665642425: Config loaded from /mosquitto/config/mosquitto.conf.<br/>1665642425: Opening ipv4 listen socket on port 1883.<br/>1665642425: Opening ipv6 listen socket on port 1883.<br/>1665642425: mosquitto version 2.0.15 running<br/>1665642425: New connection from 172.29.0.1:37076 on port 1883.<br/>1665642425: Client auto-7F81B465-FE74-A7CC-7A16-854BC3AA23E0 disconnected, not authorised.</span></pre><p id="7742" class="pw-post-body-paragraph le lf iu lg b lh li ke lj lk ll kh lm ln lo lp lq lr ls lt lu lv lw lx ly lz in bi translated">这个监视日志。它必须用<code class="fe mb mc md me b">sudo</code>运行，因为这个目录是受保护的。</p><p id="0d67" class="pw-post-body-paragraph le lf iu lg b lh li ke lj lk ll kh lm ln lo lp lq lr ls lt lu lv lw lx ly lz in bi translated">接下来，如果我们尝试进入容器来运行命令，我们将得到以下消息:</p><pre class="kt ku kv kw gu nc me nd ne aw nf bi"><span id="fada" class="ng mg iu me b gz nh ni l nj nk">$ docker exec -it mqtt-mosquitto-1 bash <br/>OCI runtime exec failed: exec failed: unable to start container process: exec: "bash": executable file not found in $PATH: unknown</span></pre><p id="3ab3" class="pw-post-body-paragraph le lf iu lg b lh li ke lj lk ll kh lm ln lo lp lq lr ls lt lu lv lw lx ly lz in bi translated">这是因为<code class="fe mb mc md me b">eclipse-mosquitto</code>容器是在没有<code class="fe mb mc md me b">bash</code>的Alpine Linux上构建的。将<code class="fe mb mc md me b">bash</code>替换为<code class="fe mb mc md me b">sh</code>，您将在容器中看到一个命令提示符。</p><p id="c442" class="pw-post-body-paragraph le lf iu lg b lh li ke lj lk ll kh lm ln lo lp lq lr ls lt lu lv lw lx ly lz in bi translated">此命令应该开始监听特定主题的消息:</p><pre class="kt ku kv kw gu nc me nd ne aw nf bi"><span id="a922" class="ng mg iu me b gz nh ni l nj nk">mosquitto_sub -v -t test/message <br/>Connection error: Connection Refused: not authorised.</span></pre><p id="6ddc" class="pw-post-body-paragraph le lf iu lg b lh li ke lj lk ll kh lm ln lo lp lq lr ls lt lu lv lw lx ly lz in bi translated">但是，如你所见，缺乏授权。很高兴知道Mosquitto有授权系统。在生产使用中，MQTT服务不能对公众开放。</p><p id="80b3" class="pw-post-body-paragraph le lf iu lg b lh li ke lj lk ll kh lm ln lo lp lq lr ls lt lu lv lw lx ly lz in bi translated">一种快速解决方法是将配置文件更改为:</p><pre class="kt ku kv kw gu nc me nd ne aw nf bi"><span id="6442" class="ng mg iu me b gz nh ni l nj nk">allow_anonymous true<br/><br/>persistence true<br/>persistence_location /mosquitto/data/<br/>log_dest file /mosquitto/log/mosquitto.log<br/><br/>listener 1883</span></pre><p id="e6ab" class="pw-post-body-paragraph le lf iu lg b lh li ke lj lk ll kh lm ln lo lp lq lr ls lt lu lv lw lx ly lz in bi translated">我们所做的是允许世界上任何人使用这个MQTT代理。显然，这不是生产部署中要做的事情。它让我们继续这个快速教程。</p><p id="bd3c" class="pw-post-body-paragraph le lf iu lg b lh li ke lj lk ll kh lm ln lo lp lq lr ls lt lu lv lw lx ly lz in bi translated">我们必须重新启动服务(<code class="fe mb mc md me b">docker compose restart</code>)，然后重新运行命令。在容器内部运行命令的一个更简单的方法是:</p><pre class="kt ku kv kw gu nc me nd ne aw nf bi"><span id="aa47" class="ng mg iu me b gz nh ni l nj nk">$ docker exec -it mqtt-mosquitto-1 \<br/>            mosquitto_sub -v -t test/message</span></pre><p id="e073" class="pw-post-body-paragraph le lf iu lg b lh li ke lj lk ll kh lm ln lo lp lq lr ls lt lu lv lw lx ly lz in bi translated">这为<code class="fe mb mc md me b">test/message</code>主题设置了一个订阅者。发布到此主题的任何消息都将被打印出来。</p><p id="16d7" class="pw-post-body-paragraph le lf iu lg b lh li ke lj lk ll kh lm ln lo lp lq lr ls lt lu lv lw lx ly lz in bi translated">要发送消息，我们可以这样做:</p><pre class="kt ku kv kw gu nc me nd ne aw nf bi"><span id="bec0" class="ng mg iu me b gz nh ni l nj nk">$ docker exec -it mqtt-mosquitto-1 \<br/>            mosquitto_pub -t test/message -m 'Hello World!'</span></pre><p id="4eb9" class="pw-post-body-paragraph le lf iu lg b lh li ke lj lk ll kh lm ln lo lp lq lr ls lt lu lv lw lx ly lz in bi translated">这将向命名主题发布一条消息。在另一个命令窗口中，订户进程将打印以下内容:</p><pre class="kt ku kv kw gu nc me nd ne aw nf bi"><span id="77dd" class="ng mg iu me b gz nh ni l nj nk">test/message Hello World!</span></pre><p id="4db6" class="pw-post-body-paragraph le lf iu lg b lh li ke lj lk ll kh lm ln lo lp lq lr ls lt lu lv lw lx ly lz in bi translated">信息已发送，向世界问好。</p><h1 id="3e15" class="mf mg iu bd mh mi mj mk ml mm mn mo mp kj mq kk mr km ms kn mt kp mu kq mv mw bi translated">在Docker容器外使用Mosquitto客户端程序</h1><p id="c41b" class="pw-post-body-paragraph le lf iu lg b lh mx ke lj lk my kh lm ln mz lp lq lr na lt lu lv nb lx ly lz in bi translated">我们使用了两个Mosquitto客户端程序，<code class="fe mb mc md me b">mosquitto_sub</code>和<code class="fe mb mc md me b">mosquitto_pub</code>，在容器内部运行它们。<code class="fe mb mc md me b">docker exec</code>命令让我们进入正在运行的容器，并执行命令。虽然对于简单的演示很有用，但这根本不是生产系统的运行方式。相反，我们的应用程序将通过网络连接到服务。为了模拟这种情况，让我们在容器外运行Mosquitto客户端。</p><p id="af4e" class="pw-post-body-paragraph le lf iu lg b lh li ke lj lk ll kh lm ln lo lp lq lr ls lt lu lv lw lx ly lz in bi translated">通常我们可以在笔记本电脑上安装客户端。例如，我的笔记本电脑运行Ubuntu，我运行了这个命令:</p><pre class="kt ku kv kw gu nc me nd ne aw nf bi"><span id="2577" class="ng mg iu me b gz nh ni l nj nk">$ sudo apt install mosquitto-clients</span></pre><p id="3ce6" class="pw-post-body-paragraph le lf iu lg b lh li ke lj lk ll kh lm ln lo lp lq lr ls lt lu lv lw lx ly lz in bi translated">对于macOS来说，MacPorts或者家酿仓库里有包，在Windows上，建议看Chocolatey仓库。</p><p id="2329" class="pw-post-body-paragraph le lf iu lg b lh li ke lj lk ll kh lm ln lo lp lq lr ls lt lu lv lw lx ly lz in bi translated">这意味着我可以从笔记本电脑上运行Mosquitto命令，例如:</p><pre class="kt ku kv kw gu nc me nd ne aw nf bi"><span id="9c27" class="ng mg iu me b gz nh ni l nj nk">mosquitto_sub -h localhost -p 1883 -v -t test/message<br/>mosquitto_pub -h localhost -p 1883 -t test/message -m 'Hello World!'</span></pre><p id="9d4f" class="pw-post-body-paragraph le lf iu lg b lh li ke lj lk ll kh lm ln lo lp lq lr ls lt lu lv lw lx ly lz in bi translated"><code class="fe mb mc md me b">-h</code>选项指定Mosquitto服务器的主机名或IP地址。<code class="fe mb mc md me b">-p</code>选项指定端口号。您可能已经将Mosquitto部署到了一个远程服务器上，这就是您到达那里的方式。</p><h1 id="33eb" class="mf mg iu bd mh mi mj mk ml mm mn mo mp kj mq kk mr km ms kn mt kp mu kq mv mw bi translated">为Mosquitto实现身份验证</h1><p id="ed41" class="pw-post-body-paragraph le lf iu lg b lh mx ke lj lk my kh lm ln mz lp lq lr na lt lu lv nb lx ly lz in bi translated">mosquitto服务器支持几种身份验证。正如我们前面所说的，这对于生产部署是必要的。上面显示的配置文件允许匿名访问，这将任何安全感都抛到了九霄云外。</p><p id="00bf" class="pw-post-body-paragraph le lf iu lg b lh li ke lj lk ll kh lm ln lo lp lq lr ls lt lu lv lw lx ly lz in bi translated">我们要做的是建立一个简单的密码文件。</p><p id="277a" class="pw-post-body-paragraph le lf iu lg b lh li ke lj lk ll kh lm ln lo lp lq lr ls lt lu lv lw lx ly lz in bi translated">在<code class="fe mb mc md me b">mosquitto.conf</code>中添加这一行:</p><pre class="kt ku kv kw gu nc me nd ne aw nf bi"><span id="4978" class="ng mg iu me b gz nh ni l nj nk">password_file /mosquitto/etc/passwd</span></pre><p id="d12e" class="pw-post-body-paragraph le lf iu lg b lh li ke lj lk ll kh lm ln lo lp lq lr ls lt lu lv lw lx ly lz in bi translated">这表示使用命名文件来存储用户名/密码对。格式为<code class="fe mb mc md me b">username:password</code>，内容使用<code class="fe mb mc md me b">mosquitto_passwd</code>程序管理。</p><p id="cb7a" class="pw-post-body-paragraph le lf iu lg b lh li ke lj lk ll kh lm ln lo lp lq lr ls lt lu lv lw lx ly lz in bi translated">为了支持这一点，我们需要更改<code class="fe mb mc md me b">docker-compose.yml</code>来挂载一个新目录:</p><pre class="kt ku kv kw gu nc me nd ne aw nf bi"><span id="bbbc" class="ng mg iu me b gz nh ni l nj nk">services:<br/>    mosquitto:<br/>        image: eclipse-mosquitto<br/>        ...<br/>        volumes:<br/>            ...<br/>            - ./etc:/mosquitto/etc/</span></pre><p id="73ba" class="pw-post-body-paragraph le lf iu lg b lh li ke lj lk ll kh lm ln lo lp lq lr ls lt lu lv lw lx ly lz in bi translated">我们将一个目录装入容器，因此必须创建该目录:</p><pre class="kt ku kv kw gu nc me nd ne aw nf bi"><span id="da8a" class="ng mg iu me b gz nh ni l nj nk">$ mkdir etc<br/>$ touch etc/passwd</span></pre><p id="0e1c" class="pw-post-body-paragraph le lf iu lg b lh li ke lj lk ll kh lm ln lo lp lq lr ls lt lu lv lw lx ly lz in bi translated">接下来，您可以启动或重新启动Mosquitto容器。在<code class="fe mb mc md me b">passwd</code>文件中没有定义用户，所以让我们创建一个。</p><pre class="kt ku kv kw gu nc me nd ne aw nf bi"><span id="716f" class="ng mg iu me b gz nh ni l nj nk">$ docker exec -it mqtt-mosquitto-1 \<br/>          mosquitto_passwd /mosquitto/etc/passwd henry <br/>Password: <br/>Reenter password:</span></pre><p id="30e0" class="pw-post-body-paragraph le lf iu lg b lh li ke lj lk ll kh lm ln lo lp lq lr ls lt lu lv lw lx ly lz in bi translated">当然，这类似于Unix/Linux/etc <code class="fe mb mc md me b">passwd</code>命令。</p><p id="4213" class="pw-post-body-paragraph le lf iu lg b lh li ke lj lk ll kh lm ln lo lp lq lr ls lt lu lv lw lx ly lz in bi translated">此时有必要重启Mosquitto容器。在测试中，服务器似乎不会识别新用户或更改密码，直到它重新启动。</p><p id="79e3" class="pw-post-body-paragraph le lf iu lg b lh li ke lj lk ll kh lm ln lo lp lq lr ls lt lu lv lw lx ly lz in bi translated">此时，您可以通过添加用户名和密码来订阅主题:</p><pre class="kt ku kv kw gu nc me nd ne aw nf bi"><span id="9b60" class="ng mg iu me b gz nh ni l nj nk">mosquitto_sub -u henry --pw passw0rd -h localhost -p 1883 \<br/>          -v -t test/message</span></pre><p id="2b77" class="pw-post-body-paragraph le lf iu lg b lh li ke lj lk ll kh lm ln lo lp lq lr ls lt lu lv lw lx ly lz in bi translated">新选项是指定用户名的<code class="fe mb mc md me b">-u</code>和指定密码的<code class="fe mb mc md me b">--pw</code>。</p><p id="02c6" class="pw-post-body-paragraph le lf iu lg b lh li ke lj lk ll kh lm ln lo lp lq lr ls lt lu lv lw lx ly lz in bi translated">发送消息需要类似的改变:</p><pre class="kt ku kv kw gu nc me nd ne aw nf bi"><span id="0a0b" class="ng mg iu me b gz nh ni l nj nk">$ mosquitto_pub -u henry -P passw0rd -h localhost -p 1883 \<br/>            -t test/message -m 'Hello World!'</span></pre><p id="c2a7" class="pw-post-body-paragraph le lf iu lg b lh li ke lj lk ll kh lm ln lo lp lq lr ls lt lu lv lw lx ly lz in bi translated"><code class="fe mb mc md me b">-P</code>选项是指定<code class="fe mb mc md me b">--pw</code>的另一种方式。如前所述，运行该命令将导致消息由<code class="fe mb mc md me b">mosquitto_sub</code>打印出来。</p><h1 id="ecea" class="mf mg iu bd mh mi mj mk ml mm mn mo mp kj mq kk mr km ms kn mt kp mu kq mv mw bi translated">摘要</h1><p id="a558" class="pw-post-body-paragraph le lf iu lg b lh mx ke lj lk my kh lm ln mz lp lq lr na lt lu lv nb lx ly lz in bi translated">Mosquitto服务器支持的功能比我们在本文中提到的多得多。例如，我们可以使用SSL证书对用户进行身份验证，每个用户都可以有一个ACL来限制他们的能力。另一个重要的特性是持久化数据的能力。</p><p id="ddb6" class="pw-post-body-paragraph le lf iu lg b lh li ke lj lk ll kh lm ln lo lp lq lr ls lt lu lv lw lx ly lz in bi translated">在Docker中设置Mosquitto服务器非常简单。这样做只需要一些配置文件和设置。</p></div><div class="ab cl ns nt hy nu" role="separator"><span class="nv bw bk nw nx ny"/><span class="nv bw bk nw nx ny"/><span class="nv bw bk nw nx"/></div><div class="in io ip iq ir"><p id="f32e" class="pw-post-body-paragraph le lf iu lg b lh li ke lj lk ll kh lm ln lo lp lq lr ls lt lu lv lw lx ly lz in bi translated"><em class="nl">最初发表于</em><a class="ae ma" href="https://techsparx.com/software-development/mqtt/mosquitto-docker.html" rel="noopener ugc nofollow" target="_blank"><em class="nl">https://techsparx.com</em></a><em class="nl">。</em></p></div><div class="ab cl ns nt hy nu" role="separator"><span class="nv bw bk nw nx ny"/><span class="nv bw bk nw nx ny"/><span class="nv bw bk nw nx"/></div><div class="in io ip iq ir"><h2 id="c82a" class="ng mg iu bd mh nz oa dn ml ob oc dp mp ln od oe mr lr of og mt lv oh oi mv ja bi translated">关于作者</h2><figure class="kt ku kv kw gu kx gi gj paragraph-image"><div class="gi gj oj"><img src="../Images/424ff7c92ea446f0b4814439d7141d2e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1280/format:webp/0*ZJlAW0fHjXK860XX.jpg"/></div></figure><p id="ae67" class="pw-post-body-paragraph le lf iu lg b lh li ke lj lk ll kh lm ln lo lp lq lr ls lt lu lv lw lx ly lz in bi translated"><a class="ae ma" href="https://davidherron.com/" rel="noopener ugc nofollow" target="_blank"> <strong class="lg je"> <em class="nl">大卫·赫伦</em></strong></a><strong class="lg je"><em class="nl"/></strong><em class="nl">:大卫·赫伦是一位专注于技术明智使用的作家和软件工程师。他对太阳能、风能和电动汽车等清洁能源技术特别感兴趣。David在硅谷从事了近30年的软件工作，从电子邮件系统到视频流，再到Java编程语言，他已经出版了几本关于Node.js编程和电动汽车的书籍。</em></p></div></div>    
</body>
</html>