<html>
<head>
<title>Securely access Azure SQL Database from Azure Synapse</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">从Azure Synapse安全地访问Azure SQL数据库</h1>
<blockquote>原文：<a href="https://itnext.io/securely-access-azure-sql-database-from-azure-synapse-6dbee7afc30e?source=collection_archive---------2-----------------------#2021-07-15">https://itnext.io/securely-access-azure-sql-database-from-azure-synapse-6dbee7afc30e?source=collection_archive---------2-----------------------#2021-07-15</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="9f18" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">使用Azure Key Vault从Azure Synapse中的Spark池进行安全访问</h2></div><p id="f799" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><a class="ae lb" href="https://docs.microsoft.com/sql/connect/spark/connector?view=sql-server-ver15&amp;WT.mc_id=data-34417-abhishgu" rel="noopener ugc nofollow" target="_blank">Apache Spark connector for Azure SQL Database(和SQL Server) </a>使这些数据库能够用作Apache Spark作业的输入数据源和输出数据接收器。您可以使用Azure Synapse Analytics 中的连接器<a class="ae lb" href="https://docs.microsoft.com/azure/synapse-analytics/spark/data-sources/apache-spark-sql-connector?WT.mc_id=data-34417-abhishgu" rel="noopener ugc nofollow" target="_blank">对实时交易数据进行大数据分析，并为即席查询或报告保存结果。</a></p><p id="29f8" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在撰写本文时，Azure SQL connector没有通过Azure Synapse Analytics提供链接服务或AAD传递支持。但是你可以使用其他选项，比如<a class="ae lb" href="https://docs.microsoft.com/azure/synapse-analytics/spark/data-sources/apache-spark-sql-connector?WT.mc_id=data-34417-abhishgu#azure-active-directory-authentication" rel="noopener ugc nofollow" target="_blank"> Azure Active Directory认证</a>或者通过直接SQL认证(基于用户名和密码)。一种安全的方法是将Azure SQL数据库证书存储在Azure Key Vault中(作为秘密)——这就是这篇简短的博客文章所涵盖的内容。</p><figure class="ld le lf lg gt lh gh gi paragraph-image"><div role="button" tabindex="0" class="li lj di lk bf ll"><div class="gh gi lc"><img src="../Images/2895a3d31217c90c9425303920bcd48e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*XIRD2wfy-Knm0_es"/></div></div><figcaption class="lo lp gj gh gi lq lr bd b be z dk translated">照片由<a class="ae lb" href="https://unsplash.com/@elcarito?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">埃尔卡里托</a>在<a class="ae lb" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄</figcaption></figure><p id="d0a7" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">假设您已经创建了<a class="ae lb" href="https://docs.microsoft.com/azure/synapse-analytics/quickstart-create-workspace?WT.mc_id=data-34417-abhishgu" rel="noopener ugc nofollow" target="_blank"> Azure Synapse工作区</a>和<a class="ae lb" href="https://docs.microsoft.com/azure/azure-sql/database/single-database-create-quickstart?tabs=azure-portal&amp;WT.mc_id=data-34417-abhishgu" rel="noopener ugc nofollow" target="_blank"> Azure SQL数据库</a>，您需要做的就是:</p><ol class=""><li id="262a" class="ls lt iq kh b ki kj kl km ko lu ks lv kw lw la lx ly lz ma bi translated">创建一个Azure密钥库，并添加一个密码来存储Azure SQL数据库连接信息。</li><li id="9456" class="ls lt iq kh b ki mb kl mc ko md ks me kw mf la lx ly lz ma bi translated">在Azure Synapse Workspace中为您的Azure Key Vault创建链接服务。</li><li id="2435" class="ls lt iq kh b ki mb kl mc ko md ks me kw mf la lx ly lz ma bi translated">向Azure Key Vault提供Azure Synapse workspace托管服务身份的适当权限</li></ol><h1 id="c8f4" class="mg mh iq bd mi mj mk ml mm mn mo mp mq jw mr jx ms jz mt ka mu kc mv kd mw mx bi translated">下面是该过程的一个演示</h1><p id="25ca" class="pw-post-body-paragraph kf kg iq kh b ki my jr kk kl mz ju kn ko na kq kr ks nb ku kv kw nc ky kz la ij bi translated"><a class="ae lb" href="https://docs.microsoft.com/azure/key-vault/general/quick-create-portal?WT.mc_id=data-34417-abhishgu" rel="noopener ugc nofollow" target="_blank">创建一个天蓝色密钥库</a>和<a class="ae lb" href="https://docs.microsoft.com/azure/key-vault/secrets/quick-create-portal?WT.mc_id=data-34417-abhishgu#add-a-secret-to-key-vault" rel="noopener ugc nofollow" target="_blank">添加一个秘密</a>。</p><figure class="ld le lf lg gt lh gh gi paragraph-image"><div role="button" tabindex="0" class="li lj di lk bf ll"><div class="gh gi nd"><img src="../Images/cd40420791c39a2b18b0ef9316fb0dc4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*onleXNzNkyX2hiPXWDjNcQ.png"/></div></div><figcaption class="lo lp gj gh gi lq lr bd b be z dk translated">Azure密钥库秘密(图片由作者提供)</figcaption></figure><blockquote class="ne nf ng"><p id="aaa9" class="kf kg nh kh b ki kj jr kk kl km ju kn ni kp kq kr nj kt ku kv nk kx ky kz la ij bi translated"><em class="iq">在这种情况下，我已经存储了整个JDBC连接字符串，但是您也可以选择只存储密码。</em></p></blockquote><p id="01d6" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">要从Azure Key Vault中检索机密，推荐的方法是创建一个到您的Azure Key Vault的链接服务。此外，确保<a class="ae lb" href="https://docs.microsoft.com/azure/synapse-analytics/security/synapse-workspace-managed-identity?WT.mc_id=data-34417-abhishgu" rel="noopener ugc nofollow" target="_blank"> Synapse workspace托管服务身份(MSI) </a>在您的Azure Key Vault上拥有<code class="fe nl nm nn no b">Secret Get</code>权限。这将允许Synapse使用Synapse workspace托管服务身份向Azure Key Vault进行身份验证。</p><blockquote class="ne nf ng"><p id="cb1f" class="kf kg nh kh b ki kj jr kk kl km ju kn ni kp kq kr nj kt ku kv nk kx ky kz la ij bi translated"><em class="iq">您还可以使用您的用户Azure Active Directory凭据进行身份验证。</em></p></blockquote><p id="fe41" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在Azure Synapse Workspace中创建链接服务:</p><figure class="ld le lf lg gt lh gh gi paragraph-image"><div role="button" tabindex="0" class="li lj di lk bf ll"><div class="gh gi np"><img src="../Images/ba47cbf541eba5ccf94e81ccc837267a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*6EVv7UWtE4zryFNoKrqyyA.png"/></div></div><figcaption class="lo lp gj gh gi lq lr bd b be z dk translated">Azure Key Vault链接服务(图片由作者提供)</figcaption></figure><p id="d0c5" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><a class="ae lb" href="https://docs.microsoft.com/azure/key-vault/general/assign-access-policy-portal?WT.mc_id=data-34417-abhishgu" rel="noopener ugc nofollow" target="_blank">授予Azure Synapse workspace服务托管身份对您的Azure Key Vault的适当访问权限</a>:</p><figure class="ld le lf lg gt lh gh gi paragraph-image"><div role="button" tabindex="0" class="li lj di lk bf ll"><div class="gh gi nq"><img src="../Images/fcc282608d5c8f11d85f101fc561b73d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Qd39K5NlK0hZ6mb9hSDMbg.png"/></div></div><figcaption class="lo lp gj gh gi lq lr bd b be z dk translated">Azure Key Vault访问策略配置(图片由作者提供)</figcaption></figure><p id="fe69" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在<code class="fe nl nm nn no b">Secret</code>上选择<code class="fe nl nm nn no b">Get</code>权限:</p><figure class="ld le lf lg gt lh gh gi paragraph-image"><div role="button" tabindex="0" class="li lj di lk bf ll"><div class="gh gi nr"><img src="../Images/d0ffef515f7b746ca74e4e99fd527bfc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*TCHtYAiD1zqFN2Tzpe8pgw.png"/></div></div><figcaption class="lo lp gj gh gi lq lr bd b be z dk translated">Azure Key Vault访问策略配置(图片由作者提供)</figcaption></figure><p id="c5fc" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">搜索Synapse Workspace托管服务身份，它与工作区的名称相同</p><figure class="ld le lf lg gt lh gh gi paragraph-image"><div role="button" tabindex="0" class="li lj di lk bf ll"><div class="gh gi ns"><img src="../Images/eea368293aa26543ce9f0215df0ec31b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*goOr7wkkxU0F3ckgY82-FA.png"/></div></div><figcaption class="lo lp gj gh gi lq lr bd b be z dk translated">Azure Key Vault访问策略配置(图片由作者提供)</figcaption></figure><p id="15ce" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">添加策略:</p><figure class="ld le lf lg gt lh gh gi paragraph-image"><div role="button" tabindex="0" class="li lj di lk bf ll"><div class="gh gi nt"><img src="../Images/216a04f756c214ead5b86cdba5a240e4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*23Ur0Lm7EfdzSbdJwoo0_g.png"/></div></div><figcaption class="lo lp gj gh gi lq lr bd b be z dk translated">Azure Key Vault访问策略配置(图片由作者提供)</figcaption></figure><p id="b501" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">点击<strong class="kh ir">保存</strong>确认:</p><figure class="ld le lf lg gt lh gh gi paragraph-image"><div role="button" tabindex="0" class="li lj di lk bf ll"><div class="gh gi nu"><img src="../Images/dc729e619ac2cbde107e51c4cf81e7e0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*cQ8MUc5kR-NT8vL7N9RPYw.png"/></div></div><figcaption class="lo lp gj gh gi lq lr bd b be z dk translated">Azure Key Vault访问策略配置(图片由作者提供)</figcaption></figure><h1 id="938b" class="mg mh iq bd mi mj mk ml mm mn mo mp mq jw mr jx ms jz mt ka mu kc mv kd mw mx bi translated">让我们看看如何使用这个…</h1><blockquote class="ne nf ng"><p id="588e" class="kf kg nh kh b ki kj jr kk kl km ju kn ni kp kq kr nj kt ku kv nk kx ky kz la ij bi translated"><em class="iq">我将以在Synapse Spark pools中使用</em> <code class="fe nl nm nn no b"><em class="iq">pyspark</em></code> <em class="iq">为例。</em></p></blockquote><p id="449c" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">默认情况下，Synapse使用Azure Active Directory (AAD)直通进行资源之间的身份验证。如果您需要使用其他凭据连接到资源，<a class="ae lb" href="https://docs.microsoft.com/azure/synapse-analytics/spark/apache-spark-secure-credentials-with-tokenlibrary?pivots=programming-language-python&amp;WT.mc_id=data-34417-abhishgu" rel="noopener ugc nofollow" target="_blank">直接使用令牌库</a> —这简化了检索SAS令牌、AAD令牌、连接字符串以及存储在链接服务中或来自Azure Key Vault的机密的过程。</p><p id="647a" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">要从Azure Key Vault中检索存储的秘密，请使用<code class="fe nl nm nn no b">TokenLibrary.getSecret()</code>函数。这里有一个<a class="ae lb" href="https://docs.microsoft.com/azure/synapse-analytics/spark/apache-spark-secure-credentials-with-tokenlibrary?pivots=programming-language-python&amp;WT.mc_id=data-34417-abhishgu#getsecret" rel="noopener ugc nofollow" target="_blank"> python的例子</a>，但同样适用于<a class="ae lb" href="https://docs.microsoft.com/azure/synapse-analytics/spark/apache-spark-secure-credentials-with-tokenlibrary?pivots=programming-language-csharp&amp;WT.mc_id=data-34417-abhishgu#getsecret" rel="noopener ugc nofollow" target="_blank"> C# </a>或<a class="ae lb" href="https://docs.microsoft.com/azure/synapse-analytics/spark/apache-spark-secure-credentials-with-tokenlibrary?pivots=programming-language-scala&amp;WT.mc_id=data-34417-abhishgu#getsecret" rel="noopener ugc nofollow" target="_blank"> Scala </a>。</p><p id="4a21" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">例如，要从<code class="fe nl nm nn no b">SalesLT.Customer</code>表(AdventureWorks示例数据库的一部分)中访问数据，可以使用以下代码:</p><pre class="ld le lf lg gt nv no nw nx aw ny bi"><span id="b81b" class="nz mh iq no b gy oa ob l oc od">url = TokenLibrary.getSecret("&lt;Azure Key Vault name&gt;", "&lt;Secret name&gt;", "&lt;Linked Service name&gt;")</span><span id="a479" class="nz mh iq no b gy oe ob l oc od">dbtable = "SalesLT.Customer"</span><span id="f2eb" class="nz mh iq no b gy oe ob l oc od">customers = spark.read \<br/>    .format("com.microsoft.sqlserver.jdbc.spark") \<br/>    .option("url", url) \<br/>    .option("dbtable", dbtable) \<br/>    .load()</span><span id="bebf" class="nz mh iq no b gy oe ob l oc od">print(customers.count())<br/>customers.show(5)</span></pre><p id="1d80" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这就是全部了！</p></div></div>    
</body>
</html>