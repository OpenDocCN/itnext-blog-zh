<html>
<head>
<title>React Native — Background Location Tracking without Timeout and with App killed</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">本地反应—后台位置跟踪，无超时，应用程序已关闭</h1>
<blockquote>原文：<a href="https://itnext.io/react-native-background-location-tracking-without-timeout-and-with-app-killed-3dbfbc80ad01?source=collection_archive---------0-----------------------#2021-01-30">https://itnext.io/react-native-background-location-tracking-without-timeout-and-with-app-killed-3dbfbc80ad01?source=collection_archive---------0-----------------------#2021-01-30</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="1c46" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">小背景:<br/> </strong>几个月前，我用Java开发了一个原生的Android应用程序，要求在后台或前台跟踪用户的位置，即使应用程序被关闭、关闭。在Android 8 (API级别26)之前，这是很容易实现的，在用户不知情的情况下，在后台<strong class="jp ir"> <em class="kl">获取用户的位置是没有限制的。<br/>自Android 8以来，开发者和Android用户的情况发生了变化。现在，如果跟踪用户位置的应用程序后台服务发出太多GPS请求，或者在后台耗尽电池电量，这些服务就会被强行终止。这里进入android的<strong class="jp ir">电池优化</strong>功能。</em></strong></p><p id="dabe" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在这个时间点上，我有一个onePlus 7T，这是一个Android 10设备，直到我从该应用程序的设置中禁用了电池优化，它不会让应用程序跟踪用户。我使用了一个每10秒运行一次的<a class="ae km" href="https://developer.android.com/reference/android/app/job/JobScheduler" rel="noopener ugc nofollow" target="_blank"> JobScheduler </a>来从设备获取GPS位置。我有一个使用ForegroundService的选项，但问题是用户无法关闭或滑动的持续通知。就像Aarogya Setu App里的那个。<em class="kl">(禁用电池优化对MVP来说已经足够好了)</em></p><figure class="ko kp kq kr gt ks gh gi paragraph-image"><div role="button" tabindex="0" class="kt ku di kv bf kw"><div class="gh gi kn"><img src="../Images/8aa16992a2dbb5ac6b4db499680f30f4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*UQjE-QzuV82MreQJuaFTcQ.jpeg"/></div></div></figure></div><div class="ab cl kz la hu lb" role="separator"><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le"/></div><div class="ij ik il im in"><p id="fdd5" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我被要求在React-Native中为Android和iOS构建相同的应用程序。</p><p id="4735" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在过去的几天里，我努力从设备上访问地理位置，这里是我面临的一些问题以及我如何提出解决方案(特别是针对Android)。</p><ol class=""><li id="a768" class="lg lh iq jp b jq jr ju jv jy li kc lj kg lk kk ll lm ln lo bi translated"><strong class="jp ir"> <em class="kl">应用程序关闭时保持服务运行——不禁用电池优化</em> </strong></li><li id="627a" class="lg lh iq jp b jq lp ju lq jy lr kc ls kg lt kk ll lm ln lo bi translated"><strong class="jp ir">在某个时间点之后，图书馆失去了对GPS的访问。 </strong></li><li id="34a9" class="lg lh iq jp b jq lp ju lq jy lr kc ls kg lt kk ll lm ln lo bi translated"><strong class="jp ir"> <em class="kl">当我运行一个连续循环的前台服务，每10秒访问一次GPS位置时，这并没有让应用程序关闭或关闭。它影响了React组件的生命周期。</em>T25】</strong></li></ol></div><div class="ab cl kz la hu lb" role="separator"><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le"/></div><div class="ij ik il im in"><h2 id="b96c" class="lu lv iq bd lw lx ly dn lz ma mb dp mc jy md me mf kc mg mh mi kg mj mk ml mm bi translated"><strong class="ak"> <em class="mn"> 1。当应用程序关闭时，保持服务运行——不禁用电池优化</em> </strong></h2><p id="537a" class="pw-post-body-paragraph jn jo iq jp b jq mo js jt ju mp jw jx jy mq ka kb kc mr ke kf kg ms ki kj kk ij bi translated">我从第一次的错误中吸取了教训，没有一种直接的(合法的)方法可以在用户不知情的情况下保持后台服务的运行。所以我不得不使用ForegroundServices来保持进程运行，这也让用户知道为什么这个服务在运行，即使在他们关闭应用程序之后。<br/>我为此使用了<a class="ae km" href="https://www.npmjs.com/package/@supersami/rn-foreground-service" rel="noopener ugc nofollow" target="_blank"><strong class="jp ir"><em class="kl">@ supersami/rn-前台-服务</em> </strong> </a> <strong class="jp ir"> <em class="kl"> </em> </strong>库<strong class="jp ir"> <em class="kl"> </em> </strong>。这里有一个关于如何使用上面的库创建一个可以做后台任务的持久服务的博客。(<a class="ae km" href="https://medium.com/javascript-in-plain-english/react-native-foreground-service-f7fc8e617fba" rel="noopener">链接到博客</a>)</p></div><div class="ab cl kz la hu lb" role="separator"><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le"/></div><div class="ij ik il im in"><h2 id="561e" class="lu lv iq bd lw lx ly dn lz ma mb dp mc jy md me mf kc mg mh mi kg mj mk ml mm bi translated"><strong class="ak"> <em class="mn"> 3。当我运行一个连续循环的前台服务，每10秒访问一次GPS位置时，这并没有让应用程序关闭或关闭。它影响了React组件的生命周期。</em> </strong></h2><p id="ddd2" class="pw-post-body-paragraph jn jo iq jp b jq mo js jt ju mp jw jx jy mq ka kb kc mr ke kf kg ms ki kj kk ij bi translated">如果你阅读了库的上述博客，它要求你在react组件的生命周期之外初始化前台服务或后台任务。但是当我使用<strong class="jp ir"><em class="kl">@ react-native-community/geolocation</em></strong>和<strong class="jp ir"><em class="kl">react-native-geolocation-service</em></strong>来访问后台服务中的GPS位置时，它通常只在react组件的生命周期开始时进行初始化，从而使后台服务进入组件的生命周期。每一次，服务循环使用组件来重新渲染，你现在可以想象为什么我不能关闭应用程序，因为我让我的服务每10秒循环一次。<br/>所以我尝试了这另一个库<a class="ae km" href="https://www.npmjs.com/package/react-native-location" rel="noopener ugc nofollow" target="_blank"><strong class="jp ir"><em class="kl">react-native-location</em></strong></a><strong class="jp ir"><em class="kl"/></strong>它与后台任务配合得天衣无缝。</p></div><div class="ab cl kz la hu lb" role="separator"><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le"/></div><div class="ij ik il im in"><h2 id="33eb" class="lu lv iq bd lw lx ly dn lz ma mb dp mc jy md me mf kc mg mh mi kg mj mk ml mm bi translated">2.<strong class="ak"> <em class="mn">每10秒访问一次设备GPS，即使应用程序被终止也不会请求超时</em> </strong></h2><p id="32e1" class="pw-post-body-paragraph jn jo iq jp b jq mo js jt ju mp jw jx jy mq ka kb kc mr ke kf kg ms ki kj kk ij bi translated">以上所有的东西，在Android 10以上的设备上是行不通的，即使你正确实现了。因为，从Android 10开始，开发者应该请求另一个名为<code class="fe mt mu mv mw b"><a class="ae km" href="https://developer.android.com/training/location/receive-location-updates#request-background-location" rel="noopener ugc nofollow" target="_blank">ACCESS_BACKGROUND_LOCATION</a></code>的权限来访问设备的位置，如果用户拒绝该权限，你就不能一次又一次地调用该权限请求。安卓不允许。所以你只有一次机会，所以要有充分的理由让它变得有价值，这样用户才能理解许可的重要性。<br/>这就是<strong class="jp ir"><em class="kl"/></strong>超时<strong class="jp ir"> <em class="kl">发生的原因。</em> </strong>我没有请求用户的许可，但是我请求了GPS定位。</p></div><div class="ab cl kz la hu lb" role="separator"><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le"/></div><div class="ij ik il im in"><h1 id="44e3" class="mx lv iq bd lw my mz na lz nb nc nd mc ne nf ng mf nh ni nj mi nk nl nm ml nn bi translated">代码:</h1><figure class="ko kp kq kr gt ks"><div class="bz fp l di"><div class="no np l"/></div><figcaption class="nq nr gj gh gi ns nt bd b be z dk translated">访问后台位置的权限请求</figcaption></figure><figure class="ko kp kq kr gt ks"><div class="bz fp l di"><div class="no np l"/></div><figcaption class="nq nr gj gh gi ns nt bd b be z dk translated">带位置跟踪的前台服务</figcaption></figure></div><div class="ab cl kz la hu lb" role="separator"><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le"/></div><div class="ij ik il im in"><h1 id="3ef1" class="mx lv iq bd lw my mz na lz nb nc nd mc ne nf ng mf nh ni nj mi nk nl nm ml nn bi translated">结果:</h1><figure class="ko kp kq kr gt ks gh gi paragraph-image"><div class="gh gi nu"><img src="../Images/25853ef56ee1d68e93ad4dd8fd7649fd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1382/format:webp/1*gTXf6ig2kQqlsY5KX4PIgA.png"/></div><figcaption class="nq nr gj gh gi ns nt bd b be z dk translated">这是应用程序被杀的时候，位置更新在接下来的2-3个小时内持续出现。</figcaption></figure></div><div class="ab cl kz la hu lb" role="separator"><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le"/></div><div class="ij ik il im in"><p id="9682" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">感谢您阅读本文，希望这对您有所帮助。我记录了这一点，因为我几乎在任何地方都没有找到任何合理的解决方案。花了将近两天的时间进行自我反省，并结合我的一些原生android开发经验，将React-Native的点点滴滴联系起来。</p><p id="53b3" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我实际上记录了我的母语学习旅程，我遇到了什么样的问题，我在哪里找到了我的解决方案，我从这些问题中学到了什么。这个博客只是一个具体问题的例子。请让我知道你是否喜欢这种形式的博客，这样我可以写更多。</p><p id="0f0f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">你可以在推特上找到我:<a class="ae km" href="https://twitter.com/sourav_bz" rel="noopener ugc nofollow" target="_blank">https://twitter.com/sourav_bz</a></p></div><div class="ab cl kz la hu lb" role="separator"><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le"/></div><div class="ij ik il im in"><p id="0abd" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">编辑:这个博客每周有近500-600的外部浏览量，你们中的一些人通过Twitter DMs联系我，帮助你完成你的项目(与位置服务相关)。因此，这里有一个3个问题的简短调查，它将帮助我理解这里的一个大问题。潜在的，这将反过来帮助我建立大众的东西，并把它给你的帮助。<br/><a class="ae km" href="https://forms.gle/5fV3kC86y7gFPJuv5" rel="noopener ugc nofollow" target="_blank">https://forms.gle/5fV3kC86y7gFPJuv5</a></p><p id="46a8" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果你想和我联系，请发邮件到s.kumar001997@gmail.com，不要犹豫。</p></div></div>    
</body>
</html>