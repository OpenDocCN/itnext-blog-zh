# 介绍 Luna——JavaScript 测试做对了

> 原文：<https://itnext.io/introducing-luna-javascript-testing-done-right-437a738cc1ed?source=collection_archive---------5----------------------->

![](img/79f95736d68734736beea64a9554b2a2.png)

## 问题是

我相信你在读这篇文章的时候会想:

> 已经有一百万个 JavaScript 测试框架。为什么这个世界需要另一个？

这也是我的第一个想法。我正在做一个项目，决定要添加一些单元测试。我试过 AVA。然后我试了胶带。然后是摩卡。那就开玩笑吧。三个小时后，我又回到了起点。盒子里什么都没有。我陷入了与 Babel 配置、ES6 模块导入/解析失败、外部依赖、测试配置等的斗争中。我越来越沮丧。

作为一个已经写了很长时间软件的人，如果我有这么多的麻烦，那么我只能想象新开发人员会经历什么。我怀疑很多人放弃了，最终根本没有写任何测试。

## 各种各样的工具

现在是读者插话的时候了:

> 但是先生，很明显你一定是个白痴。我使用这些框架，它们非常容易设置。启动和运行需要几分钟时间。

恭喜你。我为你高兴。我不是说我的经历是每个人都分享的。这真的取决于你从事的具体项目。

无论哪种方式，我们至少应该能够同意，所有不同的 JavaScript 构建工具使得向您的项目添加测试变得更加困难。

Karma、Mocha、Jasmine、Jest、Sinon、Chai、、Babel、Gulp、Grunt、Webpack、Buble、Rollup、jsdom 等等。

在编写单个测试之前，您必须编写大量的样板代码。我在 [Karma 文档](https://karma-runner.github.io/2.0/config/configuration-file.html)中数了 50 多个配置选项，其中许多都有自己的子选项集！事实上，Karma 是其他单元测试运行者的运行者，而[的介绍视频](https://www.youtube.com/watch?v=MVw8N3hTfCI)大约 15 分钟长，这应该告诉你你需要知道的一切。

大多数测试框架需要插件或其他工具来做简单的事情，比如代码覆盖。它可能不一定很难添加，但它仍然是您必须采取的额外步骤。

尽管大多数 JavaScript 代码都是为在浏览器中运行而编写的，但在一些测试框架中，使用浏览器进行测试并不容易，甚至是不可能的。想一想。他们建议你使用 jsdom，一个在服务器端模拟浏览器 dom 的节点工具。当然，这在某些情况下可能行得通，但是测试不应该默认为浏览器设计吗？

## 一个解决方案

我最近写了很多 go，我真正喜欢的是 go 的测试是如何直接内置在语言中的。您可以创建一个文件，添加一些测试，并运行它们，而不必安装任何外部依赖项。

这是激发我创作露娜的部分原因。我一直在寻找一个能够正常工作的单元测试框架，并且不需要任何疯狂的配置或外部库。我希望能够在代码中的任何地方添加测试函数，运行测试，并查看结果。

结果**露娜根本没有配置**。

为了达到这个目的，它对你的工作环境做了一些假设。您的测试必须写成 ES6 模块，您的代码也应该如此。除了 JSX，露娜不传输任何源代码。这意味着如果你正在使用 Coffeescript 或 Typescript，你现在就要倒霉了。

## 它是如何工作的？

Luna 搜索任何名字以`test`开头的函数，这些函数是从你让它查找的任何文件和目录中导出的。然后，它使用 rollup 的 API 在内存中动态创建一个测试运行包。每个测试函数都被调用，并通过一个`assert`方法传递一个对象的实例。使用控制台日志将结果传递回主进程。

这意味着一切都是独立的，不需要全局变量。此外，您不需要导入任何定制库来运行您的测试，因为测试函数本身已经从您的代码中提取出来了。

## 其他好吃的

*   由于 Luna 的工作方式，你可以在任何你想要的地方包含测试函数，包括在你的源文件中。 ***注意:*** *只有当您在构建您的产品包时使用树抖动来剥离测试代码时，才推荐这样做。*
*   浏览器测试是内置的，默认情况下运行。它使用[木偶师](https://github.com/GoogleChrome/puppeteer)来运行最新版本的 Chromium。
*   它使用背压队列来支持并发性，以允许测试并行运行。如果一些测试是 CPU 密集型的或者需要一段时间来运行，这是很有用的。
*   它自动生成代码覆盖报告，而不需要安装任何额外的库(通过`--no-coverage`标志来禁用它们)。
*   当你的测试有错误时，Luna 会自动翻译并应用源代码映射到代码覆盖报告和堆栈跟踪，即使 puppeter[不支持它们](https://github.com/GoogleChrome/puppeteer/issues/985)。
*   Luna 使用的 assert 函数受到了 [power-assert](https://github.com/power-assert-js/power-assert) 的启发，因此如果您的测试失败，您可以确切地看到语句的哪一部分失败了，而不是类似于`Failed asserting that false is true`的一般消息。下面是一个失败测试的输出示例:

```
test/test-assert.js❌ testGetData24
25    t.assert(data3.message === 'Something should be false');
26                   |
                     "Something should be true"
```

*   它支持对数组和对象的比较，而不必使用任何自定义语法(只需使用`==`或`!=`进行比较):

```
t.assert(list == ['one', 'two', 'three']);
```

*   它自动将 JSX 代码编译成`React.createElement`语法。
*   卢娜的测试由卢娜负责。多么 meta！

## 结论

我确信它并不完美，因为没有适用于所有人的灵丹妙药，特别是考虑到当今 JavaScript 的发展状况，但我相信它是朝着正确方向迈出的一步，我希望其他人也这样认为，并发现它很有用！

您可以在 [GitHub](https://github.com/ccampbell/luna-testing) 上找到更多信息并阅读完整文档。

另外，请务必查看[项目介绍页面](https://craig.is/testing/code)。