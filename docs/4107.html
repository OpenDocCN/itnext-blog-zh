<html>
<head>
<title>Why Every API Needs a Clock</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">为什么每个API都需要一个时钟</h1>
<blockquote>原文：<a href="https://itnext.io/why-every-api-needs-a-clock-84a12a910cb2?source=collection_archive---------6-----------------------#2020-04-27">https://itnext.io/why-every-api-needs-a-clock-84a12a910cb2?source=collection_archive---------6-----------------------#2020-04-27</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/4c8a761865941c1a7ed605cd63039f49.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*20NU91y7aFoWRZYZ.jpg"/></div></div></figure><h1 id="d906" class="jy jz iq bd ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv bi translated">为什么每个API都需要一个时钟</h1><p id="acff" class="pw-post-body-paragraph kw kx iq ky b kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt ij bi translated">当范·雅各布森在1985年无法上传文档时，他发现网络吞吐量已经停滞在每秒1比特。</p><p id="a59c" class="pw-post-body-paragraph kw kx iq ky b kz lu lb lc ld lv lf lg lh lw lj lk ll lx ln lo lp ly lr ls lt ij bi translated">“问题是我们启动时没有时钟。我们必须建造一个时钟"</p><p id="da74" class="pw-post-body-paragraph kw kx iq ky b kz lu lb lc ld lv lf lg lh lw lj lk ll lx ln lo lp ly lr ls lt ij bi translated">时钟将有助于减缓启动过程。这就是<a class="ae lz" href="https://en.wikipedia.org/wiki/TCP_congestion_control#Slow_start" rel="noopener ugc nofollow" target="_blank">慢启动</a>和其他<a class="ae lz" href="https://en.wikipedia.org/wiki/TCP_congestion_control" rel="noopener ugc nofollow" target="_blank">拥塞控制算法</a>的由来。</p><p id="c669" class="pw-post-body-paragraph kw kx iq ky b kz lu lb lc ld lv lf lg lh lw lj lk ll lx ln lo lp ly lr ls lt ij bi translated">TCP位调节需要一个时钟。API有什么不同吗？你的API也会变得拥挤吗？</p><h1 id="e3b9" class="jy jz iq bd ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv bi translated">好像又回到了80年代</h1><p id="d1ea" class="pw-post-body-paragraph kw kx iq ky b kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt ij bi translated">当节点重试发送数据包时，它们会在网络上发送更多的位。重试堵塞了管道。解决方案是保护共享资源。在API经济中，API是所有客户的共享资源。一个或几个演员会扼杀你的资源吗？</p><p id="b1ca" class="pw-post-body-paragraph kw kx iq ky b kz lu lb lc ld lv lf lg lh lw lj lk ll lx ln lo lp ly lr ls lt ij bi translated">拥塞控制中的所有位和参与者都是平等的，但并非所有API及其调用者都是相同的。有许多属性(不仅仅是TCP拥有的位)可以使用。但是在高层次上，有业务需求、运行API的基础设施和API的调用者。</p><p id="b2f0" class="pw-post-body-paragraph kw kx iq ky b kz lu lb lc ld lv lf lg lh lw lj lk ll lx ln lo lp ly lr ls lt ij bi translated">与TCP不同，速率限制的选择是由多种因素决定的，但是基本前提仍然保持不变——使用时钟来计数和限制对共享资源的访问。</p><p id="3387" class="pw-post-body-paragraph kw kx iq ky b kz lu lb lc ld lv lf lg lh lw lj lk ll lx ln lo lp ly lr ls lt ij bi translated">慢启动和拥塞控制被编码在TCP/IP协议栈中，由每台想上网的计算机运行。但是你能对每个调用你的API的用户这么说吗？</p><p id="4891" class="pw-post-body-paragraph kw kx iq ky b kz lu lb lc ld lv lf lg lh lw lj lk ll lx ln lo lp ly lr ls lt ij bi translated">今天，您的API被各种参与者调用。无论是最终用户、业务流程、脚本、自动化框架、事件机制、来自外部来源或其他来源的通知。你如何确保他们都是好公民，不会降低你的API？</p><h1 id="06d8" class="jy jz iq bd ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv bi translated">API速率限制—向API添加时钟</h1><p id="63dc" class="pw-post-body-paragraph kw kx iq ky b kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt ij bi translated">慢启动时钟用于计算通过网络发送的位数。</p><p id="4810" class="pw-post-body-paragraph kw kx iq ky b kz lu lb lc ld lv lf lg lh lw lj lk ll lx ln lo lp ly lr ls lt ij bi translated">但是对于一个API来说，应该考虑哪些属性呢？在L7，你的隐喻管道是什么？是具体的路径/路线吗？是特定的上游吗？</p><p id="9330" class="pw-post-body-paragraph kw kx iq ky b kz lu lb lc ld lv lf lg lh lw lj lk ll lx ln lo lp ly lr ls lt ij bi translated">你算什么？你统计过请求的数量吗？或者来自特定位置的请求数量？或者指定给特定管道的请求数量？所有的请求都是平等的吗？当你拥堵的时候，要不要同样对待GET和POST？</p><h1 id="2f6f" class="jy jz iq bd ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv bi translated">令牌桶—选择您的令牌并选择您的桶大小</h1><p id="b703" class="pw-post-body-paragraph kw kx iq ky b kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt ij bi translated">简单的令牌桶算法可用于实现API的速率限制。我们将“你算什么”映射到一个令牌。可以从映射到用户的传入HTTP报头构建令牌，或者通过在IP上执行地理查找来使用位置以识别位置。或者，可以从请求的目的地构建令牌。L7属性可用于混合和匹配来构建令牌。</p><p id="b780" class="pw-post-body-paragraph kw kx iq ky b kz lu lb lc ld lv lf lg lh lw lj lk ll lx ln lo lp ly lr ls lt ij bi translated">桶可以是我们希望每秒、每分钟、每小时等计数的令牌数。使用这两个，我们可以为特定的路由或上游执行(token)/(bucket)。</p><h1 id="81fc" class="jy jz iq bd ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv bi translated">路由通用网关中的速率限制</h1><p id="209d" class="pw-post-body-paragraph kw kx iq ky b kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt ij bi translated"><a class="ae lz" href="https://getenroute.io" rel="noopener ugc nofollow" target="_blank">途中</a>提供了在路由级别执行<a class="ae lz" href="https://getenroute.io/cookbook/getting-started-advanced-rate-limiting/" rel="noopener ugc nofollow" target="_blank">限速</a>的粒度。您可以决定在路由级别向速率限制引擎发送什么令牌。例如，您可以向速率限制引擎发送传入连接的IP地址或特定报头，如身份验证报头。</p><p id="d32e" class="pw-post-body-paragraph kw kx iq ky b kz lu lb lc ld lv lf lg lh lw lj lk ll lx ln lo lp ly lr ls lt ij bi translated">一旦速率限制引擎接收到这些令牌，它可以直接使用这些令牌，也可以连接并构建一个新令牌。然后在这个新令牌的基础上使用redis执行计数。</p><p id="9114" class="pw-post-body-paragraph kw kx iq ky b kz lu lb lc ld lv lf lg lh lw lj lk ll lx ln lo lp ly lr ls lt ij bi translated">时段粒度可以是秒、分钟或小时。</p><p id="892f" class="pw-post-body-paragraph kw kx iq ky b kz lu lb lc ld lv lf lg lh lw lj lk ll lx ln lo lp ly lr ls lt ij bi translated">速率限制引擎的规则允许您指定如何构造令牌和定义存储桶。</p><h1 id="6cf0" class="jy jz iq bd ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv bi translated">例子</h1><p id="2f30" class="pw-post-body-paragraph kw kx iq ky b kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt ij bi translated">我们来看几个限速的例子，看看它是如何被记录的，以及它是如何映射到我们的系统的。我们将评估Ebay和Pinterest是如何实现的。</p><p id="b72f" class="pw-post-body-paragraph kw kx iq ky b kz lu lb lc ld lv lf lg lh lw lj lk ll lx ln lo lp ly lr ls lt ij bi translated">我们只将这些用例映射到发送到速率限制引擎的令牌。关于如何使用实际代码实现这一点的详细信息，可以在关于途中独立网关和途中Kubernetes入口网关的<a class="ae lz" href="https://getenroute.io/cookbook/getting-started-advanced-rate-limiting/" rel="noopener ugc nofollow" target="_blank">速率限制的文章中找到。</a></p><p id="dc5a" class="pw-post-body-paragraph kw kx iq ky b kz lu lb lc ld lv lf lg lh lw lj lk ll lx ln lo lp ly lr ls lt ij bi translated">这是Ebay为它的一些API所做的速率限制的子集。兼容的应用程序是那些已经注册了Ebay并拥有API密钥的应用程序</p><figure class="mb mc md me gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi ma"><img src="../Images/d275475fb99088d8c5aae4e0ee024729.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*lclRkkmseOKm0DoC.png"/></div></div></figure><p id="e8d3" class="pw-post-body-paragraph kw kx iq ky b kz lu lb lc ld lv lf lg lh lw lj lk ll lx ln lo lp ly lr ls lt ij bi translated">发送到速率限制引擎的令牌将是具有与用户相关联的唯一令牌的HTTP报头。如果令牌出现在查询字符串中，则可以提取令牌并发送给速率限制引擎。你也可以看看易贝的例子。</p><p id="10d5" class="pw-post-body-paragraph kw kx iq ky b kz lu lb lc ld lv lf lg lh lw lj lk ll lx ln lo lp ly lr ls lt ij bi translated">以下是Pinterest如何描述它对一些API的速率限制</p><figure class="mb mc md me gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mf"><img src="../Images/937bfbc1366357d70e58cabc29281acc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*U31KVgim-6fgCEbd.png"/></div></div></figure><p id="e4ab" class="pw-post-body-paragraph kw kx iq ky b kz lu lb lc ld lv lf lg lh lw lj lk ll lx ln lo lp ly lr ls lt ij bi translated">这与上面的易贝非常相似。令牌可以是作为查询字符串传递的HTTP头或API键。易贝使用一天的时间段，而pinterest使用一个小时。你也可以看看pinterest的工作示例。</p><p id="b21e" class="pw-post-body-paragraph kw kx iq ky b kz lu lb lc ld lv lf lg lh lw lj lk ll lx ln lo lp ly lr ls lt ij bi translated">工作代码和示例可在关于<a class="ae lz" href="https://getenroute.io/cookbook/getting-started-advanced-rate-limiting/" rel="noopener ugc nofollow" target="_blank">途中独立网关和途中Kubernetes入口网关的速率限制</a>的文章中找到</p><h1 id="ded1" class="jy jz iq bd ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv bi translated">速率限制是API的基础</h1><p id="94ea" class="pw-post-body-paragraph kw kx iq ky b kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt ij bi translated">我们认为速率限制是每个API都需要的。很多流行的API网关(Gloo，大使，孔)，收费的。我们认为限速是应该免费的基本功能。我们也计划最终开源它。</p><h1 id="316d" class="jy jz iq bd ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv bi translated">沿着你的交通路线在任何地方跑限速</h1><p id="4f3c" class="pw-post-body-paragraph kw kx iq ky b kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt ij bi translated">途中通用网关提供了在网络路径的任何地方运行限速<a class="ae lz" href="https://getenroute.io/blog/gateway-mesh/" rel="noopener ugc nofollow" target="_blank">网络功能的能力。通过将服务作为服务的旁站来运行，它可以用来保护服务。或者，对于采用kubernetes的组织，可以在kubernetes入口为集群内运行的微服务运行它。Enroute的灵活性还允许在私有云或公共云环境中独立运行速率限制。一个统一的机制来配置所有这些使通用网关易于使用。</a></p><h1 id="0ce2" class="jy jz iq bd ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv bi translated">上述速率限制的路由通用网关配置</h1><p id="d9eb" class="pw-post-body-paragraph kw kx iq ky b kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt ij bi translated">以下步骤涉及到重新创建现实世界的例子:</p><ul class=""><li id="85f0" class="mg mh iq ky b kz lu ld lv lh mi ll mj lp mk lt ml mm mn mo bi translated">使用lua脚本从请求中提取用户令牌，将其作为标头值发送给速率限制引擎读取</li><li id="e660" class="mg mh iq ky b kz mp ld mq lh mr ll ms lp mt lt ml mm mn mo bi translated">添加路由操作，以便在请求与该路由匹配时将请求状态发送到速率限制引擎</li><li id="6536" class="mg mh iq ky b kz mp ld mq lh mr ll ms lp mt lt ml mm mn mo bi translated">添加速率限制引擎描述符来指定对用户的限制</li></ul><p id="6bb9" class="pw-post-body-paragraph kw kx iq ky b kz lu lb lc ld lv lf lg lh lw lj lk ll lx ln lo lp ly lr ls lt ij bi translated">第一步可以在更详细的文章中找到<a class="ae lz" href="https://getenroute.io/cookbook/getting-started-advanced-rate-limiting/" rel="noopener ugc nofollow" target="_blank">这里</a>我们展示了下面的限速引擎配置描述符</p><p id="9280" class="pw-post-body-paragraph kw kx iq ky b kz lu lb lc ld lv lf lg lh lw lj lk ll lx ln lo lp ly lr ls lt ij bi translated">易趣</p><p id="4e91" class="pw-post-body-paragraph kw kx iq ky b kz lu lb lc ld lv lf lg lh lw lj lk ll lx ln lo lp ly lr ls lt ij bi translated">当速率限制过滤器与具有以下值的路由相关联时，它将报头<code class="fe mu mv mw mx b">x-app-key</code>和<code class="fe mu mv mw mx b">remote_address</code>发送到速率限制引擎。</p><pre class="mb mc md me gt my mx mz na aw nb bi"><span id="1572" class="nc jz iq mx b gy nd ne l nf ng">{<br/>    "descriptors": [<br/>        {<br/>            "request_headers": {<br/>                "descriptor_key": "x-app-key",<br/>                "header_name": "x-app-key"<br/>            }<br/>        },<br/>        {<br/>            "remote_address": "{}"<br/>        }<br/>    ]<br/>}</span></pre><p id="7158" class="pw-post-body-paragraph kw kx iq ky b kz lu lb lc ld lv lf lg lh lw lj lk ll lx ln lo lp ly lr ls lt ij bi translated">速率限制引擎使用<code class="fe mu mv mw mx b">x-app-key</code>和<code class="fe mu mv mw mx b">remote_address</code>来构建令牌，进行计数并实施速率限制</p><pre class="mb mc md me gt my mx mz na aw nb bi"><span id="9f4b" class="nc jz iq mx b gy nd ne l nf ng">{<br/>    "descriptors": [<br/>        {<br/>            "descriptors": [<br/>                {<br/>                    "key": "remote_address",<br/>                    "rate_limit": {<br/>                        "requests_per_unit": 5000,<br/>                        "unit": "second"<br/>                    }<br/>                }<br/>            ],<br/>            "key": "x-app-key",<br/>            "value": "x-app-notfound"<br/>        },<br/>        {<br/>            "descriptors": [<br/>                {<br/>                    "key": "remote_address",<br/>                    "rate_limit": {<br/>                        "requests_per_unit": 100000,<br/>                        "unit": "second"<br/>                    }<br/>                }<br/>            ],<br/>            "key": "x-app-key"<br/>        }<br/>    ],<br/>    "domain": "enroute"<br/>}</span></pre><p id="9f7c" class="pw-post-body-paragraph kw kx iq ky b kz lu lb lc ld lv lf lg lh lw lj lk ll lx ln lo lp ly lr ls lt ij bi translated">拼趣</p><p id="b45e" class="pw-post-body-paragraph kw kx iq ky b kz lu lb lc ld lv lf lg lh lw lj lk ll lx ln lo lp ly lr ls lt ij bi translated">这种配置与上面的易贝示例相同。</p><p id="98b3" class="pw-post-body-paragraph kw kx iq ky b kz lu lb lc ld lv lf lg lh lw lj lk ll lx ln lo lp ly lr ls lt ij bi translated">当速率限制过滤器与具有以下值的路由相关联时，它将报头<code class="fe mu mv mw mx b">x-app-key</code>和<code class="fe mu mv mw mx b">remote_address</code>发送到速率限制引擎。</p><pre class="mb mc md me gt my mx mz na aw nb bi"><span id="fd27" class="nc jz iq mx b gy nd ne l nf ng">{<br/>    "descriptors": [<br/>        {<br/>            "request_headers": {<br/>                "descriptor_key": "x-app-key",<br/>                "header_name": "x-app-key"<br/>            }<br/>        },<br/>        {<br/>            "remote_address": "{}"<br/>        }<br/>    ]<br/>}</span></pre><p id="046a" class="pw-post-body-paragraph kw kx iq ky b kz lu lb lc ld lv lf lg lh lw lj lk ll lx ln lo lp ly lr ls lt ij bi translated">速率限制引擎使用<code class="fe mu mv mw mx b">x-app-key</code>和<code class="fe mu mv mw mx b">remote_address</code>来构建令牌，进行计数并实施速率限制。这也类似于易贝的例子，但有不同的限制。</p><pre class="mb mc md me gt my mx mz na aw nb bi"><span id="9193" class="nc jz iq mx b gy nd ne l nf ng">{<br/>    "descriptors": [<br/>        {<br/>            "descriptors": [<br/>                {<br/>                    "key": "remote_address",<br/>                    "rate_limit": {<br/>                        "requests_per_unit": 10,<br/>                        "unit": "hour"<br/>                    }<br/>                }<br/>            ],<br/>            "key": "x-app-key",<br/>            "value": "x-app-notfound"<br/>        },<br/>        {<br/>            "descriptors": [<br/>                {<br/>                    "key": "remote_address",<br/>                    "rate_limit": {<br/>                        "requests_per_unit": 1000,<br/>                        "unit": "hour"<br/>                    }<br/>                }<br/>            ],<br/>            "key": "x-app-key"<br/>        }<br/>    ],<br/>    "domain": "enroute"<br/>}</span></pre><h1 id="8e61" class="jy jz iq bd ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv bi translated">结论</h1><p id="9a81" class="pw-post-body-paragraph kw kx iq ky b kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt ij bi translated">我们展示了API速率限制对于今天的API是多么重要，以及如何在<a class="ae lz" href="https://getenroute.io" rel="noopener ugc nofollow" target="_blank">途中通用网关</a>上对它们进行编程。根据API运行的位置，可以使用独立网关或Kubernetes Ingress API网关。</p><p id="a98a" class="pw-post-body-paragraph kw kx iq ky b kz lu lb lc ld lv lf lg lh lw lj lk ll lx ln lo lp ly lr ls lt ij bi translated">高级速率限制可以在通用API网关上运行，没有任何限制或许可。速率限制是运行API的基础，在community edition中完全免费提供(而其他供应商对此收费)。</p><p id="7618" class="pw-post-body-paragraph kw kx iq ky b kz lu lb lc ld lv lf lg lh lw lj lk ll lx ln lo lp ly lr ls lt ij bi translated">Enroute为API提供了一个完整的速率限制解决方案，对速率限制的所有方面进行集中控制。凭借Enroute的灵活性，可以在任何环境中实现对API速率限制的需求，包括私有云、公共云、kubernetes入口或网关网格。</p><p id="83fd" class="pw-post-body-paragraph kw kx iq ky b kz lu lb lc ld lv lf lg lh lw lj lk ll lx ln lo lp ly lr ls lt ij bi translated">如果您有任何反馈，您可以使用<a class="ae lz" href="https://yastack.io/contact2/?no-cache=1" rel="noopener ugc nofollow" target="_blank">联系人</a>表格联系我们。</p></div><div class="ab cl nh ni hu nj" role="separator"><span class="nk bw bk nl nm nn"/><span class="nk bw bk nl nm nn"/><span class="nk bw bk nl nm"/></div><div class="ij ik il im in"><p id="6b95" class="pw-post-body-paragraph kw kx iq ky b kz lu lb lc ld lv lf lg lh lw lj lk ll lx ln lo lp ly lr ls lt ij bi translated"><em class="no">原载于2020年4月27日</em><a class="ae lz" href="https://getenroute.io/blog/why-every-api-needs-a-clock/" rel="noopener ugc nofollow" target="_blank"><em class="no">https://geten route . io</em></a><em class="no">。</em></p></div></div>    
</body>
</html>