<html>
<head>
<title>Adding contextual data to Python logging</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">向Python日志添加上下文数据</h1>
<blockquote>原文：<a href="https://itnext.io/adding-contextual-data-to-python-logging-2597a835b1f4?source=collection_archive---------1-----------------------#2021-04-25">https://itnext.io/adding-contextual-data-to-python-logging-2597a835b1f4?source=collection_archive---------1-----------------------#2021-04-25</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><figure class="gl gn jr js jt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi jq"><img src="../Images/125852ffbf41818e95ddf686614a8d34.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*GcE7mYX-QsDl7rkw"/></div></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated">由<a class="ae kf" href="https://unsplash.com/@goshua13?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">约书亚·阿拉贡</a>在<a class="ae kf" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</figcaption></figure><p id="3e8e" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">最近，我面临了一个令人兴奋的挑战。我需要创建一个与外部API集成的健壮的日志系统。其中一个要求是，只要有特定的上下文数据，就记录这些数据。主要的问题是，很多信息分散在整个应用程序中，嵌套在不同的函数中。</p><p id="e523" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">通过函数传递必要对象的最简单的方法会不必要地增加代码。我开始思考如何利用上下文管理器来收集数据。经过几次迭代，我和团队一起想出了一个优雅的解决方案，这给了我们额外的绒毛，我们可以在应用程序中使用。让我向您展示代码并解释其背后的原因。准备好了吗？让我们继续前进！</p><h1 id="2346" class="le lf it bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">设置日志记录上下文处理程序</h1><p id="3208" class="pw-post-body-paragraph kg kh it ki b kj mc kl km kn md kp kq kr me kt ku kv mf kx ky kz mg lb lc ld im bi translated">首先，我们将为上下文管理器创建一个数据存储。它需要具备三种能力:</p><ul class=""><li id="7276" class="mh mi it ki b kj kk kn ko kr mj kv mk kz ml ld mm mn mo mp bi translated">我们需要能够向它添加更多的上下文数据</li><li id="66bf" class="mh mi it ki b kj mq kn mr kr ms kv mt kz mu ld mm mn mo mp bi translated">它应该通过名称返回特定的属性值</li><li id="aa4b" class="mh mi it ki b kj mq kn mr kr ms kv mt kz mu ld mm mn mo mp bi translated">它应该能够删除不再需要的上下文数据。</li></ul><p id="1fe5" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">为此，我们将创建一个以字典为元素的堆栈。字典将包含一组用于日志记录的上下文数据。让我们看看它是什么样子的:</p><figure class="mv mw mx my gt ju"><div class="bz fp l di"><div class="mz na l"/></div></figure><p id="4e00" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">让我们更深入地了解一下<code class="fe nb nc nd ne b">add</code>方法，因为这就是神奇之处。</p><p id="0be6" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">每当我们向上下文添加新数据时，<code class="fe nb nc nd ne b">add</code>从栈顶克隆字典，并用新添加的内容更新它。这样，我们就不需要遍历整个堆栈来获取隐藏在其中的属性。</p><p id="cd72" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">我提到过几次上下文管理器，但是它在哪里呢？让我马上修理它！</p><h1 id="50a0" class="le lf it bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">创建上下文管理器</h1><p id="25e4" class="pw-post-body-paragraph kg kh it ki b kj mc kl km kn md kp kq kr me kt ku kv mf kx ky kz mg lb lc ld im bi translated">没有什么花哨的，只是一个简单的功能。您用作参数的任何内容都将被推送到上面定义的处理程序。成功执行包装代码后，管理器将从上下文中删除数据。</p><figure class="mv mw mx my gt ju"><div class="bz fp l di"><div class="mz na l"/></div></figure><h1 id="bbc3" class="le lf it bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">使用过滤器调整日志记录</h1><p id="cc02" class="pw-post-body-paragraph kg kh it ki b kj mc kl km kn md kp kq kr me kt ku kv mf kx ky kz mg lb lc ld im bi translated">现在我们有了数据源和管理它的方法，我们可以将数据添加到日志记录中。<a class="ae kf" href="https://docs.python.org/3/howto/logging-cookbook.html#using-filters-to-impart-contextual-information" rel="noopener ugc nofollow" target="_blank">推荐的方法</a>是使用过滤器，所以让我们创建一个过滤器并将其附加到日志处理程序。</p><figure class="mv mw mx my gt ju"><div class="bz fp l di"><div class="mz na l"/></div></figure><p id="74f9" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">这种过滤器会将日志上下文中的属性添加到每个日志记录中。当然，我们可以疯狂地做我们想做的事情。但是为了简单起见，让我们构建一个格式化程序，在我们选择的记录器中显示我们新添加的属性。</p><h1 id="f07a" class="le lf it bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">创建格式化程序</h1><p id="1f26" class="pw-post-body-paragraph kg kh it ki b kj mc kl km kn md kp kq kr me kt ku kv mf kx ky kz mg lb lc ld im bi translated">我们不需要构建任何健壮的东西。对于我们的目的，一个简单的<code class="fe nb nc nd ne b">setFormatter</code>函数调用就足够了。</p><figure class="mv mw mx my gt ju"><div class="bz fp l di"><div class="mz na l"/></div></figure><h1 id="5ea9" class="le lf it bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">让我们看看它是如何工作的</h1><p id="db3f" class="pw-post-body-paragraph kg kh it ki b kj mc kl km kn md kp kq kr me kt ku kv mf kx ky kz mg lb lc ld im bi translated">设置完成后，我们现在可以检查它是如何使用的。我给大家展示一个简单的app作为例子。</p><p id="2fef" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">假设我们有一家杂货店，我们希望通过日志记录来跟踪我们将商品卖给了谁。我们有两个客户，吉姆和蒂姆，每个人都有自己的购物清单。让我们建立一个代码，允许我们向他们销售商品。</p><figure class="mv mw mx my gt ju"><div class="bz fp l di"><div class="mz na l"/></div></figure><p id="0353" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">注意，传递给<code class="fe nb nc nd ne b">sell_goods</code>函数的唯一参数是一个购物清单，因为不需要添加任何东西。</p><p id="d92e" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">运行该脚本后，它将产生这样的输出:</p><pre class="mv mw mx my gt nf ne ng nh aw ni bi"><span id="43e5" class="nj lf it ne b gy nk nl l nm nn">[Hannah's Grocery Store | Jim | potatoes]: Sold 1 item.<br/>[Hannah's Grocery Store | Jim | tomatoes]: Sold 1 item.<br/>[Hannah's Grocery Store | Tim | bread]: Sold 1 item.<br/>[Hannah's Grocery Store | Tim | eggs]: Sold 1 item.<br/>[Hannah's Grocery Store | Tim | milk]: Sold 1 item.</span></pre><p id="a191" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">如您所见，存储在上下文中的所有数据都显示在日志中。</p><p id="8721" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">我们可以更进一步。比方说，<code class="fe nb nc nd ne b">sell_goods</code>函数也检查一个条目是否可用，如果不可用就抛出一个错误。如果我们记录了这个异常，我们可以看到下一个客户没有购买鸡蛋，因为商店没有鸡蛋了。</p><h1 id="5157" class="le lf it bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">小心基地伐木工！</h1><p id="7a27" class="pw-post-body-paragraph kg kh it ki b kj mc kl km kn md kp kq kr me kt ku kv mf kx ky kz mg lb lc ld im bi translated">需要提及的一件重要事情是<strong class="ki iu">你应该为你的应用程序创建一个单独的记录器。</strong></p><p id="76c5" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">有一次，我错误地将处理程序添加到了基本记录器中，然后我看到外部库向我抛出错误。经过短暂的调查，发现他们都试图在没有访问权限的情况下向日志记录添加额外的属性。把自己从挫败中解救出来，请不要这样做。</p></div><div class="ab cl no np hx nq" role="separator"><span class="nr bw bk ns nt nu"/><span class="nr bw bk ns nt nu"/><span class="nr bw bk ns nt"/></div><div class="im in io ip iq"><p id="e079" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">我希望你有一个好的阅读，并有另一个整洁的解决方案添加到您的工具箱！</p><p id="c74d" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">如果你想立即下载这个项目来检查它的功能，这里有一个资源库的链接:<a class="ae kf" href="https://github.com/kampikd/logging-context-python" rel="noopener ugc nofollow" target="_blank">https://github.com/kampikd/logging-context-python</a></p><p id="e85c" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">请随意拉代码，玩它！</p><p id="9e5d" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">非常感谢皮奥特·科特尼斯提出了许多发人深省的想法💙。如果没有他的帮助和见解，这个解决方案就不会如此完善。</p><h2 id="1e2a" class="nj lf it bd lg nx ny dn lk nz oa dp lo kr ob oc ls kv od oe lw kz of og ma oh bi translated">资源</h2><ul class=""><li id="5ce7" class="mh mi it ki b kj mc kn md kr oi kv oj kz ok ld mm mn mo mp bi translated"><a class="ae kf" href="https://docs.python.org/3/howto/logging-cookbook.html" rel="noopener ugc nofollow" target="_blank">https://docs.python.org/3/howto/logging-cookbook.html</a></li></ul></div></div>    
</body>
</html>