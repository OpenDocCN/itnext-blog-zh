<html>
<head>
<title>Tip: Connecting to Azure Cosmos DB MongoDB API using the MongoDB Go driver</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">提示:使用MongoDB Go驱动程序连接到Azure Cosmos DB MongoDB API</h1>
<blockquote>原文：<a href="https://itnext.io/tip-connecting-to-azure-cosmos-db-mongodb-api-using-the-mongodb-go-driver-a9ca1230a1c7?source=collection_archive---------6-----------------------#2020-03-27">https://itnext.io/tip-connecting-to-azure-cosmos-db-mongodb-api-using-the-mongodb-go-driver-a9ca1230a1c7?source=collection_archive---------6-----------------------#2020-03-27</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="0f6b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><a class="ae kl" href="https://docs.microsoft.com/azure/cosmos-db/mongodb-introduction?WT.mc_id=medium-blog-abhishgu" rel="noopener ugc nofollow" target="_blank"> Azure Cosmos DB提供MongoDB API支持</a>，这意味着您可以使用特定语言的驱动程序来本地连接到Cosmos DB。</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="ks kt di ku bf kv"><div class="gh gi km"><img src="../Images/df66a03c2426c934ebb8fb5a3eab8be8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*4WNkIFJ3TYlYldEHI3WKNw.png"/></div></div></figure><blockquote class="ky kz la"><p id="86a0" class="jn jo lb jp b jq jr js jt ju jv jw jx lc jz ka kb ld kd ke kf le kh ki kj kk ij bi translated"><em class="iq">文档中有很多资源，例如</em> <a class="ae kl" href="https://docs.microsoft.com/azure/cosmos-db/create-mongodb-java?WT.mc_id=medium-blog-abhishgu" rel="noopener ugc nofollow" target="_blank"> <em class="iq">一个Java快速入门</em> </a> <em class="iq">，</em> <a class="ae kl" href="https://docs.microsoft.com/azure/cosmos-db/tutorial-develop-mongodb-react?WT.mc_id=medium-blog-abhishgu" rel="noopener ugc nofollow" target="_blank"> <em class="iq"> Node.js + React教程</em> </a> <em class="iq">等。</em></p></blockquote><p id="bd72" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">但是<a class="ae kl" href="http://golang.org/" rel="noopener ugc nofollow" target="_blank"> Golang </a>呢，具体来说，官方<a class="ae kl" href="https://github.com/mongodb/mongo-go-driver" rel="noopener ugc nofollow" target="_blank"> MongoDB驱动</a>呢？我期望它“正常工作”，但是我面临一个小问题。在糟糕的一天，我可能会花上几个小时，然后(可能)放弃。幸运的是，事实并非如此！希望这篇文章能帮你节省一些时间，以防你遇到这种情况😉</p><p id="5000" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我首先为MongoDB版本<code class="fe lf lg lh li b">3.6</code> ( <a class="ae kl" href="https://docs.microsoft.com/azure/cosmos-db/mongodb-feature-support?WT.mc_id=medium-blog-abhishgu" rel="noopener ugc nofollow" target="_blank">另一个支持的版本是</a> <code class="fe lf lg lh li b"><a class="ae kl" href="https://docs.microsoft.com/azure/cosmos-db/mongodb-feature-support?WT.mc_id=medium-blog-abhishgu" rel="noopener ugc nofollow" target="_blank">3.2</a></code>)创建了一个Azure Cosmos DB帐户，并从门户获取了<a class="ae kl" href="https://docs.microsoft.com/azure/cosmos-db/connect-mongodb-account?WT.mc_id=medium-blog-abhishgu" rel="noopener ugc nofollow" target="_blank">连接字符串。格式如下:</a></p><pre class="kn ko kp kq gt lj li lk ll aw lm bi"><span id="c321" class="ln lo iq li b gy lp lq l lr ls">mongodb://[COSMOSDB_ACCOUNT_NAME]:[PRIMARY_PASSWORD]@[COSMOSDB_ACCOUNT_NAME].mongo.cosmos.azure.com:10255/?ssl=true&amp;replicaSet=globaldb&amp;retrywrites=false&amp;maxIdleTimeMS=120000&amp;appName=@[COSMOSDB_ACCOUNT_NAME]@</span></pre><blockquote class="ky kz la"><p id="1a18" class="jn jo lb jp b jq jr js jt ju jv jw jx lc jz ka kb ld kd ke kf le kh ki kj kk ij bi translated"><em class="iq">注意，在编写的时候，你只能使用Azure portal</em><a class="ae kl" href="https://docs.microsoft.com/azure/cosmos-db/cli-samples-mongodb?WT.mc_id=medium-blog-abhishgu" rel="noopener ugc nofollow" target="_blank"><em class="iq">创建MongoDB版本</em> </a> <code class="fe lf lg lh li b"><a class="ae kl" href="https://docs.microsoft.com/azure/cosmos-db/cli-samples-mongodb?WT.mc_id=medium-blog-abhishgu" rel="noopener ugc nofollow" target="_blank"><em class="iq">3.6</em></a></code> <a class="ae kl" href="https://docs.microsoft.com/azure/cosmos-db/cli-samples-mongodb?WT.mc_id=medium-blog-abhishgu" rel="noopener ugc nofollow" target="_blank"> <em class="iq">(不是Azure CLI) </em> </a></p></blockquote><p id="58fd" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我使用这个简单的程序只是为了测试连通性</p><pre class="kn ko kp kq gt lj li lk ll aw lm bi"><span id="5998" class="ln lo iq li b gy lp lq l lr ls">package main</span><span id="1cb8" class="ln lo iq li b gy lt lq l lr ls">import (<br/>	"context"<br/>	"fmt"<br/>	"log"<br/>	"os"<br/>	"time"</span><span id="3bdf" class="ln lo iq li b gy lt lq l lr ls">	"go.mongodb.org/mongo-driver/mongo"<br/>	"go.mongodb.org/mongo-driver/mongo/options"<br/>)</span><span id="a1b3" class="ln lo iq li b gy lt lq l lr ls">var connectionStr string</span><span id="0cc8" class="ln lo iq li b gy lt lq l lr ls">func init() {<br/>	connectionStr = os.Getenv("MONGODB_CONNECTION_STRING")<br/>	if connectionStr == "" {<br/>		log.Fatal("Missing enviornment variable MONGODB_CONNECTION_STRING")<br/>	}<br/>}</span><span id="6863" class="ln lo iq li b gy lt lq l lr ls">func main() {</span><span id="971c" class="ln lo iq li b gy lt lq l lr ls">	ctx, cancel := context.WithTimeout(context.Background(), time.Second*10)<br/>	defer cancel()</span><span id="2e4c" class="ln lo iq li b gy lt lq l lr ls">	fmt.Println("connecting...")<br/>	clientOptions := options.Client().ApplyURI(connectionStr)<br/>	c, err := mongo.NewClient(clientOptions)</span><span id="da86" class="ln lo iq li b gy lt lq l lr ls">	err = c.Connect(ctx)</span><span id="aa1c" class="ln lo iq li b gy lt lq l lr ls">	if err != nil {<br/>		log.Fatalf("unable to connect %v", err)<br/>	}<br/>	err = c.Ping(ctx, nil)<br/>	if err != nil {<br/>		log.Fatalf("unable to ping Cosmos DB %v", err)<br/>	}</span><span id="d578" class="ln lo iq li b gy lt lq l lr ls">	fmt.Println("connected!")<br/>}</span></pre><p id="509e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">要进行测试，只需设置连接字符串并运行程序</p><pre class="kn ko kp kq gt lj li lk ll aw lm bi"><span id="6048" class="ln lo iq li b gy lp lq l lr ls">export MONGODB_CONNECTION_STRING=&lt;copy-paste from azure portal&gt;</span><span id="be68" class="ln lo iq li b gy lt lq l lr ls">go run main.go</span></pre><p id="7b3b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我本以为会看到<code class="fe lf lg lh li b">connected!</code>，但结果却是这样:</p><pre class="kn ko kp kq gt lj li lk ll aw lm bi"><span id="a0c6" class="ln lo iq li b gy lp lq l lr ls">unable to Ping: connection(cdb-ms-prod-southeastasia1-cm1.documents.azure.com:10255[-5]) connection is closed</span></pre><p id="6fbf" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我根据“有根据的猜测”开始调试。Azure Cosmos DB通过<a class="ae kl" href="https://docs.microsoft.com/azure/cosmos-db/mongodb-introduction?WT.mc_id=medium-blog-abhishgu#wire-protocol-compatibility" rel="noopener ugc nofollow" target="_blank">有线协议兼容性</a>提供MongoDB支持，并允许您使用单个端点进行连接(参见连接字符串)。这意味着您不必担心底层的数据库集群拓扑。</p><p id="40ae" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">也许司机想在这点上“聪明一点”？我开始更仔细地研究Mongo驱动程序<code class="fe lf lg lh li b"><a class="ae kl" href="https://godoc.org/go.mongodb.org/mongo-driver/mongo/options#ClientOptions" rel="noopener ugc nofollow" target="_blank">ClientOptions</a></code>及其可用方法，结果发现:<code class="fe lf lg lh li b"><a class="ae kl" href="https://godoc.org/go.mongodb.org/mongo-driver/mongo/options#ClientOptions.SetDirect" rel="noopener ugc nofollow" target="_blank">SetDirect</a></code>方法！</p><p id="eec0" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这是Godoc:</p><pre class="kn ko kp kq gt lj li lk ll aw lm bi"><span id="542d" class="ln lo iq li b gy lp lq l lr ls">SetDirect specifies whether or not a direct connect should be made. To use this option, a URI with a single host must be specified through ApplyURI. If set to true, the driver will only connect to the host provided in the URI and will not discover other hosts in the cluster. This can also be set through the "connect" URI option with the following values:</span><span id="0e90" class="ln lo iq li b gy lt lq l lr ls">1. "connect=direct" for direct connections</span><span id="c870" class="ln lo iq li b gy lt lq l lr ls">2. "connect=automatic" for automatic discovery.</span><span id="7d54" class="ln lo iq li b gy lt lq l lr ls">The default is false ("automatic" in the connection string).</span></pre><p id="1167" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我所要做的就是更新<code class="fe lf lg lh li b">ClientOptions</code></p><pre class="kn ko kp kq gt lj li lk ll aw lm bi"><span id="42c0" class="ln lo iq li b gy lp lq l lr ls">clientOptions := options.Client().ApplyURI(connectionStr).<strong class="li ir">SetDirect(true)</strong></span></pre><blockquote class="ky kz la"><p id="1a62" class="jn jo lb jp b jq jr js jt ju jv jw jx lc jz ka kb ld kd ke kf le kh ki kj kk ij bi translated"><em class="iq">你也可以通过添加</em> <code class="fe lf lg lh li b"><em class="iq">connect=direct</em></code> <em class="iq">(根据Godoc)将它添加到连接字符串本身，我可以确认它也能工作</em></p></blockquote><p id="7b89" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">就是这样。现在我能够连接到Azure Cosmos DB MongoDB API了🙌请继续关注即将发布的博客文章，在这篇文章中，我将借助一个实际的例子深入研究Azure Cosmos DB + Go上的MongoDB！</p></div></div>    
</body>
</html>