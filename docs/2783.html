<html>
<head>
<title>Testing Cloud Functions with Jest</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用Jest测试云函数</h1>
<blockquote>原文：<a href="https://itnext.io/testing-cloud-functions-with-jest-7626fe1ac7e2?source=collection_archive---------0-----------------------#2019-08-01">https://itnext.io/testing-cloud-functions-with-jest-7626fe1ac7e2?source=collection_archive---------0-----------------------#2019-08-01</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="1976" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">今天我们将使用Jest测试框架深入测试云函数，比如AWS Lambda和Google Cloud函数。Jest在使用React的客户端开发人员中很流行，但不太为人所知的是Jest也是测试node.js无服务器函数的一个非常好的框架。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi kl"><img src="../Images/52ea54ac4cc0b28746c2cc81f2e9dfd9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*1Vgft5GmkMmHul82N1Zzwg.jpeg"/></div></div></figure><h2 id="ae4c" class="kx ky iq bd kz la lb dn lc ld le dp lf jy lg lh li kc lj lk ll kg lm ln lo lp bi translated">为什么开玩笑？</h2><blockquote class="lq lr ls"><p id="97b6" class="jn jo lt jp b jq jr js jt ju jv jw jx lu jz ka kb lv kd ke kf lw kh ki kj kk ij bi translated">" Jest是一个令人愉快的JavaScript测试框架，专注于简单性."</p></blockquote><div class="lx ly gp gr lz ma"><a href="https://jestjs.io" rel="noopener  ugc nofollow" target="_blank"><div class="mb ab fo"><div class="mc ab md cl cj me"><h2 class="bd ir gy z fp mf fr fs mg fu fw ip bi translated">笑话🃏愉快的JavaScript测试</h2><div class="mh l"><h3 class="bd b gy z fp mf fr fs mg fu fw dk translated">🃏令人愉快的JavaScript测试</h3></div><div class="mi l"><p class="bd b dl z fp mf fr fs mg fu fw dk translated">🃏令人愉快的JavaScript测试jetjs . io</p></div></div><div class="mj l"><div class="mk l ml mm mn mj mo kv ma"/></div></div></a></div><p id="24b8" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我认为这是一个令人愉快的测试框架。正如我们将看到的，它使用简单，但也相当强大。代码覆盖率报告非常出色，而且有一些非常好的配套工具，比如Jest的zero config GUI<a class="ae mp" href="https://github.com/Raathigesh/majestic" rel="noopener ugc nofollow" target="_blank">Majestic</a>。</p><h2 id="24fd" class="kx ky iq bd kz la lb dn lc ld le dp lf jy lg lh li kc lj lk ll kg lm ln lo lp bi translated">建立</h2><p id="7645" class="pw-post-body-paragraph jn jo iq jp b jq mq js jt ju mr jw jx jy ms ka kb kc mt ke kf kg mu ki kj kk ij bi translated">按照我在<a class="ae mp" href="https://medium.com/@keith.coughtrey" rel="noopener">以前的帖子</a>中描述的方法，我将介绍使用typescript开发和使用无服务器框架部署。</p><p id="4467" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">从安装依赖项开始:</p><pre class="km kn ko kp gt mv mw mx my aw mz bi"><span id="3966" class="kx ky iq mw b gy na nb l nc nd">npm install --save-dev jest</span></pre><p id="f08d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">当我们使用typescript时:</p><pre class="km kn ko kp gt mv mw mx my aw mz bi"><span id="6550" class="kx ky iq mw b gy na nb l nc nd">npm install --save-dev ts-jest<br/>npm install --save-dev @types/jest</span></pre><p id="5d67" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">最后，需要通过运行以下命令来创建一些初始配置:</p><pre class="km kn ko kp gt mv mw mx my aw mz bi"><span id="2749" class="kx ky iq mw b gy na nb l nc nd">npx ts-jest config:init</span></pre><p id="d9c7" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">然后在<code class="fe ne nf ng mw b">package.json</code>中设置一个脚本，这样您就可以使用命令<code class="fe ne nf ng mw b">npm run test</code>来运行您的测试，传入任何需要的环境变量:</p><pre class="km kn ko kp gt mv mw mx my aw mz bi"><span id="7af6" class="kx ky iq mw b gy na nb l nc nd">"scripts": {<br/>    ...<br/>    "test": "BASE_URL=<a class="ae mp" href="https://example.com" rel="noopener ugc nofollow" target="_blank">https://example.com</a> jest --bail --coverage --coverageDirectory=output/coverage/jest"<br/>  },</span></pre><p id="d227" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在这里，我们传入BASE_URL环境变量，运行带有代码覆盖报告的<code class="fe ne nf ng mw b">jest</code>,并将其设置为在第一次测试失败时退出。</p><h2 id="1836" class="kx ky iq bd kz la lb dn lc ld le dp lf jy lg lh li kc lj lk ll kg lm ln lo lp bi translated">测试结构和匹配器</h2><p id="116e" class="pw-post-body-paragraph jn jo iq jp b jq mq js jt ju mr jw jx jy ms ka kb kc mt ke kf kg mu ki kj kk ij bi translated">按照惯例，您首先创建一个名为<code class="fe ne nf ng mw b">__tests__</code>的文件夹来放置您的测试。</p><p id="8ed6" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">一个简单的测试如下所示:</p><pre class="km kn ko kp gt mv mw mx my aw mz bi"><span id="3e35" class="kx ky iq mw b gy na nb l nc nd">test('two plus two is four', () =&gt; {<br/>  expect(2 + 2).toBe(4);<br/>});</span></pre><p id="b5de" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这里我使用了<code class="fe ne nf ng mw b">toBe</code>匹配器。其他有用的匹配器有:</p><ul class=""><li id="ee0e" class="nh ni iq jp b jq jr ju jv jy nj kc nk kg nl kk nm nn no np bi translated"><code class="fe ne nf ng mw b">toBeUndefined</code>仅匹配<code class="fe ne nf ng mw b">undefined</code></li><li id="0ea6" class="nh ni iq jp b jq nq ju nr jy ns kc nt kg nu kk nm nn no np bi translated"><code class="fe ne nf ng mw b">toBeDefined</code>与<code class="fe ne nf ng mw b">toBeUndefined</code>相反</li><li id="89c5" class="nh ni iq jp b jq nq ju nr jy ns kc nt kg nu kk nm nn no np bi translated"><code class="fe ne nf ng mw b">toBeTruthy</code>匹配任何被<code class="fe ne nf ng mw b">if</code>语句视为真的东西</li><li id="079f" class="nh ni iq jp b jq nq ju nr jy ns kc nt kg nu kk nm nn no np bi translated"><code class="fe ne nf ng mw b">toBeFalsy</code>匹配任何被<code class="fe ne nf ng mw b">if</code>语句视为假的内容</li></ul><p id="ff72" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">还有所有常见的东西，比如检查大于、小于、接近等，加上<code class="fe ne nf ng mw b">contains</code>用于检查是否在数组中找到某个值。完整列表可在<a class="ae mp" href="https://jestjs.io/docs/en/expect" rel="noopener ugc nofollow" target="_blank">这里</a>找到。</p><p id="510a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">对于异步测试(假设是<code class="fe ne nf ng mw b">node 8</code>或更高版本),你可以简单地添加<code class="fe ne nf ng mw b">async</code>和<code class="fe ne nf ng mw b">await</code>关键字</p><pre class="km kn ko kp gt mv mw mx my aw mz bi"><span id="495c" class="kx ky iq mw b gy na nb l nc nd">test('an asynchronous function', <strong class="mw ir">async</strong> () =&gt; {</span><span id="058e" class="kx ky iq mw b gy nv nb l nc nd">  const result = <strong class="mw ir">await</strong> [function that returns a promise]<br/>  expect(result).toBeTruthy();<br/>});</span></pre><h2 id="b3fd" class="kx ky iq bd kz la lb dn lc ld le dp lf jy lg lh li kc lj lk ll kg lm ln lo lp bi translated">代码覆盖率</h2><p id="ce79" class="pw-post-body-paragraph jn jo iq jp b jq mq js jt ju mr jw jx jy ms ka kb kc mt ke kf kg mu ki kj kk ij bi translated">如上所述，代码覆盖率是一流的。在测试运行结束时，您会看到这样一个覆盖率总结:</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div class="gh gi nw"><img src="../Images/ffc192f8e45deef10b14c4c1c660e82e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1360/format:webp/1*U0caJsSZ97BJekTXmv2BJQ.png"/></div><figcaption class="nx ny gj gh gi nz oa bd b be z dk translated">代码覆盖率摘要</figcaption></figure><p id="3ad3" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">HTML摘要页面(使用Majestic显示或在上面的<code class="fe ne nf ng mw b">scripts</code>部分配置的<code class="fe ne nf ng mw b">output/coverage/jest</code>中找到)如下开始:</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi ob"><img src="../Images/2244e2ba6c1cb075ffa20b9862263e3d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*CckAJwp07NAAtPXEfV6ebA.png"/></div></div><figcaption class="nx ny gj gh gi nz oa bd b be z dk translated">代码覆盖率报告</figcaption></figure><p id="991e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在，如果我点击<code class="fe ne nf ng mw b">dynamic-link-service.ts</code>来查看为什么17个代码分支中的2个没有被测试，下面是它为<code class="fe ne nf ng mw b">shorten</code>函数显示的内容:</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi oc"><img src="../Images/50cb127125972c083fb0dad9e9273323.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*BSWvmJOpx4j7GAoK9udxhA.png"/></div></div><figcaption class="nx ny gj gh gi nz oa bd b be z dk translated">函数源代码的覆盖率</figcaption></figure><p id="c0ea" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如您所见，我的测试已经运行该函数16次，但是没有一次测试了错误处理代码路径。</p><h2 id="9045" class="kx ky iq bd kz la lb dn lc ld le dp lf jy lg lh li kc lj lk ll kg lm ln lo lp bi translated">使用vscode进行调试等</h2><p id="67be" class="pw-post-body-paragraph jn jo iq jp b jq mq js jt ju mr jw jx jy ms ka kb kc mt ke kf kg mu ki kj kk ij bi translated">如果你开发的是Visual Studio代码，<a class="ae mp" href="https://github.com/jest-community/vscode-jest" rel="noopener ugc nofollow" target="_blank"> Jest扩展</a>允许你设置断点来调试你的测试，这有时会很有帮助。</p><p id="930c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">安装扩展，然后在vscode debug视图中，选择一个<strong class="jp ir"> dd配置</strong>并选择<code class="fe ne nf ng mw b">Jest: Default jest configuration</code>。如果您的功能代码在<code class="fe ne nf ng mw b">functions</code>文件夹中，修改<code class="fe ne nf ng mw b">program</code>和<code class="fe ne nf ng mw b">cdw</code>路径如下:</p><pre class="km kn ko kp gt mv mw mx my aw mz bi"><span id="5c34" class="kx ky iq mw b gy na nb l nc nd">"configurations": [<br/>        {<br/>          "type": "node",<br/>          "name": "all tests",<br/>          "request": "launch",<br/>          "program": "${workspaceFolder}/functions/node_modules/jest/bin/jest",<br/>          "args": [<br/>            "--runInBand"<br/>          ],<br/>          "cwd": "${workspaceFolder}/functions",<br/>          "console": "integratedTerminal",<br/>          "internalConsoleOptions": "neverOpen"<br/>        }<br/>      ]<br/>    }</span></pre><p id="bee8" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在，您应该能够运行新的配置并在断点处停止。该扩展还提供了其他好处，如在修改测试时实时重新运行测试，如下图所示:</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi od"><img src="../Images/f960b09da3db02405ab86f649e415214.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*P5ZmJsh6_A0dXM5bUxa50A.gif"/></div></div><figcaption class="nx ny gj gh gi nz oa bd b be z dk translated">Jest扩展在运行中</figcaption></figure><h2 id="e7d0" class="kx ky iq bd kz la lb dn lc ld le dp lf jy lg lh li kc lj lk ll kg lm ln lo lp bi translated">宏伟的</h2><div class="lx ly gp gr lz ma"><a href="https://github.com/Raathigesh/majestic" rel="noopener  ugc nofollow" target="_blank"><div class="mb ab fo"><div class="mc ab md cl cj me"><h2 class="bd ir gy z fp mf fr fs mg fu fw ip bi translated">Raathigesh/majestic</h2><div class="mh l"><h3 class="bd b gy z fp mf fr fs mg fu fw dk translated">Majestic是Jest ✅运行所有测试或单个文件的GUI⏱切换观察模式📸更新快照❌检查测试…</h3></div><div class="mi l"><p class="bd b dl z fp mf fr fs mg fu fw dk translated">github.com</p></div></div><div class="mj l"><div class="oe l ml mm mn mj mo kv ma"/></div></div></a></div><p id="c64b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这就是你如何安装和运行<code class="fe ne nf ng mw b">Majestic</code></p><pre class="km kn ko kp gt mv mw mx my aw mz bi"><span id="e66a" class="kx ky iq mw b gy na nb l nc nd">npm install majestic -g # install majestic globally</span><span id="e603" class="kx ky iq mw b gy nv nb l nc nd">majestic # execute majestic</span></pre><p id="f179" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">运行majestic运行用于演示上述覆盖率的项目，打开显示此页面的<code class="fe ne nf ng mw b">localhost:4000</code>:</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi of"><img src="../Images/c84542a0b28ae06fcbf079c36bbcd30e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ETCmYAkkPN7-GZl59LduNQ.png"/></div></div><figcaption class="nx ny gj gh gi nz oa bd b be z dk translated">雄伟的主页</figcaption></figure><p id="7d62" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在这里，我按下了<em class="lt">手表</em>右边的按钮，使其收集代码覆盖率。显示了统计数据，您可以从这里深入查看报告。您还可以看到测试的任何控制台输出。请注意，在撰写本文时，它在Chrome中运行得最好。Safari打乱了控制台部分。</p><p id="f70c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在这里，我使用了一个错误来显示断言失败是如何显示的:</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi og"><img src="../Images/4b6be475aa08f73e6b53819e15d6ea22.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*FgcU-0WdJUw29dyS_qdzMg.png"/></div></div><figcaption class="nx ny gj gh gi nz oa bd b be z dk translated">断言失败</figcaption></figure><p id="824f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果您的测试需要配置环境变量，您可以向<code class="fe ne nf ng mw b">package.json</code>添加一个<code class="fe ne nf ng mw b">majestic</code>部分，以便向<code class="fe ne nf ng mw b">Majestic</code>提供env值，例如:</p><pre class="km kn ko kp gt mv mw mx my aw mz bi"><span id="80a0" class="kx ky iq mw b gy na nb l nc nd">"majestic": {<br/>    "args": "--debug",<br/>    "env": {<br/>      "BASE_URL": "<a class="ae mp" href="https://example.com" rel="noopener ugc nofollow" target="_blank">https://example.com</a>",<br/>    }<br/>  },</span></pre><h2 id="853d" class="kx ky iq bd kz la lb dn lc ld le dp lf jy lg lh li kc lj lk ll kg lm ln lo lp bi translated">部署前测试</h2><p id="f446" class="pw-post-body-paragraph jn jo iq jp b jq mq js jt ju mr jw jx jy ms ka kb kc mt ke kf kg mu ki kj kk ij bi translated">只有当所有测试都通过时，才允许部署，这是一个好的实践。您可以通过像这样设置<code class="fe ne nf ng mw b">package.json</code>脚本来实现:</p><pre class="km kn ko kp gt mv mw mx my aw mz bi"><span id="9246" class="kx ky iq mw b gy na nb l nc nd">"scripts": {<br/>    "build": "tsc",<br/>    "deploy": "npm run build &amp;&amp; npm run test &amp;&amp; serverless deploy",<br/>    "test": "BASE_URL=<a class="ae mp" href="https://example.com" rel="noopener ugc nofollow" target="_blank">https://example.com</a> jest --bail --coverage --coverageDirectory=output/coverage/jest"<br/>  },</span></pre><p id="9d67" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在，如果您使用<code class="fe ne nf ng mw b">npm run deploy</code>进行部署，您的测试将会运行，如果有测试失败，部署将不会继续。</p></div><div class="ab cl oh oi hu oj" role="separator"><span class="ok bw bk ol om on"/><span class="ok bw bk ol om on"/><span class="ok bw bk ol om"/></div><div class="ij ik il im in"><p id="37d3" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我希望我已经向你展示了足够多的东西来吸引你投入到你自己的项目中去尝试<code class="fe ne nf ng mw b">Jest</code>。在我的下一篇文章中，我将介绍模仿和刺探，包括一种以保持状态并可用于集成测试的方式模仿云数据库的实用方法。</p></div></div>    
</body>
</html>