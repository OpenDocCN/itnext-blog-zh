<html>
<head>
<title>[Nodejs] Managing thousand of task, @pscraper/taskm</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">[Nodejs]管理数千个任务</h1>
<blockquote>原文：<a href="https://itnext.io/nodejs-managing-thousand-of-task-pscraper-taskm-2eadfb357fc8?source=collection_archive---------4-----------------------#2020-01-12">https://itnext.io/nodejs-managing-thousand-of-task-pscraper-taskm-2eadfb357fc8?source=collection_archive---------4-----------------------#2020-01-12</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/231958cc1f45535e776190e6e6f07961.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*tKkQwzwhGexr_zaL.jpeg"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">[Nodejs]管理数千个任务</figcaption></figure><p id="d13a" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">每个程序员都应该经历过，使用for-loop来处理大量的任务。比如下载999，999，999张图片，从某论坛抓取999个网站。如果一切顺利，For-Loop是好的，但是每当出现异常(尤其是与HTTP/Internet相关的作业)并导致程序停止时。我们通常怎么处理是<code class="fe la lb lc ld b">Restart</code>，你永远不知道运气什么时候会来结束它。</p></div><div class="ab cl le lf hu lg" role="separator"><span class="lh bw bk li lj lk"/><span class="lh bw bk li lj lk"/><span class="lh bw bk li lj"/></div><div class="ij ik il im in"><p id="ad27" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">这个库用于管理大量任务，通过将每个任务添加到队列<em class="ll"> (sqlite) </em>，并消化队列中的每个项目。这些是使用<code class="fe la lb lc ld b">taskm</code>的原因:</p><ul class=""><li id="12c4" class="lm ln iq ke b kf kg kj kk kn lo kr lp kv lq kz lr ls lt lu bi translated">你有大量的任务要处理，一个异常可能会导致脚本从头开始</li><li id="6954" class="lm ln iq ke b kf lv kj lw kn lx kr ly kv lz kz lr ls lt lu bi translated">你有大量的任务要处理，需要知道有多少是<code class="fe la lb lc ld b">pending</code>、<code class="fe la lb lc ld b">finished</code>和<code class="fe la lb lc ld b">fail</code></li><li id="2423" class="lm ln iq ke b kf lv kj lw kn lx kr ly kv lz kz lr ls lt lu bi translated">你有大量的任务要处理，而这些任务可以被多台计算机消化</li></ul><p id="4a95" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">(<code class="fe la lb lc ld b">sqlite</code>用于管理队列)</p><h1 id="fa6e" class="ma mb iq bd mc md me mf mg mh mi mj mk ml mm mn mo mp mq mr ms mt mu mv mw mx bi translated">安装</h1><pre class="my mz na nb gt nc ld nd ne aw nf bi"><span id="417a" class="ng mb iq ld b gy nh ni l nj nk">$ yarn add @pscraper/taskm</span><span id="dd6f" class="ng mb iq ld b gy nl ni l nj nk">or <br/></span><span id="c938" class="ng mb iq ld b gy nl ni l nj nk">$ npm install @pscraper/taskm</span></pre><h1 id="7d4a" class="ma mb iq bd mc md me mf mg mh mi mj mk ml mm mn mo mp mq mr ms mt mu mv mw mx bi translated">示例1 (FIFO)</h1><p id="c06d" class="pw-post-body-paragraph kc kd iq ke b kf nm kh ki kj nn kl km kn no kp kq kr np kt ku kv nq kx ky kz ij bi translated">查找更多示例:<a class="ae nr" href="https://github.com/wahengchang/pscraper/tree/master/packages/demo/taskm" rel="noopener ugc nofollow" target="_blank">https://github . com/wahengchang/pscraper/tree/master/packages/demo/taskm</a></p><p id="1b68" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">向队列添加新任务(FIFO)</p><figure class="my mz na nb gt jr gh gi paragraph-image"><div class="gh gi ns"><img src="../Images/32f115cab94b23fb558a48ecd75f1424.png" data-original-src="https://miro.medium.com/v2/resize:fit:882/format:webp/0*skGIhtfs2gVhf91A.jpg"/></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">[Nodejs]管理数千个任务</figcaption></figure><pre class="my mz na nb gt nc ld nd ne aw nf bi"><span id="739f" class="ng mb iq ld b gy nh ni l nj nk">const TM = require('@pscraper/taskm')<br/>const taskm = new TM()<br/>await taskm.init()</span><span id="2c4e" class="ng mb iq ld b gy nl ni l nj nk">const uniqueId = "amazingId"<br/>const options = {<br/>    title: 'amazingTitle',<br/>    meta: JSON.stringify({key: "key1"})<br/>}<br/>await taskm.add(uniqueId, options)</span></pre><p id="06ed" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">使用队列中的任务</p><pre class="my mz na nb gt nc ld nd ne aw nf bi"><span id="b1ce" class="ng mb iq ld b gy nh ni l nj nk">const TM = require('@pscraper/taskm')<br/>const taskm = new TM()<br/>await taskm.init()</span><span id="83c4" class="ng mb iq ld b gy nl ni l nj nk">const item = await taskm.getFirst()<br/>// do something<br/>await taskm.markFinished(item.id)</span></pre><h1 id="7061" class="ma mb iq bd mc md me mf mg mh mi mj mk ml mm mn mo mp mq mr ms mt mu mv mw mx bi translated">示例2(任务分配)</h1><figure class="my mz na nb gt jr gh gi paragraph-image"><div class="gh gi nt"><img src="../Images/f05a772376ce9a64eebce2e384b65a38.png" data-original-src="https://miro.medium.com/v2/resize:fit:1112/format:webp/0*t80l26YS65XxxNxV.jpg"/></div></figure><p id="6fd7" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">向队列添加新任务</p><pre class="my mz na nb gt nc ld nd ne aw nf bi"><span id="ad8a" class="ng mb iq ld b gy nh ni l nj nk">const TM = require('@pscraper/taskm')<br/>const taskm = new TM()<br/>await taskm.init()</span><span id="34b1" class="ng mb iq ld b gy nl ni l nj nk">for(let i =0 ; i&lt;999999; i++) {<br/>    const id = `mockId${new Date().getTime()}-${i}`<br/>    const title = `${id}-title-${i}`<br/>    inputList.push({id, title})<br/>    await taskm.add(id, {title})<br/>}</span></pre><p id="2c6f" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">从队列中消耗任务，通常在多个PC并行上运行</p><pre class="my mz na nb gt nc ld nd ne aw nf bi"><span id="767a" class="ng mb iq ld b gy nh ni l nj nk">const TM = require('@pscraper/taskm')<br/>const taskm = new TM()<br/>await taskm.init()</span><span id="2e4c" class="ng mb iq ld b gy nl ni l nj nk">const item = await taskm.getFirstRandom()<br/>// do something<br/>await taskm.markFinished(item.id)</span></pre><h1 id="9d71" class="ma mb iq bd mc md me mf mg mh mi mj mk ml mm mn mo mp mq mr ms mt mu mv mw mx bi translated">使用</h1><figure class="my mz na nb gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nu"><img src="../Images/8d88c0222ce410a2b8a45266412c79c9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*q0T0uyT4WnSWbMpLhwJEmg.png"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">[Nodejs]管理数千个任务</figcaption></figure><h1 id="626d" class="ma mb iq bd mc md me mf mg mh mi mj mk ml mm mn mo mp mq mr ms mt mu mv mw mx bi translated">参考:</h1><ul class=""><li id="077c" class="lm ln iq ke b kf nm kj nn kn nv kr nw kv nx kz lr ls lt lu bi translated"><a class="ae nr" href="https://www.freertos.org/Embedded-RTOS-Queues.html" rel="noopener ugc nofollow" target="_blank">https://www.freertos.org/Embedded-RTOS-Queues.html</a></li><li id="d09b" class="lm ln iq ke b kf lv kj lw kn lx kr ly kv lz kz lr ls lt lu bi translated"><a class="ae nr" href="https://github.com/wahengchang/pscraper/tree/master/packages/taskm" rel="noopener ugc nofollow" target="_blank">https://github . com/wahengchang/pscraper/tree/master/packages/taskm</a></li></ul></div></div>    
</body>
</html>