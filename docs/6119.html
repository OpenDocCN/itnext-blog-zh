<html>
<head>
<title>NestJS Project Starter with Multiple Database Connections using TypeORM and MySQL</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用TypeORM和MySQL的具有多个数据库连接的NestJS项目启动程序</h1>
<blockquote>原文：<a href="https://itnext.io/nestjs-project-starter-with-multiple-database-connection-using-typeorm-and-mysql-47150e282ed5?source=collection_archive---------0-----------------------#2021-08-26">https://itnext.io/nestjs-project-starter-with-multiple-database-connection-using-typeorm-and-mysql-47150e282ed5?source=collection_archive---------0-----------------------#2021-08-26</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/aa671eff9091cf38a35db0089ced4c96.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*zjbQKzeIt3UM1ezHkDvHNw.png"/></div></div></figure><p id="7319" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在这个简短的教程中，我将使用MySQL。第一步是创建一个新的Nestjs项目。你可以遵循官方的<a class="ae kw" href="https://docs.nestjs.com/" rel="noopener ugc nofollow" target="_blank">文档</a>或者使用下面的命令。</p><h2 id="d9fc" class="kx ky iq bd kz la lb dn lc ld le dp lf kj lg lh li kn lj lk ll kr lm ln lo lp bi translated">设置NestJS</h2><p id="aeb0" class="pw-post-body-paragraph jy jz iq ka b kb lq kd ke kf lr kh ki kj ls kl km kn lt kp kq kr lu kt ku kv ij bi translated">首先，让我们安装nest CLI工具。</p><pre class="lv lw lx ly gt lz ma mb mc aw md bi"><span id="b697" class="kx ky iq ma b gy me mf l mg mh">$ npm i -g @nestjs/cli</span></pre><p id="b361" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">接下来，让我们使用CLI初始化一个空项目</p><pre class="lv lw lx ly gt lz ma mb mc aw md bi"><span id="5bc4" class="kx ky iq ma b gy me mf l mg mh">$ nest new project-name</span></pre><p id="2b64" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">接下来，安装所需的npm软件包</p><pre class="lv lw lx ly gt lz ma mb mc aw md bi"><span id="8213" class="kx ky iq ma b gy me mf l mg mh">$ npm i --save @nestjs/core @nestjs/common rxjs reflect-metadata</span></pre><h2 id="b414" class="kx ky iq bd kz la lb dn lc ld le dp lf kj lg lh li kn lj lk ll kr lm ln lo lp bi translated">让我们使用Nest CLI生成一个模块</h2><p id="8372" class="pw-post-body-paragraph jy jz iq ka b kb lq kd ke kf lr kh ki kj ls kl km kn lt kp kq kr lu kt ku kv ij bi translated">为此，我们可以使用内置的CLI。生成比创建自己的控制器和服务要容易得多。使用以下命令生成所需的模块、服务和控制器。我将在<em class="mi"> src/modules/power-search </em>文件夹中生成一个名为power-search的新模块</p><pre class="lv lw lx ly gt lz ma mb mc aw md bi"><span id="3c49" class="kx ky iq ma b gy me mf l mg mh">$ nest g module modules/power-search<br/>$ nest g controller modules/power-search<br/>$ nest g service modules/power-search</span></pre><p id="2160" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">创建模块后，下一步是设置开发环境和数据库连接。</p><h2 id="a353" class="kx ky iq bd kz la lb dn lc ld le dp lf kj lg lh li kn lj lk ll kr lm ln lo lp bi translated">MySQL设置</h2><p id="4ecf" class="pw-post-body-paragraph jy jz iq ka b kb lq kd ke kf lr kh ki kj ls kl km kn lt kp kq kr lu kt ku kv ij bi translated">让我们首先设置我们的开发环境。我们将使用Docker来安装MySQL并在本地机器上运行它。复制下面的docker文件并使用<code class="fe mj mk ml ma b">docker-compose up</code>运行它。如果你想了解更多关于docker的信息，请参考<a class="ae kw" rel="noopener ugc nofollow" target="_blank" href="/lets-dockerize-a-nodejs-express-api-22700b4105e4">这篇文章</a>。</p><figure class="lv lw lx ly gt jr"><div class="bz fp l di"><div class="mm mn l"/></div></figure><p id="be80" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><em class="mi">因为我们需要另一个数据库，所以我使用init.sql脚本创建了它。将脚本复制到docker-compose位置。</em></p><figure class="lv lw lx ly gt jr"><div class="bz fp l di"><div class="mm mn l"/></div></figure><p id="4d0e" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">现在运行docker-compose，使用:</p><pre class="lv lw lx ly gt lz ma mb mc aw md bi"><span id="22c1" class="kx ky iq ma b gy me mf l mg mh">docker-compose up</span></pre><p id="0fc6" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">一些重要的docker命令</p><pre class="lv lw lx ly gt lz ma mb mc aw md bi"><span id="eb6c" class="kx ky iq ma b gy me mf l mg mh">docker-compose down # Removes the container<br/>docker-compose down -v # Remove the created volumes as well<br/>docker-compose up -d # -d will run the compose file in background<br/>docker-compose build # This will just build an image</span></pre><p id="a02d" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">因为我们已经完成了本地环境的设置。让我们安装TypeORM和相关的包。</p><h2 id="230a" class="kx ky iq bd kz la lb dn lc ld le dp lf kj lg lh li kn lj lk ll kr lm ln lo lp bi translated">NestJs上的Mysql</h2><p id="9585" class="pw-post-body-paragraph jy jz iq ka b kb lq kd ke kf lr kh ki kj ls kl km kn lt kp kq kr lu kt ku kv ij bi translated">对此，也可以参考官方<a class="ae kw" href="https://docs.nestjs.com/techniques/database" rel="noopener ugc nofollow" target="_blank">文档</a>。</p><pre class="lv lw lx ly gt lz ma mb mc aw md bi"><span id="8c5a" class="kx ky iq ma b gy me mf l mg mh">$ npm install --save @nestjs/typeorm typeorm mysql2</span></pre><p id="4162" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我们将使用一种简单的方法。首先，让我们在app.module.ts文件中将连接字符串创建为defaultOptions变量。</p><figure class="lv lw lx ly gt jr"><div class="bz fp l di"><div class="mm mn l"/></div></figure><p id="6f79" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我知道在API中硬编码密码或任何类型的凭证都不是一个好的做法。所以要去掉这个，使用一个<strong class="ka ir"> dotenv </strong>文件。NestJS有一个内置的配置管理包。</p><p id="3a40" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">如果您检查上面的代码，有2个连接对象。如果没有为连接提供名称，则名称将默认为'<em class="mi"> default </em>'。<strong class="ka ir">如果我们使用多个连接，必须为辅助连接提供一个名称！</strong></p><h2 id="2790" class="kx ky iq bd kz la lb dn lc ld le dp lf kj lg lh li kn lj lk ll kr lm ln lo lp bi translated">不那么混乱的方法</h2><p id="051c" class="pw-post-body-paragraph jy jz iq ka b kb lq kd ke kf lr kh ki kj ls kl km kn lt kp kq kr lu kt ku kv ij bi translated">我们可以使用ormconfig.json并将所有连接指定为一个数组，并使用该名称导入每个配置。但是截至目前，<strong class="ka ir">这个不行。希望在未来的版本中可以修复。</strong></p><h2 id="7272" class="kx ky iq bd kz la lb dn lc ld le dp lf kj lg lh li kn lj lk ll kr lm ln lo lp bi translated">NestJS应用程序设置</h2><p id="a79e" class="pw-post-body-paragraph jy jz iq ka b kb lq kd ke kf lr kh ki kj ls kl km kn lt kp kq kr lu kt ku kv ij bi translated">接下来，我们必须设置电源搜索模块。为此，请使用下面的代码示例。</p><figure class="lv lw lx ly gt jr"><div class="bz fp l di"><div class="mm mn l"/></div></figure><p id="7b3a" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">请注意，您必须使用import提供连接名称。如果使用默认连接，则无需指定名称。</p><pre class="lv lw lx ly gt lz ma mb mc aw md bi"><span id="3705" class="kx ky iq ma b gy me mf l mg mh">imports: [TypeOrmModule.forFeature([power_search], 'w')]</span></pre><p id="3106" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">尽管如此，我们还没有完成。如果我们要使用它，我们必须在power-search.service.ts中指定名称。否则，它不会识别power_search模型是'<strong class="ka ir"> w </strong>'连接的一部分。</p><figure class="lv lw lx ly gt jr"><div class="bz fp l di"><div class="mm mn l"/></div></figure><p id="2561" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">现在我们完成了。快乐编码，感谢你阅读这篇文章❤</p></div></div>    
</body>
</html>