<html>
<head>
<title>Monitoring your docker container’s logs the Loki way</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">以Loki的方式监控docker容器的日志</h1>
<blockquote>原文：<a href="https://itnext.io/monitoring-your-docker-containers-logs-the-loki-way-e9fdbae6bafd?source=collection_archive---------1-----------------------#2020-12-17">https://itnext.io/monitoring-your-docker-containers-logs-the-loki-way-e9fdbae6bafd?source=collection_archive---------1-----------------------#2020-12-17</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="575f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">大家好。最近，我的一个朋友偶然发现了一个任务，可以方便地监控docker容器的日志。</p><p id="03ae" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">当然，现在可以使用<code class="fe kl km kn ko b">docker logs</code>命令来跟踪任何容器的日志，但不能监控它们。我所说的监控是指，比如说，在你的日志的帮助下，在折线图或任何其他类型的可视化上，可视化你的容器中每小时发生的stderr的数量。</p><p id="d1bd" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">因此，在这篇博客中，我将带你轻松完成上述任务。</p><figure class="kq kr ks kt gt ku gh gi paragraph-image"><div role="button" tabindex="0" class="kv kw di kx bf ky"><div class="gh gi kp"><img src="../Images/46d9c4bc2e5c3207ac85b15da7e39235.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*qSPyk1FmClhsc3WT.png"/></div></div><figcaption class="lb lc gj gh gi ld le bd b be z dk translated"><a class="ae lf" href="https://grafana.com/img/home_panel_collage1.png" rel="noopener ugc nofollow" target="_blank">https://grafana.com/img/home_panel_collage1.png</a></figcaption></figure><h1 id="38d1" class="lg lh iq bd li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md bi translated">让我们首先深入研究这个问题</h1><p id="3e10" class="pw-post-body-paragraph jn jo iq jp b jq me js jt ju mf jw jx jy mg ka kb kc mh ke kf kg mi ki kj kk ij bi translated">我们的容器把它的日志放在某个地方，比如，在某种<code class="fe kl km kn ko b">.log</code>文件中。我们所需要的是一个工具，它可以收集和聚合这些日志，并查询这些日志，以发现诸如4xx的数量或“err”日志的数量等信息。</p><p id="5f69" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">另一个工具是把这些数字用图表显示出来。</p><h2 id="cfb1" class="mj lh iq bd li mk ml dn lm mm mn dp lq jy mo mp lu kc mq mr ly kg ms mt mc mu bi translated">我们在哪里可以找到我们容器的日志？</h2><p id="b5f8" class="pw-post-body-paragraph jn jo iq jp b jq me js jt ju mf jw jx jy mg ka kb kc mh ke kf kg mi ki kj kk ij bi translated">每个容器的日志都存储在其内部的某个地方，因为任何容器基本上都是一个在它的主机上运行的进程，所以在主机中一定有某个地方必须存储容器的日志。</p><p id="dcb0" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">嗯，那个地方是——<code class="fe kl km kn ko b">/var/lib/docker/&lt;container-id&gt;/&lt;container-id&gt;-json.log</code></p><p id="dedb" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">其中，<code class="fe kl km kn ko b">&lt;container-id&gt;</code>是您想要其日志的容器的ID。</p><p id="9929" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">因此，我们想要跟踪的所有STDOUT/STDERR日志都可以在这里找到。</p><h1 id="7e67" class="lg lh iq bd li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md bi translated">让我们探索一下我们将要使用的工具</h1><h2 id="c818" class="mj lh iq bd li mk ml dn lm mm mn dp lq jy mo mp lu kc mq mr ly kg ms mt mc mu bi translated">洛基</h2><p id="58a7" class="pw-post-body-paragraph jn jo iq jp b jq me js jt ju mf jw jx jy mg ka kb kc mh ke kf kg mi ki kj kk ij bi translated">这是Grafana实验室开发的一个奇妙的日志聚合器。如果你知道普罗米修斯，那么就把洛基想象成普罗米修斯，但只是为了日志(而不是度量)。</p><figure class="kq kr ks kt gt ku gh gi paragraph-image"><div class="gh gi mv"><img src="../Images/fa8742f4dd64a151a45fa3e44f1ae866.png" data-original-src="https://miro.medium.com/v2/resize:fit:1076/format:webp/0*GahEcKWkj6tKplxb.png"/></div><figcaption class="lb lc gj gh gi ld le bd b be z dk translated"><a class="ae lf" href="https://grafana.com/docs/loki/latest/logo_and_name.png" rel="noopener ugc nofollow" target="_blank">https://grafana.com/docs/loki/latest/logo_and_name.png</a></figcaption></figure><p id="149b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">您可以在Loki上查询大量各种各样的日志，而且性能非常好，因为它并不索引提供给它的日志流的全部内容，而是通过promtail提供给它的一堆标签来索引日志。说到这个…</p><h2 id="1d2a" class="mj lh iq bd li mk ml dn lm mm mn dp lq jy mo mp lu kc mq mr ly kg ms mt mc mu bi translated">Promtail</h2><p id="8633" class="pw-post-body-paragraph jn jo iq jp b jq me js jt ju mf jw jx jy mg ka kb kc mh ke kf kg mi ki kj kk ij bi translated">它是一个代理(Grafana的另一个代理),将读取日志文件的内容，并将这些日志发送到Loki实例。此外，使用promtail，您可以进一步向不同种类的日志添加标签。</p><p id="d23d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">例如，如果你让promtail读取十个<code class="fe kl km kn ko b">*.log</code>文件，那么，你可以让promtail用一些标识符/标签来标记它们，这样，将来当你监视和查询它们时，你和Loki端的performant都会很方便，因为日志会在那些标签上被索引。</p><p id="bdc6" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果你感到困惑，没关系。我将带你经历这整件事，让你有一个更清楚的想法。</p><h2 id="d37e" class="mj lh iq bd li mk ml dn lm mm mn dp lq jy mo mp lu kc mq mr ly kg ms mt mc mu bi translated">格拉夫纳</h2><p id="25a4" class="pw-post-body-paragraph jn jo iq jp b jq me js jt ju mf jw jx jy mg ka kb kc mh ke kf kg mi ki kj kk ij bi translated">它是一个可视化不同种类数据存储中的数据的工具。你也可以在Prometheus、Cloudwatch、InfluxDB和Loki(以及许多其他来源)中可视化和监控数据。</p><p id="4e0c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们将创建一个图形/图表/面板(无论你怎么称呼它们)的仪表板来“监控”我们的docker容器的日志。</p><figure class="kq kr ks kt gt ku gh gi paragraph-image"><div role="button" tabindex="0" class="kv kw di kx bf ky"><div class="gh gi mw"><img src="../Images/f88e1461a28125519f6c135b4f37f78d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*fooHwCWdiu2EQ-IU.png"/></div></div><figcaption class="lb lc gj gh gi ld le bd b be z dk translated"><a class="ae lf" href="https://stitch-microverse.s3.amazonaws.com/uploads/domains/grafana-logo.png" rel="noopener ugc nofollow" target="_blank">https://stitch-microverse . S3 . Amazon AWS . com/uploads/domains/grafana-logo . png</a></figcaption></figure><blockquote class="mx my mz"><p id="81cd" class="jn jo na jp b jq jr js jt ju jv jw jx nb jz ka kb nc kd ke kf nd kh ki kj kk ij bi translated">给那些可能会想“为什么这家伙要用promtail”的人提个醒？他可以通过使用loki的docker驱动程序客户端简单地完成这项任务。谢谢你的关心:是的，我非常清楚使用loki的docker驱动程序。尽管如此，我在这里还是选择了使用promtail的更长的路线，因为通过这篇文章，我还打算向读者传达如何设置和配置promtail以及用它来发布日志:D</p><p id="6c39" class="jn jo na jp b jq jr js jt ju jv jw jx nb jz ka kb nc kd ke kf nd kh ki kj kk ij bi translated">不过，如果你想深入研究loki docker驱动程序的兔子洞，一定要看看这个</p><p id="9c35" class="jn jo na jp b jq jr js jt ju jv jw jx nb jz ka kb nc kd ke kf nd kh ki kj kk ij bi translated">休息，我期待着写一篇关于实现我们的任务使用loki-docker-driver too :D</p></blockquote><h1 id="6407" class="lg lh iq bd li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md bi translated">装置</h1><h2 id="4c55" class="mj lh iq bd li mk ml dn lm mm mn dp lq jy mo mp lu kc mq mr ly kg ms mt mc mu bi translated">洛基</h2><figure class="kq kr ks kt gt ku"><div class="bz fp l di"><div class="ne nf l"/></div></figure><h2 id="0377" class="mj lh iq bd li mk ml dn lm mm mn dp lq jy mo mp lu kc mq mr ly kg ms mt mc mu bi translated">Promtail</h2><figure class="kq kr ks kt gt ku"><div class="bz fp l di"><div class="ne nf l"/></div></figure><h2 id="ce33" class="mj lh iq bd li mk ml dn lm mm mn dp lq jy mo mp lu kc mq mr ly kg ms mt mc mu bi translated">格拉夫纳</h2><figure class="kq kr ks kt gt ku"><div class="bz fp l di"><div class="ne nf l"/></div></figure><h1 id="8ad1" class="lg lh iq bd li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md bi translated">设置东西</h1><h2 id="8fc1" class="mj lh iq bd li mk ml dn lm mm mn dp lq jy mo mp lu kc mq mr ly kg ms mt mc mu bi translated">洛基</h2><p id="d01a" class="pw-post-body-paragraph jn jo iq jp b jq me js jt ju mf jw jx jy mg ka kb kc mh ke kf kg mi ki kj kk ij bi translated">创建名为<code class="fe kl km kn ko b">loki-config.yaml</code>的loki配置文件</p><figure class="kq kr ks kt gt ku"><div class="bz fp l di"><div class="ne nf l"/></div></figure><p id="c5e9" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">不要担心，你不需要了解这个YAML。这些只是Loki的一些内部配置，由Grafana人员提供。</p><p id="d2a3" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在，运行洛基</p><pre class="kq kr ks kt gt ng ko nh ni aw nj bi"><span id="6a3c" class="mj lh iq ko b gy nk nl l nm nn">loki -config.file loki-config.yaml</span></pre><figure class="kq kr ks kt gt ku gh gi paragraph-image"><div role="button" tabindex="0" class="kv kw di kx bf ky"><div class="gh gi no"><img src="../Images/9180bc7be5ccd46e6b8034365aa7cbb4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*_8z50H8r8ZBiHrw2_cRpGQ.png"/></div></div></figure><p id="572c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">最小化这个终端，打开另一个终端来处理其他东西，比如promtail。</p><h2 id="f1aa" class="mj lh iq bd li mk ml dn lm mm mn dp lq jy mo mp lu kc mq mr ly kg ms mt mc mu bi translated">Promtail</h2><p id="13ef" class="pw-post-body-paragraph jn jo iq jp b jq me js jt ju mf jw jx jy mg ka kb kc mh ke kf kg mi ki kj kk ij bi translated">我们必须首先编写一个配置文件，该文件将告诉我们的promtail进程有关要读取哪个日志文件、要将哪些标签附加到日志上、这些日志应该被扔向哪个loki服务器等等的细节。</p><p id="5392" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在我们的例子中，我有一个容器</p><pre class="kq kr ks kt gt ng ko nh ni aw nj bi"><span id="cf25" class="mj lh iq ko b gy nk nl l nm nn">► docker container ps<br/>CONTAINER ID        IMAGE                          <br/>561b53013031        chentex/random-logger:latest</span></pre><p id="7ccc" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">使用这个容器ID，我们可以找到它的日志在主机上的确切位置。</p><p id="6daa" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">那就是</p><p id="c5f2" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><code class="fe kl km kn ko b">/var/lib/docker/containers/561b53013031*/561b53013031*.log</code></p><blockquote class="mx my mz"><p id="234c" class="jn jo na jp b jq jr js jt ju jv jw jx nb jz ka kb nc kd ke kf nd kh ki kj kk ij bi translated"><strong class="jp ir">为什么通配符(*)与容器id一起出现？</strong></p><p id="ca14" class="jn jo na jp b jq jr js jt ju jv jw jx nb jz ka kb nc kd ke kf nd kh ki kj kk ij bi translated">上面的容器ID不是完整的容器ID。它被截断以适合显示器。但是我们不需要完整的容器id。所以，通过写<code class="fe kl km kn ko b">561b53013031*</code>，我们告诉我们的计算机找到以<code class="fe kl km kn ko b">561b53013031*</code>开始的容器</p></blockquote><p id="716e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在，根据以上信息，我们将为我们的YAML编写配置(promtail-config.yaml)</p><figure class="kq kr ks kt gt ku"><div class="bz fp l di"><div class="ne nf l"/></div></figure><p id="ea9c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在，用sudo运行promtail(因为它试图抓取的日志文件需要sudo权限才能访问)</p><pre class="kq kr ks kt gt ng ko nh ni aw nj bi"><span id="f3e5" class="mj lh iq ko b gy nk nl l nm nn">sudo promtail -config.file promtail-config.yaml</span></pre><figure class="kq kr ks kt gt ku gh gi paragraph-image"><div role="button" tabindex="0" class="kv kw di kx bf ky"><div class="gh gi np"><img src="../Images/6a512544d7c31f9cef1235de1972265b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*iWeKxUjWo03YvYETgzRtrg.png"/></div></div></figure><h2 id="8d56" class="mj lh iq bd li mk ml dn lm mm mn dp lq jy mo mp lu kc mq mr ly kg ms mt mc mu bi translated">格拉夫纳</h2><ul class=""><li id="34a5" class="nq nr iq jp b jq me ju mf jy ns kc nt kg nu kk nv nw nx ny bi translated">通过输入以下命令启动grafana</li></ul><pre class="kq kr ks kt gt ng ko nh ni aw nj bi"><span id="e35d" class="mj lh iq ko b gy nk nl l nm nn">sudo systemctl start grafana-server<!-- --> </span></pre><ul class=""><li id="de11" class="nq nr iq jp b jq jr ju jv jy nz kc oa kg ob kk nv nw nx ny bi translated">这将在<a class="ae lf" href="http://localhost:3000" rel="noopener ugc nofollow" target="_blank"> http://localhost:3000 </a>启动grafana</li><li id="b01d" class="nq nr iq jp b jq oc ju od jy oe kc of kg og kk nv nw nx ny bi translated">转到该地址，使用用户名“admin”和密码“admin”登录</li><li id="39cd" class="nq nr iq jp b jq oc ju od jy oe kc of kg og kk nv nw nx ny bi translated">你会看到这个</li></ul><figure class="kq kr ks kt gt ku gh gi paragraph-image"><div role="button" tabindex="0" class="kv kw di kx bf ky"><div class="gh gi oh"><img src="../Images/c0dfa19af989e2a3c09939940b6c82d2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*4tMmSy1Nh43y9M_4yQJ-8Q.png"/></div></div></figure><ul class=""><li id="ea14" class="nq nr iq jp b jq jr ju jv jy nz kc oa kg ob kk nv nw nx ny bi translated">现在，将光标移至左侧的导航抽屉，悬停在<em class="na">齿轮图标(倒数第二个)</em>上，然后单击数据源。</li><li id="156f" class="nq nr iq jp b jq oc ju od jy oe kc of kg og kk nv nw nx ny bi translated">点击“添加数据源”并搜索Loki并点击它。</li><li id="24c0" class="nq nr iq jp b jq oc ju od jy oe kc of kg og kk nv nw nx ny bi translated">将打开一个表单，只需输入名称“loki”(或其他名称)和URL“http://localhost:3100”(因为这是我们的Loki服务器运行的地址)</li><li id="5df9" class="nq nr iq jp b jq oc ju od jy oe kc of kg og kk nv nw nx ny bi translated">然后，点击“保存并测试”。应该是这样的</li></ul><figure class="kq kr ks kt gt ku gh gi paragraph-image"><div role="button" tabindex="0" class="kv kw di kx bf ky"><div class="gh gi oi"><img src="../Images/8b37528466d15f927f50b7640fdbaab9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*QKKw--HX5pfzmNJXZQ2utQ.png"/></div></div></figure><p id="99f0" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">就这样了。我希望你还和我在一起</p><p id="c496" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">别担心，95%的工作已经完成了</p><h1 id="7ed2" class="lg lh iq bd li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md bi translated">最后，有趣的部分——可视化</h1><p id="4475" class="pw-post-body-paragraph jn jo iq jp b jq me js jt ju mf jw jx jy mg ka kb kc mh ke kf kg mi ki kj kk ij bi translated">我们将创建一个包含多个图表的仪表板，</p><ul class=""><li id="532d" class="nq nr iq jp b jq jr ju jv jy nz kc oa kg ob kk nv nw nx ny bi translated">表示该容器的“信息”和“调试”日志计数趋势的折线图。</li><li id="7a14" class="nq nr iq jp b jq oc ju od jy oe kc of kg og kk nv nw nx ny bi translated">表示该容器的日志总数的5分钟速率趋势的折线图。</li><li id="4bb6" class="nq nr iq jp b jq oc ju od jy oe kc of kg og kk nv nw nx ny bi translated">和其他一些东西:P</li></ul><p id="d206" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在上面的截图中，转到左边抽屉的“+”图标，点击“仪表板”</p><p id="0b59" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在，点击“添加新面板”按钮。这将打开设计一个面板的控制台。</p><p id="0fdf" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><em class="na">面板基本上是一个图形或图表</em></p><h2 id="c7dd" class="mj lh iq bd li mk ml dn lm mm mn dp lq jy mo mp lu kc mq mr ly kg ms mt mc mu bi translated">第一个面板—日志计数可视化</h2><p id="737a" class="pw-post-body-paragraph jn jo iq jp b jq me js jt ju mf jw jx jy mg ka kb kc mh ke kf kg mi ki kj kk ij bi translated">我们将让这个面板显示一个折线图，表示我们的容器的“INFO”、“DEBUG”和“ERROR”级别日志的趋势。</p><p id="a74f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这里有一个查询，用于查找我们容器的“信息”级日志。添加到面板窗口下的查询字段。</p><pre class="kq kr ks kt gt ng ko nh ni aw nj bi"><span id="47da" class="mj lh iq ko b gy nk nl l nm nn">count_over_time( {job="my-container"} |~ "INFO" [5m])</span></pre><blockquote class="mx my mz"><p id="1c80" class="jn jo na jp b jq jr js jt ju jv jw jx nb jz ka kb nc kd ke kf nd kh ki kj kk ij bi translated">记住我们的promtail配置。我们用<code class="fe kl km kn ko b">job: my-container</code>和另一个标签<code class="fe kl km kn ko b">host: localhost</code>标记所有的集装箱日志。因此，<code class="fe kl km kn ko b">{job="my-container"}</code>告诉loki只查询与上述标签对应的日志，这对应于我们容器的所有日志。</p><p id="5ef5" class="jn jo na jp b jq jr js jt ju jv jw jx nb jz ka kb nc kd ke kf nd kh ki kj kk ij bi translated"><code class="fe kl km kn ko b">|~ “INFO”</code>意味着从上述所有日志中，只过滤那些包含“INFO”一词的日志行。</p><p id="4946" class="jn jo na jp b jq jr js jt ju jv jw jx nb jz ka kb nc kd ke kf nd kh ki kj kk ij bi translated">最后，<code class="fe kl km kn ko b">count_over_time</code>和<code class="fe kl km kn ko b">[5m]</code>告诉loki在任意时刻的最后5分钟获取以上“信息”级别日志的计数。因此，如果我在晚上10:00执行这个查询，它将返回从晚上9:55到晚上10:00(最后5分钟)的“INFO”级别日志的计数。</p></blockquote><p id="d2e4" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">单击“<em class="na">添加查询</em>”按钮，类似地，粘贴以下查询以获取“调试”级别日志的5分钟计数。</p><pre class="kq kr ks kt gt ng ko nh ni aw nj bi"><span id="c87c" class="mj lh iq ko b gy nk nl l nm nn">count_over_time( {job="my-container"} |~ "DEBUG" [5m])</span></pre><p id="ff4b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">单击“<em class="na">添加查询</em>”按钮，类似地，粘贴以下查询以获取“调试”级别日志的5分钟计数。</p><pre class="kq kr ks kt gt ng ko nh ni aw nj bi"><span id="df20" class="mj lh iq ko b gy nk nl l nm nn">count_over_time( {job="my-container"} |~ "ERROR" [5m])</span></pre><p id="441a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">看起来就是这样</p><figure class="kq kr ks kt gt ku gh gi paragraph-image"><div role="button" tabindex="0" class="kv kw di kx bf ky"><div class="gh gi oh"><img src="../Images/fcf6d2c17e612f568c4562502ab46a2a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*n5fhCip_ODwFtFPzSeiXvw.png"/></div></div></figure><p id="2725" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">编辑面板标题(如果您愿意),并点击右上角的“应用”。</p><figure class="kq kr ks kt gt ku gh gi paragraph-image"><div role="button" tabindex="0" class="kv kw di kx bf ky"><div class="gh gi oh"><img src="../Images/f96689a27028e301b18653c2970aea64.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*dXYggaAx5wfs-VerJH11vg.png"/></div></div><figcaption class="lb lc gj gh gi ld le bd b be z dk translated">仪表板，应用上述面板后</figcaption></figure><h2 id="3760" class="mj lh iq bd li mk ml dn lm mm mn dp lq jy mo mp lu kc mq mr ly kg ms mt mc mu bi translated">第二个面板—总日志的10分钟速率</h2><p id="1c9b" class="pw-post-body-paragraph jn jo iq jp b jq me js jt ju mf jw jx jy mg ka kb kc mh ke kf kg mi ki kj kk ij bi translated">该面板将显示由容器生成的日志总数的10分钟比率。</p><figure class="kq kr ks kt gt ku gh gi paragraph-image"><div role="button" tabindex="0" class="kv kw di kx bf ky"><div class="gh gi oj"><img src="../Images/b143d45b14e33c57ebb54b91de40180e.png" data-original-src="https://miro.medium.com/v2/resize:fit:654/format:webp/1*bVoKohXha5rCseMxsNnTXg.png"/></div></div></figure><p id="7403" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">点击此按钮(右上角)在同一个仪表板中创建一个新面板，然后点击“添加新面板”</p><p id="d4ee" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">使用以下查询获取10分钟内的日志总数。</p><pre class="kq kr ks kt gt ng ko nh ni aw nj bi"><span id="dba6" class="mj lh iq ko b gy nk nl l nm nn">rate( {job="my-container"} [1m] )*10*60</span></pre><blockquote class="mx my mz"><p id="a6c6" class="jn jo na jp b jq jr js jt ju jv jw jx nb jz ka kb nc kd ke kf nd kh ki kj kk ij bi translated">这里，<code class="fe kl km kn ko b">{job="my-container"}</code>正在获取容器的所有日志。</p><p id="2b88" class="jn jo na jp b jq jr js jt ju jv jw jx nb jz ka kb nc kd ke kf nd kh ki kj kk ij bi translated"><code class="fe kl km kn ko b">rate</code>和<code class="fe kl km kn ko b">[1m]</code>正在获取过去1分钟内“每秒”接收的日志数量。例如，从晚上9:59到晚上10:00(从晚上10:00开始的最后一分钟)，添加了120个日志条目。因此，<code class="fe kl km kn ko b">rate</code>和<code class="fe kl km kn ko b">[1m]</code>会给出每秒的速率= 120/60 = 2</p><p id="b6be" class="jn jo na jp b jq jr js jt ju jv jw jx nb jz ka kb nc kd ke kf nd kh ki kj kk ij bi translated">最后，<code class="fe kl km kn ko b">10*60</code>用于将上述“每秒”速率转换为“10分钟速率”(10分钟= 10*60秒)</p></blockquote><p id="c557" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">编辑面板标题并应用它。</p><p id="8514" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">您甚至可以创建一个日志面板，在面板窗口上显示日志(文本日志)。</p><p id="1390" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">例如，以下查询将跟踪“错误”日志</p><pre class="kq kr ks kt gt ng ko nh ni aw nj bi"><span id="ad32" class="mj lh iq ko b gy nk nl l nm nn">{job="my-container"} |~ "ERROR"</span></pre><h2 id="b434" class="mj lh iq bd li mk ml dn lm mm mn dp lq jy mo mp lu kc mq mr ly kg ms mt mc mu bi translated">仪表板最终看起来怎么样</h2><figure class="kq kr ks kt gt ku gh gi paragraph-image"><div role="button" tabindex="0" class="kv kw di kx bf ky"><div class="gh gi oh"><img src="../Images/695a88b6341ff7910e9a65ddc4d164ca.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*KICzsOEH62tXAJr4wUbVKA.png"/></div></div></figure><h1 id="affe" class="lg lh iq bd li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md bi translated">我想就这样吧</h1><p id="76dc" class="pw-post-body-paragraph jn jo iq jp b jq me js jt ju mf jw jx jy mg ka kb kc mh ke kf kg mi ki kj kk ij bi translated">如果你能到达这里，非常感谢。</p><p id="cc69" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我希望您喜欢这篇文章，并理解如何使用Loki/Promtail/Grafana监控容器的日志。此外，正如我提到的，我期待着写一篇文章，通过使用loki-docker-driver客户端更方便地完成上述任务。所以，敬请关注:)</p><p id="f06e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果您有任何疑问或其他问题，请在下面的评论中提出，或者我们也可以联系:</p><p id="3b0d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">推特—<a class="ae lf" href="https://twitter.com/yashkukreja98" rel="noopener ugc nofollow" target="_blank">https://twitter.com/yashkukreja98</a></p><p id="3a5a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">LinkedIn—<a class="ae lf" href="https://www.linkedin.com/in/yashvardhan-kukreja" rel="noopener ugc nofollow" target="_blank">https://www.linkedin.com/in/yashvardhan-kukreja</a></p><p id="a297" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">再见！</p></div></div>    
</body>
</html>