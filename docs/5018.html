<html>
<head>
<title>Azure Administration: Run Commands against a VMSS Instance from CLI</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Azure管理:从CLI对VMSS实例运行命令</h1>
<blockquote>原文：<a href="https://itnext.io/run-commands-against-a-vmss-instance-from-cli-8575a9ad43b1?source=collection_archive---------2-----------------------#2020-11-17">https://itnext.io/run-commands-against-a-vmss-instance-from-cli-8575a9ad43b1?source=collection_archive---------2-----------------------#2020-11-17</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><ul class=""><li id="9bf0" class="jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke bi translated"><a class="ae kf" href="#2160" rel="noopener ugc nofollow">底线靠前</a></li><li id="726e" class="jn jo iq jp b jq kg js kh ju ki jw kj jy kk ka kb kc kd ke bi translated"><a class="ae kf" href="#ad09" rel="noopener ugc nofollow">使用CLI访问虚拟机</a></li><li id="0b06" class="jn jo iq jp b jq kg js kh ju ki jw kj jy kk ka kb kc kd ke bi translated"><a class="ae kf" href="#ee10" rel="noopener ugc nofollow">准备运行命令</a></li><li id="fa4a" class="jn jo iq jp b jq kg js kh ju ki jw kj jy kk ka kb kc kd ke bi translated"><a class="ae kf" href="#ce06" rel="noopener ugc nofollow">运行AZ vmss运行命令</a></li><li id="b94c" class="jn jo iq jp b jq kg js kh ju ki jw kj jy kk ka kb kc kd ke bi translated"><a class="ae kf" href="#f55c" rel="noopener ugc nofollow">附加信息</a></li></ul><h1 id="2160" class="kl km iq bd kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li bi translated">BLUF</h1><blockquote class="lj lk ll"><p id="b9ab" class="lm ln lo jp b jq jr lp lq js jt lr ls lt lu lv lw lx ly lz ma mb mc md me ka ij bi translated">底线在前面</p></blockquote><p id="432b" class="pw-post-body-paragraph lm ln iq jp b jq jr lp lq js jt lr ls ju lu lv lw jw ly lz ma jy mc md me ka ij bi translated"><code class="fe mf mg mh mi b">az vmss run-command</code>可用于影响变更或从您的虚拟机收集信息，而无需直接访问它们。执行时，shell命令作为管理员对虚拟机运行。</p><p id="ac42" class="pw-post-body-paragraph lm ln iq jp b jq jr lp lq js jt lr ls ju lu lv lw jw ly lz ma jy mc md me ka ij bi translated">如果出于某种原因，您无法通过其他方式来管理虚拟机，那么可以使用这种方法间接获得紧急访问权来管理虚拟机。这包括帐户管理，即:创建帐户，重置密码，获取网络信息等。</p><ol class=""><li id="0989" class="jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka mj kc kd ke bi translated">使用<code class="fe mf mg mh mi b">az vmss list</code>收集您想要运行命令的秤台信息</li><li id="ec08" class="jn jo iq jp b jq kg js kh ju ki jw kj jy kk ka mj kc kd ke bi translated">使用<code class="fe mf mg mh mi b">Name</code>和<code class="fe mf mg mh mi b">ResourceGroup</code>，您可以通过运行<code class="fe mf mg mh mi b">az vmss list-instances -n NameOfScaleSet -g ResourceGroup</code>获得一个实例(虚拟机)列表</li><li id="6f8d" class="jn jo iq jp b jq kg js kh ju ki jw kj jy kk ka mj kc kd ke bi translated">对实例运行您的命令，例如，如果我想检查一个帐户的到期时间:<code class="fe mf mg mh mi b">az vmss run-command invoke --comand-id RunShellScript --instance-id 0 -n aks-agentpool10544296-vmss -g MC_KUBERG_KUBEAKS_WESTUS2 --scripts "sudo chage -l azureuser"</code></li></ol><figure class="ml mm mn mo gt mp gh gi paragraph-image"><div role="button" tabindex="0" class="mq mr di ms bf mt"><div class="gh gi mk"><img src="../Images/af19cdaae4ab364b323d2cb1063fb143.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*k8CgsMVSX-nSxG5ItVeC1A.png"/></div></div><figcaption class="mw mx gj gh gi my mz bd b be z dk translated">输出就在那里，如果你想做一点工作，它可以变得很漂亮</figcaption></figure><h1 id="ad09" class="kl km iq bd kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li bi translated">使用命令行界面访问虚拟机</h1><blockquote class="lj lk ll"><p id="cb04" class="lm ln lo jp b jq jr lp lq js jt lr ls lt lu lv lw lx ly lz ma mb mc md me ka ij bi translated">紧急访问、管理等</p></blockquote><p id="df46" class="pw-post-body-paragraph lm ln iq jp b jq jr lp lq js jt lr ls ju lu lv lw jw ly lz ma jy mc md me ka ij bi translated">令我惊讶的是，有这么多人不知道az vmss run-command有多么强大和有用。所以我想告诉你，亲爱的读者，如何使用这个优秀的命令，希望能对你有所帮助。</p><p id="055d" class="pw-post-body-paragraph lm ln iq jp b jq jr lp lq js jt lr ls ju lu lv lw jw ly lz ma jy mc md me ka ij bi translated">我不得不在很多场合下用它来帮助自己和他人。一般来说，我使用它的大部分经验都是围绕着识别和修复虚拟机本身的问题。很多时候，过期的帐户或命令会破坏以更传统的方式(如SSH)管理虚拟机的能力。</p><p id="b75b" class="pw-post-body-paragraph lm ln iq jp b jq jr lp lq js jt lr ls ju lu lv lw jw ly lz ma jy mc md me ka ij bi translated">现在我要告诉你的是，所有的输出都是标准输出，根本没有格式化，所以如果你想得到大量的数据，它会变得很混乱。仅供参考。</p><h1 id="ee10" class="kl km iq bd kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li bi translated">准备运行命令</h1><p id="1e1b" class="pw-post-body-paragraph lm ln iq jp b jq na lp lq js nb lr ls ju nc lv lw jw nd lz ma jy ne md me ka ij bi translated">在我告诉你如何使用这个命令之前，我需要你理解一个基本的比例设置。在一个规模集中，单个虚拟机被称为实例，需要正确地调用这些实例以确保您的命令成功。让我们用我的一个例子。我将直接从Azure Portal CLI运行这些命令，但是只要您安装了az cli，就可以从任何地方运行它。</p><ol class=""><li id="c572" class="jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka mj kc kd ke bi translated">使用<code class="fe mf mg mh mi b">az vmss list -o table</code>命令确定您希望运行命令的VMSS。</li></ol><figure class="ml mm mn mo gt mp gh gi paragraph-image"><div role="button" tabindex="0" class="mq mr di ms bf mt"><div class="gh gi nf"><img src="../Images/4ee39dc84f4903a8793fefea8d9d2d8a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*NWrhpDEjhKpQMPPlA_b7yg.png"/></div></div><figcaption class="mw mx gj gh gi my mz bd b be z dk translated">az vmss列表-o表</figcaption></figure><p id="e544" class="pw-post-body-paragraph lm ln iq jp b jq jr lp lq js jt lr ls ju lu lv lw jw ly lz ma jy mc md me ka ij bi translated">2.使用上面命令中列出的名称和资源组，使用输出运行<code class="fe mf mg mh mi b">az vmss list-instances</code>命令。</p><figure class="ml mm mn mo gt mp gh gi paragraph-image"><div role="button" tabindex="0" class="mq mr di ms bf mt"><div class="gh gi ng"><img src="../Images/e51fbc7475315d1f26890be0268bb9d8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ObC1zAe_GaQ9WUfikG3h7Q.png"/></div></div><figcaption class="mw mx gj gh gi my mz bd b be z dk translated">az vmss列表-实例-n aks-agent pool-10544296-vmss-g MC _ KUBERG _ KUBEAKS _ westus 2-o表</figcaption></figure><h1 id="ce06" class="kl km iq bd kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li bi translated">运行az vmss run-command…命令</h1><p id="8284" class="pw-post-body-paragraph lm ln iq jp b jq na lp lq js nb lr ls ju nc lv lw jw nd lz ma jy ne md me ka ij bi translated">很好，现在我们有了实际运行命令所需的所有信息。呜！现在我们需要执行run-command并调用它。让我们假设我们想检查我的默认azureuser帐户的帐户到期细节。我将执行<code class="fe mf mg mh mi b">az vmss run-command invoke --command-id RunShellScript --instance-id 0 -n aks-agentpool-10544296-vmss -g MC_KUBERG_KUBEAKS_WESTUS2 --scripts "sudo chage -l azureuser"</code>查看该命令，您可以看到我选择了0实例，同时提供了规模集的名称以及规模集所属的资源组，同时告诉它我想运行一个ShellScript并执行sudo chage -l azureuser</p><figure class="ml mm mn mo gt mp gh gi paragraph-image"><div role="button" tabindex="0" class="mq mr di ms bf mt"><div class="gh gi mk"><img src="../Images/af19cdaae4ab364b323d2cb1063fb143.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*k8CgsMVSX-nSxG5ItVeC1A.png"/></div></div></figure><p id="aa23" class="pw-post-body-paragraph lm ln iq jp b jq jr lp lq js jt lr ls ju lu lv lw jw ly lz ma jy mc md me ka ij bi translated">现在，您可能已经注意到，如果您能够运行CLI命令，您可以绕过可能的安全限制，您的公司可能认为这些限制是可靠的，通常会阻止您以这种方式访问虚拟机。我的意思是…我要说的是安全审计的存在是有原因的:)。</p><p id="efea" class="pw-post-body-paragraph lm ln iq jp b jq jr lp lq js jt lr ls ju lu lv lw jw ly lz ma jy mc md me ka ij bi translated">不仅如此，输出是原始的，一点也不漂亮，很容易解决。您可能想知道这个特定命令的限制是什么。到目前为止，我还没有找到一个。当然，我只是把它作为一个碎玻璃的选择，但这并不意味着你不能用它做其他事情，如果你愿意的话。</p><h1 id="f55c" class="kl km iq bd kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li bi translated">加一个</h1><p id="a95c" class="pw-post-body-paragraph lm ln iq jp b jq na lp lq js nb lr ls ju nc lv lw jw nd lz ma jy ne md me ka ij bi translated">Windows和Linux都支持Run-命令。要在Windows中运行命令，您需要指定RunPowershellScript，当然还要使用Powershell命令语法而不是linux shell:)</p><p id="3eb5" class="pw-post-body-paragraph lm ln iq jp b jq jr lp lq js jt lr ls ju lu lv lw jw ly lz ma jy mc md me ka ij bi translated">另外<a class="ae kf" href="https://docs.microsoft.com/en-us/cli/azure/vmss/run-command?view=azure-cli-latest" rel="noopener ugc nofollow" target="_blank"> VMSS实例</a>并不是支持这个特定命令的唯一资源。来自可用性集的基本虚拟机也将以类似的方式工作。查看<a class="ae kf" href="https://docs.microsoft.com/en-us/cli/azure/vm/run-command?view=azure-cli-latest" rel="noopener ugc nofollow" target="_blank">文档</a>中的示例。</p><p id="7bb0" class="pw-post-body-paragraph lm ln iq jp b jq jr lp lq js jt lr ls ju lu lv lw jw ly lz ma jy mc md me ka ij bi translated">所以你有它！这是另一种与你的资源互动的方式，帮助你做你需要做的任何事情，如果你不能直接访问或者由于某种原因丢失了它。</p></div></div>    
</body>
</html>