# 彩车和钱

> 原文：<https://itnext.io/floats-and-money-1ef4d19c8dc9?source=collection_archive---------6----------------------->

一个非常普遍和经常被重复的程序员的智慧是“不要使用浮动货币”。这对我来说总是很有意义。这个想法是，由于存储的方式，浮动是不精确的。

实际上，浮点数不仅仅通过它们的数字来存储，还通过一个公式[来存储。这个公式不能精确地表示每一个分数。演示这一点最流行的方法是启动 Javascript 开发人员控制台并运行:](https://en.wikipedia.org/wiki/Floating-point_arithmetic)

```
> 0.3 - 0.2
0.09999999999999998
```

你会得到的答案不是`0.1`，是`0.09999999999999998`。许多人认为，这很容易证明为什么浮动不利于投资。

这也不是你想写在发票上的东西。避免浮动的一些建议包括:

*   通常在处理金钱时，使用专门的数据存储。例如，MySQL 有`[DECIMAL](https://dev.mysql.com/doc/refman/5.7/en/precision-math-decimal-characteristics.html)`字段类型。
*   当序列化货币值时，例如在 JSON 中，将它们作为字符串而不是数字传递。

另一个非常普遍的建议是，当基于货币价值进行数学计算时，忘记浮点，计算美分，而不是欧元、日元或美元。

所以不用`$ 5.00`，你可以简单地乘以 100 并使用`500`，它是一个整数。

这是处理简单发票的一个很好的方法，在大多数情况下，您只需添加数字。

# 分数

有了这些智慧，我进入了一个有点复杂的问题。为了进行金融分析，我需要用分数进行计算。

我将保持我的例子简单，但是假设我需要找出 498.09 美元的 31%是多少。

这个结果不能用十进制数来表示。在您的 JS 控制台上，它可能看起来像这样:

```
154.40789999999998
```

这不仅仅是因为这是一个浮点数，另一个原因是这个数根本不能用分数来表示。9 无限重复。

但这让我想到，为什么我真的在乎这个精确的数字。我真正感兴趣的部分是`$154.41`，所以我可以对结果取整，得到一个字符串:

```
> (input * 0.31).toFixed(2); 
'154.41'
```

对我来说，这是正确的答案。钱不是用分数表示的(除了美分)，在很多情况下是四舍五入的。

这让我有了下一个认识。这个例子实际上是一个稻草人。我可以四舍五入得到我真正想要的数字:

```
> (0.3 - 0.2).toFixed(2); 
'0.10'
```

这一直是正确的答案。事实上，我们需要首先获得`0.09999999999999998`作为中间答案是不相关的，因为差异是如此之小，我们必须在显示之前进行舍入。

# 一个更好的例子

最后这个练习让我意识到了一些事情:

*   `0.3 - 0.2`不是为什么使用浮点不好的好例子。0.00000000000000002 美元差异不大。
*   除非你愿意用公式而不是数字来写财务报告，否则四舍五入是不可避免的。
*   每个人都轮，不管数字系统。如果你使用浮点数学或定点数学，你实际上会遇到完全相同的问题。

所以我想找出使用浮点数学是否会成为一个问题的例子。它的极限在哪里？

我想到的思考这个问题的一个方法是，尝试得出一个公式，将这 0.00000000000000002 美元的差额合成为 1 美元。仅仅乘以 10，000，000，000，000，000 美元似乎并不合理，因为这个数字(目前)太高，无法在财务计算中显示出来。

我很难找到好的例子来证明这个问题，我也没有足够的智慧来提出自己的想法。但是，即使我知道一个很好的例子，一个想法仍然挥之不去:浮点数的不准确性问题也存在于其他不使用浮点数的数字系统中，例如十进制(定点)数学。使用定点数学，您基本上可以选择一个精度(例如，15 位)，超过该精度的舍入误差也会出现在某些复杂的计算中。

**<编辑>**

向 [currency.js](https://github.com/scurker/currency.js) 项目的作者[@ sc ruker](http://scurker.com/)打听时得到了一个*优秀的*例子。

他的例子是这样的:

```
(17.954 + .001).toFixed(2); // => "17.96"
```

即使这个计算应该产生`17.955`，而*应该*舍入到`17.95`，因为`.001`不能用浮点数精确表示，所以总计最终是`17.955000000000002`，舍入到。

所以这是一个非常明显的例子，一个非常小的差异导致了显著的变化。我自己想不到这一点，但这让我超级清楚为什么定点数学有意义。

**</编辑>**

# 一些推论

我不知道这是否正确，但感觉是正确的:

1.  浮点数学和十进制(定点)数学在不精确和舍入方面有类似的问题。
2.  这些问题出现在不同的计算中。有些计算的结果无法用浮点数学精确表达，而其他计算的结果也无法用定点数学精确表达。
3.  舍入时，不重要的变化可能会显示为重要的变化。

w̵̵̵h̵̵̵a̵̵̵t̵̵̵̵̵̵i̵̵̵̵̵̵d̵̵̵o̵̵̵n̵̵̵'̵̵̵t̵̵̵̵̵̵k̵̵̵n̵̵̵o̵̵̵w̵̵̵̵̵̵i̵̵̵s̵̵̵̵̵̵a̵̵̵r̵̵̵o̵̵̵u̵̵̵n̵̵̵d̵̵̵̵̵̵w̵̵̵h̵̵̵a̵̵̵t̵̵̵̵̵̵s̵̵̵c̵̵̵a̵̵̵l̵̵̵e̵̵̵s̵̵̵̵̵̵f̵̵̵l̵̵̵o̵̵̵a̵̵̵t̵̵̵i̵̵̵n̵̵̵g̵̵̵̵̵̵p̵̵̵o̵̵̵i̵̵̵n̵̵̵t̵̵̵̵̵̵m̵̵̵a̵̵̵t̵̵̵h̵̵̵̵̵̵c̵̵̵a̵̵̵n̵̵̵̵̵̵y̵̵̵i̵̵̵e̵̵̵l̵̵̵d̵̵̵̵̵̵s̵̵̵i̵̵̵g̵̵̵n̵̵̵i̵̵̵f̵̵̵i̵̵̵c̵̵̵a̵̵̵n̵̵̵t̵̵̵̵̵̵i̵̵̵n̵̵̵a̵̵̵c̵̵̵c̵̵̵u̵̵̵r̵̵̵a̵̵̵t̵̵̵e̵̵̵̵̵̵r̵̵̵e̵̵̵s̵̵̵u̵̵̵l̵̵̵t̵̵̵s̵̵̵.̵̵̵̵̵̵i̵̵̵t̵̵̵̵̵̵s̵̵̵e̵̵̵e̵̵̵m̵̵̵s̵̵̵̵̵̵s̵̵̵i̵̵̵m̵̵̵p̵̵̵l̵̵̵e̵̵̵r̵̵̵̵̵̵t̵̵̵o̵̵̵̵̵̵p̵̵̵r̵̵̵e̵̵̵d̵̵̵i̵̵̵c̵̵̵t̵̵̵̵̵̵t̵̵̵h̵̵̵i̵̵̵s̵̵̵̵̵̵w̵̵̵i̵̵̵t̵̵̵h̵̵̵̵̵̵f̵̵̵i̵̵̵x̵̵̵e̵̵̵d̵̵̵-̵̵̵p̵̵̵o̵̵̵i̵̵̵n̵̵̵t̵̵̵̵̵̵m̵̵̵a̵̵̵t̵̵̵h̵̵̵.̵̵̵
̵i̵̵t̵h̵i̵n̵k̵̵t̵h̵i̵s̵̵p̵r̵e̵d̵i̵c̵t̵a̵b̵i̵l̵i̵t̵y̵̵m̵a̵k̵e̵s̵̵p̵e̵o̵p̵l̵e̵̵f̵e̵e̵l̵̵s̵a̵f̵e̵r̵̵d̵o̵i̵n̵g̵̵f̵i̵n̵a̵n̵c̵i̵a̵l̵̵c̵a̵l̵c̵u̵l̵a̵t̵i̵o̵n̵s̵.̵

# 在 Javascript 中使用定点数学

在本文的开头，我提到了将货币乘以 100 并计算美分的解决方案。实际上，这对于任何适度复杂的东西来说都是没用的，因为你限制了你的精度到 2 位小数。

如果您觉得您有一个用例，其中乘以 100 是足够的精度，您可能更好地使用浮点和简单的舍入。

要使定点数学适用于更复杂的计算，你需要更多的有效数字，从而乘以大于 100 的数。在研究这个问题时，我[阅读了一篇关于 COBOL](https://www.xe.com/currency/aud-australian-dollar) 数学的文章，其中提到 IBM 的定点十进制类型最多可以接受 18 位数字。

如果我们将 990 亿美元作为我们希望能够表示的最大值，这意味着在这 18 位数字中，我们需要在句点之前有 11 位数字，在句点之后有 7 位数字。

这意味着每一美元的价值都必须乘以 1^07 (10，000，000，000)。

这也意味着我们需要的最高数字是 10^18.

不幸的是，这个数字高于 Javascript 的 2^53- 1。

当在 Javascript 中处理这个`MAX_SAFE_INTEGER`以上的整数时，Javascript 会自动转换成浮点数，这是我们试图避免的。

你会怎么解决这个问题？

现在，既定的方法是使用一个库来为您处理这个问题。一些例子是:

*   [decimal.js](https://github.com/MikeMcl/decimal.js/) 。
*   [bignumber.js](https://github.com/MikeMcl/bignumber.js/) 。

这些类型的库通过(例如)将一个大数字的每一位单独保存在一个数组中来处理这些限制，并且用算术运算做更多的“手工”工作。例如，100 可能存储为[1，0，0]。

这些库的好处在于，它们可以在视图图层的字符串之间进行转换，并且它们会记住数字中的(固定)点在哪里，因此在显示它们之前，您不必除以 1^07。

虽然这些库可能有点慢。其他编程语言可能有内置特性或本机模块来实现这一点。例如 PHP 有一个 [GMP](https://secure.php.net/manual/en/book.gmp.php) 模块。Java 有`[java.math.BigDecimal](https://docs.oracle.com/javase/8/docs/api/java/math/BigDecimal.html)`。Python 在这里是明显的赢家，它只对任意大小的整数提供透明的本地支持。

# Ecmascript 的 bigint

如果你运行的是 Firefox、Chrome 或 Node.js 的新版本，你可能已经支持新的 Javascript 类型: [bigint](https://github.com/tc39/proposal-bigint) 。

“bigint”就是 tin 上说的，大整数的一种类型。除非明确要求，否则这些新数字不会自动变为浮点数(或常规数字),并且除了计算机的限制之外，没有最大大小。

启动您的控制台并尝试一下:

```
> 2n ** 4018n 345559293868361148033634086220357006310511518965634896 781063867660175128163210875399825054057683275825569877 366688103085859060257763900293951810763555135397260025 513754935661856790168017882157679551094532977446472616 042388243502396227453171398675239956933209718890900049 505574416105487362960435374577513568425052733645175171 906768737683088460692573004685433967970094147567776587 968895982288887330931441539049188139650108989228586553 935232570575822085182349014973765774199297568789676530 263475320588045820967408959142772241203662510003840153 216689755054872558169600469901596210120146006100009125 686963654367743426461088529641862232649573994058654349 928433398965809337177780993779838202644442347395592695 424707614261233861675702825586749608541245212697821731 388883399113457099839192961355454810013138358212990578 801843850594265754972263518207657158345091261082252767 041012083237074622662749814648746881195156284049648490 077841431766658997246737814625191378320649854621233155 380171485533227675173253997097680556286020862942055252 836773511266514852999631351440845847321663378684304777 829482829776191764290318406962537489950747560352629539 406073440415550052435127500261152332947273952037770952 8239494112463913222144n
```

关于这些数字的另一个有趣的事情是它们总是四舍五入:

```
> 5n / 2n
2n
```

使用 bigint 类型将比 npm 库快得多。唯一的缺点是 bigint 没有小数点，所以我被迫将每个数字乘以我需要的精度。这可能会使我的代码更难阅读。

b̶u̶t̶̶w̶i̶t̶h̶̶a̶l̶l̶̶t̶h̶e̶s̶e̶̶n̶i̶c̶e̶̶n̶e̶w̶̶f̶e̶a̶t̶u̶r̶e̶s̶,̶̶i̶̶s̶t̶i̶l̶l̶̶h̶a̶v̶e̶n̶'̶t̶̶f̶o̶u̶n̶d̶̶a̶̶s̶a̶t̶i̶s̶f̶y̶i̶n̶g̶̶a̶n̶s̶w̶e̶r̶̶t̶o̶̶m̶y̶̶o̶r̶i̶g̶i̶n̶a̶l̶̶q̶u̶e̶s̶t̶i̶o̶n̶:̶̶u̶n̶d̶e̶r̶̶w̶h̶a̶t̶̶c̶o̶n̶d̶i̶t̶i̶o̶n̶s̶̶d̶o̶̶f̶l̶o̶a̶t̶i̶n̶g̶̶p̶o̶i̶n̶t̶̶n̶u̶m̶b̶e̶r̶s̶̶b̶r̶e̶a̶k̶̶d̶o̶w̶n̶̶f̶o̶r̶̶f̶i̶n̶a̶n̶c̶i̶a̶l̶̶c̶a̶l̶c̶u̶l̶a̶t̶i̶o̶n̶s̶？̶

# 放弃

发表这篇文章时，我很紧张，因为一些基础技术和数学知识超出了我的理解范围。我真的不能保证这些 100%准确。

如果你发现了什么错误，请在评论中告诉我，我会很乐意进行修改。

*最初发表于*[*evertpot.com*](https://evertpot.com/currencies-floats/)*。*