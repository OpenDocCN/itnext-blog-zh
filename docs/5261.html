<html>
<head>
<title>Prometheus: Alertmanager Web UI alerts Silence</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">普罗米修斯:警报管理器网络用户界面警报沉默</h1>
<blockquote>原文：<a href="https://itnext.io/prometheus-alertmanager-web-ui-alerts-silence-2d34fbf2d252?source=collection_archive---------0-----------------------#2021-01-26">https://itnext.io/prometheus-alertmanager-web-ui-alerts-silence-2d34fbf2d252?source=collection_archive---------0-----------------------#2021-01-26</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/eb45795606f01bca84016ad09d4a142b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*hOjRnkQx0_wmRXcpXSav9A.png"/></div></div></figure><p id="0b23" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">通过Alertmanager发送主动警报的频率通过<code class="fe kw kx ky kz b">/etc/alertmanager/config.yml</code>文件中的<code class="fe kw kx ky kz b">repeat_interval</code>进行配置。</p><p id="3314" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我们将此时间间隔设置为15分钟，因此，我们每隔15分钟就会收到一次关于Slack中的警报的通知。</p><p id="0c07" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">尽管如此，有些警报是这样的“已知问题”，当我们已经开始调查或修复它，但警报被重复发送到Slack。</p><p id="0629" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">要静音这些警报以防止它们被反复发送，可以通过将它们标记为“<em class="la">静音</em>”来禁用它们。</p><p id="3eb5" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">可以通过Alertmanager的Web UI使警报静音，参见<a class="ae lb" href="https://prometheus.io/docs/alerting/latest/alertmanager/#silences" rel="noopener ugc nofollow" target="_blank">文档</a>。</p><p id="a892" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">所以，在这篇文章中我们要做的是:</p><ul class=""><li id="fc4b" class="lc ld iq ka b kb kc kf kg kj le kn lf kr lg kv lh li lj lk bi translated">更新Alertmanager的启动选项以启用Web UI</li><li id="a562" class="lc ld iq ka b kb ll kf lm kj ln kn lo kr lp kv lh li lj lk bi translated">更新NGINX虚拟主机以访问Alertmanager的Web UI</li><li id="23b4" class="lc ld iq ka b kb ll kf lm kj ln kn lo kr lp kv lh li lj lk bi translated">将检查并配置Prometheus服务器以发送警报</li><li id="cd34" class="lc ld iq ka b kb ll kf lm kj ln kn lo kr lp kv lh li lj lk bi translated">将添加一个测试警报来检查如何使其静音</li></ul><h1 id="82f4" class="lq lr iq bd ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn bi translated">Alertmanager Web用户界面配置</h1><p id="55ea" class="pw-post-body-paragraph jy jz iq ka b kb mo kd ke kf mp kh ki kj mq kl km kn mr kp kq kr ms kt ku kv ij bi translated">我们有了从Docker Compose文件运行的Alertmanager，让我们向<code class="fe kw kx ky kz b">command</code>字段添加两个参数——一个是为Alertmanager Web UI指定URI的<code class="fe kw kx ky kz b">web.route-prefix</code>,另一个是设置完整URL的<code class="fe kw kx ky kz b">web.external-url</code>。</p><p id="ab88" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">这个完整的网址将看起来像<em class="la">dev.monitor.example.com/alertmanager</em>——添加它们:</p><pre class="mt mu mv mw gt mx kz my mz aw na bi"><span id="8360" class="nb lr iq kz b gy nc nd l ne nf">...<br/>  alertmanager:<br/>    image: prom/alertmanager:v0.21.0<br/>    networks:<br/>      - prometheus<br/>    ports:<br/>      - 9093:9093<br/>    volumes:<br/>      - /etc/prometheus/alertmanager_config.yml:/etc/alertmanager/config.yml<br/>    command:<br/>      - '--config.file=/etc/alertmanager/config.yml'<br/>      - '--web.route-prefix=/alertmanager'<br/>      - '--web.external-url=https://dev.monitor.example.com/alertmanager'<br/>...</span></pre><p id="d768" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">Alertmanager在Docker容器中工作，可从监控主机通过<em class="la"> localhost:9093 </em>访问；</p><pre class="mt mu mv mw gt mx kz my mz aw na bi"><span id="3b92" class="nb lr iq kz b gy nc nd l ne nf">root@monitoring-dev:/home/admin# docker ps | grep alert<br/>24ae3babd644 prom/alertmanager:v0.21.0 “/bin/alertmanager -…” 3 seconds ago Up 1 second 0.0.0.0:9093-&gt;9093/tcp prometheus_alertmanager_1</span></pre><p id="cdfb" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在NGINX的virtualhost配置中，使用Alertmanager的Docker容器添加一个新的<code class="fe kw kx ky kz b">upstream</code>:</p><pre class="mt mu mv mw gt mx kz my mz aw na bi"><span id="8744" class="nb lr iq kz b gy nc nd l ne nf">...<br/>upstream alertmanager {<br/>    server 127.0.0.1:9093;<br/>}<br/>...</span></pre><p id="30f3" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">另外，在这个文件中添加一个新的<code class="fe kw kx ky kz b">location</code>，它将把所有发送给<em class="la">dev.monitor.example.com/alertmanager</em>的请求代理传递给这个<code class="fe kw kx ky kz b">upstream</code>:</p><pre class="mt mu mv mw gt mx kz my mz aw na bi"><span id="2c06" class="nb lr iq kz b gy nc nd l ne nf">...<br/>    location /alertmanager {<br/>        <br/>        proxy_redirect          off;            <br/>        proxy_set_header        Host            $host;<br/>        proxy_set_header        X-Real-IP       $remote_addr;<br/>        proxy_set_header        X-Forwarded-For $proxy_add_x_forwarded_for;<br/>        proxy_pass <a class="ae lb" href="http://alertmanager$request_uri;" rel="noopener ugc nofollow" target="_blank">http://alertmanager$request_uri;</a><br/>    }<br/>...</span></pre><p id="4b0d" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">保存并重新加载NGINX和Alertmanager。</p><p id="d332" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">现在，打开<a class="ae lb" href="https://dev.monitor.example.com/alertmanager" rel="noopener ugc nofollow" target="_blank"><em class="la">https://dev.monitor.example.com/alertmanager</em></a>网址，您一定会看到Alertmanager Web UI:</p><figure class="mt mu mv mw gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi ng"><img src="../Images/f5520d21a834812ffe88de501f199c17.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*PK3m33JsuIYDxU4q.png"/></div></div></figure><p id="185a" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">这里还没有警报—等待普罗米修斯发送新的警报。</p><h2 id="a39d" class="nb lr iq bd ls nh ni dn lw nj nk dp ma kj nl nm me kn nn no mi kr np nq mm nr bi translated">Prometheus:“发送警报时出错”err= "未找到错误响应状态404 "</h2><p id="2563" class="pw-post-body-paragraph jy jz iq ka b kb mo kd ke kf mp kh ki kj mq kl km kn mr kp kq kr ms kt ku kv ij bi translated">Prometheus服务器中出现新警报后，您可以在日志中看到以下错误:</p><blockquote class="ns nt nu"><p id="4645" class="jy jz la ka b kb kc kd ke kf kg kh ki nv kk kl km nw ko kp kq nx ks kt ku kv ij bi translated">caller = notifier . go:527 component = notifier alert manager = http://alert manager:9093/API/v1/alerts count = 3 msg = "发送警报时出错" err= "错误响应状态404未找到"</p></blockquote><p id="8ba6" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">这是因为目前我们将<code class="fe kw kx ky kz b">alertmanagers</code>设置为:</p><pre class="mt mu mv mw gt mx kz my mz aw na bi"><span id="b320" class="nb lr iq kz b gy nc nd l ne nf">...<br/>alerting:<br/>  alertmanagers:<br/>  - static_configs:<br/>    - targets:<br/>      - alertmanager:9093<br/>...</span></pre><p id="a4d9" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">因此，需要通过使用<code class="fe kw kx ky kz b"><a class="ae lb" href="https://prometheus.io/docs/prometheus/latest/configuration/configuration/#alertmanager_config" rel="noopener ugc nofollow" target="_blank">path_prefix</a></code>设置来添加Alertmanager的URI:</p><pre class="mt mu mv mw gt mx kz my mz aw na bi"><span id="45ae" class="nb lr iq kz b gy nc nd l ne nf">...<br/>alerting:<br/>  alertmanagers:<br/>  - path_prefix: "/alertmanager/"<br/>    static_configs:<br/>    - targets:<br/>      - alertmanager:9093<br/>...</span></pre><p id="86d6" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">重启普罗米修斯号，再次等待警报:</p><figure class="mt mu mv mw gt jr gh gi paragraph-image"><div class="gh gi ny"><img src="../Images/71ff13521cd3872023b7ae2da4d42c16.png" data-original-src="https://miro.medium.com/v2/resize:fit:974/format:webp/0*vAfeoqgi7edZ4KUX.png"/></div></figure><p id="243c" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">此时，您也必须在Alertmanager Web UI中看到它们:</p><figure class="mt mu mv mw gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nz"><img src="../Images/011336334e1a256a88bf2ee53dd08e8a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*pg-sSO_cwQCu2OL_.png"/></div></div></figure><h1 id="4600" class="lq lr iq bd ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn bi translated">警报管理器:警报沉默</h1><p id="b68c" class="pw-post-body-paragraph jy jz iq ka b kb mo kd ke kf mp kh ki kj mq kl km kn mr kp kq kr ms kt ku kv ij bi translated">现在，让我们添加一个无声提示来停止发送它们。</p><p id="d806" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">例如，要禁用<em class="la">alert name = " apiendpointprobessuccesscritical "</em>的重新发送，点击右侧的<code class="fe kw kx ky kz b">+</code>按钮:</p><figure class="mt mu mv mw gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nz"><img src="../Images/6ea73f93eacf84e6702831e756ebd17e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*eHdgaVQotP9ZYSNC.png"/></div></div></figure><p id="9d3a" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">然后按下<em class="la">静音</em>按钮:</p><figure class="mt mu mv mw gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nz"><img src="../Images/9eb688de7308fcdae54073f1b40aad6c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*imh6SmIQRMeZI3VA.png"/></div></div></figure><p id="c37c" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><code class="fe kw kx ky kz b">alertname</code>标签被添加到沉默条件中，默认规则为2小时，添加作者和描述其被沉默的原因:</p><figure class="mt mu mv mw gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi oa"><img src="../Images/a5b2d7036a55a996dd947843c4a017a2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*SbVvtl5UxeWrXgqZ.png"/></div></div></figure><p id="8232" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">点击<em class="la">创建</em> —就完成了:</p><figure class="mt mu mv mw gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi ob"><img src="../Images/9008c390fe108fff7c5bb5096805c2f6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*CW4LQYB_65irClYB.png"/></div></div></figure><p id="92fe" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">您现在可以通过API检查此警报:</p><pre class="mt mu mv mw gt mx kz my mz aw na bi"><span id="dba0" class="nb lr iq kz b gy nc nd l ne nf">root@monitoring-dev:/home/admin# curl -s <a class="ae lb" href="http://localhost:9093/alertmanager/api/v1/alerts" rel="noopener ugc nofollow" target="_blank">http://localhost:9093/alertmanager/api/v1/alerts</a> | jq ‘.data[1]’<br/>{<br/>“labels”: {<br/>“alertname”: “APIendpointProbeSuccessCritical”,<br/>“instance”: “http://push.example.com",<br/>“job”: “blackbox”,<br/>“monitor”: “monitoring-dev”,<br/>“severity”: “critical”<br/>},<br/>“annotations”: {<br/>“description”: “Cant access API endpoint http://push.example.com!",<br/>“summary”: “API endpoint down!”<br/>},<br/>“startsAt”: “2020–12–30T11:25:25.953289015Z”,<br/>“endsAt”: “2020–12–30T11:43:25.953289015Z”,<br/>“generatorURL”: “https://dev.monitor.example.com/prometheus/graph?g0.expr=probe_success%7Binstance%21%3D%22https%3A%2F%2Fokta.example.com%22%2Cjob%3D%22blackbox%22%7D+%21%3D+1&amp;g0.tab=1",<br/>“status”: {<br/>“state”: “suppressed”,<br/>“silencedBy”: [<br/>“ec11c989-f66e-448e-837c-d788c1db8aa4”<br/>],<br/>“inhibitedBy”: null<br/>},<br/>“receivers”: [<br/>“critical”<br/>],<br/>“fingerprint”: “01e79a8dd541cf69”<br/>}</span></pre><p id="b130" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">因此，该警报不会被发送到松弛时间或其他地方，因为在<code class="fe kw kx ky kz b">"state": "suppressed"</code>字段:</p><pre class="mt mu mv mw gt mx kz my mz aw na bi"><span id="fb42" class="nb lr iq kz b gy nc nd l ne nf">…<br/>“status”: {<br/>“state”: “suppressed”,<br/>“silencedBy”: [<br/>“ec11c989-f66e-448e-837c-d788c1db8aa4”<br/>],…<br/></span></pre><p id="7699" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">完成了。</p></div><div class="ab cl oc od hu oe" role="separator"><span class="of bw bk og oh oi"/><span class="of bw bk og oh oi"/><span class="of bw bk og oh"/></div><div class="ij ik il im in"><p id="13c1" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><em class="la">最初发布于</em> <a class="ae lb" href="https://rtfm.co.ua/en/prometheus-alertmanager-web-ui-alerts-silence/" rel="noopener ugc nofollow" target="_blank"> <em class="la"> RTFM: Linux、DevOps和系统管理</em> </a> <em class="la">。</em></p></div></div>    
</body>
</html>