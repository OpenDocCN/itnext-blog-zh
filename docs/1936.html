<html>
<head>
<title>NodeJs graceful start &amp; shutdown in a load balancer</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">负载平衡器中节点的正常启动和关闭</h1>
<blockquote>原文：<a href="https://itnext.io/nodejs-graceful-start-shutdown-3ed16418ede3?source=collection_archive---------4-----------------------#2019-02-26">https://itnext.io/nodejs-graceful-start-shutdown-3ed16418ede3?source=collection_archive---------4-----------------------#2019-02-26</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/401d474463ebf145c714f5ef67fdd9b3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*SoCrQxSWimdw6-uIa-sqNw.jpeg"/></div></div></figure><p id="5e2c" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">为了避免部署、关闭、启动和重新启动应用程序时出现问题，确保现有请求完成并在服务器关闭前防止更多请求到达服务器非常重要。这称为正常关机。</p><p id="0179" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">同样重要的是，在接收到客户机请求之前，要确保服务器能够向数据库发出请求，以便能够满足这些请求，否则可能会发生错误和竞争情况，这就是我们所说的平稳开始。</p><h2 id="78a5" class="kw kx iq bd ky kz la dn lb lc ld dp le kj lf lg lh kn li lj lk kr ll lm ln lo bi translated">优雅的开始</h2><p id="a594" class="pw-post-body-paragraph jy jz iq ka b kb lp kd ke kf lq kh ki kj lr kl km kn ls kp kq kr lt kt ku kv ij bi translated">在接受请求之前，您的应用程序必须成功地建立与数据库的连接。</p><ol class=""><li id="e502" class="lu lv iq ka b kb kc kf kg kj lw kn lx kr ly kv lz ma mb mc bi translated">App启动<em class="md"> (npm启动)</em></li><li id="ca3c" class="lu lv iq ka b kb me kf mf kj mg kn mh kr mi kv lz ma mb mc bi translated">应用程序打开数据库连接</li><li id="3380" class="lu lv iq ka b kb me kf mf kj mg kn mh kr mi kv lz ma mb mc bi translated">应用程序监听端口</li><li id="ce18" class="lu lv iq ka b kb me kf mf kj mg kn mh kr mi kv lz ma mb mc bi translated">应用程序告诉负载平衡器它已准备好接受请求</li></ol><p id="2b9d" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">让我们看看如何在代码中实现这一点。</p><pre class="mj mk ml mm gt mn mo mp mq aw mr bi"><span id="5955" class="kw kx iq mo b gy ms mt l mu mv">const server = http.createServer(app)<br/>mongoose.connect(process.env.MONGO_URL)<br/>  .then(db =&gt; {<br/>    console.log('connected to mongo successfully')<br/>    server.listen(port, err =&gt; {<br/>      if (err) {<br/>        console.log('something bad happened', err)<br/>      } else {<br/>        process.send = process.send || function () { }<br/>        process.send('ready')<br/>        console.log(`server is listening on ${port}`)<br/>      }<br/>    })<br/>  })<br/>  .catch(err =&gt; console.log('Mongo connection error', err))</span></pre><h2 id="5583" class="kw kx iq bd ky kz la dn lb lc ld dp le kj lf lg lh kn li lj lk kr ll lm ln lo bi translated">正常关机</h2><p id="ebb7" class="pw-post-body-paragraph jy jz iq ka b kb lp kd ke kf lq kh ki kj lr kl km kn ls kp kq kr lt kt ku kv ij bi translated">在正常关闭时，您的应用程序必须经过5个步骤:</p><ol class=""><li id="5d9f" class="lu lv iq ka b kb kc kf kg kj lw kn lx kr ly kv lz ma mb mc bi translated">收到停止的通知</li><li id="1b63" class="lu lv iq ka b kb me kf mf kj mg kn mh kr mi kv lz ma mb mc bi translated">要求负载平衡器停止接收请求</li><li id="8b79" class="lu lv iq ka b kb me kf mf kj mg kn mh kr mi kv lz ma mb mc bi translated">完成所有正在进行的请求</li><li id="aee6" class="lu lv iq ka b kb me kf mf kj mg kn mh kr mi kv lz ma mb mc bi translated">释放所有资源(数据库、队列……)</li><li id="bb5d" class="lu lv iq ka b kb me kf mf kj mg kn mh kr mi kv lz ma mb mc bi translated">出口</li></ol><p id="7975" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">让我们看看这在代码中是什么样子的</p><pre class="mj mk ml mm gt mn mo mp mq aw mr bi"><span id="632f" class="kw kx iq mo b gy ms mt l mu mv">// If the Node process ends, close the Mongoose connection<br/>const sigs = ['SIGINT', 'SIGTERM', 'SIGQUIT']<br/>sigs.forEach(sig =&gt; {<br/>  process.on(sig, () =&gt; {<br/>    // Stops the server from accepting new connections and finishes existing connections.<br/>    server.close(function (err) {<br/>      if (err) {<br/>        console.error(err)<br/>        process.exit(1)<br/>      }<br/>      // close your database connection and exit with success <br/>      // for example with mongoose<br/>      mongoose.connection.close(function () {<br/>        console.log('Mongoose connection disconnected')<br/>        process.exit(0)<br/>      })<br/>    })<br/>  })<br/>})</span></pre></div></div>    
</body>
</html>