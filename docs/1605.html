<html>
<head>
<title>Musings about Istio with mTLS</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">关于Istio与mTLS的思考</h1>
<blockquote>原文：<a href="https://itnext.io/musings-about-istio-with-mtls-c64b551fe104?source=collection_archive---------1-----------------------#2018-12-09">https://itnext.io/musings-about-istio-with-mtls-c64b551fe104?source=collection_archive---------1-----------------------#2018-12-09</a></blockquote><div><div class="fc if ig ih ii ij"/><div class="ik il im in io"><div class=""/><p id="6d41" class="pw-post-body-paragraph jo jp ir jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl ik bi translated">首先，我想说清楚，我认为Istio中的mTLS是一个非常棒的功能，几乎是Istio的一个独特卖点。</p><figure class="ko kp kq kr gu ks gi gj paragraph-image"><div role="button" tabindex="0" class="kt ku di kv bf kw"><div class="gi gj kn"><img src="../Images/5faf0cdbefbc323c5e60ff4c71375045.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*sGyPdv6EL1-zWjWe_4wb_A.png"/></div></div><figcaption class="kz la gk gi gj lb lc bd b be z dk translated">Kiali图表显示了从<em class="ld">产品页面</em>到通过mTLS保护的详细信息的流量</figcaption></figure><p id="7063" class="pw-post-body-paragraph jo jp ir jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl ik bi translated">但它也有一些难以发现的陷阱。是的，这是有记录的，但我花了一段时间才明白。在这篇文章中，我想提供一些关于安装和调试的信息。<br/>在左图中，你可以看到mTLS建立连接时<a class="ae km" href="https://github.com/kiali/" rel="noopener ugc nofollow" target="_blank"> Kiali </a>显示的内容。</p><h2 id="a9f1" class="le lf ir bd lg lh li dn lj lk ll dp lm jz ln lo lp kd lq lr ls kh lt lu lv lw bi translated">“互TLS”到底是什么，mTLS？</h2><p id="0c42" class="pw-post-body-paragraph jo jp ir jq b jr lx jt ju jv ly jx jy jz lz kb kc kd ma kf kg kh mb kj kk kl ik bi translated">TLS或传输层安全性确保服务之间的通信是加密的。通过正确的配置，还可以借助证书来检查服务是否与它们声明的一样。TLS的一个主要例子是当您调用https URL时的web浏览器。</p><p id="7666" class="pw-post-body-paragraph jo jp ir jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl ik bi translated">mTLS现在还确保不仅客户端(调用者)验证服务器(被称为服务)的证书，反之亦然。</p><p id="4686" class="pw-post-body-paragraph jo jp ir jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl ik bi translated">在Citadel组件的帮助下，Istio可以在任意两个服务之间建立MTL，包括证书的创建、分发和检查。</p><h1 id="7c71" class="md lf ir bd lg me mf mg lj mh mi mj lm mk ml mm lp mn mo mp ls mq mr ms lv mt bi translated">为两个服务之间的单个连接设置mTLS</h1><p id="370e" class="pw-post-body-paragraph jo jp ir jq b jr lx jt ju jv ly jx jy jz lz kb kc kd ma kf kg kh mb kj kk kl ik bi translated">由于Bookinfo是Istio的Hello World，我将使用它来解释如何设置从<em class="mc"> productpage </em>到<em class="mc"> details </em>服务的mTLS，如上图所示。</p><p id="ea21" class="pw-post-body-paragraph jo jp ir jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl ik bi translated">这包括两个部分:</p><ol class=""><li id="ceb5" class="mu mv ir jq b jr js jv jw jz mw kd mx kh my kl mz na nb nc bi translated">安装一个<a class="ae km" href="https://istio.io/docs/reference/config/istio.authentication.v1alpha1/#Policy" rel="noopener ugc nofollow" target="_blank">策略</a>来告诉细节它想要接收TLS流量(仅):</li></ol><pre class="ko kp kq kr gu nd ne nf ng aw nh bi"><span id="62f7" class="le lf ir ne b gz ni nj l nk nl"><strong class="ne is">apiVersion</strong>: authentication.istio.io/v1alpha1<br/><strong class="ne is">kind</strong>: Policy<br/><strong class="ne is">metadata</strong>:<br/>  <strong class="ne is">name</strong>: details-receive-tls<br/><strong class="ne is">spec</strong>:<br/>  <strong class="ne is">targets</strong>:<br/>  - <strong class="ne is">name</strong>: details<br/>  <strong class="ne is">peers</strong>:<br/>  - <strong class="ne is">mtls</strong>: {}</span></pre><p id="0456" class="pw-post-body-paragraph jo jp ir jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl ik bi translated">2.安装一个<a class="ae km" href="https://istio.io/docs/reference/config/istio.networking.v1alpha3/#DestinationRule" rel="noopener ugc nofollow" target="_blank"> DestinationRule </a>来告诉客户端(productpage)将详细信息告知TLS:</p><pre class="ko kp kq kr gu nd ne nf ng aw nh bi"><span id="b0a6" class="le lf ir ne b gz ni nj l nk nl"><strong class="ne is">apiVersion</strong>: networking.istio.io/v1alpha3<br/><strong class="ne is">kind</strong>: DestinationRule<br/><strong class="ne is">metadata</strong>:<br/>  <strong class="ne is">name</strong>: details-istio-mtls<br/><strong class="ne is">spec</strong>:<br/>  <strong class="ne is">host</strong>: details.bookinfo.svc.cluster.local<br/>  <strong class="ne is">trafficPolicy</strong>:<br/>    <strong class="ne is">tls</strong>:<br/>      <strong class="ne is">mode</strong>: ISTIO_MUTUAL</span></pre><p id="e0df" class="pw-post-body-paragraph jo jp ir jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl ik bi translated">下面是所涉及服务的图形表示，以及前面两个配置文档适用的地方。</p><figure class="ko kp kq kr gu ks gi gj paragraph-image"><div class="gi gj nm"><img src="../Images/9b62ea41434ed0fb9b729591b2c76b5f.png" data-original-src="https://miro.medium.com/v2/resize:fit:842/format:webp/1*iL3ILZ_jvSR2_LeJhhRwXA.png"/></div></figure><p id="a940" class="pw-post-body-paragraph jo jp ir jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl ik bi translated">现在，当您仔细查看上面的策略时，您会看到<a class="ae km" href="https://istio.io/docs/reference/config/istio.authentication.v1alpha1/#MutualTls" rel="noopener ugc nofollow" target="_blank">对等身份验证</a>的条目</p><pre class="ko kp kq kr gu nd ne nf ng aw nh bi"><span id="1dfb" class="le lf ir ne b gz ni nj l nk nl"><strong class="ne is">peers</strong>:<br/>- <strong class="ne is">mtls</strong>: {}</span></pre><p id="b81e" class="pw-post-body-paragraph jo jp ir jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl ik bi translated">这意味着TLS验证是严格的，Istio(或者说是pod中的特使代理)需要TLS流量和有效证书。我们可以传递一个标志来获得<a class="ae km" href="https://istio.io/docs/reference/config/istio.authentication.v1alpha1/#MutualTls-Mode" rel="noopener ugc nofollow" target="_blank">许可模式</a>:</p><pre class="ko kp kq kr gu nd ne nf ng aw nh bi"><span id="1756" class="le lf ir ne b gz ni nj l nk nl"><strong class="ne is">peers</strong>:<br/>- <strong class="ne is">mtls</strong>: <br/>    <strong class="ne is">mode</strong>: PERMISSIVE</span></pre><h1 id="23f1" class="md lf ir bd lg me mf mg lj mh mi mj lm mk ml mm lp mn mo mp ls mq mr ms lv mt bi translated">窥视特使的世界观(关于mTLS)</h1><p id="03d9" class="pw-post-body-paragraph jo jp ir jq b jr lx jt ju jv ly jx jy jz lz kb kc kd ma kf kg kh mb kj kk kl ik bi translated">现在我们已经看到了如何配置MTL，让我们看看Envoy是如何看待这个世界的。</p><h2 id="7025" class="le lf ir bd lg lh li dn lj lk ll dp lm jz ln lo lp kd lq lr ls kh lt lu lv lw bi translated">首先是细节服务</h2><p id="918b" class="pw-post-body-paragraph jo jp ir jq b jr lx jt ju jv ly jx jy jz lz kb kc kd ma kf kg kh mb kj kk kl ik bi translated">让我们从<em class="mc">细节</em>服务和严格的TLS请求开始。我使用<a class="ae km" href="https://istio.io/docs/reference/commands/istioctl/" rel="noopener ugc nofollow" target="_blank"> <em class="mc"> istioctl </em> </a>工具来查询details pod实例，并请求<em class="mc">监听器</em>配置(这基本上是关于传入请求的代理配置)。</p><pre class="ko kp kq kr gu nd ne nf ng aw nh bi"><span id="5e3a" class="le lf ir ne b gz ni nj l nk nl">$ istioctl proxy-config <strong class="ne is">listener</strong> details-v1-688965fbdf-b9w5w<br/><br/>[<br/>  {<br/>    <strong class="ne is">"name"</strong>: "172.17.0.9_9080",<br/>    <strong class="ne is">"address"</strong>: {<br/>      <strong class="ne is">"socketAddress"</strong>: {<br/>        <strong class="ne is">"address"</strong>: "172.17.0.9",<br/>        <strong class="ne is">"portValue"</strong>: 9080<br/>      }<br/>    },</span></pre><p id="1c7e" class="pw-post-body-paragraph jo jp ir jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl ik bi translated">第一部分没有什么特别之处，只是标识了端点(配置包含多个端点，但是我们感兴趣的是用于“业务”流量的端点)。接下来是第一个有趣的部分:</p><pre class="ko kp kq kr gu nd ne nf ng aw nh bi"><span id="0a81" class="le lf ir ne b gz ni nj l nk nl"><strong class="ne is">"filterChains"</strong>: [<br/>{<br/>  <strong class="ne is">"tlsContext"</strong>: {<br/>    <strong class="ne is">"commonTlsContext"</strong>: {<br/>      <strong class="ne is">"tlsCertificates"</strong>: [<br/>      {<br/>        <strong class="ne is">"certificateChain"</strong>: {<br/>          <strong class="ne is">"filename"</strong>: "/etc/certs/cert-chain.pem"<br/>        },<br/>        <strong class="ne is">"privateKey"</strong>: {<br/>          <strong class="ne is">"filename"</strong>: "/etc/certs/key.pem"<br/>        }<br/>      }<br/>      ],<br/>      <strong class="ne is">"validationContext"</strong>: {<br/>        <strong class="ne is">"trustedCa"</strong>: {<br/>          <strong class="ne is">"filename"</strong>: "/etc/certs/root-cert.pem"<br/>        }<br/>      },<br/>      <strong class="ne is">"alpnProtocols"</strong>: [<br/>        "h2",<br/>        "http/1.1"<br/>      ]<br/>    },<br/>    <strong class="ne is">"requireClientCertificate"</strong>: true<br/>  },</span></pre><p id="eb51" class="pw-post-body-paragraph jo jp ir jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl ik bi translated">过滤器链用于检测传入流量是否是TLS。该配置指示证书在Envoy文件系统中的位置、允许的协议以及客户端必须出示其证书。</p><p id="593a" class="pw-post-body-paragraph jo jp ir jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl ik bi translated">接下来我们来看看过滤器配置，它包括一个特定于Istio的http_filter:</p><pre class="ko kp kq kr gu nd ne nf ng aw nh bi"><span id="9922" class="le lf ir ne b gz ni nj l nk nl"><strong class="ne is">"filters"</strong>: [<br/>{<br/>  <strong class="ne is">"name"</strong>: "envoy.http_connection_manager",<br/>  <strong class="ne is">"config"</strong>: {<br/>    /* ..omitted.. */<br/>    <strong class="ne is">"http_filters"</strong>: [<br/>    {<br/>      <strong class="ne is">"config"</strong>: {<br/>        <strong class="ne is">"policy"</strong>: {<br/>          <strong class="ne is">"peers"</strong>: [<br/>          {<br/>            <strong class="ne is">"mtls"</strong>: {}<br/>          }<br/>          ]<br/>        }<br/>      },<br/>      <strong class="ne is">"name"</strong>: "istio_authn"<br/>    }</span></pre><p id="d9c8" class="pw-post-body-paragraph jo jp ir jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl ik bi translated">该过滤器主要查看策略，如果如上所示设置为“mtls ”,它将在先前定义的证书和证书链的帮助下检查传入请求的证书。</p><h2 id="014e" class="le lf ir bd lg lh li dn lj lk ll dp lm jz ln lo lp kd lq lr ls kh lt lu lv lw bi translated">现在<em class="ld">产品页面</em>客户端配置</h2><p id="b281" class="pw-post-body-paragraph jo jp ir jq b jr lx jt ju jv ly jx jy jz lz kb kc kd ma kf kg kh mb kj kk kl ik bi translated">我们再次使用istioctl proxy-config来获取<em class="mc">集群</em>设置，并检查发送方的详细服务。我们可以再次使用details-pod，因为每个pod都有完整的<em class="mc">集群</em>视图。唯一的区别是本地pod的入站部分，我们目前对此不感兴趣。</p><pre class="ko kp kq kr gu nd ne nf ng aw nh bi"><span id="d9f8" class="le lf ir ne b gz ni nj l nk nl">$ istioctl proxy-config <strong class="ne is">cluster</strong> details-v1-688965fbdf-b9w5w -o json | less<br/><br/>{<br/>  <strong class="ne is">"name"</strong>: "outbound|9080||details.bookinfo.svc.cluster.local",<br/>  <strong class="ne is">"type"</strong>: "EDS",<br/>  <strong class="ne is">"tlsContext"</strong>: {<br/>    <strong class="ne is">"commonTlsContext"</strong>: {<br/>      <strong class="ne is">"tlsCertificates"</strong>: [<br/>      {<br/>        <strong class="ne is">"certificateChain"</strong>: {<br/>          <strong class="ne is">"filename"</strong>: "/etc/certs/cert-chain.pem"<br/>        },<br/>        <strong class="ne is">"privateKey"</strong>: {<br/>          <strong class="ne is">"filename"</strong>: "/etc/certs/key.pem"<br/>        }<br/>      }<br/>      ],<br/>      <strong class="ne is">"validationContext"</strong>: {<br/>        <strong class="ne is">"trustedCa"</strong>: {<br/>          <strong class="ne is">"filename"</strong>: "/etc/certs/root-cert.pem"<br/>        },<br/>        <strong class="ne is">"verifySubjectAltName"</strong>: [<br/>          "spiffe://cluster.local/ns/bookinfo/sa/default"<br/>        ]<br/>      },<br/>      <strong class="ne is">"alpnProtocols"</strong>: [<br/>        "istio"<br/>      ]<br/>    },<br/>    <strong class="ne is">"sni"</strong>: "outbound|9080||details.bookinfo.svc.cluster.local"<br/>  }<br/>}</span></pre><p id="9a9c" class="pw-post-body-paragraph jo jp ir jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl ik bi translated">为了简洁起见，这里的输出被删减了很多。如果您自己运行该命令，只需在输出中搜索<em class="mc">细节</em>。同样，您会看到包含所有证书信息的TLS上下文。这里最有趣的一行是最后一行。“sni”条目告诉Envoy使用TLS并将各自的目标服务器名称传递给被调用的IP/端口组合。维基百科有一篇关于SNI在TLS 中用法的<a class="ae km" href="https://en.wikipedia.org/wiki/Server_Name_Indication" rel="noopener ugc nofollow" target="_blank">文章。</a></p><h2 id="7898" class="le lf ir bd lg lh li dn lj lk ll dp lm jz ln lo lp kd lq lr ls kh lt lu lv lw bi translated">使用Istioctl检查mTLS设置</h2><p id="c113" class="pw-post-body-paragraph jo jp ir jq b jr lx jt ju jv ly jx jy jz lz kb kc kd ma kf kg kh mb kj kk kl ik bi translated">运行<em class="mc"> istioctl authn tls-check </em>有助于发现问题(由于输出很宽很长，我已经将其缩短，但仍然被迫放入一个截图以获得一些合理的格式):</p><figure class="ko kp kq kr gu ks gi gj paragraph-image"><div role="button" tabindex="0" class="kt ku di kv bf kw"><div class="gi gj nn"><img src="../Images/4d121b04d4114b3572c16915a38bfec0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*lPeUaEqbAFULW7txtPc_RA.png"/></div></div><figcaption class="kz la gk gi gj lb lc bd b be z dk translated">istioctl授权tls检查的输出缩短</figcaption></figure><p id="f7b4" class="pw-post-body-paragraph jo jp ir jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl ik bi translated">在产品页面的输出中，您可以看到使用了网状mTLS(见下一段)，详细信息我已经设置了自己的策略和目标规则，对于第3行的xy.demo，检测到冲突，其中DR(=客户端)要求使用mTLS，但xy.demo服务器有一个覆盖策略，只允许普通HTTP。</p><h1 id="5863" class="md lf ir bd lg me mf mg lj mh mi mj lm mk ml mm lp mn mo mp ls mq mr ms lv mt bi translated">设置网状范围的MTL</h1><p id="4452" class="pw-post-body-paragraph jo jp ir jq b jr lx jt ju jv ly jx jy jz lz kb kc kd ma kf kg kh mb kj kk kl ik bi translated">在Istio文档中<a class="ae km" href="https://istio.io/docs/tasks/security/authn-policy/#globally-enabling-istio-mutual-tls" rel="noopener ugc nofollow" target="_blank">详细描述了如何设置网状宽mTLS。要检查此<em class="mc">网格策略</em>是否在您的集群上启用，您可以运行以下命令:</a></p><pre class="ko kp kq kr gu nd ne nf ng aw nh bi"><span id="7097" class="le lf ir ne b gz ni nj l nk nl">$ kubectl get MeshPolicy default</span></pre><p id="df60" class="pw-post-body-paragraph jo jp ir jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl ik bi translated">当建立全网状mTLS时，网状网络中服务之间的所有连接都通过mTLS得到保护。但是，不仅仅是这些，还包括到网格外部服务的所有其他连接。请看一下DestinationRule中的这一行:</p><pre class="ko kp kq kr gu nd ne nf ng aw nh bi"><span id="03b7" class="le lf ir ne b gz ni nj l nk nl"><strong class="ne is">spec</strong>:<br/>  <strong class="ne is">host</strong>: "*.local"</span></pre><p id="30d8" class="pw-post-body-paragraph jo jp ir jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl ik bi translated">"*.local”匹配本地Kubernetes集群中的每个服务，包括对Kubernetes API的调用。这意味着对于这些呼叫，MTL必须明确关闭<a class="ae km" href="https://istio.io/docs/tasks/security/authn-policy/#request-from-istio-services-to-kubernetes-api-server" rel="noopener ugc nofollow" target="_blank">，这在文档</a>中再次描述。</p><p id="2ad7" class="pw-post-body-paragraph jo jp ir jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl ik bi translated">同样，来自kubelet这样的非安全服务进行健康检查的调用现在会被Envoy拒绝，因为<a class="ae km" href="https://istio.io/docs/tasks/security/authn-policy/#globally-enabling-istio-mutual-tls" rel="noopener ugc nofollow" target="_blank"> <em class="mc"> MeshPolicy </em> </a>规定了所有服务的MTL。正常的基于http的健康检查不能在Istio 1.0.x和更早的版本中使用，您需要切换到让<a class="ae km" href="https://istio.io/help/faq/security/#k8s-health-checks" rel="noopener ugc nofollow" target="_blank"> kubelet执行一个命令来进行检查</a>并提供它的返回代码。理论上，您也可以切换到许可的TLS，但是这样您会失去大部分好处，所以不推荐这样做。</p><p id="aa81" class="pw-post-body-paragraph jo jp ir jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl ik bi translated">另一种选择是(如果您的代码允许的话)将健康检查端点放在与业务流量不同的端口上。</p><figure class="ko kp kq kr gu ks gi gj paragraph-image"><div class="gi gj no"><img src="../Images/4eb0ba47fb72abb24a94c5bc8d4bb9fa.png" data-original-src="https://miro.medium.com/v2/resize:fit:846/format:webp/1*rNCKbYL4jQcgSPqZ3qmZHA.png"/></div><figcaption class="kz la gk gi gj lb lc bd b be z dk translated">业务流量和健康检查的分离</figcaption></figure><p id="b818" class="pw-post-body-paragraph jo jp ir jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl ik bi translated">为了实现这一点，我们需要做两件事:</p><ol class=""><li id="50fc" class="mu mv ir jq b jr js jv jw jz mw kd mx kh my kl mz na nb nc bi translated">禁用端口9080的策略</li></ol><pre class="ko kp kq kr gu nd ne nf ng aw nh bi"><span id="ec19" class="le lf ir ne b gz ni nj l nk nl"><strong class="ne is">spec</strong>:<br/>  <strong class="ne is">targets</strong>:<br/>  - <strong class="ne is">name</strong>: details<br/>    <strong class="ne is">ports</strong>:<br/>    - <strong class="ne is">number</strong>: 9080<br/>  <strong class="ne is">peers</strong>:<br/># no mtls entry means disable</span></pre><p id="ec08" class="pw-post-body-paragraph jo jp ir jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl ik bi translated">2.禁用详细信息服务的运行状况检查端口的mTLS。当我们打开整个网状网络时，端口80仍将被mTLS覆盖。</p><pre class="ko kp kq kr gu nd ne nf ng aw nh bi"><span id="3072" class="le lf ir ne b gz ni nj l nk nl"><strong class="ne is">spec</strong>:<br/>  <strong class="ne is">host</strong>: details<br/>  <strong class="ne is">trafficPolicy</strong>:<br/>    <strong class="ne is">tls</strong>:<br/>      <strong class="ne is">mode</strong>: ISTIO_MUTUAL<br/>    <strong class="ne is">portLevelSettings</strong>:<br/>    - <strong class="ne is">port</strong>:<br/>        <strong class="ne is">number</strong>: 9080<br/>      <strong class="ne is">tls</strong>:<br/>        <strong class="ne is">mode</strong>: DISABLE</span></pre><h2 id="db34" class="le lf ir bd lg lh li dn lj lk ll dp lm jz ln lo lp kd lq lr ls kh lt lu lv lw bi translated">Istio 1.1，mTLS和健康检查</h2><p id="6c3c" class="pw-post-body-paragraph jo jp ir jq b jr lx jt ju jv ly jx jy jz lz kb kc kd ma kf kg kh mb kj kk kl ik bi translated">Istio 1.1 <a class="ae km" href="https://github.com/istio/istio/issues/9150" rel="noopener ugc nofollow" target="_blank">将(很可能)具有不同的行为</a>，其中来自Kubelet的健康检查调用将发送到Istio的试点代理，然后该代理通过mTLS调用指定的应用健康检查端点。这是通过重写sidecar注入上的pod规范来实现的，以便为kubelet发送其请求提供不同的端口。应用程序不需要修改任何代码，可以继续使用单个端口进行业务流量和运行状况检查。在撰写本文时，这项工作仍在进行中，文档还没有准备好。Istio issue 9150 提供了所有相关信息。</p><h1 id="e585" class="md lf ir bd lg me mf mg lj mh mi mj lm mk ml mm lp mn mo mp ls mq mr ms lv mt bi translated">一些需要注意的事情…</h1><p id="a516" class="pw-post-body-paragraph jo jp ir jq b jr lx jt ju jv ly jx jy jz lz kb kc kd ma kf kg kh mb kj kk kl ik bi translated">有一点可能非常令人困惑，那就是Istio处理同一个目标的多个DestinationRules的方式。我们在上一个示例中已经看到了这一点，但实际上，当您从一个没有为整个网状网络启用mTLS的集群转到一个启用了mTLS的集群时，这可能会产生不良影响。</p><p id="4f31" class="pw-post-body-paragraph jo jp ir jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl ik bi translated">前一个例子中的明确情况非常清楚，通过使用<a class="ae km" href="https://istio.io/docs/reference/config/istio.networking.v1alpha3/#TLSSettings-TLSmode" rel="noopener ugc nofollow" target="_blank"> <strong class="jq is">模式:禁用</strong> </a>，mTLS(发送)被关闭。当mTLS在网状范围内时，如果指定如下DestinationRule，则更容易出错:</p><pre class="ko kp kq kr gu nd ne nf ng aw nh bi"><span id="45c4" class="le lf ir ne b gz ni nj l nk nl"><strong class="ne is">spec</strong>:<br/>  <strong class="ne is">host</strong>: details<br/>  <strong class="ne is">subsets</strong>: <br/>  <strong class="ne is">- name:</strong> a-subset<br/>    <strong class="ne is">labels</strong>:<br/>       <strong class="ne is">version</strong>: abc</span></pre><figure class="ko kp kq kr gu ks gi gj paragraph-image"><div class="gi gj np"><img src="../Images/53de4f70d9aa68ab6ee165b3e4d55aea.png" data-original-src="https://miro.medium.com/v2/resize:fit:574/format:webp/1*KdjstjFgDuW_08Nir1C-5g.png"/></div></figure><p id="c6ec" class="pw-post-body-paragraph jo jp ir jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl ik bi translated">这一条没有提到流量策略，当不使用mTLS时，这完全没问题。但是由于<em class="mc">细节</em>服务需要mTLS，这基本上会使所有对<em class="mc">细节</em>服务的调用失败。原因是Istio没有忽略丢失的流量策略，而是用“nothing”覆盖全局策略，这实际上禁用了TLS发送。</p><p id="43df" class="pw-post-body-paragraph jo jp ir jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl ik bi translated">要解决这个问题，我们需要显式地添加流量策略(即使它是在网状范围内指定的)</p><pre class="ko kp kq kr gu nd ne nf ng aw nh bi"><span id="abe1" class="le lf ir ne b gz ni nj l nk nl"><strong class="ne is">spec</strong>:<br/>  <strong class="ne is">host</strong>: details<br/>  <strong class="ne is">subsets</strong>:<br/>  - <strong class="ne is">name</strong>: a-subset<br/>    <strong class="ne is">labels</strong>:<br/>       <strong class="ne is">version</strong>: abc<br/>  <strong class="ne is">trafficPolicy</strong>:<br/>    <strong class="ne is">targets</strong>:<br/>    - <strong class="ne is">name</strong>: details<br/>    <strong class="ne is">peers</strong>:<br/>    - <strong class="ne is">mtls</strong>: {}</span></pre><p id="5053" class="pw-post-body-paragraph jo jp ir jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl ik bi translated">我个人希望在这里看到一些继承，使DestinationRules在启用或禁用网状或命名空间范围的mTLS的场景中都可用。通过在全局DestinationRule中指定传递mtls策略或允许说:</p><pre class="ko kp kq kr gu nd ne nf ng aw nh bi"><span id="2cda" class="le lf ir ne b gz ni nj l nk nl"><strong class="ne is"># Just an idea, will not work in current Istio 1.0/1.1<br/>trafficPolicy</strong>:<br/>  <strong class="ne is">peers</strong>:<br/>  - <strong class="ne is">mtls</strong>: <br/>      <strong class="ne is">mode</strong>: INHERIT</span></pre><p id="19b8" class="pw-post-body-paragraph jo jp ir jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl ik bi translated">前者可能需要较少的输入工作:-)，对于编写DestinationRules的用户来说，因为他们可以直接使用缺省值，而无需进一步的工作。</p><h1 id="0471" class="md lf ir bd lg me mf mg lj mh mi mj lm mk ml mm lp mn mo mp ls mq mr ms lv mt bi translated">这对基亚利来说意味着什么？</h1><p id="cb6f" class="pw-post-body-paragraph jo jp ir jq b jr lx jt ju jv ly jx jy jz lz kb kc kd ma kf kg kh mb kj kk kl ik bi translated">截至本文撰写之时(2018年12月7日)，Kiali尚未展示所有相关细节。如果DestinationRule启用了mTLS，我们将显示锁图标。我们尚未显示mTLS是否仅设置了一半(策略缺失或策略已设置，但DestinationRule未启用mTLS)。你至少可以得到一个提示:</p><figure class="ko kp kq kr gu ks gi gj paragraph-image"><div role="button" tabindex="0" class="kt ku di kv bf kw"><div class="gi gj nq"><img src="../Images/4981549963c0053fc7dd1b24f57b78f7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*tepwHd-86OksrwihUtdCyg.png"/></div></div><figcaption class="kz la gk gi gj lb lc bd b be z dk translated">Kiali向详细信息显示流量失败，因为它需要TLS，但productpage上的DR忘记重复全局设置(以发送TLS)。由于这个原因，连接上的锁丢失了</figcaption></figure><p id="9718" class="pw-post-body-paragraph jo jp ir jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl ik bi translated">不幸的是，目前这还不够明确，但至少是一个提示——您可以运行<em class="mc"> istioctl authn tls-check </em>来验证这一点，如上所示。</p><p id="a913" class="pw-post-body-paragraph jo jp ir jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl ik bi translated">有一堆开放的票(<a class="ae km" href="https://issues.jboss.org/browse/KIALI-2092" rel="noopener ugc nofollow" target="_blank">基亚利-2092 </a>、<a class="ae km" href="https://issues.jboss.org/browse/KIALI-2108" rel="noopener ugc nofollow" target="_blank">基亚利-2108 </a>)和<a class="ae km" href="https://issues.jboss.org/browse/KIALI-2082" rel="noopener ugc nofollow" target="_blank">基亚利-2082 </a>来显示更多的政策相关数据，所以请继续关注(或者如果你想加快速度，请帮助我们实现:-)</p><h1 id="b3de" class="md lf ir bd lg me mf mg lj mh mi mj lm mk ml mm lp mn mo mp ls mq mr ms lv mt bi translated">行动呼吁</h1><p id="1bb7" class="pw-post-body-paragraph jo jp ir jq b jr lx jt ju jv ly jx jy jz lz kb kc kd ma kf kg kh mb kj kk kl ik bi translated">请让我知道这个帖子是否有用，并帮助我们使<a class="ae km" href="https://github.com/kiali" rel="noopener ugc nofollow" target="_blank"> Kiali </a>以最好的和有用的方式显示各自的信息。</p><h1 id="fa7d" class="md lf ir bd lg me mf mg lj mh mi mj lm mk ml mm lp mn mo mp ls mq mr ms lv mt bi translated">感谢...</h1><p id="110f" class="pw-post-body-paragraph jo jp ir jq b jr lx jt ju jv ly jx jy jz lz kb kc kd ma kf kg kh mb kj kk kl ik bi translated">我要感谢托马斯·霍特、戴尔·巴比伊、约翰·马齐特利、吴庭艳、李涛和朱莉·斯蒂克勒为我提供了这篇文章草稿的良好反馈。</p></div></div>    
</body>
</html>