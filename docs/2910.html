<html>
<head>
<title>Kubernetes Master Nodes Backup for Kops on AWS — A step-by-step Guide</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用于AWS上Kops的Kubernetes主节点备份—分步指南</h1>
<blockquote>原文：<a href="https://itnext.io/kubernetes-master-nodes-backup-for-kops-on-aws-a-step-by-step-guide-4d73a5cd2008?source=collection_archive---------1-----------------------#2019-08-27">https://itnext.io/kubernetes-master-nodes-backup-for-kops-on-aws-a-step-by-step-guide-4d73a5cd2008?source=collection_archive---------1-----------------------#2019-08-27</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><figure class="gl gn jr js jt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi jq"><img src="../Images/cce1e4425e0aaca54eb74e3938c277f1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*KeQ2kNokc7c8s_5F"/></div></div></figure><p id="7604" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">(<a class="ae kz" rel="noopener ugc nofollow" target="_blank" href="/upgrading-kubernetes-cluster-with-kops-and-things-to-watch-out-for-8b5e7dff71c0?source=friends_link&amp;sk=9f326510f264e7a2a2cac97ae70410d0">用Kops </a>升级Kubernetes的相关文章)</p><p id="d596" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">对于那些已经使用了<a class="ae kz" href="https://github.com/kubernetes/kops" rel="noopener ugc nofollow" target="_blank"> kops </a>一段时间的人来说，应该知道从1.11升级到1.12会带来更大的风险，因为它会<a class="ae kz" href="https://github.com/kubernetes/kops/blob/master/docs/etcd3-migration.md" rel="noopener ugc nofollow" target="_blank">将etcd2升级到etcd3 </a>。</p><p id="001f" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">由于这种升级对控制平面(主节点)具有破坏性，尽管很短暂，但我们仍然非常重视，因为几乎所有的缓冲区生产服务都在这个集群上运行。我们认为需要一个比目前实施的<a class="ae kz" href="https://github.com/heptio/velero" rel="noopener ugc nofollow" target="_blank"> Heptio Velero </a>更彻底的备份过程。</p><p id="c82c" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">令我惊讶的是，我的谷歌搜索没有产生任何关于如何执行备份步骤的有用结果。公平地说，有几篇文章是专门针对备份由<a class="ae kz" href="https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/create-cluster-kubeadm/" rel="noopener ugc nofollow" target="_blank"> kubeadm </a>创建的主节点的，但没有什么太具体的针对<code class="fe la lb lc ld b">kops</code>的。我们知道我们必须自己去尝试。</p><p id="3a88" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">我们非常愿意与社区分享我们的经验，并有可能听到每个人都需要做这个升级。现在，让我们开始吧！</p></div><div class="ab cl le lf hx lg" role="separator"><span class="lh bw bk li lj lk"/><span class="lh bw bk li lj lk"/><span class="lh bw bk li lj"/></div><div class="im in io ip iq"><h1 id="fafa" class="ll lm it bd ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi bi translated">创建备份</h1><h2 id="b41c" class="mj lm it bd ln mk ml dn lr mm mn dp lv km mo mp lz kq mq mr md ku ms mt mh mu bi translated">找到主节点并记下连接的设备</h2><p id="4315" class="pw-post-body-paragraph kb kc it kd b ke mv kg kh ki mw kk kl km mx ko kp kq my ks kt ku mz kw kx ky im bi translated">是啊，让我们做一些备份。但是在哪里？我们发现备份主节点最简单的方法是备份它们的EBS卷。这应该很容易吧？但就像科技领域的一切事物一样，总有一些更小的细节需要我们留意。像Kubernetes + kops + AWS这样复杂的东西毫不奇怪也不例外。为了找到正确的EBS卷，让我们看一下下面的屏幕截图。</p><p id="46d1" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">需要注意的是，每个主节点有2个块设备，它们都很重要。一个是给<code class="fe la lb lc ld b">etcd-main</code>的，另一个是给<code class="fe la lb lc ld b">etcd-events</code>的。</p><h2 id="18a3" class="mj lm it bd ln mk ml dn lr mm mn dp lv km mo mp lz kq mq mr md ku ms mt mh mu bi translated">从每个卷创建快照(3个主机x 2个设备= 6个快照)</h2><p id="d5f3" class="pw-post-body-paragraph kb kc it kd b ke mv kg kh ki mw kk kl km mx ko kp kq my ks kt ku mz kw kx ky im bi translated">现在，让我们尝试为每个卷创建一个快照。因为我们的Kubernetes集群运行在3个主节点上以实现高可用性。我们需要这样做6次！从屏幕截图中，您应该可以看到分配给每个卷的所有标签。它们很重要，因为kop依赖它们将卷附加回主节点。现在，让我们承认这一点。我将很快提供更多的细节。</p><figure class="nb nc nd ne gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi na"><img src="../Images/f34136e3279f25233c710c803f9c83dc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*9xFAcql7WSBMGhKM"/></div></div></figure><p id="c83f" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">冲洗并重复6次，我们应该准备好6张快照。</p><figure class="nb nc nd ne gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi na"><img src="../Images/0ea93dfff9d5768eceabbe5c76f8d331.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*OneNc5tg1GJucU5X"/></div></div></figure><p id="a221" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">现在，让我们暂停一下，谈谈我前面提到的标签。每个卷都有正确的标签是很重要的。这里有一个表格，在创建卷时会很方便。是的，这意味着3个主节点设置需要30个(6个卷，每个卷5个标签)标签。</p><h2 id="bbfe" class="mj lm it bd ln mk ml dn lr mm mn dp lv km mo mp lz kq mq mr md ku ms mt mh mu bi translated">创建卷</h2><p id="97de" class="pw-post-body-paragraph kb kc it kd b ke mv kg kh ki mw kk kl km mx ko kp kq my ks kt ku mz kw kx ky im bi translated">如屏幕截图所示，务必确保每个卷都创建在与预期主节点相同的可用性区域中。否则，他们就找不到对方了。现在，我们将保留一个值为<code class="fe la lb lc ld b">stub</code>,因为我们仍然附加了现有的卷。</p><figure class="nb nc nd ne gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi na"><img src="../Images/bad197b5cb9e37e9be7a79538667d145.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*UBi9EV_F2WpUV7B7"/></div></div></figure><p id="a420" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">完成这项工作后，只要我们将<code class="fe la lb lc ld b">stub</code>值换成<code class="fe la lb lc ld b">steven.buffer-k8s.com</code>，我们就应该有六个备份卷准备就绪。我们的备份到此结束。</p><figure class="nb nc nd ne gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi na"><img src="../Images/16dc6f4709e8d56a44aee7e5c2bc3b30.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*PvMSPnv0osbukBIa"/></div></div></figure></div><div class="ab cl le lf hx lg" role="separator"><span class="lh bw bk li lj lk"/><span class="lh bw bk li lj lk"/><span class="lh bw bk li lj"/></div><div class="im in io ip iq"><h1 id="50f7" class="ll lm it bd ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi bi translated">[可选]升级集群</h1><p id="3022" class="pw-post-body-paragraph kb kc it kd b ke mv kg kh ki mw kk kl km mx ko kp kq my ks kt ku mz kw kx ky im bi translated">这一步完全是可选的。唯一的目的是演示如何使用本文中描述的备份/恢复策略恢复错误的集群升级(从1.11到1.12)。</p><p id="aad5" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">请注意，主节点现在在1.12中，我们的目的是将所有内容回滚到1.11。让我们看看我们是否能做到。</p><figure class="nb nc nd ne gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi nf"><img src="../Images/2ab4b5b4763e2a4717ee242781a5d502.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*Pxa21AUK7QHJGHyr"/></div></div></figure></div><div class="ab cl le lf hx lg" role="separator"><span class="lh bw bk li lj lk"/><span class="lh bw bk li lj lk"/><span class="lh bw bk li lj"/></div><div class="im in io ip iq"><h1 id="adb5" class="ll lm it bd ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi bi translated">从备份恢复</h1><h2 id="b8e7" class="mj lm it bd ln mk ml dn lr mm mn dp lv km mo mp lz kq mq mr md ku ms mt mh mu bi translated">分离现有卷并删除它们。这将暂时中断所有主节点</h2><p id="2254" class="pw-post-body-paragraph kb kc it kd b ke mv kg kh ki mw kk kl km mx ko kp kq my ks kt ku mz kw kx ky im bi translated">现在应该很明显，为了从备份中恢复，我们需要首先删除所有现有的附加卷。下面的截图显示了这是在哪里完成的。</p><figure class="nb nc nd ne gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi na"><img src="../Images/df48bf833d6916ff0c22802d3e2f82a2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*qPngd5ccbPZVnnXl"/></div></div></figure><h2 id="0bd0" class="mj lm it bd ln mk ml dn lr mm mn dp lv km mo mp lz kq mq mr md ku ms mt mh mu bi translated">将缺少的标记值添加到备份卷中</h2><p id="ffd0" class="pw-post-body-paragraph kb kc it kd b ke mv kg kh ki mw kk kl km mx ko kp kq my ks kt ku mz kw kx ky im bi translated">随着旧卷的分离和删除，先前创建的备份卷可以连接到主节点。但是首先，我们需要添加回正确的标签值，如屏幕截图所示。</p><figure class="nb nc nd ne gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi na"><img src="../Images/8e11a5082043905c3b922e8934f593f0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*ipBn0YsqNrXqWOXM"/></div></div></figure><p id="f4e0" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">我们现在正处于最后一步。坚持住！为了让主节点获得备份卷，我们需要重新创建所有备份卷。这一步就像终止节点一样简单，因为<code class="fe la lb lc ld b">kops</code>会自动启动新节点，并附加我们创建的卷。</p><figure class="nb nc nd ne gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi na"><img src="../Images/d9c385966972c316354380d4ebce9e06.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*8986eB2mEEuJKE2u"/></div></div></figure><h1 id="6923" class="ll lm it bd ln lo ng lq lr ls nh lu lv lw ni ly lz ma nj mc md me nk mg mh mi bi translated">利润！所有节点回到1.11</h1><figure class="nb nc nd ne gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi nl"><img src="../Images/9ee130bf931880d1035d074695dd7198.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*Yl-IiogSTu_XH0G7"/></div></div></figure><h1 id="75e4" class="ll lm it bd ln lo ng lq lr ls nh lu lv lw ni ly lz ma nj mc md me nk mg mh mi bi translated">结束语</h1><p id="073f" class="pw-post-body-paragraph kb kc it kd b ke mv kg kh ki mw kk kl km mx ko kp kq my ks kt ku mz kw kx ky im bi translated">感谢你在这篇涉及许多步骤的长文上对我的耐心。我相信我们现在正处于Kubernetes采用的一个非常有趣的阶段。虽然它在过去几年取得了惊人的进展，但生态系统仍在追赶。在很长一段时间里，Kubernetes上的CI/CD是一个挑战，然后我们面临着可观察性的问题。幸运的是，像Datadog等人这样的供应商正在不断推出新产品来应对各种挑战。Buffer是Kubernetes的早期采用者，能够见证所有这些转变，并尽我们所能为社区做出贡献，真是幸运。</p><p id="2de7" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">如果你有任何想法，问题。请随时在<a class="ae kz" href="https://twitter.com/stevenc81" rel="noopener ugc nofollow" target="_blank">推特</a>上联系我。在那之前，我希望你和Kubernetes玩得开心！</p></div><div class="ab cl le lf hx lg" role="separator"><span class="lh bw bk li lj lk"/><span class="lh bw bk li lj lk"/><span class="lh bw bk li lj"/></div><div class="im in io ip iq"><p id="f039" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated"><em class="nm">最初发表于</em><a class="ae kz" href="https://gist.github.com/stevenc81/5f4ba26e311fa3ac683eed9c2504cb14" rel="noopener ugc nofollow" target="_blank"><em class="nm">【http://github.com】</em></a><em class="nm">。</em></p></div></div>    
</body>
</html>