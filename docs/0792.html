<html>
<head>
<title>Saving External API Data To Your Own Rails API</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">将外部API数据保存到您自己的Rails API中</h1>
<blockquote>原文：<a href="https://itnext.io/saving-external-api-data-to-your-own-rails-api-fad0fa75066?source=collection_archive---------5-----------------------#2018-05-30">https://itnext.io/saving-external-api-data-to-your-own-rails-api-fad0fa75066?source=collection_archive---------5-----------------------#2018-05-30</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="97e8" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果您试图将外部API数据持久化到自己的后端，您可能会发现这篇博客很有帮助。</p><p id="4996" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这是我基于这个项目的演示视频。</p><p id="dcc1" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果您正在阅读本文，您可能已经理解了什么是获取请求及其重要性。如果你不知道，你可以在这里停下来，用fetch 快速阅读<a class="ae kl" href="https://developer.mozilla.org/en-US/docs/Web/API/Fetch_API/Using_Fetch" rel="noopener ugc nofollow" target="_blank">。</a></p><p id="ea9a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在，既然您熟悉fetch请求，您就知道它们用于在前端JavaScript接口上获取、发布、放置和删除数据。有些事情你可能不知道，你在这里的原因是，也有一种方法可以在Ruby on Rails应用程序的后端做到这一点。</p><p id="f2fb" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">提示RestClient请求！！！</p><p id="5cdd" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">您可能希望利用RestClient调用有几个原因。</p><ol class=""><li id="bda5" class="km kn iq jp b jq jr ju jv jy ko kc kp kg kq kk kr ks kt ku bi translated">您正在使用的外部API具有旋转数据，并且您想要保存所有这些数据以供回顾(或进行纵向研究)</li><li id="cb94" class="km kn iq jp b jq kv ju kw jy kx kc ky kg kz kk kr ks kt ku bi translated">您对某个外部API的API调用次数有限，并且您希望限制调用次数</li><li id="6631" class="km kn iq jp b jq kv ju kw jy kx kc ky kg kz kk kr ks kt ku bi translated">你使用了太多的外部API来保持代码的整洁</li><li id="d93d" class="km kn iq jp b jq kv ju kw jy kx kc ky kg kz kk kr ks kt ku bi translated">以上所有以及更多</li></ol><p id="a1c3" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在我的例子中，我使用RestClient将5个外部API的数据保存到我自己的Rails API中。我选择使用RestClient的原因如上。</p><p id="17ac" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">最初，我使用fetch请求从前端进行这些调用，但这是一个耗时的过程，它降低了我的应用程序的速度，并使我的代码冗长而混乱。在我的例子中，RestClient调用将我的所有数据保存在我的数据库中，这使得从我的前端到我自己的个人Rails API的一个单一获取请求就可以很容易地到达。</p><h1 id="da6d" class="la lb iq bd lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx bi translated">项目背景</h1><p id="5ffe" class="pw-post-body-paragraph jn jo iq jp b jq ly js jt ju lz jw jx jy ma ka kb kc mb ke kf kg mc ki kj kk ij bi translated">我决定开展一项研究，对纽约时报、福克斯新闻频道、美国广播公司、英国广播公司和美国有线电视新闻网的文章进行情感分析。使用React前端和Rails后端，我这样做是因为显然有大量的混乱和与主要新闻站和普通大众的脱节。我想看看当我并排展示数据时，他们文章背后的情绪是否讲述了什么故事。对于这个项目，我使用了<a class="ae kl" href="https://indico.io/docs#custom" rel="noopener ugc nofollow" target="_blank"> Indico情感分析API </a>。它非常容易使用，我推荐它来获得表面层次的情感。我不太敢说你真的可以相信这些结果，因为它很难理解背景(这是我研究中的一个主要缺陷)。我也开始构建自己的情感分析人工智能，但我的旧MacBook Pro花了几个小时来训练我的模型，所以为了节省时间，我放弃了它。</p><p id="e10e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在，这是我的一个后端RestClient文件的样子。我从《纽约时报》API中提取数据，同时对每篇文章进行情感分析，并将其保存到我自己的数据库中。我已经对代码进行了注释以供参考(所有跟在“#”后面的内容)。如果你想做类似的事情，你应该能够复制一个类似的结构。请特别注意页面顶部需要的宝石、正在解析的数据，以便我能够迭代每个单独的结果或文章，我采取的措施以确保我的数据库中没有重复，以及我如何保存文章(输出可以在页面底部的GIF中看到)。</p><pre class="md me mf mg gt mh mi mj mk aw ml bi"><span id="bab9" class="mm lb iq mi b gy mn mo l mp mq">require 'rest-client'<br/>require 'indico'<br/>require 'rails/configuration'</span><span id="ddca" class="mm lb iq mi b gy mr mo l mp mq">#New York Times API endpoint<br/>  nyt_url = "<a class="ae kl" href="https://api.nytimes.com/svc/topstories/v2/home.json?&amp;api-key=" rel="noopener ugc nofollow" target="_blank">https://api.nytimes.com/svc/topstories/v2/home.json?&amp;api-key=</a>"</span><span id="7da5" class="mm lb iq mi b gy mr mo l mp mq">#RestClient get request to the NYT endpoint with my API Key being parsed into a JS object<br/>  data = JSON.parse( RestClient.get("#{nyt_url}#{ENV["NYT_API_KEY"]}") )</span><span id="d106" class="mm lb iq mi b gy mr mo l mp mq">#Iterating through each result/article of the NYT<br/>  data["results"].each do |article, index|<br/>    #finding existing articles<br/>    existing_article = Article.find_by(headline: article["title"])<br/>    #checking if the articles abstract is there and if the article doesnt exist<br/>    if article["abstract"].length &gt; 0<br/>      if !existing_article<br/>        config = {api_key: "#{ENV["INDICO_API_KEY"]}"}<br/>        #Running sentimental analysis on the article's abstract<br/>        emotion = (Indico.emotion(article["abstract"], config))</span><span id="6803" class="mm lb iq mi b gy mr mo l mp mq">#Creating a new article in my database and assigning it's properties<br/>        news = Article.new do |key|<br/>          key.headline = article["title"]<br/>          key.news_station = "New York Times"<br/>          key.abstract = article["abstract"]<br/>          key.category = article["section"]<br/>          key.url = article["url"]<br/>          #Some of the articles didnt have pictures so I made a default one if there was no pic<br/>          if article["multimedia"].length === 0<br/>            key.image = "<a class="ae kl" href="http://www.nytimes.com/services/mobile/img/ios-newsreader-icon.png" rel="noopener ugc nofollow" target="_blank">http://www.nytimes.com/services/mobile/img/ios-newsreader-icon.png</a>"<br/>          else<br/>            key.image = article["multimedia"][0]["url"]<br/>          end<br/>          #Saving sentiments<br/>          key.anger = emotion["anger"]<br/>          key.joy = emotion["joy"]<br/>          key.fear = emotion["fear"]<br/>          key.sadness = emotion["sadness"]<br/>          key.surprise = emotion["surprise"]<br/>          key.date = Time.now<br/>        end<br/>        #Saving articles<br/>        if news.save<br/>          puts "saved nyt"<br/>        else<br/>          puts "not saved"<br/>        end<br/>      end<br/>    end<br/>  end</span></pre><p id="7cb6" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">好的，所以代码是有意义的…但是我如何让它把文章拉进我的数据库，我在哪里写这个代码？</p><p id="ff93" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">有几种不同的方法可以做到这一点。在我的例子中，我决定在服务器初始化时这样做。在做这个项目的时候，我一天要启动我的服务器好几次，所以我会把所有发表的文章都拉进来。然而，我不会说这是最好的方法。它对我有用，因为我选择不将我的项目投入使用；我的数据库太大了，无法在Heroku上运行。</p><p id="fea7" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果您想像我这样做，我将把我的Rails API的文件结构留在这里。</p><pre class="md me mf mg gt mh mi mj mk aw ml bi"><span id="85da" class="mm lb iq mi b gy mn mo l mp mq">-app<br/>-bin<br/>-<em class="ms">config</em><br/>--environments<br/>--<em class="ms">initializers<br/>---&lt;RestClient file as seen above here&gt;<br/>--</em>locales<br/>-db<br/>-lib<br/>-log<br/>-public<br/>-tmp<br/>-vendor</span></pre><p id="57f5" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">下面是我的Rails服务器启动时的样子。正如你所看到的，在初始化服务器时，它为每篇被保存的文章输出“saved <news station="">”。</news></p><figure class="md me mf mg gt mt"><div class="bz fp l di"><div class="mu mv l"/></div></figure><p id="64e3" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果你想把你的项目投入使用，我会建议你不要在初始化时更新。这里有两种方法可以让你在每次上传新文章时或者在设定的时间间隔内更新你的服务器。</p><h2 id="f73c" class="mm lb iq bd lc mw mx dn lg my mz dp lk jy na nb lo kc nc nd ls kg ne nf lw ng bi translated">克朗·乔布斯</h2><div class="nh ni gp gr nj nk"><a href="https://github.com/javan/whenever" rel="noopener  ugc nofollow" target="_blank"><div class="nl ab fo"><div class="nm ab nn cl cj no"><h2 class="bd ir gy z fp np fr fs nq fu fw ip bi translated">javan/无论何时</h2><div class="nr l"><h3 class="bd b gy z fp np fr fs nq fu fw dk translated">Ruby中的任何时候- Cron作业</h3></div><div class="ns l"><p class="bd b dl z fp np fr fs nq fu fw dk translated">github.com</p></div></div><div class="nt l"><div class="nu l nv nw nx nt ny nz nk"/></div></div></a></div><h2 id="ac63" class="mm lb iq bd lc mw mx dn lg my mz dp lk jy na nb lo kc nc nd ls kg ne nf lw ng bi translated">Heroku上的计划作业</h2><div class="nh ni gp gr nj nk"><a href="https://devcenter.heroku.com/articles/scheduled-jobs-custom-clock-processes" rel="noopener  ugc nofollow" target="_blank"><div class="nl ab fo"><div class="nm ab nn cl cj no"><h2 class="bd ir gy z fp np fr fs nq fu fw ip bi translated">计划作业和定制时钟流程| Heroku开发中心</h2><div class="nr l"><h3 class="bd b gy z fp np fr fs nq fu fw dk translated">使用Scheduler插件或通过实现自定义时钟流程，在Heroku上计划重复或基于时间的作业。</h3></div><div class="ns l"><p class="bd b dl z fp np fr fs nq fu fw dk translated">devcenter.heroku.com</p></div></div><div class="nt l"><div class="oa l nv nw nx nt ny nz nk"/></div></div></a></div><p id="12e8" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">一旦我弄清楚了这个项目的RestClient请求，事情就一帆风顺了。祝你好运！</p></div></div>    
</body>
</html>