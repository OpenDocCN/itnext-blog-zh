<html>
<head>
<title>How to implement SSO with Traefik V2 on Kubernetes</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何在Kubernetes上用Traefik V2实现单点登录</h1>
<blockquote>原文：<a href="https://itnext.io/how-to-implement-a-sso-middleware-for-traefik-v2-on-kubernetes-dcd9d45cc875?source=collection_archive---------2-----------------------#2020-01-26">https://itnext.io/how-to-implement-a-sso-middleware-for-traefik-v2-on-kubernetes-dcd9d45cc875?source=collection_archive---------2-----------------------#2020-01-26</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="820e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi kl translated"><span class="l km kn ko bm kp kq kr ks kt di">厌倦了每次访问Traefik V2负载均衡器后的应用程序都必须登录？我有好消息告诉你。在本文中，我将解释如何为Traefik代理背后的一切实现单点登录(SSO ),这样您就再也不用重复输入您的凭证了！</span></p></div><div class="ab cl ku kv hu kw" role="separator"><span class="kx bw bk ky kz la"/><span class="kx bw bk ky kz la"/><span class="kx bw bk ky kz"/></div><div class="ij ik il im in"><h1 id="e1ed" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">概观</h1><p id="2f80" class="pw-post-body-paragraph jn jo iq jp b jq lz js jt ju ma jw jx jy mb ka kb kc mc ke kf kg md ki kj kk ij bi translated">为此，我们将在Thom Seddon 的<a class="ae me" href="https://github.com/thomseddon/traefik-forward-auth" rel="noopener ugc nofollow" target="_blank"> Traefik Forward Auth的帮助下使用Google OAuth(感谢他)</a></p><p id="cdaa" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">为了更好地理解如何协同工作，我画了一个简单的授权流程图:</p><figure class="mg mh mi mj gt mk gh gi paragraph-image"><div role="button" tabindex="0" class="ml mm di mn bf mo"><div class="gh gi mf"><img src="../Images/2a2cc236b8e31d59de6d827c19ba5600.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*RDcYXe7Rig3qr06Px9WgJg.png"/></div></div><figcaption class="mr ms gj gh gi mt mu bd b be z dk translated">图一。授权流程的可视化表示。</figcaption></figure><ol class=""><li id="90bc" class="mv mw iq jp b jq jr ju jv jy mx kc my kg mz kk na nb nc nd bi translated">用户访问我们Traefik负载平衡器背后的app01.example.com</li><li id="0bca" class="mv mw iq jp b jq ne ju nf jy ng kc nh kg ni kk na nb nc nd bi translated">请求被重定向到用户登录的Google OAuth。</li><li id="f6ed" class="mv mw iq jp b jq ne ju nf jy ng kc nh kg ni kk na nb nc nd bi translated">如果授权成功，用户将被重定向回auth.example.com/_oauth.上的Traefik。该服务然后根据cookie检查请求属于哪个应用程序，并将其重定向。</li><li id="929d" class="mv mw iq jp b jq ne ju nf jy ng kc nh kg ni kk na nb nc nd bi translated">请求完成</li></ol><p id="9b3c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在，在谷歌登录请求的有效期内，你将能够访问你的服务，而不必再看到一个登录屏幕！很酷吧？</p><h1 id="3bd6" class="lb lc iq bd ld le nj lg lh li nk lk ll lm nl lo lp lq nm ls lt lu nn lw lx ly bi translated">履行</h1><p id="3491" class="pw-post-body-paragraph jn jo iq jp b jq lz js jt ju ma jw jx jy mb ka kb kc mc ke kf kg md ki kj kk ij bi translated">现在是有趣的部分，在我们的Kubernetes环境中实现SSO。</p><h2 id="ece4" class="no lc iq bd ld np nq dn lh nr ns dp ll jy nt nu lp kc nv nw lt kg nx ny lx nz bi translated">先决条件</h2><ul class=""><li id="d840" class="mv mw iq jp b jq lz ju ma jy oa kc ob kg oc kk od nb nc nd bi translated">谷歌账户或G-suite环境</li><li id="2ef1" class="mv mw iq jp b jq ne ju nf jy ng kc nh kg ni kk od nb nc nd bi translated">在Kubernetes环境中运行的Traefik V2</li><li id="267c" class="mv mw iq jp b jq ne ju nf jy ng kc nh kg ni kk od nb nc nd bi translated">Traefik中已配置的证书解析程序</li><li id="515c" class="mv mw iq jp b jq ne ju nf jy ng kc nh kg ni kk od nb nc nd bi translated">一些空闲时间</li></ul><h2 id="6dc4" class="no lc iq bd ld np nq dn lh nr ns dp ll jy nt nu lp kc nv nw lt kg nx ny lx nz bi translated">创建我们的谷歌证书</h2><p id="b681" class="pw-post-body-paragraph jn jo iq jp b jq lz js jt ju ma jw jx jy mb ka kb kc mc ke kf kg md ki kj kk ij bi translated">首先，访问<a class="ae me" href="https://console.developers.google.com/" rel="noopener ugc nofollow" target="_blank"> Google开发者控制台</a>并创建一个新项目(或者使用一个现有的项目)。在主页上，选择凭据→创建凭据→ OAuth客户端ID，如下所示:</p><figure class="mg mh mi mj gt mk gh gi paragraph-image"><div role="button" tabindex="0" class="ml mm di mn bf mo"><div class="gh gi oe"><img src="../Images/949b29e91e578fc85b9977f162ebe8ac.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*zlTuW_XGceqUsXtI11DjEw.png"/></div></div><figcaption class="mr ms gj gh gi mt mu bd b be z dk translated">图二。创建您的OAuth客户端ID和密码</figcaption></figure><p id="87a3" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果您之前没有设置OAuth，它会要求您首先设置一个同意屏幕。选择外部并填写这两个字段:<br/> <strong class="jp ir">应用名称:</strong> Traefik SSO <br/> <strong class="jp ir">授权域:</strong>example.com(用您的域替换example.com)</p><p id="8848" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在，您将能够在Credentials选项卡中获得您的OAuth客户端ID。选择Web应用程序，输入名称，将授权的JavaScript源留空，并输入您的域(替换example.com ),包括如下所示的<code class="fe of og oh oi b">/_oauth</code>路径:</p><figure class="mg mh mi mj gt mk gh gi paragraph-image"><div role="button" tabindex="0" class="ml mm di mn bf mo"><div class="gh gi oj"><img src="../Images/c2f33efdd4afb19c7068bc344824d3a9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*WM_cBz41A5H-8p1cRHzERg.png"/></div></div><figcaption class="mr ms gj gh gi mt mu bd b be z dk translated">图3。创建您的OAuth客户端ID和密码</figcaption></figure><p id="4ace" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">谷歌将显示你的客户端id和秘密，保存这些地方保存，并前往下一步。</p><h2 id="5d87" class="no lc iq bd ld np nq dn lh nr ns dp ll jy nt nu lp kc nv nw lt kg nx ny lx nz bi translated">Kubernetes部署</h2><p id="3678" class="pw-post-body-paragraph jn jo iq jp b jq lz js jt ju ma jw jx jy mb ka kb kc mc ke kf kg md ki kj kk ij bi translated">在我们开始部署我们的ForwardAuth之前，我们需要创建一个包含我们从Google的开发者控制台获得的信息的secret，其中Secret应该是一个随机字符串(即由<code class="fe of og oh oi b">openssl rand -hex 16</code>生成):</p><pre class="mg mh mi mj gt ok oi ol om aw on bi"><span id="ba64" class="no lc iq oi b gy oo op l oq or">kubectl create secret generic traefik-sso \<br/>--from-literal=clientid=XXX.apps.googleusercontent.com \<br/>--from-literal=clientsecret=XXX \<br/>--from-literal=secret=SomEtHingRandom</span></pre><p id="9542" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">接下来，复制。yaml文件，并至少更改以下环境变量以满足您的需要:</p><p id="8440" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">COOKIE _ DOMAIN:</strong>yourdomain.com<strong class="jp ir">T3】AUTH _ HOST:</strong>auth.yourdomain.com<strong class="jp ir"><br/>白名单:</strong>youremailaddress@gmail.com</p><p id="79a5" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">此外，查看IngressRoute以确保它也包含您自己的certificateresolver(在我的例子中是Cloudflare)和域。</p><figure class="mg mh mi mj gt mk"><div class="bz fp l di"><div class="os ot l"/></div></figure><p id="c2fd" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">应用。yaml文件并访问您的Traefik仪表板，它现在应该包含一个新的中间件</p><figure class="mg mh mi mj gt mk gh gi paragraph-image"><div role="button" tabindex="0" class="ml mm di mn bf mo"><div class="gh gi ou"><img src="../Images/35c0c7ad7ddcd2852968727c15231895.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*veI8S2tPT0J0yqHUzMvxEQ.png"/></div></div><figcaption class="mr ms gj gh gi mt mu bd b be z dk translated">图4。创建新的中间件</figcaption></figure><p id="80c9" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">但是，目前没有应用程序使用这个新的中间件。将新创建的中间件添加到您的IngressRoute:</p><pre class="mg mh mi mj gt ok oi ol om aw on bi"><span id="2886" class="no lc iq oi b gy oo op l oq or">apiVersion: traefik.containo.us/v1alpha1<br/>kind: IngressRoute<br/>metadata:<br/>  name: app01<br/>spec:<br/>  entryPoints:<br/>    - websecure<br/>  routes:<br/>  - match: Host(`app01.example.com`)<br/>    kind: Rule<br/>    services:<br/>    - name: app01<br/>      port: 8080<br/><strong class="oi ir">    middlewares:<br/>      - name: traefik-sso@kubernetescrd</strong><br/>  tls:<br/>    certResolver: cloudflare<br/>    domains:<br/>      - main: "*.example.com"<br/>    options: {}</span></pre><p id="95e2" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">应用更新的IngressRoute，您就可以开始了！:)</p><h1 id="5263" class="lb lc iq bd ld le nj lg lh li nk lk ll lm nl lo lp lq nm ls lt lu nn lw lx ly bi translated">SSO正在运行</h1><p id="7894" class="pw-post-body-paragraph jn jo iq jp b jq lz js jt ju ma jw jx jy mb ka kb kc mc ke kf kg md ki kj kk ij bi translated">如果一切顺利，当您现在访问您的应用程序时，您会注意到重定向到一个Google登录页面。输入您的白名单谷歌地址，如果您设置正确，您的授权是成功的，您将被重定向到您的应用程序！</p><figure class="mg mh mi mj gt mk gh gi paragraph-image"><div role="button" tabindex="0" class="ml mm di mn bf mo"><div class="gh gi ov"><img src="../Images/98bbd1d6c8f02787c33994c59beef77e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Khf782kxqR9o4t9_9m4mWw.png"/></div></div><figcaption class="mr ms gj gh gi mt mu bd b be z dk translated">图5。SSO正在运行</figcaption></figure><h1 id="12fc" class="lb lc iq bd ld le nj lg lh li nk lk ll lm nl lo lp lq nm ls lt lu nn lw lx ly bi translated">结束了。</h1><p id="28ff" class="pw-post-body-paragraph jn jo iq jp b jq lz js jt ju ma jw jx jy mb ka kb kc mc ke kf kg md ki kj kk ij bi translated">如果您对您的应用程序前面的新SSO满意，请让我知道；爱听你们的经历:)。如果以上有什么不清楚或者对你没有用，请告诉我，我很乐意帮助你！</p></div></div>    
</body>
</html>