<html>
<head>
<title>bigint-money: an NPM package for doing currency math</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">bigint-money:一个做货币数学的NPM软件包</h1>
<blockquote>原文：<a href="https://itnext.io/bigint-money-an-npm-package-for-doing-currency-math-be041aeec8df?source=collection_archive---------3-----------------------#2019-01-23">https://itnext.io/bigint-money-an-npm-package-for-doing-currency-math-be041aeec8df?source=collection_archive---------3-----------------------#2019-01-23</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/fa5a2422dd0e30e3bb640a64436d6edb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*v7FPoGxICMj325fRHqO2Ag.png"/></div></div></figure><p id="022f" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">不久前，我对用金钱和浮点问题做数学感到困惑。经过大量的研究和朋友们的帮助，我明白了很多人在我之前已经做过的事情:使用浮点确实不好。你可能会遇到舍入问题，并且真的想使用“精确数学”。</p><p id="2f8f" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">之后，我意识到我想使用新的Ecmascript <a class="ae kw" href="https://github.com/tc39/proposal-bigint" rel="noopener ugc nofollow" target="_blank"> bigint </a>类型作为表示金钱的基础。这是最近版本的Node.js和Typescript支持的，这也是我需要的地方。</p><p id="7351" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">但是有一个问题，<code class="fe kx ky kz la b">bigint</code>类型只保存“整数”,不做定点十进制数学。我在NPM上四处寻找可以为我抽象这个的东西，但是找不到一个库。</p><p id="c1b3" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">所以我花了几天时间编写了一个简单的名为<code class="fe kx ky kz la b">bigint-money</code>的npm库，它封装了<code class="fe kx ky kz la b">bigint</code>类型。它是用打字稿写的，而且是开源的，所以任何人都可以使用:<a class="ae kw" href="https://www.npmjs.com/package/bigint-money" rel="noopener ugc nofollow" target="_blank">https://www.npmjs.com/package/bigint-money</a>。</p><p id="acdf" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">主要特点:</p><h1 id="a044" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">基准</h1><p id="632d" class="pw-post-body-paragraph jy jz iq ka b kb lz kd ke kf ma kh ki kj mb kl km kn mc kp kq kr md kt ku kv ij bi translated">NPM上的大多数“钱”库只使用2位数字进行精确计算，或者使用Javacript的“数字”,很快就会溢出。</p><p id="0902" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我找到的唯一可比较的图书馆是<a class="ae kw" href="https://www.npmjs.com/package/big-money" rel="noopener ugc nofollow" target="_blank">大款</a>。如果您的Javascript环境还不支持<code class="fe kx ky kz la b">bigint</code>，这可能是最好的选择。</p><p id="b096" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我的简单基准计算一个有100万条目的分类帐。</p><pre class="me mf mg mh gt mi la mj mk aw ml bi"><span id="7cf5" class="mm lc iq la b gy mn mo l mp mq">       bigint-money | big-money<br/>ledger       816 ms | 43.201 ms <br/>%             100 % | 5294 %</span></pre><p id="f23e" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">基准脚本可以在<a class="ae kw" href="https://twitter.com/evertp/status/1088147830529802242" rel="noopener ugc nofollow" target="_blank">库</a>中找到。</p><p id="cca2" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我想强调的是，这个(相当好的)结果不是我的功劳。图书馆很快，因为<code class="fe kx ky kz la b">bigint</code>很快。</p><p id="4738" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我确实需要自己实现一些功能，实际上我觉得更擅长编写快速代码的人可能会比我做得更好。</p><p id="c003" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我想，特别是<code class="fe kx ky kz la b">moneyValueToBigInt</code>和<code class="fe kx ky kz la b">bigintToFixed</code>内部函数可能会被比我聪明得多的人优化。</p><h1 id="6b0f" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">例子</h1><p id="bb5c" class="pw-post-body-paragraph jy jz iq ka b kb lz kd ke kf ma kh ki kj mb kl km kn mc kp kq kr md kt ku kv ij bi translated">它通常是这样工作的:</p><pre class="me mf mg mh gt mi la mj mk aw ml bi"><span id="d2d4" class="mm lc iq la b gy mn mo l mp mq">// Creating a money object.</span><span id="5b4a" class="mm lc iq la b gy mr mo l mp mq">import Money from 'bigint-money';<br/>const foo = new Money('5', 'USD');</span></pre><p id="156f" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">也可以用一个数字创建一个新的货币对象</p><pre class="me mf mg mh gt mi la mj mk aw ml bi"><span id="dffc" class="mm lc iq la b gy mn mo l mp mq">const foo = new Money(5, 'USD');</span></pre><p id="70af" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">但是，如果你给它传递一个不安全的数字，比如一个浮点数，就会抛出一个错误:</p><pre class="me mf mg mh gt mi la mj mk aw ml bi"><span id="de0e" class="mm lc iq la b gy mn mo l mp mq">const foo = new Money(.5, 'USD'); // UnsafeIntegerException</span></pre><p id="1c13" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">一旦有了Money对象，就可以使用<code class="fe kx ky kz la b">toFixed()</code>输出一个字符串。</p><pre class="me mf mg mh gt mi la mj mk aw ml bi"><span id="c9cf" class="mm lc iq la b gy mn mo l mp mq">const foo = new Money('5', 'USD');<br/>console.log(foo.toFixed(2)); // 5.00</span></pre><h1 id="f346" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">算术</h1><p id="408f" class="pw-post-body-paragraph jy jz iq ka b kb lz kd ke kf ma kh ki kj mb kl km kn mc kp kq kr md kt ku kv ij bi translated">可以在上面用<code class="fe kx ky kz la b">.add()</code>和<code class="fe kx ky kz la b">.subtract()</code>:</p><pre class="me mf mg mh gt mi la mj mk aw ml bi"><span id="27bf" class="mm lc iq la b gy mn mo l mp mq">const foo = new Money('5', 'USD');<br/>const bar = foo.add('10');</span></pre><p id="d24d" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">所有的货币对象都是不可变的。调用这些函数不会改变原始值:</p><pre class="me mf mg mh gt mi la mj mk aw ml bi"><span id="8545" class="mm lc iq la b gy mn mo l mp mq">console.log(foo.toFixed(2), bar.toFixed(2)); // 5.00 1.00</span></pre><p id="6f00" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">您还可以传递货币对象来进行加减运算:</p><pre class="me mf mg mh gt mi la mj mk aw ml bi"><span id="3493" class="mm lc iq la b gy mn mo l mp mq">const startBalance = new Money(1000, 'USD');<br/>const salary = new Money(2000, 'USD');<br/>const newBalance = startBalance.add(salary);</span></pre><p id="db67" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">如果您尝试添加不同货币的货币，将会出现错误:</p><pre class="me mf mg mh gt mi la mj mk aw ml bi"><span id="04b6" class="mm lc iq la b gy mn mo l mp mq">new Money(1000, 'USD').add( new Money( 50000, 'YEN' ));<br/>// IncompatibleCurrencyError</span></pre><p id="5926" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">除法和乘法:</p><pre class="me mf mg mh gt mi la mj mk aw ml bi"><span id="258d" class="mm lc iq la b gy mn mo l mp mq">// Division<br/>const result = new Money(10).divide(3);</span><span id="d629" class="mm lc iq la b gy mr mo l mp mq">// Multiplication<br/>const result = new Money('2000').multiply('1.25');</span></pre><h1 id="4491" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">比较对象</h1><p id="9a3e" class="pw-post-body-paragraph jy jz iq ka b kb lz kd ke kf ma kh ki kj mb kl km kn mc kp kq kr md kt ku kv ij bi translated">现在，货币对象只有一个比较功能。</p><pre class="me mf mg mh gt mi la mj mk aw ml bi"><span id="f71f" class="mm lc iq la b gy mn mo l mp mq">const money1 = new Money('1.00', 'EUR');</span><span id="a856" class="mm lc iq la b gy mr mo l mp mq">money.compare(2); // Returns -1<br/>money.compare(1); // Returns 0<br/>money.compare(0); // Returns 1<br/>money.compare('0.01'); // returns -1<br/>money.compare(new Money('1.000005', 'EUR')); // returns 1</span><span id="9ae5" class="mm lc iq la b gy mr mo l mp mq">// throws IncompatibleCurrencyError<br/>money.compare(new Money('1', 'CAD'));</span></pre><p id="9b9d" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">其思想是，如果对象小于传递的对象，则返回-1。如果相等，则返回0，如果传递的值较大，则返回1。</p><p id="5401" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">这使得排序变得容易:</p><pre class="me mf mg mh gt mi la mj mk aw ml bi"><span id="03c1" class="mm lc iq la b gy mn mo l mp mq">const values = [ new Money('1', 'USD'), new Money('2', 'USD') ]; values.sort( (a, b) =&gt; a.compare(b) );</span></pre><h1 id="6977" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">分配</h1><p id="1aa3" class="pw-post-body-paragraph jy jz iq ka b kb lz kd ke kf ma kh ki kj mb kl km kn mc kp kq kr md kt ku kv ij bi translated">当把钱平分时，可能会损失一便士。例如，在三个人之间分配1美元时，每个人得到0.33美元，但还有多余的0.01美元。</p><p id="619b" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">allocate函数将一个货币值分成均匀的部分，但是剩余的部分按循环方式分配。</p><pre class="me mf mg mh gt mi la mj mk aw ml bi"><span id="ac2f" class="mm lc iq la b gy mn mo l mp mq">const earnings = new Money(100, 'USD');<br/>console.log( earnings.allocate(3, 2); ); </span><span id="05e7" class="mm lc iq la b gy mr mo l mp mq">// Results in 3 Money objects:<br/>// 33.34<br/>// 33.33<br/>// 33.33</span></pre><p id="7804" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">分割债务(负值)也像预期的那样起作用。</p><p id="25c8" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">allocate函数的第二个参数是精度。基本上就是你感兴趣的位数。</p><p id="3b6b" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">对于美元和大多数货币，这是2。它需要传递这个参数，因为Money对象无法猜测所需的精度。</p></div><div class="ab cl ms mt hu mu" role="separator"><span class="mv bw bk mw mx my"/><span class="mv bw bk mw mx my"/><span class="mv bw bk mw mx"/></div><div class="ij ik il im in"><p id="948d" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><em class="mz">最初发表于</em><a class="ae kw" href="https://evertpot.com/bigint-money-typscript-lib/" rel="noopener ugc nofollow" target="_blank">T5【evertpot.com】</a><em class="mz">。</em></p></div></div>    
</body>
</html>