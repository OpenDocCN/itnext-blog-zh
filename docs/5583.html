<html>
<head>
<title>Go Virtual Filesystem — Adding A Text Editor</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">转到虚拟文件系统—添加文本编辑器</h1>
<blockquote>原文：<a href="https://itnext.io/go-virtual-filesystem-adding-a-text-editor-176f082e0109?source=collection_archive---------1-----------------------#2021-04-09">https://itnext.io/go-virtual-filesystem-adding-a-text-editor-176f082e0109?source=collection_archive---------1-----------------------#2021-04-09</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="00e1" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">请将此视为项目中的项目，因为这将很难…</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi kl"><img src="../Images/05f10e216619a4121e03c10c50b43f86.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*m2yTUxD4bID1c4SmfE0_Zw.png"/></div></div></figure><p id="ad41" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们本周又回来了，读者！与我之前关于接下来会发生什么的声明相反，protobuf(协议缓冲区)本周将被搁置。我开始工作，但后来我开始玩角色4，发现自己无法停止。扮演一个时间管理能力极差的人，我觉得很吸引人，很难让自己离开。</p><p id="a447" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">但是让我们进入本周的话题；文本编辑器。</p><p id="e478" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">有趣的是，我决定使用编辑器，因为它似乎比文件系统映像更容易；我真是太天真了。</p><h1 id="e5f0" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">屡试不爽的策略</h1><ol class=""><li id="7f12" class="lv lw iq jp b jq lx ju ly jy lz kc ma kg mb kk mc md me mf bi translated"><strong class="jp ir">拆开kilo-in-go并把它放进我的文件系统</strong></li></ol><p id="f3dd" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我对文本编辑器做了三次迭代；每一次都让我不断反思我将要被迫做的大量工作。我想到的第一个绝妙的主意是使用kilo-in-go编辑器(参见repo:<a class="ae mg" href="https://github.com/bediger4000/kilo-in-go" rel="noopener ugc nofollow" target="_blank">https://github.com/bediger4000/kilo-in-go</a>)，进入它的源代码，把它拆成碎片，然后把这些碎片直接重建到我的文件系统源代码中，我们就有了一个类似vim的编辑器。</p><p id="ec2f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">理论上这是一个伟大的计划，如果不是因为Windows坚持要与众不同，我也不会得逞。是的，我完全被Windows和Linux/Mac之间的架构差异挫败了，因为让kilo编辑器工作的系统调用在Windows中根本不存在。</p><p id="9904" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">所以即使我把它集成到了，它也能在Linux上工作，但在Windows上不行。</p><p id="dd64" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">外卖</strong>:</p><p id="1c36" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">当我最终(可能)实现特定于操作系统的差异，使我的文件系统真正不可知时(参见文件路径中的<code class="fe mh mi mj mk b">/</code>和<code class="fe mh mi mj mk b">\\</code>差异)，为Linux用户添加Kilo编辑器，我仍然认为这是一个很酷的想法，也是一个有趣的周末项目。</p><p id="56e9" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir"> 2。在浏览器窗口中运行编辑器(Flask版本)</strong></p><p id="2e2e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我对web编程无法控制的恐惧让这种方法有点难以下咽，因为这似乎是唯一的选择。但是当我在最后期限(我完全知道我错过了)的时候，我选择了背叛你的信任和我自己的尊严，回到用Python写这一小段(毕竟在Go中不是那么虚拟的文件系统)。</p><p id="bfc0" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这个计划有点复杂，因为将两种语言混合在一起看起来有点混乱和缓慢。控制流如下所示:</p><ul class=""><li id="488b" class="lv lw iq jp b jq jr ju jv jy ml kc mm kg mn kk mo md me mf bi translated">用户在文件系统中输入<code class="fe mh mi mj mk b">open filename</code>。</li><li id="7204" class="lv lw iq jp b jq mp ju mq jy mr kc ms kg mt kk mo md me mf bi translated">目标文件的<code class="fe mh mi mj mk b">content</code>字段的内容将被写入主机操作系统磁盘上名为<code class="fe mh mi mj mk b">TEST</code>的本地文件。</li><li id="71cf" class="lv lw iq jp b jq mp ju mq jy mr kc ms kg mt kk mo md me mf bi translated">使用Golang函数<code class="fe mh mi mj mk b">exec.Command()</code>，Flask python应用程序将在后台运行。</li><li id="a9fe" class="lv lw iq jp b jq mp ju mq jy mr kc ms kg mt kk mo md me mf bi translated">Flask使用<code class="fe mh mi mj mk b">ace</code>文本编辑器JavaScript库读取<code class="fe mh mi mj mk b">TEST</code>文件的内容，并在<code class="fe mh mi mj mk b">127.0.0.1:5000</code>在浏览器中显示。</li><li id="6b26" class="lv lw iq jp b jq mp ju mq jy mr kc ms kg mt kk mo md me mf bi translated">当在浏览器中工作时，编辑器<code class="fe mh mi mj mk b">Ctrl+S</code>被映射为将编辑器的内容发送到Flask后端，在那里它将被写入<code class="fe mh mi mj mk b">TEST</code>。</li><li id="c831" class="lv lw iq jp b jq mp ju mq jy mr kc ms kg mt kk mo md me mf bi translated">在退出浏览器和Flask应用程序时，文件系统将恢复其执行，从<code class="fe mh mi mj mk b">TEST</code>读取新保存的内容，并将其写入适当的<code class="fe mh mi mj mk b">filename</code>文件结构的<code class="fe mh mi mj mk b">content</code>字段。</li><li id="e3d1" class="lv lw iq jp b jq mp ju mq jy mr kc ms kg mt kk mo md me mf bi translated"><code class="fe mh mi mj mk b">TEST</code>被删除。</li></ul><p id="9910" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">到目前为止，除了关闭Flask应用程序的时刻，使用Ctrl+C将退出一切；包括文件系统。</p><p id="e60c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">最后，我无法摆脱不学习如何在Go中进行web开发的困境。因此，新的计划将是通过教程地狱去准备网络编程和快速训练蒙太奇后，是时候采取另一个尝试。</p><h1 id="f888" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">最终结果——一个有效的编辑器</h1><p id="9d32" class="pw-post-body-paragraph jn jo iq jp b jq lx js jt ju ly jw jx jy mu ka kb kc mv ke kf kg mw ki kj kk ij bi translated">最终结果还不错，它是这样运行的:</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div class="gh gi mx"><img src="../Images/f23658cdc5ecc0c224583aefc3fc4df5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1302/format:webp/1*QKVUIp7dvrqTVxbjUlN6mA.png"/></div><figcaption class="my mz gj gh gi na nb bd b be z dk translated">在文件系统shell中运行open命令</figcaption></figure><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi nc"><img src="../Images/90c4d346cc375bb780199634902fb1b3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*2W2W0prrjdfuNyzySGej5g.png"/></div></div><figcaption class="my mz gj gh gi na nb bd b be z dk translated">使用ace文本编辑器Javascript框架在浏览器中打开shell.go。</figcaption></figure><p id="e273" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">就像这样，我们有一个全功能的文本编辑器，Ctrl+S映射到文件保存，关闭浏览器选项卡也关闭文件。</p><h2 id="4598" class="nd ky iq bd kz ne nf dn ld ng nh dp lh jy ni nj ll kc nk nl lp kg nm nn lt no bi translated">Go网络服务器</h2><p id="2dae" class="pw-post-body-paragraph jn jo iq jp b jq lx js jt ju ly jw jx jy mu ka kb kc mv ke kf kg mw ki kj kk ij bi translated">使用我对flask服务器的相同想法，我的计划是做完全相同的事情，但是在Go中。这也可以让我去掉设计中很多丑陋的部分；一个很大的问题是那个讨厌的<code class="fe mh mi mj mk b">TEST</code>文件，并且依赖于对它的读写。Go中的一切将允许我们把一切都整齐地限制在文件系统内部的机制中。</p><p id="356f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">所以现在，<code class="fe mh mi mj mk b">open</code>将触发web服务器的启动，一旦我们首先确认我们想要编辑的文件存在。</p><pre class="km kn ko kp gt np mk nq nr aw ns bi"><span id="d844" class="nd ky iq mk b gy nt nu l nv nw">func (fs  * fileSystem) open(filename string) error {<br/> if _, exists := fs.files[filename]; exists {<br/>  editingFile = fs.files[filename]<br/>  editor()<br/> } else {<br/>  fmt.Println(filename, ": file doesn't exist.")<br/> }<br/> return nil<br/>}</span></pre><p id="231c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在上面的代码中，我们首先确定我们想要编辑的文件是否存在，如果存在，将它作为我们将要处理的文件赋给全局变量<code class="fe mh mi mj mk b">editingFile</code>，然后最后调用恰当命名的<code class="fe mh mi mj mk b">editor()</code>函数来完成剩下的工作。</p><h2 id="6850" class="nd ky iq bd kz ne nf dn ld ng nh dp lh jy ni nj ll kc nk nl lp kg nm nn lt no bi translated">文本编辑器服务器</h2><p id="b799" class="pw-post-body-paragraph jn jo iq jp b jq lx js jt ju ly jw jx jy mu ka kb kc mv ke kf kg mw ki kj kk ij bi translated">我们的文本编辑器运行一个小型web服务器，它在端口127.0.0.1:5000打开，以文本编辑器的形式显示我们正在处理的当前文件的内容。</p><p id="aae1" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">该功能由两个重要部分组成。第一个确保Ctrl+C在您的终端中被禁用。我发现这是一个有趣的用户体验问题，因为我测试它的朋友坚持在终端中使用Ctrl+C杀死文本编辑器。这当然只是退出了整个文件系统，所以我不得不用一个有用的终端消息完全禁止这种用法，如果你尝试…</p><pre class="km kn ko kp gt np mk nq nr aw ns bi"><span id="708b" class="nd ky iq mk b gy nt nu l nv nw">Interrupt cancelled. Close text editor tab at :127.0.0.1:5000</span></pre><p id="a92c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">编辑器的完整源代码如下。</p><pre class="km kn ko kp gt np mk nq nr aw ns bi"><span id="7b30" class="nd ky iq mk b gy nt nu l nv nw">func editor() {<br/> mux := http.NewServeMux()<br/> c := make(chan os.Signal, 1)<br/> signal.Notify(c, os.Interrupt)<br/> go func() {<br/>  for sig := range c {<br/>   fmt.Println("Interrupt cancelled. Close text editor tab at :127.0.0.1:5000;", sig)<br/>  }<br/> }()</span><span id="133c" class="nd ky iq mk b gy nx nu l nv nw">openbrowser("<a class="ae mg" href="http://127.0.0.1:5000" rel="noopener ugc nofollow" target="_blank">http://127.0.0.1:5000</a>")<br/> server := http.Server{Addr: ":5000", Handler: mux}<br/> mux.HandleFunc("/", indexHandler)<br/> mux.HandleFunc("/save", saveHandler)<br/> mux.HandleFunc("/shutdown", shutDown)<br/> server.ListenAndServe()<br/>}</span></pre><p id="88a0" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">浏览器的第一部分就是这样做的；它接受SIGINT(信号中断)的值，即Ctrl+C，并删除其功能。所以每次按Ctrl+C时，代码</p><pre class="km kn ko kp gt np mk nq nr aw ns bi"><span id="a4e3" class="nd ky iq mk b gy nt nu l nv nw">fmt.Println("Interrupt cancelled. Close text editor tab at :127.0.0.1:5000;", sig)</span></pre><p id="01a9" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">改为运行。</p><p id="fd6a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">下一个函数<code class="fe mh mi mj mk b">openbrowser</code>负责在终端中输入<code class="fe mh mi mj mk b">open filename</code>后立即在浏览器中打开编辑器。这是我发现的最自然的方法，我可以立即模拟打开一个文本编辑器。输入打开后导航只是觉得很傻，所以我把这个扔在那里。</p><p id="d3a1" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">最后几个组件是<code class="fe mh mi mj mk b">handleFunc</code>方法。这些基本上将函数与它们各自的端点联系起来，因此任何时候这些URL被访问或以某种方式被请求，这些动作将触发这些提到的函数处理程序中的代码；<code class="fe mh mi mj mk b">indexHandler</code>处理主文本编辑器，<code class="fe mh mi mj mk b">saveHandler</code>处理文件的保存，<code class="fe mh mi mj mk b">shutDown</code>处理关闭我们的编辑器并继续前进的时候关闭服务器。</p><p id="b9ec" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">为了避免这篇文章太长，成为另一个基本的web dev Go教程，我将在这里结束对一般服务器内容的描述，转到编辑器细节。如果你想了解更多关于Go的网页开发，我强烈推荐你在这里找到的新生科技的教程；<a class="ae mg" href="https://freshman.tech/web-development-with-go/" rel="noopener ugc nofollow" target="_blank">https://freshman.tech/web-development-with-go/</a>。我为这篇文章做了这篇文章，我可以说这是我做过的最好的文章之一。</p><p id="8357" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">好了，接下来讲一点JavaScript。</p><h2 id="8ca2" class="nd ky iq bd kz ne nf dn ld ng nh dp lh jy ni nj ll kc nk nl lp kg nm nn lt no bi translated">让我们做一点网络开发</h2><p id="4307" class="pw-post-body-paragraph jn jo iq jp b jq lx js jt ju ly jw jx jy mu ka kb kc mv ke kf kg mw ki kj kk ij bi translated">我认为有必要回顾一下我发现颇具挑战性的一些网络内容；同样部分是因为我缺乏浏览器方面的技能，也因为ace编辑器的JS库是一个美丽的、隐藏的、基本上没有文档记录的宝石，我希望给它一点曝光。</p><p id="828b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我不是在开玩笑，伙计们，我绝对喜欢这个图书馆。</p><p id="4c7c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">因此，让我们稍微检查一下<code class="fe mh mi mj mk b">ace</code>编辑器代码。</p><h2 id="ad37" class="nd ky iq bd kz ne nf dn ld ng nh dp lh jy ni nj ll kc nk nl lp kg nm nn lt no bi translated">所有东西都是王牌</h2><p id="4f98" class="pw-post-body-paragraph jn jo iq jp b jq lx js jt ju ly jw jx jy mu ka kb kc mv ke kf kg mw ki kj kk ij bi translated">Ace JS库允许你直接在你的网站上构建一个文本编辑器UI，看起来和Sublime Text Editor的设计很相似。可以在这里找到:<a class="ae mg" href="https://ace.c9.io/" rel="noopener ugc nofollow" target="_blank">https://ace.c9.io/</a>。</p><p id="c2c1" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">ace编辑器代码示例:</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi ny"><img src="../Images/84d91b73cf87e12a4c7eed2b08b21197.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*EA30sYCZcTPvhocNscU2Iw.png"/></div></div><figcaption class="my mz gj gh gi na nb bd b be z dk translated">源代码</figcaption></figure><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi nz"><img src="../Images/f0d559b269a7bc951bd68432d6f2b577.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*zgiX9iLsWGyK0n4Y4LttKQ.png"/></div></div><figcaption class="my mz gj gh gi na nb bd b be z dk translated">输出</figcaption></figure><p id="39ef" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">当试图制作一个浏览器编辑器时，要记住的主要事情是首先能够模板化“源代码”部分，这样你的代码可以保持动态。想想在Go中使用类似于<code class="fe mh mi mj mk b">jinja</code>的Flask或<code class="fe mh mi mj mk b">template</code>包。您可以将上面HTML中第17到20行的代码替换为如下代码:</p><pre class="km kn ko kp gt np mk nq nr aw ns bi"><span id="4d0c" class="nd ky iq mk b gy nt nu l nv nw">&lt;div id="editor"&gt;{{ source_code }}&lt;/div&gt;</span></pre><p id="1bec" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">附带的后端代码如下所示。</p><pre class="km kn ko kp gt np mk nq nr aw ns bi"><span id="2b3e" class="nd ky iq mk b gy nt nu l nv nw">var source_code = open("source_file.go")<br/>return Render("editor.html", source_code=source_code)</span></pre><p id="64a3" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">上面是写得很差的伪代码，只是为了让大家了解这是如何工作的，以及我是如何做到的。如果你以前从未使用过Go的模板系统，你需要做更多的工作，它看起来有点不同，但想法非常相似。</p><p id="4a48" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">要说本文使用的具体代码，这个可以在<code class="fe mh mi mj mk b">indexHandler</code>函数中找到；</p><pre class="km kn ko kp gt np mk nq nr aw ns bi"><span id="9448" class="nd ky iq mk b gy nt nu l nv nw">func indexHandler(w http.ResponseWriter, r *http.Request) {<br/> buf := &amp;bytes.Buffer{}<br/> <br/> source := &amp;sourceCode{<br/>  Code: string(editingFile.content),<br/>  Ext: "golang",<br/> }<br/> err := tpl.Execute(buf, source)<br/> if err != nil {<br/>  fmt.Println("Error")<br/>  http.Error(w, err.Error(), http.StatusInternalServerError)<br/>  return<br/> }<br/> buf.WriteTo(w)<br/>}</span></pre><p id="628d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">重要的细节是<code class="fe mh mi mj mk b">souceCode</code>结构初始化器和<code class="fe mh mi mj mk b">tpl.Execute</code>行。简而言之；<code class="fe mh mi mj mk b">sourceCode</code>对象将被传入HTML，其值<code class="fe mh mi mj mk b">Code</code>和<code class="fe mh mi mj mk b">Ext</code>将是文本编辑器中的动态元素，负责显示打开文件的源代码，而<code class="fe mh mi mj mk b">Ext</code>将负责根据您使用的语言分配正确的编辑器颜色和高亮显示。这里它被硬编码为<code class="fe mh mi mj mk b">golang</code> …只是因为…</p><p id="8e13" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在HTML中；您可以分别在第17行和第25行找到它们(希望我没有在代码中的任何地方意外添加ENTER)。</p><pre class="km kn ko kp gt np mk nq nr aw ns bi"><span id="b22d" class="nd ky iq mk b gy nt nu l nv nw">&lt;div id="editor"&gt;{{ .Code }}&lt;/div&gt;<br/>...</span><span id="386d" class="nd ky iq mk b gy nx nu l nv nw">editor.session.setMode("ace/mode/{{ .Ext }}");</span></pre><p id="f49d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我添加的编辑器的另一个部分是重新映射Ctrl+S快捷键，当在浏览器中使用时，它会给你提供保存当前网页的选项。</p><p id="43d1" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这还不够，所以我把这个也改了。</p><h2 id="fdf7" class="nd ky iq bd kz ne nf dn ld ng nh dp lh jy ni nj ll kc nk nl lp kg nm nn lt no bi translated">快速储蓄</h2><p id="6468" class="pw-post-body-paragraph jn jo iq jp b jq lx js jt ju ly jw jx jy mu ka kb kc mv ke kf kg mw ki kj kk ij bi translated">我既惊讶又不惊讶地发现，你可以覆盖像Ctrl+S这样永恒的东西，让它为你服务。它只需要一个Ctrl+S的映射，通过AJAX调用将编辑器div ( <code class="fe mh mi mj mk b">&lt;div id="editro"&gt;</code>)的内容发送到一个端点(我想你是这么说的)。</p><p id="62f5" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">事情是这样的</p><pre class="km kn ko kp gt np mk nq nr aw ns bi"><span id="caa1" class="nd ky iq mk b gy nt nu l nv nw">if ((window.navigator.platform.match("Mac") ? e.metaKey : e.ctrlKey)  &amp;&amp; e.keyCode == 83) {<br/>        e.preventDefault();<br/>        console.log(editor.getValue())<br/>        $.ajax({<br/>            type: 'POST',<br/>            url: '/save',<br/>            contentType: 'application/json;charset=UTF-8',<br/>            data: JSON.stringify({'data': editor.getValue()}),<br/>            success: function() {<br/>                console.log("success")<br/>            }<br/>        });<br/>...</span></pre><p id="b77c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">上面的代码首先检查是否同时按下了正确的键(确保ctrl被替换为cmd，这取决于您是否在Macbook上工作)。</p><p id="c0ec" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在那之后，保存在<code class="fe mh mi mj mk b">editor.getValue()</code>中的编辑器的当前内容被传递到AJAX post请求中，并被发送到负责我们后端的<code class="fe mh mi mj mk b">/save</code>端点的URL。</p><p id="e97a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们的<code class="fe mh mi mj mk b">/save</code>值的<code class="fe mh mi mj mk b">saveHandler</code>功能在我们的Go后端看起来是这样的。</p><pre class="km kn ko kp gt np mk nq nr aw ns bi"><span id="19fe" class="nd ky iq mk b gy nt nu l nv nw">func saveHandler(w http.ResponseWriter, r *http.Request) {<br/>        if r.Method == "POST" {<br/>                var data map[string]string<br/>                json.NewDecoder(r.Body).Decode(&amp;data)<br/>                editingFile.content = []byte(data["data"])<br/>        }<br/>}</span></pre><p id="7455" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这个函数在导航到<code class="fe mh mi mj mk b">/save</code>端点或向其发出请求时运行。</p><p id="abea" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在上面的例子中，我们检查了POST请求是否已经从前端发出(只有当我们按Ctrl+S时才会发生)。我们检查请求体的内容，其中有我们编辑过的源代码。然后，这段代码会覆盖它自己的先前版本，在上面的代码中，它存储在<code class="fe mh mi mj mk b">editingFile.content</code>值中。</p><p id="9dce" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">因此，我们的文件被保存，我们可以…</p><h2 id="09ef" class="nd ky iq bd kz ne nf dn ld ng nh dp lh jy ni nj ll kc nk nl lp kg nm nn lt no bi translated">退出(及其工作方式)</h2><p id="0040" class="pw-post-body-paragraph jn jo iq jp b jq lx js jt ju ly jw jx jy mu ka kb kc mv ke kf kg mw ki kj kk ij bi translated">另一件我不知道JavaScript能让你做的新事情。您可以在浏览器关闭时确定一个函数触发器。我真的只是需要close函数来恢复shell的功能(只要显示127.0.0.1:5000的选项卡没有正确关闭，shell就会被阻止，不能退出——所以不能重定向，必须按“x”)。</p><p id="4569" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这需要更多的JQuery技巧。</p><p id="a9c6" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">代码如下:</p><pre class="km kn ko kp gt np mk nq nr aw ns bi"><span id="b8f6" class="nd ky iq mk b gy nt nu l nv nw">$(window).on("beforeunload", function() { <br/>        $.ajax({<br/>                type: 'POST',<br/>                url: '/shutdown',<br/>                contentType: 'application/json;charset=UTF-8',<br/>                data: JSON.stringify({'data':'exiting'})</span><span id="fc0e" class="nd ky iq mk b gy nx nu l nv nw">})    <br/>    })</span></pre><p id="e44f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这里，我们将功能绑定到当前浏览器窗口的卸载行为；所以基本上当我们关上它的时候。我们还有另一个AJAX调用，这次是对<code class="fe mh mi mj mk b">/shutdown</code>端点的调用。它只是关闭了保持编辑器运行的后端web服务器，并解除了shell的阻塞。</p><pre class="km kn ko kp gt np mk nq nr aw ns bi"><span id="1eb8" class="nd ky iq mk b gy nt nu l nv nw">func shutDown(w http.ResponseWriter, r *http.Request) {<br/>     if r.Method == "POST" {<br/>        server.Shutdown(context.Background())<br/>     }<br/> }</span></pre><p id="fdec" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">和以前一样的交易；当我们收到来自<code class="fe mh mi mj mk b">/shutdown</code>端点的post请求时，我们触发服务器关闭，并将功能返回给shell。</p><p id="1859" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这就是我们文本编辑器的总体控制流程。</p><p id="8ec0" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在最新版本的文件系统中尝试一下(在Github repo的<code class="fe mh mi mj mk b">src/05</code>中)。运行文件系统，设置一个名称，并以任何文件名作为参数运行<code class="fe mh mi mj mk b">open</code>。</p><p id="f534" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们的文本编辑器完成了。就这样，我们添加了最后一个函数来完善文件系统的版本1。</p></div><div class="ab cl oa ob hu oc" role="separator"><span class="od bw bk oe of og"/><span class="od bw bk oe of og"/><span class="od bw bk oe of"/></div><div class="ij ik il im in"><h1 id="8650" class="kx ky iq bd kz la oh lc ld le oi lg lh li oj lk ll lm ok lo lp lq ol ls lt lu bi translated">最后冲刺</h1><p id="6135" class="pw-post-body-paragraph jn jo iq jp b jq lx js jt ju ly jw jx jy mu ka kb kc mv ke kf kg mw ki kj kk ij bi translated">这有很多要经历，但在我决定是扩大还是停止这个项目之前，我们终于完成了最后一个功能。</p><p id="6568" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">到目前为止，我们的文件系统非常非常简单。我们一次只能有一个用户，我们只能读取文件和编辑现有的文件，没有任何安全性。</p><p id="b472" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们需要实现的最后一件事是可怕的文件系统映像保存，我想应该清理一下代码。在这里删除一个函数，在那里抽象一个方法…</p><p id="7615" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">总的来说，这个项目很有趣，但与我想象的最终结果相比，它也更基础。用一种全新的语言来写这本书很有趣，我也因为这一点对Go感到很舒服，并且很有效率。</p><p id="17e7" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">那么，读者，在我们结束的时候，请继续读一会儿。</p><p id="abf6" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">直到下周。</p><p id="4193" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">本文的链接一如既往:</p><p id="5e15" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">迄今为止的进展；<a class="ae mg" href="https://github.com/AlysonBee/GoVirtualFilesystem/tree/master/src/05" rel="noopener ugc nofollow" target="_blank">https://github . com/alyson bee/govirtualfile system/tree/master/src/05</a></p><p id="42ec" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">Ace文本编辑器JS库/框架；【https://ace.c9.io/ T2】号</p><p id="7450" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">新生科技——如何用Go构建你的第一个Web应用:【https://freshman.tech/web-development-with-go/ T4】</p></div></div>    
</body>
</html>