<html>
<head>
<title>Java Service Provider Interface (SPI)— understanding it via code</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Java服务提供者接口(SPI)—通过代码理解它</h1>
<blockquote>原文：<a href="https://itnext.io/java-service-provider-interface-understanding-it-via-code-30e1dd45a091?source=collection_archive---------2-----------------------#2018-05-15">https://itnext.io/java-service-provider-interface-understanding-it-via-code-30e1dd45a091?source=collection_archive---------2-----------------------#2018-05-15</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/ffd12f5976e5821d2d2e551c94c039a2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*qmFmqMilMXB-a4fJpwxSpA.jpeg"/></div></div></figure><p id="6990" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">想过JPA实现(EclipseLink或Hibernate)是如何被Java持久性API获取的吗？或者java.sql.DriverManager如何加载java.sql.Driver的可用实现，或者消息传递框架如何获取JMS实现。</p><p id="03f5" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">它们都遵循JAVA SPI(服务提供者接口)机制。</p><p id="fb92" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">根据<em class="kw">有效Java，第二版</em>:</p><p id="2fce" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">服务提供者框架是一个系统，在这个系统中，多个服务提供者实现一个服务，系统使实现对其客户端可用，将它们与实现解耦。</p><p id="70d8" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">服务提供商框架有3个基本组成部分:</p><ol class=""><li id="1180" class="kx ky iq ka b kb kc kf kg kj kz kn la kr lb kv lc ld le lf bi translated">服务接口，由提供者实现。</li><li id="c527" class="kx ky iq ka b kb lg kf lh kj li kn lj kr lk kv lc ld le lf bi translated">一个提供者注册API，系统用它来注册实现，让客户可以访问它们。</li><li id="fe19" class="kx ky iq ka b kb lg kf lh kj li kn lj kr lk kv lc ld le lf bi translated">和服务访问API，客户端选择该API来获得服务的实例。</li></ol><p id="3756" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在本文中，我们将浏览一个示例代码，通过它我们将尝试理解Java服务提供者框架。</p><blockquote class="ll lm ln"><p id="b0e8" class="jy jz kw ka b kb kc kd ke kf kg kh ki lo kk kl km lp ko kp kq lq ks kt ku kv ij bi translated">设置:</p></blockquote><p id="36d7" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">所有的代码都可以在@【https://github.com/niteshagrawalgmail/basic.git】的spi文件夹中找到。</p><p id="3a77" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">【https://github.com/niteshagrawalgmail/basic/tree/master/spi T4】</p><figure class="lt lu lv lw gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi ls"><img src="../Images/cbf54bcfbe8e77979b36da64de100026.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*_5QCMBewtiiBpZmbTjMVpA.png"/></div></div></figure><ol class=""><li id="e3b1" class="kx ky iq ka b kb kc kf kg kj kz kn la kr lb kv lc ld le lf bi translated">一个maven web项目[ <em class="kw"> basicapp </em> ]，它将作为服务接口的消费者/客户端。该项目将依赖于服务接口及其实现，并将被组装成一个. war，部署在Tomcat服务器上。</li><li id="16ad" class="kx ky iq ka b kb lg kf lh kj li kn lj kr lk kv lc ld le lf bi translated">一个有服务接口的maven项目。[com.niaa.service.api]</li><li id="66bc" class="kx ky iq ka b kb lg kf lh kj li kn lj kr lk kv lc ld le lf bi translated">两个maven项目代表服务接口的两个提供者实现。[com.niaa.service.impl1]和[com.niaa.service.impl2]</li></ol></div><div class="ab cl lx ly hu lz" role="separator"><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc"/></div><div class="ij ik il im in"><h2 id="082c" class="me mf iq bd mg mh mi dn mj mk ml dp mm kj mn mo mp kn mq mr ms kr mt mu mv mw bi translated">服务接口</h2><p id="97ab" class="pw-post-body-paragraph jy jz iq ka b kb mx kd ke kf my kh ki kj mz kl km kn na kp kq kr nb kt ku kv ij bi translated">项目<em class="kw"> com.niaa.service.api </em>包含一个接口IAccount。</p><pre class="lt lu lv lw gt nc nd ne nf aw ng bi"><span id="1956" class="me mf iq nd b gy nh ni l nj nk">package com.niaa.service.api.accoumt;</span><span id="7e3c" class="me mf iq nd b gy nl ni l nj nk">public interface IAccount {</span><span id="4431" class="me mf iq nd b gy nl ni l nj nk">  public String getAccountType();</span><span id="9cd7" class="me mf iq nd b gy nl ni l nj nk">  public String getAccountId();</span><span id="6070" class="me mf iq nd b gy nl ni l nj nk">}</span></pre><h2 id="946f" class="me mf iq bd mg mh mi dn mj mk ml dp mm kj mn mo mp kn mq mr ms kr mt mu mv mw bi translated">服务提供商实施</h2><p id="2349" class="pw-post-body-paragraph jy jz iq ka b kb mx kd ke kf my kh ki kj mz kl km kn na kp kq kr nb kt ku kv ij bi translated">项目<em class="kw"> com.niaa.service.impl1 </em>包含IAccount的实现。</p><pre class="lt lu lv lw gt nc nd ne nf aw ng bi"><span id="3b1d" class="me mf iq nd b gy nh ni l nj nk">package com.niaa.service.impl.savings.account;</span><span id="69ed" class="me mf iq nd b gy nl ni l nj nk">import com.niaa.service.api.accoumt.IAccount;</span><span id="20de" class="me mf iq nd b gy nl ni l nj nk">public class SavingsAccount implements IAccount {</span><span id="b77f" class="me mf iq nd b gy nl ni l nj nk">public String getAccountType() {</span><span id="7b80" class="me mf iq nd b gy nl ni l nj nk">  return "SavingsAccount";</span><span id="9bf8" class="me mf iq nd b gy nl ni l nj nk">}</span><span id="df62" class="me mf iq nd b gy nl ni l nj nk">public String getAccountId() {</span><span id="f26d" class="me mf iq nd b gy nl ni l nj nk">  return "1";</span><span id="71c8" class="me mf iq nd b gy nl ni l nj nk">}</span><span id="4551" class="me mf iq nd b gy nl ni l nj nk">}</span></pre><p id="980e" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">SavingsAccount类实现IAccount并返回“SavingsAccount”作为帐户类型。</p><blockquote class="ll lm ln"><p id="bf66" class="jy jz kw ka b kb kc kd ke kf kg kh ki lo kk kl km lp ko kp kq lq ks kt ku kv ij bi translated">为了连接到服务提供者框架，我们需要在META-INF/services/文件夹中创建一个名为:<strong class="ka ir">com . niaa . Service . API . account . iaccount</strong>的<strong class="ka ir">文件</strong></p><p id="5186" class="jy jz kw ka b kb kc kd ke kf kg kh ki lo kk kl km lp ko kp kq lq ks kt ku kv ij bi translated">在文件(文件的内容)中，我们需要提供提供者实现的完全限定名。</p></blockquote><pre class="lt lu lv lw gt nc nd ne nf aw ng bi"><span id="ca5d" class="me mf iq nd b gy nh ni l nj nk">com.niaa.service.impl.savings.account.SavingsAccount</span></pre><figure class="lt lu lv lw gt jr gh gi paragraph-image"><div class="gh gi nm"><img src="../Images/cf447b79795c5e5bb665ce28f3aa4fb6.png" data-original-src="https://miro.medium.com/v2/resize:fit:782/format:webp/1*ZiWQ2FsmZ1IVZBhZLoqigA.png"/></div><figcaption class="nn no gj gh gi np nq bd b be z dk translated">提供商实施项目的文件夹结构</figcaption></figure><p id="6020" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">类似地，项目<em class="kw"> com.niaa.service.impl2 </em>包含IAccount的另一个实现。</p><pre class="lt lu lv lw gt nc nd ne nf aw ng bi"><span id="1baa" class="me mf iq nd b gy nh ni l nj nk">package com.niaa.service.impl.current.account;</span><span id="44bc" class="me mf iq nd b gy nl ni l nj nk">import com.niaa.service.api.accoumt.IAccount;</span><span id="59af" class="me mf iq nd b gy nl ni l nj nk">public class CurrentAccount implements IAccount {</span><span id="fef1" class="me mf iq nd b gy nl ni l nj nk">public String getAccountType() {</span><span id="238f" class="me mf iq nd b gy nl ni l nj nk">  return "CurrentAccount";</span><span id="83a5" class="me mf iq nd b gy nl ni l nj nk">}</span><span id="4612" class="me mf iq nd b gy nl ni l nj nk">public String getAccountId() {</span><span id="bfe9" class="me mf iq nd b gy nl ni l nj nk">  return "2";</span><span id="0b6b" class="me mf iq nd b gy nl ni l nj nk">}</span><span id="2566" class="me mf iq nd b gy nl ni l nj nk">}</span></pre><p id="8ba5" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">CurrentAccount类实现IAccount并返回“CurrentAccount”作为帐户类型。</p><blockquote class="ll lm ln"><p id="7100" class="jy jz kw ka b kb kc kd ke kf kg kh ki lo kk kl km lp ko kp kq lq ks kt ku kv ij bi translated">为了连接到服务提供者框架，我们需要在META-INF/services/文件夹中创建一个名为:<strong class="ka ir">com . niaa . Service . API . accoumt . iaccount</strong>的<strong class="ka ir">文件</strong></p><p id="eaa0" class="jy jz kw ka b kb kc kd ke kf kg kh ki lo kk kl km lp ko kp kq lq ks kt ku kv ij bi translated">在文件(文件的内容)中，我们需要提供提供者实现的完全限定名。</p></blockquote><pre class="lt lu lv lw gt nc nd ne nf aw ng bi"><span id="61b8" class="me mf iq nd b gy nh ni l nj nk">com.niaa.service.impl.current.account.CurrentAccount</span></pre><figure class="lt lu lv lw gt jr gh gi paragraph-image"><div class="gh gi nr"><img src="../Images/1d130a29bd1dd531d213899bfe7741ce.png" data-original-src="https://miro.medium.com/v2/resize:fit:748/format:webp/1*GFCJo-M_BaSZx2XtZ41JAw.png"/></div><figcaption class="nn no gj gh gi np nq bd b be z dk translated">第二个提供商实施项目的文件夹结构</figcaption></figure><p id="51d7" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">现在我们有了IAccount的两个实现，SavingsAccount和CurrentAccount。两者都提供所需的配置文件<strong class="ka ir">com . niaa . service . API . acco UMT . iaccount</strong>，并在各自的文件中包含所需的提供者实现类名。</p><p id="e81f" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">接下来，我们将看到服务访问API如何加载这些实现实例。</p></div><div class="ab cl lx ly hu lz" role="separator"><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc"/></div><div class="ij ik il im in"><p id="f760" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">现在，在我们的消费者项目[basicapp]中，我们有一个名为E2eServlet的HttpServlet。这个项目集合了所有其他项目——服务接口+它的提供者实现。</p><p id="8e9f" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">basicapp的pom.xml:</p><figure class="lt lu lv lw gt jr"><div class="bz fp l di"><div class="ns nt l"/></div><figcaption class="nn no gj gh gi np nq bd b be z dk translated">basicapp的pom.xml</figcaption></figure><p id="4ca7" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">E2eServlet的doGet(HttpServletRequest请求，HttpServletResponse响应)方法:</p><figure class="lt lu lv lw gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nu"><img src="../Images/7a46b3a917a42596a33e635f98df95dc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*zEUL7swnlCVlx75IXboPdQ.png"/></div></div></figure><p id="7245" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">这里我们使用的是服务提供者框架的java.util.ServiceLoader API。</p><p id="a7db" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我们已经创建了名为AccountTO的传输对象，用于将聚合的帐户序列化为JSON to response。</p><p id="ee35" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">当我们启动API时:</p><p id="3f69" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><a class="ae lr" href="http://localhost:8081/basicapp/api" rel="noopener ugc nofollow" target="_blank">http://localhost:8081/basic app/API</a></p><pre class="lt lu lv lw gt nc nd ne nf aw ng bi"><span id="1d8a" class="me mf iq nd b gy nh ni l nj nk">[<br/> {"accountId":"1",<br/>  "accountType":"SavingsAccount"<br/> },<br/> {"accountId":"2",<br/>  "accountType":"CurrentAccount"<br/> }<br/>]</span></pre></div><div class="ab cl lx ly hu lz" role="separator"><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc"/></div><div class="ij ik il im in"><h2 id="b313" class="me mf iq bd mg mh mi dn mj mk ml dp mm kj mn mo mp kn mq mr ms kr mt mu mv mw bi translated">总结:</h2><p id="894b" class="pw-post-body-paragraph jy jz iq ka b kb mx kd ke kf my kh ki kj mz kl km kn na kp kq kr nb kt ku kv ij bi translated">服务提供者框架提供了一种简单的方法来分离和加载服务接口的多个实现。</p><p id="5aff" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">唯一重要的事情是确保必要的配置文件在文件夹[META-INF/services]中是可用的，正如框架所期望的。</p><p id="2b92" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><strong class="ka ir"> A </strong>还要注意配置文件的命名惯例。</p></div><div class="ab cl lx ly hu lz" role="separator"><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc"/></div><div class="ij ik il im in"><blockquote class="ll lm ln"><p id="e98e" class="jy jz kw ka b kb kc kd ke kf kg kh ki lo kk kl km lp ko kp kq lq ks kt ku kv ij bi translated">感谢阅读:)</p></blockquote></div></div>    
</body>
</html>