<html>
<head>
<title>Using Google Firestore for a Golang backend application</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">为Golang后端应用程序使用Google Firestore</h1>
<blockquote>原文：<a href="https://itnext.io/using-google-firestore-for-a-golang-backend-application-3d869edf8c47?source=collection_archive---------1-----------------------#2019-08-29">https://itnext.io/using-google-firestore-for-a-golang-backend-application-3d869edf8c47?source=collection_archive---------1-----------------------#2019-08-29</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><figure class="gl gn jr js jt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi jq"><img src="../Images/4e8ec168ba16badcbd88f6582ec8c676.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*k9VBLrDIC5Nlyt5u.png"/></div></div></figure><p id="261a" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">通常，当我需要一个数据库时，我只选择<a class="ae kz" href="https://www.postgresql.org/" rel="noopener ugc nofollow" target="_blank"> Postgres </a>或嵌入式键值存储，比如优秀的<a class="ae kz" href="https://github.com/etcd-io/bbolt" rel="noopener ugc nofollow" target="_blank"> boltdb </a>、来自dgraph 的<a class="ae kz" href="https://github.com/dgraph-io/badger" rel="noopener ugc nofollow" target="_blank"> badger或</a><a class="ae kz" href="https://redis.io/" rel="noopener ugc nofollow" target="_blank"> Redis </a>(如果我需要一个KV存储，但在几个节点之间共享)。灵活性带来了维护负担，有时还会带来额外的成本。在本文中，我们将探索一个简单的Golang后端服务，它将使用Google Firestore作为存储。</p><p id="f602" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">当我开始着手一个名为<a class="ae kz" href="https://bin.webhookrelay.com/" rel="noopener ugc nofollow" target="_blank">bin.webhookrelay.com</a>的简单项目时，我选择Badger作为键值存储，将一个持久磁盘连接到一个Kubernetes pod并启动它。</p><blockquote class="la lb lc"><p id="96a0" class="kb kc ld kd b ke kf kg kh ki kj kk kl le kn ko kp lf kr ks kt lg kv kw kx ky im bi translated"><a class="ae kz" href="https://bin.webhookrelay.com" rel="noopener ugc nofollow" target="_blank"><em class="it">bin.webhookrelay.com</em></a><em class="it">是一项免费服务，允许你捕获webhook或API请求用于测试目的。它还允许您指定要返回的响应正文和状态代码，并设置可选的响应延迟。</em></p></blockquote><p id="256b" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">数据模型过去(现在仍然)很简单:</p><ul class=""><li id="2765" class="lh li it kd b ke kf ki kj km lj kq lk ku ll ky lm ln lo lp bi translated"><strong class="kd iu"> Bin </strong>具有某种配置，比如返回什么状态码、响应主体、内容类型头和响应延迟。</li><li id="40bb" class="lh li it kd b ke lq ki lr km ls kq lt ku lu ky lm ln lo lp bi translated"><strong class="kd iu">请求</strong>实际上是捕获带有bin ID、请求体、头和查询的webhook请求。</li></ul><p id="b18f" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">大多数时候，boltdb或badger等KV商店非常适合这类用例。当您想要水平伸缩或使用滚动更新策略时，问题就出现了，这意味着应用程序的许多实例在更新期间必须激增。虽然Kubernetes非常适合运行几乎任何工作负载，但如果进行更新，需要分离一个持久磁盘并将其重新连接到一个新的pod，这可能会导致停机，并且通常会减慢更新速度。我总是试图避免这种情况，然而，webhook bin服务却深受其害。</p><p id="1452" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">这一次，我决定尝试一下<a class="ae kz" href="https://firebase.google.com/docs/firestore/" rel="noopener ugc nofollow" target="_blank">云火店</a>。您可能已经听说过Firestore(以前称为Firebase ),它在需要为其Android和iOS应用程序提供数据库的移动应用程序开发人员中非常受欢迎。显然，它还可以为后端应用程序提供一个非常好的开发人员UX！:)</p><h1 id="ec57" class="lv lw it bd lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp mq mr ms bi translated">设置它</h1><p id="6bd7" class="pw-post-body-paragraph kb kc it kd b ke mt kg kh ki mu kk kl km mv ko kp kq mw ks kt ku mx kw kx ky im bi translated">对于身份验证，Golang Firestore客户端使用依赖于服务帐户的标准机制。基本上，你需要去:</p><ol class=""><li id="5259" class="lh li it kd b ke kf ki kj km lj kq lk ku ll ky my ln lo lp bi translated"><a class="ae kz" href="https://console.cloud.google.com" rel="noopener ugc nofollow" target="_blank"> GCP控制台</a></li><li id="e1b6" class="lh li it kd b ke lq ki lr km ls kq lt ku lu ky my ln lo lp bi translated">点击IAM &amp; admin</li><li id="ae69" class="lh li it kd b ke lq ki lr km ls kq lt ku lu ky my ln lo lp bi translated">转到服务帐户(在左侧导航栏上)</li><li id="1284" class="lh li it kd b ke lq ki lr km ls kq lt ku lu ky my ln lo lp bi translated">创建一个具有Firestore权限的新服务帐户</li><li id="95ff" class="lh li it kd b ke lq ki lr km ls kq lt ku lu ky my ln lo lp bi translated">下载该文件，您现在可以使用它进行身份验证</li></ol><blockquote class="la lb lc"><p id="5d53" class="kb kc ld kd b ke kf kg kh ki kj kk kl le kn ko kp lf kr ks kt lg kv kw kx ky im bi translated"><em class="it">文档可以在Google云认证部分</em>  <em class="it">找到</em> <a class="ae kz" href="https://cloud.google.com/docs/authentication/getting-started" rel="noopener ugc nofollow" target="_blank"> <em class="it">。</em></a></p></blockquote><p id="70f9" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">应用程序代码出奇的简单。您使用Google应用程序凭据、项目ID获得客户端，就这样:</p><figure class="mz na nb nc gt ju"><div class="bz fp l di"><div class="nd ne l"/></div></figure><h1 id="6a2b" class="lv lw it bd lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp mq mr ms bi translated">添加和更新箱子</h1><p id="d741" class="pw-post-body-paragraph kb kc it kd b ke mt kg kh ki mu kk kl km mv ko kp kq mw ks kt ku mx kw kx ky im bi translated">创建文档时，可以指定文档ID，只需传入整个golang结构，而无需先将它封送到JSON:</p><figure class="mz na nb nc gt ju"><div class="bz fp l di"><div class="nd ne l"/></div><figcaption class="nf ng gj gh gi nh ni bd b be z dk translated">创建bin文档</figcaption></figure><p id="2d7e" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">注意，我们提供了集合名称:<code class="fe nj nk nl nm b">Collection(m.binsCollection)</code>，ID: <code class="fe nj nk nl nm b">Doc(b.GetId())</code>，并设置了结构字段<code class="fe nj nk nl nm b">Set(ctx, b)</code>。</p><p id="4de4" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">这样真的很节省时间！KV商店的另一种选择是:</p><figure class="mz na nb nc gt ju"><div class="bz fp l di"><div class="nd ne l"/></div></figure><h1 id="0c87" class="lv lw it bd lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp mq mr ms bi translated">删除</h1><figure class="mz na nb nc gt ju"><div class="bz fp l di"><div class="nd ne l"/></div></figure><p id="7836" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">虽然存储、检索和修改文档非常容易，但有些人会错过SQL类型的查询，这些查询可以在数据库中聚合、计算记录和执行其他有用的操作。例如，为了跟踪文档数量，您必须实现一个类似于这里描述的解决方案的解决方案<a class="ae kz" href="https://cloud.google.com/firestore/docs/solutions/counters" rel="noopener ugc nofollow" target="_blank">。我的建议是，在开始这个旅程之前，花更多的时间规划数据结构，以及您计划使用哪种操作:)</a></p><h1 id="7470" class="lv lw it bd lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp mq mr ms bi translated">结论</h1><p id="4ea6" class="pw-post-body-paragraph kb kc it kd b ke mt kg kh ki mu kk kl km mv ko kp kq mw ks kt ku mx kw kx ky im bi translated">虽然一开始有点怀疑，但我很快就喜欢上了Firestore。虽然运行托管Postgres可以让我更容易地转换云提供商，但它也会使运行成本更高。保持较小的存储接口意味着您可以在几个小时内实现Postgres(或任何其他数据库)驱动程序，因此最重要的事情是:</p><ul class=""><li id="7376" class="lh li it kd b ke kf ki kj km lj kq lk ku ll ky lm ln lo lp bi translated">该解决方案需要多少维护</li><li id="48f9" class="lh li it kd b ke lq ki lr km ls kq lt ku lu ky lm ln lo lp bi translated">费用</li><li id="0780" class="lh li it kd b ke lq ki lr km ls kq lt ku lu ky lm ln lo lp bi translated">表演</li></ul><p id="2abf" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">有用的资源:</p><ul class=""><li id="ee61" class="lh li it kd b ke kf ki kj km lj kq lk ku ll ky lm ln lo lp bi translated"><a class="ae kz" href="https://github.com/GoogleCloudPlatform/golang-samples/tree/master/firestore/firestore_quickstart" rel="noopener ugc nofollow" target="_blank"> Golang Firestore快速入门</a></li><li id="e5ef" class="lh li it kd b ke lq ki lr km ls kq lt ku lu ky lm ln lo lp bi translated"><a class="ae kz" href="https://github.com/GoogleCloudPlatform/golang-samples/tree/master/firestore/firestore_snippets" rel="noopener ugc nofollow" target="_blank"> Golang Firestore片段</a></li><li id="57d5" class="lh li it kd b ke lq ki lr km ls kq lt ku lu ky lm ln lo lp bi translated"><a class="ae kz" href="https://cloud.google.com/docs/authentication/getting-started" rel="noopener ugc nofollow" target="_blank"> GCP认证</a></li><li id="f2a3" class="lh li it kd b ke lq ki lr km ls kq lt ku lu ky lm ln lo lp bi translated"><a class="ae kz" href="https://firebase.google.com/docs/firestore/pricing" rel="noopener ugc nofollow" target="_blank"> Firestore账单</a></li></ul></div><div class="ab cl nn no hx np" role="separator"><span class="nq bw bk nr ns nt"/><span class="nq bw bk nr ns nt"/><span class="nq bw bk nr ns"/></div><div class="im in io ip iq"><p id="2109" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated"><em class="ld">最初发表于</em><a class="ae kz" href="https://webhookrelay.com/blog/2019/08/26/using-google-firestore-for-go-backend/" rel="noopener ugc nofollow" target="_blank"><em class="ld">【https://webhookrelay.com】</em></a><em class="ld">。</em></p></div></div>    
</body>
</html>