<html>
<head>
<title>NestJS-microservice with TypeORM, MariaDb and Integration &amp; E2E Testing</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">NestJS-采用TypeORM、MariaDb和集成&amp; E2E测试的微服务</h1>
<blockquote>原文：<a href="https://itnext.io/nestjs-microservice-with-typeorm-mariadb-and-integration-e2e-testing-379338e99580?source=collection_archive---------0-----------------------#2020-02-01">https://itnext.io/nestjs-microservice-with-typeorm-mariadb-and-integration-e2e-testing-379338e99580?source=collection_archive---------0-----------------------#2020-02-01</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><p id="667a" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">使用TypeORM、MariaDB在TCP上创建一个NestJS微服务，并学习如何编写单元、集成和E2E测试。</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div class="gh gi ko"><img src="../Images/678fb769171f94148d4de1a32e4de40c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1200/format:webp/1*Mil00LRhnrjGmbHQ25Zrfg.png"/></div></figure><h1 id="7700" class="kw kx it bd ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt bi translated">TL；速度三角形定位法(dead reckoning)</h1><p id="deeb" class="pw-post-body-paragraph jq jr it js b jt lu jv jw jx lv jz ka kb lw kd ke kf lx kh ki kj ly kl km kn im bi translated"><a class="ae lz" href="https://github.com/GeoPablo/nestjs-microservice-boilerplate" rel="noopener ugc nofollow" target="_blank">下面是带有代码的Github repo。</a></p></div><div class="ab cl ma mb hx mc" role="separator"><span class="md bw bk me mf mg"/><span class="md bw bk me mf mg"/><span class="md bw bk me mf"/></div><div class="im in io ip iq"><h1 id="9527" class="kw kx it bd ky kz mh lb lc ld mi lf lg lh mj lj lk ll mk ln lo lp ml lr ls lt bi translated">序</h1><p id="8a43" class="pw-post-body-paragraph jq jr it js b jt lu jv jw jx lv jz ka kb lw kd ke kf lx kh ki kj ly kl km kn im bi translated">如果你看到这篇博文，我会假设你已经对什么是Nest JS和什么是微服务有了一些基本的了解。</p><p id="b418" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">代码可以免费下载和使用。在这篇博文中，我们将只讨论其实现中的棘手部分。</p><p id="0a2a" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">因此，在我们开始之前，下载代码并跟随我。</p></div><div class="ab cl ma mb hx mc" role="separator"><span class="md bw bk me mf mg"/><span class="md bw bk me mf mg"/><span class="md bw bk me mf"/></div><div class="im in io ip iq"><h1 id="9400" class="kw kx it bd ky kz mh lb lc ld mi lf lg lh mj lj lk ll mk ln lo lp ml lr ls lt bi translated">代码📃</h1><p id="cc06" class="pw-post-body-paragraph jq jr it js b jt lu jv jw jx lv jz ka kb lw kd ke kf lx kh ki kj ly kl km kn im bi translated">我们将讨论的内容:</p><ol class=""><li id="e425" class="mm mn it js b jt ju jx jy kb mo kf mp kj mq kn mr ms mt mu bi translated"><a class="ae lz" href="https://github.com/GeoPablo/nestjs-microservice-boilerplate" rel="noopener ugc nofollow" target="_blank">从GitHub下载代码😀</a></li><li id="449e" class="mm mn it js b jt mv jx mw kb mx kf my kj mz kn mr ms mt mu bi translated">创建微服务</li><li id="3089" class="mm mn it js b jt mv jx mw kb mx kf my kj mz kn mr ms mt mu bi translated">为我们的项目创建配置服务</li><li id="9e02" class="mm mn it js b jt mv jx mw kb mx kf my kj mz kn mr ms mt mu bi translated">连接到数据库</li><li id="efcf" class="mm mn it js b jt mv jx mw kb mx kf my kj mz kn mr ms mt mu bi translated">创建自定义错误处理(可选)</li><li id="2548" class="mm mn it js b jt mv jx mw kb mx kf my kj mz kn mr ms mt mu bi translated">为具有CRUD操作的用户创建新模块</li><li id="4c8e" class="mm mn it js b jt mv jx mw kb mx kf my kj mz kn mr ms mt mu bi translated">测试(单元测试、集成测试和e2e测试)</li><li id="8a66" class="mm mn it js b jt mv jx mw kb mx kf my kj mz kn mr ms mt mu bi translated">数据包发送器—测试TCP微服务的实用程序</li></ol></div><div class="ab cl ma mb hx mc" role="separator"><span class="md bw bk me mf mg"/><span class="md bw bk me mf mg"/><span class="md bw bk me mf"/></div><div class="im in io ip iq"><p id="9ad4" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><strong class="js iu"> 2。创建微服务</strong></p><p id="2d87" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><strong class="js iu"> main.ts </strong></p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="nb nc di nd bf ne"><div class="gh gi na"><img src="../Images/175716ed10d8d1b5b39a9d912abb79af.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*7InaqKQxmT35LaGKcE54nQ.png"/></div></div><figcaption class="nf ng gj gh gi nh ni bd b be z dk translated"><a class="ae lz" href="https://carbon.now.sh/?bg=rgba%28171%2C+184%2C+195%2C+1%29&amp;t=seti&amp;wt=none&amp;l=javascript&amp;ds=true&amp;dsyoff=20px&amp;dsblur=68px&amp;wc=true&amp;wa=true&amp;pv=56px&amp;ph=56px&amp;ln=false&amp;fl=1&amp;fm=Hack&amp;fs=14px&amp;lh=133%25&amp;si=false&amp;es=2x&amp;wm=false&amp;code=async%2520function%2520bootstrap%28%29%2520%257B%250A%2520%2520const%2520logger%2520%253D%2520new%2520Logger%28%27Main%27%29%253B%250A%250A%2520%2520const%2520microservicesOptions%253A%2520any%2520%253D%2520%257B%250A%2520%2520%2520%2520transport%253A%2520Transport.TCP%252C%250A%2520%2520%2520%2520options%253A%2520%257B%250A%2520%2520%2520%2520%2520%2520host%253A%2520%27127.0.0.1%27%252C%250A%2520%2520%2520%2520%2520%2520port%253A%25208875%252C%250A%2520%2520%2520%2520%257D%252C%250A%2520%2520%257D%253B%250A%250A%2520%2520const%2520app%253A%2520INestMicroservice%2520%253D%2520await%2520NestFactory.createMicroservice%28%250A%2520%2520%2520%2520AppModule%252C%250A%2520%2520%2520%2520microservicesOptions%252C%250A%2520%2520%29%253B%250A%250A%2520%2520%2520app.listen%28async%2520%28%29%2520%253D%253E%2520%257B%250A%2520%2520%2520%2520logger.log%28%27Microservices%2520is%2520listening...%27%29%253B%250A%2520%2520%257D%29%253B%250A%257D%250Abootstrap%28%29%253B" rel="noopener ugc nofollow" target="_blank">生</a></figcaption></figure><p id="07fb" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">有了这个功能，我们就有了一个微服务，在PC上的8875端口上实时使用TCP通信。</p></div><div class="ab cl ma mb hx mc" role="separator"><span class="md bw bk me mf mg"/><span class="md bw bk me mf mg"/><span class="md bw bk me mf"/></div><div class="im in io ip iq"><p id="b144" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><strong class="js iu"> 3。为我们的项目创建一个配置服务</strong></p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="nb nc di nd bf ne"><div class="gh gi nj"><img src="../Images/d29dd0078878098d3274ce91bfb81264.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*hbRG7BoUxF8w2cp-VdmjiA.png"/></div></div></figure><p id="5d5a" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">我们使用<strong class="js iu"> dotenv </strong>来加载我们的配置。所以我们需要两个<strong class="js iu">。env </strong>文件一个用于开发，一个用于测试(<strong class="js iu"> .env.development </strong>和<strong class="js iu"> .env.test </strong>)</p><p id="5713" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">接下来，我们使用配置服务将这些文件加载到我们的应用程序中。</p><p id="6d10" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">在<strong class="js iu"> config.service.ts </strong>文件中，您会发现以下代码</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="nb nc di nd bf ne"><div class="gh gi nk"><img src="../Images/8aadac965e40b680219d3368ef5268ff.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Emx08x1oWB9Yplp0o7xVPA.png"/></div></div><figcaption class="nf ng gj gh gi nh ni bd b be z dk translated"><a class="ae lz" href="https://carbon.now.sh/?bg=rgba%28171%2C+184%2C+195%2C+1%29&amp;t=seti&amp;wt=none&amp;l=javascript&amp;ds=true&amp;dsyoff=20px&amp;dsblur=68px&amp;wc=true&amp;wa=true&amp;pv=56px&amp;ph=56px&amp;ln=false&amp;fl=1&amp;fm=Hack&amp;fs=14px&amp;lh=133%25&amp;si=false&amp;es=2x&amp;wm=false&amp;code=switch%2520%28this.%2523nodeEnv%29%2520%257B%250A%2520%2520case%2520%27test%27%253A%250A%2520%2520%2520%2520this.%2523envPath%2520%253D%2520resolve%28process.cwd%28%29%252C%2520%27.env.test%27%29%253B%250A%2520%2520%2520%2520break%253B%250A%2520%2520case%2520%27production%27%253A%250A%2520%2520%2520%2520this.%2523envPath%2520%253D%2520resolve%28process.cwd%28%29%252C%2520%27.env.production%27%29%253B%250A%2520%2520%2520%2520break%253B%250A%2520%2520case%2520%27development%27%253A%250A%2520%2520%2520%2520this.%2523envPath%2520%253D%2520resolve%28process.cwd%28%29%252C%2520%27.env.development%27%29%253B%250A%2520%2520%2520%2520break%253B%250A%2520%2520default%253A%250A%2520%2520%2520%2520throw%2520new%2520Error%28%27Specify%2520the%2520NODE_ENV%2520variable%27%29%253B%250A%257D%250A%250Athis.%2523envConfig%2520%253D%2520dotenv.parse%28fs.readFileSync%28this.%2523envPath%29%29%253B" rel="noopener ugc nofollow" target="_blank"> RAW </a></figcaption></figure><p id="5a53" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">还有<strong class="js iu">这个。</strong> # <strong class="js iu"> nodeEnv </strong>来自</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="nb nc di nd bf ne"><div class="gh gi nl"><img src="../Images/0195bc03d458ed41aa18c5f14660bde8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*zx0hcKqIfQcG3s6Hbyb2dA.png"/></div></div><figcaption class="nf ng gj gh gi nh ni bd b be z dk translated"><a class="ae lz" href="https://carbon.now.sh/?bg=rgba%28171%2C+184%2C+195%2C+1%29&amp;t=seti&amp;wt=none&amp;l=javascript&amp;ds=true&amp;dsyoff=20px&amp;dsblur=68px&amp;wc=true&amp;wa=true&amp;pv=56px&amp;ph=56px&amp;ln=false&amp;fl=1&amp;fm=Hack&amp;fs=14px&amp;lh=133%25&amp;si=false&amp;es=2x&amp;wm=false&amp;code=%2523nodeEnv%253A%2520string%2520%253D%2520process.env.NODE_ENV%250A%2520%2520%253F%2520process.env.NODE_ENV.trim%28%29%250A%2520%2520%253A%2520undefined%253B" rel="noopener ugc nofollow" target="_blank">未加工的</a></figcaption></figure><p id="c385" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">所以我们检查什么是<strong class="js iu"> NODE_ENV </strong>值，并且我们将加载<strong class="js iu">。婀</strong>的文件根据吧。</p><p id="590b" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">而<strong class="js iu"> NODE_ENV </strong>来自我们的运行脚本。在<strong class="js iu"> package.json </strong>中你会看到<strong class="js iu">cross-ENV NODE _ ENV = development</strong>和<strong class="js iu"> cross-env NODE_ENV=test </strong></p><p id="56c5" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">制作没有脚本，但是可以根据自己的制作环境自己写。</p></div><div class="ab cl ma mb hx mc" role="separator"><span class="md bw bk me mf mg"/><span class="md bw bk me mf mg"/><span class="md bw bk me mf"/></div><div class="im in io ip iq"><p id="f8fd" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><strong class="js iu"> 4。连接到数据库</strong></p><p id="d67f" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">我们将MariaDB与TypeORM一起使用，所以首先，确保您安装了数据库服务器，并且它工作正常。如果你需要任何帮助，你可以在Github页面找到一个关于如何安装MariaDB的youtube教程的链接。</p><p id="a9b6" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">我们将以异步模式连接到数据库，因此代码如下所示:</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="nb nc di nd bf ne"><div class="gh gi nm"><img src="../Images/d35bda315b0be4443d8ec7a2146c8984.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ro12kfMYnH9n4ICeuuIL_g.png"/></div></div><figcaption class="nf ng gj gh gi nh ni bd b be z dk translated"><a class="ae lz" href="https://carbon.now.sh/?bg=rgba%28171%2C+184%2C+195%2C+1%29&amp;t=seti&amp;wt=none&amp;l=javascript&amp;ds=true&amp;dsyoff=20px&amp;dsblur=68px&amp;wc=true&amp;wa=true&amp;pv=56px&amp;ph=56px&amp;ln=false&amp;fl=1&amp;fm=Hack&amp;fs=14px&amp;lh=133%25&amp;si=false&amp;es=2x&amp;wm=false&amp;code=%2540Module%28%257B%250A%2520%2520imports%253A%2520%255B%250A%2520%2520%2520%2520TypeOrmModule.forRootAsync%28%257B%250A%2520%2520%2520%2520%2520%2520imports%253A%2520%255BConfigModule%255D%252C%250A%2520%2520%2520%2520%2520%2520inject%253A%2520%255BConfigService%255D%252C%250A%2520%2520%2520%2520%2520%2520useFactory%253A%2520%28configService%253A%2520ConfigService%29%2520%253D%253E%2520%28%257B%250A%2520%2520%2520%2520%2520%2520%2520%2520type%253A%2520%27mysql%27%252C%250A%2520%2520%2520%2520%2520%2520%2520%2520host%253A%2520configService.get%28%27DB_SERVER_HOST%27%29%252C%250A%2520%2520%2520%2520%2520%2520%2520%2520port%253A%2520Number%28configService.get%28%27DB_SERVER_PORT%27%29%29%252C%250A%2520%2520%2520%2520%2520%2520%2520%2520username%253A%2520configService.get%28%27DB_SERVER_USERNAME%27%29%252C%250A%2520%2520%2520%2520%2520%2520%2520%2520password%253A%2520configService.get%28%27DB_SERVER_PASSWORD%27%29%252C%250A%2520%2520%2520%2520%2520%2520%2520%2520database%253A%2520configService.get%28%27DATABASE%27%29%252C%250A%2520%2520%2520%2520%2520%2520%2520%2520entities%253A%2520%255BUser%255D%252C%250A%2520%2520%2520%2520%2520%2520%2520%2520%252F%252F%2520%21%2520ALWAYS%2520FALSE%2520IN%2520PROD%250A%2520%2520%2520%2520%2520%2520%2520%2520synchronize%253A%2520%21%28process.env.NODE_ENV.trim%28%29%2520%253D%253D%253D%2520%27production%27%29%252C%250A%2520%2520%2520%2520%2520%2520%257D%29%252C%250A%2520%2520%2520%2520%257D%29%252C%250A%2520%2520%255D%252C%250A%257D%29" rel="noopener ugc nofollow" target="_blank"> RAW </a></figcaption></figure><p id="a672" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">在这里，我们注入<strong class="js iu"> configService </strong>，并使用它来获取数据库的凭证。</p><blockquote class="nn no np"><p id="c774" class="jq jr nq js b jt ju jv jw jx jy jz ka nr kc kd ke ns kg kh ki nt kk kl km kn im bi translated"><strong class="js iu">同步——这是用来同步你的数据库和你的实体，如果你不想随机丢失你的数据，请确保在生产中设置为假</strong></p></blockquote><p id="50e3" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">现在回到你的<strong class="js iu">。env </strong>文件，并确保使用您的数据完成以下字段。对于MariaDB，这些是缺省值，除了数据库名。<strong class="js iu">另外，不要忘记创建数据库。</strong></p><p id="b453" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><strong class="js iu"> .env.development </strong></p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="nb nc di nd bf ne"><div class="gh gi nu"><img src="../Images/e3fa951b02c16cbc32a608de020fe0f8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*848D0ZZhF2W2rS5rKhTPcg.png"/></div></div><figcaption class="nf ng gj gh gi nh ni bd b be z dk translated"><a class="ae lz" href="https://carbon.now.sh/?bg=rgba%28171%2C+184%2C+195%2C+1%29&amp;t=seti&amp;wt=none&amp;l=javascript&amp;ds=true&amp;dsyoff=20px&amp;dsblur=68px&amp;wc=true&amp;wa=true&amp;pv=56px&amp;ph=56px&amp;ln=false&amp;fl=1&amp;fm=Hack&amp;fs=14px&amp;lh=133%25&amp;si=false&amp;es=2x&amp;wm=false&amp;code=DB_SERVER_PORT%253D3306%250ADB_SERVER_HOST%253Dlocalhost%250ADB_SERVER_USERNAME%253Droot%250ADB_SERVER_PASSWORD%253Droot%250ADATABASE%253Dusers" rel="noopener ugc nofollow" target="_blank"> RAW </a></figcaption></figure><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="nb nc di nd bf ne"><div class="gh gi nv"><img src="../Images/149305f5fbe075952370832a04bdba99.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*nD9fpRf7Ty3BiVEpzZMAiQ.png"/></div></div></figure><p id="785d" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">你可以使用MariaDB自带的<strong class="js iu"> HeidiSQL </strong>。</p></div><div class="ab cl ma mb hx mc" role="separator"><span class="md bw bk me mf mg"/><span class="md bw bk me mf mg"/><span class="md bw bk me mf"/></div><div class="im in io ip iq"><p id="1f20" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><strong class="js iu"> 5。创建自定义错误处理(可选)</strong></p><p id="4065" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">现在是处理错误的时候了。我的方法是创建一些自定义错误代码和一些异常过滤器。这里我们需要一个用于数据库，一个用于验证，一个用于RCP异常的全局错误过滤器。RCP因为我们有微服务。</p><p id="501e" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">同时在<strong class="js iu"> .env.development </strong>和<strong class="js iu"> .env.test </strong>中编写以下代码</p><pre class="kp kq kr ks gt nw nx ny nz aw oa bi"><span id="330e" class="ob kx it nx b gy oc od l oe of">ERROR_CODE_NAMESPACE=users-microservice</span></pre><p id="a770" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">该实现可以在以下文件夹中找到:<strong class="js iu">公共- &gt;异常过滤器、</strong>和<strong class="js iu">核心- &gt;定制响应</strong>。</p><p id="d611" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">如果您不想使用这种自定义的错误处理，可以从代码中删除这一部分，并返回简单的消息。</p></div><div class="ab cl ma mb hx mc" role="separator"><span class="md bw bk me mf mg"/><span class="md bw bk me mf mg"/><span class="md bw bk me mf"/></div><div class="im in io ip iq"><p id="7275" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><strong class="js iu"> 6。为有CRUD操作的用户创建一个新模块</strong></p><p id="9490" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">接下来，我们创建一个名为<strong class="js iu"> user的新模块。</strong>为了将这个模块与数据库中的表<strong class="js iu"> user </strong>连接起来，我们编写了以下代码</p><p id="5621" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">用户模块ts :</p><pre class="kp kq kr ks gt nw nx ny nz aw oa bi"><span id="be4f" class="ob kx it nx b gy oc od l oe of">TypeOrmModule.forFeature([User])</span></pre><p id="6ef7" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">在<strong class="js iu"> user.service.ts </strong>和<strong class="js iu"> user.controller.ts </strong>里面，你会发现不同CRUD操作的实现。</p></div><div class="ab cl ma mb hx mc" role="separator"><span class="md bw bk me mf mg"/><span class="md bw bk me mf mg"/><span class="md bw bk me mf"/></div><div class="im in io ip iq"><p id="5c0d" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><strong class="js iu"> 7。测试(单元测试、集成测试和e2e测试)</strong></p><p id="892b" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">在真实的场景中，就数量而言，单元测试&gt;集成测试&gt; e2e测试。</p><p id="d4ed" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">单元测试没有那么难，所以我只写了这个场景的一个例子。你可以在<strong class="js iu"> user.service.spec.ts </strong>里面找到。</p><p id="55ec" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">简而言之，您通过使用模拟实现将应用程序的一个单元与代码的其余部分隔离开来，从而对其进行测试。</p><p id="2ccb" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">在i <strong class="js iu">集成测试中，</strong>你检查不同的模块是否在一起工作。所以在我们的例子中，我们不再模仿数据库，我们将使用一个真实的数据库。</p><p id="f325" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">您可以在<strong class="js iu">user . integration . spec . ts</strong>中找到所有CRUD操作的测试</p><p id="a449" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">在<strong class="js iu"> E2E测试</strong>中，你从头到尾检查申请流程。</p><p id="c336" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">启动微服务、连接到微服务并提取客户端的代码如下:</p><p id="754d" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><strong class="js iu">测试/应用e2e规范</strong></p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="nb nc di nd bf ne"><div class="gh gi og"><img src="../Images/69856ae0f23484094603e2d608b84a12.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*QJsBjqVfEd7LDNYEOs593g.png"/></div></div><figcaption class="nf ng gj gh gi nh ni bd b be z dk translated"><a class="ae lz" href="https://carbon.now.sh/?bg=rgba%28171%2C+184%2C+195%2C+1%29&amp;t=seti&amp;wt=none&amp;l=javascript&amp;ds=true&amp;dsyoff=20px&amp;dsblur=68px&amp;wc=true&amp;wa=true&amp;pv=56px&amp;ph=56px&amp;ln=false&amp;fl=1&amp;fm=Hack&amp;fs=14px&amp;lh=133%25&amp;si=false&amp;es=2x&amp;wm=false&amp;code=beforeAll%28async%2520%28%29%2520%253D%253E%2520%257B%250A%2520%2520const%2520moduleFixture%253A%2520TestingModule%2520%253D%2520await%2520Test.createTestingModule%28%257B%250A%2520%2520%2520%2520imports%253A%2520%255B%250A%2520%2520%2520%2520%2520%2520AppModule%252C%250A%2520%2520%2520%2520%2520%2520ClientsModule.register%28%255B%250A%2520%2520%2520%2520%2520%2520%2520%2520%257B%2520name%253A%2520%27clientToken%27%252C%2520transport%253A%2520Transport.TCP%2520%257D%252C%250A%2520%2520%2520%2520%2520%2520%255D%29%252C%250A%2520%2520%2520%2520%255D%252C%250A%2520%2520%257D%29.compile%28%29%253B%250A%250A%2520%2520userController%2520%253D%2520moduleFixture.get%253CUserController%253E%28UserController%29%253B%250A%250A%2520%2520app%2520%253D%2520moduleFixture.createNestApplication%28%29%253B%250A%250A%2520%2520app.connectMicroservice%28%257B%250A%2520%2520%2520%2520transport%253A%2520Transport.TCP%252C%250A%2520%2520%257D%29%253B%250A%250A%2520%2520await%2520app.startAllMicroservicesAsync%28%29%253B%250A%2520%2520await%2520app.init%28%29%253B%250A%250A%2520%2520client%2520%253D%2520app.get%28%27clientToken%27%29%253B%250A%2520%2520await%2520client.connect%28%29%253B%250A%257D%29%253B" rel="noopener ugc nofollow" target="_blank"> RAW </a></figcaption></figure><p id="6829" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><strong class="js iu"> 8。数据包发送者—测试TCP微服务的实用程序</strong></p><p id="4c9a" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">如果你想使用工具测试你的微服务，就像用Postman测试你的REST API一样，你可以使用<a class="ae lz" href="https://packetsender.com/" rel="noopener ugc nofollow" target="_blank">数据包发送器</a></p><p id="adf7" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">要进行配置，您必须按如下方式填写字段:</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="nb nc di nd bf ne"><div class="gh gi oh"><img src="../Images/6a974c341c014bbaeb2b76da628f7be0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*3emsoFsxMRgCn9_K01P24g.png"/></div></div><figcaption class="nf ng gj gh gi nh ni bd b be z dk translated">地址—本地主机；端口—微服务端口</figcaption></figure><p id="f97a" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">在<strong class="js iu"> ASCII </strong>文件中你写下你的命令。</p><p id="4c85" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><strong class="js iu"> 122# </strong> —表示消息的长度</p><p id="2fe5" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">你可以通过打开<a class="ae lz" href="https://blank.org" rel="noopener ugc nofollow" target="_blank">blank.org</a>来查看你的消息长度，然后在开发者工具里面写下你的消息。</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="nb nc di nd bf ne"><div class="gh gi oh"><img src="../Images/b2ac700aa7399287595d11f9e2103bff.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*aRYf0iZJWOizzoih-V3-7A.png"/></div></div></figure><p id="4ebd" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">在以下字段中写入JSON数据:</p><pre class="kp kq kr ks gt nw nx ny nz aw oa bi"><span id="643f" class="ob kx it nx b gy oc od l oe of">”data”:{“email”:”<a class="ae lz" href="mailto:q@gmail.com" rel="noopener ugc nofollow" target="_blank">q@gmail.com</a>”,”password”:”12345678"}</span></pre><p id="3cd2" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">字符串的最后一部分表示消息的类型。</p><pre class="kp kq kr ks gt nw nx ny nz aw oa bi"><span id="4e9d" class="ob kx it nx b gy oc od l oe of">”id”:”ce51ebd3–32b1–4ae6-b7ef-e018126c4cc4"</span></pre><p id="bb2e" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">该值将映射到<strong class="js iu">@ message pattern(' create _ user ')</strong></p><p id="df56" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">如果您想映射到<strong class="js iu"> @EventPattern() </strong>，那么使用这个<strong class="js iu"> id的任何其他值。</strong></p></div><div class="ab cl ma mb hx mc" role="separator"><span class="md bw bk me mf mg"/><span class="md bw bk me mf mg"/><span class="md bw bk me mf"/></div><div class="im in io ip iq"><h1 id="d95f" class="kw kx it bd ky kz mh lb lc ld mi lf lg lh mj lj lk ll mk ln lo lp ml lr ls lt bi translated">结论</h1><p id="7a06" class="pw-post-body-paragraph jq jr it js b jt lu jv jw jx lv jz ka kb lw kd ke kf lx kh ki kj ly kl km kn im bi translated">为了更好地理解这一点，我推荐您从GitHub下载代码并使用它。尝试创建一个类似于<em class="nq">帖子</em>或<em class="nq">照片</em>的新模块，并将其作为<strong class="js iu">多对一</strong>和<strong class="js iu">一对多</strong>与您的用户链接，或者创建一个使用该微服务的客户端。</p><p id="6fd4" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">如果你也想在生产中测试这个代码，这里有一个<a class="ae lz" href="https://m.do.co/c/f0f252058644" rel="noopener ugc nofollow" target="_blank">数字海洋</a>的链接，价格是100美元。</p></div></div>    
</body>
</html>