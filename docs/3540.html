<html>
<head>
<title>Breaking Changes in Helm 3 (and How to Fix Them)</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">头盔3的突破性变化(以及如何修复它们)</h1>
<blockquote>原文：<a href="https://itnext.io/breaking-changes-in-helm-3-and-how-to-fix-them-39fea23e06ff?source=collection_archive---------2-----------------------#2020-01-06">https://itnext.io/breaking-changes-in-helm-3-and-how-to-fix-them-39fea23e06ff?source=collection_archive---------2-----------------------#2020-01-06</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><figure class="gl gn jr js jt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi jq"><img src="../Images/58e96ef4917b3a6525eeec3e00107c82.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*ba3WGuYm28Gcf_qc"/></div></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated">弗兰克·艾弗特在<a class="ae kf" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>拍摄的照片</figcaption></figure><p id="e287" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><em class="le">2020年14月2日编辑:添加了关于- </em> n <em class="le">标志如何变化的说明。还添加了关于命名空间创建的说明。</em></p><p id="e518" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><em class="le">编辑22/05/2020:增加了</em> <a class="lf lg ep" href="https://medium.com/u/f45899a535aa?source=post_page-----39fea23e06ff--------------------------------" rel="noopener" target="_blank"> <em class="le">巴蒂</em> </a> <em class="le">和</em> <a class="lf lg ep" href="https://medium.com/u/17b5bbacec6e?source=post_page-----39fea23e06ff--------------------------------" rel="noopener" target="_blank"> <em class="le">格诺特·霍本赖希</em> </a>的一些建议</p><p id="e34c" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">最近我很幸运地测试了从头盔2到头盔3的迁移。头盔3是一个主要版本，解决了头盔2的许多问题。在很大程度上，这是一个平稳的过渡。helm-2to3插件使这个过程变得简单透明，一旦你移动了你所有的财产，Helm 3很容易使用。也就是说，要知道<strong class="ki iu">你的CI/CD脚本可能会崩溃。Helm接受的参数、Helm查询的发布方式以及图表发送到Kubernetes API之前的新OpenAPI验证流程都有重大变化。在我自己遇到这些问题之前，我肯定没有意识到这些变化，并且在迁移文档中也没有发现特别指出它们的地方。所以，我想我应该在这里为那些挠头想知道为什么部署失败的人记录所有这些！</strong></p><h1 id="31a6" class="lh li it bd lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me bi translated">对标志的更改(新行为、弃用等)</h1><p id="a3e6" class="pw-post-body-paragraph kg kh it ki b kj mf kl km kn mg kp kq kr mh kt ku kv mi kx ky kz mj lb lc ld im bi translated">这将主要(如果不是全部)归因于新版本头盔中旗帜的变化。<strong class="ki iu">这里列出了你在头盔2中最可能用到的旗帜的变化:</strong></p><ol class=""><li id="44f5" class="mk ml it ki b kj kk kn ko kr mm kv mn kz mo ld mp mq mr ms bi translated"><strong class="ki iu">使用</strong> <code class="fe mt mu mv mw b"><strong class="ki iu">helm install</strong></code>时 <code class="fe mt mu mv mw b"><strong class="ki iu">-n</strong></code> <strong class="ki iu">标志不再存在。使用Helm 2，你可以使用<code class="fe mt mu mv mw b">-n</code>来指定发布的名字，而不是使用一个自动生成的名字。</strong></li></ol><pre class="mx my mz na gt nb mw nc nd aw ne bi"><span id="43f9" class="nf li it mw b gy ng nh l ni nj">helm install . -n my-awesomechart --namespace dev</span></pre><p id="a8d5" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">这是有问题的，因为当使用kubectl与您的集群交互时，<code class="fe mt mu mv mw b">-n</code>用来指您运行命令的名称空间。有了头盔3，<code class="fe mt mu mv mw b">-n</code>就完全没了。相反，<em class="le">发布的名称是一个位置参数</em>:</p><pre class="mx my mz na gt nb mw nc nd aw ne bi"><span id="1909" class="nf li it mw b gy ng nh l ni nj">➜ helm3 install -h</span><span id="a544" class="nf li it mw b gy nk nh l ni nj">This command installs a chart archive.<br/>[...]<br/>Usage:<br/>  helm install [NAME] [CHART] [flags]</span></pre><p id="107a" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">此外，如果您希望Helm为您生成发布名称，您现在必须提供<code class="fe mt mu mv mw b">--generate-name</code>参数并省略发布名称的位置参数。</p><p id="c499" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">2.净化现在是头盔3的默认行为。因此，任何传递了<code class="fe mt mu mv mw b">--purge</code>标志的脚本现在都会抛出一个错误:</p><pre class="mx my mz na gt nb mw nc nd aw ne bi"><span id="720b" class="nf li it mw b gy ng nh l ni nj">➜ helm delete --purge<br/>Error: unknown flag: --purge</span><span id="67f0" class="nf li it mw b gy nk nh l ni nj"># If you want to keep the release history like Helm 2 used to when omitting the --purge flag, do this:<br/>➜ helm delete --keep-history</span></pre><p id="b69a" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">3.<strong class="ki iu">既然舵柄没了，</strong> <code class="fe mt mu mv mw b"><strong class="ki iu">--tls</strong></code> <strong class="ki iu">旗也随之而去。</strong>使用该标志将抛出与上面相同的<code class="fe mt mu mv mw b">unknown flag</code>错误。</p><p id="3ea4" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">4.<strong class="ki iu"/><code class="fe mt mu mv mw b"><strong class="ki iu">--recreate-pods</strong></code><strong class="ki iu">旗也不存在了。这在头盔2中被标记为<a class="ae kf" href="https://github.com/helm/helm-www/pull/286" rel="noopener ugc nofollow" target="_blank">不推荐使用</a>，文档已经更新，告诉你如何在头盔3中正确使用。你可以在文档<a class="ae kf" href="https://v3.helm.sh/docs/howto/charts_tips_and_tricks/#automatically-roll-deployments" rel="noopener ugc nofollow" target="_blank">这里</a>看到一个例子。</strong></p><p id="4505" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">5.<strong class="ki iu"/><code class="fe mt mu mv mw b"><strong class="ki iu">--timeout</strong></code><strong class="ki iu">旗帜现在需要一个持续时间单位。之前您可以指定300，这将转换为300秒。现在您必须指定<code class="fe mt mu mv mw b">m</code>为分钟或<code class="fe mt mu mv mw b">s</code>为秒，例如<code class="fe mt mu mv mw b">300s</code>、<code class="fe mt mu mv mw b">5m</code>或<code class="fe mt mu mv mw b">5m0s</code>。</strong></p><p id="20a9" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">6.<strong class="ki iu"/><code class="fe mt mu mv mw b"><strong class="ki iu">--strict</strong></code><strong class="ki iu"/><code class="fe mt mu mv mw b"><strong class="ki iu">helm repo update</strong></code><strong class="ki iu">的标志不见了。</strong>在头盔3中似乎没有类似的选项。</p><p id="88e1" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">7.<strong class="ki iu"/><code class="fe mt mu mv mw b"><strong class="ki iu">--save</strong></code><strong class="ki iu"/><code class="fe mt mu mv mw b"><strong class="ki iu">helm dependency update</strong></code><strong class="ki iu">的标志不见了。再次声明，头盔3中似乎没有类似的选项。</strong></p><p id="9ece" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">8.<code class="fe mt mu mv mw b"><strong class="ki iu">helm status</strong></code> <strong class="ki iu">不再显示资源赫尔姆创建的状态。</strong>GitHub有一个未解决的问题，要在Helm 3中恢复这个功能。你可以在这里阅读这个<a class="ae kf" href="https://github.com/helm/helm/issues/5952" rel="noopener ugc nofollow" target="_blank"/>。</p><p id="4a08" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">感谢<a class="lf lg ep" href="https://medium.com/u/f45899a535aa?source=post_page-----39fea23e06ff--------------------------------" rel="noopener" target="_blank"> Bharti </a>的第6、7、8项！</p><h1 id="962c" class="lh li it bd lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me bi translated">Helm 3按名称空间列出了版本</h1><p id="88ba" class="pw-post-body-paragraph kg kh it ki b kj mf kl km kn mg kp kq kr mh kt ku kv mi kx ky kz mj lb lc ld im bi translated">头盔3现在的行为类似于kubectl，我认为这是一个了不起的增加。使用Helm 2，只需输入<code class="fe mt mu mv mw b">helm ls</code>就可以查询所有名称空间中的<em class="le">所有版本。使用Helm 3，运行<code class="fe mt mu mv mw b">helm ls </code>只会显示默认名称空间中的版本，就像<code class="fe mt mu mv mw b">kubectl get pods</code>一样。要列出任何非默认名称空间中的版本，您必须<em class="le">提供<code class="fe mt mu mv mw b">-n</code>参数和名称空间，就像使用kubectl时一样。这里有一个更好的例子来说明我的意思:</em></em></p><pre class="mx my mz na gt nb mw nc nd aw ne bi"><span id="4a13" class="nf li it mw b gy ng nh l ni nj"># Helm 2: shows all releases across all namespaces<br/>➜ helm ls<br/>NAME        REVISION      UPDATED      ...  NAMESPACE<br/>prometheus  1             Sat Jan 04   ...  default<br/>devapp      2             Sat Jan 04   ...  dev<br/>prodapp     2             Sat Jan 04   ...  production</span><span id="2045" class="nf li it mw b gy nk nh l ni nj"># Helm 3: only shows releases in default namespace<br/>➜ helm ls<br/>NAME        REVISION      UPDATED      ...  NAMESPACE<br/>prometheus  1             Sat Jan 04   ...  default</span><span id="3c0b" class="nf li it mw b gy nk nh l ni nj"># Helm 3: using -n shows release in specified namespace<br/>➜ helm ls -n production<br/>NAME        REVISION      UPDATED      ...  NAMESPACE<br/>prodapp     2             Sat Jan 04   ...  production</span><span id="1226" class="nf li it mw b gy nk nh l ni nj"># Helm 3: shows all releases across all namespaces<br/>➜ helm ls --all-namespaces<br/>NAME        REVISION      UPDATED      ...  NAMESPACE<br/>prometheus  1             Sat Jan 04   ...  default<br/>devapp      2             Sat Jan 04   ...  dev<br/>prodapp     2             Sat Jan 04   ...  production</span></pre><p id="9d4d" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><strong class="ki iu">注意:Helm 3看不到Helm 2管理的版本，除非您迁移它们。上面的例子只是为了说明清单是如何变化的。你必须使用上面的2对3插件把你的版本移植到头盔3上，头盔3才能看到它们。</strong></p><p id="0ee8" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">这是一个很小的变化，但是如果您的Bash脚本先前已经使用了<code class="fe mt mu mv mw b">helm ls</code>,然后在输出中使用了<code class="fe mt mu mv mw b">grep</code>,那么这个变化就不小了。现在，这些命令将会失败，因为它们只检查默认的名称空间。如果你想要和在头盔3中一样的行为，确保你通过了<code class="fe mt mu mv mw b">--all-namespaces</code>标志！</p><h1 id="978e" class="lh li it bd lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me bi translated">Helm不会为您创建名称空间，除非您要求它这样做</h1><p id="46cc" class="pw-post-body-paragraph kg kh it ki b kj mf kl km kn mg kp kq kr mh kt ku kv mi kx ky kz mj lb lc ld im bi translated">这实际上并不是很大的变化，但是您仍然应该意识到这一点。当安装一个图表时，Helm 2会为你创建一个目标名称空间，如果它还不存在的话。Helm 3只将版本安装到预先存在的名称空间中，并会抛出一个错误，指出目标名称空间不存在。从Helm v3.2.0开始，您可以明确地告诉Helm应该使用<code class="fe mt mu mv mw b">--create-namespace</code>标志来创建名称空间(感谢<a class="lf lg ep" href="https://medium.com/u/17b5bbacec6e?source=post_page-----39fea23e06ff--------------------------------" rel="noopener" target="_blank">Gernot hben Reich！</a>)。</p><h1 id="8ece" class="lh li it bd lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me bi translated">Kubernetes OpenAPI验证</h1><p id="29d1" class="pw-post-body-paragraph kg kh it ki b kj mf kl km kn mg kp kq kr mh kt ku kv mi kx ky kz mj lb lc ld im bi translated">Helm 3根据Kubernetes OpenAPI模式验证所有渲染模板。<a class="ae kf" href="https://github.com/helm/helm/releases/tag/v3.0.0" rel="noopener ugc nofollow" target="_blank">这是在3.0.0版中启用的。</a>在此之前，Helm会渲染你的模板，并将它们发送到Kubernetes API，并由API来确定哪些是有效的。任何不正确缩进的内容都会引发错误，传递给错误端点的参数通常会被丢弃，而不会记录到stdout/stderr中。</p><p id="dc88" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">使用Helm 3，你的渲染模板在被发送到Kubernetes API之前会被验证<em class="le">。</em>这意味着任何无效的字段都将触发一个非零退出代码，从而导致发布失败。如果你的YAML文件与Kubernetes API文档完全一致，那就太好了。如果没有，您将不得不删除任何无效字段。</p><p id="4569" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">这里有一个例子。取<a class="ae kf" href="https://github.com/helm/charts/tree/master/stable/prometheus" rel="noopener ugc nofollow" target="_blank">稳定的普罗米修斯图表</a>并将无效参数插入普罗米修斯容器的<code class="fe mt mu mv mw b">volumeMounts</code>部分。在本例中，我将添加参数<code class="fe mt mu mv mw b">defaultMode</code>，根据Kubernetes API规范:，该参数<a class="ae kf" href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.11/#volumemount-v1-core" rel="noopener ugc nofollow" target="_blank">无效</a></p><pre class="mx my mz na gt nb mw nc nd aw ne bi"><span id="9efd" class="nf li it mw b gy ng nh l ni nj">[...]<br/>volumeMounts:</span><span id="5c38" class="nf li it mw b gy nk nh l ni nj">- name: config-volume</span><span id="4e79" class="nf li it mw b gy nk nh l ni nj">  mountPath: /etc/config</span><span id="a1e0" class="nf li it mw b gy nk nh l ni nj">  defaultMode: 256</span><span id="6461" class="nf li it mw b gy nk nh l ni nj">  readOnly: true</span><span id="62ec" class="nf li it mw b gy nk nh l ni nj">[...]</span></pre><p id="3033" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">我现在试着用头盔2安装这张图表:</p><pre class="mx my mz na gt nb mw nc nd aw ne bi"><span id="80c4" class="nf li it mw b gy ng nh l ni nj">helm install . -n prometheus --name prometheus<br/>➜ helm ls<br/>NAME        REVISION      UPDATED      ...  NAMESPACE<br/>prometheus  1             Sat Jan 04   ...  default</span></pre><p id="f05b" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">嗯，那很容易，而且库伯内特似乎没有抱怨。让我们用头盔3试试:</p><pre class="mx my mz na gt nb mw nc nd aw ne bi"><span id="1958" class="nf li it mw b gy ng nh l ni nj">➜ helm install prometheus .<br/>Error: unable to build kubernetes objects from release manifest: error validating "": error validating data: ValidationError(Deployment.spec.template.spec.containers[0].volumeMounts[0]): unknown field "defaultMode" in io.k8s.api.core.v1.VolumeMount</span></pre><p id="fd44" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">如果我们删除无效的参数，我们可以看到头盔3没有问题，现在安装图表:</p><pre class="mx my mz na gt nb mw nc nd aw ne bi"><span id="1d18" class="nf li it mw b gy ng nh l ni nj">➜ helm install prometheus .<br/>NAME: prometheus<br/>LAST DEPLOYED: Mon Jan  6 15:11:14 2020<br/>NAMESPACE: default<br/>STATUS: deployed<br/>REVISION: 1<br/>TEST SUITE: None<br/>NOTES:<br/>The Prometheus server can be accessed via port 80 on the following DNS name from within your cluster:<br/>prometheus-server.default.svc.cluster.local<br/>...</span></pre><p id="d817" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">你的图表可能没有这些问题，但是如果它们是在亿万年前写的，并且一直愉快地使用头盔2，你可能会看到一些像这样的验证失败。无需担心；只需检查Kubernetes API文档，确保参数有效或缩进正确。</p><h1 id="c441" class="lh li it bd lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me bi translated">结论</h1><p id="2115" class="pw-post-body-paragraph kg kh it ki b kj mf kl km kn mg kp kq kr mh kt ku kv mi kx ky kz mj lb lc ld im bi translated">这些只是我在转向头盔3时发现的一些问题。我应该提一下，这并不是要以任何方式打击头盔3；这是对头盔2的巨大改进，我强烈推荐移植到头盔2上。如果你看到了任何问题，请随时给我留言，我会更新这篇文章！</p></div></div>    
</body>
</html>