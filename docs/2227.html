<html>
<head>
<title>Modifying Kubernetes Ingress Traffic Dynamically with Ambassador: Add Metadata, Transform Payloads, etc</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Ambassador动态修改Kubernetes入口流量:添加元数据、转换有效负载等</h1>
<blockquote>原文：<a href="https://itnext.io/modifying-kubernetes-ingress-traffic-dynamically-with-ambassador-add-metadata-transform-payloads-1626ee1cf6b?source=collection_archive---------7-----------------------#2019-04-18">https://itnext.io/modifying-kubernetes-ingress-traffic-dynamically-with-ambassador-add-metadata-transform-payloads-1626ee1cf6b?source=collection_archive---------7-----------------------#2019-04-18</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="12ca" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">三月初，我们<a class="ae kl" href="https://blog.getambassador.io/announcing-ambassador-pro-0-2-filters-and-filter-policies-979fbea39d7c" rel="noopener ugc nofollow" target="_blank">宣布为Ambassador Pro API网关推出</a>请求<a class="ae kl" href="https://www.getambassador.io/reference/filter-reference/" rel="noopener ugc nofollow" target="_blank">过滤器和过滤策略</a>，我们已经看到了这一领域许多有趣的发展。许多Ambassador用户希望在最终用户的请求到达后端服务之前对其进行处理，而过滤器提供了一个完美的框架来实现这一点。</p><p id="5635" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">例如，您是否希望向基于客户ID标题、cookie或JWT的请求添加额外的客户元数据？是否要删除可能意外添加到请求中的不适当或敏感的数据？还是希望对请求有效负载执行简单的转换？解决方案可能是实现一个插件过滤器。</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="ks kt di ku bf kv"><div class="gh gi km"><img src="../Images/683a75b38bd966eab1646e189f0f1470.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*EdIxQuDAPu9q3Ref"/></div></div><figcaption class="ky kz gj gh gi la lb bd b be z dk translated"><strong class="bd lc">大使过滤器正在运行，通过过滤器和过滤器策略CRDs进行配置</strong></figcaption></figure><h1 id="b8bc" class="ld le iq bd lc lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz bi translated">实现入口横切关注点</h1><p id="c406" class="pw-post-body-paragraph jn jo iq jp b jq ma js jt ju mb jw jx jy mc ka kb kc md ke kf kg me ki kj kk ij bi translated">任何从事企业Java或。NET应用程序将熟悉HTTP过滤器的概念，许多其他语言和框架的开发人员也是如此。过滤器是一个很好的抽象点，用于实现跨领域的关注点，如身份验证/授权、操作请求数据以及向传入的HTTP请求添加元数据，然后在堆栈中进一步使用。它们还可以包含条件逻辑，以便只触发特定的请求或模式，并且它们可以链接在一起，形成任意复杂的功能管道。</p><p id="8a38" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">Ambassador Pro为过滤器提供了Kubernetes自定义资源定义(CRD ),用于初始化和配置要使用的过滤器，还提供了过滤器策略，用于指定应该过滤哪些请求以及应用过滤器的顺序。目前Ambassador Pro支持实现四种类型的过滤器:<a class="ae kl" href="https://www.getambassador.io/reference/filter-reference/#filter-type-external" rel="noopener ugc nofollow" target="_blank">外部</a>、<a class="ae kl" href="https://www.getambassador.io/reference/filter-reference/#filter-type-jwt" rel="noopener ugc nofollow" target="_blank"> JWT </a>、<a class="ae kl" href="https://www.getambassador.io/reference/filter-reference/#filter-type-oauth2" rel="noopener ugc nofollow" target="_blank"> OAuth2 </a>和<a class="ae kl" href="https://www.getambassador.io/reference/filter-reference/#filter-type-plugin" rel="noopener ugc nofollow" target="_blank">插件</a>。前三个主要与实现身份验证和授权有关，但第四个为实现定制逻辑提供了很大的灵活性。</p><p id="2b39" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">通过包含SDK和用于快速开发的<a class="ae kl" href="https://www.getambassador.io/docs/guides/filter-dev-guide/#rapid-development-of-a-custom-filter" rel="noopener ugc nofollow" target="_blank">本地插件运行器</a>，为Ambassador Pro创建过滤器变得更加容易。运行过滤器时还提供了一些有用的现成功能，例如自动注入跟踪头以帮助调试，以及通过使用FilterPolicy CRD简化运行时声明性配置和定制。</p><h1 id="ff9e" class="ld le iq bd lc lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz bi translated">过滤器和过滤器策略</h1><p id="a34e" class="pw-post-body-paragraph jn jo iq jp b jq ma js jt ju mb jw jx jy mc ka kb kc md ke kf kg me ki kj kk ij bi translated">插件过滤器是用Go编写的，它们必须有一个签名为<code class="fe mf mg mh mi b">PluginMain(w http.ResponseWriter, r *http.Request)</code>的<code class="fe mf mg mh mi b">main.PluginMain</code>函数。例如，一个简单插件的摘录如下所示:</p><pre class="kn ko kp kq gt mj mi mk ml aw mm bi"><span id="91f0" class="mn le iq mi b gy mo mp l mq mr">package main</span><span id="91ab" class="mn le iq mi b gy ms mp l mq mr">import (<br/> "net/http"<br/>)</span><span id="4a04" class="mn le iq mi b gy ms mp l mq mr">func PluginMain(w http.ResponseWriter, r *http.Request) { <br/>    ...<br/>    w.Header().Set(“customer-details”, customer)<br/>    w.WriteHeader(http.StatusOK).<br/>}</span></pre><p id="9586" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">关于插件过滤器的编译、打包和部署的完整说明包含在Ambassador Pro " <a class="ae kl" href="https://www.getambassador.io/docs/guides/filter-dev-guide/" rel="noopener ugc nofollow" target="_blank">开发过滤器</a>"文档中。</p><p id="8216" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">一旦您在Ambassador旁边部署了过滤器，您就可以将过滤器定义为Kubernetes资源:</p><pre class="kn ko kp kq gt mj mi mk ml aw mm bi"><span id="deec" class="mn le iq mi b gy mo mp l mq mr">---<br/>apiVersion: getambassador.io/v1beta2<br/>kind: Filter<br/>metadata:<br/>  name: "customer-metadata-inject"<br/>spec:<br/>  ambassador_id: "x457"<br/>  Plugin:<br/>    name: "customer-metadata-inject" # Plugin's `.so` file name</span></pre><p id="d55f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">您还可以定义FilterPolicy资源，根据主机和路径来指定应该将哪些请求发送到您的筛选器。</p><pre class="kn ko kp kq gt mj mi mk ml aw mm bi"><span id="d3a4" class="mn le iq mi b gy mo mp l mq mr">---<br/>apiVersion: getambassador.io/v1beta2<br/>kind: FilterPolicy<br/>metadata:<br/>  name: customer-metadata-inject-policy<br/>spec:<br/>  rules:<br/>  # Default to authorizing all requests with auth0<br/>  - host: "*"<br/>    path: "*"<br/>    filters:<br/>    - name: auth0<br/>  # Inject customer metadata for /user/ path <br/>  - host: "*"<br/>    path: /user/*<br/>    filters:   <br/>    - name: auth0<br/>    - name: customer-metadata-inject<br/>  # Don't run any filters for the /logout/ path<br/>  - host: "*"<br/>    path: /logout/*<br/>    filters: null</span></pre><p id="5856" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">就这么简单。实现过滤器的唯一限制是您的想象力——注意不要将高度耦合的业务逻辑合并到过滤器中，这可能会成为一个维护问题！</p><h1 id="c02f" class="ld le iq bd lc lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz bi translated">开始使用过滤器</h1><p id="4676" class="pw-post-body-paragraph jn jo iq jp b jq ma js jt ju mb jw jx jy mc ka kb kc md ke kf kg me ki kj kk ij bi translated">如果你还没有下载<a class="ae kl" href="https://www.getambassador.io/pro/" rel="noopener ugc nofollow" target="_blank"> Ambassador Pro </a>，你可以通过该项目的网站开始一个<a class="ae kl" href="https://www.getambassador.io/pro/free-trial" rel="noopener ugc nofollow" target="_blank">14天的免费试用</a>。一旦您将Ambassador Pro安装到您的Kubernetes集群中，下一个最好的参考资源是<a class="ae kl" href="https://www.getambassador.io/reference/filter-reference/" rel="noopener ugc nofollow" target="_blank">过滤器参考</a>文档和<a class="ae kl" href="https://www.getambassador.io/docs/guides/filter-dev-guide/" rel="noopener ugc nofollow" target="_blank">过滤器开发指南</a>文档。</p><p id="05d9" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">像往常一样，你也可以通过Twitter(<a class="ae kl" href="https://twitter.com/getambassadorio" rel="noopener ugc nofollow" target="_blank">@ getambassadorio</a>)、<a class="ae kl" href="https://d6e.co/slack" rel="noopener ugc nofollow" target="_blank"> Slack </a>提出任何问题，或者通过<a class="ae kl" href="https://github.com/datawire/ambassador" rel="noopener ugc nofollow" target="_blank"> GitHub </a>提出问题。</p><p id="d1f2" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><em class="mt">本文此前发表于</em> <a class="ae kl" href="https://blog.getambassador.io/pre-processing-augmenting-and-transforming-user-ingress-requests-using-filters-in-ambassador-pro-1c2438a36058" rel="noopener ugc nofollow" target="_blank"> <em class="mt"> getambassador.io博客</em> </a> <em class="mt">。</em></p></div></div>    
</body>
</html>