<html>
<head>
<title>When VPC Flow Logs Aren’t Enough</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">当VPC流量日志不够用时</h1>
<blockquote>原文：<a href="https://itnext.io/debugging-complex-networking-issues-with-elb-and-other-aws-managed-services-8d2ff9822fbe?source=collection_archive---------1-----------------------#2022-04-20">https://itnext.io/debugging-complex-networking-issues-with-elb-and-other-aws-managed-services-8d2ff9822fbe?source=collection_archive---------1-----------------------#2022-04-20</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="8199" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">调试ELB和其他AWS托管服务的复杂网络问题</h2></div><p id="f0fe" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">任何优秀的云工程师的一个基本条件是拥有强大的网络基础。无论你在云中做什么，在某些时候，一些数据必须从一个地方移动到另一个地方。当数据移动时，迟早会有东西出故障，有人必须调试它。当您处理AWS VPC时，您经常检查的第一件事是VPC流量日志，但这仅在以下方面有所帮助:</p><ol class=""><li id="6b61" class="lb lc iq kh b ki kj kl km ko ld ks le kw lf la lg lh li lj bi translated">有路由问题吗？如果流量不在VPC流量日志中，几乎总是路由问题。</li><li id="ea25" class="lb lc iq kh b ki lk kl ll ko lm ks ln kw lo la lg lh li lj bi translated">VPC安全组是否允许接口之间的流量？</li><li id="7ffb" class="lb lc iq kh b ki lk kl ll ko lm ks ln kw lo la lg lh li lj bi translated">网络ACL是否允许子网之间的流量？</li></ol><p id="ad18" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">如果在您的VPC流量日志中有一个拒绝，2或3是罪魁祸首。但是，如果VPC流量日志显示接受您的流量，但您仍然在日志中看到“连接超时”或其他网络错误，会发生什么呢？如果EC2实例的操作系统上存在丢弃流量的配置，例如基于主机的防火墙或内部路由问题，VPC流日志不会知道。幸运的是，您可以访问EC2实例的底层操作系统，因此您可以从那里进行调试。</p></div><div class="ab cl lp lq hu lr" role="separator"><span class="ls bw bk lt lu lv"/><span class="ls bw bk lt lu lv"/><span class="ls bw bk lt lu"/></div><div class="ij ik il im in"><p id="658d" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">最近在一个项目中，我们在一个应用程序负载平衡器上遇到了间歇性的502错误——间歇性的错误并不有趣。我们检查了ALB访问日志，它们提供了很好的信息，但它们不是原始数据。即使你能够解读他们讲述的故事，他们也没有讲述完整的故事。</p><pre class="lw lx ly lz gt ma mb mc md aw me bi"><span id="ddfa" class="mf mg iq mb b gy mh mi l mj mk">type time elb client_ip client_port target_ip target_port request_processing_time target_processing_time response_processing_time elb_status_code target_status_code received_bytes. sent_bytes. “request”. “user_agent” ssl_cipher. ssl_protocol target_group_arn “trace_id”. “domain_name” “chosen_cert_arn” matched_rule_priority request_creation_time “actions_executed”</span><span id="37c9" class="mf mg iq mb b gy ml mi l mj mk">https 2022–04–19T21:37:22.712394Z app/my-albli-B66X277T4761/55b71d5d1d4b7322 xx.xx.255.79:23273 xx.xx.0.120:443 0.021 0.003 -1 502–184 688 GET <a class="ae mm" href="https://trg.domain.com:443/index.net/Security/logon.aspx" rel="noopener ugc nofollow" target="_blank">https://trg.domain.com:443/index.net/Security/logon.aspx</a> HTTP/1.1 MonitoringTOOL_Monitor/1.0 ECDHE-RSA-AES128-GCM-SHA256 TLSv1.2 arn:aws:elasticloadbalancing:us-east-1:1111111111:targetgroup/my-nlb/2667f724b1efc5c5 Root=1–3333333–0124f1707221a2650b9fe9f9 trg.domain.com arn:aws:acm:us-east-1:11111111111:certificate/2222222–9f9f-4b8b-ace5–0c5a8c672798 0 2022–04–19T21:37:22.688000Z waf,forward</span></pre><p id="3ba4" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">大多数网络工程师更喜欢Wireshark——它是黄金标准，可以让您看到整个故事。问题是:我如何在一个实际上无法登录的系统上捕获数据包？例如，当使用托管AWS应用程序负载平衡器时。</p><p id="7fd1" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">进入VPC交通镜像！</p><p id="fe91" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">流量镜像于2019年6月发布，提供了一种全面了解通过AWS ENI的任何流量的方法。</p><p id="2c49" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">它需要3条信息:</p><ol class=""><li id="c4f9" class="lb lc iq kh b ki kj kl km ko ld ks le kw lf la lg lh li lj bi translated">来源ENI——您希望实际监控哪个ENI</li><li id="b3c1" class="lb lc iq kh b ki lk kl ll ko lm ks ln kw lo la lg lh li lj bi translated">目标—您希望镜像流量发送到哪里</li><li id="ab6e" class="lb lc iq kh b ki lk kl ll ko lm ks ln kw lo la lg lh li lj bi translated">过滤器—您希望镜像哪些流量—您可以镜像入站/出站、UDP/TCP、源/目标IP、源/目标端口。</li></ol><p id="819e" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">然后，AWS将镜像流量封装在VXLAN(一种运行在UDP 4789上的协议)中，并将其从镜像源发送到镜像目标。这需要将目标的安全组打开到UDP/4789。</p><figure class="lw lx ly lz gt mo gh gi paragraph-image"><div role="button" tabindex="0" class="mp mq di mr bf ms"><div class="gh gi mn"><img src="../Images/cde67bbef9beeac8e81905d621af7741.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*WHZ3pcRKA5F-OhRA.png"/></div></div></figure><p id="0b79" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">所以我启动了一个安装了Wireshark的Windows服务器，并将其设置为我的目标，我的来源是我的ALB的ENI。</p><figure class="lw lx ly lz gt mo gh gi paragraph-image"><div role="button" tabindex="0" class="mp mq di mr bf ms"><div class="gh gi mv"><img src="../Images/4b25c7790985e1119f127fd1d86b812e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*nloZvPTGfXcoE2vwiU06bw.jpeg"/></div></div><figcaption class="mw mx gj gh gi my mz bd b be z dk translated">在Wireshark中查看流量，您可以看到封装。底部的红框是从客户端到ALB的原始数据包。黑色方框是包装器流量—您可以看到它是UDP Dst端口:4789。</figcaption></figure><p id="9f7a" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">设置镜像后，我需要自己生成一个502错误。然而，这里有一个小问题——502响应在HTTPS是加密的。我很好奇，不仅想看到502的回复，还想知道之前和之后发生的事情。所以我必须找到502加密响应，然后才能进行下一步。</p><figure class="lw lx ly lz gt mo gh gi paragraph-image"><div role="button" tabindex="0" class="mp mq di mr bf ms"><div class="gh gi na"><img src="../Images/0bd36f2ba55f58fb958246955567e42a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*47gSukBtSpwfCvyG93uhRg.png"/></div></div><figcaption class="mw mx gj gh gi my mz bd b be z dk translated">这是加密的天书。</figcaption></figure><p id="7248" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">幸运的是，Wireshark确实允许您解密HTTPS(即使使用Diffie-Hellman，即完美的前向保密)，但您需要捕获用于加密的密钥。</p><p id="2a67" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">使用curl时，您可以让curl将TLS中使用的加密密钥写入您通过设置以下环境变量指定的文件中。</p><figure class="lw lx ly lz gt mo gh gi paragraph-image"><div role="button" tabindex="0" class="mp mq di mr bf ms"><div class="gh gi nb"><img src="../Images/f8767e1e69dbdcdc1ae47d716acad7ad.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*kWks-6xl0pRBqZc45Tg3ug.png"/></div></div></figure><p id="a14f" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">下次运行curl时，您将在指定的文件中看到类似这样的内容。</p><figure class="lw lx ly lz gt mo gh gi paragraph-image"><div role="button" tabindex="0" class="mp mq di mr bf ms"><div class="gh gi nc"><img src="../Images/52c2658879db64585ebe2b8bf91f9f1f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*lqwejgIURJfT9aj8FtpQ0g.png"/></div></div></figure><p id="bf33" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我用Wireshark将密钥从我的笔记本电脑复制到Windows box，然后配置Wireshark用我的密钥文件解密。</p><figure class="lw lx ly lz gt mo gh gi paragraph-image"><div role="button" tabindex="0" class="mp mq di mr bf ms"><div class="gh gi nd"><img src="../Images/c36a1fb030e47f7f74c91fed01887b74.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*_nDg_xu85AqtB2rjTNFGVg.png"/></div></div></figure><p id="f48b" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">现在我可以在Wireshark中看到我的502错误。但是为什么会这样呢？？</p><figure class="lw lx ly lz gt mo gh gi paragraph-image"><div role="button" tabindex="0" class="mp mq di mr bf ms"><div class="gh gi ne"><img src="../Images/0976f540627a1783e985a427306f13a8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ki_XYfQaOsGwzhMMOw7sVQ.jpeg"/></div></div></figure><p id="64be" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我根据我的IP地址过滤流量，因此我移除了过滤器并记下了502消息的序列号。就在它之前，有一个我的ALB的目标发送的TCP Reset！</p><figure class="lw lx ly lz gt mo gh gi paragraph-image"><div role="button" tabindex="0" class="mp mq di mr bf ms"><div class="gh gi nf"><img src="../Images/68b5152508da98499ce7212cdb2595f8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*cQMq_RmdrPXgZ0bMbo7Pjg.jpeg"/></div></div></figure><p id="c3b3" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们的目标是NLB，因此我们查看了网络负载平衡器的AWS文档，发现了以下情况:</p><blockquote class="ng nh ni"><p id="4e06" class="kf kg nj kh b ki kj jr kk kl km ju kn nk kp kq kr nl kt ku kv nm kx ky kz la ij bi translated">对于客户端通过网络负载平衡器发出的每个TCP请求，都会跟踪该连接的状态。如果客户端或目标在超过空闲超时的时间内没有通过连接发送任何数据，则连接关闭。如果客户端或目标在空闲超时时间过后发送数据，它会收到一个TCP RST数据包，表示连接不再有效。</p><p id="3c44" class="kf kg nj kh b ki kj jr kk kl km ju kn nk kp kq kr nl kt ku kv nm kx ky kz la ij bi translated">弹性负载平衡将TCP流的空闲超时值设置为350秒。您不能修改该值。客户端或目标可以使用TCP keepalive数据包来重置空闲超时。为保持TLS连接而发送的Keepalive数据包不能包含数据或有效负载。</p></blockquote><p id="8648" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这是TCP keepalive问题！因此，我们的下一步是在我们的NLB目标上启用TCP keepalive这应该会解决这个问题——届时我将更新博客。</p><h2 id="eb9a" class="mf mg iq bd nn no np dn nq nr ns dp nt ko nu nv nw ks nx ny nz kw oa ob oc od bi translated">结论:</h2><p id="9bdb" class="pw-post-body-paragraph kf kg iq kh b ki oe jr kk kl of ju kn ko og kq kr ks oh ku kv kw oi ky kz la ij bi translated">这表明在调试网络问题时，在Wireshark中查看原始数据包捕获是无可替代的。甚至跟踪此问题的AWS支持人员也发现Wireshark信息在为ALB访问日志提供上下文方面非常有用。但是，如果没有VPC流量镜像和VXLAN封装的魔力，这一切都是不可能的！</p></div><div class="ab cl lp lq hu lr" role="separator"><span class="ls bw bk lt lu lv"/><span class="ls bw bk lt lu lv"/><span class="ls bw bk lt lu"/></div><div class="ij ik il im in"><p id="1fef" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">Matthew是领先的AWS网络安全合作伙伴stackArmor的高级解决方案总监，该公司为希望满足合规框架安全要求的客户设计定制解决方案:FedRAMP、NIST 800系列、PCI-DSS、国防部SRG、HIPAA、FISMA、FIPS 140–2(和3)等。StackArmor提供了一个经过AWS审核的解决方案，可以加速FedRAMP ATO的运行并降低40%以上的成本。</p></div></div>    
</body>
</html>