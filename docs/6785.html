<html>
<head>
<title>Linear Search API is available from v1.4.0</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">线性搜索API从1.4.0版开始提供</h1>
<blockquote>原文：<a href="https://itnext.io/linear-search-api-is-available-from-v1-4-0-afe4222273b8?source=collection_archive---------0-----------------------#2022-02-25">https://itnext.io/linear-search-api-is-available-from-v1-4-0-afe4222273b8?source=collection_archive---------0-----------------------#2022-02-25</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/2e869ae0fe8a6bbd5f8b072797d9146c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*dmPqKH4sFdMlcNr3.png"/></div></div></figure><p id="bfe3" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><a class="ae kw" href="https://vdaas-vald.medium.com/release-announcement-v1-4-0-5c65a48aaa25" rel="noopener">从v1.4 </a>开始，Vald支持线性搜索API，因为NGT从<a class="ae kw" href="https://github.com/yahoojapan/NGT/releases/tag/v1.13.8" rel="noopener ugc nofollow" target="_blank"> v1.13.8 </a>发布了线性搜索CAPI。这篇文章介绍了什么是线性搜索和线性搜索API的用法。</p><p id="25fd" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">注意:</p><pre class="kx ky kz la gt lb lc ld le aw lf bi"><span id="5828" class="lg lh iq lc b gy li lj l lk ll">Current Linear Search API has <strong class="lc ir">a timeout setting as the mandatory setting</strong>. Please set a long time as `Search_Config.timeout`.<br/>This configuration will be optional soon.</span></pre></div><div class="ab cl lm ln hu lo" role="separator"><span class="lp bw bk lq lr ls"/><span class="lp bw bk lq lr ls"/><span class="lp bw bk lq lr"/></div><div class="ij ik il im in"><h1 id="c315" class="lt lh iq bd lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp bi translated">什么是线性搜索？</h1><p id="129a" class="pw-post-body-paragraph jy jz iq ka b kb mq kd ke kf mr kh ki kj ms kl km kn mt kp kq kr mu kt ku kv ij bi translated">线性搜索是最简单的最近邻搜索算法。它通过计算查询向量(输入)和已经存在于一些数据库或类似数据库中的所有目标向量之间的距离来搜索最近的向量。由于计算所有存储数据之间的距离，输入查询的搜索结果将总是相同的，因此搜索精度可以是恒定的。此外，处理时间与存储向量的数量及其维数成比例增加。</p></div><div class="ab cl lm ln hu lo" role="separator"><span class="lp bw bk lq lr ls"/><span class="lp bw bk lq lr ls"/><span class="lp bw bk lq lr"/></div><div class="ij ik il im in"><h1 id="45a7" class="lt lh iq bd lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp bi translated">在Vald中使用线性搜索的情况</h1><p id="b9a5" class="pw-post-body-paragraph jy jz iq ka b kb mq kd ke kf mr kh ki kj ms kl km kn mt kp kq kr mu kt ku kv ij bi translated">本捕手介绍线性搜索API的使用场景。</p><h2 id="eaa8" class="lg lh iq bd lu mv mw dn ly mx my dp mc kj mz na mg kn nb nc mk kr nd ne mo nf bi translated">使用它作为搜索方法</h2><p id="ef79" class="pw-post-body-paragraph jy jz iq ka b kb mq kd ke kf mr kh ki kj ms kl km kn mt kp kq kr mu kt ku kv ij bi translated">第一种是用它做线性搜索。Vald将向量索引到多路Vald代理盒中，允许您并行执行线性搜索。它比人工神经网络(使用搜索API)需要更多的搜索时间，但它比使用一个向量集的一般线性搜索执行得更快。</p><h2 id="b3b8" class="lg lh iq bd lu mv mw dn ly mx my dp mc kj mz na mg kn nb nc mk kr nd ne mo nf bi translated">调整人工神经网络搜索的准确性验证</h2><p id="8349" class="pw-post-body-paragraph jy jz iq ka b kb mq kd ke kf mr kh ki kj ms kl km kn mt kp kq kr mu kt ku kv ij bi translated">另一种方法是在使用搜索API时将其用于参数调整。您可以通过设置搜索API的参数来调整搜索精度和搜索处理时间。例如，搜索配置参数之一radius和epsilon指定搜索范围。(半径和ε是NGT特有的搜索参数。详情请参考<a class="ae kw" href="https://github.com/yahoojapan/NGT/wiki" rel="noopener ugc nofollow" target="_blank">此处</a>。</p></div><div class="ab cl lm ln hu lo" role="separator"><span class="lp bw bk lq lr ls"/><span class="lp bw bk lq lr ls"/><span class="lp bw bk lq lr"/></div><div class="ij ik il im in"><h1 id="0652" class="lt lh iq bd lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp bi translated">如何使用Vald的线性搜索</h1><p id="cf70" class="pw-post-body-paragraph jy jz iq ka b kb mq kd ke kf mr kh ki kj ms kl km kn mt kp kq kr mu kt ku kv ij bi translated">本章将以<code class="fe ng nh ni lc b">vald-client-go</code>为例，展示如何使用线性搜索API。Vald提供了客户端库并发布了gRPC proto文件，因此您可以将它们与您喜欢的编程语言一起使用。</p><h2 id="a63d" class="lg lh iq bd lu mv mw dn ly mx my dp mc kj mz na mg kn nb nc mk kr nd ne mo nf bi translated">示例代码</h2><p id="1d9f" class="pw-post-body-paragraph jy jz iq ka b kb mq kd ke kf mr kh ki kj ms kl km kn mt kp kq kr mu kt ku kv ij bi translated">下面是使用线性搜索API的示例代码。该示例使用<code class="fe ng nh ni lc b">fashion-mnist-784-euclidean</code>作为样本数据集。</p><pre class="kx ky kz la gt lb lc ld le aw lf bi"><span id="5a4e" class="lg lh iq lc b gy li lj l lk ll">package main<br/><br/>// import packages<br/>import (<br/>	"context"<br/>	"encoding/json"<br/>	"flag"<br/>	"os"<br/>	"time"<br/><br/>	"github.com/kpango/fuid"<br/>	"github.com/kpango/glg"<br/>	"github.com/vdaas/vald-client-go/v1/payload"<br/>	"github.com/vdaas/vald-client-go/v1/vald"<br/>	"gonum.org/v1/hdf5"<br/>	"google.golang.org/grpc"<br/>)<br/><br/>const (<br/>	insertCount = 10000     // the number of insert vectors<br/>	testCount   = 10        // the number of search queries<br/>	Num         = 5         // the number of nearest neighbors per search query<br/>	Radius      = -1        // search area parameter of NGT. -1 means infinite circle.<br/>	Timeout     = 100000000 // deadline time for searching<br/>)<br/><br/>var (<br/>	datasetPath         string<br/>	grpcServerAddr      string<br/>	indexingWaitSeconds uint<br/>)<br/><br/>func init() {<br/>	flag.StringVar(&amp;datasetPath, "path", "fashion-mnist-784-euclidean.hdf5", "dataset path")<br/>	flag.StringVar(&amp;grpcServerAddr, "addr", "localhost:8081", "gRPC server address")<br/>	flag.UintVar(&amp;indexingWaitSeconds, "wait", 300, "indexing wait seconds")<br/>	flag.Parse()<br/>}<br/><br/>func main() {<br/>        // load dataset<br/>	ids, train, test, err := load(datasetPath)<br/>	if err != nil {<br/>		glg.Fatal(err)<br/>	}<br/><br/><br/>        // create context<br/>	ctx := context.Background()<br/><br/><br/>        // create session to Vald cluster<br/>	conn, err := grpc.DialContext(ctx, grpcServerAddr, grpc.WithInsecure())<br/>	if err != nil {<br/>		glg.Fatal(err)<br/>	}<br/><br/><br/>        // create new client to contact with Vald cluster.<br/>	client := vald.NewValdClient(conn)<br/><br/>	glg.Infof("Start Inserting %d training vector to Vald", insertCount)<br/>	for i := range ids[:insertCount] {<br/>                // Send the insert vector request with vector object and configuration to Vald server via gRPC<br/>		_, err := client.Insert(ctx, &amp;payload.Insert_Request{<br/>                        // vector object<br/>			Vector: &amp;payload.Object_Vector{<br/>				Id:     ids[i],<br/>				Vector: train[i],<br/>			},<br/>                        // configuration<br/>			Config: &amp;payload.Insert_Config{<br/>				SkipStrictExistCheck: true,<br/>			},<br/>		})<br/>		if err != nil {<br/>			glg.Fatal(err)<br/>		}<br/>		if i%10 == 0 {<br/>			glg.Infof("Inserted: %d", i+10)<br/>		}<br/>	}<br/>	glg.Info("Finish Inserting dataset. \n\n")<br/><br/><br/>        // wait for indexing to finish<br/>	wt := time.Duration(indexingWaitSeconds) * time.Second<br/>	glg.Infof("Wait %s for indexing to finish", wt)<br/>	time.Sleep(wt)<br/><br/><br/>	/**<br/>	Gets exact nearest vectors, which is based on the value of `SearchConfig`, from the indexed tree based on the training data.<br/>	In this example, Vald gets 5 approximate vectors each search vector.<br/>	**/<br/>	glg.Infof("Start searching %d times", testCount)<br/>	for i, vec := range test[:testCount] {<br/>                // Send linear search request with query(vector) to Vald server via gRPC<br/>		res, err = client.LinearSearch(ctx, &amp;payload.Search_Request{<br/>                        // search query<br/>			Vector: vec,<br/>                        // serach config<br/>			Config: &amp;payload.Search_Config{<br/>				Num:     Num,<br/>				Radius:  Radius,<br/>				Timeout: Timeout,<br/>			},<br/>		})<br/>		if err != nil {<br/>			glg.Fatal(err)<br/>		}<br/><br/>                // convert result to buffer<br/>		b, _ = json.MarshalIndent(res.GetResults(), "", " ")<br/>		glg.Infof("%d - Linear Search Results : %s\n\n", i+1, string(b))<br/>		time.Sleep(1 * time.Second)<br/>	}<br/>	glg.Infof("Finish searching %d times", testCount)<br/><br/><br/>	// Delete indexed 10000 vectors from vald cluster.<br/>	glg.Info("Start removing vector")<br/>	for i := range ids[:insertCount] {<br/>                // Send delete request with vector's id to Vald server via gRPC<br/>		_, err := client.Remove(ctx, &amp;payload.Remove_Request{<br/>                        // the id of vector which will be deleted<br/>			Id: &amp;payload.Object_ID{<br/>				Id: ids[i],<br/>			},<br/>		})<br/>		if err != nil {<br/>			glg.Fatal(err)<br/>		}<br/>		if i%10 == 0 {<br/>			glg.Infof("Removed: %d", i+10)<br/>		}<br/>	}<br/>	glg.Info("Finish removing vector")<br/>}<br/><br/>/**<br/>load function loads training and test vector from hdf file.<br/>The size of ids is same to the number of training data.<br/>Each id, which is an element of ids, will be set a random number.<br/>This code is same as <a class="ae kw" href="https://github.com/vdaas/vald/blob/master/example/client/main.go" rel="noopener ugc nofollow" target="_blank">https://github.com/vdaas/vald/blob/master/example/client/main.go</a><br/>**/<br/>func load(path string) (ids []string, train, test [][]float32, err error) {<br/>	var f *hdf5.File<br/>	f, err = hdf5.OpenFile(path, hdf5.F_ACC_RDONLY)<br/>	if err != nil {<br/>		return nil, nil, nil, err<br/>	}<br/>	defer f.Close()<br/><br/>	readFn := func(name string) ([][]float32, error) {<br/>		d, err := f.OpenDataset(name)<br/>		if err != nil {<br/>			return nil, err<br/>		}<br/>		defer d.Close()<br/><br/>		sp := d.Space()<br/>		defer sp.Close()<br/><br/>		dims, _, _ := sp.SimpleExtentDims()<br/>		row, dim := int(dims[0]), int(dims[1])<br/><br/>		vec := make([]float32, sp.SimpleExtentNPoints())<br/>		if err := d.Read(&amp;vec); err != nil {<br/>			return nil, err<br/>		}<br/><br/>		vecs := make([][]float32, row)<br/>		for i := 0; i &lt; row; i++ {<br/>			vecs[i] = make([]float32, dim)<br/>			for j := 0; j &lt; dim; j++ {<br/>				vecs[i][j] = float32(vec[i*dim+j])<br/>			}<br/>		}<br/><br/>		return vecs, nil<br/>	}<br/><br/>	train, err = readFn("train")<br/>	if err != nil {<br/>		return nil, nil, nil, err<br/>	}<br/><br/>	test, err = readFn("test")<br/>	if err != nil {<br/>		return nil, nil, nil, err<br/>	}<br/><br/>	ids = make([]string, 0, len(train))<br/>	for i := 0; i &lt; len(train); i++ {<br/>		ids = append(ids, fuid.String())<br/>	}<br/><br/>	return<br/>}</span></pre><h2 id="1ade" class="lg lh iq bd lu mv mw dn ly mx my dp mc kj mz na mg kn nb nc mk kr nd ne mo nf bi translated">差异结果</h2><p id="1f2c" class="pw-post-body-paragraph jy jz iq ka b kb mq kd ke kf mr kh ki kj ms kl km kn mt kp kq kr mu kt ku kv ij bi translated">让我们检查搜索结果。条件如下:</p><ul class=""><li id="8b58" class="nj nk iq ka b kb kc kf kg kj nl kn nm kr nn kv no np nq nr bi translated">数据集:时尚-mnist-784-欧几里德</li><li id="8d8f" class="nj nk iq ka b kb ns kf nt kj nu kn nv kr nw kv no np nq nr bi translated">插入索引数:10，000</li><li id="486b" class="nj nk iq ka b kb ns kf nt kj nu kn nv kr nw kv no np nq nr bi translated">搜索向量的数量:10</li><li id="19c9" class="nj nk iq ka b kb ns kf nt kj nu kn nv kr nw kv no np nq nr bi translated">数字:5</li><li id="fb61" class="nj nk iq ka b kb ns kf nt kj nu kn nv kr nw kv no np nq nr bi translated">半径:-1</li><li id="11af" class="nj nk iq ka b kb ns kf nt kj nu kn nv kr nw kv no np nq nr bi translated">ε:0.1(仅搜索API使用)</li><li id="f468" class="nj nk iq ka b kb ns kf nt kj nu kn nv kr nw kv no np nq nr bi translated">超时:100，000，000纳秒</li></ul><p id="5164" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">索引的数据很小，所以没有明显的区别。但是，一些搜索结果不同于使用相同搜索查询的线性搜索结果。</p><ul class=""><li id="f081" class="nj nk iq ka b kb kc kf kg kj nl kn nm kr nn kv no np nq nr bi translated">搜索结果(前5名)</li></ul><pre class="kx ky kz la gt lb lc ld le aw lf bi"><span id="7aa9" class="lg lh iq lc b gy li lj l lk ll">[<br/> {<br/>  "id": "esg96afc89l5uc5rkvlg",<br/>  "distance": 1200.5337<br/> },<br/> {<br/>  "id": "esg96afc89l5uc5rk6u0",<br/>  "distance": 1268.7761<br/> },<br/> {<br/>  "id": "esg96afc89l5uc5rgaug",<br/>  "distance": 1325.6569<br/> },<br/> {<br/>  "id": "esg96afc89l5uc5rkffg",<br/>  "distance": 1337.0516<br/> },<br/> {<br/>  "id": "esg96afc89l5uc5rjke0",<br/>  "distance": 1344.2522<br/> }<br/>]</span></pre><ul class=""><li id="15dc" class="nj nk iq ka b kb kc kf kg kj nl kn nm kr nn kv no np nq nr bi translated">线性搜索结果(前5名)</li></ul><pre class="kx ky kz la gt lb lc ld le aw lf bi"><span id="dca0" class="lg lh iq lc b gy li lj l lk ll">[<br/> {<br/>  "id": "esg96afc89l5uk5rl44g",<br/>  "distance": 1120.9625<br/> },<br/> {<br/>  "id": "esg96afc89l5uc5rkvlg",<br/>  "distance": 1200.5337<br/> },<br/> {<br/>  "id": "esg96afc89l5uc5rk6u0",<br/>  "distance": 1268.7761<br/> },<br/> {<br/>  "id": "esg96afc89l5uc5rijig",<br/>  "distance": 1302.7283<br/> },<br/> {<br/>  "id": "esg96afc89l5uc5rgaug",<br/>  "distance": 1325.6569<br/> }<br/>]</span></pre><p id="c294" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">如上所述，你可以看到线性搜索结果比搜索结果更接近距离矢量。根据这个结果，您可以调整搜索参数和NGT配置，使搜索结果接近线性搜索结果。</p></div><div class="ab cl lm ln hu lo" role="separator"><span class="lp bw bk lq lr ls"/><span class="lp bw bk lq lr ls"/><span class="lp bw bk lq lr"/></div><div class="ij ik il im in"><p id="0e29" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">线性搜索的结果是精确的最近邻向量。然而，考虑到从十亿级数据中搜索最近的向量，线性搜索将花费更长的时间。我们建议对您的服务使用搜索，对优化配置使用线性搜索。</p></div><div class="ab cl lm ln hu lo" role="separator"><span class="lp bw bk lq lr ls"/><span class="lp bw bk lq lr ls"/><span class="lp bw bk lq lr"/></div><div class="ij ik il im in"><p id="4f73" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">如果您有任何问题或要求，请随时联系我们🙂</p><div class="nx ny gp gr nz oa"><a href="https://join.slack.com/t/vald-community/shared_invite/zt-db2ky9o4-R_9p2sVp8xRwztVa8gfnPA" rel="noopener  ugc nofollow" target="_blank"><div class="ob ab fo"><div class="oc ab od cl cj oe"><h2 class="bd ir gy z fp of fr fs og fu fw ip bi translated">松弛的</h2><div class="oh l"><h3 class="bd b gy z fp of fr fs og fu fw dk translated">编辑描述</h3></div><div class="oi l"><p class="bd b dl z fp of fr fs og fu fw dk translated">join.slack.com</p></div></div><div class="oj l"><div class="ok l ol om on oj oo jw oa"/></div></div></a></div><div class="nx ny gp gr nz oa"><a href="https://vald.vdaas.org/docs/contributing/contributing-guide/#contributing-issue" rel="noopener  ugc nofollow" target="_blank"><div class="ob ab fo"><div class="oc ab od cl cj oe"><h2 class="bd ir gy z fp of fr fs og fu fw ip bi translated">投稿指南</h2><div class="oh l"><h3 class="bd b gy z fp of fr fs og fu fw dk translated">Vald是一个开源项目。我们感谢您的帮助！我们使用Github问题来跟踪这个库中的问题…</h3></div><div class="oi l"><p class="bd b dl z fp of fr fs og fu fw dk translated">vald.vdaas.org</p></div></div><div class="oj l"><div class="op l ol om on oj oo jw oa"/></div></div></a></div><p id="c39a" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">下期见:)</p></div><div class="ab cl lm ln hu lo" role="separator"><span class="lp bw bk lq lr ls"/><span class="lp bw bk lq lr ls"/><span class="lp bw bk lq lr"/></div><div class="ij ik il im in"><p id="7934" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">相关帖子</p><div class="nx ny gp gr nz oa"><a href="https://vdaas-vald.medium.com/release-announcement-v1-4-0-5c65a48aaa25" rel="noopener follow" target="_blank"><div class="ob ab fo"><div class="oc ab od cl cj oe"><h2 class="bd ir gy z fp of fr fs og fu fw ip bi translated">发布公告:1.4.0版</h2><div class="oh l"><h3 class="bd b gy z fp of fr fs og fu fw dk translated">我们将在本周发布1.4.0版。</h3></div><div class="oi l"><p class="bd b dl z fp of fr fs og fu fw dk translated">vdaas-vald.medium.com</p></div></div><div class="oj l"><div class="oq l ol om on oj oo jw oa"/></div></div></a></div><p id="8af4" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">其他员额</p><div class="nx ny gp gr nz oa"><a href="https://medium.com/geekculture/vald-a-highly-scalable-distributed-fast-approximate-nearest-neighbour-dense-vector-search-engine-af1946a4a37" rel="noopener follow" target="_blank"><div class="ob ab fo"><div class="oc ab od cl cj oe"><h2 class="bd ir gy z fp of fr fs og fu fw ip bi translated">瓦尔德。一个高度可扩展的分布式快速近似最近邻密集向量搜索引擎。</h2><div class="oh l"><h3 class="bd b gy z fp of fr fs og fu fw dk translated">Vald简介:云原生向量搜索引擎</h3></div><div class="oi l"><p class="bd b dl z fp of fr fs og fu fw dk translated">medium.com</p></div></div><div class="oj l"><div class="or l ol om on oj oo jw oa"/></div></div></a></div><div class="nx ny gp gr nz oa"><a href="https://vdaas-vald.medium.com/a-new-world-created-by-similar-search-cases-where-vald-can-be-used-15c768e49bb" rel="noopener follow" target="_blank"><div class="ob ab fo"><div class="oc ab od cl cj oe"><h2 class="bd ir gy z fp of fr fs og fu fw ip bi translated">相似搜索创造的新世界:可以使用Vald的案例。</h2><div class="oh l"><h3 class="bd b gy z fp of fr fs og fu fw dk translated">你用Vald做什么？:案例和案例研究</h3></div><div class="oi l"><p class="bd b dl z fp of fr fs og fu fw dk translated">vdaas-vald.medium.com</p></div></div><div class="oj l"><div class="os l ol om on oj oo jw oa"/></div></div></a></div><div class="nx ny gp gr nz oa"><a href="https://vdaas-vald.medium.com/a-super-easy-way-to-try-similarity-search-using-vald-88fd7e8b87e9" rel="noopener follow" target="_blank"><div class="ob ab fo"><div class="oc ab od cl cj oe"><h2 class="bd ir gy z fp of fr fs og fu fw ip bi translated">使用Vald尝试相似性搜索的一个超级简单的方法</h2><div class="oh l"><h3 class="bd b gy z fp of fr fs og fu fw dk translated">如何在5分钟内在k3d上部署Vald</h3></div><div class="oi l"><p class="bd b dl z fp of fr fs og fu fw dk translated">vdaas-vald.medium.com</p></div></div><div class="oj l"><div class="ot l ol om on oj oo jw oa"/></div></div></a></div></div></div>    
</body>
</html>