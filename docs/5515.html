<html>
<head>
<title>Keycloak OIDC Identity Provider for OpenShift</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用于OpenShift的Keycloak OIDC身份提供程序</h1>
<blockquote>原文：<a href="https://itnext.io/keycloak-oidc-identity-provider-for-openshift-156a2ae75b9c?source=collection_archive---------3-----------------------#2021-03-21">https://itnext.io/keycloak-oidc-identity-provider-for-openshift-156a2ae75b9c?source=collection_archive---------3-----------------------#2021-03-21</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><figure class="gl gn jr js jt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi jq"><img src="../Images/d032e8f8d1ef255c5466c187b15a7eec.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*YcQyMHry0vNCAAs2.jpg"/></div></div></figure><p id="1a5f" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">让我们探索一下如何集成一个OpenID Connect (OIDC)实现keycloak，作为OpenShift的身份提供者，而不是常见的HTTPasswd、LDAP。</p><h2 id="48f4" class="kz la it bd lb lc ld dn le lf lg dp lh km li lj lk kq ll lm ln ku lo lp lq lr bi translated">OpenShift上的设置键锁</h2><p id="268a" class="pw-post-body-paragraph kb kc it kd b ke ls kg kh ki lt kk kl km lu ko kp kq lv ks kt ku lw kw kx ky im bi translated">从OperatorHub安装Keycloak操作符，在keycloak的名称空间中创建一个keycloak实例。一旦pod运行，我们就可以访问管理web界面。从名称空间中相应的Secret对象获取admin用户及其密码。</p><p id="4a9e" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">创造我们自己的境界，<code class="fe lx ly lz ma b">myrealm</code>，第一。</p><p id="d325" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">其次，创建名为<code class="fe lx ly lz ma b">idp-4-ocp</code>的客户端。在“设置”选项卡中，将“访问类型”选择为“机密”。出于测试目的，将“验证重定向URIs”设置为“https://*”。保存后，您将看到凭据选项卡。记录为此客户端创建的密码，例如<code class="fe lx ly lz ma b">909e58f1-d373–4af3-ab65-de073a54322a</code></p><p id="88f8" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">创建一个测试用户ocpuser，在credential选项卡中设置密码。</p><h2 id="db62" class="kz la it bd lb lc ld dn le lf lg dp lh km li lj lk kq ll lm ln ku lo lp lq lr bi translated">创建OIDC身份提供者</h2><p id="a1af" class="pw-post-body-paragraph kb kc it kd b ke ls kg kh ki lt kk kl km lu ko kp kq lv ks kt ku lw kw kx ky im bi translated">首先，使用上一步中记录的值在<code class="fe lx ly lz ma b">openshift-config</code>名称空间中创建一个客户机秘密。</p><pre class="mb mc md me gt mf ma mg mh aw mi bi"><span id="5114" class="kz la it ma b gy mj mk l ml mm">oc -n openshift-config create secret generic keycloak-client-secret --from-literal=clientSecret=<!-- -->909e58f1-d373–4af3-ab65-de073a54322a</span></pre><p id="7b1f" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">现在捕获用于kyecloak https访问的CA证书。在操作员版本中，创建了一条OpenShift路线。为了让身份提供者信任此路由中使用的证书，我们需要提取CA并将其添加到提供者的配置中。路由的证书由route-ca签名，提取出来并保存为文件。</p><pre class="mb mc md me gt mf ma mg mh aw mi bi"><span id="32d4" class="kz la it ma b gy mj mk l ml mm">oc -n openshift-ingress-operator get secret router-ca -o jsonpath="{ .data.tls\.crt }" | base64 -d -i &gt; ca.crt</span></pre><p id="0908" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">在<code class="fe lx ly lz ma b">openshift-config</code>名称空间中创建一个配置映射，</p><pre class="mb mc md me gt mf ma mg mh aw mi bi"><span id="749a" class="kz la it ma b gy mj mk l ml mm">oc -n openshift-config create cm keycloak-ca --from-file=ca.crt</span></pre><p id="7474" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">请注意，密钥是文件名ca.crt。</p><p id="9372" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">最后，我们可以在oauth集群配置中添加新的身份提供者。我已经有了HTPasswd ID提供程序。添加如下的keycloak OpenID定义，</p><pre class="mb mc md me gt mf ma mg mh aw mi bi"><span id="fe85" class="kz la it ma b gy mj mk l ml mm">apiVersion: config.openshift.io/v1<br/>kind: OAuth<br/>metadata:<br/>  name: cluster<br/>spec:<br/>  identityProviders:<br/>  - htpasswd:<br/>    ....</span><span id="0480" class="kz la it ma b gy mn mk l ml mm">  - name: keycloak <br/>    mappingMethod: claim <br/>    type: OpenID<br/>    openID:<br/>      clientID: idp-4-ocp<br/>      clientSecret:<br/>        name: <strong class="ma iu">keycloak-client-secret</strong><br/>      ca:<br/>        name: <strong class="ma iu">keycloak-ca</strong><br/>      claims: <br/>        preferredUsername:<br/>        - preferred_username<br/>        name:<br/>        - name<br/>        email:<br/>        - email<br/>      issuer: https://keycloak-keycloak.apps.dev-ocp47.ibmcloud.io.cpak/auth/realms/myrealm</span></pre><p id="0c3b" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">注意发布者是下面这个命名的https:// <router url=""> /auth/realms/ <realm name=""/></router></p><h2 id="a848" class="kz la it bd lb lc ld dn le lf lg dp lh km li lj lk kq ll lm ln ku lo lp lq lr bi translated">使用Keycloak身份验证登录</h2><p id="61ec" class="pw-post-body-paragraph kb kc it kd b ke ls kg kh ki lt kk kl km lu ko kp kq lv ks kt ku lw kw kx ky im bi translated">再次确认open shift-authentic ation-operator和key-cover的pod日志中没有错误。</p><p id="4193" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">现在登录到OpenShift Web控制台，</p><figure class="mb mc md me gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi mo"><img src="../Images/93b1d68279a9fd86ed782b8241eed032.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*KXNuR4LzccliHgJ_t4R6Rw.png"/></div></div></figure><p id="eb18" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">选择keycloak，弹出Keycloak的登录页面，</p><figure class="mb mc md me gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi mp"><img src="../Images/e2a20482ac62a66632135f23cf342b2f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*dlu4GCt5kFzguaQVTGFl-w.png"/></div></div></figure><p id="9a37" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">使用ocpuser及其密码登录，默认的OCP页面出现</p><figure class="mb mc md me gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi mq"><img src="../Images/2aca10272628b9671916ec002ea7081d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*93xTdVbxk8QRZwq--_tpxQ.png"/></div></div></figure><p id="846b" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">这样，您可以使用oc命令进一步分配权限。</p><p id="8752" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated"><strong class="kd iu"> <em class="mr">一些小技巧:</em> </strong></p><p id="6791" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">检查open shift-authentic ation-operator和keycloak的pod日志，以调试OCP和keycloak之间的集成。</p><p id="dde9" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">检查openshift-authentication名称空间下的pod，以了解用户登录问题。</p><p id="8fa5" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">为了使验证URL更紧密，可以基于从上面的测试中捕获的重定向URL，使用以下内容更新URL。</p><pre class="mb mc md me gt mf ma mg mh aw mi bi"><span id="d12c" class="kz la it ma b gy mj mk l ml mm">https://keycloak-keycloak.apps.dev-ocp47.ibmcloud.io.cpak/auth/realms/myrealm/protocol/openid-connect/auth?client_id=idp-4-ocp&amp;redirect_uri=https%3A%2F%2Foauth-openshift.apps.dev-ocp47.ibmcloud.io.cpak%2Foauth2callback%2Fkeycloak&amp;response_type=code&amp;scope=openid&amp;state=Y3NyZ...</span></pre><figure class="mb mc md me gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi ms"><img src="../Images/ee04b7337468b98d314284c90bb4049c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*MS-f8TK_F9gP86VF8i3byQ.png"/></div></div></figure></div></div>    
</body>
</html>