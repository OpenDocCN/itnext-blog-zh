<html>
<head>
<title>How to connect to Azure Event Hubs for Kafka using Go</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何使用Go连接到Kafka的Azure事件中心</h1>
<blockquote>原文：<a href="https://itnext.io/how-to-connect-to-azure-event-hubs-for-kafka-using-go-3957f8d98d6e?source=collection_archive---------3-----------------------#2019-10-10">https://itnext.io/how-to-connect-to-azure-event-hubs-for-kafka-using-go-3957f8d98d6e?source=collection_archive---------3-----------------------#2019-10-10</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="de15" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这个博客将展示如何使用<a class="ae kl" href="https://github.com/Shopify/sarama" rel="noopener ugc nofollow" target="_blank"> Sarama Kafka客户端</a>库与<a class="ae kl" href="https://docs.microsoft.com/azure/event-hubs/event-hubs-for-kafka-ecosystem-overview?WT.mc_id=medium-blog-abhishgu" rel="noopener ugc nofollow" target="_blank">事件中心Kafka </a>集群进行交互。<code class="fe km kn ko kp b"><a class="ae kl" href="https://godoc.org/github.com/Shopify/sarama" rel="noopener ugc nofollow" target="_blank">sarama</a></code> <a class="ae kl" href="https://godoc.org/github.com/Shopify/sarama" rel="noopener ugc nofollow" target="_blank">包</a>提供支持Kafka v 0.8及以上版本的纯Go客户端。</p><figure class="kr ks kt ku gt kv gh gi paragraph-image"><div role="button" tabindex="0" class="kw kx di ky bf kz"><div class="gh gi kq"><img src="../Images/4f36de83364040de2408fec2ee20e880.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*qRB923ojGtgXcditCBWvJQ.jpeg"/></div></div></figure><p id="0b8c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><a class="ae kl" href="https://docs.microsoft.com/azure/event-hubs/?WT.mc_id=medium-blog-abhishgu" rel="noopener ugc nofollow" target="_blank"> Azure Event Hubs </a>是一个流媒体平台和事件摄取服务，每秒能够接收和处理数百万个事件。它还提供了一个Kafka端点，您现有的基于Kafka的应用程序可以使用它作为运行您自己的Kafka集群的替代方法。由于Azure Event Hubs公开了一个与Kafka 1.0版二进制兼容的协议，所以您可以从现有的应用程序中开始使用Kafka端点，而无需更改代码，只需进行最小的配置更改。这也支持像<a class="ae kl" href="https://kafka.apache.org/documentation/#connect" rel="noopener ugc nofollow" target="_blank"> Kafka Connect </a>(目前在预览版中)、<a class="ae kl" href="https://kafka.apache.org/documentation/#basic_ops_mirror_maker" rel="noopener ugc nofollow" target="_blank"> MirrorMaker </a>等框架。</p><p id="8d37" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">您将了解到:</p><ul class=""><li id="95c1" class="lc ld iq jp b jq jr ju jv jy le kc lf kg lg kk lh li lj lk bi translated">代码:如何配置和使用Sarama Go客户端与事件中心Kafka endpoint对话，并构建生产者、消费者应用程序</li><li id="e899" class="lc ld iq jp b jq ll ju lm jy ln kc lo kg lp kk lh li lj lk bi translated">设置:使用Azure CLI快速引导Kafka实例的事件中心</li><li id="5552" class="lc ld iq jp b jq ll ju lm jy ln kc lo kg lp kk lh li lj lk bi translated">测试:运行生产者和消费者应用程序，尝试端到端场景</li></ul><blockquote class="lq lr ls"><p id="0146" class="jn jo lt jp b jq jr js jt ju jv jw jx lu jz ka kb lv kd ke kf lw kh ki kj kk ij bi translated"><em class="iq">一如既往，代码在</em> <a class="ae kl" href="https://github.com/abhirockzz/eventhubs-kafka-go-sarama" rel="noopener ugc nofollow" target="_blank"> <em class="iq"> GitHub </em> </a>上可用</p></blockquote><h1 id="344d" class="lx ly iq bd lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp mq mr ms mt mu bi translated">先决条件</h1><p id="ff29" class="pw-post-body-paragraph jn jo iq jp b jq mv js jt ju mw jw jx jy mx ka kb kc my ke kf kg mz ki kj kk ij bi translated">如果你没有Azure订阅，只需创建一个<a class="ae kl" href="https://azure.microsoft.com/free/?WT.mc_id=medium-blog-abhishgu" rel="noopener ugc nofollow" target="_blank">免费帐户</a>就可以开始了！你还需要T21的Azure命令行界面。当然，你还需要安装<a class="ae kl" href="https://golang.org/doc/install" rel="noopener ugc nofollow" target="_blank"> Go和</a>。</p></div><div class="ab cl na nb hu nc" role="separator"><span class="nd bw bk ne nf ng"/><span class="nd bw bk ne nf ng"/><span class="nd bw bk ne nf"/></div><div class="ij ik il im in"><h1 id="7d7e" class="lx ly iq bd lz ma nh mc md me ni mg mh mi nj mk ml mm nk mo mp mq nl ms mt mu bi translated">代码走查</h1><p id="6ed3" class="pw-post-body-paragraph jn jo iq jp b jq mv js jt ju mw jw jx jy mx ka kb kc my ke kf kg mz ki kj kk ij bi translated">该应用程序非常简单，由使用Sarama Go客户端构建的生产者和消费者组成。让我们快速浏览一下代码</p><figure class="kr ks kt ku gt kv gh gi paragraph-image"><div class="gh gi nm"><img src="../Images/f0217df3d9384d6ea1234995019a57e6.png" data-original-src="https://miro.medium.com/v2/resize:fit:476/0*IZU2OGmoSeE-Gb3a.gif"/></div></figure><h2 id="bd88" class="nn ly iq bd lz no np dn md nq nr dp mh jy ns nt ml kc nu nv mp kg nw nx mt ny bi translated">用于连接到Kafka事件中心的配置</h2><p id="dea4" class="pw-post-body-paragraph jn jo iq jp b jq mv js jt ju mw jw jx jy mx ka kb kc my ke kf kg mz ki kj kk ij bi translated">为了创建生产者或消费者实例，您需要传递一个<code class="fe km kn ko kp b">sarama.Config</code>对象。</p><pre class="kr ks kt ku gt nz kp oa ob aw oc bi"><span id="e014" class="nn ly iq kp b gy od oe l of og">func getConfig() *sarama.Config {<br/>    config := sarama.NewConfig()<br/>    config.Net.DialTimeout = 10 * time.Second<br/>    config.Net.SASL.Enable = true<br/>    config.Net.SASL.User = "$ConnectionString"<br/>    config.Net.SASL.Password = getEnv(eventHubsConnStringEnvVar)<br/>    config.Net.SASL.Mechanism = "PLAIN"</span><span id="5ec2" class="nn ly iq kp b gy oh oe l of og">    config.Net.TLS.Enable = true<br/>    config.Net.TLS.Config = &amp;tls.Config{<br/>        InsecureSkipVerify: true,<br/>        ClientAuth:         0,<br/>    }<br/>    config.Version = sarama.V1_0_0_0</span><span id="0f15" class="nn ly iq kp b gy oh oe l of og">    return config<br/>}</span></pre><p id="1510" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">身份验证是这里的关键——Azure Event Hubs(包括Kafka特性)要求所有通信都使用SSL或TLS，并使用共享访问签名(SAS)进行身份验证。</p><blockquote class="lq lr ls"><p id="5eb6" class="jn jo lt jp b jq jr js jt ju jv jw jx lu jz ka kb lv kd ke kf lw kh ki kj kk ij bi translated"><em class="iq">关于安全模型</em>的详细信息，请参见 <a class="ae kl" href="https://docs.microsoft.com/en-us/azure/event-hubs/event-hubs-authentication-and-security-model-overview?WT.mc_id=medium-blog-abhishgu" rel="noopener ugc nofollow" target="_blank"> <em class="iq">文档</em> </a> <em class="iq"/></p></blockquote><ul class=""><li id="a1ed" class="lc ld iq jp b jq jr ju jv jy le kc lf kg lg kk lh li lj lk bi translated">SASL通过<code class="fe km kn ko kp b">config.Net.SASL.Enable = true</code>启用，并使用<code class="fe km kn ko kp b">PLAIN</code>机制(配置。Net.SASL.Mechanism)</li><li id="da1f" class="lc ld iq jp b jq ll ju lm jy ln kc lo kg lp kk lh li lj lk bi translated">使用<code class="fe km kn ko kp b">config.Net.SASL.User</code>定义SASL用户，并设置为<code class="fe km kn ko kp b">$ConnectionString</code>(是的，这是静态的)</li><li id="0f9d" class="lc ld iq jp b jq ll ju lm jy ln kc lo kg lp kk lh li lj lk bi translated">SASL密码(<code class="fe km kn ko kp b">config.Net.SASL.Password</code>)被设置为事件集线器连接字符串(详情见下一节)</li><li id="31bb" class="lc ld iq jp b jq ll ju lm jy ln kc lo kg lp kk lh li lj lk bi translated">最后，TLS被启用(<code class="fe km kn ko kp b">config.Net.TLS.Enable</code>)并且<code class="fe km kn ko kp b">config.Net.TLS.Config</code>被设置为<a class="ae kl" href="https://godoc.org/crypto/tls#Config" rel="noopener ugc nofollow" target="_blank"> TLS配置</a>的实例</li></ul><blockquote class="lq lr ls"><p id="9b24" class="jn jo lt jp b jq jr js jt ju jv jw jx lu jz ka kb lv kd ke kf lw kh ki kj kk ij bi translated"><em class="iq">除了</em> <code class="fe km kn ko kp b"><em class="iq">config.Producer.Return.Successes = true</em></code> <em class="iq">是生产者</em>的同步版本所必需的之外，生产者和消费者(对于本例)的配置是相同的</p></blockquote><p id="e61f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">需要注意的事项:</p><ul class=""><li id="655a" class="lc ld iq jp b jq jr ju jv jy le kc lf kg lg kk lh li lj lk bi translated">如果没有正确配置TLS，您可能会看到这个错误— <code class="fe km kn ko kp b">Failed to start Sarama producer: kafka: client has run out of available brokers to talk to (Is your cluster reachable?)</code></li><li id="27bb" class="lc ld iq jp b jq ll ju lm jy ln kc lo kg lp kk lh li lj lk bi translated">在撰写本文时，<a class="ae kl" href="https://docs.microsoft.com/azure/event-hubs/event-hubs-for-kafka-ecosystem-overview?WT.mc_id=medium-blog-abhishgu#features-that-are-not-yet-supported" rel="noopener ugc nofollow" target="_blank"> Event Hubs不支持消息压缩</a>，因此请确保使用默认值<code class="fe km kn ko kp b">config.Producer.Compression</code>(即<code class="fe km kn ko kp b">none</code>)或使用<code class="fe km kn ko kp b">config.Producer.Compression = sarama.CompressionNone</code>显式设置它。否则，您可能会看到此错误<code class="fe km kn ko kp b">Failed to send msg: kafka server: The requested operation is not supported by the message format version.</code></li><li id="3247" class="lc ld iq jp b jq ll ju lm jy ln kc lo kg lp kk lh li lj lk bi translated">确保将Kafka broker版本设置为<code class="fe km kn ko kp b">config.Version = sarama.V1_0_0_0</code>或更高版本</li></ul><h2 id="2f8f" class="nn ly iq bd lz no np dn md nq nr dp mh jy ns nt ml kc nu nv mp kg nw nx mt ny bi translated">活动中心卡夫卡制作人</h2><p id="f4e7" class="pw-post-body-paragraph jn jo iq jp b jq mv js jt ju mw jw jx jy mx ka kb kc my ke kf kg mz ki kj kk ij bi translated">创建一个生产者实例，传入事件中心代理和所需的配置(<code class="fe km kn ko kp b">sarama.Config</code>)</p><pre class="kr ks kt ku gt nz kp oa ob aw oc bi"><span id="91c2" class="nn ly iq kp b gy od oe l of og">producer, err := sarama.NewSyncProducer(brokerList, getConfig())<br/>if err != nil {<br/>	fmt.Println("Failed to start Sarama producer:", err)<br/>	os.Exit(1)<br/>}</span></pre><p id="0c4e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">启动用于生成消息的goroutine。这发生在一个无限for循环中，可以使用<code class="fe km kn ko kp b">ctrl+c</code>停止</p><pre class="kr ks kt ku gt nz kp oa ob aw oc bi"><span id="ca7d" class="nn ly iq kp b gy od oe l of og">go func() {<br/>	for {<br/>		if producerOpen {<br/>			ts := time.Now().String()<br/>			msg := &amp;sarama.ProducerMessage{Topic: eventHubsTopic, Key: sarama.StringEncoder("key-" + ts), Value: sarama.StringEncoder("value-" + ts)}<br/>			p, o, err := producer.SendMessage(msg)<br/>			if err != nil {<br/>				fmt.Println("Failed to send msg:", err)<br/>				continue<br/>			}<br/>		}<br/>		...<br/>	}<br/>}()</span></pre><p id="cfd6" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">为了干净地退出，监听中断信号(<code class="fe km kn ko kp b">ctrl+c</code>)并关闭发生器</p><pre class="kr ks kt ku gt nz kp oa ob aw oc bi"><span id="7621" class="nn ly iq kp b gy od oe l of og">close := make(chan os.Signal)<br/>signal.Notify(close, syscall.SIGTERM, syscall.SIGINT)<br/>&lt;-close<br/>err = producer.Close()</span></pre><h2 id="3124" class="nn ly iq bd lz no np dn md nq nr dp mh jy ns nt ml kc nu nv mp kg nw nx mt ny bi translated">活动中心Kafka消费者</h2><p id="f615" class="pw-post-body-paragraph jn jo iq jp b jq mv js jt ju mw jw jx jy mx ka kb kc my ke kf kg mz ki kj kk ij bi translated">创建一个传入事件中心代理的消费者组实例</p><pre class="kr ks kt ku gt nz kp oa ob aw oc bi"><span id="220f" class="nn ly iq kp b gy od oe l of og">consumer, err := sarama.NewConsumerGroup(brokerList, consumerGroupID, getConfig())</span></pre><p id="a889" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">开始在单独的goroutine消费</p><pre class="kr ks kt ku gt nz kp oa ob aw oc bi"><span id="46f6" class="nn ly iq kp b gy od oe l of og">go func() {<br/>	for {<br/>		err = consumer.Consume(ctx, []string{getEnv(eventHubsTopicEnvVar)}, messageHandler{})<br/>		....<br/>		if ctx.Err() != nil {<br/>			return<br/>		}<br/>	}<br/>}()</span></pre><p id="4811" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><code class="fe km kn ko kp b">messageHandler</code>实现<code class="fe km kn ko kp b"><a class="ae kl" href="https://godoc.org/github.com/Shopify/sarama#ConsumerGroupHandler" rel="noopener ugc nofollow" target="_blank">sarama.ConsumerGroupHandler</a></code>(功能- <code class="fe km kn ko kp b">Setup</code>、<code class="fe km kn ko kp b">Cleanup</code>、<code class="fe km kn ko kp b">ConsumeClaim</code>)。<code class="fe km kn ko kp b">ConsumeClaim</code>功能是重要的一项。您可以在这里指定如何处理每条消息——在本例中，它被记录到标准输出，并被标记为已使用</p><pre class="kr ks kt ku gt nz kp oa ob aw oc bi"><span id="d63e" class="nn ly iq kp b gy od oe l of og">func (h messageHandler) ConsumeClaim(s sarama.ConsumerGroupSession, c sarama.ConsumerGroupClaim) error {<br/>    for msg := range c.Messages() {<br/>        fmt.Printf("Message topic:%q partition:%d offset:%d\n", msg.Topic, msg.Partition, msg.Offset)<br/>        fmt.Println("Message content", string(msg.Value))<br/>        s.MarkMessage(msg, "")<br/>    }<br/>    return nil<br/>}</span></pre><p id="3d27" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">可通过退出程序(按下<code class="fe km kn ko kp b">ctrl+c</code>)停止用户。对于干净退出，使用者实例被关闭</p><pre class="kr ks kt ku gt nz kp oa ob aw oc bi"><span id="d5a2" class="nn ly iq kp b gy od oe l of og">close := make(chan os.Signal)<br/>signal.Notify(close, syscall.SIGTERM, syscall.SIGINT)<br/>&lt;-close<br/>cancel()<br/>if err := consumer.Close(); err != nil {<br/>    ......<br/>}</span></pre><p id="9e7e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">好了，让我们创建一个事件中心集群，并尝试端到端场景。</p></div><div class="ab cl na nb hu nc" role="separator"><span class="nd bw bk ne nf ng"/><span class="nd bw bk ne nf ng"/><span class="nd bw bk ne nf"/></div><div class="ij ik il im in"><h1 id="e5fb" class="lx ly iq bd lz ma nh mc md me ni mg mh mi nj mk ml mm nk mo mp mq nl ms mt mu bi translated">创建您的Kafka活动中心集群</h1><p id="4a80" class="pw-post-body-paragraph jn jo iq jp b jq mv js jt ju mw jw jx jy mx ka kb kc my ke kf kg mz ki kj kk ij bi translated">如果您已经有一个集群，请跳过这一步，转到<em class="lt">“事件中心连接详细信息”</em>小节</p><p id="12da" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">设置环境变量:</p><pre class="kr ks kt ku gt nz kp oa ob aw oc bi"><span id="3452" class="nn ly iq kp b gy od oe l of og">export AZURE_SUBSCRIPTION=[to be filled]<br/>export AZURE_RESOURCE_GROUP=[to be filled]<br/>export AZURE_LOCATION=[to be filled]<br/>export EVENT_HUBS_NAMESPACE=[name of the event hub namespace - to be filled]<br/>export EVENT_HUB_NAME=[name of the event hub (topic) - to be filled]</span></pre><p id="4af6" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果还没有资源组，请创建一个</p><pre class="kr ks kt ku gt nz kp oa ob aw oc bi"><span id="52e2" class="nn ly iq kp b gy od oe l of og">az account set --subscription $AZURE_SUBSCRIPTION<br/>az group create --name $AZURE_RESOURCE_GROUP --location $AZURE_LOCATION</span></pre><p id="c28d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">创建一个事件中心名称空间(类似于Kafka集群)</p><blockquote class="lq lr ls"><p id="e4c3" class="jn jo lt jp b jq jr js jt ju jv jw jx lu jz ka kb lv kd ke kf lw kh ki kj kk ij bi translated"><em class="iq">关于事件中枢命名空间的详细信息，请参见</em> <a class="ae kl" href="https://docs.microsoft.com/azure/event-hubs/event-hubs-features?WT.mc_id=medium-blog-abhishgu" rel="noopener ugc nofollow" target="_blank"> <em class="iq">事件中枢文档</em> </a></p></blockquote><pre class="kr ks kt ku gt nz kp oa ob aw oc bi"><span id="c863" class="nn ly iq kp b gy od oe l of og">az eventhubs namespace create --name $EVENT_HUBS_NAMESPACE --resource-group $AZURE_RESOURCE_GROUP --location $AZURE_LOCATION --enable-kafka true --enable-auto-inflate false</span></pre><blockquote class="lq lr ls"><p id="84fb" class="jn jo lt jp b jq jr js jt ju jv jw jx lu jz ka kb lv kd ke kf lw kh ki kj kk ij bi translated"><em class="iq">文档为</em> <code class="fe km kn ko kp b"><a class="ae kl" href="https://docs.microsoft.com/cli/azure/eventhubs/namespace?view=azure-cli-latest&amp;WT.mc_id=medium-blog-abhishgu#az-eventhubs-namespace-create" rel="noopener ugc nofollow" target="_blank"><em class="iq">az eventhubs namespace create</em></a></code></p></blockquote><p id="5460" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">然后创建一个事件中心(与Kafka主题相同)</p><pre class="kr ks kt ku gt nz kp oa ob aw oc bi"><span id="e9fd" class="nn ly iq kp b gy od oe l of og">az eventhubs eventhub create --name $EVENT_HUB_NAME --resource-group $AZURE_RESOURCE_GROUP --namespace-name $EVENT_HUBS_NAMESPACE --partition-count 10</span></pre><blockquote class="lq lr ls"><p id="cfcd" class="jn jo lt jp b jq jr js jt ju jv jw jx lu jz ka kb lv kd ke kf lw kh ki kj kk ij bi translated"><em class="iq">文档</em>文档<code class="fe km kn ko kp b"><a class="ae kl" href="https://docs.microsoft.com/cli/azure/eventhubs/eventhub?view=azure-cli-latest&amp;WT.mc_id=medium-blog-abhishgu#az-eventhubs-eventhub-create" rel="noopener ugc nofollow" target="_blank"><em class="iq">az eventhub create</em></a></code></p></blockquote><h2 id="cc11" class="nn ly iq bd lz no np dn md nq nr dp mh jy ns nt ml kc nu nv mp kg nw nx mt ny bi translated">活动中心连接详情</h2><p id="9962" class="pw-post-body-paragraph jn jo iq jp b jq mv js jt ju mw jw jx jy mx ka kb kc my ke kf kg mz ki kj kk ij bi translated">获取集群的连接字符串和凭据</p><blockquote class="lq lr ls"><p id="65f9" class="jn jo lt jp b jq jr js jt ju jv jw jx lu jz ka kb lv kd ke kf lw kh ki kj kk ij bi translated"><em class="iq">有关详细信息，请阅读</em> <a class="ae kl" href="https://docs.microsoft.com/azure/event-hubs/authorize-access-shared-access-signature?WT.mc_id=medium-blog-abhishgu" rel="noopener ugc nofollow" target="_blank"> <em class="iq">事件中心如何使用共享访问签名进行授权</em> </a></p></blockquote><p id="c125" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">首先获取事件中心规则/策略名称</p><pre class="kr ks kt ku gt nz kp oa ob aw oc bi"><span id="479e" class="nn ly iq kp b gy od oe l of og">az eventhubs namespace authorization-rule list --resource-group $AZURE_RESOURCE_GROUP --namespace-name $EVENT_HUBS_NAMESPACE</span></pre><blockquote class="lq lr ls"><p id="a06c" class="jn jo lt jp b jq jr js jt ju jv jw jx lu jz ka kb lv kd ke kf lw kh ki kj kk ij bi translated"><em class="iq">文档为</em> <code class="fe km kn ko kp b"><a class="ae kl" href="https://docs.microsoft.com/cli/azure/eventhubs/namespace/authorization-rule?view=azure-cli-latest&amp;WT.mc_id=medium-blog-abhishgu#az-eventhubs-namespace-authorization-rule-list" rel="noopener ugc nofollow" target="_blank"><em class="iq">az eventhubs namespace authorization-rule list</em></a></code></p></blockquote><p id="df7f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">您将得到类似下面的JSON输出:</p><pre class="kr ks kt ku gt nz kp oa ob aw oc bi"><span id="c9c1" class="nn ly iq kp b gy od oe l of og">[<br/>    {<br/>        "id": "/subscriptions/qwerty42-ae29-4924-b6a7-dda0ea91d347/resourceGroups/foobar-resource/providers/Microsoft.EventHub/namespaces/foobar-event-hub-ns/AuthorizationRules/RootManageSharedAccessKey",<br/>        "location": "Southeast Asia",<br/><strong class="kp ir">        "name": "RootManageSharedAccessKey",<br/></strong>        "resourceGroup": "foobar-resource",<br/>        "rights": [<br/>        "Listen",<br/>        "Manage",<br/>        "Send"<br/>        ],<br/>        "type": "Microsoft.EventHub/Namespaces/AuthorizationRules"<br/>    }<br/>]</span></pre><p id="1495" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">授权规则名称是<code class="fe km kn ko kp b">name</code>属性的值(没有引号)，在本例中是<code class="fe km kn ko kp b">RootManageSharedAccessKey</code></p><pre class="kr ks kt ku gt nz kp oa ob aw oc bi"><span id="8f56" class="nn ly iq kp b gy od oe l of og">export EVENT_HUB_AUTH_RULE_NAME=RootManageSharedAccessKey</span></pre><p id="1290" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">然后，利用规则名提取连接字符串</p><pre class="kr ks kt ku gt nz kp oa ob aw oc bi"><span id="3fe4" class="nn ly iq kp b gy od oe l of og">az eventhubs namespace authorization-rule keys list --resource-group $AZURE_RESOURCE_GROUP --namespace-name $EVENT_HUBS_NAMESPACE --name $EVENT_HUB_AUTH_RULE_NAME</span></pre><blockquote class="lq lr ls"><p id="d225" class="jn jo lt jp b jq jr js jt ju jv jw jx lu jz ka kb lv kd ke kf lw kh ki kj kk ij bi translated"><em class="iq">文档</em>T3】</p></blockquote><p id="1d1a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">您将得到如下JSON响应:</p><pre class="kr ks kt ku gt nz kp oa ob aw oc bi"><span id="2a16" class="nn ly iq kp b gy od oe l of og">{<br/>    "aliasPrimaryConnectionString": null,<br/>    "aliasSecondaryConnectionString": null,<br/>    "keyName": "RootManageSharedAccessKey",<br/><strong class="kp ir">    "primaryConnectionString": "Endpoint=sb://foobar-eventhub-namespace.servicebus.windows.net/;SharedAccessKeyName=RootManageSharedAccessKey;SharedAccessKey=Nbaz0D42MT7qwerty6D/W51ao42r6EJuxR/zEqwerty=",<br/></strong>    "primaryKey": "qwertyEiQHIirSNDPzqcqvZEUs6VAW+JIK3L46tqwerty",<br/>    "secondaryConnectionString": "Endpoint=sb://abhishgu-temp-event-hub-ns.servicebus.windows.net/;SharedAccessKeyName=RootManageSharedAccessKey;SharedAccessKey=qwertyPF2/YRGzxKmb06Z8NBFLCjnX38O7ch6aiYkN0=",<br/>    "secondaryKey": "qwertyPF2/YRGzxKmb06Z8NBqwertyX38O7ch6aiYk42="<br/>}</span></pre><p id="d9da" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">主连接字符串是<code class="fe km kn ko kp b">primaryConnectionString</code>属性的值(没有引号)，在本例中是<code class="fe km kn ko kp b">"Endpoint=sb://foobar-eventhub-namespace.servicebus.windows.net/;SharedAccessKeyName=RootManageSharedAccessKey;SharedAccessKey=Nbaz0D42MT7qwerty6D/W51ao42r6EJuxR/zEqwerty="</code>。记下连接字符串，因为您将在下一步中使用它。</p><blockquote class="lq lr ls"><p id="4a4a" class="jn jo lt jp b jq jr js jt ju jv jw jx lu jz ka kb lv kd ke kf lw kh ki kj kk ij bi translated"><a class="ae kl" href="https://docs.microsoft.com/azure/event-hubs/authorize-access-shared-access-signature?&amp;WT.mc_id=medium-blog-abhishgu#best-practices-when-using-sas" rel="noopener ugc nofollow" target="_blank"> <em class="iq">此信息较为敏感，请谨慎</em> </a></p></blockquote></div><div class="ab cl na nb hu nc" role="separator"><span class="nd bw bk ne nf ng"/><span class="nd bw bk ne nf ng"/><span class="nd bw bk ne nf"/></div><div class="ij ik il im in"><h1 id="7148" class="lx ly iq bd lz ma nh mc md me ni mg mh mi nj mk ml mm nk mo mp mq nl ms mt mu bi translated">测试生产者和消费者</h1><p id="cf8d" class="pw-post-body-paragraph jn jo iq jp b jq mv js jt ju mw jw jx jy mx ka kb kc my ke kf kg mz ki kj kk ij bi translated">克隆GitHub存储库并导航到正确的目录:</p><pre class="kr ks kt ku gt nz kp oa ob aw oc bi"><span id="1449" class="nn ly iq kp b gy od oe l of og">git clone https://github.com/abhirockzz/eventhubs-kafka-go-sarama<br/>cd eventhubs-kafka-go-sarama</span></pre><p id="2319" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">获取Sarama Kafka客户端库</p><pre class="kr ks kt ku gt nz kp oa ob aw oc bi"><span id="f3e4" class="nn ly iq kp b gy od oe l of og">go get github.com/Shopify/sarama</span></pre><h2 id="619d" class="nn ly iq bd lz no np dn md nq nr dp mh jy ns nt ml kc nu nv mp kg nw nx mt ny bi translated">生产者</h2><p id="7da0" class="pw-post-body-paragraph jn jo iq jp b jq mv js jt ju mw jw jx jy mx ka kb kc my ke kf kg mz ki kj kk ij bi translated">设置环境变量</p><pre class="kr ks kt ku gt nz kp oa ob aw oc bi"><span id="2f2c" class="nn ly iq kp b gy od oe l of og">export EVENTHUBS_CONNECTION_STRING=[value of primary connection string obtained in the previous step]<br/>export EVENT_HUBS_NAMESPACE=[event hub namespace]<br/>export EVENTHUBS_BROKER=$EVENT_HUBS_NAMESPACE.servicebus.windows.net:9093<br/>export EVENTHUBS_TOPIC=[name of the event hub (topic)]</span></pre><blockquote class="lq lr ls"><p id="0d84" class="jn jo lt jp b jq jr js jt ju jv jw jx lu jz ka kb lv kd ke kf lw kh ki kj kk ij bi translated"><em class="iq">对于</em> <code class="fe km kn ko kp b"><em class="iq">EVENTHUBS_CONNECTION_STRING</em></code> <em class="iq">变量，请确保</em>在使用Azure CLI接收的值中包含<em class="iq">双引号，例如</em> <code class="fe km kn ko kp b"><em class="iq">export EVENTHUBS_CONNECTION_STRING="Endpoint=sb://foobar-eventhub-namespace.servicebus.windows.net/;SharedAccessKeyName=RootManageSharedAccessKey;SharedAccessKey=Nbaz0D42MT7qwerty6D/W51ao42r6EJuxR/zEqwerty="</em></code></p></blockquote><p id="5405" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">启动生成器</p><pre class="kr ks kt ku gt nz kp oa ob aw oc bi"><span id="79af" class="nn ly iq kp b gy od oe l of og">go run producer/sarama-producer.go</span></pre><p id="c678" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">一旦启动，您应该会看到日志</p><pre class="kr ks kt ku gt nz kp oa ob aw oc bi"><span id="791f" class="nn ly iq kp b gy od oe l of og">Event Hubs broker [foo-bar.servicebus.windows.net:9093]<br/>Event Hubs topic testhub<br/>Waiting for program to exit...<br/>sent message to partition 0 offset 1<br/>sent message to partition 7 offset 1<br/>sent message to partition 6 offset 1<br/>sent message to partition 8 offset 1<br/>sent message to partition 2 offset 1</span></pre><blockquote class="lq lr ls"><p id="7c05" class="jn jo lt jp b jq jr js jt ju jv jw jx lu jz ka kb lv kd ke kf lw kh ki kj kk ij bi translated"><em class="iq">要停止，只需按下终端</em>上的 <code class="fe km kn ko kp b"><em class="iq">ctrl+c</em></code> <em class="iq"/></p></blockquote><h2 id="d855" class="nn ly iq bd lz no np dn md nq nr dp mh jy ns nt ml kc nu nv mp kg nw nx mt ny bi translated">消费者</h2><p id="ef59" class="pw-post-body-paragraph jn jo iq jp b jq mv js jt ju mw jw jx jy mx ka kb kc my ke kf kg mz ki kj kk ij bi translated">在不同的终端中启动消费者进程。设置环境变量</p><pre class="kr ks kt ku gt nz kp oa ob aw oc bi"><span id="8621" class="nn ly iq kp b gy od oe l of og">export EVENTHUBS_CONNECTION_STRING=[value of primary connection string obtained in the previous step]<br/>export EVENT_HUBS_NAMESPACE=[event hub namespace]<br/>export EVENTHUBS_BROKER=$EVENT_HUBS_NAMESPACE.servicebus.windows.net:9093<br/>export EVENTHUBS_TOPIC=[name of the event hub (topic) - to be filled]<br/>export EVENTHUBS_CONSUMER_GROUPID=[name of consumer group e.g. testgroup]</span></pre><blockquote class="lq lr ls"><p id="6dd7" class="jn jo lt jp b jq jr js jt ju jv jw jx lu jz ka kb lv kd ke kf lw kh ki kj kk ij bi translated"><em class="iq">对于</em> <code class="fe km kn ko kp b"><em class="iq">EVENTHUBS_CONNECTION_STRING</em></code> <em class="iq">变量，请确保</em>在使用Azure CLI接收的值中包含<em class="iq">双引号，例如</em> <code class="fe km kn ko kp b"><em class="iq">export EVENTHUBS_CONNECTION_STRING="Endpoint=sb://foobar-eventhub-namespace.servicebus.windows.net/;SharedAccessKeyName=RootManageSharedAccessKey;SharedAccessKey=Nbaz0D42MT7qwerty6D/W51ao42r6EJuxR/zEqwerty="</em></code></p></blockquote><p id="5076" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">启动消费者</p><pre class="kr ks kt ku gt nz kp oa ob aw oc bi"><span id="e673" class="nn ly iq kp b gy od oe l of og">go run consumer/sarama-consumer.go</span></pre><p id="55c3" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在日志中，您将看到消费者组被创建，并且所有的分区(在这个例子中是10个)都被分配给它</p><pre class="kr ks kt ku gt nz kp oa ob aw oc bi"><span id="9c28" class="nn ly iq kp b gy od oe l of og">Event Hubs broker [foo-bar.servicebus.windows.net:9093]<br/>Sarama client consumer group ID testgroup<br/>new consumer group created<br/>Event Hubs topic testhub<br/>Waiting for program to exit<br/>Partition allocation - map[testhub:[0 1 2 3 4 5 6 7 8 9]]<br/>Message topic:"testhub" partition:9 offset:45<br/>Message content value-2019-10-08 16:12:23.704802 +0530 IST m=+1.003667284<br/>Message topic:"testhub" partition:3 offset:32<br/>Message content value-2019-10-08 17:05:42.388301 +0530 IST m=+0.912420074</span></pre><h2 id="fc1c" class="nn ly iq bd lz no np dn md nq nr dp mh jy ns nt ml kc nu nv mp kg nw nx mt ny bi translated">向外扩展…</h2><p id="62fa" class="pw-post-body-paragraph jn jo iq jp b jq mv js jt ju mw jw jx jy mx ka kb kc my ke kf kg mz ki kj kk ij bi translated">在不同的终端中，启动消费者的另一个实例。这将触发分区的重新平衡，您将看到很少(本例中为5个)分区被分配给这个(新的)消费者实例</p><pre class="kr ks kt ku gt nz kp oa ob aw oc bi"><span id="f9a5" class="nn ly iq kp b gy od oe l of og">Event Hubs broker [foo-bar.servicebus.windows.net:9093]<br/>Sarama client consumer group ID testgroup<br/>new consumer group created<br/>Event Hubs topic testhub<br/>Waiting for program to exit<br/>Partition allocation - map[testhub:[0 1 2 3 4]]</span></pre><p id="49e6" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果您返回到第一个消费者实例的终端，您会看到由于重新平衡，几乎没有分区被取走</p><pre class="kr ks kt ku gt nz kp oa ob aw oc bi"><span id="9185" class="nn ly iq kp b gy od oe l of og">Consumer group clean up initiated<br/>Partition allocation - map[testhub:[5 6 7 8 9]]</span></pre><blockquote class="lq lr ls"><p id="a7c3" class="jn jo lt jp b jq jr js jt ju jv jw jx lu jz ka kb lv kd ke kf lw kh ki kj kk ij bi translated"><em class="iq">要停止，只需按下终端</em>上的 <code class="fe km kn ko kp b"><em class="iq">ctrl+c</em></code> <em class="iq"/></p></blockquote><p id="90c0" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在，两个消费者都将分担工作负载，并使用来自事件中心的消息。您通过启动更多的消费者实例来保持向外扩展，但是这只有在消费者实例的数量等于分区的数量时才有用。本质上，Events Hub的分区数量是并行性和规模的单位。</p></div><div class="ab cl na nb hu nc" role="separator"><span class="nd bw bk ne nf ng"/><span class="nd bw bk ne nf ng"/><span class="nd bw bk ne nf"/></div><div class="ij ik il im in"><p id="39c6" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这个博客到此为止。我希望得到您的反馈和建议！不要害羞，只需<a class="ae kl" href="https://twitter.com/abhi_tweeter" rel="noopener ugc nofollow" target="_blank">发推文</a>或发表评论。如果你觉得这篇文章有用，请点赞并关注😃😃</p><figure class="kr ks kt ku gt kv"><div class="bz fp l di"><div class="oi oj l"/></div></figure></div></div>    
</body>
</html>