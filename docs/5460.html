<html>
<head>
<title>Reverse Engineering Bluetooth Devices</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">反向工程蓝牙设备</h1>
<blockquote>原文：<a href="https://itnext.io/reverse-engineering-bluetooth-devices-82d868edec0c?source=collection_archive---------3-----------------------#2021-03-11">https://itnext.io/reverse-engineering-bluetooth-devices-82d868edec0c?source=collection_archive---------3-----------------------#2021-03-11</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><h2 id="b543" class="ir is it bd b dl iu iv iw ix iy iz dk ja translated" aria-label="kicker paragraph">氧气和心率监测器被黑了</h2><div class=""/><div class=""><h2 id="6684" class="pw-subtitle-paragraph jz jc it bd b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq dk translated">核心蓝牙简介</h2></div><figure class="ks kt ku kv gt kw gh gi paragraph-image"><div role="button" tabindex="0" class="kx ky di kz bf la"><div class="gh gi kr"><img src="../Images/0cbee3d9953264fbfbd2e8eebb4869b7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*OvONYTj2Tg8T01VCVgGdFA.png"/></div></div></figure><p id="be83" class="pw-post-body-paragraph ld le it lf b lg lh kd li lj lk kg ll lm ln lo lp lq lr ls lt lu lv lw lx ly im bi translated">本教程将以心率和血氧监测仪为例，介绍如何从蓝牙设备中获取数据的一般方法。</p><p id="b0c2" class="pw-post-body-paragraph ld le it lf b lg lh kd li lj lk kg ll lm ln lo lp lq lr ls lt lu lv lw lx ly im bi translated">对于本教程，我使用:</p><ul class=""><li id="0551" class="lz ma it lf b lg lh lj lk lm mb lq mc lu md ly me mf mg mh bi translated">Medisana PM100连接</li><li id="dadf" class="lz ma it lf b lg mi lj mj lm mk lq ml lu mm ly me mf mg mh bi translated">iPhone 11 Pro Max，iOS 14.4</li><li id="661b" class="lz ma it lf b lg mi lj mj lm mk lq ml lu mm ly me mf mg mh bi translated">MacBook Pro，13英寸，2016，macOS Big Sur 11.2.2，XCode 12.4</li></ul><figure class="ks kt ku kv gt kw gh gi paragraph-image"><div class="gh gi mn"><img src="../Images/090fa3a86a8003707eaed83ef67c9614.png" data-original-src="https://miro.medium.com/v2/resize:fit:1000/format:webp/1*whrDLXQfYgcqacD-Lf6eVg.jpeg"/></div></figure><h2 id="4320" class="mo mp it bd mq mr ms dn mt mu mv dp mw lm mx my mz lq na nb nc lu nd ne nf iz bi translated">介绍</h2><p id="361b" class="pw-post-body-paragraph ld le it lf b lg ng kd li lj nh kg ll lm ni lo lp lq nj ls lt lu nk lw lx ly im bi translated">很长一段时间以来，我一直在寻找一款可以通过蓝牙连接到智能手机的经济型血氧计。</p><p id="8304" class="pw-post-body-paragraph ld le it lf b lg lh kd li lj lk kg ll lm ln lo lp lq lr ls lt lu lv lw lx ly im bi translated">最后运气好，找到了Medisana 的<a class="ae nl" href="https://www.medisana.com/en/Health-control/Pulsoximeter/PM-100-connect-Pulse-oximeter.html?force_sid=bpi0b7tpenm3flllv90g1452r5" rel="noopener ugc nofollow" target="_blank">“pm 100 Connect”。一个伟大的小设备，具有令人信服的制造质量和可靠的重要数据测量。</a></p><p id="ce8f" class="pw-post-body-paragraph ld le it lf b lg lh kd li lj lk kg ll lm ln lo lp lq lr ls lt lu lv lw lx ly im bi translated">该公司声称，他们有一个名为“VitaDock”的应用程序，可以捕捉并显示设备中的数据。嗯…</p><p id="d345" class="pw-post-body-paragraph ld le it lf b lg lh kd li lj lk kg ll lm ln lo lp lq lr ls lt lu lv lw lx ly im bi translated">长话短说，我无法让设备与这个应用程序一起工作。在阅读亚马逊上的评论时，我发现我不是唯一一个在让它工作时遇到问题的人。</p><p id="f4c9" class="pw-post-body-paragraph ld le it lf b lg lh kd li lj lk kg ll lm ln lo lp lq lr ls lt lu lv lw lx ly im bi translated">当我想到这是一个了解苹果<a class="ae nl" href="https://developer.apple.com/documentation/corebluetoothhttps://developer.apple.com/documentation/corebluetooth" rel="noopener ugc nofollow" target="_blank">“核心蓝牙”框架</a>并了解蓝牙设备如何工作的绝佳机会时，我差点就要归还了。</p><p id="1491" class="pw-post-body-paragraph ld le it lf b lg lh kd li lj lk kg ll lm ln lo lp lq lr ls lt lu lv lw lx ly im bi translated">是时候开始编码了，让双手变脏，或者提高心率，在本教程的最后，可以用本文末尾下载的代码进行测量。</p><p id="596f" class="pw-post-body-paragraph ld le it lf b lg lh kd li lj lk kg ll lm ln lo lp lq lr ls lt lu lv lw lx ly im bi translated"><a class="ae nl" href="https://www.buymeacoffee.com/twissmueller/e/25969" rel="noopener ugc nofollow" target="_blank"> <strong class="lf jd">点击此链接可下载完整的XCode工作空间。</strong>T12】</a></p><h2 id="3570" class="mo mp it bd mq mr ms dn mt mu mv dp mw lm mx my mz lq na nb nc lu nd ne nf iz bi translated">先决条件</h2><p id="44c1" class="pw-post-body-paragraph ld le it lf b lg ng kd li lj nh kg ll lm ni lo lp lq nj ls lt lu nk lw lx ly im bi translated">为了允许设备使用蓝牙，需要在<code class="fe nm nn no np b">Info.plist</code>中设置两个键。</p><ul class=""><li id="6064" class="lz ma it lf b lg lh lj lk lm mb lq mc lu md ly me mf mg mh bi translated"><code class="fe nm nn no np b">Privacy - Bluetooth Always Usage Description</code></li><li id="c51c" class="lz ma it lf b lg mi lj mj lm mk lq ml lu mm ly me mf mg mh bi translated"><code class="fe nm nn no np b">Privacy - Bluetooth Peripheral Usage Description</code></li></ul><figure class="ks kt ku kv gt kw gh gi paragraph-image"><div class="ab gu cl nq"><img src="../Images/c104efc324e775bcfffa8aea5ae42699.png" data-original-src="https://miro.medium.com/v2/format:webp/1*sm_7ySDqXEcmnDM4gJ_feg.png"/></div><figcaption class="nr ns gj gh gi nt nu bd b be z dk translated">信息列表</figcaption></figure><h2 id="6844" class="mo mp it bd mq mr ms dn mt mu mv dp mw lm mx my mz lq na nb nc lu nd ne nf iz bi translated">中央管理器和外围设备</h2><p id="79ec" class="pw-post-body-paragraph ld le it lf b lg ng kd li lj nh kg ll lm ni lo lp lq nj ls lt lu nk lw lx ly im bi translated">本教程的切入点是<code class="fe nm nn no np b"><a class="ae nl" href="https://developer.apple.com/documentation/corebluetooth/cbcentralmanager" rel="noopener ugc nofollow" target="_blank">CBCentralManager</a></code>，它是“扫描、发现、连接和管理外围设备的对象”。</p><p id="84c0" class="pw-post-body-paragraph ld le it lf b lg lh kd li lj lk kg ll lm ln lo lp lq lr ls lt lu lv lw lx ly im bi translated">让我们创建一个并连接它。</p><pre class="ks kt ku kv gt nv np nw nx aw ny bi"><span id="de8c" class="mo mp it np b gy nz oa l ob oc">var centralManager: CBCentralManager?<br/>centralManager = CBCentralManager(delegate: self, queue: nil)</span></pre><p id="085d" class="pw-post-body-paragraph ld le it lf b lg lh kd li lj lk kg ll lm ln lo lp lq lr ls lt lu lv lw lx ly im bi translated">在实例化时，需要提供将充当委托的对象。</p><p id="1192" class="pw-post-body-paragraph ld le it lf b lg lh kd li lj lk kg ll lm ln lo lp lq lr ls lt lu lv lw lx ly im bi translated">这个委托必须实现<code class="fe nm nn no np b">centralManagerDidUpdateState(_ central: CBCentralManager)</code>,这样就可以检查应用程序运行的设备是否支持蓝牙。</p><pre class="ks kt ku kv gt nv np nw nx aw ny bi"><span id="5c49" class="mo mp it np b gy nz oa l ob oc">func centralManagerDidUpdateState(_ central: CBCentralManager) {<br/>    guard central.state == .poweredOn else {<br/>        logger.debug("No Bluetooth available")<br/>        return<br/>    }<br/>    central.scanForPeripherals(withServices: nil, options: nil)<br/>}</span></pre><p id="f9d1" class="pw-post-body-paragraph ld le it lf b lg lh kd li lj lk kg ll lm ln lo lp lq lr ls lt lu lv lw lx ly im bi translated">当蓝牙可用时，应用程序将扫描其附近的外围设备。</p><p id="d7f7" class="pw-post-body-paragraph ld le it lf b lg lh kd li lj lk kg ll lm ln lo lp lq lr ls lt lu lv lw lx ly im bi translated">需要实现另一个委托方法，以便检查哪些外设可用。</p><pre class="ks kt ku kv gt nv np nw nx aw ny bi"><span id="a9a3" class="mo mp it np b gy nz oa l ob oc">func centralManager(_ central: CBCentralManager, didDiscover peripheral: CBPeripheral, advertisementData: [String : Any], rssi RSSI: NSNumber) {<br/>    logger.debug("Found peripheral: \(peripheral.description)")<br/>}</span></pre><p id="fe59" class="pw-post-body-paragraph ld le it lf b lg lh kd li lj lk kg ll lm ln lo lp lq lr ls lt lu lv lw lx ly im bi translated">打开PM100运行它，我很快发现它的名字是“电子血氧仪”。</p><p id="8f47" class="pw-post-body-paragraph ld le it lf b lg lh kd li lj lk kg ll lm ln lo lp lq lr ls lt lu lv lw lx ly im bi translated">让我们连接到它。</p><pre class="ks kt ku kv gt nv np nw nx aw ny bi"><span id="4ffe" class="mo mp it np b gy nz oa l ob oc">centralManager?.connect(peripheral, options: nil)</span></pre><p id="517b" class="pw-post-body-paragraph ld le it lf b lg lh kd li lj lk kg ll lm ln lo lp lq lr ls lt lu lv lw lx ly im bi translated">如果连接已经建立，将在此委托方法中接收。</p><pre class="ks kt ku kv gt nv np nw nx aw ny bi"><span id="2f27" class="mo mp it np b gy nz oa l ob oc">func centralManager(_ central: CBCentralManager, didConnect peripheral: CBPeripheral) {<br/>    logger.debug("Connected to peripheral: \(peripheral.description)")<br/>}</span></pre><p id="808d" class="pw-post-body-paragraph ld le it lf b lg lh kd li lj lk kg ll lm ln lo lp lq lr ls lt lu lv lw lx ly im bi translated">搞定了。我们已成功连接到PM100或您可能在本教程中使用的任何其他设备。在下一步中，我们将介绍实际发现设备能够发送的所有数据所需的所有步骤。</p><h2 id="f5df" class="mo mp it bd mq mr ms dn mt mu mv dp mw lm mx my mz lq na nb nc lu nd ne nf iz bi translated">服务和特点</h2><p id="1fc8" class="pw-post-body-paragraph ld le it lf b lg ng kd li lj nh kg ll lm ni lo lp lq nj ls lt lu nk lw lx ly im bi translated">要了解蓝牙设备(外设)能提供什么，我们需要首先发现它的服务:</p><pre class="ks kt ku kv gt nv np nw nx aw ny bi"><span id="27b2" class="mo mp it np b gy nz oa l ob oc">peripheral.discoverServices(nil)</span></pre><p id="dbcf" class="pw-post-body-paragraph ld le it lf b lg lh kd li lj lk kg ll lm ln lo lp lq lr ls lt lu lv lw lx ly im bi translated">在文档中，我们需要寻找<code class="fe nm nn no np b"><a class="ae nl" href="https://developer.apple.com/documentation/corebluetooth/cbservice" rel="noopener ugc nofollow" target="_blank">CBService</a></code>。服务被描述为“完成设备功能或特性的数据和相关行为的集合”</p><p id="066f" class="pw-post-body-paragraph ld le it lf b lg lh kd li lj lk kg ll lm ln lo lp lq lr ls lt lu lv lw lx ly im bi translated">需要实现一个<code class="fe nm nn no np b">CBPeripheralDelegate</code>的委托方法，在发现服务时调用该方法。</p><pre class="ks kt ku kv gt nv np nw nx aw ny bi"><span id="c715" class="mo mp it np b gy nz oa l ob oc">func peripheral(_ peripheral: CBPeripheral, didDiscoverServices error: Error?) {<br/>    peripheral.services?.forEach { service in<br/>        logger.debug("Discovered service: \(service.description)")        <br/>    }<br/>}</span></pre><p id="9d8d" class="pw-post-body-paragraph ld le it lf b lg lh kd li lj lk kg ll lm ln lo lp lq lr ls lt lu lv lw lx ly im bi translated">PM100有四种服务:</p><pre class="ks kt ku kv gt nv np nw nx aw ny bi"><span id="9ab1" class="mo mp it np b gy nz oa l ob oc">Discovered service: &lt;CBService: 0x2816b8700, isPrimary = YES, UUID = Device Information&gt;<br/>Discovered service: &lt;CBService: 0x2816b82c0, isPrimary = YES, UUID = Battery&gt;<br/>Discovered service: &lt;CBService: 0x2816b84c0, isPrimary = YES, UUID = 1822&gt;<br/>Discovered service: &lt;CBService: 0x2816b8300, isPrimary = YES, UUID = 0000FEE8-0000-1000-8000-00805F9B34FB&gt;</span></pre><p id="bc9b" class="pw-post-body-paragraph ld le it lf b lg lh kd li lj lk kg ll lm ln lo lp lq lr ls lt lu lv lw lx ly im bi translated">对于每项服务，我们都能发现所谓的特征:</p><pre class="ks kt ku kv gt nv np nw nx aw ny bi"><span id="0e26" class="mo mp it np b gy nz oa l ob oc">peripheral.discoverCharacteristics(nil, for: service)</span></pre><p id="dc5b" class="pw-post-body-paragraph ld le it lf b lg lh kd li lj lk kg ll lm ln lo lp lq lr ls lt lu lv lw lx ly im bi translated">我们非常接近用<code class="fe nm nn no np b"><a class="ae nl" href="https://developer.apple.com/documentation/corebluetooth/cbcharacteristic" rel="noopener ugc nofollow" target="_blank">CBCharacteristic</a></code>检索心率和氧合数据。让我们再次查阅文档:</p><p id="1f9f" class="pw-post-body-paragraph ld le it lf b lg lh kd li lj lk kg ll lm ln lo lp lq lr ls lt lu lv lw lx ly im bi translated">" CBCharacteristic及其子类CBMutableCharacteristic代表关于外围设备服务的进一步信息。特别是，CBCharacteristic对象表示远程外围设备服务的特征。特征包含单个值和描述该值的任意数量的描述符。特性的属性决定了如何使用特性的值，以及如何访问描述符。”</p><p id="5279" class="pw-post-body-paragraph ld le it lf b lg lh kd li lj lk kg ll lm ln lo lp lq lr ls lt lu lv lw lx ly im bi translated">同样，我们需要实现一个委托方法来检索所有发现的特征:</p><pre class="ks kt ku kv gt nv np nw nx aw ny bi"><span id="f597" class="mo mp it np b gy nz oa l ob oc">func peripheral(_ peripheral: CBPeripheral, didDiscoverCharacteristicsFor service: CBService, error: Error?) {<br/>    service.characteristics?.forEach { characteristic in<br/>        logger.debug("Discovered characteristic: \(characteristic.description) for service \(service.uuid)")<br/>      }<br/>}</span></pre><p id="ff01" class="pw-post-body-paragraph ld le it lf b lg lh kd li lj lk kg ll lm ln lo lp lq lr ls lt lu lv lw lx ly im bi translated">它需要在蓝牙规范<a class="ae nl" href="https://www.bluetooth.com" rel="noopener ugc nofollow" target="_blank">中做一些挖掘，找出我们想要的服务<code class="fe nm nn no np b">1822</code>的特性<code class="fe nm nn no np b">2A5F</code>的值。你也可以谷歌一下。-).</a></p><p id="43ac" class="pw-post-body-paragraph ld le it lf b lg lh kd li lj lk kg ll lm ln lo lp lq lr ls lt lu lv lw lx ly im bi translated">我们希望在设备发出心率和血氧数据时得到通知。因此我们需要调用以下内容:</p><pre class="ks kt ku kv gt nv np nw nx aw ny bi"><span id="0761" class="mo mp it np b gy nz oa l ob oc">if (characteristic.uuid == CBUUID(string: "2A5F")) {<br/>    peripheral.setNotifyValue(true, for: characteristic)<br/>}</span></pre><p id="1b7e" class="pw-post-body-paragraph ld le it lf b lg lh kd li lj lk kg ll lm ln lo lp lq lr ls lt lu lv lw lx ly im bi translated">最后，我们可以通过实现最后一个委托方法来检索值:</p><pre class="ks kt ku kv gt nv np nw nx aw ny bi"><span id="9e15" class="mo mp it np b gy nz oa l ob oc">func peripheral(_ peripheral: CBPeripheral, didUpdateValueFor characteristic: CBCharacteristic, error: Error?) { <br/>    guard characteristic.service.uuid == CBUUID(string: "1822"),<br/>              characteristic.uuid == CBUUID(string: "2A5F"),<br/>              let data = characteristic.value else {<br/>            return<br/>    }<br/>        <br/>    let numberOfBytes = data.count<br/>    var byteArray = [UInt8](repeating: 0, count: numberOfBytes)<br/>    (data as NSData).getBytes(&amp;byteArray, length: numberOfBytes)<br/>        <br/>    logger.debug("Data: \(byteArray)")<br/>}</span></pre><p id="3816" class="pw-post-body-paragraph ld le it lf b lg lh kd li lj lk kg ll lm ln lo lp lq lr ls lt lu lv lw lx ly im bi translated">通过将<code class="fe nm nn no np b">byteArray</code>的值与我的PM100的显示值进行比较，很容易发现哪个值是心率值，哪个值是氧合值:</p><pre class="ks kt ku kv gt nv np nw nx aw ny bi"><span id="8bd9" class="mo mp it np b gy nz oa l ob oc">let oxygenation = byteArray[1]<br/>let heartRate = byteArray[3]</span></pre><p id="495e" class="pw-post-body-paragraph ld le it lf b lg lh kd li lj lk kg ll lm ln lo lp lq lr ls lt lu lv lw lx ly im bi translated">我们完了！因此，无论您对什么样的蓝牙设备感兴趣，发现其服务和特性的方法应该总是相同的。</p><p id="8293" class="pw-post-body-paragraph ld le it lf b lg lh kd li lj lk kg ll lm ln lo lp lq lr ls lt lu lv lw lx ly im bi translated">事实上，我们还没有完成，还…</p><h2 id="57bb" class="mo mp it bd mq mr ms dn mt mu mv dp mw lm mx my mz lq na nb nc lu nd ne nf iz bi translated">示例应用程序</h2><p id="13e6" class="pw-post-body-paragraph ld le it lf b lg ng kd li lj nh kg ll lm ni lo lp lq nj ls lt lu nk lw lx ly im bi translated">如果你需要一个全功能的SwiftUI应用程序，它可以根据本教程中显示的内容显示心率和氧合数据，<a class="ae nl" href="https://www.buymeacoffee.com/twissmueller/e/25969" rel="noopener ugc nofollow" target="_blank"> <strong class="lf jd">我提供了整个XCode工作区供你下载</strong> </a>。</p><figure class="ks kt ku kv gt kw gh gi paragraph-image"><div class="ab gu cl nq"><img src="../Images/fe67677041b052fa0855c28002df9f8b.png" data-original-src="https://miro.medium.com/v2/format:webp/1*Dgw9GVbrW6t7wdDI2aGNUg.png"/></div><figcaption class="nr ns gj gh gi nt nu bd b be z dk translated">示例应用程序</figcaption></figure><p id="fdb2" class="pw-post-body-paragraph ld le it lf b lg lh kd li lj lk kg ll lm ln lo lp lq lr ls lt lu lv lw lx ly im bi translated">感谢阅读！</p><p id="db2e" class="pw-post-body-paragraph ld le it lf b lg lh kd li lj lk kg ll lm ln lo lp lq lr ls lt lu lv lw lx ly im bi translated">如果你喜欢这篇文章，请随意给我买杯咖啡。 </p><h2 id="600d" class="mo mp it bd mq mr ms dn mt mu mv dp mw lm mx my mz lq na nb nc lu nd ne nf iz bi translated">资源</h2><ul class=""><li id="3778" class="lz ma it lf b lg ng lj nh lm od lq oe lu of ly me mf mg mh bi translated"><a class="ae nl" href="https://developer.apple.com/documentation/corebluetooth" rel="noopener ugc nofollow" target="_blank">核心蓝牙框架</a></li><li id="8b0b" class="lz ma it lf b lg mi lj mj lm mk lq ml lu mm ly me mf mg mh bi translated"><a class="ae nl" href="https://developer.apple.com/library/archive/documentation/NetworkingInternetWeb/Conceptual/CoreBluetooth_concepts/AboutCoreBluetooth/Introduction.html#//apple_ref/doc/uid/TP40013257-CH1-SW1" rel="noopener ugc nofollow" target="_blank">核心蓝牙编程指南</a></li><li id="fc33" class="lz ma it lf b lg mi lj mj lm mk lq ml lu mm ly me mf mg mh bi translated"><a class="ae nl" href="https://gist.github.com/brayden-morris-303/09a738ed9c83a7d14c82" rel="noopener ugc nofollow" target="_blank">核心蓝牙和BLE </a></li><li id="d1dd" class="lz ma it lf b lg mi lj mj lm mk lq ml lu mm ly me mf mg mh bi translated"><a class="ae nl" href="https://stackoverflow.com/q/51249335/1065468" rel="noopener ugc nofollow" target="_blank">如何使用CoreBluetooth从1822 PulseOximeter的蓝牙LE数据中提取SFLOAT值</a></li></ul></div></div>    
</body>
</html>