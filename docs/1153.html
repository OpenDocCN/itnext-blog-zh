<html>
<head>
<title>Go Modules and CircleCI</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Go模块和CircleCI</h1>
<blockquote>原文：<a href="https://itnext.io/go-modules-and-circleci-c0d6fac0b000?source=collection_archive---------4-----------------------#2018-07-31">https://itnext.io/go-modules-and-circleci-c0d6fac0b000?source=collection_archive---------4-----------------------#2018-07-31</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="3304" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我最近读了<a class="ae kl" href="https://dave.cheney.net/2018/07/16/using-go-modules-with-travis-ci" rel="noopener ugc nofollow" target="_blank"> Dave Cheney的帖子</a>关于在Travis CI工作流中转换httpstat以使用Go 1.11的模块支持。Go 1.11即将正式发布，所以现在是在CircleCI中开始使用Go模块的好时机，circle CI是一个类似于Travis CI的持续集成和交付平台。</p><h1 id="ebc1" class="km kn iq bd ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj bi translated"><strong class="ak"> Go模块</strong></h1><p id="17b0" class="pw-post-body-paragraph jn jo iq jp b jq lk js jt ju ll jw jx jy lm ka kb kc ln ke kf kg lo ki kj kk ij bi translated">Go模块是相关Go包的集合。Go 1.11为使用<code class="fe lp lq lr ls b">go</code>命令处理模块提供了实验支持。</p><p id="fb6b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">模块行为由环境变量<code class="fe lp lq lr ls b">GO111MODULE</code>控制，可以设置为<code class="fe lp lq lr ls b">on</code>、<code class="fe lp lq lr ls b">off</code>或<code class="fe lp lq lr ls b">auto</code>(默认)。当<code class="fe lp lq lr ls b">GO111MODULE</code>设置为<code class="fe lp lq lr ls b">off</code>时，<code class="fe lp lq lr ls b">go</code>命令保持与先前版本相同的功能，并在构建期间使用<code class="fe lp lq lr ls b">GOPATH</code>中的包。如果<code class="fe lp lq lr ls b">GO111MODULE</code>被设置为<code class="fe lp lq lr ls b">on</code>，则<code class="fe lp lq lr ls b">go</code>命令会忽略<code class="fe lp lq lr ls b">GOPATH</code>并要求使用模块。</p><p id="d966" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">将<code class="fe lp lq lr ls b">GO111MODULE</code>设置为<code class="fe lp lq lr ls b">auto</code>(或未设置)允许<code class="fe lp lq lr ls b">GOPATH</code>和模块支持，但有一些限制。在这种模式下，<code class="fe lp lq lr ls b">go</code>命令的行为由当前目录的位置决定。如果当前目录在<code class="fe lp lq lr ls b">GOPATH</code>之外，并且包含一个<code class="fe lp lq lr ls b">go.mod</code>文件，那么模块支持被启用。否则，<code class="fe lp lq lr ls b">GOPATH</code>和vendor目录会像以前版本的Go一样使用。</p><p id="d5d7" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">有几篇关于使用Go模块和<code class="fe lp lq lr ls b">go.mod</code>文件的好文章。更多信息请查看参考资料部分。</p><h1 id="8780" class="km kn iq bd ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj bi translated">CircleCI </h1><p id="452d" class="pw-post-body-paragraph jn jo iq jp b jq lk js jt ju ll jw jx jy lm ka kb kc ln ke kf kg lo ki kj kk ij bi translated">让我们创建一个Go模块，并用CircleCI来说明Go 1.11中的<code class="fe lp lq lr ls b">auto</code>模块行为。我们将从一个包含单元测试的非常简单的模块开始。该模块有两个外部依赖项，因此我们将看到依赖项管理在起作用。该示例的源代码可在<a class="ae kl" href="https://github.com/tkeech1/gomodules" rel="noopener ugc nofollow" target="_blank"> Github </a>上获得。</p><p id="db80" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">首先，创建一个名为<code class="fe lp lq lr ls b">helloworld.go</code>的文件，它包含以下内容:</p><pre class="lt lu lv lw gt lx ls ly lz aw ma bi"><span id="773d" class="mb kn iq ls b gy mc md l me mf">package gomodules<br/>import (<br/>     log "github.com/sirupsen/logrus"<br/>)</span><span id="e15f" class="mb kn iq ls b gy mg md l me mf">func sayHello() string {<br/>     log.Info("saying hello...")<br/>     return "Hello, world"<br/>}</span></pre><p id="5d71" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">让我们也为<code class="fe lp lq lr ls b">helloworld.go</code>创建名为<code class="fe lp lq lr ls b">helloworld_test.go</code>的测试:</p><pre class="lt lu lv lw gt lx ls ly lz aw ma bi"><span id="8e00" class="mb kn iq ls b gy mc md l me mf">package gomodules</span><span id="5a5d" class="mb kn iq ls b gy mg md l me mf">import (<br/>     "testing"<br/>     "github.com/stretchr/testify/assert"<br/>)</span><span id="46b5" class="mb kn iq ls b gy mg md l me mf">func Test_HelloWorld(t *testing.T) {<br/>     tests := map[string]struct {<br/>          expectedResponse string<br/>     }{<br/>          "success": {<br/>                expectedResponse: "Hello, world",<br/>          },<br/>     }<br/>     <br/>     for name, test := range tests {<br/>          t.Logf("Running test case: %s", name)<br/>          response := sayHello()<br/>          assert.Equal(t, test.expectedResponse, response)<br/>     }<br/>}</span></pre><p id="9488" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们可以在CircleCI中执行Go 1.10的测试，方法是将下面的<code class="fe lp lq lr ls b">config.yml</code>文件添加到项目中，并在CircleCI中配置Github存储库(有关在CircleCI中配置Go项目的更多信息，请参见参考资料部分)。</p><pre class="lt lu lv lw gt lx ls ly lz aw ma bi"><span id="a8a1" class="mb kn iq ls b gy mc md l me mf"># Golang CircleCI 2.0 configuration file<br/>version: 2<br/>jobs:<br/>  build-go1.10:<br/>    docker:<br/>      - image: circleci/golang:1.10<br/>      working_directory: /go/src/github.com/tkeech1/gomodules<br/>    steps:<br/>      - checkout<br/>      - run: go get -v -t -d ./...<br/>      - run: go test -race</span><span id="657f" class="mb kn iq ls b gy mg md l me mf">workflows:<br/>  version: 2<br/>  build_and_test:<br/>  jobs:<br/>    - build-go1.10</span></pre><p id="bf7c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">此示例使用CircleCI工作流。工作流可以在每次构建期间并行执行多个作业。<code class="fe lp lq lr ls b">steps</code>部分定义了每个任务运行的具体命令。在本例中，步骤如下:</p><ul class=""><li id="d741" class="mh mi iq jp b jq jr ju jv jy mj kc mk kg ml kk mm mn mo mp bi translated">将Github库签出到<code class="fe lp lq lr ls b">working_directory</code>。在这种情况下，<code class="fe lp lq lr ls b">working_directory</code>位于<code class="fe lp lq lr ls b">GOPATH</code>上。</li><li id="0adf" class="mh mi iq jp b jq mq ju mr jy ms kc mt kg mu kk mm mn mo mp bi translated"><code class="fe lp lq lr ls b">go get</code>包和测试的依赖关系。</li><li id="28f9" class="mh mi iq jp b jq mq ju mr jy ms kc mt kg mu kk mm mn mo mp bi translated">进行测试。</li></ul><figure class="lt lu lv lw gt mw gh gi paragraph-image"><div role="button" tabindex="0" class="mx my di mz bf na"><div class="gh gi mv"><img src="../Images/05d5b7b1e25b3a7e9b7b64675154a64c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*LmEUUjyBuEkYhxg0VSZZ2g.png"/></div></div><figcaption class="nd ne gj gh gi nf ng bd b be z dk translated">Go 1.10的CircleCI构建结果</figcaption></figure><p id="cbd2" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">CircleCI构建显示<code class="fe lp lq lr ls b">go get</code>和<code class="fe lp lq lr ls b">go test</code>工作步骤成功执行。我们有一个Go 1.10的工作版本。</p><h1 id="5e13" class="km kn iq bd ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj bi translated"><strong class="ak"> Go 1.11模块和CircleCI </strong></h1><p id="572b" class="pw-post-body-paragraph jn jo iq jp b jq lk js jt ju ll jw jx jy lm ka kb kc ln ke kf kg lo ki kj kk ij bi translated">现在我们将在不使用模块的情况下为Go 1.11添加一个CircleCI作业。我们可以使用与Go 1.10构建作业相同的配置，用Go 1.11映像替换Go 1.10映像。</p><pre class="lt lu lv lw gt lx ls ly lz aw ma bi"><span id="b638" class="mb kn iq ls b gy mc md l me mf"># Golang CircleCI 2.0 configuration file<br/>version: 2<br/>jobs:<br/>  build-go1.10:<br/>    docker:<br/>      - image: circleci/golang:1.10<br/>      working_directory: /go/src/github.com/tkeech1/gomodules<br/>    steps:<br/>      - checkout<br/>      - run: go get -v -t -d ./...<br/>      - run: go test -race<br/>  <strong class="ls ir"><em class="nh">build-go1.11:<br/>    docker:<br/>      - image: circleci/golang:1.11-rc<br/>      working_directory: /go/src/github.com/tkeech1/gomodules<br/>    steps:<br/>      - checkout<br/>      - run: go get -v -t -d ./...<br/>      - run: go test -race</em></strong></span><span id="272a" class="mb kn iq ls b gy mg md l me mf">workflows:<br/>  version: 2<br/>  build_and_test:<br/>  jobs:<br/>    - build-go1.10<br/>    <strong class="ls ir"><em class="nh">- build-go1.11</em></strong></span></pre><p id="487e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">要添加使用Go模块的新CircleCI构建，我们必须首先使用Go 1.11 <code class="fe lp lq lr ls b">go mod</code>命令初始化模块。不安装Go 1.11的方法之一就是使用Docker。下面的命令启动一个Go 1.11 Docker容器，将本地源代码装入容器，并运行模块初始化命令。</p><pre class="lt lu lv lw gt lx ls ly lz aw ma bi"><span id="2d69" class="mb kn iq ls b gy mc md l me mf">docker run -it --rm -v $PWD:/opt golang:1.11-rc <em class="nh">go mod -init -module github.com/tkeech1/gomodules</em></span></pre><p id="65d6" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><em class="nh">更新(2018年8月7日)—Go的beta3版本使用以下命令初始化模块:</em></p><pre class="lt lu lv lw gt lx ls ly lz aw ma bi"><span id="d277" class="mb kn iq ls b gy mc md l me mf">docker run -it --rm -v $PWD:/opt golang:1.11-rc <em class="nh">go mod init github.com/tkeech1/gomodules</em></span></pre><p id="a349" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">模块初始化产生一个包含以下内容的<code class="fe lp lq lr ls b">go.mod</code>文件:</p><pre class="lt lu lv lw gt lx ls ly lz aw ma bi"><span id="ba57" class="mb kn iq ls b gy mc md l me mf">module github.com/tkeech1/gomodules</span></pre><p id="e4cf" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">让我们添加依赖项。许多<code class="fe lp lq lr ls b">go</code>工具命令，如<code class="fe lp lq lr ls b">build</code>、<code class="fe lp lq lr ls b">run</code>和<code class="fe lp lq lr ls b">test</code>是模块感知的，会将缺失的依赖项添加到<code class="fe lp lq lr ls b">go.mod</code>文件中。除了添加缺失的依赖关系，<code class="fe lp lq lr ls b">go mod -sync</code>命令还将删除不必要的依赖关系。您可以使用以下命令在Docker中运行它:</p><pre class="lt lu lv lw gt lx ls ly lz aw ma bi"><span id="c61b" class="mb kn iq ls b gy mc md l me mf">docker run -it --rm -v $PWD:/opt --workdir /opt golang:1.11-rc <em class="nh">go mod -sync</em></span></pre><p id="e344" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><em class="nh">更新(2018年8月7日)—Go的beta3版本使用以下命令来同步依赖关系:</em></p><pre class="lt lu lv lw gt lx ls ly lz aw ma bi"><span id="b4aa" class="mb kn iq ls b gy mc md l me mf">docker run -it --rm -v $PWD:/opt --workdir /opt golang:1.11-rc <em class="nh">go mod tidy</em></span></pre><p id="7106" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">依赖关系现在列在<code class="fe lp lq lr ls b">go.mod</code>文件中。</p><pre class="lt lu lv lw gt lx ls ly lz aw ma bi"><span id="2ca8" class="mb kn iq ls b gy mc md l me mf">module github.com/tkeech1/gomodules</span><span id="e2a1" class="mb kn iq ls b gy mg md l me mf">require (<br/> github.com/davecgh/go-spew v1.1.0 // indirect<br/> github.com/fsnotify/fsnotify v1.4.7 // indirect<br/> github.com/golang/protobuf v1.1.0 // indirect<br/> github.com/hpcloud/tail v1.0.0 // indirect<br/> github.com/onsi/ginkgo v1.6.0 // indirect<br/> github.com/onsi/gomega v1.4.1 // indirect<br/> github.com/pmezard/go-difflib v1.0.0 // indirect<br/> github.com/sirupsen/logrus v1.0.6<br/> github.com/stretchr/testify v1.2.2<br/> golang.org/x/crypto v0.0.0-20180723164146-c126467f60eb // indirect<br/> golang.org/x/net v0.0.0-20180724234803-3673e40ba225 // indirect<br/> golang.org/x/sync v0.0.0-20180314180146-1d60e4601c6f // indirect<br/> golang.org/x/sys v0.0.0-20180727230415-bd9dbc187b6e // indirect<br/> golang.org/x/text v0.3.0 // indirect<br/> gopkg.in/airbrake/gobrake.v2 v2.0.9 // indirect<br/> gopkg.in/fsnotify.v1 v1.4.7 // indirect<br/> gopkg.in/gemnasium/logrus-airbrake-hook.v2 v2.1.2 // indirect<br/> gopkg.in/tomb.v1 v1.0.0-20141024135613-dd632973f1e7 // indirect<br/> gopkg.in/yaml.v2 v2.2.1 // indirect<br/>)</span></pre><p id="ae71" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">最后，通过向config.yml文件添加一个新作业，在CircleCI中创建Go 1.11模块构建配置。</p><pre class="lt lu lv lw gt lx ls ly lz aw ma bi"><span id="1c77" class="mb kn iq ls b gy mc md l me mf"># Golang CircleCI 2.0 configuration file<br/>version: 2<br/>jobs:<br/>  build-go1.10:<br/>    docker:<br/>      - image: circleci/golang:1.10<br/>      working_directory: /go/src/github.com/tkeech1/gomodules<br/>    steps:<br/>      - checkout<br/>      - run: go get -v -t -d ./...<br/>      - run: go test -race<br/>  build-go1.11:<br/>    docker:<br/>      - image: circleci/golang:1.11-rc<br/>      working_directory: /go/src/github.com/tkeech1/gomodules<br/>    steps:<br/>      - checkout<br/>      - run: go get -v -t -d ./...<br/>      - run: go test -race<br/><em class="nh">  </em><strong class="ls ir"><em class="nh">build-go1.11-gomodules:<br/>    docker:<br/>    - image: circleci/golang:1.11-rc<br/>    working_directory: ~/github.com/tkeech1/gomodules<br/>    steps:<br/>    - checkout<br/>    - run: go test -race</em></strong></span><span id="9979" class="mb kn iq ls b gy mg md l me mf">workflows:<br/>  version: 2<br/>  build_and_test:<br/>  jobs:<br/>    - build-go1.10<br/>    - build-go1.11<br/>    <strong class="ls ir"><em class="nh">- build-go1.11-gomodules</em></strong></span></pre><p id="013f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">新工作有一些小变化:</p><ul class=""><li id="711e" class="mh mi iq jp b jq jr ju jv jy mj kc mk kg ml kk mm mn mo mp bi translated">没必要跑<code class="fe lp lq lr ls b">go get</code>。<code class="fe lp lq lr ls b">go test</code>将处理<code class="fe lp lq lr ls b">go.mod</code>文件中列出的必要依赖项的下载。</li><li id="0c73" class="mh mi iq jp b jq mq ju mr jy ms kc mt kg mu kk mm mn mo mp bi translated"><code class="fe lp lq lr ls b">working_directory</code>位于<code class="fe lp lq lr ls b">GOPATH</code>外</li></ul><p id="89e2" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">Docker容器中的<code class="fe lp lq lr ls b">GO111MODULE</code>环境变量是未设置的(默认为<code class="fe lp lq lr ls b">auto</code>),并且有一个现有的<code class="fe lp lq lr ls b">go.mod</code>文件，因此构建将使用Go模块。</p><figure class="lt lu lv lw gt mw gh gi paragraph-image"><div role="button" tabindex="0" class="mx my di mz bf na"><div class="gh gi ni"><img src="../Images/6aa40e0f29133503b4c55a4153fb5a69.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Ny-WlZewrVHqPWq0UPAEHg.png"/></div></div><figcaption class="nd ne gj gh gi nf ng bd b be z dk translated">带有模块的Go 1.11的CircleCI构建结果</figcaption></figure><p id="8de9" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在CircleCI输出中，我们看到运行<code class="fe lp lq lr ls b">go test</code>导致构建下载了<code class="fe lp lq lr ls b">go.mod</code>文件中列出的依赖项。现在我们有一个CircleCI工作流，在Go 1.10、Go 1.11和Go 1.11上用模块构建和测试一个小项目。</p><h1 id="278b" class="km kn iq bd ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj bi translated">摘要</h1><ul class=""><li id="5f9f" class="mh mi iq jp b jq lk ju ll jy nj kc nk kg nl kk mm mn mo mp bi translated">模块是Go 1.11中的一个实验性特性</li><li id="20b2" class="mh mi iq jp b jq mq ju mr jy ms kc mt kg mu kk mm mn mo mp bi translated">环境变量<code class="fe lp lq lr ls b">GO111MODULE</code>决定了Go 1.11模块支持的行为</li><li id="bfec" class="mh mi iq jp b jq mq ju mr jy ms kc mt kg mu kk mm mn mo mp bi translated">CircleCI工作流可以配置为使用传统的<code class="fe lp lq lr ls b">GOPATH</code>方法和模块构建单个项目</li></ul><p id="218c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我希望这有所帮助。感谢阅读。</p><h1 id="17c6" class="km kn iq bd ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj bi translated"><strong class="ak">资源</strong></h1><p id="998c" class="pw-post-body-paragraph jn jo iq jp b jq lk js jt ju ll jw jx jy lm ka kb kc ln ke kf kg lo ki kj kk ij bi translated"><a class="ae kl" href="https://dave.cheney.net/2018/07/16/using-go-modules-with-travis-ci" rel="noopener ugc nofollow" target="_blank">通过Travis CI使用Go模块</a></p><p id="0efa" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><a class="ae kl" href="https://groups.google.com/forum/m/#!msg/golang-dev/a5PqQuBljF4/61QK4JdtBgAJ" rel="noopener ugc nofollow" target="_blank"> Go模块已经登陆</a></p><p id="aab0" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><a class="ae kl" href="https://github.com/golang/proposal/blob/master/design/24301-versioned-go.md" rel="noopener ugc nofollow" target="_blank">版本化Go模块提案</a></p><p id="1cc8" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><a class="ae kl" href="https://circleci.com/docs/2.0/workflows/" rel="noopener ugc nofollow" target="_blank"> CircleCI工作流程</a></p><p id="1c5c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><a class="ae kl" href="https://circleci.com/docs/2.0/language-go/" rel="noopener ugc nofollow" target="_blank">在CircleCI中配置Go项目</a></p></div></div>    
</body>
</html>