<html>
<head>
<title>MongoDB Unit-testing in Node.js</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Node.js中的MongoDB单元测试</h1>
<blockquote>原文：<a href="https://itnext.io/mongodb-unit-testing-in-node-js-5686390a6689?source=collection_archive---------1-----------------------#2021-12-16">https://itnext.io/mongodb-unit-testing-in-node-js-5686390a6689?source=collection_archive---------1-----------------------#2021-12-16</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="ba3e" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">用Jasmine，TypeScript和Docker-Compose</h2></div><p id="f474" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">根据MongoDB实例的位置，有多种方法可以测试您的MongoDB存储库:</p><ul class=""><li id="581b" class="le lf it kk b kl km ko kp kr lg kv lh kz li ld lj lk ll lm bi translated">在记忆中</li><li id="e7cc" class="le lf it kk b kl ln ko lo kr lp kv lq kz lr ld lj lk ll lm bi translated">在码头集装箱✔️</li><li id="ac24" class="le lf it kk b kl ln ko lo kr lp kv lq kz lr ld lj lk ll lm bi translated">在云端的✔️</li></ul><p id="231c" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">本教程针对的是后两者。此外，我们将在这里使用Jasmine和TypeScript，但是也可以使用do same Jest和/或plain JS。</p><figure class="lt lu lv lw gt lx gh gi paragraph-image"><div role="button" tabindex="0" class="ly lz di ma bf mb"><div class="gh gi ls"><img src="../Images/dc220d3dc0e84a80835c040109eca8db.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*hLsOIFPaA2Qz_NsqHKVhcA.png"/></div></div></figure><h1 id="72c1" class="me mf it bd mg mh mi mj mk ml mm mn mo jz mp ka mq kc mr kd ms kf mt kg mu mv bi translated">TL；速度三角形定位法(dead reckoning)</h1><p id="11b4" class="pw-post-body-paragraph ki kj it kk b kl mw ju kn ko mx jx kq kr my kt ku kv mz kx ky kz na lb lc ld im bi translated">如下使用<code class="fe nb nc nd ne b"><a class="ae nf" href="https://www.npmjs.com/package/mongo-ci" rel="noopener ugc nofollow" target="_blank">mongo-ci</a></code>:</p><pre class="lt lu lv lw gt ng ne nh ni aw nj bi"><span id="b67d" class="nk mf it ne b gy nl nm l nn no">npm install -D mongo-ci</span></pre><p id="204a" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">在你的测试中:</p><figure class="lt lu lv lw gt lx"><div class="bz fp l di"><div class="np nq l"/></div></figure><h1 id="4c2e" class="me mf it bd mg mh mi mj mk ml mm mn mo jz mp ka mq kc mr kd ms kf mt kg mu mv bi translated">连接到MongoDB实例</h1><p id="2367" class="pw-post-body-paragraph ki kj it kk b kl mw ju kn ko mx jx kq kr my kt ku kv mz kx ky kz na lb lc ld im bi translated">TL；DR部分显示了一个样本存储库测试的JS代码清单。没有更多的事情要做，剩下的棘手部分是创建一个MongoDB实例。现在，有不同的方法来实现它:</p><ul class=""><li id="56e8" class="le lf it kk b kl km ko kp kr lg kv lh kz li ld lj lk ll lm bi translated">在MongoDB Atlas上创建一个MongoDB实例</li><li id="78ca" class="le lf it kk b kl ln ko lo kr lp kv lq kz lr ld lj lk ll lm bi translated">在本地创建一个MongoDB实例，在配置项中创建另一个实例</li><li id="45b0" class="le lf it kk b kl ln ko lo kr lp kv lq kz lr ld lj lk ll lm bi translated">使用Docker容器</li></ul><p id="72ed" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">这些方法的可行性和便利性还取决于是否需要一个副本集。</p><p id="492a" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">如果您的代码使用新引入的事务，对副本集进行测试是必不可少的。如果您仍然不使用事务，您很可能会在将来使用它们，所以在本教程的剩余部分，我们将假设您想要部署一个副本集，尽管我们将简单地提到部署独立实例。</p><p id="db33" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">请参考<a class="ae nf" href="https://docs.mongodb.com/manual/replication/" rel="noopener ugc nofollow" target="_blank"> MongoDB的复制手册</a>以了解更多这方面的信息。</p><h2 id="07ac" class="nk mf it bd mg nr ns dn mk nt nu dp mo kr nv nw mq kv nx ny ms kz nz oa mu ob bi translated">MongoDB地图集</h2><p id="a193" class="pw-post-body-paragraph ki kj it kk b kl mw ju kn ko mx jx kq kr my kt ku kv mz kx ky kz na lb lc ld im bi translated">使用MongoDB Atlas可能是创建MongoDB实例的最方便的方式，但是有一些挑战:</p><ul class=""><li id="13a8" class="le lf it kk b kl km ko kp kr lg kv lh kz li ld lj lk ll lm bi translated">只有独立实例是免费的，副本集是付费功能</li><li id="c292" class="le lf it kk b kl ln ko lo kr lp kv lq kz lr ld lj lk ll lm bi translated">如果多个用户和CI试图同时运行测试，将会出现争用情况</li></ul><h2 id="3c2d" class="nk mf it bd mg nr ns dn mk nt nu dp mo kr nv nw mq kv nx ny ms kz nz oa mu ob bi translated">本地和CI服务</h2><p id="3328" class="pw-post-body-paragraph ki kj it kk b kl mw ju kn ko mx jx kq kr my kt ku kv mz kx ky kz na lb lc ld im bi translated">这个解决方案只允许创建MongoDB的独立实例。可以在本地安装MongoDB，它只是一个实例，无需进一步的虚拟化或容器化。此外，在CI中，可以创建一个类似的MongoDB服务。以GitLab-CI为例:</p><figure class="lt lu lv lw gt lx"><div class="bz fp l di"><div class="np nq l"/></div></figure><h2 id="a01c" class="nk mf it bd mg nr ns dn mk nt nu dp mo kr nv nw mq kv nx ny ms kz nz oa mu ob bi translated">使用Docker-Compose</h2><p id="a0cb" class="pw-post-body-paragraph ki kj it kk b kl mw ju kn ko mx jx kq kr my kt ku kv mz kx ky kz na lb lc ld im bi translated">使用Docker-Compose配置，可以在本地创建一个副本集并连接到它。这将是独立于平台的，但是需要在CI上执行Docker-in-Docker。</p><h1 id="7ac3" class="me mf it bd mg mh mi mj mk ml mm mn mo jz mp ka mq kc mr kd ms kf mt kg mu mv bi translated">使用Docker-Compose创建一个副本集</h1><p id="23e9" class="pw-post-body-paragraph ki kj it kk b kl mw ju kn ko mx jx kq kr my kt ku kv mz kx ky kz na lb lc ld im bi translated">我们将创建一个Docker-Compose配置文件，该文件创建了MongoDB容器的3个实例，以拥有一个完整的副本集:一个主副本集、一个辅助副本集和一个仲裁副本集。</p><figure class="lt lu lv lw gt lx"><div class="bz fp l di"><div class="np nq l"/></div></figure><p id="e545" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">要启动MongoDB副本集，只需执行以下操作:</p><pre class="lt lu lv lw gt ng ne nh ni aw nj bi"><span id="23d3" class="nk mf it ne b gy nl nm l nn no">docker-compose up -d</span></pre><h2 id="9ffa" class="nk mf it bd mg nr ns dn mk nt nu dp mo kr nv nw mq kv nx ny ms kz nz oa mu ob bi translated">集装箱测试</h2><p id="17cc" class="pw-post-body-paragraph ki kj it kk b kl mw ju kn ko mx jx kq kr my kt ku kv mz kx ky kz na lb lc ld im bi translated">为了方便和进一步的平台独立性，可以将测试放在Docker-Compose配置中:</p><figure class="lt lu lv lw gt lx"><div class="bz fp l di"><div class="np nq l"/></div></figure><p id="c636" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">要使用MongoCI在Node.js测试中使用凭证连接到副本集，请执行以下操作:</p><figure class="lt lu lv lw gt lx"><div class="bz fp l di"><div class="np nq l"/></div></figure><p id="2da7" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">并在存储库测试中调用<code class="fe nb nc nd ne b">initMongoConnectionWithDBName</code>:</p><pre class="lt lu lv lw gt ng ne nh ni aw nj bi"><span id="a9d4" class="nk mf it ne b gy nl nm l nn no">beforeAll(async () =&gt; initMongoConnectionWithDBName('test'));</span></pre><p id="db80" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">然后以下命令将运行测试:</p><pre class="lt lu lv lw gt ng ne nh ni aw nj bi"><span id="e3c1" class="nk mf it ne b gy nl nm l nn no">docker-compose -p test up --exit-code-from nodejs-test nodejs-test</span></pre><h2 id="d6da" class="nk mf it bd mg nr ns dn mk nt nu dp mo kr nv nw mq kv nx ny ms kz nz oa mu ob bi translated">创建NPM命令</h2><p id="7a93" class="pw-post-body-paragraph ki kj it kk b kl mw ju kn ko mx jx kq kr my kt ku kv mz kx ky kz na lb lc ld im bi translated">为了更方便，可以创建NPM脚本，并将这些命令放入其中:</p><figure class="lt lu lv lw gt lx"><div class="bz fp l di"><div class="np nq l"/></div></figure><p id="8fe4" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">这将允许我们只通过以下命令运行容器化测试:</p><pre class="lt lu lv lw gt ng ne nh ni aw nj bi"><span id="92ea" class="nk mf it ne b gy nl nm l nn no">npm test</span></pre><p id="d54f" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">测试结束后会进行清理。</p><h1 id="595a" class="me mf it bd mg mh mi mj mk ml mm mn mo jz mp ka mq kc mr kd ms kf mt kg mu mv bi translated">笔记</h1><ul class=""><li id="982d" class="le lf it kk b kl mw ko mx kr oc kv od kz oe ld lj lk ll lm bi translated">将测试放入容器不仅仅是为了方便:我们使用主机名<code class="fe nb nc nd ne b">mongodb-primary</code>,默认情况下在Docker网络上下文中解析，而不是在主机上。此外，MongoDB端口不向主机公开。</li><li id="9c2a" class="le lf it kk b kl ln ko lo kr lp kv lq kz lr ld lj lk ll lm bi translated">使用函数<code class="fe nb nc nd ne b">initMongoConnectionWithDBName</code>可以使用基于云的或远程的MongoDB部署，并随机化DB名称以避免竞争情况。</li><li id="46e8" class="le lf it kk b kl ln ko lo kr lp kv lq kz lr ld lj lk ll lm bi translated">Docker-Compose命令中的<code class="fe nb nc nd ne b">-p</code>选项代表“项目”。这意味着人们可以基于相同的Docker-Compose配置创建不同的项目，并且它们不会冲突。因此，您可以在测试的同时使用另一个项目名来运行您的服务器。</li></ul><h1 id="942d" class="me mf it bd mg mh mi mj mk ml mm mn mo jz mp ka mq kc mr kd ms kf mt kg mu mv bi translated">结论</h1><p id="1a07" class="pw-post-body-paragraph ki kj it kk b kl mw ju kn ko mx jx kq kr my kt ku kv mz kx ky kz na lb lc ld im bi translated">使用内存中的MongoDB实例进行存储库测试是一种方便的解决方案，但是如果想要针对副本集进行测试，这种解决方案就行不通了。用Docker-Compose和MongoCI提出的解决方案是免费的，并且与CI兼容。</p></div></div>    
</body>
</html>