<html>
<head>
<title>Amazon QuickSight Identity Federation with Auth0</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Auth0的Amazon QuickSight身份联盟</h1>
<blockquote>原文：<a href="https://itnext.io/amazon-quicksight-identity-federation-with-auth0-2cae6a5f3a0a?source=collection_archive---------1-----------------------#2021-02-27">https://itnext.io/amazon-quicksight-identity-federation-with-auth0-2cae6a5f3a0a?source=collection_archive---------1-----------------------#2021-02-27</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="3474" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">通过第三方企业身份提供商(IdP)管理QuickSight用户</h2></div><h1 id="862d" class="ki kj it bd kk kl km kn ko kp kq kr ks jz kt ka ku kc kv kd kw kf kx kg ky kz bi translated">介绍</h1><p id="16e2" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated">作为一名与分析客户合作的解决方案架构师，我经常被问到关于将Amazon QuickSight与Active Directory集成，或者与第三方身份提供商进行单点登录以进行用户管理的问题。</p><h2 id="4505" class="lw kj it bd kk lx ly dn ko lz ma dp ks lj mb mc ku ln md me kw lr mf mg ky mh bi translated">亚马逊QuickSight</h2><p id="11e7" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated">根据AWS的说法，Amazon QuickSight是一种可扩展、无服务器、可嵌入、基于机器学习的商业智能(BI)服务。QuickSight可让您轻松创建和发布交互式BI仪表盘，其中包含基于机器学习的见解。QuickSight仪表盘可从任何设备访问，并无缝嵌入到您的应用、门户和网站中。</p><figure class="mk ml mm mn gt mo gh gi paragraph-image"><div role="button" tabindex="0" class="mp mq di mr bf ms"><div class="gh gi mj"><img src="../Images/accc560ede00ac7fb43565e1984e7dc0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*HuOtrYQsjyMbhQP6Z52OcQ.png"/></div></div></figure><h2 id="daef" class="lw kj it bd kk lx ly dn ko lz ma dp ks lj mb mc ku ln md me kw lr mf mg ky mh bi translated">Auth0</h2><p id="9d21" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated"><a class="ae mi" href="https://auth0.com/single-sign-on/" rel="noopener ugc nofollow" target="_blank"> Auth0 </a>是一个易于实现、适应性强的认证和授权平台。根据Auth0的说法，Auth0的身份和管理平台提供了更好的控制、更高的安全性和易用性。<a class="ae mi" href="https://auth0.com/docs/sso" rel="noopener ugc nofollow" target="_blank">单点登录</a> (SSO)，无论是通过企业联盟、社交登录，还是用户名密码认证，据Auth0称，都允许用户只需登录一次，就可以使用他们被授权访问的所有应用。</p><figure class="mk ml mm mn gt mo gh gi paragraph-image"><div role="button" tabindex="0" class="mp mq di mr bf ms"><div class="gh gi mj"><img src="../Images/51a96d4c92e2494fecb86ef543412ae6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*_cBpl9JkQywVlQD_WHAG5Q.png"/></div></div></figure><h2 id="7dd4" class="lw kj it bd kk lx ly dn ko lz ma dp ks lj mb mc ku ln md me kw lr mf mg ky mh bi translated">身份联盟</h2><p id="8408" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated">据<a class="ae mi" href="https://docs.aws.amazon.com/quicksight/latest/user/external-identity-providers.html" rel="noopener ugc nofollow" target="_blank"> AWS </a>报道，亚马逊QuickSight支持标准版和企业版的身份联合。借助联合身份，您可以通过您的企业<a class="ae mi" href="https://docs.aws.amazon.com/IAM/latest/UserGuide/id_roles_providers.html" rel="noopener ugc nofollow" target="_blank">身份提供商</a> (IdP)管理用户，并使用AWS身份和访问管理(IAM)在用户登录Amazon QuickSight时对其进行身份验证。您可以使用支持<a class="ae mi" href="https://aws.amazon.com/identity/saml/" rel="noopener ugc nofollow" target="_blank">安全声明标记语言2.0 </a> (SAML 2.0)的第三方身份提供者为您的QuickSight用户提供简单的入职流程。这样的身份提供者包括<a class="ae mi" href="https://docs.microsoft.com/en-us/windows-server/identity/active-directory-federation-services" rel="noopener ugc nofollow" target="_blank">微软活动目录联合服务</a>(AD FS)<a class="ae mi" href="https://www.okta.com/" rel="noopener ugc nofollow" target="_blank">Okta</a>，<a class="ae mi" href="https://www.pingidentity.com/en/software/pingfederate.html" rel="noopener ugc nofollow" target="_blank"> Ping身份</a>，<a class="ae mi" href="https://duo.com/docs/sso-generic" rel="noopener ugc nofollow" target="_blank"> Duo </a>，<a class="ae mi" href="https://docs.microsoft.com/en-us/azure/active-directory/manage-apps/configure-password-single-sign-on-non-gallery-applications" rel="noopener ugc nofollow" target="_blank"> Azure AD </a>，以及<a class="ae mi" href="https://auth0." rel="noopener ugc nofollow" target="_blank"> Auth0 </a>。</p><p id="04ca" class="pw-post-body-paragraph la lb it lc b ld mv ju lf lg mw jx li lj mx ll lm ln my lp lq lr mz lt lu lv im bi translated">借助identity federation，您的用户可以使用他们现有的身份凭证，一键访问他们的Amazon QuickSight应用程序。您还可以通过身份提供商获得身份认证的安全性优势。您可以使用现有的身份提供商控制哪些用户可以访问Amazon QuickSight。经过身份验证的用户可以绕过AWS管理控制台，直接登录QuickSight。</p><h2 id="3e53" class="lw kj it bd kk lx ly dn ko lz ma dp ks lj mb mc ku ln md me kw lr mf mg ky mh bi translated">从Amazon QuickSight启动登录</h2><p id="acc5" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated">在本文的<a class="ae mi" href="https://docs.aws.amazon.com/quicksight/latest/user/federated-identities-sp-to-idp.html" rel="noopener ugc nofollow" target="_blank">场景</a>中，用户从Amazon QuickSight应用程序门户启动登录过程，而没有登录到身份提供者Auth0。用户拥有由Auth0管理的现有联合帐户。用户可能已经拥有或尚未拥有QuickSight帐户。QuickSight向IdP发送身份验证请求，即Auth0。用户成功通过身份验证后，QuickSight会打开。</p><p id="4e71" class="pw-post-body-paragraph la lb it lc b ld mv ju lf lg mw jx li lj mx ll lm ln my lp lq lr mz lt lu lv im bi translated">在这篇文章中，我们假设你已经注册了Amazon QuickSight的企业版，并选择了<strong class="lc iu">使用基于角色的联盟(SSO) </strong>，而不是<strong class="lc iu">使用活动目录</strong>。<strong class="lc iu">使用基于角色的联盟(SSO) </strong>选项将允许我们配置第三方IdP进行身份认证。</p><figure class="mk ml mm mn gt mo gh gi paragraph-image"><div role="button" tabindex="0" class="mp mq di mr bf ms"><div class="gh gi mj"><img src="../Images/5e3c54a9cbb21ca49fa9e62bb1ec5f40.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*erjjdMhV1slYWHidEMRrDw.png"/></div></div></figure><h2 id="423d" class="lw kj it bd kk lx ly dn ko lz ma dp ks lj mb mc ku ln md me kw lr mf mg ky mh bi translated">Auth0用户和角色</h2><p id="1ea7" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated">在Auth0的<strong class="lc iu">用户管理</strong>界面中，创建三个用户及其相关角色，代表三个QuickSight角色:管理员、作者和读者。出于演示目的，我选择根据这三个用户的QuickSight角色来命名他们:QuickSightAdmin1、QuickSightAuthor1和QuickSightReader1。</p><figure class="mk ml mm mn gt mo gh gi paragraph-image"><div role="button" tabindex="0" class="mp mq di mr bf ms"><div class="gh gi mj"><img src="../Images/4b87968c7c17948e23c03dcf40d24574.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*DcVPqZylaHg5ngr_5qX6Qg.png"/></div></div></figure><p id="a5f7" class="pw-post-body-paragraph la lb it lc b ld mv ju lf lg mw jx li lj mx ll lm ln my lp lq lr mz lt lu lv im bi translated">接下来，创建三个角色:QuickSight-Admin-Role、QuickSight-Author-Role和QuickSight-Reader-Role。角色名称是任意的，只要它们与AWS中的等价IAM角色相同(稍后在文章中创建的<em class="na">)。</em></p><figure class="mk ml mm mn gt mo gh gi paragraph-image"><div role="button" tabindex="0" class="mp mq di mr bf ms"><div class="gh gi mj"><img src="../Images/971555e2ca962a3c17524507902175f4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*UOGIpDRKvbMS40A7FsIwDw.png"/></div></div></figure><p id="4b08" class="pw-post-body-paragraph la lb it lc b ld mv ju lf lg mw jx li lj mx ll lm ln my lp lq lr mz lt lu lv im bi translated">将每个用户与其对应的角色相关联，每个角色对应一个用户。例如，将<strong class="lc iu"> QuickSightDemoAdmin1 </strong>用户与<strong class="lc iu"> QuickSight-Admin-Role </strong>角色相关联。</p><figure class="mk ml mm mn gt mo gh gi paragraph-image"><div role="button" tabindex="0" class="mp mq di mr bf ms"><div class="gh gi mj"><img src="../Images/9ba2db61a1538da9e836d813592ec6e9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*LHY_V51TuJHSXxdPOLcgug.png"/></div></div></figure><h2 id="c238" class="lw kj it bd kk lx ly dn ko lz ma dp ks lj mb mc ku ln md me kw lr mf mg ky mh bi translated">Auth0应用程序</h2><p id="8a2d" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated">接下来，在Auth0的<strong class="lc iu">应用</strong>界面，新建一个<strong class="lc iu">常规Web应用</strong>。将新应用程序命名为<strong class="lc iu"> Amazon QuickSight </strong>。</p><figure class="mk ml mm mn gt mo gh gi paragraph-image"><div role="button" tabindex="0" class="mp mq di mr bf ms"><div class="gh gi mj"><img src="../Images/32e08d1a173280ca222c2bbc509786e0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*S8cyGdGQMejFACHWeSoq1w.png"/></div></div></figure><p id="0f0a" class="pw-post-body-paragraph la lb it lc b ld mv ju lf lg mw jx li lj mx ll lm ln my lp lq lr mz lt lu lv im bi translated">在新应用程序的<strong class="lc iu">插件</strong>选项卡上，启用<strong class="lc iu"> SAML2 Web App </strong>选项。</p><figure class="mk ml mm mn gt mo gh gi paragraph-image"><div role="button" tabindex="0" class="mp mq di mr bf ms"><div class="gh gi mj"><img src="../Images/7dfeeee27744bc8b8da0717800a4d764.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*HsAhgO_h1aXJylGRCj_F6A.png"/></div></div></figure><p id="5b09" class="pw-post-body-paragraph la lb it lc b ld mv ju lf lg mw jx li lj mx ll lm ln my lp lq lr mz lt lu lv im bi translated">在<strong class="lc iu"> SAML2 Web App </strong> Addon的<strong class="lc iu">设置</strong>选项卡上，将<strong class="lc iu">应用回调URL </strong>值设置为<code class="fe nb nc nd ne b">https://signin.aws.amazon.com/saml</code>。将<strong class="lc iu">设置</strong>的JSON blob值更改如下:</p><pre class="mk ml mm mn gt nf ne ng nh aw ni bi"><span id="18ef" class="lw kj it ne b gy nj nk l nl nm">{<br/>  "audience": "urn:amazon:webservices"<br/>}</span></pre><p id="c3ee" class="pw-post-body-paragraph la lb it lc b ld mv ju lf lg mw jx li lj mx ll lm ln my lp lq lr mz lt lu lv im bi translated">最终配置应该与下面的示例相匹配。</p><figure class="mk ml mm mn gt mo gh gi paragraph-image"><div role="button" tabindex="0" class="mp mq di mr bf ms"><div class="gh gi mj"><img src="../Images/2b294acc0ea2ce782a883669b8f6a380.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ACouVORjhqizlcZP3HXmiA.png"/></div></div></figure><p id="729b" class="pw-post-body-paragraph la lb it lc b ld mv ju lf lg mw jx li lj mx ll lm ln my lp lq lr mz lt lu lv im bi translated">切换到<strong class="lc iu">用法</strong>选项卡。下载<strong class="lc iu">身份提供者元数据</strong> XML文件，并记下<strong class="lc iu">身份提供者登录URL </strong>的值。您将需要元数据文件和URL来配置QuickSight。</p><figure class="mk ml mm mn gt mo gh gi paragraph-image"><div role="button" tabindex="0" class="mp mq di mr bf ms"><div class="gh gi mj"><img src="../Images/968a4a3976e7a2be8f9f067cae1f8698.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*2lH0FAv9lp1pofGvaQ4U2g.png"/></div></div></figure><p id="2913" class="pw-post-body-paragraph la lb it lc b ld mv ju lf lg mw jx li lj mx ll lm ln my lp lq lr mz lt lu lv im bi translated">接下来，在新的<strong class="lc iu">亚马逊QuickSight </strong>应用程序的<strong class="lc iu">连接</strong>选项卡上，确保只有<strong class="lc iu">用户名-密码-认证</strong>被启用。</p><figure class="mk ml mm mn gt mo gh gi paragraph-image"><div role="button" tabindex="0" class="mp mq di mr bf ms"><div class="gh gi mj"><img src="../Images/142d4a20db41a39036ac4f85b63ae683.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*t8HhS6B3J_eLKROabdp-kw.png"/></div></div></figure><p id="f4eb" class="pw-post-body-paragraph la lb it lc b ld mv ju lf lg mw jx li lj mx ll lm ln my lp lq lr mz lt lu lv im bi translated">最后，在<strong class="lc iu">设置</strong>选项卡上，在<strong class="lc iu">应用URIs </strong>配置部分，确保<strong class="lc iu">允许回调URL</strong>值也被设置为<code class="fe nb nc nd ne b"><a class="ae mi" href="https://signin.aws.amazon.com/saml." rel="noopener ugc nofollow" target="_blank">https://signin.aws.amazon.com/saml</a></code> <a class="ae mi" href="https://signin.aws.amazon.com/saml." rel="noopener ugc nofollow" target="_blank">。</a></p><figure class="mk ml mm mn gt mo gh gi paragraph-image"><div role="button" tabindex="0" class="mp mq di mr bf ms"><div class="gh gi mj"><img src="../Images/4bbb9fb8c951a6ec240e4533addb0330.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*psQuUE3BdkYJzz6MePpxog.png"/></div></div></figure><h2 id="0684" class="lw kj it bd kk lx ly dn ko lz ma dp ks lj mb mc ku ln md me kw lr mf mg ky mh bi translated">授权管道规则</h2><p id="06cd" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated">接下来，在Auth0的<strong class="lc iu"> Auth Pipeline Rules </strong>接口中，创建一个新的<strong class="lc iu">空规则</strong>。</p><figure class="mk ml mm mn gt mo gh gi paragraph-image"><div role="button" tabindex="0" class="mp mq di mr bf ms"><div class="gh gi mj"><img src="../Images/6ced9e6b02322bd452772ee71026270e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*gHFGg9MOk35C2Eo5C6ZXhw.png"/></div></div></figure><p id="e353" class="pw-post-body-paragraph la lb it lc b ld mv ju lf lg mw jx li lj mx ll lm ln my lp lq lr mz lt lu lv im bi translated">命名新规则:<strong class="lc iu">更改QuickSight SAML配置</strong>。</p><figure class="mk ml mm mn gt mo gh gi paragraph-image"><div role="button" tabindex="0" class="mp mq di mr bf ms"><div class="gh gi mj"><img src="../Images/f372c728c0ef63834efcc60968bd0551.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*LajpUAyEvlsuaUvFtGPUdw.png"/></div></div></figure><p id="f523" class="pw-post-body-paragraph la lb it lc b ld mv ju lf lg mw jx li lj mx ll lm ln my lp lq lr mz lt lu lv im bi translated">对于<strong class="lc iu">脚本</strong>字段值，使用下面的JavaScript代码片段。</p><pre class="mk ml mm mn gt nf ne ng nh aw ni bi"><span id="83d4" class="lw kj it ne b gy nj nk l nl nm">function changeSamlConfiguration(user, context, callback) {<br/>    if (context.clientID !== '<strong class="ne iu">&lt;your_web_client_id&gt;</strong>')<br/>        return callback(null, user, context);</span><span id="ed46" class="lw kj it ne b gy nn nk l nl nm">const assignedRoles = (context.authorization || {}).roles;<br/>    const accountId = '<strong class="ne iu">&lt;your_aws_account_id&gt;</strong>';<br/>    const provider = 'saml-provider/Auth0';</span><span id="6b86" class="lw kj it ne b gy nn nk l nl nm">user.awsRole = 'arn:aws:iam::' + accountId + ':role/' + assignedRoles[0] +<br/>        ',arn:aws:iam::' + accountId + ':' + provider;</span><span id="a2ce" class="lw kj it ne b gy nn nk l nl nm">user.quickSightUser = user.name.replace(/@.*/, '');</span><span id="1c06" class="lw kj it ne b gy nn nk l nl nm">context.samlConfiguration.mappings = {<br/>        'https://aws.amazon.com/SAML/Attributes/Role': 'awsRole',<br/>        'https://aws.amazon.com/SAML/Attributes/RoleSessionName': 'quickSightUser',<br/>    };</span><span id="8c34" class="lw kj it ne b gy nn nk l nl nm">callback(null, user, context);<br/>}</span></pre><p id="f46d" class="pw-post-body-paragraph la lb it lc b ld mv ju lf lg mw jx li lj mx ll lm ln my lp lq lr mz lt lu lv im bi translated">用您之前创建的<strong class="lc iu"> Amazon QuickSight </strong>常规web应用程序的客户端ID替换<code class="fe nb nc nd ne b">&lt;your_web_client_id&gt;</code>占位符。客户端ID列在<strong class="lc iu">应用程序</strong>界面中，在应用程序名称旁边。此外，用您的十二位数字AWS帐户Id替换<code class="fe nb nc nd ne b">&lt;your_aws_account_id&gt;</code>占位符。</p><figure class="mk ml mm mn gt mo gh gi paragraph-image"><div role="button" tabindex="0" class="mp mq di mr bf ms"><div class="gh gi mj"><img src="../Images/b6ecc1318c40a89f291fcd544267b45c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*aAYVkQKZyT08CdJ-wXIrjg.png"/></div></div></figure><p id="681e" class="pw-post-body-paragraph la lb it lc b ld mv ju lf lg mw jx li lj mx ll lm ln my lp lq lr mz lt lu lv im bi translated">该规则将用于修改SAML断言，如下面的SAML断言片段示例所示，由Auth0作为身份验证过程的一部分返回。该规则将注入IAM角色的Amazon资源名称(ARN ), auth 0用户应该与之相关联:QuickSight-Admin-Role、QuickSight-Author-Role或QuickSight-Reader-Role。请注意，该规则假设每个用户有一个角色。如果用户被分配了多个角色，则需要额外的逻辑。</p><figure class="mk ml mm mn gt mo gh gi paragraph-image"><div role="button" tabindex="0" class="mp mq di mr bf ms"><div class="gh gi no"><img src="../Images/6cba81207e8f523827f9266c5ef0df31.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Qy8hL1IMY51lJAtaJl2EiA.png"/></div></div></figure><h2 id="b81f" class="lw kj it bd kk lx ly dn ko lz ma dp ks lj mb mc ku ln md me kw lr mf mg ky mh bi translated">AWS IAM身份提供者</h2><p id="ddeb" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated">回到AWS管理控制台，为Auth0添加一个AWS IAM身份提供者。从IAM控制台的<strong class="lc iu">身份提供者</strong>界面，单击<strong class="lc iu">添加提供者</strong>。对于<strong class="lc iu">提供者类型</strong>，选择<strong class="lc iu"> SAML </strong>。命名提供者，<strong class="lc iu"> Auth0 </strong>。在<strong class="lc iu">元数据文档</strong>部分点击<strong class="lc iu">选择文件</strong>。选择您之前从Auth0下载的元数据文档。点击<strong class="lc iu">添加提供商</strong>完成。</p><figure class="mk ml mm mn gt mo gh gi paragraph-image"><div role="button" tabindex="0" class="mp mq di mr bf ms"><div class="gh gi mj"><img src="../Images/3872ba401e01daaa694819109524c1d2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*hMQ9Ibz6knJd_HOc7Yxx1Q.png"/></div></div></figure><p id="558e" class="pw-post-body-paragraph la lb it lc b ld mv ju lf lg mw jx li lj mx ll lm ln my lp lq lr mz lt lu lv im bi translated">生成的Auth0 IAM身份提供程序应类似于以下示例。</p><figure class="mk ml mm mn gt mo gh gi paragraph-image"><div role="button" tabindex="0" class="mp mq di mr bf ms"><div class="gh gi mj"><img src="../Images/9d3b7fc383c83397079dd46e69a4ce1b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*go7jucaaq09qazZR48IRHQ.png"/></div></div></figure><h2 id="ccce" class="lw kj it bd kk lx ly dn ko lz ma dp ks lj mb mc ku ln md me kw lr mf mg ky mh bi translated">AWS IAM策略和角色</h2><p id="5c1d" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated">接下来，创建三个AWS IAM角色，分别对应于管理员、作者和读者这三个QuickSight角色。这三个角色也对应于我们之前创建的三个Auth0角色。Auth0用户将在SAML文档中传递Auth0角色名称。Auth0角色名称将对应于IAM角色。IAM角色定义了Auth0用户对QuickSight拥有的权限。我们可以将许多Auth0用户关联到一个Auth0角色，并相应地关联到一个IAM角色。</p><p id="0bd4" class="pw-post-body-paragraph la lb it lc b ld mv ju lf lg mw jx li lj mx ll lm ln my lp lq lr mz lt lu lv im bi translated">首先，创建三个IAM策略:QuickSight-Admin-Policy、QuickSight-Author-Policy和QuickSight-Reader-Policy。这些策略都将与相应的IAM角色相关联。创建策略<strong class="lc iu"> QuickSight-Admin-Policy </strong>。用您的十二位数字AWS帐户Id替换<code class="fe nb nc nd ne b">&lt;your_aws_account_id&gt;</code>占位符。</p><pre class="mk ml mm mn gt nf ne ng nh aw ni bi"><span id="de39" class="lw kj it ne b gy nj nk l nl nm">{<br/>    "Version": "2012-10-17",<br/>    "Statement": [<br/>        {<br/>            "Effect": "Allow",<br/>            "Action": "quicksight:CreateAdmin",<br/>            "Resource": "arn:aws:quicksight::<strong class="ne iu">&lt;your_aws_account_id&gt;</strong>:user/${aws:userid}"<br/>        }<br/>    ]<br/>}</span></pre><p id="4509" class="pw-post-body-paragraph la lb it lc b ld mv ju lf lg mw jx li lj mx ll lm ln my lp lq lr mz lt lu lv im bi translated">然后，<strong class="lc iu">快视-作者-政策</strong>。</p><pre class="mk ml mm mn gt nf ne ng nh aw ni bi"><span id="44d6" class="lw kj it ne b gy nj nk l nl nm">{<br/>    "Version": "2012-10-17",<br/>    "Statement": [<br/>        {<br/>            "Effect": "Allow",<br/>            "Action": "<strong class="ne iu">quicksight:CreateUser</strong>",<br/>            "Resource": "arn:aws:quicksight::<strong class="ne iu">&lt;your_aws_account_id&gt;</strong>:user/${aws:userid}"<br/>        }<br/>    ]<br/>}</span></pre><p id="6c05" class="pw-post-body-paragraph la lb it lc b ld mv ju lf lg mw jx li lj mx ll lm ln my lp lq lr mz lt lu lv im bi translated">最后，<strong class="lc iu">快速浏览-读者-政策</strong>。</p><pre class="mk ml mm mn gt nf ne ng nh aw ni bi"><span id="9388" class="lw kj it ne b gy nj nk l nl nm">{<br/>    "Version": "2012-10-17",<br/>    "Statement": [<br/>        {<br/>            "Effect": "Allow",<br/>            "Action": "<strong class="ne iu">quicksight:CreateReader</strong>",<br/>            "Resource": "arn:aws:quicksight::<strong class="ne iu">&lt;your_aws_account_id&gt;</strong>:user/${aws:userid}"<br/>        }<br/>    ]<br/>}</span></pre><p id="1124" class="pw-post-body-paragraph la lb it lc b ld mv ju lf lg mw jx li lj mx ll lm ln my lp lq lr mz lt lu lv im bi translated">接下来，创建三个相应的IAM角色，并关联相应的IAM策略:quick sight-Admin-Role(quick sight-Admin-Policy)、quick sight-Author-Role(quick sight-Author-Policy)和quick sight-Reader-Role(quick sight-Reader-Policy)。</p><figure class="mk ml mm mn gt mo gh gi paragraph-image"><div role="button" tabindex="0" class="mp mq di mr bf ms"><div class="gh gi mj"><img src="../Images/381c1a9a7e8f6696ec3d0f5090e3a1ce.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*X0NQEk-Bp12i6haJf4zBKg.png"/></div></div></figure><p id="6c09" class="pw-post-body-paragraph la lb it lc b ld mv ju lf lg mw jx li lj mx ll lm ln my lp lq lr mz lt lu lv im bi translated">角色的<strong class="lc iu">信任关系</strong>在角色和Auth0 IAM身份提供者之间建立信任关系，如下所示。</p><figure class="mk ml mm mn gt mo gh gi paragraph-image"><div role="button" tabindex="0" class="mp mq di mr bf ms"><div class="gh gi mj"><img src="../Images/fa9f646740353eda657bf0c74ec2d17b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*VnGBj7ddRPpMxZ16v3qXTA.png"/></div></div></figure><p id="c701" class="pw-post-body-paragraph la lb it lc b ld mv ju lf lg mw jx li lj mx ll lm ln my lp lq lr mz lt lu lv im bi translated">对于三个角色中的每一个，点击<strong class="lc iu">编辑信任关系</strong>并修改访问控制策略文档，如下所示。用您的十二位数字AWS帐户Id替换<code class="fe nb nc nd ne b">&lt;your_aws_account_id&gt;</code>占位符。</p><pre class="mk ml mm mn gt nf ne ng nh aw ni bi"><span id="e72f" class="lw kj it ne b gy nj nk l nl nm">{<br/>  "Version": "2012-10-17",<br/>  "Statement": [<br/>    {<br/>      "Effect": "Allow",<br/>      "Principal": {<br/>        "Federated": "arn:aws:iam::<strong class="ne iu">&lt;your_aws_account_id&gt;</strong>:saml-provider/Auth0"<br/>      },<br/>      "Action": "sts:AssumeRoleWithSAML",<br/>      "Condition": {<br/>        "StringEquals": {<br/>          "saml:aud": "https://signin.aws.amazon.com/saml"<br/>        }<br/>      }<br/>    }<br/>  ]<br/>}</span></pre><p id="b85f" class="pw-post-body-paragraph la lb it lc b ld mv ju lf lg mw jx li lj mx ll lm ln my lp lq lr mz lt lu lv im bi translated">角色的访问控制策略文档还包括一个<code class="fe nb nc nd ne b">Condition</code>策略元素。根据AWS IAM <a class="ae mi" href="https://docs.aws.amazon.com/IAM/latest/UserGuide/id_roles_providers_create_saml_assertions.html#saml_audience-restriction" rel="noopener ugc nofollow" target="_blank">文档</a>，出于安全原因，AWS应该作为受众包含在您的IdP发送给AWS的SAML断言中。对于<code class="fe nb nc nd ne b">Audience</code>元素的值，指定<code class="fe nb nc nd ne b">https://signin.aws.amazon.com/saml</code>或<code class="fe nb nc nd ne b">urn:amazon:webservices</code>。</p><p id="9a7c" class="pw-post-body-paragraph la lb it lc b ld mv ju lf lg mw jx li lj mx ll lm ln my lp lq lr mz lt lu lv im bi translated">我们可以通过将响应有效负载中的表单数据从Base64格式解码为XML来检查从Auth0返回的SAML断言。下面，我们看到SAML断言使用Chrome的开发工具来检查网络活动。</p><figure class="mk ml mm mn gt mo gh gi paragraph-image"><div role="button" tabindex="0" class="mp mq di mr bf ms"><div class="gh gi mj"><img src="../Images/7910a5922133edb8770032ee01eac2f5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*vr1Lj7ab2kBDF3_DH66r6g.png"/></div></div></figure><p id="b5cf" class="pw-post-body-paragraph la lb it lc b ld mv ju lf lg mw jx li lj mx ll lm ln my lp lq lr mz lt lu lv im bi translated">请注意，AWS IAM <a class="ae mi" href="https://docs.aws.amazon.com/IAM/latest/UserGuide/id_roles_providers_create_saml_assertions.html#saml_audience-restriction" rel="noopener ugc nofollow" target="_blank">文档</a>指出，来自IdP的SAML断言中的SAML <code class="fe nb nc nd ne b">AudienceRestriction</code>值不<em class="na">映射到可以在IAM策略中测试的<code class="fe nb nc nd ne b">saml:aud</code>上下文键。相反，<code class="fe nb nc nd ne b">saml:aud</code>上下文关键字来自SAML <em class="na">接收者</em>属性，因为它是等同于OIDC观众字段的SAML，例如，通过<code class="fe nb nc nd ne b">accounts.google.com:aud</code>。这些显示在下面的SAML断言XML片段中。</em></p><figure class="mk ml mm mn gt mo gh gi paragraph-image"><div role="button" tabindex="0" class="mp mq di mr bf ms"><div class="gh gi no"><img src="../Images/f8c493ff1cf709ae0340126faf2252bc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*RritvXvhSvmGrO3EnwDP8g.png"/></div></div></figure><h2 id="cc62" class="lw kj it bd kk lx ly dn ko lz ma dp ks lj mb mc ku ln md me kw lr mf mg ky mh bi translated">QuickSight IdP配置</h2><p id="0053" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated">集成QuickSight和Auth0的最后一步是用Auth0的特定IdP信息配置QuickSight。从QuickSight管理界面中，选择<strong class="lc iu">单点登录(SSO) </strong>。在上将<strong class="lc iu">状态</strong>切换到<strong class="lc iu">。</strong></p><figure class="mk ml mm mn gt mo gh gi paragraph-image"><div role="button" tabindex="0" class="mp mq di mr bf ms"><div class="gh gi mj"><img src="../Images/c133fdc4b4964595ba059ef782866bdc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*MTZHQlJDAz1gLNk-obQx3Q.png"/></div></div></figure><p id="754e" class="pw-post-body-paragraph la lb it lc b ld mv ju lf lg mw jx li lj mx ll lm ln my lp lq lr mz lt lu lv im bi translated">添加<strong class="lc iu"> IdP URL </strong>值。提醒一下，这个值来自于Auth0 Amazon QuickSight应用程序的<strong class="lc iu"> SAML2 Web App </strong> Addon的<strong class="lc iu">用法</strong>选项卡、<strong class="lc iu">身份提供者登录URL </strong>值(<em class="na">见下文</em>)。确保复制与显示的URL相关联的实际链接。</p><figure class="mk ml mm mn gt mo gh gi paragraph-image"><div role="button" tabindex="0" class="mp mq di mr bf ms"><div class="gh gi mj"><img src="../Images/03a9e7fb0bdb4148af0ffa286c01898a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*HU4ctb-JFDw8pm2SM67LgA.png"/></div></div></figure><p id="43b9" class="pw-post-body-paragraph la lb it lc b ld mv ju lf lg mw jx li lj mx ll lm ln my lp lq lr mz lt lu lv im bi translated">最后，对于<strong class="lc iu"> IdP重定向URL参数</strong>值，使用<strong class="lc iu"> RelayState </strong>。选择<strong class="lc iu">保存</strong>保存IdP配置。</p><h2 id="ac68" class="lw kj it bd kk lx ly dn ko lz ma dp ks lj mb mc ku ln md me kw lr mf mg ky mh bi translated">测试身份联盟</h2><p id="8d20" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated">测试集成最简单的方法是打开一个新的匿名窗口，将浏览器指向<code class="fe nb nc nd ne b">https://quicksight.aws.amazon.com</code>。应该会提示您输入QuickSight帐户名。您在注册QuickSight时创建了自己的帐户名称(例如，acme-corp-sales)。</p><figure class="mk ml mm mn gt mo gh gi paragraph-image"><div role="button" tabindex="0" class="mp mq di mr bf ms"><div class="gh gi mj"><img src="../Images/42cef6319e9e1280470a819e95c52aa7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*LkgwvdYzkVHabF855r3YKA.png"/></div></div></figure><p id="ceb0" class="pw-post-body-paragraph la lb it lc b ld mv ju lf lg mw jx li lj mx ll lm ln my lp lq lr mz lt lu lv im bi translated">一旦您输入了您的QuickSight帐户名称，您将被重定向到Auth0，并显示Amazon QuickSight应用程序的登录屏幕。输入三个Auth0用户的电子邮件地址和密码中的任意一个。</p><figure class="mk ml mm mn gt mo gh gi paragraph-image"><div role="button" tabindex="0" class="mp mq di mr bf ms"><div class="gh gi mj"><img src="../Images/0a5787e8026b356fca269634a5aa4d46.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*XGi7BkKZIP-uRiHT9ngNhA.png"/></div></div></figure><p id="1e17" class="pw-post-body-paragraph la lb it lc b ld mv ju lf lg mw jx li lj mx ll lm ln my lp lq lr mz lt lu lv im bi translated">如果Auth0登录成功，您将被重定向回QuickSight应用程序门户。如果这是用户第一次登录QuickSight，系统会提示您输入用户的电子邮件地址。使用与用户在Auth0中关联的相同电子邮件地址。在这种情况下，用户将向QuickSight进行自我注册，并与默认的<em class="na"/><a class="ae mi" href="https://docs.aws.amazon.com/quicksight/latest/user/namespaces.html" rel="noopener ugc nofollow" target="_blank">名称空间</a>相关联。</p><figure class="mk ml mm mn gt mo gh gi paragraph-image"><div role="button" tabindex="0" class="mp mq di mr bf ms"><div class="gh gi mj"><img src="../Images/bd8f5616568270a5c052743d23ff3a30.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*yyL3iWmLZTmcvUsfodeg2g.png"/></div></div></figure><p id="f43f" class="pw-post-body-paragraph la lb it lc b ld mv ju lf lg mw jx li lj mx ll lm ln my lp lq lr mz lt lu lv im bi translated">根据与用户相关联的IAM角色(读者、作者或管理员),您的QuickSight体验和可用功能会有所不同。</p><figure class="mk ml mm mn gt mo gh gi paragraph-image"><div role="button" tabindex="0" class="mp mq di mr bf ms"><div class="gh gi mj"><img src="../Images/bea204cac01018b5db0da5750f6663d1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*sdc-y6P6jm70-PiH5mosCg.png"/></div></div></figure><p id="afe8" class="pw-post-body-paragraph la lb it lc b ld mv ju lf lg mw jx li lj mx ll lm ln my lp lq lr mz lt lu lv im bi translated">关闭隐名浏览器窗口，结束当前用户会话。打开一个新的匿名浏览器窗口，对剩下的两个用户重复该过程，确保每个用户都能成功登录。此外，请确保用户在QuickSight中的体验与相关角色(读者、作者或管理员)相匹配。</p><h2 id="ca32" class="lw kj it bd kk lx ly dn ko lz ma dp ks lj mb mc ku ln md me kw lr mf mg ky mh bi translated">用户管理</h2><p id="bf7b" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated">作为QuickSight管理员，重新登录QuickSight并打开<strong class="lc iu">管理用户</strong>界面。所有三个Auth0用户都应该向QuickSight注册，如下例所示。用户应该与正确的IAM角色相关联(<em class="na">列1，在正斜杠</em>的左边):QuickSight-Admin-Role、QuickSight-Author-Role和QuickSight-Reader-Role。用户还应该与正确的QuickSight角色相关联(<em class="na">栏3，在</em>下面):读者、作者或管理员。</p><figure class="mk ml mm mn gt mo gh gi paragraph-image"><div role="button" tabindex="0" class="mp mq di mr bf ms"><div class="gh gi mj"><img src="../Images/af3b5fb89263342c6b0d4018ad6307db.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*I1HJcuqltB55oPSlvRi4Ww.png"/></div></div></figure><p id="4dc6" class="pw-post-body-paragraph la lb it lc b ld mv ju lf lg mw jx li lj mx ll lm ln my lp lq lr mz lt lu lv im bi translated">用户可以使用<strong class="lc iu">管理权限</strong>选项应用自定义权限。</p><figure class="mk ml mm mn gt mo gh gi paragraph-image"><div role="button" tabindex="0" class="mp mq di mr bf ms"><div class="gh gi mj"><img src="../Images/cd1866e60ae348ec932efd95b1f31b30.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*rWWF2usAQlz3fVWL0faYug.png"/></div></div></figure><h1 id="d4fe" class="ki kj it bd kk kl km kn ko kp kq kr ks jz kt ka ku kc kv kd kw kf kx kg ky kz bi translated">结论</h1><p id="b564" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated">在这篇文章中，我们了解了Amazon QuickSight如何支持身份联合。我们学习了如何使用第三方企业身份提供商(IdP)auth 0管理用户，以及如何使用AWS身份和访问管理(IAM)在用户登录Amazon QuickSight时对其进行身份验证。</p><h1 id="4653" class="ki kj it bd kk kl km kn ko kp kq kr ks jz kt ka ku kc kv kd kw kf kx kg ky kz bi translated">参考</h1><ul class=""><li id="148b" class="np nq it lc b ld le lg lh lj nr ln ns lr nt lv nu nv nw nx bi translated">AWS文档:<a class="ae mi" href="https://docs.aws.amazon.com/quicksight/latest/user/federated-identities-sp-to-idp.html" rel="noopener ugc nofollow" target="_blank">从Amazon QuickSight启动登录</a></li><li id="adb0" class="np nq it lc b ld ny lg nz lj oa ln ob lr oc lv nu nv nw nx bi translated">AWS文档:<a class="ae mi" href="https://docs.aws.amazon.com/quicksight/latest/user/tutorial-okta-quicksight.html" rel="noopener ugc nofollow" target="_blank">教程:使用Okta SSO访问Amazon quick sight</a></li><li id="c468" class="np nq it lc b ld ny lg nz lj oa ln ob lr oc lv nu nv nw nx bi translated">AWS博客:<a class="ae mi" href="https://aws.amazon.com/blogs/big-data/enabling-amazon-quicksight-federation-with-azure-ad/" rel="noopener ugc nofollow" target="_blank">使用Azure AD启用Amazon QuickSight联盟</a></li><li id="938d" class="np nq it lc b ld ny lg nz lj oa ln ob lr oc lv nu nv nw nx bi translated">AWS博客:<a class="ae mi" href="https://aws.amazon.com/blogs/big-data/federate-amazon-quicksight-access-with-okta/" rel="noopener ugc nofollow" target="_blank">联合Amazon QuickSight access和Okta </a></li></ul></div><div class="ab cl od oe hx of" role="separator"><span class="og bw bk oh oi oj"/><span class="og bw bk oh oi oj"/><span class="og bw bk oh oi"/></div><div class="im in io ip iq"><p id="8a8a" class="pw-post-body-paragraph la lb it lc b ld mv ju lf lg mw jx li lj mx ll lm ln my lp lq lr mz lt lu lv im bi translated">本博客代表我自己的观点，不代表我的雇主亚马逊网络服务公司的观点。所有产品名称、徽标和品牌都是其各自所有者的财产。</p></div></div>    
</body>
</html>