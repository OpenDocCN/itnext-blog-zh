<html>
<head>
<title>Jenkins: Redis deployment, and Helm subchart values</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">詹金斯:Redis部署和舵子图表值</h1>
<blockquote>原文：<a href="https://itnext.io/jenkins-redis-deployment-and-helm-subchart-values-633a3e31541c?source=collection_archive---------4-----------------------#2020-11-01">https://itnext.io/jenkins-redis-deployment-and-helm-subchart-values-633a3e31541c?source=collection_archive---------4-----------------------#2020-11-01</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div class="gh gi jn"><img src="../Images/3cee4e0c9be337d1b7bb36a571c2f25e.png" data-original-src="https://miro.medium.com/v2/resize:fit:260/format:webp/0*Ipn2LdthoX4YYVuf.png"/></div></figure><p id="21bc" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">任务是创建一个Jenkins作业，将Redis部署到Dev/Stage/Prod Kubernetes集群。</p><p id="9f3e" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">在<a class="ae ks" href="https://rtfm.co.ua/en/redis-running-master-slave-replication-in-kubernetes/" rel="noopener ugc nofollow" target="_blank"> Redis:在Kubernetes </a>中运行主从复制中，我们手动完成了它，看看它是如何工作的，现在是时候自动化它了。</p><p id="30af" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">主要问题是如何在部署期间为不同的环境传递参数？我想使用Bitnami的现有图表，同时从我们自己的Helm图表中部署它，并在每个开发/阶段/生产环境中使用一个<code class="fe kt ku kv kw b">values.yaml</code>文件。</p><p id="1246" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">嗯，我们仍然可以创建我们的掌舵图，并添加Redis Bitnami图作为<a class="ae ks" href="https://rtfm.co.ua/helm-dependencies-aka-subcharts-obzor-i-primer/" rel="noopener ugc nofollow" target="_blank">掌舵依赖关系</a>，并从父图表传递一个<code class="fe kt ku kv kw b">values.yaml</code>。</p><p id="c24c" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">这里的文档是<a class="ae ks" href="https://helm.sh/docs/chart_template_guide/subcharts_and_globals/#:~:text=A%20subchart%20is%20considered%20%22stand,be%20accessed%20by%20all%20charts." rel="noopener ugc nofollow" target="_blank">&gt;&gt;&gt;</a>。</p><p id="113d" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">所以，我们要做的是:</p><ul class=""><li id="4f5f" class="kx ky iq jw b jx jy kb kc kf kz kj la kn lb kr lc ld le lf bi translated">父图表— <em class="lg">后端—redis</em></li><li id="40ca" class="kx ky iq jw b jx lh kb li kf lj kj lk kn ll kr lc ld le lf bi translated">具有<a class="ae ks" href="https://bitnami.com/stack/redis" rel="noopener ugc nofollow" target="_blank"> bitnami/redis </a>依赖性</li><li id="80a1" class="kx ky iq jw b jx lh kb li kf lj kj lk kn ll kr lc ld le lf bi translated">同<code class="fe kt ku kv kw b">env</code>目录</li><li id="0ef6" class="kx ky iq jw b jx lh kb li kf lj kj lk kn ll kr lc ld le lf bi translated">有了<code class="fe kt ku kv kw b">dev</code>目录</li><li id="27aa" class="kx ky iq jw b jx lh kb li kf lj kj lk kn ll kr lc ld le lf bi translated">里面放着<code class="fe kt ku kv kw b">values.yaml</code>的文件</li><li id="00e7" class="kx ky iq jw b jx lh kb li kf lj kj lk kn ll kr lc ld le lf bi translated">保留<a class="ae ks" href="https://rtfm.co.ua/redis-master-slave-replikaciya-i-zapusk-v-kubernetes/#Redis_Options" rel="noopener ugc nofollow" target="_blank"> Redis选项</a>的位置</li><li id="d1bd" class="kx ky iq jw b jx lh kb li kf lj kj lk kn ll kr lc ld le lf bi translated">在詹金斯，它将被部署为<code class="fe kt ku kv kw b">helm install backend-redis -f env/${ENV}/values.yaml</code></li></ul><p id="6c5a" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">我们走吧。</p><h1 id="540d" class="lm ln iq bd lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj bi translated">创建父掌舵图</h1><p id="fe6e" class="pw-post-body-paragraph ju jv iq jw b jx mk jz ka kb ml kd ke kf mm kh ki kj mn kl km kn mo kp kq kr ij bi translated">在我们服务的存储库中创建一个新图表:</p><pre class="mp mq mr ms gt mt kw mu mv aw mw bi"><span id="318f" class="mx ln iq kw b gy my mz l na nb">$ helm create backend-redis<br/>Creating backend-redis</span></pre><p id="a519" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">删除所有模板文件—我们这里不需要它们:</p><pre class="mp mq mr ms gt mt kw mu mv aw mw bi"><span id="1bbc" class="mx ln iq kw b gy my mz l na nb">$ rm -rf backend-redis/templates/*</span></pre><p id="1703" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">为<code class="fe kt ku kv kw b">values.yaml</code>创建目录:</p><pre class="mp mq mr ms gt mt kw mu mv aw mw bi"><span id="8493" class="mx ln iq kw b gy my mz l na nb">$ mkdir -p backend-redis/env/{dev,stage,prod}</span></pre><p id="d896" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">从<a class="ae ks" href="https://rtfm.co.ua/redis-master-slave-replikaciya-i-zapusk-v-kubernetes/" rel="noopener ugc nofollow" target="_blank">以前的帖子</a> ( <em class="lg"> Rus </em>)中复制一个配置:</p><pre class="mp mq mr ms gt mt kw mu mv aw mw bi"><span id="0a48" class="mx ln iq kw b gy my mz l na nb">$ cp ~/Temp/redis-opts.yaml backend-redis/env/dev/values.yaml</span></pre><p id="4814" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">检查其内容:</p><pre class="mp mq mr ms gt mt kw mu mv aw mw bi"><span id="9fd9" class="mx ln iq kw b gy my mz l na nb">$ head backend-redis/env/dev/values.yaml<br/>global:<br/>  redis:<br/>    password: “blablacar”</span><span id="ec06" class="mx ln iq kw b gy nc mz l na nb">metrics:<br/>  enabled: true<br/>  serviceMonitor:<br/>    enabled: true<br/>    namespace: “monitoring”</span></pre><p id="95cc" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">好的，只需要从这里删除密码，因为它将在部署过程中从Jenkins密码参数中通过<code class="fe kt ku kv kw b">helm install --set</code>传递。</p><h2 id="b800" class="mx ln iq bd lo nd ne dn ls nf ng dp lw kf nh ni ma kj nj nk me kn nl nm mi nn bi translated">头盔:a <code class="fe kt ku kv kw b">values.yaml</code>为副车</h2><p id="3acb" class="pw-post-body-paragraph ju jv iq jw b jx mk jz ka kb ml kd ke kf mm kh ki kj mn kl km kn mo kp kq kr ij bi translated">此外，这里我们需要更改的是在最开始添加一个子图表的名称，这样我们就可以在父图表中使用它，Helm会将这些值应用到我们的子图表Bitnami中的Redis图表。</p><p id="eef8" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">将<em class="lg"> redis </em>字添加到文件的开头，并删除<code class="fe kt ku kv kw b">password</code>的值:</p><pre class="mp mq mr ms gt mt kw mu mv aw mw bi"><span id="8c7f" class="mx ln iq kw b gy my mz l na nb">redis:<br/>  global:<br/>    redis:<br/>      password: ""<br/><br/>  metrics:<br/>    enabled: true<br/>    serviceMonitor:<br/>      enabled: true<br/>      namespace: "monitoring"<br/><br/>  master:<br/>    persistence:<br/>      enabled: false<br/>    service:<br/>      type: LoadBalancer<br/>      annotations:<br/>        service.beta.kubernetes.io/aws-load-balancer-internal: "true"<br/>...</span></pre><p id="ba01" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">现在，我们可以向父级<em class="lg">后端-redis </em>图表添加依赖项，添加redis图表:</p><pre class="mp mq mr ms gt mt kw mu mv aw mw bi"><span id="c1ff" class="mx ln iq kw b gy my mz l na nb">$ helm search repo redis<br/>NAME CHART VERSION APP VERSION DESCRIPTION<br/>bitnami/redis 11.2.3 6.0.9 Open source, advanced key-value store. It is of…<br/>bitnami/redis-cluster 3.2.10 6.0.9 Open source, advanced key-value store. It is of…<br/>stable/prometheus-redis-exporter 3.5.1 1.3.4 DEPRECATED Prometheus exporter for Redis metrics<br/>stable/redis 10.5.7 5.0.7 DEPRECATED Open source, advanced key-value stor…<br/>stable/redis-ha 4.4.4 5.0.6 Highly available Kubernetes implementation of R…<br/>stable/sensu 0.2.3 0.28 Sensu monitoring framework backed by the Redis …</span></pre><p id="f309" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">让我们使用<em class="lg"> bitnami/redis 11.2.3 </em>，将<code class="fe kt ku kv kw b">dependencies</code>添加到父图表的<code class="fe kt ku kv kw b">Chart.yaml</code>中:</p><pre class="mp mq mr ms gt mt kw mu mv aw mw bi"><span id="db99" class="mx ln iq kw b gy my mz l na nb">...<br/>dependencies:<br/>- name: redis<br/>  version: ~11.2<br/>  repository: "@bitnami"</span></pre><p id="d00c" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">添加存储库:</p><pre class="mp mq mr ms gt mt kw mu mv aw mw bi"><span id="6d4c" class="mx ln iq kw b gy my mz l na nb">$ helm repo add bitnami <a class="ae ks" href="https://charts.bitnami.com/bitnami" rel="noopener ugc nofollow" target="_blank">https://charts.bitnami.com/bitnami</a></span></pre><p id="f97d" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">为测试运行:</p><pre class="mp mq mr ms gt mt kw mu mv aw mw bi"><span id="d639" class="mx ln iq kw b gy my mz l na nb">$ helm install backend-redis . --dry-run -f env/dev/values.yaml --debug<br/>install.go:172: [debug] Original chart version: “”<br/>install.go:189: [debug] CHART PATH: /home/setevoy/Work/devops-kubernetes/projects/backend/services/backend-redis<br/>Error: found in Chart.yaml, but missing in charts/ directory: redis<br/>helm.go:94: [debug] found in Chart.yaml, but missing in charts/ directory: redis<br/>…</span></pre><p id="7c44" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated"><strong class="jw ir"> <em class="lg">“错误:在Chart.yaml中找到，但在charts/directory:redis</em></strong>”—啊，对，忘了。更新依赖关系:</p><pre class="mp mq mr ms gt mt kw mu mv aw mw bi"><span id="437f" class="mx ln iq kw b gy my mz l na nb">$ helm dependency update<br/>Hang tight while we grab the latest from your chart repositories…<br/>…Successfully got an update from the “equinor-charts” chart repository<br/>…Successfully got an update from the “bitnami” chart repository<br/>…Successfully got an update from the “stable” chart repository<br/>Update Complete. ⎈Happy Helming!⎈<br/>Saving 1 charts<br/>Downloading redis from repo <a class="ae ks" href="https://charts.bitnami.com/bitnami" rel="noopener ugc nofollow" target="_blank">https://charts.bitnami.com/bitnami</a><br/>Deleting outdated charts</span></pre><p id="6888" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">检查子图表的档案:</p><pre class="mp mq mr ms gt mt kw mu mv aw mw bi"><span id="ba03" class="mx ln iq kw b gy my mz l na nb">$ ll charts/<br/>total 64<br/>-rw-r — r — 1 setevoy setevoy 64195 Oct 28 16:30 redis-11.2.3.tgz</span></pre><p id="8ed1" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">再次运行:</p><pre class="mp mq mr ms gt mt kw mu mv aw mw bi"><span id="63dc" class="mx ln iq kw b gy my mz l na nb">$ helm install backend-redis . — dry-run -f env/dev/values.yaml — debug</span></pre><p id="6cce" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">如果一切正常，运行安装程序:</p><pre class="mp mq mr ms gt mt kw mu mv aw mw bi"><span id="bba4" class="mx ln iq kw b gy my mz l na nb">$ helm upgrade --install --namespace eks-dev-1-backend-redis-ns --create-namespace --atomic backend-redis . -f env/dev/values.yaml --set redis.global.redis.password=p@ssw0rd --debug<br/>history.go:53: [debug] getting history for release backend-redis<br/>Release “backend-redis” does not exist. Installing it now.<br/>install.go:172: [debug] Original chart version: “”<br/>install.go:189: [debug] CHART PATH: /home/setevoy/Work/devops-kubernetes/projects/backend/services/backend-redis<br/>client.go:108: [debug] creating 1 resource(s)<br/>client.go:108: [debug] creating 9 resource(s)<br/>wait.go:53: [debug] beginning wait for 9 resources with timeout of 5m0s<br/>wait.go:206: [debug] Service does not have load balancer ingress IP address: eks-dev-1-backend-redis-ns/backend-redis<br/>wait.go:329: [debug] StatefulSet is not ready: eks-dev-1-backend-redis-ns/backend-redis-node. 1 out of 2 expected pods have been scheduled…</span></pre><p id="0acf" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">注意，在<code class="fe kt ku kv kw b">--set</code>中，<code class="fe kt ku kv kw b">password</code>参数也通过子块的名称传递，然后是块的名称- <code class="fe kt ku kv kw b">redis.global.redis.password</code>。</p><p id="33d5" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">检查服务:</p><pre class="mp mq mr ms gt mt kw mu mv aw mw bi"><span id="284b" class="mx ln iq kw b gy my mz l na nb">$ kubectl -n eks-dev-1-backend-redis-ns get svc<br/>NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE<br/>backend-redis LoadBalancer 172.20.153.106 internal-a5d0d8f5a5d4a4438a2ca06610886d2f-1400935130.us-east-2.elb.amazonaws.com 6379:30362/TCP,26379:31326/TCP 70s<br/>backend-redis-headless ClusterIP None &lt;none&gt; 6379/TCP,26379/TCP 70s<br/>backend-redis-metrics ClusterIP 172.20.50.77 &lt;none&gt; 9121/TCP 70s 9121/TCP 21s</span></pre><p id="3d60" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">豆荚:</p><pre class="mp mq mr ms gt mt kw mu mv aw mw bi"><span id="aa0c" class="mx ln iq kw b gy my mz l na nb">$ kubectl -n eks-dev-1-backend-redis-ns get pod<br/>NAME READY STATUS RESTARTS AGE<br/>backend-redis-node-0 3/3 Running 0 37s<br/>backend-redis-node-1 3/3 Running 0 21s</span></pre><p id="566a" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">并检查Redis是否正常工作:</p><pre class="mp mq mr ms gt mt kw mu mv aw mw bi"><span id="b570" class="mx ln iq kw b gy my mz l na nb">$ admin@bttrm-dev-app-1:~$ redis-cli -h internal-a5d0d8f5a5d4a4438a2ca06610886d2f-1400935130.us-east-2.elb.amazonaws.com -p 6379 -a p@ssw0rd info replication<br/>Replication<br/>role:master<br/>connected_slaves:1<br/>slave0:ip=10.3.45.195,port=6379,state=online,offset=15261,lag=1<br/>…</span></pre><p id="e471" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">酷—现在我们可以添加一个Jenkins作业了。</p><p id="fce9" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">以下是与来自<a class="ae ks" href="https://rtfm.co.ua/helm-poshagovoe-sozdanie-charta-i-deplojmenta-iz-jenkins/" rel="noopener ugc nofollow" target="_blank">掌舵人пошаговое·созданиечартаиелокментаиза詹金斯</a>岗位(<em class="lg"> Rus </em>)的工作相似的一切。</p><h1 id="e643" class="lm ln iq bd lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj bi translated">Jenkins部署作业</h1><p id="55cc" class="pw-post-body-paragraph ju jv iq jw b jx mk jz ka kb ml kd ke kf mm kh ki kj mn kl km kn mo kp kq kr ij bi translated">创建一个Jenkins管道作业。</p><h2 id="6a36" class="mx ln iq bd lo nd ne dn ls nf ng dp lw kf nh ni ma kj nj nk me kn nl nm mi nn bi translated">因素</h2><p id="bb64" class="pw-post-body-paragraph ju jv iq jw b jx mk jz ka kb ml kd ke kf mm kh ki kj mn kl km kn mo kp kq kr ij bi translated">添加参数:</p><figure class="mp mq mr ms gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="np nq di nr bf ns"><div class="gh gi no"><img src="../Images/67ff2de420cca243f8185810b5f33874.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*-L9ZhKKCbTTbkozk.png"/></div></div></figure><p id="7cfc" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi">Тут будут:</p><ul class=""><li id="4a19" class="kx ky iq jw b jx jy kb kc kf kz kj la kn lb kr lc ld le lf bi translated"><code class="fe kt ku kv kw b">APP_CHART_NAME</code>:父图表名称</li><li id="0e31" class="kx ky iq jw b jx lh kb li kf lj kj lk kn ll kr lc ld le lf bi translated"><code class="fe kt ku kv kw b">AWS_EKS_NAMESPACE</code>:要部署到的Kubernetes名称空间</li><li id="2ba2" class="kx ky iq jw b jx lh kb li kf lj kj lk kn ll kr lc ld le lf bi translated"><code class="fe kt ku kv kw b">AWS_EKS_CLUSTER</code>:要部署到的Kubernetes集群，也用于为<code class="fe kt ku kv kw b">kubectl</code>生成<code class="fe kt ku kv kw b">.kube/config</code></li><li id="10e0" class="kx ky iq jw b jx lh kb li kf lj kj lk kn ll kr lc ld le lf bi translated"><code class="fe kt ku kv kw b">APP_ENV</code>:用于替代<code class="fe kt ku kv kw b">backend-redis/env/$APP_ENV/values.yaml</code>中的<code class="fe kt ku kv kw b">verify()</code>功能调用，参见<a class="ae ks" href="https://rtfm.co.ua/en/jenkins-scripted-pipeline-production-environment-job-confirmation-step/" rel="noopener ugc nofollow" target="_blank"> Jenkins:脚本化流水线-生产环境作业确认步骤</a></li><li id="e62c" class="kx ky iq jw b jx lh kb li kf lj kj lk kn ll kr lc ld le lf bi translated"><code class="fe kt ku kv kw b">APP_REPO_URL</code>:图表的存储库</li><li id="0617" class="kx ky iq jw b jx lh kb li kf lj kj lk kn ll kr lc ld le lf bi translated"><code class="fe kt ku kv kw b">APP_REPO_BRANCH</code>:此存储库中的一个分支</li></ul><p id="4622" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">我们存储库中的目录结构如下:</p><pre class="mp mq mr ms gt mt kw mu mv aw mw bi"><span id="876c" class="mx ln iq kw b gy my mz l na nb">projects/<br/>└── backend<br/>└── services<br/>└── backend-redis<br/>├── Chart.lock<br/>├── charts<br/>│ └── redis-11.2.3.tgz<br/>├── Chart.yaml<br/>├── env<br/>│ ├── dev<br/>│ │ └── values.yaml<br/>│ ├── prod<br/>│ └── stage<br/>├── templates└── values.yaml</span></pre><p id="49c0" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">使用Redis的密码创建密码参数:</p><figure class="mp mq mr ms gt jr gh gi paragraph-image"><div class="gh gi nt"><img src="../Images/94bb404f3dcde0a8c9d2a60ea2010196.png" data-original-src="https://miro.medium.com/v2/resize:fit:956/format:webp/0*o-Ol_QBkel5RHlUH.png"/></div></figure><h2 id="6527" class="mx ln iq bd lo nd ne dn ls nf ng dp lw kf nh ni ma kj nj nk me kn nl nm mi nn bi translated">管道脚本</h2><p id="ea40" class="pw-post-body-paragraph ju jv iq jw b jx mk jz ka kb ml kd ke kf mm kh ki kj mn kl km kn mo kp kq kr ij bi translated">并编写管道脚本:</p><pre class="mp mq mr ms gt mt kw mu mv aw mw bi"><span id="9e75" class="mx ln iq kw b gy my mz l na nb">// ask confirmation for build if APP_ENV == prod<br/>def verify() {<br/><br/>        def userInput = input(<br/>            id: 'userInput', message: 'This is PRODUCTION!', parameters: [<br/>            [$class: 'BooleanParameterDefinition', defaultValue: false, description: '', name: 'Please confirm you sure to proceed']<br/>        ])<br/>        <br/>        if(!userInput) {<br/>            error "Build wasn't confirmed"<br/>        }<br/>}<br/><br/>// Add slack Notification<br/>def notifySlack(String buildStatus = 'STARTED') {<br/><br/>    // Build status of null means success.<br/>    buildStatus = buildStatus ?: 'SUCCESS'<br/><br/>    def color<br/>    //change for another slack chanel<br/>    def token = 'devops-alarms-ci-slack-notification'<br/><br/>    if (buildStatus == 'STARTED') {<br/>        color = '#D4DADF'<br/>    } else if (buildStatus == 'SUCCESS') {<br/>        color = '#BDFFC3'<br/>    } else if (buildStatus == 'UNSTABLE') {<br/>            color = '#FFFE89'<br/>    } else {<br/>        color = '#FF9FA1'<br/>    }<br/><br/>    def msg = "${buildStatus}: `${env.JOB_NAME}` #${env.BUILD_NUMBER}:\n${env.BUILD_URL}"<br/>    slackSend(color: color, message: msg, tokenCredentialId: token)<br/>}<br/><br/>node {<br/><br/>    try { <br/><br/>    docker.image('projectname/kubectl-aws:4.1').inside('-v /var/run/docker.sock:/var/run/docker.sock') {<br/>        <br/>        stage('Verify') {<br/>           switch("${env.APP_ENV}") {<br/>               case "prod":<br/>                   verify()<br/>                   echo "Run job"<br/>                   break;<br/>               default:<br/>                   echo "Dev deploy"<br/>                   break;<br/>            }<br/>        }<br/><br/>        stage('Init') {<br/>            <br/>            gitenv = git branch: '${APP_REPO_BRANCH}',<br/>                         credentialsId: 'jenkins-projectname-github',<br/>                         url: '${APP_REPO_URL}'<br/>        <br/>            GIT_COMMIT_SHORT = gitenv.GIT_COMMIT.take(8)<br/>            RELEASE_VERSION = "${BUILD_NUMBER}"<br/>            APP_VERSION = "${BUILD_NUMBER}.${GIT_COMMIT_SHORT}"<br/>            AWS_EKS_REGION = "us-east-2"<br/>            <br/>            echo "APP_VERSION: ${APP_VERSION}"<br/>            echo "RELEASE_VERSION: ${RELEASE_VERSION}"<br/>            <br/>            sh "aws eks update-kubeconfig --region ${AWS_EKS_REGION} --name ${AWS_EKS_CLUSTER}"<br/>            sh "kubectl cluster-info"<br/>            sh "helm version"<br/>            sh "helm -n ${AWS_EKS_NAMESPACE} ls "<br/>        }<br/><br/>        // install dependencies<br/>        stage("Helm dependencies") {<br/><br/>            dir("projects/backend/services/${APP_CHART_NAME}") {<br/>                sh "helm repo add bitnami https://charts.bitnami.com/bitnami"<br/>                sh "helm dependency update"<br/>            }<br/>        }<br/><br/>        // lint the chart<br/>        stage("Helm lint") {<br/>            <br/>            dir("projects/backend/services/") {<br/>                sh "helm lint ${APP_CHART_NAME} -f ${APP_CHART_NAME}/env/${APP_ENV}/values.yaml"<br/>            }<br/>        }<br/><br/>        // just to create --app-version<br/>        stage("Helm package") {<br/><br/>            dir("projects/backend/services/") {<br/>                sh "helm package ${APP_CHART_NAME} --version ${RELEASE_VERSION} --app-version ${APP_VERSION}"<br/>            }<br/>        }<br/>        <br/>        // --dry-run first, if OK then run install<br/>        stage("Helm install") {<br/>            <br/>            dir("projects/backend/services/") {<br/>                sh "helm secrets upgrade --install --namespace ${AWS_EKS_NAMESPACE} --create-namespace --atomic ${APP_CHART_NAME} ${APP_CHART_NAME}-${RELEASE_VERSION}.tgz -f ${APP_CHART_NAME}/env/${APP_ENV}/values.yaml --set redis.global.redis.password=${REDIS_PASSWORD} --debug --dry-run"<br/>                sh "helm secrets upgrade --install --namespace ${AWS_EKS_NAMESPACE} --create-namespace --atomic ${APP_CHART_NAME} ${APP_CHART_NAME}-${RELEASE_VERSION}.tgz -f ${APP_CHART_NAME}/env/${APP_ENV}/values.yaml --set redis.global.redis.password=${REDIS_PASSWORD} --debug"<br/>            }<br/>        }<br/><br/>        stage("Helm info") {<br/>            <br/>            dir("projects/backend/services/") {<br/>                sh "helm ls -a -d --namespace ${AWS_EKS_NAMESPACE}"<br/>                sh "helm get manifest --namespace ${AWS_EKS_NAMESPACE} ${APP_CHART_NAME}"<br/>            }<br/>        }<br/>    }<br/><br/>    // send Slack notification if Jenkins build fails<br/>    } catch (e) {<br/>        currentBuild.result = 'FAILURE'<br/>        notifySlack(currentBuild.result)<br/>        throw e<br/>    }<br/>}</span></pre><p id="9b8a" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">松弛通知在<a class="ae ks" href="https://rtfm.co.ua/jenkins-uvedomlenie-v-slack-iz-jenkins-scripted-pipeline/" rel="noopener ugc nofollow" target="_blank">Jenkins:уведомлениевSlackизJenkins脚本管道</a>帖子(<em class="lg"> Rus </em>)中有所描述。</p><p id="656d" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">运行作业:</p><figure class="mp mq mr ms gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="np nq di nr bf ns"><div class="gh gi nu"><img src="../Images/8cdb730fd50ebe74b182533726ed011e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*74TR-a1UVfjBhQVg.png"/></div></div></figure><p id="669a" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">检查结果:</p><pre class="mp mq mr ms gt mt kw mu mv aw mw bi"><span id="c5c3" class="mx ln iq kw b gy my mz l na nb">$ helm -n eks-dev-1-backend-redis-ns ls<br/>NAME NAMESPACE REVISION UPDATED STATUS CHART APP VERSION<br/>backend-redis eks-dev-1-backend-redis-ns 2 2020–10–29 14:19:52.407047243 +0000 UTC deployed backend-redis-13 13.6da15d3e</span></pre><p id="cc0c" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">完成了。</p></div><div class="ab cl nv nw hu nx" role="separator"><span class="ny bw bk nz oa ob"/><span class="ny bw bk nz oa ob"/><span class="ny bw bk nz oa"/></div><div class="ij ik il im in"><p id="4dbd" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated"><em class="lg">最初发布于</em> <a class="ae ks" href="https://rtfm.co.ua/en/jenkins-redis-deployment-and-helm-subchart-values/" rel="noopener ugc nofollow" target="_blank"> <em class="lg"> RTFM: Linux、DevOps和系统管理</em> </a> <em class="lg">。</em></p></div></div>    
</body>
</html>