<html>
<head>
<title>Git: scan repositories for secrets using Gitleaks</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Git:使用Gitleaks扫描仓库中的秘密</h1>
<blockquote>原文：<a href="https://itnext.io/git-scanning-repositories-for-secrets-using-gitleaks-6b3c73d88d0d?source=collection_archive---------1-----------------------#2021-08-16">https://itnext.io/git-scanning-repositories-for-secrets-using-gitleaks-6b3c73d88d0d?source=collection_archive---------1-----------------------#2021-08-16</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div class="gh gi jn"><img src="../Images/685fb56ad1c23b41006e89a20771945e.png" data-original-src="https://miro.medium.com/v2/resize:fit:488/format:webp/1*HAnGUQ9Zf3UKjgKfrTP6xQ.png"/></div></figure><p id="ce56" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">机密数据泄露，比如对Git存储库的RDS密钥或密码，即使它是一个私有的Github存储库，也是一件非常糟糕的事情，最好检查一下您的存储库，了解是否有开发人员对这些数据进行了提交。</p><h1 id="61cb" class="ks kt iq bd ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp bi translated"><strong class="ak">内容</strong></h1><ul class=""><li id="b4cb" class="lq lr iq jw b jx ls kb lt kf lu kj lv kn lw kr lx ly lz ma bi translated"><a class="ae mb" href="https://rtfm.co.ua/en/git-scanning-repositories-for-secrets-using-gitleaks/#Scanning_utilities" rel="noopener ugc nofollow" target="_blank">扫描实用程序</a></li><li id="66a6" class="lq lr iq jw b jx mc kb md kf me kj mf kn mg kr lx ly lz ma bi translated"><a class="ae mb" href="https://rtfm.co.ua/en/git-scanning-repositories-for-secrets-using-gitleaks/#Planning" rel="noopener ugc nofollow" target="_blank">策划</a></li><li id="d2f1" class="lq lr iq jw b jx mc kb md kf me kj mf kn mg kr lx ly lz ma bi translated"><a class="ae mb" href="https://rtfm.co.ua/en/git-scanning-repositories-for-secrets-using-gitleaks/#Gitleaks_-_manual_run" rel="noopener ugc nofollow" target="_blank"> Gitleaks —手动运行</a></li><li id="ccbb" class="lq lr iq jw b jx mc kb md kf me kj mf kn mg kr lx ly lz ma bi translated"><a class="ae mb" href="https://rtfm.co.ua/en/git-scanning-repositories-for-secrets-using-gitleaks/#Github_token" rel="noopener ugc nofollow" target="_blank"> Github令牌</a></li><li id="f49e" class="lq lr iq jw b jx mc kb md kf me kj mf kn mg kr lx ly lz ma bi translated"><a class="ae mb" href="https://rtfm.co.ua/en/git-scanning-repositories-for-secrets-using-gitleaks/#Jenkins_job" rel="noopener ugc nofollow" target="_blank">詹金斯的工作</a></li><li id="ddc2" class="lq lr iq jw b jx mc kb md kf me kj mf kn mg kr lx ly lz ma bi translated"><a class="ae mb" href="https://rtfm.co.ua/en/git-scanning-repositories-for-secrets-using-gitleaks/#Pipeline_script" rel="noopener ugc nofollow" target="_blank">管道脚本</a></li><li id="e869" class="lq lr iq jw b jx mc kb md kf me kj mf kn mg kr lx ly lz ma bi translated"><a class="ae mb" href="https://rtfm.co.ua/en/git-scanning-repositories-for-secrets-using-gitleaks/#Loops_in_Groovy" rel="noopener ugc nofollow" target="_blank">Groovy中的循环</a></li><li id="5bf1" class="lq lr iq jw b jx mc kb md kf me kj mf kn mg kr lx ly lz ma bi translated"><a class="ae mb" href="https://rtfm.co.ua/en/git-scanning-repositories-for-secrets-using-gitleaks/#Jenkins_Docker_plugin" rel="noopener ugc nofollow" target="_blank">詹金斯Docker插件</a></li><li id="cd0a" class="lq lr iq jw b jx mc kb md kf me kj mf kn mg kr lx ly lz ma bi translated"><a class="ae mb" href="https://rtfm.co.ua/en/git-scanning-repositories-for-secrets-using-gitleaks/#Ignoring_errors_in_a_Jenkins_stage" rel="noopener ugc nofollow" target="_blank">忽略詹金斯阶段的错误{} </a></li><li id="121c" class="lq lr iq jw b jx mc kb md kf me kj mf kn mg kr lx ly lz ma bi translated">来自詹金斯的时差通知</li><li id="e7f9" class="lq lr iq jw b jx mc kb md kf me kj mf kn mg kr lx ly lz ma bi translated"><a class="ae mb" href="https://rtfm.co.ua/en/git-scanning-repositories-for-secrets-using-gitleaks/#Create_a_Slack_Bot" rel="noopener ugc nofollow" target="_blank">创建一个松弛机器人</a></li><li id="688c" class="lq lr iq jw b jx mc kb md kf me kj mf kn mg kr lx ly lz ma bi translated"><a class="ae mb" href="https://rtfm.co.ua/en/git-scanning-repositories-for-secrets-using-gitleaks/#Jenkins_credentials" rel="noopener ugc nofollow" target="_blank">詹金斯的证件</a></li><li id="77c3" class="lq lr iq jw b jx mc kb md kf me kj mf kn mg kr lx ly lz ma bi translated"><a class="ae mb" href="https://rtfm.co.ua/en/git-scanning-repositories-for-secrets-using-gitleaks/#jenkinspluginsslackStandardSlackService_postToSlack_Response_Code_404" rel="noopener ugc nofollow" target="_blank">Jenkins . plugins . slack . standardslackservice postToSlack响应代码:404 </a></li><li id="06ca" class="lq lr iq jw b jx mc kb md kf me kj mf kn mg kr lx ly lz ma bi translated"><a class="ae mb" href="https://rtfm.co.ua/en/git-scanning-repositories-for-secrets-using-gitleaks/#File_upload_to_Slack" rel="noopener ugc nofollow" target="_blank">文件上传到Slack </a></li><li id="5a64" class="lq lr iq jw b jx mc kb md kf me kj mf kn mg kr lx ly lz ma bi translated"><a class="ae mb" href="https://rtfm.co.ua/en/git-scanning-repositories-for-secrets-using-gitleaks/#Gitleaks_configuration" rel="noopener ugc nofollow" target="_blank"> Gitleaks配置</a></li><li id="cc13" class="lq lr iq jw b jx mc kb md kf me kj mf kn mg kr lx ly lz ma bi translated"><a class="ae mb" href="https://rtfm.co.ua/en/git-scanning-repositories-for-secrets-using-gitleaks/#Commits_to_check" rel="noopener ugc nofollow" target="_blank">提交检查</a></li><li id="6d33" class="lq lr iq jw b jx mc kb md kf me kj mf kn mg kr lx ly lz ma bi translated"><a class="ae mb" href="https://rtfm.co.ua/en/git-scanning-repositories-for-secrets-using-gitleaks/#Gitleaks_configuration_file" rel="noopener ugc nofollow" target="_blank"> Gitleaks配置文件</a></li></ul><h1 id="179a" class="ks kt iq bd ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp bi translated">扫描实用程序</h1><p id="499c" class="pw-post-body-paragraph ju jv iq jw b jx ls jz ka kb lt kd ke kf mh kh ki kj mi kl km kn mj kp kq kr ij bi translated">乍一看，要检查Git存储库的泄漏，有很多实用程序:</p><ul class=""><li id="8496" class="lq lr iq jw b jx jy kb kc kf mk kj ml kn mm kr lx ly lz ma bi translated">Gittyleaks  —看起来很有趣，但上次更新是在2年前</li><li id="3f4a" class="lq lr iq jw b jx mc kb md kf me kj mf kn mg kr lx ly lz ma bi translated"><a class="ae mb" href="https://github.com/auth0/repo-supervisor" rel="noopener ugc nofollow" target="_blank">回购主管</a> —有一个WebUI，使用AWS Lambda，与Github完全集成，可以稍后检查</li><li id="0779" class="lq lr iq jw b jx mc kb md kf me kj mf kn mg kr lx ly lz ma bi translated">块菌猪 —只有CLI，看起来还不错</li><li id="c965" class="lq lr iq jw b jx mc kb md kf me kj mf kn mg kr lx ly lz ma bi translated"><a class="ae mb" href="https://github.com/ezekg/git-hound" rel="noopener ugc nofollow" target="_blank">Git Hound</a>—<code class="fe mn mo mp mq b">git</code>的插件，只能执行提交前扫描，不能执行远程存储库</li><li id="4ba8" class="lq lr iq jw b jx mc kb md kf me kj mf kn mg kr lx ly lz ma bi translated">最近一次更新是在三年前</li><li id="7b02" class="lq lr iq jw b jx mc kb md kf me kj mf kn mg kr lx ly lz ma bi translated">瞭望塔——看起来很有趣，甚至有一个WebUI，但他们甚至没有在网站上公布他们的定价，所以退出了比赛</li><li id="2601" class="lq lr iq jw b jx mc kb md kf me kj mf kn mg kr lx ly lz ma bi translated"><a class="ae mb" href="https://www.gitguardian.com/" rel="noopener ugc nofollow" target="_blank">git guardian</a>——一个非常好的解决方案，但是价格过高</li><li id="77e4" class="lq lr iq jw b jx mc kb md kf me kj mf kn mg kr lx ly lz ma bi translated">gitleaks  —只有CLI，我们将在本文中使用</li></ul><p id="eabf" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">因此，从上面的列表来看，值得一试<a class="ae mb" href="https://github.com/trufflesecurity/truffleHog" rel="noopener ugc nofollow" target="_blank">松露猪</a>和<a class="ae mb" href="https://github.com/zricethezav/gitleaks" rel="noopener ugc nofollow" target="_blank"> gitleaks </a>，但是我不喜欢<a class="ae mb" href="https://github.com/trufflesecurity/truffleHog" rel="noopener ugc nofollow" target="_blank">松露猪</a>的文档。</p><p id="2f2b" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated"><a class="ae mb" href="https://github.com/auth0/repo-supervisor" rel="noopener ugc nofollow" target="_blank">回购主管</a>看起来也很有希望，会在下面的帖子中查看。</p><p id="e728" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">从那两个:</p><ul class=""><li id="6c1b" class="lq lr iq jw b jx jy kb kc kf mk kj ml kn mm kr lx ly lz ma bi translated">Gitleaks:只是一个扫描器——给出了一个存储库的URL，它将生成一个包含发现的JSON报告</li><li id="2816" class="lq lr iq jw b jx mc kb md kf me kj mf kn mg kr lx ly lz ma bi translated">回购主管:有两种用途:</li><li id="7a03" class="lq lr iq jw b jx mc kb md kf me kj mf kn mg kr lx ly lz ma bi translated">只是为了扫描本地目录</li><li id="e81c" class="lq lr iq jw b jx mc kb md kf me kj mf kn mg kr lx ly lz ma bi translated">在PullRequest/push/etc上扫描远程存储库</li></ul><p id="105e" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">因此，对于Gitleaks，我们可以在Jenkins或Kubernetes中创建一个cronjob，它将接受要检查的存储库列表，然后将报告发送到Slack通道。</p><p id="901a" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">还有，Gitleaks可以和<a class="ae mb" href="https://rtfm.co.ua/github-obzor-github-actions-i-deploj-s-argocd/" rel="noopener ugc nofollow" target="_blank"> Github动作</a>一起使用，更多<a class="ae mb" href="https://github.com/marketplace/actions/gitleaks" rel="noopener ugc nofollow" target="_blank">见这里&gt; &gt; &gt; </a>，但是并不是我们所有的开发者团队都使用动作。另一种方式可以是<a class="ae mb" href="https://pre-commit.com/" rel="noopener ugc nofollow" target="_blank">预提交钩子</a>。</p><h1 id="24d6" class="ks kt iq bd ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp bi translated">规划</h1><p id="27c7" class="pw-post-body-paragraph ju jv iq jw b jx ls jz ka kb lt kd ke kf mh kh ki kj mi kl km kn mj kp kq kr ij bi translated">所以，现在，让我们用Jenkins来尝试一个解决方案，尽管有各种方法来运行它:</p><ul class=""><li id="722b" class="lq lr iq jw b jx jy kb kc kf mk kj ml kn mm kr lx ly lz ma bi translated">使用<a class="ae mb" href="https://rtfm.co.ua/jenkins-github-pull-request-builder-plagin/" rel="noopener ugc nofollow" target="_blank"> GitHub拉取请求生成器</a>触发作业</li><li id="05df" class="lq lr iq jw b jx mc kb md kf me kj mf kn mg kr lx ly lz ma bi translated">使用через <em class="mr"> GitHub hook触发器为GITScm轮询</em> или <em class="mr">轮询SCM </em>触发作业</li><li id="547d" class="lq lr iq jw b jx mc kb md kf me kj mf kn mg kr lx ly lz ma bi translated">作为crontask运行</li></ul><p id="661f" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">首先，我们将创建一个按计划运行的简单作业，然后将检查其他解决方案。</p><p id="f95e" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">我们的项目中有什么:</p><ul class=""><li id="690d" class="lq lr iq jw b jx jy kb kc kf mk kj ml kn mm kr lx ly lz ma bi translated">大约200个Github库</li><li id="eab7" class="lq lr iq jw b jx mc kb md kf me kj mf kn mg kr lx ly lz ma bi translated">大约10个开发团队——后端、前端、分析、iOS和Android移动应用、游戏、devops。</li></ul><p id="e0da" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">我们能对Gitleaks做什么:</p><ul class=""><li id="5652" class="lq lr iq jw b jx jy kb kc kf mk kj ml kn mm kr lx ly lz ma bi translated">为每个团队创建一个Jenkins工作</li><li id="92d8" class="lq lr iq jw b jx mc kb md kf me kj mf kn mg kr lx ly lz ma bi translated">该作业将接受一个带有团队存储库列表的参数</li><li id="2ec9" class="lq lr iq jw b jx mc kb md kf me kj mf kn mg kr lx ly lz ma bi translated">将为每个团队创建一个专用的空闲通道</li><li id="22cd" class="lq lr iq jw b jx mc kb md kf me kj mf kn mg kr lx ly lz ma bi translated">每天将运行一次扫描，并将报告发送到相应的空闲通道</li></ul><p id="87b1" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">首先，让我们手动运行Gitleaks，看看它是如何工作的，然后将进行自动化工作。</p><h1 id="ca01" class="ks kt iq bd ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp bi translated">Gitleaks —手动运行</h1><p id="1a71" class="pw-post-body-paragraph ju jv iq jw b jx ls jz ka kb lt kd ke kf mh kh ki kj mi kl km kn mj kp kq kr ij bi translated">安装它。在Arch Linux上，可以从AUR安装:</p><pre class="ms mt mu mv gt mw mq mx my aw mz bi"><span id="c68a" class="na kt iq mq b gy nb nc l nd ne">$ yay -S gitleaks</span></pre><h2 id="3caa" class="na kt iq bd ku nf ng dn ky nh ni dp lc kf nj nk lg kj nl nm lk kn nn no lo np bi translated">Github令牌</h2><p id="c627" class="pw-post-body-paragraph ju jv iq jw b jx ls jz ka kb lt kd ke kf mh kh ki kj mi kl km kn mj kp kq kr ij bi translated">接下来，需要创建一个令牌来访问Github组织的存储库。</p><p id="6092" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">转到您的Github用户设置，创建一个令牌:</p><figure class="ms mt mu mv gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="nr ns di nt bf nu"><div class="gh gi nq"><img src="../Images/77748f8774b56a40ca990b6c90913cdd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*z5HqQKYM3PUAmkOt.png"/></div></div></figure><p id="7cc9" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">给它<code class="fe mn mo mp mq b">repo</code>权限:</p><figure class="ms mt mu mv gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="nr ns di nt bf nu"><div class="gh gi nv"><img src="../Images/aae7ce3594da4d558e406cfe1c98bbc3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*U30huQCfTWl2qIXu.png"/></div></div></figure><p id="0be4" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">用令牌运行Gitleaks，一个存储库的URL，添加<code class="fe mn mo mp mq b">--verbose</code>，将结果保存到一个文件:</p><pre class="ms mt mu mv gt mw mq mx my aw mz bi"><span id="bc40" class="na kt iq mq b gy nb nc l nd ne">$ gitleaks — access-token=ghp_C6h***3z5 — repo-url=https://github.com/example/BetterBI — verbose — report=analytics-repo.json<br/>…\<br/>INFO[0036] scan time: 32 seconds 756 milliseconds 672 microseconds\<br/>INFO[0036] commits scanned: 1893<br/>WARN[0036] leaks found: 111</span></pre><p id="0ba8" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">检查报告:</p><pre class="ms mt mu mv gt mw mq mx my aw mz bi"><span id="8fad" class="na kt iq mq b gy nb nc l nd ne">$ less analytics-repo.json</span></pre><p id="3855" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">调查结果中有一个例子:</p><pre class="ms mt mu mv gt mw mq mx my aw mz bi"><span id="0a36" class="na kt iq mq b gy nb nc l nd ne">...<br/> {<br/>  "line": "  \"private_key\": \"-----BEGIN PRIVATE KEY-----\\nMIIEvQIBADA***CCaM=\\n-----END PRIVATE KEY-----\\n\",",<br/>  "lineNumber": 5,<br/>  "offender": "-----BEGIN PRIVATE KEY-----",<br/>  "offenderEntropy": -1,<br/>  "commit": "0f047f0cca3994b3465821ef133dbd3c8b55ee7a",<br/>  "repo": "BetterBI",<br/>  "repoURL": "https://github.com/example/BetterBI",<br/>  "leakURL": "https://github.com/example/BetterBI/blob/0f047f0cca3994b3465821ef133dbd3c8b55ee7a/adslib/roas_automation/example-service-account.json#L5",<br/>  "rule": "Asymmetric Private Key",<br/>  "commitMessage": "DT-657 update script for subs and add test\n\nDT-657 create test for check new json (add new subs)",<br/>  "author": "username",<br/>  "email": "example@users.noreply.github.com",<br/>  "file": "adslib/roas_automation/example-service-account.json",<br/>  "date": "2021-05-11T19:46:46+03:00",<br/>  "tags": "key, AsymmetricPrivateKey"<br/> },<br/>...</span></pre><p id="1f07" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">这里:</p><ul class=""><li id="38f6" class="lq lr iq jw b jx jy kb kc kf mk kj ml kn mm kr lx ly lz ma bi translated"><code class="fe mn mo mp mq b">line</code>:到底发现了什么</li><li id="a7af" class="lq lr iq jw b jx mc kb md kf me kj mf kn mg kr lx ly lz ma bi translated"><code class="fe mn mo mp mq b">offender</code>:该发现触发的规则</li><li id="4ff3" class="lq lr iq jw b jx mc kb md kf me kj mf kn mg kr lx ly lz ma bi translated"><code class="fe mn mo mp mq b">commit</code>:带秘密的提交ID</li></ul><p id="11a9" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">使用正则表达式执行查找，如<code class="fe mn mo mp mq b"><a class="ae mb" href="https://github.com/zricethezav/gitleaks/blob/master/config/default.go" rel="noopener ugc nofollow" target="_blank">default.go</a></code>中所述。</p><p id="4ba4" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">此外，您可以创建自己的配置文件并将其传递给Gitleaks。</p><p id="5339" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">例如，上面的私有RSA密钥是通过<a class="ae mb" href="https://github.com/zricethezav/gitleaks/blob/master/config/default.go#L76:" rel="noopener ugc nofollow" target="_blank">非对称私有密钥</a>规则找到的:</p><pre class="ms mt mu mv gt mw mq mx my aw mz bi"><span id="67c2" class="na kt iq mq b gy nb nc l nd ne">[[rules]]<br/>    description = "Asymmetric Private Key"<br/>    regex = '''-----BEGIN ((EC|PGP|DSA|RSA|OPENSSH) )?PRIVATE KEY( BLOCK)?-----'''<br/>    tags = ["key", "AsymmetricPrivateKey"]</span></pre><p id="c180" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">因此，我们可以为每个团队或存储库创建一个专用的配置文件，并通过Kubernetes ConfigMap或作为Jenkins作业中的一个文件传递它们。</p><h1 id="e655" class="ks kt iq bd ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp bi translated">詹金斯工作</h1><p id="54fe" class="pw-post-body-paragraph ju jv iq jw b jx ls jz ka kb lt kd ke kf mh kh ki kj mi kl km kn mj kp kq kr ij bi translated">现在，当我们看到Gitleaks是如何启动的，让我们添加一个Jenkins作业来定期运行它。</p><h2 id="7f94" class="na kt iq bd ku nf ng dn ky nh ni dp lc kf nj nk lg kj nl nm lk kn nn no lo np bi translated">管道脚本</h2><p id="ba73" class="pw-post-body-paragraph ju jv iq jw b jx ls jz ka kb lt kd ke kf mh kh ki kj mi kl km kn mj kp kq kr ij bi translated">因此，对于每个团队，我们将创建一个专门的Jenkins作业，该作业将包含一个带有团队存储库列表的参数。</p><h2 id="c40c" class="na kt iq bd ku nf ng dn ky nh ni dp lc kf nj nk lg kj nl nm lk kn nn no lo np bi translated">Groovy中的循环</h2><p id="cf64" class="pw-post-body-paragraph ju jv iq jw b jx ls jz ka kb lt kd ke kf mh kh ki kj mi kl km kn mj kp kq kr ij bi translated">不久前，我用Golang做了一个类似的解决方案，查看Github中的<a class="ae mb" href="https://rtfm.co.ua/en/go-checking-public-repositories-list-in-github-go-slices-comparison-the-first-golang-experience/" rel="noopener ugc nofollow" target="_blank"> Go:检查公共库列表。Go slices comparison </a>贴出细节，在列表上运行一个循环稍微简单一点。用Groovy，必须谷歌一下。</p><p id="84fb" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">创建一个新的Jenkins作业，将其类型设置为Pipeline:</p><figure class="ms mt mu mv gt jr gh gi paragraph-image"><div class="gh gi nw"><img src="../Images/e4b9b62e21476e473a93a0580d98851b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1020/format:webp/0*TRwXCexnLwbqUaCa.png"/></div></figure><p id="2e0d" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">在作业的设置中，创建一个字符串参数，其中包含团队的存储库列表，这里只使用了两个:</p><figure class="ms mt mu mv gt jr gh gi paragraph-image"><div class="gh gi nx"><img src="../Images/b778724a45932b9c5714fbf4165ca749.png" data-original-src="https://miro.medium.com/v2/resize:fit:1324/format:webp/0*eTpbukwOv5iN-csY.png"/></div></figure><p id="6b98" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">接下来，转到Jenkins脚本。</p><p id="77cc" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">设置一个名为<code class="fe mn mo mp mq b">$repos_list</code>的变量，它将接受一个环境变量<code class="fe mn mo mp mq b">$TEAM_REPOS</code>，然后通过使用<code class="fe mn mo mp mq b">split()</code>方法划分列表的对象。</p><p id="84ad" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">然后，通过使用<code class="fe mn mo mp mq b">for</code>循环对它们进行积分:</p><figure class="ms mt mu mv gt jr gh gi paragraph-image"><div class="gh gi ny"><img src="../Images/bc1de8b4446b75532b372c23ba641827.png" data-original-src="https://miro.medium.com/v2/resize:fit:834/format:webp/0*JeI3FAhIUJP8X0aH.png"/></div></figure><pre class="ms mt mu mv gt mw mq mx my aw mz bi"><span id="c86c" class="na kt iq mq b gy nb nc l nd ne">node('master') {<br/><br/>  def repos_list = "${env.TEAM_REPOS}".split(',')<br/><br/>  for (repo in repos_list) {<br/>    println repo<br/>  }<br/><br/>}</span></pre><p id="a1d1" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">运行作业:</p><figure class="ms mt mu mv gt jr gh gi paragraph-image"><div class="gh gi nz"><img src="../Images/17fb90103b3e6d8902b9f34fc88de2da.png" data-original-src="https://miro.medium.com/v2/resize:fit:1206/format:webp/0*xMZoYTsrcHszPcG7.png"/></div></figure><h2 id="513c" class="na kt iq bd ku nf ng dn ky nh ni dp lc kf nj nk lg kj nl nm lk kn nn no lo np bi translated">Jenkins Docker插件</h2><p id="dc74" class="pw-post-body-paragraph ju jv iq jw b jx ls jz ka kb lt kd ke kf mh kh ki kj mi kl km kn mj kp kq kr ij bi translated">我们运行Jenkins构建的默认方法是使用Docker容器来保持主机系统的整洁。</p><p id="b2a6" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">用<em class="mr">密码</em>类型添加另一个参数，在这里保存Github令牌:</p><figure class="ms mt mu mv gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="nr ns di nt bf nu"><div class="gh gi oa"><img src="../Images/441016c6da0c0e72fed170e3ff0b5647.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*-WkWkCFpOXEF5Tln.png"/></div></div></figure><p id="b15e" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">通过使用<a class="ae mb" href="https://www.jenkins.io/doc/book/pipeline/docker/" rel="noopener ugc nofollow" target="_blank"> Jenkins Docker插件</a>创建一个包含Gitleaks的Docker容器，传递令牌、URL和报告文件。注意，报告文件将包含一个存储库的名称:</p><pre class="ms mt mu mv gt mw mq mx my aw mz bi"><span id="7ad6" class="na kt iq mq b gy nb nc l nd ne">node('master') {<br/>      <br/>  def repos_list = "${env.TEAM_REPOS}".split(',')<br/><br/>  for (repo in repos_list) {<br/>    stage("Repository ${repo}") {<br/>      docker.image('zricethezav/gitleaks').inside('--entrypoint=""') {<br/>        sh "gitleaks --access-token=${GITHUB_TOKEN} --repo-url=https://github.com/example/${repo} --verbose --report=analytics-${repo}-repo.json"<br/>      }<br/>    }<br/>  }<br/>}</span></pre><p id="7a6f" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">这里，对于来自<code class="fe mn mo mp mq b">repos_list</code>列表的每个存储库名称，我们将创建一个专用的Jenkins管道阶段，它也将使用存储库的名称。</p><p id="c0c4" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">运行并检查:</p><figure class="ms mt mu mv gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="nr ns di nt bf nu"><div class="gh gi gj"><img src="../Images/37e26dfc61d7b52e03d0b4901844becb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*Iq7bk1hwj-HkFMe5.png"/></div></div></figure><p id="33f2" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">嗯…这里有一个问题:扫描将在第一次扫描的repo中的第一个结果之后立即停止，因为Geatleaks发现了一个泄漏，返回了exit 1代码，并且作业立即停止:</p><figure class="ms mt mu mv gt jr gh gi paragraph-image"><div class="gh gi ob"><img src="../Images/df1de0f7aad691671f5ad306e5d05ef3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1192/format:webp/0*HOgijuZyQccU__hW.png"/></div></figure><h2 id="e18b" class="na kt iq bd ku nf ng dn ky nh ni dp lc kf nj nk lg kj nl nm lk kn nn no lo np bi translated">忽略Jenkins阶段中的错误{}</h2><p id="23d8" class="pw-post-body-paragraph ju jv iq jw b jx ls jz ka kb lt kd ke kf mh kh ki kj mi kl km kn mj kp kq kr ij bi translated">要解决这个问题，我们可以使用<code class="fe mn mo mp mq b">try/catch</code>解决方案:每个阶段将在其<code class="fe mn mo mp mq b">try</code>中运行，如果出现错误，我们将使用<code class="fe mn mo mp mq b">catch</code>来捕捉它们，并继续构建:</p><pre class="ms mt mu mv gt mw mq mx my aw mz bi"><span id="1208" class="na kt iq mq b gy nb nc l nd ne">node('master') {<br/>  <br/>  def repos_list = "${env.TEAM_REPOS}".split(',')<br/>  def build_ok = true<br/>  <br/>  for (repo in repos_list) {<br/>    try {<br/>      stage("Repository ${repo}") {<br/>        docker.image('zricethezav/gitleaks').inside('--entrypoint=""') {<br/>          sh "gitleaks --access-token=${GITHUB_TOKEN} --repo-url=https://github.com/example/${repo} --verbose --report=analytics-${repo}-repo.json"<br/>        }<br/>      }<br/>    } catch(e) {<br/>        currentBuild.result = 'FAILURE'<br/>    }<br/>  }<br/>}</span></pre><p id="d204" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">运行它:</p><figure class="ms mt mu mv gt jr gh gi paragraph-image"><div class="gh gi ob"><img src="../Images/695a2aad4d022d5afcb1bc41e9c480d6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1192/format:webp/0*WSWdiUY6wtZKKHGU.png"/></div></figure><p id="2586" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">好—现在所有阶段都在运行，尽管有前一个阶段的结果。</p><h2 id="6ebf" class="na kt iq bd ku nf ng dn ky nh ni dp lc kf nj nk lg kj nl nm lk kn nn no lo np bi translated">来自Jenkins的时差通知</h2><p id="8d5a" class="pw-post-body-paragraph ju jv iq jw b jx ls jz ka kb lt kd ke kf mh kh ki kj mi kl km kn mj kp kq kr ij bi translated">我们的下一步是配置向松弛工作区发送警报。</p><p id="d3b4" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">为此，我们使用<a class="ae mb" href="https://plugins.jenkins.io/slack" rel="noopener ugc nofollow" target="_blank">松弛通知</a>插件。此处&gt; &gt; &gt; 见其文档。</p><h2 id="71a2" class="na kt iq bd ku nf ng dn ky nh ni dp lc kf nj nk lg kj nl nm lk kn nn no lo np bi translated">创建一个Slack Bot</h2><p id="9e84" class="pw-post-body-paragraph ju jv iq jw b jx ls jz ka kb lt kd ke kf mh kh ki kj mi kl km kn mj kp kq kr ij bi translated">转到<a class="ae mb" href="https://api.slack.com/apps" rel="noopener ugc nofollow" target="_blank">松弛应用</a>，创建一个新应用:</p><figure class="ms mt mu mv gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="nr ns di nt bf nu"><div class="gh gi oc"><img src="../Images/f4fcf4c509fbb5a5580c2210399df263.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*bmBHa4LnE9ZFDK1w.png"/></div></div></figure><figure class="ms mt mu mv gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="nr ns di nt bf nu"><div class="gh gi od"><img src="../Images/ea119c92bdb90b74134422ba7a1228d7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*Y6kXVoXdJXcW4Mo3.png"/></div></div></figure><p id="4b71" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">转到<em class="mr">权限</em>:</p><figure class="ms mt mu mv gt jr gh gi paragraph-image"><div class="gh gi oe"><img src="../Images/bbd8bdfda4613e5c84bfa27571e0e0df.png" data-original-src="https://miro.medium.com/v2/resize:fit:1398/format:webp/0*xfKNX3hvaL8hg0_p.png"/></div></figure><p id="1afd" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">添加以下内容:</p><ul class=""><li id="312e" class="lq lr iq jw b jx jy kb kc kf mk kj ml kn mm kr lx ly lz ma bi translated"><code class="fe mn mo mp mq b">files:write</code></li><li id="ff1d" class="lq lr iq jw b jx mc kb md kf me kj mf kn mg kr lx ly lz ma bi translated"><code class="fe mn mo mp mq b">chat:write</code></li></ul><figure class="ms mt mu mv gt jr gh gi paragraph-image"><div class="gh gi oe"><img src="../Images/b765cfab0391641566f209317d908bed.png" data-original-src="https://miro.medium.com/v2/resize:fit:1398/format:webp/0*k18TwkF3aB5jaelG.png"/></div></figure><p id="7ae2" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">转到<em class="mr"> OAuth &amp;权限</em>，将bot安装到Slack工作区:</p><figure class="ms mt mu mv gt jr gh gi paragraph-image"><div class="gh gi oe"><img src="../Images/59fe7ae1ff2192cb37eb44f364c3ccd4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1398/format:webp/0*xudz38w7t5sc7XjX.png"/></div></figure><p id="c3c6" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">保存令牌:</p><figure class="ms mt mu mv gt jr gh gi paragraph-image"><div class="gh gi of"><img src="../Images/b4066594b6bb144ed81dab0b99ac04bf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1388/format:webp/0*Lf3zwxHUtSkjM8T5.png"/></div></figure><h2 id="1dfb" class="na kt iq bd ku nf ng dn ky nh ni dp lc kf nj nk lg kj nl nm lk kn nn no lo np bi translated">詹金斯证书</h2><p id="5b79" class="pw-post-body-paragraph ju jv iq jw b jx ls jz ka kb lt kd ke kf mh kh ki kj mi kl km kn mj kp kq kr ij bi translated">向Jenkins添加令牌—转到<em class="mr">管理Jenkins &gt;管理凭证</em>:</p><figure class="ms mt mu mv gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="nr ns di nt bf nu"><div class="gh gi og"><img src="../Images/d2442ff1769c075d3ab054dbb42a675c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*fIMIvOjaoXCwz9vO.png"/></div></div></figure><p id="648a" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">添加一个新的:</p><figure class="ms mt mu mv gt jr gh gi paragraph-image"><div class="gh gi oh"><img src="../Images/a8ef334e1957d2a9eb04929859da4bd7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1298/format:webp/0*2myxnmt5b1T4tHZm.png"/></div></figure><p id="c621" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">将其类型设置为<em class="mr">秘密文件</em>:</p><figure class="ms mt mu mv gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="nr ns di nt bf nu"><div class="gh gi oi"><img src="../Images/4e18e867f8a24981ce6975e17aa1a86f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*wMEpXnY9VEC52xQc.png"/></div></div></figure><p id="288b" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">在松弛工作区中，创建一个新频道:</p><figure class="ms mt mu mv gt jr gh gi paragraph-image"><div class="gh gi oj"><img src="../Images/f40350b9c1c4cfe00d61fca5c92ddca4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1090/format:webp/0*MNUBm62-getKzLKB.png"/></div></figure><p id="9a6c" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">邀请机器人加入频道:</p><figure class="ms mt mu mv gt jr gh gi paragraph-image"><div class="gh gi ok"><img src="../Images/0426b0f926c4a4cfff2dc57d0840ad51.png" data-original-src="https://miro.medium.com/v2/resize:fit:1086/format:webp/0*3NIwbtz6ojgccV9o.png"/></div></figure><figure class="ms mt mu mv gt jr gh gi paragraph-image"><div class="gh gi nw"><img src="../Images/5d6cd128ffc848beb3ab7f63960cd412.png" data-original-src="https://miro.medium.com/v2/resize:fit:1020/format:webp/0*7pb09_eW8u5boLeV.png"/></div></figure><p id="c414" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">向Jenkins脚本添加一个新函数— <code class="fe mn mo mp mq b">notifySlack()</code>，并从<code class="fe mn mo mp mq b">catch{}</code>运行它，以便在扫描过程中发现任何秘密时发送警报:</p><pre class="ms mt mu mv gt mw mq mx my aw mz bi"><span id="8d8b" class="na kt iq mq b gy nb nc l nd ne">def notifySlack(String buildStatus = 'STARTED') {<br/><br/>    // Build status of null means success.<br/>    buildStatus = buildStatus ?: 'SUCCESS'<br/><br/>    def color<br/>    //change for another slack chanel<br/>    def token = 'gitleaks-slack-bot'<br/><br/>    if (buildStatus == 'STARTED') {<br/>        color = '#D4DADF'<br/>    } else if (buildStatus == 'SUCCESS') {<br/>        color = '#BDFFC3'<br/>    } else if (buildStatus == 'UNSTABLE') {<br/>        color = '#FFFE89'<br/>    } else {<br/>        color = '#FF9FA1'<br/>    }<br/><br/>    def msg = "${buildStatus}: `${env.JOB_NAME}` #${env.BUILD_NUMBER}:\n${env.BUILD_URL}"<br/>    slackSend(color: color, message: msg, tokenCredentialId: token, channel: "#devops-alarms-gitleaks-analytics")<br/>}<br/><br/><br/>node('master') {<br/>  <br/>  def repos_list = "${env.TEAM_REPOS}".split(',')<br/>  <br/>  for (repo in repos_list) {<br/>    try {<br/>      stage("Repository ${repo}") {<br/>        docker.image('zricethezav/gitleaks').inside('--entrypoint=""') {<br/>          sh "gitleaks --access-token=${GITHUB_TOKEN} --repo-url=https://github.com/example/${repo} --verbose --report=analytics-${repo}-repo.json"<br/>        }<br/>      }   <br/>    } catch(e) {<br/>        currentBuild.result = 'FAILURE'<br/>        notifySlack(currentBuild.result)<br/>    } <br/>  }     <br/>}</span></pre><h2 id="38aa" class="na kt iq bd ku nf ng dn ky nh ni dp lc kf nj nk lg kj nl nm lk kn nn no lo np bi translated">Jenkins . plugins . slack . standardslackservice postToSlack响应代码:404</h2><p id="fadd" class="pw-post-body-paragraph ju jv iq jw b jx ls jz ka kb lt kd ke kf mh kh ki kj mi kl km kn mj kp kq kr ij bi translated">运行构建，并得到以下错误:</p><blockquote class="ol om on"><p id="b44c" class="ju jv mr jw b jx jy jz ka kb kc kd ke oo kg kh ki op kk kl km oq ko kp kq kr ij bi translated">12:42:39错误:时差通知失败。有关详细信息，请参阅Jenkins日志。</p></blockquote><p id="7701" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">查看Jenkin在<em class="mr">https://&lt;JENKINS _ URL&gt;/log/all</em>上的日志:</p><figure class="ms mt mu mv gt jr gh gi paragraph-image"><div class="gh gi or"><img src="../Images/0595d2d9c9c0f044fb7cd5aea7491f7e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1070/format:webp/0*Btpx4crhL8K9pUyh.png"/></div></figure><p id="f001" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">进入<em class="mr">管理Jenkins &gt;配置系统</em>，找到Slack插件的选项，设置<em class="mr">自定义slack app bot用户</em>:</p><figure class="ms mt mu mv gt jr gh gi paragraph-image"><div class="gh gi os"><img src="../Images/b39ec4fcfa48dc7bea43d23817a99ffe.png" data-original-src="https://miro.medium.com/v2/resize:fit:700/format:webp/0*0Ne4gw8GqtvrTRfp.png"/></div></figure><p id="89ab" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">这里的凭证是默认的，我们将从管道中覆盖它们。</p><p id="23f6" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">在<em class="mr">高级</em>中删除<em class="mr">覆盖URL，如果设置了</em>:</p><figure class="ms mt mu mv gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="nr ns di nt bf nu"><div class="gh gi ot"><img src="../Images/8aa4722f8b92bcc701ae5f0f37d3866b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*ooonPJHTWtrPpkwF.png"/></div></div></figure><p id="2f5c" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">再次运行，现在一切正常:</p><figure class="ms mt mu mv gt jr gh gi paragraph-image"><div class="gh gi ou"><img src="../Images/58f5d95b0000c8e6561ea28c9b13f672.png" data-original-src="https://miro.medium.com/v2/resize:fit:1196/format:webp/0*htXa6-fm87t8LoDL.png"/></div></figure><h2 id="65ed" class="na kt iq bd ku nf ng dn ky nh ni dp lc kf nj nk lg kj nl nm lk kn nn no lo np bi translated">文件上传到松弛时间</h2><p id="c5d2" class="pw-post-body-paragraph ju jv iq jw b jx ls jz ka kb lt kd ke kf mh kh ki kj mi kl km kn mj kp kq kr ij bi translated">现在，让我们通过使用<code class="fe mn mo mp mq b">slackUploadFile()</code>函数向Slack通道中的消息添加一个报告文件upload和发现:</p><pre class="ms mt mu mv gt mw mq mx my aw mz bi"><span id="4be0" class="na kt iq mq b gy nb nc l nd ne">def notifySlack(String buildStatus = 'STARTED', reportFile) {<br/><br/>    // Build status of null means success.<br/>    buildStatus = buildStatus ?: 'SUCCESS'<br/><br/>    def color<br/>    //change for another slack chanel<br/>    def token = 'gitleaks-slack-bot'<br/><br/>    if (buildStatus == 'STARTED') {<br/>        color = '#D4DADF'<br/>    } else if (buildStatus == 'SUCCESS') {<br/>        color = '#BDFFC3'<br/>    } else if (buildStatus == 'UNSTABLE') {<br/>        color = '#FFFE89'<br/>    } else {<br/>        color = '#FF9FA1'<br/>    }<br/><br/>    def msg = "${buildStatus}: `${env.JOB_NAME}` #${env.BUILD_NUMBER}:\n${env.BUILD_URL}"<br/>    slackSend(color: color, message: msg, tokenCredentialId: token, channel: "#devops-alarms-gitleaks-analytics")<br/>    slackUploadFile(credentialId: token, channel: "#devops-alarms-gitleaks-analytics", filePath: "${reportFile}")<br/>}<br/><br/><br/>node('master') {<br/>  <br/>  def repos_list = "${env.TEAM_REPOS}".split(',')<br/>  <br/>  for (repo in repos_list) {<br/>    try {<br/>      stage("Repository ${repo}") {<br/>        docker.image('zricethezav/gitleaks').inside('--entrypoint=""') {<br/>          sh "gitleaks --access-token=${GITHUB_TOKEN} --repo-url=https://github.com/example/${repo} --verbose --report=analytics-${repo}-repo.json"<br/>        }<br/>      }   <br/>    } catch(e) {<br/>        currentBuild.result = 'FAILURE'<br/>        notifySlack(currentBuild.result, "analytics-${repo}-repo.json")<br/>    } <br/>  }     <br/>}</span></pre><p id="b760" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">这里的通道可以在以后移动到作业的参数中。</p><p id="f677" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">这里，在<code class="fe mn mo mp mq b">notifySlack()</code>中，我们添加了另一个参数——T9，然后在<code class="fe mn mo mp mq b">notifySlack()</code>函数调用期间，我们将报告文件作为第二个参数传递给函数。</p><p id="9ea0" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">运行作业，检查松弛通道:</p><figure class="ms mt mu mv gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="nr ns di nt bf nu"><div class="gh gi ov"><img src="../Images/57072d06056e58de1fd254843ed0ae80.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*TLS3NXve1xRkI4K6.png"/></div></div></figure><p id="8dfe" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">最后一件事是设置运行作业的时间表:</p><figure class="ms mt mu mv gt jr gh gi paragraph-image"><div class="gh gi ow"><img src="../Images/12aec128688449d0d58c9366df00f1be.png" data-original-src="https://miro.medium.com/v2/resize:fit:738/format:webp/0*QcwvaPYPM1S7adbT.png"/></div></figure><h1 id="b4ce" class="ks kt iq bd ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp bi translated">Gitleaks配置</h1><h2 id="82cc" class="na kt iq bd ku nf ng dn ky nh ni dp lc kf nj nk lg kj nl nm lk kn nn no lo np bi translated">提交检查</h2><p id="1514" class="pw-post-body-paragraph ju jv iq jw b jx ls jz ka kb lt kd ke kf mh kh ki kj mi kl km kn mj kp kq kr ij bi translated">此时，Gitleasks将对存储库进行全面扫描——所有提交，所有历史。</p><p id="ec5a" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">如果我们每天都运行它，那么每天我们都会收到一些关于旧的有问题的提交的消息。</p><p id="eac2" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">作为一种减轻风险的方法，我们可以创建两个作业:在第一个作业中，我们将执行完全扫描，在第二个作业中，我们将对过去24小时内发生的更改执行一种增量扫描。</p><p id="6b97" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">也就是说,“增量”作业将在每天中午12:00运行，此时所有开发人员都在办公室，该作业将只检查最后一天的提交。</p><p id="1305" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">为此，Gitleaks提供了<code class="fe mn mo mp mq b">--commit-since</code>选项。让我们添加一个名为<code class="fe mn mo mp mq b">yesterday</code>的新变量，它带有由<code class="fe mn mo mp mq b">Date()</code>类的<code class="fe mn mo mp mq b">previous()</code>方法获取的昨天的日期，然后这个日期将被传递给<code class="fe mn mo mp mq b">--commit-since</code>:</p><pre class="ms mt mu mv gt mw mq mx my aw mz bi"><span id="a328" class="na kt iq mq b gy nb nc l nd ne">...<br/><br/>node('master') { <br/>  <br/>  def repos_list = "${env.TEAM_REPOS}".split(',')<br/>  def yesterday = new Date().format( 'yyyy-MM-dd' ).previous()<br/><br/>  println yesterday<br/>  <br/>  for (repo in repos_list) {<br/>    try {<br/>      stage("Repository ${repo}") {<br/>        docker.image('zricethezav/gitleaks').inside('--entrypoint=""') {<br/>          sh "gitleaks --access-token=${GITHUB_TOKEN} --repo-url=https://github.com/example/${repo} --verbose --report=analytics-${repo}-repo.json --commit-since=${yesterday}"<br/>        }<br/>      }<br/>    } catch(e) {<br/>        currentBuild.result = 'FAILURE'<br/>        notifySlack(currentBuild.result, "analytics-${repo}-repo.json")<br/>    }<br/>  }<br/>}</span></pre><h2 id="c068" class="na kt iq bd ku nf ng dn ky nh ni dp lc kf nj nk lg kj nl nm lk kn nn no lo np bi translated">Gitleaks配置文件</h2><p id="431d" class="pw-post-body-paragraph ju jv iq jw b jx ls jz ka kb lt kd ke kf mh kh ki kj mi kl km kn mj kp kq kr ij bi translated">另一件事是为Gitleaks创建一个专用的规则文件。</p><p id="facb" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">这可以用<code class="fe mn mo mp mq b">--repo-config-path</code>来完成，在每个存储库中，我们可以添加它自己的配置文件。</p><p id="59df" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">添加一些默认规则，另外我想检查作为明文传递给提交的密码:</p><pre class="ms mt mu mv gt mw mq mx my aw mz bi"><span id="6bea" class="na kt iq mq b gy nb nc l nd ne">...<br/><br/>[[rules]]<br/>    description = "Plaintext password"<br/>    regex = '''(?i)pass*[a-z]{5}[:|=]? +["|'](.*)["|']'''<br/>    tags = ["password", "PlainTextPassword"]<br/><br/>[allowlist]<br/>    description = "Allowlisted files"<br/>    files = ['''^\.?gitleaks.config$''']</span></pre><p id="1207" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">使用<code class="fe mn mo mp mq b">(?i)pass*[a-z]{5}[:|=]? +["|'](.*)["|']</code>正则表达式，我们寻找一个以<em class="mr"> pass </em>开始的字符串，然后是一个":"或" = "符号，然后它可以包含或不包含一个空格，然后是一个引号，然后是任何文本，再次是引号。</p><p id="7f47" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">看来肯定是管用的:</p><figure class="ms mt mu mv gt jr gh gi paragraph-image"><div class="gh gi ox"><img src="../Images/b88e43e82ca44987b8e09a8c1aa0f757.png" data-original-src="https://miro.medium.com/v2/resize:fit:1144/format:webp/0*QtapRptZYdxZh8Jk.png"/></div></figure><p id="ab60" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">将其作为<code class="fe mn mo mp mq b">.github/gitleaks.config</code>保存到存储库中，并通过使用该文件在作业中添加另一个参数:</p><pre class="ms mt mu mv gt mw mq mx my aw mz bi"><span id="1aa7" class="na kt iq mq b gy nb nc l nd ne">...<br/>        docker.image('zricethezav/gitleaks').inside('--entrypoint=""') {<br/>          sh "gitleaks --access-token=${GITHUB_TOKEN} --repo-url=https://github.com/example/${repo} --verbose --report=analytics-${repo}-repo.json --commit-since=${yesterday} --repo-config-path=.github/gitleaks.config"<br/>        }<br/>...</span></pre><p id="8285" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">目前就这些。</p></div><div class="ab cl oy oz hu pa" role="separator"><span class="pb bw bk pc pd pe"/><span class="pb bw bk pc pd pe"/><span class="pb bw bk pc pd"/></div><div class="ij ik il im in"><p id="9fce" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated"><em class="mr">最初发布于</em> <a class="ae mb" href="https://rtfm.co.ua/en/git-scanning-repositories-for-secrets-using-gitleaks/" rel="noopener ugc nofollow" target="_blank"> <em class="mr"> RTFM: Linux、DevOps、系统管理</em> </a> <em class="mr">。</em></p></div></div>    
</body>
</html>