<html>
<head>
<title>Promise-based circuit breaking for gRPC in Node.js</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Node.js中gRPC的基于承诺的断路</h1>
<blockquote>原文：<a href="https://itnext.io/promise-based-circuit-breaking-for-grpc-in-node-js-b6ce3f3efa54?source=collection_archive---------1-----------------------#2019-05-21">https://itnext.io/promise-based-circuit-breaking-for-grpc-in-node-js-b6ce3f3efa54?source=collection_archive---------1-----------------------#2019-05-21</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><figure class="ip iq gp gr ir is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi io"><img src="../Images/8c8e5f5ed7487fea34fb7a2ca2e23dab.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*MLpium7nMAYT-5psOxPk3Q.jpeg"/></div></div></figure><div class=""/><p id="9ca0" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">构建微服务需要关注架构的许多方面。其中之一是可靠性，而“<a class="ae kw" href="http://microservices.io/patterns/reliability/circuit-breaker.html" rel="noopener ugc nofollow" target="_blank">断路器</a>可以帮助解决系统中的这一问题:服务有时会在处理请求时协作，并且总是存在另一个服务不可用或太慢而不可用的可能性。在等待另一个服务响应时，资源可能会被浪费，这可能会导致资源耗尽，并可能级联到整个应用程序中的其他服务。</p><p id="28d4" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在过去的一个项目中，我确实在Node.js内置的API网关中实现了这样的机制(它必须通过gRPC与各种服务进行通信)——所以我使用<a class="ae kw" href="https://www.npmjs.com/package/hystrixjs" rel="noopener ugc nofollow" target="_blank"> Hystrix.js </a>(最初在网飞用Java编写的库)为这样的调用编写了一个小包装器。</p><p id="5afc" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">下面代码的存储库是这里的<a class="ae kw" href="https://github.com/lucavallin/grpc-circuitbreaker" rel="noopener ugc nofollow" target="_blank"/>。</p></div><div class="ab cl kx ky hu kz" role="separator"><span class="la bw bk lb lc ld"/><span class="la bw bk lb lc ld"/><span class="la bw bk lb lc"/></div><div class="ij ik il im in"><h1 id="4293" class="le lf jb bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">创建命令功能</h1><p id="9091" class="pw-post-body-paragraph jy jz jb ka b kb mc kd ke kf md kh ki kj me kl km kn mf kp kq kr mg kt ku kv ij bi translated"><strong class="ka jc"> <em class="mh"> createCommand </em> </strong>函数设置您想要运行的RPC命令，并为配置设置一些可定制的默认值。</p><pre class="mi mj mk ml gt mm mn mo mp aw mq bi"><span id="6e6f" class="mr lf jb mn b gy ms mt l mu mv">const CommandsFactory = require("hystrixjs").commandFactory;<br/>const createCommand = (<br/>  runFn,<br/>  opts = {<br/>    name: Symbol(runFn),<br/>    errorThreshold: 1,<br/>    timeout: 3000,<br/>    concurrency: 0<br/>  }<br/>) =&gt;<br/>  CommandsFactory.getOrCreate(opts.name)<br/>    .circuitBreakerErrorThresholdPercentage(opts.errorThreshold)<br/>    .timeout(opts.timeout)<br/>    .run(runFn)<br/>    .circuitBreakerSleepWindowInMilliseconds(opts.timeout)<br/>    .statisticalWindowLength(10000)<br/>    .statisticalWindowNumberOfBuckets(10)<br/>    .requestVolumeRejectionThreshold(opts.concurrency)<br/>    .build();</span></pre><p id="cf57" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">这由<strong class="ka jc"><em class="mh">createrpcommand</em></strong>函数在内部使用，该函数“承诺”该命令——这是基本库中所缺少的功能。</p><pre class="mi mj mk ml gt mm mn mo mp aw mq bi"><span id="7b0e" class="mr lf jb mn b gy ms mt l mu mv">const createRpcCommand = rpcFn =&gt;<br/>  createCommand(<br/>    request =&gt;<br/>      new Promise((resolve, reject) =&gt; {<br/>        rpcFn(request, (error, response) =&gt; {<br/>          if (error) reject(error);<br/>          resolve(response);<br/>        });<br/>      })<br/>  );</span><span id="0636" class="mr lf jb mn b gy mw mt l mu mv">module.exports = {<br/>  createRpcCommand<br/>};</span></pre><h1 id="e144" class="le lf jb bd lg lh mx lj lk ll my ln lo lp mz lr ls lt na lv lw lx nb lz ma mb bi translated">使用</h1><p id="42e1" class="pw-post-body-paragraph jy jz jb ka b kb mc kd ke kf md kh ki kj me kl km kn mf kp kq kr mg kt ku kv ij bi translated">包装器现在可以用于现实世界的应用程序，在这些应用程序中，您需要一个基于承诺的断路器来与Node.js应用程序中的任何其他服务进行通信:</p><pre class="mi mj mk ml gt mm mn mo mp aw mq bi"><span id="594c" class="mr lf jb mn b gy ms mt l mu mv">const messages = require("your-protobuf-messages");<br/>const rpcClient = require("your-grpc-client");<br/>const { createRpcCommand } = require("grpc-circuitbreaker");</span><span id="a397" class="mr lf jb mn b gy mw mt l mu mv">// Let's say rpcClient.get(request, (err, res) ...) is your function<br/>// You really need .bind()!<br/>const command = createRpcCommand(rpcClient.get.bind(rpcClient));<br/>const request = new messages.YourMessage();</span><span id="c1f0" class="mr lf jb mn b gy mw mt l mu mv">command<br/>  .execute(request)<br/>  .then(response =&gt; {<br/>    // do something with response<br/>  })<br/>  .catch(error =&gt; {<br/>    // do something with error<br/>  });</span></pre></div><div class="ab cl kx ky hu kz" role="separator"><span class="la bw bk lb lc ld"/><span class="la bw bk lb lc ld"/><span class="la bw bk lb lc"/></div><div class="ij ik il im in"><p id="ca5c" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><strong class="ka jc"> <em class="mh">想了解更多微服务和创新？关注@lucavallin上</em> </strong> <a class="ae kw" href="https://twitter.com/lucavallin" rel="noopener ugc nofollow" target="_blank"> <strong class="ka jc"> <em class="mh">推特</em> </strong> </a> <strong class="ka jc"> <em class="mh">和</em></strong><a class="ae kw" href="https://github.com/lucavallin" rel="noopener ugc nofollow" target="_blank"><strong class="ka jc"><em class="mh">Github</em></strong></a><strong class="ka jc"><em class="mh">或者来</em> </strong> <a class="ae kw" href="https://www.xebia.studio/" rel="noopener ugc nofollow" target="_blank"> <strong class="ka jc"> <em class="mh"> Xebia工作室</em> </strong> </a> <strong class="ka jc"> <em class="mh">和我们见面吧！</em>T47】</strong></p></div></div>    
</body>
</html>