<html>
<head>
<title>Automate your Kubernetes cluster bootstrapping with Rancher and Ansible and speed up your pipeline</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Rancher和Ansible自动化您的Kubernetes集群引导，并加速您的管道</h1>
<blockquote>原文：<a href="https://itnext.io/automate-your-kubernetes-cluster-bootstrap-with-rancher-and-ansible-and-speed-up-your-pipeline-365f5e2fa484?source=collection_archive---------2-----------------------#2020-12-07">https://itnext.io/automate-your-kubernetes-cluster-bootstrap-with-rancher-and-ansible-and-speed-up-your-pipeline-365f5e2fa484?source=collection_archive---------2-----------------------#2020-12-07</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="34a4" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">Ansible和Rancher如何帮助简化Kubernetes集群的创建过程。</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/0d4698fb693052bddec8a57c5576f74c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*IxUxhDwByc3IN0VJ.jpg"/></div></div></figure><p id="01ab" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">您希望自动引导Kubernetes集群的原因有很多。无论是为了测试您的应用程序，还是仅仅因为您不想在配置上花费太多时间，自动化您的集群创建是利用DevOps的一个显而易见的决定。在这里，我们将描述如何使用Rancher和Ansible提高您的生产率，并将这种自动化集成到您的k8s连续交付流程中。</p><p id="63ed" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">在<a class="ae ln" href="https://medium.com/swlh/a-ci-cd-pipeline-project-for-a-trunk-based-development-strategy-in-a-kubernetes-environment-c4ffea9700fe" rel="noopener">这篇文章</a>中，我们描述了Kubernetes中的一个CI/CD管道项目，该项目依赖于Rancher和Ansible来自动创建用于测试目的的集群。用例是引导一个临时k8s环境，在将它转移到试运行和生产之前，我们可以在其中部署、测试和验证一个新特性。每当该特征与主分支合并时，该临时集群就被解除。</p><p id="abcb" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">短暂的Kubernetes集群非常适合测试。在几分钟内，就可以部署一个高度可用且完全可操作的环境，从而创建一个类似生产的小规模集群。除了您的应用程序的功能需求之外，您还可以验证它的底层配置，比如秘密、配置映射、卷、自动缩放策略等。此外，您可以应用混沌测试来预测集群故障，执行压力测试来分析其可靠性，并执行安全性测试来减少集群漏洞。</p><p id="6993" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated"><a class="ae ln" href="https://rancher.com/" rel="noopener ugc nofollow" target="_blank">devo PS景观中的Rancher </a>，为Kubernetes集群设置和管理提供了一个很好的解决方案。从单个Rancher安装，您可以管理数百个集群(或100万个，如来自<a class="ae ln" href="https://rancher.com/products/rancher/2.5" rel="noopener ugc nofollow" target="_blank"> Rancher 2.5 </a>)，在一个一体化平台中集成可观察性、安全性、日志记录和用户管理服务。最重要的是，Rancher提供了<strong class="kt ir">集群模板</strong>和<strong class="kt ir"> API </strong>，我们可以与Ansible等自动化工具进行交互。</p><p id="0aa3" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">Rancher中的集群模板是我们在自动化中使用的核心功能之一。Rancher引导过程依靠RKE (Rancher Kubernetes引擎)根据cluster.yaml文件中描述的配置来配置新的集群。从Kubernetes版本到控制平面属性，所有配置都打包在这个文件中。此外，使用Rancher，您可以从现有集群创建RKE模板。此功能增强了控制，因为我们可以使用与生产环境完全相同的配置来引导集群。</p></div><div class="ab cl lo lp hu lq" role="separator"><span class="lr bw bk ls lt lu"/><span class="lr bw bk ls lt lu"/><span class="lr bw bk ls lt"/></div><div class="ij ik il im in"><h2 id="5630" class="lv lw iq bd lx ly lz dn ma mb mc dp md la me mf mg le mh mi mj li mk ml mm mn bi translated">牧场主Kubernetes Bootsrapping的可行剧本</h2><p id="d492" class="pw-post-body-paragraph kr ks iq kt b ku mo jr kw kx mp ju kz la mq lc ld le mr lg lh li ms lk ll lm ij bi translated">在Rancher中有一个API和一个RKE模板使我们的工作更容易。使用Ansible，我们可以自动执行在Rancher中创建新的Kubernetes集群所需的步骤，并添加一些后期配置，例如来自ingress和Helm Chart部署的DNS条目。<a class="ae ln" href="https://galaxy.ansible.com/alexismaior/ansible_role_manage_rancher_cluster" rel="noopener ugc nofollow" target="_blank">例如，这个剧本</a>与Rancher交互，从模板部署集群。</p><p id="3276" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">这是我们在运行第一个行动手册之前需要的信息。这必须作为变量传递给Ansible:</p><ol class=""><li id="a4d2" class="mt mu iq kt b ku kv kx ky la mv le mw li mx lm my mz na nb bi translated">rancher_host:您的rancher安装的URL。</li><li id="4254" class="mt mu iq kt b ku nc kx nd la ne le nf li ng lm my mz na nb bi translated">rancher_clustername:新引导集群的名称。</li><li id="a34c" class="mt mu iq kt b ku nc kx nd la ne le nf li ng lm my mz na nb bi translated">rancher_user:具有“创建集群”权限的rancher用户名。</li><li id="76cd" class="mt mu iq kt b ku nc kx nd la ne le nf li ng lm my mz na nb bi translated">rancher_pass:您的rancher_user的rancher密码。</li><li id="61e6" class="mt mu iq kt b ku nc kx nd la ne le nf li ng lm my mz na nb bi translated">rancher_cluster_template_id:您的RKE模板的id(例如:ctr-abcd)</li><li id="c806" class="mt mu iq kt b ku nc kx nd la ne le nf li ng lm my mz na nb bi translated">rancher_cluster_roles:集群中每个节点将承担的角色列表(controlplane、etcd和/或worker)。</li><li id="15cc" class="mt mu iq kt b ku nc kx nd la ne le nf li ng lm my mz na nb bi translated">一个包含将添加到群集的节点的清单文件。</li></ol><p id="f097" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">行动手册执行的步骤是:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi nh"><img src="../Images/045ce9bada056519b7020def4c5f1b68.png" data-original-src="https://miro.medium.com/v2/resize:fit:1020/0*cpva6d-BvGFoyOf3"/></div><figcaption class="ni nj gj gh gi nk nl bd b be z dk translated">图一。创建牧场主集群可行行动手册工作流</figcaption></figure><p id="cfeb" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">如果一切按计划进行，集群将在Rancher UI下准备就绪并可用。一次成功的3节点(Centos 7、4核、6GB RAM)集群引导的平均时间是<strong class="kt ir"> 17分钟</strong>，但是如果您设置一个单节点集群，时间可能会稍微短一些。这是因为节点注册过程，其中每个节点下载所有需要的容器(包括Rancher代理容器)，执行所有安装并与Rancher master交互以进行配置。</p><p id="6f70" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">但是，此过程要求您已经准备好了Ansible清单，配置了虚拟机并安装了docker。这是不灵活的，并且肯定需要手动配置。我们在自动化中所做的是，在运行剧本的这一部分之前，依靠<strong class="kt ir">动态清单</strong>和<strong class="kt ir">责任角色</strong>来充分准备我们的节点。</p><p id="c379" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">由于我们的私有云是基于VMWare的，因此我们使用了<a class="ae ln" href="https://docs.ansible.com/ansible/latest/collections/community/vmware/vmware_vm_inventory_inventory.html" rel="noopener ugc nofollow" target="_blank">这个</a>动态清单插件，它查询vCenter并根据定义的标准返回虚拟机列表(我们为此使用标签)。不过，如果你选择动态创建虚拟机，你也可以使用像<a class="ae ln" href="https://galaxy.ansible.com/jtyr/ansible_vmware_vm_provisioning" rel="noopener ugc nofollow" target="_blank">这样的角色。Ansible中动态库存的惊人之处在于插件的大量可用性，无论您是在内部部署还是在公共云上，如AWS、Azure、GCP等。</a></p><p id="0771" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">让我们将这些新步骤添加到行动手册的工作流程中:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nm"><img src="../Images/a8fa6419a82d8436e0942cc272c33e93.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*Z6KW9JRpI_LVqxAY"/></div></div><figcaption class="ni nj gj gh gi nk nl bd b be z dk translated">图二。使用动态节点准备创建牧场主集群可行行动手册工作流。</figcaption></figure><p id="bc09" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">好了，现在我们有了一个基于RKE模板在Rancher上创建Kubernetes集群的自动化工具，它利用Ansible中的动态清单来基于特定标准创建或重用虚拟机。但是，为了充分利用它，我们还希望在这个集群上部署我们的应用程序，在DNS中注册入口端点，并告诉我们的开发人员，他们的集群已经准备好了，部署了他们的新特性。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nn"><img src="../Images/b68f8b4f488510005cc5fc0919dd5401.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*fVs9mSY6bVfcTVMq"/></div></div><figcaption class="ni nj gj gh gi nk nl bd b be z dk translated">图三。具有后期操作任务的完整工作流程。</figcaption></figure><p id="4f5d" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">整个过程大约需要<strong class="kt ir"> 20分钟</strong>—k8s集群引导需要17分钟+后期操作任务需要3分钟(你希望快速通道吗？继续读！)</p><p id="2012" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">总的来说，该流程与我们的CI/CD管道相集成，不仅可以动态创建集群，还可以同步主应用产品中部署的Helm Chats，并最终推出我们希望与客户一起测试/验证的功能。此外，我们执行自动化任务来验证配置、检查性能、安全性和混乱测试。到目前为止，它一直是我们持续交付流程的重要合作伙伴。</p></div><div class="ab cl lo lp hu lq" role="separator"><span class="lr bw bk ls lt lu"/><span class="lr bw bk ls lt lu"/><span class="lr bw bk ls lt"/></div><div class="ij ik il im in"><h2 id="be15" class="lv lw iq bd lx ly lz dn ma mb mc dp md la me mf mg le mh mi mj li mk ml mm mn bi translated">额外好处:使用k3s集群加速您的Kubernetes开发/测试环境</h2><p id="f6c7" class="pw-post-body-paragraph kr ks iq kt b ku mo jr kw kx mp ju kz la mq lc ld le mr lg lh li ms lk ll lm ij bi translated">好吧，所以你不想等20分钟…我也不想。一个不安分的DevOps工程师将永远在寻找替代方案，因为他/她对可靠性和性能的承诺，在我看来，这是改进自动化和CI/CD工程的本质。</p><p id="40de" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">我们最近做的是创建一个k3s集群而不是RKE集群，并将其导入到我们的Rancher安装中。</p><p id="33e7" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">K3s 是一个轻量级认证的Kubernetes发行版，专注于边缘计算。它将所有Kubernetes组件封装在一个小的二进制文件中，这也简化了集群引导过程。尽管它的大小和简单性，它仍然提供了基本的和附加的特性，例如入口控制器网络策略和作为容器运行时的containerd。</p><p id="ae90" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">对于测试环境，尤其是软件功能测试，k3s为短暂的环境提供了一个很好的解决方案，因此非常适合CI/CD集成。</p><p id="912e" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">在我们上一个工作流中，我们必须调整“管理Rancher集群”角色，在单个虚拟机中创建一个独立的k3s，然后将其导入Rancher。这个过程和原来略有不同。以前的角色从Rancher 引导Kubernetes集群<strong class="kt ir">(称为定制集群)，而这个新的角色首先直接在VM节点中创建k3s集群，然后将<strong class="kt ir">导入Rancher </strong>服务器(导入集群)。</strong></p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi no"><img src="../Images/f4b1253d3b81a6c72d144a6ba2a96dc6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*nf-Va3KtElnmYRWa"/></div></div><figcaption class="ni nj gj gh gi nk nl bd b be z dk translated">图4。创建k3s集群可行行动手册工作流</figcaption></figure><p id="6a7a" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">下图显示了我们基于<a class="ae ln" href="https://www.drone.io/" rel="noopener ugc nofollow" target="_blank"> drone.io的</a> CI/CD管道的每个步骤持续时间，用于在k8s和k3s开发/测试集群中部署新功能。检查两个环境设置时间之间的差异。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi np"><img src="../Images/426933a85aa9c682c64fdb4cf57cc536.png" data-original-src="https://miro.medium.com/v2/resize:fit:982/format:webp/1*-ypPPTz9_ECAIFQWA2uccA.png"/></div><figcaption class="ni nj gj gh gi nk nl bd b be z dk translated">无人机io中的CI/CD管道</figcaption></figure><p id="41b7" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">通过利用k3s作为我们的测试环境，我们注意到集群引导和后期操作任务从20分钟明显下降到仅<strong class="kt ir"> 6分钟</strong>。这意味着流水线速度的提高，这将促使开发人员更频繁地交付代码，更快地测试软件。</p></div></div>    
</body>
</html>