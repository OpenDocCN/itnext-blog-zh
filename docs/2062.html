<html>
<head>
<title>Load testing Serverless with Serverless at Comic Relief</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Comic Relief上的无服务器负载测试</h1>
<blockquote>原文：<a href="https://itnext.io/load-testing-serverless-with-serverless-at-comic-relief-e983e8bf52c0?source=collection_archive---------4-----------------------#2019-03-25">https://itnext.io/load-testing-serverless-with-serverless-at-comic-relief-e983e8bf52c0?source=collection_archive---------4-----------------------#2019-03-25</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="c03d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在2019年红鼻子日之前，我们如何使用无服务器大炮对我们的无服务器应用(和传统应用)进行负载测试</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi kl"><img src="../Images/28fd8ab34dc71be5ccf1a63b1aac9205.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*E8tx3rBbTxXTEezQ7fd_BA.png"/></div></div></figure><h1 id="fd72" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">这个红鼻子日是什么东西？</h1><p id="9da4" class="pw-post-body-paragraph jn jo iq jp b jq lv js jt ju lw jw jx jy lx ka kb kc ly ke kf kg lz ki kj kk ij bi translated">自从1988年发起以来，红鼻子日已经成为英国的一种习俗。这一天，全国各地的人们可以聚在一起，在家里、学校和工作场所筹集资金，以支持英国和国际上的弱势群体和社区。</p><p id="939d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">整整一年都是行人流量，然后每样东西都有五个小时处于危险之中，我们需要能够确保我们的系统失败并优雅地倒过来。我将向您简要介绍我们如何在峰值负载之上持续对系统进行负载测试，确保我们不会引入应用程序在流量冲击期间无法处理的漏洞。给我的<a class="ae ma" href="https://medium.com/@adamclarkdev/journey-to-serverless-d3256d91af16" rel="noopener">上一篇关于无服务器之旅的文章</a>读一读，了解一下我们是如何实现几乎一切无服务器并大幅减少AWS占用空间的。</p><h1 id="a6b5" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">背景故事</h1><p id="b20d" class="pw-post-body-paragraph jn jo iq jp b jq lv js jt ju lw jw jx jy lx ka kb kc ly ke kf kg lz ki kj kk ij bi translated">因此，要理解我们现在在负载测试中的位置，您需要知道我们从哪里来。</p><p id="a79e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们之前使用了部署在EC2 spot实例负载上的<a class="ae ma" href="https://github.com/JoeDog/siege" rel="noopener ugc nofollow" target="_blank">围攻</a>，所有这些都是使用<a class="ae ma" href="https://www.terraform.io/" rel="noopener ugc nofollow" target="_blank">地形</a>和<a class="ae ma" href="https://www.ansible.com/" rel="noopener ugc nofollow" target="_blank"> Ansible </a>部署的。为了模拟我们过去最重要的交通事件之一，我们使用了32个r4.large实例进行一系列slam测试。它允许我们生成所需的负载，以确保我们的应用程序按预期工作。从工程(和成本)角度来看，缺点非常明显。这些是，</p><ul class=""><li id="f83b" class="mb mc iq jp b jq jr ju jv jy md kc me kg mf kk mg mh mi mj bi translated">部署基础设施、设置和运行测试需要几天时间。</li><li id="e634" class="mb mc iq jp b jq mk ju ml jy mm kc mn kg mo kk mg mh mi mj bi translated">不必要地增加了负载测试的成本，基础设施的部署时间通常也比需要的时间长得多。</li><li id="9199" class="mb mc iq jp b jq mk ju ml jy mm kc mn kg mo kk mg mh mi mj bi translated">它不容易被工程团队中想要测试他们系统的每个人复制。</li></ul><h1 id="e3c5" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">新的希望</h1><p id="5206" class="pw-post-body-paragraph jn jo iq jp b jq lv js jt ju lw jw jx jy lx ka kb kc ly ke kf kg lz ki kj kk ij bi translated">Peter (工程主管)和我努力理解遗留方法以及我们如何推进它，我们开始在谷歌上搜索立即生效的替代方案。我们很快遇到了两个非常合适的候选人；这些是<a class="ae ma" href="https://goad.io/" rel="noopener ugc nofollow" target="_blank">驱迫器</a>和<a class="ae ma" href="https://github.com/Nordstrom/serverless-artillery" rel="noopener ugc nofollow" target="_blank">无服务器火炮</a>。我们对两者做了一个快速的比较，并选定了<a class="ae ma" href="https://github.com/Nordstrom/serverless-artillery" rel="noopener ugc nofollow" target="_blank">无服务器大炮</a>，因为它是用NodeJS编写的，并使用了<a class="ae ma" href="https://serverless.com/" rel="noopener ugc nofollow" target="_blank">无服务器框架</a>，这与我们其他新兴的无服务器应用程序是一致的。</p><p id="f5d8" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">为了让您对我们的方法有更多的了解，我们通常会针对我们的应用程序执行不同的测试选择，下面是对每种测试类型以及我们为什么要这样做的快速解释。</p><ul class=""><li id="11f7" class="mb mc iq jp b jq jr ju jv jy md kc me kg mf kk mg mh mi mj bi translated"><strong class="jp ir">点滴试验</strong>通常持续几天。这可确保我们模拟正常的后台负载水平，观察站点在正常操作下的行为，并将延迟或错误率增加的任何时段与这些时段内已知发生的活动(例如部署、缓存清理和我们负载测试计划的其他元素)相关联。</li><li id="f2fb" class="mb mc iq jp b jq mk ju ml jy mm kc mn kg mo kk mg mh mi mj bi translated"><strong class="jp ir"> Slam测试</strong>至<strong class="jp ir"> </strong>模拟流量的突然峰值，这使我们能够了解站点在面对传统的自动扩展系统难以恰当处理的流量状况时的行为。我们在这里的目标是确定在突然的流量高峰期间可能出现的错误的级别和类型。由于喜剧救济的性质，响应于新闻故事、在国家电视上播放的吸引人的电影和其他类似事件，可能出现极其急剧的流量峰值。</li><li id="1a86" class="mb mc iq jp b jq mk ju ml jy mm kc mn kg mo kk mg mh mi mj bi translated"><strong class="jp ir">匝道测试</strong>产生一个逐渐增加的交通流量水平，类似于活动期间每天的流量水平。</li></ul><figure class="km kn ko kp gt kq gh gi paragraph-image"><div class="ab gu cl mp"><img src="../Images/283686679578d83d60ab98d429e01752.png" data-original-src="https://miro.medium.com/v2/format:webp/1*7ijmNKmGqYR8fw2RRoGZMw.png"/></div><figcaption class="mq mr gj gh gi ms mt bd b be z dk translated">电视之夜前的捐赠流量</figcaption></figure><p id="704d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">就我们的负载测试工作流而言，我们将所有的负载测试计划与测试代码一起存储在一个存储库中。我们可能会让计划更接近我们正在测试的应用程序，但是这些东西会自然增长，所以，哦，好吧！对于每个负载测试，我们在GitHub中创建一个发布，记录负载测试和任何信息或发现；稍后我们可以快速回头看这些，所有与负载测试相关的代码更改都是sed发布的一部分。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi mu"><img src="../Images/8236ad4b020441aa74c97b924aa58d1e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*F7rn7OxzKnxxBuysCdHDcQ.png"/></div></div><figcaption class="mq mr gj gh gi ms mt bd b be z dk translated">我们的查找服务的负载测试版本</figcaption></figure><p id="6c6d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们从<a class="ae ma" href="https://github.com/Nordstrom/serverless-artillery" rel="noopener ugc nofollow" target="_blank">无服务器火炮</a>向<a class="ae ma" href="https://www.influxdata.com/" rel="noopener ugc nofollow" target="_blank"> InfluxDB </a>报告负载测试的性能；然后我们在Grafana中可视化该报告，并在我们的GitHub版本中链接到它。</p><p id="fd7b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们从一个单独的AWS帐户对我们正在测试的应用程序运行所有的负载测试，这使我们能够快速了解运行测试的成本，也意味着我们不会超出我们的lambda调用限制(希望不会，我们有非常高的调用限制)。我们通常还会从不同的AWS区域对应用程序进行负载测试。更科学的做法可能是从另一家云提供商那里运行这些服务，以更接近真实用户，但目前对我们来说已经足够接近了。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div class="ab gu cl mp"><img src="../Images/f79aee2bb5fbeb3b27c04386507eaa21.png" data-original-src="https://miro.medium.com/v2/format:webp/1*cz8fUEO8_Z2DzG2zGdliSA.png"/></div><figcaption class="mq mr gj gh gi ms mt bd b be z dk translated">向InfluxDB报告并在Grafana中查看的无服务器火炮载荷试验</figcaption></figure><p id="28b3" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">所以，为了让你全面了解我们如何用<a class="ae ma" href="https://github.com/Nordstrom/serverless-artillery" rel="noopener ugc nofollow" target="_blank">无服务器大炮</a>对<a class="ae ma" href="https://giftaid.comicrelief.com/" rel="noopener ugc nofollow" target="_blank">礼物援助应用程序</a>进行负载测试，我需要给你提供一些背景。对该应用程序的最佳描述是一个用户提交其详细信息的表单，以便我们可以在短信捐赠上申请礼品援助。</p><p id="f0b5" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">点击<a class="ae ma" href="https://giftaid.comicrelief.com/" rel="noopener ugc nofollow" target="_blank">礼物援助应用</a>的流量通常在BBC广播频道的行动号召之后非常高，在几秒钟内从0上升到数千个请求。它可能是我们负载最高的应用程序，但也是我们最简单的用户流之一，因为大部分负载是针对单个lambda的。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi mv"><img src="../Images/3bb71763b670a1623ac5405afe9c1932.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*3ZYISdT6D8b8cnn_BZQePw.png"/></div></div><figcaption class="mq mr gj gh gi ms mt bd b be z dk translated">礼品资助表格</figcaption></figure><p id="fb66" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在下面的测试中，我们定义了无服务器后端的端点，设置了60秒的持续时间，每秒120次提交的到达率上升到每秒240次提交。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi mw"><img src="../Images/b848ecb6063dc269561b051cc542b160.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*VCGRDx3wausTYPHde8nlDg.png"/></div></div></figure><p id="fb92" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">然后我们创建提交逻辑，使用faker NPM模块向无服务器端点提交一个包含随机数据的表单。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi mx"><img src="../Images/df1d349bd3216a8864b8c94c57d5261b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*lh3SKVYT_vazF2DNFpoiqA.png"/></div></div></figure><p id="2ab7" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">就这么简单，我在这里就不赘述了，因为<a class="ae ma" href="https://github.com/Nordstrom/serverless-artillery" rel="noopener ugc nofollow" target="_blank">无服务器火炮</a>和<a class="ae ma" href="https://github.com/artilleryio/artillery" rel="noopener ugc nofollow" target="_blank">火炮</a>文档都超出了我在这里所能描述的范围。</p><p id="ebb4" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">一旦我们在本地机器上验证并运行了一个低流量版本的测试，以确保它像预期的那样工作，我们运行<code class="fe my mz na nb b">slsart deploy</code>将负载测试部署到AWS，然后使用<code class="fe my mz na nb b">slasrt invoke</code>调用负载测试。然后，我们将立即开始查看Grafana中被调用的负载测试lambdas的计数，看到流量开始到达后端，并可以注意错误或延迟问题。</p><p id="c0e4" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在斜坡测试中，我们通常会看到请求上升，并确保响应速度或客户端错误不会突然下降。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi nc"><img src="../Images/9a8798be39b266b5db4b802b1dc47014.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*aY03l5Yr1zTiE2xU8xmwtg.png"/></div></div><figcaption class="mq mr gj gh gi ms mt bd b be z dk translated">超过5分钟的上升请求</figcaption></figure><p id="05cb" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们在非常突然的高流量峰值上看到的一个常见问题是，您将获得相当大的预热延迟。一旦兰姆达斯舰队得到补给和温暖，这通常会得到控制。我们构建我们的前端应用程序来处理这种初始峰值，如果它发生了，不会吓坏用户。在P99.99上平均382毫秒是可以接受的，但我们最终会为那些看了8秒钟旋转器的人感到难过。</p><p id="e8aa" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">对于电视之夜，随着时间的推移，我们通常会看到越来越温暖的兰姆达斯车队，所以这不是一个问题。当我们知道高峰即将到来时，我们可以温暖一队兰姆达斯；不过，峰值通常不是那么容易预测的。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi nd"><img src="../Images/1f3cafeeb581ef3f4c94df794b5283b7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*LIPLCZyGrXtrcszo-Mej4Q.png"/></div></div><figcaption class="mq mr gj gh gi ms mt bd b be z dk translated">预热延迟峰值</figcaption></figure><p id="157e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">当负载测试运行时，我们将高度警惕来自<a class="ae ma" href="https://sentry.io" rel="noopener ugc nofollow" target="_blank">哨兵</a>和<a class="ae ma" href="https://www.iopipe.com/" rel="noopener ugc nofollow" target="_blank"> IOPipe </a>的错误。我们通常会尝试完全复制负载测试环境的警报和仪表板，以匹配生产，让我们完全习惯于我们将在活动期间看到的内容。</p><p id="c3cd" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在活动开始前，我们还举办了几个游戏日，让企业的利益相关者参与测试和模拟。我们运行这些测试的更多扩展版本，以复制电视之夜的流量概况的压缩版本，同时在youtube上观看红鼻子日的重播。这一过程有助于团队习惯于他们晚上将会看到的东西，并允许创建和优化沟通路线。</p><h1 id="3439" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">最后的想法</h1><p id="7ae5" class="pw-post-body-paragraph jn jo iq jp b jq lv js jt ju lw jw jx jy lx ka kb kc ly ke kf kg lz ki kj kk ij bi translated">我们的下一步可能是为我们的负载测试带来一定程度的自动化，并将测试与我们的功能测试一起引入我们的<a class="ae ma" href="https://concourse-ci.org/" rel="noopener ugc nofollow" target="_blank"> Concourse CI </a>管道。随着新特性的出现，了解我们系统的负载含义并确保我们不会带来任何关键问题将是一件非常棒的事情。</p><p id="4d7b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这对我们来说就像负载测试一样简单。我们鼓励工程团队中的每一个班都去做，并对此感到舒适。无服务器之前的负载测试过程看起来总是像一场艰苦的斗争，有点痛苦，并且针对一个利基技能集。就像无服务器中的所有东西一样，它只是去掉了一些额外的垃圾环，您必须跳过这些环才能完成外围工作并继续您的一天。负载测试的价格和时间现在处于一个可以忽略不计的水平，它不能成为不做测试的理由。</p></div><div class="ab cl ne nf hu ng" role="separator"><span class="nh bw bk ni nj nk"/><span class="nh bw bk ni nj nk"/><span class="nh bw bk ni nj"/></div><div class="ij ik il im in"><p id="43a8" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果你喜欢这篇文章，那么看看我们走向无服务器之旅的<a class="ae ma" href="https://medium.com/@adamclarkdev/journey-to-serverless-d3256d91af16" rel="noopener">故事</a>以及<a class="ae ma" href="https://medium.com/@adamclarkdev/monitoring-debugging-serverless-applications-for-red-nose-day-2019-b2e3dd43613b" rel="noopener">我们如何调试我们的应用</a>。</p><p id="c23b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">此外，请务必观看由我们的工程主管<a class="ae ma" href="https://github.com/pvhee" rel="noopener ugc nofollow" target="_blank"> Peter Vanhee </a>在<a class="ae ma" href="https://serverlesscomputing.london/" rel="noopener ugc nofollow" target="_blank">伦敦无服务器计算大会</a>上介绍我们当前架构的<a class="ae ma" href="https://www.youtube.com/watch?v=uyWDrEh0PvA" rel="noopener ugc nofollow" target="_blank">演讲。此外，查看我们的</a><a class="ae ma" href="http://technology.comicrelief.com" rel="noopener ugc nofollow" target="_blank">技术博客</a>了解更多关于我们如何做我们所做的事情的故事。</p></div></div>    
</body>
</html>