<html>
<head>
<title>Terraform — Reducing “glue” shell scripts</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Terraform —减少“粘合”外壳脚本</h1>
<blockquote>原文：<a href="https://itnext.io/terraform-reducing-glue-shell-scripts-b050df339659?source=collection_archive---------5-----------------------#2020-05-18">https://itnext.io/terraform-reducing-glue-shell-scripts-b050df339659?source=collection_archive---------5-----------------------#2020-05-18</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/3c7b995fd2da3460d912dae2ee6558ae.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*BC25wiPudSuJoOSX.png"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">AKS出口管理</figcaption></figure><p id="e722" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">在最近的一次参与中，我使用ARM模板自动化了Azure Kubernetes服务(AKS)和相关组件的部署。客户要求我们限制对互联网的访问，微软为此提供了全面的文档。</p><p id="580e" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">为了管理出口，我配置了一个Azure防火墙和一个默认路由表来指向防火墙作为下一跳。</p><p id="4c7e" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">我们面临的一个挑战是Azure防火墙不能很好地处理所有出口规则。所有出口规则都基于FQDN；但不是所有的HTTP/HTTPS。因此，我们无法使用防火墙应用程序规则来满足以下要求。我们不得不使用只接受IP地址的网络规则。</p><ul class=""><li id="5509" class="lb lc iq ke b kf kg kj kk kn ld kr le kv lf kz lg lh li lj bi translated">API主服务器的TCP规则</li><li id="5af5" class="lb lc iq ke b kf lk kj ll kn lm kr ln kv lo kz lg lh li lj bi translated">到ntp.ubuntu.com的UDP规则</li><li id="6452" class="lb lc iq ke b kf lk kj ll kn lm kr ln kv lo kz lg lh li lj bi translated">到kms.windows.net的TCP规则</li></ul><p id="0161" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">要在ARM中管理这些规则，您必须解析IP并在部署期间将它们作为输入传递进来。这需要一个胶合脚本来执行查找，并格式化数据以作为输入变量传递。不理想，并且破坏了部署流程。</p><p id="f1e5" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">当我试图在Terraform中实现它时，我发现通过使用DNS模块实现起来更加简洁。这个过程相当简单:</p><ul class=""><li id="dd4e" class="lb lc iq ke b kf kg kj kk kn ld kr le kv lf kz lg lh li lj bi translated">设置提供程序</li><li id="0d3f" class="lb lc iq ke b kf lk kj ll kn lm kr ln kv lo kz lg lh li lj bi translated">为主机创建要解析的数据源</li><li id="c5da" class="lb lc iq ke b kf lk kj ll kn lm kr ln kv lo kz lg lh li lj bi translated">使用资源中的数据</li></ul><p id="10ea" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">最终的结果是更加整洁，减少了粘合代码，并保持了用一种语言进行端到端部署。</p><figure class="lq lr ls lt gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi lp"><img src="../Images/c0b4d2b3771ec8f73ecad5b3b2821f49.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*F3BgrI51LO8acOE4saUc2A.png"/></div></div></figure></div></div>    
</body>
</html>