<html>
<head>
<title>Building Container Images with Img</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用Img构建容器图像</h1>
<blockquote>原文：<a href="https://itnext.io/building-container-images-with-img-30e7251f9908?source=collection_archive---------6-----------------------#2019-10-31">https://itnext.io/building-container-images-with-img-30e7251f9908?source=collection_archive---------6-----------------------#2019-10-31</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/a1ad524cc02467694764bea57d159d6c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*5tNv8eTVqf4MeY-9.jpg"/></div></div></figure><p id="c7f8" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><a class="ae kw" href="https://github.com/genuinetools/img" rel="noopener ugc nofollow" target="_blank"> Img </a>是由这个领域最著名的软件工程师之一<a class="ae kw" href="https://twitter.com/jessfraz?lang=en" rel="noopener ugc nofollow" target="_blank"> Jessie Frazelle </a>发起的一个开源项目，以响应对无后台和无根容器映像构建的需求——尤其是在Kubernetes中。她的博客文章<a class="ae kw" href="https://blog.jessfraz.com/post/building-container-images-securely-on-kubernetes/" rel="noopener ugc nofollow" target="_blank">“在Kubernetes上安全地构建容器图像”</a>描述了创建Img项目的基本原理。</p><p id="eb12" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">本质上，Img是另一种开源构建相关技术的包装器，称为<a class="ae kw" href="https://github.com/moby/buildkit" rel="noopener ugc nofollow" target="_blank"> BuildKit </a>，它作为一个库嵌入在Img中。BuildKit是一个极其强大的多用途构建引擎，是Docker制定的莫比项目的一部分。在研究BuildKit提供的一些构建特性之前，让我们看看Img是如何公开这些特性的。</p><h1 id="e6cb" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">Img</h1><p id="c041" class="pw-post-body-paragraph jy jz iq ka b kb lv kd ke kf lw kh ki kj lx kl km kn ly kp kq kr lz kt ku kv ij bi translated">Img直接面向那些熟悉Dockerfile作为构建步骤来源，以及将<code class="fe ma mb mc md b">docker build</code>命令作为构建<a class="ae kw" href="https://github.com/opencontainers/image-spec/blob/master/spec.md#image-format-specification" rel="noopener ugc nofollow" target="_blank"> OCI兼容容器映像</a>的手段的开发人员。</p><h1 id="7dee" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">Img CLI</h1><p id="1cb3" class="pw-post-body-paragraph jy jz iq ka b kb lv kd ke kf lw kh ki kj lx kl km kn ly kp kq kr lz kt ku kv ij bi translated">从UX的角度来看，Img提供了一组命令，这些命令模拟了与容器映像构建、分发和映像操作相关的等效Docker CLI命令。除了用于调用实际映像构建的<code class="fe ma mb mc md b">img build</code>, Img还有用于与容器注册中心交互的命令；<code class="fe ma mb mc md b">img login</code>、<code class="fe ma mb mc md b">img pull</code>、<code class="fe ma mb mc md b">img push</code>等等。当谈到在本地缓存中操作图像时，就像Docker一样，可以列出、删除、标记和保存图像。甚至还有一些方便的内务管理命令，用于监控磁盘使用情况，并保持在构建缓存的顶部。</p><p id="473d" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">对于图像构建，<code class="fe ma mb mc md b">img build</code>命令复制了<code class="fe ma mb mc md b">docker build</code>提供的最重要的选项子集，为熟悉Docker的图像作者带来了无缝体验。用img建立一个形象，可以简单到用' Img '代替' docker '。</p><p id="42ae" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在这方面，Img类似于Podman ( <a class="ae kw" href="https://blog.giantswarm.io/building-container-images-with-podman-and-buildah/" rel="noopener ugc nofollow" target="_blank">，我们在上一篇文章</a>中讨论过它)，但是它局限于构建映像的任务，而Podman可以用于构建映像、运行容器等等。</p><h1 id="691a" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">构建状态</h1><p id="bd71" class="pw-post-body-paragraph jy jz iq ka b kb lv kd ke kf lw kh ki kj lx kl km kn ly kp kq kr lz kt ku kv ij bi translated">使用Docker守护进程构建其图像的容器图像作者不再需要负责确定在本地何处存储图像数据；它由Docker守护进程处理。如果没有守护进程来管理存储，就像Img的情况一样，责任就落在了图像作者身上。Img将图像数据存储在名为<code class="fe ma mb mc md b">img</code>的目录中，该目录位于为用户设置的<code class="fe ma mb mc md b">XDG_DATA_HOME</code>变量的值下，如果未设置<code class="fe ma mb mc md b">XDG_DATA_HOME</code>则为<code class="fe ma mb mc md b">$HOME/.local/share</code>，如果未设置<code class="fe ma mb mc md b">XDG_DATA_HOME</code>或<code class="fe ma mb mc md b">HOME</code>变量则为<code class="fe ma mb mc md b">/tmp</code>。位置是可配置的，但是要记住的一点是，如果Img是以容器化的方式运行的，那么“state”目录需要作为一个卷提供给容器。通过使用卷，构建的映像和构建缓存可用于Img的后续调用。</p><h1 id="72a4" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">无根建筑</h1><p id="9763" class="pw-post-body-paragraph jy jz iq ka b kb lv kd ke kf lw kh ki kj lx kl km kn ly kp kq kr lz kt ku kv ij bi translated">作为非特权用户构建映像是Img的主要目标，因此需要为各种上游项目制作大量与安全相关的补丁。其中包括在容器中运行无根构建的Docker和在pod中运行无根构建的Kubernetes。</p><p id="4f5d" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">Img利用用户名称空间来实现无根构建特性，并且在使用<a class="ae kw" href="https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/tree/Documentation/filesystems/overlayfs.txt" rel="noopener ugc nofollow" target="_blank"> overlayfs </a>(除了在Ubuntu发行版中)时，受到当前缺乏对非特权用户名称空间中挂载的支持的共同限制。Overlayfs通常是组装容器文件系统的首选union mount方法，如果没有它对非特权用户名称空间的支持，Img就不得不依靠复制文件，这是非常低效和缓慢的。</p><p id="6a6d" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">尽管有这样的限制，Img还是实现了提供无根构建的目标，同时利用了BuildKit提供的一些高级构建特性。</p><h1 id="e149" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">构建工具包</h1><p id="c351" class="pw-post-body-paragraph jy jz iq ka b kb lv kd ke kf lw kh ki kj lx kl km kn ly kp kq kr lz kt ku kv ij bi translated">BuildKit可能被一些人描述为容器映像的下一代构建引擎，并且可以被认为是构建过程中的“后端”组件。我们将在以后的文章中发现，它被合并到Docker引擎的最新版本中，但它是一个独立的项目，可以独立于Docker使用。Img证明了这一事实，但它不是利用BuildKit的唯一技术。事实上，BuildKit是技术不可知的，可以用于执行任何领域的构建步骤，这些步骤可以使用“前端”来表示，前端将这些步骤转换为BuildKit的内部表示。那么，BuildKit有什么特别之处呢？有许多创新的特性，但这里有几个是Img利用的。</p><h1 id="f9a8" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">并行构建执行</h1><p id="9b0c" class="pw-post-body-paragraph jy jz iq ka b kb lv kd ke kf lw kh ki kj lx kl km kn ly kp kq kr lz kt ku kv ij bi translated">莫比项目在17.05版本的Docker引擎中引入了<a class="ae kw" href="https://docs.docker.com/develop/develop-images/multistage-build/" rel="noopener ugc nofollow" target="_blank">多阶段构建</a>，允许将映像构建分离到单独的逻辑阶段中。多阶段构建对图像作者来说是一个巨大的好处，但是Docker守护进程中遗留构建引擎中构建步骤的执行顺序性意味着不相关的构建阶段不能从它们独立构建步骤的并行执行中获益。BuildKit来救援了！</p><figure class="mf mg mh mi gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi me"><img src="../Images/57efd0bb19b278b9fe4eeb82856877ac.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*taVKweekLMuMZ2aY.png"/></div></div></figure><p id="1e71" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">BuildKit将构建步骤的内部表示组装成一个<a class="ae kw" href="https://en.wikipedia.org/wiki/Directed_acyclic_graph" rel="noopener ugc nofollow" target="_blank">有向无环图</a> (DAG)，这使得它能够确定哪些构建步骤可以并行执行。对于包含许多构建阶段的docker文件，这可以显著减少构建完成的时间长度。对于Img采用者来说，这是一个重要的优势，不需要图像作者的任何知识或配置。</p><h1 id="a08d" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">跨平台/操作系统版本</h1><p id="716c" class="pw-post-body-paragraph jy jz iq ka b kb lv kd ke kf lw kh ki kj lx kl km kn ly kp kq kr lz kt ku kv ij bi translated">Img通过其用户界面公开了另一个BuildKit特性；跨平台和跨操作系统版本。虽然在使用该特性时有一些额外的考虑事项要考虑，但是可以在完全不同的平台上为不同的架构和操作系统组合构建映像。例如，linux/amd64平台可用于构建适合linux/arm64的映像。Img使用<code class="fe ma mb mc md b">--platform</code>标志来公开这个特性。</p><h1 id="ced4" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">Img和Kubernetes</h1><p id="8a35" class="pw-post-body-paragraph jy jz iq ka b kb lv kd ke kf lw kh ki kj lx kl km kn ly kp kq kr lz kt ku kv ij bi translated">在Kubernetes上安全地构建映像的目标为Img提供了最初的动力，并且一个<a class="ae kw" href="https://r.j3ss.co/repo/img/tags" rel="noopener ugc nofollow" target="_blank">容器映像</a>可用于在Kubernetes pod中运行构建。图像的docker文件也可用于审查，并可用作创建定制图像的基础，以考虑备选偏好或约束。</p><p id="fa57" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">图像中提供的关键成分是:</p><ul class=""><li id="4d84" class="mj mk iq ka b kb kc kf kg kj ml kn mm kr mn kv mo mp mq mr bi translated">创建运行构建的非特权用户，</li><li id="a7a6" class="mj mk iq ka b kb ms kf mt kj mu kn mv kr mw kv mo mp mq mr bi translated">为非特权用户定义用户命名空间映射的从属uid/gid文件，以及</li><li id="ca32" class="mj mk iq ka b kb ms kf mt kj mu kn mv kr mw kv mo mp mq mr bi translated">用于为用户名称空间执行映射的<code class="fe ma mb mc md b">newuidmap</code>和<code class="fe ma mb mc md b">newgidmap</code>二进制文件，这些名称空间是在每次为构建步骤运行容器时创建的。</li></ul><p id="b979" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">使用Img在Kubernetes上运行无根构建时，有许多不同的层在起作用。构建步骤在嵌套在Img容器中的BuildKit工作容器中执行。Img容器很可能在Docker容器运行时下运行(或者可能只是<a class="ae kw" href="https://containerd.io/" rel="noopener ugc nofollow" target="_blank"> containerd </a>)，全部由Kubernetes <a class="ae kw" href="https://github.com/kubernetes/community/blob/master/contributors/devel/sig-node/container-runtime-interface.md" rel="noopener ugc nofollow" target="_blank">容器运行时接口</a> (CRI)管理。安全地消除各层特权执行的约束是一项重要的任务，因此仍然存在一些限制也就不足为奇了。</p><p id="cf76" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">目前，<a class="ae kw" href="https://kubernetes.io/docs/tutorials/clusters/apparmor/" rel="noopener ugc nofollow" target="_blank"> AppArmor </a>和<a class="ae kw" href="https://kubernetes.io/docs/concepts/policy/pod-security-policy/#seccomp" rel="noopener ugc nofollow" target="_blank"> Seccomp </a>概要文件不能应用于Img pods来执行无根构建，尽管worker容器仍然可以使用这些安全措施来保护。pod中的Img容器也需要“无屏蔽”地访问其<code class="fe ma mb mc md b">/proc</code>文件系统，对于从1.12开始的Kubernetes版本，这可以通过使用pod安全特性<code class="fe ma mb mc md b">securityContext.procMount</code>来实现。这需要设置为<code class="fe ma mb mc md b">Unmasked</code>。</p><p id="ff7f" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在Kubernetes上使用Img构建容器映像的最后一个实际需求是，Img pods可以访问不断发展的构建状态。这样，单独调用Img就可以利用本地存储中构建的图像和缓存层。例如，构建的映像可能需要作为CI/CD工作流的一部分推送到注册表，并且构建迭代肯定会从重用存储在缓存中的先前构建的层中受益。使用Kubernetes(持久)卷抽象，可以使构建状态对Img pods可用。</p><h1 id="8cce" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">结论</h1><p id="ce68" class="pw-post-body-paragraph jy jz iq ka b kb lv kd ke kf lw kh ki kj lx kl km kn ly kp kq kr lz kt ku kv ij bi translated">很难判断Img有多普遍，或者它会有多成功，因为它不像许多开源项目那样得到既得利益公司的支持。然而，它确实有一个活跃的社区，而且该项目在打破运行无根容器的障碍方面发挥了重要作用。为此，它赢得了很多荣誉。</p><p id="e828" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">Img使用的构建引擎BuildKit有很多有趣的特性，这些特性是Img目前没有公开的。如果这些额外的特性及时进入Img的用户界面，它将成为容器映像构建的更好前景——特别是对于Kubernetes环境中的无根构建。</p><p id="96ff" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">您是否希望将Kubernetes容器投入生产？<a class="ae kw" href="https://www.giantswarm.io/contact" rel="noopener ugc nofollow" target="_blank">联系Giant Swarm </a>开始您的云原生之旅</p><p id="2730" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">由<a class="ae kw" href="https://twitter.com/puja108" rel="noopener ugc nofollow" target="_blank">Puja Abbas si</a>——开发者倡议@ <a class="ae kw" href="https://giantswarm.io/" rel="noopener ugc nofollow" target="_blank">巨型虫群</a>撰写</p><div class="mx my gp gr mz na"><a href="https://twitter.com/puja108" rel="noopener  ugc nofollow" target="_blank"><div class="nb ab fo"><div class="nc ab nd cl cj ne"><h2 class="bd ir gy z fp nf fr fs ng fu fw ip bi translated">Puja Abbassi @ #KubeCon #KubeKhan</h2><div class="nh l"><h3 class="bd b gy z fp nf fr fs ng fu fw dk translated">Puja Abbassi的最新推文@ #KubeCon #KubeKhan (@puja108)。开发者关系和产品@GiantSwarm…</h3></div><div class="ni l"><p class="bd b dl z fp nf fr fs ng fu fw dk translated">twitter.com</p></div></div><div class="nj l"><div class="nk l nl nm nn nj no jw na"/></div></div></a></div></div></div>    
</body>
</html>