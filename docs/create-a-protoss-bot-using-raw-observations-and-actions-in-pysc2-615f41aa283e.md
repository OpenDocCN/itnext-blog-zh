# 使用 PySC2 中的原始观察和动作创建一个神族机器人

> 原文：<https://itnext.io/create-a-protoss-bot-using-raw-observations-and-actions-in-pysc2-615f41aa283e?source=collection_archive---------0----------------------->

回到 1 月份，我们看到 DeepMind 宣布了 AlphaStar，这是一个在《星际争霸 2》中使用强化学习击败人类玩家的机器人。AlphaStar 利用的关键变化之一是一组新功能，使机器人能够一次观察整个地图，称为原始观察，并在地图上的任何地方采取行动，而不必先移动屏幕，称为原始行动。

以这种方式观察和行动可以开启一系列全新的可能性，同时也带来一些新的挑战。最重要的是，任何现有的机器人都不能立即使用新功能，需要从头开始训练。在本教程中，我们将探索如何实现这些新工具，以便您可以将它们应用到自己的机器人。

本教程假设你熟悉我的[之前的教程](https://medium.com/skjb/build-a-zerg-bot-with-pysc2-2-0-295375d2f58e)中的 PySC2。

*注意:原始观察和行动的开发仍在进行中，因此有些东西可能不工作或可能会改变。虽然本教程可以在任何平台上工作，但为了充分利用原始动作，你应该使用 Linux 版本的星际争霸 2，并更新文件*[*stableid . JSON*](https://raw.githubusercontent.com/Blizzard/s2client-proto/master/stableid.json)*，否则有些动作，如移动，将无法工作。*

# 1.安装 PySC2 的“dev”分支

新特性只在 PySC2 Git 存储库的“dev”分支上可用。首先，您应该克隆 PySC2 存储库:

```
git clone https://github.com/deepmind/pysc2.git
```

接下来，切换到 dev 分支:

```
git checkout -t origin/dev
```

现在从以下位置安装 PySC2:

```
pip install -e .
```

您可能需要使用`--force-reinstall`进行安装，以确保所有依赖项都已更新。

# 2.创建基本代理

首先让我们添加导入:

接下来，我们可以创建一个真正基本的代理:

你已经在使用原始动作了！这可能只是一个没有行动，但它仍然很酷。

现在让我们添加运行一切的代码:

动作空间设置为`RAW`，这将启用原始动作，而不是常规屏幕和小地图动作。

观察空间被设置为 raw，这与`use_feature_units`非常相似，除了它为每个单元启用了更多的属性，并且单元的 *x* 和 *y* 坐标在世界空间中表示。

我们将原始分辨率从世界空间转换为 64，与特征空间中的默认小地图分辨率相同，如果您正在转换旧代码，这将非常方便。

如果您现在运行此代码，它将什么也不做，您的代理最终会失败。

```
python raw_agent.py
```

此步骤的代码可在[这里](https://github.com/skjb/pysc2-tutorial/blob/master/Build%20a%20Raw%20Protoss%20Agent/raw_agent_step2.py)获得。

# 3.确定基本位置

在我们建造狂热者之前，我们需要建造一个入口，它需要一个尖塔。在我们建造一个塔之前，我们需要知道我们的基地是在左上角，还是在右下角。让我们添加一个属性来跟踪它:

接下来，我们可以添加一个实用程序方法来帮助我们找到我们拥有的给定类型的原始单元:

注意我们在这里是如何使用`obs.observation.raw_units`的，就像我们在之前的教程中使用`obs.observation.feature_units`一样。

默认情况下，原始单位包括敌人和中立单位，比如矿点，所以我们通过`unit.alliance`过滤以确保单位属于我们，通过`unit.unit_type`过滤以确保我们只得到特定类型的单位。

现在在`step()`方法中，让我们根据连接点的位置来确定基本位置:

由于地图坐标被限制为 64x64，并且我们使用的是 Simple64 地图，任何从 0–31 的 x 坐标都意味着连接点在左侧，并且由于左侧唯一的产卵位置在顶部，我们可以假设底部在左上角。32-63 之间的任何值都意味着底部在右下方。

这一步的代码可在[这里](https://github.com/skjb/pysc2-tutorial/blob/master/Build%20a%20Raw%20Protoss%20Agent/raw_agent_step3.py)获得。

# 4.建造一座铁塔

太好了，我们知道我们的基地在哪里，所以让我们用一个探针来建造一个塔。raw actions 最棒的一点是我们不需要选择单元，我们可以简单地通过使用单元的标签来指示一个单元执行一个动作。标签是游戏中单位实例的唯一标识符，所以每个单位都有不同的标识符。

因为我们只想在没有的情况下建造一个尖塔，所以让我们检查一下我们是否有一个尖塔，以及我们是否有足够的矿石来建造一个尖塔:

现在让我们拿起所有的探针:

请注意我们是如何检查是否有任何探针的——这将防止在敌人已经杀死所有探针并且没有探针可用的情况下崩溃。

接下来，我们根据基础位置在世界空间(比例为 64x64)中选择塔架建造位置:

现在，为了简单起见，我们希望使用离塔架建造位置最近的探头，我们通过计算每个探头到建造位置的距离来实现。为此，我们需要向类中添加一个新方法:

然后我们用我们的探测器列表和构建位置调用这个方法:

然后，我们提取距离最短的探针:

最后，我们告诉探测器构建塔架:

如果您以前使用过常规操作，这最后一行看起来会很熟悉，但是还是有一些细微的差别。如你所见，我们使用了`RAW_FUNCTIONS`，它通常有“点”、“单位”、“自动预测”和“快速”格式。

第一个参数确定命令是立即执行，还是与现有命令一起排队。第二个参数是单元的标签。第三个参数是包含 *x* 和 *y* 坐标的列表或元组。

需要注意的一点是，你不需要检查动作是否可用，如果不可用，你的动作将被忽略。

如果你运行代码，你的探测器应该建立一个塔架。

此步骤的代码可在[这里](https://github.com/skjb/pysc2-tutorial/blob/master/Build%20a%20Raw%20Protoss%20Agent/raw_agent_step4.py)获得。

# 5.建立一个网关

现在我们有一个塔，我们可以建立一个网关，代码非常相似。首先，我们要检查已完成的挂架，因此我们需要添加另一个实用方法:

然后，我们可以使用这种方法来获得已完成的塔架列表:

然后，我们需要获得任何现有的网关:

接下来，我们要检查一切，并得到我们的探针:

接下来，我们确定网关构建位置:

然后我们可以再次计算距离，找到最近的探测器(应该是同一个)，并告诉它建立网关:

运行代码，观看光荣之门建设！

这一步的代码可在[这里](https://github.com/skjb/pysc2-tutorial/blob/master/Build%20a%20Raw%20Protoss%20Agent/raw_agent_step5.py)获得。

# 6.训练一些狂热者

太棒了，我们有了一个塔，我们有了一个入口，现在我们只需要一支军队。

让我们来看看完整的网关:

接下来我们可以计算免费供应:

在我们制造狂热者之前，我们需要确保我们拥有我们需要的一切:

接下来，获取网关:

原始单元的一个很酷的特性是我们可以看到每个单元的“订单”数量，在这种情况下，订单长度代表网关的构建队列。由于网关一次只能训练五个狂热者，我们可以在发出动作前检查:

当你运行这个代码时，你的网关将训练四个狂热者，如果敌人靠近，他们将积极保卫你的基地。

此步骤的代码可在[这里](https://github.com/skjb/pysc2-tutorial/blob/master/Build%20a%20Raw%20Protoss%20Agent/raw_agent_step6.py)获得。

# 7.进攻！

酷，我们有狂热者，现在我们需要攻击。

类似于之前，我们可以得到我们所有的狂热者:

现在，我们只想在我们集结了一支小规模的军队，基本上是在我们耗尽了我们的免费供应之后，发动进攻:

接下来我们根据我们的基地位置选择攻击坐标:

此时你通常会选择陆军，对吗？你不需要选择军队，但是你有所有狂热者的标签。理想情况下，你可以创建一个狂热者标签列表，供行动使用，但是目前 PySC2 中有一个 bug，只允许你一次控制一个单位。哭丧着脸。

当我的[拉动请求](https://github.com/deepmind/pysc2/pull/266)等待批准时，我们将尝试另一种方法。首先我们计算每个狂热者到攻击地点的距离:

然后我们选择最远的狂热者:

注意，我们在这里使用`np.argmax`来选择最远的，而不是我们之前用来寻找最近的`np.argmin`。

现在我们想让狂热者稍微搜索一下敌人的基地位置，所以我们随机选择一个离`attack_xy`4 点以内的位置，命令狂热者攻击:

当你运行你的代码时，你的狂热者会攻击，而且几乎每次都会赢。

完整的代码可在[这里](https://github.com/skjb/pysc2-tutorial/blob/master/Build%20a%20Raw%20Protoss%20Agent/raw_agent_step7.py)获得。

如果你喜欢这个教程，请在 [Patreon](https://www.patreon.com/skjb) 上支持我。也请和我一起上 [Discord](https://discord.gg/zXHU4wM) ，或者关注我上 [Twitch](https://www.twitch.tv/skjb) 、 [Medium](https://medium.com/@skjb) 、 [GitHub](https://github.com/skjb) 、 [Twitter](https://twitter.com/theskjb) 和 [YouTube](https://www.youtube.com/channel/UCZcEvhpV4_6llcrWrWQ2wsg) 。