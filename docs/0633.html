<html>
<head>
<title>Rails background workers: Sidekiq overview and how to deploy it to Heroku</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Rails后台工作者:Sidekiq概述以及如何将其部署到Heroku</h1>
<blockquote>原文：<a href="https://itnext.io/sidekiq-overview-and-how-to-deploy-it-to-heroku-b8811fea9347?source=collection_archive---------0-----------------------#2018-04-23">https://itnext.io/sidekiq-overview-and-how-to-deploy-it-to-heroku-b8811fea9347?source=collection_archive---------0-----------------------#2018-04-23</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><figure class="gl gn jr js jt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi jq"><img src="../Images/fdda128c0d99c5b17a5d20bac69e0d9e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*VPwJk4g9GgzUvKdLZpN-rQ.png"/></div></div></figure><p id="96df" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">Sidekiq是一个后台作业处理框架，对于处理昂贵的计算、电子邮件和其他在主web应用程序之外更好服务的进程非常有用。</p><p id="20ca" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">在这篇博文中，我使用了一个解析大型口袋妖怪数据库的古怪例子来解释Sidekiq的必要性、Sidekiq的工作流程、如何实现/利用Sidekiq，以及如何将Sidekiq部署到Heroku。</p><h1 id="5dd7" class="kz la it bd lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw bi translated">一个关于何时需要Sidekiq的人为但有用的例子</h1><p id="1fcf" class="pw-post-body-paragraph kb kc it kd b ke lx kg kh ki ly kk kl km lz ko kp kq ma ks kt ku mb kw kx ky im bi translated">你可以在这里下载这个pokedex回购<a class="ae mc" href="https://github.com/kevinYCKim33/pokedex" rel="noopener ugc nofollow" target="_blank">，或者在这里</a>使用部署的应用<a class="ae mc" href="https://pokedex-sidekiq.herokuapp.com/pokemons" rel="noopener ugc nofollow" target="_blank">，随意跟随这个指南。</a></p><p id="32ac" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">假设您发现了一个很棒的<a class="ae mc" href="https://github.com/veekun/pokedex/blob/master/pokedex/data/csv/pokemon.csv" rel="noopener ugc nofollow" target="_blank"> CSV文件，其中列出了所有807个口袋妖怪</a>，您想要创建一个Rails应用程序，您只需按一个按钮，它就会创建一个<code class="fe md me mf mg b">Pokemon</code>类的807个实例，并以如下表格格式显示它们:</p><figure class="mi mj mk ml gt ju gh gi paragraph-image"><div class="gh gi mh"><img src="../Images/3ecdc63bfd36a5de66866f4226be41f5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1146/format:webp/1*PVnt_c1x_EUoHagZS76TwA.png"/></div></figure><p id="aef1" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">所以现在你可能想在你的<code class="fe md me mf mg b">PokemonsController</code>中写一些类似的东西</p><pre class="mi mj mk ml gt mm mg mn mo aw mp bi"><span id="866f" class="mq la it mg b gy mr ms l mt mu">#app/controllers/pokemons_controller.rb</span><span id="c348" class="mq la it mg b gy mv ms l mt mu">class PokemonsController &lt; ApplicationController<br/>  require 'csv'</span><span id="d86e" class="mq la it mg b gy mv ms l mt mu">  def index<br/>    <a class="ae mc" href="http://twitter.com/pokemons" rel="noopener ugc nofollow" target="_blank">@pokemons</a> = Pokemon.all<br/>  end</span><span id="db17" class="mq la it mg b gy mv ms l mt mu">  def upload<br/>    csv_path = File.join Rails.root, 'db', 'pokemon.csv'<br/>    CSV.foreach((csv_path), headers: true) do |pokemon|<br/>      Pokemon.create(<br/>        pokedex_id: pokemon[0],<br/>        name: pokemon[1],<br/>        height: pokemon[3],<br/>        weight: pokemon[4])<br/>    end<br/>    flash[:notice] = "All 807 Pokemons added to db."<br/>    redirect_to pokemons_path<br/>  end</span><span id="58fa" class="mq la it mg b gy mv ms l mt mu">  def destroy_all<br/>    Pokemon.destroy_all<br/>    flash[:notice] = "All 807 Pokemons deleted from db."<br/>    redirect_to pokemons_path<br/>  end</span><span id="cd7a" class="mq la it mg b gy mv ms l mt mu">end</span></pre><p id="e775" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">虽然这段代码是功能性的，但一旦用户点击“导入口袋妖怪”或“删除口袋妖怪”按钮，它将锁定浏览器，直到每个口袋妖怪的807个实例都被创建或删除，因为它现在在与请求/响应相同的线程中处理相同的解析/创建/删除动作。</p><p id="4ab0" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">这在开发模式下很烦人，但是假设这种情况发生在你部署的Heroku应用上，你甚至可能会得到这样的结果:</p><figure class="mi mj mk ml gt ju gh gi paragraph-image"><div class="gh gi mw"><img src="../Images/47630fb7e337e453119977b37e2fd741.png" data-original-src="https://miro.medium.com/v2/resize:fit:1376/format:webp/1*Vv5Yl4qPSRgsbT4fJjbeqw.jpeg"/></div></figure><p id="a35c" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">这就是Sidekiq的用武之地。不要让主web应用程序线程处理Pokemons的创建/删除，您可以将这个乏味且消耗内存的任务交给您可信赖的Sidekiq——一个后台工作程序，允许您在主web应用程序线程之外执行任务。为了直观起见，请使用这张漂亮的图表:</p><figure class="mi mj mk ml gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi mx"><img src="../Images/5c80b48a9ae36591fba8069ad6a4c1e2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*3MbeS1FWXjclQwcJK5et_A.jpeg"/></div></div><figcaption class="my mz gj gh gi na nb bd b be z dk translated">由<a class="ae mc" href="https://www.youtube.com/watch?v=GBEDvF1_8B8" rel="noopener ugc nofollow" target="_blank">https://www.youtube.com/watch?v=GBEDvF1_8B8</a>提供</figcaption></figure><p id="876b" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">控制器不是将所有口袋妖怪的创建/删除交给口袋妖怪模型类，然后将结果发送回web服务器并显示在计算机屏幕上，这里的目标是将此任务委托给Redis队列(稍后将详细介绍),并让Sidekiq处理这些任务，同时web应用程序线程温和地让用户知道当前正在创建/删除所有口袋妖怪。</p><h2 id="9dd1" class="mq la it bd lb nc nd dn lf ne nf dp lj km ng nh ln kq ni nj lr ku nk nl lv nm bi translated">设置</h2><p id="65a3" class="pw-post-body-paragraph kb kc it kd b ke lx kg kh ki ly kk kl km lz ko kp kq ma ks kt ku mb kw kx ky im bi translated">首先，将Sidekiq添加到<code class="fe md me mf mg b">Gemfile</code>和<code class="fe md me mf mg b">bundle</code></p><pre class="mi mj mk ml gt mm mg mn mo aw mp bi"><span id="e8c6" class="mq la it mg b gy mr ms l mt mu">gem 'sidekiq'</span></pre><p id="7b79" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">Sidekiq依赖于<a class="ae mc" href="https://redis.io/topics/introduction" rel="noopener ugc nofollow" target="_blank">Redis</a>——一个数据库存储，在这种情况下，它将被用来将口袋妖怪创建/删除作业保存在队列中。要在本地安装，请键入Terminal:</p><pre class="mi mj mk ml gt mm mg mn mo aw mp bi"><span id="042c" class="mq la it mg b gy mr ms l mt mu">brew install redis</span></pre><h2 id="1f53" class="mq la it bd lb nc nd dn lf ne nf dp lj km ng nh ln kq ni nj lr ku nk nl lv nm bi translated">重构我们的口袋妖怪代码以利用Sidekiq</h2><p id="5248" class="pw-post-body-paragraph kb kc it kd b ke lx kg kh ki ly kk kl km lz ko kp kq ma ks kt ku mb kw kx ky im bi translated">在我们的Sidekiq gem安装后，你现在可以创建几个Worker类来处理口袋妖怪的添加和删除，如下所示:</p><pre class="mi mj mk ml gt mm mg mn mo aw mp bi"><span id="4558" class="mq la it mg b gy mr ms l mt mu">#app/workers/pokemon_worker.rb</span><span id="0096" class="mq la it mg b gy mv ms l mt mu">class PokemonAddWorker<br/>  include Sidekiq::Worker<br/>  sidekiq_options retry: false</span><span id="23b9" class="mq la it mg b gy mv ms l mt mu">  require 'csv'</span><span id="0ff8" class="mq la it mg b gy mv ms l mt mu">  def perform(csv_path)<br/>    CSV.foreach((csv_path), headers: true) do |pokemon|<br/>      Pokemon.create(<br/>        pokedex_id: pokemon[0],<br/>        name: pokemon[1],<br/>        height: pokemon[3],<br/>        weight: pokemon[4]<br/>      )<br/>    end<br/>  end<br/>end</span><span id="8720" class="mq la it mg b gy mv ms l mt mu">class PokemonRemoveWorker<br/>  include Sidekiq::Worker<br/>  sidekiq_options retry: false</span><span id="092c" class="mq la it mg b gy mv ms l mt mu">  def perform<br/>    Pokemon.destroy_all<br/>  end<br/>end</span></pre><p id="12a2" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">正如你在上面看到的，要将一个普通的Ruby类转换成Sidekiq Worker类，你只需要在类声明下面添加行<code class="fe md me mf mg b">include Sidekiq::Worker</code>。</p><p id="2029" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">此外，默认情况下，Sidekiq将继续重试失败的方法。有些情况下这并不理想，比如涉及信用卡的时候。如果是这样，您可以像上面的代码一样通过添加<code class="fe md me mf mg b">sidekiq_options retry:false</code>来关闭它</p><p id="d3d3" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">添加完这些代码行后，再添加一个<code class="fe md me mf mg b">#perform</code>方法，现在你可以在这个方法中加入任何你不想成为主web应用程序瓶颈的任务。</p><p id="f8cb" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">现在您只需要通过调用这些Worker方法来重构<code class="fe md me mf mg b">PokemonsController.rb</code>。</p><pre class="mi mj mk ml gt mm mg mn mo aw mp bi"><span id="5c7c" class="mq la it mg b gy mr ms l mt mu">#app/controllers/pokemons_controller.rb</span><span id="d9e1" class="mq la it mg b gy mv ms l mt mu">class PokemonsController &lt; ApplicationController</span><span id="3b13" class="mq la it mg b gy mv ms l mt mu">  def index<br/>    <a class="ae mc" href="http://twitter.com/pokemons" rel="noopener ugc nofollow" target="_blank">@pokemons</a> = Pokemon.all<br/>  end</span><span id="7ad9" class="mq la it mg b gy mv ms l mt mu">  def upload<br/>    csv_path = File.join Rails.root, 'db', 'pokemon.csv'<br/>    PokemonAddWorker.perform_async(csv_path)<br/>    flash[:notice] = "Pokemons getting added to db"<br/>    redirect_to pokemons_path<br/>  end</span><span id="c00e" class="mq la it mg b gy mv ms l mt mu">  def destroy_all<br/>    PokemonRemoveWorker.perform_async<br/>    flash[:notice] = "Pokemons getting removed from db"<br/>    redirect_to pokemons_path<br/>  end</span><span id="26aa" class="mq la it mg b gy mv ms l mt mu">end</span></pre><p id="07b0" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">注意，工人方法是通过写出<code class="fe md me mf mg b">NameOfWorkerClass.perform_async(args)</code>来执行的</p><h2 id="7345" class="mq la it bd lb nc nd dn lf ne nf dp lj km ng nh ln kq ni nj lr ku nk nl lv nm bi translated">执行一切(至少在本地)</h2><p id="8df4" class="pw-post-body-paragraph kb kc it kd b ke lx kg kh ki ly kk kl km lz ko kp kq ma ks kt ku mb kw kx ky im bi translated">为此，您需要打开“终端”的三个标签:</p><p id="f5d5" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">选项卡1:通过键入<code class="fe md me mf mg b">redis-server</code>启动redis服务器</p><p id="c6bd" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">标签2:通过输入<code class="fe md me mf mg b">bundle exec sidekiq</code>激活你的Sidekiq</p><p id="8cd0" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">第3页:输入<code class="fe md me mf mg b">rails s</code>，启动你真正的Rails应用</p><p id="db95" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">如果你进入浏览器中的<code class="fe md me mf mg b">localhost:3000</code>，你将能够看到你的Sidekiq正在工作，并且在导入或删除你的口袋妖怪数据库时没有锁定你的主浏览器。</p><figure class="mi mj mk ml gt ju"><div class="bz fp l di"><div class="nn no l"/></div><figcaption class="my mz gj gh gi na nb bd b be z dk translated">Sidekiq让我们不断刷新页面，看看有多少口袋妖怪被创造出来，而不是锁定屏幕，直到大约800个口袋妖怪被载入数据库。</figcaption></figure><h1 id="3642" class="kz la it bd lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw bi translated">将Sidekiq部署到Heroku</h1><p id="5a63" class="pw-post-body-paragraph kb kc it kd b ke lx kg kh ki ly kk kl km lz ko kp kq ma ks kt ku mb kw kx ky im bi translated">所以你现在可能想知道:“我不能在Heroku cloud和<code class="fe md me mf mg b">brew install redis server</code>和<code class="fe md me mf mg b">redis-server</code>和<code class="fe md me mf mg b">bundle exec sidekiq</code>中打开几个终端，对吗？对吗？？</p><p id="0506" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">幸运的是，Heroku使这一切变得非常简单。</p><h2 id="556d" class="mq la it bd lb nc nd dn lf ne nf dp lj km ng nh ln kq ni nj lr ku nk nl lv nm bi translated"><strong class="ak">把Redis拿到Heroku </strong></h2><p id="403f" class="pw-post-body-paragraph kb kc it kd b ke lx kg kh ki ly kk kl km lz ko kp kq ma ks kt ku mb kw kx ky im bi translated">一旦主Rails应用程序被部署到Heroku，登录到你的Heroku帐户，然后转到应用程序的仪表板，点击<em class="np">资源</em>选项卡。</p><p id="c60d" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">向下滚动到<em class="np">附加组件</em>部分，搜索<em class="np"> Redis To Go，</em>并安装其免费版本。最后，它应该看起来像这样:</p><figure class="mi mj mk ml gt ju gh gi paragraph-image"><div class="gh gi nq"><img src="../Images/f4d2a1f94cd51e38ebeb9090ac518273.png" data-original-src="https://miro.medium.com/v2/resize:fit:988/format:webp/1*jb8sfMOI6AFDE0WClnCMQg.png"/></div></figure><p id="5e80" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">现在转到Heroku应用仪表板上的<em class="np">设置</em>选项卡，点击<em class="np">显示配置变量</em>。在列表的末尾分别添加一个键值对REDIS_PROVIDER和REDISTOGO_URL。如果操作正确，应该是这样的:</p><figure class="mi mj mk ml gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi nr"><img src="../Images/56c33e505f6d7677fc7a97878318068b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*pE4-jO-I9BacPtviRk5FLg.png"/></div></div></figure><p id="1593" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">这又是相当于<code class="fe md me mf mg b">brew install redis</code>和<code class="fe md me mf mg b">redis-server</code>的本地环境</p><h2 id="cb5e" class="mq la it bd lb nc nd dn lf ne nf dp lj km ng nh ln kq ni nj lr ku nk nl lv nm bi translated">把Sidekiq带到Heroku</h2><p id="43a8" class="pw-post-body-paragraph kb kc it kd b ke lx kg kh ki ly kk kl km lz ko kp kq ma ks kt ku mb kw kx ky im bi translated">如果你还没有，在你的Rails应用的根目录下创建一个<code class="fe md me mf mg b">Procfile</code>。</p><p id="b62b" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">如果你想知道<code class="fe md me mf mg b">Procfile</code>实际上是什么，直接从Heroku文档:</p><blockquote class="ns nt nu"><p id="cc95" class="kb kc np kd b ke kf kg kh ki kj kk kl nv kn ko kp nw kr ks kt nx kv kw kx ky im bi translated">Procfile是一种机制，用于声明Heroku平台上应用程序的<a class="ae mc" href="https://devcenter.heroku.com/articles/dynos" rel="noopener ugc nofollow" target="_blank"> dynos </a>运行哪些命令。它遵循<a class="ae mc" href="https://devcenter.heroku.com/articles/process-model" rel="noopener ugc nofollow" target="_blank">流程模型</a>。您可以使用Procfile来声明各种流程类型，例如您的web服务器、多种类型的工作器、像<a class="ae mc" href="https://devcenter.heroku.com/articles/scheduled-jobs-custom-clock-processes" rel="noopener ugc nofollow" target="_blank">时钟</a>这样的单一流程，或者您希望在将新版本部署到生产环境之前运行的<a class="ae mc" href="https://devcenter.heroku.com/articles/release-phase" rel="noopener ugc nofollow" target="_blank">任务</a>。</p></blockquote><p id="d5fd" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">如果您曾经在没有Procfile的情况下将Rails应用程序部署到Heroku，您可能会注意到日志中有一条警告，指出没有检测到Procfile，并且应用程序的默认值被设置为:</p><pre class="mi mj mk ml gt mm mg mn mo aw mp bi"><span id="6050" class="mq la it mg b gy mr ms l mt mu">web: <!-- -->bin/rails server -p $PORT -e $RAILS_ENV</span></pre><p id="a79d" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">这只是Heroku真的很好，但它还不足以让人感觉到你在使用Sidekiq并为你添加适当的Procfile命令。</p><p id="5e87" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">相反，进入你的<code class="fe md me mf mg b">Procfile</code>，输入:</p><pre class="mi mj mk ml gt mm mg mn mo aw mp bi"><span id="4028" class="mq la it mg b gy mr ms l mt mu">pokemonworker: bundle exec sidekiq -c 2</span></pre><p id="703a" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated"><strong class="kd iu"> <em class="np">批判搁置在-c 2旗帜上</em> </strong></p><p id="3638" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">Sidekiq以能够并发运行多个线程而自豪(在-c 2标志中“c”代表什么)。这类似于左边这个了不起的家伙在一场街机篮球比赛中大获全胜:</p><figure class="mi mj mk ml gt ju gh gi paragraph-image"><div class="gh gi ny"><img src="../Images/3e10afa4cfe0ded08a294ffecaf09899.png" data-original-src="https://miro.medium.com/v2/resize:fit:1270/1*NUyTqf8JvffB018e7919tQ.gif"/></div><figcaption class="my mz gj gh gi na nb bd b be z dk translated">左边的家伙:bundle exec sidekiq-C2；右边的人:捆绑销售高管sidekiq -c 1</figcaption></figure><p id="2a93" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">默认情况下，<em class="np"> </em> <code class="fe md me mf mg b"><em class="np">bundle exec sidekiq</em></code> <em class="np"> </em>将实际上并发运行<strong class="kd iu"> 25个</strong>线程，但这是一个很大的线程，我们在Redis To的<em class="np">免费</em>版本的基础上使用Heroku的<em class="np">免费</em>版本。所以为了避免任何Heroku日志看起来像这样:</p><pre class="mi mj mk ml gt mm mg mn mo aw mp bi"><span id="05dd" class="mq la it mg b gy mr ms l mt mu"><strong class="mg iu">2018-04-23T07:12:09.453785+00:00 app[pokemonworker.1]:</strong> 4 TID-qkxr8 WARN: Redis::CommandError: ERR max number of clients reached</span></pre><p id="37ea" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">我们将只解决两个线程，而不是25。因此，我们给我们的<code class="fe md me mf mg b">bundle exec sidekiq</code>添加了一个<code class="fe md me mf mg b">c -2</code>标志。</p><p id="b861" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">将代码推送到Heroku后，回到Heroku应用仪表板上的<em class="np">资源</em>选项卡，打开dyno部分下的<em class="np">口袋妖怪工作器</em>。该说的都说了，该做的都做了，应该是这样的:</p><figure class="mi mj mk ml gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi nz"><img src="../Images/b5243ffb7a6cfdad5df9f3c34374434e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*tk_OlhCETm0eT26uysxuhQ.png"/></div></div></figure><p id="4309" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">下图是<a class="ae mc" href="https://pokedex-sidekiq.herokuapp.com/pokemons" rel="noopener ugc nofollow" target="_blank">这里</a>部署的app的Heroku日志(要显示日志，输入终端:<code class="fe md me mf mg b">heroku logs -t</code>)。蓝色突出显示的日志是由主web-app线程创建的日志，而绿色突出显示的日志是由Sidekiq/Redis线程创建的日志。您可以看到两者同时工作。</p><figure class="mi mj mk ml gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi oa"><img src="../Images/aa36041c1f69f0dee0c8c9f90d19c7da.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*5-LaGXUp0eMNh1uj8Vwqnw.png"/></div></div></figure><p id="0a04" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">所以应该就是这样！你的Sidekiq现在部署在你实际的口袋妖怪创建/删除应用程序旁边。</p><h1 id="6d96" class="kz la it bd lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw bi translated">信用/更多资源</h1><p id="bdae" class="pw-post-body-paragraph kb kc it kd b ke lx kg kh ki ly kk kl km lz ko kp kq ma ks kt ku mb kw kx ky im bi translated">和我之前的博客一样，如果没有几个优秀的资源，这篇博客是不可能的。我在这里列出主要的，强烈推荐大家去看看，深入了解Sidekiq和后台处理。</p><p id="b037" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated"><a class="ae mc" href="https://github.com/learn-co-students/rails-sidekiq-readme-v-000" rel="noopener ugc nofollow" target="_blank"> <strong class="kd iu"> <em class="np">长时间运行的任务</em> </strong> <strong class="kd iu"> <em class="np">在Rails中</em> </strong> </a>由Flatiron School:一个关于如何设置Sidekiq的本地环境以及如何实现它的简明纲要。</p><p id="21f2" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated"><a class="ae mc" href="https://www.youtube.com/watch?v=GBEDvF1_8B8" rel="noopener ugc nofollow" target="_blank"> <strong class="kd iu"> <em class="np">使用Rails、Redis和Sidekiq</em></strong></a><strong class="kd iu"><em class="np"/></strong>进行后台处理由Decypher Media提供:一个15分钟的YouTube视频，其中包含了关于后台处理的高级概念(博客文章顶部的流程图就是来自那里)，以及如何将Sidekiq部署到Heroku的详细演示。</p><p id="c53b" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated"><a class="ae mc" href="https://www.youtube.com/watch?v=bfPb1zD91Rg&amp;list=PLjeHh2LSCFrWGT5uVjUuFKAcrcj5kSai1" rel="noopener ugc nofollow" target="_blank"><strong class="kd iu"><em class="np">Sidekiq Playlist</em></strong></a><strong class="kd iu"/>作者daily drip:Sidekiq的创建者的官方演示，它包括一个展示Sidekiq如何在并行/并发线程中工作的演示，以及如何使用其基于Sinatra的web-ui查看Sidekiq操作的深入教程。</p><p id="8ff6" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated"><a class="ae mc" href="https://speakerdeck.com/gogogarrett/lets-chat" rel="noopener ugc nofollow" target="_blank"> <strong class="kd iu"> <em class="np">让我们聊聊</em></strong></a><strong class="kd iu"><em class="np"/></strong>by<strong class="kd iu"><em class="np"/></strong><a class="ae mc" href="https://twitter.com/GoGoGarrett" rel="noopener ugc nofollow" target="_blank">网飞的Garrett Heinlen</a>:在<a class="ae mc" href="http://www.fogcityruby.com/" rel="noopener ugc nofollow" target="_blank"> FogCity Meetup </a>上的演讲，包括Redis的快速概述，以及Sidekiq如何与Redis通信。</p><h1 id="a4c1" class="kz la it bd lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw bi translated">结束语</h1><p id="1eb9" class="pw-post-body-paragraph kb kc it kd b ke lx kg kh ki ly kk kl km lz ko kp kq ma ks kt ku mb kw kx ky im bi translated">感谢你一直坚持到最后，这篇博客比我想象的要全面得多。</p><p id="ced5" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated"><em class="np">随便在下面留几个拍手的吧！</em></p></div></div>    
</body>
</html>