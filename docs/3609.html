<html>
<head>
<title>How to describe 100 Gitlab jobs in 100 lines using Jsonnet</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何使用Jsonnet用100行描述100个Gitlab作业</h1>
<blockquote>原文：<a href="https://itnext.io/how-to-describe-100-gitlab-jobs-in-100-lines-using-jsonnet-4e19a4d5bca?source=collection_archive---------3-----------------------#2020-01-16">https://itnext.io/how-to-describe-100-gitlab-jobs-in-100-lines-using-jsonnet-4e19a4d5bca?source=collection_archive---------3-----------------------#2020-01-16</a></blockquote><div><div class="fc if ig ih ii ij"/><div class="ik il im in io"><div class=""/><p id="a49e" class="pw-post-body-paragraph jo jp ir jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl ik bi translated">除了<a class="ae km" href="https://medium.com/@kvaps/trying-new-tools-for-building-and-automate-the-deployment-in-kubernetes-f96f9684e580" rel="noopener">上一篇关于Kubernetes中部署工具的文章</a>，我想告诉你如何使用Jsonnet来简化你的<strong class="jq is">中的工作描述。gitlab-ci.yml </strong></p><figure class="ko kp kq kr gt ks gh gi paragraph-image"><div class="gh gi kn"><img src="../Images/7731d7aeaba0e0f4b53c3d14a91ab2c1.png" data-original-src="https://miro.medium.com/v2/resize:fit:700/format:webp/1*fVzTtRqdqlthR-kEGqbxLw.png"/></div></figure><h1 id="2fad" class="kv kw ir bd kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls bi translated">考虑到</h1><p id="632d" class="pw-post-body-paragraph jo jp ir jq b jr lt jt ju jv lu jx jy jz lv kb kc kd lw kf kg kh lx kj kk kl ik bi translated">有一种单一回购，其中:</p><ul class=""><li id="300e" class="ly lz ir jq b jr js jv jw jz ma kd mb kh mc kl md me mf mg bi translated">10个dockerfiles文件</li><li id="279f" class="ly lz ir jq b jr mh jv mi jz mj kd mk kh ml kl md me mf mg bi translated">30个描述的部署</li><li id="2b6e" class="ly lz ir jq b jr mh jv mi jz mj kd mk kh ml kl md me mf mg bi translated">3个环境:<strong class="jq is">开发</strong>、<strong class="jq is">阶段</strong>和<strong class="jq is">生产</strong></li></ul><h1 id="c051" class="kv kw ir bd kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls bi translated">工作</h1><p id="536d" class="pw-post-body-paragraph jo jp ir jq b jr lt jt ju jv lu jx jy jz lv kb kc kd lw kf kg kh lx kj kk kl ik bi translated">配置管道:</p><ul class=""><li id="2d6c" class="ly lz ir jq b jr js jv jw jz ma kd mb kh mc kl md me mf mg bi translated">构建Docker映像应该通过添加一个带有版本号的git标签来完成。</li><li id="4cbb" class="ly lz ir jq b jr mh jv mi jz mj kd mk kh ml kl md me mf mg bi translated">每个部署操作都应该在推送到环境分支时执行，并且只有在特定目录中的文件发生更改时才执行</li><li id="de29" class="ly lz ir jq b jr mh jv mi jz mj kd mk kh ml kl md me mf mg bi translated">每个环境都有自己的gitlab-runner，带有不同的标记，只在这个环境中执行部署。</li><li id="0da0" class="ly lz ir jq b jr mh jv mi jz mj kd mk kh ml kl md me mf mg bi translated">不应该在每个环境中部署任何应用程序。我们应该描述管道，以便能够进行例外处理。</li><li id="7c62" class="ly lz ir jq b jr mh jv mi jz mj kd mk kh ml kl md me mf mg bi translated">一些部署使用git子模块，并且应该在设置了<code class="fe mm mn mo mp b"><strong class="jq is">GIT_SUBMODULE_STRATEGY=normal</strong></code>环境变量的情况下运行。</li></ul><p id="f9b2" class="pw-post-body-paragraph jo jp ir jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl ik bi translated">描述这一切可能看起来像一个真正的地狱，但不要绝望，有了Jsonnet的武装，我们可以轻松做到这一点。</p><h1 id="c158" class="kv kw ir bd kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls bi translated"><strong class="ak">解决方案</strong></h1><p id="a6ac" class="pw-post-body-paragraph jo jp ir jq b jr lt jt ju jv lu jx jy jz lv kb kc kd lw kf kg kh lx kj kk kl ik bi translated"><strong class="jq is"> gitlab-ci.yml </strong>内置了减少重复作业描述的功能，例如，您可以使用<a class="ae km" href="https://docs.gitlab.com/ee/ci/yaml/#extends" rel="noopener ugc nofollow" target="_blank">扩展</a>或<a class="ae km" href="https://docs.gitlab.com/ee/ci/yaml/#include" rel="noopener ugc nofollow" target="_blank">包含</a>，但是它没有提供完全成熟的模板，无法让您更加简洁高效地描述作业。</p><p id="5980" class="pw-post-body-paragraph jo jp ir jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl ik bi translated">为了解决这个问题，我建议使用jsonnet，它允许您在描述任何数据结构时摆脱代码重复。</p><blockquote class="mq mr ms"><p id="9745" class="jo jp mt jq b jr js jt ju jv jw jx jy mu ka kb kc mv ke kf kg mw ki kj kk kl ik bi translated">我强烈推荐你为你的编辑器安装一个插件，以便与<strong class="jq is"><em class="ir">jsonnet</em></strong><em class="ir">一起工作。</em></p><p id="ead5" class="jo jp mt jq b jr js jt ju jv jw jx jy mu ka kb kc mv ke kf kg mw ki kj kk kl ik bi translated"><em class="ir">例如，vim有一个很好的插件</em><strong class="jq is"><em class="ir">vim-jsonnet</em></strong><em class="ir">，它打开语法高亮，并在每次保存时自动运行</em> <code class="fe mm mn mo mp b"><em class="ir">jsonnet fmt</em></code> <em class="ir">(它需要安装</em><strong class="jq is"><em class="ir">jsonnet</em></strong><em class="ir">二进制)。</em></p></blockquote><p id="8038" class="pw-post-body-paragraph jo jp ir jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl ik bi translated">让我们看看我们的存储库的结构:</p><pre class="ko kp kq kr gt mx mp my mz aw na bi"><span id="4061" class="nb kw ir mp b gy nc nd l ne nf">.<br/>├── deploy<br/>│   ├── analyse<br/>│   ├── basin<br/>│   ├── brush<br/>│   ├── copper<br/>│   ├── dinner<br/>│   ├── dirty<br/>│   ├── drab<br/>│   ├── drunk<br/>│   ├── education<br/>│   ├── fanatical<br/>│   ├── faulty<br/>│   ├── guarantee<br/>│   ├── guitar<br/>│   ├── hall<br/>│   ├── harmonious<br/>│   ├── history<br/>│   ├── iron<br/>│   ├── maniacal<br/>│   ├── mist<br/>│   ├── nine<br/>│   ├── pleasant<br/>│   ├── polish<br/>│   ├── receipt<br/>│   ├── shop<br/>│   ├── smelly<br/>│   ├── solid<br/>│   ├── stroke<br/>│   ├── thunder<br/>│   ├── ultra<br/>│   └── yarn<br/>└── dockerfiles<br/>    ├── dinner<br/>    ├── drunk<br/>    ├── fanatical<br/>    ├── guarantee<br/>    ├── guitar<br/>    ├── harmonious<br/>    ├── shop<br/>    ├── smelly<br/>    ├── thunder<br/>    └── yarn</span></pre><p id="1767" class="pw-post-body-paragraph jo jp ir jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl ik bi translated">Docker图像将使用<a class="ae km" href="https://medium.com/@kvaps/trying-new-tools-for-building-and-automate-the-deployment-in-kubernetes-f96f9684e580#9bf2" rel="noopener"> <strong class="jq is"> kaniko </strong> </a>构建</p><p id="5c85" class="pw-post-body-paragraph jo jp ir jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl ik bi translated">应用程序将使用<a class="ae km" href="https://medium.com/@kvaps/trying-new-tools-for-building-and-automate-the-deployment-in-kubernetes-f96f9684e580#4c4b" rel="noopener"> <strong class="jq is"> qbec </strong> </a>部署到集群中。已经针对三种不同的环境描述了每个应用程序，为了将更改应用到集群，只需运行:</p><pre class="ko kp kq kr gt mx mp my mz aw na bi"><span id="7832" class="nb kw ir mp b gy nc nd l ne nf">qbec apply &lt;environment&gt; --root deploy/&lt;app&gt; --yes</span></pre><p id="32b8" class="pw-post-body-paragraph jo jp ir jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl ik bi translated">其中:</p><ul class=""><li id="0eb2" class="ly lz ir jq b jr js jv jw jz ma kd mb kh mc kl md me mf mg bi translated"><code class="fe mm mn mo mp b">&lt;app&gt;</code> —是应用程序名称</li><li id="94d5" class="ly lz ir jq b jr mh jv mi jz mj kd mk kh ml kl md me mf mg bi translated"><code class="fe mm mn mo mp b">&lt;environment&gt;</code> —是我们的环境之一:<strong class="jq is"> devel </strong>、<strong class="jq is"> stage </strong>或<strong class="jq is"> prod </strong>。</li></ul><p id="36bb" class="pw-post-body-paragraph jo jp ir jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl ik bi translated">最终，我们的工作应该是这样的:</p><p id="744f" class="pw-post-body-paragraph jo jp ir jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl ik bi translated"><strong class="jq is">构建:</strong></p><figure class="ko kp kq kr gt ks"><div class="bz fp l di"><div class="ng nh l"/></div></figure><p id="3313" class="pw-post-body-paragraph jo jp ir jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl ik bi translated">其中<code class="fe mm mn mo mp b">{{ image }}</code>将被替换为<strong class="jq is"> dockerfiles </strong>中的目录名</p><p id="8cff" class="pw-post-body-paragraph jo jp ir jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl ik bi translated"><strong class="jq is">部署:</strong></p><figure class="ko kp kq kr gt ks"><div class="bz fp l di"><div class="ng nh l"/></div></figure><p id="8712" class="pw-post-body-paragraph jo jp ir jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl ik bi translated">其中<code class="fe mm mn mo mp b">{{ app }}</code>将被替换为<strong class="jq is">部署</strong>目录中应用的名称，<code class="fe mm mn mo mp b">{{ environment }}</code>将被替换为我们执行部署的环境的名称。</p><p id="e4c6" class="pw-post-body-paragraph jo jp ir jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl ik bi translated">让我们将我们工作的原型描述为单独库中的对象<code class="fe mm mn mo mp b"><strong class="jq is">lib/jobs.jsonnet</strong></code> <strong class="jq is"> : </strong></p><figure class="ko kp kq kr gt ks"><div class="bz fp l di"><div class="ng nh l"/></div></figure><p id="0426" class="pw-post-body-paragraph jo jp ir jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl ik bi translated">请注意，我故意没有指定<code class="fe mm mn mo mp b"><strong class="jq is">refs</strong></code>和<code class="fe mm mn mo mp b"><strong class="jq is">tags</strong></code>以使我们的库更加灵活，并向您更详细地展示jsonnet的功能，我们稍后将在主文件中添加它们。</p><p id="9e8b" class="pw-post-body-paragraph jo jp ir jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl ik bi translated">现在我们来描述一下我们的<code class="fe mm mn mo mp b"><strong class="jq is">.gitlab-ci.jsonnet</strong></code>:</p><figure class="ko kp kq kr gt ks"><div class="bz fp l di"><div class="ng nh l"/></div></figure><p id="3766" class="pw-post-body-paragraph jo jp ir jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl ik bi translated">看看文件开头的<code class="fe mm mn mo mp b"><strong class="jq is">ref</strong></code>、<code class="fe mm mn mo mp b"><strong class="jq is">tag</strong></code>和<code class="fe mm mn mo mp b"><strong class="jq is">submodule</strong></code>函数，它们允许您构建一个覆盖对象。</p><p id="9ce1" class="pw-post-body-paragraph jo jp ir jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl ik bi translated">稍微解释一下:对覆盖对象使用<code class="fe mm mn mo mp b"><strong class="jq is">+:</strong></code>而不是<code class="fe mm mn mo mp b"><strong class="jq is">:</strong></code>允许您向现有对象或列表追加一个值。</p><p id="025c" class="pw-post-body-paragraph jo jp ir jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl ik bi translated"><code class="fe mm mn mo mp b"><strong class="jq is">refs</strong></code>的示例<code class="fe mm mn mo mp b"><strong class="jq is">:</strong></code>:</p><figure class="ko kp kq kr gt ks"><div class="bz fp l di"><div class="ng nh l"/></div></figure><p id="c7d6" class="pw-post-body-paragraph jo jp ir jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl ik bi translated">将输出:</p><pre class="ko kp kq kr gt mx mp my mz aw na bi"><span id="e999" class="nb kw ir mp b gy nc nd l ne nf">{<br/>   "only": { "refs": [ "prod" ] },<br/>   "script": [ "echo 123" ]<br/>}</span></pre><p id="0f1f" class="pw-post-body-paragraph jo jp ir jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl ik bi translated">但是<code class="fe mm mn mo mp b"><strong class="jq is">+:</strong></code>对于<code class="fe mm mn mo mp b"><strong class="jq is">refs</strong></code>:</p><figure class="ko kp kq kr gt ks"><div class="bz fp l di"><div class="ng nh l"/></div></figure><p id="b6ec" class="pw-post-body-paragraph jo jp ir jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl ik bi translated">将输出:</p><pre class="ko kp kq kr gt mx mp my mz aw na bi"><span id="434c" class="nb kw ir mp b gy nc nd l ne nf">{<br/>   "only": { "refs": [ "prod", "tags" ] },<br/>   "script": [ "echo 123" ]<br/>}</span></pre><p id="b10c" class="pw-post-body-paragraph jo jp ir jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl ik bi translated">正如你所看到的，使用Jsonnet允许你非常有效地描述和合并你的对象，结果，你总是得到现成的JSON，我们可以立即将它写入我们的<code class="fe mm mn mo mp b"><strong class="jq is">.gitlab-ci.yml</strong></code>文件:</p><pre class="ko kp kq kr gt mx mp my mz aw na bi"><span id="5ba6" class="nb kw ir mp b gy nc nd l ne nf">jsonnet .gitlab-ci.jsonnet &gt; .gitlab-ci.yml</span></pre><p id="dafa" class="pw-post-body-paragraph jo jp ir jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl ik bi translated">让我们检查一下行数:</p><pre class="ko kp kq kr gt mx mp my mz aw na bi"><span id="15f7" class="nb kw ir mp b gy nc nd l ne nf"># wc -l .gitlab-ci.jsonnet lib/jobs.libsonnet .gitlab-ci.yml<br/>   77 .gitlab-ci.jsonnet<br/>   24 lib/jobs.libsonnet<br/> 1710 .gitlab-ci.yml</span></pre><p id="6dc7" class="pw-post-body-paragraph jo jp ir jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl ik bi translated">非常好</p><p id="6c5d" class="pw-post-body-paragraph jo jp ir jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl ik bi translated">可以在官网看到更多例子直接试试Jsonnet:<a class="ae km" href="https://jsonnet.org/" rel="noopener ugc nofollow" target="_blank">【jsonnet.org】T2</a></p></div></div>    
</body>
</html>