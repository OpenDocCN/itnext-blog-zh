<html>
<head>
<title>Modernising our hosting infrastructure: what we’ve learnt</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">现代化我们的主机基础设施:我们学到了什么</h1>
<blockquote>原文：<a href="https://itnext.io/modernising-our-hosting-infrastructure-what-weve-learnt-f438188cbccb?source=collection_archive---------4-----------------------#2019-01-28">https://itnext.io/modernising-our-hosting-infrastructure-what-weve-learnt-f438188cbccb?source=collection_archive---------4-----------------------#2019-01-28</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/eedbb50462d813cb7e17e50d05e27fcb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*FUbdOOUf5R07afqSFZh-sw.jpeg"/></div></div></figure><p id="6a24" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">大多数制造数字产品的公司都希望在产品发布后运行和维护它们很多年。在此期间，几乎肯定会出现对该项目的网络托管基础设施进行现代化和迁移的需求。</p><p id="d09f" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">以浏览器为例，目前<a class="ae kw" href="https://www.browserlondon.com/services/continuous-improvement-support/" rel="noopener ugc nofollow" target="_blank">支持很多直播项目</a>，最老的要追溯到2010年。任何对技术感兴趣的人都会告诉你，在这段时间里，很多事情都会发生变化。这篇文章是关于我们是如何处理当前正在进行的主机迁移过程的，以及到目前为止我们学到了什么。</p><h1 id="34e0" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">但是首先，有一个警告</h1><p id="6be0" class="pw-post-body-paragraph jy jz iq ka b kb lv kd ke kf lw kh ki kj lx kl km kn ly kp kq kr lz kt ku kv ij bi translated"><a class="ae kw" href="https://www.browserlondon.com/blog/2015/12/15/how-we-auto-scale-our-products-with-aws/" rel="noopener ugc nofollow" target="_blank">我们是亚马逊网络服务</a> (AWS)的忠实用户，因此我们从这一过程中获得的许多技术优势将参考特定的AWS托管服务。</p><p id="8217" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">这并不是说谷歌云、微软Azure或任何其他大公司不可能获得这样的收益，但我们不会在这里讨论替代方案。像往常一样，您应该研究服务并制定一个最适合您的迁移项目的计划。</p><h1 id="4e02" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">将发现应用于托管基础架构变更</h1><p id="91e8" class="pw-post-body-paragraph jy jz iq ka b kb lv kd ke kf lw kh ki kj lx kl km kn ly kp kq kr lz kt ku kv ij bi translated">当接近这种多种产品的大规模迁移时，我们试图实践我们向客户宣扬的东西，并参与到项目的<a class="ae kw" href="https://www.browserlondon.com/services/research-analysis/" rel="noopener ugc nofollow" target="_blank">彻底发现过程</a>中。</p><p id="a8c0" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">幸运的是，我们的姐妹公司<a class="ae kw" href="https://www.twineapp.com/" rel="noopener ugc nofollow" target="_blank"> Twine </a>最近通过<a class="ae kw" href="https://www.browserlondon.com/blog/2016/02/27/how-we-use-aws-to-manage-our-product-services/" rel="noopener ugc nofollow" target="_blank">对其托管平台</a>进行了类似的现代化改造，因此我们开始尽可能多地学习他们的经验，然后再将其应用到我们自己的基础设施中。</p><figure class="mb mc md me gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi ma"><img src="../Images/ab518928a2a0a40042c6eaf891be5dc8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*7k7vUaRi_TcYm6E0Z9Zo9g.jpeg"/></div></div><figcaption class="mf mg gj gh gi mh mi bd b be z dk translated"><em class="mj">我们的发现阶段包括Twine团队关于其持续迁移流程的演示</em></figcaption></figure><p id="383c" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我们还认为，重要的是不仅要研究新技术如何使事情变得更加安全，还要研究它们如何用于降低业务流程的风险。因此，理解我们的开发人员的主要挫折是很重要的，这样做有助于确定在迁移期间要关注的三个关键领域。</p><h2 id="9ff8" class="mk ky iq bd kz ml mm dn ld mn mo dp lh kj mp mq ll kn mr ms lp kr mt mu lt mv bi translated">1.标准化部署流程</h2><p id="cad3" class="pw-post-body-paragraph jy jz iq ka b kb lv kd ke kf lw kh ki kj lx kl km kn ly kp kq kr lz kt ku kv ij bi translated">不同时间的不同项目有不同的部署过程——从自动部署的持续集成工具，到过时的Capistrano脚本。在一些旧的项目中，不清楚使用的是什么方法，以及使用的是什么版本的给定工具。</p><p id="8354" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">这导致了不必要的部署延迟，因为不是每个开发人员都有正确版本的部署工具运行在他们的机器上。标准化并消除对开发人员机器执行部署的依赖将节省时间和成本。</p><h2 id="edab" class="mk ky iq bd kz ml mm dn ld mn mo dp lh kj mp mq ll kn mr ms lp kr mt mu lt mv bi translated">2.提高效率和性能</h2><p id="e34a" class="pw-post-body-paragraph jy jz iq ka b kb lv kd ke kf lw kh ki kj lx kl km kn ly kp kq kr lz kt ku kv ij bi translated">由于不同的项目依赖于不同的外部服务(及其版本)，我们的项目部署效率低下。由于特定软件版本的依赖性，一些项目需要他们自己的虚拟服务器，这分散了我们的主机预算，而不是为我们所有的客户部署更好的性能。</p><h2 id="eda3" class="mk ky iq bd kz ml mm dn ld mn mo dp lh kj mp mq ll kn mr ms lp kr mt mu lt mv bi translated">3.为交叉培训和项目评审创造机会</h2><p id="14e4" class="pw-post-body-paragraph jy jz iq ka b kb lv kd ke kf lw kh ki kj lx kl km kn ly kp kq kr lz kt ku kv ij bi translated">在一个项目将近十年的时间跨度中，最初的开发人员可能会带着他们对项目的深入了解继续前进。虽然文档意味着我们永远不会完全陷入困境，但当被要求维护项目时，真正了解项目是有好处的。</p><p id="395e" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">顺便提一下，谷歌已经开始解决这个问题，故意定期重写完美的项目，只是为了交叉培训员工。</p><p id="1004" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">现在，对于我们大多数人来说，这种方法(Fergus Henderson在他关于谷歌软件工程的报告的<a class="ae kw" href="https://arxiv.org/pdf/1702.01715.pdf" rel="noopener ugc nofollow" target="_blank">第2.11节中详述)是荒谬的，但是像这样的迁移项目可以作为开发者了解项目的机会。将一个项目分配给一个以前从未见过它的开发人员，既传播了知识，又给了团队一个如何管理项目的新视角。它还有助于在您的团队中传播对您的devops流程的理解。</a></p><h1 id="149d" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">我们的技术方法</h1><p id="492c" class="pw-post-body-paragraph jy jz iq ka b kb lv kd ke kf lw kh ki kj lx kl km kn ly kp kq kr lz kt ku kv ij bi translated">这不是一个技术指南，但是根据最近的Twine迁移工作，以及我们在其他项目中的经验，我们确定了我们的虚拟主机设置的一些核心支柱。</p><h2 id="bfdd" class="mk ky iq bd kz ml mm dn ld mn mo dp lh kj mp mq ll kn mr ms lp kr mt mu lt mv bi translated">码头工人</h2><p id="5e46" class="pw-post-body-paragraph jy jz iq ka b kb lv kd ke kf lw kh ki kj lx kl km kn ly kp kq kr lz kt ku kv ij bi translated">这对我们来说是显而易见的，其他人<a class="ae kw" href="https://dzone.com/articles/top-10-benefits-of-using-docker" rel="noopener ugc nofollow" target="_blank">已经比我更好地解释了这些好处。然而，我们实现的不同之处在于，对于我们的遗留项目，我们构建了一个包含我们需要的所有内容的容器，而不是每个服务一个容器的最佳实践。</a></p><figure class="mb mc md me gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mx"><img src="../Images/f9f80a7ded37a72acdf68fa928e5884d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*-YArkXDSWaY6QPW4Mk6KkA.png"/></div></div></figure><p id="8f5c" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">这是因为我们几乎所有的项目都将文件推送到<a class="ae kw" href="https://aws.amazon.com/s3/" rel="noopener ugc nofollow" target="_blank">简单存储服务</a> (S3)，使用<a class="ae kw" href="https://aws.amazon.com/rds/" rel="noopener ugc nofollow" target="_blank">关系数据库服务</a> (RDS)，或者尽可能使用托管AWS产品。这很有帮助，因为这意味着我们可以将整个项目作为一个容器来运行，将缓存、web服务器和应用程序本身打包在一起。我们这样做主要是为了减少迁移项目所需的时间，默认情况下，这些项目期望服务位于特定的位置，我们在需要时会对此规则进行例外处理。</p><p id="9509" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">明确地说，这种方法有缺点，特别是在如何处理日志方面。这种权衡可能不适合某些项目，尤其是新的绿地项目。</p><h2 id="5e90" class="mk ky iq bd kz ml mm dn ld mn mo dp lh kj mp mq ll kn mr ms lp kr mt mu lt mv bi translated">ECS和EC2</h2><p id="96dd" class="pw-post-body-paragraph jy jz iq ka b kb lv kd ke kf lw kh ki kj lx kl km kn ly kp kq kr lz kt ku kv ij bi translated">我们决定使用亚马逊的<a class="ae kw" href="https://aws.amazon.com/ecs/" rel="noopener ugc nofollow" target="_blank">弹性容器服务</a> (ECS)和<a class="ae kw" href="https://aws.amazon.com/ec2/" rel="noopener ugc nofollow" target="_blank">弹性计算云</a> (EC2)实例。Twine将ECS与<a class="ae kw" href="https://aws.amazon.com/fargate/" rel="noopener ugc nofollow" target="_blank"> Fargate </a>一起使用，但是，我们的经验告诉我们，当您快速迁移许多项目时，能够快速、直接地访问主机实例以调试问题会有很大的好处。我们还发现，使用EC2集群，我们可以更经济高效地降低部署成本。</p><p id="ce9d" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><a class="ae kw" href="https://aws.amazon.com/eks/" rel="noopener ugc nofollow" target="_blank">弹性Kubernetes服务</a> (EKS)是一个完全可以接受的解决方案，如果你想避免供应商锁定，但我们并没有大力推行，因为我们在ECS方面已经有了丰富的经验，并高度依赖AWS产品。</p><h2 id="bdfd" class="mk ky iq bd kz ml mm dn ld mn mo dp lh kj mp mq ll kn mr ms lp kr mt mu lt mv bi translated">连续累计</h2><p id="9f44" class="pw-post-body-paragraph jy jz iq ka b kb lv kd ke kf lw kh ki kj lx kl km kn ly kp kq kr lz kt ku kv ij bi translated">另一个显而易见的问题<a class="ae kw" href="https://pantheon.io/blog/5-advantages-continuous-integration" rel="noopener ugc nofollow" target="_blank">已经在其他地方得到了更好的解释</a>，你已经在这么做了，对吗？对我们T15来说，CI是一个用一个自动化解决方案摆脱所有旧的不同部署方法的机会。这也减少了我们对特定团队成员的依赖，他们可以访问服务器进行部署，任何人都可以进行部署。</p><p id="79bf" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我们过去一直大量使用<a class="ae kw" href="https://jenkins.io/" rel="noopener ugc nofollow" target="_blank"> Jenkins </a>，但最终在Twine团队的建议下，我们决定迁移到<a class="ae kw" href="https://circleci.com/" rel="noopener ugc nofollow" target="_blank"> CircleCI </a>，避免自己管理这项服务。</p><figure class="mb mc md me gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mx"><img src="../Images/5e6cef516105670b01b21470beb2e548.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*vpfIfFjU9omZujdRkMUHfw.png"/></div></div></figure><h2 id="f928" class="mk ky iq bd kz ml mm dn ld mn mo dp lh kj mp mq ll kn mr ms lp kr mt mu lt mv bi translated">分支合并规则</h2><p id="8919" class="pw-post-body-paragraph jy jz iq ka b kb lv kd ke kf lw kh ki kj lx kl km kn ly kp kq kr lz kt ku kv ij bi translated">每个人都可以在任何时间部署，我们现在有相反的问题…任何人都可以在任何时间部署！我们在我们的位存储库中利用分支合并规则来解决这个问题。我们通常仍然允许任何人进行部署，特别是部署到暂存环境，但是对于部署到生产环境的分支，我们添加了一个限制，要求创建一个拉请求。此拉取请求必须得到至少2名开发人员的批准才能合并，从而触发CircleCI。</p><h1 id="2780" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">怎么样了？</h1><p id="66b4" class="pw-post-body-paragraph jy jz iq ka b kb lv kd ke kf lw kh ki kj lx kl km kn ly kp kq kr lz kt ku kv ij bi translated">到目前为止，将我们的托管基础设施迁移到更现代的AWS服务是一个非常积极的项目，不仅满足了我们的关键目标，还带来了一些有益的改进。</p><h2 id="106f" class="mk ky iq bd kz ml mm dn ld mn mo dp lh kj mp mq ll kn mr ms lp kr mt mu lt mv bi translated">软件更新</h2><p id="5b13" class="pw-post-body-paragraph jy jz iq ka b kb lv kd ke kf lw kh ki kj lx kl km kn ly kp kq kr lz kt ku kv ij bi translated">当然，我们会更新软件来修补安全问题，但由于在相同服务器上运行的其他项目的限制，我们经常无法走得更远。通过转移到基于docker的设置，我们可以轻松地将每个项目升级到他们可以处理的“最佳”状态。在许多情况下，这给了我们一个自动的、免费的性能改进。</p><h2 id="948e" class="mk ky iq bd kz ml mm dn ld mn mo dp lh kj mp mq ll kn mr ms lp kr mt mu lt mv bi translated">提高性能和安全性</h2><p id="cd07" class="pw-post-body-paragraph jy jz iq ka b kb lv kd ke kf lw kh ki kj lx kl km kn ly kp kq kr lz kt ku kv ij bi translated">将服务从旧的EC2 classic实例转移到新的ECS集群意味着我们能够利用更新的Amazon实例类型，在这种情况下，M5实例系列的性价比更高。</p><p id="9b2a" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">这也意味着我们可以从旧的弹性负载平衡器(elb)转移到更新、更强大的应用负载平衡器(ALB)。这些允许我们使用路由规则来执行重要的301重定向，比如在请求到达web服务器之前强制SSL，从而提高性能。然而，更重要的是，它提供了以多种方式增加安全性的机会。</p><p id="b6fe" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">例如，<a class="ae kw" href="https://aws.amazon.com/certificate-manager/" rel="noopener ugc nofollow" target="_blank"> AWS证书管理器</a> (ACM)集成现在意味着提供和更新SSL证书变得很简单，更重要的是，是免费的。我们现在可以为任何客户提供SSL支持，无论是老客户还是新客户，只要他们能够在DNS记录中添加一个小的TXT条目。在以前基于ELB的服务下，我们必须手动购买、上传和续订证书。此外，ELB只支持每个负载平衡器一个证书，这意味着每个使用SSL的客户端都将承担自己的服务成本。</p><p id="86f4" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">ALB带来了与另一个优秀工具的集成，即<a class="ae kw" href="https://aws.amazon.com/waf/" rel="noopener ugc nofollow" target="_blank"> Web应用防火墙</a> (WAF)。WAF允许我们通过定义在基础架构级别运行的规则来缓解已知问题，如SQL注入攻击。此外，我们可以订阅由外部安全公司定期更新的第三方规则集，每月支付少量费用。我们借此机会订阅了几个规则集，例如包括针对know CMS CVEs的缓解。这意味着，即使我们由于重大变更而无法快速更新CMS应用程序，也有很大机会在问题到达应用程序之前阻止它。</p><h1 id="a0c4" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">结论</h1><p id="0245" class="pw-post-body-paragraph jy jz iq ka b kb lv kd ke kf lw kh ki kj lx kl km kn ly kp kq kr lz kt ku kv ij bi translated">我们还没有完成，但我们从这个过程中学到了很多。我们学到的最重要的一点是，如果计划和执行得当，托管基础设施现代化项目可以带来超越效率、安全性和性能的优势。交叉培训员工并抓住机会实现完全自动化部署的好处让开发人员可以做他们最擅长的事情。</p></div><div class="ab cl my mz hu na" role="separator"><span class="nb bw bk nc nd ne"/><span class="nb bw bk nc nd ne"/><span class="nb bw bk nc nd"/></div><div class="ij ik il im in"><h2 id="f6f3" class="mk ky iq bd kz ml mm dn ld mn mo dp lh kj mp mq ll kn mr ms lp kr mt mu lt mv bi translated">关于浏览器</h2><p id="398b" class="pw-post-body-paragraph jy jz iq ka b kb lv kd ke kf lw kh ki kj lx kl km kn ly kp kq kr lz kt ku kv ij bi translated">我们为更好、更高效的工作场所创建企业网络应用。我们已经帮助壳牌、英国航空公司和英国政府等客户提高效率，简化业务。访问我们在<a class="ae kw" href="http://www.browserlondon.com" rel="noopener ugc nofollow" target="_blank">浏览器伦敦</a>。</p><p id="9289" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><em class="mw">原载于2019年1月28日</em><a class="ae kw" href="https://www.browserlondon.com/blog/2019/01/28/modernising-hosting-platform/" rel="noopener ugc nofollow" target="_blank"><em class="mw">www.browserlondon.com</em></a><em class="mw">。</em></p></div></div>    
</body>
</html>