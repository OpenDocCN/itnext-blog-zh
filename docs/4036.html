<html>
<head>
<title>Elastic Stack on Kubernetes 1.15 using Helm v3</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Helm v3的Kubernetes 1.15上的弹性堆栈</h1>
<blockquote>原文：<a href="https://itnext.io/deploy-elastic-stack-on-kubernetes-1-15-using-helm-v3-9105653c7c8?source=collection_archive---------0-----------------------#2020-04-14">https://itnext.io/deploy-elastic-stack-on-kubernetes-1-15-using-helm-v3-9105653c7c8?source=collection_archive---------0-----------------------#2020-04-14</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><figure class="gl gn jr js jt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi jq"><img src="../Images/86c3ac929e1e514e2891fd2494d5c216.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*5cCEIsqusNxn-vFz1ie0jA.jpeg"/></div></div></figure><p id="d831" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">随着Kubernetes越来越受欢迎，并已成为编排容器工作负载的事实上的标准，难怪Kubernetes和Helm现在成为描述公司监控堆栈的标准组合。</p><p id="d8cb" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">Elastic Stack(也称为ELK)与Kubernetes进行了本机集成，是一种流行的开源解决方案，用于收集、存储和分析Kubernetes遥测数据。虽然使用Kubernetes部署ELK堆栈似乎是一项复杂的任务，但围绕这一场景的最佳实践以及Kubernetes本地解决方案越来越多。其中一个解决方案是使用<a class="ae kz" href="https://helm.sh/" rel="noopener ugc nofollow" target="_blank">舵</a>图。</p><h2 id="be26" class="la lb it bd lc ld le dn lf lg lh dp li km lj lk ll kq lm ln lo ku lp lq lr ls bi translated">标准ELK测井解决方案概述</h2><figure class="lu lv lw lx gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi lt"><img src="../Images/89876ee1b85f0a3ad45c7bede78848cb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*9Zgq_SW8A1wIZjHr.png"/></div></div></figure><ul class=""><li id="25c3" class="ly lz it kd b ke kf ki kj km ma kq mb ku mc ky md me mf mg bi translated"><strong class="kd iu">日志</strong>:识别待分析的服务器日志</li><li id="1419" class="ly lz it kd b ke mh ki mi km mj kq mk ku ml ky md me mf mg bi translated"><strong class="kd iu"> Logstash </strong>:数据汇总和处理</li><li id="b662" class="ly lz it kd b ke mh ki mi km mj kq mk ku ml ky md me mf mg bi translated"><strong class="kd iu">弹性搜索</strong>:索引和存储</li><li id="0696" class="ly lz it kd b ke mh ki mi km mj kq mk ku ml ky md me mf mg bi translated">基巴纳:分析和可视化</li></ul><p id="da87" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">在深入实际设置之前，让我们快速探索一下在Kubernetes上运行ELK堆栈的可能替代方案。</p><h2 id="9984" class="la lb it bd lc ld le dn lf lg lh dp li km lj lk ll kq lm ln lo ku lp lq lr ls bi translated">Elasticserach设置— SaaS还是自我管理？</h2><p id="d6d8" class="pw-post-body-paragraph kb kc it kd b ke mm kg kh ki mn kk kl km mo ko kp kq mp ks kt ku mq kw kx ky im bi translated">许多云提供商将Elasticsearch作为一项服务提供，对于一家公司来说，尽可能减少构建解决方案的工作量似乎很有吸引力。然而，维护的便利性来自以下考虑因素:</p><p id="7496" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated"><strong class="kd iu">弹性搜索即服务</strong></p><ul class=""><li id="28fe" class="ly lz it kd b ke kf ki kj km ma kq mb ku mc ky md me mf mg bi translated"><strong class="kd iu">安全性:</strong>基于云的Elasticsearch解决方案通常缺乏像RBAC这样的基本ELK安全功能，最明显的是AWS Elasticsearch产品不支持<a class="ae kz" href="https://www.elastic.co/what-is/open-x-pack" rel="noopener ugc nofollow" target="_blank"> X-Pack </a>插件。因此，实现担保权的灵活性是不存在的，从长远来看，肯定需要付出额外的努力。</li><li id="c212" class="ly lz it kd b ke mh ki mi km mj kq mk ku ml ky md me mf mg bi translated"><strong class="kd iu">功能:</strong>最流行的Elasticsearch云解决方案缺乏分片重新平衡功能，而这在大型生产环境中是一个关键点，因此需要一些手动工作来将索引移动到新节点，以防节点故障。<br/>SaaS选项也不支持其他插件，如分析器插件和摄取插件。</li><li id="bedb" class="ly lz it kd b ke mh ki mi km mj kq mk ku ml ky md me mf mg bi translated"><strong class="kd iu">控制:</strong>托管解决方案很少提供对弹性搜索设置的完全控制。通常对配置更改和性能优化的支持非常有限。</li><li id="23b8" class="ly lz it kd b ke mh ki mi km mj kq mk ku ml ky md me mf mg bi translated"><strong class="kd iu">维护:</strong>备份频率选项通常限于一天一次。与Elastic的官方发布日期相比，新版本的发布要晚得多。升级通常是一个痛苦的过程，因为它们通常需要为新版本建立一个全新的集群。</li><li id="f5ac" class="ly lz it kd b ke mh ki mi km mj kq mk ku ml ky md me mf mg bi translated"><strong class="kd iu">可见性:</strong>监控和集群指标也非常有限。投诉、警告、垃圾收集缓慢等日志不可用</li><li id="9bc3" class="ly lz it kd b ke mh ki mi km mj kq mk ku ml ky md me mf mg bi translated"><strong class="kd iu">成本</strong>:托管云服务附带预定义的实例类型和数量选项，与自行设置的解决方案相比，这会导致成本增加。</li></ul><p id="39bb" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated"><strong class="kd iu">Kubernetes上的弹性搜索</strong></p><p id="8c43" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">根据为ELK stack供电的Elastic公司的说法，这只是这种设置带来的一些好处:</p><ul class=""><li id="4d20" class="ly lz it kd b ke kf ki kj km ma kq mb ku mc ky md me mf mg bi translated"><strong class="kd iu">多个弹性搜索集群的简单部署和管理</strong>，包括Kibana</li><li id="8a0c" class="ly lz it kd b ke mh ki mi km mj kq mk ku ml ky md me mf mg bi translated"><strong class="kd iu">无缝升级</strong>到新版本的弹性堆栈</li><li id="f866" class="ly lz it kd b ke mh ki mi km mj kq mk ku ml ky md me mf mg bi translated"><strong class="kd iu">简单的扩展</strong>允许您随着使用案例的增加而增长</li><li id="d441" class="ly lz it kd b ke mh ki mi km mj kq mk ku ml ky md me mf mg bi translated"><strong class="kd iu">每个集群上的默认安全性</strong></li></ul><p id="6af4" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">Elastic提供在Kubernetes上运行Elasticsearch &amp; Kibana的选项，运行在<a class="ae kz" href="https://www.elastic.co/elasticsearch/service/pricing" rel="noopener ugc nofollow" target="_blank">弹性云管理解决方案</a>上，如果SaaS是您的首选，您可以查看他们的产品。</p><p id="f5e7" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">如果您愿意使用Helm 3探索Kubernetes上的弹性设置，现在我们已经了解了Kubernetes上的弹性搜索设置的潜在好处，您可以继续本文的步骤。</p><p id="d0f4" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">下面是这个设置的大概情况。</p><figure class="lu lv lw lx gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi mr"><img src="../Images/229a6e4d962187671a935d0511570c27.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ijqbid2N4B8sOn1TG8ou4Q.png"/></div></div></figure><h2 id="4bdd" class="la lb it bd lc ld le dn lf lg lh dp li km lj lk ll kq lm ln lo ku lp lq lr ls bi translated">步骤1:创建Kubernetes集群</h2><p id="9fb8" class="pw-post-body-paragraph kb kc it kd b ke mm kg kh ki mn kk kl km mo ko kp kq mp ks kt ku mq kw kx ky im bi translated">出于测试目的，您可以使用minikube-版本1.15.6，该版本可以按照<a class="ae kz" href="https://kubernetes.io/docs/tasks/tools/install-minikube/" rel="noopener ugc nofollow" target="_blank"> Kubernetes Minicube文档中所示进行安装。</a></p><p id="a3e8" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">或者，可以将集群部署在提供此服务的主要云提供商之一(EKS或GKE)上。我们的设置将在EKS版本1.15上运行。您可以参考官方云提供商文档来轻松设置。</p><h2 id="dbc3" class="la lb it bd lc ld le dn lf lg lh dp li km lj lk ll kq lm ln lo ku lp lq lr ls bi translated">第二步:<a class="ae kz" href="https://v3.helm.sh/" rel="noopener ugc nofollow" target="_blank">舵3 </a>安装</h2><p id="1d07" class="pw-post-body-paragraph kb kc it kd b ke mm kg kh ki mn kk kl km mo ko kp kq mp ks kt ku mq kw kx ky im bi translated">就像遵循官方<a class="ae kz" href="https://helm.sh/docs/intro/install/" rel="noopener ugc nofollow" target="_blank">安装指南</a>一样简单</p><h2 id="6cdf" class="la lb it bd lc ld le dn lf lg lh dp li km lj lk ll kq lm ln lo ku lp lq lr ls bi translated">步骤3:部署Elasticsearch集群</h2><p id="14c0" class="pw-post-body-paragraph kb kc it kd b ke mm kg kh ki mn kk kl km mo ko kp kq mp ks kt ku mq kw kx ky im bi translated">为此，我们将使用Github上的官方<a class="ae kz" href="https://github.com/elastic/helm-charts" rel="noopener ugc nofollow" target="_blank">弹性舵图表</a>。</p><pre class="lu lv lw lx gt ms mt mu mv aw mw bi"><span id="c704" class="la lb it mt b gy mx my l mz na">$ helm repo add elastic https://helm.elastic.co</span></pre><p id="0309" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">您可以参考存储库中提供的大量安装和设置示例。</p><p id="f0a4" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">对于我们的设置，我们将创建一个类似于下图的目录结构，并在每个组件的相关目录中创建<code class="fe nb nc nd mt b">values.yaml</code>文件:</p><p id="2463" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">├──<strong class="kd iu">elastic search</strong><br/>│└──<a class="ae kz" href="https://raw.githubusercontent.com/elastic/helm-charts/master/elasticsearch/values.yaml" rel="noopener ugc nofollow" target="_blank">values . YAML</a><br/>├──<strong class="kd iu">基巴纳</strong><br/>│└──<a class="ae kz" href="https://raw.githubusercontent.com/elastic/helm-charts/master/kibana/values.yaml" rel="noopener ugc nofollow" target="_blank">values . YAML</a><br/>└──<strong class="kd iu">metric beat</strong><br/>└───<a class="ae kz" href="https://raw.githubusercontent.com/elastic/helm-charts/master/metricbeat/values.yaml" rel="noopener ugc nofollow" target="_blank">values . YAML</a></p><p id="afdd" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">特别注意CPU和内存使用的<strong class="kd iu">资源</strong>配置，并确保一旦完成测试后<code class="fe nb nc nd mt b">values.yaml</code>被正确更新用于生产级部署。</p><p id="f251" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">默认情况下，对于elasticsearch，我们将为集群中的每个pod创建容量为1Gi的<code class="fe nb nc nd mt b"><a class="ae kz" href="https://kubernetes.io/docs/concepts/storage/persistent-volumes/" rel="noopener ugc nofollow" target="_blank">PersistentVolumeClaim</a></code>,以防止在意外删除pod的情况下丢失数据。对于生产工作负载，应该使用所需的存储容量和(可选)Kubernetes <a class="ae kz" href="https://kubernetes.io/docs/concepts/storage/storage-classes/" rel="noopener ugc nofollow" target="_blank">存储类</a>来定义卷声明模板，以便与持久卷相关联。批量索赔的名称必须始终为<code class="fe nb nc nd mt b">elasticsearch-data</code>。</p><figure class="lu lv lw lx gt ju"><div class="bz fp l di"><div class="ne nf l"/></div><figcaption class="ng nh gj gh gi ni nj bd b be z dk translated">Elasticsearch values.yaml</figcaption></figure><p id="462f" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">对于实际安装，我们将使用以下脚本。将它放入项目的根目录，这样它就可以访问3个子目录。</p><p id="10d8" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">请随意增强脚本或更改提供的缺省值以满足您的需求，因为为了简单起见，我们已尽量将其保持在最低限度:</p><figure class="lu lv lw lx gt ju"><div class="bz fp l di"><div class="ne nf l"/></div><figcaption class="ng nh gj gh gi ni nj bd b be z dk translated">ELK安装脚本</figcaption></figure><pre class="lu lv lw lx gt ms mt mu mv aw mw bi"><span id="4723" class="la lb it mt b gy mx my l mz na">This script must be run with 2 parameters</span><span id="0872" class="la lb it mt b gy nk my l mz na">Usage:<br/>./elk-setup.sh [install|update] [elasticsearch|kibana|metricbeat|filebeat]</span><span id="84d6" class="la lb it mt b gy nk my l mz na">Example:<br/>./elk-setup.sh install kibana</span></pre><p id="bd16" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">使用<code class="fe nb nc nd mt b">install elasticsearch</code>选项运行上面的脚本应该会产生以下输出:</p><pre class="lu lv lw lx gt ms mt mu mv aw mw bi"><span id="88e6" class="la lb it mt b gy mx my l mz na">NAME:   elasticsearch<br/>LAST DEPLOYED: Thu Apr 1 17:28:20 2020<br/>NAMESPACE: default<br/>STATUS: DEPLOYED<br/>NOTES:<br/>1. Watch all cluster members come up.<br/>  $ kubectl get pods --namespace=default -l app=elasticsearch-master -w<br/>2. Test cluster health using Helm test.<br/>  $ Helm test elasticsearch</span></pre><p id="5686" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">如上面的提示所示，您可以使用以下命令来观察集群的状态:</p><pre class="lu lv lw lx gt ms mt mu mv aw mw bi"><span id="64d2" class="la lb it mt b gy mx my l mz na">$ kubectl get pods --namespace=default -l app=elasticsearch-master -w</span><span id="201c" class="la lb it mt b gy nk my l mz na">$ helm test elasticsearch</span></pre><p id="0313" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">部署完成后，将会看到elasticsearch窗格出现:</p><pre class="lu lv lw lx gt ms mt mu mv aw mw bi"><span id="72cb" class="la lb it mt b gy mx my l mz na">NAME                     READY     STATUS     RESTARTS   AGE<br/>elasticsearch-master-0   1/1       Running   0         1m<br/>elasticsearch-master-2   1/1       Running   0         1m<br/>elasticsearch-master-1   1/1       Running   0         1m</span></pre><p id="5569" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">通过本地测试来完成设置。您可以通过执行到本地机器的端口转发来访问集群。</p><pre class="lu lv lw lx gt ms mt mu mv aw mw bi"><span id="a272" class="la lb it mt b gy mx my l mz na">$ kubectl port-forward svc/elasticsearch-master 9200</span></pre><p id="82d2" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">输出是:</p><figure class="lu lv lw lx gt ju gh gi paragraph-image"><div class="gh gi nl"><img src="../Images/51fb3e4776b54713a6f1d30f9cb28ae0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1184/format:webp/1*QFISO8xPfgBNjIyNcm6NLw.png"/></div></figure><h2 id="e7a5" class="la lb it bd lc ld le dn lf lg lh dp li km lj lk ll kq lm ln lo ku lp lq lr ls bi translated">步骤4:部署Kibana</h2><p id="d179" class="pw-post-body-paragraph kb kc it kd b ke mm kg kh ki mn kk kl km mo ko kp kq mp ks kt ku mq kw kx ky im bi translated">对于Kibana部署，我们将采用完全相同的方法，只更新Kibana的相关图表和<code class="fe nb nc nd mt b">values.yaml</code>:</p><figure class="lu lv lw lx gt ju"><div class="bz fp l di"><div class="ne nf l"/></div></figure><p id="3fb1" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">..并使用Kibana选项运行安装脚本:</p><pre class="lu lv lw lx gt ms mt mu mv aw mw bi"><span id="c041" class="la lb it mt b gy mx my l mz na">$ ./elk-setup install elasticsearch</span></pre><p id="75d6" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">以下输出:</p><pre class="lu lv lw lx gt ms mt mu mv aw mw bi"><span id="5518" class="la lb it mt b gy mx my l mz na">NAME:   kibana<br/>LAST DEPLOYED: Thu Apr 1 09:52:21 2020<br/>NAMESPACE: default<br/>STATUS: DEPLOYED</span></pre><p id="1248" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">..还有一份跑步舱的清单</p><pre class="lu lv lw lx gt ms mt mu mv aw mw bi"><span id="2212" class="la lb it mt b gy mx my l mz na">kubectl get pods<br/>NAME                             READY     STATUS    RESTARTS   AGE<br/>elasticsearch-master-0           1/1       Running   0          15m<br/>elasticsearch-master-1           1/1       Running   0          15m<br/>elasticsearch-master-2           1/1       Running   0          15m<br/>kibana-kibana-6d7466b9b9-fbmsz   1/1       Running   0          2m</span></pre><p id="08f2" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">端口转发:</p><pre class="lu lv lw lx gt ms mt mu mv aw mw bi"><span id="9c1b" class="la lb it mt b gy mx my l mz na">$ kubectl port-forward deployment/kibana-kibana 5601</span></pre><p id="5714" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">现在，您可以在浏览器中访问Kibana，网址为:<a class="ae kz" href="http://localhost:5601/" rel="noopener ugc nofollow" target="_blank"> http://localhost:5601 </a></p><figure class="lu lv lw lx gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi nm"><img src="../Images/7ac8b6086a3fddd59905b1bd912ed2b6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*bTv1QA6BSSZlil09.png"/></div></div></figure><h2 id="31c1" class="la lb it bd lc ld le dn lf lg lh dp li km lj lk ll kq lm ln lo ku lp lq lr ls bi translated">步骤5:部署metricbeat</h2><p id="02cf" class="pw-post-body-paragraph kb kc it kd b ke mm kg kh ki mn kk kl km mo ko kp kq mp ks kt ku mq kw kx ky im bi translated">下一步将是部署T4号。</p><p id="b347" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">它是Elastic提供的常用beats之一，负责发送度量数据。它可以将数据直接发送到Elasticsearch或通过<a class="ae kz" href="https://www.elastic.co/products/logstash" rel="noopener ugc nofollow" target="_blank"> Logstash </a>发送，在那里您可以进一步处理和增强数据，然后在<a class="ae kz" href="https://www.elastic.co/products/logstash" rel="noopener ugc nofollow" target="_blank"> Kibana </a>中可视化数据。</p><p id="f823" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">以下是所有节拍的完整列表，由Elastic提供。他们中的每一个人都负责收集特定类型的数据并将其发送到elasticsearch集群。花点时间熟悉一下<a class="ae kz" href="https://www.elastic.co/beats/" rel="noopener ugc nofollow" target="_blank"> Beats文档</a>，因为在本文中我们不会对它们中的每一个做太多的详细介绍。</p><figure class="lu lv lw lx gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi nn"><img src="../Images/7d2e8046904ec1a5d7673d075db90028.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*tMbobU5YBwaC8VHY.png"/></div></div><figcaption class="ng nh gj gh gi ni nj bd b be z dk translated"><a class="ae kz" href="https://www.elastic.co/guide/en/beats/libbeat/current/beats-reference.html" rel="noopener ugc nofollow" target="_blank"> Beats平台参考</a></figcaption></figure><pre class="lu lv lw lx gt ms mt mu mv aw mw bi"><span id="73ac" class="la lb it mt b gy mx my l mz na">$ ./elk-setup install metricbeat</span></pre><figure class="lu lv lw lx gt ju"><div class="bz fp l di"><div class="ne nf l"/></div><figcaption class="ng nh gj gh gi ni nj bd b be z dk translated">metricbeat-values.yaml</figcaption></figure><p id="2a29" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">如果我们仔细检查<a class="ae kz" href="https://gist.github.com/radostina-dimova/298ca1af0926dd633c2c8c6128e3c579" rel="noopener ugc nofollow" target="_blank"> metricbeat-values.yaml </a>文件，我们会注意到它配置了各种度量收集<em class="no">模块</em> (kubernetes、system等)。Metricbeat <em class="no">模块</em>定义从服务中收集哪些特定的指标，定义收集它们的频率，以及如何连接到服务。模块由一个或多个<em class="no">指标集</em>组成——字面意思是一组要收集和发布的相关指标。</p><p id="99e1" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">模块细分:</p><ul class=""><li id="fa5e" class="ly lz it kd b ke kf ki kj km ma kq mb ku mc ky md me mf mg bi translated"><code class="fe nb nc nd mt b">metricbeat.yml</code>为Metricbeat提供一般配置的文件(包含从每个节点上的kubelet收集的系统和kubernetes模块)</li><li id="58c1" class="ly lz it kd b ke mh ki mi km mj kq mk ku ml ky md me mf mg bi translated"><code class="fe nb nc nd mt b">kube-state-metrics-metricbeat.yml</code>—<a class="ae kz" href="https://github.com/kubernetes/kube-state-metrics" rel="noopener ugc nofollow" target="_blank">kube-state-metric</a>s是一个简单的服务，它监听Kubernetes API服务器，并生成关于Kubernetes内部各种对象(如部署、节点和单元)的状态和健康状况的指标。</li></ul><p id="a516" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">我们将在k8s集群的每个节点上部署Metricbeat作为一个<code class="fe nb nc nd mt b">DaemonSet</code>。通过将metricbeat部署为<a class="ae kz" href="https://kubernetes.io/docs/concepts/workloads/controllers/daemonset/" rel="noopener ugc nofollow" target="_blank"> DaemonSet </a>，我们确保在集群的每个节点上都有一个正在运行的metricbeat守护进程。</p><p id="1bd3" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">请注意，在配置中，所有带有<code class="fe nb nc nd mt b">state_</code>前缀的<em class="no">度量集</em>需要<code class="fe nb nc nd mt b">hosts</code>字段指向集群内的<code class="fe nb nc nd mt b">kube-state-metrics</code>服务，而其余的应该指向<code class="fe nb nc nd mt b">kubelet</code>服务。</p><p id="97a9" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">让我们测试一下设置:</p><pre class="lu lv lw lx gt ms mt mu mv aw mw bi"><span id="6e6d" class="la lb it mt b gy mx my l mz na">$ curl localhost:9200/_cat/indices<br/><br/>Handling connection for 9200<br/>green open .kibana_task_manager_1    1 1     2 2     55.5kb  27.6kb<br/>green open .apm-agent-configuration  1 1     0 0       566b    283b<br/>green open ilm-history-1-000001      1 1    18 0     50.9kb  25.4kb<br/>green open .kibana_1                 1 1    77 6      2.2mb   1.1mb<br/>green open metricbeat-7.6.1          1 1    1512060 0 1.7gb 910.5mb</span></pre><p id="e566" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">默认情况下，Metricbeat 的<a class="ae kz" href="https://www.elastic.co/blog/elasticsearch-observability-embracing-prometheus-and-openmetrics-standards-for-metrics" rel="noopener ugc nofollow" target="_blank"> Prometheus模块公开了<code class="fe nb nc nd mt b">/metrics</code>端点，这意味着现有的Prometheus设置也可以收集这些指标。</a></p><h2 id="f432" class="la lb it bd lc ld le dn lf lg lh dp li km lj lk ll kq lm ln lo ku lp lq lr ls bi translated">步骤6:部署Filebeat</h2><pre class="lu lv lw lx gt ms mt mu mv aw mw bi"><span id="deb2" class="la lb it mt b gy mx my l mz na">$ ./elk-setup install filebeat</span><span id="10df" class="la lb it mt b gy nk my l mz na">Release "filebeat-1586246704" has been upgraded. Happy Helming!<br/>NAME: filebeat-1586246704<br/>LAST DEPLOYED: Wed Apr  8 12:48:24 2020<br/>NAMESPACE: log<br/>STATUS: deployed<br/>REVISION: 4<br/>TEST SUITE: None<br/>NOTES:<br/>1. Watch all containers come up.<br/>  $ kubectl get pods --namespace=log -l app=filebeat-1586246704-filebeat -w<br/>Updated filebeat</span></pre><h2 id="eda7" class="la lb it bd lc ld le dn lf lg lh dp li km lj lk ll kq lm ln lo ku lp lq lr ls bi translated">第七步:把所有东西放在一起</h2><p id="b673" class="pw-post-body-paragraph kb kc it kd b ke mm kg kh ki mn kk kl km mo ko kp kq mp ks kt ku mq kw kx ky im bi translated">如果我们检查创建的设置，我们可以检查舵释放状态(为简单起见，一些字段已被删除):</p><pre class="lu lv lw lx gt ms mt mu mv aw mw bi"><span id="47e2" class="la lb it mt b gy mx my l mz na">$ helm ls</span><span id="b137" class="la lb it mt b gy nk my l mz na">NAME          NAMESPACE REVISION    STATUS    CHART   APP VERSION                            <br/>elasticsearch log      1   deployed elasticsearch-7.6.1 7.6.1      <br/>kibana        log      1   deployed kibana-7.6.1        7.6.1      <br/>metricbeat    log      1   deployed metricbeat-7.6.1    7.6.1<br/>filebeat      log      1   deployed filebeat-7.6.1      7.6.1</span></pre><p id="2649" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">要查看关于已创建的Kubernetes资源的详细信息，可以运行以下命令:</p><pre class="lu lv lw lx gt ms mt mu mv aw mw bi"><span id="75a0" class="la lb it mt b gy mx my l mz na">$ helm get manifest &lt;RELEASE-NAME&gt; | kubectl get -f -</span></pre><p id="c1a0" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">样本输出:</p><pre class="lu lv lw lx gt ms mt mu mv aw mw bi"><span id="9b1c" class="la lb it mt b gy mx my l mz na">$ helm get manifest kibana-1585817443 | kubectl get -f -<br/>NAME                               TYPE        CLUSTER-IP    EXTERNAL-IP   PORT(S)    AGE<br/>service/kibana-1585817443-kibana   ClusterIP   10.20.5.20   &lt;none&gt;        5601/TCP   25h</span><span id="14f4" class="la lb it mt b gy nk my l mz na">NAME                                       READY   UP-TO-DATE   AVAILABLE   AGE<br/>deployment.apps/kibana-1585817443-kibana   1/1     1            1           25h</span></pre><h2 id="a30a" class="la lb it bd lc ld le dn lf lg lh dp li km lj lk ll kq lm ln lo ku lp lq lr ls bi translated">步骤9:在Kibana中分析数据</h2><p id="6a81" class="pw-post-body-paragraph kb kc it kd b ke mm kg kh ki mn kk kl km mo ko kp kq mp ks kt ku mq kw kx ky im bi translated">现在我们已经部署了所有组件，在Kibana中，我们可以转到<strong class="kd iu">管理→ Kibana →索引模式</strong>页面，并单击<strong class="kd iu">创建索引模式</strong>。Kibana将自动识别和显示Metricbeat指数。</p><p id="920c" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">输入'<em class="no"> metricbeat-* </em>'并在下一步选择<em class="no"> @timestamp </em>字段，以完成在Kibana中创建索引模式。</p><p id="51ce" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">跳到探索页面。您将看到从Kubernetes集群中收集的所有指标(按Metricbeat显示):</p><figure class="lu lv lw lx gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi np"><img src="../Images/eaa04897687438a999388c20f7b39b3c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Iaz--4sNtIwy89YPSuqExQ.png"/></div></div></figure><p id="fb9f" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">如果您浏览Kibana UI，您可以探索它提供的各种字段、仪表板和统计数据。</p><p id="a9e7" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">跳转到机器学习选项卡并选择<code class="fe nb nc nd mt b">metricbeat-*</code>索引来可视化我们之前配置的大量Kubernetes ans系统指标。</p><figure class="lu lv lw lx gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi nq"><img src="../Images/faf207c5be74cacc134928d47a652dbf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*tPLVT2YddFqgnOvnfq70eg.png"/></div></div></figure><p id="2cf1" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated"><a class="ae kz" href="http://localhost:5601/app/infra#/infrastructure/inventory" rel="noopener ugc nofollow" target="_blank">http://localhost:5601/app/infra #/infra/inventory</a></p><p id="82f1" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">检查基础架构清单并选择感兴趣的资源，以探索其指标并查看其日志文件。</p><figure class="lu lv lw lx gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi nr"><img src="../Images/51677c1cdac54edbc634efd77a65a97e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*9iSJzatLnGoavbMd.gif"/></div></div><figcaption class="ng nh gj gh gi ni nj bd b be z dk translated">Kubernetes服务发现</figcaption></figure><p id="9bdf" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated"><em class="no">关于基巴纳仪表盘的一句话:</em></p><p id="a155" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">Kubernetes的Kibana仪表板非常有用，因为它们让我们可以很好地概述我们的Kubernetes集群及其组件。在<a class="ae kz" href="https://demo.elastic.co/app/kibana#/dashboard/19e7fae0-92a6-11e8-8fa2-3d5f811fbd0f?_g=()&amp;_a=(description:'Beats%20modules%20gallery,%20a%20jumping%20point%20to%20modules%20dashboards%20available%20here.',filters:!(),fullScreenMode:!f,options:(darkTheme:!f,hidePanelTitles:!f,useMargins:!t),panels:!((embeddableConfig:(title:APACHE),gridData:(h:14,i:'1',w:7,x:21,y:12),id:'13330b20-5496-11e8-962d-c3a08979c250',panelIndex:'1',title:APACHE,type:visualization,version:'7.5.1'),(embeddableConfig:(title:MONGODB),gridData:(h:14,i:'3',w:7,x:7,y:26),id:'18557a10-5497-11e8-962d-c3a08979c250',panelIndex:'3',title:MONGODB,type:visualization,version:'7.5.1'),(embeddableConfig:(title:KUBERNETES),gridData:(h:14,i:'4',w:7,x:7,y:12),id:e44e9430-5497-11e8-962d-c3a08979c250,panelIndex:'4',title:KUBERNETES,type:visualization,version:'7.5.1'),(embeddableConfig:(title:DOCKER),gridData:(h:14,i:'5',w:7,x:14,y:12),id:c43e1d00-5497-11e8-962d-c3a08979c250,panelIndex:'5',title:DOCKER,type:visualization,version:'7.5.1'),(embeddableConfig:(title:NGINX),gridData:(h:14,i:'6',w:7,x:28,y:12),id:a2fa9cb0-549a-11e8-962d-c3a08979c250,panelIndex:'6',title:NGINX,type:visualization,version:'7.5.1'),(embeddableConfig:(title:MYSQL),gridData:(h:14,i:'9',w:7,x:35,y:26),id:'5617e230-549b-11e8-962d-c3a08979c250',panelIndex:'9',title:MYSQL,type:visualization,version:'7.5.1'),(embeddableConfig:(title:POSTGRESQL),gridData:(h:14,i:'11',w:7,x:21,y:26),id:cb62a340-59d7-11e8-962d-c3a08979c250,panelIndex:'11',title:POSTGRESQL,type:visualization,version:'7.5.1'),(embeddableConfig:(title:KAFKA),gridData:(h:14,i:'13',w:7,x:14,y:26),id:d3451e30-5496-11e8-962d-c3a08979c250,panelIndex:'13',title:KAFKA,type:visualization,version:'7.5.1'),(embeddableConfig:(title:REDIS),gridData:(h:14,i:'15',w:7,x:0,y:26),id:'0e0eb8b0-549b-11e8-962d-c3a08979c250',panelIndex:'15',title:REDIS,type:visualization,version:'7.5.1'),(embeddableConfig:(title:'NETWORK%20DATA'),gridData:(h:14,i:'16',w:7,x:35,y:12),id:'1cbc8b50-6259-11e8-892f-19d69b635064',panelIndex:'16',title:'NETWORK%20DATA',type:visualization,version:'7.5.1'),(embeddableConfig:(title:GOLANG),gridData:(h:14,i:'17',w:7,x:28,y:26),id:ce485b60-6259-11e8-892f-19d69b635064,panelIndex:'17',title:GOLANG,type:visualization,version:'7.5.1'),(embeddableConfig:(title:'SYSTEM%20METRICS'),gridData:(h:14,i:'18',w:6,x:42,y:26),id:a14f2f20-625a-11e8-892f-19d69b635064,panelIndex:'18',title:'SYSTEM%20METRICS',type:visualization,version:'7.5.1'),(embeddableConfig:(),gridData:(h:12,i:'26',w:24,x:24,y:40),id:'55c90dc0-9287-11e8-8fa2-3d5f811fbd0f',panelIndex:'26',type:visualization,version:'7.5.1'),(embeddableConfig:(),gridData:(h:12,i:'27',w:24,x:0,y:40),id:'10553fb0-9288-11e8-8fa2-3d5f811fbd0f',panelIndex:'27',type:visualization,version:'7.5.1'),(embeddableConfig:(title:Welcome),gridData:(h:12,i:'28',w:24,x:0,y:0),id:ee02b2d0-92aa-11e8-8fa2-3d5f811fbd0f,panelIndex:'28',title:Welcome,type:visualization,version:'7.5.1'),(embeddableConfig:(),gridData:(h:12,i:'29',w:24,x:24,y:0),id:df63c620-9407-11e8-8fa2-3d5f811fbd0f,panelIndex:'29',type:visualization,version:'7.5.1'),(embeddableConfig:(title:AZURE),gridData:(h:14,i:'33',w:7,x:0,y:12),id:'04704970-241d-11e9-9985-f1ba5bcab6e5',panelIndex:'33',title:AZURE,type:visualization,version:'7.5.1'),(embeddableConfig:(title:Prometheus),gridData:(h:14,i:'34',w:6,x:42,y:12),id:'5f886b70-dfa3-11e9-b69e-8b75a9a3572b',panelIndex:'34',title:Prometheus,type:visualization,version:'7.5.1')),query:(language:lucene,query:''),timeRestore:!f,title:'Welcome%20-%20Beats%20Modules',viewMode:view)" rel="noopener ugc nofollow" target="_blank"> Elastic演示页面</a>上有一个非常好的仪表板浏览器。</p><p id="8719" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">此时，默认情况下，的弹性舵图表不启用Filebeat和Metricbeat控制面板。如何实现这一点，可以在官方文档中找到，并且需要对default values.yaml文件进行一些添加:<br/> <a class="ae kz" href="https://www.elastic.co/guide/en/beats/metricbeat/current/configuration-dashboards.html" rel="noopener ugc nofollow" target="_blank"> Metricbeat仪表板设置</a> <a class="ae kz" href="https://www.elastic.co/guide/en/beats/filebeat/current/configuration-dashboards.html" rel="noopener ugc nofollow" target="_blank"> <br/> Filebeat仪表板设置</a></p><h1 id="68c6" class="ns lb it bd lc nt nu nv lf nw nx ny li nz oa ob ll oc od oe lo of og oh lr oi bi translated">最后的话</h1><p id="8302" class="pw-post-body-paragraph kb kc it kd b ke mm kg kh ki mn kk kl km mo ko kp kq mp ks kt ku mq kw kx ky im bi translated">您已经看到了使用官方的Elastic Helm图表在Kubernetes上部署Elastic Stack (Elasticsearch、Kibana、Metricbeat、Filebeat)的简单设置。</p><p id="9d2e" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">既然我们已经在集群上安装并运行了所有这些组件，就有无限的可能进行潜在的增强:高可用性和高性能集群配置、定制的保留策略、安全性增强、用户可访问性改进等等。您可以自由探索无限的选项，并以同样的方式进行试验，就好像这是在本地托管的虚拟机或云中的某个地方进行的传统部署一样。</p><p id="eb2f" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated"><strong class="kd iu">资源</strong></p><div class="oj ok gp gr ol om"><a href="https://github.com/elastic/helm-charts" rel="noopener  ugc nofollow" target="_blank"><div class="on ab fo"><div class="oo ab op cl cj oq"><h2 class="bd iu gy z fp or fr fs os fu fw is bi translated">弹性/舵图</h2><div class="ot l"><h3 class="bd b gy z fp or fr fs os fu fw dk translated">此功能处于测试阶段，可能会有变化。设计和代码没有官方的GA特性成熟…</h3></div><div class="ou l"><p class="bd b dl z fp or fr fs os fu fw dk translated">github.com</p></div></div><div class="ov l"><div class="ow l ox oy oz ov pa jz om"/></div></div></a></div><div class="oj ok gp gr ol om"><a href="https://www.elastic.co/guide/index.html" rel="noopener  ugc nofollow" target="_blank"><div class="on ab fo"><div class="oo ab op cl cj oq"><h2 class="bd iu gy z fp or fr fs os fu fw is bi translated">弹性堆栈和产品文档</h2><div class="ot l"><h3 class="bd b gy z fp or fr fs os fu fw dk translated">弹性公共模式(ECS)参考[1.5] -其他版本</h3></div><div class="ou l"><p class="bd b dl z fp or fr fs os fu fw dk translated">www.elastic.co</p></div></div><div class="ov l"><div class="pb l ox oy oz ov pa jz om"/></div></div></a></div><div class="oj ok gp gr ol om"><a href="https://www.guru99.com/elk-stack-tutorial.html" rel="noopener  ugc nofollow" target="_blank"><div class="on ab fo"><div class="oo ab op cl cj oq"><h2 class="bd iu gy z fp or fr fs os fu fw is bi translated">ELK Stack教程:学习Elasticsearch、Logstash和Kibana</h2><div class="ot l"><h3 class="bd b gy z fp or fr fs os fu fw dk translated">ELK Stack是三个开源产品的集合——elastic search、Logstash和Kibana。他们都是…</h3></div><div class="ou l"><p class="bd b dl z fp or fr fs os fu fw dk translated">www.guru99.com</p></div></div><div class="ov l"><div class="pc l ox oy oz ov pa jz om"/></div></div></a></div></div></div>    
</body>
</html>