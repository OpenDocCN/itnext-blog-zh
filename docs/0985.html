<html>
<head>
<title>Building a “Serverless” RESTful API with Cloud Functions, Firestore and Express</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用云功能Firestore和Express构建一个“无服务器”RESTful API</h1>
<blockquote>原文：<a href="https://itnext.io/building-a-serverless-restful-api-with-cloud-functions-firestore-and-express-f917a305d4e6?source=collection_archive---------0-----------------------#2018-06-28">https://itnext.io/building-a-serverless-restful-api-with-cloud-functions-firestore-and-express-f917a305d4e6?source=collection_archive---------0-----------------------#2018-06-28</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div class="gh gi jn"><img src="../Images/4dc7833d1346e70ae0204383c6627d1b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1276/format:webp/1*uB2sSn7mEP_jT1-IuxlR4g.jpeg"/></div></figure><p id="00d7" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">很明显，它运行在地球上某个地方的“a”服务器上；然而，好处是您不必配置或维护它。</p><p id="0647" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">我最近做了一个关于如何构建RESTful HTTP接口的练习，这让我很感兴趣，我可以尝试构建一个临时的RESTful API来测试这个概念。幸运的是，我正在从事几个使用Firebase云功能和云Firestore的项目。完全有可能创建这样的端点用于测试目的，甚至是一个完整的工作RESTful API项目。谁知道呢？！</p><p id="fb63" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">因此，在这个项目中，我将使用<strong class="jw ir"> Firebase云功能、Firebase托管、云Firestore(数据库)和TypeScript。</strong>对，你没看错，云函数确实支持TypeScript！这意味着您可以在编写函数时利用ES6+。</p><p id="ba32" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">你可以遵循这个指导或者检查这个项目的git库。</p><p id="c979" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">https://github.com/dalenguyen/serverless-rest-api<a class="ae ks" href="https://github.com/dalenguyen/serverless-rest-api" rel="noopener ugc nofollow" target="_blank"/></p><p id="c3fb" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">作为一个例子，我将使用这个API来管理联系人信息。</p><p id="ba6f" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated"><strong class="jw ir">第一步:准备好你的firebase项目</strong></p><p id="7ae1" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">嗯，你需要创建一个<a class="ae ks" href="https://firebase.google.com/" rel="noopener ugc nofollow" target="_blank"> firebase项目</a>来使用。记得选择Firestore作为您的数据库。</p><figure class="ku kv kw kx gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="ky kz di la bf lb"><div class="gh gi kt"><img src="../Images/7a6fc7f15707c58976c392d75b77ff9c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*e9-wrGfw0X80gmgVNypJ_Q.png"/></div></div></figure><p id="c25a" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">这些规则对公众开放。在投入生产之前，您需要<a class="ae ks" rel="noopener ugc nofollow" target="_blank" href="/setting-up-cloud-firestore-security-rules-1ad24438805a">实现firestore </a>的安全性。</p><p id="a801" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated"><strong class="jw ir">步骤2:在本地机器上启动Firebase托管和功能</strong></p><p id="a150" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">在开始之前，你需要安装NPM认为firebase-tools</p><pre class="ku kv kw kx gt lc ld le lf aw lg bi"><span id="23ad" class="lh li iq ld b gy lj lk l ll lm">npm install -g firebase-tools</span></pre><p id="f3cc" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">之后，您登录并初始化firebase项目</p><pre class="ku kv kw kx gt lc ld le lf aw lg bi"><span id="48a3" class="lh li iq ld b gy lj lk l ll lm">firebase login<br/>firebase init</span></pre><p id="5b60" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">记得检查功能和主机。实现托管的好处是您将有一个自定义的API项目URL。</p><figure class="ku kv kw kx gt jr gh gi paragraph-image"><div class="gh gi ln"><img src="../Images/ad1e78a28f54b68dd11cc8096969ffd4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1048/format:webp/1*-DD_znpVFwhSy6FvfIBJjw.png"/></div></figure><p id="d814" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">请选择<strong class="jw ir">打字稿</strong>作为编写函数的语言。如果你愿意，你可以选择JavaScript。</p><p id="7388" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated"><strong class="jw ir">步骤3:安装软件包依赖关系</strong></p><p id="4418" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">这些包将位于functions文件夹中</p><pre class="ku kv kw kx gt lc ld le lf aw lg bi"><span id="04c6" class="lh li iq ld b gy lj lk l ll lm">cd functions<br/>npm install --save express body-parser firebase-functions-helper</span></pre><p id="e522" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated"><a class="ae ks" href="https://www.npmjs.com/package/firebase-functions-helper" rel="noopener ugc nofollow" target="_blank">firebase-functions-helper</a>是我在使用Cloud Firestore时编写的包。如果你愿意，可以使用<a class="ae ks" href="https://firebase.google.com/docs/firestore/quickstart" rel="noopener ugc nofollow" target="_blank">原生向导</a>。</p><div class="lo lp gp gr lq lr"><a href="https://www.npmjs.com/package/firebase-functions-helper" rel="noopener  ugc nofollow" target="_blank"><div class="ls ab fo"><div class="lt ab lu cl cj lv"><h2 class="bd ir gy z fp lw fr fs lx fu fw ip bi translated">消防基地-功能-助手</h2><div class="ly l"><h3 class="bd b gy z fp lw fr fs lx fu fw dk translated">用于Firebase云函数的辅助NPM包</h3></div><div class="lz l"><p class="bd b dl z fp lw fr fs lx fu fw dk translated">www.npmjs.com</p></div></div><div class="ma l"><div class="mb l mc md me ma mf js lr"/></div></div></a></div><p id="8ebf" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">第四步:编写你的函数</p><p id="67e0" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">功能逻辑位于<strong class="jw ir"> functions/src/index.ts </strong></p><p id="ccea" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">您首先需要导入必要的包</p><pre class="ku kv kw kx gt lc ld le lf aw lg bi"><span id="e84b" class="lh li iq ld b gy lj lk l ll lm">import * as functions from 'firebase-functions';</span><span id="6b81" class="lh li iq ld b gy mg lk l ll lm">import * as admin from 'firebase-admin';<br/>import * as firebaseHelper from 'firebase-functions-helper';<br/>import * as express from 'express';<br/>import * as bodyParser from "body-parser";</span><span id="3c79" class="lh li iq ld b gy mg lk l ll lm">admin.initializeApp(functions.config().firebase);</span><span id="c19d" class="lh li iq ld b gy mg lk l ll lm">const db = admin.firestore();</span><span id="b00c" class="lh li iq ld b gy mg lk l ll lm">const app = express();<br/>const main = express();</span><span id="dd7e" class="lh li iq ld b gy mg lk l ll lm">const contactsCollection = 'contacts';</span><span id="6cb7" class="lh li iq ld b gy mg lk l ll lm">main.use('/api/v1', app);<br/>main.use(bodyParser.json());<br/>main.use(bodyParser.urlencoded({ extended: false }));</span><span id="b6b6" class="lh li iq ld b gy mg lk l ll lm">// webApi is your functions name, and you will pass main as <br/>// a parameter<br/>export const webApi = functions.https.onRequest(main);</span></pre><p id="a48c" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">在这个文件中，我们还为API创建了CRUD路径</p><pre class="ku kv kw kx gt lc ld le lf aw lg bi"><span id="6889" class="lh li iq ld b gy lj lk l ll lm">// Add new contact<br/>app.post('/contacts', async (req, res) =&gt; {<br/>    try {<br/>        const contact: Contact = {<br/>            firstName: req.body['firstName'],<br/>            lastName: req.body['lastName'],<br/>            email: req.body['email']<br/>        }</span><span id="ced0" class="lh li iq ld b gy mg lk l ll lm">const newDoc = await firebaseHelper.firestore<br/>            .createNewDocument(db, contactsCollection, contact);<br/>        res.status(201).send(`Created a new contact: ${newDoc.id}`);<br/>    } catch (error) {<br/>        res.status(400).send(`Contact should only contains firstName, lastName and email!!!`)<br/>    }        <br/>})</span><span id="8995" class="lh li iq ld b gy mg lk l ll lm">// Update new contact<br/>app.patch('/contacts/:contactId', async (req, res) =&gt; {<br/>    const updatedDoc = await firebaseHelper.firestore<br/>        .updateDocument(db, contactsCollection, req.params.contactId, req.body);<br/>    res.status(204).send(`Update a new contact: ${updatedDoc}`);<br/>})</span><span id="a13a" class="lh li iq ld b gy mg lk l ll lm">// View a contact<br/>app.get('/contacts/:contactId', (req, res) =&gt; {<br/>    firebaseHelper.firestore<br/>        .getDocument(db, contactsCollection, req.params.contactId)<br/>        .then(doc =&gt; res.status(200).send(doc))<br/>        .catch(error =&gt; res.status(400).send(`Cannot get contact: ${error}`));<br/>})</span><span id="a9b7" class="lh li iq ld b gy mg lk l ll lm">// View all contacts<br/>app.get('/contacts', (req, res) =&gt; {<br/>    firebaseHelper.firestore<br/>        .backup(db, contactsCollection)<br/>        .then(data =&gt; res.status(200).send(data))<br/>        .catch(error =&gt; res.status(400).send(`Cannot get contacts: ${error}`));<br/>})</span><span id="cae1" class="lh li iq ld b gy mg lk l ll lm">// Delete a contact <br/>app.delete('/contacts/:contactId', async (req, res) =&gt; {<br/>    const deletedContact = await firebaseHelper.firestore<br/>        .deleteDocument(db, contactsCollection, req.params.contactId);<br/>    res.status(204).send(`Contact is deleted: ${deletedContact}`);<br/>})</span></pre><p id="43bb" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated"><strong class="jw ir">步骤5:部署您的主机和功能</strong></p><p id="6b28" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">在部署到firebase之前，我们需要对firebase.json进行一些修改</p><pre class="ku kv kw kx gt lc ld le lf aw lg bi"><span id="4b36" class="lh li iq ld b gy lj lk l ll lm">{<br/>  "functions": {<br/>    "predeploy": [<br/>      "npm --prefix ./functions/ run lint",<br/>      "npm --prefix ./functions/ run build"<br/>    ]<br/>  },<br/>  "hosting": {<br/>    "public": "public",<br/>    "ignore": [<br/>      "firebase.json",<br/>      "**/.*",<br/>      "**/node_modules/**"<br/>    ],<br/><strong class="ld ir">    "rewrites": [<br/>      {<br/>        "source": "/api/v1/**",<br/>        "function": "webApi"<br/>      }<br/>    ]</strong><br/>  }<br/>}</span></pre><p id="78a7" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">我们将把函数映射到URL，因此webApi将触发我们调用URL。(<em class="mh">您的项目中的URL不同</em></p><pre class="ku kv kw kx gt lc ld le lf aw lg bi"><span id="33bd" class="lh li iq ld b gy lj lk l ll lm"><a class="ae ks" href="https://serverless-api-dn.firebaseapp.com/api/v1/**" rel="noopener ugc nofollow" target="_blank">https://serverless-api-dn.firebaseapp.com/api/v1/**</a></span></pre><p id="698a" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">现在，您可以部署到firebase</p><pre class="ku kv kw kx gt lc ld le lf aw lg bi"><span id="30e4" class="lh li iq ld b gy lj lk l ll lm">firebase deploy</span></pre><p id="8fdf" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">这个命令将把主机和功能部署到firebase。下一次，您只需要在对路由进行一些更改时部署功能。</p><pre class="ku kv kw kx gt lc ld le lf aw lg bi"><span id="0244" class="lh li iq ld b gy lj lk l ll lm">firebase deploy --only functions</span></pre><p id="391f" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated"><strong class="jw ir">步骤6:测试你的API项目</strong></p><p id="d0a0" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">我将使用<a class="ae ks" href="https://www.getpostman.com/" rel="noopener ugc nofollow" target="_blank"> Postman </a>来测试API。首先，我们将通过发送POST请求和正文来创建联系人。</p><figure class="ku kv kw kx gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="ky kz di la bf lb"><div class="gh gi mi"><img src="../Images/5d51d42a2119b898e3f1548d9a13bbe1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1354/format:webp/1*EqCRJZvsTs11uNEe9vAykA.png"/></div></div></figure><p id="b765" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">查看具有获取请求的所有联系人</p><figure class="ku kv kw kx gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="ky kz di la bf lb"><div class="gh gi mj"><img src="../Images/17da82293f2fe3ce71886f219ffcb188.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*DnjBIO4KCNHluWh5s0I_Ww.png"/></div></div></figure><p id="d267" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">我们可以传递联系人Id来只查看一个联系人</p><figure class="ku kv kw kx gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="ky kz di la bf lb"><div class="gh gi mk"><img src="../Images/c3b3661611af690baf6bfc098298f49e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*YKWcMFh3UKuG_OMRPrZr4w.png"/></div></div></figure><p id="a5c7" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">通过发送补丁请求来更新我的电子邮件地址</p><figure class="ku kv kw kx gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="ky kz di la bf lb"><div class="gh gi ml"><img src="../Images/352cce0fc14713c014b19f801b6a20b2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*0QRs2xjGO-q7zekKZp4OPg.png"/></div></div></figure><p id="f0c9" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">最后，我们可以通过删除请求删除联系人</p><figure class="ku kv kw kx gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="ky kz di la bf lb"><div class="gh gi mm"><img src="../Images/20a524bfdf06304b106cd03c77e9bcf1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*7nQwTtCSY64PtZ1FQcBO1g.png"/></div></div></figure><p id="f29a" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">有一些响应处理需要改进；然而，我们现在有了一个可以试验的工作API。</p><p id="0d92" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">如果你对构建API感兴趣，你可以看看我的另一篇文章:</p><p id="5349" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated"><a class="ae ks" rel="noopener ugc nofollow" target="_blank" href="/building-restful-web-apis-with-node-js-express-mongodb-and-typescript-part-1-2-195bdaf129cf">用Node.js、Express、MongoDB和TypeScript构建RESTful Web APIs】</a></p><p id="6b8d" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated"><a class="ae ks" href="https://twitter.com/dale_nguyen" rel="noopener ugc nofollow" target="_blank"> <strong class="jw ir">在Twitter上关注我</strong> </a>了解Angular、JavaScript &amp; WebDevelopment的最新内容👐</p></div></div>    
</body>
</html>