<html>
<head>
<title>Microk8s puts up its Istio and sails away</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Microk8s竖起桅杆，扬帆远航</h1>
<blockquote>原文：<a href="https://itnext.io/microk8s-puts-up-its-istio-and-sails-away-104c5a16c3c2?source=collection_archive---------0-----------------------#2018-10-15">https://itnext.io/microk8s-puts-up-its-istio-and-sails-away-104c5a16c3c2?source=collection_archive---------0-----------------------#2018-10-15</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="d0ff" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">作为企业级软件，Istio几乎会立刻给你留下深刻印象。与其说是因为它引入了复杂性，不如说是因为它为您的服务网格增加了一些功能。必备功能打包在一个连贯的框架中:</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="ks kt di ku bf kv"><div class="gh gi km"><img src="../Images/1432acbf8ae74d3acf41cde9b9533bef.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*mjVJ9t8HBvhPW1VaqHhQ3w.png"/></div></div></figure><ul class=""><li id="9fe1" class="ky kz iq jp b jq jr ju jv jy la kc lb kg lc kk ld le lf lg bi translated">交通管理</li><li id="9121" class="ky kz iq jp b jq lh ju li jy lj kc lk kg ll kk ld le lf lg bi translated">安全策略</li><li id="0628" class="ky kz iq jp b jq lh ju li jy lj kc lk kg ll kk ld le lf lg bi translated">遥感勘测</li><li id="ac72" class="ky kz iq jp b jq lh ju li jy lj kc lk kg ll kk ld le lf lg bi translated">性能调整</li></ul><p id="4ef1" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">由于microk8s将自己定位为本地Kubernetes集群开发人员的原型，所以毫不奇怪Istio的部署变得非常简单。让我们从microk8s部署本身开始:</p><pre class="kn ko kp kq gt lm ln lo lp aw lq bi"><span id="832a" class="lr ls iq ln b gy lt lu l lv lw">&gt; sudo snap install microk8s --classic</span></pre><p id="91ee" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">Istio部署可用于:</p><pre class="kn ko kp kq gt lm ln lo lp aw lq bi"><span id="a674" class="lr ls iq ln b gy lt lu l lv lw">&gt; microk8s.enable istio</span></pre><p id="8129" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在我们需要回答一个问题。我们是否希望<a class="ae kl" href="https://istio.io/docs/concepts/security/#mutual-tls-authentication" rel="noopener ugc nofollow" target="_blank">在边车</a>之间实施相互TLS认证？Istio为您的服务放置一个代理，以便控制路由、安全等。如果我们知道我们有一个非Istio和Istio支持服务的混合部署，我们宁愿不实施相互TLS:</p><pre class="kn ko kp kq gt lm ln lo lp aw lq bi"><span id="9759" class="lr ls iq ln b gy lt lu l lv lw">&gt; microk8s.enable istio<br/>Enabling Istio<br/>Enabling DNS<br/>Applying manifest<br/>service/kube-dns created<br/>serviceaccount/kube-dns created<br/>configmap/kube-dns created<br/>deployment.extensions/kube-dns created<br/>Restarting kubelet<br/>DNS is enabled<br/>Enforce mutual TLS authentication (<a class="ae kl" href="https://bit.ly/2KB4j04" rel="noopener ugc nofollow" target="_blank">https://bit.ly/2KB4j04</a>) between sidecars? If unsure, choose N. (y/N): y</span></pre><p id="413a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">信不信由你，我们已经完成了，Istio v1.0服务正在建立，您可以通过以下方式检查部署进度:</p><pre class="kn ko kp kq gt lm ln lo lp aw lq bi"><span id="ca46" class="lr ls iq ln b gy lt lu l lv lw">&gt; watch microk8s.kubectl get all --all-namespaces</span></pre><p id="496a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">为了您的方便，我们将<code class="fe lx ly lz ln b">istioctl</code>打包在microk8s中:</p><pre class="kn ko kp kq gt lm ln lo lp aw lq bi"><span id="68d9" class="lr ls iq ln b gy lt lu l lv lw">&gt; microk8s.istioctl get all --all-namespaces<br/>NAME                          KIND                                      NAMESPACE      AGE<br/>grafana-ports-mtls-disabled   Policy.authentication.istio.io.v1alpha1   istio-system   2m</span><span id="e880" class="lr ls iq ln b gy ma lu l lv lw">DESTINATION-RULE NAME   HOST                                             SUBSETS   NAMESPACE      AGE<br/>istio-policy            istio-policy.istio-system.svc.cluster.local                istio-system   3m<br/>istio-telemetry         istio-telemetry.istio-system.svc.cluster.local             istio-system   3m</span><span id="18a5" class="lr ls iq ln b gy ma lu l lv lw">GATEWAY NAME                      HOSTS     NAMESPACE      AGE<br/>istio-autogenerated-k8s-ingress   *         istio-system   3m</span></pre><p id="866d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">不要被服务和部署的数量吓到，一切都在<code class="fe lx ly lz ln b">istio-system</code>名称空间之下。我们准备开始探索了！</p></div><div class="ab cl mb mc hu md" role="separator"><span class="me bw bk mf mg mh"/><span class="me bw bk mf mg mh"/><span class="me bw bk mf mg"/></div><div class="ij ik il im in"><h1 id="664e" class="mi ls iq bd mj mk ml mm mn mo mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne bi translated">演示时间！</h1><p id="5dce" class="pw-post-body-paragraph jn jo iq jp b jq nf js jt ju ng jw jx jy nh ka kb kc ni ke kf kg nj ki kj kk ij bi translated">Istio需要在你的部署舱中加入边车。在microk8s中，支持自动注入，所以您唯一需要做的就是用<code class="fe lx ly lz ln b">istion-injection=enabled</code>标记您将要使用的名称空间:</p><pre class="kn ko kp kq gt lm ln lo lp aw lq bi"><span id="8019" class="lr ls iq ln b gy lt lu l lv lw">&gt; microk8s.kubectl label namespace default istio-injection=enabled</span></pre><p id="9a7e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在让我们从1.0 Istio版本中抓取<code class="fe lx ly lz ln b">bookinfo</code>示例并应用它:</p><pre class="kn ko kp kq gt lm ln lo lp aw lq bi"><span id="478b" class="lr ls iq ln b gy lt lu l lv lw">&gt; wget <a class="ae kl" href="https://raw.githubusercontent.com/istio/istio/release-1.0/samples/bookinfo/platform/kube/bookinfo.yaml" rel="noopener ugc nofollow" target="_blank">https://raw.githubusercontent.com/istio/istio/release-1.0/samples/bookinfo/platform/kube/bookinfo.yaml</a><br/>&gt; microk8s.kubectl create -f bookinfo.yaml</span></pre><p id="b577" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">以下服务将很快推出:</p><pre class="kn ko kp kq gt lm ln lo lp aw lq bi"><span id="ca2c" class="lr ls iq ln b gy lt lu l lv lw">&gt; microk8s.kubectl get svc<br/>NAME          TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)    details       ClusterIP   10.152.183.33    &lt;none&gt;        9080/TCP   kubernetes    ClusterIP   10.152.183.1     &lt;none&gt;        443/TCP    productpage   ClusterIP   10.152.183.59    &lt;none&gt;        9080/TCP   ratings       ClusterIP   10.152.183.124   &lt;none&gt;        9080/TCP   reviews       ClusterIP   10.152.183.9     &lt;none&gt;        9080/TCP</span></pre><p id="6379" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们可以使用他们拥有的集群IP来访问服务；例如，我们可以通过将浏览器指向<code class="fe lx ly lz ln b">10.152.183.59:9080</code>来访问上面示例中的<code class="fe lx ly lz ln b">productpage</code>。但是让我们按照规则来玩，并且<a class="ae kl" href="https://istio.io/docs/examples/bookinfo/#determining-the-ingress-ip-and-port" rel="noopener ugc nofollow" target="_blank">遵循关于通过节点端口公开服务的官方说明</a>:</p><pre class="kn ko kp kq gt lm ln lo lp aw lq bi"><span id="f4de" class="lr ls iq ln b gy lt lu l lv lw">&gt; wget <a class="ae kl" href="https://raw.githubusercontent.com/istio/istio/release-1.0/samples/bookinfo/networking/bookinfo-gateway.yaml" rel="noopener ugc nofollow" target="_blank">https://raw.githubusercontent.com/istio/istio/release-1.0/samples/bookinfo/networking/bookinfo-gateway.yaml</a><br/>&gt; microk8s.kubectl create -f bookinfo-gateway.yaml</span></pre><p id="5d6d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">为了通过入口到达<code class="fe lx ly lz ln b">productpage</code>,我们无耻地复制了示例指令:</p><pre class="kn ko kp kq gt lm ln lo lp aw lq bi"><span id="dac3" class="lr ls iq ln b gy lt lu l lv lw">&gt; microk8s.kubectl -n istio-system get service istio-ingressgateway -o jsonpath='{.spec.ports[?(@.name=="http2")].nodePort}'<br/>31380</span></pre><p id="a056" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们的节点是本地主机，因此我们可以将浏览器指向<a class="ae kl" href="http://localhost:31380/productpage" rel="noopener ugc nofollow" target="_blank">http://localhost:31380/product page</a></p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="ks kt di ku bf kv"><div class="gh gi nk"><img src="../Images/6bf4a05db713cad9f36881952697f771.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*UCUOuPZ_uJGXkQqx8fqH0A.png"/></div></div></figure><h1 id="c002" class="mi ls iq bd mj mk nl mm mn mo nm mq mr ms nn mu mv mw no my mz na np nc nd ne bi translated">给我看一些图表！</h1><p id="5713" class="pw-post-body-paragraph jn jo iq jp b jq nf js jt ju ng jw jx jy nh ka kb kc ni ke kf kg nj ki kj kk ij bi translated">当然，在博客文章中，图表看起来很漂亮，所以，给你。</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="ks kt di ku bf kv"><div class="gh gi nq"><img src="../Images/1bda4827e4db5f4aa0fb69857bb44bd6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*E3DTv5SpWhoIQj9wt_umeA.png"/></div></div><figcaption class="nr ns gj gh gi nt nu bd b be z dk translated">格拉夫纳服务</figcaption></figure><p id="9d95" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">您需要获取Grafana服务的集群IP:</p><pre class="kn ko kp kq gt lm ln lo lp aw lq bi"><span id="f073" class="lr ls iq ln b gy lt lu l lv lw">microk8s.kubectl -n istio-system get svc grafana</span></pre><p id="1e0e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">普罗米修斯也可用同样的方式。</p><pre class="kn ko kp kq gt lm ln lo lp aw lq bi"><span id="231a" class="lr ls iq ln b gy lt lu l lv lw">microk8s.kubectl -n istio-system get svc prometheus</span></pre><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="ks kt di ku bf kv"><div class="gh gi nv"><img src="../Images/a5959e47c5267d1c6040361a6c450f8a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*fB_vY55filFt9GDBg0T_8w.png"/></div></div><figcaption class="nr ns gj gh gi nt nu bd b be z dk translated">普罗米修斯服务</figcaption></figure><p id="2c86" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">对于痕迹，您需要查看<code class="fe lx ly lz ln b">jaeger-query</code>。</p><pre class="kn ko kp kq gt lm ln lo lp aw lq bi"><span id="3898" class="lr ls iq ln b gy lt lu l lv lw">microk8s.kubectl -n istio-system get service/jaeger-query</span></pre><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="ks kt di ku bf kv"><div class="gh gi nw"><img src="../Images/d339e351f2d4294fb208f7a7c7d0f142.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*SMsnnpCrdDjzg3HIOljETg.png"/></div></div><figcaption class="nr ns gj gh gi nt nu bd b be z dk translated">耶格服务</figcaption></figure><p id="01c5" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">servicegraph端点可用于:</p><pre class="kn ko kp kq gt lm ln lo lp aw lq bi"><span id="5d3c" class="lr ls iq ln b gy lt lu l lv lw">microk8s.kubectl -n istio-system get svc servicegraph</span></pre><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="ks kt di ku bf kv"><div class="gh gi nw"><img src="../Images/c92bf06bb70801494910eb73d8f016cc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*2gQadCMAh-X_6VqATrcYpw.png"/></div></div><figcaption class="nr ns gj gh gi nt nu bd b be z dk translated">服务图表</figcaption></figure><p id="cf9d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我应该就此打住。请访问<a class="ae kl" href="https://istio.io/docs/" rel="noopener ugc nofollow" target="_blank"> Istio文档</a>了解更多关于如何利用Istio所提供服务的详细信息。</p><h1 id="5af7" class="mi ls iq bd mj mk nl mm mn mo nm mq mr ms nn mu mv mw no my mz na np nc nd ne bi translated">这篇文章要保留什么</h1><ul class=""><li id="ce2e" class="ky kz iq jp b jq nf ju ng jy nx kc ny kg nz kk ld le lf lg bi translated">Istio有很大的价值。这是一个为企业准备Kubernetes的框架。</li><li id="8d26" class="ky kz iq jp b jq lh ju li jy lj kc lk kg ll kk ld le lf lg bi translated">Microk8s可以让你快速启动运行。<a class="ae kl" href="https://github.com/ubuntu/microk8s/issues" rel="noopener ugc nofollow" target="_blank">写信给我们</a>告诉我们你想看到的改进。</li><li id="cfd9" class="ky kz iq jp b jq lh ju li jy lj kc lk kg ll kk ld le lf lg bi translated">不要害怕失败。一艘沉船可能比一艘帆船更有价值。</li></ul><h1 id="f89e" class="mi ls iq bd mj mk nl mm mn mo nm mq mr ms nn mu mv mw no my mz na np nc nd ne bi translated">参考</h1><div class="oa ob gp gr oc od"><a href="https://microk8s.io/" rel="noopener  ugc nofollow" target="_blank"><div class="oe ab fo"><div class="of ab og cl cj oh"><h2 class="bd ir gy z fp oi fr fs oj fu fw ip bi translated">microk8s —本地上游kubernetes</h2><div class="ok l"><h3 class="bd b gy z fp oi fr fs oj fu fw dk translated">在您的机器上安装一个本地upstream @kubernetes集群来玩、测试和开发…</h3></div><div class="ol l"><p class="bd b dl z fp oi fr fs oj fu fw dk translated">microk8s.io</p></div></div></div></a></div><div class="oa ob gp gr oc od"><a href="https://istio.io/" rel="noopener  ugc nofollow" target="_blank"><div class="oe ab fo"><div class="of ab og cl cj oh"><h2 class="bd ir gy z fp oi fr fs oj fu fw ip bi translated">伊斯迪奥</h2><div class="ok l"><h3 class="bd b gy z fp oi fr fs oj fu fw dk translated">连接、保护、控制和观察服务。</h3></div><div class="ol l"><p class="bd b dl z fp oi fr fs oj fu fw dk translated">istio.io</p></div></div><div class="om l"><div class="on l oo op oq om or kw od"/></div></div></a></div></div></div>    
</body>
</html>