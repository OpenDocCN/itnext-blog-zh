<html>
<head>
<title>Integrating Auth0 into your Angular applications</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">将Auth0集成到您的Angular应用中</h1>
<blockquote>原文：<a href="https://itnext.io/integrating-auth0-into-your-angular-applications-42fabef31f3e?source=collection_archive---------3-----------------------#2021-05-10">https://itnext.io/integrating-auth0-into-your-angular-applications-42fabef31f3e?source=collection_archive---------3-----------------------#2021-05-10</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="e7ac" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">Auth0为Angular提供了SDK来认证用户，并简单地授权用户访问受保护的API。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi kl"><img src="../Images/d156fc33c6191fb6b5a36146899f40a0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*H0FUZ7BDCiv5AvGDNFS7dw.jpeg"/></div></div><figcaption class="kx ky gj gh gi kz la bd b be z dk translated">图片来自<a class="ae lb" href="https://unsplash.com/photos/SEYO0Botkgc" rel="noopener ugc nofollow" target="_blank">https://unsplash.com/photos/SEYO0Botkgc</a></figcaption></figure><p id="5ce9" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在这篇文章中，我们将创建一个简单的Angular SPA应用程序，并尝试访问我们在上一篇文章中在<a class="ae lb" href="https://hantsy.medium.com/secures-rest-apis-with-spring-security-5-and-auth0-41d579ca1e27" rel="noopener">创建的<em class="lc">后端API </em>。</a></p><p id="cada" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">首先，让我们在Auth0管理控制台中创建新的应用程序。一个应用程序呈现一个OAuth2 <em class="lc">客户端</em>角色，每个客户端应该有一个唯一的客户端id来标识它。</p><p id="adc0" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在仪表板UI中，展开左侧窗格中的<em class="lc">应用程序/应用程序</em>。点击<em class="lc">创建应用</em>按钮，开始创建进程。</p><ul class=""><li id="4699" class="ld le iq jp b jq jr ju jv jy lf kc lg kg lh kk li lj lk ll bi translated">在应用名称中，为这个新的角度应用设置一个名称，例如，我在这里使用了<em class="lc"> spa </em>。</li><li id="c50e" class="ld le iq jp b jq lm ju ln jy lo kc lp kg lq kk li lj lk ll bi translated">然后选择<em class="lc">单页应用</em>。</li><li id="51f0" class="ld le iq jp b jq lm ju ln jy lo kc lp kg lq kk li lj lk ll bi translated">点击<em class="lc">创建</em>按钮。</li></ul><p id="93a1" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">创建完成后，打开<em class="lc">设置</em>页面，您会发现<em class="lc">客户端ID </em>和<em class="lc">客户端机密</em>都在页面中生成。在<em class="lc">应用程序URL</em>部分，将<a class="ae lb" href="http://localhost:4200" rel="noopener ugc nofollow" target="_blank"><em class="lc">http://localhost:4200</em></a>添加到以下字段。</p><ul class=""><li id="b441" class="ld le iq jp b jq jr ju jv jy lf kc lg kg lh kk li lj lk ll bi translated"><em class="lc">允许的回调URL</em></li><li id="0bcc" class="ld le iq jp b jq lm ju ln jy lo kc lp kg lq kk li lj lk ll bi translated"><em class="lc">允许的注销网址</em></li><li id="4323" class="ld le iq jp b jq lm ju ln jy lo kc lp kg lq kk li lj lk ll bi translated"><em class="lc">允许的网络来源</em></li><li id="0ff6" class="ld le iq jp b jq lm ju ln jy lo kc lp kg lq kk li lj lk ll bi translated"><em class="lc">允许原产地(CORS) </em></li></ul><p id="1d54" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在<em class="lc">快速入门</em>选项卡中，Auth0提供了一系列教程，将Auth0与流行的SPA框架进行整合，包括Angular/React/Vue等。</p><p id="bab0" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我遵循了官方的Angular Quickstart教程，但是我根据<a class="ae lb" href="https://angular.io/guide/styleguide" rel="noopener ugc nofollow" target="_blank"> Angular编码风格指南</a>重构了项目文件结构，并从<a class="ae lb" href="https://github.com/hantsy/angular-spring-reactive-sample" rel="noopener ugc nofollow" target="_blank">hantsy/Angular-spring-reactive-sample</a>移植了现有代码，以简化开发工作。最终的源代码可以在我的Github账号下找到。</p><blockquote class="lr ls lt"><p id="71db" class="jn jo lc jp b jq jr js jt ju jv jw jx lu jz ka kb lv kd ke kf lw kh ki kj kk ij bi translated"><em class="iq">关于逐步创建这个示例应用程序的更多细节，请阅读</em> <a class="ae lb" href="https://auth0.com/docs/quickstart/spa/angular" rel="noopener ugc nofollow" target="_blank"> <em class="iq">官方Angular快速入门教程</em> </a> <em class="iq">。</em></p><p id="ccec" class="jn jo lc jp b jq jr js jt ju jv jw jx lu jz ka kb lv kd ke kf lw kh ki kj kk ij bi translated"><em class="iq">关于访问后端API的实现细节，查看</em> <a class="ae lb" href="https://hantsy.medium.com/build-a-reactive-application-with-spring-boot-2-0-and-angular-de0ee5837fed" rel="noopener"> <em class="iq">我在Medium上发表的这篇文章</em> </a> <em class="iq">和这篇旧的</em> <a class="ae lb" href="https://github.com/hantsy/angular2-sample" rel="noopener ugc nofollow" target="_blank"> <em class="iq"> Angular2样例代码</em> </a> <em class="iq">。</em></p></blockquote><p id="9d20" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这里我们要介绍集成Auth0 Angular SDK的细节。</p><p id="cfec" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">安装Auth0 Angular SDK。</p><pre class="km kn ko kp gt lx ly lz ma aw mb bi"><span id="5da2" class="mc md iq ly b gy me mf l mg mh">$ npm i @auth0/auth0-angular</span></pre><p id="47db" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">Auth0 Angular SDK提供了一系列开箱即用的认证相关设施，包括<code class="fe mi mj mk ly b">AuthModule</code>、<code class="fe mi mj mk ly b">AuthService</code>、<code class="fe mi mj mk ly b">AuthGuard</code>和<code class="fe mi mj mk ly b">AuthHttpInterceptor</code>。我们在<a class="ae lb" href="https://github.com/hantsy/angular-spring-reactive-sample" rel="noopener ugc nofollow" target="_blank">hantsy/角弹簧反作用样品</a>中从头开始构建这些组件。</p><p id="be9b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在<em class="lc"> app.module.ts </em>中配置<code class="fe mi mj mk ly b">AuthModule</code>和<code class="fe mi mj mk ly b">AuthHttpInterceptor</code>。</p><pre class="km kn ko kp gt lx ly lz ma aw mb bi"><span id="0d3b" class="mc md iq ly b gy me mf l mg mh">// Import the module from the SDK<br/>import { AuthHttpInterceptor, AuthModule } from '@auth0/auth0-angular';</span><span id="150c" class="mc md iq ly b gy ml mf l mg mh">@NgModule({<br/>  declarations: [AppComponent],<br/>  imports: [<br/>    BrowserModule,<br/>    BrowserAnimationsModule,<br/>    CoreModule,<br/>    SharedModule,<br/>    // Import the module into the application, with configuration<br/>    AuthModule.forRoot({<br/>      domain: 'dev-ese8241b.us.auth0.com',<br/>      clientId: 'xwulkQN219vK2LU9MKowCo0HQLRi0WQU',<br/>      audience: 'https://hantsy.github.io/api',<br/>      scope: 'openid profile email read:posts write:posts delete:posts',<br/>      // The AuthHttpInterceptor configuration<br/>      httpInterceptor: {<br/>        allowedList: [<br/>          '/api/*',<br/>        ],<br/>      },<br/>    }),<br/>    HomeModule,<br/>    AppRoutingModule,<br/>  ],<br/>  providers: [<br/>    {<br/>      provide: HTTP_INTERCEPTORS,<br/>      useClass: AuthHttpInterceptor,<br/>      multi: true,<br/>    },<br/>  ],<br/>  bootstrap: [AppComponent],<br/>})<br/>export class AppModule {}</span></pre><p id="b2a6" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们来看看<code class="fe mi mj mk ly b">AppRoutingModule</code>的内容。在profile模块和admin模块的路径中，添加一个<code class="fe mi mj mk ly b">AuthGuard</code>来确保当前用户已经过身份验证。</p><pre class="km kn ko kp gt lx ly lz ma aw mb bi"><span id="7bdb" class="mc md iq ly b gy me mf l mg mh">import { AuthGuard } from '@auth0/auth0-angular';<br/>//...</span><span id="a014" class="mc md iq ly b gy ml mf l mg mh">const routes: Routes = [<br/>  { path: '', redirectTo: '/home', pathMatch: 'full' },<br/>  {<br/>    path: 'profile',<br/>    loadChildren: () =&gt;<br/>      import('./profile/profile.module').then((m) =&gt; m.ProfileModule),<br/>    canActivate: [AuthGuard],<br/>  },<br/>  {<br/>    path: 'posts',<br/>    loadChildren: () =&gt;<br/>      import('./posts/posts.module').then((m) =&gt; m.PostsModule),<br/>  },<br/>  {<br/>    path: 'admin',<br/>    loadChildren: () =&gt;<br/>      import('./admin/admin.module').then((m) =&gt; m.AdminModule),<br/>    canActivate: [AuthGuard],<br/>  },<br/>  //{ path: '**', component:PageNotFoundComponent}<br/>];</span><span id="b08c" class="mc md iq ly b gy ml mf l mg mh">@NgModule({<br/>  imports: [RouterModule.forRoot(routes)],<br/>  exports: [RouterModule],<br/>})<br/>export class AppRoutingModule {}</span></pre><p id="a61c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">要显示/隐藏登录和注销按钮，插入一个<code class="fe mi mj mk ly b">AuthService</code>并通过其<code class="fe mi mj mk ly b">isAuthenticated</code>方法检测认证状态。</p><pre class="km kn ko kp gt lx ly lz ma aw mb bi"><span id="dabd" class="mc md iq ly b gy me mf l mg mh">export class AuthenticationButtonComponent implements OnInit {<br/>  constructor(public auth: AuthService) {}</span><span id="2aec" class="mc md iq ly b gy ml mf l mg mh">  ngOnInit(): void {}<br/>}</span></pre><p id="5110" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><code class="fe mi mj mk ly b">AuthenticationButtonComponent</code>的模板文件。</p><pre class="km kn ko kp gt lx ly lz ma aw mb bi"><span id="c6a7" class="mc md iq ly b gy me mf l mg mh">&lt;app-login-button *ngIf="(auth.isAuthenticated$ | async) === false"&gt;<br/>&lt;/app-login-button&gt;</span><span id="8fc8" class="mc md iq ly b gy ml mf l mg mh">&lt;app-logout-button *ngIf="auth.isAuthenticated$ | async"&gt;<br/>&lt;/app-logout-button&gt;</span></pre><p id="82b5" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">为了测试应用程序，我们必须在Auth0中添加一些测试用户(您也可以使用<em class="lc">注册</em>表单来注册一个用户)。</p><p id="f4d9" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">转到Auth0管理控制台。展开左侧窗格中的<em class="lc">认证/数据库</em>，我们将在此使用默认的<em class="lc">用户名-密码-认证</em>，单击选项按钮打开<em class="lc">设置</em>页面，确保<em class="lc">需要用户名</em>被选中，我希望使用用户名而不是电子邮件登录。切换到<em class="lc">密码策略</em>选项卡，降低<em class="lc">密码强度</em>，它允许您为您的测试用户创建简单的密码。切换到<em class="lc">应用</em>选项卡，确保您的应用在那里被激活。</p><p id="a339" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在让我们添加一些用户。打开仪表板中的<em class="lc">用户管理/用户</em>。点击<em class="lc">创建用户</em>开始添加新用户。添加以下新用户(用户名/密码/电子邮件)，并为他们分配权限。</p><ul class=""><li id="9173" class="ld le iq jp b jq jr ju jv jy lf kc lg kg lh kk li lj lk ll bi translated">user/password/user@example.com—读:帖子，写:帖子</li><li id="5073" class="ld le iq jp b jq lm ju ln jy lo kc lp kg lq kk li lj lk ll bi translated">admin/password/admin@example.com—读:帖子，写:帖子，删除:帖子</li></ul><p id="5397" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">进入每个用户的用户详情页面，在邮件下，直接将邮件标记为已验证，避免邮件验证。</p><p id="67f8" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在回到您的应用程序，运行以下命令来启动它。</p><pre class="km kn ko kp gt lx ly lz ma aw mb bi"><span id="9b99" class="mc md iq ly b gy me mf l mg mh">$ npm run start</span></pre><p id="4356" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">点击登录按钮显示Auth0登录表单，输入用户/密码登录。</p><p id="41d6" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">导航到<em class="lc">个人资料</em>页面，您将看到类似于以下的屏幕。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi mm"><img src="../Images/9d4a942ec0be297827c82e8620685da4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*WLh-8P7h-HcGfPof.png"/></div></div></figure><p id="7030" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">博客访问我们创建的<em class="lc">后端API </em>。要体验它，请确保后端API正在运行。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi mn"><img src="../Images/df0e1020459a3b22f6d3d9f3f28fec55.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*bQVaA3xTTeGNAZWi.png"/></div></div></figure><p id="136c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">尝试注销，应该会返回到<a class="ae lb" href="http://localhost:4200" rel="noopener ugc nofollow" target="_blank"><em class="lc">http://localhost:4200</em></a>。</p><h2 id="b312" class="mc md iq bd mo mp mq dn mr ms mt dp mu jy mv mw mx kc my mz na kg nb nc nd ne bi translated">从我的Github获取源代码。</h2></div></div>    
</body>
</html>