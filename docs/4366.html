<html>
<head>
<title>Logging service uptime with a custom log4j2 lookup plugin</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用自定义log4j2查找插件记录服务正常运行时间</h1>
<blockquote>原文：<a href="https://itnext.io/logging-service-uptime-with-a-custom-log4j2-lookup-plugin-2e2572246b00?source=collection_archive---------0-----------------------#2020-06-16">https://itnext.io/logging-service-uptime-with-a-custom-log4j2-lookup-plugin-2e2572246b00?source=collection_archive---------0-----------------------#2020-06-16</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/></div><div class="ab cl jn jo hu jp" role="separator"><span class="jq bw bk jr js jt"/><span class="jq bw bk jr js jt"/><span class="jq bw bk jr js"/></div><div class="ij ik il im in"><figure class="jv jw jx jy gt jz gh gi paragraph-image"><div role="button" tabindex="0" class="ka kb di kc bf kd"><div class="gh gi ju"><img src="../Images/203f0d24924f4c14cf0fa38d2af57a19.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*jh3ujWmYKZ00eD-c"/></div></div><figcaption class="kg kh gj gh gi ki kj bd b be z dk translated">由<a class="ae kk" href="https://unsplash.com/@angro?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Antonio Grosz </a>在<a class="ae kk" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄</figcaption></figure><p id="7b2e" class="pw-post-body-paragraph kl km iq kn b ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li ij bi lj translated"><span class="l lk ll lm bm ln lo lp lq lr di"> It </span>了解每个日志消息在服务生命周期的哪个时间点被记录有时很有用，例如，由内存泄漏引起的错误可能仅在服务启动几天后才被记录，而请求延迟警告可能仅在部署后的第一秒/分钟被记录。有趣的是，服务打开所有数据库连接或响应第一次成功的健康检查的速度有多快。一个简单的解决方案可能是在引导数据库中记录时间戳，然后手动计算偏移量。或者在每个日志消息中明确记录正常运行时间。但是这种简单的方法有局限性。手动计算偏移量是一件痛苦的事情。如果您使用<strong class="kn ir"> ELK/Kibana </strong>进行日志发送和搜索，您将无法使用<a class="ae kk" href="https://www.elastic.co/what-is/kibana-alerting" rel="noopener ugc nofollow" target="_blank"> Kibana alerting </a>来创建基于此属性的日志事件警报。显式记录时间戳对第三方库和依赖项不起作用，它们可能会记录重要信息并且不受您的控制。</p><p id="be5c" class="pw-post-body-paragraph kl km iq kn b ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">log4j2查找插件来拯救！正如其<a class="ae kk" href="https://logging.apache.org/log4j/2.0/manual/lookups.html" rel="noopener ugc nofollow" target="_blank">文档</a>所说:</p><blockquote class="ls"><p id="176d" class="lt lu iq bd lv lw lx ly lz ma mb li dk translated"><em class="mc">查找可能是所有插件中最简单的。</em></p></blockquote><p id="b662" class="pw-post-body-paragraph kl km iq kn b ko md kq kr ks me ku kv kw mf ky kz la mg lc ld le mh lg lh li ij bi translated">然而，它的文档不是很有帮助，而且互联网上充满了过时的/令人困惑的例子。</p><p id="7468" class="pw-post-body-paragraph kl km iq kn b ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">在本帖中，我们将:</p><ul class=""><li id="f9ab" class="mi mj iq kn b ko kp ks kt kw mk la ml le mm li mn mo mp mq bi translated">用Kotlin写一个log4j2查找插件</li><li id="79fe" class="mi mj iq kn b ko mr ks ms kw mt la mu le mv li mn mo mp mq bi translated">配置log4j2以在yaml语法中使用它</li><li id="6e7d" class="mi mj iq kn b ko mr ks ms kw mt la mu le mv li mn mo mp mq bi translated">使用logzio字段映射将自定义正常运行时间属性解析为long</li><li id="6e90" class="mi mj iq kn b ko mr ks ms kw mt la mu le mv li mn mo mp mq bi translated">在此过滤正常运行时间为&lt; 60 seconds in kibana with a lucene query</li></ul><h1 id="e640" class="mw mx iq bd my mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr ns nt bi translated">The plugin</h1><figure class="jv jw jx jy gt jz"><div class="bz fp l di"><div class="nu nv l"/></div><figcaption class="kg kh gj gh gi ki kj bd b be z dk translated">More about log4j plugins can be found <a class="ae kk" href="https://logging.apache.org/log4j/2.x/manual/plugins.html" rel="noopener ugc nofollow" target="_blank">的事件</a></figcaption></figure><h1 id="fe80" class="mw mx iq bd my mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr ns nt bi translated">配置</h1><figure class="jv jw jx jy gt jz"><div class="bz fp l di"><div class="nu nv l"/></div><figcaption class="kg kh gj gh gi ki kj bd b be z dk translated">使用我们插件的log4j配置</figcaption></figure><p id="4941" class="pw-post-body-paragraph kl km iq kn b ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">这是一个有趣的例子。让我们简单讨论一下。它包含两个控制台附加器，JSON和TEXT。当在本地或在CI中运行服务时使用文本appender，而在其他地方使用“json”。</p><p id="c4e2" class="pw-post-body-paragraph kl km iq kn b ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">这是通过使用现有的log4j2环境loockup插件<code class="fe nw nx ny nz b">"${env:LOG_FORMAT:-text}"</code>来实现的。env查找之前的单个<code class="fe nw nx ny nz b">$</code>将导致记录器只使用一次该查找，并缓存所有消息的结果。</p><p id="f52e" class="pw-post-body-paragraph kl km iq kn b ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">我们的插件在这里使用:</p><pre class="jv jw jx jy gt oa nz ob oc aw od bi"><span id="178b" class="oe mx iq nz b gy of og l oh oi">...<br/>JsonLayout:<br/>...          <br/>	keyValuePair:<br/>	          - key: uptime<br/>	            value: '$${uptime:seconds}'</span></pre><p id="56e4" class="pw-post-body-paragraph kl km iq kn b ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">这是名为“json”的控制台appender使用的<a class="ae kk" href="https://logging.apache.org/log4j/2.x/manual/layouts.html" rel="noopener ugc nofollow" target="_blank"> json布局</a>的配置。</p><blockquote class="oj ok ol"><p id="1096" class="kl km om kn b ko kp kq kr ks kt ku kv on kx ky kz oo lb lc ld op lf lg lh li ij bi translated">Appender使用一种布局将日志事件格式化成一种形式，这种形式可以满足使用日志事件的任何人的需求。</p></blockquote><p id="db3f" class="pw-post-body-paragraph kl km iq kn b ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">在我们的例子中，日志将由ELK使用，并基于json属性对它们进行索引。</p><p id="a90e" class="pw-post-body-paragraph kl km iq kn b ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">log4j2 JSON布局可以有定制字段，这些字段可以使用定制loockup插件，这些插件使用<code class="fe nw nx ny nz b">keyValuePair</code>配置属性。</p><p id="44b6" class="pw-post-body-paragraph kl km iq kn b ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">在我们的例子中，自定义字段的名称将是<code class="fe nw nx ny nz b">uptime</code>，并且将通过调用我们的插件来计算每个日志消息的值，<code class="fe nw nx ny nz b">'$${uptime:seconds}'.</code>注意双<code class="fe nw nx ny nz b">$$</code>，这意味着我们的插件将为每个日志消息被调用。</p><p id="a380" class="pw-post-body-paragraph kl km iq kn b ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">每个loockup插件都必须实现<a class="ae kk" href="https://github.com/apache/logging-log4j2/blob/master/log4j-core/src/main/java/org/apache/logging/log4j/core/lookup/StrLookup.java" rel="noopener ugc nofollow" target="_blank"> StrLoockup接口</a>，该接口包含两个方法:</p><pre class="jv jw jx jy gt oa nz ob oc aw od bi"><span id="614b" class="oe mx iq nz b gy of og l oh oi">public interface StrLookup {<br/>	String lookup(String key); <br/>	String lookup(LogEvent event, String key); <br/>}</span></pre><p id="8126" class="pw-post-body-paragraph kl km iq kn b ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">如果你在配置中的插件名称前放一个单个的<code class="fe nw nx ny nz b">$</code>将会调用第一个方法，如果你放一个双<code class="fe nw nx ny nz b">$$</code>将会调用第二个方法，第二个方法也可以访问包含消息、级别、上下文映射、日志名称和其他有用的东西的日志事件。在我们的示例中，<code class="fe nw nx ny nz b">String key</code>接口方法变量是<code class="fe nw nx ny nz b">seconds</code>，它是出现在配置中的<strong class="kn ir"> ":" </strong>之后的字符串→ $${uptime: <code class="fe nw nx ny nz b"><strong class="kn ir">seconds</strong></code> }</p><p id="d8f4" class="pw-post-body-paragraph kl km iq kn b ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">我真的很奇怪为什么他们不在官方文档或者界面的javadocs中用粗体字写$$和$这个东西。</p><p id="c38f" class="pw-post-body-paragraph kl km iq kn b ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">log4j会发现我们的插件，因为我们告诉它在哪里可以找到它</p><pre class="jv jw jx jy gt oa nz ob oc aw od bi"><span id="a38a" class="oe mx iq nz b gy of og l oh oi">Configuration:<br/>  name: Default<br/>  packages: "com.company.core.logging"</span></pre><p id="c243" class="pw-post-body-paragraph kl km iq kn b ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated"><code class="fe nw nx ny nz b">com.company.core.logging</code>是应该在类路径中可用的包名。</p><p id="a127" class="pw-post-body-paragraph kl km iq kn b ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">插件的注释是:</p><pre class="jv jw jx jy gt oa nz ob oc aw od bi"><span id="58de" class="oe mx iq nz b gy of og l oh oi">@Plugin(name = "uptime", category = StrLookup.CATEGORY)</span></pre><p id="a031" class="pw-post-body-paragraph kl km iq kn b ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">“uptime”是log4j将使用反射定位的插件的名称。</p><h1 id="60eb" class="mw mx iq bd my mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr ns nt bi translated">Logzio字段映射</h1><p id="6a18" class="pw-post-body-paragraph kl km iq kn b ko oq kq kr ks or ku kv kw os ky kz la ot lc ld le ou lg lh li ij bi translated">既然我们的服务记录了每个日志消息的正常运行时间，我们希望在logzio中将它解析为一个long，以实现开放的logzio控制台。<strong class="kn ir">工具- &gt;字段映射</strong> <strong class="kn ir">面板</strong></p><figure class="jv jw jx jy gt jz gh gi paragraph-image"><div role="button" tabindex="0" class="ka kb di kc bf kd"><div class="gh gi ov"><img src="../Images/df73d805630f477cabe2a7040fcc94ef.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*rio4-OR_L3Nhm9oTV1Y4_A.png"/></div></div><figcaption class="kg kh gj gh gi ki kj bd b be z dk translated">logzio字段映射将插件输出解析为long</figcaption></figure><p id="956e" class="pw-post-body-paragraph kl km iq kn b ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">别忘了<strong class="kn ir">刷新kibana映射</strong>。以使更改生效。</p><h1 id="3a21" class="mw mx iq bd my mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr ns nt bi translated">Lucene查询</h1><pre class="jv jw jx jy gt oa nz ob oc aw od bi"><span id="f517" class="oe mx iq nz b gy of og l oh oi">svc_name:banana AND svc_uptime:&lt;60</span></pre><p id="ffd3" class="pw-post-body-paragraph kl km iq kn b ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">现在，我们终于可以过滤部署服务后第一分钟内发生的事件了。</p><p id="ee88" class="pw-post-body-paragraph kl km iq kn b ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">干杯！</p></div></div>    
</body>
</html>