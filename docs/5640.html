<html>
<head>
<title>Istio: external AWS Application LoadBalancer and Istio Ingress Gateway</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Istio:外部AWS应用负载平衡器和Istio入口网关</h1>
<blockquote>原文：<a href="https://itnext.io/istio-external-aws-application-loadbalancer-and-istio-ingress-gateway-fce3bfd3202f?source=collection_archive---------0-----------------------#2021-04-22">https://itnext.io/istio-external-aws-application-loadbalancer-and-istio-ingress-gateway-fce3bfd3202f?source=collection_archive---------0-----------------------#2021-04-22</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/7b10e0b10e383f972a219ab5303b948c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*kkvtw5c0lGhRYKcEogx7zw.jpeg"/></div></div></figure><p id="0e63" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在之前的帖子<a class="ae kw" href="https://rtfm.co.ua/en/istio-an-overview-and-running-service-mesh-in-kubernetes/" rel="noopener ugc nofollow" target="_blank">Istio:Kubernetes中的概述和运行服务网格</a>中，我们启动了Istio AWS Elastic Kubernetes服务，并对其主要组件进行了概述。</p><p id="d997" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">下一个任务是在Istio入口网关之前添加一个AWS <strong class="ka ir">应用</strong>负载平衡器(ALB ),因为Istio网关服务及其默认类型负载平衡器创建了nad AWS <strong class="ka ir"> Classic </strong>负载平衡器，其中我们只能附加一个来自<a class="ae kw" href="https://aws.amazon.com/ru/certificate-manager/" rel="noopener ugc nofollow" target="_blank">亚马逊证书管理器</a>的SSL证书。</p><h1 id="ed30" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">内容</h1><ul class=""><li id="c730" class="lv lw iq ka b kb lx kf ly kj lz kn ma kr mb kv mc md me mf bi translated"><a class="ae kw" href="https://rtfm.co.ua/en/istio-external-aws-application-loadbalancer-and-istio-ingress-gateway/#Updating_Istio_Ingress_Gateway" rel="noopener ugc nofollow" target="_blank">更新Istio入口网关</a></li><li id="1a97" class="lv lw iq ka b kb mg kf mh kj mi kn mj kr mk kv mc md me mf bi translated"><a class="ae kw" href="https://rtfm.co.ua/en/istio-external-aws-application-loadbalancer-and-istio-ingress-gateway/#Istio_Ingress_Gateway_and_AWS_Application_LoadBalancer_health_checks" rel="noopener ugc nofollow" target="_blank"> Istio入口网关和AWS应用负载平衡器运行状况检查</a></li><li id="9619" class="lv lw iq ka b kb mg kf mh kj mi kn mj kr mk kv mc md me mf bi translated"><a class="ae kw" href="https://rtfm.co.ua/en/istio-external-aws-application-loadbalancer-and-istio-ingress-gateway/#Create_an_Ingress_and_its_AWS_Application_LoadBalancer" rel="noopener ugc nofollow" target="_blank">创建入口及其AWS应用负载平衡器</a></li><li id="6c89" class="lv lw iq ka b kb mg kf mh kj mi kn mj kr mk kv mc md me mf bi translated"><a class="ae kw" href="https://rtfm.co.ua/en/istio-external-aws-application-loadbalancer-and-istio-ingress-gateway/#A_testing_application" rel="noopener ugc nofollow" target="_blank">测试应用</a></li><li id="7ea0" class="lv lw iq ka b kb mg kf mh kj mi kn mj kr mk kv mc md me mf bi translated"><a class="ae kw" href="https://rtfm.co.ua/en/istio-external-aws-application-loadbalancer-and-istio-ingress-gateway/#Istio_Gateway_configuration" rel="noopener ugc nofollow" target="_blank"> Istio网关配置</a></li><li id="d821" class="lv lw iq ka b kb mg kf mh kj mi kn mj kr mk kv mc md me mf bi translated"><a class="ae kw" href="https://rtfm.co.ua/en/istio-external-aws-application-loadbalancer-and-istio-ingress-gateway/#Istio_VirtualService_configuration" rel="noopener ugc nofollow" target="_blank"> Istio VirtualService配置</a></li></ul><h1 id="c7e6" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">任务</h1><p id="04b1" class="pw-post-body-paragraph jy jz iq ka b kb lx kd ke kf ly kh ki kj ml kl km kn mm kp kq kr mn kt ku kv ij bi translated">目前，我们的应用程序中的流量采用以下流程:</p><ul class=""><li id="292c" class="lv lw iq ka b kb kc kf kg kj mo kn mp kr mq kv mc md me mf bi translated">在应用程序的舵图中，我们定义了入口和服务，该入口创建了带有SSL的AWS应用程序负载平衡器</li><li id="5a5b" class="lv lw iq ka b kb mg kf mh kj mi kn mj kr mk kv mc md me mf bi translated">来自ALB的一个包被发送到应用程序的服务</li><li id="1d11" class="lv lw iq ka b kb mg kf mh kj mi kn mj kr mk kv mc md me mf bi translated">通过此服务，它将与应用程序一起发送到Pod</li></ul><figure class="ms mt mu mv gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mr"><img src="../Images/6be4df01cd6d82529af7a78a49b46152.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*4tIb8ArNolpZJ0sM.png"/></div></div></figure><p id="e9fe" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">现在，让我们在这里添加Istio。</p><p id="fa85" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">接下来的想法是:</p><ul class=""><li id="bb0a" class="lv lw iq ka b kb kc kf kg kj mo kn mp kr mq kv mc md me mf bi translated">安装Istion，它将创建Istio入口网关—它的服务和Pod</li><li id="192d" class="lv lw iq ka b kb mg kf mh kj mi kn mj kr mk kv mc md me mf bi translated">在应用程序的导航图中，将有入口、服务和带有Istio入口网关虚拟服务的网关</li><li id="bf9a" class="lv lw iq ka b kb mg kf mh kj mi kn mj kr mk kv mc md me mf bi translated">应用程序的进入将创建一个ALB，在此完成SSL终止，集群内部的流量将通过HTTP发送</li><li id="220c" class="lv lw iq ka b kb mg kf mh kj mi kn mj kr mk kv mc md me mf bi translated">来自ALB的数据包将被发送到Istio入口网关的Pod</li><li id="2a56" class="lv lw iq ka b kb mg kf mh kj mi kn mj kr mk kv mc md me mf bi translated">从Istio入口网关，遵循应用程序的网关和虚拟服务中定义的规则，它将被发送到应用程序的服务</li><li id="1ccb" class="lv lw iq ka b kb mg kf mh kj mi kn mj kr mk kv mc md me mf bi translated">从这个服务到应用程序的Pod</li></ul><figure class="ms mt mu mv gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mr"><img src="../Images/7691c2cc35bfe6b63c1d911fceafd1dd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*znzFA2vuKgF3yp2U.png"/></div></div></figure><p id="a7ac" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">为此，我们需要:</p><ol class=""><li id="ce89" class="lv lw iq ka b kb kc kf kg kj mo kn mp kr mq kv mw md me mf bi translated">添加入口以使用<a class="ae kw" href="https://rtfm.co.ua/en/aws-elastic-kubernetes-service-running-alb-ingress-controller/" rel="noopener ugc nofollow" target="_blank"> ALB入口控制器</a>创建ALB</li><li id="08b4" class="lv lw iq ka b kb mg kf mh kj mi kn mj kr mk kv mw md me mf bi translated">更新Istio入口网关的服务，而不是负载平衡器类型将设置节点端口，因此AWS ALB入口控制器可以创建与ALB一起使用的目标组</li><li id="1904" class="lv lw iq ka b kb mg kf mh kj mi kn mj kr mk kv mw md me mf bi translated">使用通用Kubernetes服务部署测试应用程序</li><li id="4d75" class="lv lw iq ka b kb mg kf mh kj mi kn mj kr mk kv mw md me mf bi translated">对于测试应用程序，需要创建一个网关和虚拟服务来配置Istio入口网关的特使，以将流量路由到应用程序的服务</li></ol><p id="608f" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我们走吧。</p><h1 id="bd97" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">更新Istio入口网关</h1><p id="9847" class="pw-post-body-paragraph jy jz iq ka b kb lx kd ke kf ly kh ki kj ml kl km kn mm kp kq kr mn kt ku kv ij bi translated">我们在上一章中已经安装了Istio，因此现在我们有了一个Istio入口网关，它具有负载平衡器类型的服务:</p><pre class="ms mt mu mv gt mx my mz na aw nb bi"><span id="c756" class="nc ky iq my b gy nd ne l nf ng">$ kubectl -n istio-system get svc istio-ingressgateway<br/>NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE<br/>istio-ingressgateway LoadBalancer 172.20.112.213 a6f***599.eu-west-3.elb.amazonaws.com 15021:30218/TCP,80:31246/TCP,443:30486/TCP,15012:32445/TCP,15443:30154/TCP 25h</span></pre><p id="6c75" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">需要更改它并将服务类型设置为节点端口，这可以通过<code class="fe nh ni nj my b">istioctl</code>和<code class="fe nh ni nj my b">--set</code>来完成:</p><pre class="ms mt mu mv gt mx my mz na aw nb bi"><span id="5a9f" class="nc ky iq my b gy nd ne l nf ng">$ istioctl install --set profile=default --set values.gateways.istio-ingressgateway.type=NodePort -y<br/>✔ Istio core installed<br/>✔ Istiod installed<br/>✔ Ingress gateways installed<br/>✔ Installation complete</span></pre><p id="ab89" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">检查服务:</p><pre class="ms mt mu mv gt mx my mz na aw nb bi"><span id="6076" class="nc ky iq my b gy nd ne l nf ng">$ kubectl -n istio-system get svc istio-ingressgateway<br/>NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE<br/>istio-ingressgateway NodePort 172.20.112.213 &lt;none&gt; 15021:30218/TCP,80:31246/TCP,443:30486/TCP,15012:32445/TCP,15443:30154/TCP 25h</span></pre><p id="e831" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">NodePort，很好——都完成了。</p><h2 id="ebc1" class="nc ky iq bd kz nk nl dn ld nm nn dp lh kj no np ll kn nq nr lp kr ns nt lt nu bi translated">Istio入口网关和AWS应用负载平衡器运行状况检查</h2><p id="edb7" class="pw-post-body-paragraph jy jz iq ka b kb lx kd ke kf ly kh ki kj ml kl km kn mm kp kq kr mn kt ku kv ij bi translated">但这里有一个问题:我们如何在AWS应用程序负载平衡器上执行健康检查，因为Istio Ingress Gateway使用一组TCP端口——80用于传入流量，12021用于其状态检查？</p><p id="2822" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">如果我们将在入口中设置<code class="fe nh ni nj my b">alb.ingress.kubernetes.io/healthcheck-port</code>注释，那么ALB入口控制器将会忽略它，而不会在日志中显示任何消息。将创建入口，但不会创建相应的AWS负载平衡器。</p><p id="a896" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在Github上搜索了一个解决方案— <a class="ae kw" href="https://github.com/kubernetes-sigs/aws-load-balancer-controller/issues/93" rel="noopener ugc nofollow" target="_blank">如果在路线上使用多个pod，健康检查不起作用</a>:将健康检查相关的注释移动到Istio网关的服务。</p><p id="9163" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">所以，编辑<code class="fe nh ni nj my b">istio-ingressgateway</code>服务:</p><pre class="ms mt mu mv gt mx my mz na aw nb bi"><span id="43c9" class="nc ky iq my b gy nd ne l nf ng">$ kubectl -n istio-system edit svc istio-ingressgateway</span></pre><p id="9a0f" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在它的<code class="fe nh ni nj my b">spec.ports</code>中找到<code class="fe nh ni nj my b">status-port</code>和它的<code class="fe nh ni nj my b">nodePort</code>:</p><pre class="ms mt mu mv gt mx my mz na aw nb bi"><span id="8daa" class="nc ky iq my b gy nd ne l nf ng">...<br/>spec:<br/>  clusterIP: 172.20.112.213<br/>  externalTrafficPolicy: Cluster<br/>  ports:<br/>  - name: status-port<br/>    nodePort: 30218<br/>    port: 15021<br/>    protocol: TCP<br/>    targetPort: 15021<br/>...</span></pre><p id="2075" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">要配置<code class="fe nh ni nj my b">alb.ingress.kubernetes.io/alb.ingress.kubernetes.io/healthcheck-path</code>，从部署中获取一个<code class="fe nh ni nj my b">readinessProbe</code>，这将创建带有<code class="fe nh ni nj my b">istio-ingressgateway</code>的pod:</p><pre class="ms mt mu mv gt mx my mz na aw nb bi"><span id="1601" class="nc ky iq my b gy nd ne l nf ng">$ kubectl -n istio-system get deploy istio-ingressgateway -o yaml<br/>…<br/>readinessProbe:<br/>failureThreshold: 30<br/>httpGet:<br/>path: /healthz/ready<br/>…</span></pre><p id="ce0b" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">为<code class="fe nh ni nj my b">istio-ingressgateway</code>服务设置注释:在<code class="fe nh ni nj my b">healthchek-port</code>中设置来自<code class="fe nh ni nj my b">status-port</code>的<code class="fe nh ni nj my b">nodePort</code>，在<code class="fe nh ni nj my b">healthcheck-path</code>中设置来自<code class="fe nh ni nj my b">readinessProbe</code>的路径:</p><pre class="ms mt mu mv gt mx my mz na aw nb bi"><span id="6808" class="nc ky iq my b gy nd ne l nf ng">...<br/>    alb.ingress.kubernetes.io/healthcheck-path: /healthz/ready<br/>    alb.ingress.kubernetes.io/healthcheck-port: "30218"<br/>...</span></pre><figure class="ms mt mu mv gt jr gh gi paragraph-image"><div class="gh gi nv"><img src="../Images/22c0ea3304278ce43cff29e206180103.png" data-original-src="https://miro.medium.com/v2/resize:fit:1314/format:webp/0*s5jofCRKbyaNEVTy.png"/></div></figure><p id="f2a7" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">现在，在创建入口的过程中，我们的ALB入口控制器将找到入口清单的<code class="fe nh ni nj my b">backend.serviceName</code>中指定的服务，读取其注释，并将应用到附加到ALB的TargetGroup。</p><p id="54fd" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">当使用Helm部署时，可以通过<code class="fe nh ni nj my b">values.gateways.istio-ingressgateway.serviceAnnotations</code>设置这些注释。</p><h1 id="d09e" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">创建入口及其AWS应用程序负载平衡器</h1><p id="7fb8" class="pw-post-body-paragraph jy jz iq ka b kb lx kd ke kf ly kh ki kj ml kl km kn mm kp kq kr mn kt ku kv ij bi translated">接下来，添加一个入口——这将是我们使用SSL终端的应用程序的主要负载平衡器。</p><p id="3796" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在这里，从AWS证书管理器设置SSL证书的ARN。必须在<code class="fe nh ni nj my b">istio-system</code>名称空间中创建入口，因为它需要访问<code class="fe nh ni nj my b">istio-ingressgateway</code>服务:</p><pre class="ms mt mu mv gt mx my mz na aw nb bi"><span id="e773" class="nc ky iq my b gy nd ne l nf ng">---<br/>apiVersion: extensions/v1beta1<br/>kind: Ingress<br/>metadata:<br/>  name: test-alb<br/>  namespace: istio-system<br/>  annotations:<br/>    # create AWS Application LoadBalancer<br/>    kubernetes.io/ingress.class: alb<br/>    # external type<br/>    alb.ingress.kubernetes.io/scheme: internet-facing<br/>    # AWS Certificate Manager certificate's ARN<br/>    alb.ingress.kubernetes.io/certificate-arn: "arn:aws:acm:eu-west-3:***:certificate/fcaa9fd2-1b55-48d7-92f2-e829f7bafafd"<br/>    # open ports 80 and 443 <br/>    alb.ingress.kubernetes.io/listen-ports: '[{"HTTP": 80}, {"HTTPS":443}]'<br/>    # redirect all HTTP to HTTPS<br/>    alb.ingress.kubernetes.io/actions.ssl-redirect: '{"Type": "redirect", "RedirectConfig": { "Protocol": "HTTPS", "Port": "443", "StatusCode": "HTTP_301"}}'<br/>    # ExternalDNS settings: <a class="ae kw" href="https://rtfm.co.ua/en/kubernetes-update-aws-route53-dns-from-an-ingress/" rel="noopener ugc nofollow" target="_blank">https://rtfm.co.ua/en/kubernetes-update-aws-route53-dns-from-an-ingress/</a><br/>    external-dns.alpha.kubernetes.io/hostname: "istio-test-alb.example.com"<br/>spec:<br/>  rules:<br/>  - http:<br/>      paths:<br/>        - path: /*<br/>          backend:<br/>            serviceName: ssl-redirect<br/>            servicePort: use-annotation<br/>        - path: /*<br/>          backend:<br/>            serviceName: istio-ingressgateway<br/>            servicePort: 80</span></pre><p id="e56d" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">部署它:</p><pre class="ms mt mu mv gt mx my mz na aw nb bi"><span id="9d6b" class="nc ky iq my b gy nd ne l nf ng">$ kubectl apply -f test-ingress.yaml<br/>ingress.extensions/test-alb created</span></pre><p id="a987" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">检查<code class="fe nh ni nj my b">istio-system</code>名称空间中的入口:</p><pre class="ms mt mu mv gt mx my mz na aw nb bi"><span id="2827" class="nc ky iq my b gy nd ne l nf ng">$ kubectl -n istio-system get ingress<br/>NAME CLASS HOSTS ADDRESS PORTS AGE<br/>test-alb &lt;none&gt; * cc2***514.eu-west-3.elb.amazonaws.com 80 2m49s</span></pre><p id="5cc6" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我们的AWS ALB已创建:</p><figure class="ms mt mu mv gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nw"><img src="../Images/dfccfe2f8dfe7009860e55fa49d8c01a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*Ilf50TP7rgAljxRl.png"/></div></div></figure><p id="1b04" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在目标组的<em class="nx">健康检查</em>中，我们可以看到我们的TCP端口和URI:</p><figure class="ms mt mu mv gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi ny"><img src="../Images/8dc9d92d9ceb9db6eb61b438d6bc6459.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*o-y1ocg7nfn1kfOn.png"/></div></div></figure><p id="e04e" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">目标是健康的:</p><figure class="ms mt mu mv gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi ny"><img src="../Images/ccf6951cac8c7045c4d73c6e99a6a8dc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*ftazfleyEN5fNFnt.png"/></div></div></figure><p id="9d8e" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">检查从入口的<code class="fe nh ni nj my b">external-dns.alpha.kubernetes.io/hostname</code>注释创建的域，参见<a class="ae kw" href="https://rtfm.co.ua/en/kubernetes-update-aws-route53-dns-from-an-ingress/" rel="noopener ugc nofollow" target="_blank">Kubernetes:update AWS route 53 DNS from a Ingress</a>帖子了解更多详细信息:</p><pre class="ms mt mu mv gt mx my mz na aw nb bi"><span id="8aeb" class="nc ky iq my b gy nd ne l nf ng">$ curl -I <a class="ae kw" href="https://istio-test-alb.example.com" rel="noopener ugc nofollow" target="_blank">https://istio-test-alb.example.com</a><br/>HTTP/2 502<br/>server: awselb/2.0</span></pre><p id="a0a3" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">炉排！它正在工作，我们只是没有在网关后面运行应用程序，所以它甚至没有TCP端口80监听器:</p><pre class="ms mt mu mv gt mx my mz na aw nb bi"><span id="3477" class="nc ky iq my b gy nd ne l nf ng">$ istioctl proxy-config listeners -n istio-system istio-ingressgateway-d45fb4b48-jsz9z<br/>ADDRESS PORT MATCH DESTINATION<br/>0.0.0.0 15021 ALL Inline Route: /healthz/ready*<br/>0.0.0.0 15090 ALL Inline Route: /stats/prometheus*</span></pre><p id="126e" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">但是15021已经开通，健康检查正在进行。</p><h1 id="8da7" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">测试应用程序</h1><p id="0973" class="pw-post-body-paragraph jy jz iq ka b kb lx kd ke kf ly kh ki kj ml kl km kn mm kp kq kr mn kt ku kv ij bi translated">描述一个常见的应用程序——一个名称空间、两个带有<code class="fe nh ni nj my b"><a class="ae kw" href="https://hub.docker.com/r/nginxdemos/hello/" rel="noopener ugc nofollow" target="_blank">nginxdemos/hello</a></code>图像的窗格和一个服务:</p><pre class="ms mt mu mv gt mx my mz na aw nb bi"><span id="4ea1" class="nc ky iq my b gy nd ne l nf ng">---         <br/>apiVersion: v1<br/>kind: Namespace<br/>metadata:<br/>  name: test-ns<br/>  labels:<br/>    istio-injection:<br/>      enabled<br/>---<br/>apiVersion: apps/v1<br/>kind: Deployment<br/>metadata:<br/>  name: test-deploy<br/>  namespace: test-ns<br/>  labels:<br/>    app: test-app<br/>    version: v1<br/>spec: <br/>  replicas: 2<br/>  selector:<br/>    matchLabels:<br/>      app: test-app<br/>  template:<br/>    metadata:<br/>      labels:<br/>        app: test-app<br/>        version: v1<br/>    spec: <br/>      containers:<br/>      - name: web<br/>        image: nginxdemos/hello<br/>        ports:<br/>        - containerPort: 80<br/>        resources:<br/>          requests:<br/>            cpu: 100m<br/>            memory: 100Mi<br/>        readinessProbe:<br/>          httpGet:<br/>            path: /<br/>            port: 80<br/>---<br/>apiVersion: v1<br/>kind: Service<br/>metadata:<br/>  name: test-svc<br/>  namespace: test-ns<br/>spec:   <br/>  selector:<br/>    app: test-app<br/>  ports:<br/>    - name: http<br/>      protocol: TCP<br/>      port: 80<br/>      targetPort: 80</span></pre><p id="5dae" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">部署它:</p><pre class="ms mt mu mv gt mx my mz na aw nb bi"><span id="2aea" class="nc ky iq my b gy nd ne l nf ng">$ kubectl apply -f test-ingress.yaml<br/>ingress.extensions/test-alb configured<br/>namespace/test-ns created<br/>deployment.apps/test-deploy created<br/>service/test-svc created</span></pre><p id="4a9c" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">但是我们的ALB仍然给出了502错误，因为我们还没有配置Istio入口网关。</p><h2 id="7491" class="nc ky iq bd kz nk nl dn ld nm nn dp lh kj no np ll kn nq nr lp kr ns nt lt nu bi translated">Istio网关配置</h2><p id="0339" class="pw-post-body-paragraph jy jz iq ka b kb lx kd ke kf ly kh ki kj ml kl km kn mm kp kq kr mn kt ku kv ij bi translated">描述网关和虚拟服务。</p><p id="0f57" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在网关中设置一个监听端口80，并配置一个Istio入口——即<code class="fe nh ni nj my b">ingressgateway</code>。在<code class="fe nh ni nj my b">spec.servers.hosts</code>字段中设置我们的测试域:</p><pre class="ms mt mu mv gt mx my mz na aw nb bi"><span id="78c7" class="nc ky iq my b gy nd ne l nf ng">---<br/>apiVersion: networking.istio.io/v1alpha3<br/>kind: Gateway<br/>metadata:<br/>  name: test-gateway<br/>  namespace: test-ns<br/>spec: <br/>  selector:<br/>    istio: ingressgateway<br/>  servers:<br/>  - port:<br/>      number: 80<br/>      name: http<br/>      protocol: HTTP<br/>    hosts:<br/>    - "istio-test-alb.example.com"</span></pre><p id="c610" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">部署:</p><pre class="ms mt mu mv gt mx my mz na aw nb bi"><span id="f517" class="nc ky iq my b gy nd ne l nf ng">$ kubectl apply -f test-ingress.yaml<br/>ingress.extensions/test-alb configured<br/>namespace/test-ns unchanged<br/>deployment.apps/test-deploy configured<br/>service/test-svc unchanged<br/>gateway.networking.istio.io/test-gateway created</span></pre><p id="b429" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">再次检查Istio入口网关的<code class="fe nh ni nj my b">listeners</code>:</p><pre class="ms mt mu mv gt mx my mz na aw nb bi"><span id="726a" class="nc ky iq my b gy nd ne l nf ng">$ istioctl proxy-config listeners -n istio-system istio-ingressgateway-d45fb4b48-jsz9z<br/>ADDRESS PORT MATCH DESTINATION<br/>0.0.0.0 8080 ALL Route: http.80<br/>0.0.0.0 15021 ALL Inline Route: /healthz/ready*<br/>0.0.0.0 15090 ALL Inline Route: /stats/prometheus*</span></pre><p id="a730" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">TCP端口80现在在这里，但是这里的流量没有被路由到任何地方:</p><pre class="ms mt mu mv gt mx my mz na aw nb bi"><span id="fb61" class="nc ky iq my b gy nd ne l nf ng">$ istioctl proxy-config routes -n istio-system istio-ingressgateway-d45fb4b48-jsz9z<br/>NOTE: This output only contains routes loaded via RDS.<br/>NAME DOMAINS MATCH VIRTUAL SERVICE<br/>http.80 * /* 404<br/>* /healthz/ready*<br/>* /stats/prometheus*</span></pre><p id="4e33" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">如果现在访问我们的域，将获得404，但这次不是从<code class="fe nh ni nj my b">awselb/2.0</code>而是从<code class="fe nh ni nj my b">istio-envoy</code>获得，因为请求正在到达入口网关Pod:</p><pre class="ms mt mu mv gt mx my mz na aw nb bi"><span id="2a57" class="nc ky iq my b gy nd ne l nf ng">$ curl -I <a class="ae kw" href="https://istio-test-alb.example.com" rel="noopener ugc nofollow" target="_blank">https://istio-test-alb.example.com</a><br/>HTTP/2 404<br/>date: Fri, 26 Mar 2021 11:02:57 GMT<br/>server: istio-envoy</span></pre><h2 id="b599" class="nc ky iq bd kz nk nl dn ld nm nn dp lh kj no np ll kn nq nr lp kr ns nt lt nu bi translated">Istio虚拟服务配置</h2><p id="d527" class="pw-post-body-paragraph jy jz iq ka b kb lx kd ke kf ly kh ki kj ml kl km kn mm kp kq kr mn kt ku kv ij bi translated">在VirtualService中，指定要应用路由的网关，以及路由本身——将所有流量发送到我们应用程序的服务:</p><pre class="ms mt mu mv gt mx my mz na aw nb bi"><span id="60ef" class="nc ky iq my b gy nd ne l nf ng">---<br/>apiVersion: networking.istio.io/v1alpha3<br/>kind: VirtualService<br/>metadata:<br/>  name: test-virtualservice<br/>  namespace: test-ns<br/>spec: <br/>  hosts:<br/>  - "istio-test-alb.example.com"<br/>  gateways:<br/>  - test-gateway<br/>  http:<br/>  - match: <br/>    - uri:   <br/>        prefix: /<br/>    route:<br/>    - destination:<br/>        host: test-svc<br/>        port:<br/>          number: 80</span></pre><p id="468e" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">部署并再次检查Istio入口网关路由:</p><pre class="ms mt mu mv gt mx my mz na aw nb bi"><span id="6001" class="nc ky iq my b gy nd ne l nf ng">$ istioctl proxy-config routes -n istio-system istio-ingressgateway-d45fb4b48-jsz9z<br/>NOTE: This output only contains routes loaded via RDS.<br/>NAME DOMAINS MATCH VIRTUAL SERVICE<br/>http.80 istio-test-alb.example.com /* test-virtualservice.test-ns</span></pre><p id="91a5" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">现在我们可以看到，有一条通向我们的测试应用程序的路径，然后通向测试舱:</p><pre class="ms mt mu mv gt mx my mz na aw nb bi"><span id="16cf" class="nc ky iq my b gy nd ne l nf ng">$ curl -I <a class="ae kw" href="https://istio-test-alb.example.com" rel="noopener ugc nofollow" target="_blank">https://istio-test-alb.example.com</a><br/>HTTP/2 200<br/>date: Fri, 26 Mar 2021 11:06:52 GMT<br/>content-type: text/html<br/>server: istio-envoy</span></pre><figure class="ms mt mu mv gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nz"><img src="../Images/d65ef926fd29e81b2513aedf3f790f1a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*pyVobZ0vaQ2-mqEW.png"/></div></div></figure><p id="4bcf" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">完成了。</p></div><div class="ab cl oa ob hu oc" role="separator"><span class="od bw bk oe of og"/><span class="od bw bk oe of og"/><span class="od bw bk oe of"/></div><div class="ij ik il im in"><p id="1b6e" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><em class="nx">最初发布于</em> <a class="ae kw" href="https://rtfm.co.ua/en/istio-external-aws-application-loadbalancer-and-istio-ingress-gateway/" rel="noopener ugc nofollow" target="_blank"> <em class="nx"> RTFM: Linux、DevOps、系统管理</em> </a> <em class="nx">。</em></p></div></div>    
</body>
</html>