<html>
<head>
<title>Surviving a sudden spike in website traffic — Global rate limiting with Ambassador on Kubernetes</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在网站流量突然激增的情况下生存Kubernetes上的大使全球限速</h1>
<blockquote>原文：<a href="https://itnext.io/surviving-a-sudden-spike-in-website-traffic-global-rate-limiting-with-ambassador-a19dd2dfda46?source=collection_archive---------4-----------------------#2019-03-01">https://itnext.io/surviving-a-sudden-spike-in-website-traffic-global-rate-limiting-with-ambassador-a19dd2dfda46?source=collection_archive---------4-----------------------#2019-03-01</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="5fcb" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">想象一下你的网站登上了<a class="ae kl" href="https://news.ycombinator.com/" rel="noopener ugc nofollow" target="_blank">黑客新闻</a>的头版。流量开始飙升。不幸的是，你的网站还没有为此做好准备。您的数据库在负载下开始崩溃。随着性能的下降，用户开始点击浏览器中的重新加载，希望获得一个请求，这会给服务器增加更多的负载。</p><p id="52b5" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">你是做什么的？</p><h1 id="cb15" class="km kn iq bd ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj bi translated">全局速率限制</h1><p id="b059" class="pw-post-body-paragraph jn jo iq jp b jq lk js jt ju ll jw jx jy lm ka kb kc ln ke kf kg lo ki kj kk ij bi translated">您希望尽可能快地缓解性能问题，同时努力扩展您的后端。您可以使用速率限制来做到这一点，即限制您的应用程序接收的请求总数。有许多限制速率的方法。</p><p id="f7a1" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">由于我们的网站正在崩溃，我们将应用一个快速的每用户速率限制，以防止单个用户向我们的应用程序发送太多请求。</p><h1 id="523b" class="km kn iq bd ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj bi translated">大使速率限制</h1><p id="f6c5" class="pw-post-body-paragraph jn jo iq jp b jq lk js jt ju ll jw jx jy lm ka kb kc ln ke kf kg lo ki kj kk ij bi translated">大使有一个强大的速率限制API。传入的请求可以用<em class="lp">标记。</em>这些请求标签暴露给第三方速率限制服务，该服务可以使用这些标签来做出速率限制决定。在Ambassador Pro中，我们还包括一个利用该API的集成速率限制服务。</p><h1 id="cf62" class="km kn iq bd ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj bi translated">在Ambassador中部署全局速率限制</h1><p id="cdff" class="pw-post-body-paragraph jn jo iq jp b jq lk js jt ju ll jw jx jy lm ka kb kc ln ke kf kg lo ki kj kk ij bi translated">通过在全局大使<code class="fe lq lr ls lt b">Module</code>中配置<code class="fe lq lr ls lt b">default_labels</code>，我们可以通过大使将请求标签应用于所有请求。</p><pre class="lu lv lw lx gt ly lt lz ma aw mb bi"><span id="8924" class="mc kn iq lt b gy md me l mf mg">---<br/>apiVersion: ambassador/v1<br/>kind: Module<br/>name: ambassador<br/>config:<br/>  default_label_domain: ambassador<br/>  default_labels:<br/>    ambassador:<br/>      defaults:<br/>      - remote_address</span></pre><p id="f711" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><code class="fe lq lr ls lt b">remote_address</code>值告诉Ambassador用客户机IP地址标记每个请求。这允许将外部速率限制服务配置为基于通过Ambassador的每个客户端IP进行速率限制。在Ambassador Pro中，这很容易用一个<code class="fe lq lr ls lt b">RateLimit</code>对象来配置。</p><pre class="lu lv lw lx gt ly lt lz ma aw mb bi"><span id="f0d8" class="mc kn iq lt b gy md me l mf mg">apiVersion: getambassador.io/v1beta1<br/>kind: RateLimit<br/>metadata:<br/>  name: global-rate-limit<br/>spec:<br/>  domain: ambassador<br/>  limits:<br/>  - pattern: [{remote_address: "*"}]<br/>    rate: 10<br/>    unit: second</span></pre><p id="801d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这将配置Ambassador Pro以限制单个用户每秒10个请求。如果用户超过这个限制，Ambassador将使用HTTP 429拒绝请求。</p><h1 id="6335" class="km kn iq bd ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj bi translated">监视</h1><p id="7cea" class="pw-post-body-paragraph jn jo iq jp b jq lk js jt ju ll jw jx jy lm ka kb kc ln ke kf kg lo ki kj kk ij bi translated">通过Ambassador的统计输出，我们可以主动跟踪速率限制配置对系统的影响。</p><figure class="lu lv lw lx gt mi gh gi paragraph-image"><div role="button" tabindex="0" class="mj mk di ml bf mm"><div class="gh gi mh"><img src="../Images/03eb394f948f52f6d28de59717aef213.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*lwwYtX3bMgFc7c-U6PZshA.png"/></div></div></figure><p id="54eb" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这个Grafana仪表板显示了通过大使提出的15分钟的请求。</p><p id="a2fe" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们可以看到，在我们实现速率限制之前，我们后端的可用性是不一致的，向我们的用户返回了大量的500错误(红线)。在Ambassador中配置了每个用户的速率限制后，我们可以看到500的数量下降，200(绿线)的数量上升，因为来自霸道用户的请求被抑制，允许更多的用户访问我们的API。此外，429响应也有所增加(黄线)，因为用户受到速率限制。</p><h1 id="0d91" class="km kn iq bd ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj bi translated">结论</h1><p id="3f33" class="pw-post-body-paragraph jn jo iq jp b jq lk js jt ju ll jw jx jy lm ka kb kc ln ke kf kg lo ki kj kk ij bi translated">速率限制是一种保护您的应用程序免受拒绝服务攻击的强大技术，无论拒绝服务是恶意的还是意外的。为了进一步了解速率限制技术，<a class="ae kl" href="https://www.getambassador.io/user-guide/rate-limiting" rel="noopener ugc nofollow" target="_blank">本文</a>涵盖了速率限制的不同用例及场景。关于Ambassador中速率限制的更多信息，请参见关于<a class="ae kl" href="https://www.getambassador.io/user-guide/rate-limiting-tutorial" rel="noopener ugc nofollow" target="_blank">基本</a>和<a class="ae kl" href="https://www.getambassador.io/user-guide/advanced-rate-limiting" rel="noopener ugc nofollow" target="_blank">高级速率限制</a>的文档。</p><p id="bfb4" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">本文的早期版本  <em class="lp">最初出现在大使博客上。</em></p></div></div>    
</body>
</html>