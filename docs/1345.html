<html>
<head>
<title>Deploying Spinnaker on GKE</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在GKE部署三角帆</h1>
<blockquote>原文：<a href="https://itnext.io/deploying-spinnaker-on-gke-125ef47a8c9?source=collection_archive---------2-----------------------#2018-09-19">https://itnext.io/deploying-spinnaker-on-gke-125ef47a8c9?source=collection_archive---------2-----------------------#2018-09-19</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/ab1cd438f0a9b5bd981fc0dafb118b47.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*kaMgwjBd78_mIFOq5GTHeA.png"/></div></div></figure><p id="83b8" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">Kubernetes可以说已经赢得了容器编排之战，并且已经成为在生产中运行容器的事实上的标准。</p><p id="bf3e" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">GKE(Kubernetes Engine)是一个托管的生产就绪环境，用于部署容器化的应用程序。</p><p id="7d0a" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">谷歌的Kubernetes引擎也有替代品，比如<a class="ae kw" href="https://azure.microsoft.com/en-ca/services/kubernetes-service/" rel="noopener ugc nofollow" target="_blank"> Azure Kubernetes服务</a>或亚马逊的<a class="ae kw" href="https://aws.amazon.com/eks/" rel="noopener ugc nofollow" target="_blank"> EKS </a>，这里有一篇<a class="ae kw" href="https://dzone.com/articles/5-hosted-kubernetes-platforms" rel="noopener ugc nofollow" target="_blank">好文章</a>可能会帮助你决定你想使用哪个提供商。</p><p id="8ef1" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">本指南将引导您完成以下步骤，以便在Google的Kubernetes引擎(GKE)上安装生产就绪的Spinnaker</p><ul class=""><li id="3daf" class="kx ky iq ka b kb kc kf kg kj kz kn la kr lb kv lc ld le lf bi translated">安装升降索</li><li id="5265" class="kx ky iq ka b kb lg kf lh kj li kn lj kr lk kv lc ld le lf bi translated">创建Kubernetes集群和服务帐户</li><li id="6773" class="kx ky iq ka b kb lg kf lh kj li kn lj kr lk kv lc ld le lf bi translated">选择环境</li><li id="a0c7" class="kx ky iq ka b kb lg kf lh kj li kn lj kr lk kv lc ld le lf bi translated">配置持久存储</li><li id="5f60" class="kx ky iq ka b kb lg kf lh kj li kn lj kr lk kv lc ld le lf bi translated">展开三角帆</li><li id="cae3" class="kx ky iq ka b kb lg kf lh kj li kn lj kr lk kv lc ld le lf bi translated">将Spinnaker配置为可公开访问(带身份验证)</li></ul></div><div class="ab cl ll lm hu ln" role="separator"><span class="lo bw bk lp lq lr"/><span class="lo bw bk lp lq lr"/><span class="lo bw bk lp lq"/></div><div class="ij ik il im in"><h2 id="8b55" class="ls lt iq bd lu lv lw dn lx ly lz dp ma kj mb mc md kn me mf mg kr mh mi mj mk bi translated">安装升降索</h2><p id="2fd8" class="pw-post-body-paragraph jy jz iq ka b kb ml kd ke kf mm kh ki kj mn kl km kn mo kp kq kr mp kt ku kv ij bi translated">Halyard管理您的Spinnaker部署的生命周期，包括编写和验证您的部署配置，部署Spinnaker的每个微服务，以及更新部署。</p><p id="e493" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><a class="ae kw" href="https://www.spinnaker.io/setup/install/" rel="noopener ugc nofollow" target="_blank">官方文档</a>建议使用升降索安装Spinnaker，如果您需要任何安装支持，而您没有使用升降索，您将只能靠自己，<a class="ae kw" href="https://www.spinnaker.io/setup/install/halyard/#1-install-halyard" rel="noopener ugc nofollow" target="_blank">此引用</a>来自Spinnaker官方安装指南。</p><blockquote class="mq mr ms"><p id="c951" class="jy jz mt ka b kb kc kd ke kf kg kh ki mu kk kl km mv ko kp kq mw ks kt ku kv ij bi translated">虽然没有升降索也可以安装Spinnaker，但是我们不推荐这样做，如果你遇到困难，我们会告诉你使用升降索。</p></blockquote><p id="e6df" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">也就是说，让我们从<a class="ae kw" href="https://www.spinnaker.io/setup/install/halyard/#1-install-halyard" rel="noopener ugc nofollow" target="_blank">安装升降索</a>开始。</p><p id="2062" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我使用了“<a class="ae kw" href="https://www.spinnaker.io/setup/install/halyard/#install-on-debianubuntu-and-macos" rel="noopener ugc nofollow" target="_blank">在Debian/Ubuntu和macOS上安装</a>”安装，并将其安装在我的MacOS上</p><h2 id="c42e" class="ls lt iq bd lu lv lw dn lx ly lz dp ma kj mb mc md kn me mf mg kr mh mi mj mk bi translated">创建Kubernetes集群和服务帐户</h2><p id="257c" class="pw-post-body-paragraph jy jz iq ka b kb ml kd ke kf mm kh ki kj mn kl km kn mo kp kq kr mp kt ku kv ij bi translated">如果你还没有集群，你可以使用官方文档在GKE上创建一个Kubernetes集群</p><p id="de48" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">按照<a class="ae kw" href="https://cloud.google.com/kubernetes-engine/docs/how-to/cluster-access-for-kubectl#generate_kubeconfig_entry" rel="noopener ugc nofollow" target="_blank">官方文档</a>中所示的说明下载凭证。我们将使用这些凭据创建下面的服务帐户</p><p id="6990" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">鉴于GKE上的所有pod共享相同的服务帐户，授予GKE上的Spinnaker权限也会授予与Spinnaker并行运行的所有pod权限。出于这个原因，我们将为Spinnaker配置一个Kubernetes服务帐户来进行身份验证。</p><p id="2c89" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">创建一个文件<code class="fe mx my mz na b">cluster-admin-role.yml</code>并将该内容粘贴到其中</p><pre class="nb nc nd ne gt nf na ng nh aw ni bi"><span id="f92a" class="ls lt iq na b gy nj nk l nl nm">apiVersion: rbac.authorization.k8s.io/v1<br/>kind: ClusterRoleBinding<br/>metadata:<br/>  name: spinnaker-admin-delete-me-after<br/>roleRef:<br/>  apiGroup: rbac.authorization.k8s.io<br/>  kind: ClusterRole<br/>  name: cluster-admin<br/>subjects:<br/>- kind: User<br/>  name: <a class="ae kw" href="mailto:colin@lottery.com" rel="noopener ugc nofollow" target="_blank">y</a>our-gke-user-account@example.com</span></pre><p id="aa58" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">使用命令可以找到<code class="fe mx my mz na b">your-gke-user-account@example.com</code></p><pre class="nb nc nd ne gt nf na ng nh aw ni bi"><span id="70c2" class="ls lt iq na b gy nj nk l nl nm">gcloud auth list --filter=status:ACTIVE --format="value(account)"</span></pre><blockquote class="mq mr ms"><p id="b952" class="jy jz mt ka b kb kc kd ke kf kg kh ki mu kk kl km mv ko kp kq mw ks kt ku kv ij bi translated">它应该与下载的凭据文件中的电子邮件地址相同</p></blockquote><p id="c86c" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">创建角色:<code class="fe mx my mz na b">kubectl apply -f cluster-admin-role.yml</code></p><p id="ea08" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">现在我们有了正确的权限，可以继续为Spinnaker创建Kubernetes服务帐户了。</p><p id="bf3f" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">首先，创建一个<code class="fe mx my mz na b">k8s-spinnaker-service-account.yml</code>文件并将该内容粘贴到其中，该文件可以在<a class="ae kw" href="https://www.spinnaker.io/setup/install/providers/kubernetes-v2/#optional-configure-kubernetes-roles-rbac" rel="noopener ugc nofollow" target="_blank">这里</a>找到</p><pre class="nb nc nd ne gt nf na ng nh aw ni bi"><span id="9558" class="ls lt iq na b gy nj nk l nl nm">apiVersion: rbac.authorization.k8s.io/v1<br/>kind: ClusterRole<br/>metadata:<br/> name: spinnaker-role<br/>rules:<br/>- apiGroups: [""]<br/>  resources: ["namespaces", "configmaps", "events", "replicationcontrollers", "serviceaccounts", "pods/logs"]<br/>  verbs: ["get", "list"]<br/>- apiGroups: [""]<br/>  resources: ["pods", "services", "secrets"]<br/>  verbs: ["create", "delete", "deletecollection", "get", "list", "patch", "update", "watch"]<br/>- apiGroups: ["autoscaling"]<br/>  resources: ["horizontalpodautoscalers"]<br/>  verbs: ["list", "get"]<br/>- apiGroups: ["apps"]<br/>  resources: ["controllerrevisions", "statefulsets"]<br/>  verbs: ["list"]<br/>- apiGroups: ["extensions", "apps"]<br/>  resources: ["deployments", "replicasets", "ingresses"]<br/>  verbs: ["create", "delete", "deletecollection", "get", "list", "patch", "update", "watch"]<br/># These permissions are necessary for halyard to operate. We use this role also to deploy Spinnaker itself.<br/>- apiGroups: [""]<br/>  resources: ["services/proxy", "pods/portforward"]<br/>  verbs: ["create", "delete", "deletecollection", "get", "list", "patch", "update", "watch"]<br/>---<br/>apiVersion: rbac.authorization.k8s.io/v1<br/>kind: ClusterRoleBinding<br/>metadata:<br/> name: spinnaker-role-binding<br/>roleRef:<br/> apiGroup: rbac.authorization.k8s.io<br/> kind: ClusterRole<br/> name: spinnaker-role<br/>subjects:<br/>- namespace: spinnaker<br/>  kind: ServiceAccount<br/>  name: spinnaker-service-account<br/>---<br/>apiVersion: v1<br/>kind: ServiceAccount<br/>metadata:<br/> name: spinnaker-service-account<br/> namespace: spinnaker</span></pre><p id="b623" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">现在我们可以将它应用到我们的集群中。</p><pre class="nb nc nd ne gt nf na ng nh aw ni bi"><span id="584a" class="ls lt iq na b gy nj nk l nl nm">kubectl apply --context spinnaker -f <!-- -->k8s-spinnaker-service-account.yml</span></pre><p id="f93a" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">获取此服务帐户依赖的令牌:</p><pre class="nb nc nd ne gt nf na ng nh aw ni bi"><span id="d4cb" class="ls lt iq na b gy nj nk l nl nm">TOKEN=$(kubectl get secret --context <!-- -->spinnaker<!-- --> \<br/>   $(kubectl get serviceaccount spinnaker-service-account \<br/>       --context <!-- -->spinnaker<!-- --> \<br/>       -n spinnaker \<br/>       -o jsonpath='{.secrets[0].name}') \<br/>   -n spinnaker \<br/>   -o jsonpath='{.data.token}' | base64 --decode)</span></pre><p id="90d9" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">将此令牌放入名为的新用户的<code class="fe mx my mz na b">kubeconfig</code>中</p><p id="8080" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><code class="fe mx my mz na b">spinnaker-token-user</code></p><pre class="nb nc nd ne gt nf na ng nh aw ni bi"><span id="e8d1" class="ls lt iq na b gy nj nk l nl nm">kubectl config set-credentials spinnaker-token-user --token $TOKEN</span></pre><p id="7598" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">配置您的<code class="fe mx my mz na b">spinnaker</code>上下文来使用这个新用户</p><pre class="nb nc nd ne gt nf na ng nh aw ni bi"><span id="45b7" class="ls lt iq na b gy nj nk l nl nm">kubectl config set-context spinnaker --user spinnaker-token-user</span></pre><p id="2ee8" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">现在，您的<code class="fe mx my mz na b">spinnaker</code>上下文将使用我们上面创建的令牌进行认证。</p><p id="9e5e" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">查看<a class="ae kw" href="https://kubernetes.io/docs/tasks/access-application-cluster/configure-access-multiple-clusters/#define-clusters-users-and-contexts" rel="noopener ugc nofollow" target="_blank">这些文档</a>以了解更多关于上下文的信息以及它们为什么有用。</p><p id="80dc" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">完成这些步骤后，我们可以跳回官方指南并<a class="ae kw" href="https://www.spinnaker.io/setup/install/providers/kubernetes-v2/#adding-an-account" rel="noopener ugc nofollow" target="_blank">添加一个账户</a>。</p><h2 id="89cd" class="ls lt iq bd lu lv lw dn lx ly lz dp ma kj mb mc md kn me mf mg kr mh mi mj mk bi translated">选择环境</h2><p id="09af" class="pw-post-body-paragraph jy jz iq ka b kb ml kd ke kf mm kh ki kj mn kl km kn mo kp kq kr mp kt ku kv ij bi translated">添加帐户后，您需要选择一个环境。如果您计划在生产中使用它，推荐的环境是<a class="ae kw" href="https://www.spinnaker.io/setup/install/environment/#distributed-installation" rel="noopener ugc nofollow" target="_blank">分布式安装</a></p><h2 id="3ef3" class="ls lt iq bd lu lv lw dn lx ly lz dp ma kj mb mc md kn me mf mg kr mh mi mj mk bi translated">配置持久存储</h2><p id="b5d7" class="pw-post-body-paragraph jy jz iq ka b kb ml kd ke kf mm kh ki kj mn kl km kn mo kp kq kr mp kt ku kv ij bi translated">Spinnaker需要一个外部存储提供程序来保存应用程序设置和配置的管道。对于我的安装，我使用了三角帆<a class="ae kw" href="https://www.spinnaker.io/setup/install/storage/gcs/" rel="noopener ugc nofollow" target="_blank"> GCS指南</a></p><p id="945e" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">配置好一切后，我们现在准备部署Spinnaker</p><h2 id="e83c" class="ls lt iq bd lu lv lw dn lx ly lz dp ma kj mb mc md kn me mf mg kr mh mi mj mk bi translated">展开三角帆</h2><p id="cf2e" class="pw-post-body-paragraph jy jz iq ka b kb ml kd ke kf mm kh ki kj mn kl km kn mo kp kq kr mp kt ku kv ij bi translated">部署Spinnaker是容易的部分，只需按照<a class="ae kw" href="https://www.spinnaker.io/setup/install/deploy/" rel="noopener ugc nofollow" target="_blank">这些步骤</a></p><p id="f195" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">就是这样。这应该就是在GKE上设置Spinnaker所需的全部内容。</p><h2 id="1943" class="ls lt iq bd lu lv lw dn lx ly lz dp ma kj mb mc md kn me mf mg kr mh mi mj mk bi translated">将Spinnaker配置为可公开访问(带身份验证)</h2><p id="95df" class="pw-post-body-paragraph jy jz iq ka b kb ml kd ke kf mm kh ki kj mn kl km kn mo kp kq kr mp kt ku kv ij bi translated">为了更容易地访问Spinnaker，您希望能够公开访问它。</p><p id="1faf" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">对于指南的这一部分，让我们假设我们正在使用下面的＄DOMAIN<code class="fe mx my mz na b">cznconsulting.com</code></p><p id="4863" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><a class="ae kw" href="https://www.spinnaker.io/setup/quickstart/halyard-gke-public/#part-0-prerequisites" rel="noopener ugc nofollow" target="_blank">本<a class="ae kw" href="https://www.spinnaker.io/setup/quickstart/halyard-gke-public/" rel="noopener ugc nofollow" target="_blank">导轨</a>的第0部分</a>和<a class="ae kw" href="https://www.spinnaker.io/setup/quickstart/halyard-gke-public/#part-1-configuring-authentication" rel="noopener ugc nofollow" target="_blank">第1部分</a>易于遵循，无需更改。</p><p id="a253" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我无法让第2部分在GKE上工作，旋转平台和旋转门服务上的外部IP陷入了待定状态。</p><p id="769e" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">作为一个变通办法，而且在我看来，对GKE来说这是一个更好的解决方案，我设置了一个入口来将流量路由到这些服务，稍后会详细介绍。</p><p id="c4f1" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">首先导航回<a class="ae kw" href="https://console.developers.google.com/apis/credentials" rel="noopener ugc nofollow" target="_blank"> Google凭证管理器</a>，并使用您的值<code class="fe mx my mz na b">$DOMAIN</code>编辑Spinnaker客户端ID:</p><figure class="nb nc nd ne gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nn"><img src="../Images/3720ab6c1d914e448c7c128957cb6838.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*55p0-Kh4gaN4v6IlDzJS4w.png"/></div></div></figure><figure class="nb nc nd ne gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi no"><img src="../Images/e587aa60aed960346f72cfe9f729539a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*bufEQahOrodQH1lWT70A_g.png"/></div></div><figcaption class="np nq gj gh gi nr ns bd b be z dk translated">在我们的例子中，它应该是这样的:http://spinnaker-api.cznconsulting.com/login</figcaption></figure><p id="4632" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">现在授权UI和API服务器使用Halyard在这些URL接收请求:</p><pre class="nb nc nd ne gt nf na ng nh aw ni bi"><span id="679a" class="ls lt iq na b gy nj nk l nl nm">hal config security ui edit \<br/>    --override-base-url http://spinnaker.cznconsulting.com<br/><br/>hal config security api edit \<br/>    --override-base-url http://spinnaker-api.cznconsulting.com</span></pre><p id="8d04" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">现在，在通过部署Spinnaker最终完成这些更改之前，我们需要编辑位于UI &amp; API服务器前面的<a class="ae kw" href="https://kubernetes.io/docs/concepts/services-networking/service/" rel="noopener ugc nofollow" target="_blank"> Kubernetes服务</a>，以及分别位于<code class="fe mx my mz na b">spinnaker</code>名称空间中的<code class="fe mx my mz na b">spin-deck</code>和<code class="fe mx my mz na b">spin-gate</code>。</p><p id="3cb7" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">运行以下命令</p><pre class="nb nc nd ne gt nf na ng nh aw ni bi"><span id="8252" class="ls lt iq na b gy nj nk l nl nm">kubectl edit svc spin-deck -n spinnaker</span></pre><p id="9dc0" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">您将在文本编辑器中打开服务定义。进行以下粗体标注的更改</p><pre class="nb nc nd ne gt nf na ng nh aw ni bi"><span id="4439" class="ls lt iq na b gy nj nk l nl nm"># Please edit the object below. Lines beginning with a '#' will be ignored,<br/># and an empty file will abort the edit. If an error occurs while saving this file will be<br/># reopened with the relevant failures.<br/>#<br/>apiVersion: v1<br/>kind: Service<br/>metadata:<br/>  creationTimestamp: 2017-06-01T00:57:34Z<br/>  name: spin-deck<br/>  namespace: spinnaker<br/>  resourceVersion: "6038615"<br/>  selfLink: /api/v1/namespaces/spinnaker/services/spin-deck<br/>  uid: 4c1fb82f-4165-11e7-888f-42020a8a0a12<br/>spec:<br/>  clusterIP: 10.127.244.30<br/>  ports:<br/>  - <strong class="na ir">port: 9000</strong>                          <br/>    protocol: TCP<br/>    targetPort: 9000<br/>  selector:<br/>    load-balancer-spin-deck: "true"<br/>  sessionAffinity: None<br/>  <strong class="na ir">type: NodePort  </strong>                 <br/>                                       <br/>status:<br/>  loadBalancer: {}</span></pre><p id="451b" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">现在重复这一步骤，但针对<code class="fe mx my mz na b">spin-gate</code></p><pre class="nb nc nd ne gt nf na ng nh aw ni bi"><span id="2190" class="ls lt iq na b gy nj nk l nl nm">kubectl edit svc spin-gate -n spinnaker</span></pre><p id="69b1" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">您将在文本编辑器中打开服务定义。进行以下粗体标注的更改</p><pre class="nb nc nd ne gt nf na ng nh aw ni bi"><span id="8721" class="ls lt iq na b gy nj nk l nl nm"># Please edit the object below. Lines beginning with a '#' will be ignored,<br/># and an empty file will abort the edit. If an error occurs while saving this file will be<br/># reopened with the relevant failures.<br/>#<br/>apiVersion: v1<br/>kind: Service<br/>metadata:<br/>  creationTimestamp: 2017-06-01T00:57:32Z<br/>  name: spin-gate<br/>  namespace: spinnaker<br/>  resourceVersion: "6038615"<br/>  selfLink: /api/v1/namespaces/spinnaker/services/spin-gate<br/>  uid: 1c4fd288-818a-166e-888f-45251eee0d92<br/>spec:<br/>  clusterIP: 10.127.244.29<br/>  ports:<br/>  - <strong class="na ir">port: 8084</strong>                           <br/>    protocol: TCP<br/>    targetPort: 8084<br/>  selector:<br/>    load-balancer-spin-gate: "true"<br/>  sessionAffinity: None<br/>  <strong class="na ir">type: NodePort</strong>                   </span><span id="ba3f" class="ls lt iq na b gy nt nk l nl nm">status:<br/>  loadBalancer: {}</span></pre><p id="c9fd" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><strong class="ka ir">原生</strong> GKE入口控制器<a class="ae kw" href="https://github.com/kubernetes/kubernetes/issues/26508#issuecomment-222376886" rel="noopener ugc nofollow" target="_blank">目前只支持</a>节点端口</p><p id="7cb1" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">最后，重新部署Spinnaker</p><pre class="nb nc nd ne gt nf na ng nh aw ni bi"><span id="7fdd" class="ls lt iq na b gy nj nk l nl nm">hal deploy apply</span></pre><p id="6c73" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我们最终将更新我们的DNS设置并创建一个记录来将我们的子域指向一个静态IP，所以我们需要首先创建静态IP。</p><pre class="nb nc nd ne gt nf na ng nh aw ni bi"><span id="8d10" class="ls lt iq na b gy nj nk l nl nm">gcloud compute addresses create spinnaker-static-ip --global</span></pre><p id="d346" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">现在我们准备创建入口资源。我推荐阅读这篇<a class="ae kw" href="https://medium.com/google-cloud/kubernetes-nodeport-vs-loadbalancer-vs-ingress-when-should-i-use-what-922f010849e0" rel="noopener">解释入口是什么的优秀文章</a>。</p><p id="db98" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">首先，创建一个名为<code class="fe mx my mz na b">spinnaker-ingress.yml</code>的文件，并将以下内容粘贴到其中。</p><pre class="nb nc nd ne gt nf na ng nh aw ni bi"><span id="1fde" class="ls lt iq na b gy nj nk l nl nm">apiVersion: extensions/v1beta1<br/>kind: Ingress<br/>metadata:<br/>  name: spinnaker-ingress<br/>  annotations:<br/>    <strong class="na ir">kubernetes.io/ingress.global-static-ip-name: "spinnaker-static-ip"</strong><br/>  namespace: spinnaker<br/>spec:<br/>  rules:<br/>  - host: spinnaker-api.cznconsulting.com<br/>    http:<br/>      paths:<br/>      - backend:<br/>          serviceName: spin-gate<br/>          servicePort: 8084<br/>  - host: spinnaker.cznconsulting.com<br/>    http:<br/>      paths:<br/>      - backend:<br/>          serviceName: spin-deck<br/>          servicePort: 9000</span></pre><p id="9fac" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><strong class="ka ir">注意</strong>:注释部分指定新创建的静态IP应该与该入口相关联</p><p id="805a" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">现在，我们可以将它应用到我们的集群中，这将为我们创建一个新的负载平衡器。</p><pre class="nb nc nd ne gt nf na ng nh aw ni bi"><span id="5152" class="ls lt iq na b gy nj nk l nl nm">kubectl apply -f spinnaker-ingress.yml</span></pre><p id="6c76" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我们需要采取最后一个步骤来使其工作，这是因为github的<a class="ae kw" href="https://github.com/kubernetes/ingress-gce/issues/42" rel="noopener ugc nofollow" target="_blank">现有问题</a>与<a class="ae kw" href="https://github.com/kubernetes/ingress-gce" rel="noopener ugc nofollow" target="_blank"> ingress-gce </a></p><p id="8877" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我们需要在新创建的负载平衡器上手动更新运行状况检查。</p><p id="7367" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">首先，确定失败的运行状况检查</p><pre class="nb nc nd ne gt nf na ng nh aw ni bi"><span id="47b4" class="ls lt iq na b gy nj nk l nl nm">kubectl describe ingress spinnaker-ingress -n spinnaker</span></pre><p id="aa26" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">该命令将显示如下内容，只是有一个服务不正常</p><figure class="nb nc nd ne gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nu"><img src="../Images/ff99433b54420905c4e60a530ee4989a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*KRP7XJz0Q3_ELXhw9CnM4g.png"/></div></div></figure><p id="24e0" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">一旦你确定了不健康的服务，前往<a class="ae kw" href="https://console.cloud.google.com/compute/healthChecks" rel="noopener ugc nofollow" target="_blank">谷歌云控制台</a>，通过编辑失败的健康检查，将健康检查从<code class="fe mx my mz na b">/</code>更新到<code class="fe mx my mz na b">/health</code>。这是因为spin-gate不会在其服务的<code class="fe mx my mz na b">/</code>路径上返回20X的http状态代码，但<code class="fe mx my mz na b">spin-deck</code>会，所以您只需更新/编辑一个健康检查。</p><p id="f789" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">如果您给它一两分钟时间并再次运行下面的命令，您应该会看到所有后端现在都报告为健康。</p><pre class="nb nc nd ne gt nf na ng nh aw ni bi"><span id="4486" class="ls lt iq na b gy nj nk l nl nm">kubectl describe ingress spinnaker-ingress -n spinnaker</span></pre><p id="0a36" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">关于该命令还有一条对最后一步有用的信息，那就是在<code class="fe mx my mz na b">Address</code>块中报告的静态IP。</p><p id="0a9a" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">使用该IP来配置您的DNS提供商，并为子域<code class="fe mx my mz na b">spinnaker.yourdomainhere.com</code>和<code class="fe mx my mz na b">spinnaker-api.yourdomainhere.com</code>创建两个A记录，并将它们指向上面的静态IP。</p><p id="f327" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">如果一切顺利，您将拥有一个功能正常的spinnaker安装，它可以通过Google OAuth认证公开使用。</p></div></div>    
</body>
</html>