<html>
<head>
<title>Getting started with FastAPI and MySQL</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">FastAPI和MySQL入门</h1>
<blockquote>原文：<a href="https://itnext.io/getting-started-with-fastapi-and-mysql-96e720cc761a?source=collection_archive---------2-----------------------#2021-01-30">https://itnext.io/getting-started-with-fastapi-and-mysql-96e720cc761a?source=collection_archive---------2-----------------------#2021-01-30</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/b67fc1c5cdc4b7124ef6349d17c15c05.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*JMvf08SjYMNAAcHRAjYm0g.jpeg"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">尼古拉斯·霍伊泽在<a class="ae kc" href="https://unsplash.com/s/photos/fast?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</figcaption></figure><p id="fb91" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这篇文章是FastAPI系列的一部分。</p><p id="d1c6" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在第一篇<a class="ae kc" href="http://blog.adnansiddiqi.me/create-your-first-rest-api-in-fastapi/" rel="noopener ugc nofollow" target="_blank">帖子</a>中，我向您介绍了FastAPI以及如何在其中创建高性能的基于Python的应用程序。在本文中，我们将研究与MySQL数据库交互的Rest APIs。我们还将探讨如何在多个文件中组织路由器和模型，使它们更易于维护和阅读。</p><p id="2b64" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">FastAPI并不要求您使用特定的数据库框架。您可以使用SQLAlchemy或任何其他您想要的。我更喜欢用<a class="ae kc" href="http://blog.adnansiddiqi.me/develop-database-driven-applications-in-python-with-peewee/" rel="noopener ugc nofollow" target="_blank"> peewee </a>，因为它更有表现力，也更容易使用。</p><h1 id="9163" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">安装Peewee和MySQL驱动程序</h1><p id="779d" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">在开始在我们的应用程序中使用MySQL之前，我们必须准备好所有的东西。为此，我们将首先安装<code class="fe me mf mg mh b">peewee</code> ORM。</p><figure class="mj mk ml mm gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mi"><img src="../Images/2cee96dc6bfdcc7d0f0e915c09094238.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*O-YXmveTUnCcgSeI.png"/></div></div></figure><p id="fc44" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我将创建一个名为<code class="fe me mf mg mh b">database.py</code>的单独文件，并向其中添加以下代码。</p><pre class="mj mk ml mm gt mn mh mo mp aw mq bi"><span id="554f" class="mr lc iq mh b gy ms mt l mu mv">from peewee import *</span><span id="89e6" class="mr lc iq mh b gy mw mt l mu mv">user = 'root'<br/>password = 'root'<br/>db_name = 'fastapi_contact'</span><span id="7ff6" class="mr lc iq mh b gy mw mt l mu mv">conn = MySQLDatabase(<br/>    db_name, user=user,<br/>    password=password,<br/>    host='localhost'<br/>)</span><span id="e3bf" class="mr lc iq mh b gy mw mt l mu mv">class BaseModel(Model):<br/>    class Meta:<br/>        database = conn</span></pre><p id="c42e" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我导入了框架并创建了一个<code class="fe me mf mg mh b">MySQLDatabase</code>对象。我正在传递所有必需的凭证，以确保连接成功。</p><p id="88e9" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">但是等等…在我们运行服务器之前，我们还需要安装MySQL驱动程序。我将使用PyMySQL来连接MySQL数据库，否则您将会看到以下错误:</p><pre class="mj mk ml mm gt mn mh mo mp aw mq bi"><span id="5333" class="mr lc iq mh b gy ms mt l mu mv">self._state.set_connection(self._connect())<br/>  File "/Users/AdnanAhmad/.local/share/virtualenvs/ContactAPI-Ycq5CXn7/lib/python3.9/site-packages/peewee.py", line 3964, in _connect<br/>    raise ImproperlyConfigured('MySQL driver not installed!')<br/>peewee.ImproperlyConfigured: MySQL driver not installed!</span><span id="9db4" class="mr lc iq mh b gy mw mt l mu mv">&lt;a href="<a class="ae kc" href="http://blog.adnansiddiqi.me/wp-content/uploads/2021/01/fastapi_install_pymysql.png" rel="noopener ugc nofollow" target="_blank">http://blog.adnansiddiqi.me/wp-content/uploads/2021/01/fastapi_install_pymysql.png</a>"&gt;&lt;img class="aligncenter size-large wp-image-2374" src="<a class="ae kc" href="http://blog.adnansiddiqi.me/wp-content/uploads/2021/01/fastapi_install_pymysql-1024x734.png" rel="noopener ugc nofollow" target="_blank">http://blog.adnansiddiqi.me/wp-content/uploads/2021/01/fastapi_install_pymysql-1024x734.png</a>" alt="" width="960" height="688" /&gt;&lt;/a&gt;</span></pre><p id="f81f" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">到目前为止一切顺利。现在我将更改<code class="fe me mf mg mh b">main.py</code>来导入<code class="fe me mf mg mh b">database.py</code>文件内容。</p><pre class="mj mk ml mm gt mn mh mo mp aw mq bi"><span id="d1ce" class="mr lc iq mh b gy ms mt l mu mv">app = FastAPI(title='Contact.ly', description='APIs for contact Apis', version='0.1')</span><span id="acf3" class="mr lc iq mh b gy mw mt l mu mv"><a class="ae kc" href="http://twitter.com/app" rel="noopener ugc nofollow" target="_blank">@app</a>.on_event("startup")<br/>async def startup():<br/>    print("Connecting...")</span><span id="225a" class="mr lc iq mh b gy mw mt l mu mv"><a class="ae kc" href="http://twitter.com/app" rel="noopener ugc nofollow" target="_blank">@app</a>.get("/")<br/>async def root():<br/>    return {"message": "Contact Applications!"}</span></pre><p id="46b0" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">发生了几件事，但让我先讨论其中重要的一件:<a class="ae kc" href="https://fastapi.tiangolo.com/advanced/events/" rel="noopener ugc nofollow" target="_blank"> FastAPI事件</a>。</p><h1 id="12c8" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">FastAPI事件</h1><p id="f71f" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">FastAPI提供了几个可以在应用程序中使用的事件:启动和关闭。</p><p id="70c5" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><strong class="kf ir">启动事件</strong>:该事件负责在启动应用程序时执行某些任务。启动应用程序意味着当你到达某个API端点时，它首先被执行。像连接数据库这样的任务是在做任何事情之前必须执行的任务之一。</p><p id="c906" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><strong class="kf ir">关机事件:</strong>该事件在app退出或关机时触发。在离开应用程序之前，您可能希望使用此事件来存储所有信息。</p><p id="fa09" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这些事件的优点是，您不必在每个API端点中调用代码。</p><p id="b383" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">正如您现在所理解的，我正在连接启动事件的数据库。</p><p id="bce0" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">另一件事你可能已经注意到了，我在<code class="fe me mf mg mh b">FastAPI</code>构造函数中传递了一些命名参数。当我这样做时，它会产生如下所示的内容:</p><figure class="mj mk ml mm gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mi"><img src="../Images/8e15ccc6916c955ac610eb2c02b263f0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*qCIIPSnpwZdf49mk.png"/></div></div></figure><p id="0ada" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">看起来好多了，不是吗？</p><p id="ad33" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">现在我必须创建路由器、模型、数据库连接等。这些都在一个文件中会使应用程序变得臃肿。我现在将创建两个文件夹，分别名为<code class="fe me mf mg mh b">models</code>和<code class="fe me mf mg mh b">routers</code>。我还在根文件夹中创建了一个文件<code class="fe me mf mg mh b">database.py</code>，它将实例化<code class="fe me mf mg mh b">MySQLDatabase</code>类对象。</p><h1 id="f1c0" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">什么是APIRouter</h1><p id="a04f" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">如果你有一个小的应用程序，把你所有的路线放在一个单独的<code class="fe me mf mg mh b">main.py</code>文件中是可以的，但是如果你在一个大的系统上工作，那么把所有的路线放在一个单独的文件中会使它变得笨拙和臃肿。如果我们可以按照实体或应用程序组织一组路由器，那该有多好？像姜戈提供的东西。</p><p id="c428" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">FastAPI的<a class="ae kc" href="https://fastapi.tiangolo.com/tutorial/bigger-applications/?h=+apirouter#apirouter" rel="noopener ugc nofollow" target="_blank"> APIRouter </a>可以帮助你在多个文件中组织你的路由和逻辑。</p><p id="f53e" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在根文件夹中，我创建了一个名为<code class="fe me mf mg mh b">routers</code>的文件夹，我将在其中添加我的联系API相关的路由器。我在里面加了一个<code class="fe me mf mg mh b">__init.py__</code>把它变成一个包。你可以不做这件事。我正在添加我的路线文件，<code class="fe me mf mg mh b">contact.py</code>，其内容如下:</p><pre class="mj mk ml mm gt mn mh mo mp aw mq bi"><span id="4b19" class="mr lc iq mh b gy ms mt l mu mv">from fastapi import APIRouter</span><span id="a878" class="mr lc iq mh b gy mw mt l mu mv">router_contacts = APIRouter(<br/>    prefix="/contacts",<br/>    tags=["contacts"]<br/>)</span><span id="5f39" class="mr lc iq mh b gy mw mt l mu mv"><a class="ae kc" href="http://twitter.com/router_contacts" rel="noopener ugc nofollow" target="_blank">@router_contacts</a>.get("/",summary="List of contacts", description="Returns all contacts" )<br/>async def get_contacts():<br/>    #create(first_name='Addu', last_name='Pagal', <a class="ae kc" href="mailto:email='addu@gmail.com" rel="noopener ugc nofollow" target="_blank">email='addu@gmail.com</a>', phone='123-494', status=1)<br/>    return [{'status': 'OK'}]</span></pre><p id="7c75" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我通过传递两个参数创建了一个<code class="fe me mf mg mh b">APIRouter</code>对象:<em class="mx">前缀</em>和<em class="mx">标签。这让我们可以在每个端点添加<code class="fe me mf mg mh b">/contacts/</code>。</em></p><p id="0602" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我还添加了在文档中渲染的<code class="fe me mf mg mh b">summary</code>和<code class="fe me mf mg mh b">description</code>参数。</p><p id="994a" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">FastAPI还允许您使用<em class="mx"> docstring </em>来记录您的API端点。例如:</p><pre class="mj mk ml mm gt mn mh mo mp aw mq bi"><span id="93ac" class="mr lc iq mh b gy ms mt l mu mv"><a class="ae kc" href="http://twitter.com/router_contacts" rel="noopener ugc nofollow" target="_blank">@router_contacts</a>.get("/view/{id}", summary="Returns a single contact")<br/>async def view(id: int):<br/>    """<br/>        To view all details related to a single contact</span><span id="79a8" class="mr lc iq mh b gy mw mt l mu mv">- **id**: The integer id of the contact you want to view details.<br/>    """<br/>    return [{'status': 'OK'}]</span></pre><p id="3f0a" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这里我使用了带有markdown的<em class="mx"> docstring </em>。渲染时，它显示为:</p><figure class="mj mk ml mm gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi my"><img src="../Images/efe268b75da3fdcc6686c3e3102b6e79.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*D2AsP2C_n4ZwyCLi.png"/></div></div></figure><p id="bfa8" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">很酷，不是吗？在如何显示API端点文档方面，Docstring 为您提供了更多的灵活性。</p><p id="189e" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><em class="mx">标签</em>有助于将应用相关的API组织在文档中的一个位置。它们也在OpenAPI中使用。例如，当我访问<code class="fe me mf mg mh b">http://localhost:8080/openapi.json</code>时，它会显示以下内容，您可以在其中看到给出的标签。</p><pre class="mj mk ml mm gt mn mh mo mp aw mq bi"><span id="71d1" class="mr lc iq mh b gy ms mt l mu mv">{"openapi":"3.0.2","info":{"title":"Contact.ly","description":"APIs for contact Apis","version":"0.1"},"paths":{"/":{"get":{"summary":"Root","operationId":"root__get","responses":{"200":{"description":"Successful Response","content":{"application/json":{"schema":{}}}}}}},"/contacts/":{"get":{"tags":["contacts"],"summary":"List of contacts","description":"Returns all contacts","operationId":"get_contacts_contacts__get","responses":{"200":{"description":"Successful Response","content":{"application/json":{"schema":{}}}}}}},"/contacts/view/{id}":{"get":{"tags":["contacts"],"summary":"View","description":"Returns a single contact","operationId":"view_contacts_view__id__get","parameters":[{"required":true,"schema":{"title":"Id","type":"integer"},"name":"id","in":"path"}],"responses":{"200":{"description":"Successful Response","content":{"application/json":{"schema":{}}}},"422":{"description":"Validation Error","content":{"application/json":{"schema":{"$ref":"#/components/schemas/HTTPValidationError"}}}}}}}},"components":{"schemas":{"HTTPValidationError":{"title":"HTTPValidationError","type":"object","properties":{"detail":{"title":"Detail","type":"array","items":{"$ref":"#/components/schemas/ValidationError"}}}},"ValidationError":{"title":"ValidationError","required":["loc","msg","type"],"type":"object","properties":{"loc":{"title":"Location","type":"array","items":{"type":"string"}},"msg":{"title":"Message","type":"string"},"type":{"title":"Error Type","type":"string"}}}}}}</span></pre><p id="e71b" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们已经创建了我们的路线文件，但事情还没有完成。我们必须在<code class="fe me mf mg mh b">main.py</code>文件中调用它们。在主文件中，我将进行以下更改。</p><pre class="mj mk ml mm gt mn mh mo mp aw mq bi"><span id="99f4" class="mr lc iq mh b gy ms mt l mu mv">from routers import contact</span><span id="dc2b" class="mr lc iq mh b gy mw mt l mu mv">app = FastAPI(title='Contact.ly', description='APIs for contact Apis', version='0.1')<br/>app.include_router(contact.router_contacts)</span></pre><p id="61c1" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">由于<code class="fe me mf mg mh b">routers</code>文件夹现在是一个包，所以我可以调用<code class="fe me mf mg mh b">router_contacts</code>变量并将其传递给<code class="fe me mf mg mh b">include_router</code>函数。</p><p id="e1d4" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">完成新的联系后，相关路线将出现在文档页面上。</p><h1 id="189a" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">Peewee模型</h1><p id="dc21" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">正如我提到的，我将使用<em class="mx"> peewee </em> ORM而不是SqlAlchemy，我将为此创建相关的模型。在此之前，让我们看看<code class="fe me mf mg mh b">database.py</code>文件会是什么样子。这个文件将包含<code class="fe me mf mg mh b">MySQLDatabase</code>类的类对象，所有需要的参数都传递给它。</p><p id="be28" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">下面的<code class="fe me mf mg mh b">database.py</code>将会是这样的:</p><pre class="mj mk ml mm gt mn mh mo mp aw mq bi"><span id="9ea7" class="mr lc iq mh b gy ms mt l mu mv">from peewee import *</span><span id="cb74" class="mr lc iq mh b gy mw mt l mu mv">user = 'root'<br/>password = 'root'<br/>db_name = 'fastapi_contact'</span><span id="72c3" class="mr lc iq mh b gy mw mt l mu mv">conn = MySQLDatabase(<br/>    db_name, user=user,<br/>    password=password,<br/>    host='localhost'<br/>)</span></pre><p id="1913" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">后来，在<code class="fe me mf mg mh b">main.py</code>文件中，我打算这样称呼它:</p><pre class="mj mk ml mm gt mn mh mo mp aw mq bi"><span id="66ee" class="mr lc iq mh b gy ms mt l mu mv">from database import *</span><span id="5e47" class="mr lc iq mh b gy mw mt l mu mv"><a class="ae kc" href="http://twitter.com/app" rel="noopener ugc nofollow" target="_blank">@app</a>.on_event("startup")<br/>async def startup():<br/>    if conn.is_closed():<br/>        conn.connect()</span><span id="28c8" class="mr lc iq mh b gy mw mt l mu mv"><a class="ae kc" href="http://twitter.com/app" rel="noopener ugc nofollow" target="_blank">@app</a>.on_event("shutdown")<br/>async def shutdown():<br/>    print("Closing...")<br/>    if not conn.is_closed():<br/>        conn.close()</span></pre><p id="88ed" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">因此，无论何时访问任何API端点，它都会创建一个连接，然后在所有执行完成后关闭它。</p><p id="e2f7" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">现在模型…我将创建几个模型:一个<code class="fe me mf mg mh b">BaseModel</code>负责将模型与MySQL数据库关联起来，一个<code class="fe me mf mg mh b">Contact</code>负责处理<code class="fe me mf mg mh b">contacts</code>表。我假设已经创建了该表，因此没有覆盖它。要了解更多，你可以在这里查看我的文章<a class="ae kc" href="http://blog.adnansiddiqi.me/develop-database-driven-applications-in-python-with-peewee/" rel="noopener ugc nofollow" target="_blank"/>。</p><pre class="mj mk ml mm gt mn mh mo mp aw mq bi"><span id="e0a2" class="mr lc iq mh b gy ms mt l mu mv">from peewee import *<br/>from database import conn</span><span id="669e" class="mr lc iq mh b gy mw mt l mu mv">class BaseModel(Model):<br/>    class Meta:<br/>        database = conn</span></pre><p id="2ba5" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">和<code class="fe me mf mg mh b">contact.py</code></p><pre class="mj mk ml mm gt mn mh mo mp aw mq bi"><span id="19ee" class="mr lc iq mh b gy ms mt l mu mv">from peewee import *</span><span id="3725" class="mr lc iq mh b gy mw mt l mu mv">from .Base import BaseModel</span><span id="a515" class="mr lc iq mh b gy mw mt l mu mv">class Contact(BaseModel):<br/>    first_name = CharField(max_length=30)<br/>    last_name = CharField(max_length=30)<br/>    email = CharField(max_length=40)<br/>    phone = CharField(max_length=25)<br/>    status = SmallIntegerField()<br/>    updated_at = DateTimeField()</span><span id="6916" class="mr lc iq mh b gy mw mt l mu mv">class Meta:<br/>        db_table = 'contacts'</span></pre><p id="627a" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们将创建<strong class="kf ir"> CRUD </strong>端点来管理整个应用程序，即用于创建记录、更新、删除和检索的API端点。</p><p id="aa71" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我将创建我们的第一个联系人API端点，它将在数据库中添加一个联系人。在<code class="fe me mf mg mh b">models/contact.py</code>中，我将创建一个数据插入方法:</p><pre class="mj mk ml mm gt mn mh mo mp aw mq bi"><span id="2b3b" class="mr lc iq mh b gy ms mt l mu mv">async def create_contact(first_name: str, last_name: str, email: str, phone: str, status: int):<br/>    contact_object = Contact(<br/>        first_name=first_name,<br/>        last_name=last_name,<br/>        email=email,<br/>        phone=phone,<br/>        status=status<br/>    )<br/>    contact_object.save()<br/>    return contact_object</span></pre><p id="98f5" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">相当直接。我创建了一个<code class="fe me mf mg mh b">Contact</code>对象，并在其中传递了所需的参数。现在注意了。<code class="fe me mf mg mh b">create_contact</code>模型方法正在返回一个<code class="fe me mf mg mh b">ModelSelect</code>对象，这个对象对我们没有用，因为它包含了一些与peewee相关的信息，因此我们需要一个Pydantic模型来处理它。这并不简单，所以让我们开始吧！</p><p id="da17" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">首先，我将创建一个将peewee模型映射到Pydantic模型的类。代码<a class="ae kc" href="https://fastapi.tiangolo.com/advanced/sql-databases-peewee/?h=+sql" rel="noopener ugc nofollow" target="_blank">取自</a>FastAPI官网:</p><pre class="mj mk ml mm gt mn mh mo mp aw mq bi"><span id="cec1" class="mr lc iq mh b gy ms mt l mu mv">class PeeweeGetterDict(GetterDict):<br/>    def get(self, key: Any, default: Any = None):<br/>        res = getattr(self._obj, key, default)<br/>        if isinstance(res, peewee.ModelSelect):<br/>            return list(res)<br/>        return res</span></pre><p id="666d" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">接下来，我们将创建联系人的Pydantic模型:</p><pre class="mj mk ml mm gt mn mh mo mp aw mq bi"><span id="b9f9" class="mr lc iq mh b gy ms mt l mu mv">class ContactModel(BaseModel):<br/>    id:int<br/>    first_name:str<br/>    last_name:str<br/>    email:str</span><span id="93c2" class="mr lc iq mh b gy mw mt l mu mv">class Config:<br/>        orm_mode = True<br/>        getter_dict = PeeweeGetterDict</span></pre><p id="c006" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">添加了我们想要显示的字段后，我将<code class="fe me mf mg mh b">orm_mode</code>设置为<code class="fe me mf mg mh b">True</code>，然后将<code class="fe me mf mg mh b">getter_dict</code>参数设置为我们刚刚创建的类<code class="fe me mf mg mh b">PeeweeGetterDict</code>，这是Pydantic提供的。欲了解更多信息，您可以访问<a class="ae kc" href="https://pydantic-docs.helpmanual.io/usage/model_config/" rel="noopener ugc nofollow" target="_blank">这里</a>。<strong class="kf ir"> orm_mode </strong>实际上将orm模型对象映射到Pydantic对象，因此我们不需要手动构造一个返回对象。</p><p id="c242" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">接下来，我将创建一个用于创建新联系人的POST端点。</p><pre class="mj mk ml mm gt mn mh mo mp aw mq bi"><span id="f257" class="mr lc iq mh b gy ms mt l mu mv">from models.contact import create_contact</span><span id="4c1b" class="mr lc iq mh b gy mw mt l mu mv"><a class="ae kc" href="http://twitter.com/router_contacts" rel="noopener ugc nofollow" target="_blank">@router_contacts</a>.post("/", summary="Create a new contact")<br/>async def create(first_name: str, last_name: str, email: str, phone: str, status: int):<br/>    return await create_contact(first_name=first_name, last_name=last_name, email=email, phone=phone, status=status)</span></pre><p id="2fec" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">你不必让一个函数成为<code class="fe me mf mg mh b">async</code>函数。FastAPI两者都支持。总之，我正在创建一个<code class="fe me mf mg mh b">POST</code>端点，它接受一个JSON对象作为输入并创建一条记录。为了简单起见，我在这里只是返回一个OK，但是在现实世界的应用程序中，您将负责所有的异常和其他东西。</p><p id="2ca9" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">让我们点击<code class="fe me mf mg mh b">/doc</code>来创造我们的第一个记录。当它被创建时，它返回如下:</p><figure class="mj mk ml mm gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mi"><img src="../Images/9078b9e404123371d1853e39a067d64f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*9rvZRnNtQjIxp089.png"/></div></div></figure><p id="e7f6" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">嗯，它确实成功返回了，但是你喜欢返回的JSON响应吗？我不知道。它只是返回由peewee对象抛出的任何东西。如何让它变得更好，是的，你答对了！通过使用<code class="fe me mf mg mh b">response_model</code>参数。API例程现在将如下所示:</p><pre class="mj mk ml mm gt mn mh mo mp aw mq bi"><span id="d006" class="mr lc iq mh b gy ms mt l mu mv"><a class="ae kc" href="http://twitter.com/router_contacts" rel="noopener ugc nofollow" target="_blank">@router_contacts</a>.post("/", response_model=ContactModel, summary="Create a new contact")<br/>async def create(first_name: str, last_name: str, email: str, phone: str, status: int):<br/>    return await create_contact(first_name=first_name, last_name=last_name, email=email, phone=phone, status=status)</span></pre><p id="0e10" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">现在让我们再创造一次。太棒了。如您所见，输出看起来不再令人讨厌。它展示了我们想要展示的东西。</p><figure class="mj mk ml mm gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mi"><img src="../Images/f785438ecf8aa52812d9d353a8e550a6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*_PO9igTCXYgcaA0g.png"/></div></div></figure><p id="e8de" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我的MYSQL客户端显示新插入的数据。</p><figure class="mj mk ml mm gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mi"><img src="../Images/106044dffbd3f58761ac344013c11d2c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*834VZP60HiUUDlGP.png"/></div></div></figure><p id="889f" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我将在这里创建几个端点，一个用于列表，另一个用于删除。更新是你自己要做的事情😉</p><p id="61bf" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在<code class="fe me mf mg mh b">models/contact.py</code>中，我添加了一个例程来列出所有联系人，默认情况下最多100个条目。</p><pre class="mj mk ml mm gt mn mh mo mp aw mq bi"><span id="5014" class="mr lc iq mh b gy ms mt l mu mv">def list_contacts(skip: int = 0, limit: int = 100):<br/>    return list(Contact.select().offset(skip).limit(limit))</span></pre><p id="0d49" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">然后在<code class="fe me mf mg mh b">routers/contact.py</code>中，我会这样做:</p><pre class="mj mk ml mm gt mn mh mo mp aw mq bi"><span id="ff44" class="mr lc iq mh b gy ms mt l mu mv"><a class="ae kc" href="http://twitter.com/router_contacts" rel="noopener ugc nofollow" target="_blank">@router_contacts</a>.get("/", response_model=List[ContactModel], summary="List of contacts", description="Returns all contacts")<br/>def get_contacts():<br/>    return list_contacts()</span></pre><p id="667c" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这与个人接触是一样的。唯一的区别是<code class="fe me mf mg mh b">response_model</code>是类型<code class="fe me mf mg mh b">List</code>，这样做的原因是模型返回一个列表，所以我们的模型也应该是一个列表。在执行时，它显示如下:</p><figure class="mj mk ml mm gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mi"><img src="../Images/7d5dcf431369b3086fb4f88d628752d0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*Ti1qUyBb8bLfs44B.png"/></div></div></figure><p id="7c67" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">为了删除记录，我将在模型文件中添加以下内容:</p><pre class="mj mk ml mm gt mn mh mo mp aw mq bi"><span id="f21b" class="mr lc iq mh b gy ms mt l mu mv">def delete_contact(id: int):<br/>    return Contact.delete().where(Contact.id == id).execute()</span></pre><p id="e285" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">并且在<code class="fe me mf mg mh b">routers/contact.py</code></p><pre class="mj mk ml mm gt mn mh mo mp aw mq bi"><span id="f824" class="mr lc iq mh b gy ms mt l mu mv"><a class="ae kc" href="http://twitter.com/router_contacts" rel="noopener ugc nofollow" target="_blank">@router_contacts</a>.delete(<br/>    "/remove/{id}",<br/>    summary="Delete an individual contact",<br/>    response_class=Response,<br/>    responses={<br/>        200: {"description": "Contact successfully deleted"},<br/>        404: {"description": "Contact not found"},<br/>    },<br/>)<br/>def remove_contact(id: int):<br/>    del_contact = delete_contact(id)<br/>    if del_contact is None:<br/>        return Response(status_code=404)<br/>    return Response(status_code=200)</span></pre><p id="2f0f" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在<code class="fe me mf mg mh b">delete</code>装饰器中，我添加了另一个参数<code class="fe me mf mg mh b">responses</code>,并为每个HTTP状态消息添加了应该在文档中显示的消息。</p><figure class="mj mk ml mm gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mi"><img src="../Images/50d5263ef44ccb9971ee0b1dcce5a10b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*ZbMbzqXl-6HM7poA.png"/></div></div></figure><p id="093e" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">看起来好多了，不是吗？</p><p id="a839" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在我结束这篇文章之前，我想谈谈另一件事:模板！！！！</p><h1 id="9006" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">FastAPI模板</h1><p id="79c4" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">就像Flask一样，你也可以在FastAPI中使用<a class="ae kc" href="https://fastapi.tiangolo.com/advanced/templates/?h=+templ" rel="noopener ugc nofollow" target="_blank"> Jinja2或任何其他模板</a>。您可能不需要这个特性，但是如果您需要提供简单的HTML，例如一个登录表单，那么可以使用这个特性。</p><p id="c869" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我将首先安装<strong class="kf ir"> Jinja2 </strong>:</p><p id="4666" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><code class="fe me mf mg mh b">pipenv install jinja2</code></p><p id="4478" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">为了提供静态文件，您还需要<code class="fe me mf mg mh b">pipenv install aiofiles</code>。</p><p id="7a5a" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">为了举例，我将创建查看联系人详细信息的HTML版本。</p><p id="77e0" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我创建了两个文件夹:<em class="mx">静态</em>和<em class="mx">模板</em>。静态的将包含所有的资产，而HTML文件和模板模板。我只是创建了一个简单的HTML文件的演示目的和一个简单的CSS文件。</p><p id="2f9d" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在<code class="fe me mf mg mh b">main.py</code>,我做了以下改变:</p><pre class="mj mk ml mm gt mn mh mo mp aw mq bi"><span id="55c8" class="mr lc iq mh b gy ms mt l mu mv">from fastapi.staticfiles import StaticFiles<br/>app.mount("/static", StaticFiles(directory="static"), name="static")</span></pre><p id="a6a8" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">请记住，您在这里使用的是<code class="fe me mf mg mh b">mount</code>，因为它不是基于API的主应用程序的一部分，因此不能成为<code class="fe me mf mg mh b">APIRouter</code>的一部分，如果您试图这样做，您会得到一个异常<code class="fe me mf mg mh b">starlette.routing.NoMatchFound</code>异常。</p><p id="e48c" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在<code class="fe me mf mg mh b">routers/contact.py</code>中，我是这样做的:</p><pre class="mj mk ml mm gt mn mh mo mp aw mq bi"><span id="a73a" class="mr lc iq mh b gy ms mt l mu mv">from fastapi.responses import HTMLResponse<br/>from fastapi.templating import Jinja2Templates<br/>....</span><span id="c6a9" class="mr lc iq mh b gy mw mt l mu mv"><a class="ae kc" href="http://twitter.com/router_contacts" rel="noopener ugc nofollow" target="_blank">@router_contacts</a>.get("/view_html/{id}", response_class=HTMLResponse, summary="Returns a single contact in HTML")<br/>async def view_html(request: Request, id: int):<br/>    contact = get_contact(id=id)<br/>    if contact is None:<br/>        raise HTTPException(status_code=404, detail="Contact not found")</span><span id="c6c3" class="mr lc iq mh b gy mw mt l mu mv">return templates.TemplateResponse("view.html", {"request": request, "contact": contact})</span></pre><p id="2af3" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">注意，我使用的是<code class="fe me mf mg mh b">response_class</code>而不是<code class="fe me mf mg mh b">response_model</code>参数。当我访问<code class="fe me mf mg mh b">http://localhost:8000/contacts/view_html/1</code>时，它呈现为:</p><figure class="mj mk ml mm gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mi"><img src="../Images/f85d744bdb090b73fd19018b437c40ad.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*T1Tg4Xc0_PdYx_ih.png"/></div></div></figure><h1 id="e340" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">结论</h1><p id="29fd" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">在这篇文章中，我讨论了如何在FastAPI中集成像MySQL这样的数据库引擎。我还讨论了如何使用Jinja2模板创建API的frontpage。这篇文章的代码可以在<a class="ae kc" href="https://github.com/kadnan/FastAPIMySQLTutorial" rel="noopener ugc nofollow" target="_blank"> Github </a>上找到。</p></div><div class="ab cl mz na hu nb" role="separator"><span class="nc bw bk nd ne nf"/><span class="nc bw bk nd ne nf"/><span class="nc bw bk nd ne"/></div><div class="ij ik il im in"><p id="1899" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><em class="mx">原载于2021年1月30日</em><a class="ae kc" href="http://blog.adnansiddiqi.me/getting-started-with-fastapi-and-mysql/" rel="noopener ugc nofollow" target="_blank"><em class="mx">http://blog . adnansiddiqi . me</em></a><em class="mx">。</em></p></div></div>    
</body>
</html>