<html>
<head>
<title>Guidance for Building a Control Plane to Manage Envoy Proxy at the edge, as a gateway, or in a mesh</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">构建控制平面以管理边缘、网关或网格中的特使代理的指南</h1>
<blockquote>原文：<a href="https://itnext.io/guidance-for-building-a-control-plane-to-manage-envoy-proxy-at-the-edge-as-a-gateway-or-in-a-mesh-7c8c671e6e33?source=collection_archive---------9-----------------------#2019-02-18">https://itnext.io/guidance-for-building-a-control-plane-to-manage-envoy-proxy-at-the-edge-as-a-gateway-or-in-a-mesh-7c8c671e6e33?source=collection_archive---------9-----------------------#2019-02-18</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jn jo jp jq gh gi paragraph-image"><div class="ab gu cl jr"><img src="../Images/dd7cf55c9f0d3623bcacc00ad95cdbe4.png" data-original-src="https://miro.medium.com/v2/format:webp/1*SXZ4GlfXedH1e9md_bWd9g.jpeg"/></div></figure><p id="798b" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">最近，特使已经成为一个流行的网络组件。马特·克莱因<a class="ae ks" href="https://blog.envoyproxy.io/the-universal-data-plane-api-d15cec7a" rel="noopener ugc nofollow" target="_blank">几年前写了一篇博客</a>谈论Envoy的动态配置API，以及它如何成为Envoy的采用曲线向右上方上升的部分原因。他称这个博客为“通用数据平面API”。随着<a class="ae ks" href="https://www.envoyproxy.io/community" rel="noopener ugc nofollow" target="_blank">如此多的其他项目采用Envoy </a>作为其产品的核心组件，对于应用/L7网络解决方案来说，说“Envoy已经成为云原生架构中的通用数据平面”并不夸张，而不仅仅是建立了一个标准化的API。</p><figure class="kt ku kv kw gt jq gh gi paragraph-image"><div class="ab gu cl jr"><img src="../Images/60ae5410f4592c76cd168ad15b0da919.png" data-original-src="https://miro.medium.com/v2/format:webp/0*_0Kw8uB5T77tA31o.png"/></div></figure><p id="a200" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">尽管如此，因为有了<a class="ae ks" href="https://blog.envoyproxy.io/the-universal-data-plane-api-d15cec7a" rel="noopener ugc nofollow" target="_blank"> Envoy的通用数据平面API </a>，我们已经看到了大量<em class="kx">管理层</em>的实现来配置和驱动基于Envoy的基础设施。我们将深入探讨为Envoy构建控制平面需要什么，以便您可以使用这些信息来评估哪种类型的基础架构最适合您的组织和用例。因为这是一个广泛的主题，我们将在接下来的几周内发布的多部分系列文章中解决它。跟着(<a class="ae ks" href="https://twitter.com/christianposta" rel="noopener ugc nofollow" target="_blank"> @christianposta </a>，<a class="ae ks" href="https://twitter.com/soloio_inc" rel="noopener ugc nofollow" target="_blank">@ solio _ Inc</a>)看接下来的条目。</p><p id="cf8d" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">在EnvoyCon/KubeCon上有一些很棒的演讲，一些组织分享了他们采用Envoy的经验，包括他们如何构建自己的控制平面。人们选择建造自己的控制平面的一些原因:</p><ul class=""><li id="50fa" class="ky kz iq jw b jx jy kb kc kf la kj lb kn lc kr ld le lf lg bi translated">现有解决方案构建在不同的数据平面上，并带有预先存在的控制平面，需要在中改造Envoy</li><li id="f310" class="ky kz iq jw b jx lh kb li kf lj kj lk kn ll kr ld le lf lg bi translated">构建没有任何现有开源或其他Envoy控制平面(例如，虚拟机、AWS ECS等)的基础架构</li><li id="1fad" class="ky kz iq jw b jx lh kb li kf lj kj lk kn ll kr ld le lf lg bi translated">不需要使用特使的所有功能；只是一个子集</li><li id="a70b" class="ky kz iq jw b jx lh kb li kf lj kj lk kn ll kr ld le lf lg bi translated">对于Envoy配置，更喜欢特定于领域的API/对象模型，以更好地适应他们的工作流/世界观</li><li id="377d" class="ky kz iq jw b jx lh kb li kf lj kj lk kn ll kr ld le lf lg bi translated">当他们各自的组织准备部署时，其他控制平面还没有处于成熟状态</li></ul><figure class="kt ku kv kw gt jq gh gi paragraph-image"><div class="ab gu cl jr"><img src="../Images/9b7f310c4062d43ab7bbb79326125fde.png" data-original-src="https://miro.medium.com/v2/format:webp/0*YgZeMk4rzErfY6qM.png"/></div></figure><p id="3a81" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">然而，仅仅因为一些早期采用者建造了他们自己的定制控制平面并不意味着你现在应该做同样的事情。首先，为Envoy构建控制平面的项目在去年已经相当成熟，您应该在决定重新创建另一个控制平面之前探索使用这些项目。第二，正如Datawire的人所发现的，丹尼尔·布莱恩特(Daniel Bryant)最近所阐明的，T2为特使建造控制飞机并不适合胆小的人。</p><p id="49a6" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated"><a class="ae ks" href="https://www.solo.io/" rel="noopener ugc nofollow" target="_blank">我在<a class="ae ks" href="https://github.com/istio/istio" rel="noopener ugc nofollow" target="_blank">做</a>几个</a> <a class="ae ks" href="https://github.com/solo-io/gloo" rel="noopener ugc nofollow" target="_blank">开源项目</a>为特使建造了一个控制平面。例如，<a class="ae ks" href="https://gloo.solo.io/" rel="noopener ugc nofollow" target="_blank"> Gloo </a>是<a class="ae ks" href="https://medium.com/solo-io/announcing-gloo-the-function-gateway-3f0860ef6600" rel="noopener">一个功能网关</a>，它可以充当一个非常强大的Kubernetes入口、API网关或功能网关，以简化从单片到微服务的过渡。Gloo <a class="ae ks" href="https://gloo.solo.io/introduction/architecture/" rel="noopener ugc nofollow" target="_blank">为Envoy </a>提供了一个控制平面，我们可以在这一系列的文章中参考这个控制平面，作为如何构建一个简单的抽象的例子，它允许在您需要的控制点上实现可插拔性和可扩展性。您可以参考的其他可靠的控制平面实现有<a class="ae ks" href="https://istio.io/" rel="noopener ugc nofollow" target="_blank"> Istio </a>和<a class="ae ks" href="https://github.com/heptio/contour" rel="noopener ugc nofollow" target="_blank"> Heptio Contour </a>，我们将在整个博客系列中使用它们作为很好的例子。如果没有别的，您可以了解Envoy控制平面有哪些选项，如果您必须走这条路，可以用它来指导您的实现。</p><figure class="kt ku kv kw gt jq gh gi paragraph-image"><div class="ab gu cl jr"><img src="../Images/751944bd4cbc1bbed8b2e26a2ec4bf39.png" data-original-src="https://miro.medium.com/v2/format:webp/0*K2tZeSEAqi98ytua.png"/></div></figure><p id="cfa9" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">在这个博客系列中，我们将看看以下几个方面:</p><ul class=""><li id="c61f" class="ky kz iq jw b jx jy kb kc kf la kj lb kn lc kr ld le lf lg bi translated">采用一种机制来动态更新Envoy的路由、服务发现和其他配置</li><li id="e24d" class="ky kz iq jw b jx lh kb li kf lj kj lk kn ll kr ld le lf lg bi translated">确定控制平面由哪些组件组成，包括后备存储器、服务发现API、安全组件等。艾尔。</li><li id="6d71" class="ky kz iq jw b jx lh kb li kf lj kj lk kn ll kr ld le lf lg bi translated">建立最适合您的用例及组织的任何特定于领域的配置对象和API</li><li id="48aa" class="ky kz iq jw b jx lh kb li kf lj kj lk kn ll kr ld le lf lg bi translated">提前思考如何最好地让您的控制面板可插入到您需要的地方</li><li id="e4cc" class="ky kz iq jw b jx lh kb li kf lj kj lk kn ll kr ld le lf lg bi translated">部署各种控制面板组件的选项</li><li id="6ff4" class="ky kz iq jw b jx lh kb li kf lj kj lk kn ll kr ld le lf lg bi translated">仔细考虑你的控制平面的测试装具</li></ul><p id="8701" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">作为本系列的开始，让我们看看如何使用Envoy的动态配置API在运行时更新Envoy，以处理拓扑和部署中的变化。</p><p id="efb8" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">在Envoy之上构建的主要优势之一是它的数据平面API。有了数据平面API，我们可以<a class="ae ks" href="https://www.envoyproxy.io/docs/envoy/v1.9.0/intro/arch_overview/dynamic_configuration" rel="noopener ugc nofollow" target="_blank">动态配置Envoy的大部分重要运行时设置</a>。Envoy通过其xDS APIs的配置是<a class="ae ks" href="https://blog.envoyproxy.io/embracing-eventual-consistency-in-soa-networking-32a5ee5d443d" rel="noopener ugc nofollow" target="_blank">最终设计一致的</a>——也就是说，没有办法影响集群中所有代理的“原子更新”。当控制平面有配置更新时，它通过xDS APIs使它们对数据平面代理可用，并且每个代理将彼此独立地应用这些更新。</p><p id="6558" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">以下是我们可以通过xDS动态配置的Envoy运行时模型的部分:</p><ul class=""><li id="877e" class="ky kz iq jw b jx jy kb kc kf la kj lb kn lc kr ld le lf lg bi translated"><a class="ae ks" href="https://www.envoyproxy.io/docs/envoy/v1.9.0/configuration/listeners/lds#config-listeners-lds" rel="noopener ugc nofollow" target="_blank">监听器发现服务API — LDS </a>发布监听流量的端口</li><li id="3263" class="ky kz iq jw b jx lh kb li kf lj kj lk kn ll kr ld le lf lg bi translated"><a class="ae ks" href="https://www.envoyproxy.io/docs/envoy/v1.9.0/api-v2/api/v2/eds.proto#envoy-api-file-envoy-api-v2-eds-proto" rel="noopener ugc nofollow" target="_blank">端点发现服务API- EDS </a>用于服务发现，</li><li id="7a71" class="ky kz iq jw b jx lh kb li kf lj kj lk kn ll kr ld le lf lg bi translated"><a class="ae ks" href="https://www.envoyproxy.io/docs/envoy/v1.9.0/configuration/http_conn_man/rds#config-http-conn-man-rds" rel="noopener ugc nofollow" target="_blank">用于流量路由决策的路由发现服务API- RDS </a></li><li id="6bf0" class="ky kz iq jw b jx lh kb li kf lj kj lk kn ll kr ld le lf lg bi translated"><a class="ae ks" href="https://www.envoyproxy.io/docs/envoy/v1.9.0/configuration/cluster_manager/cds#config-cluster-manager-cds" rel="noopener ugc nofollow" target="_blank">集群发现服务- CDS </a>用于我们可以将流量路由到的后端服务</li><li id="fb06" class="ky kz iq jw b jx lh kb li kf lj kj lk kn ll kr ld le lf lg bi translated"><a class="ae ks" href="https://www.envoyproxy.io/docs/envoy/v1.9.0/configuration/secret" rel="noopener ugc nofollow" target="_blank">秘密发现服务—用于分发秘密(证书和密钥)的SDS </a></li></ul><figure class="kt ku kv kw gt jq gh gi paragraph-image"><div class="ab gu cl jr"><img src="../Images/64edc19704f3a723663a21748efb821a.png" data-original-src="https://miro.medium.com/v2/format:webp/0*hxfzkCuQl8PfuL9M.png"/></div></figure><p id="6e86" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">API是用<a class="ae ks" href="https://www.envoyproxy.io/docs/envoy/v1.9.0/configuration/overview/v2_overview#config-overview-v2" rel="noopener ugc nofollow" target="_blank"> proto3协议缓冲区</a>定义的，甚至有几个参考实现，您可以使用它们来引导您自己的控制平面:</p><ul class=""><li id="2e6e" class="ky kz iq jw b jx jy kb kc kf la kj lb kn lc kr ld le lf lg bi translated"><a class="ae ks" href="https://github.com/envoyproxy/go-control-plane" rel="noopener ugc nofollow" target="_blank"> go-control-plane </a></li><li id="5572" class="ky kz iq jw b jx lh kb li kf lj kj lk kn ll kr ld le lf lg bi translated"><a class="ae ks" href="https://github.com/envoyproxy/java-control-plane" rel="noopener ugc nofollow" target="_blank"> java控制平面</a></li></ul><p id="4340" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">尽管这些区域(LDS/EDS/RDS/CDS/SDS，统称为“xDS”)都是可动态配置的，但这并不意味着您必须动态配置所有内容。您可以组合静态定义的部分和动态更新的部分。例如，要实现一种类型的服务发现，其中<code class="fe lm ln lo lp b">endpoints</code>应该是动态的，但是<code class="fe lm ln lo lp b">clusters</code>在部署时是已知的，您可以静态定义<code class="fe lm ln lo lp b">clusters</code>并使用来自Envoy的<a class="ae ks" href="https://www.envoyproxy.io/docs/envoy/v1.9.0/api-v2/api/v2/eds.proto#envoy-api-file-envoy-api-v2-eds-proto" rel="noopener ugc nofollow" target="_blank">端点发现服务</a>。如果您不确定在部署时将使用哪个<a class="ae ks" href="https://www.envoyproxy.io/docs/envoy/v1.9.0/intro/arch_overview/terminology" rel="noopener ugc nofollow" target="_blank">上游集群</a>，您可以使用<a class="ae ks" href="https://www.envoyproxy.io/docs/envoy/v1.9.0/configuration/cluster_manager/cds#config-cluster-manager-cds" rel="noopener ugc nofollow" target="_blank">集群发现服务</a>来动态地找到它们。关键是，您可以构建一个工作流和流程，静态配置您需要的部分，同时使用动态xDS服务在运行时发现您需要的部分。您看到不同控制平面实现的原因之一是，并不是每个人都有一个完全动态和可替换的环境，其中所有部分都应该是动态的。在给定现有约束和可用工作流的情况下，采用最适合您的系统的动态级别。</p><p id="a3bb" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">在Gloo的情况下，我们使用基于go-control-plane 的控制平面<a class="ae ks" href="https://github.com/solo-io/gloo/blob/ac3bddf202423b297fb909eb6eff498745a8c015/projects/gloo/pkg/xds/envoy.go#L76" rel="noopener ugc nofollow" target="_blank">来实现xDS APIs，以服务于Envoy的动态配置。Istio和Heptio Contour一样也使用这种实现。这个控制平面API利用了</a><a class="ae ks" href="https://grpc.io/docs/guides/concepts.html#server-streaming-rpc" rel="noopener ugc nofollow" target="_blank"> gRPC流</a>调用，并去掉了API，因此您可以用一个实现来填充它。另一个项目是<a class="ae ks" href="https://github.com/turbinelabs/rotor" rel="noopener ugc nofollow" target="_blank"> Turbine Labs的转子项目</a>，不幸被弃用，但可以用来学习很多东西。这是将Envoy的数据平面API与控制平面集成的高效方式。</p><p id="cb32" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">gRPC流不是更新Envoy配置的唯一方式。在<a class="ae ks" href="https://www.envoyproxy.io/docs/envoy/v1.5.0/api-v1/api" rel="noopener ugc nofollow" target="_blank">早期版本的Envoy xDS API </a>中，轮询是确定新配置是否可用的唯一选项。尽管这是可以接受的，并且符合“最终一致”配置更新的标准，但在网络和计算使用方面效率较低。也很难适当地调整轮询配置以减少资源浪费。</p><p id="b11f" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">最后，一些特使管理实现选择生成<a class="ae ks" href="https://www.envoyproxy.io/docs/envoy/latest/configuration/overview/v2_overview#static" rel="noopener ugc nofollow" target="_blank">静态特使配置文件</a>，并定期为特使替换磁盘上的配置文件，然后执行特使进程的<a class="ae ks" href="https://blog.envoyproxy.io/envoy-hot-restart-1d16b14555b5" rel="noopener ugc nofollow" target="_blank">热重载。在高度动态的环境中(如Kubernetes，但实际上是任何基于短期计算的平台),文件生成、交付、热重启等管理可能会变得难以处理。Envoy最初是在这样一个执行更新的环境中运行的(Lyft，它就是在那里创建的)，但是现在有了xDS服务</a></p><p id="0570" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">Gloo团队相信使用gRPC流和xDS APIs是为Envoy实现动态配置和控制的理想方式。同样，如果您不需要，并不是所有的Envoy配置都应该动态提供，但是如果您在一个高度动态的环境中操作(例如Kubernetes)，动态配置Envoy的选项是非常关键的。其他环境可能没有这种需求。无论哪种方式，用于动态部分的gRPC流API都是理想的。这种方法的一些好处:</p><ul class=""><li id="02ec" class="ky kz iq jw b jx jy kb kc kf la kj lb kn lc kr ld le lf lg bi translated">事件驱动的配置更新；当配置在控制平面中变得可用时，配置被推送到特使</li><li id="65d4" class="ky kz iq jw b jx lh kb li kf lj kj lk kn ll kr ld le lf lg bi translated">不需要轮询更改</li><li id="18bc" class="ky kz iq jw b jx lh kb li kf lj kj lk kn ll kr ld le lf lg bi translated">无需热重装特使</li><li id="e542" class="ky kz iq jw b jx lh kb li kf lj kj lk kn ll kr ld le lf lg bi translated">不中断交通</li></ul><p id="1448" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">在第一部分中，我们通过介绍xDS APIs和为Envoy提供动态配置的不同选项，建立了一些关于如何为Envoy构建控制平面的基本背景。在几天后发布的下一部分中，将涉及将控制平面分解成可部署的组件，确定您需要哪些组件，特定于域的配置对象模型可能是什么样子，以及如何考虑控制平面的可插入性。在推特(<a class="ae ks" href="https://twitter.com/christianposta" rel="noopener ugc nofollow" target="_blank"> @christianposta </a>，<a class="ae ks" href="https://twitter.com/soloio_inc" rel="noopener ugc nofollow" target="_blank">@ solio _ Inc</a>)或博客(【https://medium.com/solo-io】T4)上关注</p></div><div class="ab cl lq lr hu ls" role="separator"><span class="lt bw bk lu lv lw"/><span class="lt bw bk lu lv lw"/><span class="lt bw bk lu lv"/></div><div class="ij ik il im in"><p id="3099" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated"><em class="kx">原载于2019年2月18日</em><a class="ae ks" href="https://medium.com/solo-io/guidance-for-building-a-control-plane-to-manage-envoy-proxy-at-the-edge-as-a-gateway-or-in-a-mesh-badb6c36a2af" rel="noopener"><em class="kx">medium.com</em></a><em class="kx">。</em></p></div></div>    
</body>
</html>