<html>
<head>
<title>Server Name Indication (SNI) and Ingress TLS in Kubernetes with Ambassador</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">带大使的Kubernetes中的服务器名称指示(SNI)和入口TLS</h1>
<blockquote>原文：<a href="https://itnext.io/server-name-indication-sni-and-ingress-tls-in-kubernetes-with-ambassador-d3d796835ebe?source=collection_archive---------3-----------------------#2019-01-29">https://itnext.io/server-name-indication-sni-and-ingress-tls-in-kubernetes-with-ambassador-d3d796835ebe?source=collection_archive---------3-----------------------#2019-01-29</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="b26d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">开源大使0.50 API网关增加了对<a class="ae kl" href="https://www.getambassador.io/user-guide/sni/" rel="noopener ugc nofollow" target="_blank">服务器名称指示(SNI) </a>的支持，这是一个社区非常需要的功能，允许从单个入口IP地址提供多个TLS证书的配置。在本教程中，我们将探讨多个安全域(例如，<a class="ae kl" href="https://www.datawire.io" rel="noopener ugc nofollow" target="_blank"> https://www.datawire.io </a>和<a class="ae kl" href="https://www.getambassador.io" rel="noopener ugc nofollow" target="_blank">https://www . getambassador . io</a>)是如何实现的。)可以由Kubernetes集群中运行的单个或负载平衡的大使提供。</p><h1 id="8968" class="km kn iq bd ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj bi translated">SNI用例</h1><p id="651a" class="pw-post-body-paragraph jn jo iq jp b jq lk js jt ju ll jw jx jy lm ka kb kc ln ke kf kg lo ki kj kk ij bi translated">简而言之(感谢维基百科)，<a class="ae kl" href="https://en.wikipedia.org/wiki/Server_Name_Indication" rel="noopener ugc nofollow" target="_blank"> SNI </a>是TLS协议的一个扩展，它允许客户端在TCP握手过程开始时指出它试图连接到哪个主机名。这允许服务器在相同的IP地址和TCP端口号上呈现多个证书，这又使得能够提供多个安全网站或API服务，而不需要所有这些站点使用相同的证书。</p><p id="8b06" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">对于那些过去配置过边缘代理和API网关的人来说，SNI在概念上相当于HTTP/1.1基于名称的虚拟主机，但是对于HTTPS来说。</p><p id="fe58" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们已经在edge代理/网关中讨论了许多有趣的SNI支持用例，其中既有开源的<a class="ae kl" href="https://www.getambassador.io/" rel="noopener ugc nofollow" target="_blank">用户，也有商业支持的</a>和<a class="ae kl" href="https://www.getambassador.io/pro/" rel="noopener ugc nofollow" target="_blank">用户。</a></p><p id="21a7" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">许多工程师正在运行Kubernetes集群，这些集群为最终用户提供多种后端服务，他们经常希望在提供多个主机名的同时提供安全的流量，例如，这允许轻松区分所提供的服务(如www.datawire.io和api.dw.io)，并支持多个内部(web可寻址)品牌的曝光，这些品牌共享来自单个集群的后端服务(如<a class="ae kl" href="http://www.fashion-brand-one.com" rel="noopener ugc nofollow" target="_blank">www.fashion-brand-one.com</a>和<a class="ae kl" href="http://www.fashion-brand-two.com)." rel="noopener ugc nofollow" target="_blank"> www.fashion-brand-two.com)。</a></p><figure class="lq lr ls lt gt lu gh gi paragraph-image"><div role="button" tabindex="0" class="lv lw di lx bf ly"><div class="gh gi lp"><img src="../Images/ad6dc28df29c2f187070fb6e255d4038.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*vSldRMNJpW5S4aLQ"/></div></div></figure><h1 id="4643" class="km kn iq bd ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj bi translated">在大使中配置SNI</h1><p id="cd67" class="pw-post-body-paragraph jn jo iq jp b jq lk js jt ju ll jw jx jy lm ka kb kc ln ke kf kg lo ki kj kk ij bi translated"><a class="ae kl" href="https://www.getambassador.io/user-guide/sni/" rel="noopener ugc nofollow" target="_blank">大使SNI文档</a>提供了一步一步的配置指南，还深入介绍了<a class="ae kl" href="https://www.getambassador.io/user-guide/tls-termination/" rel="noopener ugc nofollow" target="_blank">入口TLS端接</a>，但我在这里也提供了一个总结。</p><p id="a44f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">第一步是为每个所需的安全传输上下文创建一个TLS证书——通常这将涉及为每个顶级域生成一个证书——并将这些证书添加为Kubernetes机密(例如<code class="fe mb mc md me b">datawire-site-secret</code>和<code class="fe mb mc md me b">getambassador-site-secret</code>)。</p><p id="e047" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">接下来，创建一个<code class="fe mb mc md me b">TLSContext</code>资源，并将这个配置应用到集群中:</p><pre class="lq lr ls lt gt mf me mg mh aw mi bi"><span id="2d7a" class="mj kn iq me b gy mk ml l mm mn">---<br/>apiVersion: v1<br/>kind: Service<br/>metadata:<br/>  annotations:<br/>    getambassador.io/config: |<br/>    ---<br/>    apiVersion: ambassador/v0<br/>    kind: TLSContext<br/>    name: datawire-site-context<br/>    hosts:<br/>    - <a class="ae kl" href="http://www.datawire.io" rel="noopener ugc nofollow" target="_blank">www.datawire.io</a><br/>    secret: datawire-site-secret<br/>    ---<br/>    apiVersion: ambassador/v0<br/>    kind: TLSContext<br/>    name: getambassador-site-context<br/>    hosts:<br/>    - <a class="ae kl" href="http://www.getambassador.io" rel="noopener ugc nofollow" target="_blank">www.getambassador.io</a><br/>    secret: getambassador-site-secret<br/>  &lt;snip&gt;</span></pre><p id="d67a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">请注意，如<a class="ae kl" href="https://www.getambassador.io/reference/core/tls/" rel="noopener ugc nofollow" target="_blank"> Ambassador TLS文档</a>中所述，全局TLS配置可能需要在<code class="fe mb mc md me b">tls</code>模块中更新，以便<a class="ae kl" href="https://www.getambassador.io/reference/core/tls/#redirecting-from-cleartext-to-tls" rel="noopener ugc nofollow" target="_blank">将不安全的明文请求</a>从端口80重定向到端口443(其他功能，如<a class="ae kl" href="https://www.getambassador.io/reference/core/tls/#authentication-with-tls-client-certificates" rel="noopener ugc nofollow" target="_blank">客户端认证</a>也可以在此配置)。</p><p id="cc5d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">TLS contexts就绪后，现在可以指定主机和路由的大使映射，并通过主机链接到TLS上下文:</p><pre class="lq lr ls lt gt mf me mg mh aw mi bi"><span id="91aa" class="mj kn iq me b gy mk ml l mm mn">---<br/>apiVersion: v1<br/>kind: Service<br/>metadata:<br/>  annotations:<br/>    getambassador.io/config: |<br/>      ---<br/>      apiVersion: ambassador/v0<br/>      kind:  Mapping<br/>      name:  datawire-website-mapping<br/>      prefix: /<br/>      service: datawire-site-service:80<br/>      host: <a class="ae kl" href="http://www.datawire.io" rel="noopener ugc nofollow" target="_blank">www.datawire.io</a><br/>      ---<br/>      apiVersion: ambassador/v0<br/>      kind:  Mapping<br/>      name:  getambassador-website-mapping<br/>      prefix: /<br/>      service: getambassador-site-service.org:80<br/>      host: <a class="ae kl" href="http://www.getambassador.io" rel="noopener ugc nofollow" target="_blank">www.getambassador.io</a><br/> &lt;snip&gt;</span></pre><h1 id="d4c7" class="km kn iq bd ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj bi translated">升级到大使0.50 GA和SNI</h1><p id="eeed" class="pw-post-body-paragraph jn jo iq jp b jq lk js jt ju ll jw jx jy lm ka kb kc ln ke kf kg lo ki kj kk ij bi translated">Ambassador 0.50 GA即将推出，一些额外的功能和架构变化(如支持Envoy v2 APIs和ADS)需要进行一些与旧版本Ambassador不向后兼容的更改。我们鼓励您测试<a class="ae kl" href="https://blog.getambassador.io/ambassador-0-50-rc5-available-9901d01c7a46" rel="noopener ugc nofollow" target="_blank">发布候选版本</a>，阅读<a class="ae kl" href="https://github.com/datawire/ambassador/blob/master/CHANGELOG.md" rel="noopener ugc nofollow" target="_blank">发布文档</a>，并在将该版本部署到生产中之前验证您的用例(例如，通过冒烟测试和流量阴影)。</p><p id="9a12" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们很高兴看到大使中包含SNI功能，因为这是一个受欢迎的功能请求。我们要感谢所有的贡献者和在Datawire Slack和GitHub库上讨论过这个特性的人。</p><p id="23ec" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><a class="ae kl" href="http://d6e.co/slack" rel="noopener ugc nofollow" target="_blank">加入大使休闲频道</a>了解0.50 GA发布的最新消息！</p></div></div>    
</body>
</html>