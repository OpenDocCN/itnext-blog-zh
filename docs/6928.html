<html>
<head>
<title>Jenkins + k8s + Buildkit: life behind the corporate proxy</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Jenkins + k8s + Buildkit:企业代理背后的生活</h1>
<blockquote>原文：<a href="https://itnext.io/jenkins-k8s-buildkit-life-behind-the-corporate-proxy-cb052bd7f969?source=collection_archive---------2-----------------------#2022-04-15">https://itnext.io/jenkins-k8s-buildkit-life-behind-the-corporate-proxy-cb052bd7f969?source=collection_archive---------2-----------------------#2022-04-15</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="e5ec" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在<a class="ae kl" rel="noopener ugc nofollow" target="_blank" href="/jenkins-k8s-building-docker-image-without-docker-d41cffdbda5a">上一篇文章</a>中，我们讨论了当Kubernetes在1.24版中移除Dockershim后构建Docker映像时可用的选项。</p><p id="6a6e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">但是，如果您的本地Kubernetes集群不能直接访问互联网，而是被迫通过代理服务器，那该怎么办呢？这种情况在企业界相当普遍。</p><p id="07f9" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">此外，在这种设置中常见的是使用自托管Docker注册表，并且在某些情况下，内部自托管资源使用自签名证书或由本地创建的不受信任的证书颁发机构签名的证书。在这个设置中可以使用Buildkit吗？</p><p id="49a3" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">答案是肯定的，这是可能的，但需要一点额外的努力来设置它。</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="ks kt di ku bf kv"><div class="gh gi km"><img src="../Images/438e55b559ccbf424dade21cca6b00fd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*DeA-BD2EUWJ3aB-zXF5I8A.jpeg"/></div></div></figure><h1 id="203b" class="ky kz iq bd la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv bi translated">自托管Docker注册表</h1><p id="d189" class="pw-post-body-paragraph jn jo iq jp b jq lw js jt ju lx jw jx jy ly ka kb kc lz ke kf kg ma ki kj kk ij bi translated">让我们讨论每个场景，从自托管Docker注册中心开始。</p><p id="e42f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果自托管Docker Registry使用由公认可信的证书颁发机构签名的SSL证书，则不需要进行任何更改。</p><p id="35a9" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">但是，如果它是由不受信任的CA签名的，或者它使用自签名证书，则必须将其添加到<code class="fe mb mc md me b">moby/buildkit</code>映像中。因为我们在守护模式下使用buildkit，所以必须在启动容器之前将它添加到映像中。</p><p id="02f6" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">为此，您需要创建一个新的镜像扩展<code class="fe mb mc md me b">moby/build</code>，将您的CA证书或自签名证书放入<code class="fe mb mc md me b">/usr/local/share/ca-certificates/</code>目录(<code class="fe mb mc md me b">moby/buildkit</code>基于<code class="fe mb mc md me b">alpine</code>发行版)并运行<code class="fe mb mc md me b">update-ca-certificates</code>命令。</p><p id="c3e5" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">例如，Dockerfile将如下所示:</p><figure class="kn ko kp kq gt kr"><div class="bz fp l di"><div class="mf mg l"/></div></figure><p id="0597" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">一旦您构建了它<code class="fe mb mc md me b">docker build -t myorg/buildkit .</code>并将其推送到注册表<code class="fe mb mc md me b">docker push myorg/buildkit</code>中，它就可以在管道中使用了。只需将Pod模板中的<code class="fe mb mc md me b">moby/buildkit</code>替换为新建图像的名称即可:</p><figure class="kn ko kp kq gt kr"><div class="bz fp l di"><div class="mf mg l"/></div></figure><p id="1244" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果您将图像推入需要认证才能访问图像的私有注册中心，您必须在Jenkins使用的名称空间中创建一个类型为<code class="fe mb mc md me b">kubernetes.io/dockerconfigjson</code>的新秘密。</p><p id="eb21" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">为此，首先用注册表凭证对以下JSON进行编码:</p><figure class="kn ko kp kq gt kr"><div class="bz fp l di"><div class="mf mg l"/></div></figure><p id="86cb" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">“auth”属性的内容是base64编码的<code class="fe mb mc md me b">username:password </code>字符串。</p><p id="7ce5" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">用base64编码对上述JSON进行编码，并将其作为<code class="fe mb mc md me b">.dockerconfigjson</code>属性添加到以下secret中:</p><figure class="kn ko kp kq gt kr"><div class="bz fp l di"><div class="mf mg l"/></div></figure><p id="54ae" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">运行<code class="fe mb mc md me b">kubectl apply -f secret.yaml</code>在名称空间中创建secret，然后将其名称添加到Pod模板的<code class="fe mb mc md me b">imagePullSecrets</code>数组属性中:</p><figure class="kn ko kp kq gt kr"><div class="bz fp l di"><div class="mf mg l"/></div></figure><h1 id="b31b" class="ky kz iq bd la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv bi translated">代理背后的Kubernetes集群</h1><p id="f355" class="pw-post-body-paragraph jn jo iq jp b jq lw js jt ju lx jw jx jy ly ka kb kc lz ke kf kg ma ki kj kk ij bi translated">如果您的Kubernetes集群部署在代理之后，并且工作节点不能直接访问互联网来获取映像和/或获取依赖关系，则需要另外两个设置。</p><p id="90d9" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果Kubernetes在代理之后，为了允许BuildKit提取图像，请向正在讨论的pod添加HTTP_PROXY、HTTPS_PROXY和NO_PROXY环境变量。在这种情况下，容器定义将如下所示:</p><figure class="kn ko kp kq gt kr"><div class="bz fp l di"><div class="mf mg l"/></div></figure><p id="12f7" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">为了允许BuildKit在构建映像时获取依赖项或任何其他网络资源，请在build命令中添加相同的环境变量。在这种情况下，构建命令将如下所示:</p><figure class="kn ko kp kq gt kr"><div class="bz fp l di"><div class="mf mg l"/></div></figure></div></div>    
</body>
</html>