<html>
<head>
<title>Understandable Terraform projects</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">可理解的地形项目</h1>
<blockquote>原文：<a href="https://itnext.io/understandable-terraform-projects-9c1cd9b4b21a?source=collection_archive---------0-----------------------#2022-04-13">https://itnext.io/understandable-terraform-projects-9c1cd9b4b21a?source=collection_archive---------0-----------------------#2022-04-13</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/5e1996cab6fec6d566102bbfff947924.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*nSkec3pMjA4aKBfn.png"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated"><a class="ae kc" href="https://abstrusegoose.com/strips/you_down_wit_OPC-yeah_you_know_me.png" rel="noopener ugc nofollow" target="_blank">https://abtrusegoose . com/strips/you _ down _ wit _ OPC-yeah _ you _ know _ me . png</a></figcaption></figure><p id="593e" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">Terraform代码是声明性的。我们用它来声明我们想从我们的云提供商那里得到什么。如果能把这段代码翻译成简单的英语，读起来就像一份精心制作的购物清单:</p><blockquote class="lb lc ld"><p id="2a40" class="kd ke le kf b kg kh ki kj kk kl km kn lf kp kq kr lg kt ku kv lh kx ky kz la ij bi translated">给我一个带数据库和kubernetes集群的私有虚拟网络。集群应该有一定数量的节点，并且它们都应该使用这种特定类型的CPU。数据库应该位于世界的这一部分，它应该有能力存储一些千兆字节…</p></blockquote><p id="592d" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们所描述的理想状态往往非常复杂；这就是为什么Terraform项目经常变得难以理解。</p><p id="cc02" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">本文的目的是分享我们如何在<a class="ae kc" href="https://bulderbank.no" rel="noopener ugc nofollow" target="_blank"> Bulder Bank </a>编写可理解的Terraform代码。</p><h2 id="7904" class="li lj iq bd lk ll lm dn ln lo lp dp lq ko lr ls lt ks lu lv lw kw lx ly lz ma bi translated">YAML风味输入值</h2><p id="91a3" class="pw-post-body-paragraph kd ke iq kf b kg mb ki kj kk mc km kn ko md kq kr ks me ku kv kw mf ky kz la ij bi translated">大多数人在<code class="fe mg mh mi mj b">.tfvars</code>文件中把他们的输入值写成HCL。我更喜欢YAML，因为它更容易阅读。当您使用YAML为Terraform根模块定义输入值时，所需的状态变得更容易解释:</p><pre class="mk ml mm mn gt mo mj mp mq aw mr bi"><span id="9d62" class="li lj iq mj b gy ms mt l mu mv"># ./my-project/live/prod/config.yaml<br/><br/>networks:<br/>  - name: network-a<br/>    region: europe-west1<br/>  - name: network-b<br/>    region: europe-north1  <br/><br/>databases:<br/>  - name: database-number1<br/>    type: cloudsql<br/>    network: network-a<br/>    region: europe-west1-a<br/>    disk_size: 20gb<br/>  - name: database-number2<br/>    type: postgresql<br/>    network: network-b<br/>    region: europe-north1-b<br/>    disk_size: 40gb<br/><br/>clusters:<br/>  - name: prod-blue<br/>    region: europe-west1-a<br/>    network: network-a<br/>    min_nodes: 3<br/>    max_nodes: 6<br/>  - name: prod-green<br/>    region: europe-west1-b<br/>    network: network-a<br/>    min_nodes: 3<br/>    max_nodes: 6</span></pre><p id="1d74" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">HCL中的等效物相当嘈杂:</p><pre class="mk ml mm mn gt mo mj mp mq aw mr bi"><span id="dc28" class="li lj iq mj b gy ms mt l mu mv">networks = [<br/>  {<br/>    name = "network-a"<br/>    location = "europe-west1"<br/>  },<br/>  {<br/>    name = "network-b"<br/>    location = "europe-west1"<br/>  }<br/>]<br/><br/>databases = [<br/>  {<br/>    name = "database-number1"<br/>    type = "cloudsql"<br/>    network = "network-a"<br/>    location = "europe-west1-a"<br/>    disk_size = "20gb"<br/>  },<br/>  {<br/>    name = "database-number2"<br/>    type = "postgresql"<br/>    network = "network-b"<br/>    region = "europe-west1-b"<br/>    disk_size = "40gb"<br/>  }<br/>]<br/><br/># etc..</span></pre><p id="ed2a" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">YAML和HCL支持相同的基本集合。这使得将YAML转化成HCL变得容易；Terraform中甚至有一个内置函数来做这件事(<code class="fe mg mh mi mj b">yamldecode()</code>)。</p><p id="0dd1" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">通过以下技巧，YAML配置可用于Terraform:</p><pre class="mk ml mm mn gt mo mj mp mq aw mr bi"><span id="147d" class="li lj iq mj b gy ms mt l mu mv"># ./live/*/locals.tf</span><span id="128c" class="li lj iq mj b gy mw mt l mu mv">locals {<br/>  config = yamldecode(file("./config.yaml"))<br/>}</span></pre><p id="1041" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这使得来自<code class="fe mg mh mi mj b">config.yaml</code>的所有内容都可以通过<code class="fe mg mh mi mj b">local.config</code>对象在<code class="fe mg mh mi mj b">.tf</code>文件中访问。</p><h2 id="f83b" class="li lj iq bd lk ll lm dn ln lo lp dp lq ko lr ls lt ks lu lv lw kw lx ly lz ma bi translated">面向配置</h2><p id="42d8" class="pw-post-body-paragraph kd ke iq kf b kg mb ki kj kk mc km kn ko md kq kr ks me ku kv kw mf ky kz la ij bi translated">编写可理解的Terraform代码的一个关键策略是面向配置。通过配置，我指的是将传递给Terraform模块的输入值。如上所述，这些值可以用一种几乎像文档一样的方式来组织。功能文档。说明执行Terraform代码时会发生什么的文档。</p><p id="9287" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">面向配置意味着您将最小化工程师可能长期与之交互的文件数量。工程师只重新访问旧的Terraform代码，因为他们想了解(或修改)所需的状态。如果您像上面说明的那样构造您的输入值，大多数代码访问可以被限制在<code class="fe mg mh mi mj b">config.yaml</code>文件中。任何了解YAML的人都会直观地理解如何添加/删除数据库、集群和网络。像增加数据库大小这样的简单任务也变得非常直观。</p><h2 id="e182" class="li lj iq bd lk ll lm dn ln lo lp dp lq ko lr ls lt ks lu lv lw kw lx ly lz ma bi translated">目录结构</h2><p id="44c0" class="pw-post-body-paragraph kd ke iq kf b kg mb ki kj kk mc km kn ko md kq kr ks me ku kv kw mf ky kz la ij bi translated">许多Terraform项目的一个常见缺陷是结构不良。我见过有几十个<code class="fe mg mh mi mj b">.tf</code>文件的存储库，读者甚至不知道从哪里开始。</p><p id="8069" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在Bulder Bank，我们所有的Terraform项目都有一个固定的目录布局。假设我们想要在两个环境中部署资源(<code class="fe mg mh mi mj b">dev</code>和<code class="fe mg mh mi mj b">prod</code>):</p><pre class="mk ml mm mn gt mo mj mp mq aw mr bi"><span id="622c" class="li lj iq mj b gy ms mt l mu mv">└── my-project<br/>    ├── live<br/>    │   ├── dev<br/>    │   │   ├── config.yaml<br/>    │   │   ├── modules.tf<br/>    │   │   ├── providers.tf<br/>    │   │   ├── locals.tf<br/>    │   │   └── terraform.tf<br/>    │   └── prod<br/>    │       ├── config.yaml<br/>    │       ├── modules.tf<br/>    │       ├── providers.tf<br/>    │       ├── locals.tf<br/>    │       └── terraform.tf<br/>    └── modules<br/>        ├── kubernetes<br/>        │   └── main.tf<br/>        ├── network<br/>        │   └── main.tf<br/>        └── database<br/>            └── main.tf</span></pre><p id="7271" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们GitHub组织中的每个Terraform项目都是这样构建的，使我们的工程师可以轻松导航。</p><h2 id="c99d" class="li lj iq bd lk ll lm dn ln lo lp dp lq ko lr ls lt ks lu lv lw kw lx ly lz ma bi translated">使用模块</h2><p id="5865" class="pw-post-body-paragraph kd ke iq kf b kg mb ki kj kk mc km kn ko md kq kr ks me ku kv kw mf ky kz la ij bi translated">我们放在<code class="fe mg mh mi mj b">modules/</code>目录中的Terraform模块并没有什么特别之处。它们是用HCL编写的，通常期望简单的输入值，如字符串、数字或列表。如果它们跨多个根模块使用，我们将它们存储在它们自己的GitHub存储库中，以实现可重用性。</p><p id="ff72" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们遵循的一个固执的风格决定是，对于有多个环境的项目，我们不在根模块中使用<code class="fe mg mh mi mj b">resource</code>块(例如<code class="fe mg mh mi mj b">prod</code> / <code class="fe mg mh mi mj b">dev</code> / <code class="fe mg mh mi mj b">staging</code>)。换句话说，我们只在<code class="fe mg mh mi mj b">modules.tf</code>中使用<code class="fe mg mh mi mj b">module</code>和<code class="fe mg mh mi mj b">data</code>块。这种方法有一些好处:</p><ul class=""><li id="ccb6" class="mx my iq kf b kg kh kk kl ko mz ks na kw nb la nc nd ne nf bi translated">在<code class="fe mg mh mi mj b">live/</code>下<code class="fe mg mh mi mj b">modules.tf</code>文件在不同环境下总是相同的(易于复制粘贴)。</li><li id="d1ac" class="mx my iq kf b kg ng kk nh ko ni ks nj kw nk la nc nd ne nf bi translated">跨多个环境修改Terraform代码变得更加容易。</li><li id="0156" class="mx my iq kf b kg ng kk nh ko ni ks nj kw nk la nc nd ne nf bi translated"><code class="fe mg mh mi mj b">terraform state</code>命令变得更容易处理。</li></ul><p id="0a07" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">对于单一环境项目，不需要这种风格限制。</p><p id="f1cc" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们的YAML配置示例的<code class="fe mg mh mi mj b">modules.tf</code>文件如下所示:</p><pre class="mk ml mm mn gt mo mj mp mq aw mr bi"><span id="0af2" class="li lj iq mj b gy ms mt l mu mv"># ./my-project/live/*/modules.tf<br/><br/>module "network" {<br/>  for_each = { for x in local.config.networks : x.name =&gt; x }<br/>  source   = "../../modules/network"<br/><br/>  name      = each.value.name<br/>  region    = each.value.region<br/>}<br/><br/>module "database" {<br/>  for_each = { for x in local.config.databases : x.name =&gt; x }<br/>  source   = "../../modules/database"<br/><br/>  name      = each.value.name<br/>  type      = each.value.type<br/>  region    = each.value.region<br/>  disk_size = each.value.disk_size<br/>  network   = module.network[each.value.network].name<br/>}<br/><br/>module "kubernetes" {<br/>  for_each = { for x in local.config.clusters : x.name =&gt; x }<br/>  source   = "../../modules/kubernetes"<br/><br/>  name      = each.value.name<br/>  region    = each.value.region<br/>  min_nodes = each.value.min_nodes<br/>  max_nodes = each.value.max_nodes<br/>  network   = module.network[each.value.network].name<br/>}</span></pre><h2 id="63e0" class="li lj iq bd lk ll lm dn ln lo lp dp lq ko lr ls lt ks lu lv lw kw lx ly lz ma bi translated">默认值</h2><p id="5b65" class="pw-post-body-paragraph kd ke iq kf b kg mb ki kj kk mc km kn ko md kq kr ks me ku kv kw mf ky kz la ij bi translated">Terraform模块通常包含大量输入值。在YAML配置文件中包含所有这些内容可能会对它们的可读性产生负面影响。当我们编写自己的模块时，我们可以在<code class="fe mg mh mi mj b">modules/</code>目录中使用缺省值，将不必要的复杂性排除在YAML文件之外。YAML风格方法遇到的一个问题是如何支持<code class="fe mg mh mi mj b">config.yaml</code>中的可选值。从Terraform <code class="fe mg mh mi mj b">v1.1.0</code>开始，有一个<a class="ae kc" href="https://www.terraform.io/language/values/variables#disallowing-null-input-values" rel="noopener ugc nofollow" target="_blank">巧妙的技巧</a>来遵从模块的默认值。</p><p id="9315" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">让我们假设<code class="fe mg mh mi mj b">kubernetes</code>模块中的<code class="fe mg mh mi mj b">max_nodes</code>变量默认为<code class="fe mg mh mi mj b">6</code>。我们希望能够在<code class="fe mg mh mi mj b">config.yaml</code>中覆盖这个默认值，但是我们也希望Terraform在<code class="fe mg mh mi mj b">config.yaml</code>中没有指定变量时使用<code class="fe mg mh mi mj b">6</code>的默认值:</p><pre class="mk ml mm mn gt mo mj mp mq aw mr bi"><span id="7fba" class="li lj iq mj b gy ms mt l mu mv"># ./my-project/live/prod/config.yaml<br/><br/>clusters:<br/>  - name: prod-blue<br/>    region: europe-west1-a<br/>    network: network-a<br/>    min_nodes: 3<br/>  - name: prod-green<br/>    region: europe-west1-b<br/>    network: network-a<br/>    min_nodes: 3<br/>    max_nodes: 12</span><span id="3552" class="li lj iq mj b gy mw mt l mu mv"># ./my-project/modules/kubernetes/main.tf<br/><br/>variable "max_nodes" {<br/>  default = 6<br/>  nullable = false<br/>}</span><span id="f5d1" class="li lj iq mj b gy mw mt l mu mv"># ./my-project/live/*/modules.tf<br/><br/>module "kubernetes" {<br/>  for_each = { for x in local.config.clusters : x.name =&gt; x }<br/>  source   = "../../modules/kubernetes"<br/><br/>  name      = each.value.name<br/>  region    = each.value.region<br/>  min_nodes = each.value.min_nodes<br/>  max_nodes = lookup(each.value, "max_nodes", null)<br/>  network   = module.network[each.value.network].name<br/>}</span></pre><p id="c26d" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><code class="fe mg mh mi mj b">main.tf</code>中的<code class="fe mg mh mi mj b">nullable = false</code>选项意味着如果模块从<code class="fe mg mh mi mj b">modules.tf</code>接收到一个<code class="fe mg mh mi mj b">null</code>值，它将回落到默认值<code class="fe mg mh mi mj b">6</code>。上图中，<code class="fe mg mh mi mj b">prod-blue</code>的<code class="fe mg mh mi mj b">max_nodes</code>为<code class="fe mg mh mi mj b">6</code>，而<code class="fe mg mh mi mj b">prod-green</code>为<code class="fe mg mh mi mj b">12</code>。</p><p id="51bd" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">如果您无法控制在<code class="fe mg mh mi mj b">modules.tf</code>中获得的Terraform模块，您可能无法选择定义<code class="fe mg mh mi mj b">nullable</code>字段(默认为<code class="fe mg mh mi mj b">true</code>)。如果你想让一个值在<code class="fe mg mh mi mj b">config.yaml</code>中既是可配置的又是可选的，你可以简单地在<code class="fe mg mh mi mj b">modules.tf</code>的<code class="fe mg mh mi mj b">lookup()</code>命令中提供一个默认值，但是要小心，你做得越多，工程师就越难弄清楚一些模块是如何配置的。当模块没有合适的默认值时，我只倾向于将默认值放在<code class="fe mg mh mi mj b">lookup()</code>函数中，并且我不太可能长期关心输入值。</p><h2 id="5047" class="li lj iq bd lk ll lm dn ln lo lp dp lq ko lr ls lt ks lu lv lw kw lx ly lz ma bi translated">结论</h2><p id="c1f4" class="pw-post-body-paragraph kd ke iq kf b kg mb ki kj kk mc km kn ko md kq kr ks me ku kv kw mf ky kz la ij bi translated">我在Terraform工作了几年，接触过多个组织的Terraform项目。我注意到的一件事是，实践差异很大；似乎没有一个标准化的方法来组织Terraform项目。Terraform代码应该为长期而写；编写可理解的代码相当于帮了你的同事(和未来的自己)一个大忙。</p><p id="6ab4" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我希望在创建/重构你自己的项目时，我们的Terraform方法对你有所帮助。</p></div></div>    
</body>
</html>