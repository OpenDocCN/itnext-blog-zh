<html>
<head>
<title>How to Build a Realtime Multiplayer Game in JavaScript with PubNub</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何用PubNub用JavaScript构建一个实时多人游戏</h1>
<blockquote>原文：<a href="https://itnext.io/how-to-build-a-realtime-multiplayer-game-in-javascript-using-pubnub-5f410fd62f33?source=collection_archive---------0-----------------------#2019-03-19">https://itnext.io/how-to-build-a-realtime-multiplayer-game-in-javascript-using-pubnub-5f410fd62f33?source=collection_archive---------0-----------------------#2019-03-19</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><figure class="gl gn jr js jt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi jq"><img src="../Images/fddc7bf454c1fbc69a3cbbfc7583a28d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*k4dxF8fijRku0Xh3OdCOIQ.jpeg"/></div></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated">“游戏玩家不会死。他们重生了！”</figcaption></figure><blockquote class="kf kg kh"><p id="3e88" class="ki kj kk kl b km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg im bi translated">场景:您想要构建一个在线多人游戏。这是你第一次这样做，你很兴奋！但是你如何实现玩家之间的实时互动呢？经过一些快速研究后，您发现您可以使用socket.io。您在网上查找并找到了如何实现socket.io的教程。您需要安装Node.js和Express，设置Express服务器，将socket.io代码添加到与Express代码相同的文件中，最后将客户端连接到服务器。咻，所有这些只是为了设置！此外，由于这是你第一次在游戏中实现实时基础设施，你需要学习一些网络概念，比如客户端预测。花在这些事情上的时间是你可以用来开发你的游戏的时间！</p></blockquote><p id="85e9" class="pw-post-body-paragraph ki kj it kl b km kn ko kp kq kr ks kt lh kv kw kx li kz la lb lj ld le lf lg im bi translated">事实是，在应用程序中实现实时功能并不是一件容易的事情。有很多很棒的工具可供您使用，但是在这个过程中您可能会遇到一些问题，尤其是当您开始扩展用户增长时。这就是PubNub的用武之地。PubNub提供实时基础设施，为用户提供安全可靠的连接，以连接他们的设备并使用PubNub的全球数据流网络传输数据。这是以0.25秒的全球全向消息传递速率完成的。</p><p id="fcc2" class="pw-post-body-paragraph ki kj it kl b km kn ko kp kq kr ks kt lh kv kw kx li kz la lb lj ld le lf lg im bi translated">使用PubNub的API可以完成的应用数不胜数，比如聊天应用、拼车应用、零售应用、多人游戏等。在多人游戏的情况下，PubNub促进了玩家之间的实时交互，并增强了游戏功能和社交功能，从而创造了流畅的游戏体验。</p><p id="34f2" class="pw-post-body-paragraph ki kj it kl b km kn ko kp kq kr ks kt lh kv kw kx li kz la lb lj ld le lf lg im bi translated">对于本教程，PubNub将用于连接游戏中的两个玩家，他们可以在游戏中相互交流和聊天。游戏UI将由一个用于绘图的画布和两个聊天框组成，一个用于书写猜测的单词，另一个供玩家相互发送消息。这个游戏将使用PubNub的JavaScript V4 SDK和ChatEngine JavaScript SDK以JavaScript构建。</p><h1 id="4fdd" class="lk ll it bd lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh bi translated">游戏概述</h1><p id="5cc5" class="pw-post-body-paragraph ki kj it kl b km mi ko kp kq mj ks kt lh mk kw kx li ml la lb lj mm le lf lg im bi translated">在本教程中，我们将从头开始构建一个绘画和猜谜游戏。在游戏中，一个玩家画一个单词，另一个玩家根据画猜这个单词。玩家猜中正确的单词可获得一分。得分最高的玩家获胜。</p><p id="ea68" class="pw-post-body-paragraph ki kj it kl b km kn ko kp kq kr ks kt lh kv kw kx li kz la lb lj ld le lf lg im bi translated">整个项目可以在我的GitHub <a class="ae mn" href="https://github.com/ocastroa/GuessWordPubNub" rel="noopener ugc nofollow" target="_blank">资源库中找到。</a>这是我们将要构建的游戏的截图:</p><figure class="mp mq mr ms gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi mo"><img src="../Images/dcca801eff810dcffbf823861cc19455.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*H09CX0tXg_QamJBCF1ZDOA.png"/></div></div></figure><h1 id="cd43" class="lk ll it bd lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh bi translated">设置发布</h1><p id="02ed" class="pw-post-body-paragraph ki kj it kl b km mi ko kp kq mj ks kt lh mk kw kx li ml la lb lj mm le lf lg im bi translated">在此注册一个免费的PubNub账户<a class="ae mn" href="https://dashboard.pubnub.com/signup" rel="noopener ugc nofollow" target="_blank">。注册后，您将被带到管理页面，在那里您可以获得您的发布/订阅密钥。您可以从“演示项目应用程序”中获取密钥，也可以创建一个新的应用程序来获取一组新的密钥。将密钥复制粘贴到一个新文件中，并将密钥标记为“游戏密钥”(注意:该文件用于临时存储您的密钥，不会用于游戏)。</a></p><p id="a9f0" class="pw-post-body-paragraph ki kj it kl b km kn ko kp kq kr ks kt lh kv kw kx li kz la lb lj ld le lf lg im bi translated">我们将使用<a class="ae mn" href="https://www.pubnub.com/products/presence/" rel="noopener ugc nofollow" target="_blank">状态</a>来检测大厅和游戏频道中的玩家。要启用频道显示，请单击您获取密钥的应用程序，单击演示密钥集框，然后转到应用程序加载项。寻找存在并单击开关将其打开。在TCP FIN或RST上选中“生成休假”复选框，并在此处选中“全球休假”复选框。</p><p id="4ff2" class="pw-post-body-paragraph ki kj it kl b km kn ko kp kq kr ks kt lh kv kw kx li kz la lb lj ld le lf lg im bi translated">为了让玩家实时聊天，我们将使用PubNub的<a class="ae mn" href="https://www.pubnub.com/docs/chat-engine/getting-started" rel="noopener ugc nofollow" target="_blank">聊天引擎</a>。要设置ChatEngine，您需要使用与游戏不同的发布/订阅密钥。你可以在这里获得免费的预配置密钥<a class="ae mn" href="https://www.pubnub.com/tutorials/chatengine/" rel="noopener ugc nofollow" target="_blank"/>。将这些键添加到上面使用的同一个文件中，并将这些键标记为“主聊天键”。由于游戏使用两个独立的聊天框(一个用于消息传递，另一个用于猜词)，您需要重新加载页面(或点击<a class="ae mn" href="https://www.pubnub.com/tutorials/chatengine/" rel="noopener ugc nofollow" target="_blank">此处</a>)来获得不同的密钥。将这些键添加到文件中，并标记为“猜词聊天键”。</p><p id="1db7" class="pw-post-body-paragraph ki kj it kl b km kn ko kp kq kr ks kt lh kv kw kx li kz la lb lj ld le lf lg im bi translated">现在我们已经完成了上面的工作，我们可以开始游戏了。创建一个目录来存储游戏文件。对于本教程，您可以使用任何文本编辑器。我个人喜欢将<a class="ae mn" href="https://code.visualstudio.com/download" rel="noopener ugc nofollow" target="_blank"> VS代码</a>与Live服务器扩展一起使用。</p><h1 id="bbf5" class="lk ll it bd lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh bi translated">设置HTML/CSS文件</h1><p id="2491" class="pw-post-body-paragraph ki kj it kl b km mi ko kp kq mj ks kt lh mk kw kx li ml la lb lj mm le lf lg im bi translated">创建一个新文件，index.html，并将其添加到您为游戏创建的目录中。我们将设置画布、两个聊天框容器和色样。确保您的外部文件包含PubNub的JavaScript SDK和ChatEngine JavaScript SDK。</p><figure class="mp mq mr ms gt ju"><div class="bz fp l di"><div class="mt mu l"/></div></figure><p id="7bea" class="pw-post-body-paragraph ki kj it kl b km kn ko kp kq kr ks kt lh kv kw kx li kz la lb lj ld le lf lg im bi translated">html文件到此为止！你可以从<a class="ae mn" href="https://github.com/ocastroa/GuessWordPubNub/blob/master/style.css" rel="noopener ugc nofollow" target="_blank">这里</a>得到css文件。</p><h1 id="5dde" class="lk ll it bd lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh bi translated">设置大厅</h1><p id="43ce" class="pw-post-body-paragraph ki kj it kl b km mi ko kp kq mj ks kt lh mk kw kx li ml la lb lj mm le lf lg im bi translated">创建一个新文件lobby.js，并将其添加到您的游戏目录中。<br/> <br/>大厅的代码将在一个<a class="ae mn" href="https://en.wikibooks.org/wiki/JavaScript/Anonymous_functions" rel="noopener ugc nofollow" target="_blank">匿名函数</a>中。</p><pre class="mp mq mr ms gt mv mw mx my aw mz bi"><span id="276e" class="na ll it mw b gy nb nc l nd ne">(function() {<br/>  // Lobby code goes here<br/>})();</span></pre><p id="1305" class="pw-post-body-paragraph ki kj it kl b km kn ko kp kq kr ks kt lh kv kw kx li kz la lb lj ld le lf lg im bi translated">我们首先初始化<em class="kk">播放器</em>变量。</p><pre class="mp mq mr ms gt mv mw mx my aw mz bi"><span id="5748" class="na ll it mw b gy nb nc l nd ne">const player = {<br/>  name: '',<br/>  sign: '',<br/>  score: 0<br/>}</span></pre><p id="68ec" class="pw-post-body-paragraph ki kj it kl b km kn ko kp kq kr ks kt lh kv kw kx li kz la lb lj ld le lf lg im bi translated"><em class="kk">玩家</em>变量包含3个对象属性:</p><p id="9537" class="pw-post-body-paragraph ki kj it kl b km kn ko kp kq kr ks kt lh kv kw kx li kz la lb lj ld le lf lg im bi translated">1)名称:开始为空，但后来设置为“主机”或“客人”。<br/> 2)标志:开始为空，但后来设置为“H”或“G”。<br/> 3)评分:设置为0。</p><p id="5903" class="pw-post-body-paragraph ki kj it kl b km kn ko kp kq kr ks kt lh kv kw kx li kz la lb lj ld le lf lg im bi translated">因为我们要改变文本，我们需要从html文件中获取元素。我们是这样做的:</p><pre class="mp mq mr ms gt mv mw mx my aw mz bi"><span id="35c6" class="na ll it mw b gy nb nc l nd ne">function $(id) { <br/>  return document.getElementById(id); <br/>}</span><span id="5d4e" class="na ll it mw b gy nf nc l nd ne">let score = $('score'), triesLeft = $('triesLeft'),          guessWord = $('guessWord'), opponentScore = $('opponentScore');</span></pre><p id="f49a" class="pw-post-body-paragraph ki kj it kl b km kn ko kp kq kr ks kt lh kv kw kx li kz la lb lj ld le lf lg im bi translated">在新游戏开始时，玩家将输入一个大厅名称。</p><pre class="mp mq mr ms gt mv mw mx my aw mz bi"><span id="16d7" class="na ll it mw b gy nb nc l nd ne">let lobby = prompt("Enter name of lobby");<br/>let game = lobby; // game is the channel where the game takes places<br/>lobby = lobby + 'Lobby'; // separate channel for lobby</span></pre><p id="28fb" class="pw-post-body-paragraph ki kj it kl b km kn ko kp kq kr ks kt lh kv kw kx li kz la lb lj ld le lf lg im bi translated">我们将<em class="kk">游戏</em>设置为lobby的值，并将‘Lobby’追加到<em class="kk"> lobby。</em>我们做<em class="kk"> </em>这个<em class="kk"> </em>来分别从两个通道得到玩家的存在。</p><p id="d9ae" class="pw-post-body-paragraph ki kj it kl b km kn ko kp kq kr ks kt lh kv kw kx li kz la lb lj ld le lf lg im bi translated">让我们初始化将在这个文件中使用的变量。</p><pre class="mp mq mr ms gt mv mw mx my aw mz bi"><span id="22d3" class="na ll it mw b gy nb nc l nd ne">const newUUID = PubNub.generateUUID();<br/>let isHost = false;<br/>let ChatEngine = '';<br/>let GuessWordChatEngine = '';</span></pre><p id="666d" class="pw-post-body-paragraph ki kj it kl b km kn ko kp kq kr ks kt lh kv kw kx li kz la lb lj ld le lf lg im bi translated">实例化一个新的PubNub实例，用你的“游戏密钥”替换“游戏_pub_key”和“游戏_sub_key”。</p><pre class="mp mq mr ms gt mv mw mx my aw mz bi"><span id="0bff" class="na ll it mw b gy nb nc l nd ne">const pubnubGuessGame = new PubNub({<br/>  uuid: newUUID,<br/>  publish_key: 'game_pub_key',<br/>  subscribe_key: 'game_sub_key',<br/>  ssl: true<br/>});</span></pre><p id="3e6f" class="pw-post-body-paragraph ki kj it kl b km kn ko kp kq kr ks kt lh kv kw kx li kz la lb lj ld le lf lg im bi translated">创建一个新的监听器，以接收连接状态和存在的通知。另外，添加侦听器。</p><figure class="mp mq mr ms gt ju"><div class="bz fp l di"><div class="mt mu l"/></div></figure><p id="ba99" class="pw-post-body-paragraph ki kj it kl b km kn ko kp kq kr ks kt lh kv kw kx li kz la lb lj ld le lf lg im bi translated">让我们检查一下代码。监听器中有两个回调函数:存在和状态。在线状态检测大厅频道中的新玩家。第一个进入新大厅的玩家成为主人，第二个进入同一大厅的玩家成为客人。当两个玩家在一个大厅时，监听器将被移除，玩家将从大厅频道退订(但仍订阅游戏频道)，游戏将开始。</p><p id="d394" class="pw-post-body-paragraph ki kj it kl b km kn ko kp kq kr ks kt lh kv kw kx li kz la lb lj ld le lf lg im bi translated">由于玩家不再订阅大厅频道，其他玩家将可以访问大厅，因为它是空的。为了防止这个问题，我们调用hereNow()来检查游戏通道中的人数。如果两个玩家在游戏频道中，那么我们通知新玩家游戏正在进行中，移除监听器，并取消新玩家的订阅。</p><figure class="mp mq mr ms gt ju"><div class="bz fp l di"><div class="mt mu l"/></div></figure><p id="0b84" class="pw-post-body-paragraph ki kj it kl b km kn ko kp kq kr ks kt lh kv kw kx li kz la lb lj ld le lf lg im bi translated">在状态回调函数中，我们通过调用connectToChat()将玩家连接到聊天引擎。</p><figure class="mp mq mr ms gt ju"><div class="bz fp l di"><div class="mt mu l"/></div></figure><p id="986f" class="pw-post-body-paragraph ki kj it kl b km kn ko kp kq kr ks kt lh kv kw kx li kz la lb lj ld le lf lg im bi translated">用您的“主聊天键”替换“主聊天键”和“主聊天键”。将“guess_word_chat_pub_key”和“guess_word_chat_sub_key”替换为您的“guess word聊天键”。玩家的uuid或者是“主机”(如果他们是主机),或者是“客人”(如果他们是客人)。这是他们互相发信息时的样子，一旦游戏开始，他们就可以开始发信息了。</p><p id="c9d2" class="pw-post-body-paragraph ki kj it kl b km kn ko kp kq kr ks kt lh kv kw kx li kz la lb lj ld le lf lg im bi translated">建立连接后，状态回调函数中的event.category返回“PNConnectedCategory”。发生这种情况时，会调用setUpCanvas()。</p><figure class="mp mq mr ms gt ju"><div class="bz fp l di"><div class="mt mu l"/></div></figure><p id="01ce" class="pw-post-body-paragraph ki kj it kl b km kn ko kp kq kr ks kt lh kv kw kx li kz la lb lj ld le lf lg im bi translated">在我们刚刚实现的监听器的正下方，订阅大厅频道并启用presence。</p><pre class="mp mq mr ms gt mv mw mx my aw mz bi"><span id="3a16" class="na ll it mw b gy nb nc l nd ne">pubnubGuessGame.subscribe({<br/>  channels: [lobby],<br/>  withPresence: true<br/>});</span></pre><p id="865a" class="pw-post-body-paragraph ki kj it kl b km kn ko kp kq kr ks kt lh kv kw kx li kz la lb lj ld le lf lg im bi translated">现在我们已经完成了大厅，我们可以开始为游戏本身编写代码了。</p><h1 id="4c0b" class="lk ll it bd lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh bi translated">实现游戏</h1><p id="dfa8" class="pw-post-body-paragraph ki kj it kl b km mi ko kp kq mj ks kt lh mk kw kx li ml la lb lj mm le lf lg im bi translated">创建一个新文件guessDrawing.js，并将其添加到您的游戏目录中。</p><p id="8304" class="pw-post-body-paragraph ki kj it kl b km kn ko kp kq kr ks kt lh kv kw kx li kz la lb lj ld le lf lg im bi translated">游戏的代码将在函数gameStart()中。这些参数是lobby.js文件中的变量。</p><pre class="mp mq mr ms gt mv mw mx my aw mz bi"><span id="1e12" class="na ll it mw b gy nb nc l nd ne">function gameStart(pubnubGuessGame, ChatEngine, GuessWordChatEngine, game, player){<br/>  // Game code goes here<br/>}</span></pre><p id="c66f" class="pw-post-body-paragraph ki kj it kl b km kn ko kp kq kr ks kt lh kv kw kx li kz la lb lj ld le lf lg im bi translated">初始化将用于游戏的变量。</p><figure class="mp mq mr ms gt ju"><div class="bz fp l di"><div class="mt mu l"/></div></figure><p id="bd8e" class="pw-post-body-paragraph ki kj it kl b km kn ko kp kq kr ks kt lh kv kw kx li kz la lb lj ld le lf lg im bi translated">将从数组<em class="kk">字</em>中选择一个随机元素，并将其从数组中移除。选中的单词将只显示给画出该单词的玩家。第一个抽到的玩家是主人，客人有3次猜词的机会。</p><p id="bef3" class="pw-post-body-paragraph ki kj it kl b km kn ko kp kq kr ks kt lh kv kw kx li kz la lb lj ld le lf lg im bi translated">同样，我们需要访问html文件中的文本。</p><pre class="mp mq mr ms gt mv mw mx my aw mz bi"><span id="6c20" class="na ll it mw b gy nb nc l nd ne">function $(id){ <br/>  return document.getElementById(id); <br/>}</span><span id="0cbf" class="na ll it mw b gy nf nc l nd ne">let chatLog =  $('chatLog'), chatInput = $('chatInput'), guessWordChatLog =  $('guessWordChatLog'), guessWordInput = $('guessWordChatInput'), clearCanvasButton = $('clearCanvasButton'),     score = $('score'), colorSwatch = $('colorSwatch'), triesLeft = $('triesLeft'), guessWord = $('guessWord'), opponentScore = $('opponentScore');</span></pre><p id="9ba5" class="pw-post-body-paragraph ki kj it kl b km kn ko kp kq kr ks kt lh kv kw kx li kz la lb lj ld le lf lg im bi translated">当ChatEngine成功连接时，会出现一个' $。激发“就绪”事件。因为我们已经在lobby.js文件中连接了ChatEngine，所以我们需要为' $ '编写代码。“就绪”事件。</p><pre class="mp mq mr ms gt mv mw mx my aw mz bi"><span id="3fad" class="na ll it mw b gy nb nc l nd ne">ChatEngine.on('$.ready', function(data){<br/>   // Every time a message is recieved from PubNub, render it.<br/>   ChatEngine.global.on('message', onMessage);<br/>});</span><span id="6e6f" class="na ll it mw b gy nf nc l nd ne">GuessWordChatEngine.on('$.ready', function(data){<br/>   GuessWordChatEngine.global.on('message', onMessageGuessWord);<br/>});</span></pre><p id="d289" class="pw-post-body-paragraph ki kj it kl b km kn ko kp kq kr ks kt lh kv kw kx li kz la lb lj ld le lf lg im bi translated">ChatEngine已经设置完毕，可以使用了。每当玩家在主聊天框中发送消息时，都会调用sendMessage()。</p><figure class="mp mq mr ms gt ju"><div class="bz fp l di"><div class="mt mu l"/></div></figure><p id="b6a1" class="pw-post-body-paragraph ki kj it kl b km kn ko kp kq kr ks kt lh kv kw kx li kz la lb lj ld le lf lg im bi translated">当按下一个键时，监听器调用sendMessage()。在函数内部，我们检查按下的键是否是“enter”或键代码13，以及输入是否大于0。如果是这样的话，玩家写的文本，以及他们被分配的名字(主人或客人)被发送。聊天输入被设置为一个空字符串，这样玩家可以写一个新句子。</p><p id="bf63" class="pw-post-body-paragraph ki kj it kl b km kn ko kp kq kr ks kt lh kv kw kx li kz la lb lj ld le lf lg im bi translated">收到消息时，调用onMessage()将消息添加到主聊天日志中。</p><figure class="mp mq mr ms gt ju"><div class="bz fp l di"><div class="mt mu l"/></div></figure><p id="65ef" class="pw-post-body-paragraph ki kj it kl b km kn ko kp kq kr ks kt lh kv kw kx li kz la lb lj ld le lf lg im bi translated">我们将稍后实现猜词聊天框的功能，因为我们需要首先设置游戏。现在，让我们创建一个新的监听器，“gameListener”，并添加监听器。</p><figure class="mp mq mr ms gt ju"><div class="bz fp l di"><div class="mt mu l"/></div></figure><p id="c4f7" class="pw-post-body-paragraph ki kj it kl b km kn ko kp kq kr ks kt lh kv kw kx li kz la lb lj ld le lf lg im bi translated">我们添加了一个新的回调函数message，它监听发布到游戏通道的任何消息。该通道将接收几个消息，但我们只需要处理3个特定的消息:</p><p id="b6bb" class="pw-post-body-paragraph ki kj it kl b km kn ko kp kq kr ks kt lh kv kw kx li kz la lb lj ld le lf lg im bi translated">1)<em class="kk">msg . message . chosen word</em>:无论何时从数组中选择一个随机字，我们都将该字发布到通道，并将其添加到变量<em class="kk"> chosenWord </em>的值中。我们只对轮到猜抽牌的玩家这样做。</p><p id="0628" class="pw-post-body-paragraph ki kj it kl b km kn ko kp kq kr ks kt lh kv kw kx li kz la lb lj ld le lf lg im bi translated">2) <em class="kk"> msg.message.plots </em>:一旦玩家停止在画布上绘图，我们就将绘图的路径添加到<em class="kk"> plots </em>数组，并将该数组以及绘图的颜色发布到通道。另一个玩家会收到这条消息，并调用drawFromStream()，后者调用drawOnCanvas()在他们的画布上进行绘制。</p><figure class="mp mq mr ms gt ju"><div class="bz fp l di"><div class="mt mu l"/></div></figure><p id="b650" class="pw-post-body-paragraph ki kj it kl b km kn ko kp kq kr ks kt lh kv kw kx li kz la lb lj ld le lf lg im bi translated">确保在drawFromStream()之前初始化变量。</p><figure class="mp mq mr ms gt ju"><div class="bz fp l di"><div class="mt mu l"/></div></figure><p id="f0ab" class="pw-post-body-paragraph ki kj it kl b km kn ko kp kq kr ks kt lh kv kw kx li kz la lb lj ld le lf lg im bi translated">3)<em class="kk">msg . message . clearthecanvas</em>—当抽签的玩家按下清除按钮时，或者在新一轮中，发布一条消息，为双方玩家清除画布。当收到消息时，调用clearCanvas()。</p><pre class="mp mq mr ms gt mv mw mx my aw mz bi"><span id="51b0" class="na ll it mw b gy nb nc l nd ne">function clearCanvas(){<br/>  ctx.fillStyle = 'WHITE';<br/>  ctx.clearRect(0,0,window.innerWidth, window.innerHeight);<br/>  ctx.fillRect(20,20,window.innerWidth, window.innerHeight);     <br/>}</span></pre><p id="eb82" class="pw-post-body-paragraph ki kj it kl b km kn ko kp kq kr ks kt lh kv kw kx li kz la lb lj ld le lf lg im bi translated">对于存在回调函数，我们需要检查玩家是否在游戏结束前离开了游戏。如果是，那么response.action是“离开”,另一个玩家被宣布为获胜者。然后，两个玩家都退订游戏频道，并与聊天引擎断开连接。游戏结束后，玩家也会退订并断开连接。</p><figure class="mp mq mr ms gt ju"><div class="bz fp l di"><div class="mt mu l"/></div></figure><p id="645e" class="pw-post-body-paragraph ki kj it kl b km kn ko kp kq kr ks kt lh kv kw kx li kz la lb lj ld le lf lg im bi translated">当连接建立后，状态被调用。如果event.category返回‘PNConnectedCategory’，那么游戏开始。在我们实现startGame()之前，让我们订阅频道。</p><pre class="mp mq mr ms gt mv mw mx my aw mz bi"><span id="0d28" class="na ll it mw b gy nb nc l nd ne">pubnubGuessGame.subscribe({<br/>  channels: [game],<br/>  withPresence: true<br/>});</span></pre><p id="d36f" class="pw-post-body-paragraph ki kj it kl b km kn ko kp kq kr ks kt lh kv kw kx li kz la lb lj ld le lf lg im bi translated">在此之下，我们添加了一个函数publish()，当我们需要向通道发布数据时，就会调用这个函数。为了发布，我们需要传入通道的名称和我们想要发布的数据。</p><pre class="mp mq mr ms gt mv mw mx my aw mz bi"><span id="c68c" class="na ll it mw b gy nb nc l nd ne">function publish(data){<br/>  pubnubGuessGame.publish({<br/>    channel: game,<br/>    message: data<br/>   });<br/>}</span></pre><p id="c394" class="pw-post-body-paragraph ki kj it kl b km kn ko kp kq kr ks kt lh kv kw kx li kz la lb lj ld le lf lg im bi translated">现在让我们实现startGame()。</p><figure class="mp mq mr ms gt ju"><div class="bz fp l di"><div class="mt mu l"/></div></figure><p id="3902" class="pw-post-body-paragraph ki kj it kl b km kn ko kp kq kr ks kt lh kv kw kx li kz la lb lj ld le lf lg im bi translated">该轮到谁猜抽彩的玩家将被返回。另一个玩家将会看到一个随机的单词，这个单词将会发布到频道上。然后，播放器将通过监听器访问色板、清除按钮和绘图功能。有3种绘图功能:</p><p id="8561" class="pw-post-body-paragraph ki kj it kl b km kn ko kp kq kr ks kt lh kv kw kx li kz la lb lj ld le lf lg im bi translated">1) startDraw():当玩家在画布上按下时，调用该函数将变量<em class="kk"> isActive </em>设置为true，这意味着玩家准备好开始绘制了。</p><pre class="mp mq mr ms gt mv mw mx my aw mz bi"><span id="bb5e" class="na ll it mw b gy nb nc l nd ne">function startDraw(e) {<br/>  e.preventDefault();<br/>  isActive = true;<br/>}</span></pre><p id="35bc" class="pw-post-body-paragraph ki kj it kl b km kn ko kp kq kr ks kt lh kv kw kx li kz la lb lj ld le lf lg im bi translated">2) draw():玩家一开始在画布上移动，就调用这个函数。显示路径的画布坐标被推送到数组<em class="kk"> plots </em>中，并与颜色一起发送到drawOnCanvas()。由于这个游戏可以在触摸屏上玩，所以坐标是四舍五入的。</p><figure class="mp mq mr ms gt ju"><div class="bz fp l di"><div class="mt mu l"/></div></figure><p id="cb3d" class="pw-post-body-paragraph ki kj it kl b km kn ko kp kq kr ks kt lh kv kw kx li kz la lb lj ld le lf lg im bi translated">3) endDraw():一旦玩家停止在画布上移动，就调用这个函数。变量<em class="kk"> isActive </em>再次被设置为false，颜色和绘图被发布到通道，并且<em class="kk">绘图</em>数组被设置为空数组。</p><figure class="mp mq mr ms gt ju"><div class="bz fp l di"><div class="mt mu l"/></div></figure><p id="980e" class="pw-post-body-paragraph ki kj it kl b km kn ko kp kq kr ks kt lh kv kw kx li kz la lb lj ld le lf lg im bi translated">当画图的玩家按下clear按钮时，调用clear button()来清除画布。变量<em class="kk"> clearTheCanvas </em>设置为真，并发布到通道。</p><pre class="mp mq mr ms gt mv mw mx my aw mz bi"><span id="03c8" class="na ll it mw b gy nb nc l nd ne">function clearButton(e){<br/>  e.preventDefault();<br/>  clearTheCanvas = true;<br/>  publish({<br/>     clearTheCanvas: clearTheCanvas<br/>   })<br/>}</span></pre><p id="ff33" class="pw-post-body-paragraph ki kj it kl b km kn ko kp kq kr ks kt lh kv kw kx li kz la lb lj ld le lf lg im bi translated">一旦玩家猜对了图画中的单词，或者试完了，角色就会互换。玩家不断交换角色，直到有人达到3分。当玩家切换角色时，调用nextRound()。</p><figure class="mp mq mr ms gt ju"><div class="bz fp l di"><div class="mt mu l"/></div></figure><p id="54d9" class="pw-post-body-paragraph ki kj it kl b km kn ko kp kq kr ks kt lh kv kw kx li kz la lb lj ld le lf lg im bi translated">首先，该函数检查某个玩家的分数是否为3，如果是，则宣布获胜者，并调用unsubscribeFromGame()。否则，为两个玩家清除画布，清除猜词聊天日志，并将<em class="kk">尝试</em>重置为3。如果没有轮到玩家画图，那么<em class="kk">guess sword</em>和<em class="kk"> triesLeft </em>被设置为适当的文本，用于画图的监听器以及清除按钮被移除，因此它们将无法访问画布。玩家抽奖将把<em class="kk">guess sword</em>和<em class="kk"> triesLeft </em>设置为空字符串，并调用startGame()。</p><p id="0191" class="pw-post-body-paragraph ki kj it kl b km kn ko kp kq kr ks kt lh kv kw kx li kz la lb lj ld le lf lg im bi translated">剩下唯一要实现的是猜词聊天框的功能。让我们实现onMessageGuessWord()。</p><figure class="mp mq mr ms gt ju"><div class="bz fp l di"><div class="mt mu l"/></div></figure><p id="74ad" class="pw-post-body-paragraph ki kj it kl b km kn ko kp kq kr ks kt lh kv kw kx li kz la lb lj ld le lf lg im bi translated">无论何时收到消息，我们都会将其显示在猜词聊天日志中。这条消息应该是猜测的单词。我们检查它是否与为该轮选择的单词匹配。如果单词匹配并尝试大于0，那么我们奖励猜中正确单词的玩家一分。我们增加玩家分数，并在他们的屏幕上显示为“我的分数:#”。更新后的分数显示给其他玩家，显示为“对手分数:#”。之后调用switchTurns()来交换玩家的角色并开始新一轮。</p><pre class="mp mq mr ms gt mv mw mx my aw mz bi"><span id="90e3" class="na ll it mw b gy nb nc l nd ne">function switchTurns(){<br/>  turn = (turn === 'H') ? 'G' : 'H';<br/>  nextRound();<br/>}</span></pre><p id="0424" class="pw-post-body-paragraph ki kj it kl b km kn ko kp kq kr ks kt lh kv kw kx li kz la lb lj ld le lf lg im bi translated">如果玩家用完了所有的尝试，他们将不会得到任何分数，角色也会被交换。否则，我们减少剩余的尝试次数。</p><p id="02db" class="pw-post-body-paragraph ki kj it kl b km kn ko kp kq kr ks kt lh kv kw kx li kz la lb lj ld le lf lg im bi translated">既然我们已经处理了接收来自猜测单词聊天框的消息，那么让我们添加一个新的按键监听器并实现函数sendMessageGuessWord()。</p><figure class="mp mq mr ms gt ju"><div class="bz fp l di"><div class="mt mu l"/></div></figure><p id="021e" class="pw-post-body-paragraph ki kj it kl b km kn ko kp kq kr ks kt lh kv kw kx li kz la lb lj ld le lf lg im bi translated">这几乎与sendMessage()相同，只是我们添加了一个if语句来检查只有猜测图画的玩家才能发送消息。玩家抽奖没有发送消息的权限，如果他们试图发送消息，将会收到警告。这是作为一种边缘情况来完成的，因为在大多数情况下，绘制的玩家不会发送他们正在绘制的单词。毕竟，这样做不符合他们的最佳利益。</p><p id="a1f7" class="pw-post-body-paragraph ki kj it kl b km kn ko kp kq kr ks kt lh kv kw kx li kz la lb lj ld le lf lg im bi translated">仅此而已！总共你应该有4个文件:index.html，风格. css，大厅. js和guessDrawing.js。如果你使用的是VS代码与直播服务器扩展，运行直播服务器，并输入一个大厅名称。如果你使用另一个文本编辑器，运行index.html文件。复制并粘贴网址到另一个标签，或最好是一个新的窗口，输入相同的大厅名称，游戏将开始！</p><h1 id="6efa" class="lk ll it bd lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh bi translated">怎么玩</h1><p id="0707" class="pw-post-body-paragraph ki kj it kl b km mi ko kp kq mj ks kt lh mk kw kx li ml la lb lj mm le lf lg im bi translated">1)大厅中的第一个玩家是主持人。第二个加入同一大厅的玩家是客人。</p><p id="06a0" class="pw-post-body-paragraph ki kj it kl b km kn ko kp kq kr ks kt lh kv kw kx li kz la lb lj ld le lf lg im bi translated">2)当大厅中有两名玩家时，游戏开始。</p><p id="1f4c" class="pw-post-body-paragraph ki kj it kl b km kn ko kp kq kr ks kt lh kv kw kx li kz la lb lj ld le lf lg im bi translated">3)给主持人一个词，需要在画布上画出来。</p><p id="99b0" class="pw-post-body-paragraph ki kj it kl b km kn ko kp kq kr ks kt lh kv kw kx li kz la lb lj ld le lf lg im bi translated">4)游客有3次机会猜测代表绘画的单词，并在猜测聊天框中输入他们的猜测。如果客人猜出正确的单词，他们将获得一分。<br/> —注意:虽然游客可以看到他们画布上的图画，但在轮到他们画单词之前，他们不能在画布上画画。</p><p id="af9e" class="pw-post-body-paragraph ki kj it kl b km kn ko kp kq kr ks kt lh kv kw kx li kz la lb lj ld le lf lg im bi translated">5)一旦猜对了一个单词，或者尝试次数等于0，角色就交换，客人画一个新单词，而主人猜这个画。</p><p id="613d" class="pw-post-body-paragraph ki kj it kl b km kn ko kp kq kr ks kt lh kv kw kx li kz la lb lj ld le lf lg im bi translated">6)角色不断切换，直到一个玩家达到3分。宣布该玩家获胜，游戏结束。<br/> —如果一名玩家在游戏结束前离开，另一名玩家将被宣布获胜。</p><h1 id="ae9d" class="lk ll it bd lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh bi translated">最后一个音符</h1><p id="b962" class="pw-post-body-paragraph ki kj it kl b km mi ko kp kq mj ks kt lh mk kw kx li ml la lb lj mm le lf lg im bi translated">游戏保持简单，因为这个游戏的目的是演示如何在多人游戏中实现PubNub的API。这个游戏的可能性是无限的。你可以在一个大厅中允许更多的玩家，让玩家选择一个类别来抽奖(如动物)，将获胜分数从3增加，添加更多的颜色供选择，添加抽奖的时间限制等。</p><p id="58ce" class="pw-post-body-paragraph ki kj it kl b km kn ko kp kq kr ks kt lh kv kw kx li kz la lb lj ld le lf lg im bi translated">我希望你喜欢这个教程！</p><h1 id="9aa3" class="lk ll it bd lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh bi translated">致谢:</h1><p id="3ee6" class="pw-post-body-paragraph ki kj it kl b km mi ko kp kq mj ks kt lh mk kw kx li ml la lb lj mm le lf lg im bi translated">游戏的灵感和一些代码来自PubNub的开源项目:<a class="ae mn" href="https://github.com/pubnub/codoodler" rel="noopener ugc nofollow" target="_blank"> codoodler </a> -一个多用户涂鸦网络应用。</p><p id="933b" class="pw-post-body-paragraph ki kj it kl b km kn ko kp kq kr ks kt lh kv kw kx li kz la lb lj ld le lf lg im bi translated">其他使用的资源包括:<a class="ae mn" href="https://www.pubnub.com/tutorials/javascript/multiplayer-game/" rel="noopener ugc nofollow" target="_blank">开发你的第一个多人游戏</a>和<a class="ae mn" href="https://www.pubnub.com/blog/in-game-multiplayer-chat-with-chatengine/" rel="noopener ugc nofollow" target="_blank">用聊天引擎为多人游戏添加游戏内聊天</a></p></div></div>    
</body>
</html>