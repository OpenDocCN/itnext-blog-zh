<html>
<head>
<title>Load balancing strategies in Kubernetes</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Kubernetes中的负载平衡策略</h1>
<blockquote>原文：<a href="https://itnext.io/load-balancing-strategies-in-kubernetes-6213a5becd66?source=collection_archive---------0-----------------------#2019-09-26">https://itnext.io/load-balancing-strategies-in-kubernetes-6213a5becd66?source=collection_archive---------0-----------------------#2019-09-26</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="40ed" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">L4循环法、L7循环法、环形散列法等等</h2></div><p id="1791" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">负载平衡是在多个后端服务之间高效分配网络流量的过程，是最大化可扩展性和可用性的关键策略。在Kubernetes中，有多种选择可以对pods的外部流量进行负载平衡，每种选择都有不同的权衡。</p><h1 id="7fd1" class="lb lc iq bd ld le lf lg lh li lj lk ll jw lm jx ln jz lo ka lp kc lq kd lr ls bi translated">使用kube代理的L4循环负载平衡</h1><p id="b690" class="pw-post-body-paragraph kf kg iq kh b ki lt jr kk kl lu ju kn ko lv kq kr ks lw ku kv kw lx ky kz la ij bi translated">在一个典型的Kubernetes集群中，发送到Kubernetes服务的请求由一个名为<code class="fe ly lz ma mb b"><a class="ae mc" href="https://kubernetes.io/docs/reference/command-line-tools-reference/kube-proxy/" rel="noopener ugc nofollow" target="_blank">kube-proxy</a></code>的组件路由。有些令人困惑的是，<code class="fe ly lz ma mb b">kube-proxy</code>不是传统意义上的代理，而是通过iptables规则为服务实现虚拟IP的过程。这种架构给路由增加了<a class="ae mc" href="https://jvns.ca/blog/2017/10/10/operating-a-kubernetes-network/" rel="noopener ugc nofollow" target="_blank">额外的复杂性。每个请求都会引入少量的延迟，随着服务数量的增加，延迟也会增加。此外，<code class="fe ly lz ma mb b">kube-proxy</code>在L4 (TCP)路由，这不一定很适合今天以应用为中心的协议。例如，假设两个gRPC客户端连接到您的后端pod。在L4负载平衡中，每个客户端将被发送到不同的后端pod(循环)。即使一个客户端每分钟发送1个请求，而另一个客户端每秒发送100个请求，也是如此。</a></p><p id="b505" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">那么为什么要使用<code class="fe ly lz ma mb b">kube-proxy</code>呢？一个字:简单。负载平衡的整个过程委托给Kubernetes，这是默认策略。因此，无论您是通过Ambassador还是通过其他服务发送请求，您都要经历相同的负载平衡机制。</p><h1 id="2a3a" class="lb lc iq bd ld le lf lg lh li lj lk ll jw lm jx ln jz lo ka lp kc lq kd lr ls bi translated">L7循环负载平衡</h1><p id="cc13" class="pw-post-body-paragraph kf kg iq kh b ki lt jr kk kl lu ju kn ko lv kq kr ks lw ku kv kw lx ky kz la ij bi translated">如果您使用gRPC或HTTP/2之类的多路复用保活协议，并且需要更公平的循环算法，该怎么办？你可以为Kubernetes使用API网关，比如<a class="ae mc" href="https://www.getambassador.io/" rel="noopener ugc nofollow" target="_blank"> Ambassador </a>，它可以完全绕过<code class="fe ly lz ma mb b">kube-proxy</code>，将流量直接路由到Kubernetes pods。Ambassador建立在Envoy Proxy之上，这是一个L7代理，因此每个gRPC请求在可用的pods之间进行负载平衡。</p><p id="507c" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在这种方法中，您的负载平衡器使用<a class="ae mc" href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.14/#endpoints-v1-core" rel="noopener ugc nofollow" target="_blank"> Kubernetes端点API </a>来跟踪pod的可用性。当对特定Kubernetes服务的请求被发送到您的负载平衡器时，负载平衡器会在映射到给定服务的pods之间循环交换请求。</p><h1 id="e6c8" class="lb lc iq bd ld le lf lg lh li lj lk ll jw lm jx ln jz lo ka lp kc lq kd lr ls bi translated">环形散列</h1><p id="b170" class="pw-post-body-paragraph kf kg iq kh b ki lt jr kk kl lu ju kn ko lv kq kr ks lw ku kv kw lx ky kz la ij bi translated">环哈希负载平衡策略不是在不同的pod之间轮换请求，而是使用哈希算法将来自给定客户端的所有请求发送到同一个pod。环形散列方法既用于“粘性会话”(其中设置cookie以确保来自客户端的所有请求到达相同的pod)，也用于“会话相似性”(依赖于客户端IP或客户端状态的某个其他部分)。</p><p id="34b0" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">哈希方法对于维护每个客户端状态的服务(例如，购物车)非常有用。通过将相同的客户端路由到相同的pod，给定客户端的状态不需要跨pod同步。此外，如果您在给定的pod上缓存客户端数据，缓存命中的概率也会增加。使用环哈希的缺点是，在不同的后端服务器之间平均分配负载可能更具挑战性，因为客户端工作负载可能不相等。此外，散列的计算成本增加了请求的延迟，尤其是在大规模的情况下。</p><h1 id="ce0a" class="lb lc iq bd ld le lf lg lh li lj lk ll jw lm jx ln jz lo ka lp kc lq kd lr ls bi translated">磁力悬浮火车</h1><p id="66a5" class="pw-post-body-paragraph kf kg iq kh b ki lt jr kk kl lu ju kn ko lv kq kr ks lw ku kv kw lx ky kz la ij bi translated">和环哈希一样，maglev也是一种<a class="ae mc" href="https://en.wikipedia.org/wiki/Consistent_hashing" rel="noopener ugc nofollow" target="_blank">一致哈希算法</a>。maglev最初由Google开发，设计目的是在哈希表查找上比环形哈希算法更快，并最小化内存占用。环形哈希算法生成相当大的查找表，不适合您的CPU处理器缓存。对于微服务，Maglev有一个相当昂贵的权衡:当一个节点出现故障时，生成查找表的成本相对较高。鉴于Kubernetes豆荚短暂的本质，这可能行不通。关于不同一致性散列算法的权衡的更多细节，<a class="ae mc" href="https://medium.com/@dgryski/consistent-hashing-algorithmic-tradeoffs-ef6b8e2fcae8" rel="noopener">本文</a>详细介绍了用于负载平衡的一致性散列，以及一些基准。</p><h1 id="5d12" class="lb lc iq bd ld le lf lg lh li lj lk ll jw lm jx ln jz lo ka lp kc lq kd lr ls bi translated">了解更多信息</h1><p id="6619" class="pw-post-body-paragraph kf kg iq kh b ki lt jr kk kl lu ju kn ko lv kq kr ks lw ku kv kw lx ky kz la ij bi translated">Kubernetes中的网络实现比第一次出现时更复杂，也比许多工程师理解的更有限。Matt Klein撰写了一篇内容丰富的博客文章"<a class="ae mc" href="https://blog.envoyproxy.io/introduction-to-modern-network-load-balancing-and-proxying-a57f6ff80236" rel="noopener ugc nofollow" target="_blank">现代网络负载平衡和代理介绍</a>"，为理解关键概念提供了坚实的基础。还有一系列额外的帖子解释了为什么组织选择使用第7层感知代理来负载平衡入口流量，如<a class="ae mc" href="https://blog.bugsnag.com/envoy/" rel="noopener ugc nofollow" target="_blank"> Bugsnag </a>、<a class="ae mc" href="https://medium.com/geckoboard-under-the-hood/we-rolled-out-envoy-at-geckoboard-13c45b4eaddd" rel="noopener"> Geckoboard </a>和<a class="ae mc" href="https://www.twilio.com/blog/2017/10/http2-issues.html" rel="noopener ugc nofollow" target="_blank"> Twilio </a>。</p><h1 id="9448" class="lb lc iq bd ld le lf lg lh li lj lk ll jw lm jx ln jz lo ka lp kc lq kd lr ls bi translated">大使API网关</h1><p id="2841" class="pw-post-body-paragraph kf kg iq kh b ki lt jr kk kl lu ju kn ko lv kq kr ks lw ku kv kw lx ky kz la ij bi translated">Ambassador建立在Envoy代理之上，是一个开源API网关，支持Kubernetes上讨论的所有负载平衡方法。请访问<a class="ae mc" href="https://www.getambassador.io/" rel="noopener ugc nofollow" target="_blank">https://www . getambassador . io</a>或<a class="ae mc" href="http://d6e.co/slack" rel="noopener ugc nofollow" target="_blank">加入我们的Slack频道</a>了解更多信息。</p></div></div>    
</body>
</html>