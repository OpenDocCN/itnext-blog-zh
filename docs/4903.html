<html>
<head>
<title>Review: Testing Terraform Infrastructure-as-code with Unit tests &amp; BDD e2e with checkov and compliance-testing</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">回顾:用单元测试测试Terraform基础设施，用checkov和符合性测试测试BDD e2e</h1>
<blockquote>原文：<a href="https://itnext.io/review-testing-terraform-infrastructure-as-code-with-unit-tests-bdd-e2e-with-checkov-and-9b05ca7655d2?source=collection_archive---------2-----------------------#2020-10-20">https://itnext.io/review-testing-terraform-infrastructure-as-code-with-unit-tests-bdd-e2e-with-checkov-and-9b05ca7655d2?source=collection_archive---------2-----------------------#2020-10-20</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="487b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">最近，我很幸运地接受了一项任务，为terraform代码库调查、开发和交付一个合适的开源测试框架，作为基础设施发布管道的一部分。</p><p id="a071" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">“质量保证一切”的意图并不新鲜。然而，在[任何此类]上线阶段之前，实施确实依赖于组织基础设施的成熟度和风险容忍度，并因其而异。</p><blockquote class="kl"><p id="a82c" class="km kn iq bd ko kp kq kr ks kt ku kk dk translated"><em class="kv">TL；无论你的团队规模有多大。实施一个良好的基于terraform的基础设施配置分析和端到端健全性测试，不需要很长时间，也不复杂。</em></p></blockquote><figure class="kx ky kz la lb lc gh gi paragraph-image"><div role="button" tabindex="0" class="ld le di lf bf lg"><div class="gh gi kw"><img src="../Images/f2e30718a04b9de88afd8c2e92c0c3b4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ISwjp757Dl-hcQr8sHdT2w.jpeg"/></div></div></figure><p id="54ec" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">重新审视“测试基础设施的代码”，展示所有新的、闪亮的测试框架，以及一个非常受欢迎的学习机会。</p><p id="6f8a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我必须承认，我在开始时确实有一定程度的偏见，认为这种“企业级保证”本身可能需要花费大量精力来设置和提供开销。</p><p id="aae5" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">Hashicorp Terraform提供了足够的开箱即用功能，来检查和验证你的代码库；</p><ul class=""><li id="06c8" class="lk ll iq jp b jq jr ju jv jy lm kc ln kg lo kk lp lq lr ls bi translated">皮棉— <code class="fe lt lu lv lw b">terraform fmt -check</code>和<code class="fe lt lu lv lw b">terraform validate</code></li><li id="d0b3" class="lk ll iq jp b jq lx ju ly jy lz kc ma kg mb kk lp lq lr ls bi translated">预览— <code class="fe lt lu lv lw b">terraform plan</code></li><li id="c82d" class="lk ll iq jp b jq lx ju ly jy lz kc ma kg mb kk lp lq lr ls bi translated">构建— <code class="fe lt lu lv lw b">TF_LOG=debug terraform apply</code>了解所有的细节。</li></ul><h1 id="ef65" class="mc md iq bd me mf mg mh mi mj mk ml mm mn mo mp mq mr ms mt mu mv mw mx my mz bi translated">Terraform的静态代码分析工具</h1><p id="2cca" class="pw-post-body-paragraph jn jo iq jp b jq na js jt ju nb jw jx jy nc ka kb kc nd ke kf kg ne ki kj kk ij bi translated">一个关于相关terraform测试工具的新的Google搜索显示了同样多的信息，并且可用工具的列表非常庞大。</p><p id="eadd" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">但是我们有一个特定的<strong class="jp ir">需求列表</strong>，</p><ul class=""><li id="890f" class="lk ll iq jp b jq jr ju jv jy lm kc ln kg lo kk lp lq lr ls bi translated">terraform资源配置需要进行<strong class="jp ir">单元测试</strong>，以及扩展给定公共云提供商的任何此类最佳实践*检查通用列表的选项。最后，易用性是我们追求的立即开始。</li></ul><p id="0b76" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><em class="nf"> *没有ec2实例对0.0.0.0/0等世界开放。</em></p><ul class=""><li id="b0c3" class="lk ll iq jp b jq jr ju jv jy lm kc ln kg lo kk lp lq lr ls bi translated">运行更多定制测试的能力——一种形式的<strong class="jp ir">合规“防护栏”，使我能够约束资源配置</strong>。该选项需要具有合理的可扩展性，以保护子网、安全角色、定制标记，甚至确保启用或不启用某些EKS集群功能标志。</li><li id="430f" class="lk ll iq jp b jq lx ju ly jy lz kc ma kg mb kk lp lq lr ls bi translated">一个<strong class="jp ir"> </strong>更多个人经验驱动的需求——需要确保测试框架试图尽可能减少工程开销，而不是增加它，包括技能筒仓。我很清楚，这样的测试套件——一旦创建，可能会成为以后维护和扩展的工程开销，甚至是债务。</li><li id="048a" class="lk ll iq jp b jq lx ju ly jy lz kc ma kg mb kk lp lq lr ls bi translated">就开源软件选项而言，社区支持是很重要的。至少，所选择的框架应该基于公共开发语言，比如Go或Python。如果需要框架深度开发和定制方法扩展，<em class="nf"/><em class="nf">也许更有可能找到一个拥有一种而不是两种开发语言经验的平台工程师</em>。所有和任何以前的经验，当前团队和更广泛的组织可能有，与类似的工具也是有帮助的。因此，<em class="nf">我已经准备好为这项工作寻找合适的测试工具&amp;框架。</em></li></ul><h2 id="8087" class="ng md iq bd me nh ni dn mi nj nk dp mm jy nl nm mq kc nn no mu kg np nq my nr bi translated">候选名单——让我们回顾和比较一下</h2><figure class="nt nu nv nw gt lc gh gi paragraph-image"><div class="gh gi ns"><img src="../Images/9eb1625b251e3692c6fb63f0c318dd02.png" data-original-src="https://miro.medium.com/v2/resize:fit:1200/format:webp/1*aZWP6eVufFbUjN3_PH45FQ.jpeg"/></div></figure><p id="07be" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">希望下面的列表对你的IaC静态分析和QA之旅有所帮助。请注意，这是所有已发现的terraform测试相关工具的完整列表，它是配置健全性<strong class="jp ir">测试</strong>本身、<strong class="jp ir"> lint </strong>工具和面向secOps的最佳实践以及<strong class="jp ir">单元</strong> - <strong class="jp ir">测试</strong>的混合体。这份清单供你参考。</p><ul class=""><li id="0960" class="lk ll iq jp b jq jr ju jv jy lm kc ln kg lo kk lp lq lr ls bi translated"><strong class="jp ir">TF lint</strong>——【https://github.com/terraform-linters/ T21】</li><li id="21b4" class="lk ll iq jp b jq lx ju ly jy lz kc ma kg mb kk lp lq lr ls bi translated"><strong class="jp ir">陆地公司</strong>——<a class="ae lj" href="https://github.com/wayfair/terrafirma" rel="noopener ugc nofollow" target="_blank">https://github.com/wayfair/terrafirma</a></li><li id="b4fe" class="lk ll iq jp b jq lx ju ly jy lz kc ma kg mb kk lp lq lr ls bi translated"><strong class="jp ir">TF sec</strong>——<a class="ae lj" href="https://github.com/liamg/tfsec" rel="noopener ugc nofollow" target="_blank">https://github.com/liamg/tfsec</a></li><li id="10be" class="lk ll iq jp b jq lx ju ly jy lz kc ma kg mb kk lp lq lr ls bi translated"><strong class="jp ir">terras can</strong>—<a class="ae lj" href="https://github.com/cesar-rodriguez/terrascan" rel="noopener ugc nofollow" target="_blank">https://github.com/cesar-rodriguez/terrascan</a>(目前没有TF 0.13支持)</li><li id="ae40" class="lk ll iq jp b jq lx ju ly jy lz kc ma kg mb kk lp lq lr ls bi translated">查科夫——<a class="ae lj" href="https://github.com/bridgecrewio/checkov/" rel="noopener ugc nofollow" target="_blank">https://github.com/bridgecrewio/checkov/</a></li><li id="9478" class="lk ll iq jp b jq lx ju ly jy lz kc ma kg mb kk lp lq lr ls bi translated">https://github.com/instrumenta/conftest</li></ul><h1 id="0f8c" class="mc md iq bd me mf mg mh mi mj mk ml mm mn mo mp mq mr ms mt mu mv mw mx my mz bi translated">选择的工具</h1><p id="9094" class="pw-post-body-paragraph jn jo iq jp b jq na js jt ju nb jw jx jy nc ka kb kc nd ke kf kg ne ki kj kk ij bi translated">现在概括一下，我热衷于为terraform资源组件确定<strong class="jp ir">标准化</strong> <strong class="jp ir">单元</strong> <strong class="jp ir">测试</strong>，以及一个更可定制的测试套件，该套件基于<code class="fe lt lu lv lw b">terraform plan</code>结果对资源配置进行验证。</p><p id="6fbc" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在回顾了每种框架的优缺点后，我选择了<code class="fe lt lu lv lw b">checkov</code>并恰当地命名为<code class="fe lt lu lv lw b">terraform-compliance</code>，它们都是基于python的框架。这似乎满足了我前面提到的所有要求。</p><p id="d024" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">IaC发布管道，</strong>简而言之，看起来像这样。</p><figure class="nt nu nv nw gt lc gh gi paragraph-image"><div role="button" tabindex="0" class="ld le di lf bf lg"><div class="gh gi nx"><img src="../Images/81ac742f596caadbef47c5f870d55173.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*2Ho3YcJSZbMPR08L.png"/></div></div></figure><p id="bde0" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">随着对框架的深入研究，我不可避免地自我检查了我自己的经验和目前为止在这个问题上的发现，例如；</p><ul class=""><li id="3cb9" class="lk ll iq jp b jq jr ju jv jy lm kc ln kg lo kk lp lq lr ls bi translated">理智测试不需要花费全世界</li><li id="234d" class="lk ll iq jp b jq lx ju ly jy lz kc ma kg mb kk lp lq lr ls bi translated">就单元测试而言，一些测试框架的成熟提供了大量现成的<strong class="jp ir">最佳实践</strong>。</li><li id="2be4" class="lk ll iq jp b jq lx ju ly jy lz kc ma kg mb kk lp lq lr ls bi translated">大多数的入门都是非常直接的，因此对于任何规模的组织来说，接受和集成这样的测试框架都是必须的，其中IaC补充了组织自己的敏捷，由"<strong class="jp ir"> fail fast </strong>"和"<strong class="jp ir">go fast</strong>"业务需求支持。</li></ul><h1 id="5f54" class="mc md iq bd me mf mg mh mi mj mk ml mm mn mo mp mq mr ms mt mu mv mw mx my mz bi translated">单元测试——由BridgeCrew检查</h1><p id="7410" class="pw-post-body-paragraph jn jo iq jp b jq na js jt ju nb jw jx jy nc ka kb kc nd ke kf kg ne ki kj kk ij bi translated"><a class="ae lj" href="https://www.checkov.io/" rel="noopener ugc nofollow" target="_blank"><em class="nf">https://www.checkov.io/</em></a></p><blockquote class="kl"><p id="24d0" class="km kn iq bd ko kp kq kr ks kt ku kk dk translated">Checkov是一个静态代码分析工具，用于基础设施即代码。T19】</p><p id="8952" class="km kn iq bd ko kp kq kr ks kt ku kk dk translated"><em class="kv">它扫描使用</em><strong class="ak"><em class="kv">terra form</em></strong><em class="kv">、Cloudformation、</em><strong class="ak"><em class="kv">Kubernetes</em></strong><em class="kv">、无服务器或ARM模板调配的云基础架构，并检测安全性和合规性错误配置。</em></p></blockquote><p id="8227" class="pw-post-body-paragraph jn jo iq jp b jq ny js jt ju nz jw jx jy oa ka kb kc ob ke kf kg oc ki kj kk ij bi translated">当扫描您的terraform代码库时，有许多默认的最佳实践单元测试会突出与最佳实践的偏差—例如，让VM a端口22向外界开放(0.0.0.0/0 ),这从安全配置中可以明显看出。</p><p id="8be7" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">所有的测试都可以在便捷的<a class="ae lj" href="https://github.com/bridgecrewio/checkov/tree/master/tests/terraform/checks/resource/aws" rel="noopener ugc nofollow" target="_blank"> GitHub链接</a>上找到。</p><p id="dcc8" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">开始真的很简单。</p><ul class=""><li id="3752" class="lk ll iq jp b jq jr ju jv jy lm kc ln kg lo kk lp lq lr ls bi translated">安装二进制文件</li><li id="be6b" class="lk ll iq jp b jq lx ju ly jy lz kc ma kg mb kk lp lq lr ls bi translated">初始化地形目录<code class="fe lt lu lv lw b">terraform init</code></li><li id="d025" class="lk ll iq jp b jq lx ju ly jy lz kc ma kg mb kk lp lq lr ls bi translated">在那个目录上运行<strong class="jp ir"> chechov </strong></li></ul><p id="1a62" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">所有可用的默认单元测试都可以用方便的CLI命令行程序列出。或者，当<strong class="jp ir"> checkov </strong>运行时，它会默认输出所有通过和失败的单元测试。非常方便，易于上手。验证了<code class="fe lt lu lv lw b">terraform</code>的最佳实践，但不是所有的。这是根本的区别。</p><p id="e9ff" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">Chechov 会很乐意只评估你的地形代码。它可以在<code class="fe lt lu lv lw b">terraform init.</code>之后立即运行，它不关心你的<code class="fe lt lu lv lw b">terraform plan</code>——这里潜在的利弊，它做它在tin上所说的——“静态代码分析”。请注意其中的含义，以及对您的资源的任何逻辑考虑。</p><figure class="nt nu nv nw gt lc gh gi paragraph-image"><div role="button" tabindex="0" class="ld le di lf bf lg"><div class="gh gi od"><img src="../Images/2f347418380c7f5b8ced376a4327f277.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*OE_8VK0hIjUEuQR_.png"/></div></div></figure><p id="77c2" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir"> checkov -l </strong> #查看所有已发货支票的最有用班轮</p><figure class="nt nu nv nw gt lc gh gi paragraph-image"><div role="button" tabindex="0" class="ld le di lf bf lg"><div class="gh gi oe"><img src="../Images/119dd601cfa5bef2ff109ef0eb0fc920.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*EpYJ-DjmecjH3jHu.png"/></div></div></figure><p id="0999" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">checkov运行时的输出突出显示了它通过或未通过的检查(如果适用)。</p><p id="327a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">请注意，只要您习惯于深入Python开发，就可以编写额外的单元测试。框架的开发语言是需求之一，因为我有时不得不探索测试代码库，以评估这种额外的方法会花费多少精力。这一点以及对更广泛团队的维护考虑，与实现相同目的的替代框架相比，是决策过程中的驱动因素之一。</p><p id="f994" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">概括地说，就静态代码分析而言，<code class="fe lt lu lv lw b">checkov</code>是非常好的。考虑到我想从一开始就将子网的某些IP地址列入白名单的情况，这不是e2e测试的地方，但是，需要一个单独的测试框架。</p><p id="7502" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><em class="nf">虽然肯定，我可以复制单元测试并调优值，今天就到此为止，为我的子网/IP烘焙硬值。但是如果，我有几个实例和项目，我开始跳过相关的测试吗？也许吧。也许不是。</em></p><blockquote class="kl"><p id="eb82" class="km kn iq bd ko kp kq kr ks kt ku kk dk translated"><em class="kv">这就是第二个补充测试框架——terraform-compliance的用武之地。</em></p></blockquote><h1 id="9ae1" class="mc md iq bd me mf mg mh mi mj mk ml mm mn of mp mq mr og mt mu mv oh mx my mz bi translated">地形符合性</h1><p id="41ef" class="pw-post-body-paragraph jn jo iq jp b jq na js jt ju nb jw jx jy nc ka kb kc nd ke kf kg ne ki kj kk ij bi translated"><a class="ae lj" href="https://terraform-compliance.com/" rel="noopener ugc nofollow" target="_blank"><em class="nf">https://terraform-compliance.com/</em></a></p><blockquote class="kl"><p id="a540" class="km kn iq bd ko kp kq kr ks kt ku kk dk translated"><em class="kv"> Terraform-compliance是一个针对Terraform的轻量级、安全性和合规性测试框架，可对您的基础设施即代码进行负面测试。</em></p></blockquote><h1 id="be78" class="mc md iq bd me mf mg mh mi mj mk ml mm mn of mp mq mr og mt mu mv oh mx my mz bi translated">背景故事</h1><p id="9e37" class="pw-post-body-paragraph jn jo iq jp b jq na js jt ju nb jw jx jy nc ka kb kc nd ke kf kg ne ki kj kk ij bi translated">最近，作为测试框架的BDD再次成为焦点，强调了对通用测试框架的需求，但也有其他的需求。<strong class="jp ir">简约</strong>。</p><p id="6900" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">事实上，我觉得这种<strong class="jp ir">行为驱动的开发</strong>没有得到足够的重视。你可能听说过<strong class="jp ir">TDD——测试驱动开发</strong>——这可以追溯到很久以前，主要是在软件开发环境中。但是对于典型的基础设施工程师来说，这正是BDD框架之类的东西促进了一种附加逻辑的地方，以实现一种更简单、简洁和可重复的方式来开发端到端的可定制测试，而无需深入任何新的特定开发语言。</p><p id="5c52" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">虽然你可以出去整理太阳底下的任何东西，但这最终还是要归结到可管理性上。理解可能需要进一步记录的复杂性，不言而喻，支持和维护，由你的同事，向前迈进。<a class="ae lj" href="https://cucumber.io/blog/bdd/getting-started-with-bdd-part-1/" rel="noopener ugc nofollow" target="_blank">在这里阅读更多关于BDD的内容</a>。</p><p id="f202" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><a class="ae lj" href="http://cucumber.io/" rel="noopener ugc nofollow" target="_blank">cucumber . io</a>——更多的阿郎，促进这一测试之旅——完全旨在简化这一过程，实现<strong class="jp ir">所见即所得</strong>方法到<strong class="jp ir">测试</strong> <strong class="jp ir">创建</strong>，<strong class="jp ir">理解</strong>和<strong class="jp ir">维护</strong>。这些例子是在开发开始之前定义的，并被用作验收标准。</p><p id="0013" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">它们是<strong class="jp ir">对完成</strong>的定义的一部分。</p><h1 id="9af8" class="mc md iq bd me mf mg mh mi mj mk ml mm mn mo mp mq mr ms mt mu mv mw mx my mz bi translated">符合地形的测试</h1><p id="239d" class="pw-post-body-paragraph jn jo iq jp b jq na js jt ju nb jw jx jy nc ka kb kc nd ke kf kg ne ki kj kk ij bi translated">每个框架都根据其自身的优点进行了考虑，并对每个框架进行了深入分析，突出了它们最适合的地方，并对其中的注意事项和细微差别进行了补充—展望未来，我们可以两者都加以利用。</p><p id="a638" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这是用<code class="fe lt lu lv lw b">terraform-compliance</code>框架开发的测试用例的例子，利用了<strong class="jp ir"> B </strong>行为<strong class="jp ir"> D </strong> riven <strong class="jp ir"> D </strong>开发。这使得测试相当复杂的端到端测试用例成为可能。</p><p id="9364" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><code class="fe lt lu lv lw b">terraform-compliance</code>框架利用<code class="fe lt lu lv lw b">terraform plan</code> <strong class="jp ir">输出</strong>。因此，这使得能够为您的发布生成完整的“计划”,并相应地彻底测试这些计划。无论是使用正确的加密密钥对[为您的云提供商]帐户发言，环境或其他方面，都有很多创造性的自由，最重要的是，这是一个简单的<strong class="jp ir">行为</strong>来做所以。</p><p id="3f34" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">只需查看下面的步骤和示例。</p><ul class=""><li id="921e" class="lk ll iq jp b jq jr ju jv jy lm kc ln kg lo kk lp lq lr ls bi translated"><strong class="jp ir">第一步</strong>。初始化地形目录<br/> # <code class="fe lt lu lv lw b">terraform init</code></li><li id="d9b5" class="lk ll iq jp b jq lx ju ly jy lz kc ma kg mb kk lp lq lr ls bi translated"><strong class="jp ir">第二步</strong>。快捷选项，用<br/> # <code class="fe lt lu lv lw b">terraform plan -out=plan.out</code>生成一个<code class="fe lt lu lv lw b">terraform plan</code></li><li id="fdb6" class="lk ll iq jp b jq lx ju ly jy lz kc ma kg mb kk lp lq lr ls bi translated"><strong class="jp ir">第三步</strong>。写一些测试。好吧，公平地说，已经有一个范例文件夹了。下面让我们来看看我自己的测试例子，它们是基于我的<code class="fe lt lu lv lw b">terraform plan</code>输出编写的。</li></ul><p id="3a30" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这概述了terraform计划的片段——一个terraform配置，它创建了具有指定发射组的EKS。<br/>让我们确保我们的特定开发环境terraform IaC不使用任何<code class="fe lt lu lv lw b">instance_type</code> <strong class="jp ir">，而是使用</strong>“批准的”<code class="fe lt lu lv lw b"> a1.xlarge </code>或<code class="fe lt lu lv lw b">a1.2xlarge</code>。</p><p id="4760" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在我故意改成<code class="fe lt lu lv lw b">t2.small</code>来模拟一次失败。</p><figure class="nt nu nv nw gt lc gh gi paragraph-image"><div class="gh gi oi"><img src="../Images/4d5a07d568552d9c2574228a6a9f6885.png" data-original-src="https://miro.medium.com/v2/resize:fit:1384/format:webp/0*HTqnQUH9r8gnpeIf.png"/></div></figure><p id="fbdf" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">编写测试来确保我们能够成功地验证需求。</p><figure class="nt nu nv nw gt lc gh gi paragraph-image"><div role="button" tabindex="0" class="ld le di lf bf lg"><div class="gh gi oj"><img src="../Images/a17efe08f7e1130b4518880449744e4c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*mNbRh2Q2EdJ4UvoC.png"/></div></div></figure><ul class=""><li id="1dce" class="lk ll iq jp b jq jr ju jv jy lm kc ln kg lo kk lp lq lr ls bi translated"><strong class="jp ir">第四步</strong>。让<code class="fe lt lu lv lw b">terraform-compliance</code>利用您的测试用例<br/> # <code class="fe lt lu lv lw b">terraform-compliance -p plan.out -f ./&lt;test-cases-folder&gt;</code>来评估计划</li></ul><p id="76d8" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">运行测试</strong></p><p id="4bd4" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">通过和失败的示例结果</p><figure class="nt nu nv nw gt lc gh gi paragraph-image"><div role="button" tabindex="0" class="ld le di lf bf lg"><div class="gh gi ok"><img src="../Images/43553f48033aabbefeadce26d0cd054f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*BMLtVSCTov0Axj3X.png"/></div></div></figure><p id="5a8a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果我们的地形IaC具有正确的<code class="fe lt lu lv lw b">instance_type</code>,这将导致全绿<strong class="jp ir">成功</strong></p><figure class="nt nu nv nw gt lc gh gi paragraph-image"><div role="button" tabindex="0" class="ld le di lf bf lg"><div class="gh gi ol"><img src="../Images/74d7f8775dc627f0de8241df7972df73.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*Ju0328DfNp7hrMkg.png"/></div></div></figure><p id="4a9b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果我们的Terraform IaC功能违反了合规性要求，则不正确的<code class="fe lt lu lv lw b">instance_type</code>会导致全红失败</p><p id="e3d0" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">让我们编写更多的测试</strong></p><figure class="nt nu nv nw gt lc gh gi paragraph-image"><div role="button" tabindex="0" class="ld le di lf bf lg"><div class="gh gi om"><img src="../Images/f94c3719028b7a5327f673e2ee0852da.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*jjzcqq2veqwu4A3r.png"/></div></div></figure><p id="370a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">另一个简单的测试，从示例目录中借来开始</p><figure class="nt nu nv nw gt lc gh gi paragraph-image"><div role="button" tabindex="0" class="ld le di lf bf lg"><div class="gh gi on"><img src="../Images/f62a7e596c00a0ac28ff1aa0a0b7aacb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*Mt1QgC0SyGDRLen7.png"/></div></div></figure><p id="e009" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">对于另一个<strong class="jp ir">失败</strong>场景，这是为了强调在<strong class="jp ir">失败</strong>时，用户获取提取并显示的<strong class="jp ir"> Actual_Value </strong>以供参考和<strong class="jp ir"> </strong>调试。</p><figure class="nt nu nv nw gt lc gh gi paragraph-image"><div class="gh gi oo"><img src="../Images/229b9c11013db1a727e52fc83088264b.png" data-original-src="https://miro.medium.com/v2/resize:fit:490/format:webp/1*mwQaw-k20HMhwZ4X7zC1FQ.jpeg"/></div></figure><p id="7922" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">可以想象，这种失败在任何环境下都可能是灾难性的，尤其是在涉及多租户和多集群的情况下，这种相对简单的测试框架有一天真的可以拯救一些人。</p><p id="f31c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">测试运行统计数据</strong></p><p id="7788" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">一旦所有的测试连续运行，对于所有的测试通过和失败，以及它们是否被跳过，都有一个方便的“总总结”。我喜欢这一点，因为这使我能够写一长串彻底的测试，并在最后找到什么失败以及何时失败的清晰输出。另外，有些测试可以用<code class="fe lt lu lv lw b">@warning</code>标签跳过，如下例所示。</p><figure class="nt nu nv nw gt lc gh gi paragraph-image"><div role="button" tabindex="0" class="ld le di lf bf lg"><div class="gh gi op"><img src="../Images/62e172759bdc486498cfeee976258d09.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*xWUQPo9Acb8kJ3eV.png"/></div></div></figure><h1 id="37c5" class="mc md iq bd me mf mg mh mi mj mk ml mm mn mo mp mq mr ms mt mu mv mw mx my mz bi translated">结束语</h1><p id="9418" class="pw-post-body-paragraph jn jo iq jp b jq na js jt ju nb jw jx jy nc ka kb kc nd ke kf kg ne ki kj kk ij bi translated">这无疑是对Terraform基础设施即代码构建可用的一些高质量验证和测试框架的一次重大更新。</p><figure class="nt nu nv nw gt lc gh gi paragraph-image"><div class="gh gi oq"><img src="../Images/d83b178fbea3fb546d884c89451d476f.png" data-original-src="https://miro.medium.com/v2/resize:fit:298/format:webp/0*suk9fcdR71agRs6H.png"/></div></figure><p id="279f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我喜欢探索这两者，并且对checkov集成的简单性，以及令人惊叹的e2e验证和带有T6的定制测试选项印象深刻</p><p id="6f0e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">后者让我想起了另一个伟大的<code class="fe lt lu lv lw b">kubernetes</code> BDD e2e测试框架<code class="fe lt lu lv lw b">behave</code>，我过去曾与之共事过。</p><p id="b47a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">一个全python的测试框架简化了一个跨框架的通用python知识共享，并减少了未来进一步维护和测试用例开发中的精神疲劳。</p><p id="21b7" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">您是否需要最佳实践配置检查—不需要terraform计划— <code class="fe lt lu lv lw b">checkov</code>可能是您所追求的，否则对于功能更丰富的terraform计划验证目的— <code class="fe lt lu lv lw b">terraform-compliance</code>可能是答案。作为一个BDD框架，<code class="fe lt lu lv lw b">terraform-compliance</code>非常容易上手。</p><figure class="nt nu nv nw gt lc gh gi paragraph-image"><div class="gh gi or"><img src="../Images/60c5b56bfdcf0eb446c0f9b28a6a3bbd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1090/format:webp/1*jm6iwdDHLNSImytrjvKLLw.jpeg"/></div></figure><blockquote class="kl"><p id="7f52" class="km kn iq bd ko kp os ot ou ov ow kk dk translated"><em class="kv">首先从基础——单元测试开始。最简单。由bridgecrewio </em>  <em class="kv">检验</em> <strong class="ak"> <em class="kv"> Checkov与开箱即用的“最佳实践”验证。</em></strong></p></blockquote><p id="1983" class="pw-post-body-paragraph jn jo iq jp b jq ny js jt ju nz jw jx jy oa ka kb kc ob ke kf kg oc ki kj kk ij bi translated">现在，无论你的团队规模有多大，都没有好的理由跳过任何质量保证练习。特别是，考虑到所需的实现工作量很小，正如帖子中所举例说明的:)<br/>祝你好运，尽管你真的不需要它。</p><p id="a03c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">最后，如果你觉得这篇文章有帮助，请鼓掌并分享它</strong></p><p id="4414" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir"> PS </strong>在<strong class="jp ir"> Contino </strong>有很多奇妙的项目正在进行。如果您正在寻找最新最棒的基础设施堆栈，或者正在寻找挑战，——<a class="ae lj" href="https://www.linkedin.com/in/johas/" rel="noopener ugc nofollow" target="_blank">联系我们！我们正在招聘</a>，寻找各个层次的聪明人。在<strong class="jp ir"> Contino </strong>，我们为能够为中型企业和大型企业提供最佳实践云转型项目而自豪。</p></div></div>    
</body>
</html>