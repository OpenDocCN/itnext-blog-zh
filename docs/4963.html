<html>
<head>
<title>How to Create a Go (Golang) API on Google App Engine</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何在Google App Engine上创建Go (Golang) API</h1>
<blockquote>原文：<a href="https://itnext.io/how-to-create-a-go-golang-api-on-google-app-engine-157e7cd33a93?source=collection_archive---------3-----------------------#2020-11-03">https://itnext.io/how-to-create-a-go-golang-api-on-google-app-engine-157e7cd33a93?source=collection_archive---------3-----------------------#2020-11-03</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><h2 id="ba76" class="ir is it bd b dl iu iv iw ix iy iz dk ja translated" aria-label="kicker paragraph">戈朗</h2><div class=""/><div class=""><h2 id="3ecb" class="pw-subtitle-paragraph jz jc it bd b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq dk translated">一个简单的演练，关于创建一个服务器API，用Go编写，部署到Google App Engine。</h2></div><figure class="ks kt ku kv gt kw gh gi paragraph-image"><div role="button" tabindex="0" class="kx ky di kz bf la"><div class="gh gi kr"><img src="../Images/48d0a3b4697ca58bc35a393b8e8fe2f3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*_M_usADKAMZST6uHcHYQ4w.jpeg"/></div></div></figure><h2 id="162b" class="ld le it bd lf lg lh dn li lj lk dp ll lm ln lo lp lq lr ls lt lu lv lw lx iz bi translated">为什么选择谷歌应用引擎？</h2><p id="1a79" class="pw-post-body-paragraph ly lz it ma b mb mc kd md me mf kg mg lm mh mi mj lq mk ml mm lu mn mo mp mq im bi translated">谷歌应用引擎是平台即服务(PaaS)。它旨在简化部署。它是完全受管的、随用随付的、高可用性的，确保快速上市，并支持多种编程语言。</p><p id="a32d" class="pw-post-body-paragraph ly lz it ma b mb mr kd md me ms kg mg lm mt mi mj lq mu ml mm lu mv mo mp mq im bi translated">App Engine允许您构建具有流量分流和防火墙功能的可扩展web和移动后端。</p><h2 id="e2ef" class="ld le it bd lf lg lh dn li lj lk dp ll lm ln lo lp lq lr ls lt lu lv lw lx iz bi translated">标准环境与灵活环境</h2><p id="c277" class="pw-post-body-paragraph ly lz it ma b mb mc kd md me mf kg mg lm mh mi mj lq mk ml mm lu mn mo mp mq im bi translated">创建应用引擎环境时，您有两种选择:</p><ul class=""><li id="85eb" class="mw mx it ma b mb mr me ms lm my lq mz lu na mq nb nc nd ne bi translated"><strong class="ma jd">标准</strong> —应用程序在沙箱中运行。如果您需要快速扩展，或者遇到突发的流量高峰，请选择此选项</li><li id="a312" class="mw mx it ma b mb nf me ng lm nh lq ni lu nj mq nb nc nd ne bi translated"><strong class="ma jd">灵活— </strong>实例<strong class="ma jd"> </strong>在计算引擎虚拟机上的Docker容器中运行。如果您有稳定的流量，需要扩大或缩小规模，或者需要访问计算引擎上的资源，请选择此项。</li></ul><div class="nk nl gp gr nm nn"><a href="https://cloud.google.com/appengine/docs/the-appengine-environments" rel="noopener  ugc nofollow" target="_blank"><div class="no ab fo"><div class="np ab nq cl cj nr"><h2 class="bd jd gy z fp ns fr fs nt fu fw jc bi translated">选择应用引擎环境|应用引擎文档</h2><div class="nu l"><p class="bd b dl z fp ns fr fs nt fu fw dk translated">cloud.google.com</p></div></div><div class="nv l"><div class="nw l nx ny nz nv oa lb nn"/></div></div></a></div><blockquote class="ob oc od"><p id="35ad" class="ly lz oe ma b mb mr kd md me ms kg mg of mt mi mj og mu ml mm oh mv mo mp mq im bi translated">需要注意的是，App Engine应用程序URL将根据项目名称命名。因此，在选择您的云项目时，请考虑这一点。</p></blockquote><p id="dfac" class="pw-post-body-paragraph ly lz it ma b mb mr kd md me ms kg mg lm mt mi mj lq mu ml mm lu mv mo mp mq im bi translated"><strong class="ma jd">我们开始吧！</strong></p><h1 id="61c7" class="oi le it bd lf oj ok ol li om on oo ll ki op kj lp kl oq km lt ko or kp lx os bi translated">1)在云控制台中设置应用引擎</h1><p id="d2fc" class="pw-post-body-paragraph ly lz it ma b mb mc kd md me mf kg mg lm mh mi mj lq mk ml mm lu mn mo mp mq im bi translated">首先，让我们建立应用引擎项目。</p><p id="2f78" class="pw-post-body-paragraph ly lz it ma b mb mr kd md me ms kg mg lm mt mi mj lq mu ml mm lu mv mo mp mq im bi translated">转到<a class="ae ot" href="https://console.cloud.google.com/appengine" rel="noopener ugc nofollow" target="_blank">https://console.cloud.google.com/appengine</a>。</p><p id="1365" class="pw-post-body-paragraph ly lz it ma b mb mr kd md me ms kg mg lm mt mi mj lq mu ml mm lu mv mo mp mq im bi translated">在一些自动初始化之后，你应该会看到这个屏幕…</p><figure class="ks kt ku kv gt kw gh gi paragraph-image"><div role="button" tabindex="0" class="kx ky di kz bf la"><div class="gh gi ou"><img src="../Images/5fdfae1e788d5f9691497a61791450b4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*I1qIKnvxFI3FMuWQ7XIGKA.png"/></div></div><figcaption class="ov ow gj gh gi ox oy bd b be z dk translated">App Engine欢迎屏幕</figcaption></figure><p id="77f6" class="pw-post-body-paragraph ly lz it ma b mb mr kd md me ms kg mg lm mt mi mj lq mu ml mm lu mv mo mp mq im bi translated">点击<strong class="ma jd">开始</strong></p><figure class="ks kt ku kv gt kw gh gi paragraph-image"><div role="button" tabindex="0" class="kx ky di kz bf la"><div class="gh gi oz"><img src="../Images/17a9e6edaf0775925bfe17a0be554acb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*favS1Fweq1l8SyMSo2Ih-w.png"/></div></div><figcaption class="ov ow gj gh gi ox oy bd b be z dk translated">应用引擎配置选项</figcaption></figure><p id="62f0" class="pw-post-body-paragraph ly lz it ma b mb mr kd md me ms kg mg lm mt mi mj lq mu ml mm lu mv mo mp mq im bi translated">从下拉菜单中选择'<strong class="ma jd">转到</strong>'。</p><p id="36b7" class="pw-post-body-paragraph ly lz it ma b mb mr kd md me ms kg mg lm mt mi mj lq mu ml mm lu mv mo mp mq im bi translated">在这个例子中，我们将使用<strong class="ma jd">标准</strong>环境。</p><p id="7d10" class="pw-post-body-paragraph ly lz it ma b mb mr kd md me ms kg mg lm mt mi mj lq mu ml mm lu mv mo mp mq im bi translated">接下来的步骤是下载SDK</p><div class="nk nl gp gr nm nn"><a href="https://cloud.google.com/sdk/" rel="noopener  ugc nofollow" target="_blank"><div class="no ab fo"><div class="np ab nq cl cj nr"><h2 class="bd jd gy z fp ns fr fs nt fu fw jc bi translated">云SDK命令行工具|云SDK:命令行界面</h2><div class="pa l"><h3 class="bd b gy z fp ns fr fs nt fu fw dk translated">用于与谷歌云产品和服务交互的工具和库。新客户可获得300美元的免费积分，用于…</h3></div><div class="nu l"><p class="bd b dl z fp ns fr fs nt fu fw dk translated">cloud.google.com</p></div></div><div class="nv l"><div class="pb l nx ny nz nv oa lb nn"/></div></div></a></div><p id="a9f0" class="pw-post-body-paragraph ly lz it ma b mb mr kd md me ms kg mg lm mt mi mj lq mu ml mm lu mv mo mp mq im bi translated">这使您可以访问命令行工具(CLI)。</p><h2 id="d12c" class="ld le it bd lf lg lh dn li lj lk dp ll lm ln lo lp lq lr ls lt lu lv lw lx iz bi translated">初始化项目</h2><p id="3b3f" class="pw-post-body-paragraph ly lz it ma b mb mc kd md me mf kg mg lm mh mi mj lq mk ml mm lu mn mo mp mq im bi translated">使用<code class="fe pc pd pe pf b">gcloud</code>命令，初始化项目。</p><pre class="ks kt ku kv gt pg pf ph pi aw pj bi"><span id="1c94" class="ld le it pf b gy pk pl l pm pn"><strong class="pf jd">$</strong> gcloud init</span></pre><p id="b81d" class="pw-post-body-paragraph ly lz it ma b mb mr kd md me ms kg mg lm mt mi mj lq mu ml mm lu mv mo mp mq im bi translated">在您将应用程序部署到应用程序引擎之前，您的仪表板将如下所示。</p><figure class="ks kt ku kv gt kw gh gi paragraph-image"><div role="button" tabindex="0" class="kx ky di kz bf la"><div class="gh gi po"><img src="../Images/a5e3c7f46261d93d40c514767644616e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Hfoa_xuoTEMvpV3UgDHJLA.png"/></div></div><figcaption class="ov ow gj gh gi ox oy bd b be z dk translated">部署到应用程序引擎之前的临时屏幕</figcaption></figure><p id="d036" class="pw-post-body-paragraph ly lz it ma b mb mr kd md me ms kg mg lm mt mi mj lq mu ml mm lu mv mo mp mq im bi translated">现在应用引擎已经设置好了，是时候实际编写我们的服务器了。</p><h1 id="7bb6" class="oi le it bd lf oj ok ol li om on oo ll ki op kj lp kl oq km lt ko or kp lx os bi translated">2)在Go中编写一个简单的服务器应用程序</h1><p id="7182" class="pw-post-body-paragraph ly lz it ma b mb mc kd md me mf kg mg lm mh mi mj lq mk ml mm lu mn mo mp mq im bi translated">我们将使用Go版本1.14。我们还将使用Go模块。</p><p id="2abd" class="pw-post-body-paragraph ly lz it ma b mb mr kd md me ms kg mg lm mt mi mj lq mu ml mm lu mv mo mp mq im bi translated">有3个文件对我们的应用程序至关重要。这些概述如下。</p><h2 id="9ca1" class="ld le it bd lf lg lh dn li lj lk dp ll lm ln lo lp lq lr ls lt lu lv lw lx iz bi translated">运行时配置— app.yaml</h2><p id="fca4" class="pw-post-body-paragraph ly lz it ma b mb mc kd md me mf kg mg lm mh mi mj lq mk ml mm lu mn mo mp mq im bi translated">我们需要创建的第一个文件是app.yaml文件。此文件在应用程序引擎项目中是必需的。</p><figure class="ks kt ku kv gt kw"><div class="bz fp l di"><div class="pp pq l"/></div><figcaption class="ov ow gj gh gi ox oy bd b be z dk translated">应用引擎运行时的app.yaml文件</figcaption></figure><h2 id="4c84" class="ld le it bd lf lg lh dn li lj lk dp ll lm ln lo lp lq lr ls lt lu lv lw lx iz bi translated">Go模块— go.mod</h2><p id="1307" class="pw-post-body-paragraph ly lz it ma b mb mc kd md me mf kg mg lm mh mi mj lq mk ml mm lu mn mo mp mq im bi translated">我们还需要创建我们的Go模块。</p><figure class="ks kt ku kv gt kw"><div class="bz fp l di"><div class="pp pq l"/></div><figcaption class="ov ow gj gh gi ox oy bd b be z dk translated">Go模块文件</figcaption></figure><h2 id="7a91" class="ld le it bd lf lg lh dn li lj lk dp ll lm ln lo lp lq lr ls lt lu lv lw lx iz bi translated">主文件— main.go</h2><p id="0f4b" class="pw-post-body-paragraph ly lz it ma b mb mc kd md me mf kg mg lm mh mi mj lq mk ml mm lu mn mo mp mq im bi translated">首先，我们需要在主文件中创建一个获取端口号的函数。<strong class="ma jd">这只是一个函数，它根据当前环境获取我们的API正在监听的适当端口号</strong>。</p><p id="dfcf" class="pw-post-body-paragraph ly lz it ma b mb mr kd md me ms kg mg lm mt mi mj lq mu ml mm lu mv mo mp mq im bi translated">我们使用<code class="fe pc pd pe pf b">os</code>库来获取端口(如果是环境变量)，如果没有设置环境变量，默认为端口<code class="fe pc pd pe pf b">8080</code>，并将端口号作为<code class="fe pc pd pe pf b">string</code>返回给调用者。</p><figure class="ks kt ku kv gt kw"><div class="bz fp l di"><div class="pp pq l"/></div><figcaption class="ov ow gj gh gi ox oy bd b be z dk translated">获取并设置端口号</figcaption></figure><h2 id="4f68" class="ld le it bd lf lg lh dn li lj lk dp ll lm ln lo lp lq lr ls lt lu lv lw lx iz bi translated">初始化我们的HTTP服务器客户端</h2><p id="88fa" class="pw-post-body-paragraph ly lz it ma b mb mc kd md me mf kg mg lm mh mi mj lq mk ml mm lu mn mo mp mq im bi translated">让我们创建一个简单的HTTP服务器来监听请求。</p><p id="3c07" class="pw-post-body-paragraph ly lz it ma b mb mr kd md me ms kg mg lm mt mi mj lq mu ml mm lu mv mo mp mq im bi translated"><strong class="ma jd">首先</strong>我们将使用之前创建的<code class="fe pc pd pe pf b">getPort()</code>函数获取端口。</p><p id="de37" class="pw-post-body-paragraph ly lz it ma b mb mr kd md me ms kg mg lm mt mi mj lq mu ml mm lu mv mo mp mq im bi translated">然后，我们将编写匿名处理函数来处理请求和响应。</p><p id="091f" class="pw-post-body-paragraph ly lz it ma b mb mr kd md me ms kg mg lm mt mi mj lq mu ml mm lu mv mo mp mq im bi translated">我们的API还没有做任何事情，所以它是非常无用的。但是我们将很快开始处理一些参数，就像在实际的API中一样。</p><p id="5da4" class="pw-post-body-paragraph ly lz it ma b mb mr kd md me ms kg mg lm mt mi mj lq mu ml mm lu mv mo mp mq im bi translated">然后，我们将使用<code class="fe pc pd pe pf b">http.ListenAndServe</code>调用指示我们的HTTP客户端在指定端口上监听和服务我们的应用程序的函数，同时捕捉可能出现的任何错误。</p><figure class="ks kt ku kv gt kw"><div class="bz fp l di"><div class="pp pq l"/></div><figcaption class="ov ow gj gh gi ox oy bd b be z dk translated">带有服务器代码的基本main.go文件</figcaption></figure><p id="79f2" class="pw-post-body-paragraph ly lz it ma b mb mr kd md me ms kg mg lm mt mi mj lq mu ml mm lu mv mo mp mq im bi translated">正如您所看到的，回调函数接受两个参数<code class="fe pc pd pe pf b">http.ResponseWriter</code>来写入响应，以及一个指向请求对象的指针<code class="fe pc pd pe pf b">*http.Request</code>。</p><div class="nk nl gp gr nm nn"><a href="https://golang.org/pkg/net/http/" rel="noopener  ugc nofollow" target="_blank"><div class="no ab fo"><div class="np ab nq cl cj nr"><h2 class="bd jd gy z fp ns fr fs nt fu fw jc bi translated">http-Go编程语言</h2><div class="nu l"><p class="bd b dl z fp ns fr fs nt fu fw dk translated">golang.org</p></div></div><div class="nv l"><div class="pr l nx ny nz nv oa lb nn"/></div></div></a></div><h2 id="4ee4" class="ld le it bd lf lg lh dn li lj lk dp ll lm ln lo lp lq lr ls lt lu lv lw lx iz bi translated">处理查询参数</h2><p id="2282" class="pw-post-body-paragraph ly lz it ma b mb mc kd md me mf kg mg lm mh mi mj lq mk ml mm lu mn mo mp mq im bi translated">这个API目前有点太基础了。在现实世界中，您需要处理查询参数来支持我们的API。</p><p id="2135" class="pw-post-body-paragraph ly lz it ma b mb mr kd md me ms kg mg lm mt mi mj lq mu ml mm lu mv mo mp mq im bi translated">在Go中处理查询参数非常简单。你只需要记住，当用<code class="fe pc pd pe pf b">URL.Query()['value']</code>，<strong class="ma jd">访问一个查询参数时，它总是返回一个项目数组</strong>。因此，请确保通过数组索引来访问该值。</p><figure class="ks kt ku kv gt kw"><div class="bz fp l di"><div class="pp pq l"/></div><figcaption class="ov ow gj gh gi ox oy bd b be z dk translated">包含服务器代码的完整main.go文件，带有处理的查询参数</figcaption></figure><p id="2805" class="pw-post-body-paragraph ly lz it ma b mb mr kd md me ms kg mg lm mt mi mj lq mu ml mm lu mv mo mp mq im bi translated">我们将提供新的函数<code class="fe pc pd pe pf b"><strong class="ma jd">APIHandler</strong></code>来处理请求以及URL中提供的任何参数，而不是编写一个匿名函数作为对<code class="fe pc pd pe pf b">HandleFunc</code>函数的回调。</p><p id="dbb2" class="pw-post-body-paragraph ly lz it ma b mb mr kd md me ms kg mg lm mt mi mj lq mu ml mm lu mv mo mp mq im bi translated">我们的<code class="fe pc pd pe pf b">APIHandler</code>函数必须符合回调签名，所以我们有两个参数<code class="fe pc pd pe pf b">http.ResponseWriter</code>和<code class="fe pc pd pe pf b">*http.Request</code>。</p><p id="8cb9" class="pw-post-body-paragraph ly lz it ma b mb mr kd md me ms kg mg lm mt mi mj lq mu ml mm lu mv mo mp mq im bi translated">在这个示例函数中，我们不接受<code class="fe pc pd pe pf b">POST</code>请求，如果是这种情况，我们会提前返回一个HTTP错误。</p><p id="e3fe" class="pw-post-body-paragraph ly lz it ma b mb mr kd md me ms kg mg lm mt mi mj lq mu ml mm lu mv mo mp mq im bi translated">然后我们获取查询参数<code class="fe pc pd pe pf b">value</code>，如果有的话。如果它是无效的或空的，我们返回，不做任何事情。</p><p id="6b81" class="pw-post-body-paragraph ly lz it ma b mb mr kd md me ms kg mg lm mt mi mj lq mu ml mm lu mv mo mp mq im bi translated">如果它存在并且有效，我们将在响应中返回该值(出于演示目的)。</p><p id="9ac6" class="pw-post-body-paragraph ly lz it ma b mb mr kd md me ms kg mg lm mt mi mj lq mu ml mm lu mv mo mp mq im bi translated"><strong class="ma jd">这是我们编写的基本API…</strong></p><h1 id="ae9c" class="oi le it bd lf oj ok ol li om on oo ll ki op kj lp kl oq km lt ko or kp lx os bi translated">3)部署到应用引擎</h1><p id="f42d" class="pw-post-body-paragraph ly lz it ma b mb mc kd md me mf kg mg lm mh mi mj lq mk ml mm lu mn mo mp mq im bi translated">在前面的步骤中运行<code class="fe pc pd pe pf b">gcloud init</code>命令应该可以让您登录到google cloud帐户。但如果没有，运行<code class="fe pc pd pe pf b">gcloud auth login</code>登录。</p><p id="2733" class="pw-post-body-paragraph ly lz it ma b mb mr kd md me ms kg mg lm mt mi mj lq mu ml mm lu mv mo mp mq im bi translated">在这一步之后，您需要使用</p><pre class="ks kt ku kv gt pg pf ph pi aw pj bi"><span id="0180" class="ld le it pf b gy pk pl l pm pn"><strong class="pf jd">$</strong> gcloud app deploy</span></pre><figure class="ks kt ku kv gt kw gh gi paragraph-image"><div role="button" tabindex="0" class="kx ky di kz bf la"><div class="gh gi ps"><img src="../Images/ec8b4cd26e1a3f7beb559c762c9bd9ad.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*3g9iJrGdEfC0wzLZYUgWtw.png"/></div></div><figcaption class="ov ow gj gh gi ox oy bd b be z dk translated">通过CLI部署到应用引擎</figcaption></figure><blockquote class="ob oc od"><p id="fe96" class="ly lz oe ma b mb mr kd md me ms kg mg of mt mi mj og mu ml mm oh mv mo mp mq im bi translated">这意味着您的API已成功部署到所提供的URL。</p></blockquote><h1 id="e056" class="oi le it bd lf oj ok ol li om on oo ll ki op kj lp kl oq km lt ko or kp lx os bi translated">4)测试应用程序</h1><p id="6034" class="pw-post-body-paragraph ly lz it ma b mb mc kd md me mf kg mg lm mh mi mj lq mk ml mm lu mn mo mp mq im bi translated">在谷歌云控制台中找到您保留的应用引擎URL。</p><p id="309f" class="pw-post-body-paragraph ly lz it ma b mb mr kd md me ms kg mg lm mt mi mj lq mu ml mm lu mv mo mp mq im bi translated">要测试它是否全部启动并运行，您需要做的就是单击链接查看您的工作应用程序引擎应用程序。</p><p id="1cfb" class="pw-post-body-paragraph ly lz it ma b mb mr kd md me ms kg mg lm mt mi mj lq mu ml mm lu mv mo mp mq im bi translated">您可以通过测试URL(在浏览器中键入)来查看您的应用程序是否成功解析了查询参数。</p><pre class="ks kt ku kv gt pg pf ph pi aw pj bi"><span id="1eb7" class="ld le it pf b gy pk pl l pm pn"><a class="ae ot" href="https://dev-country-173521.uc.r.appspot.com/?value=hello" rel="noopener ugc nofollow" target="_blank">https://&lt;INSERT_PROJECT_ID&gt;.uc.r.appspot.com/?value=hello</a></span></pre><figure class="ks kt ku kv gt kw gh gi paragraph-image"><div role="button" tabindex="0" class="kx ky di kz bf la"><div class="gh gi pt"><img src="../Images/4bf0c273f347e77c4c4e6471d2671790.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*YM4QdPK8McXn3xfZHWByOw.png"/></div></div><figcaption class="ov ow gj gh gi ox oy bd b be z dk translated">使用查询参数测试API</figcaption></figure><h2 id="6989" class="ld le it bd lf lg lh dn li lj lk dp ll lm ln lo lp lq lr ls lt lu lv lw lx iz bi translated">就是这样！🚀</h2><p id="4743" class="pw-post-body-paragraph ly lz it ma b mb mc kd md me mf kg mg lm mh mi mj lq mk ml mm lu mn mo mp mq im bi translated">现在你有了一个部署在App Engine上的基本API，用Go编写，你可以扩展它，让它做一些有用的事情。</p><blockquote class="ob oc od"><p id="3640" class="ly lz oe ma b mb mr kd md me ms kg mg of mt mi mj og mu ml mm oh mv mo mp mq im bi translated">感谢阅读！有任何问题请在评论中告诉我。</p></blockquote></div></div>    
</body>
</html>