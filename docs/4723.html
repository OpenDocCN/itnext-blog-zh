<html>
<head>
<title>Helping Reach a Zero Trust Network Using an Istio Service Mesh</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Istio服务网格帮助实现零信任网络</h1>
<blockquote>原文：<a href="https://itnext.io/helping-reach-a-zero-trust-network-using-an-istio-service-mesh-ca4865d46e61?source=collection_archive---------3-----------------------#2020-09-01">https://itnext.io/helping-reach-a-zero-trust-network-using-an-istio-service-mesh-ca4865d46e61?source=collection_archive---------3-----------------------#2020-09-01</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><figure class="gl gn jr js jt ju gh gi paragraph-image"><div class="gh gi jq"><img src="../Images/4292f436e5a8919a6648c783d93d1b40.png" data-original-src="https://miro.medium.com/v2/resize:fit:1000/format:webp/1*6d5p4gc6FsftSZRWiz0zYg.jpeg"/></div></figure><p id="94e2" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">最近，我把大一的女儿送到了她的大学宿舍，准备秋季学期开学——在新冠肺炎时代，宿舍是开放的，但课程都是在线的。像许多宿舍一样，大厅的入口和单独的宿舍一样都有锁。你能进宿舍，不代表你能进每个房间。这个设置让我想到了在Kubernetes上运行的微服务的零信任和服务网格。</p><p id="e650" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">微服务提供了许多好处，包括独立扩展、业务逻辑隔离、独立的生命周期管理和更容易的分布式开发。然而，这些好处是有代价的，因为微服务会增加您的安全漏洞，所以会有更多的攻击面——每个微服务都是一个目标。如果入侵者进入了您的网络，他们可能会肆无忌惮地攻击单个微服务。因此，仅仅保护网络边界是不够的，还必须保护网络内部。这就是零信任的由来。</p><p id="6804" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">零信任是由约翰·金德瓦格(John Kindervag)提出的概念，即无论你的网络边界内外，没有任何东西是绝对可信的。它要求显式验证，并使用最小特权原则来限制对资源的访问。在本文中，我展示了将Istio服务网格配置为零信任网络的步骤。具体来说，我给出了一个简单的示例微服务架构，然后通过移除隐式的服务到服务信任，用Istio锁定它。</p><p id="cbc3" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">试图用自主开发的解决方案来保护微服务网络既困难又令人困惑。在这种情况下，服务网格(如Istio)会有所帮助。它保障了南北交通和东西交通。南北流量是进入(入口)和离开(出口)服务网格的流量。东西向流量是网格内的流量，通常是服务到服务的流量。Istio通过入口和出口网关处理南北流量，流量路由由虚拟服务管理。Istio的特使代理管理东西向的流量，在它所保护的服务的Kubernetes pod中作为边车运行。现在让我们看一个应用于小型服务网格的例子。</p><h1 id="3714" class="kw kx it bd ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt bi translated">在服务网格之外公开服务</h1><p id="5634" class="pw-post-body-paragraph jx jy it jz b ka lu kc kd ke lv kg kh ki lw kk kl km lx ko kp kq ly ks kt ku im bi translated">在这个例子中，我们将从两个微服务开始——一个运行在NGINX web服务器上的web客户端和一个Java/Spring Boot后端REST服务。我在早先一篇关于<a class="ae kv" href="https://medium.com/@pklinker/performance-impacts-of-an-istio-service-mesh-63957a0000b" rel="noopener"> Istio Performance </a>的文章中详细描述了这些服务。</p><p id="ceaf" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">该客户端是一个“友好”的客户端，我们将允许它访问后端服务。稍后，我们将向网格中添加第三个微服务——一个恶意的“敌人”web客户端，它将被拒绝访问后端微服务。称为“capitol-info”的后端微服务具有查询和插入国家首都数据库的能力。这些微服务公开的端点如下图所示。此图显示了一个开放的、无保护的服务网状架构。</p><figure class="ma mb mc md gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="me mf di mg bf mh"><div class="gh gi lz"><img src="../Images/07a6a2cbd761bb2a3844738aad4b2af8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*hZ3b4WZB7-NFly1YUB00kQ.png"/></div></div><figcaption class="mi mj gj gh gi mk ml bd b be z dk translated">在Istio服务网格中运行的Capitol-client微服务和capitol-info微服务</figcaption></figure><p id="6f76" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">因为我们试图保护服务网格的微服务，所以我们不想将来自客户端网站的调用重定向到后端微服务。相反，我们希望创建一个API网关，并允许网关代表我们调用服务，从而实现服务到服务的调用。NGINX在web客户端的<em class="mm"> /capitolservice </em>路径下提供了一个API网关。当通过这个路径调用web客户端时，NGINX网关代理对capitol-info服务的调用。</p><p id="11ac" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">对于Istio配置，我们首先为客户端和数据提供微服务入口网关和虚拟服务。入口网关是标准的端口80 (web)网关，因此我们将关注Istio虚拟服务来处理流量路由。我们从capitol-info服务开始，如下面的虚拟服务定义所示:</p><figure class="ma mb mc md gt ju"><div class="bz fp l di"><div class="mn mo l"/></div><figcaption class="mi mj gj gh gi mk ml bd b be z dk translated">Capitol Service虚拟服务定义</figcaption></figure><p id="d37f" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">capitol-info服务虚拟服务表明，我们只向入站流量开放了<em class="mm"> getCapitol </em> REST操作，而不是由<em class="mm"> addCapitol </em> REST操作定义的插入功能。因此<em class="mm"> addCapitol </em> REST操作受到保护，不会受到外部(南北)调用的影响，但不会受到服务网格内其他微服务的调用(东西调用)的影响。getCapitol 呼叫目前对南北和东西呼叫完全开放。</p><figure class="ma mb mc md gt ju"><div class="bz fp l di"><div class="mn mo l"/></div><figcaption class="mi mj gj gh gi mk ml bd b be z dk translated">capitol-客户端虚拟服务定义</figcaption></figure><p id="9abb" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">capitol-client虚拟服务显示，我们正在打开位于<em class="mm"> /capitolservice </em>下的API网关，以及位于<em class="mm"> /info </em>路径<em class="mm">下的HTML页面。</em></p><h1 id="be0a" class="kw kx it bd ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt bi translated">锁定微服务</h1><p id="5b61" class="pw-post-body-paragraph jx jy it jz b ka lu kc kd ke lv kg kh ki lw kk kl km lx ko kp kq ly ks kt ku im bi translated">现在我们已经介绍了基本的架构，我们使用授权策略来锁定它。这是迈向零信任网络的重要一步——我们不再隐式信任网格中的其他服务。</p><p id="4121" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">为了锁定微服务，我们首先使用<a class="ae kv" href="https://istio.io/pt-br/docs/concepts/security/#allow-all-and-deny-all" rel="noopener ugc nofollow" target="_blank"> deny-all </a>策略，并将其应用于我们的名称空间(<strong class="jz iu">默认</strong>)，阻止所有访问。我们现在创建一个Istio <em class="mm">授权策略</em>来开始开放我们的端点。在第一个示例中，我们应用了一个策略，允许任何调用者访问我们之前创建的资源:</p><figure class="ma mb mc md gt ju"><div class="bz fp l di"><div class="mn mo l"/></div></figure><p id="fa8c" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">您可以看到，我们允许基于HTTP操作(GET、POST)和URI路径访问微服务。请注意，我们必须将NGINX API网关<em class="mm"> /capitolservice </em>添加到授权策略中，以允许它可到达。如果它丢失了，网页会显示出来，但是调用后端capitol-info微服务的功能会被阻塞。</p><p id="b603" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">一旦应用了这个授权策略，我们就能够访问我们的web页面和REST端点。请注意，即使我们允许任何人访问<em class="mm">/add capital</em>，外部世界仍然无法访问它，因为我们没有在虚拟服务中创建路由。如果我们导航到web客户端来查询国会大厦，<a class="ae kv" href="http://localhost/info/QueryCapitol.html," rel="noopener ugc nofollow" target="_blank">http://localhost/info/querycapitol . html，</a>我们将能够到达该站点并运行查询:</p><figure class="ma mb mc md gt ju gh gi paragraph-image"><div class="gh gi mp"><img src="../Images/7d5d97e15fd8b3ac9baf66715337fb31.png" data-original-src="https://miro.medium.com/v2/resize:fit:1012/format:webp/1*ekuwDODJbgNeIIo11YXlaA.png"/></div><figcaption class="mi mj gj gh gi mk ml bd b be z dk translated">客户端微服务—查询国会网页</figcaption></figure><p id="40e8" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">既然我们已经使用宽松的授权策略打开了流量备份，那么让我们来看看一些选择性的锁定策略。如果我们通过删除允许web ( <em class="mm"> /info </em>)和API ( <em class="mm"> /capitolservice </em>)访问的条目来关闭对web客户端的访问，那么我们就阻止了流量进入capitol-client。例如，查看下面的客户端和服务器授权策略，如果我们要应用只允许访问capitol数据服务的策略，它将阻止对网站的访问。南北向入站流量唯一可用的资源是<em class="mm"> /getCapitol </em> REST呼叫，而<em class="mm"> /appCapito </em> l仍然由于缺乏虚拟服务路由而被阻塞。</p><figure class="ma mb mc md gt ju"><div class="bz fp l di"><div class="mn mo l"/></div></figure><p id="8cbe" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">因为capitol-client也在默认的名称空间中运行，所以它是不可访问的。由于我们没有明确授予特权，因此deny all策略对这些资源有效。现在，当我们导航到网页<a class="ae kv" href="http://localhost/info/GetCapital.html" rel="noopener ugc nofollow" target="_blank">http://localhost/info/get capitol . html</a>时，我们得到一个拒绝访问。</p><figure class="ma mb mc md gt ju gh gi paragraph-image"><div class="gh gi mq"><img src="../Images/2d7c834c8f233e76a30f7e1739f96eff.png" data-original-src="https://miro.medium.com/v2/resize:fit:1016/format:webp/1*d7C4Clr6jEOK2MI3yJDukw.png"/></div></figure><p id="a427" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">封锁网页是一件奇怪的事情，相反，我们希望保护后端API不被外界访问，并打开网站。现在，假设我们决定不希望任何人直接从capitol-info服务获取数据，而是只通过capitol-client。我们可以移除入口，阻止外部流量，但服务网格中的其他实体仍然可以访问它。我们不是通过仅阻止外部流量来实现零信任，我们还需要阻止未经批准的内部服务对服务流量。</p><p id="b097" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">上述授权策略的一个问题是它对于名称空间是全局的(<strong class="jz iu">默认</strong>)。这意味着规则适用于名称空间内的所有服务。我们知道capitol-info微服务和capitol-client微服务具有不同的端点，因此让我们为适当的服务配置设置。</p><h2 id="75a8" class="mr kx it bd ky ms mt dn lc mu mv dp lg ki mw mx lk km my mz lo kq na nb ls nc bi translated"><strong class="ak">客户授权政策</strong></h2><figure class="ma mb mc md gt ju"><div class="bz fp l di"><div class="mn mo l"/></div></figure><p id="1e7b" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">上述客户端策略开放了来自服务网格外部以及内部客户端的入站流量，因为它没有指定从开始的<em class="mm">规则，而只指定了从<em class="mm">到</em>的规则。</em></p><h2 id="a340" class="mr kx it bd ky ms mt dn lc mu mv dp lg ki mw mx lk km my mz lo kq na nb ls nc bi translated"><strong class="ak">服务器授权策略</strong></h2><figure class="ma mb mc md gt ju"><div class="bz fp l di"><div class="mn mo l"/></div></figure><p id="94d9" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">应用上述策略为capitol-client和capitol-info微服务提供了它们自己的授权策略。查看Istio的Kiali服务网格仪表板，我们能够看到我们应用的授权策略。</p><figure class="ma mb mc md gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="me mf di mg bf mh"><div class="gh gi nd"><img src="../Images/f55744299093173deb55926c95c2eb02.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*GRQVZOsN6KxgaHqbuxthAg.png"/></div></div><figcaption class="mi mj gj gh gi mk ml bd b be z dk translated">Kiala仪表板显示Istio网关、虚拟服务和授权策略。</figcaption></figure><p id="8582" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">这些特定策略的含义意味着，作为微服务的所有者，我可以控制谁可以访问它们。</p><p id="8ed1" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">随着授权策略的分离，我们能够锁定capitol-info服务，仅用于可信的东西向流量。</p><figure class="ma mb mc md gt ju"><div class="bz fp l di"><div class="mn mo l"/></div></figure><p id="ab55" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">更新后的capitol-info授权策略将流量限制为仅来自默认域内的capitol-client微服务的呼叫。这是因为我们在来自规则的<em class="mm">中指定了主体。为了测试这一点，让我们在网格中添加一个“敌人”微服务。如前所述，零信任意味着不隐式地信任其他参与者，所以仅仅因为一个微服务存在于服务网格中，并不意味着我们信任它。我们的数据服务维护自己的安全配置，所以它决定谁和谁不可信。</em></p><p id="710b" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">假设恶意的内部人员将敌人的服务部署到服务网格中。该敌方服务模仿有效友好客户端的URIs和API网关，如下图所示:</p><figure class="ma mb mc md gt ju gh gi paragraph-image"><div class="gh gi ne"><img src="../Images/eacad52b6c69e00a98359481b13ab962.png" data-original-src="https://miro.medium.com/v2/resize:fit:1392/format:webp/1*zLC1ciRWZgYW6RFWp7PTdw.png"/></div><figcaption class="mi mj gj gh gi mk ml bd b be z dk translated">如果没有东西方安全控制，恶意微服务会造成严重破坏</figcaption></figure><p id="0dcf" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">如果我们不指定限制性的capitol-info授权策略，敌人的微服务将能够直接调用capitol-info微服务。假设敌方服务更进一步，声明自己的授权策略来覆盖<em class="mm">拒绝所有</em>策略，并将其部署到集群中:</p><figure class="ma mb mc md gt ju"><div class="bz fp l di"><div class="mn mo l"/></div></figure><p id="0d50" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">如果你看看敌人微服务的配置，它正试图通过添加自己的<em class="mm"> ALLOW </em>语句来覆盖capitol-info服务策略。另一个<em class="mm"> ALLOW </em>语句(/enemy*和/capitolone *)覆盖了<em class="mm"> deny-all </em>策略。允许对/ <em class="mm"> getCapitol </em> API进行HTTP GET和POST操作的最后一条规则不会被覆盖和忽略。当我们试图从敌方客户端调用<em class="mm"> getCapitol </em>或<em class="mm"> addCapitol </em> REST操作时，调用被阻塞，数据服务受到保护。</p><figure class="ma mb mc md gt ju gh gi paragraph-image"><div class="gh gi nf"><img src="../Images/69c8e3ea8f9557636a769161649b52b9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1376/format:webp/1*8W3zLcWYpFEYsyeSHvaD5Q.png"/></div><figcaption class="mi mj gj gh gi mk ml bd b be z dk translated">在零信任网络中，敌人的微服务被阻止到达其他微服务</figcaption></figure><p id="1404" class="pw-post-body-paragraph jx jy it jz b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku im bi translated">为了进一步保护我们的数据服务，现在我们已经通过授权策略保护了服务到服务的通信，我们可以删除capitol-info入口网关和虚拟服务，只允许通过capitol-client网页和API网关进行访问。</p><h1 id="46b4" class="kw kx it bd ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt bi translated">结论</h1><p id="39d7" class="pw-post-body-paragraph jx jy it jz b ka lu kc kd ke lv kg kh ki lw kk kl km lx ko kp kq ly ks kt ku im bi translated">在本文中，我展示了如何应用零信任原则，将服务网格锁定为仅来自可信来源的流量。使用Istio，您有许多资源来限制对微服务的访问，包括限制虚拟服务和基于流量的来源和目的地实施授权策略。</p></div></div>    
</body>
</html>