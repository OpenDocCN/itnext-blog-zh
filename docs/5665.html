<html>
<head>
<title>K0s Cluster Without Internet Access</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">无互联网接入的K0s集群</h1>
<blockquote>原文：<a href="https://itnext.io/k0s-cluster-without-internet-access-ac0dda08aa63?source=collection_archive---------4-----------------------#2021-04-27">https://itnext.io/k0s-cluster-without-internet-access-ac0dda08aa63?source=collection_archive---------4-----------------------#2021-04-27</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="9223" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">让我们看看k0s如何让气隙安装变得简单</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/b8028416403fa5532add38087a66cb3f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*uKcGMA7kC_BCe7Blkk0fow.jpeg"/></div></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">照片由<a class="ae ky" href="https://unsplash.com/@riiyad?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">卡比尔·拉赫曼·里亚德</a>在<a class="ae ky" href="https://unsplash.com/s/photos/network?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>拍摄</figcaption></figure><p id="0460" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">🔥根据我在LinkedIn上的一些评论，我必须强调，这篇文章只介绍了一种非常简单的气隙安装方法。它并不一定是建立弹性/安全/可观察/可升级生产集群的完整指南。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><p id="ecbe" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在具有高度安全性约束的公司中，可能需要在没有任何互联网接入的机器上安装Kubernetes集群。这意味着必须预先从另一台机器上下载设置集群所需的所有东西，然后以安全的方式(例如，使用USB密钥，从而通过物理方式访问机器)复制到气隙机器上。</p><p id="766b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在这篇短文中，我们将了解<a class="ae ky" href="https://k0sproject.io" rel="noopener ugc nofollow" target="_blank"> k0s </a>如何管理气隙安装。k0s 0.12(火星2021)增加了这个功能。我们将用使用<a class="ae ky" href="https://multipass.run" rel="noopener ugc nofollow" target="_blank">多遍</a>创建的2个虚拟机来说明整个过程:</p><ul class=""><li id="56b2" class="mc md it lb b lc ld lf lg li me lm mf lq mg lu mh mi mj mk bi translated">第一个叫做<em class="ml">工具</em>，可以上网。它将用于获取k0s二进制文件和设置集群所需的所有映像</li><li id="525c" class="mc md it lb b lc mm lf mn li mo lm mp lq mq lu mh mi mj mk bi translated">第二个名为<em class="ml"> airgap </em>的是一个模拟的airgap机器(我们假设这个没有互联网接入)</li></ul></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h2 id="d0f0" class="mr ms it bd mt mu mv dn mw mx my dp mz li na nb nc lm nd ne nf lq ng nh ni nj bi translated">获取图像</h2><p id="1a7f" class="pw-post-body-paragraph kz la it lb b lc nk ju le lf nl jx lh li nm lk ll lm nn lo lp lq no ls lt lu im bi translated">在这一步中，我们将从一台可以访问互联网的机器上下载k0s二进制文件和所有需要的图像。</p><p id="a9b2" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">首先，我们创建一个新的虚拟机(启动并运行不到一分钟),并在其中装入一个shell:</p><pre class="kj kk kl km gt np nq nr ns aw nt bi"><span id="4260" class="mr ms it nq b gy nu nv l nw nx">$ multipass launch -n tools</span><span id="e377" class="mr ms it nq b gy ny nv l nw nx">$ multipass shell tools</span></pre><p id="37df" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">接下来，我们用下面的命令下载k0s二进制文件，这个命令也将k0s安装到<em class="ml"> /usr/local/bin: </em></p><pre class="kj kk kl km gt np nq nr ns aw nt bi"><span id="0b57" class="mr ms it nq b gy nu nv l nw nx"><strong class="nq iu">ubuntu@tools:~$ curl -sSLf https://get.k0s.sh | sudo sh</strong><br/>...<br/>k0s is now executable in /usr/local/bin</span></pre><p id="515c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这里不需要运行k0s，因为我们只使用这个二进制文件来获取运行集群所需的映像列表。该列表可使用如下所示的<code class="fe nz oa ob nq b">airgap</code>子命令获得:</p><pre class="kj kk kl km gt np nq nr ns aw nt bi"><span id="ba09" class="mr ms it nq b gy nu nv l nw nx"><strong class="nq iu">ubuntu@tools:~$ k0s airgap list-images</strong><br/>docker.io/calico/cni:v3.16.2<br/>docker.io/calico/kube-controllers:v3.16.2<br/>docker.io/calico/node:v3.16.2<br/>us.gcr.io/k8s-artifacts-prod/kas-network-proxy/proxy-agent:v0.0.13<br/>docker.io/coredns/coredns:1.7.0<br/>k8s.gcr.io/kube-proxy:v1.20.4<br/>gcr.io/k8s-staging-metrics-server/metrics-server:v0.3.7<br/>k8s.gcr.io/pause:3.2<br/>docker.io/cloudnativelabs/kube-router:v1.1.1<br/>quay.io/k0sproject/cni-node:0.1.0</span></pre><p id="6527" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们不会深入每个映像的细节，它们基本上被k0s用来运行集群的控制平面(加上一些额外的项目，如metrics-server，一个用来获取集群指标的流行工具)。</p><p id="5d86" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">0.13 <code class="fe nz oa ob nq b">kube-router</code>的ℹ️是k0s默认使用的CNI插件</p><p id="506d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在同一台机器上，我们安装了Docker，以便更容易下载图像。在Linux主机上安装Docker，下面的命令非常方便:</p><pre class="kj kk kl km gt np nq nr ns aw nt bi"><span id="fe6b" class="mr ms it nq b gy nu nv l nw nx"><strong class="nq iu">ubuntu@tools:~$ </strong>curl -sSLf https://get.docker.com | sudo sh</span></pre><p id="9057" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们将默认的<code class="fe nz oa ob nq b">ubuntu</code>用户添加到<code class="fe nz oa ob nq b">docker</code>组中:</p><pre class="kj kk kl km gt np nq nr ns aw nt bi"><span id="fb1c" class="mr ms it nq b gy nu nv l nw nx"><strong class="nq iu">ubuntu@tools:~$ </strong>sudo usermod -aG docker ubuntu</span></pre><p id="2b71" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">退出shell并启动新的shell后，我们可以从<code class="fe nz oa ob nq b">ubuntu</code>用户那里获取所有图像:</p><pre class="kj kk kl km gt np nq nr ns aw nt bi"><span id="51f5" class="mr ms it nq b gy nu nv l nw nx"><strong class="nq iu">ubuntu@tools:~$ </strong>for image in $(k0s airgap list-images); do<br/>  docker image pull $image<br/>done</span></pre><p id="d192" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">接下来，我们创建一个包含所有这些图像的归档。这可以使用<code class="fe nz oa ob nq b">docker image save</code>子命令完成，其用法详述如下:</p><pre class="kj kk kl km gt np nq nr ns aw nt bi"><span id="e842" class="mr ms it nq b gy nu nv l nw nx"><strong class="nq iu">ubuntu@tools:~$ docker image save --help</strong></span><span id="3f98" class="mr ms it nq b gy ny nv l nw nx">Usage:  docker image save [OPTIONS] IMAGE [IMAGE...]</span><span id="5df2" class="mr ms it nq b gy ny nv l nw nx">Save one or more images to a tar archive (streamed to STDOUT by default)</span><span id="361f" class="mr ms it nq b gy ny nv l nw nx">Options:<br/>  -o, --output string   Write to a file, instead of STDOUT</span></pre><p id="266a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">以下命令创建了<code class="fe nz oa ob nq b">images.tar</code>归档文件:</p><pre class="kj kk kl km gt np nq nr ns aw nt bi"><span id="f738" class="mr ms it nq b gy nu nv l nw nx"><strong class="nq iu">ubuntu@tools:~$</strong> docker image save $(k0s airgap list-images) -o images.tar</span></pre><p id="da55" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">归档包含所有图像，因此非常沉重:</p><pre class="kj kk kl km gt np nq nr ns aw nt bi"><span id="94ba" class="mr ms it nq b gy nu nv l nw nx"><strong class="nq iu">ubuntu@k0s:~$ ls -lrt<br/></strong>total 759408<br/>-rw------- 1 ubuntu ubuntu 777626624 Apr 26 15:29 images.tar</span></pre><p id="62cc" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在下一步中，我们将把k0s二进制文件和归档文件复制到Air-Gap机器，并运行k0s集群。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h2 id="9559" class="mr ms it bd mt mu mv dn mw mx my dp mz li na nb nc lm nd ne nf lq ng nh ni nj bi translated">将图像复制到气隙机</h2><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi oc"><img src="../Images/0dca098bdaf72b5e71108aef5e8e8da7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1352/format:webp/1*HKqBtMSN1UCHCdy5ko6e7A.jpeg"/></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">将数据复制到气隙机并不总是容易的</figcaption></figure><p id="7e31" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">根据气隙电机的安全级别，我们可能需要对电机进行物理访问，并从USB闪存盘复制数据。当然，有时来自另一台机器的ssh连接也是可能的。</p><p id="d28f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">让我们用一个新的多通道虚拟机来模拟一个气隙电机:</p><pre class="kj kk kl km gt np nq nr ns aw nt bi"><span id="a6e5" class="mr ms it nq b gy nu nv l nw nx">$ multipass launch -n airgap</span></pre><p id="edce" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">接下来，我们将使用本地文件夹和Multipass' transfer命令将资产从<code class="fe nz oa ob nq b">tools</code>复制到<code class="fe nz oa ob nq b">airgap</code>:</p><pre class="kj kk kl km gt np nq nr ns aw nt bi"><span id="1fea" class="mr ms it nq b gy nu nv l nw nx"># Create a local shared folder<br/>mkdir -p /tmp/shared/k0s</span><span id="f192" class="mr ms it nq b gy ny nv l nw nx"># Copy assets from tools to the shared folder<br/>multipass transfer tools:/usr/local/bin/k0s /tmp/shared/k0s<br/>multipass transfer tools:/home/ubuntu/images.tar /tmp/shared/k0s</span><span id="b75a" class="mr ms it nq b gy ny nv l nw nx"># Copy assets from the shared folder to airgap<br/>multipass transfer /tmp/shared/k0s/k0s airgap:/tmp<br/>multipass transfer /tmp/shared/k0/images.tar airgap:/tmp</span></pre><p id="0432" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">一旦可以从气隙机访问资产，我们需要将它们放入正确的位置:</p><ul class=""><li id="6887" class="mc md it lb b lc ld lf lg li me lm mf lq mg lu mh mi mj mk bi translated">k0s二进制需要移到<em class="ml"> /usr/local/bin/ </em></li></ul><pre class="kj kk kl km gt np nq nr ns aw nt bi"><span id="83d3" class="mr ms it nq b gy nu nv l nw nx">$ multipass exec airgap -- /bin/bash -c "<br/>  sudo mv /tmp/k0s /usr/local/bin/<br/>  sudo chmod +x /usr/local/bin/k0s<br/>"</span></pre><ul class=""><li id="a81b" class="mc md it lb b lc ld lf lg li me lm mf lq mg lu mh mi mj mk bi translated">图像档案需要移动到新的<em class="ml"> /var/lib/k0s/images </em>文件夹中</li></ul><pre class="kj kk kl km gt np nq nr ns aw nt bi"><span id="4446" class="mr ms it nq b gy nu nv l nw nx">$ multipass exec airgap -- /bin/bash -c "<br/>  <!-- -->sudo mkdir -p /var/lib/k0s/images<br/>  sudo mv /tmp/images.tar /var/lib/k0s/images/<br/>"</span></pre><p id="6ce4" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">所有的资产在气隙机上都不可用。在下一步中，我们将使用这些组件运行一个集群。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h2 id="5e70" class="mr ms it bd mt mu mv dn mw mx my dp mz li na nb nc lm nd ne nf lq ng nh ni nj bi translated">在气隙电机上运行k0s</h2><p id="c308" class="pw-post-body-paragraph kz la it lb b lc nk ju le lf nl jx lh li nm lk ll lm nn lo lp lq no ls lt lu im bi translated">首先我们在<code class="fe nz oa ob nq b">airgap</code>上得到一个shell</p><pre class="kj kk kl km gt np nq nr ns aw nt bi"><span id="254e" class="mr ms it nq b gy nu nv l nw nx">$ multipass shell airgap</span></pre><p id="015c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">接下来，我们定义一个配置文件，将<code class="fe nz oa ob nq b">default_pull_policy</code>设置为<code class="fe nz oa ob nq b">Never</code>，以确保如果图像不存在，就不会从互联网上下载。</p><pre class="kj kk kl km gt np nq nr ns aw nt bi"><span id="b45a" class="mr ms it nq b gy nu nv l nw nx"><strong class="nq iu">ubuntu@airgap:~$ </strong>cat &lt;&lt;EOF &gt; /tmp/k0s.yaml<br/>apiVersion: k0s.k0sproject.io/v1beta1<br/>kind: Cluster <br/>metadata:   <br/>  name: k0s <br/>spec:   <br/>  images:     <br/><strong class="nq iu">    default_pull_policy: Never<br/></strong>EOF</span></pre><p id="a465" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">然后，我们照常安装k0s(在本例中，我们将选择单个节点),并提供配置文件:</p><pre class="kj kk kl km gt np nq nr ns aw nt bi"><span id="08e6" class="mr ms it nq b gy nu nv l nw nx"><strong class="nq iu">ubuntu@airgap:~$ sudo k0s install controller --single -c /tmp/k0s.yaml</strong><br/>INFO[2021-04-26 20:54:49] no config file given, using defaults<br/>INFO[2021-04-26 20:54:49] creating user: etcd<br/>INFO[2021-04-26 20:54:49] creating user: kube-apiserver<br/>INFO[2021-04-26 20:54:49] creating user: konnectivity-server<br/>INFO[2021-04-26 20:54:49] creating user: kube-scheduler<br/>INFO[2021-04-26 20:54:49] Installing k0s service</span></pre><p id="932d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">然后，我们启动systemd进程:</p><pre class="kj kk kl km gt np nq nr ns aw nt bi"><span id="7536" class="mr ms it nq b gy nu nv l nw nx">$ sudo systemctl start k0scontroller</span></pre><p id="4f6d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">最后，我们可以检查群集是否正常运行</p><pre class="kj kk kl km gt np nq nr ns aw nt bi"><span id="e2b0" class="mr ms it nq b gy nu nv l nw nx">export KUBECONFIG=/var/lib/k0s/pki/admin.conf</span><span id="0452" class="mr ms it nq b gy ny nv l nw nx"><strong class="nq iu">$ sudo k0s kubectl get no<br/></strong>NAME     STATUS   ROLES    AGE     VERSION<br/>airgap   Ready    &lt;none&gt;   2m28s   v1.20.5-k0s1</span></pre></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h2 id="977e" class="mr ms it bd mt mu mv dn mw mx my dp mz li na nb nc lm nd ne nf lq ng nh ni nj bi translated">关键外卖</h2><p id="dbf0" class="pw-post-body-paragraph kz la it lb b lc nk ju le lf nl jx lh li nm lk ll lm nn lo lp lq no ls lt lu im bi translated">出于安全原因，气隙安装有时是必要。正如我们在本文中看到的，k0s的最新版本通过新的<code class="fe nz oa ob nq b">airgap</code>子命令使整个过程变得非常简单。</p></div></div>    
</body>
</html>