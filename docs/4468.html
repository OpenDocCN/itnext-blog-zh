<html>
<head>
<title>Secure Jenkins Operator pipelines with Webhook Relay on Kubernetes</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">通过Kubernetes上的Webhook中继保护Jenkins运营商管道</h1>
<blockquote>原文：<a href="https://itnext.io/secure-jenkins-operator-pipelines-with-webhook-relay-on-kubernetes-4e40028efa30?source=collection_archive---------4-----------------------#2020-07-06">https://itnext.io/secure-jenkins-operator-pipelines-with-webhook-relay-on-kubernetes-4e40028efa30?source=collection_archive---------4-----------------------#2020-07-06</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="6981" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在本教程中，我们将在Kubernetes上配置一个利用Jenkins和Webhook中继操作符的Jenkins管道。Jenkins Kubernetes操作员将使用预定义的种子作业创建Jenkins实例。Webhook中继运营商将确保推送事件上的GitHub webhooks触发新的Jenkins版本，以实现快速高效的CI/CD体验。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi kl"><img src="../Images/98aee40a4cd1ca4bb57a79fe649f45ce.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*_IiulYN1Y67hRHmB.png"/></div></div><figcaption class="kx ky gj gh gi kz la bd b be z dk translated">詹金斯和Webhook中继运营商</figcaption></figure><p id="032e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这种设置的优点:</p><ul class=""><li id="6cd9" class="lb lc iq jp b jq jr ju jv jy ld kc le kg lf kk lg lh li lj bi translated">您的Jenkins实例只能通过kubectl port-forward访问，同时保持从公共目的地接收webhooks的能力。</li><li id="dec2" class="lb lc iq jp b jq lk ju ll jy lm kc ln kg lo kk lg lh li lj bi translated">Jenkins管道配置存储在Git中。</li><li id="fc18" class="lb lc iq jp b jq lk ju ll jy lm kc ln kg lo kk lg lh li lj bi translated">Webhook中继路由配置存储在Git中，与Jenkins本身相同。</li></ul><p id="1600" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">您可以在<a class="ae lp" href="https://kubernetes.io/docs/concepts/extend-kubernetes/operator/" rel="noopener ugc nofollow" target="_blank"> Kubernetes文档</a>中阅读关于操作符模式的内容。</p><h1 id="466b" class="lq lr iq bd ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn bi translated">先决条件</h1><p id="1a03" class="pw-post-body-paragraph jn jo iq jp b jq mo js jt ju mp jw jx jy mq ka kb kc mr ke kf kg ms ki kj kk ij bi translated">先决条件:</p><ul class=""><li id="0947" class="lb lc iq jp b jq jr ju jv jy ld kc le kg lf kk lg lh li lj bi translated"><a class="ae lp" href="https://docs.helm.sh/using_helm/#installing-helm" rel="noopener ugc nofollow" target="_blank">掌舵</a></li><li id="e4e9" class="lb lc iq jp b jq lk ju ll jy lm kc ln kg lo kk lg lh li lj bi translated"><a class="ae lp" href="https://my.webhookrelay.com" rel="noopener ugc nofollow" target="_blank"> Webhook中继账号</a></li><li id="13ce" class="lb lc iq jp b jq lk ju ll jy lm kc ln kg lo kk lg lh li lj bi translated"><a class="ae lp" href="https://kubernetes.io/" rel="noopener ugc nofollow" target="_blank"> Kubernetes </a>环境，Minikube，k3s，GKE，AKS等。都很好。</li><li id="fa06" class="lb lc iq jp b jq lk ju ll jy lm kc ln kg lo kk lg lh li lj bi translated">已配置的kubectl</li><li id="39cd" class="lb lc iq jp b jq lk ju ll jy lm kc ln kg lo kk lg lh li lj bi translated">饭桶</li></ul><h1 id="4265" class="lq lr iq bd ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn bi translated">装置</h1><p id="62a6" class="pw-post-body-paragraph jn jo iq jp b jq mo js jt ju mp jw jx jy mq ka kb kc mr ke kf kg ms ki kj kk ij bi translated">安装将包括几个步骤:</p><ul class=""><li id="cc72" class="lb lc iq jp b jq jr ju jv jy ld kc le kg lf kk lg lh li lj bi translated">安装Jenkins操作员</li><li id="6bf5" class="lb lc iq jp b jq lk ju ll jy lm kc ln kg lo kk lg lh li lj bi translated">安装Webhook继电器操作器</li></ul><h1 id="9de7" class="lq lr iq bd ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn bi translated">创建新的名称空间</h1><p id="4e7a" class="pw-post-body-paragraph jn jo iq jp b jq mo js jt ju mp jw jx jy mq ka kb kc mr ke kf kg ms ki kj kk ij bi translated">让我们从创建一个新的名称空间开始，在这里我们将放置Jenkins实例并运行构建。我会叫它“詹金斯”,但你可以选择任何其他的名字:</p><pre class="km kn ko kp gt mt mu mv mw aw mx bi"><span id="f4cd" class="my lr iq mu b gy mz na l nb nc">kubectl create namespace jenkins</span></pre><p id="9758" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">然后切换到它:</p><pre class="km kn ko kp gt mt mu mv mw aw mx bi"><span id="980e" class="my lr iq mu b gy mz na l nb nc">kubectl config set-context $(kubectl config current-context) --namespace=jenkins</span></pre><h1 id="aad2" class="lq lr iq bd ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn bi translated">詹金斯算子</h1><p id="6933" class="pw-post-body-paragraph jn jo iq jp b jq mo js jt ju mp jw jx jy mq ka kb kc mr ke kf kg ms ki kj kk ij bi translated">我们将使用头盔安装詹金斯操作员。首先，添加存储库:</p><pre class="km kn ko kp gt mt mu mv mw aw mx bi"><span id="154b" class="my lr iq mu b gy mz na l nb nc">helm repo add jenkins https://raw.githubusercontent.com/jenkinsci/kubernetes-operator/master/chart<br/>helm repo update</span></pre><p id="6164" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">添加存储库后，安装它:</p><pre class="km kn ko kp gt mt mu mv mw aw mx bi"><span id="8816" class="my lr iq mu b gy mz na l nb nc">helm install jenkins-operator jenkins/jenkins-operator</span></pre><p id="771f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">官方文档可以在这里找到:<a class="ae lp" href="https://jenkinsci.github.io/kubernetes-operator/docs/installation/" rel="noopener ugc nofollow" target="_blank">https://jenkinsci . github . io/kubernetes-operator/docs/installation/</a>。操作者不是Jenkins本身，所以要获得我们的Jenkins实例，我们必须创建一个<a class="ae lp" href="https://kubernetes.io/docs/concepts/extend-kubernetes/api-extension/custom-resources/" rel="noopener ugc nofollow" target="_blank">自定义资源</a>。</p><blockquote class="nd ne nf"><p id="0c91" class="jn jo ng jp b jq jr js jt ju jv jw jx nh jz ka kb ni kd ke kf nj kh ki kj kk ij bi translated"><em class="iq">自定义资源是Kubernetes API的扩展。本页讨论何时向Kubernetes集群添加自定义资源，以及何时使用独立服务。它描述了添加自定义资源的两种方法以及如何在它们之间进行选择。</em></p></blockquote><h1 id="f117" class="lq lr iq bd ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn bi translated">启动Jenkins(使用自定义资源)</h1><p id="ef2c" class="pw-post-body-paragraph jn jo iq jp b jq mo js jt ju mp jw jx jy mq ka kb kc mr ke kf kg ms ki kj kk ij bi translated">我们需要创建一个CR。您可以使用Jenkins Operator docs来创建一个，也可以派生这个<a class="ae lp" href="https://github.com/webhookrelay/jenkins-operator-example.git" rel="noopener ugc nofollow" target="_blank">https://github . com/webhook relay/Jenkins-Operator-example . git</a>存储库并克隆它。然后:</p><ol class=""><li id="5971" class="lb lc iq jp b jq jr ju jv jy ld kc le kg lf kk nk lh li lj bi translated">将<strong class="jp ir"> jenkins_cr.yaml </strong> <a class="ae lp" href="https://github.com/webhookrelay/jenkins-operator-example/blob/master/jenkins_cr.yaml" rel="noopener ugc nofollow" target="_blank">文件</a> <code class="fe nl nm nn mu b">https://github.com/webhookrelay/jenkins-operator-example.git</code>更新到自己的库叉(一般会是<code class="fe nl nm nn mu b">https://github.com/&lt;your username or organization&gt;/jenkins-operator-example.git</code>)。</li><li id="ffe5" class="lb lc iq jp b jq lk ju ll jy lm kc ln kg lo kk nk lh li lj bi translated">用kubectl创建它:</li></ol><pre class="km kn ko kp gt mt mu mv mw aw mx bi"><span id="1a50" class="my lr iq mu b gy mz na l nb nc">kubectl apply -f jenkins_cr.yaml</span></pre><p id="aa6f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">该文件与股票示例的主要区别在于:</p><ul class=""><li id="b396" class="lb lc iq jp b jq jr ju jv jy ld kc le kg lf kk lg lh li lj bi translated">添加了<code class="fe nl nm nn mu b">github</code>插件，因为我们需要它来触发任务</li><li id="ccf6" class="lb lc iq jp b jq lk ju ll jy lm kc ln kg lo kk lg lh li lj bi translated">种子作业也设置好了<code class="fe nl nm nn mu b">githubPushTrigger: true</code></li></ul><p id="3996" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">创建此PR应该会产生两个额外的容器:</p><pre class="km kn ko kp gt mt mu mv mw aw mx bi"><span id="17c9" class="my lr iq mu b gy mz na l nb nc">kubectl get pods<br/>NAME                                      READY   STATUS    RESTARTS   AGE<br/>jenkins-jenkins                           1/1     Running   0          7m11s<br/>jenkins-operator-6dbbc458c9-gmx6p         1/1     Running   0          18m<br/>seed-job-agent-jenkins-65cc4bc684-9ztr5   1/1     Running   0          6m21s</span></pre><p id="4c28" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们来连线詹金斯。首先，获取用户名和密码:</p><pre class="km kn ko kp gt mt mu mv mw aw mx bi"><span id="9b8d" class="my lr iq mu b gy mz na l nb nc">kubectl --namespace jenkins get secret jenkins-operator-credentials-jenkins -o 'jsonpath={.data.user}' | base64 -d<br/>kubectl --namespace jenkins get secret jenkins-operator-credentials-jenkins -o 'jsonpath={.data.password}' | base64 -d</span></pre><p id="8f50" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">然后，在一个终端启动端口转发:</p><pre class="km kn ko kp gt mt mu mv mw aw mx bi"><span id="7245" class="my lr iq mu b gy mz na l nb nc">kubectl port-forward jenkins-jenkins 8080:8080</span></pre><p id="816b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">然后在浏览器中打开<a class="ae lp" href="http://localhost:8080" rel="noopener ugc nofollow" target="_blank"> http://localhost:8080 </a>。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi no"><img src="../Images/d6201b92482a4d500ba8261dbee7b0e7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*mk1EPLsL4VVGzd8m.png"/></div></div><figcaption class="kx ky gj gh gi kz la bd b be z dk translated">管道</figcaption></figure><h1 id="b621" class="lq lr iq bd ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn bi translated">Webhook继电器</h1><p id="95ca" class="pw-post-body-paragraph jn jo iq jp b jq mo js jt ju mp jw jx jy mq ka kb kc mr ke kf kg ms ki kj kk ij bi translated">从<a class="ae lp" href="https://my.webhookrelay.com/tokens" rel="noopener ugc nofollow" target="_blank">https://my.webhookrelay.com/tokens</a>获取您的访问令牌密钥和秘密对，并将它们设置为环境变量:</p><pre class="km kn ko kp gt mt mu mv mw aw mx bi"><span id="a5f1" class="my lr iq mu b gy mz na l nb nc">export RELAY_KEY=xxxxxxxxxxxx<br/>export RELAY_SECRET=xxxxx</span></pre><p id="568d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">添加Webhook中继操作员舵库并安装:</p><pre class="km kn ko kp gt mt mu mv mw aw mx bi"><span id="633f" class="my lr iq mu b gy mz na l nb nc">helm repo add webhookrelay https://charts.webhookrelay.com<br/>helm repo update<br/>helm upgrade --install webhookrelay-operator --namespace=jenkins webhookrelay/webhookrelay-operator \<br/>  --set credentials.key=$RELAY_KEY --set credentials.secret=$RELAY_SECRET</span></pre><blockquote class="nd ne nf"><p id="7e1b" class="jn jo ng jp b jq jr js jt ju jv jw jx nh jz ka kb ni kd ke kf nj kh ki kj kk ij bi translated"><em class="iq">操作员不会自己转发webhooks。每个创建的CR将确保代理部署被配置为路由特定的存储桶。</em></p></blockquote><p id="e57f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">从<a class="ae lp" href="https://github.com/webhookrelay/jenkins-operator-example/blob/master/webhookrelay_cr.yaml" rel="noopener ugc nofollow" target="_blank">操作员示例库</a>中，我们需要创建Webhook中继定制资源:</p><pre class="km kn ko kp gt mt mu mv mw aw mx bi"><span id="f2b4" class="my lr iq mu b gy mz na l nb nc">kubectl apply -f webhookrelay_cr.yaml</span></pre><blockquote class="nd ne nf"><p id="0243" class="jn jo ng jp b jq jr js jt ju jv jw jx nh jz ka kb ni kd ke kf nj kh ki kj kk ij bi translated"><em class="iq">请注意，如果您修改了Jenkins CR名称，您需要将webhookrelay_cr.yaml“目的地”字段从</em> <code class="fe nl nm nn mu b"><em class="iq">destination: http://jenkins-operator-http-jenkins:8080/github-webhook/</em></code> <em class="iq">更新为您当前的Jenkins服务。通常，它的格式为</em> <code class="fe nl nm nn mu b"><em class="iq">jenkins-operator-http-&lt;CR name&gt;</em></code> <em class="iq">。</em></p></blockquote><h1 id="7bfc" class="lq lr iq bd ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn bi translated">GitHub配置</h1><p id="df44" class="pw-post-body-paragraph jn jo iq jp b jq mo js jt ju mp jw jx jy mq ka kb kc mr ke kf kg ms ki kj kk ij bi translated">这一步可以通过让Jenkins自动配置Github存储库以转发到这个端点来实现自动化，但是为了简单起见，为了更清楚它是如何工作的，我们将手动添加这个URL。</p><h1 id="58e5" class="lq lr iq bd ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn bi translated">获取您的Webhook中继公共URL</h1><p id="e1a2" class="pw-post-body-paragraph jn jo iq jp b jq mo js jt ju mp jw jx jy mq ka kb kc mr ke kf kg ms ki kj kk ij bi translated">要获取您的公共端点，您可以访问<a class="ae lp" href="https://my.webhookrelay.com/buckets" rel="noopener ugc nofollow" target="_blank">https://my.webhookrelay.com/buckets</a>页面或通过CR status获取:</p><pre class="km kn ko kp gt mt mu mv mw aw mx bi"><span id="5aa1" class="my lr iq mu b gy mz na l nb nc">kubectl get webhookrelayforwards.forward.webhookrelay.com forward-to-jenkins -o 'jsonpath={.status.publicEndpoints[0]}'</span></pre><p id="a2c8" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">结果应该类似于:</p><pre class="km kn ko kp gt mt mu mv mw aw mx bi"><span id="21b6" class="my lr iq mu b gy mz na l nb nc">$ kubectl get webhookrelayforwards.forward.webhookrelay.com forward-to-jenkins -o 'jsonpath={.status.publicEndpoints[0]}'<br/>https://k0yv9ip5sxxp55ncsu936k.hooks.webhookrelay.com</span></pre><h1 id="1181" class="lq lr iq bd ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn bi translated">将公共URL添加到GitHub存储库设置</h1><p id="6802" class="pw-post-body-paragraph jn jo iq jp b jq mo js jt ju mp jw jx jy mq ka kb kc mr ke kf kg ms ki kj kk ij bi translated">获取公共端点URL并将其添加到GitHub存储库中:</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi np"><img src="../Images/633bbd1a20e5be11a64ff4cd4887eb13.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*wQVol1BRTzVpdQRa.png"/></div></div><figcaption class="kx ky gj gh gi kz la bd b be z dk translated">将您的Webhook中继公共URL添加到GitHub存储库webhooks设置</figcaption></figure><h1 id="257d" class="lq lr iq bd ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn bi translated">使用管道</h1><p id="f172" class="pw-post-body-paragraph jn jo iq jp b jq mo js jt ju mp jw jx jy mq ka kb kc mr ke kf kg ms ki kj kk ij bi translated">首先，当创建管道时，手动触发构建。之后，任何对GitHub库的推送都会通过webhook中继将Webhook发送到运行在Kubernetes集群中的Jenkins实例:</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi nq"><img src="../Images/3ef1729774d4e2ef7067e9d561699532.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*NG0zkMqFvgxH9IN8.png"/></div></div></figure></div><div class="ab cl nr ns hu nt" role="separator"><span class="nu bw bk nv nw nx"/><span class="nu bw bk nv nw nx"/><span class="nu bw bk nv nw"/></div><div class="ij ik il im in"><p id="3309" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><em class="ng">最初发表于</em><a class="ae lp" href="https://webhookrelay.com/v1/tutorials/webhooks-jenkins-operator-kubernetes.html" rel="noopener ugc nofollow" target="_blank">T5【https://webhookrelay.com】</a><em class="ng">。</em></p></div></div>    
</body>
</html>