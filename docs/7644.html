<html>
<head>
<title>Jakarta REST 3.1 by Examples</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">雅加达休息3.1举例说明</h1>
<blockquote>原文：<a href="https://itnext.io/jakarta-rest-3-1-by-examples-dbe13fe6988c?source=collection_archive---------0-----------------------#2022-12-06">https://itnext.io/jakarta-rest-3-1-by-examples-dbe13fe6988c?source=collection_archive---------0-----------------------#2022-12-06</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="2a6b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">Jakarta REST包括十几个小的改进，还引入了两个主要的新特性。</p><ul class=""><li id="a175" class="kl km iq jp b jq jr ju jv jy kn kc ko kg kp kk kq kr ks kt bi translated">Java SE引导API</li><li id="eb62" class="kl km iq jp b jq ku ju kv jy kw kc kx kg ky kk kq kr ks kt bi translated">期待已久的标准多部分API</li></ul><p id="043b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">让我们通过例子来探索这些特性。</p><figure class="la lb lc ld gt le gh gi paragraph-image"><div role="button" tabindex="0" class="lf lg di lh bf li"><div class="gh gi kz"><img src="../Images/457d9ca2a57c32d9a6bfc0d8ee7a1242.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Anj-VcomDtdChNasGbaoSQ.jpeg"/></div></div></figure><h1 id="8850" class="ll lm iq bd ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi bi translated">引导API</h1><p id="d89a" class="pw-post-body-paragraph jn jo iq jp b jq mj js jt ju mk jw jx jy ml ka kb kc mm ke kf kg mn ki kj kk ij bi translated">就像CDI Bootstrap API在Java SE环境中托管CDI容器一样，Jakarta REST Bootstrap API提供了类似的API来为嵌入式服务器中的Jaxrs应用程序提供服务。</p><h1 id="c05b" class="ll lm iq bd ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi bi translated">创建Java SE项目</h1><p id="11da" class="pw-post-body-paragraph jn jo iq jp b jq mj js jt ju mk jw jx jy ml ka kb kc mm ke kf kg mn ki kj kk ij bi translated">按照<a class="ae mo" href="https://github.com/hantsy/jakartaee10-sandbox/blob/master/docs/jpa/hibernate.md" rel="noopener ugc nofollow" target="_blank">Jakarta Persistence-Example:Hibernate 6.1</a>中的步骤创建一个简单的Java SE项目。</p><p id="0dcd" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们将使用sl4j/logback作为日志框架，并使用Lombok注释来简化Java代码。</p><p id="cf57" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在项目<em class="mp"> pom.xml </em>中添加以下依赖项。</p><pre class="la lb lc ld gt mq mr ms bn mt mu bi"><span id="c5e1" class="mv lm iq mr b be mw mx l my mz">&lt;!-- Lombok --&gt;<br/>&lt;dependency&gt;<br/>    &lt;groupId&gt;org.projectlombok&lt;/groupId&gt;<br/>    &lt;artifactId&gt;lombok&lt;/artifactId&gt;<br/>    &lt;optional&gt;true&lt;/optional&gt;<br/>    &lt;version&gt;1.18.24&lt;/version&gt;<br/>&lt;/dependency&gt;</span></pre><pre class="na mq mr nb nc aw nd bi"><span id="8b27" class="ne lm iq mr b gy nf ng l nh mz">&lt;!-- logging with logback --&gt;<br/>&lt;dependency&gt;<br/>    &lt;groupId&gt;org.slf4j&lt;/groupId&gt;<br/>    &lt;artifactId&gt;slf4j-api&lt;/artifactId&gt;<br/>    &lt;version&gt;2.0.4&lt;/version&gt;<br/>&lt;/dependency&gt;<br/>&lt;dependency&gt;<br/>    &lt;groupId&gt;org.slf4j&lt;/groupId&gt;<br/>    &lt;artifactId&gt;jcl-over-slf4j&lt;/artifactId&gt;<br/>    &lt;version&gt;2.0.4&lt;/version&gt;<br/>&lt;/dependency&gt;<br/>&lt;dependency&gt;<br/>    &lt;groupId&gt;ch.qos.logback&lt;/groupId&gt;<br/>    &lt;artifactId&gt;logback-core&lt;/artifactId&gt;<br/>    &lt;version&gt;1.4.4&lt;/version&gt;<br/>&lt;/dependency&gt;<br/>&lt;dependency&gt;<br/>    &lt;groupId&gt;ch.qos.logback&lt;/groupId&gt;<br/>    &lt;artifactId&gt;logback-classic&lt;/artifactId&gt;<br/>    &lt;version&gt;1.4.4&lt;/version&gt;<br/>&lt;/dependency&gt;</span></pre><p id="5987" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">创建<em class="mp">src/main/resources/logback . XML</em>来设置log back。</p><pre class="la lb lc ld gt mq mr ms bn mt mu bi"><span id="5a3f" class="mv lm iq mr b be mw mx l my mz">&lt;?xml version="1.0" encoding="UTF-8"?&gt;<br/>&lt;configuration&gt;<br/> &lt;property name="LOGS" value="./logs"/&gt;<br/>&lt;appender name="Console"<br/>              class="ch.qos.logback.core.ConsoleAppender"&gt;<br/>        &lt;layout class="ch.qos.logback.classic.PatternLayout"&gt;<br/>            &lt;Pattern&gt;<br/>                %green(%d{ISO8601}) %highlight(%-5level) [%blue(%t)] %yellow(%C{1.}): %msg%n%throwable<br/>            &lt;/Pattern&gt;<br/>        &lt;/layout&gt;<br/>    &lt;/appender&gt;<br/>    &lt;appender name="RollingFile"<br/>              class="ch.qos.logback.core.rolling.RollingFileAppender"&gt;<br/>        &lt;file&gt;${LOGS}/app.log&lt;/file&gt;<br/>        &lt;encoder<br/>                class="ch.qos.logback.classic.encoder.PatternLayoutEncoder"&gt;<br/>            &lt;Pattern&gt;%d %p %C{1.} [%t] %m%n&lt;/Pattern&gt;<br/>        &lt;/encoder&gt;<br/>        &lt;rollingPolicy<br/>                class="ch.qos.logback.core.rolling.TimeBasedRollingPolicy"&gt;<br/>            &lt;!-- rollover daily and when the file reaches 10 MegaBytes --&gt;<br/>            &lt;fileNamePattern&gt;${LOGS}/archived/app-%d{yyyy-MM-dd}.%i.log<br/>            &lt;/fileNamePattern&gt;<br/>            &lt;timeBasedFileNamingAndTriggeringPolicy<br/>                    class="ch.qos.logback.core.rolling.SizeAndTimeBasedFNATP"&gt;<br/>                &lt;maxFileSize&gt;10MB&lt;/maxFileSize&gt;<br/>            &lt;/timeBasedFileNamingAndTriggeringPolicy&gt;<br/>        &lt;/rollingPolicy&gt;<br/>    &lt;/appender&gt;<br/>    &lt;!-- LOG everything at INFO level --&gt;<br/>    &lt;root level="info"&gt;<br/>        &lt;appender-ref ref="RollingFile"/&gt;<br/>        &lt;appender-ref ref="Console"/&gt;<br/>    &lt;/root&gt;<br/>    &lt;logger name="org.glassfish.jersey.server" level="DEBUG"&gt;<br/>    &lt;/logger&gt;<br/>    &lt;logger name="com.example" level="debug" additivity="false"&gt;<br/>        &lt;appender-ref ref="RollingFile"/&gt;<br/>        &lt;appender-ref ref="Console"/&gt;<br/>    &lt;/logger&gt;<br/>&lt;/configuration&gt;</span></pre><p id="53ed" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">将Jakarta REST API添加到依赖项中。</p><pre class="la lb lc ld gt mq mr ms bn mt mu bi"><span id="2307" class="mv lm iq mr b be mw mx l my mz">&lt;dependencies&gt;<br/>    &lt;dependency&gt;<br/>        &lt;groupId&gt;jakarta.ws.rs&lt;/groupId&gt;<br/>        &lt;artifactId&gt;jakarta.ws.rs-api&lt;/artifactId&gt;<br/>        &lt;version&gt;3.1.0&lt;/version&gt;<br/>    &lt;/dependency&gt;<br/>    //...<br/>&lt;/dependencies&gt;</span></pre><p id="649f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">创建一个<em class="mp">主</em>类作为应用程序入口。</p><pre class="la lb lc ld gt mq mr ms bn mt mu bi"><span id="cdcf" class="mv lm iq mr b be mw mx l my mz">@Slf4j<br/>public class Main {<br/>public static void main(String[] args) throws InterruptedException, IOException {<br/>        SeBootstrap.Configuration configuration = SeBootstrap.Configuration.builder()<br/>                .host("localhost")<br/>                .port(8080)<br/>                .protocol("http")<br/>                .build();<br/>        SeBootstrap.start(RestConfig.class, configuration)<br/>            .thenAccept(instance -&gt; {<br/>                    instance.stopOnShutdown(stopResult -&gt; log.debug(<br/>                                    "Stop result: {} [Native stop result: {}]",<br/>                                    stopResult,<br/>                                    stopResult.unwrap(Object.class)));<br/>                    final URI uri = instance.configuration().baseUri();<br/>                    log.debug(<br/>                                    "Instance {} running at {} [Native handle: {}].%n",<br/>                                    instance, uri,<br/>                                    instance.unwrap(Object.class));<br/>                    log.debug("Send SIGKILL to shutdown.");<br/>            })<br/>            .toCompletableFuture().join();<br/>        // stop quit.<br/>        System.in.read();<br/>    }<br/>}</span></pre><p id="c652" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><code class="fe ni nj nk mr b">@Slf4j</code>来自Lombok，它会在编译时给<code class="fe ni nj nk mr b">Main</code>类添加一个<code class="fe ni nj nk mr b">org.slf4j.Logger</code>声明。</p><p id="2d05" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">要定制<code class="fe ni nj nk mr b">SeBootstrap</code>，使用<code class="fe ni nj nk mr b">SeBootstrap.Configuration.builder()</code>产生一个<code class="fe ni nj nk mr b">SeBootstrap.Configuration</code>，它可以作为启动<code class="fe ni nj nk mr b">SeBootstrap</code>实例的参数。</p><p id="f536" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><code class="fe ni nj nk mr b">SeBootstrap.start</code>接受其余的<code class="fe ni nj nk mr b">Application</code>入口类和一个可选的<code class="fe ni nj nk mr b">SeBootstrap.Configuration</code>，在<code class="fe ni nj nk mr b">thenAccept</code>块中，一个引导服务器实例可供使用。<code class="fe ni nj nk mr b">instance.stopOnShutdown</code>用于设置关机挂钩，然后打印应用程序启动信息。</p><p id="0e17" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><code class="fe ni nj nk mr b">.toCompletableFuture().join()</code>将等待异步执行完成。</p><p id="e3c2" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们来看看<code class="fe ni nj nk mr b">RestConfig</code>——这是REST应用入口类。</p><pre class="la lb lc ld gt mq mr ms bn mt mu bi"><span id="0e41" class="mv lm iq mr b be mw mx l my mz">@ApplicationPath("/api")<br/>public class RestConfig extends Application {<br/>    @Override<br/>    public Set&lt;Class&lt;?&gt;&gt; getClasses() {<br/>        return Set.of(GreetingResource.class);<br/>    }<br/>}</span></pre><p id="dcbb" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">添加一个简单的Jaxrs资源— <code class="fe ni nj nk mr b">GreetingResource</code>。</p><pre class="la lb lc ld gt mq mr ms bn mt mu bi"><span id="0f6d" class="mv lm iq mr b be mw mx l my mz">@Path("greeting")<br/>@RequestScoped<br/>public class GreetingResource {<br/>@GET<br/>    public String hello(@QueryParam("name") String name) {<br/>        return "Say 'Hello' to " + (name == null ? "World" : name) + " at " + LocalDateTime.now();<br/>    }<br/>}</span></pre><p id="7464" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">虽然CDI <em class="mp"> beans.xml </em>在Jakarta EE环境中是可选的，但是在Java SE环境中使用SeBootstrap API时却是必须的。</p><p id="cfb1" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">创建一个空的CDI <em class="mp"> beans.xml </em>，放入项目文件夹<em class="mp">src/main/resources/META-INFO</em>。</p><pre class="la lb lc ld gt mq mr ms bn mt mu bi"><span id="179e" class="mv lm iq mr b be mw mx l my mz">&lt;beans <br/>  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"<br/>  xsi:schemaLocation="https://jakarta.ee/xml/ns/jakartaee https://jakarta.ee/xml/ns/jakartaee/beans_4_0.xsd"<br/>  bean-discovery-mode="annotated" version="4.0"&gt;<br/>&lt;/beans&gt;</span></pre><p id="6d86" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">要运行这个应用程序，在运行时需要一个HTTP嵌入式服务器。Jersey和Resteasy都提供了几种选择。</p><h1 id="405e" class="ll lm iq bd ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi bi translated">泽西岛</h1><p id="f0e4" class="pw-post-body-paragraph jn jo iq jp b jq mj js jt ju mk jw jx jy ml ka kb kc mm ke kf kg mn ki kj kk ij bi translated">为Jersey创建一个标准的Maven概要文件，添加以下依赖项。</p><pre class="la lb lc ld gt mq mr ms bn mt mu bi"><span id="cb9a" class="mv lm iq mr b be mw mx l my mz">&lt;profiles&gt;<br/>    &lt;profile&gt;<br/>        &lt;id&gt;jersey&lt;/id&gt;<br/>        &lt;activation&gt;<br/>            &lt;activeByDefault&gt;true&lt;/activeByDefault&gt;<br/>        &lt;/activation&gt;<br/>        &lt;dependencies&gt;<br/>            &lt;dependency&gt;<br/>                &lt;groupId&gt;org.glassfish.jersey.core&lt;/groupId&gt;<br/>                &lt;artifactId&gt;jersey-server&lt;/artifactId&gt;<br/>            &lt;/dependency&gt;<br/>            &lt;dependency&gt;<br/>                &lt;groupId&gt;org.glassfish.jersey.containers&lt;/groupId&gt;<br/>                &lt;artifactId&gt;jersey-container-jdk-http&lt;/artifactId&gt;<br/>            &lt;/dependency&gt;<br/>            &lt;dependency&gt;<br/>                &lt;groupId&gt;org.glassfish.jersey.inject&lt;/groupId&gt;<br/>                &lt;artifactId&gt;jersey-cdi2-se&lt;/artifactId&gt;<br/>            &lt;/dependency&gt;<br/>        &lt;/dependencies&gt;<br/>    &lt;/profile&gt;<br/>    //...</span></pre><p id="2358" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">最新球衣中有<a class="ae mo" href="https://repo1.maven.org/maven2/org/glassfish/jersey/containers/" rel="noopener ugc nofollow" target="_blank">几个球衣容器</a>。这里我们使用了最简单的一个，它基于JDK内置的HttpServer。</p><p id="1850" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在通过点击run按钮直接在ide中运行<code class="fe ni nj nk mr b">Main</code>类。</p><p id="52a4" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">您将在控制台窗口中看到以下信息。</p><pre class="la lb lc ld gt mq mr ms bn mt mu bi"><span id="f927" class="mv lm iq mr b be mw mx l my mz">Nov 22, 2022 10:42:46 PM org.glassfish.jersey.message.internal.MessagingBinders$EnabledProvidersBinder bindToBinder<br/>WARNING: A class jakarta.activation.DataSource for a default provider MessageBodyWriter&lt;jakarta.activation.DataSource&gt; was not found. The provider is not available.<br/>Nov 22, 2022 10:42:46 PM org.glassfish.jersey.server.wadl.WadlFeature configure<br/>WARNING: JAX-B API not found . WADL feature is disabled.<br/>2022-11-22 22:42:46,667 INFO  [ForkJoinPool.commonPool-worker-1] org.jboss.weld.bootstrap.WeldStartup: WELD-000900: 5.0.1 (Final)<br/>2022-11-22 22:42:46,935 INFO  [ForkJoinPool.commonPool-worker-1] org.jboss.weld.environment.deployment.discovery.ReflectionDiscoveryStrategy: WELD-ENV-000014: Falling back to Java Reflection for bean-discovery-mode="annotated" discovery. Add org.jboss:jandex to the classpath to speed-up startup.<br/>2022-11-22 22:42:47,035 INFO  [ForkJoinPool.commonPool-worker-1] org.jboss.weld.bootstrap.WeldStartup: WELD-000101: Transactional services not available. Injection of @Inject UserTransaction not available. Transactional observers will be invoked synchronously.<br/>2022-11-22 22:42:47,796 INFO  [ForkJoinPool.commonPool-worker-1] org.jboss.weld.environment.se.WeldContainer: WELD-ENV-002003: Weld SE container eb0f72e8-e3e1-4f72-bbae-045cc3791db4 initialized<br/>2022-11-22 22:42:48,005 DEBUG [ForkJoinPool.commonPool-worker-1] com.example.Main: Instance org.glassfish.jersey.server.internal.RuntimeDelegateImpl$1@2c7c9fa9 running at http://localhost:8080/ [Native handle: org.glassfish.jersey.jdkhttp.JdkHttpServer@57458589].%n<br/>2022-11-22 22:42:48,006 DEBUG [ForkJoinPool.commonPool-worker-1] com.example.Main: Send SIGKILL to shutdown.</span></pre><p id="300c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">打开另一个终端窗口，使用<code class="fe ni nj nk mr b">curl</code>命令测试<code class="fe ni nj nk mr b">/api/greeting</code>端点。</p><pre class="la lb lc ld gt mq mr ms bn mt mu bi"><span id="40de" class="mv lm iq mr b be mw mx l my mz">curl http://localhost:8080/api/greeting?name=Hantsy</span></pre><pre class="na mq mr nb nc aw nd bi"><span id="2c34" class="ne lm iq mr b gy nf ng l nh mz">Say 'Hello' to Hantsy at 2022-11-22T22:45:41.129167100</span></pre><p id="08eb" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">利用maven-assemble-plugin，它将把所有依赖关系的应用程序类打包到一个档案中。</p><pre class="la lb lc ld gt mq mr ms bn mt mu bi"><span id="0d2b" class="mv lm iq mr b be mw mx l my mz">&lt;!-- Maven Assembly Plugin --&gt;<br/>&lt;plugin&gt;<br/>    &lt;groupId&gt;org.apache.maven.plugins&lt;/groupId&gt;<br/>    &lt;artifactId&gt;maven-assembly-plugin&lt;/artifactId&gt;<br/>    &lt;version&gt;3.4.2&lt;/version&gt;<br/>    &lt;configuration&gt;<br/>        &lt;descriptorRefs&gt;<br/>            &lt;descriptorRef&gt;jar-with-dependencies&lt;/descriptorRef&gt;<br/>        &lt;/descriptorRefs&gt;<br/>        &lt;!-- MainClass in mainfest make a executable jar --&gt;<br/>        &lt;archive&gt;<br/>            &lt;manifest&gt;<br/>                &lt;addClasspath&gt;true&lt;/addClasspath&gt;<br/>                &lt;mainClass&gt;com.example.Main&lt;/mainClass&gt;<br/>            &lt;/manifest&gt;<br/>        &lt;/archive&gt;<br/>    &lt;/configuration&gt;<br/>        &lt;executions&gt;<br/>            &lt;execution&gt;<br/>                &lt;id&gt;make-assembly&lt;/id&gt;<br/>                &lt;phase&gt;package&lt;/phase&gt; &lt;!-- bind to the packaging phase --&gt;<br/>                &lt;goals&gt;<br/>                    &lt;goal&gt;single&lt;/goal&gt;<br/>                &lt;/goals&gt;<br/>            &lt;/execution&gt;<br/>        &lt;/executions&gt;<br/>    &lt;/plugin&gt;</span></pre><p id="35d2" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">打开终端，切换到项目根目录，运行以下命令将应用程序构建到jar归档文件中。</p><pre class="la lb lc ld gt mq mr ms bn mt mu bi"><span id="2774" class="mv lm iq mr b be mw mx l my mz">&gt;mvn clean package -DskipTests -D"maven.test.skip=true"<br/>...<br/>[INFO]<br/>[INFO] --- maven-assembly-plugin:3.4.2:single (make-assembly) @ rest-se-bootstrap-examples ---<br/>[INFO] Building jar: D:\hantsylabs\jakartaee10-sandbox\rest-se-bootstrap\target\rest-se-bootstrap-examples-jar-with-dependencies.jar<br/>...</span></pre><p id="453b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">然后使用以下命令运行应用程序。</p><pre class="la lb lc ld gt mq mr ms bn mt mu bi"><span id="75a0" class="mv lm iq mr b be mw mx l my mz">&gt;java -jar .\target\rest-se-bootstrap-examples-jar-with-dependencies.jar<br/>...<br/>WELD-000101: Transactional services not available. Injection of @Inject UserTransaction not available.<br/>Transactional observers will be invoked synchronously.<br/>2022-11-26 13:50:45,132 INFO  [ForkJoinPool.commonPool-worker-1] org.jboss.weld.environment.se.WeldContainer: WELD-ENV-002003: Weld SE container 4744564b-922c-4612-a88f-8095c4d7293b initialized<br/>2022-11-26 13:50:45,257 DEBUG [ForkJoinPool.commonPool-worker-1] com.example.Main: Instance org.glassfish.jersey.server.internal.RuntimeDelegateImpl$1@2fa5468d running at http://localhost:8080/ [Native handle: org.glassfish.jersey.jdkhttp.JdkHttpServer@78879a1c].%n<br/>2022-11-26 13:50:45,257 DEBUG [ForkJoinPool.commonPool-worker-1] com.example.Main: Send SIGKILL to shutdown.</span></pre><p id="6437" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">同样，您可以使用上面的<code class="fe ni nj nk mr b">curl</code>命令来验证<code class="fe ni nj nk mr b">/greeting</code>端点。</p><h1 id="adcb" class="ll lm iq bd ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi bi translated">Resteasy</h1><p id="898a" class="pw-post-body-paragraph jn jo iq jp b jq mj js jt ju mk jw jx jy ml ka kb kc mm ke kf kg mn ki kj kk ij bi translated">让我们切换到使用Redhat <a class="ae mo" href="https://resteasy.dev/" rel="noopener ugc nofollow" target="_blank"> Resteasy </a>作为运行时。</p><p id="6a8f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">为Resteasy创建一个新的Maven概要文件。</p><pre class="la lb lc ld gt mq mr ms bn mt mu bi"><span id="4af0" class="mv lm iq mr b be mw mx l my mz">&lt;profile&gt;<br/>    &lt;id&gt;resteasy&lt;/id&gt;<br/>    &lt;properties&gt;<br/>        &lt;jboss-logmanager.version&gt;2.1.19.Final&lt;/jboss-logmanager.version&gt;<br/>    &lt;/properties&gt;<br/>    &lt;dependencies&gt;<br/>        &lt;dependency&gt;<br/>            &lt;groupId&gt;org.jboss.logmanager&lt;/groupId&gt;<br/>            &lt;artifactId&gt;jboss-logmanager&lt;/artifactId&gt;<br/>            &lt;version&gt;${jboss-logmanager.version}&lt;/version&gt;<br/>        &lt;/dependency&gt;<br/>        &lt;dependency&gt;<br/>            &lt;groupId&gt;org.jboss.resteasy&lt;/groupId&gt;<br/>            &lt;artifactId&gt;resteasy-undertow-cdi&lt;/artifactId&gt;<br/>        &lt;/dependency&gt;<br/>    &lt;/dependencies&gt;<br/>    &lt;build&gt;<br/>        &lt;plugins&gt;<br/>            &lt;plugin&gt;<br/>                &lt;artifactId&gt;maven-surefire-plugin&lt;/artifactId&gt;<br/>                &lt;configuration&gt;<br/>                    &lt;systemPropertyVariables&gt;<br/>                        &lt;java.util.logging.manager&gt;org.jboss.logmanager.LogManager&lt;/java.util.logging.manager&gt;<br/>                    &lt;/systemPropertyVariables&gt;<br/>                &lt;/configuration&gt;<br/>            &lt;/plugin&gt;<br/>        &lt;/plugins&gt;<br/>    &lt;/build&gt;<br/>&lt;/profile&gt;</span></pre><p id="0545" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在最新的Resteasy中有几个嵌入式容器。这里我们选择基于支持CDI的Redhat Undertow的<code class="fe ni nj nk mr b">resteasy-undertow-cdi</code>。</p><p id="fe7c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">打开一个终端，切换到项目根目录，运行下面的命令在这个Resteasy embedded server中启动应用程序。</p><pre class="la lb lc ld gt mq mr ms bn mt mu bi"><span id="eaee" class="mv lm iq mr b be mw mx l my mz">&gt;mvn clean package -Presteasy  -DskipTests -D"maven.test.skip=true"<br/>...<br/>[INFO] --- maven-assembly-plugin:3.4.2:single (make-assembly) @ rest-se-bootstrap-examples ---<br/>[INFO] Building jar: D:\hantsylabs\jakartaee10-sandbox\rest-se-bootstrap\target\rest-se-bootstrap-examples-jar-with-dependencies.jar<br/>...<br/>&gt;java -jar .\target\rest-se-bootstrap-examples-jar-with-dependencies.jar</span></pre><pre class="na mq mr nb nc aw nd bi"><span id="f626" class="ne lm iq mr b gy nf ng l nh mz">...<br/>org.jboss.weld.environment.undertow.UndertowContainer: WELD-ENV-001302: Undertow detected, CDI injection will be available in Servlets, Filters and Listeners.<br/>2022-11-26 13:44:37,430 DEBUG [ForkJoinPool.commonPool-worker-1] com.example.Main: Instance org.jboss.resteasy.core.se.ResteasySeInstance@56cb9a0d running at <a class="ae mo" href="http://localhost:8080/" rel="noopener ugc nofollow" target="_blank">http://localhost:8080/</a> [Native handle: dev.resteasy.embedded.server.UndertowCdiEmbeddedServer@80a8d12].%n<br/>2022-11-26 13:44:37,431 DEBUG [ForkJoinPool.commonPool-worker-1] com.example.Main: Send SIGKILL to shutdown.</span></pre><h1 id="936d" class="ll lm iq bd ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi bi translated">测试REST端点</h1><p id="09a7" class="pw-post-body-paragraph jn jo iq jp b jq mj js jt ju mk jw jx jy ml ka kb kc mm ke kf kg mn ki kj kk ij bi translated">使用Bootstrap API，在JUnit生命周期挂钩中启动和停止应用程序是很容易的。</p><pre class="la lb lc ld gt mq mr ms bn mt mu bi"><span id="6c73" class="mv lm iq mr b be mw mx l my mz">@Slf4j<br/>public class SeBootstrapTest {<br/>    SeBootstrap.Instance instance;<br/>    @SneakyThrows<br/>    @BeforeEach<br/>    public void setup() {<br/>        var latch = new CountDownLatch(1);<br/>        SeBootstrap.start(RestConfig.class)<br/>                .thenAccept(it -&gt; {<br/>                    instance = it;<br/>                    latch.countDown();<br/>                })<br/>                .toCompletableFuture().join();<br/>        latch.await(1000, java.util.concurrent.TimeUnit.MILLISECONDS);<br/>    }<br/>    @AfterEach<br/>    public void teardown() {<br/>        instance.stop()<br/>                .thenAccept(<br/>                        stopResult -&gt; log.debug(<br/>                                "Stop result: {} [Native stop result: {}]",<br/>                                stopResult,<br/>                                stopResult.unwrap(Object.class)<br/>                        )<br/>                ).toCompletableFuture().join();<br/>    }<br/>// tests<br/>}</span></pre><p id="4ac6" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">添加一个测试来验证<code class="fe ni nj nk mr b">GreetingResource</code>的功能。</p><pre class="la lb lc ld gt mq mr ms bn mt mu bi"><span id="0c53" class="mv lm iq mr b be mw mx l my mz">@Slf4j<br/>public class SeBootstrapTest {<br/><br/>private final ExecutorService executorService = Executors.newFixedThreadPool(5);<br/>    private final HttpClient httpClient = HttpClient.newBuilder()<br/>            .executor(executorService)<br/>            .version(HttpClient.Version.HTTP_2)<br/>            .build();<br/>    // @BeforeEach and @AfterEach...<br/>    @Test<br/>    public void testGreetingEndpoints() {<br/>        var greetingUri = instance.configuration().baseUriBuilder().path("/api/greeting").queryParam("name", "Hantsy").build();<br/>        log.debug("greetingUri: {}", greetingUri);<br/>        this.httpClient<br/>                .sendAsync(<br/>                        HttpRequest.newBuilder()<br/>                                .GET()<br/>                                .uri(greetingUri)<br/>                                .header("Accept", "application/json")<br/>                                .build()<br/>                        ,<br/>                        HttpResponse.BodyHandlers.ofString()<br/>                )<br/>                .thenApply(HttpResponse::body)<br/>                .thenAccept(body -&gt; {<br/>                    log.debug("Greeting: {}", body);<br/>                    assertThat(body).contains("Say 'Hello' to Hantsy at");<br/>                })<br/>                .join();<br/>    }<br/>}</span></pre><p id="518f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这里我们使用Java 11内置的HttClient与<code class="fe ni nj nk mr b">/api/greeting</code>端点握手。</p><p id="a847" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">执行以下命令来运行测试。</p><pre class="la lb lc ld gt mq mr ms bn mt mu bi"><span id="7ebb" class="mv lm iq mr b be mw mx l my mz">&gt;mvn clean test<br/>...<br/>2022-11-26 16:45:57,721 DEBUG [main] com.example.SeBootstrapTest: greetingUri: http://localhost:8080/api/greeting?name=Hantsy<br/>2022-11-26 16:45:58,103 DEBUG [ForkJoinPool.commonPool-worker-1] com.example.SeBootstrapTest: Greeting: Say 'Hello' to Hantsy at 2022-11-26T16:45:58.022505600<br/>2022-11-26 16:45:58,211 INFO  [ForkJoinPool.commonPool-worker-1] org.jboss.weld.environment.se.WeldContainer: WELD-ENV-002001: Weld SE<br/>container e388f80d-f026-41cb-999d-6f2ed757a1b5 shut down<br/>2022-11-26 16:45:58,213 DEBUG [ForkJoinPool.commonPool-worker-1] com.example.SeBootstrapTest: Stop result: org.glassfish.jersey.server.internal.RuntimeDelegateImpl$1$1@2df99c23 [Native stop result: null]<br/>[INFO] Tests run: 1, Failures: 0, Errors: 0, Skipped: 0, Time elapsed: 3.694 s - in com.example.SeBootstrapTest<br/>[INFO]<br/>[INFO] Results:<br/>[INFO]<br/>[INFO] Tests run: 1, Failures: 0, Errors: 0, Skipped: 0<br/>[INFO]<br/>[INFO] ------------------------------------------------------------------------<br/>[INFO] BUILD SUCCESS<br/>[INFO] ------------------------------------------------------------------------<br/>[INFO] Total time:  15.225 s<br/>[INFO] Finished at: 2022-11-26T16:45:58+08:00<br/>[INFO] ------------------------------------------------------------------------</span></pre><h1 id="cbf3" class="ll lm iq bd ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi bi translated">多部分API</h1><p id="d368" class="pw-post-body-paragraph jn jo iq jp b jq mj js jt ju mk jw jx jy ml ka kb kc mm ke kf kg mn ki kj kk ij bi translated">Jersey和Resteasy都有自己的多部分实现。在Jakarta REST 3.1中，它最终带来了标准化的多部分API支持。</p><p id="cd67" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">遵循<a class="ae mo" href="https://github.com/hantsy/jakartaee10-sandbox/blob/master/docs/jpa/jakartaee.md" rel="noopener ugc nofollow" target="_blank">Jakarta Persistence—Jakarta EE</a>中的步骤，创建一个简单的Jakarta EE项目。</p><p id="a532" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">首先让我们用一个简单的Jaxrs资源来消费多方请求并产生多方响应。</p><pre class="la lb lc ld gt mq mr ms bn mt mu bi"><span id="c7ab" class="mv lm iq mr b be mw mx l my mz">@Path("multiparts")<br/>@RequestScoped<br/>public class MultipartResource {<br/>    private static final Logger LOGGER = Logger.getLogger(MultipartResource.class.getName());<br/><br/>java.nio.file.Path uploadedPath;<br/>    @PostConstruct<br/>    public void init() {<br/>        try {<br/>            uploadedPath = Files.createTempDirectory(Paths.get("/temp"), "uploads_");<br/>        } catch (IOException e) {<br/>            throw new RuntimeException(e);<br/>        }<br/>    }<br/><br/>    @Path("simple")<br/>    @POST<br/>    @Consumes(MediaType.MULTIPART_FORM_DATA)<br/>    public Response uploadFile(@FormParam("name") String name,<br/>                               @FormParam("part") EntityPart part) {<br/>        LOGGER.log(Level.INFO, "name: {0} ", name);<br/>        LOGGER.log(<br/>                Level.INFO,<br/>                "uploading file: {0},{1},{2},{3}",<br/>                new Object[]{<br/>                        part.getMediaType(),<br/>                        part.getName(),<br/>                        part.getFileName(),<br/>                        part.getHeaders()<br/>                }<br/>        );<br/>        try {<br/>            Files.copy(<br/>                    part.getContent(),<br/>                    Paths.get(uploadedPath.toString(), part.getFileName().orElse(generateFileName(UUID.randomUUID().toString(), mediaTypeToFileExtension(part.getMediaType())))),<br/>                    StandardCopyOption.REPLACE_EXISTING<br/>            );<br/>        } catch (IOException e) {<br/>            throw new RuntimeException(e);<br/>        }<br/>        return Response.ok().build();<br/>    }<br/>    @Path("list")<br/>    @POST<br/>    @Consumes(MediaType.MULTIPART_FORM_DATA)<br/>    public Response uploadMultiFiles(List&lt;EntityPart&gt; parts) {<br/>        LOGGER.log(Level.INFO, "Uploading files: {0}", parts.size());<br/>        parts.forEach(<br/>                part -&gt; {<br/>                    LOGGER.log(<br/>                            Level.INFO,<br/>                            "uploading multifiles: {0},{1},{2},{3}",<br/>                            new Object[]{<br/>                                    part.getMediaType(),<br/>                                    part.getName(),<br/>                                    part.getFileName(),<br/>                                    part.getHeaders()<br/>                            }<br/>                    );<br/>                    try {<br/>                        Files.copy(<br/>                                part.getContent(),<br/>                                Paths.get(uploadedPath.toString(), part.getFileName().orElse(generateFileName(UUID.randomUUID().toString(), mediaTypeToFileExtension(part.getMediaType())))),<br/>                                StandardCopyOption.REPLACE_EXISTING<br/>                        );<br/>                    } catch (IOException e) {<br/>                        throw new RuntimeException(e);<br/>                    }<br/>                }<br/>        );<br/>        return Response.ok().build();<br/>    }<br/>    @GET<br/>    public List&lt;EntityPart&gt; getFiles() throws IOException {<br/>        List&lt;EntityPart&gt; parts = new ArrayList&lt;&gt;();<br/>        parts.add(EntityPart.withName("abd")<br/>                .fileName("abc.text").content("this is a text content")<br/>                .mediaType(MediaType.TEXT_PLAIN_TYPE)<br/>                .build()<br/>        );<br/>        try (var files = Files.list(uploadedPath)) {<br/>            var partsInUploaded = files<br/>                    .map(path -&gt; {<br/>                                var file = path.toFile();<br/>                                LOGGER.log(Level.INFO, "found uploaded file: {0}", file.getName());<br/>                                try {<br/>                                    return EntityPart.withName(file.getName())<br/>                                            .fileName(file.getName())<br/>                                            .content(new FileInputStream(file))<br/>                                            .mediaType(fileExtensionToMediaType(getFileExt(file.getName())))<br/>                                            .build();<br/>                                } catch (IOException e) {<br/>                                    throw new RuntimeException(e);<br/>                                }<br/>                            }<br/>                    )<br/>                    .toList();<br/>            parts.addAll(partsInUploaded);<br/>        }<br/>        return parts;<br/>    }<br/>    private String getFileExt(String fileName) {<br/>        return fileName.substring(fileName.lastIndexOf(".") + 1);<br/>    }<br/>    private MediaType fileExtensionToMediaType(String extension) {<br/>        return switch (extension.toLowerCase()) {<br/>            case "txt" -&gt; MediaType.TEXT_PLAIN_TYPE;<br/>            case "svg" -&gt; MediaType.APPLICATION_SVG_XML_TYPE;<br/>            default -&gt; MediaType.APPLICATION_OCTET_STREAM_TYPE;<br/>        };<br/>    }<br/>    private String generateFileName(String fileName, String extension) {<br/>        return fileName + "." + extension;<br/>    }<br/>    private String mediaTypeToFileExtension(MediaType mediaType) {<br/>        return switch (mediaType.toString()) {<br/>            case "text/plain" -&gt; "txt";<br/>            case "application/svg+xml" -&gt; "svg";<br/>            default -&gt; "bin";<br/>        };<br/>    }<br/>}</span></pre><p id="6fa2" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">为了处理一个<code class="fe ni nj nk mr b">multipart/form-data</code>请求，在Jaxrs资源方法上添加<code class="fe ni nj nk mr b">@Consumes(MediaType.MULTIPART_FORM_DATA)</code>。一个Jaxrs资源可以使用一个<code class="fe ni nj nk mr b">EntityPart</code>或者一个<code class="fe ni nj nk mr b">EntityPart</code>的集合。</p><p id="2a94" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在上面的示例代码中，<code class="fe ni nj nk mr b">uploadFile</code>方法演示了如何处理包含一个简单表单值和一个<code class="fe ni nj nk mr b">EntityPart</code>的常规表单post，而<code class="fe ni nj nk mr b">uploadMultiFiles</code>方法用于处理一个<code class="fe ni nj nk mr b">EntityPart</code>列表。<code class="fe ni nj nk mr b">getFiles</code>方法用于为客户端生成一个多部分实体的集合。</p><p id="b587" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">创建休止符<code class="fe ni nj nk mr b">Application</code>以激活雅加达休止符。</p><pre class="la lb lc ld gt mq mr ms bn mt mu bi"><span id="c449" class="mv lm iq mr b be mw mx l my mz">@ApplicationPath("api")<br/>public class RestConfig extends Application {<br/>}</span></pre><p id="2ed0" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">运行以下命令，它将构建项目并将其打包到war档案中，然后启动一个GlassFish实例并将war档案部署到GlassFish。</p><pre class="la lb lc ld gt mq mr ms bn mt mu bi"><span id="f5cf" class="mv lm iq mr b be mw mx l my mz">&gt; mvn clean package cargo:run</span></pre><p id="9467" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">或者，如果您喜欢WildFly，运行以下命令部署到WildFly。</p><pre class="la lb lc ld gt mq mr ms bn mt mu bi"><span id="89d0" class="mv lm iq mr b be mw mx l my mz">&gt; mvn clean wildfly:run</span></pre><p id="63fa" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">当部署工作完成后，打开另一个终端，让我们用<code class="fe ni nj nk mr b">curl</code>命令测试我们的端点。</p><pre class="la lb lc ld gt mq mr ms bn mt mu bi"><span id="e5a7" class="mv lm iq mr b be mw mx l my mz">&gt; curl -i -X POST  http://localhost:8080/rest-examples/api/multiparts/simple -F "name=Hantsy" -F "part=@D:\temp\test.txt" -H "Content-Type: multipart/form-data"<br/>HTTP/1.1 200 OK<br/>Server: Eclipse GlassFish  7.0.0</span></pre><p id="a100" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">打开GlassFish server.log文件，它会追加以下新信息。</p><pre class="la lb lc ld gt mq mr ms bn mt mu bi"><span id="97b3" class="mv lm iq mr b be mw mx l my mz">[2022-12-03T20:52:36.002626+08:00] [GlassFish 7.0] [INFO] [] [com.example.MultipartResource] [tid: _ThreadID=61 _ThreadName=http-listener-1(1)] [levelValue: 800] [[<br/>  name: Hantsy ]]<br/>[2022-12-03T20:52:36.003632+08:00] [GlassFish 7.0] [INFO] [] [com.example.MultipartResource] [tid: _ThreadID=61 _ThreadName=http-listener-1(1)] [levelValue: 800] [[<br/>  uploading file: text/plain,part,Optional[test.txt],{Content-Disposition=[form-data; name="part"; filename="test.txt"], Content-Type=[text/plain]}]]</span></pre><p id="4339" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">让我们尝试使用<code class="fe ni nj nk mr b">/list</code>端点上传多个文件。</p><pre class="la lb lc ld gt mq mr ms bn mt mu bi"><span id="2a5f" class="mv lm iq mr b be mw mx l my mz">&gt; curl -i -X POST  http://localhost:8080/rest-examples/api/multiparts/list -F "test=@D:\temp\test.txt" -F "test2=@D:\temp\test2.txt" -H "Content-Type: multipart/form-data"<br/>HTTP/1.1 200 OK<br/>Server: Eclipse GlassFish  7.0.0</span></pre><p id="7df8" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在GlassFish server.log文件中，新添加了以下新日志。</p><pre class="la lb lc ld gt mq mr ms bn mt mu bi"><span id="fa99" class="mv lm iq mr b be mw mx l my mz">[2022-12-03T20:58:54.140995+08:00] [GlassFish 7.0] [INFO] [] [com.example.MultipartResource] [tid: _ThreadID=65 _ThreadName=http-listener-1(5)] [levelValue: 800] [[<br/>  Uploading files: 2]]<br/>[2022-12-03T20:58:54.142996+08:00] [GlassFish 7.0] [INFO] [] [com.example.MultipartResource] [tid: _ThreadID=65 _ThreadName=http-listener-1(5)] [levelValue: 800] [[<br/>  uploading multifiles: text/plain,test,Optional[test.txt],{Content-Disposition=[form-data; name="test"; filename="test.txt"], Content-Type=[text/plain]}]]<br/>[2022-12-03T20:58:54.145995+08:00] [GlassFish 7.0] [INFO] [] [com.example.MultipartResource] [tid: _ThreadID=65 _ThreadName=http-listener-1(5)] [levelValue: 800] [[<br/>  uploading multifiles: text/plain,test2,Optional[test2.txt],{Content-Disposition=[form-data; name="test2"; filename="test2.txt"], Content-Type=[text/plain]}]]</span></pre><p id="f2aa" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">让我们尝试发送一个<code class="fe ni nj nk mr b">GET</code>请求来获取多部分数据。</p><pre class="la lb lc ld gt mq mr ms bn mt mu bi"><span id="68c3" class="mv lm iq mr b be mw mx l my mz">&gt;curl -v http://localhost:8080/rest-examples/api/multiparts -H "Accept: multipart/form-data"</span></pre><pre class="na mq mr nb nc aw nd bi"><span id="1e44" class="ne lm iq mr b gy nf ng l nh mz">* Connected to localhost (127.0.0.1) port 8080 (#0)<br/>&gt; GET /rest-examples/api/multiparts HTTP/1.1<br/>&gt; Host: localhost:8080<br/>&gt; User-Agent: curl/7.83.1<br/>&gt; Accept: multipart/form-data<br/>&gt;<br/>* Mark bundle as not supporting multiuse<br/>&lt; HTTP/1.1 200 OK<br/>&lt; Server: Eclipse GlassFish  7.0.0<br/>&lt; X-Powered-By: Servlet/6.0 JSP/3.1(Eclipse GlassFish  7.0.0  Java/Oracle Corporation/17)<br/>&lt; MIME-Version: 1.0<br/>&lt; Content-Type: multipart/form-data;boundary=Boundary_1_1941664842_1670072479638<br/>&lt; Content-Length: 197<br/>&lt;<br/>--Boundary_1_1941664842_1670072479638<br/>Content-Type: text/plain<br/>Content-Disposition: form-data; filename="abc.text"; name="abd"</span><span id="256d" class="ne lm iq mr b gy nl ng l nh mz">this is a text content<br/>--Boundary_1_1941664842_1670072479638--</span></pre><p id="f8d7" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">Jaxrs还包括与多方端点握手的客户端API。使用客户端API，很容易上传或下载多部分实体。</p><p id="e8ab" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">让我们创建一个Arquillian测试并使用Jaxrs客户机API来验证上述端点。</p><pre class="la lb lc ld gt mq mr ms bn mt mu bi"><span id="9d08" class="mv lm iq mr b be mw mx l my mz">@ExtendWith(ArquillianExtension.class)<br/>public class MultipartResourceTest {<br/><br/>private final static Logger LOGGER = Logger.getLogger(MultipartResourceTest.class.getName());<br/><br/>@Deployment(testable = false)<br/>    public static WebArchive createDeployment() {<br/>        File[] extraJars = Maven<br/>                .resolver()<br/>                .loadPomFromFile("pom.xml")<br/>                .importCompileAndRuntimeDependencies()<br/>                .resolve("org.assertj:assertj-core")<br/>                .withTransitivity()<br/>                .asFile();<br/>        var war = ShrinkWrap.create(WebArchive.class)<br/>                .addAsLibraries(extraJars)<br/>                .addClasses(MultipartResource.class, RestConfig.class)<br/>                .addAsWebInfResource(EmptyAsset.INSTANCE, "beans.xml");<br/>        LOGGER.log(Level.INFO, "war deployment: {0}", new Object[]{war.toString(true)});<br/>        return war;<br/>    }<br/>    @ArquillianResource<br/>    private URL baseUrl;<br/>    Client client;<br/>    @BeforeEach<br/>    public void before() throws Exception {<br/>        LOGGER.log(Level.INFO, "baseURL: {0}", new Object[]{baseUrl.toExternalForm()});<br/>        client = ClientBuilder.newClient();<br/>        client.register(MultiPartFeature.class);<br/>    }<br/>    @AfterEach<br/>    public void after() throws Exception {<br/>        client.close();<br/>    }<br/>    @Test<br/>    @RunAsClient<br/>    public void testUploadSingleFile() throws Exception {<br/>        var target = client.target(URI.create(baseUrl.toExternalForm() + "api/multiparts/simple"));<br/>        var part = EntityPart.withName("part").fileName("test.txt")<br/>                .content(this.getClass().getResourceAsStream("/test.txt"))<br/>                .mediaType(MediaType.TEXT_PLAIN_TYPE)<br/>                .build();<br/>        var name = EntityPart.withName( "name").content("test").build();<br/>        var genericEntity = new GenericEntity&lt;List&lt;EntityPart&gt;&gt;(List.of(name, part)) {};<br/>        var entity = Entity.entity(genericEntity, MediaType.MULTIPART_FORM_DATA);<br/>        Response r = target.request(MediaType.MULTIPART_FORM_DATA).post(entity);<br/>        LOGGER.log(Level.INFO, "response status: {0}", r.getStatus());<br/>        assertEquals(200, r.getStatus());<br/>    }<br/>    @Test<br/>    @RunAsClient<br/>    public void testUploadMultiFiles() throws Exception {<br/>        var target = client.target(URI.create(baseUrl.toExternalForm() + "api/multiparts/list"));<br/>        List&lt;EntityPart&gt; parts = List.of(<br/>                EntityPart.withName("textFile").fileName("test.txt")<br/>                        .content(this.getClass().getResourceAsStream("/test.txt"))<br/>                        .mediaType(MediaType.TEXT_PLAIN_TYPE)<br/>                        .build(),<br/>                EntityPart.withName("imageFile").fileName("test.svg")<br/>                        .content(this.getClass().getResourceAsStream("/test.svg"))<br/>                        .mediaType(MediaType.APPLICATION_SVG_XML_TYPE)<br/>                        .build()<br/>        );<br/>        var genericEntity = new GenericEntity&lt;List&lt;EntityPart&gt;&gt;(parts) {};<br/>        var entity = Entity.entity(genericEntity, MediaType.MULTIPART_FORM_DATA);<br/>        Response r = target.request().post(entity);<br/>        assertEquals(200, r.getStatus());<br/>        LOGGER.log(Level.INFO, "Upload multiple files response status: {0}", r.getStatus());<br/>    }<br/>    @Test<br/>    @RunAsClient<br/>    public void testGetFiles() {<br/>        var target = client.target(URI.create(baseUrl.toExternalForm() + "api/multiparts"));<br/>        Response response = target.request().accept(MediaType.MULTIPART_FORM_DATA).get();<br/>        assertEquals(200, response.getStatus());<br/>        LOGGER.log(Level.INFO, "GetFiles response status: {0}", response.getStatus());<br/>        List&lt;EntityPart&gt; parts = response.readEntity(new GenericType&lt;List&lt;EntityPart&gt;&gt;() {});<br/>        parts.forEach(part -&gt; LOGGER.log(<br/>                Level.INFO,<br/>                "Get file: {0},{1},{2},{3}",<br/>                new Object[]{<br/>                        part.getMediaType(),<br/>                        part.getName(),<br/>                        part.getFileName(),<br/>                        part.getHeaders()<br/>                }<br/>        ));<br/>    }<br/>}</span></pre><p id="c817" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在这个测试中，有三种方法来验证上传单个文件、上传文件集合和从服务器端读取文件的功能。</p><p id="1ef3" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">运行以下命令来执行测试。</p><pre class="la lb lc ld gt mq mr ms bn mt mu bi"><span id="6113" class="mv lm iq mr b be mw mx l my mz">&gt;  mvn clean verify -Parq-glassfish-managed -D"it.test=MultipartResourceTest"<br/>...</span></pre><pre class="na mq mr nb nc aw nd bi"><span id="6a94" class="ne lm iq mr b gy nf ng l nh mz">[INFO] --- maven-failsafe-plugin:3.0.0-M7:integration-test (integration-test) @ rest-examples ---<br/>[INFO] Using auto detected provider org.apache.maven.surefire.junitplatform.JUnitPlatformProvider<br/>[INFO]<br/>[INFO] -------------------------------------------------------<br/>[INFO]  T E S T S<br/>[INFO] -------------------------------------------------------<br/>[INFO] Running com.example.it.MultipartResourceTest<br/>Starting database using command: [java, -jar, D:\hantsylabs\jakartaee10-sandbox\rest\target\glassfish7\glassfish\modules\admin-cli.jar, start-database, -t]<br/>Starting database in the background.<br/>Log redirected to D:\hantsylabs\jakartaee10-sandbox\rest\target\glassfish7\glassfish\databases\derby.log.<br/>Starting container using command: [java, -jar, D:\hantsylabs\jakartaee10-sandbox\rest\target\glassfish7\glassfish\modules\admin-cli.jar, start-domain, -t]<br/>Attempting to start domain1.... Please look at the server log for more details.....<br/>SLF4J: Failed to load class "org.slf4j.impl.StaticLoggerBinder".<br/>SLF4J: Defaulting to no-operation (NOP) logger implementation<br/>SLF4J: See <a class="ae mo" href="http://www.slf4j.org/codes.html#StaticLoggerBinder" rel="noopener ugc nofollow" target="_blank">http://www.slf4j.org/codes.html#StaticLoggerBinder</a> for further details.<br/>Dec 03, 2022 9:21:19 PM com.example.it.MultipartResourceTest createDeployment<br/>INFO: war deployment: 3ca3304d-1523-4473-bd4d-a7074b2ae48b.war:<br/>/WEB-INF/<br/>/WEB-INF/lib/<br/>/WEB-INF/lib/assertj-core-3.23.1.jar<br/>/WEB-INF/lib/byte-buddy-1.12.10.jar<br/>/WEB-INF/classes/<br/>/WEB-INF/classes/com/<br/>/WEB-INF/classes/com/example/<br/>/WEB-INF/classes/com/example/MultipartResource.class<br/>/WEB-INF/classes/com/example/RestConfig.class<br/>/WEB-INF/beans.xml<br/>Dec 03, 2022 9:21:28 PM com.example.it.MultipartResourceTest before<br/>INFO: baseURL: <a class="ae mo" href="http://localhost:8080/3ca3304d-1523-4473-bd4d-a7074b2ae48b/" rel="noopener ugc nofollow" target="_blank">http://localhost:8080/3ca3304d-1523-4473-bd4d-a7074b2ae48b/</a><br/>Dec 03, 2022 9:21:28 PM com.example.it.MultipartResourceTest testUploadSingleFile<br/>INFO: response status: 200<br/>Dec 03, 2022 9:21:28 PM com.example.it.MultipartResourceTest before<br/>INFO: baseURL: <a class="ae mo" href="http://localhost:8080/3ca3304d-1523-4473-bd4d-a7074b2ae48b/" rel="noopener ugc nofollow" target="_blank">http://localhost:8080/3ca3304d-1523-4473-bd4d-a7074b2ae48b/</a><br/>Dec 03, 2022 9:21:28 PM com.example.it.MultipartResourceTest testGetFiles<br/>INFO: GetFiles response status: 200<br/>Dec 03, 2022 9:21:28 PM com.example.it.MultipartResourceTest lambda$testGetFiles$0<br/>INFO: Get file: text/plain,abd,Optional[abc.text],{Content-Type=[text/plain], Content-Disposition=[form-data; filename="abc.text"; name="abd"]}<br/>Dec 03, 2022 9:21:28 PM com.example.it.MultipartResourceTest lambda$testGetFiles$0<br/>INFO: Get file: text/plain,test.txt,Optional[test.txt],{Content-Type=[text/plain], Content-Disposition=[form-data; filename="test.txt"; name="test.txt"]}<br/>Dec 03, 2022 9:21:28 PM com.example.it.MultipartResourceTest before<br/>INFO: baseURL: <a class="ae mo" href="http://localhost:8080/3ca3304d-1523-4473-bd4d-a7074b2ae48b/" rel="noopener ugc nofollow" target="_blank">http://localhost:8080/3ca3304d-1523-4473-bd4d-a7074b2ae48b/</a><br/>Dec 03, 2022 9:21:28 PM com.example.it.MultipartResourceTest testUploadMultiFiles<br/>INFO: Upload multiple files response status: 200<br/>[INFO] Tests run: 3, Failures: 0, Errors: 0, Skipped: 0, Time elapsed: 74.084 s - in com.example.it.MultipartResourceTest<br/>Stopping container using command: [java, -jar, D:\hantsylabs\jakartaee10-sandbox\rest\target\glassfish7\glassfish\modules\admin-cli.jar, stop-domain, --kill, -t]<br/>Stopping database using command: [java, -jar, D:\hantsylabs\jakartaee10-sandbox\rest\target\glassfish7\glassfish\modules\admin-cli.jar, stop-database, -t]<br/>Sat Dec 03 21:21:33 CST 2022 : Connection obtained for host: 0.0.0.0, port number 1527.<br/>Sat Dec 03 21:21:33 CST 2022 : Apache Derby Network Server - 10.15.2.0 - (1873585) shutdown<br/>[INFO]<br/>[INFO] Results:<br/>[INFO]<br/>[INFO] Tests run: 3, Failures: 0, Errors: 0, Skipped: 0<br/>[INFO]<br/>[INFO]<br/>[INFO] --- maven-failsafe-plugin:3.0.0-M7:verify (integration-test) @ rest-examples ---<br/>[INFO] ------------------------------------------------------------------------<br/>[INFO] BUILD SUCCESS<br/>[INFO] ------------------------------------------------------------------------<br/>[INFO] Total time:  01:44 min<br/>[INFO] Finished at: 2022-12-03T21:21:34+08:00<br/>[INFO] ------------------------------------------------------------------------</span></pre><h1 id="348a" class="ll lm iq bd ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi bi translated">定制Jsonb</h1><p id="cbf0" class="pw-post-body-paragraph jn jo iq jp b jq mj js jt ju mk jw jx jy ml ka kb kc mm ke kf kg mn ki kj kk ij bi translated">在Jaxrs 3.1中，可以定制Jsonb来调整HTTP消息的序列化和反序列化。</p><pre class="la lb lc ld gt mq mr ms bn mt mu bi"><span id="0428" class="mv lm iq mr b be mw mx l my mz">@Provider<br/>public class JsonbContextResolver implements ContextResolver&lt;Jsonb&gt; {<br/>    @Override<br/>    public Jsonb getContext(Class&lt;?&gt; type) {<br/>        JsonbConfig config = new JsonbConfig()<br/>                .withPropertyNamingStrategy(PropertyNamingStrategy.UPPER_CAMEL_CASE)<br/>                .withFormatting(true)<br/>                .withNullValues(false);<br/>        return JsonbBuilder.newBuilder().withConfig(config).build();<br/>    }<br/>}</span></pre><p id="bd30" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在配置中，我们对属性名应用<code class="fe ni nj nk mr b">UPPER_CAMEL_CASE</code>策略，格式化输出结果使其可读，并过滤掉JSON中的空节点。</p><p id="0954" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">让我们为测试目的创建一个简单的Jaxrs资源。</p><pre class="la lb lc ld gt mq mr ms bn mt mu bi"><span id="274c" class="mv lm iq mr b be mw mx l my mz">@Path("greeting")<br/>@RequestScoped<br/>public class GreetingResource {<br/><br/>@GET<br/>    @Produces(MediaType.APPLICATION_JSON)<br/>    public Response sayHello() {<br/>        var person = new GreetingRecord("Hantsy", LocalDateTime.now());<br/>        return Response.ok(person).build();<br/>    }<br/>}<br/>// GreetingRecord<br/>public record GreetingRecord(String name, LocalDateTime sentAt){}</span></pre><p id="cd42" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在GlassFish或WildFly上构建并运行应用程序，并使用<code class="fe ni nj nk mr b">curl</code>访问<code class="fe ni nj nk mr b">/greeting</code>端点。</p><pre class="la lb lc ld gt mq mr ms bn mt mu bi"><span id="bf91" class="mv lm iq mr b be mw mx l my mz">curl http://localhost:8080/rest-examples/api/greeting<br/>{<br/>    "Name": "Hantsy",<br/>    "SentAt": "2022-12-04T15:06:10.2230204"<br/>}</span></pre><p id="783f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">让我们创建一个简单的Arquillian测试来验证这个功能。</p><pre class="la lb lc ld gt mq mr ms bn mt mu bi"><span id="3da7" class="mv lm iq mr b be mw mx l my mz">@ExtendWith(ArquillianExtension.class)<br/>public class GreetingResourceTest {<br/><br/>private final static Logger LOGGER = Logger.getLogger(GreetingResourceTest.class.getName());<br/>    @Deployment(testable = false)<br/>    public static WebArchive createDeployment() {<br/>        File[] extraJars = Maven<br/>                .resolver()<br/>                .loadPomFromFile("pom.xml")<br/>                .importCompileAndRuntimeDependencies()<br/>                .resolve("org.assertj:assertj-core")<br/>                .withTransitivity()<br/>                .asFile();<br/>        var war = ShrinkWrap.create(WebArchive.class)<br/>                .addAsLibraries(extraJars)<br/>                .addClasses(GreetingResource.class, GreetingRecord.class, JsonbContextResolver.class, RestConfig.class)<br/>                .addAsWebInfResource(EmptyAsset.INSTANCE, "beans.xml");<br/>        LOGGER.log(Level.INFO, "war deployment: {0}", new Object[]{war.toString(true)});<br/>        return war;<br/>    }<br/>    @ArquillianResource<br/>    private URL baseUrl;<br/>    Client client;<br/>    @BeforeEach<br/>    public void before() throws Exception {<br/>        LOGGER.log(Level.INFO, "baseURL: {0}", new Object[]{baseUrl.toExternalForm()});<br/>        client = ClientBuilder.newClient();<br/>        //client.register(JsonbContextResolver.class);<br/>    }<br/>    @AfterEach<br/>    public void after() throws Exception {<br/>        client.close();<br/>    }<br/>    @Test<br/>    @RunAsClient<br/>    public void testGetPerson() throws Exception {<br/>        var target = client.target(URI.create(baseUrl.toExternalForm() + "api/greeting"));<br/>        Response r = target.request().accept(MediaType.APPLICATION_JSON_TYPE).get();<br/>        LOGGER.log(Level.INFO, "Get greeting response status: {0}", r.getStatus());<br/>        assertEquals(200, r.getStatus());<br/>        String jsonString = r.readEntity(String.class);<br/>        LOGGER.log(Level.INFO, "Get greeting result string: {0}", jsonString);<br/>        assertThat(jsonString).doesNotContain("email");<br/>        assertThat(jsonString).contains("Name");<br/>    }<br/>}</span></pre><p id="96f5" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">针对先前在<code class="fe ni nj nk mr b">arq-glassfish-managed</code> Maven概要文件中定义的GlassFish托管适配器运行测试。</p><pre class="la lb lc ld gt mq mr ms bn mt mu bi"><span id="ba36" class="mv lm iq mr b be mw mx l my mz">&gt; mvn clean verify -Parq-glassfish-managed -D"it.test=GreetingResourceTest"<br/>...<br/>[INFO] --- maven-failsafe-plugin:3.0.0-M7:integration-test (integration-test) @ rest-examples ---<br/>[INFO] Using auto detected provider org.apache.maven.surefire.junitplatform.JUnitPlatformProvider<br/>[INFO]<br/>[INFO] -------------------------------------------------------<br/>[INFO]  T E S T S<br/>[INFO] -------------------------------------------------------<br/>[INFO] Running com.example.it.GreetingResourceTest<br/>Starting database using command: [java, -jar, D:\hantsylabs\jakartaee10-sandbox\rest\target\glassfish7\glassfish\modules\admin-cli.jar, start-database, -t]<br/>Starting database in the background.<br/>Log redirected to D:\hantsylabs\jakartaee10-sandbox\rest\target\glassfish7\glassfish\databases\derby.log.<br/>Starting container using command: [java, -jar, D:\hantsylabs\jakartaee10-sandbox\rest\target\glassfish7\glassfish\modules\admin-cli.jar, start-domain, -t]<br/>Attempting to start domain1.... Please look at the server log for more details.....<br/>SLF4J: Failed to load class "org.slf4j.impl.StaticLoggerBinder".<br/>SLF4J: Defaulting to no-operation (NOP) logger implementation<br/>SLF4J: See http://www.slf4j.org/codes.html#StaticLoggerBinder for further details.<br/>Dec 04, 2022 3:12:58 PM com.example.it.GreetingResourceTest createDeployment<br/>INFO: war deployment: d8b12d32-3bac-4092-b30b-612bb887509f.war:<br/>/WEB-INF/<br/>/WEB-INF/lib/<br/>/WEB-INF/lib/assertj-core-3.23.1.jar<br/>/WEB-INF/lib/byte-buddy-1.12.10.jar<br/>/WEB-INF/classes/<br/>/WEB-INF/classes/com/<br/>/WEB-INF/classes/com/example/<br/>/WEB-INF/classes/com/example/GreetingResource.class<br/>/WEB-INF/classes/com/example/GreetingRecord.class<br/>/WEB-INF/classes/com/example/JsonbContextResolver.class<br/>/WEB-INF/classes/com/example/RestConfig.class<br/>/WEB-INF/beans.xml<br/>Dec 04, 2022 3:13:08 PM com.example.it.GreetingResourceTest before<br/>INFO: baseURL: http://localhost:8080/d8b12d32-3bac-4092-b30b-612bb887509f/<br/>Dec 04, 2022 3:13:08 PM com.example.it.GreetingResourceTest testGetPerson<br/>INFO: Get greeting response status: 200<br/>Dec 04, 2022 3:13:08 PM com.example.it.GreetingResourceTest testGetPerson<br/>INFO: Get greeting result string: {<br/>    "Name": "Hantsy",<br/>    "SentAt": "2022-12-04T15:13:08.4011684"<br/>}<br/>[INFO] Tests run: 1, Failures: 0, Errors: 0, Skipped: 0, Time elapsed: 66.233 s - in com.example.it.GreetingResourceTest<br/>Stopping container using command: [java, -jar, D:\hantsylabs\jakartaee10-sandbox\rest\target\glassfish7\glassfish\modules\admin-cli.jar, stop-domain, --kill, -t]<br/>Stopping database using command: [java, -jar, D:\hantsylabs\jakartaee10-sandbox\rest\target\glassfish7\glassfish\modules\admin-cli.jar, stop-database, -t]<br/>Sun Dec 04 15:13:13 CST 2022 : Connection obtained for host: 0.0.0.0, port number 1527.<br/>Sun Dec 04 15:13:14 CST 2022 : Apache Derby Network Server - 10.15.2.0 - (1873585) shutdown<br/>[INFO]<br/>[INFO] Results:<br/>[INFO]<br/>[INFO] Tests run: 1, Failures: 0, Errors: 0, Skipped: 0<br/>[INFO]<br/>[INFO]<br/>[INFO] --- maven-failsafe-plugin:3.0.0-M7:verify (integration-test) @ rest-examples ---<br/>[INFO] ------------------------------------------------------------------------<br/>[INFO] BUILD SUCCESS<br/>[INFO] ------------------------------------------------------------------------<br/>[INFO] Total time:  01:37 min<br/>[INFO] Finished at: 2022-12-04T15:13:14+08:00<br/>[INFO] ------------------------------------------------------------------------</span></pre><p id="1322" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如你所见，它如预期的那样工作。</p><h1 id="3e76" class="ll lm iq bd ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi bi translated">CDI作为注射供应商</h1><p id="9a35" class="pw-post-body-paragraph jn jo iq jp b jq mj js jt ju mk jw jx jy ml ka kb kc mm ke kf kg mn ki kj kk ij bi translated">在最初的Jaxrs 3.1提案中，一个令人兴奋的特性是使用CDI作为默认注入提供者来替换Jaxrs中现有的提供者，这意味着您可以使用<code class="fe ni nj nk mr b">Inject</code>来替换Jaxrs <code class="fe ni nj nk mr b">Context</code>来注入Jaxrs特定的资源。不幸的是，这个特性被延迟到下一个版本，并且不包括在最终的3.1版本中。</p><p id="802e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">但是Jersey本身提供了一个额外的模块来实现这个特性。</p><p id="0773" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">让我们创建一个简单的TODO Jaxrs应用程序，在<code class="fe ni nj nk mr b">/todos</code>端点公开资源。</p><p id="d64f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">首先创建一个JPA实体— <code class="fe ni nj nk mr b">Todo</code>。</p><pre class="la lb lc ld gt mq mr ms bn mt mu bi"><span id="4afd" class="mv lm iq mr b be mw mx l my mz">@Entity<br/>@Table(name = "todos")<br/>public class Todo implements Serializable {<br/><br/>    @Id<br/>    @GeneratedValue(strategy = GenerationType.UUID)<br/>    UUID id;<br/>    String title;<br/>    boolean completed = false;<br/>    // setters and getters, hashCode and equals<br/>}</span></pre><p id="f219" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">创建一个简单的EJB <code class="fe ni nj nk mr b">@Stateless</code> bean来创建Todo并检索Todo。</p><pre class="la lb lc ld gt mq mr ms bn mt mu bi"><span id="774e" class="mv lm iq mr b be mw mx l my mz">@Stateless<br/>public class TodoService {<br/><br/>    @PersistenceContext<br/>    EntityManager entityManager;<br/><br/>    @Transactional<br/>    public Todo create(Todo data) {<br/>        entityManager.persist(data);<br/>        return data;<br/>    }<br/>    public Todo findById(UUID id) {<br/>        return entityManager.find(Todo.class, id);<br/>    }<br/>    public List&lt;Todo&gt; findAll() {<br/>        return entityManager.createQuery("select t from Todo t", Todo.class).getResultList();<br/>    }<br/>}</span></pre><p id="234d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">创建一个EJB <code class="fe ni nj nk mr b">@Singleton</code> bean来初始化一些样本数据。</p><pre class="la lb lc ld gt mq mr ms bn mt mu bi"><span id="21be" class="mv lm iq mr b be mw mx l my mz">@Singleton<br/>@Startup<br/>public class TodoSamples {<br/>    private static final Logger LOGGER = Logger.getLogger(TodoSamples.class.getName());<br/>    @Inject<br/>    TodoService todoService;<br/><br/>    @PostConstruct<br/>    public void init() {<br/>        var todos = Stream.of("What's new in JPA 3.1?", "What's new in Jaxrs 3.1", "Learn new features in Faces 4.0")<br/>                .map(Todo::new)<br/>                .map(it -&gt; todoService.create(it))<br/>                .toList();<br/>        LOGGER.log(Level.INFO, "initialized todo samples: {0}", todos);<br/>    }<br/>}</span></pre><p id="4fc1" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在创建一个Jaxrs资源来公开<code class="fe ni nj nk mr b">/todos</code>端点。</p><pre class="la lb lc ld gt mq mr ms bn mt mu bi"><span id="5894" class="mv lm iq mr b be mw mx l my mz">@Path("todos")<br/>@RequestScoped<br/>public class TodoResources {<br/><br/>    @Inject<br/>    //@Context<br/>    ResourceContext resourceContext;<br/>    @Inject<br/>    // @Context<br/>    UriInfo uriInfo;<br/>    @Inject<br/>    TodoService todoService;<br/>    @GET<br/>    public Response getAllTodos() {<br/>        var todos = todoService.findAll();<br/>        return Response.ok(todos).build();<br/>    }<br/>    @POST<br/>    public Response createTodo(Todo todo) throws Exception {<br/>        var saved = todoService.create(todo);<br/>        return Response.created(uriInfo.getBaseUriBuilder().path("todos/{id}").build(saved.getId())).build();<br/>    }<br/>    @GET<br/>    @Path("{id}")<br/>    public TodoResource subResource() {<br/>        return resourceContext.getResource(TodoResource.class);<br/>    }<br/>}<br/><br/>// TodoResource for single resource.<br/>@RequestScoped<br/>public class TodoResource {<br/>    @Inject<br/>    TodoService todoService;<br/>    @PathParam("id")<br/>    UUID id;<br/>    @GET<br/>    public Response getById() {<br/>        var todos = todoService.findById(id);<br/>        return Response.ok(todos).build();<br/>    }<br/>}</span></pre><p id="f24e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">为了确保它在GlassFish上工作，将<code class="fe ni nj nk mr b">jersey-cdi-rs-inject</code>复制到GlassFish<em class="mp">GlassFish _ install dir/GlassFish/modules</em>文件夹。</p><p id="418e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">只需将下面的片段添加到<code class="fe ni nj nk mr b">glassfish</code>概要文件中，并使用<code class="fe ni nj nk mr b">maven-dependency-plugin</code>将<code class="fe ni nj nk mr b">jersey-cdi-rs-inject</code>的副本下载到cargo managed GlassFish实例中。</p><pre class="la lb lc ld gt mq mr ms bn mt mu bi"><span id="1b68" class="mv lm iq mr b be mw mx l my mz">&lt;plugin&gt;<br/>    &lt;groupId&gt;org.apache.maven.plugins&lt;/groupId&gt;<br/>    &lt;artifactId&gt;maven-dependency-plugin&lt;/artifactId&gt;<br/>    &lt;version&gt;${maven-dependency-plugin.version}&lt;/version&gt;<br/>    &lt;executions&gt;<br/>        &lt;execution&gt;<br/>            &lt;id&gt;copy&lt;/id&gt;<br/>            &lt;phase&gt;process-classes&lt;/phase&gt;<br/>            &lt;goals&gt;<br/>                &lt;goal&gt;copy&lt;/goal&gt;<br/>            &lt;/goals&gt;<br/>            &lt;configuration&gt;<br/>                &lt;artifactItems&gt;<br/>                    &lt;artifactItem&gt;<br/>                        &lt;groupId&gt;org.glassfish.jersey.ext.cdi&lt;/groupId&gt;<br/>                        &lt;artifactId&gt;jersey-cdi-rs-inject&lt;/artifactId&gt;<br/>                        &lt;version&gt;${jersey.version}&lt;/version&gt;<br/>                        &lt;type&gt;jar&lt;/type&gt;<br/>                        &lt;overWrite&gt;false&lt;/overWrite&gt;<br/>                    &lt;/artifactItem&gt;<br/>                &lt;/artifactItems&gt;<br/>                &lt;outputDirectory&gt;${project.build.directory}/cargo/installs/glassfish-${glassfish.version}/glassfish7/glassfish/modules&lt;/outputDirectory&gt;<br/>            &lt;/configuration&gt;<br/>        &lt;/execution&gt;<br/>    &lt;/executions&gt;<br/>&lt;/plugin&gt;</span></pre><p id="1dab" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">构建并运行应用程序，并使用<code class="fe ni nj nk mr b">curl</code>来测试我们的端点<code class="fe ni nj nk mr b">/todos</code>。</p><pre class="la lb lc ld gt mq mr ms bn mt mu bi"><span id="893a" class="mv lm iq mr b be mw mx l my mz">&gt; curl http://localhost:8080/rest-examples/api/todos<br/>[<br/>    {<br/>        "Completed": false,<br/>        "Id": "7db8cb74-6ec6-4b3b-8930-e6a29a9c363a",<br/>        "Title": "Learn new features in Faces 4.0"<br/>    },<br/>    {<br/>        "Completed": false,<br/>        "Id": "0dba2afd-943f-42a2-b1bd-2cd9fea3a140",<br/>        "Title": "What's new in JPA 3.1?"<br/>    },<br/>    {<br/>        "Completed": false,<br/>        "Id": "ff7ac837-fe68-4d47-b79d-f11fd87fd43a",<br/>        "Title": "What's new in Jaxrs 3.1"<br/>    }<br/>]</span></pre><p id="a198" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">创建一个简单的Arquillian测试来验证功能。</p><pre class="la lb lc ld gt mq mr ms bn mt mu bi"><span id="e3a4" class="mv lm iq mr b be mw mx l my mz">@ExtendWith(ArquillianExtension.class)<br/>public class TodoResourceTest {<br/><br/>    private final static Logger LOGGER = Logger.getLogger(TodoResourceTest.class.getName());<br/>    @Deployment(testable = false)<br/>    public static WebArchive createDeployment() {<br/>        File[] extraJars = Maven<br/>                .resolver()<br/>                .loadPomFromFile("pom.xml")<br/>                .importCompileAndRuntimeDependencies()<br/>                .resolve("org.assertj:assertj-core")<br/>                .withTransitivity()<br/>                .asFile();<br/>        var war = ShrinkWrap.create(WebArchive.class)<br/>                .addAsLibraries(extraJars)<br/>                .addClasses(<br/>                        TodoResource.class,<br/>                        TodoResources.class,<br/>                        TodoService.class,<br/>                        Todo.class,<br/>                        TodoSamples.class,<br/>                        RestConfig.class<br/>                )<br/>                .addAsResource("test-persistence.xml", "META-INF/persistence.xml")<br/>                .addAsWebInfResource(EmptyAsset.INSTANCE, "beans.xml");<br/>        LOGGER.log(Level.INFO, "war deployment: {0}", new Object[]{war.toString(true)});<br/>        return war;<br/>    }<br/>    @ArquillianResource<br/>    private URL baseUrl;<br/>    Client client;<br/>    @BeforeEach<br/>    public void before() throws Exception {<br/>        LOGGER.log(Level.INFO, "baseURL: {0}", new Object[]{baseUrl.toExternalForm()});<br/>        client = ClientBuilder.newClient();<br/>    }<br/>    @AfterEach<br/>    public void after() throws Exception {<br/>        client.close();<br/>    }<br/>    @Test<br/>    @RunAsClient<br/>    public void testGetTodos() throws Exception {<br/>        var target = client.target(URI.create(baseUrl.toExternalForm() + "api/todos"));<br/>        Response r = target.request().accept(MediaType.APPLICATION_JSON_TYPE).get();<br/>        LOGGER.log(Level.INFO, "Get /todos response status: {0}", r.getStatus());<br/>        assertEquals(200, r.getStatus());<br/>        String jsonString = r.readEntity(String.class);<br/>        LOGGER.log(Level.INFO, "Get /todos result string: {0}", jsonString);<br/>    }<br/>}</span></pre><p id="68bb" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">为了让测试在GlassFish上成功运行，类似地将<code class="fe ni nj nk mr b">jersey-cdi-rs-inject</code>复制到目标GlassFish服务器。</p><p id="144b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在<code class="fe ni nj nk mr b">arq-glassfish-managed</code> Maven profile中，找到<code class="fe ni nj nk mr b">dependency-maven-plugin</code> config，在<code class="fe ni nj nk mr b">configuration</code>部分的末尾添加以下内容。</p><pre class="la lb lc ld gt mq mr ms bn mt mu bi"><span id="4021" class="mv lm iq mr b be mw mx l my mz">&lt;execution&gt;<br/>    &lt;id&gt;copy&lt;/id&gt;<br/>    &lt;phase&gt;pre-integration-test&lt;/phase&gt;<br/>    &lt;goals&gt;<br/>        &lt;goal&gt;copy&lt;/goal&gt;<br/>    &lt;/goals&gt;<br/>    &lt;configuration&gt;<br/>        &lt;artifactItems&gt;<br/>            &lt;artifactItem&gt;<br/>                &lt;groupId&gt;org.glassfish.jersey.ext.cdi&lt;/groupId&gt;<br/>                &lt;artifactId&gt;jersey-cdi-rs-inject&lt;/artifactId&gt;<br/>                &lt;version&gt;${jersey.version}&lt;/version&gt;<br/>                &lt;type&gt;jar&lt;/type&gt;<br/>                &lt;overWrite&gt;false&lt;/overWrite&gt;<br/>            &lt;/artifactItem&gt;<br/>        &lt;/artifactItems&gt;<br/>        &lt;outputDirectory&gt;${project.build.directory}/glassfish7/glassfish/modules&lt;/outputDirectory&gt;<br/>    &lt;/configuration&gt;<br/>&lt;/execution&gt;</span></pre><p id="1e6a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">然后运行<code class="fe ni nj nk mr b">TodoResourceTest</code>测试。</p><pre class="la lb lc ld gt mq mr ms bn mt mu bi"><span id="0b53" class="mv lm iq mr b be mw mx l my mz">&gt; mvn clean verify -Parq-glassfish-managed -D"it.test=TodoResourceTest"<br/>...<br/>[INFO] --- maven-failsafe-plugin:3.0.0-M7:integration-test (integration-test) @ rest-examples ---<br/>[INFO] Using auto detected provider org.apache.maven.surefire.junitplatform.JUnitPlatformProvider<br/>[INFO]<br/>[INFO] -------------------------------------------------------<br/>[INFO]  T E S T S<br/>[INFO] -------------------------------------------------------<br/>[INFO] Running com.example.it.TodoResourceTest<br/>Starting database using command: [java, -jar, D:\hantsylabs\jakartaee10-sandbox\rest\target\glassfish7\glassfish\modules\admin-cli.jar, start-database, -t]<br/>Starting database in the background.<br/>Log redirected to D:\hantsylabs\jakartaee10-sandbox\rest\target\glassfish7\glassfish\databases\derby.log.<br/>Starting container using command: [java, -jar, D:\hantsylabs\jakartaee10-sandbox\rest\target\glassfish7\glassfish\modules\admin-cli.jar, start-domain, -t]<br/>Attempting to start domain1.... Please look at the server log for more details.....<br/>SLF4J: Failed to load class "org.slf4j.impl.StaticLoggerBinder".<br/>SLF4J: Defaulting to no-operation (NOP) logger implementation<br/>SLF4J: See http://www.slf4j.org/codes.html#StaticLoggerBinder for further details.<br/>Dec 04, 2022 5:09:02 PM com.example.it.TodoResourceTest createDeployment<br/>INFO: war deployment: 4a77aebc-2b83-44e6-9ab0-f93e656e1b2c.war:<br/>/WEB-INF/<br/>/WEB-INF/lib/<br/>/WEB-INF/lib/assertj-core-3.23.1.jar<br/>/WEB-INF/lib/byte-buddy-1.12.10.jar<br/>/WEB-INF/classes/<br/>/WEB-INF/classes/com/<br/>/WEB-INF/classes/com/example/<br/>/WEB-INF/classes/com/example/TodoResource.class<br/>/WEB-INF/classes/com/example/TodoResources.class<br/>/WEB-INF/classes/com/example/TodoService.class<br/>/WEB-INF/classes/com/example/Todo.class<br/>/WEB-INF/classes/com/example/TodoSamples.class<br/>/WEB-INF/classes/com/example/RestConfig.class<br/>/WEB-INF/classes/META-INF/<br/>/WEB-INF/classes/META-INF/persistence.xml<br/>/WEB-INF/beans.xml<br/>Dec 04, 2022 5:09:15 PM com.example.it.TodoResourceTest before<br/>INFO: baseURL: http://localhost:8080/4a77aebc-2b83-44e6-9ab0-f93e656e1b2c/<br/>Dec 04, 2022 5:09:16 PM com.example.it.TodoResourceTest testGetTodos<br/>INFO: Get /todos response status: 200<br/>Dec 04, 2022 5:09:16 PM com.example.it.TodoResourceTest testGetTodos<br/>INFO: Get /todos result string: [{"completed":false,"id":"6686c811-71cb-40aa-a38a-24d775c679ba","title":"Learn new features in Faces 4.0"},{"completed":false,"id":"8efb7123-0c43-46aa-aabc-0777494be620","title":"What's new in JPA 3.1?"},{"completed":false,"id":"0478a20e-b8c1-4577-91e4-cc0362ab14d5","title":"What's new in Jaxrs 3.1"}]<br/>[INFO] Tests run: 1, Failures: 0, Errors: 0, Skipped: 0, Time elapsed: 78.438 s - in com.example.it.TodoResourceTest<br/>Stopping container using command: [java, -jar, D:\hantsylabs\jakartaee10-sandbox\rest\target\glassfish7\glassfish\modules\admin-cli.jar, stop-domain, --kill, -t]<br/>Stopping database using command: [java, -jar, D:\hantsylabs\jakartaee10-sandbox\rest\target\glassfish7\glassfish\modules\admin-cli.jar, stop-database, -t]<br/>Sun Dec 04 17:09:20 CST 2022 : Connection obtained for host: 0.0.0.0, port number 1527.<br/>Sun Dec 04 17:09:20 CST 2022 : Apache Derby Network Server - 10.15.2.0 - (1873585) shutdown<br/>[INFO]<br/>[INFO] Results:<br/>[INFO]<br/>[INFO] Tests run: 1, Failures: 0, Errors: 0, Skipped: 0<br/>[INFO]<br/>[INFO]<br/>[INFO] --- maven-failsafe-plugin:3.0.0-M7:verify (integration-test) @ rest-examples ---<br/>[INFO] ------------------------------------------------------------------------<br/>[INFO] BUILD SUCCESS<br/>[INFO] ------------------------------------------------------------------------<br/>[INFO] Total time:  01:45 min<br/>[INFO] Finished at: 2022-12-04T17:09:21+08:00<br/>[INFO] ------------------------------------------------------------------------</span></pre><p id="4fb4" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">从我的Github账户中获取<a class="ae mo" href="https://github.com/hantsy/jakartaee10-sandbox/blob/master/rest/" rel="noopener ugc nofollow" target="_blank">样本代码</a>。</p></div></div>    
</body>
</html>