<html>
<head>
<title>AWS CDK for EKS — Handling Helm Charts</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">EKS自动气象站CDK-操纵舵图</h1>
<blockquote>原文：<a href="https://itnext.io/aws-cdk-for-eks-handling-helm-charts-aa002afedde4?source=collection_archive---------4-----------------------#2021-05-20">https://itnext.io/aws-cdk-for-eks-handling-helm-charts-aa002afedde4?source=collection_archive---------4-----------------------#2021-05-20</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="1a01" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在之前的一篇文章中，我简要介绍了如何使用AWS云开发工具包(CDK)和Java来构建亚马逊EKS集群，并使用Kubernetes (k8s)清单来安装资源。在这篇文章中，我将看看自动气象站CDK如何处理舵图。</p><h1 id="81ea" class="km kn iq bd ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj bi translated">舵</h1><p id="25bf" class="pw-post-body-paragraph jn jo iq jp b jq lk js jt ju ll jw jx jy lm ka kb kc ln ke kf kg lo ki kj kk ij bi translated">根据<a class="ae kl" href="https://helm.sh/" rel="noopener ugc nofollow" target="_blank">舵手文档记载</a>舵手是:</p><blockquote class="lp lq lr"><p id="6292" class="jn jo ls jp b jq jr js jt ju jv jw jx lt jz ka kb lu kd ke kf lv kh ki kj kk ij bi translated">Kubernetes的包管理器</p></blockquote><p id="1574" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">文件继续写道:</p><blockquote class="lp lq lr"><p id="c0d8" class="jn jo ls jp b jq jr js jt ju jv jw jx lt jz ka kb lu kd ke kf lv kh ki kj kk ij bi translated">Helm是查找、共享和使用为Kubernetes构建的软件的最佳方式。</p></blockquote><p id="a234" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">Helm是一个成熟的应用程序，是云本地计算基金会(CNCF)的<a class="ae kl" href="https://www.cncf.io/projects/" rel="noopener ugc nofollow" target="_blank">毕业项目</a>。有了helm charts，k8s用户可以轻松地<em class="ls">创建、版本化、共享和发布运行在k8s上的</em>软件。</p><h1 id="6cc1" class="km kn iq bd ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj bi translated">图表</h1><p id="7816" class="pw-post-body-paragraph jn jo iq jp b jq lk js jt ju ll jw jx jy lm ka kb kc ln ke kf kg lo ki kj kk ij bi translated">头盔包被称为图表。</p><blockquote class="lp lq lr"><p id="1418" class="jn jo ls jp b jq jr js jt ju jv jw jx lt jz ka kb lu kd ke kf lv kh ki kj kk ij bi translated">Helm使用一种叫做图表的打包格式。图表是描述一组相关Kubernetes资源的文件集合。一个图表可以用来部署简单的东西，比如memcached pod，或者复杂的东西，比如带有HTTP服务器、数据库、缓存等的完整web应用程序堆栈。</p></blockquote><figure class="lx ly lz ma gt mb gh gi paragraph-image"><div class="gh gi lw"><img src="../Images/b37009704685bd9ad01e8022f89b8417.png" data-original-src="https://miro.medium.com/v2/resize:fit:668/format:webp/1*OHLVAvuqpObI3pWxOIyPTQ.png"/></div><figcaption class="me mf gj gh gi mg mh bd b be z dk translated">舵图文件系统布局</figcaption></figure><p id="7127" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">图表很酷的一点是，它们可以用于跨k8s集群安装资源；它们不限于单个名称空间。而且，这些资源都与正在安装的软件包的范围和版本相关。</p><p id="90a7" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">尽管图表包括其他部分，但它们主要由模板文件和值文件组成。以下示例显示了k8s服务的模板文件。</p><pre class="lx ly lz ma gt mi mj mk ml aw mm bi"><span id="8802" class="mn kn iq mj b gy mo mp l mq mr">kind: Service<br/>apiVersion: v1<br/>metadata:<br/>  name: {{ .Values.service.name }}<br/>  namespace: {{ .Values.service.namespace }}<br/>  labels: {{ toYaml .Values.service.labels | nindent 4 }}<br/>  {{- if .Values.service.annotations }}<br/>  annotations:<br/>    {{- toYaml .Values.service.annotations | nindent 4 }}<br/>  {{- end }}<br/>spec:<br/>  ports:<br/>    - port: {{ .Values.service.port }}<br/>      targetPort: {{ .Values.service.targetPort }}<br/>      protocol: TCP<br/>      name: http<br/>  type: {{ .Values.service.type }}<br/>  selector: {{ toYaml .Values.service.selector | nindent 4 }}</span></pre><p id="fe0f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">模板和值背后的思想是配置既统一又灵活。模板中提供了基本配置；这减少了图表实例之间的<em class="ls">无差别重载</em>。值文件提供了定制点；用户可以提供自己的配置元素来自定义安装到集群的软件包。这也遵循了12因素应用程序方法学的<a class="ae kl" href="https://12factor.net/config" rel="noopener ugc nofollow" target="_blank">配置实践。下面的清单是<em class="ls">值</em>文件的一部分，它允许用户定制图表安装的服务。</a></p><pre class="lx ly lz ma gt mi mj mk ml aw mm bi"><span id="5cc0" class="mn kn iq mj b gy mo mp l mq mr">service:<br/>  name: readonly<br/>  namespace: readonly<br/>  type: LoadBalancer<br/>  port: 80<br/>  targetPort: 8080<br/>  labels: {owner: "jimmy", env: "dev", app: "readonly"}<br/>  selector: {app: "readonly"}<br/>  annotations: {service.beta.kubernetes.io/load-balancer-source-ranges: "10.0.0.1/32,192.168.0.1/32"}</span></pre><p id="150a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">前面的YAML文件使用<a class="ae kl" href="https://yaml.org/spec/1.2/spec.html#Flow" rel="noopener ugc nofollow" target="_blank">流样式</a>，通过显式指示器使其成为可能；这使得YAML更少依赖空白和缩进。为了使用这个标记，在模板中使用了<em class="ls"> toYaml </em>函数。</p><pre class="lx ly lz ma gt mi mj mk ml aw mm bi"><span id="d29d" class="mn kn iq mj b gy mo mp l mq mr">labels: {{ toYaml .Values.service.labels | nindent 4 }}</span></pre><p id="256f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><em class="ls"> toYaml </em>函数将格式转换为Yaml，结果通过管道传递给<em class="ls"> nindent </em>函数，在换行符后将元素缩进4个空格。如下面的代码片段所示，由<em class="ls">helm template readonly-go-http</em>命令创建，YAML输出由模板和值组成。</p><pre class="lx ly lz ma gt mi mj mk ml aw mm bi"><span id="7e64" class="mn kn iq mj b gy mo mp l mq mr">kind: Service<br/>apiVersion: v1<br/>metadata:<br/>  name: readonly<br/>  namespace: readonly<br/>  labels:<br/>    app: readonly<br/>    env: dev<br/>    owner: jimmy<br/>  annotations:<br/>    service.beta.kubernetes.io/load-balancer-source-ranges: 10.0.0.1/32,192.168.0.1/32<br/>spec:<br/>  ports:<br/>    - port: 80<br/>      targetPort: 8080<br/>      protocol: TCP<br/>      name: http<br/>  type: LoadBalancer<br/>  selector:<br/>    app: readonly</span></pre><p id="2a49" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><em class="ls">舵模板</em>命令非常方便地验证舵图表模板和值的输出。使用<em class="ls"> kubectl apply </em>命令可以将该输出直接应用到Kubernetes集群。</p><p id="cb51" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">K8s用户通常通过<em class="ls"> helm install </em>命令安装图表，如下例所示。</p><pre class="lx ly lz ma gt mi mj mk ml aw mm bi"><span id="bc5e" class="mn kn iq mj b gy mo mp l mq mr">helm install readonly jimmy-charts/readonly-go-http --debug -f readonly-go-http/values.yaml</span></pre><p id="f5c3" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在前面的例子中，<em class="ls"> readonly </em>是安装的k8s包的名称。这是程序包在群集上的名称。<em class="ls">Jimmy-charts/readonly-go-http</em>参数是用于安装实例的helm存储库和图表。在正常操作中通常不使用<em class="ls"> — debug </em>参数，但是当图表没有正确安装时，它很有用。<em class="ls">-f readonly-go-http/values . YAML</em>是k8s用户提供自定义值的文件。</p><h1 id="10b5" class="km kn iq bd ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj bi translated">带自动气象站CDK的舵图</h1><p id="b014" class="pw-post-body-paragraph jn jo iq jp b jq lk js jt ju ll jw jx jy lm ka kb kc ln ke kf kg lo ki kj kk ij bi translated">将helm与AWS CDK一起使用类似于k8s清单的处理方式。以下示例使用了<em class="ls"> HelmChart。构建器</em>对象为由<em class="ls"> cdk synth </em>和<em class="ls"> cdk deploy </em>命令生成的AWS CloudFormation模板构建舵图条目。</p><pre class="lx ly lz ma gt mi mj mk ml aw mm bi"><span id="d6e3" class="mn kn iq mj b gy mo mp l mq mr">HelmChart.Builder.create(this, "readonly")<br/>                .cluster(cluster)<br/>                .chart("readonly-go-http")<br/>                .repository("<a class="ae kl" href="https://git-helm.jimmyray.io" rel="noopener ugc nofollow" target="_blank">https://git-helm.jimmyray.io</a>")<br/>                .values(YamlParser.parse(readonlyValues))<br/>                .createNamespace(false)<br/>                .version("0.1.1")<br/>                .build();</span></pre><p id="1daf" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><em class="ls">集群</em>参数指向安装了舵轮图的集群对象。<em class="ls">图表</em>参数是存储在舵图表存储库中的舵图表的名称:<a class="ae kl" href="https://git-helm.jimmyray.io" rel="noopener ugc nofollow" target="_blank">https://git-helm . Jimmy ray . io</a>。values参数是经过解析的YAML值字符串。最后，<em class="ls">版本</em>参数指向舵图版本。</p><h1 id="b951" class="km kn iq bd ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj bi translated">价值观念</h1><p id="6755" class="pw-post-body-paragraph jn jo iq jp b jq lk js jt ju ll jw jx jy lm ka kb kc ln ke kf kg lo ki kj kk ij bi translated">final Values类将值YAML文件存储在最终的Java文本块字符串中。如前一篇文章所述，这个YAML文件可以存储在一个外部文件中，并用Java <em class="ls"> FileReader </em>或<em class="ls"> InputStream </em>读取。</p><pre class="lx ly lz ma gt mi mj mk ml aw mm bi"><span id="f8ad" class="mn kn iq mj b gy mo mp l mq mr">public final class Values {<br/>    public static final String readonlyValues = """<br/>            namespace:<br/>              name: readonly<br/>              labels: {owner: "jimmy",env: "dev",app: "readonly"}<br/>                        <br/>            service:<br/>              name: readonly<br/>              namespace: readonly<br/>              type: LoadBalancer<br/>              port: 80<br/>              targetPort: 8080<br/>              labels: {owner: "jimmy", env: "dev", app: "readonly"}<br/>              selector: {app: "readonly"}<br/>              annotations: {service.beta.kubernetes.io/load-balancer-source-ranges: "10.0.0.1/32,192.168.0.1/32"}<br/>...<br/>             """;<br/>...</span></pre><p id="5973" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><em class="ls"> YamlParse.parse(…) </em>方法解析YAML值，并将其作为<a class="ae kl" href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/template-custom-resources.html" rel="noopener ugc nofollow" target="_blank"> AWS CloudFormation自定义资源</a>提供给堆栈。下面的片段来自<em class="ls"> cdk synth </em>命令输出。</p><pre class="lx ly lz ma gt mi mj mk ml aw mm bi"><span id="2afe" class="mn kn iq mj b gy mo mp l mq mr">readonly40AF6D61:<br/>    Type: Custom::AWSCDK-EKS-HelmChart<br/>...<br/>      Chart: readonly-go-http<br/>      Version: 0.1.1<br/>      Values: '{"namespace":{"name":"readonly","labels":{"owner":"jimmy","env":"dev","app":"readonly"}},"service":{"name":"readonly","namespace":"readonly","type":"LoadBalancer","port":80,"targetPort":8080,"labels":{"owner":"jimmy","env":"dev","app":"readonly"},"selector":{"app":"readonly"},"annotations":{"service.beta.kubernetes.io/load-balancer-source-ranges":"10.0.0.1/32,192.168.0.1/32"}},"deployment":{"name":"readonly","namespace":"readonly","labels":{"owner":"jimmy","env":"dev","app":"readonly"},"matchLabels":{"app":"readonly"},"revisionHistoryLimit":3,"podSecurityContext":{"fsGroup":2000},"replicaCount":3,"podTemplateLabels":{"owner":"jimmy","env":"dev","app":"readonly"},"containerName":"readonly","image":{"repository":"public.ecr.aws/r2l1x4g2/go-http-server","pullPolicy":"IfNotPresent","tag":"v0.1.0-23ffe0a715"},"securityContext":{"capabilities":{"drop":["ALL"]},"readOnlyRootFilesystem":true,"runAsNonRoot":true,"runAsUser":1000,"allowPrivilegeEscalation":false},"resources":{"limits":{"cpu":"200m","memory":"20Mi"},"requests":{"cpu":"100m","memory":"10Mi"}},"readinessProbe":{"tcpSocket":{"port":8080},"initialDelaySeconds":5,"periodSeconds":10},"livenessProbe":{"tcpSocket":{"port":8080},"initialDelaySeconds":15,"periodSeconds":20},"ports":[{"containerPort":8080}]}}'<br/>...</span></pre><p id="02a8" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">像AWS CDK处理k8s清单一样，helm图表是在部署过程中创建的，由<em class="ls"> cdk deploy </em>启动，使用AWS CDK资产。提醒一下，在<em class="ls"> cdk引导</em>操作期间，这些资产被安装在<em class="ls"> CDKToolkit </em>堆栈中。CDkToolkit提供了helm处理程序，使<em class="ls"> helm </em>通过<a class="ae kl" href="https://aws.amazon.com/lambda/" rel="noopener ugc nofollow" target="_blank"> AWS Lambda </a>调用目标集群。</p><p id="c35a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">已安装的helm chart包含<em class="ls"> readonly </em>包，包括<em class="ls">名称空间</em>、<em class="ls">部署</em>和<em class="ls">服务</em>资源，以及应用<em class="ls">部署</em>隐式创建的<a class="ae kl" href="https://kubernetes.io/docs/concepts/workloads/controllers/replicaset/" rel="noopener ugc nofollow" target="_blank"> <em class="ls">复制集</em> </a>资源。最后，还有一个由Kubernetes AWS云提供商创建的AWS经典负载平衡器(ELB)。</p><pre class="lx ly lz ma gt mi mj mk ml aw mm bi"><span id="15cf" class="mn kn iq mj b gy mo mp l mq mr">k get all -n readonly</span></pre><figure class="lx ly lz ma gt mb gh gi paragraph-image"><div role="button" tabindex="0" class="mt mu di mv bf mw"><div class="gh gi ms"><img src="../Images/890f7bf1939a26ef6bdf8336dcb5f135.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*jM7NypLvjZTfzGjsouD6Qg.png"/></div></div><figcaption class="me mf gj gh gi mg mh bd b be z dk translated">舵图安装程序包</figcaption></figure><p id="7ad9" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">ELB配备了一个AWS安全组，其入站规则与在<em class="ls">service.beta.kubernetes.io/load-balancer-source-ranges</em>注释中提供的CIDR范围相匹配。</p><figure class="lx ly lz ma gt mb gh gi paragraph-image"><div role="button" tabindex="0" class="mt mu di mv bf mw"><div class="gh gi mx"><img src="../Images/7e976c3e650787397ab318144f164ff2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ZNykDYv50IjeNvnQw2YqMQ.png"/></div></div><figcaption class="me mf gj gh gi mg mh bd b be z dk translated">ELB安全组入站规则</figcaption></figure><h1 id="cb1a" class="km kn iq bd ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj bi translated">摘要</h1><p id="af24" class="pw-post-body-paragraph jn jo iq jp b jq lk js jt ju ll jw jx jy lm ka kb kc ln ke kf kg lo ki kj kk ij bi translated">AWS CDK处理舵图并创建AWS云形成资源，以将包作为Kubernetes资源来应用。这些软件包的应用由AWS CDK引导操作安装的AWS Lambda资产处理。有了AWS CDK，k8s开发者可以使用他们已经熟悉的工具(比如Java)在云中构建。这种对多种语言的开放性提高了采用率，并降低了云开发人员的准入门槛。</p><p id="1f9a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><em class="ls">这个帖子的示例代码可以从这个</em><a class="ae kl" href="https://github.com/jimmyraywv/aws-cdk-eks" rel="noopener ugc nofollow" target="_blank"><em class="ls">GitHub repo</em></a><em class="ls">中得到。</em></p><p id="3064" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><em class="ls">掌舵人图表详见本</em> <a class="ae kl" href="https://github.com/jimmyraywv/helm-charts" rel="noopener ugc nofollow" target="_blank"> <em class="ls"> GitHub回购</em> </a> <em class="ls">。</em></p></div></div>    
</body>
</html>