<html>
<head>
<title>Files upload from Kubeless on MicroK8s to Minio</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">文件从MicroK8s上的Kubeless上传到Minio</h1>
<blockquote>原文：<a href="https://itnext.io/files-upload-from-kubeless-on-microk8s-to-minio-607e06598a4b?source=collection_archive---------4-----------------------#2019-01-07">https://itnext.io/files-upload-from-kubeless-on-microk8s-to-minio-607e06598a4b?source=collection_archive---------4-----------------------#2019-01-07</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="cbda" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">无服务器上传到对象存储</p><p id="fd57" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在这篇文章中，我将演示如何编写一个简单的python函数，它将从<a class="ae kl" href="https://unsplash.com/" rel="noopener ugc nofollow" target="_blank"> <strong class="jp ir"> Unsplash </strong> </a>下载一个图像，并上传到<a class="ae kl" href="https://github.com/minio/minio" rel="noopener ugc nofollow" target="_blank"> <strong class="jp ir"> Minio </strong>，</a> S3兼容对象存储器。</p><p id="b89c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">要跟踪和执行本文中的代码，您需要MicroK8s、Kubeless和Python3。你可以在我的文章中阅读关于MicroK8s的无服务器介绍:</p><div class="km kn gp gr ko kp"><a href="https://medium.com/@bluszcz/serverless-microk8s-kubernetes-fcd6b875cd33" rel="noopener follow" target="_blank"><div class="kq ab fo"><div class="kr ab ks cl cj kt"><h2 class="bd ir gy z fp ku fr fs kv fu fw ip bi translated">无服务器MicroK8s Kubernetes</h2><div class="kw l"><h3 class="bd b gy z fp ku fr fs kv fu fw dk translated">在基于Snap的Kubernetes集群上安装Kubeless和裂变</h3></div><div class="kx l"><p class="bd b dl z fp ku fr fs kv fu fw dk translated">medium.com</p></div></div><div class="ky l"><div class="kz l la lb lc ky ld le kp"/></div></div></a></div><h1 id="1001" class="lf lg iq bd lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc bi translated">不溅</h1><p id="a704" class="pw-post-body-paragraph jn jo iq jp b jq md js jt ju me jw jx jy mf ka kb kc mg ke kf kg mh ki kj kk ij bi translated">Unsplash是一个非常受欢迎的营销服务；-) —免费提供数千张免版税照片。</p><p id="e558" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果您没有Unsplash帐户，请<a class="ae kl" href="https://unsplash.com/join" rel="noopener ugc nofollow" target="_blank">创建一个</a>。</p><figure class="mj mk ml mm gt mn gh gi paragraph-image"><div role="button" tabindex="0" class="mo mp di mq bf mr"><div class="gh gi mi"><img src="../Images/3de01511048db4d4a5af67e34ccde517.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*9Ukb3eWBZMf9Bd3Ss-s25A.png"/></div></div></figure><p id="2ddd" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">接下来，注册一个新的应用程序:<a class="ae kl" href="https://unsplash.com/oauth/applications/new." rel="noopener ugc nofollow" target="_blank">https://unsplash.com/oauth/applications/new.</a></p><figure class="mj mk ml mm gt mn gh gi paragraph-image"><div role="button" tabindex="0" class="mo mp di mq bf mr"><div class="gh gi mt"><img src="../Images/9fe36bcae15b994e76c8f9cfa70dec9b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*wnnkdNb1xEfJy_f2Q9uCJw.png"/></div></div><figcaption class="mu mv gj gh gi mw mx bd b be z dk translated">在Unsplash中注册新应用程序</figcaption></figure><p id="ba62" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">此后，您将收到您的访问密钥(我们稍后会用到):</p><figure class="mj mk ml mm gt mn gh gi paragraph-image"><div role="button" tabindex="0" class="mo mp di mq bf mr"><div class="gh gi my"><img src="../Images/e3c387c60cced155ef60a698bb705251.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*aGHD7HAZP_JZpUIq5pkh5g.png"/></div></div><figcaption class="mu mv gj gh gi mw mx bd b be z dk translated">API凭据。</figcaption></figure><p id="4177" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们可以通过先执行<strong class="jp ir"> <em class="mz">卷曲</em> </strong>命令，再执行<strong class="jp ir"> <em class="mz"> jq </em> </strong>命令来验证钥匙是否工作:</p><pre class="mj mk ml mm gt na nb nc nd aw ne bi"><span id="12c1" class="nf lg iq nb b gy ng nh l ni nj">$ export UNSPLASH_ACCESS_KEY="..."<br/>$ curl -s <a class="ae kl" href="https://api.unsplash.com/photos/\?client_id\=$UNSPLASH_ACCESS_KEY" rel="noopener ugc nofollow" target="_blank">https://api.unsplash.com/photos/\?client_id\=$UNSPLASH_ACCESS_KEY</a> |jq '.[0] |{desc: .description}'<br/>{<br/>  "desc": "5 bottles of DOSE Juice on a shelf"<br/>}</span></pre><h1 id="82a2" class="lf lg iq bd lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc bi translated">米尼奥</h1><p id="2cff" class="pw-post-body-paragraph jn jo iq jp b jq md js jt ju me jw jx jy mf ka kb kc mg ke kf kg mh ki kj kk ij bi translated">Minio是一个开源对象存储服务器，与S3兼容。一个有趣的特性是，它还可以充当其他对象存储系统之间的网关。</p><p id="7139" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们可以使用Kubernetes安装Minio，但是在我们需要准备一个持久卷之前:</p><pre class="mj mk ml mm gt na nb nc nd aw ne bi"><span id="17ee" class="nf lg iq nb b gy ng nh l ni nj">$ cat pv.yaml <br/>kind: PersistentVolume<br/>apiVersion: v1<br/>metadata:<br/>  name: task-pv-volume<br/>  labels:<br/>    type: local<br/>spec:<br/>  storageClassName: standard<br/>  capacity:<br/>    storage: 10Gi<br/>  accessModes:<br/>    - ReadWriteOnce<br/>  hostPath:<br/>    path: "/tmp/data"</span></pre><p id="c80b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">接下来，我为这里生成了yaml文件:Minio<a class="ae kl" href="https://www.minio.io/kubernetes.html" rel="noopener ugc nofollow" target="_blank">https://www.minio.io/kubernetes.html</a>。您需要做的是取消对storageClassName的注释，并用正确的值填充它，在我的例子中它是标准的(与上面的<em class="mz"> pv.yaml </em>文件相同):</p><pre class="mj mk ml mm gt na nb nc nd aw ne bi"><span id="e4f3" class="nf lg iq nb b gy ng nh l ni nj">storageClassName: standard</span></pre><p id="a921" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">并将数值输入Minio <em class="mz"> </em> <strong class="jp ir"> <em class="mz">访问密钥</em> </strong> <em class="mz"> </em>和<em class="mz"> </em> <strong class="jp ir"> <em class="mz">秘密密钥</em> </strong>。</p><pre class="mj mk ml mm gt na nb nc nd aw ne bi"><span id="f9dd" class="nf lg iq nb b gy ng nh l ni nj">$ kubectl create -f minio-deployment.yaml</span></pre><p id="e2b6" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">要验证:</p><pre class="mj mk ml mm gt na nb nc nd aw ne bi"><span id="44a3" class="nf lg iq nb b gy ng nh l ni nj">$ kubectl get services                                                                                                               <br/>NAME            TYPE           CLUSTER-IP       EXTERNAL-IP   PORT(S)          AGE<br/>kubernetes      ClusterIP      10.152.183.1     &lt;none&gt;        443/TCP          4d<br/>minio-service   LoadBalancer   10.152.183.228   &lt;pending&gt;     9000:32302/TCP   72m</span></pre><h1 id="a895" class="lf lg iq bd lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc bi translated">用于Kubeless的Python函数</h1><p id="2e1b" class="pw-post-body-paragraph jn jo iq jp b jq md js jt ju me jw jx jy mf ka kb kc mg ke kf kg mh ki kj kk ij bi translated">现在，最有趣的部分来了——我们要写一些代码:)为此，有两个有用的API:</p><ul class=""><li id="46d7" class="nk nl iq jp b jq jr ju jv jy nm kc nn kg no kk np nq nr ns bi translated"><a class="ae kl" href="https://unsplash.com/developers" rel="noopener ugc nofollow" target="_blank">https://unsplash.com/developers</a></li><li id="3339" class="nk nl iq jp b jq nt ju nu jy nv kc nw kg nx kk np nq nr ns bi translated"><a class="ae kl" href="https://docs.minio.io/docs/python-client-quickstart-guide" rel="noopener ugc nofollow" target="_blank">https://docs.minio.io/docs/python-client-quickstart-guide</a></li></ul><p id="78a7" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">正如我们在Minio文档中看到的，它使用了特殊的python包。让我们通过简单地导入minio来尝试执行一个函数，看看这个包在Kubeless中是否可用:</p><pre class="mj mk ml mm gt na nb nc nd aw ne bi"><span id="7cb2" class="nf lg iq nb b gy ng nh l ni nj">$ cat /tmp/up.py             <br/>import minio</span><span id="0e33" class="nf lg iq nb b gy ny nh l ni nj">def hello(event, context):<br/>    print (event)<br/>    return event['data']</span><span id="c6a7" class="nf lg iq nb b gy ny nh l ni nj">$ kubeless function deploy up --runtime python3.6 --from-file up.py --handler up.hello</span><span id="714d" class="nf lg iq nb b gy ny nh l ni nj">INFO[0000] Deploying function...                        <br/>INFO[0000] Function up submitted for deployment         <br/>INFO[0000] Check the deployment status executing 'kubeless function ls up' <br/>$ kubeless function  ls                                                               <br/>NAME  NAMESPACE HANDLER    RUNTIME   DEPENDENCIES STATUS       <br/>hello default   test.hello python3.6              1/1 READY    <br/>up    default   up.hello   python3.6              0/1 NOT READY<br/>$ kubeless function  ls<br/>NAME  NAMESPACE HANDLER    RUNTIME   DEPENDENCIES STATUS   <br/>hello default   test.hello python3.6              1/1 READY<br/>up    default   up.hello   python3.6              1/1 READY<br/>$ kubeless function call up --data "Let's pray..."<br/>ERRO[0000] {"kind":"Status","apiVersion":"v1","metadata":{},"status":"Failure","message":"no endpoints available for service \"up:http-function-port\"","reason":"ServiceUnavailable","code":503}<br/> <br/>FATA[0000] the server is currently unable to handle the request</span></pre><p id="2620" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">它没有，这是预期的:)每个曾经使用AWS Lambda的人肯定都记得构建python包，将它们调整到特定的大小，然后与Lambda一起上传。在这里，我们可以跳过它，将依赖项作为额外的参数提供:</p><pre class="mj mk ml mm gt na nb nc nd aw ne bi"><span id="6214" class="nf lg iq nb b gy ng nh l ni nj">$ cat requirements.txt <br/>minio<br/>requests<br/>$ kubeless function  deploy up --runtime python3.6 --from-file /tmp/up.py --dependencies requirements.txt --handler up.hello</span></pre><p id="e5d0" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在，当我们列出我们的函数时，我们将在依赖项列表中看到我们的包:</p><pre class="mj mk ml mm gt na nb nc nd aw ne bi"><span id="7c96" class="nf lg iq nb b gy ng nh l ni nj">$ kubeless function ls up      <br/>NAME NAMESPACE HANDLER  RUNTIME   DEPENDENCIES STATUS       <br/>up   default   up.hello python3.6 minio        0/1 NOT READY<br/>                                  requests<br/>$ kubectl get pods<br/>NAME                  READY   STATUS             RESTARTS   AGE<br/><br/>up-5f6cbd8bb7-957ls   0/1     Init:1/2           0          2m5s</span></pre><p id="6c2f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">描述pod以查看它正在构建新的docker映像:</p><pre class="mj mk ml mm gt na nb nc nd aw ne bi"><span id="0d84" class="nf lg iq nb b gy ng nh l ni nj">$ kubectl describe pod up-5f6cbd8bb7-957ls</span><span id="e4c6" class="nf lg iq nb b gy ny nh l ni nj">...Events:<br/>  Type    Reason     Age                   From               Message<br/>  ----    ------     ----                  ----               -------<br/>  Normal  Scheduled  6m26s                 default-scheduler  Successfully assigned default/up-5f6cbd8bb7-957ls to t480<br/>  Normal  Pulled     6m25s                 kubelet, t480      Container image "kubeless/unzip@sha256:f162c062973cca05459834de6ed14c039d45df8cdb76097f50b028a1621b3697" already present on machine<br/>  Normal  Created    6m25s                 kubelet, t480      Created container<br/>  Normal  Started    6m25s                 kubelet, t480      Started container<br/>  Normal  Pulling    6m24s                 kubelet, t480      pulling image "python:3.6"<br/>  Normal  Pulled     4m36s                 kubelet, t480      Successfully pulled image "python:3.6"<br/>  Normal  Created    2m3s (x2 over 4m34s)  kubelet, t480      Created container<br/>  Normal  Started    2m3s (x2 over 4m33s)  kubelet, t480      Started container<br/>  Normal  Pulled     2m3s                  kubelet, t480      Container image "python:3.6" already present on machine</span></pre><p id="8c7e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">快速检查依赖项是否工作(在我们正在导入的代码中<strong class="jp ir"> minio </strong>模块):</p><pre class="mj mk ml mm gt na nb nc nd aw ne bi"><span id="c843" class="nf lg iq nb b gy ng nh l ni nj">$ kubeless function call up --data "Let's pray..."<br/>Let's pray...</span></pre><p id="297a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">由于依赖项正在工作，我准备了简单的python脚本来从Unsplash获取图像——我在这里上传了<a class="ae kl" href="https://github.com/Devcarpet/microk8s-kubeless-minio/blob/master/up.py" rel="noopener ugc nofollow" target="_blank">，由于Medium中较差的等宽字体支持，我没有在这里复制粘贴它——其中最重要的部分是下载图像:</a></p><figure class="mj mk ml mm gt mn gh gi paragraph-image"><div class="gh gi nz"><img src="../Images/d031d1118aac526d73a1524e2214e8f9.png" data-original-src="https://miro.medium.com/v2/resize:fit:886/format:webp/1*NhBO7NX_jGvAoEowhtkfQw.png"/></div></figure><p id="55d6" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">并上传到部署在Kubernetes Minio:</p><figure class="mj mk ml mm gt mn gh gi paragraph-image"><div class="gh gi oa"><img src="../Images/f88bf17452359f0279b6b004f7aa8d3e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1044/format:webp/1*P_fNFNTjkURniOa7v9mnjA.png"/></div></figure><p id="3563" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我将这段代码部署为一个函数:</p><pre class="mj mk ml mm gt na nb nc nd aw ne bi"><span id="7aca" class="nf lg iq nb b gy ng nh l ni nj">$ kubeless function delete up<br/>$ kubeless function  deploy up \ <br/> --runtime python3.6 --from-file up.py \ <br/> --dependencies requirements.txt --handler up.hello \ <br/> --env MINIO_ACCESS_KEY=$MINIO_ACCESS_KEY \ <br/> --env MINIO_SECRET_KEY=$MINIO_SECRET_KEY \ <br/> --env MINIO_API_URL=$MINIO_API_URL \  <br/> --env UNSPLASH_ACCESS_KEY=$UNSPLASH_ACCESS_KEY</span></pre><p id="311a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">函数的最后一次调用(上传成功后将输出文件名):</p><pre class="mj mk ml mm gt na nb nc nd aw ne bi"><span id="cd46" class="nf lg iq nb b gy ng nh l ni nj">$ kubeless function call up                                                                                                           Deer_1546895482.jpg</span></pre><p id="d940" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">并查看<a class="ae kl" href="http://localhost:9000" rel="noopener ugc nofollow" target="_blank"> Minio web面板</a>:</p><figure class="mj mk ml mm gt mn gh gi paragraph-image"><div class="gh gi ob"><img src="../Images/da2a179de39c44657fc3a6c8d17d9b7f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1360/format:webp/1*hlEG8WIYD0cd7M9cT2MI8A.png"/></div></figure><p id="bbf9" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">一切正常:)我希望你喜欢看这篇文章。</p></div></div>    
</body>
</html>