<html>
<head>
<title>Building RESTful APIs with Eclipse Vertx</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用Eclipse Vertx构建RESTful APIs</h1>
<blockquote>原文：<a href="https://itnext.io/building-restful-apis-with-eclipse-vertx-4ce89d8eeb74?source=collection_archive---------0-----------------------#2021-07-02">https://itnext.io/building-restful-apis-with-eclipse-vertx-4ce89d8eeb74?source=collection_archive---------0-----------------------#2021-07-02</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="0673" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在本文中，我们将探索如何用Eclipse Vertx和reactive Postgres客户端构建一个简单的RESTful示例应用程序。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi kl"><img src="../Images/36bbb4a45ee428609990058dcfbe4a9b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*xR6gc7dEF0E7gXxf_57izA.jpeg"/></div></div><figcaption class="kx ky gj gh gi kz la bd b be z dk translated">萨姆·比斯利在<a class="ae lb" href="https://unsplash.com/s/photos/china-gugong?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</figcaption></figure><p id="74ff" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">不同于其他框架中<em class="lc"> reactive </em>是对现有特性的添加，Eclipse Vertx是为<em class="lc"> reactive应用</em>而生，阅读<a class="ae lb" href="https://vertx.io/introduction-to-vertx-and-reactive/" rel="noopener ugc nofollow" target="_blank">官方介绍指南</a>了解Vertx中的reactive支持。</p><p id="206c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">类似于<a class="ae lb" href="https://start.spring.io" rel="noopener ugc nofollow" target="_blank"> Spring Boot初始化器</a>，Eclipse Vertx也提供了一个脚手架工具来为您生成项目框架。</p><p id="570b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">打开浏览器，导航至<a class="ae lb" href="https://start.vertx.io/" rel="noopener ugc nofollow" target="_blank"> Vertx开始页面</a>。在<strong class="jp ir">依赖项</strong>字段中，选择<em class="lc"> Vertx Web </em>、<em class="lc">responsive PostgreSQL客户端</em>，并可选展开<strong class="jp ir">高级选项</strong>，选择<em class="lc">最新Java版本</em>(目前为<strong class="jp ir"> 16 </strong>)。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi ld"><img src="../Images/472df2dae335cf3c0311914e5e0c0433.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*JJa1u3eVqoVUlw7k.png"/></div></div></figure><p id="3773" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">保持其他选项不变，它将使用默认值，然后点击<strong class="jp ir">生成项目</strong>按钮，将项目生成到一个档案中以供下载。</p><p id="6015" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">下载项目档案，将文件解压到本地磁盘，并导入到您的ide中，例如Intellij IDEA。</p><p id="d2bc" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">打开<em class="lc"> pom.xml </em>。如你所见，它使用<code class="fe le lf lg lh b">maven-shade-plugin</code>将构建的结果打包到一个胖罐子里，<em class="lc">主类</em>就是Vertx内置的<code class="fe le lf lg lh b">io.vertx.core.Launcher</code>。当通过<code class="fe le lf lg lh b">java -jar target\xxx.jar</code>运行应用程序时，它将使用<code class="fe le lf lg lh b">Launcher</code>来部署声明的<code class="fe le lf lg lh b">MainVerticle</code>。一个<code class="fe le lf lg lh b">Verticle</code>是一个Vertx特定的部署单元，用于对网络、HTTP等资源进行分组。</p><p id="2c06" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">让我们转到<code class="fe le lf lg lh b">MainVerticle</code>类。</p><pre class="km kn ko kp gt li lh lj lk aw ll bi"><span id="a211" class="lm ln iq lh b gy lo lp l lq lr">public class MainVerticle extends AbstractVerticle {<br/>    <br/>}</span></pre><p id="5d3a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">通常，要编写我们的业务逻辑，您只需要覆盖<code class="fe le lf lg lh b">start()</code>方法或<code class="fe le lf lg lh b">start(Promise&lt;Void&gt; startPromise)</code>。</p><p id="8b11" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在我们的应用程序中，我们将启动一个HTTP服务器来服务HTTP请求。用以下内容替换<code class="fe le lf lg lh b">start(Promise&lt;Void&gt; startPromise)</code>方法的内容。</p><pre class="km kn ko kp gt li lh lj lk aw ll bi"><span id="91b5" class="lm ln iq lh b gy lo lp l lq lr">// Create the HTTP server<br/>vertx.createHttpServer()<br/>    // Handle every request using the router<br/>    .requestHandler(router)<br/>    // Start listening<br/>    .listen(8888)<br/>    // Print the port<br/>    .onSuccess(server -&gt; {<br/>        startPromise.complete();<br/>        System.out.println("HTTP server started on port " + server.actualPort());<br/>    })<br/>    .onFailure(event -&gt; {<br/>        startPromise.fail(event);<br/>        System.out.println("Failed to start HTTP server:" + event.getMessage());<br/>    });</span></pre><p id="a9dc" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">请求处理工作由上面的<code class="fe le lf lg lh b">.requestHandler(Handler&lt;HttpServerRequest&gt;)</code>完成。<code class="fe le lf lg lh b">Router</code>是一个特殊的<code class="fe le lf lg lh b">Handler&lt;HttpServerRequest&gt;</code>，它简化了HTTP请求的处理，并允许链接一系列处理程序。</p><p id="4c61" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">添加一个<code class="fe le lf lg lh b">reoutes</code>方法在一个中心位置处理所有路由的请求，它返回路由器。</p><pre class="km kn ko kp gt li lh lj lk aw ll bi"><span id="a110" class="lm ln iq lh b gy lo lp l lq lr">//create routes<br/>private Router routes(PostsHandler handlers) {</span><span id="9996" class="lm ln iq lh b gy ls lp l lq lr">    // Create a Router<br/>    Router router = Router.router(vertx);<br/>    // register BodyHandler globally.<br/>    //router.route().handler(BodyHandler.create());<br/>    router.get("/posts").produces("application/json").handler(handlers::all);<br/>   	router.post("/posts").consumes("application/json").handler(BodyHandler.create()).handler(handlers::save);<br/>    router.get("/posts/:id").produces("application/json").handler(handlers::get).failureHandler(frc -&gt; frc.response().setStatusCode(404).end());<br/>    router.put("/posts/:id").consumes("application/json").handler(BodyHandler.create()).handler(handlers::update);<br/>    router.delete("/posts/:id").handler(handlers::delete);</span><span id="f532" class="lm ln iq lh b gy ls lp l lq lr">    router.get("/hello").handler(rc -&gt; rc.response().end("Hello from my route"));</span><span id="4bd6" class="lm ln iq lh b gy ls lp l lq lr">    return router;<br/>}</span></pre><p id="2b26" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">对于<code class="fe le lf lg lh b">post</code>和<code class="fe le lf lg lh b">put</code> HTTP方法，需要<code class="fe le lf lg lh b">BodyHandler</code>来处理消费HTTP请求体。</p><p id="2a77" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">将所有处理细节提取到一个新的<code class="fe le lf lg lh b">PostHandler</code>类中。</p><pre class="km kn ko kp gt li lh lj lk aw ll bi"><span id="c9e1" class="lm ln iq lh b gy lo lp l lq lr">class PostsHandler {<br/>    private static final Logger LOGGER = Logger.getLogger(PostsHandler.class.getSimpleName());</span><span id="619f" class="lm ln iq lh b gy ls lp l lq lr">    PostRepository posts;</span><span id="438e" class="lm ln iq lh b gy ls lp l lq lr">    private PostsHandler(PostRepository _posts) {<br/>        this.posts = _posts;<br/>    }</span><span id="7417" class="lm ln iq lh b gy ls lp l lq lr">    //factory method<br/>    public static PostsHandler create(PostRepository posts) {<br/>        return new PostsHandler(posts);<br/>    }</span><span id="8673" class="lm ln iq lh b gy ls lp l lq lr">    public void all(RoutingContext rc) {<br/>//        var params = rc.queryParams();<br/>//        var q = params.get("q");<br/>//        var limit = params.get("limit") == null ? 10 : Integer.parseInt(params.get("q"));<br/>//        var offset = params.get("offset") == null ? 0 : Integer.parseInt(params.get("offset"));<br/>//        LOGGER.log(Level.INFO, " find by keyword: q={0}, limit={1}, offset={2}", new Object[]{q, limit, offset});<br/>        this.posts.findAll()<br/>            .onSuccess(<br/>                data -&gt; rc.response().end(Json.encode(data))<br/>            );<br/>    }</span><span id="454b" class="lm ln iq lh b gy ls lp l lq lr">    public void get(RoutingContext rc) {<br/>        var params = rc.pathParams();<br/>        var id = params.get("id");<br/>        this.posts.findById(UUID.fromString(id))<br/>            .onSuccess(<br/>                post -&gt; rc.response().end(Json.encode(post))<br/>            )<br/>            .onFailure(<br/>                throwable -&gt; rc.fail(404, throwable)<br/>            );</span><span id="4e7b" class="lm ln iq lh b gy ls lp l lq lr">    }<br/></span><span id="e9d3" class="lm ln iq lh b gy ls lp l lq lr">    public void save(RoutingContext rc) {<br/>        //rc.getBodyAsJson().mapTo(PostForm.class)<br/>        var body = rc.getBodyAsJson();<br/>        LOGGER.log(Level.INFO, "request body: {0}", body);<br/>        var form = body.mapTo(PostForm.class);<br/>        this.posts.save(Post.of(form.getTitle(), form.getContent()))<br/>            .onSuccess(<br/>                savedId -&gt; rc.response()<br/>                    .putHeader("Location", "/posts/" + savedId)<br/>                    .setStatusCode(201)<br/>                    .end()</span><span id="51e6" class="lm ln iq lh b gy ls lp l lq lr">            );<br/>    }</span><span id="7b9b" class="lm ln iq lh b gy ls lp l lq lr">    public void update(RoutingContext rc) {<br/>        var params = rc.pathParams();<br/>        var id = params.get("id");<br/>        var body = rc.getBodyAsJson();<br/>        LOGGER.log(Level.INFO, "\npath param id: {0}\nrequest body: {1}", new Object[]{id, body});<br/>        var form = body.mapTo(PostForm.class);<br/>        this.posts.findById(UUID.fromString(id))<br/>            .compose(<br/>                post -&gt; {<br/>                    post.setTitle(form.getTitle());<br/>                    post.setContent(form.getContent());</span><span id="c891" class="lm ln iq lh b gy ls lp l lq lr">                    return this.posts.update(post);<br/>                }<br/>            )<br/>            .onSuccess(<br/>                data -&gt; rc.response().setStatusCode(204).end()<br/>            )<br/>            .onFailure(<br/>                throwable -&gt; rc.fail(404, throwable)<br/>            );</span><span id="a98a" class="lm ln iq lh b gy ls lp l lq lr">    }</span><span id="fdaf" class="lm ln iq lh b gy ls lp l lq lr">    public void delete(RoutingContext rc) {<br/>        var params = rc.pathParams();<br/>        var id = params.get("id");</span><span id="e61d" class="lm ln iq lh b gy ls lp l lq lr">        var uuid = UUID.fromString(id);<br/>        this.posts.findById(uuid)<br/>            .compose(<br/>                post -&gt; this.posts.deleteById(uuid)<br/>            )<br/>            .onSuccess(<br/>                data -&gt; rc.response().setStatusCode(204).end()<br/>            )<br/>            .onFailure(<br/>                throwable -&gt; rc.fail(404, throwable)<br/>            );</span><span id="e144" class="lm ln iq lh b gy ls lp l lq lr">    }</span><span id="f84c" class="lm ln iq lh b gy ls lp l lq lr">}</span></pre><p id="9427" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">从<code class="fe le lf lg lh b">RoutingContext</code>中，很容易读取请求参数等。<code class="fe le lf lg lh b">PostRepository</code>负责与你的后台数据库Postgres交互，当数据库操作完成后，再通过<code class="fe le lf lg lh b">RoutingContext.response()</code>将结果发送给HTTP响应。</p><p id="af1a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们来看看<code class="fe le lf lg lh b">PostRepository</code>类。</p><pre class="km kn ko kp gt li lh lj lk aw ll bi"><span id="dbb0" class="lm ln iq lh b gy lo lp l lq lr">public class PostRepository {<br/>    private static final Logger LOGGER = Logger.getLogger(PostRepository.class.getName());</span><span id="a2ce" class="lm ln iq lh b gy ls lp l lq lr">    private static Function&lt;Row, Post&gt; MAPPER = (row) -&gt;<br/>        Post.of(<br/>            row.getUUID("id"),<br/>            row.getString("title"),<br/>            row.getString("content"),<br/>            row.getLocalDateTime("created_at")<br/>        );<br/></span><span id="07e2" class="lm ln iq lh b gy ls lp l lq lr">    private final PgPool client;</span><span id="71d9" class="lm ln iq lh b gy ls lp l lq lr">    private PostRepository(PgPool _client) {<br/>        this.client = _client;<br/>    }</span><span id="1cb3" class="lm ln iq lh b gy ls lp l lq lr">    //factory method<br/>    public static PostRepository create(PgPool client) {<br/>        return new PostRepository(client);<br/>    }</span><span id="a2b4" class="lm ln iq lh b gy ls lp l lq lr">    public Future&lt;List&lt;Post&gt;&gt; findAll() {<br/>        return client.query("SELECT * FROM posts ORDER BY id ASC")<br/>            .execute()<br/>            .map(rs -&gt; StreamSupport.stream(rs.spliterator(), false)<br/>                .map(MAPPER)<br/>                .collect(Collectors.toList())<br/>            );<br/>    }<br/></span><span id="2868" class="lm ln iq lh b gy ls lp l lq lr">    public Future&lt;Post&gt; findById(UUID id) {<br/>        Objects.requireNonNull(id, "id can not be null");<br/>        return client.preparedQuery("SELECT * FROM posts WHERE id=$1").execute(Tuple.of(id))<br/>            .map(RowSet::iterator)<br/>            .map(iterator -&gt; iterator.hasNext() ? MAPPER.apply(iterator.next()) : null)<br/>            .map(Optional::ofNullable)<br/>            .map(p -&gt; p.orElseThrow(() -&gt; new PostNotFoundException(id)));<br/>    }</span><span id="370b" class="lm ln iq lh b gy ls lp l lq lr">    public Future&lt;UUID&gt; save(Post data) {<br/>        return client.preparedQuery("INSERT INTO posts(title, content) VALUES ($1, $2) RETURNING (id)").execute(Tuple.of(data.getTitle(), data.getContent()))<br/>            .map(rs -&gt; rs.iterator().next().getUUID("id"));<br/>    }</span><span id="487f" class="lm ln iq lh b gy ls lp l lq lr">    public Future&lt;Integer&gt; saveAll(List&lt;Post&gt; data) {<br/>        var tuples = data.stream()<br/>            .map(<br/>                d -&gt; Tuple.of(d.getTitle(), d.getContent())<br/>            )<br/>            .collect(Collectors.toList());</span><span id="6a11" class="lm ln iq lh b gy ls lp l lq lr">        return client.preparedQuery("INSERT INTO posts (title, content) VALUES ($1, $2)")<br/>            .executeBatch(tuples)<br/>            .map(SqlResult::rowCount);<br/>    }</span><span id="92f8" class="lm ln iq lh b gy ls lp l lq lr">    public Future&lt;Integer&gt; update(Post data) {<br/>        return client.preparedQuery("UPDATE posts SET title=$1, content=$2 WHERE id=$3")<br/>            .execute(Tuple.of(data.getTitle(), data.getContent(), data.getId()))<br/>            .map(SqlResult::rowCount);<br/>    }</span><span id="71c3" class="lm ln iq lh b gy ls lp l lq lr">    public Future&lt;Integer&gt; deleteAll() {<br/>        return client.query("DELETE FROM posts").execute()<br/>            .map(SqlResult::rowCount);<br/>    }</span><span id="7254" class="lm ln iq lh b gy ls lp l lq lr">    public Future&lt;Integer&gt; deleteById(UUID id) {<br/>        Objects.requireNonNull(id, "id can not be null");<br/>        return client.preparedQuery("DELETE FROM posts WHERE id=$1").execute(Tuple.of(id))<br/>            .map(SqlResult::rowCount);<br/>    }</span><span id="7c3a" class="lm ln iq lh b gy ls lp l lq lr">}</span></pre><p id="1ae5" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><code class="fe le lf lg lh b">pgPool</code>是一个Postgres客户端，用于与Postgres数据库进行交互，操作与传统的JDBC非常相似，但它基于Vertx的<code class="fe le lf lg lh b">Future</code> API。与Java 8 <code class="fe le lf lg lh b">CompletionStage</code>或Reactor <code class="fe le lf lg lh b">Mono</code> / <code class="fe le lf lg lh b">Flux</code>类似，Vertx Future提供了非常有限的API，用于以异步方式产生、转换和观察完成的结果。</p><blockquote class="lt lu lv"><p id="923d" class="jn jo lc jp b jq jr js jt ju jv jw jx lw jz ka kb lx kd ke kf ly kh ki kj kk ij bi translated"><em class="iq">更多关于反应式PostgreSQL客户端的详细信息，请阅读</em> <a class="ae lb" href="https://vertx.io/docs/vertx-pg-client/java/" rel="noopener ugc nofollow" target="_blank"> <em class="iq"> PostgreSQL客户端文档</em> </a> <em class="iq">。</em></p><p id="f4f3" class="jn jo lc jp b jq jr js jt ju jv jw jx lw jz ka kb lx kd ke kf ly kh ki kj kk ij bi translated"><em class="iq">在Vertx中，几乎所有的异步方法都提供了一个变体，接受一个</em> <code class="fe le lf lg lh b"><em class="iq">Promise</em></code> <em class="iq"> like回调作为参数，而不是返回一个</em> <code class="fe le lf lg lh b"><em class="iq">Future</em></code> <em class="iq">实例。但我个人认为</em> <code class="fe le lf lg lh b"><em class="iq">Promise</em></code> <em class="iq">是邪恶的，如果把处理进度传递成一个转场序列，那么</em> <code class="fe le lf lg lh b"><em class="iq">Promise</em></code> <em class="iq">就会嵌套另一个</em> <code class="fe le lf lg lh b"><em class="iq">Promise</em></code> <em class="iq">等等。它会把你放在一个无限的</em> <code class="fe le lf lg lh b"><em class="iq">Promise</em></code> <em class="iq">洞里。</em></p></blockquote><p id="8cfc" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在<code class="fe le lf lg lh b">MainVerticle</code>中创建一个方法来产生一个<code class="fe le lf lg lh b">PgPool</code>实例。</p><pre class="km kn ko kp gt li lh lj lk aw ll bi"><span id="0c2e" class="lm ln iq lh b gy lo lp l lq lr">private PgPool pgPool() {<br/>    PgConnectOptions connectOptions = new PgConnectOptions()<br/>        .setPort(5432)<br/>        .setHost("localhost")<br/>        .setDatabase("blogdb")<br/>        .setUser("user")<br/>        .setPassword("password");</span><span id="009b" class="lm ln iq lh b gy ls lp l lq lr">    // Pool Options<br/>    PoolOptions poolOptions = new PoolOptions().setMaxSize(5);</span><span id="2d5a" class="lm ln iq lh b gy ls lp l lq lr">    // Create the pool from the data object<br/>    PgPool pool = PgPool.pool(vertx, connectOptions, poolOptions);</span><span id="a5bb" class="lm ln iq lh b gy ls lp l lq lr">    return pool;<br/>}</span></pre><p id="568b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">创建一个类来初始化一些示例数据。</p><pre class="km kn ko kp gt li lh lj lk aw ll bi"><span id="9feb" class="lm ln iq lh b gy lo lp l lq lr">public class DataInitializer {</span><span id="7890" class="lm ln iq lh b gy ls lp l lq lr">    private final static Logger LOGGER = Logger.getLogger(DataInitializer.class.getName());</span><span id="c204" class="lm ln iq lh b gy ls lp l lq lr">    private PgPool client;</span><span id="d83d" class="lm ln iq lh b gy ls lp l lq lr">    public DataInitializer(PgPool client) {<br/>        this.client = client;<br/>    }</span><span id="09e1" class="lm ln iq lh b gy ls lp l lq lr">    public static DataInitializer create(PgPool client) {<br/>        return new DataInitializer(client);<br/>    }</span><span id="467e" class="lm ln iq lh b gy ls lp l lq lr">    public void run() {<br/>        LOGGER.info("Data initialization is starting...");</span><span id="dd9f" class="lm ln iq lh b gy ls lp l lq lr">        Tuple first = Tuple.of("Hello Quarkus", "My first post of Quarkus");<br/>        Tuple second = Tuple.of("Hello Again, Quarkus", "My second post of Quarkus");</span><span id="123f" class="lm ln iq lh b gy ls lp l lq lr">        client<br/>            .withTransaction(<br/>                conn -&gt; conn.query("DELETE FROM posts").execute()<br/>                    .flatMap(r -&gt; conn.preparedQuery("INSERT INTO posts (title, content) VALUES ($1, $2)")<br/>                        .executeBatch(List.of(first, second))<br/>                    )<br/>                    .flatMap(r -&gt; conn.query("SELECT * FROM posts").execute())<br/>            )<br/>            .onSuccess(data -&gt; StreamSupport.stream(data.spliterator(), true)<br/>                .forEach(row -&gt; LOGGER.log(Level.INFO, "saved data:{0}", new Object[]{row.toJson()}))<br/>            )<br/>            .onComplete(<br/>                r -&gt; {<br/>                    //client.close(); will block the application.<br/>                    LOGGER.info("Data initialization is done...");<br/>                }<br/>            )<br/>            .onFailure(<br/>                throwable -&gt; LOGGER.warning("Data initialization is failed:" + throwable.getMessage())<br/>            );<br/>    }<br/>}</span></pre><p id="652a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在上面的代码中，使用<code class="fe le lf lg lh b">withTransaction</code>方法将一系列数据库操作包装在单个事务中。</p><p id="bb5a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">让我们在<code class="fe le lf lg lh b">MainVerticle</code>的start方法中集合所有的资源。</p><pre class="km kn ko kp gt li lh lj lk aw ll bi"><span id="513d" class="lm ln iq lh b gy lo lp l lq lr">@Override<br/>public void start(Promise&lt;Void&gt; startPromise) throws Exception {<br/>    LOGGER.log(Level.INFO, "Starting HTTP server...");<br/>    //setupLogging();</span><span id="9699" class="lm ln iq lh b gy ls lp l lq lr">    //Create a PgPool instance<br/>    var pgPool = pgPool();</span><span id="a033" class="lm ln iq lh b gy ls lp l lq lr">    //Creating PostRepository<br/>    var postRepository = PostRepository.create(pgPool);</span><span id="0f33" class="lm ln iq lh b gy ls lp l lq lr">    //Creating PostHandler<br/>    var postHandlers = PostsHandler.create(postRepository);</span><span id="7f0b" class="lm ln iq lh b gy ls lp l lq lr">    // Initializing the sample data<br/>    var initializer = DataInitializer.create(pgPool);<br/>    initializer.run();</span><span id="c2be" class="lm ln iq lh b gy ls lp l lq lr">    // Configure routes<br/>    var router = routes(postHandlers);</span><span id="1b7b" class="lm ln iq lh b gy ls lp l lq lr">    // Create the HTTP server<br/>    vertx.createHttpServer()<br/>        // Handle every request using the router<br/>    	.requestHandler(router)<br/>        ...<br/>}</span></pre><p id="be6f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">默认情况下，Vertx Web使用Jackson来序列化和反序列化请求/响应负载。不幸的是，默认情况下，它没有注册Java DateTime模块。</p><p id="0bbd" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在<em class="lc"> pom.xml </em>文件中添加以下依赖项。</p><pre class="km kn ko kp gt li lh lj lk aw ll bi"><span id="b65e" class="lm ln iq lh b gy lo lp l lq lr">&lt;dependency&gt;<br/>    &lt;groupId&gt;com.fasterxml.jackson.core&lt;/groupId&gt;<br/>    &lt;artifactId&gt;jackson-databind&lt;/artifactId&gt;<br/>    &lt;version&gt;${jackson.version}&lt;/version&gt;<br/>&lt;/dependency&gt;<br/>&lt;dependency&gt;<br/>    &lt;groupId&gt;com.fasterxml.jackson.datatype&lt;/groupId&gt;<br/>    &lt;artifactId&gt;jackson-datatype-jsr310&lt;/artifactId&gt;<br/>    &lt;version&gt;${jackson.version}&lt;/version&gt;<br/>&lt;/dependency&gt;</span></pre><p id="c0ad" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">向<code class="fe le lf lg lh b">properties</code>部分添加一个<code class="fe le lf lg lh b">jackson.version</code>属性。</p><pre class="km kn ko kp gt li lh lj lk aw ll bi"><span id="b6c2" class="lm ln iq lh b gy lo lp l lq lr">&lt;jackson.version&gt;2.11.3&lt;/jackson.version&gt;</span></pre><p id="678a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">然后在<code class="fe le lf lg lh b">MainVerticle</code>类中添加一个静态块来配置日期时间序列化和反序列化。</p><pre class="km kn ko kp gt li lh lj lk aw ll bi"><span id="62ac" class="lm ln iq lh b gy lo lp l lq lr">static {<br/>    LOGGER.info("Customizing the built-in jackson ObjectMapper...");<br/>    var objectMapper = DatabindCodec.mapper();<br/>    objectMapper.disable(SerializationFeature.WRITE_DATES_AS_TIMESTAMPS);<br/>    objectMapper.disable(SerializationFeature.WRITE_DATE_TIMESTAMPS_AS_NANOSECONDS);<br/>    objectMapper.disable(DeserializationFeature.READ_DATE_TIMESTAMPS_AS_NANOSECONDS);</span><span id="5fde" class="lm ln iq lh b gy ls lp l lq lr">    JavaTimeModule module = new JavaTimeModule();<br/>    objectMapper.registerModule(module);<br/>}</span></pre><p id="481b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">让我们启动应用程序。</p><p id="358e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">简单地获取<a class="ae lb" href="https://github.com/hantsy/vertx-sandbox" rel="noopener ugc nofollow" target="_blank">源代码</a>，它提供一个docker编译文件。</p><p id="d2c3" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">运行以下命令在Docker容器中启动一个Postgres实例。</p><pre class="km kn ko kp gt li lh lj lk aw ll bi"><span id="14de" class="lm ln iq lh b gy lo lp l lq lr">docker compose postgres</span></pre><p id="f0b3" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">当数据库启动时，它将通过<a class="ae lb" href="https://github.com/hantsy/vertx-sandbox/tree/master/pg-initdb.d" rel="noopener ugc nofollow" target="_blank">初始脚本</a>准备必要的表。</p><p id="8d38" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在切换到项目文件夹，运行以下命令启动应用程序。</p><pre class="km kn ko kp gt li lh lj lk aw ll bi"><span id="ffdc" class="lm ln iq lh b gy lo lp l lq lr">mvn clean compile exec:java</span></pre><p id="578d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">或者先构建项目，然后运行最终的jar文件。</p><pre class="km kn ko kp gt li lh lj lk aw ll bi"><span id="0884" class="lm ln iq lh b gy lo lp l lq lr">mvn clean package<br/>java -jar target/demo.jar</span></pre><p id="5ff8" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">应用程序启动后，打开一个终端，用<code class="fe le lf lg lh b">curl</code>测试<code class="fe le lf lg lh b">/posts</code>端点。</p><pre class="km kn ko kp gt li lh lj lk aw ll bi"><span id="2871" class="lm ln iq lh b gy lo lp l lq lr">curl <a class="ae lb" href="http://localhost:8888/posts" rel="noopener ugc nofollow" target="_blank">http://localhost:8888/posts</a> -H "Accept: application/json"<br/>[{"id":"1f99032b-3bb0-4795-ba9f-b0437b59cfbe","title":"Hello Quarkus","content":"My first post of Quarkus","createdAt":"2021-07-02T09:35:21.341037"},{"id":"adda9ca6-2c4c-4223-9cb6-b8407c15ba03","title":"Hello Again, Quarkus","content":"My second post of Quarkus","createdAt":"2021-07-02T09:35:21.341037"}]</span></pre><h2 id="4d30" class="lm ln iq bd lz ma mb dn mc md me dp mf jy mg mh mi kc mj mk ml kg mm mn mo mp bi translated">从我的Github获取完整的源代码。</h2></div></div>    
</body>
</html>