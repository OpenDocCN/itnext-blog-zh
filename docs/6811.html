<html>
<head>
<title>Why Step Functions is the Best AWS Service You Are Not Using</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">为什么Step Functions是您没有使用的最佳AWS服务</h1>
<blockquote>原文：<a href="https://itnext.io/why-step-functions-is-the-best-aws-service-you-are-not-using-4f3c133d7d0d?source=collection_archive---------0-----------------------#2022-03-08">https://itnext.io/why-step-functions-is-the-best-aws-service-you-are-not-using-4f3c133d7d0d?source=collection_archive---------0-----------------------#2022-03-08</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="c3e0" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">我们如何使用它来满足FedRAMP中度合规性要求</h2></div><p id="5e68" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">我有件事要坦白:我爱AWS的STEP函数！它们可能是AWS提供的最强大的服务。但并不总是这样。当我第一次学习阶跃函数时，我被吓到了。</p><p id="858f" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">“什么是状态机？”</p><p id="5b43" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">“你会如何使用它？”。</p><p id="9ceb" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">后来…</p><p id="7b92" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">"为什么有这么多Lambda函数？"</p><p id="8682" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">它们对我来说太复杂了，难以理解。然后我开始想:如何将两个Lambda函数缝合在一起，其中一个得到另一个的结果？然后一切都开始有意义了！让我们来回顾一下。</p><h1 id="21f1" class="le lf it bd lg lh li lj lk ll lm ln lo jz lp ka lq kc lr kd ls kf lt kg lu lv bi translated">什么是状态机？</h1><p id="a71e" class="pw-post-body-paragraph ki kj it kk b kl lw ju kn ko lx jx kq kr ly kt ku kv lz kx ky kz ma lb lc ld im bi translated">状态机只是动作的逻辑流程。这与运行bash或Powershell脚本没有太大区别。例如:一个每天运行的脚本，它查询Active Directory中90天未登录的用户，禁用任何符合该标准的用户，并发送所有新禁用用户的电子邮件报告。这是一个非常简单的状态机。</p><h1 id="df4f" class="le lf it bd lg lh li lj lk ll lm ln lo jz lp ka lq kc lr kd ls kf lt kg lu lv bi translated">为什么我不能这样做，而忘记阶跃函数呢？</h1><p id="8e2b" class="pw-post-body-paragraph ki kj it kk b kl lw ju kn ko lx jx kq kr ly kt ku kv lz kx ky kz ma lb lc ld im bi translated">作为cron选项卡在服务器上运行脚本需要计算资源和操作系统。这并非没有管理开销，尤其是当脚本是资源密集型的和/或对业务运营至关重要时。Step Functions允许您抽象出管理层，同时仍然能够运行长时间的复杂流程/脚本。此外，Step Functions与EventBridge等其他AWS服务相集成，因此您可以根据不同的事件模式触发您的状态机，甚至可以在web应用程序中将它用作API Gateway的逻辑层。</p></div><div class="ab cl mb mc hx md" role="separator"><span class="me bw bk mf mg mh"/><span class="me bw bk mf mg mh"/><span class="me bw bk mf mg"/></div><div class="im in io ip iq"><p id="2ac3" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">当我第一次开始使用阶跃函数时，它很棒，但是有点乏味。我必须为每个动作编写一个Lambda函数——这也意味着为每个Lambda函数设计一个具有最少特权的IAM角色，并对Lambda应用一个资源策略，通过只允许我的状态机调用Lambda来防止特权升级。因为我无论如何都要写代码，所以我没有发现很多Step函数的内部函数非常有用——对于长时间的异步流程，我只使用了Choice和Wait以及CheckStatus Lambda。</p><h1 id="c768" class="le lf it bd lg lh li lj lk ll lm ln lo jz lp ka lq kc lr kd ls kf lt kg lu lv bi translated">直接API集成和Workflow Studio来拯救您</h1><p id="ded6" class="pw-post-body-paragraph ki kj it kk b kl lw ju kn ko lx jx kq kr ly kt ku kv lz kx ky kz ma lb lc ld im bi translated">去年，AWS宣布了2个而不是1个Step函数的游戏规则改变者:</p><ol class=""><li id="7b43" class="mi mj it kk b kl km ko kp kr mk kv ml kz mm ld mn mo mp mq bi translated">直接API集成——您现在可以直接在您的状态机中定义AWS API调用——不再需要为每个动作缝合简单的Lambdas。每个API动作！这真正释放了内部函数的力量，因为我现在可以将该逻辑卸载到阶跃函数。如果你使用自定义库或者需要做一些复杂的数据转换，你只需要写一个Lambda。</li><li id="8999" class="mi mj it kk b kl mr ko ms kr mt kv mu kz mv ld mn mo mp mq bi translated">workflow Studio——一个超级灵活的基于浏览器的向导，您可以通过拖放来定义您的流程。这真的提醒了我(以积极的方式！)在我之前的工作中构建SharePoint工作流。</li></ol><figure class="mx my mz na gt nb gh gi paragraph-image"><div role="button" tabindex="0" class="nc nd di ne bf nf"><div class="gh gi mw"><img src="../Images/027e840cd80ef25b46159b5be5f73a36.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*002gEK2u8kDxQBiTamfdag.png"/></div></div><figcaption class="ni nj gj gh gi nk nl bd b be z dk translated">Step函数的新Workflow Studio的润色和手感真的是一流的！</figcaption></figure></div><div class="ab cl mb mc hx md" role="separator"><span class="me bw bk mf mg mh"/><span class="me bw bk mf mg mh"/><span class="me bw bk mf mg"/></div><div class="im in io ip iq"><h1 id="c2d2" class="le lf it bd lg lh nm lj lk ll nn ln lo jz no ka lq kc np kd ls kf nq kg lu lv bi translated">构建SSL配置状态跟踪器</h1><p id="d60c" class="pw-post-body-paragraph ki kj it kk b kl lw ju kn ko lx jx kq kr ly kt ku kv lz kx ky kz ma lb lc ld im bi translated">我们的一个FedRAMP客户目前正在与他们的授权机构进行卡托流程(连续ATO您每年进行1/3的审计，而不是每3年进行一次全面审计)。对于那些不熟悉FedRAMP流程的人来说，每个云服务提供商都必须满足基于NIST 800–53的数百种不同的控制，尽管FedRAMP控制有硬性要求，而不是许多“由组织定义”的标准。CISA具有约束力的操作指令(BOD)18–01、<a class="ae nr" href="https://www.cisa.gov/binding-operational-directive-18-01" rel="noopener ugc nofollow" target="_blank"> <em class="ns">增强电子邮件和网络安全</em> </a>中概述了联邦政府使用的所有公共终端的一些要求。这需要DMARC、DKIM和SPF用于所有电子邮件应用程序，以及在您的网络流量的TLS配置中使用强密码和HSTS。仅仅使用FIPS 140–2验证的加密技术是不够的(尽管这并不排除它)，您的应用程序必须符合以下要求:</p><ol class=""><li id="f535" class="mi mj it kk b kl km ko kp kr mk kv ml kz mm ld mn mo mp mq bi translated">3DES按照NIST<a class="ae nr" href="https://www.cisa.gov/binding-operational-directive-18-01" rel="noopener ugc nofollow" target="_blank">CAVP</a>的说法还是可以接受的；BOD 18–01禁止在TLS中使用3DES。RC4也被BOD 18–01禁止，但是IETF在2015年通过RFC 7465宣布RC4不再被允许用于TLS，因此这些天在野外非常罕见。</li><li id="6bdd" class="mi mj it kk b kl mr ko ms kr mt kv mu kz mv ld mn mo mp mq bi translated">必须执行HSTS(更多关于这是下文)。</li></ol><p id="b65f" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">进入ssllabs.com(由Qualys提供)。SSL Labs是FedRAMP授权的服务，用于评估您的web应用程序的SSL/TLS状态。由于我们有30-40个端点要评估，这不是我们想要手动完成的事情！幸运的是，<a class="ae nr" href="https://www.ssllabs.com/projects/ssllabs-apis/index.html" rel="noopener ugc nofollow" target="_blank">ssllabs.com有一个公共API </a>。这似乎是使用阶跃函数的最佳时机！</p><p id="33de" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">我创建了一个DynamoDB表，其中存储了我们必须跟踪的所有URL。</p><p id="0b7e" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">然后，我像这样定义我的阶跃函数:</p><ol class=""><li id="bf84" class="mi mj it kk b kl km ko kp kr mk kv ml kz mm ld mn mo mp mq bi translated">通过EventBridge每周调用一次</li><li id="69a6" class="mi mj it kk b kl mr ko ms kr mt kv mu kz mv ld mn mo mp mq bi translated">在DynamoDB中查询我需要扫描的所有URL。</li><li id="3d83" class="mi mj it kk b kl mr ko ms kr mt kv mu kz mv ld mn mo mp mq bi translated">我使用Map State内在函数告诉Step函数遍历列表，并对列表中的每一项执行一组操作。因为DynamoDB查询将列表嵌入到了JSON字典中，所以我只需指定在字典中的什么位置找到要迭代的列表。</li></ol><figure class="mx my mz na gt nb gh gi paragraph-image"><div role="button" tabindex="0" class="nc nd di ne bf nf"><div class="gh gi nt"><img src="../Images/b34ab2b2cb80b6485b978d29106201ed.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*mPjk3gNdh1ddQs7VcEVN_w.png"/></div></div></figure><p id="8dd0" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">4.将URL传递给Lambda——在将它传递给Lambda之前，我使用这一步对上一步中的JSON进行了一些预解析。</p><p id="a52e" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">5.使用Lambda调用SSLLabs API。这是异步的，所以我没有花钱让Lambda一直运行到任务完成，而是让Step函数检查状态并等待它就绪。我的Lambda函数从结果中解析出几个属性。我稍后将介绍这些内容。* *旁注:我为此使用了请求库。由于这是一个基本的Python库，我希望AWS将它作为托管层之一。我理解不要把它放入运行时，但是如果能够作为一个层导入而不需要手动上传库就好了。</p><p id="be59" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">6.准备好之后，我会将结果上传到dynamo db——URL就是分区键。因为我使用了直接的API集成来调用dynamo db:put item——我只是这样定义了动作。</p><pre class="mx my mz na gt nu nv nw nx aw ny bi"><span id="d219" class="nz lf it nv b gy oa ob l oc od">{<br/> “TableName”: “ssllab”,<br/> “Key”: {<br/> “endpoint”: {<br/> “S.$”: “$.url”<br/> }<br/> },<br/> “AttributeUpdates”: {<br/> “Grade”: {<br/> “Action”: “PUT”,<br/> “Value”: {<br/> “S.$”: “$.grade”<br/> }<br/> },<br/>.............<br/>.............additional attributes<br/> },<br/> “supportHSTS”: {<br/> “Action”: “PUT”,<br/> “Value”: {<br/> “S.$”: “$.HSTS”<br/> }<br/> },<br/> “PFSCiphers”: {<br/> “Action”: “PUT”,<br/> “Value”: {<br/> “S.$”: “$.PFS”<br/> }<br/> }<br/> }<br/>}</span></pre><p id="2cdc" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">7.因为我想生成两个不同的报告，所以我运行了两个不同的分支:</p><ol class=""><li id="3a86" class="mi mj it kk b kl km ko kp kr mk kv ml kz mm ld mn mo mp mq bi translated">等级状态报告，</li><li id="7868" class="mi mj it kk b kl mr ko ms kr mt kv mu kz mv ld mn mo mp mq bi translated">关于证书过期状态的报告(我们没有使用ACM，因为我们必须使用政府的CA)</li></ol><p id="732d" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">8.查询DDB中成绩不是A+的所有终端以及证书将在30天内过期的所有终端。</p><pre class="mx my mz na gt nu nv nw nx aw ny bi"><span id="8c79" class="nz lf it nv b gy oa ob l oc od">{<br/> “TableName”: “ssllab”,<br/> “FilterExpression”: “Grade &lt;&gt; :val”,<br/> “ExpressionAttributeValues”: {<br/> “:val”: {<br/> “S”: “A+”<br/> }<br/> },<br/> “ProjectionExpression”: “endpoint, Grade”<br/>}</span></pre><p id="20fe" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">旁注:看一下&lt;&gt;符号，这是DynamoDB滤波器表达式中不等于的表达式。我在AWS文档中没有看到这个，但是在StackOverflow中找到了！</p><pre class="mx my mz na gt nu nv nw nx aw ny bi"><span id="fbba" class="nz lf it nv b gy oa ob l oc od">{<br/> “TableName”: “ssllab”,<br/> “FilterExpression”: “Expiresin30Days = :val”,<br/> “ExpressionAttributeValues”: {<br/> “:val”: {<br/> “S”: “True”<br/> }<br/> },<br/> “ProjectionExpression”: “endpoint, CertIssuer, ExpirationDate”<br/>}</span></pre><p id="6bfa" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">9.如果有任何结果(Count不等于0)，它会将json结果发送给一个Lambda函数，该函数使用<em class="ns"> json2html </em>库将JSON列表转换成html表。然后，我将这个html传递给sesv2:SendEmail操作来发送每周报告。</p><p id="e9ba" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">下面是最后一个流程:</p><figure class="mx my mz na gt nb gh gi paragraph-image"><div role="button" tabindex="0" class="nc nd di ne bf nf"><div class="gh gi oe"><img src="../Images/b583ea19a2d8e3230a203b0c351ca789.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*WW5rpdyyucDnlh8pDvbzvQ.png"/></div></div><figcaption class="ni nj gj gh gi nk nl bd b be z dk translated">阶跃函数自动生成清晰的文档流程图。</figcaption></figure><p id="c9cc" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">这样，我就有了一个自动化的、无服务器的SSL/TLS配置状态跟踪器。如果我有时间，我会在CDK把它打包，然后发到GitHub上。</p><p id="1fac" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><strong class="kk iu">关于SSL实验室的一些评论</strong></p><p id="b047" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">SSL Labs生成了一些关于您的SSL/TLS配置的非常有趣的数据——这些数据本身可能是一篇又长又复杂的博客。我们报告的一些属性是:</p><ol class=""><li id="7dab" class="mi mj it kk b kl km ko kp kr mk kv ml kz mm ld mn mo mp mq bi translated">分数——分数是基于很多因素的，其中一些我会在下面介绍。</li><li id="df11" class="mi mj it kk b kl mr ko ms kr mt kv mu kz mv ld mn mo mp mq bi translated">证书到期日期—这是UNIX时间，所以我必须使用datetime库进行转换。</li><li id="0e10" class="mi mj it kk b kl mr ko ms kr mt kv mu kz mv ld mn mo mp mq bi translated">证书颁发者—显示简化续订过程的证书颁发机构</li><li id="c990" class="mi mj it kk b kl mr ko ms kr mt kv mu kz mv ld mn mo mp mq bi translated">证书主体—我还没有在DDB查询中建立这种逻辑，但是由于我们使用多SAN证书，一些URL将具有相同的证书，并将导致过期列表中的冗余条目。在将来的某个时候，我将在查询中添加逻辑，以便只输出具有唯一证书主体的条目。</li><li id="f786" class="mi mj it kk b kl mr ko ms kr mt kv mu kz mv ld mn mo mp mq bi translated">它是否容易受到几个众所周知的攻击，如野兽或心脏出血。</li><li id="cf72" class="mi mj it kk b kl mr ko ms kr mt kv mu kz mv ld mn mo mp mq bi translated">是支持3DES还是RC4。RC4在结果中被明确地叫了出来。为了确定3DES是否受支持，我必须解析所有受支持的密码套件，幸运的是这并不太难。</li><li id="19bb" class="mi mj it kk b kl mr ko ms kr mt kv mu kz mv ld mn mo mp mq bi translated">PFS——完美的前向保密——是一个概念，它意味着所有会话对所有加密都使用唯一的会话密钥。这确保了如果会话密钥泄露或被盗，并且有人记录了加密的对话，他们将只能解密单个会话。解决方案是使用短暂的密钥交换。如果您在密码套件中看到DHE，您正在使用PFS。这包括比圆形曲线更有效的椭圆曲线——ECDHE。</li><li id="6e65" class="mi mj it kk b kl mr ko ms kr mt kv mu kz mv ld mn mo mp mq bi translated">HSTS(HTTP严格传输安全)是由您的web服务器传递的一个报头，它告诉浏览器使用HTTPS向前移动该域，即使您输入HTTP。由于没有更好的术语，可以把它看作客户端重定向。传统上，您会在web服务器或负载平衡器上使用HTTP到HTTPS重定向。然而，从理论上讲，如果原始请求是未加密的，并且其中包含敏感数据，那么这将会对其进行保护。最佳实践是将<em class="ns">最大年龄</em>设置为至少1年，并且<em class="ns">包括子域名</em>——这样所有子域名在第一次被浏览时都会执行HTTPS。此外，你可以在标题中包含<em class="ns">预载</em>，它告诉像谷歌和Mozilla这样的浏览器公司，在他们的浏览器中预载这个域名——确保它不会通过HTTP。否则，您的浏览器必须先获得您正在浏览的域名的HSTS响应头，然后才能知道实施HTTPS。虽然不能保证浏览器会预加载你的域名，但是值得一试。根据BOD 18-01，联邦政府要求所有公共联邦终端强制执行HSTS，以满足FISMA、CMMC或FedRAMP合规性要求。</li><li id="5b89" class="mi mj it kk b kl mr ko ms kr mt kv mu kz mv ld mn mo mp mq bi translated">安全的重新谈判——这只是因为它有点令人恼火才被包括在内。我们的一个终点不支持这一点，因此被评为A-。当客户端或服务器想要在会话过程中切换加密密钥时，通常在客户端验证之后，使用安全重新协商。奇怪的是，这是A+评级所要求的。重新协商会使您的网站暴露于多种攻击(DoS和MitM)——这就是为什么安全重新协商被发明来帮助减轻这些攻击的原因。此外，如果你使用短暂的Diffie-Hellman，你必须问为什么你需要重新协商？这些密钥是短暂的，并且是在会话启动时计算的，在获得唯一且安全的会话密钥后，您是否需要立即转身重新协商？这可能是TLS 1.3中没有包括安全重新协商的原因，在TLS 1.3中，PFS被明确强制执行。</li></ol></div><div class="ab cl mb mc hx md" role="separator"><span class="me bw bk mf mg mh"/><span class="me bw bk mf mg mh"/><span class="me bw bk mf mg"/></div><div class="im in io ip iq"><p id="0374" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">Matthew是领先的AWS网络安全合作伙伴stackArmor的高级解决方案总监，该公司为希望满足合规框架安全要求的客户设计定制解决方案:FedRAMP、NIST 800系列、PCI-DSS、国防部SRG、CMMC、HIPAA、FISMA、FIPS 140–2(和3)等。StackArmor提供了一个经过AWS审核的解决方案，可以加速FedRAMP ATO的运行并降低40%以上的成本。</p></div></div>    
</body>
</html>