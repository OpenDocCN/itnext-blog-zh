<html>
<head>
<title>Azure Lighthouse: MSP’s, let there be light!</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">蔚蓝灯塔:MSP的，要有光！</h1>
<blockquote>原文：<a href="https://itnext.io/azure-lighthouse-msps-let-there-be-light-3da060717b09?source=collection_archive---------2-----------------------#2021-01-22">https://itnext.io/azure-lighthouse-msps-let-there-be-light-3da060717b09?source=collection_archive---------2-----------------------#2021-01-22</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="09ae" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们都知道从一个租户切换到另一个租户的困难，无尽的保管库和凭据注册，在不同的环境中一遍又一遍地执行相同的(管理)活动，以及缺少所有(客户)环境的集中视图。使用Azure Lighthouse，可以管理、自动化和扩展多个租户，并改善资源和租户的治理。</p><p id="4431" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在这篇博客中，我将大致解释什么是Azure Lighthouse，为什么你想使用它，并提供一个如何实现它的快速入门。</p><h1 id="41d5" class="kl km iq bd kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li bi translated">蔚蓝灯塔是什么？</h1><blockquote class="lj lk ll"><p id="a681" class="jn jo lm jp b jq jr js jt ju jv jw jx ln jz ka kb lo kd ke kf lp kh ki kj kk ij bi translated">Azure Lighthouse为服务提供商提供了一个单一的控制平面，以更高的自动化、规模和增强的治理来查看和管理他们所有客户的Azure。有了Azure Lighthouse，服务提供商可以使用内置于Azure平台的全面而强大的管理工具来交付托管服务。该产品还可以让管理多个租户资源的企业it组织受益。— <a class="ae lq" href="https://docs.microsoft.com/en-us/azure/lighthouse/overview" rel="noopener ugc nofollow" target="_blank">蔚蓝灯塔是什么？— Azure Lighthouse |微软文档</a></p></blockquote><p id="7e21" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">上面的引用听起来很棒，但还是有点隐晦。它试图告诉我们的是，Azure Lighthouse提供了几种方法来简化管理并提高与客户的互动。<br/>通过委托管理，可以从服务提供商的租户安全地管理客户的Azure资源，而不必切换上下文和控制平面。客户订阅和资源组可以委托给管理租户中的指定用户和角色，必要时可以选择删除访问权限。Lighthouse提供了收集一个Azure AD租户下的资源并将它们投射到另一个租户的能力。</p><figure class="ls lt lu lv gt lw gh gi paragraph-image"><div role="button" tabindex="0" class="lx ly di lz bf ma"><div class="gh gi lr"><img src="../Images/127bfc5b54dddfd1bb0e20a295df8c2f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*tQY9iR9tWIG8eGjw.jpg"/></div></div><figcaption class="md me gj gh gi mf mg bd b be z dk translated">图片由<a class="ae lq" href="https://www.microsoft.com/en-us" rel="noopener ugc nofollow" target="_blank">微软</a>在<a class="ae lq" href="https://docs.microsoft.com/en-us/azure/lighthouse/overview" rel="noopener ugc nofollow" target="_blank">微软文档</a>上提供</figcaption></figure><p id="17ad" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">Azure门户与Lighthouse的集成在Azure门户的“我的客户”页面上提供了跨租户信息。对于客户，有一个关联的服务提供商页面，他们可以在其中查看和管理服务提供商的访问权限。</p><h1 id="4fe3" class="kl km iq bd kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li bi translated">为什么要用Azure Lighthouse？</h1><p id="b271" class="pw-post-body-paragraph jn jo iq jp b jq mh js jt ju mi jw jx jy mj ka kb kc mk ke kf kg ml ki kj kk ij bi translated">这个博客的“什么”部分涵盖了一些你应该为使用Azure Lighthouse而激动的原因。Azure Lighthouse帮助服务提供商(或共享服务中心)高效地构建和交付托管服务。</p><p id="f201" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">Azure Lighthouse无需在客户的Azure Active Directory中添加访客用户帐户。由于安全性、隐私和法规遵从性要求，客户通常反对这样做。利用委托的资源管理功能，服务提供商仍然能够访问和管理环境。这也使得从一个视图进行管理成为可能，而不需要在租户之间切换。</p><p id="0bf9" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">此外，它使现有的API、管理工具和工作流能够与委托资源一起使用，包括托管在Azure之外的机器，而不管它们在哪个区域。这使得管理客户资源的客户参与和生命周期活动变得更简单、更具可扩展性。</p><p id="cd4b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">通过Azure Lighthouse，客户可以从一个中心点方便地查看服务提供商对客户订阅的访问权限。客户保持可见性，并精确控制他们委托管理的范围和允许的权限。他们可以监控服务提供商的行为，并在需要时完全删除访问权限。</p><p id="cae1" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">还有一些其他优势，例如，通过市场透明地提供应用程序，其中必须保留管理和支持的责任。对于这些和其他详细功能，最好在这里查阅微软文档<a class="ae lq" href="https://azure.microsoft.com/en-us/services/azure-lighthouse/#features" rel="noopener ugc nofollow" target="_blank">。</a></p><p id="d4d6" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">最重要的是:使用Azure Lighthouse管理Azure资源不需要额外的成本。任何Azure客户或合作伙伴都可以使用Azure Lighthouse！</p><figure class="ls lt lu lv gt lw gh gi paragraph-image"><div role="button" tabindex="0" class="lx ly di lz bf ma"><div class="gh gi mm"><img src="../Images/15addbf4c78386625f42956e20fd497c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*S881GIDqcDMOnIFA9aJR0Q.jpeg"/></div></div><figcaption class="md me gj gh gi mf mg bd b be z dk translated"><a class="ae lq" href="https://unsplash.com/@aycai?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">艾伦蔡</a>在<a class="ae lq" href="https://unsplash.com/s/photos/beacon?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</figcaption></figure><h1 id="e801" class="kl km iq bd kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li bi translated">如何开始使用Azure Lighthouse？</h1><p id="562e" class="pw-post-body-paragraph jn jo iq jp b jq mh js jt ju mi jw jx jy mj ka kb kc mk ke kf kg ml ki kj kk ij bi translated">在这个快速入门中，您将使用PowerShell和Azure资源管理(ARM)模板(JSON)来设置Azure Lighthouse。</p><h2 id="3b5c" class="mn km iq bd kn mo mp dn kr mq mr dp kv jy ms mt kz kc mu mv ld kg mw mx lh my bi translated">开始之前，这里有一些要求:</h2><ul class=""><li id="8972" class="mz na iq jp b jq mh ju mi jy nb kc nc kg nd kk ne nf ng nh bi translated">您需要在管理租户中进行有效的订阅。</li><li id="76a0" class="mz na iq jp b jq ni ju nj jy nk kc nl kg nm kk ne nf ng nh bi translated">您需要一个本地用户帐户，在您想要管理的租户中具有“所有者”角色。</li><li id="9066" class="mz na iq jp b jq ni ju nj jy nk kc nl kg nm kk ne nf ng nh bi translated">你需要Azure AZ PowerShell模块。</li></ul><h2 id="37cd" class="mn km iq bd kn mo mp dn kr mq mr dp kv jy ms mt kz kc mu mv ld kg mw mx lh my bi translated"><strong class="ak">步骤1:从您的管理员租户处检索信息。</strong></h2><p id="5680" class="pw-post-body-paragraph jn jo iq jp b jq mh js jt ju mi jw jx jy mj ka kb kc mk ke kf kg ml ki kj kk ij bi translated">首先，我们将打开一个PowerShell提示符，导入AZ模块，连接到Azure，并登录到我们的Azure租户，使用以下命令:</p><pre class="ls lt lu lv gt nn no np nq aw nr bi"><span id="7d54" class="mn km iq no b gy ns nt l nu nv">Import-Module Az<br/>Connect-AzAccount</span></pre><p id="3e09" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">稍后，我们将需要租户ID。为了检索它，我们使用以下命令并保存输出供以后使用:</p><pre class="ls lt lu lv gt nn no np nq aw nr bi"><span id="dbb2" class="mn km iq no b gy ns nt l nu nv">Get-AzTenant</span></pre><p id="d710" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们现在将设置一个组，该组将获得管理客户订阅的权限。我将使用默认的Azure组“AdminAgents”作为例子，但是你可以创建自己的组。执行以下命令并保存输出，因为稍后我们将需要这个PrincipalId。</p><pre class="ls lt lu lv gt nn no np nq aw nr bi"><span id="be32" class="mn km iq no b gy ns nt l nu nv">(Get-AzADGroup -DisplayName 'AdminAgents').id</span></pre><p id="d901" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果您考虑添加多个角色，可以对要添加的每个组运行此命令。</p><p id="b95c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们现在将为想要管理的订阅设置角色。该角色将应用于目标订阅中的所有资源。执行以下命令并保存输出，因为我们稍后将需要这个roleDefinitionId。</p><pre class="ls lt lu lv gt nn no np nq aw nr bi"><span id="6fea" class="mn km iq no b gy ns nt l nu nv">(Get-AzRoleDefinition -Name 'Contributor').id</span></pre><p id="804b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果您考虑添加多个角色，您可以为每个要添加的角色运行此命令。</p><p id="4893" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir"> <em class="lm">须知:</em> </strong> <em class="lm">不允许使用“所有者”和“用户访问管理员”角色！</em></p><h2 id="b9f1" class="mn km iq bd kn mo mp dn kr mq mr dp kv jy ms mt kz kc mu mv ld kg mw mx lh my bi translated">步骤2:连接并选择客户订阅。</h2><p id="56ea" class="pw-post-body-paragraph jn jo iq jp b jq mh js jt ju mi jw jx jy mj ka kb kc mk ke kf kg ml ki kj kk ij bi translated">我们现在已经完成了管理租户，将继续使用以下Azure PowerShell命令连接到客户:</p><pre class="ls lt lu lv gt nn no np nq aw nr bi"><span id="55d8" class="mn km iq no b gy ns nt l nu nv">Connect-AzAccount</span></pre><p id="6c02" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在我们注册资源提供者之前，我们应该确保我们选择了正确的订阅。执行以下命令:</p><pre class="ls lt lu lv gt nn no np nq aw nr bi"><span id="5735" class="mn km iq no b gy ns nt l nu nv">Get-AzContext</span></pre><p id="68e3" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果返回值不是您想要管理的订阅，那么我们需要首先选择正确的订阅。如果您选择了正确的订阅，您可以跳过下面的部分。</p><p id="8478" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">首先，我们需要使用第一个命令在这个租户中查找当前订阅。其次，我们将使用第二个命令，用第一个命令的输出(subscriptionId)选择它。</p><pre class="ls lt lu lv gt nn no np nq aw nr bi"><span id="d7bc" class="mn km iq no b gy ns nt l nu nv"># First command, lookup current subscriptions in this tenant<br/>Get-AzSubscription</span><span id="b471" class="mn km iq no b gy nw nt l nu nv"># Second command, select the right subscription in this tenant<br/>Set-AzContext -Subscription &lt;subscriptionId&gt;</span></pre><p id="c3cc" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们现在已经选择了正确的订阅，可以继续委托资源管理了。</p><h2 id="fe9d" class="mn km iq bd kn mo mp dn kr mq mr dp kv jy ms mt kz kc mu mv ld kg mw mx lh my bi translated">步骤3:链接和委托资源管理。</h2><p id="1ffb" class="pw-post-body-paragraph jn jo iq jp b jq mh js jt ju mi jw jx jy mj ka kb kc mk ke kf kg ml ki kj kk ij bi translated">现在我们将需要2个文件；模板文件和参数文件。</p><figure class="ls lt lu lv gt lw"><div class="bz fp l di"><div class="nx ny l"/></div></figure><figure class="ls lt lu lv gt lw"><div class="bz fp l di"><div class="nx ny l"/></div></figure><p id="c500" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">将这些文件复制或下载到您的下载文件夹或您选择的文件夹。</p><p id="7375" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir"> <em class="lm">注意事项:</em> </strong> <em class="lm"> </em> <a class="ae lq" href="https://github.com/Azure/Azure-Lighthouse-samples" rel="noopener ugc nofollow" target="_blank"> <em class="lm">微软在GitHub </em> </a> <em class="lm">上发布了这个包含模板/示例的存储库，帮助您使用Azure Resource Manager来配置</em><a class="ae lq" href="https://docs.microsoft.com/azure/lighthouse/concepts/azure-delegated-resource-management" rel="noopener ugc nofollow" target="_blank"><em class="lm">Azure delegated Resource management</em></a><em class="lm">，以及配置对客户环境的监控和管理。这些模板可以用来让客户登陆Azure Lighthouse，并且可以手动部署，或者通过点击按钮直接在Azure门户中部署。</em></p><p id="e7e3" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在参数文件中，我们需要编辑以下字段:</p><ul class=""><li id="3449" class="mz na iq jp b jq jr ju jv jy nz kc oa kg ob kk ne nf ng nh bi translated">您的公司名称。这对客户来说是可见的。</li><li id="759a" class="mz na iq jp b jq ni ju nj jy nk kc nl kg nm kk ne nf ng nh bi translated">对你的公司或服务的描述。</li><li id="ff68" class="mz na iq jp b jq ni ju nj jy nk kc nl kg nm kk ne nf ng nh bi translated"><strong class="jp ir"> managedByTenantId: </strong>您在步骤1中的(管理员)Azure租户Id。</li><li id="6c6c" class="mz na iq jp b jq ni ju nj jy nk kc nl kg nm kk ne nf ng nh bi translated"><strong class="jp ir"> PrincipalId: </strong>您在步骤1中的PrincipalId。</li><li id="6028" class="mz na iq jp b jq ni ju nj jy nk kc nl kg nm kk ne nf ng nh bi translated"><strong class="jp ir"> PrincipalIdDisplayName: </strong>您在第一步中的群组名称。</li><li id="c6a1" class="mz na iq jp b jq ni ju nj jy nk kc nl kg nm kk ne nf ng nh bi translated"><strong class="jp ir">rolefinitionid:</strong>您在步骤1中的rolefinitionid。</li></ul><p id="747f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">应用更改后，参数文件应如下所示:</p><figure class="ls lt lu lv gt lw gh gi paragraph-image"><div role="button" tabindex="0" class="lx ly di lz bf ma"><div class="gh gi oc"><img src="../Images/acf3ba6d75deeb3af1d916d287dab58e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*YAdLfE1hhiQmvkoaYU7b2g.png"/></div></div></figure><p id="b713" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在终于到了用参数文件部署模板文件的时候了。只需在PowerShell中运行以下命令。如果您将文件保存在不同的文件夹中，不要忘记更改路径。</p><pre class="ls lt lu lv gt nn no np nq aw nr bi"><span id="e6ce" class="mn km iq no b gy ns nt l nu nv">New-AzDeployment `</span><span id="df7a" class="mn km iq no b gy nw nt l nu nv">-Name LightHouse `</span><span id="7837" class="mn km iq no b gy nw nt l nu nv">-Location westeurope `</span><span id="0423" class="mn km iq no b gy nw nt l nu nv">-TemplateFile "&lt;your folder&gt;\delegatedResourceManagement.json" `</span><span id="0eda" class="mn km iq no b gy nw nt l nu nv">-TemplateParameterFile "&lt;Your folder&gt;\DelegatedResourceManagement.parameters.json" `</span><span id="3034" class="mn km iq no b gy nw nt l nu nv">-Verbose</span></pre><h2 id="7a39" class="mn km iq bd kn mo mp dn kr mq mr dp kv jy ms mt kz kc mu mv ld kg mw mx lh my bi translated">第四步:验证和管理！</h2><p id="b607" class="pw-post-body-paragraph jn jo iq jp b jq mh js jt ju mi jw jx jy mj ka kb kc mk ke kf kg ml ki kj kk ij bi translated">我们应该验证链接是否已经成功建立。我们可以在Azure门户的“我的客户”部分使用搜索栏进行搜索。您可以在这里验证连接。</p><figure class="ls lt lu lv gt lw gh gi paragraph-image"><div role="button" tabindex="0" class="lx ly di lz bf ma"><div class="gh gi od"><img src="../Images/1f4317eef225db7dfeede61d3d02046c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*0IeZ6YD9Nd5muiE2tRVIYw.png"/></div></div></figure><p id="da78" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">您现在可以开始管理了！您可以通过转到Azure门户右上方的目录+订阅按钮来选择您想要管理的订阅，并选择所需的订阅。</p></div></div>    
</body>
</html>