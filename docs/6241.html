<html>
<head>
<title>Creating a GraphQL API with .NET5 and HotChocolate</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用. NET5和HotChocolate创建GraphQL API</h1>
<blockquote>原文：<a href="https://itnext.io/creating-a-graphql-api-with-net5-and-hotchocolate-6dfe94626d10?source=collection_archive---------2-----------------------#2021-09-28">https://itnext.io/creating-a-graphql-api-with-net5-and-hotchocolate-6dfe94626d10?source=collection_archive---------2-----------------------#2021-09-28</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/d5335b4135b7fe4f17c28186ff3eebba.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*WjVr87nTkybfJLmZM8QFfg.png"/></div></div></figure><p id="b6a4" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在这篇文章中，我将使用HotChocolate帮助您在. NET5中开始使用GraphQL。</p><h1 id="3490" class="kw kx iq bd ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt bi translated">介绍</h1><p id="43da" class="pw-post-body-paragraph jy jz iq ka b kb lu kd ke kf lv kh ki kj lw kl km kn lx kp kq kr ly kt ku kv ij bi translated">GraphQL是一种用于API的查询语言，也是一个用现有数据完成这些查询的运行时。</p><p id="37bb" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><a class="ae lz" href="https://chillicream.com/docs/hotchocolate" rel="noopener ugc nofollow" target="_blank">热巧克力</a>是微软的开源GraphQL服务器。NET平台。这个库消除了构建完全成熟的GraphQL服务器的复杂性，让您专注于快速构建API。</p><p id="24b8" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我们将创建一个简单的应用程序，可用于<strong class="ka ir">创建</strong>、<strong class="ka ir">读取</strong>、<strong class="ka ir">更新</strong>和<strong class="ka ir">删除</strong>一个客户。</p><p id="e9da" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">这个示例的代码可以在GitHub上的<a class="ae lz" href="https://github.com/TSiustis/GraphQLDemo" rel="noopener ugc nofollow" target="_blank"> GraphQLDemo </a>存储库中找到。</p><h1 id="6512" class="kw kx iq bd ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt bi translated">先决条件</h1><ul class=""><li id="7e58" class="ma mb iq ka b kb lu kf lv kj mc kn md kr me kv mf mg mh mi bi translated"><a class="ae lz" href="https://visualstudio.microsoft.com/vs/" rel="noopener ugc nofollow" target="_blank"> Visual Studio 2019 </a></li><li id="5080" class="ma mb iq ka b kb mj kf mk kj ml kn mm kr mn kv mf mg mh mi bi translated"><a class="ae lz" href="https://www.microsoft.com/en-us/sql-server/sql-server-downloads" rel="noopener ugc nofollow" target="_blank"> SQL Server 2019 </a></li></ul><h1 id="119b" class="kw kx iq bd ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt bi translated">创建解决方案和项目</h1><p id="cec7" class="pw-post-body-paragraph jy jz iq ka b kb lu kd ke kf lv kh ki kj lw kl km kn lx kp kq kr ly kt ku kv ij bi translated">我们将需要一个ASP.NET网络应用编程接口项目。打开VS后，点击<strong class="ka ir">新建项目</strong>链接，选择<strong class="ka ir">空白解决方案</strong>，将项目和解决方案命名为<strong class="ka ir"> GraphQLDemo </strong>，点击<strong class="ka ir">创建</strong>。接下来，右键单击该解决方案并选择<strong class="ka ir">添加新项目</strong>并选择<strong class="ka ir">ASP.NET核心Web应用程序，</strong>选择<strong class="ka ir">空项目</strong>并将其命名为<strong class="ka ir"> GraphQLDemo.Api. </strong>通过添加一个名为<strong class="ka ir"> GraphQLDemo.Common. </strong>的<strong class="ka ir">类库</strong>来重复最后一步</p><h1 id="b861" class="kw kx iq bd ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt bi translated">安装依赖项</h1><ul class=""><li id="5b07" class="ma mb iq ka b kb lu kf lv kj mc kn md kr me kv mf mg mh mi bi translated">我们需要安装<a class="ae lz" href="https://chillicream.com/" rel="noopener ugc nofollow" target="_blank">热巧克力。AspNetCore(v11.3.8) </a>包。这个包包含了ASP.NET的GraphQL APIs。要安装这个包，在解决方案浏览器中右键单击这个解决方案，并选择<strong class="ka ir">Manage nu get Packages for Solution</strong>。在浏览部分，搜索<strong class="ka ir">热巧克力。AspNetCore </strong>并点击它，然后在预览面板中点击安装按钮。我们还需要热巧克力。AspNetCore.Playground 和<strong class="ka ir">热巧克力。数据</strong>。对所有包重复该过程。</li><li id="ff96" class="ma mb iq ka b kb mj kf mk kj ml kn mm kr mn kv mf mg mh mi bi translated">安装<strong class="ka ir">微软。EntityFrameworkCore </strong>，<strong class="ka ir">微软。EntityFrameworkCore . SQL server</strong>和<strong class="ka ir">微软。EntityFrameworkCore.Design </strong>分别封装。</li></ul><h1 id="d4bc" class="kw kx iq bd ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt bi translated">实体</h1><p id="bf18" class="pw-post-body-paragraph jy jz iq ka b kb lu kd ke kf lv kh ki kj lw kl km kn lx kp kq kr ly kt ku kv ij bi translated">我们将使用<a class="ae lz" href="https://docs.microsoft.com/en-us/ef/core/" rel="noopener ugc nofollow" target="_blank"> EntityFrameworkCore </a>作为ORM。实体(类)用于定义数据库对象(表)，这些实体被映射到<a class="ae lz" href="https://docs.microsoft.com/en-us/ef/core/dbcontext-configuration/" rel="noopener ugc nofollow" target="_blank"> DbContext </a>中的数据库表。</p><p id="7838" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在这个演示中，我们将定义一个实体，即客户<strong class="ka ir"/>，但是您可以拥有任意多个实体。<br/>数据访问<strong class="ka ir">代码、<strong class="ka ir">存储库</strong>和<strong class="ka ir"> GraphQL </strong>相关类将被拆分到不同的文件夹中。</strong></p><h1 id="fc6b" class="kw kx iq bd ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt bi translated">客户模型</h1><p id="9188" class="pw-post-body-paragraph jy jz iq ka b kb lu kd ke kf lv kh ki kj lw kl km kn lx kp kq kr ly kt ku kv ij bi translated">在<strong class="ka ir"> GraphQLDemo中创建一个文件夹<strong class="ka ir"> Models </strong>。常见的</strong>和新的c#类<strong class="ka ir"> Customer.cs </strong>。这个类的代码是:</p><pre class="mo mp mq mr gt ms mt mu mv aw mw bi"><span id="5cfa" class="mx kx iq mt b gy my mz l na nb">public class Customer</span><span id="e4f3" class="mx kx iq mt b gy nc mz l na nb">{</span><span id="b0fb" class="mx kx iq mt b gy nc mz l na nb">public long Id { get; set; }</span><span id="9be4" class="mx kx iq mt b gy nc mz l na nb">public string Email { get; set; }</span><span id="23de" class="mx kx iq mt b gy nc mz l na nb">public string Name { get; set; }</span><span id="1ccf" class="mx kx iq mt b gy nc mz l na nb">public int? Code { get; set; }</span><span id="7d88" class="mx kx iq mt b gy nc mz l na nb">public DateTime CreatedAt { get; set; }</span><span id="2640" class="mx kx iq mt b gy nc mz l na nb">public bool IsBlocked { get; set; }</span><span id="c71b" class="mx kx iq mt b gy nc mz l na nb">}</span></pre><p id="b92a" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">其余的类将被添加到GraphQLDemo.API中。</p><h1 id="dee0" class="kw kx iq bd ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt bi translated">数据库上下文</h1><p id="63af" class="pw-post-body-paragraph jy jz iq ka b kb lu kd ke kf lv kh ki kj lw kl km kn lx kp kq kr ly kt ku kv ij bi translated">DbContext将非常简单。大多数数据库配置都是在这个文件中完成的。在<strong class="ka ir">数据库</strong>文件夹中添加一个新的C#类文件，命名为<strong class="ka ir">graphqldemodbcontext . cs</strong>。通常以应用程序的名字命名<strong class="ka ir"> DbContext </strong>。该文件的代码是:</p><pre class="mo mp mq mr gt ms mt mu mv aw mw bi"><span id="8bc5" class="mx kx iq mt b gy my mz l na nb">public DbSet&lt;Customer&gt; Customers { get; set; }</span><span id="6c18" class="mx kx iq mt b gy nc mz l na nb">public GraphQLDemoDbContext(DbContextOptions&lt;GraphQLDemoDbContext&gt; options) : base(options)</span><span id="5ea2" class="mx kx iq mt b gy nc mz l na nb">{</span><span id="9a2f" class="mx kx iq mt b gy nc mz l na nb">}</span></pre><p id="b406" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><strong class="ka ir">DbSet&lt;Customer&gt;</strong>定义客户属性，用于将<strong class="ka ir"> Customer.cs </strong>实体映射到数据库中的<strong class="ka ir"> Customer </strong>表。</p><p id="2d75" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">从我的github repo中，您还可以获得一个样本数据播种器。</p><h1 id="b470" class="kw kx iq bd ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt bi translated"><strong class="ak">创建数据库</strong></h1><p id="7873" class="pw-post-body-paragraph jy jz iq ka b kb lu kd ke kf lv kh ki kj lw kl km kn lx kp kq kr ly kt ku kv ij bi translated">在appsettings.json中添加以下行:</p><pre class="mo mp mq mr gt ms mt mu mv aw mw bi"><span id="6d31" class="mx kx iq mt b gy my mz l na nb">"ConnectionStrings": {</span><span id="5904" class="mx kx iq mt b gy nc mz l na nb">"ConnectionString": "Data Source=(localdb)\\MSSQLLocalDB;Initial Catalog=GraphQL;Integrated Security=True;Connect Timeout=30;Encrypt=False;TrustServerCertificate=False;ApplicationIntent=ReadWrite;MultiSubnetFailover=False;"</span><span id="1d1d" class="mx kx iq mt b gy nc mz l na nb">}</span></pre><p id="1929" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在软件包管理器控制台中:</p><ul class=""><li id="5826" class="ma mb iq ka b kb kc kf kg kj nd kn ne kr nf kv mf mg mh mi bi translated">输入命令Add-Migration <yourcustommigrationname/></li><li id="c7c0" class="ma mb iq ka b kb mj kf mk kj ml kn mm kr mn kv mf mg mh mi bi translated">更新-数据库</li></ul><p id="5190" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">该数据库将被创建，名称为<strong class="ka ir"> GraphQL </strong>。</p><h1 id="d4af" class="kw kx iq bd ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt bi translated">客户知识库</h1><p id="0642" class="pw-post-body-paragraph jy jz iq ka b kb lu kd ke kf lv kh ki kj lw kl km kn lx kp kq kr ly kt ku kv ij bi translated">在服务文件夹中添加以下接口<strong class="ka ir"> ICustomerRepository </strong>:</p><pre class="mo mp mq mr gt ms mt mu mv aw mw bi"><span id="2820" class="mx kx iq mt b gy my mz l na nb">public interface  ICustomerRepository</span><span id="ee26" class="mx kx iq mt b gy nc mz l na nb">{</span><span id="fafc" class="mx kx iq mt b gy nc mz l na nb">void Add(Customer customer);</span><span id="5cb7" class="mx kx iq mt b gy nc mz l na nb">void Delete(int id);</span><span id="a4cf" class="mx kx iq mt b gy nc mz l na nb">IQueryable&lt;Customer&gt; GetAll();</span><span id="5cd3" class="mx kx iq mt b gy nc mz l na nb">Customer GetById(int id);</span><span id="f805" class="mx kx iq mt b gy nc mz l na nb">Customer Update(Customer customer);</span><span id="8bf9" class="mx kx iq mt b gy nc mz l na nb">}</span></pre><p id="4e61" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">将一个名为<strong class="ka ir"> CustomerRepository.cs </strong>的实现ICustomerRepository<strong class="ka ir">T47】的C#类文件添加到<strong class="ka ir"> Services </strong>文件夹中:</strong></p><pre class="mo mp mq mr gt ms mt mu mv aw mw bi"><span id="c458" class="mx kx iq mt b gy my mz l na nb">public class CustomerRepository : ICustomerRepository</span><span id="3375" class="mx kx iq mt b gy nc mz l na nb">{</span><span id="db83" class="mx kx iq mt b gy nc mz l na nb">private readonly GraphQLDemoDbContext _dbContext;</span><span id="bb92" class="mx kx iq mt b gy nc mz l na nb">public CustomerRepository(GraphQLDemoDbContext dbContext)</span><span id="b435" class="mx kx iq mt b gy nc mz l na nb">{</span><span id="5773" class="mx kx iq mt b gy nc mz l na nb">_dbContext = dbContext;</span><span id="119f" class="mx kx iq mt b gy nc mz l na nb">}</span><span id="6503" class="mx kx iq mt b gy nc mz l na nb">public void Add(Customer customer)</span><span id="ba7e" class="mx kx iq mt b gy nc mz l na nb">{</span><span id="8d6a" class="mx kx iq mt b gy nc mz l na nb">_dbContext.Customers.Add(customer);</span><span id="07d1" class="mx kx iq mt b gy nc mz l na nb">_dbContext.SaveChanges();</span><span id="13c3" class="mx kx iq mt b gy nc mz l na nb">}</span><span id="9943" class="mx kx iq mt b gy nc mz l na nb">public void Delete(int id)</span><span id="cb80" class="mx kx iq mt b gy nc mz l na nb">{</span><span id="07d0" class="mx kx iq mt b gy nc mz l na nb">var customer = _dbContext.Customers.FirstOrDefault(c =&gt; c.Id == id);</span><span id="03e0" class="mx kx iq mt b gy nc mz l na nb">if (customer != null)</span><span id="8ae7" class="mx kx iq mt b gy nc mz l na nb">{</span><span id="abb0" class="mx kx iq mt b gy nc mz l na nb">_dbContext.Customers.Remove(customer);</span><span id="9b34" class="mx kx iq mt b gy nc mz l na nb">_dbContext.SaveChanges();</span><span id="2f8b" class="mx kx iq mt b gy nc mz l na nb">}</span><span id="8930" class="mx kx iq mt b gy nc mz l na nb">}</span><span id="6c9d" class="mx kx iq mt b gy nc mz l na nb">public IQueryable&lt;Customer&gt; GetAll() =&gt; _dbContext.Customers.AsQueryable();</span><span id="d729" class="mx kx iq mt b gy nc mz l na nb">public Customer GetById(int id) =&gt; _dbContext.Customers.FirstOrDefault(c =&gt; c.Id == id);</span><span id="d956" class="mx kx iq mt b gy nc mz l na nb">public Customer Update(Customer customer)</span><span id="ea73" class="mx kx iq mt b gy nc mz l na nb">{</span><span id="7db7" class="mx kx iq mt b gy nc mz l na nb">var newCustomer = new Customer();</span><span id="210f" class="mx kx iq mt b gy nc mz l na nb">if (newCustomer.Name != null)</span><span id="8d70" class="mx kx iq mt b gy nc mz l na nb">newCustomer.Name = customer.Name;</span><span id="3202" class="mx kx iq mt b gy nc mz l na nb">newCustomer.Code ??= customer.Code;</span><span id="6d5d" class="mx kx iq mt b gy nc mz l na nb">newCustomer.CreatedAt = customer.CreatedAt;</span><span id="a30b" class="mx kx iq mt b gy nc mz l na nb">if (newCustomer.Email != null)</span><span id="2682" class="mx kx iq mt b gy nc mz l na nb">newCustomer.Email = customer.Email;</span><span id="2b6d" class="mx kx iq mt b gy nc mz l na nb">newCustomer.IsBlocked = customer.IsBlocked;</span><span id="b2e4" class="mx kx iq mt b gy nc mz l na nb">newCustomer.Status = customer.Status;</span><span id="3f7d" class="mx kx iq mt b gy nc mz l na nb">_dbContext.Customers.Update(customer);</span><span id="daf7" class="mx kx iq mt b gy nc mz l na nb">_dbContext.SaveChanges();</span><span id="96ca" class="mx kx iq mt b gy nc mz l na nb">return newCustomer;</span><span id="eac0" class="mx kx iq mt b gy nc mz l na nb">}</span></pre><p id="93b3" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">该类定义了返回所有客户列表的<strong class="ka ir"> GetAll() </strong>、<strong class="ka ir"> GetById() </strong>、获取Id并返回客户(如果客户存在则返回null，如果客户不存在则返回null)、<strong class="ka ir"> Add() </strong>方法将客户作为参数并将其添加到数据库中、<strong class="ka ir"> Update() </strong>获取客户并更新客户，以及<strong class="ka ir"> Delete </strong>方法获取Id并删除客户(如果客户不存在)。</p><h1 id="dec6" class="kw kx iq bd ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt bi translated">GraphQL</h1><p id="d23b" class="pw-post-body-paragraph jy jz iq ka b kb lu kd ke kf lv kh ki kj lw kl km kn lx kp kq kr ly kt ku kv ij bi translated">对于REST API，我们使用GET来获取数据，使用POST、PUT、DELETE来修改数据。GET in REST API与GraphQL中的Query相同。POST，PUT，DELETE和突变是一样的。</p><h2 id="57b2" class="mx kx iq bd ky ng nh dn lc ni nj dp lg kj nk nl lk kn nm nn lo kr no np ls nq bi translated">询问</h2><p id="49e7" class="pw-post-body-paragraph jy jz iq ka b kb lu kd ke kf lv kh ki kj lw kl km kn lx kp kq kr ly kt ku kv ij bi translated">将名为<strong class="ka ir"> Query.cs </strong>的新C#类文件添加到<strong class="ka ir"> GraphQL </strong>文件夹中。这个类将包含我们需要执行的所有查询:</p><pre class="mo mp mq mr gt ms mt mu mv aw mw bi"><span id="0d90" class="mx kx iq mt b gy my mz l na nb">public class Query</span><span id="93c2" class="mx kx iq mt b gy nc mz l na nb">{</span><span id="06f6" class="mx kx iq mt b gy nc mz l na nb">[UsePaging]</span><span id="b14a" class="mx kx iq mt b gy nc mz l na nb">[UseFiltering]</span><span id="a7cb" class="mx kx iq mt b gy nc mz l na nb">[UseSorting]</span><span id="fdce" class="mx kx iq mt b gy nc mz l na nb">public IQueryable&lt;Customer&gt; Customers([Service] ICustomerRepository _customerRepository) =&gt; _customerRepository.GetAll();</span><span id="81fa" class="mx kx iq mt b gy nc mz l na nb">public Customer Customer([Service] ICustomerRepository _customerRepository, int id)</span><span id="0c7f" class="mx kx iq mt b gy nc mz l na nb">{</span><span id="ee4b" class="mx kx iq mt b gy nc mz l na nb">var customer = _customerRepository.GetById(id);</span><span id="d6ef" class="mx kx iq mt b gy nc mz l na nb">if (customer == null)</span><span id="4ae2" class="mx kx iq mt b gy nc mz l na nb">{</span><span id="8374" class="mx kx iq mt b gy nc mz l na nb">throw new CustomerNotFoundException() { Id = id };</span><span id="4f67" class="mx kx iq mt b gy nc mz l na nb">}</span><span id="f28c" class="mx kx iq mt b gy nc mz l na nb">return customer;</span><span id="7f26" class="mx kx iq mt b gy nc mz l na nb">}</span><span id="55fc" class="mx kx iq mt b gy nc mz l na nb">}</span></pre><p id="0009" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">Customers()返回所有客户。Customer()返回id指定的客户，如果它存在于数据库中。</p><p id="2b57" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">Query.cs和Mutation.cs中的所有方法都使用<strong class="ka ir">【服务】</strong>标记注入了<strong class="ka ir"> CustomerRepository </strong>。</p><p id="c1d0" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我们还添加了分页、过滤和排序功能，这些功能由HotChocolate库负责。</p><h2 id="aa84" class="mx kx iq bd ky ng nh dn lc ni nj dp lg kj nk nl lk kn nm nn lo kr no np ls nq bi translated">变化</h2><p id="1273" class="pw-post-body-paragraph jy jz iq ka b kb lu kd ke kf lv kh ki kj lw kl km kn lx kp kq kr ly kt ku kv ij bi translated">将名为<strong class="ka ir"> Mutation.cs </strong>的新C#类文件添加到<strong class="ka ir"> GraphQL </strong>文件夹中。这个类将包含我们需要执行的所有突变:</p><pre class="mo mp mq mr gt ms mt mu mv aw mw bi"><span id="f948" class="mx kx iq mt b gy my mz l na nb">public Customer AddCustomer([Service] ICustomerRepository _customerRepository, string name, string email, int? code, DateTime createdAt, bool isBlocked)</span><span id="ff67" class="mx kx iq mt b gy nc mz l na nb">{</span><span id="c9c3" class="mx kx iq mt b gy nc mz l na nb">var customer = new Customer</span><span id="c0d2" class="mx kx iq mt b gy nc mz l na nb">{</span><span id="37e3" class="mx kx iq mt b gy nc mz l na nb">Name = name,</span><span id="79d6" class="mx kx iq mt b gy nc mz l na nb">Email = email,</span><span id="f236" class="mx kx iq mt b gy nc mz l na nb">Code = code,</span><span id="f2c0" class="mx kx iq mt b gy nc mz l na nb">CreatedAt = createdAt,</span><span id="79df" class="mx kx iq mt b gy nc mz l na nb">IsBlocked = isBlocked</span><span id="bde9" class="mx kx iq mt b gy nc mz l na nb">};</span><span id="3e05" class="mx kx iq mt b gy nc mz l na nb">_customerRepository.Add(customer);</span><span id="ce30" class="mx kx iq mt b gy nc mz l na nb">return customer;</span><span id="613c" class="mx kx iq mt b gy nc mz l na nb">}</span><span id="7ebc" class="mx kx iq mt b gy nc mz l na nb">public Customer UpdateCustomer([Service] ICustomerRepository _customerRepository, int id, string? name, string? email, int? code, DateTime? createdAt, bool? isBlocked)</span><span id="68fc" class="mx kx iq mt b gy nc mz l na nb">{</span><span id="0cbf" class="mx kx iq mt b gy nc mz l na nb">var customerToUpdate = _customerRepository.GetById(id);</span><span id="ffd8" class="mx kx iq mt b gy nc mz l na nb">if (customerToUpdate == null) throw new CustomerNotFoundException() { Id = id };</span><span id="333e" class="mx kx iq mt b gy nc mz l na nb">if (name != null)</span><span id="a38f" class="mx kx iq mt b gy nc mz l na nb">customerToUpdate.Name = name;</span><span id="db4d" class="mx kx iq mt b gy nc mz l na nb">if (email != null)</span><span id="bfd0" class="mx kx iq mt b gy nc mz l na nb">customerToUpdate.Email = email;</span><span id="a427" class="mx kx iq mt b gy nc mz l na nb">if (code != null)</span><span id="6e88" class="mx kx iq mt b gy nc mz l na nb">customerToUpdate.Code = code;</span><span id="a212" class="mx kx iq mt b gy nc mz l na nb">if (createdAt != null)</span><span id="309f" class="mx kx iq mt b gy nc mz l na nb">customerToUpdate.CreatedAt = (DateTime)createdAt;</span><span id="fec7" class="mx kx iq mt b gy nc mz l na nb">if (isBlocked != null)</span><span id="7e52" class="mx kx iq mt b gy nc mz l na nb">customerToUpdate.IsBlocked = (bool)isBlocked;</span><span id="c4a3" class="mx kx iq mt b gy nc mz l na nb">_customerRepository.Update(customerToUpdate);</span><span id="9acc" class="mx kx iq mt b gy nc mz l na nb">return customerToUpdate;</span><span id="76c8" class="mx kx iq mt b gy nc mz l na nb">}</span><span id="6df2" class="mx kx iq mt b gy nc mz l na nb">public Customer Delete(int id, [Service] ICustomerRepository _customerRepository)</span><span id="bd3e" class="mx kx iq mt b gy nc mz l na nb">{</span><span id="766b" class="mx kx iq mt b gy nc mz l na nb">var customerToDelete = _customerRepository.GetById(id);</span><span id="68cf" class="mx kx iq mt b gy nc mz l na nb">if (customerToDelete == null)</span><span id="9f1a" class="mx kx iq mt b gy nc mz l na nb">throw new CustomerNotFoundException() { Id = id };</span><span id="0992" class="mx kx iq mt b gy nc mz l na nb">_customerRepository.Delete(id);</span><span id="ac61" class="mx kx iq mt b gy nc mz l na nb">return customerToDelete;</span><span id="d175" class="mx kx iq mt b gy nc mz l na nb">}<br/></span></pre><p id="4154" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">AddCustomer()将客户添加到数据库中，UpdateCustomer()完全或部分更新客户，Delete()根据给定的id(如果存在)删除客户。请注意，所有方法都需要返回要添加/更新/删除的实体，因为GraphQL需要返回它。</p><h1 id="a406" class="kw kx iq bd ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt bi translated">配置GraphQL</h1><p id="052a" class="pw-post-body-paragraph jy jz iq ka b kb lu kd ke kf lv kh ki kj lw kl km kn lx kp kq kr ly kt ku kv ij bi translated">我们需要配置<strong class="ka ir"> Startup.cs </strong>来使用GraphQL。将文件中的代码替换为:</p><pre class="mo mp mq mr gt ms mt mu mv aw mw bi"><span id="a40f" class="mx kx iq mt b gy my mz l na nb">using GraphQLDemo.Api.Database;</span><span id="e78e" class="mx kx iq mt b gy nc mz l na nb">using GraphQLDemo.Api.GraphQL;</span><span id="d64d" class="mx kx iq mt b gy nc mz l na nb">using GraphQLDemo.Api.Services;</span><span id="73b6" class="mx kx iq mt b gy nc mz l na nb">using HotChocolate;</span><span id="0f82" class="mx kx iq mt b gy nc mz l na nb">using HotChocolate.AspNetCore;</span><span id="bac4" class="mx kx iq mt b gy nc mz l na nb">using HotChocolate.AspNetCore.Playground;</span><span id="ba4d" class="mx kx iq mt b gy nc mz l na nb">using Microsoft.AspNetCore.Builder;</span><span id="93c1" class="mx kx iq mt b gy nc mz l na nb">using Microsoft.AspNetCore.Hosting;</span><span id="ecc8" class="mx kx iq mt b gy nc mz l na nb">using Microsoft.AspNetCore.Http;</span><span id="03c4" class="mx kx iq mt b gy nc mz l na nb">using Microsoft.EntityFrameworkCore;</span><span id="88b2" class="mx kx iq mt b gy nc mz l na nb">using Microsoft.Extensions.Configuration;</span><span id="222a" class="mx kx iq mt b gy nc mz l na nb">using Microsoft.Extensions.DependencyInjection;</span><span id="bf28" class="mx kx iq mt b gy nc mz l na nb">using Microsoft.Extensions.Hosting;</span><span id="6190" class="mx kx iq mt b gy nc mz l na nb">namespace GraphQLDemo.Api</span><span id="a3e1" class="mx kx iq mt b gy nc mz l na nb">{</span><span id="e83f" class="mx kx iq mt b gy nc mz l na nb">public class Startup</span><span id="0032" class="mx kx iq mt b gy nc mz l na nb">{</span><span id="8758" class="mx kx iq mt b gy nc mz l na nb">public IConfiguration Configuration { get; }</span><span id="1623" class="mx kx iq mt b gy nc mz l na nb">public Startup(IConfiguration configuration)</span><span id="947a" class="mx kx iq mt b gy nc mz l na nb">{</span><span id="cdd7" class="mx kx iq mt b gy nc mz l na nb">Configuration = configuration;</span><span id="5678" class="mx kx iq mt b gy nc mz l na nb">}</span><span id="b1e5" class="mx kx iq mt b gy nc mz l na nb">public void ConfigureServices(IServiceCollection services)</span><span id="3730" class="mx kx iq mt b gy nc mz l na nb">{</span><span id="bc52" class="mx kx iq mt b gy nc mz l na nb">services.AddScoped&lt;ICustomerRepository, CustomerRepository&gt;();</span><span id="91dc" class="mx kx iq mt b gy nc mz l na nb">services.AddDbContext&lt;GraphQLDemoDbContext&gt;(context =&gt;</span><span id="2c90" class="mx kx iq mt b gy nc mz l na nb">{</span><span id="9076" class="mx kx iq mt b gy nc mz l na nb">context.UseSqlServer(Configuration.GetConnectionString("ConnectionString"),</span><span id="974f" class="mx kx iq mt b gy nc mz l na nb">sqlServerOptionsAction: sqlOptions =&gt;</span><span id="4144" class="mx kx iq mt b gy nc mz l na nb">{</span><span id="231e" class="mx kx iq mt b gy nc mz l na nb">sqlOptions.EnableRetryOnFailure();</span><span id="3a04" class="mx kx iq mt b gy nc mz l na nb">});</span><span id="bfdd" class="mx kx iq mt b gy nc mz l na nb">});</span><span id="35f6" class="mx kx iq mt b gy nc mz l na nb">services.AddGraphQLServer()</span><span id="2e2c" class="mx kx iq mt b gy nc mz l na nb">.AddQueryType&lt;Query&gt;()</span><span id="2e12" class="mx kx iq mt b gy nc mz l na nb">.AddFiltering()</span><span id="e02f" class="mx kx iq mt b gy nc mz l na nb">.AddSorting()</span><span id="953f" class="mx kx iq mt b gy nc mz l na nb">.ModifyRequestOptions(opt =&gt; opt.IncludeExceptionDetails = true)</span><span id="6192" class="mx kx iq mt b gy nc mz l na nb">.AddMutationType&lt;Mutation&gt;();</span><span id="b3fe" class="mx kx iq mt b gy nc mz l na nb">}</span><span id="55b7" class="mx kx iq mt b gy nc mz l na nb">// This method gets called by the runtime. Use this method to configure the HTTP request pipeline.</span><span id="7b0c" class="mx kx iq mt b gy nc mz l na nb">public void Configure(IApplicationBuilder app, IWebHostEnvironment env)</span><span id="694c" class="mx kx iq mt b gy nc mz l na nb">{</span><span id="22f5" class="mx kx iq mt b gy nc mz l na nb">if (env.IsDevelopment())</span><span id="6edc" class="mx kx iq mt b gy nc mz l na nb">{</span><span id="5e46" class="mx kx iq mt b gy nc mz l na nb">app.UseDeveloperExceptionPage();</span><span id="837f" class="mx kx iq mt b gy nc mz l na nb">app.UsePlayground(new PlaygroundOptions</span><span id="737d" class="mx kx iq mt b gy nc mz l na nb">{</span><span id="9cb7" class="mx kx iq mt b gy nc mz l na nb">QueryPath = "/api",</span><span id="7a04" class="mx kx iq mt b gy nc mz l na nb">Path = "/playground"</span><span id="3c72" class="mx kx iq mt b gy nc mz l na nb">});</span><span id="caa3" class="mx kx iq mt b gy nc mz l na nb">}</span><span id="6dc3" class="mx kx iq mt b gy nc mz l na nb">app.UseRouting();</span><span id="7be7" class="mx kx iq mt b gy nc mz l na nb">app.UseEndpoints(endpoints =&gt;</span><span id="bf6d" class="mx kx iq mt b gy nc mz l na nb">{</span><span id="8455" class="mx kx iq mt b gy nc mz l na nb">endpoints.MapGraphQL("/api");</span><span id="1124" class="mx kx iq mt b gy nc mz l na nb">});</span><span id="8eb1" class="mx kx iq mt b gy nc mz l na nb">}</span><span id="6137" class="mx kx iq mt b gy nc mz l na nb">}</span><span id="3f99" class="mx kx iq mt b gy nc mz l na nb">}</span></pre><p id="5449" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在这个文件中，我们为GraphQL、查询和变异配置服务。</p><p id="ecf4" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我们还注册了<strong class="ka ir"> Playground </strong>，一个你可以轻松测试你的GraphQL API的地方。</p><h1 id="d052" class="kw kx iq bd ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt bi translated">运行应用程序</h1><p id="54b9" class="pw-post-body-paragraph jy jz iq ka b kb lu kd ke kf lv kh ki kj lw kl km kn lx kp kq kr ly kt ku kv ij bi translated">构建解决方案并运行应用程序。在您的浏览器中，导航到<a class="ae lz" href="https://localhost:44351/graphql/" rel="noopener ugc nofollow" target="_blank">https://localhost:44351/playground/</a>来测试您的API。</p><p id="2247" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">Query.cs、Mutation.cs中定义的方法已经分别归类在Query和Mutation下。</p><h1 id="e6c2" class="kw kx iq bd ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt bi translated">测试查询</h1><p id="a775" class="pw-post-body-paragraph jy jz iq ka b kb lu kd ke kf lv kh ki kj lw kl km kn lx kp kq kr ly kt ku kv ij bi translated">您可以使用以下查询获得前两个客户:</p><pre class="mo mp mq mr gt ms mt mu mv aw mw bi"><span id="e4ca" class="mx kx iq mt b gy my mz l na nb">query getCustomers{<br/>  customers(first:2){<br/>    edges{<br/>      node{<br/>        id,<br/>        name,<br/>        email,<br/>        code,<br/>        createdAt,<br/>        isBlocked<br/>      }<br/>    }<br/>  }<br/>}</span></pre><p id="1f01" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">由于我们使用分页，我们必须查询客户<a class="ae lz" href="https://chillicream.com/docs/hotchocolate/fetching-data/pagination" rel="noopener ugc nofollow" target="_blank"> <strong class="ka ir">连接</strong> </a> <strong class="ka ir"> </strong>而不是直接查询客户对象。直接通过id查询客户的例子如下:</p><pre class="mo mp mq mr gt ms mt mu mv aw mw bi"><span id="fff4" class="mx kx iq mt b gy my mz l na nb">query getCustomer{<br/>  customer(id:3){<br/>        id,<br/>        name,<br/>        email,<br/>        code,<br/>        createdAt,<br/>        isBlocked <br/>  }<br/>}</span></pre><h1 id="c331" class="kw kx iq bd ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt bi translated">测试突变</h1><p id="9352" class="pw-post-body-paragraph jy jz iq ka b kb lu kd ke kf lv kh ki kj lw kl km kn lx kp kq kr ly kt ku kv ij bi translated">您可以添加具有以下变异的客户:</p><pre class="mo mp mq mr gt ms mt mu mv aw mw bi"><span id="d969" class="mx kx iq mt b gy my mz l na nb">mutation addCustomer{<br/>  addCustomer(name: "John Doe", email:"<a class="ae lz" href="mailto:johndoe@gmail.com" rel="noopener ugc nofollow" target="_blank">johndoe@gmail.com</a>", code: 4, isBlocked: false createdAt:"2020-08-08"){<br/>      id,<br/>      name,<br/>      email,<br/>      createdAt,<br/>      isBlocked<br/>    }<br/>  }</span></pre><p id="0e9a" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">教程到此结束。尝试API并添加您自己的特性！</p></div></div>    
</body>
</html>