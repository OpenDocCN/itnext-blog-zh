<html>
<head>
<title>Kubernetes Secret and Configmap sync</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Kubernetes Secret和配置图同步</h1>
<blockquote>原文：<a href="https://itnext.io/kubernetes-secret-and-configmap-sync-6c6b9f906b0d?source=collection_archive---------2-----------------------#2020-10-25">https://itnext.io/kubernetes-secret-and-configmap-sync-6c6b9f906b0d?source=collection_archive---------2-----------------------#2020-10-25</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/255739f7f838631eddec3ea2588573c4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*dtsIqDD8k4wMCD3s"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">清水久美子在<a class="ae kc" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</figcaption></figure><p id="3460" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">嗨，</p><p id="dd28" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">今天我想说说我为什么写k8s secret sync operator，我是怎么编码的。</p><p id="e872" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">有时我们想在不同的名称空间中使用秘密，不幸的是，我们不能没有任何帮助操作符或手动复制，因为在kubernetes中秘密和配置映射是名称空间。当我们有一些名称空间和秘密时，我们可以复制秘密和配置映射。但是当我们有几十个名称空间时，这可能会非常复杂。正因为如此，我用python和Kopf编写了一个小的Kubernetes操作符。这个项目的名字是Synator，我在Github上开源分享的，你可以在这里查看<a class="ae kc" href="https://github.com/TheYkk/synator" rel="noopener ugc nofollow" target="_blank"/>。</p><p id="d9c0" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">第一次编写K8s操作符，我想选择一个简单的框架。Kopf 非常适合这个。Helm <a class="ae kc" href="https://kopf.readthedocs.io/" rel="noopener ugc nofollow" target="_blank">文档</a>非常好，非常好用。我使用了<a class="ae kc" href="https://github.com/kubernetes-client/python" rel="noopener ugc nofollow" target="_blank"> Kubernetes Python客户端</a>与Kubernetes API进行通信。</p><p id="0890" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">K8s上的synator很好用。我们所要做的就是将<a class="ae kc" href="https://github.com/TheYkk/synator/blob/master/deploy.yml" rel="noopener ugc nofollow" target="_blank"> deploy.yml </a>部署到Kubernetes。</p><figure class="lc ld le lf gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi lb"><img src="../Images/631d33196a19f5410fc41b7ec05b5639.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*KKfFMfFDzwk8iBU4gP1-YA.png"/></div></div></figure><p id="20aa" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在此YAML中有ServiceAccount、ClusterRole和Deployment。ServiceAccount和ClusterRole需要与Kubernetes API进行通信，该API为我们生成令牌并将它们直接注入到pod中。</p><p id="514a" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">部署synator之后，我们可以通过向我们想要的Secret或ConfigMap添加synator/sync=yes注释来启动同步过程。</p><figure class="lc ld le lf gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi lg"><img src="../Images/ee24f9a65c7208b80601ebad63db8090.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*3gXBYpff106HREtJuWIu0Q.png"/></div></div></figure><p id="ed10" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">如果我们只想复制到特定的名称空间，synator/include-namespaces = ' namespace 1，namespace2 '可以用注释来完成。</p><figure class="lc ld le lf gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi lh"><img src="../Images/28156ebc8b2c5b75aa9a1675a3691638.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*UH4iTu3Gg6DkofHyX2KDHg.png"/></div></div></figure><p id="e0c0" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">如果我们不希望它被复制到特定的名称空间，我们可以使用synator/exclude-namespaces = ' kube-system，kube-node-lease '注释。</p><figure class="lc ld le lf gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi li"><img src="../Images/1bf67aaa72ff52c116be4cc75b401b2f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*dLyY8L3rmq_zPIDI2CzMkg.png"/></div></div></figure><p id="a981" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">最后，我想说一下我添加的功能。刷新密码或配置图时，重新启动pod。</p><p id="e78f" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">为此，我们只需将synator/reload:“secret:example”添加到pod模板中。</p><figure class="lc ld le lf gt jr gh gi paragraph-image"><div class="gh gi lj"><img src="../Images/4aa929a1d1db302644a77cfe5043b4d6.png" data-original-src="https://miro.medium.com/v2/resize:fit:938/format:webp/1*mgA7ddrbJeXSZgGkJbj5dw.png"/></div></figure><p id="b6ea" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">感谢您阅读我的文章。祝你工作愉快。</p></div></div>    
</body>
</html>