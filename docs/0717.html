<html>
<head>
<title>Tweaking an EFK stack on Kubernetes: Fluentd configuration and Logtrail</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">调整Kubernetes上的EFK堆栈:Fluentd配置和Logtrail</h1>
<blockquote>原文：<a href="https://itnext.io/tweaking-an-efk-stack-on-kubernetes-fluentd-configuration-and-logtrail-f89d8a5149c9?source=collection_archive---------1-----------------------#2018-05-14">https://itnext.io/tweaking-an-efk-stack-on-kubernetes-fluentd-configuration-and-logtrail-f89d8a5149c9?source=collection_archive---------1-----------------------#2018-05-14</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="8921" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这是我在Kubernetes 上一篇关于EFK的文章的延续。在这篇文章中，我们将主要关注于配置<a class="ae kl" href="https://www.fluentd.org/" rel="noopener ugc nofollow" target="_blank">Fluent d</a>/<a class="ae kl" href="https://fluentbit.io/" rel="noopener ugc nofollow" target="_blank">Fluent Bit</a>，但也会有一个关于Logtrail插件的<a class="ae kl" href="https://www.elastic.co/products/kibana" rel="noopener ugc nofollow" target="_blank"> Kibana </a>调整。</p><h1 id="b87d" class="km kn iq bd ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj bi translated">配置流体d</h1><p id="a878" class="pw-post-body-paragraph jn jo iq jp b jq lk js jt ju ll jw jx jy lm ka kb kc ln ke kf kg lo ki kj kk ij bi translated">这一部分和下一部分将有相同的目标，但一部分将侧重于Fluentd，另一部分将侧重于Fluent Bit。我们的目标是创建一个配置，将不同名称空间的日志分开，并根据它们的标签选择我们想要记录的容器。</p><h1 id="9b83" class="km kn iq bd ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj bi translated">配置守护进程</h1><p id="7751" class="pw-post-body-paragraph jn jo iq jp b jq lk js jt ju ll jw jx jy lm ka kb kc ln ke kf kg lo ki kj kk ij bi translated">我们要做的第一件事是改变Fluentd的DaemonSet。事实上，如果我们使用Fluentd 提供的<a class="ae kl" href="https://github.com/fluent/fluentd-kubernetes-daemonset" rel="noopener ugc nofollow" target="_blank">，配置文件被硬编码到映像中，要更改它并不容易。因此，我们将创建一个Kubernetes ConfigMap，并将其挂载到<code class="fe lp lq lr ls b">/fluentd/etc</code>文件夹中。如果您启用了RBAC，并且应该这样做，不要忘记为Fluentd配置它:</a></p><pre class="lt lu lv lw gt lx ls ly lz aw ma bi"><span id="ffda" class="mb kn iq ls b gy mc md l me mf"># fluentd-rbac.yml<br/># If you have RBAC enabled<br/>apiVersion: v1<br/>kind: ServiceAccount<br/>metadata:<br/>  name: fluentd<br/>  namespace: kube-system<br/>---<br/>apiVersion: rbac.authorization.k8s.io/v1beta1<br/>kind: ClusterRole<br/>metadata:<br/>  name: fluentd<br/>  namespace: kube-system<br/>rules:<br/>- apiGroups:<br/>  - ""<br/>  resources:<br/>  - pods<br/>  - namespaces<br/>  verbs:<br/>  - get<br/>  - list<br/>  - watch<br/>---<br/>kind: ClusterRoleBinding<br/>apiVersion: rbac.authorization.k8s.io/v1beta1<br/>metadata:<br/>  name: fluentd<br/>roleRef:<br/>  kind: ClusterRole<br/>  name: fluentd<br/>  apiGroup: rbac.authorization.k8s.io<br/>subjects:<br/>- kind: ServiceAccount<br/>  name: fluentd<br/>  namespace: kube-system</span></pre><p id="c7df" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在关于达蒙塞特:</p><pre class="lt lu lv lw gt lx ls ly lz aw ma bi"><span id="4db8" class="mb kn iq ls b gy mc md l me mf"># fluentd-daemonset.yml<br/>apiVersion: extensions/v1beta1<br/>kind: DaemonSet<br/>metadata:<br/>  name: fluentd<br/>  labels:<br/>    k8s-app: fluentd-logging<br/>    version: v1<br/>    kubernetes.io/cluster-service: "true"<br/>spec:<br/>  template:<br/>    metadata:<br/>      labels:<br/>        k8s-app: fluentd-logging<br/>        version: v1<br/>        kubernetes.io/cluster-service: "true"<br/>    spec:<br/>      serviceAccount: fluentd # if RBAC is enabled<br/>      serviceAccountName: fluentd # if RBAC is enabled<br/>      tolerations:<br/>      - key: node-role.kubernetes.io/master<br/>        effect: NoSchedule<br/>      containers:<br/>      - name: fluentd<br/>        image: fluent/fluentd-kubernetes-daemonset:v1.1-debian-elasticsearch<br/>        env:<br/>        - name:  FLUENT_ELASTICSEARCH_HOST<br/>          value: "elasticsearch"<br/>        - name:  FLUENT_ELASTICSEARCH_PORT<br/>          value: "9200"<br/>        - name: FLUENT_ELASTICSEARCH_SCHEME<br/>          value: "http"<br/>        - name: FLUENT_ELASTICSEARCH_USER # even if not used they are necessary<br/>          value: "foo"<br/>        - name: FLUENT_ELASTICSEARCH_PASSWORD # even if not used they are necessary<br/>          value: "bar"<br/>        resources:<br/>          limits:<br/>            memory: 200Mi<br/>          requests:<br/>            cpu: 100m<br/>            memory: 200Mi<br/>        volumeMounts:<br/>        - name: varlog<br/>          mountPath: /var/log<br/>        - name: varlibdockercontainers<br/>          mountPath: /var/lib/docker/containers<br/>          readOnly: <strong class="ls ir">true</strong><br/>        - name: fluentd-config<br/>          mountPath: /fluentd/etc # path of fluentd config file<br/>      terminationGracePeriodSeconds: 30<br/>      volumes:<br/>      - name: varlog<br/>        hostPath:<br/>          path: /var/log<br/>      - name: varlibdockercontainers<br/>        hostPath:<br/>          path: /var/lib/docker/containers<br/>      - name: fluentd-config<br/>        configMap:<br/>          name: fluentd-config # name of the config map we will create</span></pre><blockquote class="mg mh mi"><p id="7dc3" class="jn jo mj jp b jq jr js jt ju jv jw jx mk jz ka kb ml kd ke kf mm kh ki kj kk ij bi translated"><em class="iq">注意，我们使用的是Fluentd v1。有些配置在v0.12上不起作用！</em></p></blockquote><p id="5f51" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">你可能会奇怪我为什么加了<code class="fe lp lq lr ls b">FLUENT_ELASTICSEARCH_PASSWORD</code>和<code class="fe lp lq lr ls b">FLUENT_ELASTICSEARCH_USER</code>。这是因为如果没有设置这些环境变量，Docker映像<a class="ae kl" href="https://hub.docker.com/r/fluent/fluentd-kubernetes-daemonset/" rel="noopener ugc nofollow" target="_blank">fluent/fluentd-kubernetes-daemon set</a>将使用配置文件上的<code class="fe lp lq lr ls b">sed</code>，并且由于ConfigMap是只读的，因此容器将无法启动。我们可以改变DaemonSet的基本图像，但添加这两行更简单，而且没有坏处。</p><p id="4df1" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">随着DaemonSet的创建，我们现在可以专注于我们的<code class="fe lp lq lr ls b">fluentd-config</code>配置图。</p><h1 id="52e0" class="km kn iq bd ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj bi translated">创建配置图</h1><p id="bfce" class="pw-post-body-paragraph jn jo iq jp b jq lk js jt ju ll jw jx jy lm ka kb kc ln ke kf kg lo ki kj kk ij bi translated">以下是Kubernetes的基本Fluentd配置(你可以在他们的文档中了解更多关于配置Fluentd的信息):</p><pre class="lt lu lv lw gt lx ls ly lz aw ma bi"><span id="dc2e" class="mb kn iq ls b gy mc md l me mf"># fluentd-config-map.yml<br/>apiVersion: v1<br/>kind: ConfigMap<br/>metadata:<br/>  name: fluentd-config<br/>data:<br/>  fluent.conf: |<br/>    &lt;match fluent.**&gt;<br/>        # this tells fluentd to not output its log on stdout<br/>        @type null<br/>    &lt;/match&gt;<br/><br/>    # here we read the logs from Docker's containers and parse them<br/>    &lt;source&gt;<br/>      @type tail<br/>      path /var/log/containers/*.log<br/>      pos_file /var/log/fluentd-containers.log.pos<br/>      tag kubernetes.*<br/>      read_from_head true<br/>      &lt;parse&gt;<br/>        @type json<br/>        time_format %Y-%m-%dT%H:%M:%S.%NZ<br/>      &lt;/parse&gt;      <br/>    &lt;/source&gt;<br/><br/>    # we use kubernetes metadata plugin to add metadatas to the log<br/>    &lt;filter kubernetes.**&gt;<br/>        @type kubernetes_metadata<br/>    &lt;/filter&gt;<br/><br/>    # we send the logs to Elasticsearch<br/>    &lt;match kubernetes.**&gt;<br/>        @type elasticsearch<br/>        include_tag_key true<br/>        host "#{ENV['FLUENT_ELASTICSEARCH_HOST']}"<br/>        port "#{ENV['FLUENT_ELASTICSEARCH_PORT']}"<br/>        scheme "#{ENV['FLUENT_ELASTICSEARCH_SCHEME'] || 'http'}"<br/>        ssl_verify "#{ENV['FLUENT_ELASTICSEARCH_SSL_VERIFY'] || 'true'}"<br/>        user "#{ENV['FLUENT_ELASTICSEARCH_USER']}" # remove these lines if not needed<br/>        password "#{ENV['FLUENT_ELASTICSEARCH_PASSWORD']}" # remove these lines if not needed<br/>        reload_connections true<br/>        logstash_prefix logstash<br/>        logstash_format true<br/>        &lt;buffer&gt;<br/>            flush_thread_count 8<br/>            flush_interval 5s<br/>            chunk_limit_size 2M<br/>            queue_limit_length 32<br/>            retry_max_interval 30<br/>            retry_forever true<br/>        &lt;/buffer&gt;<br/>    &lt;/match&gt;</span></pre><blockquote class="mg mh mi"><p id="0494" class="jn jo mj jp b jq jr js jt ju jv jw jx mk jz ka kb ml kd ke kf mm kh ki kj kk ij bi translated"><em class="iq">我们使用的Docker镜像中已经安装了</em> <a class="ae kl" href="https://github.com/fabric8io/fluent-plugin-kubernetes_metadata_filter" rel="noopener ugc nofollow" target="_blank"> <em class="iq"> Kubernetes元数据插件</em> </a> <em class="iq">。</em></p></blockquote><p id="b4ad" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这种配置与Fluentd提供的配置大致相同。现在，如果您不想发送<code class="fe lp lq lr ls b">kube-system</code>容器的日志，您可以在Elasticsearch输出之前添加以下几行:</p><pre class="lt lu lv lw gt lx ls ly lz aw ma bi"><span id="6a3e" class="mb kn iq ls b gy mc md l me mf">&lt;match kubernetes.var.log.containers.**kube-system**.log&gt;<br/>    @type null<br/>&lt;/match&gt;</span></pre><h1 id="7638" class="km kn iq bd ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj bi translated">分割关于名称空间的日志</h1><p id="064b" class="pw-post-body-paragraph jn jo iq jp b jq lk js jt ju ll jw jx jy lm ka kb kc ln ke kf kg lo ki kj kk ij bi translated">让我们假设您想要根据容器的名称空间来分离日志。例如，您可以将日志从<code class="fe lp lq lr ls b">dev</code>名称空间发送到一个Elasticsearch集群，将日志从<code class="fe lp lq lr ls b">production</code>名称空间发送到另一个集群。为了实现它，我们将使用<a class="ae kl" href="https://github.com/fluent/fluent-plugin-rewrite-tag-filter" rel="noopener ugc nofollow" target="_blank">重写标签过滤器</a>。在元数据插件之后，我们可以添加:</p><pre class="lt lu lv lw gt lx ls ly lz aw ma bi"><span id="9807" class="mb kn iq ls b gy mc md l me mf"># this add the namespace name at the begining of the tag<br/>&lt;match kubernetes.**&gt;<br/>    @type rewrite_tag_filter<br/>    &lt;rule&gt;<br/>        key $['kubernetes']['namespace_name']<br/>        pattern ^(.+)$<br/>        tag $1.${tag}<br/>    &lt;/rule&gt;<br/>&lt;/match&gt;</span></pre><p id="f060" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">然后我们可以有这样的输出:</p><pre class="lt lu lv lw gt lx ls ly lz aw ma bi"><span id="12f9" class="mb kn iq ls b gy mc md l me mf"># match the dev logs<br/>&lt;match dev.kubernetes.**&gt;<br/>    @type elasticsearch<br/>    include_tag_key true<br/>    host "#{ENV['FLUENT_ELASTICSEARCH_HOST_DEV']}"<br/>    port "#{ENV['FLUENT_ELASTICSEARCH_PORT_DEV']}"<br/>    scheme "#{ENV['FLUENT_ELASTICSEARCH_SCHEME_DEV'] || 'http'}"<br/>    ...<br/>&lt;/match&gt;<br/># match the production logs<br/>&lt;match production.kubernetes.**&gt;<br/>    @type elasticsearch<br/>    include_tag_key true<br/>    host "#{ENV['FLUENT_ELASTICSEARCH_HOST_PROD']}"<br/>    port "#{ENV['FLUENT_ELASTICSEARCH_PORT_PROD']}"<br/>    scheme "#{ENV['FLUENT_ELASTICSEARCH_SCHEME_PROD'] || 'http'}"<br/>    ...<br/>&lt;/match&gt;</span></pre><blockquote class="mg mh mi"><p id="3c86" class="jn jo mj jp b jq jr js jt ju jv jw jx mk jz ka kb ml kd ke kf mm kh ki kj kk ij bi translated"><em class="iq">这只是一个例子，让你的想象力发挥更大的作用:)！</em></p></blockquote><h1 id="f785" class="km kn iq bd ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj bi translated">选择要记录的容器</h1><p id="e22f" class="pw-post-body-paragraph jn jo iq jp b jq lk js jt ju ll jw jx jy lm ka kb kc ln ke kf kg lo ki kj kk ij bi translated">现在，我们要选择要记录或不记录哪些容器。使用<a class="ae kl" href="https://docs.fluentd.org/v1.0/articles/filter_grep" rel="noopener ugc nofollow" target="_blank"> grep过滤器</a>是可能的(这只适用于Fluentd v1，因为嵌套键似乎不适用于v0.12)。</p><p id="19ed" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这里的想法是给想要记录的容器或者不想记录的容器添加一个标签。有两种方法:要么我们标记所有想要记录的容器；或者那些我们不想记录的。</p><p id="db64" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">例如，如果我们添加<code class="fe lp lq lr ls b">fluentd: "true"</code>作为我们想要记录的容器的标签，那么我们需要添加:</p><pre class="lt lu lv lw gt lx ls ly lz aw ma bi"><span id="5613" class="mb kn iq ls b gy mc md l me mf">&lt;filter kubernetes.**&gt;<br/>    @type grep<br/>    &lt;regexp&gt;<br/>        key $.kubernetes.labels.fluentd<br/>        pattern true<br/>    &lt;/regexp&gt;<br/>&lt;/filter&gt;</span></pre><p id="bb6c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">或者类似地，如果我们添加<code class="fe lp lq lr ls b">fluentd: "false"</code>作为我们不想记录的容器的标签，我们将添加:</p><pre class="lt lu lv lw gt lx ls ly lz aw ma bi"><span id="ebd0" class="mb kn iq ls b gy mc md l me mf">&lt;filter kubernetes.**&gt;<br/>    @type grep<br/>    &lt;exclude&gt;<br/>        key $.kubernetes.labels.fluentd<br/>        pattern false<br/>    &lt;/exclude&gt;<br/>&lt;/filter&gt;</span></pre><p id="7243" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这就是Fluentd配置。同样，如果你想要更多的配置选项，请查看Fluentd和我们使用的插件的文档。</p><h1 id="e423" class="km kn iq bd ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj bi translated">配置流畅位</h1><p id="0154" class="pw-post-body-paragraph jn jo iq jp b jq lk js jt ju ll jw jx jy lm ka kb kc ln ke kf kg lo ki kj kk ij bi translated">不幸的是，像我们刚刚为Fluentd所做的那样配置Fluent Bit工作还不行(还不行？)有可能。实现这一点的一种方法是将Fluent Bit连接到Fluentd聚合器，但我不会在这里介绍它。你可以在<a class="ae kl" href="https://github.com/fluent/fluent-bit-docs/blob/master/output/forward.md" rel="noopener ugc nofollow" target="_blank"> fluent Github repo </a>上找到一些关于它的信息。</p><h1 id="0cf6" class="km kn iq bd ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj bi translated">让我们用Logtrail插件稍微调整一下Kibana</h1><figure class="lt lu lv lw gt mo gh gi paragraph-image"><div role="button" tabindex="0" class="mp mq di mr bf ms"><div class="gh gi mn"><img src="../Images/8fb732d68d0e4e6b79ad07f3f2190e19.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*fYWc6v7NPY8yDNAd.png"/></div></div></figure><blockquote class="mg mh mi"><p id="6c72" class="jn jo mj jp b jq jr js jt ju jv jw jx mk jz ka kb ml kd ke kf mm kh ki kj kk ij bi translated"><em class="iq"> Logtrail </em> <em class="iq">是Kibana的一个插件，通过devops友好的界面实时查看、分析、搜索和跟踪来自多个主机的日志事件，其灵感来自</em><a class="ae kl" href="https://papertrailapp.com/" rel="noopener ugc nofollow" target="_blank"><em class="iq">paper trail</em></a><em class="iq">。</em></p></blockquote><p id="d331" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">首先我们需要安装插件(Kibana 5。X &amp; 6。仅限x)。要安装这个插件，你需要一个Logtrail版本的URL。你可以在这里查看它们。</p><blockquote class="mg mh mi"><p id="ecb2" class="jn jo mj jp b jq jr js jt ju jv jw jx mk jz ka kb ml kd ke kf mm kh ki kj kk ij bi translated">您必须获取与您的Kibana版本相对应的URL。</p></blockquote><p id="0f90" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在，您可以像这样用Logtrail插件构建映像(假设您想要Kibana 6.2.4):</p><pre class="lt lu lv lw gt lx ls ly lz aw ma bi"><span id="cbd4" class="mb kn iq ls b gy mc md l me mf">FROM docker.elastic.co/kibana/kibana-oss:6.2.4<br/>RUN kibana-plugin install https://github.com/sivasamyk/logtrail/releases/download/v0.1.27/logtrail-6.2.4-0.1.27.zip<br/>WORKDIR /config<br/>USER root<br/>RUN mv /usr/share/kibana/plugins/logtrail/logtrail.json /config/logtrail.json &amp;&amp; \<br/>    ln -s /config/logtrail.json /usr/share/kibana/plugins/logtrail/logtrail.json<br/>USER kibana</span></pre><p id="9896" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">或者从我的docker hub:<a class="ae kl" href="https://hub.docker.com/r/sh4d1/kibana-logtrail/" rel="noopener ugc nofollow" target="_blank">sh4d 1/ki Bana-log trail</a>拉图</p><blockquote class="mg mh mi"><p id="6f3f" class="jn jo mj jp b jq jr js jt ju jv jw jx mk jz ka kb ml kd ke kf mm kh ki kj kk ij bi translated"><em class="iq">我只有</em> <code class="fe lp lq lr ls b"><em class="iq">6.2.4</em></code> <em class="iq">标签。</em></p></blockquote><p id="dd6b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">下一步是配置Logtrail，我们将使用配置映射。以下是Kibana的配置图和部署:</p><pre class="lt lu lv lw gt lx ls ly lz aw ma bi"><span id="ffcb" class="mb kn iq ls b gy mc md l me mf">apiVersion: v1<br/>kind: ConfigMap<br/>metadata:<br/>  name: logtrail-config<br/>data:<br/>  logtrail.json: |<br/>    {<br/>        "version" : 1,<br/>        "index_patterns" : [<br/>        {      <br/>            "es": {<br/>                "default_index": "logstash-*"<br/>            },<br/>            "tail_interval_in_seconds": 10,<br/>            "es_index_time_offset_in_seconds": 0,<br/>            "display_timezone": "local",<br/>            "display_timestamp_format": "MMM DD HH:mm:ss",<br/>            "max_buckets": 500,<br/>            "default_time_range_in_days" : 0,<br/>            "max_hosts": 100,<br/>            "max_events_to_keep_in_viewer": 5000,<br/>            "fields" : {<br/>                "mapping" : {<br/>                    "timestamp" : "@timestamp",<br/>                    "hostname" : "kubernetes.host",<br/>                    "program": "kubernetes.pod_name",<br/>                    "message": "log"<br/>                },<br/>                "message_format": "{{{log}}}"<br/>            },<br/>            "color_mapping" : {<br/>            }<br/>        }]<br/>    } <br/>---<br/>apiVersion: apps/v1beta1<br/>kind: Deployment<br/>metadata:<br/>  name: kibana<br/>  labels:<br/>    component: kibana<br/>spec:<br/>  replicas: 1<br/>  selector:<br/>    matchLabels:<br/>     component: kibana<br/>  template:<br/>    metadata:<br/>      labels:<br/>        component: kibana<br/>    spec:<br/>      containers:<br/>      - name: kibana<br/>        image: sh4d1/kibana-logtrail:6.2.4 # or your image<br/>        volumeMounts:<br/>          - name: logtrail-config<br/>            mountPath: /config<br/>        env:<br/>        - name: CLUSTER_NAME<br/>          value: myesdb # the name of your ES cluster<br/>        resources:<br/>          limits:<br/>            cpu: 1000m<br/>          requests:<br/>            cpu: 100m<br/>        ports:<br/>        - containerPort: 5601<br/>          name: http<br/>      volumes:<br/>        - name: logtrail-config<br/>          configMap:<br/>            name: logtrail-config</span></pre><p id="aeee" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">所以让我们来看看Logtrail的配置。第一点是<code class="fe lp lq lr ls b">default-index</code>；必须设置为Elasticsearch使用的索引。<br/>那么重要的部分就是<code class="fe lp lq lr ls b">fields</code>部分了。它将显示如下:</p><pre class="lt lu lv lw gt lx ls ly lz aw ma bi"><span id="555a" class="mb kn iq ls b gy mc md l me mf">timestamp hostname program:message</span></pre><p id="e5f5" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><code class="fe lp lq lr ls b">message</code>在<code class="fe lp lq lr ls b">message_format</code>中定义。我们可以放一些类似于<code class="fe lp lq lr ls b">{{{docker.container_id}}}: {{{log}}}</code>的东西。<br/>关于进一步的配置，您可以查看<a class="ae kl" href="https://github.com/sivasamyk/logtrail" rel="noopener ugc nofollow" target="_blank"> sivasamyk </a>的存储库。</p><p id="8458" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果您有任何问题，请随时向<a class="ae kl" href="mailto:patrik@ptrk.io" rel="noopener ugc nofollow" target="_blank">发送电子邮件</a>或通过<a class="ae kl" href="https://dockercommunity.slack.com/" rel="noopener ugc nofollow" target="_blank"> Docker Slack社区</a> @Sh4d1联系我</p></div><div class="ab cl mv mw hu mx" role="separator"><span class="my bw bk mz na nb"/><span class="my bw bk mz na nb"/><span class="my bw bk mz na"/></div><div class="ij ik il im in"><p id="32f6" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><em class="mj">原载于2018年5月14日</em><a class="ae kl" href="https://blog.ptrk.io/tweaking-an-efk-stack-on-kubernetes/" rel="noopener ugc nofollow" target="_blank"><em class="mj">blog . ptrk . io</em></a><em class="mj">。</em></p></div></div>    
</body>
</html>