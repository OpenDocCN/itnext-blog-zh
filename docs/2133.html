<html>
<head>
<title>Google Kubernetes Engine — HorizontalPodAutoscaler with external metrics from PubSub</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Google Kubernetes引擎——具有来自PubSub的外部指标的HorizontalPodAutoscaler</h1>
<blockquote>原文：<a href="https://itnext.io/google-kubernetes-engine-horizontalpodautoscaler-with-external-metrics-from-pubsub-28780c300305?source=collection_archive---------5-----------------------#2019-04-05">https://itnext.io/google-kubernetes-engine-horizontalpodautoscaler-with-external-metrics-from-pubsub-28780c300305?source=collection_archive---------5-----------------------#2019-04-05</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="50a0" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在某些用例中，基于cpu使用率的水平扩展并不真正有效。假设你在Kubernetes有一个消费者工人池。消费者从PubSub主题中提取消息。当队列填满时，我们希望有更多的工作人员快速处理消息。另一方面，当队列为空时，我们不想为闲置的大型工作池付费。借助在GKE上运行的PubSub Stackdriver metrics适配器，我们可以轻松地自动扩展我们的工人池，以实现最小的延迟和最大的成本效益。</p></div><div class="ab cl kl km hu kn" role="separator"><span class="ko bw bk kp kq kr"/><span class="ko bw bk kp kq kr"/><span class="ko bw bk kp kq"/></div><div class="ij ik il im in"><h1 id="7cba" class="ks kt iq bd ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp bi translated">使用外部指标自动扩展部署</h1><p id="01f1" class="pw-post-body-paragraph jn jo iq jp b jq lq js jt ju lr jw jx jy ls ka kb kc lt ke kf kg lu ki kj kk ij bi translated">本教程演示了如何根据<a class="ae lv" href="https://cloud.google.com/stackdriver/" rel="noopener ugc nofollow" target="_blank"> Stackdriver </a>中可用的指标自动扩展您的GKE工作负载。</p><p id="2728" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果您希望基于Kubernetes工作负载导出的指标或附加到Kubernetes对象(如Pod或Node)的指标进行自动扩展，请访问<a class="ae lv" href="https://cloud.google.com/kubernetes-engine/docs/tutorials/custom-metrics-autoscaling" rel="noopener ugc nofollow" target="_blank">使用自定义指标进行自动扩展部署</a>。</p><p id="aaf7" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">该示例显示了基于<a class="ae lv" href="https://cloud.google.com/pubsub/" rel="noopener ugc nofollow" target="_blank">云发布/订阅</a>中未送达消息数量的自动缩放，但是该说明可以应用于Stackdriver中可用的任何指标。</p><figure class="lx ly lz ma gt mb gh gi paragraph-image"><div role="button" tabindex="0" class="mc md di me bf mf"><div class="gh gi lw"><img src="../Images/9feeb4e346a9343fd49af5d8e0898875.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*pSXgqW6IeOmktiv5s8e7sw.png"/></div></div><figcaption class="mi mj gj gh gi mk ml bd b be z dk translated">堆栈驱动云发布/订阅监控</figcaption></figure><h1 id="0782" class="ks kt iq bd ku kv mm kx ky kz mn lb lc ld mo lf lg lh mp lj lk ll mq ln lo lp bi translated">提供GCP资源</h1><p id="b5d3" class="pw-post-body-paragraph jn jo iq jp b jq lq js jt ju lr jw jx jy ls ka kb kc lt ke kf kg lu ki kj kk ij bi translated">我们将在这里使用terraform来提供所有必要的GCP资源。集群和节点池的定义在文件<a class="ae lv" href="https://raw.githubusercontent.com/marekaf/gke-hpa-stackdriver-pubsub/master/main.tf" rel="noopener ugc nofollow" target="_blank"> main.tf </a>中。确保按照README中的所有步骤为terraform创建一个服务帐户，并拥有创建所有资源所需的所有权限。</p><p id="794d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">然后运行:</p><pre class="lx ly lz ma gt mr ms mt mu aw mv bi"><span id="1b5c" class="mw kt iq ms b gy mx my l mz na">terraform init<br/>terraform plan -out planfile<br/>terraform apply planfile</span></pre><p id="0a9d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">PubSub主题将被命名为“echo”，对它的订阅为“echo-read”。如果您已成功运行terraform apply，则已经提供了此功能。</p><pre class="lx ly lz ma gt mr ms mt mu aw mv bi"><span id="0024" class="mw kt iq ms b gy mx my l mz na">resource "google_pubsub_topic" "echo" {<br/>  name = "echo"<br/>}<br/><br/>resource "google_pubsub_subscription" "echo" {<br/>  name  = "echo-read"<br/>  topic = "${google_pubsub_topic.echo.name}"<br/><br/>  ack_deadline_seconds = 20<br/>}</span></pre><h1 id="e4d0" class="ks kt iq bd ku kv mm kx ky kz mn lb lc ld mo lf lg lh mp lj lk ll mq ln lo lp bi translated">部署Stackdriver指标适配器</h1><p id="f1d8" class="pw-post-body-paragraph jn jo iq jp b jq lq js jt ju lr jw jx jy ls ka kb kc lt ke kf kg lu ki kj kk ij bi translated">确保您已经安装了kubectl，并且您可以<a class="ae lv" href="https://cloud.google.com/kubernetes-engine/docs/how-to/cluster-access-for-kubectl" rel="noopener ugc nofollow" target="_blank">访问集群</a>。</p><p id="4f63" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">部署stackdriver适配器:</p><pre class="lx ly lz ma gt mr ms mt mu aw mv bi"><span id="edd3" class="mw kt iq ms b gy mx my l mz na">kubectl create -f https://raw.githubusercontent.com/GoogleCloudPlatform/k8s-stackdriver/master/custom-metrics-stackdriver-adapter/deploy/production/adapter.yaml</span></pre><h1 id="315b" class="ks kt iq bd ku kv mm kx ky kz mn lb lc ld mo lf lg lh mp lj lk ll mq ln lo lp bi translated">部署HPA和部署</h1><p id="8918" class="pw-post-body-paragraph jn jo iq jp b jq lq js jt ju lr jw jx jy ls ka kb kc lt ke kf kg lu ki kj kk ij bi translated">以下是HPA的定义:</p><pre class="lx ly lz ma gt mr ms mt mu aw mv bi"><span id="f960" class="mw kt iq ms b gy mx my l mz na">apiVersion: autoscaling/v2beta1<br/>kind: HorizontalPodAutoscaler<br/>metadata:<br/>  name: pubsub<br/>spec:<br/>  minReplicas: 1<br/>  maxReplicas: 5<br/>  metrics:<br/>  - external:<br/>      metricName: pubsub.googleapis.com|subscription|num_undelivered_messages<br/>      metricSelector:<br/>        matchLabels:<br/>          resource.labels.subscription_id: echo-read<br/>      targetAverageValue: "2"<br/>    type: External<br/>  scaleTargetRef:<br/>    apiVersion: apps/v1<br/>    kind: Deployment<br/>    name: pubsub</span></pre><p id="fca1" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们将根据来自我们的<em class="nb"> echo-read </em>订阅的外部指标<em class="nb">pubsub . Google APIs . com | subscription | num _ un delivered _ messages</em>，在1到5个副本之间自动缩放。</p><p id="ca7d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">目标值是2封未送达邮件。但是它实际上意味着什么呢？</p><p id="5d27" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">例如:假设我的部署当前正在运行<strong class="jp ir"> 3 </strong>个副本，我的队列从6个未送达的消息增加到8个。<br/>我每个副本有8/ <strong class="jp ir"> 3 </strong> =2.6条未送达的消息。<br/>达到阈值并触发向外扩展到<strong class="jp ir"> 4个</strong>副本，每个副本将有8/ <strong class="jp ir"> 4 </strong> =2条未送达的消息，并且符合所需的targetAverageValue值。<br/>如果我有50封未送达的邮件，我将有5个副本，因为这是我的最大值。<br/>如果我有0封未送达的邮件，我将有1个副本，因为这是我的最小值。</p><p id="5580" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><em class="nb">scaletargerref</em>是我正在自动缩放的资源的引用。它是在文件<a class="ae lv" href="https://raw.githubusercontent.com/marekaf/gke-hpa-stackdriver-pubsub/master/pubsub-deployment.yaml" rel="noopener ugc nofollow" target="_blank"> pubsub-deployment.yaml </a>中定义的部署。</p><p id="b480" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">使用将要自动扩展的部署来部署HPA:</p><pre class="lx ly lz ma gt mr ms mt mu aw mv bi"><span id="d7f2" class="mw kt iq ms b gy mx my l mz na">kubectl apply -f  pubsub-hpa.yaml<br/>kubectl apply -f  pubsub-deployment.yaml</span></pre><h1 id="7343" class="ks kt iq bd ku kv mm kx ky kz mn lb lc ld mo lf lg lh mp lj lk ll mq ln lo lp bi translated">测试一下！</h1><p id="5111" class="pw-post-body-paragraph jn jo iq jp b jq lq js jt ju lr jw jx jy ls ka kb kc lt ke kf kg lu ki kj kk ij bi translated">向主题发布一些消息</p><pre class="lx ly lz ma gt mr ms mt mu aw mv bi"><span id="2c08" class="mw kt iq ms b gy mx my l mz na">for i in {1..200}; do <br/>  gcloud pubsub topics publish echo --message=”Autoscaling #${i}”<br/>done</span></pre><p id="14ac" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">并观察集群资源的神奇表现</p><pre class="lx ly lz ma gt mr ms mt mu aw mv bi"><span id="39ba" class="mw kt iq ms b gy mx my l mz na">watch 'kubectl get pods; echo ; kubectl get hpa'</span></pre><figure class="lx ly lz ma gt mb gh gi paragraph-image"><div role="button" tabindex="0" class="mc md di me bf mf"><div class="gh gi nc"><img src="../Images/ec87c820a4f00cf87219068a841eaad1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*lVSKrIk7h1zrEypNURYZuQ.png"/></div></div><figcaption class="mi mj gj gh gi mk ml bd b be z dk translated">饱和队列上的横向扩展</figcaption></figure><figure class="lx ly lz ma gt mb gh gi paragraph-image"><div role="button" tabindex="0" class="mc md di me bf mf"><div class="gh gi nd"><img src="../Images/8d9d723cf9b56e0c20f0318167179a86.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*p-PTeBxalwgA0EzqfZWxlA.png"/></div></div><figcaption class="mi mj gj gh gi mk ml bd b be z dk translated">在空队列上放大</figcaption></figure><h1 id="a931" class="ks kt iq bd ku kv mm kx ky kz mn lb lc ld mo lf lg lh mp lj lk ll mq ln lo lp bi translated">摘要</h1><p id="aa57" class="pw-post-body-paragraph jn jo iq jp b jq lq js jt ju lr jw jx jy ls ka kb kc lt ke kf kg lu ki kj kk ij bi translated">有了这个简单的设置，你就有了一个相当不错的水平自动缩放设置。丑陋的事情是自己运行stackdriver适配器，至少HPA控制器是GKE的一部分，并且完全为您管理。<br/>HPA的另一个优点是<a class="ae lv" href="https://cloud.google.com/blog/products/gcp/beyond-cpu-horizontal-pod-autoscaling-comes-to-google-kubernetes-engine" rel="noopener ugc nofollow" target="_blank">您可以在同一个HPA资源中使用多个指标</a>(甚至是自定义/外部/cpu的组合)，并且您的部署将根据其中任何一个指标达到的阈值进行扩展。</p><h1 id="5847" class="ks kt iq bd ku kv mm kx ky kz mn lb lc ld mo lf lg lh mp lj lk ll mq ln lo lp bi translated">链接</h1><p id="7f9c" class="pw-post-body-paragraph jn jo iq jp b jq lq js jt ju lr jw jx jy ls ka kb kc lt ke kf kg lu ki kj kk ij bi translated"><a class="ae lv" href="https://github.com/marekaf/gke-hpa-stackdriver-pubsub" rel="noopener ugc nofollow" target="_blank">https://github.com/marekaf/gke-hpa-stackdriver-pubsub</a></p><p id="7e67" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><a class="ae lv" href="https://cloud.google.com/kubernetes-engine/docs/tutorials/authenticating-to-cloud-platform" rel="noopener ugc nofollow" target="_blank">https://cloud . Google . com/kubernetes-engine/docs/tutorials/authenticating-to-cloud-platform</a></p><p id="7129" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><a class="ae lv" href="https://cloud.google.com/kubernetes-engine/docs/tutorials/external-metrics-autoscaling" rel="noopener ugc nofollow" target="_blank">https://cloud . Google . com/kubernetes-engine/docs/tutorials/external-metrics-auto scaling</a></p></div></div>    
</body>
</html>