<html>
<head>
<title>Perform Load Testing against Graph Databases with K6</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用K6对图形数据库执行负载测试</h1>
<blockquote>原文：<a href="https://itnext.io/perform-load-testing-against-graph-databases-with-k6-dacd6add0792?source=collection_archive---------0-----------------------#2022-08-04">https://itnext.io/perform-load-testing-against-graph-databases-with-k6-dacd6add0792?source=collection_archive---------0-----------------------#2022-08-04</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/6359aa810f5fb9cb87b28b3a0fb20ee9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*J0S7TERWKyaLzvVH.png"/></div></div></figure><h1 id="7d78" class="jy jz iq bd ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv bi translated">为什么负载测试在图形数据库中很重要？</h1><p id="ffea" class="pw-post-body-paragraph kw kx iq ky b kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt ij bi translated">通常需要对数据库进行负载测试，以便在不同场景下监控对系统的影响，如查询语言规则优化、存储引擎参数调整等。</p><p id="0020" class="pw-post-body-paragraph kw kx iq ky b kz lu lb lc ld lv lf lg lh lw lj lk ll lx ln lo lp ly lr ls lt ij bi translated">本文中的操作系统是x86 CentOS 7.8。</p><p id="0245" class="pw-post-body-paragraph kw kx iq ky b kz lu lb lc ld lv lf lg lh lw lj lk ll lx ln lo lp ly lr ls lt ij bi translated">部署数据库的主机配置了4C 16G内存、SSD磁盘和10G网络。</p><h1 id="70ab" class="jy jz iq bd ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv bi translated">负载测试所需的工具</h1><ul class=""><li id="7702" class="lz ma iq ky b kz la ld le lh mb ll mc lp md lt me mf mg mh bi translated">nebula-ansible 部署NebulaGraph服务。</li><li id="621e" class="lz ma iq ky b kz mj ld mk lh ml ll mm lp mn lt me mf mg mh bi translated"><a class="ae mi" href="https://github.com/vesoft-inc/nebula-importer" rel="noopener ugc nofollow" target="_blank">星云导入器</a>将数据导入星云星团。</li><li id="1c08" class="lz ma iq ky b kz mj ld mk lh ml ll mm lp mn lt me mf mg mh bi translated"><a class="ae mi" href="https://github.com/vesoft-inc/k6-plugin" rel="noopener ugc nofollow" target="_blank"> <strong class="ky ir"> k6-plugin </strong> </a> <strong class="ky ir">是一个k6扩展，用于对NebulaGraph集群进行负载测试。该扩展与nebula-go客户端集成，在测试期间发送请求。</strong></li><li id="30ee" class="lz ma iq ky b kz mj ld mk lh ml ll mm lp mn lt me mf mg mh bi translated"><a class="ae mi" href="https://github.com/vesoft-inc/nebula-bench" rel="noopener ugc nofollow" target="_blank"> nebula-bench </a>生成LDBC数据集，然后将其导入NebulaGraph。</li><li id="d06d" class="lz ma iq ky b kz mj ld mk lh ml ll mm lp mn lt me mf mg mh bi translated"><a class="ae mi" href="https://github.com/ldbc/ldbc_snb_datagen_hadoop" rel="noopener ugc nofollow" target="_blank">ldbc _ snb _ data gen _ Hadoop</a>是一个ldbc数据生成器。</li></ul><h1 id="3c32" class="jy jz iq bd ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv bi translated">负载测试过程概述</h1><p id="7893" class="pw-post-body-paragraph kw kx iq ky b kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt ij bi translated">本文中进行的负载测试使用了由<a class="ae mi" href="https://github.com/ldbc/ldbc_snb_datagen_hadoop" rel="noopener ugc nofollow" target="_blank"> ldbc_snb_datagen </a>生成的LDBC数据集。测试过程如下。</p><figure class="mp mq mr ms gt jr gh gi paragraph-image"><div class="gh gi mo"><img src="../Images/9d86c3cb755737007ff90b5ae6b256a0.png" data-original-src="https://miro.medium.com/v2/resize:fit:768/format:webp/0*lL72Os4f5-hyAwFs.png"/></div></figure><p id="7678" class="pw-post-body-paragraph kw kx iq ky b kz lu lb lc ld lv lf lg lh lw lj lk ll lx ln lo lp ly lr ls lt ij bi translated">要部署拓扑，使用一台主机作为负载测试运行程序，并使用三台主机组成一个NebulaGraph集群。</p><figure class="mp mq mr ms gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mt"><img src="../Images/e2b1a455cf88484534b98259859c831d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*5-7dno2VvDnhcTGf.png"/></div></div></figure><p id="9142" class="pw-post-body-paragraph kw kx iq ky b kz lu lb lc ld lv lf lg lh lw lj lk ll lx ln lo lp ly lr ls lt ij bi translated">为了使监控更容易，负载测试运行器还部署了:</p><ul class=""><li id="2253" class="lz ma iq ky b kz lu ld lv lh mu ll mv lp mw lt me mf mg mh bi translated">普罗米修斯</li><li id="18ac" class="lz ma iq ky b kz mj ld mk lh ml ll mm lp mn lt me mf mg mh bi translated">Influxdb</li><li id="0388" class="lz ma iq ky b kz mj ld mk lh ml ll mm lp mn lt me mf mg mh bi translated">格拉夫纳</li><li id="a850" class="lz ma iq ky b kz mj ld mk lh ml ll mm lp mn lt me mf mg mh bi translated">节点导出器</li></ul><p id="b55e" class="pw-post-body-paragraph kw kx iq ky b kz lu lb lc ld lv lf lg lh lw lj lk ll lx ln lo lp ly lr ls lt ij bi translated">安装了NebulaGraph的主机也会部署:</p><ul class=""><li id="2e2d" class="lz ma iq ky b kz lu ld lv lh mu ll mv lp mw lt me mf mg mh bi translated">节点导出器</li><li id="b302" class="lz ma iq ky b kz mj ld mk lh ml ll mm lp mn lt me mf mg mh bi translated">加工出口商</li></ul><h1 id="279e" class="jy jz iq bd ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv bi translated">负载测试步骤</h1><h1 id="522a" class="jy jz iq bd ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv bi translated">使用nebula-ansible部署NebulaGraph数据库</h1><ol class=""><li id="f8cb" class="lz ma iq ky b kz la ld le lh mb ll mc lp md lt mx mf mg mh bi translated">设置无密码SSH登录a .分别登录192.168.8.60、192.168.8.61、192.168.8.62、192.168.8.63。创建一个vesoft用户，用NOPASSWD加入sudoer。b .登录192.168.8.60设置SSH。</li></ol><pre class="mp mq mr ms gt my mz na nb aw nc bi"><span id="4de5" class="nd jz iq mz b gy ne nf l ng nh">ssh-keygenssh-copy-id vesoft@192.168.8.61<br/>ssh-copy-id vesoft@192.168.8.62<br/>ssh-copy-id vesoft@192.168.8.63</span></pre><p id="7987" class="pw-post-body-paragraph kw kx iq ky b kz lu lb lc ld lv lf lg lh lw lj lk ll lx ln lo lp ly lr ls lt ij bi translated">2.下载nebula-ansible，安装ansible，修改Ansible配置。</p><pre class="mp mq mr ms gt my mz na nb aw nc bi"><span id="24cd" class="nd jz iq mz b gy ne nf l ng nh">sudo yum install ansible -y<br/>git clone <a class="ae mi" href="https://github.com/vesoft-inc/nebula-ansible" rel="noopener ugc nofollow" target="_blank">https://github.com/vesoft-inc/nebula-ansible</a><br/>cd nebula-ansible/</span></pre><p id="aab6" class="pw-post-body-paragraph kw kx iq ky b kz lu lb lc ld lv lf lg lh lw lj lk ll lx ln lo lp ly lr ls lt ij bi translated">下面是inventory.ini的一个例子。</p><pre class="mp mq mr ms gt my mz na nb aw nc bi"><span id="058a" class="nd jz iq mz b gy ne nf l ng nh">[all:vars]<br/># GA or nightly<br/>install_source_type = GA<br/>nebula_version = 2.0.1<br/>os_version = el7<br/>arc = x86_64<br/>pkg = rpmpackages_dir = {{ playbook_dir }}/packages<br/>deploy_dir = /home/vesoft/nebula<br/>data_dir = {{ deploy_dir }}/data# ssh user<br/>ansible_ssh_user = vesoftforce_download = False[metad]<br/>192.168.8.[61:63][graphd]<br/>192.168.8.[61:63][storaged]<br/>192.168.8.[61:63]</span></pre><p id="e642" class="pw-post-body-paragraph kw kx iq ky b kz lu lb lc ld lv lf lg lh lw lj lk ll lx ln lo lp ly lr ls lt ij bi translated">3.安装和部署NebulaGraph。</p><pre class="mp mq mr ms gt my mz na nb aw nc bi"><span id="0885" class="nd jz iq mz b gy ne nf l ng nh">ansible-playbook install.yml<br/>ansible-playbook start.yml</span></pre><h1 id="5c65" class="jy jz iq bd ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv bi translated">监控主机</h1><p id="b380" class="pw-post-body-paragraph kw kx iq ky b kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt ij bi translated">使用docker-compose部署监控系统非常方便。需要首先在主机上安装Docker和Docker-Compose。</p><p id="cba1" class="pw-post-body-paragraph kw kx iq ky b kz lu lb lc ld lv lf lg lh lw lj lk ll lx ln lo lp ly lr ls lt ij bi translated">登录192.168.8.60</p><pre class="mp mq mr ms gt my mz na nb aw nc bi"><span id="691d" class="nd jz iq mz b gy ne nf l ng nh">git clone <a class="ae mi" href="https://github.com/vesoft-inc/nebula-bench.gitcd" rel="noopener ugc nofollow" target="_blank">https://github.com/vesoft-inc/nebula-bench.gitcd</a> nebula-bench<br/>cp -r third/promethues ~/.<br/>cp -r third/exporter ~/.cd ~/exporter/ &amp;&amp; docker-compose up -dcd ~/promethues<br/># Modify the exporter address of monitoring nodes<br/># vi prometheus.yml<br/>docker-compose up -d# Copy exporter to 192.168.8.61, 192.168.8.62, and 192.168.8.63, and then start docker-compose</span></pre><p id="d5cd" class="pw-post-body-paragraph kw kx iq ky b kz lu lb lc ld lv lf lg lh lw lj lk ll lx ln lo lp ly lr ls lt ij bi translated">配置Grafana数据源和仪表板。详见<a class="ae mi" href="https://github.com/vesoft-inc/nebula-bench/tree/master/third" rel="noopener ugc nofollow" target="_blank">https://github . com/vesoft-Inc/nebula-bench/tree/master/third</a>。</p><h1 id="79e3" class="jy jz iq bd ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv bi translated">生成LDBC数据集</h1><pre class="mp mq mr ms gt my mz na nb aw nc bi"><span id="9484" class="nd jz iq mz b gy ne nf l ng nh">cd nebula-benchsudo yum install -y git \<br/>                    make \<br/>                    file \<br/>                    libev \<br/>                    libev-devel \<br/>                    gcc \<br/>                    wget \<br/>                    python3 \<br/>                    python3-devel \<br/>                    java-1.8.0-openjdk \<br/>                    mavenpip3 install --user -r requirements.txt# Using `snb.interactive.1` parameter in ldbc_snb_datagen_hadoop, for more infor <a class="ae mi" href="https://github.com/ldbc/ldbc_snb_datagen_hadoop/wiki/Configurationpython3" rel="noopener ugc nofollow" target="_blank">https://github.com/ldbc/ldbc_snb_datagen_hadoop/wiki/Configurationpython3</a> run.py data# Date generated by mvmv target/data/test_data/ ./sf1</span></pre><h1 id="e317" class="jy jz iq bd ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv bi translated">输入数据</h1><pre class="mp mq mr ms gt my mz na nb aw nc bi"><span id="0f0b" class="nd jz iq mz b gy ne nf l ng nh">cd nebula-bench<br/># Modify .evn<br/>cp env .env<br/>vi .env</span></pre><p id="d5cf" class="pw-post-body-paragraph kw kx iq ky b kz lu lb lc ld lv lf lg lh lw lj lk ll lx ln lo lp ly lr ls lt ij bi translated">以下是的示例。包封/包围（动词envelop的简写）</p><pre class="mp mq mr ms gt my mz na nb aw nc bi"><span id="af0f" class="nd jz iq mz b gy ne nf l ng nh">DATA_FOLDER=sf1<br/>NEBULA_SPACE=sf1<br/>NEBULA_USER=root<br/>NEBULA_PASSWORD=nebula<br/>NEBULA_ADDRESS=192.168.8.61:9669,192.168.8.62:9669,192.168.8.63:9669<br/>#NEBULA_MAX_CONNECTION=100<br/>INFLUXDB_URL=http://192.168.8.60:8086/k6# Compile nebula-importer and K6<br/>./scripts/setup.sh# Import data<br/>python3 run.py nebula importer</span></pre><p id="83f5" class="pw-post-body-paragraph kw kx iq ky b kz lu lb lc ld lv lf lg lh lw lj lk ll lx ln lo lp ly lr ls lt ij bi translated">在导入过程中，您可以关注以下网络带宽和磁盘IO写入。</p><figure class="mp mq mr ms gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi ni"><img src="../Images/da62bf9270cb1cd97d72d806ffc9f211.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*EoSlvBvBbsL2EC1r.png"/></div></div></figure><figure class="mp mq mr ms gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nj"><img src="../Images/724cbade93f7f676b2668beaef07dd11.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*yQNJLPO7xeNZrNHY.png"/></div></div></figure><h1 id="4fbc" class="jy jz iq bd ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv bi translated">执行负载测试</h1><pre class="mp mq mr ms gt my mz na nb aw nc bi"><span id="4e53" class="nd jz iq mz b gy ne nf l ng nh">python3 run.py stress run</span></pre><p id="a5bc" class="pw-post-body-paragraph kw kx iq ky b kz lu lb lc ld lv lf lg lh lw lj lk ll lx ln lo lp ly lr ls lt ij bi translated">根据文件<code class="fe nk nl nm mz b">scenarios</code>中的代码源，自动渲染js文件，使用K6测试所有场景。</p><p id="e3cd" class="pw-post-body-paragraph kw kx iq ky b kz lu lb lc ld lv lf lg lh lw lj lk ll lx ln lo lp ly lr ls lt ij bi translated">执行结束后，js文件和结果将保存在输出文件夹中。</p><p id="1085" class="pw-post-body-paragraph kw kx iq ky b kz lu lb lc ld lv lf lg lh lw lj lk ll lx ln lo lp ly lr ls lt ij bi translated">其中，<code class="fe nk nl nm mz b">latency</code>是服务器返回的延迟时间，<code class="fe nk nl nm mz b">responseTime</code>是客户端发起<code class="fe nk nl nm mz b">execute</code>到<code class="fe nk nl nm mz b">response</code>的时间。测量单位为<code class="fe nk nl nm mz b">μs</code>。</p><pre class="mp mq mr ms gt my mz na nb aw nc bi"><span id="9291" class="nd jz iq mz b gy ne nf l ng nh">[vesoft@qa-60 nebula-bench]$ more output/result_Go1Step.json<br/>{<br/>    "metrics": {<br/>        "data_sent": {<br/>            "count": 0,<br/>            "rate": 0<br/>        },<br/>        "checks": {<br/>            "passes": 1667632,<br/>            "fails": 0,<br/>            "value": 1<br/>        },<br/>        "data_received": {<br/>            "count": 0,<br/>            "rate": 0<br/>        },<br/>        "iteration_duration": {<br/>            "min": 0.610039,<br/>            "avg": 3.589942336582023,<br/>            "med": 2.9560145,<br/>            "max": 1004.232905,<br/>            "p(90)": 6.351617299999998,<br/>            "p(95)": 7.997563949999995,<br/>            "p(99)": 12.121579809999997<br/>        },<br/>        "latency": {<br/>            "min": 308,<br/>            "avg": 2266.528722763775,<br/>            "med": 1867,<br/>            "p(90)": 3980,<br/>            "p(95)": 5060,<br/>            "p(99)": 7999<br/>        },<br/>        "responseTime": {<br/>            "max": 94030,<br/>            "p(90)": 6177,<br/>            "p(95)": 7778,<br/>            "p(99)": 11616,<br/>            "min": 502,<br/>            "avg": 3437.376111156418,<br/>            "med": 2831<br/>        },<br/>        "iterations": {<br/>            "count": 1667632,<br/>            "rate": 27331.94978169588<br/>        },<br/>        "vus": {<br/>            "max": 100,<br/>            "value": 100,<br/>            "min": 0[vesoft@qa-60 nebula-bench]$ head -300 output/output_Go1Step.csv | grep -v USE<br/>timestamp,nGQL,latency,responseTime,isSucceed,rows,errorMsg<br/>1628147822,GO 1 STEP FROM 4398046516514 OVER KNOWS,1217,1536,true,1,<br/>1628147822,GO 1 STEP FROM 2199023262994 OVER KNOWS,1388,1829,true,94,<br/>1628147822,GO 1 STEP FROM 1129 OVER KNOWS,1488,2875,true,14,<br/>1628147822,GO 1 STEP FROM 6597069771578 OVER KNOWS,1139,1647,true,30,<br/>1628147822,GO 1 STEP FROM 2199023261211 OVER KNOWS,1399,2096,true,6,<br/>1628147822,GO 1 STEP FROM 2199023256684 OVER KNOWS,1377,2202,true,4,<br/>1628147822,GO 1 STEP FROM 4398046515995 OVER KNOWS,1487,2017,true,39,<br/>1628147822,GO 1 STEP FROM 10995116278700 OVER KNOWS,837,1381,true,3,<br/>1628147822,GO 1 STEP FROM 933 OVER KNOWS,1130,3422,true,5,<br/>1628147822,GO 1 STEP FROM 6597069771971 OVER KNOWS,1022,2292,true,60,<br/>1628147822,GO 1 STEP FROM 10995116279952 OVER KNOWS,1221,1758,true,3,<br/>1628147822,GO 1 STEP FROM 8796093031179 OVER KNOWS,1252,1811,true,13,<br/>1628147822,GO 1 STEP FROM 10995116279792 OVER KNOWS,1115,1858,true,6,<br/>1628147822,GO 1 STEP FROM 6597069777326 OVER KNOWS,1223,2016,true,4,<br/>1628147822,GO 1 STEP FROM 8796093028089 OVER KNOWS,1361,2054,true,13,<br/>1628147822,GO 1 STEP FROM 6597069777454 OVER KNOWS,1219,2116,true,2,<br/>1628147822,GO 1 STEP FROM 13194139536109 OVER KNOWS,1027,1604,true,2,<br/>1628147822,GO 1 STEP FROM 10027 OVER KNOWS,2212,3016,true,83,<br/>1628147822,GO 1 STEP FROM 13194139544176 OVER KNOWS,855,1478,true,29,<br/>1628147822,GO 1 STEP FROM 10995116280047 OVER KNOWS,1874,2211,true,12,<br/>1628147822,GO 1 STEP FROM 15393162797860 OVER KNOWS,714,1684,true,5,<br/>1628147822,GO 1 STEP FROM 6597069770517 OVER KNOWS,2295,3056,true,7,<br/>1628147822,GO 1 STEP FROM 17592186050570 OVER KNOWS,768,1630,true,26,<br/>1628147822,GO 1 STEP FROM 8853 OVER KNOWS,2773,3509,true,14,<br/>1628147822,GO 1 STEP FROM 19791209307908 OVER KNOWS,1022,1556,true,6,<br/>1628147822,GO 1 STEP FROM 13194139544258 OVER KNOWS,1542,2309,true,91,<br/>1628147822,GO 1 STEP FROM 10995116285325 OVER KNOWS,1901,2556,true,0,<br/>1628147822,GO 1 STEP FROM 6597069774931 OVER KNOWS,2040,3291,true,152,<br/>1628147822,GO 1 STEP FROM 8796093025056 OVER KNOWS,2007,2728,true,29,<br/>1628147822,GO 1 STEP FROM 21990232560726 OVER KNOWS,1639,2364,true,9,<br/>1628147822,GO 1 STEP FROM 8796093030318 OVER KNOWS,2145,2851,true,6,<br/>1628147822,GO 1 STEP FROM 21990232556027 OVER KNOWS,1784,2554,true,5,<br/>1628147822,GO 1 STEP FROM 15393162796879 OVER KNOWS,2621,3184,true,71,<br/>1628147822,GO 1 STEP FROM 17592186051113 OVER KNOWS,2052,2990,true,5,</span></pre><p id="421a" class="pw-post-body-paragraph kw kx iq ky b kz lu lb lc ld lv lf lg lh lw lj lk ll lx ln lo lp ly lr ls lt ij bi translated">也可以在一个场景中执行负载测试，并不断调整配置参数进行比较。</p><h1 id="18e2" class="jy jz iq bd ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv bi translated">同时阅读</h1><pre class="mp mq mr ms gt my mz na nb aw nc bi"><span id="47ee" class="nd jz iq mz b gy ne nf l ng nh"># Run Go2Step with 50 virtual users and 300 seconds of duration<br/>python3 run.py stress run -scenario go.Go2Step -vu 50 -d 300INFO[0302] 2021/08/06 03:55:27 [INFO] finish init the pool     ✓ IsSucceed     █ setup     █ teardown     checks...............: 100.00% ✓ 1559930     ✗ 0<br/>     data_received........: 0 B     0 B/s<br/>     data_sent............: 0 B     0 B/s<br/>     iteration_duration...: min=687.47µs avg=9.6ms       med=8.04ms max=1.03s  p(90)=18.41ms p(95)=22.58ms p(99)=31.87ms<br/>     iterations...........: 1559930 5181.432199/s<br/>     latency..............: min=398      avg=6847.850345 med=5736   max=222542 p(90)=13046   p(95)=16217   p(99)=23448<br/>     responseTime.........: min=603      avg=9460.857877 med=7904   max=226992 p(90)=18262   p(95)=22429   p(99)=31726.71<br/>     vus..................: 50      min=0         max=50<br/>     vus_max..............: 50      min=50        max=50</span></pre><p id="eb26" class="pw-post-body-paragraph kw kx iq ky b kz lu lb lc ld lv lf lg lh lw lj lk ll lx ln lo lp ly lr ls lt ij bi translated">可以同时监控每个指标。</p><figure class="mp mq mr ms gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nn"><img src="../Images/6bd21c3b7e17e81e26c73fecf89fb812.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*-EgGC7MjvLgyKAun.png"/></div></div></figure><p id="e59a" class="pw-post-body-paragraph kw kx iq ky b kz lu lb lc ld lv lf lg lh lw lj lk ll lx ln lo lp ly lr ls lt ij bi translated"><code class="fe nk nl nm mz b">checks</code>是验证请求是否执行成功。如果执行失败，失败消息将保存在CSV文件中。</p><pre class="mp mq mr ms gt my mz na nb aw nc bi"><span id="818b" class="nd jz iq mz b gy ne nf l ng nh">awk -F ',' '{print $NF}' output/output_Go2Step.csv|sort |uniq -c# Execute Go2Step with 200 virtual users and 300 seconds of duration<br/>python3 run.py stress run -scenario go.Go2Step -vu 200 -d 300INFO[0302] 2021/08/06 04:02:34 [INFO] finish init the pool     ✓ IsSucceed     █ setup     █ teardown     checks...............: 100.00% ✓ 1866850    ✗ 0<br/>     data_received........: 0 B     0 B/s<br/>     data_sent............: 0 B     0 B/s<br/>     iteration_duration...: min=724.77µs avg=32.12ms      med=25.56ms max=1.03s  p(90)=63.07ms p(95)=84.52ms  p(99)=123.92ms<br/>     iterations...........: 1866850 6200.23481/s<br/>     latency..............: min=395      avg=25280.893558 med=20411   max=312781 p(90)=48673   p(95)=64758    p(99)=97993.53<br/>     responseTime.........: min=627      avg=31970.234329 med=25400   max=340299 p(90)=62907   p(95)=84361.55 p(99)=123750<br/>     vus..................: 200     min=0        max=200<br/>     vus_max..............: 200     min=200      max=200</span></pre><p id="861a" class="pw-post-body-paragraph kw kx iq ky b kz lu lb lc ld lv lf lg lh lw lj lk ll lx ln lo lp ly lr ls lt ij bi translated">K6指标由Grafana监控</p><figure class="mp mq mr ms gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/38f6ff658d1aba3e23d26eb07d05e12f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*yoa8TlnnSciu6ui8.png"/></div></div></figure><h1 id="0afc" class="jy jz iq bd ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv bi translated">并行写作</h1><pre class="mp mq mr ms gt my mz na nb aw nc bi"><span id="ffc6" class="nd jz iq mz b gy ne nf l ng nh"># Execute insert with 200 virtual users and 300 seconds of duration. By default, batchSize is 100.python3 run.py stress run -scenario go.Go2Step -vu 200 -d 300</span></pre><p id="5286" class="pw-post-body-paragraph kw kx iq ky b kz lu lb lc ld lv lf lg lh lw lj lk ll lx ln lo lp ly lr ls lt ij bi translated">可以手动修改js文件来调整批处理大小</p><pre class="mp mq mr ms gt my mz na nb aw nc bi"><span id="4dd5" class="nd jz iq mz b gy ne nf l ng nh">sed -i 's/batchSize = 100/batchSize = 300/g' output/InsertPersonScenario.js# Run K6 manuallyscripts/k6 run output/InsertPersonScenario.js -u 400 -d 30s --summary-trend-stats "min,avg,med,max,p(90),p(95),p(99)" --summary-export output/result_InsertPersonScenario.json --out influxdb=http://192.168.8.60:8086/k6</span></pre><p id="53dd" class="pw-post-body-paragraph kw kx iq ky b kz lu lb lc ld lv lf lg lh lw lj lk ll lx ln lo lp ly lr ls lt ij bi translated">如果batchSize是300，有400个虚拟用户，将返回一个错误。</p><pre class="mp mq mr ms gt my mz na nb aw nc bi"><span id="0a55" class="nd jz iq mz b gy ne nf l ng nh">INFO[0032] 2021/08/06 04:03:49 [INFO] finish init the pool     ✗ IsSucceed<br/>      ↳  96% — ✓ 31257 / ✗ 1103     █ setup     █ teardown     checks...............: 96.59% ✓ 31257       ✗ 1103<br/>     data_received........: 0 B    0 B/s<br/>     data_sent............: 0 B    0 B/s<br/>     iteration_duration...: min=12.56ms avg=360.11ms      med=319.12ms max=2.07s   p(90)=590.31ms p(95)=696.69ms p(99)=958.32ms<br/>     iterations...........: 32360  1028.339207/s<br/>     latency..............: min=4642    avg=206931.543016 med=206162   max=915671  p(90)=320397.4 p(95)=355798.7 p(99)=459521.39<br/>     responseTime.........: min=6272    avg=250383.122188 med=239297.5 max=1497159 p(90)=384190.5 p(95)=443439.6 p(99)=631460.92<br/>     vus..................: 400    min=0         max=400<br/>     vus_max..............: 400    min=400       max=400awk -F ',' '{print $NF}' output/output_InsertPersonScenario.csv|sort |uniq -c31660<br/>   1103  error: E_CONSENSUS_ERROR(-16)."<br/>      1 errorMsg</span></pre><p id="a49b" class="pw-post-body-paragraph kw kx iq ky b kz lu lb lc ld lv lf lg lh lw lj lk ll lx ln lo lp ly lr ls lt ij bi translated">如果<code class="fe nk nl nm mz b">E_CONSENSUS_ERROR</code>发生，应该是raft的追加日志缓冲区在并发较大时溢出，可以通过调整相关参数来解决。</p><h1 id="7485" class="jy jz iq bd ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv bi translated">摘要</h1><ul class=""><li id="4be1" class="lz ma iq ky b kz la ld le lh mb ll mc lp md lt me mf mg mh bi translated">负载测试使用LDBC数据集标准来确保数据一致性。即使生成了更大的数据量，比如十亿个顶点，图形模式也是一样的。</li><li id="98ef" class="lz ma iq ky b kz mj ld mk lh ml ll mm lp mn lt me mf mg mh bi translated">K6比Jmeter更方便进行负载测试。更多详情请参考<a class="ae mi" href="https://k6.io/docs/" rel="noopener ugc nofollow" target="_blank">https://k6.io/docs/</a>。</li><li id="09cb" class="lz ma iq ky b kz mj ld mk lh ml ll mm lp mn lt me mf mg mh bi translated">通过使用上述工具模拟各种场景或调整NebulaGraph中的参数，您可以轻松找到系统资源的瓶颈。</li></ul></div></div>    
</body>
</html>