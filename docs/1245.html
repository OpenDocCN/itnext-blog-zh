<html>
<head>
<title>Lessons Learned: Switching from CircleCI to Google Cloud Build</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">经验教训:从CircleCI转向Google Cloud Build</h1>
<blockquote>原文：<a href="https://itnext.io/what-i-learned-switching-from-circleci-to-google-cloud-build-b4405de2be38?source=collection_archive---------2-----------------------#2018-08-21">https://itnext.io/what-i-learned-switching-from-circleci-to-google-cloud-build-b4405de2be38?source=collection_archive---------2-----------------------#2018-08-21</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="b479" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">本月早些时候，我们终于达到了CircleCI慷慨的每月1500分钟的构建时间限制。</p><p id="db23" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">作为一家自举创业公司的创始人(见<a class="ae kl" href="http://focuster.com/?utm_source=medium&amp;utm_medium=blog&amp;utm_campaign=circle_gcb" rel="noopener ugc nofollow" target="_blank"> Focuster </a>)，我非常感谢CircleCI这么多年来一直在提供很棒的构建服务，而且他们对自己的限制非常慷慨。</p><p id="b8ee" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">但是每一笔新的开销都像是打在脸上的一拳。</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div class="gh gi km"><img src="../Images/146c697886f40d1bee0621ec09e823f6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1000/0*RD2zTAC4j7gpEDj6.gif"/></div></figure><p id="1053" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们最近将Focuster的基础设施迁移到了谷歌的Kubernetes服务(GKE)，我注意到他们有自己的构建服务，云构建(GCB)。</p><p id="36b5" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">虽然它在很多方面并不全面，但在这一点上它对我来说有一些明显的优势。</p><p id="21ff" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我想分享我在迁移中所学到的东西，这样其他人也可以受益，希望谷歌会听取我的一些反馈并做出一些改进。</p><h1 id="35d5" class="ku kv iq bd kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr bi translated">谷歌云构建的优势</h1><h2 id="9d1e" class="ls kv iq bd kw lt lu dn la lv lw dp le jy lx ly li kc lz ma lm kg mb mc lq md bi translated">更便宜*</h2><p id="297e" class="pw-post-body-paragraph jn jo iq jp b jq me js jt ju mf jw jx jy mg ka kb kc mh ke kf kg mi ki kj kk ij bi translated">正如我前面提到的，CircleCI在他们的免费层上每月提供1500分钟，并发限制为1。要升级到下一个服务级别，统一费率为每月50美元。对于2个构建并发，构建数量不限。</p><p id="78da" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">另一方面，Google Cloud Build在其标准大小的容器(n1-standard-1机器类型，1个内核，3.75gb RAM)上提供了每天120分钟的免费构建时间。</p><p id="63f7" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这算出来大约是。每月3600次构建/分钟。也就是说，未使用天数的时间不会滚动，因此某个特别繁忙的日子可能会产生一些费用。</p><p id="b2aa" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在免费层之上，定价仅为每构建/分钟0.003美元。我的构建平均需要10分钟，所以我一个月要做超过1667个构建，或者一天50个构建才能达到CircleCI收取的50美元。</p><h2 id="6fa4" class="ls kv iq bd kw lt lu dn la lv lw dp le jy lx ly li kc lz ma lm kg mb mc lq md bi translated">并发</h2><p id="1b58" class="pw-post-body-paragraph jn jo iq jp b jq me js jt ju mf jw jx jy mg ka kb kc mh ke kf kg mi ki kj kk ij bi translated">CircleCI基本上是根据你的并发级别来收费的，并且给你无限的分钟数。GCB有10个并发构建的实际限制，但按构建/分钟收费。在这一点上，我喜欢这种方法，因为我可以在空闲层上获得额外并发的好处。</p><h2 id="9da5" class="ls kv iq bd kw lt lu dn la lv lw dp le jy lx ly li kc lz ma lm kg mb mc lq md bi translated">本地测试</h2><p id="ff10" class="pw-post-body-paragraph jn jo iq jp b jq me js jt ju mf jw jx jy mg ka kb kc mh ke kf kg mi ki kj kk ij bi translated">CircleCI和GCB都提供了使用docker测试本地部署的工具。上一次我在OSX的CircleCI上尝试时，速度慢得可怕，以至于无法使用。我不确定这个问题是否已经解决。</p><p id="87a0" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">GCB提供本地测试工具，这些工具通过<em class="mj"> cloud-build-local </em>命令与Google Cloud SDK一起发布。</p><p id="1fdf" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">使用这个工具，我能够快速迭代我的构建步骤，而不需要在云服务上花费任何时间。</p><h2 id="570a" class="ls kv iq bd kw lt lu dn la lv lw dp le jy lx ly li kc lz ma lm kg mb mc lq md bi translated">更快部署</h2><ul class=""><li id="fc81" class="mk ml iq jp b jq me ju mf jy mm kc mn kg mo kk mp mq mr ms bi translated">接近谷歌集装箱注册(GCR)更快的码头拉/推。</li></ul><p id="9734" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我实际上没有测试这是真是假，但我假设在谷歌的网络中意味着从GCR到GCB的docker图像将比从CircleCI更快。</p><ul class=""><li id="ae3a" class="mk ml iq jp b jq jr ju jv jy mt kc mu kg mv kk mp mq mr ms bi translated">实时图像通知部署通知</li></ul><p id="9dcf" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">为了部署到我的Kubernetes集群，我使用了一个名为<a class="ae kl" href="https://keel.sh" rel="noopener ugc nofollow" target="_blank"> Keel </a>的工具，在Docker存储库中的映像更新时自动更新我的部署。</p><p id="0ecb" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">过去我使用Docker的轮询系统，因为web挂钩的设置有点麻烦。我发现GCR发布订阅通知的设置非常简单，这使得部署快了一分钟。</p><h2 id="1b02" class="ls kv iq bd kw lt lu dn la lv lw dp le jy lx ly li kc lz ma lm kg mb mc lq md bi translated">Docker本地步骤</h2><p id="62aa" class="pw-post-body-paragraph jn jo iq jp b jq me js jt ju mf jw jx jy mg ka kb kc mh ke kf kg mi ki kj kk ij bi translated">CircleCI和Google Cloud Build都有广泛的Docker支持。但是Google Cloud Build允许你使用Docker映像定义自己的步骤。</p><p id="13bc" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">共享工作区(挂载在/workspace)在步骤之间是持久的。</p><p id="c8c8" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我发现这实际上是开发我的构建步骤的一个非常好的方法，因为我可以为每个步骤利用专门构建的小图像。</p><p id="9d75" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我还可以在构建过程中的任何时候利用现有的Docker映像，并且可以用任何语言编写我的构建步骤。</p><h1 id="9400" class="ku kv iq bd kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr bi translated">谷歌云构建的缺点</h1><h2 id="acf7" class="ls kv iq bd kw lt lu dn la lv lw dp le jy lx ly li kc lz ma lm kg mb mc lq md bi translated">内置步骤是有限的</h2><p id="a718" class="pw-post-body-paragraph jn jo iq jp b jq me js jt ju mf jw jx jy mg ka kb kc mh ke kf kg mi ki kj kk ij bi translated">GCB为许多最常用的工具提供了现有的步骤:docker、git、Google的服务、curl、npm、kubectl等。</p><p id="9d49" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">完整名单在此:【https://github.com/GoogleCloudPlatform/cloud-builders T2】</p><p id="4dcb" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">但是像初始化git子模块这样简单的事情却很难做到。为此，我必须创建自己的构建步骤。如果他们能提供一个简单易用的构建步骤，从谷歌的KMS中提取ssh密钥，那就太好了。</p><p id="1aee" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">CircleCI在这方面有优势，因为他们支持向构建帐户添加SSH密钥，并且因为他们的构建都在一个容器中运行，所以配置起来容易得多。</p><h2 id="f79b" class="ls kv iq bd kw lt lu dn la lv lw dp le jy lx ly li kc lz ma lm kg mb mc lq md bi translated">糟糕的缓存故事</h2><p id="2f0e" class="pw-post-body-paragraph jn jo iq jp b jq me js jt ju mf jw jx jy mg ka kb kc mh ke kf kg mi ki kj kk ij bi translated">与GCB相比，CircleCI的另一个亮点是缓存。</p><p id="6b09" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">它们提供了一些非常灵活的缓存原语，例如，根据文件内容的哈希动态生成缓存键。并允许基于分支名称或许多其他标准回退到较旧的高速缓存。</p><p id="3a9b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">另一方面，GCB只提供了在Google Storage中存储一些文件夹内容的文档。</p><p id="c75e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">好消息是，我能够创建自己的构建步骤，基本上模仿了CircleCI在GCB中的行为。</p><p id="3fbc" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">(如果有兴趣，我将开放我创建的缓存步骤的源代码)</p><h2 id="2fde" class="ls kv iq bd kw lt lu dn la lv lw dp le jy lx ly li kc lz ma lm kg mb mc lq md bi translated">有限调试</h2><p id="b90a" class="pw-post-body-paragraph jn jo iq jp b jq me js jt ju mf jw jx jy mg ka kb kc mh ke kf kg mi ki kj kk ij bi translated">CircleCI使SSH进入您的构建来诊断问题变得非常容易，只需在构建上勾选一个框并重新启动它。</p><p id="5b65" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">对于GCB，我找不到任何类似的步骤。</p><p id="ce29" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">也许可以在本地调试中使用docker run来打开特定映像中的shell，但是我不清楚在这种情况下如何保留构建的工作空间。</p><h2 id="7075" class="ls kv iq bd kw lt lu dn la lv lw dp le jy lx ly li kc lz ma lm kg mb mc lq md bi translated">用户界面没有那么好</h2><ul class=""><li id="6216" class="mk ml iq jp b jq me ju mf jy mm kc mn kg mo kk mp mq mr ms bi translated">过滤器构建可以使用很多改进。对所有构建属性进行全文搜索会很棒。没有对查询语言的解释。</li><li id="110c" class="mk ml iq jp b jq mw ju mx jy my kc mz kg na kk mp mq mr ms bi translated">在构建完成之前看不到单个步骤的进度，或者需要查看整个构建的日志。Circle CI在这里做得更好，因为您可以看到每一步的进度。</li><li id="6739" class="mk ml iq jp b jq mw ju mx jy my kc mz kg na kk mp mq mr ms bi translated">您必须手动单击“刷新”才能在构建列表中看到新的构建。</li></ul><h2 id="c59b" class="ls kv iq bd kw lt lu dn la lv lw dp le jy lx ly li kc lz ma lm kg mb mc lq md bi translated">缺乏整合</h2><p id="e8f7" class="pw-post-body-paragraph jn jo iq jp b jq me js jt ju mf jw jx jy mg ka kb kc mh ke kf kg mi ki kj kk ij bi translated">设置Slack和Github集成是基于手动安装一些谷歌云功能，而不是大多数服务使用的1-click。</p><p id="4304" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">也就是说，将PubSub用于构建通知允许很多定制。</p><h2 id="89cb" class="ls kv iq bd kw lt lu dn la lv lw dp le jy lx ly li kc lz ma lm kg mb mc lq md bi translated">有限的机器类型配置</h2><p id="e2e5" class="pw-post-body-paragraph jn jo iq jp b jq me js jt ju mf jw jx jy mg ka kb kc mh ke kf kg mi ki kj kk ij bi translated">目前，您只能在1核、8核或32核之间进行选择。最好有2核和4核作为选项。我们能得到一个<em class="mj"> n1-standard-2 </em>或其他尺寸的建筑机械吗？</p><h1 id="69fe" class="ku kv iq bd kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr bi translated">最后的想法</h1><p id="1b04" class="pw-post-body-paragraph jn jo iq jp b jq me js jt ju mf jw jx jy mg ka kb kc mh ke kf kg mi ki kj kk ij bi translated">做出了改变，我对结果总体上很满意。我希望谷歌继续定期更新这项服务。</p><p id="4131" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi">—</p><p id="d87a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><em class="mj">这是关于Focuster工程实践系列文章的一部分。</em></p><p id="5218" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><a class="ae kl" href="http://focuster.com/?utm_source=medium&amp;utm_medium=blog&amp;utm_campaign=circle_gcb" rel="noopener ugc nofollow" target="_blank"> <strong class="jp ir"> <em class="mj">看看Focuster </em> </strong> </a> <em class="mj">，第一款真正帮助你完成事情而不是做无止境的清单的专注app。在谷歌日历中根据你的待办事项列表自动建立一个日程表，如果事情没有完成，就把它向前推进。</em></p><p id="a73a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><a class="ae kl" href="https://twitter.com/intent/follow?screen_name=focusterapp" rel="noopener ugc nofollow" target="_blank"> <em class="mj">在Twitter上关注@ focusterapp</em></a><em class="mj">获取关于生产力和高绩效的更新。</em></p></div></div>    
</body>
</html>