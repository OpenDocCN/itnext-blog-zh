<html>
<head>
<title>Optimizing Linkerd Metrics in Prometheus</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">优化Prometheus中的Linkerd指标</h1>
<blockquote>原文：<a href="https://itnext.io/optimizing-linkerd-metrics-in-prometheus-de607ec10f6b?source=collection_archive---------2-----------------------#2022-08-25">https://itnext.io/optimizing-linkerd-metrics-in-prometheus-de607ec10f6b?source=collection_archive---------2-----------------------#2022-08-25</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/d43bc8ee934d71bd416ea324db0aed24.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*RCdYV7CXzEr0YykrPuqicg.png"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">这篇文章的演员阵容</figcaption></figure><p id="6631" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">Linkerd是一个服务网格解决方案，其理念是“做得更少，但做到最好”它有Viz扩展，提供自己的仪表板来呈现实时画面，还有Grafana，提供预配置的仪表板来分析历史数据。所有仪表板都使用Prometheus作为后端来收集、保存和查询指标。</p><p id="529b" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">默认情况下，Viz扩展为用户提供了一个启动包，包括Prometheus、Grafana和所有必要的配置。只需安装舵图并使用它。这是我们的第一选择，因为它节省了你开始的时间。</p><figure class="lb lc ld le gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi la"><img src="../Images/c212d718c788eea66be4bdf8ab2ccc08.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*PVwmRmpMew1TvjMK-JiaXQ.png"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">Viz仪表盘</figcaption></figure><p id="3794" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">在使用Linkerd的一年中，我们的测试和生产环境中的工作负载数量稳步增长，在某个时刻，<strong class="ke ir"> <em class="lf">我们开始意识到仪表板工作缓慢</em> </strong>。此外，<strong class="ke ir"> <em class="lf">我们保留了最后一个小时的指标值，只是因为普罗米修斯</em> </strong>消耗了大量内存(对于500多个网格工作负载，大约11GB)。因此，我们开始思考如何使仪表板更快，花费更少的资源，并保留数据至少几天。</p></div><div class="ab cl lg lh hu li" role="separator"><span class="lj bw bk lk ll lm"/><span class="lj bw bk lk ll lm"/><span class="lj bw bk lk ll"/></div><div class="ij ik il im in"><h1 id="68ec" class="ln lo iq bd lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk bi translated">第一次尝试</h1><p id="2005" class="pw-post-body-paragraph kc kd iq ke b kf ml kh ki kj mm kl km kn mn kp kq kr mo kt ku kv mp kx ky kz ij bi translated">有趣的是，我们的第一个愿望是长期保存数据，并在统计上使用它。半年前，谷歌推出了他们的产品<a class="ae mq" href="https://cloud.google.com/stackdriver/docs/managed-prometheus" rel="noopener ugc nofollow" target="_blank"> Monarch </a>作为管理式普罗米修斯解决方案。到那时，我们已经使用其他GCP产品，如Stackdriver来保持来自Linkerd的痕迹。尝试一种新的方法来用熟悉的工具存储和分析时间序列数据是合理的。</p><p id="7985" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">后端的替换很容易。出于测试目的，我们更改了容器映像名称，并添加了向Monarch发送样本的适当权限。而且……它起作用了！</p><p id="468b" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">美中不足的是。我们面临两个主要问题。首先，我们无法获取一些指标:</p><figure class="lb lc ld le gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mr"><img src="../Images/b70fc1de37eb841c8ee4be10554c88e7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*LUUdv5HnBSVHz8OJZ0uXEQ.png"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">度量的误差</figcaption></figure><p id="ad29" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">我们与Google支持团队一起解决了这个问题。该错误的原因是该指标的标签数量。<strong class="ke ir"> <em class="lf">托管解决方案的上限为55个标签。解决这个问题的唯一选择是减少标签数量，然后重新创建指标。</em>T13】</strong></p><p id="3492" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">我们可以快速解决刮擦配置修改的第一个问题:</p><pre class="lb lc ld le gt ms mt mu mv aw mw bi"><span id="67ac" class="mx lo iq mt b gy my mz l na nb"><strong class="mt ir"># remove this action to remove unused pod labels</strong><br/>- action: labelmap        <br/>  regex: __meta_kubernetes_pod_label_(.+)        <br/>  replacement: __tmp_pod_label_$1</span></pre><p id="f1fd" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">第二个问题更棘手。默认情况下，<strong class="ke ir"> <em class="lf">存储来自Linkerd的所有指标需要大约150万个样本，每月花费大约9K美元</em> </strong>。这对我们来说是一个重要的数字，我们试图减少样本的数量。</p><p id="2d9c" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">正如您在下面的截图中看到的，我们在减少摄入样本量方面取得了一些成功:</p><figure class="lb lc ld le gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nc"><img src="../Images/95f1e0c4f0cfaa605f8301ad7bc5647b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*i_A4McbFJzIIgiGOFEQbBA.png"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">摄取度量图形</figcaption></figure><p id="eea8" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">为此，我们开始<strong class="ke ir">只导出三个关键指标</strong>并且<strong class="ke ir">将抓取时间</strong>从10秒增加到20秒:</p><pre class="lb lc ld le gt ms mt mu mv aw mw bi"><span id="b0e1" class="mx lo iq mt b gy my mz l na nb"><strong class="mt ir"># flag to export only some metrics to Monarch</strong><br/>--export.match='{__name__=~"response_.+"}'</span></pre><p id="656a" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">它将样本数量从150万急剧减少到25万。然而，<strong class="ke ir"> <em class="lf">这样的变化让我们失去了很大一部分指标</em> </strong>。我们不能用Monarch完全取代默认的Prometheus安装。</p><blockquote class="nd ne nf"><p id="b527" class="kc kd lf ke b kf kg kh ki kj kk kl km ng ko kp kq nh ks kt ku ni kw kx ky kz ij bi translated">顺便说一句，如果你有额外的钱花，那么君主将是正确的选择。</p></blockquote><h1 id="d060" class="ln lo iq bd lp lq nj ls lt lu nk lw lx ly nl ma mb mc nm me mf mg nn mi mj mk bi translated">深入了解指标内部</h1><p id="0cf0" class="pw-post-body-paragraph kc kd iq ke b kf ml kh ki kj mm kl km kn mn kp kq kr mo kt ku kv mp kx ky kz ij bi translated">过了一会儿，我们进行了第二次尝试来提高仪表板的性能。在那时，我们已经知道了很多度量标准的标签，并且已经解决了一些问题。</p><p id="adc9" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">从逻辑上讲，我们的下一步是找出缓慢的本质。首先要做的是理解指标的基数，因为我们假设<strong class="ke ir">高基数会显著影响性能</strong>。</p><p id="7897" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">毫不奇怪，Linkerd指标(其中一些指标比其他指标更高)具有很高的基数。原因很简单。大多数Linkerd代理指标系列提供了由两个POD名称组成的边缘，当POD重新创建时，这些名称会发生变化。豆荚和它们之间的连接越多，基数就越大。</p><p id="6808" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">为了找到最基数的指标，我们可以使用简单的查询Prometheus:</p><pre class="lb lc ld le gt ms mt mu mv aw mw bi"><span id="09b4" class="mx lo iq mt b gy my mz l na nb">topk(10, count by (__name__)({__name__=~".+"}))</span></pre><p id="becf" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">该查询返回的领导者是超过250K系列的<strong class="ke ir">response _ latency _ ms _ bucket</strong>度量。这是一个巨大的基数，我们应该找到一种方法来减少它。</p><p id="5dc4" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">因为它是直方图指标，所以我们观察到了很多桶。标准，如<strong class="ke ir"> +INF、</strong>和<strong class="ke ir">1/10/100/10000/10000</strong>ms，以及用于更精确计算的附加，如<strong class="ke ir"> 2/3/4/5…/40000/50000。</strong>附加值有助于在分位数图中获得更准确的结果，但是多个pod到pod的边要计算25次。大量的这种边缘和这种乘数会显著影响Linkerd仪表板的性能和稳定性。</p><p id="fe82" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">解决方案是从指标中移除额外的桶:</p><pre class="lb lc ld le gt ms mt mu mv aw mw bi"><span id="36dd" class="mx lo iq mt b gy my mz l na nb">metric_relabel_configs:<br/>  - action: drop<br/>    source_labels: [le]<br/>    regex: "2.*|3.*|4.*|5.*"</span></pre><p id="52bb" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated"><strong class="ke ir">它帮助我们将最高基数从250K降低到60K！</strong></p><h2 id="818b" class="mx lo iq bd lp no np dn lt nq nr dp lx kn ns nt mb kr nu nv mf kv nw nx mj ny bi translated">其他调整</h2><p id="278b" class="pw-post-body-paragraph kc kd iq ke b kf ml kh ki kj mm kl km kn mn kp kq kr mo kt ku kv mp kx ky kz ij bi translated">我们使用的默认普罗米修斯(是的，我们已经知道了<a class="ae mq" href="https://linkerd.io/2.12/tasks/external-prometheus/" rel="noopener ugc nofollow" target="_blank">的缺点</a>)抓取了很多Viz仪表板没有使用的指标(标准k8、容器、Grafana和它自己的)。<strong class="ke ir"> <em class="lf">我们通过修改普罗米修斯</em> </strong>的配置删除了所有这些擦伤。它帮助我们减少了度量数据量，Prometheus开始感觉好些了。</p><p id="438e" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">尽管有这些变化，性能仍然一般，我们开始寻找如何改进它。</p><p id="574f" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">因为这些指标具有很高的基数，我们发现有些文章<a class="ae mq" href="https://victoriametrics.com/" rel="noopener ugc nofollow" target="_blank"> Victoria Metrics </a>在这种情况下表现更好。好消息是Victoria Metrics与PromQL兼容，并支持Prometheus scrape配置:</p><pre class="lb lc ld le gt ms mt mu mv aw mw bi"><span id="3da4" class="mx lo iq mt b gy my mz l na nb">- args:<br/>  - -promscrape.config.strictParse=false<br/>  <strong class="mt ir">- -promscrape.config=/etc/prometheus/prometheus.yml</strong><br/>  - -promscrape.maxScrapeSize=256MB<br/>  - -storageDataPath=/data<br/>  - -retentionPeriod=30d<br/>  <strong class="mt ir">- -httpListenAddr=:9090</strong><br/>  - -search.maxSeries=100000<br/>  - -search.maxUniqueTimeseries=1000000</span></pre><p id="f56a" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">为了修复配置的严格解析，我们删除了不支持的属性:</p><pre class="lb lc ld le gt ms mt mu mv aw mw bi"><span id="fd0c" class="mx lo iq mt b gy my mz l na nb">global:<br/>  <strong class="mt ir">evaluation_interval: 10s</strong></span><span id="7263" class="mx lo iq mt b gy nz mz l na nb"><strong class="mt ir">rule_files:<br/>  - /etc/prometheus/*_rules.yml<br/>  - /etc/prometheus/*_rules.yaml</strong></span></pre><p id="f978" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">借助Victoria Metrics，我们实现了相同价格(CPU/MEM消耗)下的每月保留期，而不是几个小时，并且Viz dashboard 的<strong class="ke ir">性能显著提高。</strong></p><p id="9f60" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">完整的刮擦配置:</p><figure class="lb lc ld le gt jr"><div class="bz fp l di"><div class="oa ob l"/></div></figure><h1 id="cade" class="ln lo iq bd lp lq nj ls lt lu nk lw lx ly nl ma mb mc nm me mf mg nn mi mj mk bi translated">回到君主</h1><p id="185e" class="pw-post-body-paragraph kc kd iq ke b kf ml kh ki kj mm kl km kn mn kp kq kr mo kt ku kv mp kx ky kz ij bi translated">好了，现在我们有了操作数据，但我们应该考虑历史数据。没有必要将具有所有可能的度量和边缘的所有数据长期保存。</p><p id="6616" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">我们决定，有两个主要指标我们希望尽可能长地保持:<strong class="ke ir">response _ latency _ ms _ bucket</strong>和<strong class="ke ir"> response_total </strong>，分别用于计算延迟和成功率。</p><p id="8a14" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">对于长期存储，我们选择了Monarch(在文章的第一部分中介绍过),因为我们计划显著减少样本的数量，并消除其使用的高价格。</p><p id="5588" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">我们的第一个目标是去除高基数标签，所以我们选择创建规则来仅聚合具有有价值标签的数据:</p><figure class="lb lc ld le gt jr"><div class="bz fp l di"><div class="oa ob l"/></div></figure><p id="bdff" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">我们不能使用托管版本，因为在使用联合的情况下缺少<strong class="ke ir">类型</strong>的<a class="ae mq" href="https://cloud.google.com/stackdriver/docs/managed-prometheus/troubleshooting#unknown-double-written." rel="noopener ugc nofollow" target="_blank">问题</a>，所以我们部署了自部署版本，如文档中所述:<a class="ae mq" href="https://cloud.google.com/stackdriver/docs/managed-prometheus/setup-unmanaged" rel="noopener ugc nofollow" target="_blank">https://cloud . Google . com/stack driver/docs/managed-Prometheus/setup-unmanaged</a>。</p><p id="fabe" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">因此，我们通过Victoria Metrics的联合设置了所需的收集指标:</p><figure class="lb lc ld le gt jr"><div class="bz fp l di"><div class="oa ob l"/></div></figure><p id="6027" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">如你所见，我们使用长的刮擦间隔来减少系列的数量。为了仅导出聚合指标，我们根据文档对其进行限制，并使用尽可能短的保留时间:</p><pre class="lb lc ld le gt ms mt mu mv aw mw bi"><span id="593e" class="mx lo iq mt b gy my mz l na nb">containers:<br/>  - args:<br/>    - --config.file=/etc/prometheus/prometheus.yml<br/>    - --storage.tsdb.path=/prometheus/data<br/>   <strong class="mt ir"> - --storage.tsdb.retention.time=1h</strong><br/>    - --web.enable-lifecycle<br/>    - --storage.tsdb.no-lockfile<br/>    - --web.route-prefix=/<br/>    <strong class="mt ir">- --export.match={__name__=~"job:response.+:sum"}</strong></span></pre><p id="af02" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">所有这些都有助于我们发送和长期保存有价值的数据，并且只需支付很少的费用。</p><figure class="lb lc ld le gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi oc"><img src="../Images/6c937d32e9af34ebb5ed154fd1a28a8a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*8skATk5BZAmBvXrrEhv8uQ.png"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">现在摄入了多少样本</figcaption></figure><p id="958b" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">正如你在上面的图片中看到的，目前，我们每小时摄取不到100万个样本，每月花费不到100美元。</p></div><div class="ab cl lg lh hu li" role="separator"><span class="lj bw bk lk ll lm"/><span class="lj bw bk lk ll lm"/><span class="lj bw bk lk ll"/></div><div class="ij ik il im in"><h1 id="e558" class="ln lo iq bd lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk bi translated">结论</h1><p id="699d" class="pw-post-body-paragraph kc kd iq ke b kf ml kh ki kj mm kl km kn mn kp kq kr mo kt ku kv mp kx ky kz ij bi translated">在最终解决方案中，我们为Linkerd指标划分了Prometheus指标存储:</p><ul class=""><li id="a20c" class="od oe iq ke b kf kg kj kk kn of kr og kv oh kz oi oj ok ol bi translated">由Victoria Metrics支持的Viz dashboard和标准Linkerd Grafana dashboards的短期存储，可保存一个月的数据</li><li id="c5df" class="od oe iq ke b kf om kj on kn oo kr op kv oq kz oi oj ok ol bi translated">由Monarch支持的历史数据长期存储(GCE管理的Prometheus)</li></ul><p id="bc94" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">Victoria Metrics帮助我们<strong class="ke ir">有效地处理许多高基数指标</strong>，并提高Linkerd可观察性工具的稳定性和性能。Monarch帮助我们<strong class="ke ir">以合理的价格将有价值的数据长期</strong>保存下来，没有任何麻烦。</p><p id="02d1" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">结束了。我希望这篇文章能帮助或给你一些想法、见解和乐趣。</p></div></div>    
</body>
</html>