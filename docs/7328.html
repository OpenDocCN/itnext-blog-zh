<html>
<head>
<title>Creating an ECS Fargate service for containers using terraform and terragrunt</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用terraform和terragrunt为容器创建ECS Fargate服务</h1>
<blockquote>原文：<a href="https://itnext.io/creating-an-ecs-fargate-service-for-container-applications-using-terraform-and-terragrunt-2af5db3b35c0?source=collection_archive---------0-----------------------#2022-08-23">https://itnext.io/creating-an-ecs-fargate-service-for-container-applications-using-terraform-and-terragrunt-2af5db3b35c0?source=collection_archive---------0-----------------------#2022-08-23</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><figure class="ip iq gp gr ir is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi io"><img src="../Images/b7156711bd0f4ea5f463b06d78789512.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*8ffPI15bxUMli4MYD9ETzg.png"/></div></div></figure><div class=""/><p id="e94a" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在2022年求职狂潮期间，我遇到了一个有趣的挑战，那就是DevOps工程师的职位。这个任务需要我部署和公开一个docker容器，在这个例子中是著名的<a class="ae kw" href="https://hub.docker.com/_/ghost" rel="noopener ugc nofollow" target="_blank"> ghost应用程序</a>，使用<a class="ae kw" href="https://aws.amazon.com/fargate/" rel="noopener ugc nofollow" target="_blank"> AWS ECS Fargate </a>。我以前曾在Kubernetes上做过容器编排员，完全不知道如何绕开ECS Fargate。我意识到这是一个学习ECS Fargate集群以及在其上部署应用程序的绝好机会，同时使用terraform。</p><div class="ip iq gp gr ir kx"><a href="https://aws.amazon.com/fargate/" rel="noopener  ugc nofollow" target="_blank"><div class="ky ab fo"><div class="kz ab la cl cj lb"><h2 class="bd jc gy z fp lc fr fs ld fu fw ja bi translated">无服务器计算引擎-AWS Fargate-亚马逊网络服务</h2><div class="le l"><h3 class="bd b gy z fp lc fr fs ld fu fw dk translated">AWS Fargate部署和管理您的应用程序，而不是基础架构。Fargate消除了…的运营开销</h3></div><div class="lf l"><p class="bd b dl z fp lc fr fs ld fu fw dk translated">aws.amazon.com</p></div></div><div class="lg l"><div class="lh l li lj lk lg ll ix kx"/></div></div></a></div><p id="aaf1" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">面临的挑战是为ECS Fargate集群设置一个单击式IaC部署，它将能够在给定一些阈值的情况下自动扩展；所有这些都要在仅仅6个小时内完成！然而，这项任务非常直接，非常耗费精力，因为我必须建立一个terraform项目，并决定使用terragrunt来配置它。我的第一直觉是搜索允许实现这一功能的人的博客帖子，我能够找到一个这样的博客，它做得足够好，但没有涵盖所有内容。</p><p id="aefa" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我把我的任务分成两部分:创建由所有的<code class="fe lm ln lo lp b">networking</code>和必要的基础应用组成的<code class="fe lm ln lo lp b">base infrastructure</code>来支持我的用例，创建由<code class="fe lm ln lo lp b">application infrastructure</code>组成的<code class="fe lm ln lo lp b">base infrastructure</code>来提供如何部署这样一个应用的通用模板。我的过程如下:</p><ul class=""><li id="b12f" class="lq lr jb ka b kb kc kf kg kj ls kn lt kr lu kv lv lw lx ly bi translated">创建一个<code class="fe lm ln lo lp b">VPC</code>、<code class="fe lm ln lo lp b">subnets</code>并设置所有需要的路由表</li><li id="9bdc" class="lq lr jb ka b kb lz kf ma kj mb kn mc kr md kv lv lw lx ly bi translated">创建<code class="fe lm ln lo lp b">ECS Fargate</code>组件</li><li id="db92" class="lq lr jb ka b kb lz kf ma kj mb kn mc kr md kv lv lw lx ly bi translated">- <code class="fe lm ln lo lp b">ECS</code>集群</li><li id="337e" class="lq lr jb ka b kb lz kf ma kj mb kn mc kr md kv lv lw lx ly bi translated">- <code class="fe lm ln lo lp b">ECS</code>服务</li><li id="b526" class="lq lr jb ka b kb lz kf ma kj mb kn mc kr md kv lv lw lx ly bi translated">- <code class="fe lm ln lo lp b">ECS</code>任务定义</li><li id="33d1" class="lq lr jb ka b kb lz kf ma kj mb kn mc kr md kv lv lw lx ly bi translated">创建<code class="fe lm ln lo lp b">AWS</code>应用负载平衡器；<code class="fe lm ln lo lp b">ALB</code></li><li id="7b73" class="lq lr jb ka b kb lz kf ma kj mb kn mc kr md kv lv lw lx ly bi translated">创建安全组来加强我的应用程序的安全性</li><li id="53b0" class="lq lr jb ka b kb lz kf ma kj mb kn mc kr md kv lv lw lx ly bi translated">创建<code class="fe lm ln lo lp b">appautoscaling</code>策略和阈值，根据定义的指标自动扩展我的应用。</li></ul></div><div class="ab cl me mf hu mg" role="separator"><span class="mh bw bk mi mj mk"/><span class="mh bw bk mi mj mk"/><span class="mh bw bk mi mj"/></div><div class="ij ik il im in"><p id="43ea" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我通过Anton Babenkov 的著名<a class="ae kw" href="https://registry.terraform.io/modules/terraform-aws-modules/vpc/aws/latest" rel="noopener ugc nofollow" target="_blank">模块创建了一个全新的VPC，它允许我几乎立即配置VPC、创建多AZ子网、配置网关和设置路由表。这节省了我的时间，并帮助我为我的应用程序建立了一个可分解的环境。下一步是确定其余的基础架构组件和应用程序基础架构组件，并相应地隔离它们。我的基础架构组件最终以所有网络相关组件、ECS集群和一个应用程序负载平衡器的形式来访问我的应用程序；所有其他组件都用于应用程序基础架构。我的项目结构如下所示:</a></p><figure class="ml mm mn mo gt is"><div class="bz fp l di"><div class="mp mq l"/></div></figure><p id="9f20" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我需要首先了解什么是ECS Fargate集群，以及在其上部署应用程序需要哪些组件。我找到了一些很好的资源，帮助我<a class="ae kw" href="https://www.freecodecamp.org/news/amazon-ecs-terms-and-architecture-807d8c4960fd/" rel="noopener ugc nofollow" target="_blank">了解ECS集群</a>和<a class="ae kw" href="https://stackoverflow.com/a/42961623/4158615" rel="noopener ugc nofollow" target="_blank">区分ECS服务和任务</a>。我把这些写在这里，让每个人都跟随；ECS任务是运行来自用户的代码的容器，而ECS服务运行并确保所需数量的任务在ECS群集中执行。</p><div class="ip iq gp gr ir kx"><a href="https://stackoverflow.com/a/42961623/4158615" rel="noopener  ugc nofollow" target="_blank"><div class="ky ab fo"><div class="kz ab la cl cj lb"><h2 class="bd jc gy z fp lc fr fs ld fu fw ja bi translated">AWS ECS中的任务和服务有什么区别？</h2><div class="le l"><h3 class="bd b gy z fp lc fr fs ld fu fw dk translated">任务定义是一个或多个容器配置的集合。有些任务可能只需要一个容器，而…</h3></div><div class="lf l"><p class="bd b dl z fp lc fr fs ld fu fw dk translated">stackoverflow.com</p></div></div><div class="lg l"><div class="mr l li lj lk lg ll ix kx"/></div></div></a></div><p id="56c4" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我创建了三个不同的可用性区域，并为每个区域配置了公共子网。VPC模块非常灵活，因为您可以选择所需的可用性分区数量，并相应地在其中配置公共/私有子网。为了这个项目，我选择部署到所有三个区域，以实现高可用性部署。</p><figure class="ml mm mn mo gt is"><div class="bz fp l di"><div class="mp mq l"/></div></figure><p id="d8d0" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">创建VPC后，我们创建一个ECS群集，这是一个相当简单的任务；您只需要创建一个ECS集群资源并命名它。</p><figure class="ml mm mn mo gt is"><div class="bz fp l di"><div class="mp mq l"/></div></figure><p id="ad8c" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">现在我们有了一个ECS集群设置，我们需要创建一个应用程序负载平衡器，它将为我们接收请求，并将其分配给服务将创建和维护的多个任务。</p><p id="0156" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><em class="ms">请注意，为了便于理解，安全组配置故意对外公开，但这是一种不好的做法。</em></p><p id="d52a" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><em class="ms">请遵守您各自的VPC和子网设置，并调整您的安全组的入口和出口，以限制不必要的访问。</em></p><figure class="ml mm mn mo gt is"><div class="bz fp l di"><div class="mp mq l"/></div></figure><p id="5a23" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">接下来，我们为我们的应用程序配置ECS服务和任务。为了完成集群设置，我们需要两个服务角色；一个作为ECS服务的执行角色，另一个作为ECS按需横向扩展的自动扩展角色。我将服务角色模块化，并创建了两个后续的角色模块。</p><figure class="ml mm mn mo gt is"><div class="bz fp l di"><div class="mp mq l"/></div></figure><figure class="ml mm mn mo gt is"><div class="bz fp l di"><div class="mp mq l"/></div></figure><p id="6753" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">有了合适的服务角色，我们最终可以为ghost容器创建ECS服务和任务，并通过ALB公开它。</p><figure class="ml mm mn mo gt is"><div class="bz fp l di"><div class="mp mq l"/></div></figure><p id="29a2" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我的最后一项任务是了解<a class="ae kw" href="https://stackoverflow.com/questions/65774071/aws-ecs-cluster-auto-scaling-vs-service-auto-scaling/65782253#65782253" rel="noopener ugc nofollow" target="_blank">ECS集群自动扩展是如何工作的</a>。要设置自动伸缩，我只需要定义基于CPU和内存的指标，并设置一个良好的估计阈值，这将允许服务向外扩展。可以通过创建一个<code class="fe lm ln lo lp b">aws_appautoscaling_target</code>并创建相应的<code class="fe lm ln lo lp b">aws_appautoscaling_policy</code>来创建一个要扩展的指标，从而实现自动扩展。</p><figure class="ml mm mn mo gt is"><div class="bz fp l di"><div class="mp mq l"/></div></figure><p id="313b" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在我后来的研究中，我还意识到可能有由EC2实例组成的<a class="ae kw" href="https://faun.pub/deploy-a-containerized-application-on-aws-with-terraform-bf929bb3bb6b" rel="noopener ugc nofollow" target="_blank"> ECS集群，用户可以指定EC2实例的种类和类型。ECS确实有很多我在初次接触时没有注意到的技巧。</a></p><p id="717a" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">这是我分享过的最难也是最长的教程之一，坦白地说，当我收到这个面试挑战时，我非常惊讶，并为自己在给定的时间内完成了它而感到自豪。我意识到在这个教程中有很多内容，可能不是每个人都能够恰当地遵循我一直在做的事情，因此我会在这篇文章中发布回购的github url，以便好奇的人可以看一看，并能够自己加入这些点。</p><p id="db9d" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">就个人而言，我认为在ECS上托管和公开容器比在Kubernetes集群上做同样的事情更难。ECS可能是一个很好的服务，但是在terraform中，设置它并把所有的东西连接在一起以使它工作绝非易事。我可以想象在为更大的团队设置和大规模管理它时的摩擦，以及与它相比Kubernetes带来的简单和易于执行，以及更清晰的API和资源。</p><p id="1d65" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><em class="ms"> PS。如果你觉得这有用，我真的很感激github repo上的一颗星，因为它允许我在未来创建更多相关的内容。</em></p><div class="ip iq gp gr ir kx"><a href="https://github.com/aliabbasjaffri/ecs-terraform-terragrunt" rel="noopener  ugc nofollow" target="_blank"><div class="ky ab fo"><div class="kz ab la cl cj lb"><h2 class="bd jc gy z fp lc fr fs ld fu fw ja bi translated">GitHub-aliabbasjaffri/ECS-terraform-terra grunt:这个存储库包含要部署的terra form代码…</h2><div class="le l"><h3 class="bd b gy z fp lc fr fs ld fu fw dk translated">该存储库包含terraform代码，用于在ECS Fargate集群上部署一个简单的ghost api容器</h3></div><div class="lf l"><p class="bd b dl z fp lc fr fs ld fu fw dk translated">github.com</p></div></div><div class="lg l"><div class="mt l li lj lk lg ll ix kx"/></div></div></a></div></div></div>    
</body>
</html>