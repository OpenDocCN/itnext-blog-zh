<html>
<head>
<title>Kubernetes: part 5 — RBAC authorization with a Role and RoleBinding example</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Kubernetes:第5部分—带有角色和角色绑定示例的RBAC授权</h1>
<blockquote>原文：<a href="https://itnext.io/kubernetes-part-5-rbac-authorization-with-a-role-and-rolebinding-example-765718e94f5a?source=collection_archive---------2-----------------------#2020-03-26">https://itnext.io/kubernetes-part-5-rbac-authorization-with-a-role-and-rolebinding-example-765718e94f5a?source=collection_archive---------2-----------------------#2020-03-26</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/73a92c872a9fad735b7b25c9b1e99bb1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*EabJdu5kv-yzzt7Zolu19A.png"/></div></div></figure><p id="02ec" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">下一个任务是添加一个新用户，该用户将有权检查pods状态和查看日志—必须禁止任何其他操作。</p><p id="e426" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">AWS EKS在Kubernetes集群中使用AWS IAM进行身份验证(查看<a class="ae kw" href="https://rtfm.co.ua/en/kubernetes-part-4-aws-eks-authentification-aws-iam-authenticator-and-aws-iam/" rel="noopener ugc nofollow" target="_blank"> Kubernetes:第4部分— AWS EKS身份验证、aws-iam-authenticator和AWS IAM post了解详细信息</a>)，而在授权方面，例如确定用户是否拥有特定操作的权限— Kubernetes使用自己的基于角色的授权控制机制。</p><p id="976f" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">本系列的前几部分:</p><ul class=""><li id="7ec4" class="kx ky iq ka b kb kc kf kg kj kz kn la kr lb kv lc ld le lf bi translated"><a class="ae kw" href="https://rtfm.co.ua/en/kubernetes-part-1-architecture-and-main-components-overview/" rel="noopener ugc nofollow" target="_blank"> Kubernetes:第1部分—架构和主要组件概述</a></li><li id="7be0" class="kx ky iq ka b kb lg kf lh kj li kn lj kr lk kv lc ld le lf bi translated"><a class="ae kw" href="https://rtfm.co.ua/en/kubernetes-part-2-a-cluster-set-up-on-aws-with-aws-cloud-provider-and-aws-loadbalancer/" rel="noopener ugc nofollow" target="_blank"> Kubernetes:第2部分—使用AWS云提供商和AWS负载平衡器在AWS上建立集群</a></li><li id="d40e" class="kx ky iq ka b kb lg kf lh kj li kn lj kr lk kv lc ld le lf bi translated"><a class="ae kw" href="https://rtfm.co.ua/en/kubernetes-part-3-aws-eks-overview-and-manual-eks-cluster-set-up/" rel="noopener ugc nofollow" target="_blank"> Kubernetes:第3部分— AWS EKS概述和手动EKS集群设置</a></li><li id="f13d" class="kx ky iq ka b kb lg kf lh kj li kn lj kr lk kv lc ld le lf bi translated"><a class="ae kw" href="https://rtfm.co.ua/en/kubernetes-part-4-aws-eks-authentification-aws-iam-authenticator-and-aws-iam/" rel="noopener ugc nofollow" target="_blank"> Kubernetes:第4部分— AWS EKS认证、aws-iam-authenticator和AWS IAM post了解详情</a></li></ul><p id="da24" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">让我们首先对RBAC做一个大致的概述，然后创建一个拥有必要权限的新用户。</p><h2 id="814e" class="ll lm iq bd ln lo lp dn lq lr ls dp lt kj lu lv lw kn lx ly lz kr ma mb mc md bi translated">Kubernetes RBAC概述</h2><p id="505d" class="pw-post-body-paragraph jy jz iq ka b kb me kd ke kf mf kh ki kj mg kl km kn mh kp kq kr mi kt ku kv ij bi translated">文档— <a class="ae kw" href="https://kubernetes.io/docs/reference/access-authn-authz/authorization/" rel="noopener ugc nofollow" target="_blank">授权概述</a>和<a class="ae kw" href="https://kubernetes.io/docs/reference/access-authn-authz/rbac/" rel="noopener ugc nofollow" target="_blank">使用RBAC授权</a>。</p><p id="927a" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">Kubernetes的RBAC模型由三个主要部分组成:</p><ul class=""><li id="5755" class="kx ky iq ka b kb kc kf kg kj kz kn la kr lb kv lc ld le lf bi translated">角色:定义权限边界</li><li id="e590" class="kx ky iq ka b kb lg kf lh kj li kn lj kr lk kv lc ld le lf bi translated">主题:<em class="mj">用户</em>(人或应用程序)，或用户组</li><li id="94d5" class="kx ky iq ka b kb lg kf lh kj li kn lj kr lk kv lc ld le lf bi translated">RoleBingdings:指定哪些<em class="mj">主题</em>拥有哪些<em class="mj">角色</em></li></ul><h2 id="d066" class="ll lm iq bd ln lo lp dn lq lr ls dp lt kj lu lv lw kn lx ly lz kr ma mb mc md bi translated">RBAC <code class="fe mk ml mm mn b">Role</code></h2><p id="3898" class="pw-post-body-paragraph jy jz iq ka b kb me kd ke kf mf kh ki kj mg kl km kn mh kp kq kr mi kt ku kv ij bi translated">一个名为<em class="mj"> example-role </em>的角色示例，它允许通过<code class="fe mk ml mm mn b">get</code>、<code class="fe mk ml mm mn b">watch</code>和<code class="fe mk ml mm mn b">list</code>操作访问<em class="mj"> mynamespace </em>:</p><pre class="mo mp mq mr gt ms mn mt mu aw mv bi"><span id="a243" class="ll lm iq mn b gy mw mx l my mz">kind: Role<br/>apiVersion: rbac.authorization.k8s.io/v1<br/>metadata:<br/>  namespace: mynamespace<br/>  name: example-role<br/>rules:<br/>- apiGroups: [""]<br/>  resources: ["pods"]<br/>  verbs: ["get", "watch", "list"]</span></pre><p id="ec5f" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">要获得Kubernetes <code class="fe mk ml mm mn b"><a class="ae kw" href="https://kubernetes.io/docs/reference/using-api/api-overview/#api-groups" rel="noopener ugc nofollow" target="_blank">apiGroups</a></code>，可以使用<code class="fe mk ml mm mn b">kubectl api-resources</code>:</p><pre class="mo mp mq mr gt ms mn mt mu aw mv bi"><span id="61e0" class="ll lm iq mn b gy mw mx l my mz">$ kubectl api-resources -o wide<br/>NAME SHORTNAMES APIGROUP NAMESPACED KIND VERBS<br/>…<br/>pods po true Pod [create delete deletecollection get list patch update watch]<br/>…</span></pre><p id="194c" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在<code class="fe mk ml mm mn b">rules</code>上面我们:</p><ol class=""><li id="3452" class="kx ky iq ka b kb kc kf kg kj kz kn la kr lb kv na ld le lf bi translated"><code class="fe mk ml mm mn b">apiGroups: [""]</code> -设置<em class="mj">核心API组</em></li><li id="8132" class="kx ky iq ka b kb lg kf lh kj li kn lj kr lk kv na ld le lf bi translated"><code class="fe mk ml mm mn b">resources: ["pods"]</code> -允许访问哪些资源</li><li id="befd" class="kx ky iq ka b kb lg kf lh kj li kn lj kr lk kv na ld le lf bi translated"><code class="fe mk ml mm mn b">["get", "watch", "list"]</code> -上面的资源允许哪些操作</li></ol><h2 id="c225" class="ll lm iq bd ln lo lp dn lq lr ls dp lt kj lu lv lw kn lx ly lz kr ma mb mc md bi translated">RBAC <code class="fe mk ml mm mn b">RoleBingding</code></h2><p id="8ad3" class="pw-post-body-paragraph jy jz iq ka b kb me kd ke kf mf kh ki kj mg kl km kn mh kp kq kr mi kt ku kv ij bi translated">为了将这些权限“映射”到用户，我们使用了Kubernetes <code class="fe mk ml mm mn b">RoleBingding</code>，它为<em class="mj">示例-用户</em>用户设置了<em class="mj"> mynamespace </em>中的<em class="mj">示例-角色</em>:</p><pre class="mo mp mq mr gt ms mn mt mu aw mv bi"><span id="e983" class="ll lm iq mn b gy mw mx l my mz">kind: RoleBinding<br/>apiVersion: rbac.authorization.k8s.io/v1<br/>metadata:<br/>  name: example-rolebinding<br/>  namespace: mynamespace<br/>subjects:<br/>- kind: User<br/>  name: example-user<br/>  apiGroup: rbac.authorization.k8s.io<br/>roleRef:<br/>  kind: Role<br/>  name: example-role<br/>  apiGroup: rbac.authorization.k8s.io</span></pre><p id="e97f" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我们在这里设定:</p><ul class=""><li id="8dfd" class="kx ky iq ka b kb kc kf kg kj kz kn la kr lb kv lc ld le lf bi translated"><code class="fe mk ml mm mn b">subjects</code>:</li><li id="bea1" class="kx ky iq ka b kb lg kf lh kj li kn lj kr lk kv lc ld le lf bi translated"><code class="fe mk ml mm mn b">kind: User</code> -拥有访问权限的对象类型，在我们的例子中，这是一个普通用户</li><li id="0472" class="kx ky iq ka b kb lg kf lh kj li kn lj kr lk kv lc ld le lf bi translated"><code class="fe mk ml mm mn b">name: example-user</code> -设置权限的用户名</li><li id="f0b3" class="kx ky iq ka b kb lg kf lh kj li kn lj kr lk kv lc ld le lf bi translated"><code class="fe mk ml mm mn b">roleRef</code>:</li><li id="2d7a" class="kx ky iq ka b kb lg kf lh kj li kn lj kr lk kv lc ld le lf bi translated"><code class="fe mk ml mm mn b">kind: Role</code> -到底什么将被附加到用户，在这种情况下，它是<code class="fe mk ml mm mn b">Role</code>对象类型</li><li id="4ab8" class="kx ky iq ka b kb lg kf lh kj li kn lj kr lk kv lc ld le lf bi translated"><code class="fe mk ml mm mn b">name: example-role</code> -以及上例中<code class="fe mk ml mm mn b">name: example-role</code>中设置的角色名称</li></ul><h2 id="b269" class="ll lm iq bd ln lo lp dn lq lr ls dp lt kj lu lv lw kn lx ly lz kr ma mb mc md bi translated"><code class="fe mk ml mm mn b">Role</code> vs <code class="fe mk ml mm mn b">ClusterRole</code></h2><p id="02b9" class="pw-post-body-paragraph jy jz iq ka b kb me kd ke kf mf kh ki kj mg kl km kn mh kp kq kr mi kt ku kv ij bi translated">除了描述权限的规则集<code class="fe mk ml mm mn b">Role</code>和<code class="fe mk ml mm mn b">ClusterRole</code>之外，Kubernetes还有<code class="fe mk ml mm mn b">RoleBinding</code>和<code class="fe mk ml mm mn b">ClusterRoleBinding</code>对象。</p><p id="e879" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">不同之处在于，<code class="fe mk ml mm mn b">Role</code>用于名称空间内部，而<code class="fe mk ml mm mn b">ClusterRole</code>是集群范围的权限，没有名称空间边界，例如:</p><ul class=""><li id="7291" class="kx ky iq ka b kb kc kf kg kj kz kn la kr lb kv lc ld le lf bi translated">允许访问群集节点</li><li id="7878" class="kx ky iq ka b kb lg kf lh kj li kn lj kr lk kv lc ld le lf bi translated">所有命名空间中的资源</li><li id="7a4c" class="kx ky iq ka b kb lg kf lh kj li kn lj kr lk kv lc ld le lf bi translated">允许访问端点，如<code class="fe mk ml mm mn b">/healthz</code></li></ul><p id="6b68" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">一个<code class="fe mk ml mm mn b">ClusterRole</code>看起来类似于一个角色，唯一的区别是我们必须将它的<code class="fe mk ml mm mn b">kind</code>设置为<code class="fe mk ml mm mn b">ClusterRole</code>:</p><pre class="mo mp mq mr gt ms mn mt mu aw mv bi"><span id="ef5b" class="ll lm iq mn b gy mw mx l my mz">kind: ClusterRole<br/>apiVersion: rbac.authorization.k8s.io/v1<br/>metadata:<br/>  name: example-clusterrole<br/>rules:<br/>- apiGroups: [""]<br/>  resources: ["pods"]<br/>  verbs: ["get", "watch", "list"]</span></pre><p id="0842" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">还有一个<code class="fe mk ml mm mn b">ClusterRoleBinding</code>例子:</p><pre class="mo mp mq mr gt ms mn mt mu aw mv bi"><span id="0925" class="ll lm iq mn b gy mw mx l my mz">kind: ClusterRoleBinding<br/>apiVersion: rbac.authorization.k8s.io/v1<br/>metadata:<br/>  name: example-clusterrolebinding<br/>subjects:<br/>- kind: User<br/>  name: example-user<br/>  apiGroup: rbac.authorization.k8s.io<br/>roleRef:<br/>  kind: ClusterRole<br/>  name: example-clusterrole<br/>  apiGroup: rbac.authorization.k8s.io</span></pre><p id="b48b" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">请记住，一旦你创建了一个绑定，你将不能编辑它的<code class="fe mk ml mm mn b">roleRef</code>值——相反，你必须删除一个绑定，然后重新创建</p><h2 id="741a" class="ll lm iq bd ln lo lp dn lq lr ls dp lt kj lu lv lw kn lx ly lz kr ma mb mc md bi translated">EKS认证和授权</h2><p id="0afb" class="pw-post-body-paragraph jy jz iq ka b kb me kd ke kf mf kh ki kj mg kl km kn mh kp kq kr mi kt ku kv ij bi translated">简而言之，身份验证和授权流程如下:</p><ol class=""><li id="a34f" class="kx ky iq ka b kb kc kf kg kj kz kn la kr lb kv na ld le lf bi translated"><strong class="ka ir">认证</strong></li><li id="8b3b" class="kx ky iq ka b kb lg kf lh kj li kn lj kr lk kv na ld le lf bi translated">一个客户机向Kubernetes集群发出请求，传递带有用户ID的客户机令牌</li><li id="e75e" class="kx ky iq ka b kb lg kf lh kj li kn lj kr lk kv na ld le lf bi translated">Kubernetes使用<code class="fe mk ml mm mn b">aws-iam-authenticator</code>请求AWS IAM检查这样一个用户是否真的存在，以及他是否真的是他所声称的那个人</li><li id="b828" class="kx ky iq ka b kb lg kf lh kj li kn lj kr lk kv na ld le lf bi translated"><strong class="ka ir">授权</strong></li><li id="d125" class="kx ky iq ka b kb lg kf lh kj li kn lj kr lk kv na ld le lf bi translated">如果用户通过了身份验证步骤——Kubernetes通过RBAC机制向他发送所有用户的数据和操作请求</li><li id="e6ac" class="kx ky iq ka b kb lg kf lh kj li kn lj kr lk kv na ld le lf bi translated">Kubernetes寻找一个将用户与角色对应起来的<code class="fe mk ml mm mn b">RoleBinding</code></li><li id="b66b" class="kx ky iq ka b kb lg kf lh kj li kn lj kr lk kv na ld le lf bi translated">通过Rolу name，Kubernetes将检查用户的权限</li><li id="5344" class="kx ky iq ka b kb lg kf lh kj li kn lj kr lk kv na ld le lf bi translated">最后，Kubernreteds将允许或拒绝用户的请求</li></ol><figure class="mo mp mq mr gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nb"><img src="../Images/520e62ed69deb7bdd75011c09555a270.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*Pj-jxmTPYXUAqKVQ.png"/></div></div></figure><p id="26ef" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">接下来，我们将:</p><ol class=""><li id="1691" class="kx ky iq ka b kb kc kf kg kj kz kn la kr lb kv na ld le lf bi translated">创建IAM用户</li><li id="98b4" class="kx ky iq ka b kb lg kf lh kj li kn lj kr lk kv na ld le lf bi translated">配置AWS CLI</li><li id="4e12" class="kx ky iq ka b kb lg kf lh kj li kn lj kr lk kv na ld le lf bi translated">向窗格添加具有只读权限的RBAC角色</li><li id="0a8c" class="kx ky iq ka b kb lg kf lh kj li kn lj kr lk kv na ld le lf bi translated">添加一个RBAC角色绑定来连接我们的用户和角色</li></ol><h2 id="50b8" class="ll lm iq bd ln lo lp dn lq lr ls dp lt kj lu lv lw kn lx ly lz kr ma mb mc md bi translated">IAM用户</h2><p id="a650" class="pw-post-body-paragraph jy jz iq ka b kb me kd ke kf mf kh ki kj mg kl km kn mh kp kq kr mi kt ku kv ij bi translated">让我们从创建一个IAM用户开始。</p><p id="cec5" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">添加一个新的唯一的<em class="mj">编程访问</em>:</p><figure class="mo mp mq mr gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nc"><img src="../Images/c41ae3d7b0a91050c362cfc91b984dd6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*7yqxHyTgh-6pvWtq.png"/></div></div></figure><p id="d3bd" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">保存其密钥:</p><figure class="mo mp mq mr gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nc"><img src="../Images/846941d67271449238b7ea2654b00d0f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*f6nMJQDzQ-67niA1.jpg"/></div></div></figure><h2 id="6515" class="ll lm iq bd ln lo lp dn lq lr ls dp lt kj lu lv lw kn lx ly lz kr ma mb mc md bi translated">IAM策略</h2><p id="ca37" class="pw-post-body-paragraph jy jz iq ka b kb me kd ke kf mf kh ki kj mg kl km kn mh kp kq kr mi kt ku kv ij bi translated">例如，如果用户需要访问AWS API以获取集群列表，则需要为他添加IAM策略。</p><p id="4c63" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">转到<em class="mj">策略—添加策略</em>:</p><pre class="mo mp mq mr gt ms mn mt mu aw mv bi"><span id="3f00" class="ll lm iq mn b gy mw mx l my mz">{<br/>    "Version": "2012-10-17",<br/>    "Statement": [<br/>        {<br/>            "Effect": "Allow",<br/>            "Action": [<br/>                "eks:DescribeCluster",<br/>                "eks:ListClusters"<br/>            ],<br/>            "Resource": "*"<br/>        }<br/>    ]<br/>}</span></pre><p id="f451" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在这里，我们只允许两个API调用— <code class="fe mk ml mm mn b"><a class="ae kw" href="https://docs.aws.amazon.com/eks/latest/APIReference/API_DescribeCluster.html" rel="noopener ugc nofollow" target="_blank">eks:DescribeCluster</a></code>和<code class="fe mk ml mm mn b"><a class="ae kw" href="https://docs.aws.amazon.com/eks/latest/APIReference/API_ListClusters.html" rel="noopener ugc nofollow" target="_blank">eks:ListClusters</a></code>，用于所有EKS集群的所有区域。</p><p id="82c6" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">保存它并附加到用户:</p><figure class="mo mp mq mr gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nd"><img src="../Images/46ac5f171f95095f98afc790c36d00c9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*n2MntTq57Dn1lmqp.png"/></div></div></figure><h2 id="e89d" class="ll lm iq bd ln lo lp dn lq lr ls dp lt kj lu lv lw kn lx ly lz kr ma mb mc md bi translated">AWS CLI配置</h2><p id="7662" class="pw-post-body-paragraph jy jz iq ka b kb me kd ke kf mf kh ki kj mg kl km kn mh kp kq kr mi kt ku kv ij bi translated">要配置<code class="fe mk ml mm mn b">kubectl</code>，首先我们需要配置我们的AWS CLI，我们可以在专用CLI配置文件中完成，查看<a class="ae kw" href="https://rtfm.co.ua/en/aws-cli-named-profiles/" rel="noopener ugc nofollow" target="_blank"> AWS: CLI命名配置文件</a>帖子:</p><pre class="mo mp mq mr gt ms mn mt mu aw mv bi"><span id="9c45" class="ll lm iq mn b gy mw mx l my mz">$ aws configure — profile eks-ro-user<br/>AWS Access Key ID [None]: AKI***FYC<br/>AWS Secret Access Key [None]: SzH***VGi<br/>Default region name [None]: eu-north-1<br/>Default output format [None]: json</span></pre><p id="4b81" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">检查您现在使用的用户ID:</p><pre class="mo mp mq mr gt ms mn mt mu aw mv bi"><span id="4552" class="ll lm iq mn b gy mw mx l my mz">$ aws — profile eks-ro-user sts get-caller-identity<br/>{<br/>“UserId”: “AID***XGK”,<br/>“Account”: “534***385”,<br/>“Arn”: “arn:aws:iam::534***385:user/eks-ro-user”<br/>}</span></pre><p id="1210" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">并检查对EKS集群的访问(最好说是对AWS API的访问):</p><pre class="mo mp mq mr gt ms mn mt mu aw mv bi"><span id="4075" class="ll lm iq mn b gy mw mx l my mz">$ aws — profile eks-ro-user eks list-clusters — output text<br/>CLUSTERS eks-alb-testing-3<br/>CLUSTERS eks-alb-testing-2</span></pre><h2 id="a55a" class="ll lm iq bd ln lo lp dn lq lr ls dp lt kj lu lv lw kn lx ly lz kr ma mb mc md bi translated">库伯内特RBAC —一个例子</h2><h2 id="e993" class="ll lm iq bd ln lo lp dn lq lr ls dp lt kj lu lv lw kn lx ly lz kr ma mb mc md bi translated"><code class="fe mk ml mm mn b">Role</code></h2><p id="869c" class="pw-post-body-paragraph jy jz iq ka b kb me kd ke kf mf kh ki kj mg kl km kn mh kp kq kr mi kt ku kv ij bi translated">现在，让我们创建一个真实的用户和角色。</p><p id="94c8" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我们将从创建一个角色开始，该角色允许访问pod及其日志，并创建一个端口转发，并且仅用于<code class="fe mk ml mm mn b">get</code>、<code class="fe mk ml mm mn b">list</code>、<code class="fe mk ml mm mn b">create</code>操作:</p><pre class="mo mp mq mr gt ms mn mt mu aw mv bi"><span id="7e17" class="ll lm iq mn b gy mw mx l my mz">kind: Role<br/>apiVersion: rbac.authorization.k8s.io/v1<br/>metadata:<br/>  name: eks-ro-role<br/>rules:<br/>- apiGroups: [""]<br/>  resources: ["pods", "pods/log", "pods/portforward"]<br/>  verbs: ["get", "list", "create"]</span></pre><p id="a04a" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">应用它:</p><pre class="mo mp mq mr gt ms mn mt mu aw mv bi"><span id="8ef0" class="ll lm iq mn b gy mw mx l my mz">$ kubectl apply -f rbac-role.yml<br/>role.rbac.authorization.k8s.io/eks-ro-role created</span></pre><p id="dbff" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">并检查:</p><pre class="mo mp mq mr gt ms mn mt mu aw mv bi"><span id="48a8" class="ll lm iq mn b gy mw mx l my mz">$ kubectl get roles -o yaml<br/>apiVersion: v1<br/>items:<br/>- apiVersion: rbac.authorization.k8s.io/v1<br/>kind: Role<br/>metadata:<br/>annotations:<br/>kubectl.kubernetes.io/last-applied-configuration: |<br/>{“apiVersion”:”rbac.authorization.k8s.io/v1",”kind”:”Role”,”metadata”:{“annotations”:{},”name”:”eks-ro-role”,”namespace”:”default”},”rules”:[{“apiGroups”:[“”],”resources”:[“pods”,”pods/log”],”verbs”:[“get”,”list”]}]}<br/>creationTimestamp: “2020–03–24T10:34:27Z”<br/>name: eks-ro-role<br/>namespace: default<br/>resourceVersion: “681997”<br/>selfLink: /apis/rbac.authorization.k8s.io/v1/namespaces/default/roles/eks-ro-role<br/>uid: 09a78b6f-6dbb-11ea-827f-0a9eb3e1782e<br/>rules:<br/>- apiGroups:<br/>- “”<br/>resources:<br/>- pods<br/>- pods/log<br/>verbs:<br/>- get<br/>- list<br/>kind: List<br/>metadata:<br/>resourceVersion: “”<br/>selfLink: “”</span></pre><h2 id="6a7b" class="ll lm iq bd ln lo lp dn lq lr ls dp lt kj lu lv lw kn lx ly lz kr ma mb mc md bi translated"><code class="fe mk ml mm mn b">RoleBinding</code></h2><p id="21a5" class="pw-post-body-paragraph jy jz iq ka b kb me kd ke kf mf kh ki kj mg kl km kn mh kp kq kr mi kt ku kv ij bi translated">接下来要添加一个RoleBinding来映射我们的用户名和上面创建的角色:</p><pre class="mo mp mq mr gt ms mn mt mu aw mv bi"><span id="90f8" class="ll lm iq mn b gy mw mx l my mz">apiVersion: rbac.authorization.k8s.io/v1<br/>kind: RoleBinding<br/>metadata:<br/>  name: eks-ro-role-binding<br/>subjects:<br/>- kind: User<br/>  name: eks-ro-user<br/>  apiGroup: rbac.authorization.k8s.io<br/>roleRef:<br/>  kind: Role<br/>  name: eks-ro-role<br/>  apiGroup: rbac.authorization.k8s.io</span></pre><p id="536a" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">应用:</p><pre class="mo mp mq mr gt ms mn mt mu aw mv bi"><span id="7f97" class="ll lm iq mn b gy mw mx l my mz">$ kubectl apply -f rbac-rolebinding.yml<br/>rolebinding.rbac.authorization.k8s.io/eks-ro-role-binding created</span></pre><h2 id="1270" class="ll lm iq bd ln lo lp dn lq lr ls dp lt kj lu lv lw kn lx ly lz kr ma mb mc md bi translated">aws-auth <code class="fe mk ml mm mn b">ConfigMap</code></h2><p id="274c" class="pw-post-body-paragraph jy jz iq ka b kb me kd ke kf mf kh ki kj mg kl km kn mh kp kq kr mi kt ku kv ij bi translated">由于我们正在使用AWS —需要更新<em class="mj"> aws-auth </em> <code class="fe mk ml mm mn b">ConfigMap</code>(参见<a class="ae kw" href="https://rtfm.co.ua/en/kubernetes-part-4-aws-eks-authentification-aws-iam-authenticator-and-aws-iam/#AWS_EKS_aws-auth_ConfigMap" rel="noopener ugc nofollow" target="_blank"> AWS EKS aws-auth ConfigMap </a>):</p><p id="9049" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">kubectl编辑配置映射aws-auth -n kube-system</p><p id="11d8" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">添加<code class="fe mk ml mm mn b">mapUsers</code>并指定用户的ARN、姓名及其群组:</p><pre class="mo mp mq mr gt ms mn mt mu aw mv bi"><span id="305c" class="ll lm iq mn b gy mw mx l my mz">apiVersion: v1<br/>data:<br/>  mapRoles: |<br/>    - groups:<br/>      - system:bootstrappers<br/>      - system:nodes<br/>      rolearn: arn:aws:iam::534***385:role/eksctl-eks-alb-testing-2-nodegrou-NodeInstanceRole-M6BS1WV48RLR<br/>      username: system:node:{{EC2PrivateDNSName}}<br/>  mapUsers: |<br/>    - userarn: arn:aws:iam::534***385:user/eks-ro-user<br/>      username: eks-ro-user<br/>      groups: eks-ro-role</span></pre><p id="7901" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">保存并检查它:</p><pre class="mo mp mq mr gt ms mn mt mu aw mv bi"><span id="a847" class="ll lm iq mn b gy mw mx l my mz">$ kubectl get pods — as eks-ro-user<br/>NAME READY STATUS RESTARTS AGE<br/>nginx-7db9fccd9b-7d4rq 1/1 Running 0 58m</span></pre><p id="c043" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">尝试获取工作节点—我们不允许访问此资源:</p><pre class="mo mp mq mr gt ms mn mt mu aw mv bi"><span id="33c4" class="ll lm iq mn b gy mw mx l my mz">$ kubectl get nodes — as eks-ro-user<br/>Error from server (Forbidden): nodes is forbidden: User “eks-ro-user” cannot list resource “nodes” in API group “” at the cluster scope</span></pre><p id="1754" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">太好了！</p><p id="d284" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">现在，让我们来看看pod的日志——使用NGINX运行到测试pod的端口转发:</p><pre class="mo mp mq mr gt ms mn mt mu aw mv bi"><span id="0dac" class="ll lm iq mn b gy mw mx l my mz">$ kubectl — as eks-ro-user port-forward nginx-7db9fccd9b-7d4rq 8000:80<br/>Forwarding from 127.0.0.1:8000 -&gt; 80<br/>Forwarding from [::1]:8000 -&gt; 80</span></pre><p id="2763" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">向pod发出请求:</p><pre class="mo mp mq mr gt ms mn mt mu aw mv bi"><span id="627c" class="ll lm iq mn b gy mw mx l my mz">$ curl -I localhost:8000<br/>HTTP/1.1 200 OK</span></pre><p id="e9d5" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">并检查其日志:</p><pre class="mo mp mq mr gt ms mn mt mu aw mv bi"><span id="b9cc" class="ll lm iq mn b gy mw mx l my mz">$ kubectl — as eks-ro-user logs -f nginx-7db9fccd9b-7d4rq<br/>127.0.0.1 — — [25/Mar/2020:07:29:06 +0000] “GET / HTTP/1.1” 200 612 “-” “curl/7.69.1” “-”</span></pre><p id="fdfe" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">完成了。</p><h2 id="03e7" class="ll lm iq bd ln lo lp dn lq lr ls dp lt kj lu lv lw kn lx ly lz kr ma mb mc md bi translated">有用的链接</h2><ul class=""><li id="353e" class="kx ky iq ka b kb me kf mf kj ne kn nf kr ng kv lc ld le lf bi translated"><a class="ae kw" href="https://www.sovsystems.com/blog/authentication-and-authorization-in-kubernetes" rel="noopener ugc nofollow" target="_blank">Kubernetes中的认证和授权</a></li><li id="eb49" class="kx ky iq ka b kb lg kf lh kj li kn lj kr lk kv lc ld le lf bi translated"><a class="ae kw" href="https://kubernetes.io/docs/reference/access-authn-authz/authorization/#privilege-escalation-via-pod-creation" rel="noopener ugc nofollow" target="_blank">通过创建pod提升权限</a></li><li id="42f8" class="kx ky iq ka b kb lg kf lh kj li kn lj kr lk kv lc ld le lf bi translated"><a class="ae kw" href="https://unofficial-kubernetes.readthedocs.io/en/latest/concepts/cluster-administration/authenticate-across-clusters-kubeconfig/" rel="noopener ugc nofollow" target="_blank">使用kubeconfig进行跨集群认证</a></li><li id="c52b" class="kx ky iq ka b kb lg kf lh kj li kn lj kr lk kv lc ld le lf bi translated"><a class="ae kw" href="https://www.openlogic.com/blog/granting-user-access-your-kubernetes-cluster" rel="noopener ugc nofollow" target="_blank">授予用户访问您的Kubernetes集群的权限</a></li><li id="1b4d" class="kx ky iq ka b kb lg kf lh kj li kn lj kr lk kv lc ld le lf bi translated"><a class="ae kw" href="https://www.freecodecamp.org/news/adding-limited-access-iam-user-to-eks-cluster/" rel="noopener ugc nofollow" target="_blank">如何将受限访问IAM用户添加到EKS集群</a></li><li id="0af7" class="kx ky iq ka b kb lg kf lh kj li kn lj kr lk kv lc ld le lf bi translated"><a class="ae kw" href="https://docs.aws.amazon.com/eks/latest/userguide/add-user-role.html" rel="noopener ugc nofollow" target="_blank">管理集群的用户或IAM角色</a></li><li id="4892" class="kx ky iq ka b kb lg kf lh kj li kn lj kr lk kv lc ld le lf bi translated"><a class="ae kw" href="https://www.magalix.com/blog/kubernetes-authorization" rel="noopener ugc nofollow" target="_blank"> Kubernetes授权</a></li><li id="2897" class="kx ky iq ka b kb lg kf lh kj li kn lj kr lk kv lc ld le lf bi translated"><a class="ae kw" href="https://aws.amazon.com/ru/premiumsupport/knowledge-center/amazon-eks-cluster-access/" rel="noopener ugc nofollow" target="_blank">在亚马逊EKS创建集群后，我如何向其他用户和角色提供访问权限？</a></li><li id="7307" class="kx ky iq ka b kb lg kf lh kj li kn lj kr lk kv lc ld le lf bi translated">如何在亚马逊EKS集群中为我的IAM用户管理跨名称空间的权限？</li><li id="58f7" class="kx ky iq ka b kb lg kf lh kj li kn lj kr lk kv lc ld le lf bi translated"><a class="ae kw" href="https://docs.aws.amazon.com/eks/latest/userguide/security_iam_id-based-policy-examples.html" rel="noopener ugc nofollow" target="_blank">亚马逊EKS基于身份的政策示例</a></li><li id="0bc0" class="kx ky iq ka b kb lg kf lh kj li kn lj kr lk kv lc ld le lf bi translated"><a class="ae kw" href="https://medium.com/@ManagedKube/kubernetes-rbac-giving-permissions-for-logging-and-port-forwarding-882694c91927" rel="noopener"> Kubernetes RBAC —授予登录和端口转发权限</a></li><li id="a754" class="kx ky iq ka b kb lg kf lh kj li kn lj kr lk kv lc ld le lf bi translated"><a class="ae kw" href="https://medium.com/faun/add-new-user-to-manage-aws-eks-e487c5d10ee3" rel="noopener">添加新用户管理AWS EKS </a></li><li id="9b2e" class="kx ky iq ka b kb lg kf lh kj li kn lj kr lk kv lc ld le lf bi translated"><a class="ae kw" href="https://medium.com/containerum/configuring-permissions-in-kubernetes-with-rbac-a456a9717d5d" rel="noopener">用RBAC在Kubernetes中配置权限</a></li></ul></div><div class="ab cl nh ni hu nj" role="separator"><span class="nk bw bk nl nm nn"/><span class="nk bw bk nl nm nn"/><span class="nk bw bk nl nm"/></div><div class="ij ik il im in"><p id="fb76" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><em class="mj">最初发布于</em> <a class="ae kw" href="https://rtfm.co.ua/en/kubernetes-part-5-rbac-authorization-with-a-role-and-rolebinding-example/" rel="noopener ugc nofollow" target="_blank"> <em class="mj"> RTFM: Linux、DevOps和系统管理</em> </a> <em class="mj">。</em></p></div></div>    
</body>
</html>