<html>
<head>
<title>How to get AWS metrics in Grafana in 5 minutes?</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何在5分钟内获得Grafana中的AWS指标？</h1>
<blockquote>原文：<a href="https://itnext.io/how-to-get-aws-metrics-in-grafana-in-a-minute-bc623b7bf6fb?source=collection_archive---------1-----------------------#2019-06-28">https://itnext.io/how-to-get-aws-metrics-in-grafana-in-a-minute-bc623b7bf6fb?source=collection_archive---------1-----------------------#2019-06-28</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="7a7b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">AWS提供<a class="ae kl" href="https://docs.aws.amazon.com/AmazonCloudWatch/latest/monitoring/CloudWatch_Dashboards.html" rel="noopener ugc nofollow" target="_blank"> AWS Cloudwatch仪表盘</a>来构建您自己的服务指标仪表盘。</p><p id="2541" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这是一个良好的开端，但这一解决方案并不是最好的扩展方案，因为AWS Cloudwatch仪表盘存在许多棘手问题:</p><ul class=""><li id="4c05" class="km kn iq jp b jq jr ju jv jy ko kc kp kg kq kk kr ks kt ku bi translated">AWS资源标识符在仪表板中是硬编码的</li><li id="7b69" class="km kn iq jp b jq kv ju kw jy kx kc ky kg kz kk kr ks kt ku bi translated">您必须为每个地区和每个AWS帐户复制仪表板</li><li id="a107" class="km kn iq jp b jq kv ju kw jy kx kc ky kg kz kk kr ks kt ku bi translated">Cloudwatch仪表盘收费3美元/仪表盘/月(见<a class="ae kl" href="https://aws.amazon.com/cloudwatch/pricing/" rel="noopener ugc nofollow" target="_blank">定价</a>)</li></ul><p id="d67d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">幸运的是，Grafana已经与AWS Cloudwatch 进行了内置集成，您可以使用它来进一步利用Grafana社区来使用现有的仪表板。</p><figure class="lb lc ld le gt lf gh gi paragraph-image"><div class="gh gi la"><img src="../Images/f8b68fa74a643c2fcee79777a49e0838.png" data-original-src="https://miro.medium.com/v2/resize:fit:892/format:webp/1*vQCJhFFIr-KdBbfJziHriA.png"/></div></figure><p id="7029" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在这篇博文中，我将在几分钟内展示如何在Grafana中集成Cloudwatch指标。</p></div><div class="ab cl li lj hu lk" role="separator"><span class="ll bw bk lm ln lo"/><span class="ll bw bk lm ln lo"/><span class="ll bw bk lm ln"/></div><div class="ij ik il im in"><h1 id="6116" class="lp lq iq bd lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm bi translated">AWS设置</h1><p id="d737" class="pw-post-body-paragraph jn jo iq jp b jq mn js jt ju mo jw jx jy mp ka kb kc mq ke kf kg mr ki kj kk ij bi translated">Grafana需要AWS权限来获取Cloudwatch指标。出于安全目的，我们将创建一个专用于Grafana的AWS用户，并有自己的政策。</p><p id="1195" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">创建具有Cloudwatch只读权限的<code class="fe ms mt mu mv b">CustomerGrafana</code>策略:</p><pre class="lb lc ld le gt mw mv mx my aw mz bi"><span id="4d93" class="na lq iq mv b gy nb nc l nd ne">cat &gt; /tmp/policy.json &lt;&lt; EOF<br/>{<br/>    "Version": "2012-10-17",<br/>    "Statement": [<br/>        {<br/>            "Sid": "AllowReadingMetricsFromCloudWatch",<br/>            "Effect": "Allow",<br/>            "Action": [<br/>                "cloudwatch:ListMetrics",<br/>                "cloudwatch:GetMetricStatistics",<br/>                "cloudwatch:GetMetricData"<br/>            ],<br/>            "Resource": "*"<br/>        },<br/>        {<br/>            "Sid": "AllowReadingTagsInstancesRegionsFromEC2",<br/>            "Effect": "Allow",<br/>            "Action": [<br/>                "ec2:DescribeTags",<br/>                "ec2:DescribeInstances",<br/>                "ec2:DescribeRegions"<br/>            ],<br/>            "Resource": "*"<br/>        },<br/>        {<br/>            "Sid": "AllowReadingResourcesForTags",<br/>            "Effect" : "Allow",<br/>            "Action" : "tag:GetResources",<br/>            "Resource" : "*"<br/>        }<br/>    ]<br/>}<br/>EOF</span><span id="1320" class="na lq iq mv b gy nf nc l nd ne">aws iam create-policy \<br/>--policy-name CustomerGrafana \<br/>--policy-document file:///tmp/policy.json \<br/>--description "Used by Grafana to fetch Cloudwatch metrics"</span><span id="34c6" class="na lq iq mv b gy nf nc l nd ne">rm /tmp/policy.json</span></pre><p id="961c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">创建一个名为<code class="fe ms mt mu mv b">service_grafana</code>的AWS用户，然后附加先前创建的策略，最后生成一个AWS API密钥:</p><pre class="lb lc ld le gt mw mv mx my aw mz bi"><span id="a88e" class="na lq iq mv b gy nb nc l nd ne">AWS_USERNAME=service_grafana<br/>AWS_ACCOUNT_ID=$(aws sts get-caller-identity | jq -r .Account)<br/>AWS_POLICY_ARN=arn:aws:iam::$AWS_ACCOUNT_ID:policy/CustomerGrafana</span><span id="9668" class="na lq iq mv b gy nf nc l nd ne"># Create AWS user<br/>aws iam create-user --user-name $AWS_USERNAME</span><span id="8b53" class="na lq iq mv b gy nf nc l nd ne"># Attach IAM policy to user<br/>aws iam attach-user-policy --policy-arn $AWS_POLICY_ARN --user-name $AWS_USERNAME</span><span id="4dd1" class="na lq iq mv b gy nf nc l nd ne"># Generate AWS access key<br/>aws iam create-access-key --user-name $AWS_USERNAME</span></pre><p id="b432" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">将<code class="fe ms mt mu mv b">service_grafana</code> API关键信息保存在以下变量中:</p><pre class="lb lc ld le gt mw mv mx my aw mz bi"><span id="ab05" class="na lq iq mv b gy nb nc l nd ne">GRAFANA_AWS_ACCESS_KEY_ID=&lt;AWS ACCESS KEY ID&gt;<br/>GRAFANA_AWS_SECRET_ACCESS_KEY=&lt;AWS SECRET ACCESS KEY&gt;<br/>GRAFANA_AWS_DEFAULT_REGION=&lt;YOUR MAIN AWS REGION&gt;</span></pre><p id="50ad" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在我们已经为Grafana配置做好了准备！</p></div><div class="ab cl li lj hu lk" role="separator"><span class="ll bw bk lm ln lo"/><span class="ll bw bk lm ln lo"/><span class="ll bw bk lm ln"/></div><div class="ij ik il im in"><h1 id="2050" class="lp lq iq bd lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm bi translated">格拉夫纳构型</h1><p id="831c" class="pw-post-body-paragraph jn jo iq jp b jq mn js jt ju mo jw jx jy mp ka kb kc mq ke kf kg mr ki kj kk ij bi translated">让我们使用Docker启动一个Grafana实例:</p><pre class="lb lc ld le gt mw mv mx my aw mz bi"><span id="94ed" class="na lq iq mv b gy nb nc l nd ne">docker run \<br/>  --detach \<br/>  --publish 3000:3000 \<br/>  --name=grafana \<br/>  --env "GF_SECURITY_ADMIN_PASSWORD=secret" \<br/>  grafana/grafana</span></pre><p id="3179" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">Grafana可在<a class="ae kl" href="http://localhost:3000" rel="noopener ugc nofollow" target="_blank"> http://localhost:3000 </a>获得(凭证:admin/secret)。</p><p id="f408" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">为了更快地部署，我们将使用Grafana API来创建数据源和导入仪表板。定义以下环境变量:</p><pre class="lb lc ld le gt mw mv mx my aw mz bi"><span id="5c87" class="na lq iq mv b gy nb nc l nd ne">GRAFANA_USERNAME="admin"<br/>GRAFANA_PASSWORD="secret"<br/>GRAFANA_HOST="<a class="ae kl" href="http://localhost:3000" rel="noopener ugc nofollow" target="_blank">http://localhost:3000</a>"</span></pre><p id="475b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在Grafana中创建AWS Cloudwatch数据源:</p><pre class="lb lc ld le gt mw mv mx my aw mz bi"><span id="4a00" class="na lq iq mv b gy nb nc l nd ne"># Generate datasource configuration<br/>cat &gt; /tmp/datasource.json &lt;&lt; EOF<br/>{<br/>  "name":"cloudwatch1",<br/>  "type":"cloudwatch",<br/>  "access":"proxy",<br/>  "jsonData": {<br/>    "authType": "keys",<br/>    "defaultRegion": "$GRAFANA_AWS_DEFAULT_REGION"<br/>  },<br/>  "secureJsonData":{<br/>    "accessKey":"$GRAFANA_AWS_ACCESS_KEY_ID",<br/>    "secretKey":"$GRAFANA_AWS_SECRET_ACCESS_KEY"<br/>  }<br/>}<br/>EOF</span><span id="f6ca" class="na lq iq mv b gy nf nc l nd ne"># Create Grafana datasource<br/>curl -v -k $GRAFANA_HOST/api/datasources \<br/>-u "$GRAFANA_USERNAME:$GRAFANA_PASSWORD" \<br/>-H "Content-Type: application/json" \<br/>-H "Accept: application/json" \<br/>-d <a class="ae kl" href="http://twitter.com/datasource" rel="noopener ugc nofollow" target="_blank">@</a>/tmp/<a class="ae kl" href="http://twitter.com/datasource" rel="noopener ugc nofollow" target="_blank">datasource</a>.json</span><span id="6753" class="na lq iq mv b gy nf nc l nd ne">rm /tmp/datasource.json</span></pre><p id="fd92" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">Grafana现在已经连接到AWS Cloudwatch了，让我们来创建仪表盘吧！</p></div><div class="ab cl li lj hu lk" role="separator"><span class="ll bw bk lm ln lo"/><span class="ll bw bk lm ln lo"/><span class="ll bw bk lm ln"/></div><div class="ij ik il im in"><h1 id="80b3" class="lp lq iq bd lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm bi translated">Grafana仪表板</h1><p id="b1e0" class="pw-post-body-paragraph jn jo iq jp b jq mn js jt ju mo jw jx jy mp ka kb kc mq ke kf kg mr ki kj kk ij bi translated"><a class="ae kl" href="https://monitoringartist.com" rel="noopener ugc nofollow" target="_blank">监测艺术家</a>在他们的Github账户上分享了AWS Cloudwatch指标的Grafana仪表盘<a class="ae kl" href="https://github.com/monitoringartist/grafana-aws-cloudwatch-dashboards" rel="noopener ugc nofollow" target="_blank">。</a></p><p id="5e56" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">由于大约有20个仪表板，我们将创建一个“AWS”目录:</p><pre class="lb lc ld le gt mw mv mx my aw mz bi"><span id="48fa" class="na lq iq mv b gy nb nc l nd ne">GRAFANA_DIRECTORY_ID=$(curl -s -k \<br/>$GRAFANA_HOST/api/folders \<br/>-u "$GRAFANA_USERNAME:$GRAFANA_PASSWORD" \<br/>-H "Content-Type: application/json" \<br/>-H "Accept: application/json" \<br/>-d '{"title":"AWS"}' | jq .id)</span></pre><p id="7a21" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">使用以下命令可以直接导入仪表板:</p><pre class="lb lc ld le gt mw mv mx my aw mz bi"><span id="5a6e" class="na lq iq mv b gy nb nc l nd ne">dashboards=(1516 677 139 674 590 659 758 623 617 551 653 969 650 644 607 593 707 575 1519 581 584 2969 8050);</span><span id="b3e0" class="na lq iq mv b gy nf nc l nd ne">for dashboard_id in "${dashboards[@]}"; do<br/>  echo "Processing dashboard: $dashboard_id"</span><span id="ca0a" class="na lq iq mv b gy nf nc l nd ne">  # Get dashboard content<br/>  content=$(curl -s -k -u "$GRAFANA_USERNAME:$GRAFANA_PASSWORD" $GRAFANA_HOST/api/gnet/dashboards/$dashboard_id | jq .json)</span><span id="ff94" class="na lq iq mv b gy nf nc l nd ne">  # Override dashboard configuration<br/>  cat &gt; /tmp/dashboard.json &lt;&lt; EOF<br/>  {<br/>    "dashboard": $content,<br/>    "overwrite": true,<br/>    "folderId": $GRAFANA_DIRECTORY_ID,<br/>    "inputs":<br/>      [{<br/>        "pluginId": "cloudwatch",<br/>        "name": "DS_CLOUDWATCH",<br/>        "type": "datasource",<br/>        "value": "cloudwatch1"<br/>      }]<br/>  }<br/>EOF</span><span id="848c" class="na lq iq mv b gy nf nc l nd ne">  # Publish dashboard on Grafana<br/>  curl -s \<br/>  $GRAFANA_HOST/api/dashboards/import \<br/>  -u "$GRAFANA_USERNAME:$GRAFANA_PASSWORD" \<br/>  -H "Content-Type: application/json" \<br/>  -H "Accept: application/json" \<br/>  -d <a class="ae kl" href="http://twitter.com/datasource" rel="noopener ugc nofollow" target="_blank">@</a>/tmp/dashboard.json<br/>  echo ""</span><span id="beb3" class="na lq iq mv b gy nf nc l nd ne">  rm /tmp/dashboard.json<br/>done</span></pre><p id="2f03" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">就是这样！您可以在Grafana仪表板中看到您的AWS指标:<a class="ae kl" href="http://localhost:3000/dashboards" rel="noopener ugc nofollow" target="_blank">http://localhost:3000/dashboards</a></p><figure class="lb lc ld le gt lf gh gi paragraph-image"><div role="button" tabindex="0" class="nh ni di nj bf nk"><div class="gh gi ng"><img src="../Images/13717cc716c7a9eff909c7844a1a904b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*mB6rUiQbszpixGaDY0vOsA.png"/></div></div><figcaption class="nl nm gj gh gi nn no bd b be z dk translated">关于AWS RDS的Grafana仪表板</figcaption></figure></div><div class="ab cl li lj hu lk" role="separator"><span class="ll bw bk lm ln lo"/><span class="ll bw bk lm ln lo"/><span class="ll bw bk lm ln"/></div><div class="ij ik il im in"><p id="124e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">查看<a class="ae kl" href="https://grafana.com/dashboards" rel="noopener ugc nofollow" target="_blank">https://grafana.com/dashboards</a>上提供的其他Grafana仪表盘。</p></div></div>    
</body>
</html>