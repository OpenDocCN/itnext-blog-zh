<html>
<head>
<title>How to build and run a SQL container using a DACPAC file</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何使用DACPAC文件构建和运行SQL容器</h1>
<blockquote>原文：<a href="https://itnext.io/how-to-build-and-run-a-sql-container-using-a-dacpac-file-c7b0d30f6255?source=collection_archive---------2-----------------------#2021-12-15">https://itnext.io/how-to-build-and-run-a-sql-container-using-a-dacpac-file-c7b0d30f6255?source=collection_archive---------2-----------------------#2021-12-15</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><figure class="ip iq gp gr ir is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi io"><img src="../Images/ea06fbbd276fead34c1db3661b01f77c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*-qEKc5z5lo5V3oMs"/></div></div></figure><div class=""/><h1 id="5605" class="jy jz jb bd ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv bi translated">介绍</h1><p id="b42b" class="pw-post-body-paragraph kw kx jb ky b kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt ij bi translated">好的，最近我在做一个代码项目，这个项目对SQL数据库有很强的依赖性。现在通常我会试着模仿一些东西，添加一些抽象概念等等。但是对于相对简单的服务，我想知道是否有更好的方法来实现这一点。</p><p id="fbc7" class="pw-post-body-paragraph kw kx jb ky b kz lu lb lc ld lv lf lg lh lw lj lk ll lx ln lo lp ly lr ls lt ij bi translated">我正在做的项目已经包含了一个. sqlproj项目，它生成了一个dacpac文件，使开发人员能够轻松地保持他们的本地或远程SQL实例同步(如果你对这些概念中的任何一个都不熟悉，请在这里查看<a class="ae lz" href="https://docs.microsoft.com/en-us/openspecs/sql_data_portability/ms-dacpac/c62984e2-0ab5-430d-b0e1-9b38835cc244" rel="noopener ugc nofollow" target="_blank">DAC PAC文档</a>和<a class="ae lz" href="https://docs.microsoft.com/en-us/previous-versions/sql/sql-server-data-tools/hh272702(v=vs.103)" rel="noopener ugc nofollow" target="_blank"> sqlproj文档</a>)。这意味着如果我构建了sqlproj，我就得到一个dacpac…但是如何将它部署到容器中呢？</p><h1 id="8299" class="jy jz jb bd ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv bi translated">从哪里开始</h1><p id="56d9" class="pw-post-body-paragraph kw kx jb ky b kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt ij bi translated">我知道dockerfiles，也知道dacpac文件，但是我如何将这两者结合在一起呢？</p><p id="403c" class="pw-post-body-paragraph kw kx jb ky b kz lu lb lc ld lv lf lg lh lw lj lk ll lx ln lo lp ly lr ls lt ij bi translated">基本上，我想要的是一种进行docker构建的方法，使用微软为SQL2019提供的基础映像，将我的dacpac规范放入该数据库，以便创建我的表等，然后在我的机器上准备好容器定义，以便在我需要时随时加速和减速。</p><p id="5c11" class="pw-post-body-paragraph kw kx jb ky b kz lu lb lc ld lv lf lg lh lw lj lk ll lx ln lo lp ly lr ls lt ij bi translated">幸运的是，我偶然发现了Ken Muse关于Wintellect 的一篇<a class="ae lz" href="https://www.wintellect.com/devops-sql-server-dacpac-docker/" rel="noopener ugc nofollow" target="_blank">帖子，虽然它不适合我的用例(因为它是SQL2017，有一些bug)，但它确实给了我一个很好的起点。肯获得了巨大的荣誉👏👏👏👏👏</a></p><h1 id="ddd8" class="jy jz jb bd ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv bi translated">容器定义</h1><figure class="ma mb mc md gt is"><div class="bz fp l di"><div class="me mf l"/></div></figure><h2 id="8b10" class="mg jz jb bd ka mh mi dn ke mj mk dp ki lh ml mm km ll mn mo kq lp mp mq ku mr bi translated">分解它</h2><p id="8f25" class="pw-post-body-paragraph kw kx jb ky b kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt ij bi translated">好了，这里有很多步骤，让我来分解一下:</p><ol class=""><li id="4093" class="ms mt jb ky b kz lu ld lv lh mu ll mv lp mw lt mx my mz na bi translated">首先，我使用MSFT提供的基本SQL2019映像</li><li id="854f" class="ms mt jb ky b kz nb ld nc lh nd ll ne lp nf lt mx my mz na bi translated">接下来，我将我的权限提升到<code class="fe ng nh ni nj b">root</code>,使我能够安装一些<code class="fe ng nh ni nj b">apt-get</code>包</li><li id="44ba" class="ms mt jb ky b kz nb ld nc lh nd ll ne lp nf lt mx my mz na bi translated">在第11行，我转到了<code class="fe ng nh ni nj b">sqlpackage</code>的linux发行版的<code class="fe ng nh ni nj b">aka.ms</code>链接。如果您不熟悉这个工具，请查看这里的文档，但本质上它是一个CLI工具，允许您将dacpac部署到SQL中。</li><li id="5df3" class="ms mt jb ky b kz nb ld nc lh nd ll ne lp nf lt mx my mz na bi translated">第19行我将dacpac文件复制到容器层</li><li id="7d3d" class="ms mt jb ky b kz nb ld nc lh nd ll ne lp nf lt mx my mz na bi translated">第22–27行设置了SQL容器启动所需的一些默认选项。<a class="ae lz" href="https://hub.docker.com/_/microsoft-mssql-server" rel="noopener ugc nofollow" target="_blank">更多信息可在此处的文档中找到</a></li><li id="0834" class="ms mt jb ky b kz nb ld nc lh nd ll ne lp nf lt mx my mz na bi translated">第31+行是真正神奇的地方。</li><li id="6f77" class="ms mt jb ky b kz nb ld nc lh nd ll ne lp nf lt mx my mz na bi translated">首先，我们启动sqlserver进程，等待它通知我们代理已经启动。</li><li id="9889" class="ms mt jb ky b kz nb ld nc lh nd ll ne lp nf lt mx my mz na bi translated">接下来，我们调用下载的sqlpackage cli二进制文件，告诉它发布到本地主机并使用我们的dacpac文件。</li><li id="3484" class="ms mt jb ky b kz nb ld nc lh nd ll ne lp nf lt mx my mz na bi translated">Line 33 &gt;整理图像。</li></ol><h2 id="8c10" class="mg jz jb bd ka mh mi dn ke mj mk dp ki lh ml mm km ll mn mo kq lp mp mq ku mr bi translated">运行容器</h2><p id="7729" class="pw-post-body-paragraph kw kx jb ky b kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt ij bi translated">我们可以通过调用以下命令轻松构建并运行该容器:</p><pre class="ma mb mc md gt nk nj nl nm aw nn bi"><span id="68a8" class="mg jz jb nj b gy no np l nq nr">$ podman build ../. --build-arg PASSWORD="&lt;YourStrong@Passw0rd&gt;" -t mydatabase:1.0 --no-cache</span><span id="5d5d" class="mg jz jb nj b gy ns np l nq nr">$ podman run -p 1433:1433 --name sqldb -d mydatabase:1.0</span></pre><p id="b3e5" class="pw-post-body-paragraph kw kx jb ky b kz lu lb lc ld lv lf lg lh lw lj lk ll lx ln lo lp ly lr ls lt ij bi translated">我在这里使用<code class="fe ng nh ni nj b">podman</code>作为我的容器引擎，但是同样的命令也应该在<code class="fe ng nh ni nj b">docker</code>中完美地工作😃</p><p id="fb6a" class="pw-post-body-paragraph kw kx jb ky b kz lu lb lc ld lv lf lg lh lw lj lk ll lx ln lo lp ly lr ls lt ij bi translated">(请注意，我在这里使用了<code class="fe ng nh ni nj b">--no-cache</code>标志，因为我遇到了问题，在这里<code class="fe ng nh ni nj b">podman</code>会缓存<code class="fe ng nh ni nj b">dacpac</code>文件，而不会注意到它是否已经被更改/重建🙈)</p><h2 id="6f51" class="mg jz jb bd ka mh mi dn ke mj mk dp ki lh ml mm km ll mn mo kq lp mp mq ku mr bi translated">我的解决方案和Ken的解决方案之间的差异</h2><p id="7593" class="pw-post-body-paragraph kw kx jb ky b kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt ij bi translated">对于那些对肯写的博客和我的版本之间的差异感兴趣的人:</p><ul class=""><li id="2eca" class="ms mt jb ky b kz lu ld lv lh mu ll mv lp mw lt nt my mz na bi translated">我必须将权限提升到root，因为没有它apt-get就无法工作。我本可以把它们放回去的，但我没有这么做。</li><li id="e514" class="ms mt jb ky b kz nb ld nc lh nd ll ne lp nf lt nt my mz na bi translated">Ken使用的<code class="fe ng nh ni nj b">sqlpackage</code> uri似乎不想在内置了<code class="fe ng nh ni nj b">netstandard2.0</code>的dacpac的容器中正常运行。它不停地抱怨openssl不是正确的版本，把它撞向这个从未修复的链接。</li><li id="b248" class="ms mt jb ky b kz nb ld nc lh nd ll ne lp nf lt nt my mz na bi translated">对cli做了一些整理，使图像变得更小。</li></ul><h1 id="bcfc" class="jy jz jb bd ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv bi translated">结论</h1><p id="0079" class="pw-post-body-paragraph kw kx jb ky b kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt ij bi translated">我真的很喜欢集装箱给我的隔离和保护。尤其是在运行服务测试时，因为我可能会污染我的本地数据库容器，几分钟后将其拆除并重新启动。我还可以预见，将来我会让这些容器在我的构建代理上运行，这样我就不需要在CI/CD构建时使用infra了。</p><p id="3646" class="pw-post-body-paragraph kw kx jb ky b kz lu lb lc ld lv lf lg lh lw lj lk ll lx ln lo lp ly lr ls lt ij bi translated">我希望这能在将来帮助其他人👋</p><figure class="ma mb mc md gt is gh gi paragraph-image"><div class="gh gi nu"><img src="../Images/0dc001aaacfbcca4bef1e9b38fb35ce5.png" data-original-src="https://miro.medium.com/v2/resize:fit:534/0*bqIYTRbr0IC07VaF.gif"/></div></figure></div></div>    
</body>
</html>