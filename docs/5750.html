<html>
<head>
<title>ArgoCD: users, access, and RBAC</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">ArgoCD:用户、访问和RBAC</h1>
<blockquote>原文：<a href="https://itnext.io/argocd-users-access-and-rbac-ddf9f8b51bad?source=collection_archive---------6-----------------------#2021-05-17">https://itnext.io/argocd-users-access-and-rbac-ddf9f8b51bad?source=collection_archive---------6-----------------------#2021-05-17</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/1a446629e8c022ba478ecb739487ffac.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*LydFAwy_HJjw8lGCsi1Iqg.png"/></div></div></figure><p id="7371" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><a class="ae kw" href="https://rtfm.co.ua/en/category/ci-cd-en/argocd-en/" rel="noopener ugc nofollow" target="_blank"> ArgoCD </a>有两种类型的用户——在<code class="fe kx ky kz la b">argocd-cm</code>配置图中设置的本地用户和单点登录用户。</p><p id="74fd" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">下面，我们将谈到本地用户管理，在下一章将看到如何集成ArgoCD和Okta，因为本地用户不能分组。参见<a class="ae kw" href="https://argoproj.github.io/argo-cd/operator-manual/user-management/#local-usersaccounts-v15" rel="noopener ugc nofollow" target="_blank">本地用户/账户</a>页面上的文档。</p><p id="ebb6" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">对于任何用户，都可以使用角色来配置他们的权限，这些角色附加了描述对象的策略，以允许用户对其进行访问和操作。</p><p id="e4cd" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">有了这个，访问可以按集群进行全局配置，或者专用于<a class="ae kw" href="https://rtfm.co.ua/en/?p=26033#ArgoCD_Projects" rel="noopener ugc nofollow" target="_blank">项目</a>。</p><p id="e756" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">让我们从添加一个简单的本地用户开始，然后一步一步地配置剩下的部分。</p><ul class=""><li id="4cf3" class="lb lc iq ka b kb kc kf kg kj ld kn le kr lf kv lg lh li lj bi translated"><a class="ae kw" href="https://rtfm.co.ua/en/argocd-users-access-and-rbac/#Users_and_roles_in_ArgoCD" rel="noopener ugc nofollow" target="_blank">ArgoCD中的用户和角色</a></li><li id="fcff" class="lb lc iq ka b kb lk kf ll kj lm kn ln kr lo kv lg lh li lj bi translated"><a class="ae kw" href="https://rtfm.co.ua/en/argocd-users-access-and-rbac/#Adding_a_local_user" rel="noopener ugc nofollow" target="_blank">添加本地用户</a></li><li id="0259" class="lb lc iq ka b kb lk kf ll kj lm kn ln kr lo kv lg lh li lj bi translated"><a class="ae kw" href="https://rtfm.co.ua/en/argocd-users-access-and-rbac/#Roles_and_RBAC" rel="noopener ugc nofollow" target="_blank">角色和RBAC </a></li><li id="0b76" class="lb lc iq ka b kb lk kf ll kj lm kn ln kr lo kv lg lh li lj bi translated"><a class="ae kw" href="https://rtfm.co.ua/en/argocd-users-access-and-rbac/#ArgoCD_Projects" rel="noopener ugc nofollow" target="_blank"> ArgoCD项目</a></li><li id="d083" class="lb lc iq ka b kb lk kf ll kj lm kn ln kr lo kv lg lh li lj bi translated"><a class="ae kw" href="https://rtfm.co.ua/en/argocd-users-access-and-rbac/#Projects_and_roles" rel="noopener ugc nofollow" target="_blank">项目和角色</a></li><li id="cf53" class="lb lc iq ka b kb lk kf ll kj lm kn ln kr lo kv lg lh li lj bi translated"><a class="ae kw" href="https://rtfm.co.ua/en/argocd-users-access-and-rbac/#Global_roles" rel="noopener ugc nofollow" target="_blank">全局角色</a></li><li id="9bb5" class="lb lc iq ka b kb lk kf ll kj lm kn ln kr lo kv lg lh li lj bi translated"><a class="ae kw" href="https://rtfm.co.ua/en/argocd-users-access-and-rbac/#Project_roles_and_authentication_tokens" rel="noopener ugc nofollow" target="_blank">项目角色和认证令牌</a></li><li id="25b2" class="lb lc iq ka b kb lk kf ll kj lm kn ln kr lo kv lg lh li lj bi translated"><a class="ae kw" href="https://rtfm.co.ua/en/argocd-users-access-and-rbac/#ArgoCD_groups" rel="noopener ugc nofollow" target="_blank"> ArgoCD组</a></li><li id="5412" class="lb lc iq ka b kb lk kf ll kj lm kn ln kr lo kv lg lh li lj bi translated"><a class="ae kw" href="https://rtfm.co.ua/en/argocd-users-access-and-rbac/#Putting_all_together" rel="noopener ugc nofollow" target="_blank">把所有的放在一起</a></li></ul><h1 id="68f1" class="lp lq iq bd lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm bi translated">ArgoCD中的用户和角色</h1><h2 id="37a1" class="mn lq iq bd lr mo mp dn lv mq mr dp lz kj ms mt md kn mu mv mh kr mw mx ml my bi translated">添加本地用户</h2><p id="113b" class="pw-post-body-paragraph jy jz iq ka b kb mz kd ke kf na kh ki kj nb kl km kn nc kp kq kr nd kt ku kv ij bi translated">要添加本地用户，编辑<code class="fe kx ky kz la b">argocd-cm</code>配置图并添加一条<code class="fe kx ky kz la b">accounts.USERNAME</code>记录:</p><pre class="ne nf ng nh gt ni la nj nk aw nl bi"><span id="49a9" class="mn lq iq la b gy nm nn l no np">apiVersion: v1<br/>data:<br/>  accounts.testuser: apiKey,login<br/>...</span></pre><p id="535f" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">通过这里的<code class="fe kx ky kz la b">apiKey</code>，我们已经设置用户可以生成<a class="ae kw" href="https://rtfm.co.ua/en/kubernetes-serviceaccounts-jwt-tokens-authentication-and-rbac-authorization/#JWT_token" rel="noopener ugc nofollow" target="_blank"> JWT令牌</a>进行身份验证，参见<a class="ae kw" href="https://argoproj.github.io/argo-cd/operator-manual/security/#authentication" rel="noopener ugc nofollow" target="_blank">安全</a>，通过<code class="fe kx ky kz la b">login</code>，允许该用户使用ArgoCD WebUI登录。</p><p id="0b82" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">保存并检查用户列表:</p><pre class="ne nf ng nh gt ni la nj nk aw nl bi"><span id="d4c6" class="mn lq iq la b gy nm nn l no np">$ argocd account list<br/>NAME ENABLED CAPABILITIES<br/>admin true login<br/>testuser true apiKey, login</span></pre><p id="404d" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><em class="nq"> admin </em>用户是在ArgoCD实例设置期间创建的，它不能使用令牌。这可以通过在<code class="fe kx ky kz la b">argocd-cm</code>中设置该用户来配置，尽管建议在添加所有必需的用户后禁用管理员用户。</p><p id="7976" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">一般来说，这个想法是让用户访问WebUI，让<a class="ae kw" href="https://rtfm.co.ua/en/?p=26033#Projects_and_roles" rel="noopener ugc nofollow" target="_blank"> <em class="nq">项目角色</em></a><em class="nq"/>——获得可以在CI/CD管道中使用的令牌。</p><p id="d696" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">测试用户是我们刚刚添加的，目前还没有设置密码。</p><p id="2d7b" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">要为他创建密码，您需要有当前管理员的密码:</p><pre class="ne nf ng nh gt ni la nj nk aw nl bi"><span id="a2d9" class="mn lq iq la b gy nm nn l no np">$ argocd account update-password --account testuser --new-password 1234 --current-password admin-p@ssw0rd</span></pre><p id="ee2b" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">密码已更新</p><p id="17a5" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">不是最好的解决方案，但事实如此。详情请参见<a class="ae kw" href="https://github.com/argoproj/argo-cd/issues/4096" rel="noopener ugc nofollow" target="_blank">无法通过argocd CLI </a>更改用户密码的讨论。</p><p id="9600" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">现在，使用<em class="nq">测试用户</em>登录:</p><pre class="ne nf ng nh gt ni la nj nk aw nl bi"><span id="021c" class="mn lq iq la b gy nm nn l no np">$ argocd login dev-1–18.argocd.example.com --username testuser --name testuser@dev-1–18.argocd.example.com<br/>Password:<br/>‘testuser’ logged in successfully<br/>Context ‘testuser@dev-1–18.argocd.example.com’ updated</span></pre><p id="79fe" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">检查本地ArgoCD CLI上下文:</p><pre class="ne nf ng nh gt ni la nj nk aw nl bi"><span id="d776" class="mn lq iq la b gy nm nn l no np">$ argocd login dcontext<br/>CURRENT NAME SERVER<br/>admin@dev-1–18.argocd.example.com dev-1–18.argocd.example.com<br/>* testuser@dev-1–18.argocd.example.com dev-1–18.argocd.example.com</span></pre><p id="9bbd" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">好了，现在我们在<em class="nq">测试用户</em>下。</p><h2 id="9142" class="mn lq iq bd lr mo mp dn lv mq mr dp lz kj ms mt md kn mu mv mh kr mw mx ml my bi translated">角色和RBAC</h2><p id="eac9" class="pw-post-body-paragraph jy jz iq ka b kb mz kd ke kf na kh ki kj nb kl km kn nc kp kq kr nd kt ku kv ij bi translated">默认情况下，所有新用户都使用来自<code class="fe kx ky kz la b">argocd-rbac-cm</code>配置图的<code class="fe kx ky kz la b">policy.default</code>:</p><pre class="ne nf ng nh gt ni la nj nk aw nl bi"><span id="b22c" class="mn lq iq la b gy nm nn l no np">$ kubectl -n dev-1–18-devops-argocd-ns get configmap argocd-rbac-cm -o yaml<br/>apiVersion: v1<br/>data:<br/>policy.default: role:readonly<br/>…</span></pre><p id="9444" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">ArgoCD有两个默认角色— <code class="fe kx ky kz la b">role:readonly</code>和<code class="fe kx ky kz la b">role:admin</code>。此外，您可以用<code class="fe kx ky kz la b">role: ''</code>设置<code class="fe kx ky kz la b">policy.default</code>来完全禁用访问。</p><p id="3b70" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">此时，我们的用户可以查看任何资源:</p><pre class="ne nf ng nh gt ni la nj nk aw nl bi"><span id="a950" class="mn lq iq la b gy nm nn l no np">$ argocd cluster list<br/>SERVER NAME VERSION STATUS MESSAGE<br/><a class="ae kw" href="https://kubernetes.default.svc" rel="noopener ugc nofollow" target="_blank">https://kubernetes.default.svc</a> in-cluster 1.18+ Successful</span></pre><p id="2c9d" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">但是不能创建任何新的，例如，尝试添加一个新的集群:</p><pre class="ne nf ng nh gt ni la nj nk aw nl bi"><span id="1a3d" class="mn lq iq la b gy nm nn l no np">$ argocd cluster add config-aws-china-eks-account@aws-china-eks-account --kubeconfig ~/.kube/config-aws-china-eks-account@aws-china-eks-account<br/>INFO[0002] ServiceAccount “argocd-manager” already exists in namespace “kube-system”<br/>INFO[0003] ClusterRole “argocd-manager-role” updated<br/>INFO[0004] ClusterRoleBinding “argocd-manager-role-binding” updated<br/>FATA[0006] rpc error: code = PermissionDenied desc = permission denied: clusters, create, <a class="ae kw" href="https://21D***ECD.gr7.cn-northwest-1.eks.amazonaws.com.cn," rel="noopener ugc nofollow" target="_blank">https://21D***ECD.gr7.cn-northwest-1.eks.amazonaws.com.cn,</a> sub: testuser, iat: 2021–05–12T14:03:12Z</span></pre><p id="1fbd" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><strong class="ka ir"> <em class="nq">“权限被拒绝:集群，创建</em></strong>”—啊哈，不能。</p><p id="fc30" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">要允许用户添加集群，编辑<code class="fe kx ky kz la b">argocd-rbac-cm</code> CondfigMap，添加一个具有<code class="fe kx ky kz la b">clusters, create</code>权限的新<code class="fe kx ky kz la b">role:test-role</code>:</p><pre class="ne nf ng nh gt ni la nj nk aw nl bi"><span id="6e08" class="mn lq iq la b gy nm nn l no np">...<br/>data:<br/>  policy.default: role:readonly<br/>  policy.csv: |<br/>    p, role:test-role, clusters, create, *, allow<br/>    g, testuser, role:test-role<br/>...</span></pre><p id="c0ce" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">检查一下:</p><pre class="ne nf ng nh gt ni la nj nk aw nl bi"><span id="9d19" class="mn lq iq la b gy nm nn l no np">$ argocd account can-i create clusters ‘*’<br/>yes</span></pre><p id="45fb" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">并添加一个集群:</p><pre class="ne nf ng nh gt ni la nj nk aw nl bi"><span id="423e" class="mn lq iq la b gy nm nn l no np">$ argocd cluster add config-aws-china-eks-account@aws-china-eks-account --kubeconfig ~/.kube/config-aws-china-eks-account@aws-china-eks-account<br/>INFO[0001] ServiceAccount “argocd-manager” already exists in namespace “kube-system”<br/>INFO[0002] ClusterRole “argocd-manager-role” updated<br/>INFO[0003] ClusterRoleBinding “argocd-manager-role-binding” updated<br/>Cluster ‘https://21D***ECD.gr7.cn-northwest-1.eks.amazonaws.com.cn' added</span></pre><p id="66bd" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">但是，如果您希望允许名称空间操作，该怎么做呢？配置图中的RBAC不允许这样做。</p><p id="3d64" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">例如，在我目前的项目中，我们有Web开发人员、后端开发人员，他们都有部署在不同名称空间中的不同应用程序，分离他们的访问是一个好主意，因此Web团队不会影响后端的团队资源。</p><h1 id="e845" class="lp lq iq bd lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm bi translated">ArgoCD项目</h1><p id="9bf4" class="pw-post-body-paragraph jy jz iq ka b kb mz kd ke kf na kh ki kj nb kl km kn nc kp kq kr nd kt ku kv ij bi translated">而在这里"<em class="nq">项目来拯救</em>"！</p><p id="a5cf" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><a class="ae kw" href="https://argoproj.github.io/argo-cd/user-guide/projects/" rel="noopener ugc nofollow" target="_blank">项目</a>允许指定对名称空间、存储库、集群等的访问。然后，我们将能够只通过他们自己的名称空间来限制每个开发团队<em class="nq">。</em></p><p id="24c4" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">让我们看看这是如何工作的。</p><p id="6e32" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">因此，在安装过程中，ArgoCD创建了默认的<em class="nq">项目:</em></p><pre class="ne nf ng nh gt ni la nj nk aw nl bi"><span id="9b8b" class="mn lq iq la b gy nm nn l no np">$ argocd proj list<br/>NAME DESCRIPTION DESTINATIONS SOURCES CLUSTER-RESOURCE-WHITELIST NAMESPACE-RESOURCE-BLACKLIST SIGNATURE-KEYS ORPHANED-RESOURCES<br/>default *,* * */* &lt;none&gt; &lt;none&gt; disabled</span></pre><p id="f107" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">项目是Kubernetes定制的资源对象，类型为:</p><pre class="ne nf ng nh gt ni la nj nk aw nl bi"><span id="059a" class="mn lq iq la b gy nm nn l no np">$ kubectl -n dev-1–18-devops-argocd-ns get appproject<br/>NAME AGE<br/>default 166d</span></pre><p id="f12f" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">可以用一个普通的Kubernetes清单创建，如下所示:</p><pre class="ne nf ng nh gt ni la nj nk aw nl bi"><span id="c3d6" class="mn lq iq la b gy nm nn l no np">kind: AppProject<br/>metadata:<br/>  name: example-project<br/>  namespace: dev-1-18-devops-argocd-ns<br/>spec:<br/>  clusterResourceWhitelist:<br/>  - group: '*'<br/>    kind: '*'<br/>  destinations:<br/>  - namespace: argo-test-ns<br/>    server: <a class="ae kw" href="https://kubernetes.default.svc" rel="noopener ugc nofollow" target="_blank">https://kubernetes.default.svc</a><br/>  orphanedResources:<br/>    warn: false<br/>  sourceRepos:<br/>  - '*'</span></pre><p id="4529" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">或使用ArgoCD CLI:</p><pre class="ne nf ng nh gt ni la nj nk aw nl bi"><span id="b78f" class="mn lq iq la b gy nm nn l no np">$ argocd proj create test-project -d <a class="ae kw" href="https://kubernetes.default.svc,argo-test-ns" rel="noopener ugc nofollow" target="_blank">https://kubernetes.default.svc,argo-test-ns</a> -s <a class="ae kw" href="https://github.com/argoproj/argocd-example-apps.git" rel="noopener ugc nofollow" target="_blank">https://github.com/argoproj/argocd-example-apps.git</a></span></pre><p id="f5bb" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">检查一下:</p><pre class="ne nf ng nh gt ni la nj nk aw nl bi"><span id="ee57" class="mn lq iq la b gy nm nn l no np">$ argocd proj list<br/>NAME DESCRIPTION DESTINATIONS SOURCES CLUSTER-RESOURCE-WHITELIST NAMESPACE-RESOURCE-BLACKLIST SIGNATURE-KEYS ORPHANED-RESOURCES<br/>default *,* * */* &lt;none&gt; &lt;none&gt; disabled<br/>test-project <a class="ae kw" href="https://kubernetes.default.svc,argo-test-ns" rel="noopener ugc nofollow" target="_blank">https://kubernetes.default.svc,argo-test-ns</a> <a class="ae kw" href="https://github.com/argoproj/argocd-example-apps.git" rel="noopener ugc nofollow" target="_blank">https://github.com/argoproj/argocd-example-apps.git</a> &lt;none&gt; &lt;none&gt; &lt;none&gt; disabled</span></pre><p id="32c2" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">现在，让我们将现有的应用程序<em class="nq">留言簿</em>从<code class="fe kx ky kz la b">argo-test-ns</code>移动到新项目:</p><pre class="ne nf ng nh gt ni la nj nk aw nl bi"><span id="63b8" class="mn lq iq la b gy nm nn l no np">$ argocd app set guestbook --project test-project</span></pre><p id="c2fa" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">检查一下:</p><pre class="ne nf ng nh gt ni la nj nk aw nl bi"><span id="a41e" class="mn lq iq la b gy nm nn l no np">$ argocd app get guestbook<br/>Name: guestbook<br/>Project: test-project<br/>Server: <a class="ae kw" href="https://kubernetes.default.svc" rel="noopener ugc nofollow" target="_blank">https://kubernetes.default.svc</a><br/>Namespace: argo-test-ns<br/>URL: https://dev-1–18.argocd.example.com/applications/guestbook<br/>Repo: <a class="ae kw" href="https://github.com/argoproj/argocd-example-apps.git" rel="noopener ugc nofollow" target="_blank">https://github.com/argoproj/argocd-example-apps.git</a><br/>…</span></pre><p id="4ece" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">现在，让我们检查一下名称空间限制是如何工作的。</p><p id="7519" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">当我们创建了上面的项目，我们已经设置了<em class="nq">目的地</em> — <code class="fe kx ky kz la b"><a class="ae kw" href="https://kubernetes.default.svc,argo-test-ns." rel="noopener ugc nofollow" target="_blank">https://kubernetes.default.svc,argo-test-ns</a></code> <a class="ae kw" href="https://kubernetes.default.svc,argo-test-ns." rel="noopener ugc nofollow" target="_blank">。</a></p><p id="64d4" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">尝试在该项目中创建一个新的应用程序，但将其名称空间设置为<em class="nq"> argo-test-2-ns </em>:</p><pre class="ne nf ng nh gt ni la nj nk aw nl bi"><span id="0ac5" class="mn lq iq la b gy nm nn l no np">$ argocd app create guestbook-2 — repo <a class="ae kw" href="https://github.com/argoproj/argocd-example-apps.git" rel="noopener ugc nofollow" target="_blank">https://github.com/argoproj/argocd-example-apps.git</a> — path guestbook — dest-server <a class="ae kw" href="https://kubernetes.default.svc" rel="noopener ugc nofollow" target="_blank">https://kubernetes.default.svc</a> — dest-namespace argo-test-2-ns — project test-project<br/>FATA[0001] rpc error: code = InvalidArgument desc = application spec is invalid: InvalidSpecError: application destination {https://kubernetes.default.svc argo-test-2-ns} is not permitted in project ‘test-project’</span></pre><p id="914a" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><strong class="ka ir"> <em class="nq">“项目' test-project </em> ' </strong>'中不允许应用目的地{ https://kubernetes . default . SVC Argo-test-2-ns }”—酷！对于<em class="nq">测试项目</em>项目中的<em class="nq"> testuser </em>权限，我们目前不能将应用程序添加到新的名称空间，因为项目对目的地有限制。</p><p id="c908" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">更新项目并添加一个新的目的地—同一个集群，但是另一个名称空间<em class="nq"> argo-test-2-ns </em>:</p><pre class="ne nf ng nh gt ni la nj nk aw nl bi"><span id="a9f2" class="mn lq iq la b gy nm nn l no np">$ argocd proj add-destination test-project <a class="ae kw" href="https://kubernetes.default.svc" rel="noopener ugc nofollow" target="_blank">https://kubernetes.default.svc</a> argo-test-2-ns</span></pre><p id="f908" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">立即检查项目:</p><pre class="ne nf ng nh gt ni la nj nk aw nl bi"><span id="ab23" class="mn lq iq la b gy nm nn l no np">$ argocd proj get test-project<br/>Name: test-project<br/>Description:<br/>Destinations: <a class="ae kw" href="https://kubernetes.default.svc,argo-test-ns" rel="noopener ugc nofollow" target="_blank">https://kubernetes.default.svc,argo-test-ns</a><br/><a class="ae kw" href="https://kubernetes.default.svc,argo-test-2-ns" rel="noopener ugc nofollow" target="_blank">https://kubernetes.default.svc,argo-test-2-ns</a><br/>…</span></pre><p id="283d" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">尝试再次创建应用程序:</p><pre class="ne nf ng nh gt ni la nj nk aw nl bi"><span id="165e" class="mn lq iq la b gy nm nn l no np">$ argocd app create guestbook-2 — repo <a class="ae kw" href="https://github.com/argoproj/argocd-example-apps.git" rel="noopener ugc nofollow" target="_blank">https://github.com/argoproj/argocd-example-apps.git</a> — path guestbook — dest-server <a class="ae kw" href="https://kubernetes.default.svc" rel="noopener ugc nofollow" target="_blank">https://kubernetes.default.svc</a> — dest-namespace argo-test-2-ns — project test-project<br/>application ‘guestbook-2’ created</span></pre><p id="23a7" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">现在成功了。</p><p id="8424" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">因此，在我们的Dev Kubernetes集群上，我们可以将目的地设置为<code class="fe kx ky kz la b">'*'</code>，因为这里的名称空间是动态创建的——开发人员正在将他们的分支部署到专用的名称空间，以便为测试设置一个多环境，但是在我们的生产集群上，我们可以对允许的名称空间设置一个硬限制。</p><h2 id="4d90" class="mn lq iq bd lr mo mp dn lv mq mr dp lz kj ms mt md kn mu mv mh kr mw mx ml my bi translated">项目和角色</h2><h2 id="4a7f" class="mn lq iq bd lr mo mp dn lv mq mr dp lz kj ms mt md kn mu mv mh kr mw mx ml my bi translated">全球角色</h2><p id="b467" class="pw-post-body-paragraph jy jz iq ka b kb mz kd ke kf na kh ki kj nb kl km kn nc kp kq kr nd kt ku kv ij bi translated">对项目的访问可以通过te <code class="fe kx ky kz la b">argocd-rbac-cm</code> ConfigMap进行全局设置，也可以根据项目进行本地设置。</p><p id="c872" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">让我们回到我们的全局<code class="fe kx ky kz la b">role:test-role</code>，添加一个只允许从<code class="fe kx ky kz la b">test-project</code>访问应用程序的策略，并在<code class="fe kx ky kz la b">policy.default</code>中通过设置<code class="fe kx ky kz la b">role: ''</code>禁用只读访问:</p><pre class="ne nf ng nh gt ni la nj nk aw nl bi"><span id="3f64" class="mn lq iq la b gy nm nn l no np">...<br/>  policy.csv: |<br/>    p, role:test-role, clusters, create, *, allow<br/>    p, role:test-role, applications, *, test-project/*, allow<br/>    g, testuser, role:test-role<br/>  policy.default: role:''<br/>...</span></pre><p id="f601" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">切换到<em class="nq">测试用户</em>:</p><pre class="ne nf ng nh gt ni la nj nk aw nl bi"><span id="ecea" class="mn lq iq la b gy nm nn l no np">$ argocd context testuser@dev-1–18.argocd.example.com<br/>Switched to context ‘testuser@dev-1–18.argocd.example.comd’</span></pre><p id="9dfa" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">检查可用的应用程序:</p><pre class="ne nf ng nh gt ni la nj nk aw nl bi"><span id="6a94" class="mn lq iq la b gy nm nn l no np">$ argocd app list<br/>NAME CLUSTER NAMESPACE PROJECT STATUS HEALTH SYNCPOLICY CONDITIONS REPO PATH TARGET<br/>guestbook <a class="ae kw" href="https://kubernetes.default.svc" rel="noopener ugc nofollow" target="_blank">https://kubernetes.default.svc</a> argo-test-ns test-project OutOfSync Missing &lt;none&gt; &lt;none&gt; <a class="ae kw" href="https://github.com/argoproj/argocd-example-apps.git" rel="noopener ugc nofollow" target="_blank">https://github.com/argoproj/argocd-example-apps.git</a> helm-guestbook HEAD</span></pre><p id="effc" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">这里唯一的一个，正如我们在政策中规定的。</p><h2 id="bd96" class="mn lq iq bd lr mo mp dn lv mq mr dp lz kj ms mt md kn mu mv mh kr mw mx ml my bi translated">项目角色和身份验证令牌</h2><p id="247f" class="pw-post-body-paragraph jy jz iq ka b kb mz kd ke kf na kh ki kj nb kl km kn nc kp kq kr nd kt ku kv ij bi translated">另一种方法是为项目创建一个专门的角色。然后，您将能够像为普通用户一样为这个角色创建一个令牌。</p><p id="0696" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在<em class="nq">测试项目</em>项目中创建<em class="nq">测试角色</em>:</p><pre class="ne nf ng nh gt ni la nj nk aw nl bi"><span id="a4a2" class="mn lq iq la b gy nm nn l no np">$ argocd proj role create test-project test-role</span></pre><p id="7dce" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">添加策略—对<em class="nq"> guestbo </em> ok应用程序的任何操作:</p><pre class="ne nf ng nh gt ni la nj nk aw nl bi"><span id="1bbd" class="mn lq iq la b gy nm nn l no np">$ argocd proj role add-policy test-project test-role — action '*' --permission allow --object guestbook</span></pre><p id="46a1" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">该政策将被添加到关于该项目的RBAC规则中:</p><pre class="ne nf ng nh gt ni la nj nk aw nl bi"><span id="2a30" class="mn lq iq la b gy nm nn l no np">$ kubectl -n dev-1–18-devops-argocd-ns get appproject test-project -o jsonpath=’{.spec.roles[].policies}’<br/>[p, proj:test-project:test-role, applications, *, test-project/guestbook, allow]</span></pre><p id="7ff3" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">获取令牌:</p><pre class="ne nf ng nh gt ni la nj nk aw nl bi"><span id="c417" class="mn lq iq la b gy nm nn l no np">$ argocd proj role create-token test-project test-role<br/>eyJ***sCA</span></pre><p id="acab" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">或者将其设置为一个变量:</p><pre class="ne nf ng nh gt ni la nj nk aw nl bi"><span id="0d53" class="mn lq iq la b gy nm nn l no np">$ token=$(argocd proj role create-token test-project test-role)</span></pre><p id="8939" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">Ans使用令牌检查权限，例如，同步应用程序:</p><pre class="ne nf ng nh gt ni la nj nk aw nl bi"><span id="d3c2" class="mn lq iq la b gy nm nn l no np">$ argocd account can-i sync applications test-project/guestbook --auth-token $token<br/>yes</span></pre><p id="d4a9" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">好吧，这个有用，</p><p id="dcd0" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">但是您不能使用此角色的令牌添加群集，因为我们没有在其策略中设置它:</p><pre class="ne nf ng nh gt ni la nj nk aw nl bi"><span id="43ac" class="mn lq iq la b gy nm nn l no np">$ argocd account can-i create clusters '*' --auth-token $token<br/>no</span></pre><p id="02e5" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">尽管如此，您的testuser仍然能够做到这一点，因为它在<code class="fe kx ky kz la b">argocd-rbac-cm</code>中拥有权限et，其策略为<em class="nq">测试角色</em> - <code class="fe kx ky kz la b">p, role:test-role, clusters, create, *, allow</code>:</p><pre class="ne nf ng nh gt ni la nj nk aw nl bi"><span id="03aa" class="mn lq iq la b gy nm nn l no np">$ argocd account can-i create projects '*'<br/>yes</span></pre><h1 id="3218" class="lp lq iq bd lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm bi translated">ArgoCD组</h1><p id="e500" class="pw-post-body-paragraph jy jz iq ka b kb mz kd ke kf na kh ki kj nb kl km kn nc kp kq kr nd kt ku kv ij bi translated">使用RBAC规则，您可以将角色分组到组中，但现在用户可以分组，例如:</p><pre class="ne nf ng nh gt ni la nj nk aw nl bi"><span id="05a0" class="mn lq iq la b gy nm nn l no np">...<br/>  policy.csv: |<br/>    g, argocd-admins, role:admin<br/>...</span></pre><p id="ee70" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">稍后，使用SSO，我们将把用户组映射到ArgoCD角色。</p><h1 id="722d" class="lp lq iq bd lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm bi translated">把所有的放在一起</h1><p id="70e9" class="pw-post-body-paragraph jy jz iq ka b kb mz kd ke kf na kh ki kj nb kl km kn nc kp kq kr nd kt ku kv ij bi translated">好了，现在我们已经熟悉了ArgoCD中的用户管理，让我们来计划一下如何使用它。</p><p id="68dd" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我们有什么？</p><p id="3b74" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">两个团队Web和后端。</p><p id="492d" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">每个团队都有自己的一套应用程序。</p><p id="0c9b" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">从全局用户中，我们可以为DevOps团队创建一个具有完全访问权限的根用户，以及一个绑定到项目的管理员和只读用户。</p><p id="d95a" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在一个项目中，我们可以通过使用它的令牌来指定一个将在Github Actions/Jenkins管道中使用的角色。</p><p id="9e1d" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">稍后，我们将配置Oktaa和SSO，这样用户将使用他们的Okta凭据和Okta组登录ArgoCD WebUI，Okta中的后端团队将访问ArgoCD中的后端项目，Okta中的Web团队将访问ArgoCD中的Web项目。</p><p id="066a" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">就目前而言，仅此而已。</p><p id="a4e8" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在下面的帖子中，我们将配置Okta和ArgoCD，参见<a class="ae kw" href="https://rtfm.co.ua/en/?p=26037" rel="noopener ugc nofollow" target="_blank"> ArgoCD: Okta集成和用户组</a>帖子。</p></div><div class="ab cl nr ns hu nt" role="separator"><span class="nu bw bk nv nw nx"/><span class="nu bw bk nv nw nx"/><span class="nu bw bk nv nw"/></div><div class="ij ik il im in"><p id="1b2e" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><em class="nq">最初发表于</em> <a class="ae kw" href="https://rtfm.co.ua/en/argocd-users-access-and-rbac/" rel="noopener ugc nofollow" target="_blank"> <em class="nq"> RTFM: Linux、DevOps和系统管理</em> </a> <em class="nq">。</em></p></div></div>    
</body>
</html>