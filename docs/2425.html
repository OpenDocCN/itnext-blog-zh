<html>
<head>
<title>Kubernetes + MetalLB + vlan</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Kubernetes + MetalLB + vlan</h1>
<blockquote>原文：<a href="https://itnext.io/kubernetes-metallb-vlan-3e5f310a4510?source=collection_archive---------0-----------------------#2019-05-22">https://itnext.io/kubernetes-metallb-vlan-3e5f310a4510?source=collection_archive---------0-----------------------#2019-05-22</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><figure class="ip iq gp gr ir is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi io"><img src="../Images/4fc48fa8e586d1d94215257176348b87.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*n6OG04exogb_aC2Lf41cCQ.png"/></div></div></figure><div class=""/><p id="d2ad" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">使用您自己网络范围内的外部IP创建负载平衡器服务的简短手册。</p><figure class="kx ky kz la gt is gh gi paragraph-image"><div class="gh gi kw"><img src="../Images/ac05945cf4d787bbb4a3d5fd92776d6b.png" data-original-src="https://miro.medium.com/v2/resize:fit:760/format:webp/1*do-RzulMynfAD-shoY28-g.png"/></div></figure><h2 id="eb94" class="lb lc jb bd ld le lf dn lg lh li dp lj kj lk ll lm kn ln lo lp kr lq lr ls lt bi translated">要求</h2><ul class=""><li id="dd7b" class="lu lv jb ka b kb lw kf lx kj ly kn lz kr ma kv mb mc md me bi translated">安装了Ubuntu 18.04 LTS(我用的是<a class="ae mf" href="http://hetzner.de" rel="noopener ugc nofollow" target="_blank"> hetzner.de </a>云解决方案)</li><li id="83f6" class="lu lv jb ka b kb mg kf mh kj mi kn mj kr mk kv mb mc md me bi translated">已安装的Kubernetes集群</li><li id="c1bf" class="lu lv jb ka b kb mg kf mh kj mi kn mj kr mk kv mb mc md me bi translated">Kubernetes pod网络应该与MetalLB 兼容<a class="ae mf" href="https://metallb.universe.tf/installation/network-addons/" rel="noopener ugc nofollow" target="_blank"/></li><li id="99e5" class="lu lv jb ka b kb mg kf mh kj mi kn mj kr mk kv mb mc md me bi translated">金属LB <a class="ae mf" href="https://metallb.universe.tf/#requirements" rel="noopener ugc nofollow" target="_blank">要求</a></li></ul><blockquote class="ml mm mn"><p id="f15d" class="jy jz mo ka b kb kc kd ke kf kg kh ki mp kk kl km mq ko kp kq mr ks kt ku kv ij bi translated">MetalLB是一个<strong class="ka jc"> beta </strong>系统。你可以用它自担风险。</p></blockquote></div><div class="ab cl ms mt hu mu" role="separator"><span class="mv bw bk mw mx my"/><span class="mv bw bk mw mx my"/><span class="mv bw bk mw mx"/></div><div class="ij ik il im in"><p id="4793" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">首先<strong class="ka jc"> vlan </strong>工具应该安装在Ubuntu上:</p><pre class="kx ky kz la gt mz na nb nc aw nd bi"><span id="6c2f" class="lb lc jb na b gy ne nf l ng nh"><strong class="na jc">apt-get install vlan</strong></span></pre><h2 id="3b3d" class="lb lc jb bd ld le lf dn lg lh li dp lj kj lk ll lm kn ln lo lp kr lq lr ls lt bi translated">Vlan配置</h2><ul class=""><li id="d54f" class="lu lv jb ka b kb lw kf lx kj ly kn lz kr ma kv mb mc md me bi translated">将部分添加到<strong class="ka jc">/etc/network/interfaces . d/50-cloud-init . CFG</strong></li></ul><pre class="kx ky kz la gt mz na nb nc aw nd bi"><span id="5166" class="lb lc jb na b gy ne nf l ng nh">auto vlan10<br/>iface vlan10 inet static<br/>    address 192.168.10.1<br/>    netmask 255.255.255.0<br/>    vlan_raw_device eth0</span></pre><ul class=""><li id="1d17" class="lu lv jb ka b kb kc kf kg kj ni kn nj kr nk kv mb mc md me bi translated">在<strong class="ka jc">/etc/net plan/01-net CFG . YAML</strong>中添加一节(针对使用netplan 的人的<em class="mo"/></li></ul><pre class="kx ky kz la gt mz na nb nc aw nd bi"><span id="f548" class="lb lc jb na b gy ne nf l ng nh">vlans:<br/>    vlan10:<br/>      id: 0<br/>      link: ens4<br/>      addresses: [192.168.10.0/24]</span></pre><blockquote class="ml mm mn"><p id="9ca5" class="jy jz mo ka b kb kc kd ke kf kg kh ki mp kk kl km mq ko kp kq mr ks kt ku kv ij bi translated">更改后不要忘记重启网络子系统。</p></blockquote><h2 id="9c30" class="lb lc jb bd ld le lf dn lg lh li dp lj kj lk ll lm kn ln lo lp kr lq lr ls lt bi translated">安装金属1b</h2><p id="88c2" class="pw-post-body-paragraph jy jz jb ka b kb lw kd ke kf lx kh ki kj nl kl km kn nm kp kq kr nn kt ku kv ij bi translated">安装非常简单:</p><pre class="kx ky kz la gt mz na nb nc aw nd bi"><span id="c54b" class="lb lc jb na b gy ne nf l ng nh"># <strong class="na jc">kubectl apply -f</strong> https://raw.githubusercontent.com/google/metallb/v0.7.3/manifests/metallb.yaml</span></pre><p id="0fbb" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">检查扬声器和控制器是否正常工作</p><pre class="kx ky kz la gt mz na nb nc aw nd bi"><span id="525c" class="lb lc jb na b gy ne nf l ng nh"># <strong class="na jc">kubectl get pods</strong> -n metallb-system</span></pre><h2 id="f41e" class="lb lc jb bd ld le lf dn lg lh li dp lj kj lk ll lm kn ln lo lp kr lq lr ls lt bi translated">定义LB的IP范围</h2><p id="492a" class="pw-post-body-paragraph jy jz jb ka b kb lw kd ke kf lx kh ki kj nl kl km kn nm kp kq kr nn kt ku kv ij bi translated">为MetalLB服务分配IP空间区块。为此，我们将使用<strong class="ka jc">192 . 168 . 10 . 240–192 . 168 . 10 . 250</strong>。</p><p id="5970" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">准备<strong class="ka jc"> ConfigMap </strong> yaml文件并部署到kubermetes集群。位于<a class="ae mf" href="https://raw.githubusercontent.com/google/metallb/v0.7.3/manifests/example-layer2-config.yaml" rel="noopener ugc nofollow" target="_blank"> MetalLB GitHub </a>存储库中的配置图示例。</p><p id="14b9" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">配置映射yaml文件的示例:</p><pre class="kx ky kz la gt mz na nb nc aw nd bi"><span id="1580" class="lb lc jb na b gy ne nf l ng nh">apiVersion: v1<br/>kind: ConfigMap<br/>metadata:<br/>  namespace: metallb-system<br/>  name: config<br/>data:<br/>  config: |<br/>    address-pools:<br/>    - name: default<br/>      protocol: <strong class="na jc">layer2</strong><br/>      addresses:<br/>      - 192.168.10.240-192.168.10.250</span></pre><p id="f4b1" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><strong class="ka jc">这里使用的是Layer2 </strong>模式，但是MetalLB也可以配置<strong class="ka jc"> BGP </strong>模式。参见<a class="ae mf" href="https://metallb.universe.tf/tutorial/minikube/" rel="noopener ugc nofollow" target="_blank"> BGP MetalLB教程</a>。</p><h2 id="8dc4" class="lb lc jb bd ld le lf dn lg lh li dp lj kj lk ll lm kn ln lo lp kr lq lr ls lt bi translated">为测试配置pod和LB服务</h2><p id="7374" class="pw-post-body-paragraph jy jz jb ka b kb lw kd ke kf lx kh ki kj nl kl km kn nm kp kq kr nn kt ku kv ij bi translated">现在，我们可以为nginx pod配置MetalLB服务(仅用于测试)</p><pre class="kx ky kz la gt mz na nb nc aw nd bi"><span id="a6d1" class="lb lc jb na b gy ne nf l ng nh">apiVersion: v1<br/>kind: Service<br/>metadata:<br/>  name: nginx<br/>spec:<br/>  ports:<br/>  - name: http<br/>    port: 80<br/>    protocol: TCP<br/>    targetPort: 80<br/>  selector:<br/>    app: nginx<br/>  type: LoadBalancer</span></pre><p id="9dc1" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">并安装nginx pod</p><pre class="kx ky kz la gt mz na nb nc aw nd bi"><span id="daf9" class="lb lc jb na b gy ne nf l ng nh">apiVersion: apps/v1beta2<br/>kind: Deployment<br/>metadata:<br/>  name: nginx<br/>spec:<br/>  selector:<br/>    matchLabels:<br/>      app: nginx<br/>  template:<br/>    metadata:<br/>      labels:<br/>        app: nginx<br/>    spec:<br/>      containers:<br/>      - name: nginx<br/>        image: nginx:1<br/>        ports:<br/>        - name: http<br/>          containerPort: 80</span></pre><blockquote class="ml mm mn"><p id="df40" class="jy jz mo ka b kb kc kd ke kf kg kh ki mp kk kl km mq ko kp kq mr ks kt ku kv ij bi translated">或者只执行教程yaml文件:</p><p id="d911" class="jy jz mo ka b kb kc kd ke kf kg kh ki mp kk kl km mq ko kp kq mr ks kt ku kv ij bi translated"><code class="fe no np nq na b"><em class="jb"># </em><strong class="ka jc"><em class="jb">kubectl apply -f</em></strong><em class="jb"> </em><a class="ae mf" href="https://raw.githubusercontent.com/google/metallb/v0.7.3/manifests/tutorial-2.yaml" rel="noopener ugc nofollow" target="_blank"><em class="jb">https://raw.githubusercontent.com/google/metallb/v0.7.3/manifests/tutorial-2.yaml</em></a></code></p></blockquote><h2 id="983c" class="lb lc jb bd ld le lf dn lg lh li dp lj kj lk ll lm kn ln lo lp kr lq lr ls lt bi translated">结果</h2><p id="6b25" class="pw-post-body-paragraph jy jz jb ka b kb lw kd ke kf lx kh ki kj nl kl km kn nm kp kq kr nn kt ku kv ij bi translated">在结果中，我们可以看到分配给我们的负载平衡器的外部IP</p><pre class="kx ky kz la gt mz na nb nc aw nd bi"><span id="49f2" class="lb lc jb na b gy ne nf l ng nh"># <strong class="na jc">kubectl get services</strong><br/>NAME         TYPE           CLUSTER-IP      EXTERNAL-IP      PORT(S)        AGE<br/>kubernetes   ClusterIP      10.96.0.1       &lt;none&gt;           443/TCP        23h<br/>nginx        LoadBalancer   10.107.44.239   <strong class="na jc">192.168.10.240</strong>   80:32025/TCP   22h</span></pre><p id="ba31" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">让我们ping我们的pod</p><pre class="kx ky kz la gt mz na nb nc aw nd bi"><span id="fbee" class="lb lc jb na b gy ne nf l ng nh"># <strong class="na jc">ping 192.168.10.240</strong><br/>PING 192.168.10.240 (192.168.10.240) 56(84) bytes of data.<br/>From 192.168.10.1 icmp_seq=1 Destination Host Unreachable<br/>From 192.168.10.1 icmp_seq=2 Destination Host Unreachable<br/>From 192.168.10.1 icmp_seq=3 Destination Host Unreachable</span></pre><p id="10ee" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">哎呀…无法访问主机…是的，因为我们打开<strong class="ka jc">端口80 </strong>与nginx pod通信。但是，如果我们执行curl:</p><pre class="kx ky kz la gt mz na nb nc aw nd bi"><span id="4495" class="lb lc jb na b gy ne nf l ng nh"># <strong class="na jc">curl </strong><a class="ae mf" href="http://192.168.10.240" rel="noopener ugc nofollow" target="_blank"><strong class="na jc">http://192.168.10.240</strong></a><br/>&lt;!DOCTYPE html&gt;<br/>&lt;html&gt;<br/>&lt;head&gt;<br/>&lt;title&gt;Welcome to nginx!&lt;/title&gt;<br/>&lt;style&gt;<br/>    body {<br/>        width: 35em;<br/>        margin: 0 auto;<br/>        font-family: Tahoma, Verdana, Arial, sans-serif;<br/>    }<br/>&lt;/style&gt;<br/>&lt;/head&gt;<br/>&lt;body&gt;<br/>&lt;h1&gt;Welcome to nginx!&lt;/h1&gt;<br/>&lt;p&gt;If you see this page, the nginx web server is successfully installed and<br/>working. Further configuration is required.&lt;/p&gt;</span><span id="4afe" class="lb lc jb na b gy nr nf l ng nh">&lt;p&gt;For online documentation and support please refer to<br/>&lt;a href="<a class="ae mf" href="http://nginx.org/" rel="noopener ugc nofollow" target="_blank">http://nginx.org/</a>"&gt;nginx.org&lt;/a&gt;.&lt;br/&gt;<br/>Commercial support is available at<br/>&lt;a href="<a class="ae mf" href="http://nginx.com/" rel="noopener ugc nofollow" target="_blank">http://nginx.com/</a>"&gt;nginx.com&lt;/a&gt;.&lt;/p&gt;</span><span id="e176" class="lb lc jb na b gy nr nf l ng nh">&lt;p&gt;&lt;em&gt;Thank you for using nginx.&lt;/em&gt;&lt;/p&gt;<br/>&lt;/body&gt;<br/>&lt;/html&gt;</span></pre><p id="8ba7" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我们会看到nginx的输出:)，这是<em class="mo">牛逼的</em>。</p><p id="7783" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><strong class="ka jc">有用的链接</strong></p><ul class=""><li id="665e" class="lu lv jb ka b kb kc kf kg kj ni kn nj kr nk kv mb mc md me bi translated"><a class="ae mf" href="https://metallb.universe.tf/" rel="noopener ugc nofollow" target="_blank">金属银行</a>网站</li><li id="a6c5" class="lu lv jb ka b kb mg kf mh kj mi kn mj kr mk kv mb mc md me bi translated"><a class="ae mf" rel="noopener ugc nofollow" target="_blank" href="/kubernetes-on-ubuntu-on-virtualbox-60e8ce7c85ed">如何在Ubuntu上安装kubernetes</a>(文章版本较旧，但仍然可用)</li></ul></div><div class="ab cl ms mt hu mu" role="separator"><span class="mv bw bk mw mx my"/><span class="mv bw bk mw mx my"/><span class="mv bw bk mw mx"/></div><div class="ij ik il im in"><p id="928a" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">附:我的<a class="ae mf" href="https://www.linkedin.com/in/mikegavrilov/" rel="noopener ugc nofollow" target="_blank"> Linkedin </a>，如果你有什么有趣的事…..</p></div></div>    
</body>
</html>