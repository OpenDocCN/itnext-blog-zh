<html>
<head>
<title>DC/OS Agent Node Maintenance</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">DC/操作系统代理节点维护</h1>
<blockquote>原文：<a href="https://itnext.io/dc-os-agent-node-maintenance-e95355e6ef51?source=collection_archive---------5-----------------------#2018-06-21">https://itnext.io/dc-os-agent-node-maintenance-e95355e6ef51?source=collection_archive---------5-----------------------#2018-06-21</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div class="gh gi jn"><img src="../Images/3df6544201eb686002620eca9f74212a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1344/1*UW6MiVlxqvNvJAPdwvNwkw.gif"/></div><figcaption class="ju jv gj gh gi jw jx bd b be z dk translated">资料来源:toothpastefordinner.com</figcaption></figure><p id="6125" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">提供基础设施的高可用性(HA)是我工作的一个主要方面，我对此非常自豪。我关心基础设施的可用性，因为这反映了我的架构设计和我作为工程师的知识，这是我努力获得的。如果我希望开发人员使用我的平台来运行他们的服务，他们需要知道底层基础设施将始终可用，并且不会成为他们正常运行时间SLA的瓶颈。当然，这也要求用户将他们的服务设计成HA，但是如果底层架构不是HA，他们的服务怎么可能是HA呢？</p><p id="2390" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在这篇文章中，我想讨论一下我们目前处理DC/操作系统代理节点维护的方式。我将解释我们在维护期间为确保用户的高可用性而采取的步骤，解释我们用来处理维护的步骤和工具，并讨论我们在过去几年中在我们的环境中学到的一些东西。</p></div><div class="ab cl kw kx hu ky" role="separator"><span class="kz bw bk la lb lc"/><span class="kz bw bk la lb lc"/><span class="kz bw bk la lb"/></div><div class="ij ik il im in"><p id="d286" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">电脑很烂，而且很笨。为了保持基础设施平稳安全地运行，我们必须预计到在某个时间点至少会出现计算机故障和/或维护。这个已知的事实并没有改变能够为服务提供HA和高SLA的需求。在当今的计算和软件世界中，我们比以往任何时候都有更多的控制和机会来设计架构良好的系统，以实现故障转移、恢复和高可用性。在我看来，如果它不能允许这些事情，那么它就不应该运行。</p><p id="27a1" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我想花一点时间来讨论这篇文章背后的基础架构和平台，以及我们用来管理基础架构的一些工具。</p><h1 id="5d0d" class="ld le iq bd lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma bi translated"><strong class="ak">站台</strong></h1><p id="53c5" class="pw-post-body-paragraph jy jz iq ka b kb mb kd ke kf mc kh ki kj md kl km kn me kp kq kr mf kt ku kv ij bi translated">如果你没有从标题中猜到的话——是的，我们将要讨论<a class="ae mg" href="https://docs.mesosphere.com/1.11/overview/" rel="noopener ugc nofollow" target="_blank">DC/操作系统</a>。</p><blockquote class="mh mi mj"><p id="852a" class="jy jz mk ka b kb kc kd ke kf kg kh ki ml kk kl km mm ko kp kq mn ks kt ku kv ij bi translated">“DC/OS是基于Apache Mesos分布式系统内核的分布式操作系统。它支持管理多台机器，就像它们是一台计算机一样。它自动化了资源管理，安排了进程放置，促进了进程间的通信，并简化了分布式服务的安装和管理。”—docs.mesosphere.com</p></blockquote><p id="7050" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">无需深入解释DC/操作系统架构，只需注意这是为我们提供管理服务框架的主要平台。我们还选择在AWS中运行这个架构，以利用使云计算如此强大和令人敬畏的东西。我们还应该注意到，我们的大部分服务都在<a class="ae mg" href="https://www.docker.com" rel="noopener ugc nofollow" target="_blank">码头</a>运行，这也不需要解释很多好处。</p><p id="da6b" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">这里我应该提到的另一个关键点是，我们在DC操作系统上大量使用卡夫卡。我们在自己的环境中部署了多个Kafka集群，这些集群最能代表不同的应用环境(开发、QA、测试等)。每个Kafka集群也可能是不同的版本或风格(如合流Kafka)，因此我们必须始终确保我们不会一次失去来自同一个集群的太多代理，否则我们会遭受数据丢失。</p><h1 id="1a33" class="ld le iq bd lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma bi translated"><strong class="ak">工装</strong></h1><p id="8839" class="pw-post-body-paragraph jy jz iq ka b kb mb kd ke kf mc kh ki kj md kl km kn me kp kq kr mf kt ku kv ij bi translated">作为基础设施工程师，我们实践<a class="ae mg" href="https://www.martinfowler.com/bliki/InfrastructureAsCode.html" rel="noopener ugc nofollow" target="_blank">基础设施即代码</a>方法，并在任何可能的地方应用它们。我们对基础设施管理和DC/操作系统的各个方面进行版本控制、编码和自动化。这使得我们能够快速有效地为一个非常忙碌的工程师组成的极小团队工作。实现这一目标的一些工具值得一提:</p><p id="03e8" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><a class="ae mg" href="http://www.packer.io" rel="noopener ugc nofollow" target="_blank"> Packer </a> —我们使用Packer来构建我们的机器映像(AMIs)并将我们所有的环境细节应用于它们(监控、日志、Docker版本等……)。如果有兴趣了解更多，请看我以前的帖子，关于我们如何使用<a class="ae mg" href="https://medium.com/@wbassler23/dc-os-agent-ami-using-packer-and-ansible-8f6184a30e21" rel="noopener"> Packer来构建我们的DC/操作系统代理AMIs </a>。</p><p id="b671" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><a class="ae mg" href="http://www.terraform.io" rel="noopener ugc nofollow" target="_blank"> Terraform </a> —我们使用Terraform创建和管理我们基础设施的所有方面(EC2实例、SG、角色等)。当然，我们把上面用Packer创建的机器图像合并到这里。借助Terraform，我们能够自动完成DC/操作系统集群的初始创建，并将其用于扩展和修补。大部分魔力来自定制脚本和用户数据的<a class="ae mg" href="https://www.terraform.io/docs/providers/template/index.html" rel="noopener ugc nofollow" target="_blank"> Terraform模板</a>功能。</p><p id="e6c9" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">Ansible——我们非常广泛地使用ansi ble，不仅自动化我们基础设施的不同方面，还通过特别的命令管理基础设施。我们将行动手册融入到构建我们的机器映像和ansible-vault中，以保护敏感信息。</p><h1 id="2c10" class="ld le iq bd lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma bi translated"><strong class="ak">流程</strong></h1><p id="a5ea" class="pw-post-body-paragraph jy jz iq ka b kb mb kd ke kf mc kh ki kj md kl km kn me kp kq kr mf kt ku kv ij bi translated">既然我们已经讨论了用于执行维护的工具，我想概述一下我们的流程和方法。</p><p id="bf67" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">由于我们使用基础设施即代码、AWS和高度分布式系统，我们用全新的DC/操作系统代理完全取代了我们的代理。本质上，我们所做的是构建一个全新的机器映像，终止当前的DC/操作系统代理，然后用新创建的AMI重建/替换该代理。当然，在终止实例之前，我们必须做一些事情(下面会详细介绍)，但这是我们处理维护的高级方式。当您看到下面执行的步骤时，这可能会更有意义。</p><p id="dbae" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我们利用能够使用我们的DC/操作系统代理作为短暂的生命，而不是长期永远活着的实例。我们对待它们就好像我们知道我们很可能会因为文件系统损坏、内核崩溃、有人在AWS中捣鬼等等而失去代理一样。我们不会浪费时间对故障节点进行故障排除(99%的时间)，我们也不想担心如果我们执行“yum update -y”并重新启动可能会出现什么兼容性问题。我们用经过全面测试的机器映像进行替换，以避免将来发生灾难。记住我之前说的，电脑很烂，而且很蠢。他们会在某个时候让你失望。</p><p id="c2bf" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">如上所述，在终止实例之前，我们必须做几件事来确保我们不会影响集群上运行的服务。尽管我们已经为故障转移设计了我们的服务，但是我们必须安全地从代理节点中排出当前运行的服务。我们不想在维护时冒险造成停机。DC/操作系统实际上有一种执行<a class="ae mg" href="https://docs.mesosphere.com/1.11/administering-clusters/update-a-node/" rel="noopener ugc nofollow" target="_blank">节点维护</a>的方法，在这种方法中，您可以从主节点取消代理的注册，直到进一步通知或给定的时间。我们实际上更进了一步，我将在下面展示。此外，因为我们也运行几个Kafka集群，所以我们还必须替换代理，并让其他可用的代理替代它们，以避免数据丢失。</p><h1 id="35cf" class="ld le iq bd lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma bi translated"><strong class="ak">步骤</strong></h1><p id="5e9d" class="pw-post-body-paragraph jy jz iq ka b kb mb kd ke kf mc kh ki kj md kl km kn me kp kq kr mf kt ku kv ij bi translated">现在我们对这个过程有了更好的理解，让我们来看一下在节点维护期间执行的步骤。下面的步骤代表了我们为每个代理所经历的步骤:</p><ol class=""><li id="fe51" class="mo mp iq ka b kb kc kf kg kj mq kn mr kr ms kv mt mu mv mw bi translated">从Amazon和供应商提供的最新最好的AMI构建一个新的机器映像。我们用CentOS 7。你可以在我之前的文章<a class="ae mg" href="https://medium.com/@wbassler23/dc-os-agent-ami-using-packer-and-ansible-8f6184a30e21" rel="noopener">中再次看到这一步。</a>这一步只做一次，所有代理节点共享。</li><li id="fb36" class="mo mp iq ka b kb mx kf my kj mz kn na kr nb kv mt mu mv mw bi translated">在您的Terraform代码中，修改用于管理特定DC/操作系统代理的ec2资源，并用在第一步中创建的新ami-id替换旧ami-id。Terraform文档示例。</li></ol><pre class="nc nd ne nf gt ng nh ni nj aw nk bi"><span id="9c76" class="nl le iq nh b gy nm nn l no np">resource "aws_instance" "dcos_agent_node" {<br/>  monitoring    = true<br/>  ami           = "NEW_AMI_ID_HERE"<br/>  instance_type = "${var.instance_types["dcos_agent"]}"</span><span id="8c9d" class="nl le iq nh b gy nq nn l no np">...<br/>...<br/>...</span><span id="08df" class="nl le iq nh b gy nq nn l no np">}</span></pre><p id="3d3b" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">3.在AWS中终止DC/操作系统代理之前，我们还必须做其他事情。我们必须耗尽节点上所有正在运行的服务，以确保安全的故障转移。</p><p id="7691" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在我们的环境中，我们首先必须检查是否有任何Kafka经纪人在运行，如果有<a class="ae mg" href="https://docs.mesosphere.com/services/confluent-kafka/2.3.0-4.0.0e/troubleshooting/#replacing-a-permanently-failed-node" rel="noopener ugc nofollow" target="_blank">我们必须“替换”他们</a>。您可以使用<a class="ae mg" href="https://docs.mesosphere.com/1.11/cli/" rel="noopener ugc nofollow" target="_blank">DC/操作系统命令行界面</a>轻松做到这一点，您还可以深入到DC/操作系统用户界面的节点选项卡，找到代理属于哪个Kafka集群。</p><pre class="nc nd ne nf gt ng nh ni nj aw nk bi"><span id="2aaf" class="nl le iq nh b gy nm nn l no np">dcos kafka --name=&lt;KAFKA_CLUSTER_NAME&gt; pod replace kafka-0</span><span id="edd7" class="nl le iq nh b gy nq nn l no np"># For older versions<br/>dcos kafka --name=&lt;KAFKA_CLUSTER_NAME&gt; broker replace 0</span></pre><p id="a74a" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">这将停止在该节点上运行的当前代理，然后将新代理重新部署到不同的代理节点，并开始同步指定Kafka集群的数据。</p><p id="9453" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">其次，我们必须清空在那里运行的所有其他服务，并从集群中删除代理。我之前提到过，我们的大部分服务都在Docker中运行。因为我们的Docker版本当前需要Docker守护进程来运行容器，而Marathon需要守护进程运行来部署服务，所以我们向docker systemd服务发送一个kill信号并停止它。</p><pre class="nc nd ne nf gt ng nh ni nj aw nk bi"><span id="13a1" class="nl le iq nh b gy nm nn l no np">sudo systemctl kill -s SIGUSR1 docker &amp;&amp; sudo systemctl stop docker</span></pre><p id="53e0" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">这将立即终止在节点上运行的docker容器，Marathon将开始在集群中的其他地方重新部署它们。此外，因为docker守护进程现在在节点上停止了，所以我们不必担心马拉松式地尝试在我们正在工作的当前代理节点上重新部署它们！</p><p id="5f0c" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我们要做的最后一步是从DC/操作系统群集中完全删除代理节点。幸运的是，<a class="ae mg" href="https://docs.mesosphere.com/1.11/administering-clusters/delete-node/" rel="noopener ugc nofollow" target="_blank"> Mesosphere为我们提供了一个类似的命令，它将为我们处理上面提到的</a>。</p><pre class="nc nd ne nf gt ng nh ni nj aw nk bi"><span id="f56b" class="nl le iq nh b gy nm nn l no np">sudo systemctl kill -s SIGUSR1 dcos-mesos-slave &amp;&amp; sudo systemctl stop dcos-mesos-slave</span></pre><p id="ace8" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">您将很快看到，如果不是立即看到，您的代理节点在DC/OS UI和Mesos UI中完全从集群中消失。</p><p id="7f86" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我们已经想出了一个很酷的事情，那就是如何杀死和停止Docker守护进程和dcos-mesos-slave服务，这些服务是为SSM自动伸缩组后面的实例提供的。这使我们能够自动化向DC/操作系统集群添加新实例以及在节点终止时安全清空节点的整个过程。在以后的文章中会有更多的介绍！</p><p id="8ab1" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">4.现在，我们登录AWS并启动DC/操作系统代理实例终止。</p><p id="f411" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">5.一旦实例完全终止，现在可以使用我们在步骤1中构建的新AMI，用上面的terraform代码替换/重新部署该实例。</p><pre class="nc nd ne nf gt ng nh ni nj aw nk bi"><span id="ff34" class="nl le iq nh b gy nm nn l no np">terraform apply</span></pre><p id="49b0" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">大约2-3分钟后，我们将看到我们的DC/操作系统代理向群集重新注册，并以全新的操作系统重新出现在DC/操作系统用户界面中，它将开始接受预订请求。第5步需要一点编码和一些定制，以使节点自动<a class="ae mg" href="https://docs.mesosphere.com/1.11/installing/ent/custom/advanced/" rel="noopener ugc nofollow" target="_blank">正确添加回</a>，因为我们运行定制设置，如<a class="ae mg" href="https://docs.mesosphere.com/1.9/installing/oss/faq/#q-how-to-add-mesos-attributes-to-nodes-to-use-marathon-constraints" rel="noopener ugc nofollow" target="_blank">属性标签</a>和<a class="ae mg" href="https://docs.mesosphere.com/1.11/monitoring/debugging/slow-docker/" rel="noopener ugc nofollow" target="_blank">禁用CFS </a>。也许在某个时候，关于我们如何使用Terraform来管理我们的DC/操作系统集群的不同帖子会更合适。也许有一天，我们也会将整个过程自动化。</p></div><div class="ab cl kw kx hu ky" role="separator"><span class="kz bw bk la lb lc"/><span class="kz bw bk la lb lc"/><span class="kz bw bk la lb"/></div><div class="ij ik il im in"><p id="3e7c" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">让我们能够在进行节点维护的同时为用户提供高可用性需要一些反复试验。我们现在能够在很短的时间内完全升级大约20个DC/操作系统代理节点的集群，而对服务没有任何影响。这很重要，因为它允许我们在白天进行维护，没有人知道发生了什么。用户能够不受影响地完成他们的测试，我们也不必在非工作时间熬夜做测试。如果您的环境是相似的，那么您可以采取我上面介绍的相同步骤，并将其应用到您的节点维护中，以确保最高的可用性。</p></div></div>    
</body>
</html>