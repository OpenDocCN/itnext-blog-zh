<html>
<head>
<title>Restricting Flux permissions</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">限制流量许可</h1>
<blockquote>原文：<a href="https://itnext.io/restricting-flux-permissions-1f79372c77b5?source=collection_archive---------2-----------------------#2020-07-06">https://itnext.io/restricting-flux-permissions-1f79372c77b5?source=collection_archive---------2-----------------------#2020-07-06</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/6aec24fba4846207cfea16c071c8df16.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*sOWd0ecZMQcyXHxiFj-UEw.png"/></div></div></figure><h1 id="62af" class="jy jz iq bd ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv bi translated">问题陈述</h1><p id="3822" class="pw-post-body-paragraph kw kx iq ky b kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt ij bi translated">这项工作的问题陈述如下:</p><p id="2c89" class="pw-post-body-paragraph kw kx iq ky b kz lu lb lc ld lv lf lg lh lw lj lk ll lx ln lo lp ly lr ls lt ij bi translated"><strong class="ky ir">作为一名</strong>平台工程师<br/> <strong class="ky ir">我希望</strong>将通量权限锁定为“刚好够用”<br/> <strong class="ky ir">这样</strong>我们就能尽可能地保证集群的安全</p><h1 id="76c5" class="jy jz iq bd ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv bi translated">什么是通量？</h1><p id="7804" class="pw-post-body-paragraph kw kx iq ky b kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt ij bi translated">Flux是一个工具，可以自动确保集群的状态与git中的配置相匹配。它使用集群中的一个操作符来触发Kubernetes内部的部署，这意味着您不需要单独的CD工具。</p><p id="2df2" class="pw-post-body-paragraph kw kx iq ky b kz lu lb lc ld lv lf lg lh lw lj lk ll lx ln lo lp ly lr ls lt ij bi translated">它监控所有相关的映像存储库，检测新映像，触发部署，并基于此更新所需的运行配置(以及可配置的策略)。</p><p id="e529" class="pw-post-body-paragraph kw kx iq ky b kz lu lb lc ld lv lf lg lh lw lj lk ll lx ln lo lp ly lr ls lt ij bi translated">更多信息见<a class="ae lz" href="https://github.com/fluxcd/flux" rel="noopener ugc nofollow" target="_blank">https://github.com/fluxcd/flux</a></p><h1 id="7dc9" class="jy jz iq bd ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv bi translated">问题是</h1><p id="d6c8" class="pw-post-body-paragraph kw kx iq ky b kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt ij bi translated">默认情况下，Flux helm图表将RBAC(基于角色的访问控制)权限设置为能够执行任何操作的集群角色(见下文)</p><pre class="ma mb mc md gt me mf mg mh aw mi bi"><span id="9ff0" class="mj jz iq mf b gy mk ml l mm mn">rules:<br/>  - apiGroups:<br/>      - '*'<br/>    resources:<br/>      - '*'<br/>    verbs:<br/>      - '*'<br/>  - nonResourceURLs:<br/>      - '*'<br/>    verbs:<br/>      - '*'</span></pre><p id="a62b" class="pw-post-body-paragraph kw kx iq ky b kz lu lb lc ld lv lf lg lh lw lj lk ll lx ln lo lp ly lr ls lt ij bi translated">Flux out the box不知道要协调什么，所以这个默认位置是有意义的。然而，从安全角度来看，这远非理想。</p><h1 id="e172" class="jy jz iq bd ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv bi translated">要求</h1><p id="3220" class="pw-post-body-paragraph kw kx iq ky b kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt ij bi translated">要求如下:</p><ol class=""><li id="9dbc" class="mo mp iq ky b kz lu ld lv lh mq ll mr lp ms lt mt mu mv mw bi translated"><strong class="ky ir">所有通量所需的一组默认RBAC权限</strong></li></ol><p id="3b4e" class="pw-post-body-paragraph kw kx iq ky b kz lu lb lc ld lv lf lg lh lw lj lk ll lx ln lo lp ly lr ls lt ij bi translated">开箱即用，每个flux实例都需要一个默认的权限集，不管它协调什么，我们需要定义这些。</p><p id="4870" class="pw-post-body-paragraph kw kx iq ky b kz lu lb lc ld lv lf lg lh lw lj lk ll lx ln lo lp ly lr ls lt ij bi translated"><strong class="ky ir"> 2。一组RBAC权限允许自动提升图像</strong></p><p id="2411" class="pw-post-body-paragraph kw kx iq ky b kz lu lb lc ld lv lf lg lh lw lj lk ll lx ln lo lp ly lr ls lt ij bi translated">如果您正在使用自动图像升级，并在<code class="fe mx my mz mf b">HelmRelease</code>资源上使用flux注释，我们需要一组权限来实现这一点。</p><p id="5d49" class="pw-post-body-paragraph kw kx iq ky b kz lu lb lc ld lv lf lg lh lw lj lk ll lx ln lo lp ly lr ls lt ij bi translated"><strong class="ky ir"> 3。针对flux的每个实例的一组RBAC权限</strong></p><p id="7ee4" class="pw-post-body-paragraph kw kx iq ky b kz lu lb lc ld lv lf lg lh lw lj lk ll lx ln lo lp ly lr ls lt ij bi translated">最后，我们需要拥有运行特定flux实例所需的权限。这将因所调和的通量而不同。例如，一个特定的实例可能只需要将<code class="fe mx my mz mf b">SealedSecret</code>资源协调到一组名称空间中，其他什么都不需要。</p><h1 id="3aa2" class="jy jz iq bd ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv bi translated">实施</h1><p id="5ab6" class="pw-post-body-paragraph kw kx iq ky b kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt ij bi translated">为了简单起见，我将在这里谈论使用可用的<a class="ae lz" href="https://github.com/fluxcd/flux/tree/master/chart" rel="noopener ugc nofollow" target="_blank">上游舵图时所需的改变。</a></p><h2 id="7026" class="mj jz iq bd ka na nb dn ke nc nd dp ki lh ne nf km ll ng nh kq lp ni nj ku nk bi translated">控制RBAC</h2><p id="9869" class="pw-post-body-paragraph kw kx iq ky b kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt ij bi translated">我们需要做的第一件事是完全控制flux实例使用的RBAC。这可以通过设置以下值来实现。</p><pre class="ma mb mc md gt me mf mg mh aw mi bi"><span id="469d" class="mj jz iq mf b gy mk ml l mm mn">rbac:<br/>  create: false<br/>  <br/>serviceAccount:<br/>  create: false<br/>  name: flux-engineering</span></pre><h2 id="923f" class="mj jz iq bd ka na nb dn ke nc nd dp ki lh ne nf km ll ng nh kq lp ni nj ku nk bi translated">构造我们的ClusterRoleBinding &amp; service account</h2><p id="4214" class="pw-post-body-paragraph kw kx iq ky b kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt ij bi translated">我们现在需要一个默认的<code class="fe mx my mz mf b">ClusterRoleBinding</code>和相应的<code class="fe mx my mz mf b">ServiceAccount</code>(名称在你的舵图表值中指定)。这方面的一个例子如下:</p><pre class="ma mb mc md gt me mf mg mh aw mi bi"><span id="c903" class="mj jz iq mf b gy mk ml l mm mn">apiVersion: rbac.authorization.k8s.io/v1<br/>kind: ClusterRoleBinding<br/>metadata:<br/>  name: flux-engineering<br/>roleRef:<br/>  apiGroup: rbac.authorization.k8s.io<br/>  kind: ClusterRole<br/>  name: flux-engineering<br/>subjects:<br/>  - kind: ServiceAccount<br/>    name: flux-engineering<br/>    namespace: flux-engineering</span><span id="284a" class="mj jz iq mf b gy nl ml l mm mn">----</span><span id="2e6e" class="mj jz iq mf b gy nl ml l mm mn">apiVersion: v1<br/>kind: ServiceAccount<br/>metadata:<br/>  name: flux-engineering<br/>  namespace: flux-engineering</span></pre><h2 id="2429" class="mj jz iq bd ka na nb dn ke nc nd dp ki lh ne nf km ll ng nh kq lp ni nj ku nk bi translated">构建我们的集群角色</h2><p id="d6d3" class="pw-post-body-paragraph kw kx iq ky b kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt ij bi translated">当构建<code class="fe mx my mz mf b">ClusterRole</code>时，我们需要从添加流图提供的默认的基于角色的权限开始。这些是下面的</p><pre class="ma mb mc md gt me mf mg mh aw mi bi"><span id="68c0" class="mj jz iq mf b gy mk ml l mm mn"><em class="nm"># Default RBAC permissions</em></span><span id="2e63" class="mj jz iq mf b gy nl ml l mm mn">- apiGroups: ["apiextensions.k8s.io"]<br/>  resources: ["customresourcedefinitions"]<br/>  verbs: ["list", "watch"]<br/>- apiGroups: [""]<br/>  resources: ["namespaces"]<br/>  verbs: ["list"]</span></pre><p id="125d" class="pw-post-body-paragraph kw kx iq ky b kz lu lb lc ld lv lf lg lh lw lj lk ll lx ln lo lp ly lr ls lt ij bi translated">下一个要添加的部分是完成自动映像升级所需的权限，列出的资源取决于flux需要查看的资源，下面是一个示例:</p><pre class="ma mb mc md gt me mf mg mh aw mi bi"><span id="73a0" class="mj jz iq mf b gy mk ml l mm mn"><em class="nm"># RBAC required for automatic image promotion</em></span><span id="28c5" class="mj jz iq mf b gy nl ml l mm mn">- apiGroups: ["apps"]<br/>  resources: ["deployments", "daemonset", "statefulset"]<br/>  verbs: ["get", "list", "watch"]<br/><br/>- apiGroups: ["batch"]<br/>  resources: ["cronjob"]<br/>  verbs: ["get", "list", "watch"]</span></pre><p id="045b" class="pw-post-body-paragraph kw kx iq ky b kz lu lb lc ld lv lf lg lh lw lj lk ll lx ln lo lp ly lr ls lt ij bi translated">如果你使用的是<code class="fe mx my mz mf b">imagePullSecrets</code>，你需要给flux提供<code class="fe mx my mz mf b">get</code>和<code class="fe mx my mz mf b">list</code>秘密的能力，见下文:</p><pre class="ma mb mc md gt me mf mg mh aw mi bi"><span id="e08e" class="mj jz iq mf b gy mk ml l mm mn"><em class="nm"># RBAC required to pull images from a private registry</em></span><span id="8db2" class="mj jz iq mf b gy nl ml l mm mn">- apiGroups: [""]<br/>  resources: ["secrets"]<br/>  verbs: ["get", "list", "watch"]</span><span id="f523" class="mj jz iq mf b gy nl ml l mm mn">- apiGroups: [""]<br/>  resources: ["serviceaccounts"]<br/>  verbs: ["get", "list", "watch"]</span></pre><p id="9411" class="pw-post-body-paragraph kw kx iq ky b kz lu lb lc ld lv lf lg lh lw lj lk ll lx ln lo lp ly lr ls lt ij bi translated">现在我们需要提供协调存储库中特定资源所需的权限，例如，这可能只是<code class="fe mx my mz mf b">HelmRelease</code>资源。这可以从下面看出:</p><pre class="ma mb mc md gt me mf mg mh aw mi bi"><span id="2a3a" class="mj jz iq mf b gy mk ml l mm mn"><em class="nm"># Specific RBAC permissions for this flux instance</em></span><span id="f04f" class="mj jz iq mf b gy nl ml l mm mn">- apiGroups: ["helm.fluxcd.io"]<br/>  resources: ["helmreleases"]<br/>  verbs: ["*"]</span></pre><h2 id="192f" class="mj jz iq bd ka na nb dn ke nc nd dp ki lh ne nf km ll ng nh kq lp ni nj ku nk bi translated">用于访问发现API的附加ClusterRoleBinding</h2><p id="914a" class="pw-post-body-paragraph kw kx iq ky b kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt ij bi translated">最后，我们需要创建一个新的<code class="fe mx my mz mf b">ClusterRoleBinding</code>，为flux服务帐户提供<code class="fe mx my mz mf b">system:discovery</code> <code class="fe mx my mz mf b">ClusterRole</code>权限。这是默认的<code class="fe mx my mz mf b">ClusterRole</code>，允许对API发现端点进行只读访问，这是发现和协商API级别所必需的。下面可以看到<code class="fe mx my mz mf b">ClusterRoleBinding</code>:</p><pre class="ma mb mc md gt me mf mg mh aw mi bi"><span id="64e9" class="mj jz iq mf b gy mk ml l mm mn">apiVersion: rbac.authorization.k8s.io/v1<br/>kind: ClusterRoleBinding<br/>metadata:<br/>  name: flux-engineering-discovery-api<br/>roleRef:<br/>  apiGroup: rbac.authorization.k8s.io<br/>  kind: ClusterRole<br/>  name: system:discovery<br/>subjects:<br/>  - kind: ServiceAccount<br/>    name: flux-engineering<br/>    namespace: flux-engineering</span></pre><blockquote class="nn no np"><p id="3ac5" class="kw kx nm ky b kz lu lb lc ld lv lf lg nq lw lj lk nr lx ln lo ns ly lr ls lt ij bi translated">这个<code class="fe mx my mz mf b">ClusterRoleBinding</code>对于<strong class="ky ir">所有的flux实例</strong>都是必需的，不管实例正在协调什么。</p><p id="a8b0" class="kw kx nm ky b kz lu lb lc ld lv lf lg nq lw lj lk nr lx ln lo ns ly lr ls lt ij bi translated">Flux需要访问Kubernetes Discovery API，因为它使用它来枚举所有可能需要进行垃圾收集的东西。</p></blockquote><h1 id="9b38" class="jy jz iq bd ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv bi translated">退关货物</h1><p id="8503" class="pw-post-body-paragraph kw kx iq ky b kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt ij bi translated">我最后要大声喊出<strong class="ky ir">weave works<strong class="ky ir"/>的迈克尔·布里根</strong>和<strong class="ky ir">斯蒂芬·普罗丹</strong>。我们三个人踏上了学习如何锁定通量的旅程。</p></div></div>    
</body>
</html>