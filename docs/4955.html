<html>
<head>
<title>Ten Tips for Running Istio in Production</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在生产中运行Istio的十个技巧</h1>
<blockquote>原文：<a href="https://itnext.io/ten-tips-for-running-istio-in-production-4ea2b158440a?source=collection_archive---------4-----------------------#2020-11-02">https://itnext.io/ten-tips-for-running-istio-in-production-4ea2b158440a?source=collection_archive---------4-----------------------#2020-11-02</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="e5d8" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果你已经阅读了所有的pasta BookInfo博客帖子，这里有十个关于Istio的建议，可能会帮助你在Istio和Envoy Proxy领域获得博士学位。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi kl"><img src="../Images/04514ebcb2f3ce7f973f78dc290d84da.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*FMI3maJ_wN5GIIehdxwCXg.png"/></div></div><figcaption class="kx ky gj gh gi kz la bd b be z dk translated">我们是如何选择Istio的</figcaption></figure><ol class=""><li id="8f10" class="lb lc iq jp b jq jr ju jv jy ld kc le kg lf kk lg lh li lj bi translated">使用<a class="ae lk" href="https://github.com/eldadru/ksniff" rel="noopener ugc nofollow" target="_blank"> Kubectl Sniff </a>和<a class="ae lk" href="https://www.wireshark.org/" rel="noopener ugc nofollow" target="_blank">Wireshark</a>——如果你没有在夏天的网上跌跌撞撞和开车，你可能没有听说过Wireshark。Sniff提供了一种抽象，允许您通过Wireshark监听进出Istio代理的数据包。Sniff非常适合于低级分析，允许您隔离应用程序级与特使级问题的根本原因。首先在您的IstioOperator CRD上启用特权模式<code class="fe ll lm ln lo b">global.proxy.privileged=true</code>,并将以下注释添加到您的部署中。</li></ol><pre class="km kn ko kp gt lp lo lq lr aw ls bi"><span id="8b50" class="lt lu iq lo b gy lv lw l lx ly">apiVersion: apps/v1<br/>kind: Deployment<br/>metadata:<br/>  name: reception<br/>spec:<br/>  template:<br/>    metadata:<br/>      annotations:<br/>        sidecar.istio.io/capNetBindService: "true"</span></pre><p id="aaa0" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在Wireshark中，您可以启用对GRPC请求的<a class="ae lk" href="https://www.ridingthecrest.com/blog/2018/10/29/wireshark-getting-started.html" rel="noopener ugc nofollow" target="_blank">捕获</a>，并基于它们进行过滤，以及“跟踪”请求的生命周期以确定其进入和离开。本地端口转发您的服务，并使用<a class="ae lk" href="https://github.com/uw-labs/bloomrpc" rel="noopener ugc nofollow" target="_blank"> BloomRPC </a>或<a class="ae lk" href="https://www.postman.com/downloads/" rel="noopener ugc nofollow" target="_blank"> Postman </a>来隔离连接问题。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi lz"><img src="../Images/4e70d6aedea77f2178e301ed0b23b592.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*dmuwNRJrIss-U-A5"/></div></div><figcaption class="kx ky gj gh gi kz la bd b be z dk translated">在Wireshark中过滤GRPC请求</figcaption></figure><p id="4c34" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">2.先用特使。通过在本地docker-compose文件中运行Envoy来了解如何配置Envoy过滤器链，可以更容易地对请求镜像或WASM等更改进行原型化。在将Envoy转换为Istio配置的过程中，树立对其理解的信心会有所收获。</p><p id="4e74" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">3.虔诚地阅读发行说明。这是值得重申的，因为在过去，我们已经错过了发布说明上光的关键变化。在我们之前的Istio升级期间，我们错过了一个看似良性的更改，即特使状态端口被修改(15020 -&gt; 15021)，导致我们认为我们的负载平衡器不健康。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi lz"><img src="../Images/b4ae51669d5b65f9a451b4f9be9beb35.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*QqIwtaIftA5Q-Lrk"/></div></div><figcaption class="kx ky gj gh gi kz la bd b be z dk translated">Istio网站上的发行说明和升级指南</figcaption></figure><p id="b500" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">4.在Istio操作符上使用Istioctl生成清单——我们最近从1.6 -&gt; 1.7进行了升级，注意到操作符由于结构的变化而无法完成其协调循环(label-&gt; labels in kind:envoy filter)。我们期望运营商能够以向后兼容的方式处理这种升级。对于没有通过操作符CRD公开的字段(例如:服务注释)，通过Istio Overlay API或Kustomize可以更容易地操作生成的清单。</p><pre class="km kn ko kp gt lp lo lq lr aw ls bi"><span id="12c3" class="lt lu iq lo b gy lv lw l lx ly">apiVersion: networking.istio.io/v1alpha3<br/>kind: EnvoyFilter<br/>metadata:<br/>  name: wasm-hmac<br/>spec:<br/>  workloadSelector:<br/>    labels: # labels, not label<br/>      app: pubsub-gateway</span></pre><p id="4094" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">5.当您找到一个示例清单时，请确认该示例与代理容器中的Envoy API/Protobuf版本一致。对于一些关键特性，与最新的Envoy相关的typed_config示例记录得很少。</p><pre class="km kn ko kp gt lp lo lq lr aw ls bi"><span id="3c4a" class="lt lu iq lo b gy lv lw l lx ly">patch:<br/>     operation: INSERT_BEFORE<br/>     value:<br/>       name: envoy.filters.http.wasm<br/>       typed_config:<br/>         "@type": type.googleapis.com/udpa.type.v1.TypedStruct<br/>         type_url: type.googleapis.com/envoy.config.filter.http.wasm.v3.Wasm<br/>         value:<br/>           config:<br/>             name: "signature_auth"<br/>             root_id: "signature_auth"<br/>             configuration:<br/>               "@type": "type.googleapis.com/google.protobuf.Struct"<br/>               value:<br/>                 signing_key: ""<br/>                 signature_header: "X-My-Hmac-Header-SHA256"<br/>             vm_config:<br/>               runtime: "envoy.wasm.runtime.v8"<br/>               code:<br/>                 local:<br/>                   filename: "/etc/wasm/your-binary.wasm"<br/>               allow_precompiled: true</span></pre><p id="2bde" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">6.如果您使用Istio Ingress网关作为GKE上集群的入口，并希望启用HTTPS，请使用Istio Ingress网关服务的单个上游设置一个入口对象。添加静态IP计算地址、托管证书和BackendConfig(以设置运行状况检查)，以便通过负载平衡器提供安全访问。这里有一个关于这个话题的<a class="ae lk" href="https://cloud.google.com/solutions/exposing-service-mesh-apps-through-gke-ingress" rel="noopener ugc nofollow" target="_blank">教程</a>。</p><p id="a43c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">7.请求镜像是一种“生产测试”的强大手段。如果您在安装中启用了此功能，并且无法解释为什么下游服务会拒绝请求，请查看您的主机头。<a class="ae lk" href="https://www.envoyproxy.io/docs/envoy/latest/api-v2/api/v2/route/route_components.proto#route-routeaction-requestmirrorpolicy" rel="noopener ugc nofollow" target="_blank">特使将“-阴影</a>”附加到你的主机头。如果您使用的是<a class="ae lk" href="https://github.com/envoyproxy/envoy/issues/9094#issuecomment-565380693" rel="noopener ugc nofollow" target="_blank"> vanilla Envoy </a>，您可以通过创建一个单独的监听器来解决这个问题。通过Istio重写这个头在Istio中不太可行，所以我们选择添加一个单独的Envoy部署来将头重写到我们想要的目的地。</p><p id="73a9" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">同样，如果您正在使用<code class="fe ll lm ln lo b">istio-ingressgateway</code>在边缘实现请求镜像，并且希望在集群中实现镜像，那么将本地服务名和关键字<code class="fe ll lm ln lo b">mesh</code>添加到您的virtualservice中。</p><pre class="km kn ko kp gt lp lo lq lr aw ls bi"><span id="6492" class="lt lu iq lo b gy lv lw l lx ly">kind: VirtualService<br/>metadata:<br/>  name: mirror-policy<br/>  namespace: your-app<br/>spec:<br/>  gateways:<br/>    - istio-system/your-gateway<br/>    - mesh<br/>  hosts:<br/>    - 'your-service.your-app.svc.cluster.local'<br/>    - 'your-api.dot.com'</span></pre><p id="f0cf" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">8.JWT验证提供了一个有趣的抽象，允许您的服务知道它是否经过身份验证。与基于工作负载选择器标签方案选择退出相比，不得不“选择加入”可能公开的经过身份验证的服务似乎是有风险的。使用Open Policy Agent等工具在您的工作负载上强制执行所需的标签，以确保所有服务上都有身份验证标签。此外，当您在JWTRule上启用“outputPayloadToHeader”来传播上下文时，预计负载在被服务使用时会缺少base64填充。</p><p id="e671" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">9.GRPC JSON代码转换是一个方便的抽象，节省了工程师编写助手代码将JSON代码转换成GRPC代码的时间。然而，将变更部署到原型描述符的过程似乎有点笨拙。我们最初的解决方法包括对我们的原型描述符进行base64编码，并将其作为一个秘密挂载。这很快变得难以处理，因为每当Protobuf定义发生变化时，没有工程师愿意对二进制文件进行base64编码。一种稍微好一点的方法是用您的描述符构建一个容器映像，并将其作为一个具有共享内存卷的initContainer来运行。在pod启动时，initContainer会将二进制文件复制到共享卷空间中，并且Istio代理容器可以访问它。</p><pre class="km kn ko kp gt lp lo lq lr aw ls bi"><span id="6543" class="lt lu iq lo b gy lv lw l lx ly">apiVersion: apps/v1<br/>kind: Deployment<br/>metadata:<br/>  name: reception<br/>spec:<br/>  template:<br/>    metadata:<br/>      annotations: # only good for prototyping!<br/>        sidecar.istio.io/userVolumeMount: '[{"name":"my-cert", "mountPath":"/etc/envoy", "readonly":true}, {"name": "cache-volume", "mountPath":"/tmp"}]'<br/>        sidecar.istio.io/userVolume: '[{"name":"my-cert", "secret":{"secretName":"event-reception-pb"}}, {"name": "cache-volume", "emptyDir":{}}]'</span></pre><p id="dd59" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">10.Envoy提供了一种修改过滤器的虚拟主机特定配置的方法。用Istio术语来说，这意味着能够改变特定虚拟主机路径上现有过滤器的功能。该功能适用于那些声称支持每条路由配置的<a class="ae lk" href="https://www.envoyproxy.io/docs/envoy/latest/configuration/http/http_filters/http_filters#config-http-filters" rel="noopener ugc nofollow" target="_blank">的特定过滤器，但不适用于WASM等过滤器。</a></p><p id="2044" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">额外收获:如果你必须添加一个标签，它可能是pod模板规范标签，而不是部署标签。使用istioctl analyze为您提供低挂水果修复。</p></div></div>    
</body>
</html>