<html>
<head>
<title>Automated HA Kubernetes deployment on Raspberry Pis</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在Raspberry Pis上自动部署HA Kubernetes</h1>
<blockquote>原文：<a href="https://itnext.io/automated-ha-kubernetes-deployment-on-raspberry-pis-408f38cd836c?source=collection_archive---------3-----------------------#2020-07-16">https://itnext.io/automated-ha-kubernetes-deployment-on-raspberry-pis-408f38cd836c?source=collection_archive---------3-----------------------#2020-07-16</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="bb59" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">了解如何在Raspberry Pis上创建HA Kubernetes集群。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi kl"><img src="../Images/4d27cd98eaefaf766f0c5fc09f0a53fa.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*YgBKCY12xfnKaBNd4ydsfQ.jpeg"/></div></div></figure></div><div class="ab cl kx ky hu kz" role="separator"><span class="la bw bk lb lc ld"/><span class="la bw bk lb lc ld"/><span class="la bw bk lb lc"/></div><div class="ij ik il im in"><p id="311e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">本指南演示了如何在学习环境中实现企业级安全性、可观察性和整体集群管理。本指南中的所有信息都基于Raspbernetes项目。</p><p id="fdd4" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">Raspbernetes项目的目标是在Raspberry Pis上自动设置和管理Kubernetes集群。它的目标是完全的声明性和幂等性。</p><p id="d50c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">查看有关该项目的更多信息→<a class="ae le" href="https://github.com/raspbernetes" rel="noopener ugc nofollow" target="_blank">https://github.com/raspbernetes</a></p><h1 id="4c0f" class="lf lg iq bd lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc bi translated"><em class="md">先决条件</em></h1><p id="57bc" class="pw-post-body-paragraph jn jo iq jp b jq me js jt ju mf jw jx jy mg ka kb kc mh ke kf kg mi ki kj kk ij bi translated">硬件——我们建议至少有4个覆盆子。本指南使用3个Pi作为主节点，另一个Pi作为工作节点。您可以添加更多的pi来创建额外的主节点或工作节点。</p><p id="2742" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">软件—您需要以下CLI工具才能遵循本指南中的步骤:</p><ul class=""><li id="9c39" class="mj mk iq jp b jq jr ju jv jy ml kc mm kg mn kk mo mp mq mr bi translated"><a class="ae le" href="https://docs.ansible.com/ansible/latest/installation_guide/intro_installation.html" rel="noopener ugc nofollow" target="_blank">可回答的</a></li><li id="ee9c" class="mj mk iq jp b jq ms ju mt jy mu kc mv kg mw kk mo mp mq mr bi translated"><a class="ae le" href="https://github.com/hypriot/flash#installation" rel="noopener ugc nofollow" target="_blank">闪光灯</a></li><li id="64a4" class="mj mk iq jp b jq ms ju mt jy mu kc mv kg mw kk mo mp mq mr bi translated"><a class="ae le" href="https://kubernetes.io/docs/tasks/tools/install-kubectl/" rel="noopener ugc nofollow" target="_blank">库贝克特尔</a></li></ul><p id="79ea" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">最后，您需要克隆这个库:<a class="ae le" href="https://github.com/raspbernetes/k8s-cluster-installation" rel="noopener ugc nofollow" target="_blank">https://github.com/raspbernetes/k8s-cluster-installation</a></p><h1 id="501c" class="lf lg iq bd lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc bi translated">闪存卡</h1><p id="0cb2" class="pw-post-body-paragraph jn jo iq jp b jq me js jt ju mf jw jx jy mg ka kb kc mh ke kf kg mi ki kj kk ij bi translated">为了给每个节点配置唯一的IP和主机名，我们使用cloud-init。这是一种跨平台云实例初始化的方法，也适用于裸机安装。</p><p id="9f59" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">本指南中使用的操作系统将是Ubuntu 20.04，运行以下命令下载映像:</p><pre class="km kn ko kp gt mx my mz na aw nb bi"><span id="5697" class="nc lg iq my b gy nd ne l nf ng"># Download the Ubuntu 20.04 Focal image for Raspberry Pis<br/>curl -L "http://cdimage.ubuntu.com/releases/focal/release/ubuntu-  20.04.1-preinstalled-server-arm64+raspi.img.xz" -o ~/Downloads/ubuntu-20.04.1-preinstalled-server-arm64+raspi.img.xz</span><span id="823e" class="nc lg iq my b gy nh ne l nf ng"># Extract the downloaded files<br/>unxz -T 0 ~/Downloads/ubuntu-20.04.1-preinstalled-server-arm64+raspi.img.xz</span></pre><p id="ce8b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">以下步骤将在引导时使用cloud-init自动为节点配置网络(必须为每个节点重复步骤4至6):</p><ol class=""><li id="2453" class="mj mk iq jp b jq jr ju jv jy ml kc mm kg mn kk ni mp mq mr bi translated">打开<a class="ae le" href="https://github.com/raspbernetes/k8s-cluster-installation/blob/master/setup/cloud-config.yml" rel="noopener ugc nofollow" target="_blank">云配置</a>文件。</li><li id="e751" class="mj mk iq jp b jq ms ju mt jy mu kc mv kg mw kk ni mp mq mr bi translated">更新<code class="fe nj nk nl my b">gateway4</code>值以匹配您路由器的IP。(如果不确定，您可以使用本<a class="ae le" href="https://www.howtogeek.com/233952/how-to-find-your-routers-ip-address-on-any-computer-smartphone-or-tablet/#:~:text=Find%20Your%20Router's%20IP%20Address%20in%20Mac%20OS%20X&amp;text=Select%20your%20network%20connection%E2%80%94for,listed%20simply%20as%20%E2%80%9CRouter.%E2%80%9D" rel="noopener ugc nofollow" target="_blank">指南</a>找到该IP)</li><li id="7a1a" class="mj mk iq jp b jq ms ju mt jy mu kc mv kg mw kk ni mp mq mr bi translated">用您自己的密钥更新<code class="fe nj nk nl my b">ssh_authorized_keys</code>值，无需进一步配置即可实现对每个节点的安全SSH访问。(强烈推荐，如果您还没有设置SSH密钥，有很多指南会解释如何设置SSH密钥)</li><li id="fb91" class="mj mk iq jp b jq ms ju mt jy mu kc mv kg mw kk ni mp mq mr bi translated">将<code class="fe nj nk nl my b">hostname</code>值更新为每个节点唯一的值。</li><li id="f9ef" class="mj mk iq jp b jq ms ju mt jy mu kc mv kg mw kk ni mp mq mr bi translated">将<code class="fe nj nk nl my b">addresses</code>值更新为每个节点的唯一IP。</li><li id="479c" class="mj mk iq jp b jq ms ju mt jy mu kc mv kg mw kk ni mp mq mr bi translated">使用以下命令将操作系统映像和云初始化配置刷新到Raspberry Pi上:</li></ol><pre class="km kn ko kp gt mx my mz na aw nb bi"><span id="7a6f" class="nc lg iq my b gy nd ne l nf ng">flash \<br/>  --userdata setup/cloud-config.yml \<br/>  ~/Downloads/ubuntu-20.04.1-preinstalled-server-arm64+raspi.img</span></pre><h1 id="e066" class="lf lg iq bd lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc bi translated">集群配置</h1><h2 id="25cb" class="nc lg iq bd lh nm nn dn ll no np dp lp jy nq nr lt kc ns nt lx kg nu nv mb nw bi translated">基本设置</h2><p id="839e" class="pw-post-body-paragraph jn jo iq jp b jq me js jt ju mf jw jx jy mg ka kb kc mh ke kf kg mi ki kj kk ij bi translated"><em class="nx">注意:这将使用默认CRI &amp; CNI配置初始化您的集群，对于更高级的配置，请检查“</em> <a class="ae le" href="#14fe" rel="noopener ugc nofollow"> <em class="nx">高级设置</em> </a> <em class="nx">”选项。</em></p><p id="fe11" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在我们已经运行了所有的Raspberry Pi节点，并配置了唯一的主机名IP，我们现在需要在Ansible <a class="ae le" href="https://github.com/raspbernetes/k8s-cluster-installation/blob/master/ansible/inventory" rel="noopener ugc nofollow" target="_blank"> inventory </a>文件中声明这些值。</p><p id="c75b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">下面是我如何配置3个主节点和1个工作节点的例子。</p><pre class="km kn ko kp gt mx my mz na aw nb bi"><span id="bac9" class="nc lg iq my b gy nd ne l nf ng">[masters]<br/>k8s-master-01 hostname=k8s-master-01 ansible_host=192.168.1.121 ansible_user=pi<br/>k8s-master-02 hostname=k8s-master-02 ansible_host=192.168.1.122 ansible_user=pi<br/>k8s-master-03 hostname=k8s-master-03 ansible_host=192.168.1.123 ansible_user=pi</span><span id="f31d" class="nc lg iq my b gy nh ne l nf ng">[workers]<br/>k8s-worker-01 hostname=k8s-worker-01 ansible_host=192.168.1.131 ansible_user=pi</span></pre><p id="cb32" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">为所有主机配置清单后，我们还必须配置最后一件事。我们需要分配一个VIP(“虚拟IP”)，用于跨HA主节点进行负载平衡。</p><p id="8c11" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">打开<a class="ae le" href="https://github.com/raspbernetes/k8s-cluster-installation/blob/master/ansible/group_vars/masters.yml" rel="noopener ugc nofollow" target="_blank"> masters.yml </a>，将<code class="fe nj nk nl my b">keepalived_vip</code>值配置为未分配的IP。对于我的配置，我使用<code class="fe nj nk nl my b">192.168.1.200</code>。</p><p id="6039" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">运行以下命令来验证SSH连接。</p><pre class="km kn ko kp gt mx my mz na aw nb bi"><span id="1867" class="nc lg iq my b gy nd ne l nf ng">env ANSIBLE_CONFIG=ansible/ansible.cfg ansible all -m ping</span></pre><p id="4192" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">成功的响应应该如下所示:</p><pre class="km kn ko kp gt mx my mz na aw nb bi"><span id="e32b" class="nc lg iq my b gy nd ne l nf ng">k8s-master-01 | SUCCESS =&gt; {<br/>...<br/>"ping": "pong"<br/>...<br/>}</span></pre><p id="d077" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><em class="nx">注意:如果每次ping的输出都返回成功，那么您可以继续，否则可能会出现库存文件配置错误或网络连接问题。</em></p><p id="a1fd" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在我们已经测试了网络连接，我们可以运行自动化脚本，这些脚本将负责使用以下内容部署Kubernetes:</p><pre class="km kn ko kp gt mx my mz na aw nb bi"><span id="e9e5" class="nc lg iq my b gy nd ne l nf ng">env ANSIBLE_CONFIG=ansible/ansible.cfg ansible-playbook ansible/playbooks/all.yml</span></pre><p id="dd3d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">成功完成后，您可以使用<code class="fe nj nk nl my b">kubectl</code>与您的Kubernetes集群互动:</p><pre class="km kn ko kp gt mx my mz na aw nb bi"><span id="dd92" class="nc lg iq my b gy nd ne l nf ng">kubectl get nodes --kubeconfig ansible/playbooks/output/k8s-config.yaml</span></pre><p id="62fb" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">预期的输出应该如下所示:</p><pre class="km kn ko kp gt mx my mz na aw nb bi"><span id="268b" class="nc lg iq my b gy nd ne l nf ng">NAME            STATUS     ROLES    AGE     VERSION<br/>k8s-master-01   Ready      master   4m45s   v1.18.2<br/>k8s-master-02   Ready      master   70s     v1.18.2<br/>k8s-master-03   Ready      master   79s     v1.18.2<br/>k8s-worker-01   Ready      &lt;none&gt;   16s     v1.18.2</span></pre><p id="a859" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">恭喜</strong>！现在，您已经有了一个在Raspberry Pis上运行的Kubernetes集群。</p><h2 id="14fe" class="nc lg iq bd lh nm nn dn ll no np dp lp jy nq nr lt kc ns nt lx kg nu nv mb nw bi translated">高级设置</h2><p id="8a1f" class="pw-post-body-paragraph jn jo iq jp b jq me js jt ju mf jw jx jy mg ka kb kc mh ke kf kg mi ki kj kk ij bi translated">本节是对“基本设置”的补充，但是将探索更多可用的高级配置。</p><p id="9f6d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">配置选项可以在<a class="ae le" href="https://github.com/raspbernetes/k8s-cluster-installation/blob/master/ansible/group_vars" rel="noopener ugc nofollow" target="_blank"> group_vars </a>文件夹中找到，其中有文件<a class="ae le" href="https://github.com/raspbernetes/k8s-cluster-installation/blob/master/ansible/group_vars/all.yml" rel="noopener ugc nofollow" target="_blank"> all.yml </a>、<a class="ae le" href="https://github.com/raspbernetes/k8s-cluster-installation/blob/master/ansible/group_vars/masters.yml" rel="noopener ugc nofollow" target="_blank"> masters.yml </a>和<a class="ae le" href="https://github.com/raspbernetes/k8s-cluster-installation/blob/master/ansible/group_vars/workers.yml" rel="noopener ugc nofollow" target="_blank"> workers.yml </a>。这些文件包含每个角色的可配置变量。</p><figure class="km kn ko kp gt kq"><div class="bz fp l di"><div class="ny nz l"/></div></figure><h1 id="f77c" class="lf lg iq bd lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc bi translated">清除</h1><p id="ebc2" class="pw-post-body-paragraph jn jo iq jp b jq me js jt ju mf jw jx jy mg ka kb kc mh ke kf kg mi ki kj kk ij bi translated">使用以下命令拆除集群并删除所有内容:</p><pre class="km kn ko kp gt mx my mz na aw nb bi"><span id="084e" class="nc lg iq my b gy nd ne l nf ng">env ANSIBLE_CONFIG=ansible/ansible.cfg ansible-playbook ansible/playbooks/nuke.yml</span></pre><h1 id="2fd7" class="lf lg iq bd lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc bi translated">摘要</h1><p id="56ef" class="pw-post-body-paragraph jn jo iq jp b jq me js jt ju mf jw jx jy mg ka kb kc mh ke kf kg mi ki kj kk ij bi translated">您已经成功地在Raspberry Pis上创建了一个具有高可用性拓扑的Kubernetes集群。</p><p id="6bec" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">您已经学习了如何配置网络、刷新操作系统、设置一些基本的集群配置，现在有了Kubernetes集群可以继续学习。</p></div><div class="ab cl kx ky hu kz" role="separator"><span class="la bw bk lb lc ld"/><span class="la bw bk lb lc ld"/><span class="la bw bk lb lc"/></div><div class="ij ik il im in"><p id="2e25" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果您喜欢我们的开源项目，请随意贡献，尤其是如果您有目前不可用的用例！在Raspbernetes Github org <a class="ae le" href="https://github.com/raspbernetes" rel="noopener ugc nofollow" target="_blank">这里</a>可以发现更多。</p><p id="4dc9" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><em class="nx">你觉得这个有用吗？发表评论或给我们点赞！</em></p></div></div>    
</body>
</html>