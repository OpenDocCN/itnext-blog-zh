<html>
<head>
<title>Kubernetes: a cluster’s monitoring with Prometheus Operator</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Kubernetes:用Prometheus算子监视集群</h1>
<blockquote>原文：<a href="https://itnext.io/kubernetes-a-clusters-monitoring-with-the-prometheus-operator-bfb4c04ba3c2?source=collection_archive---------4-----------------------#2020-08-13">https://itnext.io/kubernetes-a-clusters-monitoring-with-the-prometheus-operator-bfb4c04ba3c2?source=collection_archive---------4-----------------------#2020-08-13</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div class="gh gi jn"><img src="../Images/0e4a20948b401b89d6acc81d4e4d9d4b.png" data-original-src="https://miro.medium.com/v2/resize:fit:260/format:webp/0*BGU5-7MWNrKRHT5b.png"/></div></figure><p id="17fe" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">继续讨论<a class="ae ks" href="https://rtfm.co.ua/en/kubernetes-monitoring-with-prometheus-exporters-a-service-discovery-and-its-roles/" rel="noopener ugc nofollow" target="_blank"> Kubernetes:使用Prometheus进行监控——exporters、服务发现及其角色</a>，我们手动配置了Prometheus以查看其工作情况——现在，让我们尝试使用通过Helm chart安装的<a class="ae ks" href="https://github.com/bitnami/charts/tree/master/bitnami/prometheus-operator/" rel="noopener ugc nofollow" target="_blank"> Prometheus操作符</a>。</p><p id="adec" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">因此，任务是在AWS Elastic Kubernetes集群中启动Prometheus服务器和所有必要的导出器，然后通过<code class="fe kt ku kv kw b"><a class="ae ks" href="https://rtfm.co.ua/prometehus-obzor-federation-monitoring-docker-swarm-i-nastrojki-alertmanager/#Prometheus_crossservice_federation" rel="noopener ugc nofollow" target="_blank">/federation</a></code>将指标传递到我们的“中央”Prometheus服务器，该服务器带有Alertmanager警报和Grafana仪表板。</p><p id="146c" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">有一点令人困惑的是整套这样的掌舵图——有一个“简单”的普罗米修斯图，还有<code class="fe kt ku kv kw b">kube-prometheus</code>和<code class="fe kt ku kv kw b">prometheus-operator</code>:</p><ul class=""><li id="89f3" class="kx ky iq jw b jx jy kb kc kf kz kj la kn lb kr lc ld le lf bi translated">Bitnami Prometheus操作员—<a class="ae ks" href="https://github.com/bitnami/charts/tree/master/bitnami/prometheus-operator/" rel="noopener ugc nofollow" target="_blank">https://github . com/bitnami/charts/tree/master/bitnami/Prometheus-Operator/</a></li><li id="4db6" class="kx ky iq jw b jx lg kb lh kf li kj lj kn lk kr lc ld le lf bi translated">CoreOS Prometheus操作员—<a class="ae ks" href="https://github.com/coreos/prometheus-operator" rel="noopener ugc nofollow" target="_blank">https://github.com/coreos/prometheus-operator</a></li><li id="51f5" class="kx ky iq jw b jx lg kb lh kf li kj lj kn lk kr lc ld le lf bi translated">赫尔姆社区普罗米修斯操作员—<a class="ae ks" href="https://github.com/helm/charts/tree/master/stable/prometheus-operator" rel="noopener ugc nofollow" target="_blank">https://github . com/helm/charts/tree/master/stable/Prometheus-Operator</a></li><li id="dc18" class="kx ky iq jw b jx lg kb lh kf li kj lj kn lk kr lc ld le lf bi translated">科瑞奥斯<code class="fe kt ku kv kw b">kube-prometheus</code>-<a class="ae ks" href="https://github.com/coreos/kube-prometheus" rel="noopener ugc nofollow" target="_blank">https://github.com/coreos/kube-prometheus</a></li><li id="08bf" class="kx ky iq jw b jx lg kb lh kf li kj lj kn lk kr lc ld le lf bi translated">还有《只是一个普罗米修斯》——<a class="ae ks" href="https://github.com/helm/charts/tree/master/stable/prometheus" rel="noopener ugc nofollow" target="_blank">https://github . com/helm/charts/tree/master/stable/普罗米修斯</a></li></ul><p id="c7b7" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">虽然如果通过赫尔姆搜索寻找它——它返回唯一的一个<code class="fe kt ku kv kw b">prometheus-operator</code>:</p><pre class="ll lm ln lo gt lp kw lq lr aw ls bi"><span id="3645" class="lt lu iq kw b gy lv lw l lx ly">$ helm search repo stable/prometheus-operator -o yaml<br/>- app_version: 0.38.1<br/>description: Provides easy monitoring definitions for Kubernetes services, and deployment<br/>and management of Prometheus instances.<br/>name: stable/prometheus-operator<br/>version: 8.14.0</span></pre><p id="0ad7" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated"><code class="fe kt ku kv kw b">stable/prometheus</code>和<code class="fe kt ku kv kw b">stable/prometheus-operator</code>的区别在于，运营商内置了Grafana和一套现成的仪表盘以及一套<code class="fe kt ku kv kw b">ServiceMonitors</code>来收集集群服务的指标，如CoreDNS、API服务器、调度程序等。</p><p id="00c8" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">因此，如前所述，我们将使用<code class="fe kt ku kv kw b"><a class="ae ks" href="https://github.com/helm/charts/tree/master/stable/prometheus-operator" rel="noopener ugc nofollow" target="_blank">stable/prometheus-operator</a></code>。</p><h1 id="066f" class="lz lu iq bd ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp mq mr ms mt mu mv bi translated">内容</h1><ul class=""><li id="6df4" class="kx ky iq jw b jx mw kb mx kf my kj mz kn na kr lc ld le lf bi translated"><a class="ae ks" href="https://rtfm.co.ua/en/kubernetes-a-clusters-monitoring-with-the-prometheus-operator/#Prometheus_Operator_deployment" rel="noopener ugc nofollow" target="_blank">普罗米修斯操作员部署</a></li><li id="9951" class="kx ky iq jw b jx lg kb lh kf li kj lj kn lk kr lc ld le lf bi translated"><a class="ae ks" href="https://rtfm.co.ua/en/kubernetes-a-clusters-monitoring-with-the-prometheus-operator/#Grafana_access" rel="noopener ugc nofollow" target="_blank">格拉法纳接入</a></li><li id="9e56" class="kx ky iq jw b jx lg kb lh kf li kj lj kn lk kr lc ld le lf bi translated"><a class="ae ks" href="https://rtfm.co.ua/en/kubernetes-a-clusters-monitoring-with-the-prometheus-operator/#Prometheus_Operator_configuration" rel="noopener ugc nofollow" target="_blank">普罗米修斯操作员配置</a></li><li id="5e4e" class="kx ky iq jw b jx lg kb lh kf li kj lj kn lk kr lc ld le lf bi translated"><a class="ae ks" href="https://rtfm.co.ua/en/kubernetes-a-clusters-monitoring-with-the-prometheus-operator/#Adding_new_application_under_monitoring" rel="noopener ugc nofollow" target="_blank">在监控下添加新应用</a></li><li id="32ab" class="kx ky iq jw b jx lg kb lh kf li kj lj kn lk kr lc ld le lf bi translated"><a class="ae ks" href="https://rtfm.co.ua/en/kubernetes-a-clusters-monitoring-with-the-prometheus-operator/#Redis_server_launch" rel="noopener ugc nofollow" target="_blank"> Redis服务器启动</a></li><li id="e26e" class="kx ky iq jw b jx lg kb lh kf li kj lj kn lk kr lc ld le lf bi translated"><a class="ae ks" href="https://rtfm.co.ua/en/kubernetes-a-clusters-monitoring-with-the-prometheus-operator/#redisexporter_launch" rel="noopener ugc nofollow" target="_blank"> redis_exporter发布</a></li><li id="b8e1" class="kx ky iq jw b jx lg kb lh kf li kj lj kn lk kr lc ld le lf bi translated"><a class="ae ks" href="https://rtfm.co.ua/en/kubernetes-a-clusters-monitoring-with-the-prometheus-operator/#Adding_Kubernetes_ServiceMonitor" rel="noopener ugc nofollow" target="_blank">添加Kubernetes ServiceMonitor </a></li><li id="2281" class="kx ky iq jw b jx lg kb lh kf li kj lj kn lk kr lc ld le lf bi translated"><a class="ae ks" href="https://rtfm.co.ua/en/kubernetes-a-clusters-monitoring-with-the-prometheus-operator/#Prometheus_Operator_Helm_deployment_and_its_services_configuration" rel="noopener ugc nofollow" target="_blank"> Prometheus操作员舵部署及其服务配置</a></li><li id="9fd9" class="kx ky iq jw b jx lg kb lh kf li kj lj kn lk kr lc ld le lf bi translated"><a class="ae ks" href="https://rtfm.co.ua/en/kubernetes-a-clusters-monitoring-with-the-prometheus-operator/#An_AWS_LoadBalancer_configuration" rel="noopener ugc nofollow" target="_blank">AWS负载平衡器配置</a></li></ul><h1 id="0ec9" class="lz lu iq bd ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp mq mr ms mt mu mv bi translated">普罗米修斯操作员部署</h1><p id="ea9a" class="pw-post-body-paragraph ju jv iq jw b jx mw jz ka kb mx kd ke kf nb kh ki kj nc kl km kn nd kp kq kr ij bi translated">用头盔展开它:</p><pre class="ll lm ln lo gt lp kw lq lr aw ls bi"><span id="f66e" class="lt lu iq kw b gy lv lw l lx ly">$ helm install — namespace monitoring — create-namespace prometheus stable/prometheus-operator<br/>manifest_sorter.go:192: info: skipping unknown hook: “crd-install”<br/>manifest_sorter.go:192: info: skipping unknown hook: “crd-install”<br/>manifest_sorter.go:192: info: skipping unknown hook: “crd-install”<br/>manifest_sorter.go:192: info: skipping unknown hook: “crd-install”<br/>manifest_sorter.go:192: info: skipping unknown hook: “crd-install”<br/>manifest_sorter.go:192: info: skipping unknown hook: “crd-install”<br/>NAME: prometheus<br/>LAST DEPLOYED: Mon Jun 15 17:54:27 2020<br/>NAMESPACE: monitoring<br/>STATUS: deployed<br/>REVISION: 1<br/>NOTES:<br/>The Prometheus Operator has been installed. Check its status by running:</span><span id="1d18" class="lt lu iq kw b gy ne lw l lx ly">kubectl — namespace monitoring get pods -l “release=prometheus”</span><span id="7d2d" class="lt lu iq kw b gy ne lw l lx ly">Visit <a class="ae ks" href="https://github.com/coreos/prometheus-operator" rel="noopener ugc nofollow" target="_blank">https://github.com/coreos/prometheus-operator</a> for instructions on how to create &amp; configure Alertmanager and Prometheus instances using the Operator.</span></pre><p id="165c" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">检查舱:</p><pre class="ll lm ln lo gt lp kw lq lr aw ls bi"><span id="bac0" class="lt lu iq kw b gy lv lw l lx ly">$ kk -n monitoring get pod<br/>NAME READY STATUS RESTARTS AGE<br/>alertmanager-prometheus-prometheus-oper-alertmanager-0 2/2 Running 0 41s<br/>prometheus-grafana-85c9fbc85c-ll58c 2/2 Running 0 46s<br/>prometheus-kube-state-metrics-66d969ff69–6b7t8 1/1 Running 0 46s<br/>prometheus-prometheus-node-exporter-89mf4 1/1 Running 0 46s<br/>prometheus-prometheus-node-exporter-bpn67 1/1 Running 0 46s<br/>prometheus-prometheus-node-exporter-l9wjm 1/1 Running 0 46s<br/>prometheus-prometheus-node-exporter-zk4cm 1/1 Running 0 46s<br/>prometheus-prometheus-oper-operator-7d5f8ff449-fl6x4 2/2 Running 0 46s<br/>prometheus-prometheus-prometheus-oper-prometheus-0 3/3 Running 1 31</span></pre><p id="e711" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated"><em class="nf">注:</em> <code class="fe kt ku kv kw b"><em class="nf">alias kk="kubectl" &gt;&gt; ~/.bashrc</em></code></p><p id="69a9" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">因此，Prometheus操作员的掌舵图创建了一整套服务——Prometheus本身、Alertmanager、Grafana，以及一组服务监视器:</p><pre class="ll lm ln lo gt lp kw lq lr aw ls bi"><span id="69f1" class="lt lu iq kw b gy lv lw l lx ly">$ kk -n monitoring get servicemonitor<br/>NAME AGE<br/>prometheus-prometheus-oper-alertmanager 3m53s<br/>prometheus-prometheus-oper-apiserver 3m53s<br/>prometheus-prometheus-oper-coredns 3m53s<br/>prometheus-prometheus-oper-grafana 3m53s<br/>prometheus-prometheus-oper-kube-controller-manager 3m53s<br/>prometheus-prometheus-oper-kube-etcd 3m53s<br/>prometheus-prometheus-oper-kube-proxy 3m53s<br/>prometheus-prometheus-oper-kube-scheduler 3m53s<br/>prometheus-prometheus-oper-kube-state-metrics 3m53s<br/>prometheus-prometheus-oper-kubelet 3m53s<br/>prometheus-prometheus-oper-node-exporter 3m53s<br/>prometheus-prometheus-oper-operator 3m53s<br/>prometheus-prometheus-oper-prometheus 3m53s</span></pre><p id="7de2" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">ServiceMonitors角色将在本帖子的<a class="ae ks" href="https://rtfm.co.ua/?p=24374#%D0%94%D0%BE%D0%B1%D0%B0%D0%B2%D0%BB%D0%B5%D0%BD%D0%B8%D0%B5_%D1%81%D0%B5%D1%80%D0%B2%D0%B8%D1%81%D0%B0_%D0%B2_%D0%BC%D0%BE%D0%BD%D0%B8%D1%82%D0%BE%D1%80%D0%B8%D0%BD%D0%B3" rel="noopener ugc nofollow" target="_blank">добавлениесеииавмисавмонитоииоииинг</a>部分进行回顾。</p><h2 id="a0b7" class="lt lu iq bd ma ng nh dn me ni nj dp mi kf nk nl mm kj nm nn mq kn no np mu nq bi translated">格拉夫纳入口</h2><p id="7450" class="pw-post-body-paragraph ju jv iq jw b jx mw jz ka kb mx kd ke kf nb kh ki kj nc kl km kn nd kp kq kr ij bi translated">让我们来看看Grafana附带了哪些仪表盘。</p><p id="557f" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">找到格拉夫纳的豆荚:</p><pre class="ll lm ln lo gt lp kw lq lr aw ls bi"><span id="6d97" class="lt lu iq kw b gy lv lw l lx ly">$ kk -n monitoring get pod<br/>NAME READY STATUS RESTARTS AGE<br/>alertmanager-prometheus-prometheus-oper-alertmanager-0 2/2 Running 0 103s<br/>prometheus-grafana-85c9fbc85c-wl856 2/2 Running 0 107s<br/>…</span></pre><p id="a969" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">运行<code class="fe kt ku kv kw b">port-forward</code>:</p><pre class="ll lm ln lo gt lp kw lq lr aw ls bi"><span id="d22f" class="lt lu iq kw b gy lv lw l lx ly">$ kk -n monitoring port-forward prometheus-grafana-85c9fbc85c-wl856 3000:3000<br/>Forwarding from 127.0.0.1:3000 -&gt; 3000<br/>Forwarding from [::1]:3000 -&gt; 3000</span></pre><p id="9854" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">打开<em class="nf"> localhost:3000 </em>，用<em class="nf"> admin </em>用户名和<em class="nf"> prom-operator </em>密码登录，你会看到很多准备好的用户图形:</p><figure class="ll lm ln lo gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="ns nt di nu bf nv"><div class="gh gi nr"><img src="../Images/43cb0ff4bf6565ac3988c877f44dc3ab.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*RyvV96uVTEg0TLpD.png"/></div></div></figure><p id="ff6f" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">在撰写本文时，Prometheus Operator的Grafana版本为7.0.3。</p><p id="584c" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">实际上，我们在这里不需要Grafana和Alertmanager，因为它们在我们的“中央”监控服务器上使用，所以让我们从这里删除它们。</p><h1 id="9dd1" class="lz lu iq bd ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp mq mr ms mt mu mv bi translated">普罗米修斯操作员配置</h1><p id="5017" class="pw-post-body-paragraph ju jv iq jw b jx mw jz ka kb mx kd ke kf nb kh ki kj nc kl km kn nd kp kq kr ij bi translated">Prometheus操作员使用<a class="ae ks" href="https://kubernetes.io/docs/concepts/extend-kubernetes/api-extension/custom-resources/" rel="noopener ugc nofollow" target="_blank">自定义资源定义</a>描述其所有组件:</p><pre class="ll lm ln lo gt lp kw lq lr aw ls bi"><span id="87f7" class="lt lu iq kw b gy lv lw l lx ly">$ kk -n monitoring get crd<br/>NAME CREATED AT<br/>alertmanagers.monitoring.coreos.com 2020–06–15T14:47:44Z<br/>eniconfigs.crd.k8s.amazonaws.com 2020–04–10T07:21:20Z<br/>podmonitors.monitoring.coreos.com 2020–06–15T14:47:45Z<br/>prometheuses.monitoring.coreos.com 2020–06–15T14:47:46Z<br/>prometheusrules.monitoring.coreos.com 2020–06–15T14:47:47Z<br/>servicemonitors.monitoring.coreos.com 2020–06–15T14:47:47Z<br/>thanosrulers.monitoring.coreos.com 2020–06–15T14:47:48Z</span></pre><p id="2efc" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">例如，<code class="fe kt ku kv kw b">prometheuses.monitoring.coreos.com</code> CRD描述了一个名为<em class="nf">普罗米修斯</em>的定制资源:</p><pre class="ll lm ln lo gt lp kw lq lr aw ls bi"><span id="9fea" class="lt lu iq kw b gy lv lw l lx ly">$ kk -n monitoring get crd prometheuses.monitoring.coreos.com -o yaml<br/>apiVersion: apiextensions.k8s.io/v1beta1<br/>kind: CustomResourceDefinition<br/>…<br/>spec:<br/>…<br/>names:<br/>kind: Prometheus<br/>listKind: PrometheusList<br/>plural: prometheuses<br/>singular: prometheus<br/>…</span></pre><p id="3a1a" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">然后，您可以通过使用<code class="fe kt ku kv kw b">names</code>字段中的名称，将该名称用作常见的Kubernetes对象，如pod、节点、卷等:</p><pre class="ll lm ln lo gt lp kw lq lr aw ls bi"><span id="c463" class="lt lu iq kw b gy lv lw l lx ly">$ kk -n monitoring get prometheus -o yaml<br/>apiVersion: v1<br/>items:<br/>- apiVersion: monitoring.coreos.com/v1<br/>kind: Prometheus<br/>metadata:<br/>annotations:<br/>meta.helm.sh/release-name: prometheus<br/>meta.helm.sh/release-namespace: monitoring<br/>…<br/>spec:<br/>alerting:<br/>alertmanagers:<br/>- apiVersion: v2<br/>name: prometheus-prometheus-oper-alertmanager<br/>namespace: monitoring<br/>pathPrefix: /<br/>port: web<br/>baseImage: quay.io/prometheus/prometheus<br/>enableAdminAPI: false<br/>externalUrl: <a class="ae ks" href="http://prometheus-prometheus-oper-prometheus.monitoring:9090" rel="noopener ugc nofollow" target="_blank">http://prometheus-prometheus-oper-prometheus.monitoring:9090</a><br/>listenLocal: false<br/>logFormat: logfmt<br/>logLevel: info<br/>paused: false<br/>podMonitorNamespaceSelector: {}<br/>podMonitorSelector:<br/>matchLabels:<br/>release: prometheus<br/>portName: web<br/>replicas: 1<br/>retention: 10d<br/>routePrefix: /<br/>ruleNamespaceSelector: {}<br/>ruleSelector:<br/>matchLabels:<br/>app: prometheus-operator<br/>release: prometheus<br/>securityContext:<br/>fsGroup: 2000<br/>runAsGroup: 2000<br/>runAsNonRoot: true<br/>runAsUser: 1000<br/>serviceAccountName: prometheus-prometheus-oper-prometheus<br/>serviceMonitorNamespaceSelector: {}<br/>serviceMonitorSelector:<br/>matchLabels:<br/>release: prometheus<br/>version: v2.18.1<br/>…</span></pre><p id="2caa" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">现在，我们感兴趣的是<code class="fe kt ku kv kw b">serviceMonitorSelector</code>记录:</p><pre class="ll lm ln lo gt lp kw lq lr aw ls bi"><span id="0b49" class="lt lu iq kw b gy lv lw l lx ly">...<br/>serviceMonitorSelector: <br/>  matchLabels:<br/>    release: prometheus</span></pre><p id="c3b7" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">它定义了在集群中Prometheus服务器的观察下将添加哪些ServiceMonitors。</p><h2 id="b666" class="lt lu iq bd ma ng nh dn me ni nj dp mi kf nk nl mm kj nm nn mq kn no np mu nq bi translated">添加受监控的新应用程序</h2><p id="f262" class="pw-post-body-paragraph ju jv iq jw b jx mw jz ka kb mx kd ke kf nb kh ki kj nc kl km kn nd kp kq kr ij bi translated">现在，让我们尝试在监控下添加一个额外的服务:</p><ol class=""><li id="30df" class="kx ky iq jw b jx jy kb kc kf kz kj la kn lb kr nw ld le lf bi translated">启动Redis服务器</li><li id="e490" class="kx ky iq jw b jx lg kb lh kf li kj lj kn lk kr nw ld le lf bi translated">还有<code class="fe kt ku kv kw b">redis_exporter</code></li><li id="5f7b" class="kx ky iq jw b jx lg kb lh kf li kj lj kn lk kr nw ld le lf bi translated">将添加ServiceMonitor</li><li id="611d" class="kx ky iq jw b jx lg kb lh kf li kj lj kn lk kr nw ld le lf bi translated">最后，我们将配置Prometheus Operator使用ServiceMonitor从<code class="fe kt ku kv kw b">redis_exporter</code>收集指标</li></ol><h2 id="a8bd" class="lt lu iq bd ma ng nh dn me ni nj dp mi kf nk nl mm kj nm nn mq kn no np mu nq bi translated">Redis服务器启动</h2><p id="1dab" class="pw-post-body-paragraph ju jv iq jw b jx mw jz ka kb mx kd ke kf nb kh ki kj nc kl km kn nd kp kq kr ij bi translated">当被监视的应用程序位于一个命名空间中，而监视服务位于另一个命名空间中时，创建一个命名空间以使这种设置更加真实:</p><pre class="ll lm ln lo gt lp kw lq lr aw ls bi"><span id="0552" class="lt lu iq kw b gy lv lw l lx ly">$ kk create ns redis-test<br/>namespace/redis-test created</span></pre><p id="1364" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">运行Redis:</p><pre class="ll lm ln lo gt lp kw lq lr aw ls bi"><span id="f773" class="lt lu iq kw b gy lv lw l lx ly">$ kk -n redis-test run redis — image=redis<br/>deployment.apps/redis created</span></pre><p id="bf1e" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">为Redis网络通信创建服务对象:</p><pre class="ll lm ln lo gt lp kw lq lr aw ls bi"><span id="ebaa" class="lt lu iq kw b gy lv lw l lx ly">$ kk -n redis-test expose deploy redis — type=ClusterIP — name redis-svc — port 6379<br/>service/redis-svc exposed</span></pre><p id="4836" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">检查一下:</p><pre class="ll lm ln lo gt lp kw lq lr aw ls bi"><span id="aaaf" class="lt lu iq kw b gy lv lw l lx ly">$ kk -n redis-test get svc redis-svc<br/>NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE<br/>redis-svc ClusterIP 172.20.237.116 &lt;none&gt; 6379/TCP 25s</span></pre><p id="15c2" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">好的— Redis正在工作，现在让我们添加它的Prometheus exporter。</p><h2 id="11fd" class="lt lu iq bd ma ng nh dn me ni nj dp mi kf nk nl mm kj nm nn mq kn no np mu nq bi translated"><code class="fe kt ku kv kw b">redis_exporter</code>启动</h2><p id="2e1c" class="pw-post-body-paragraph ju jv iq jw b jx mw jz ka kb mx kd ke kf nb kh ki kj nc kl km kn nd kp kq kr ij bi translated">用舵安装:</p><pre class="ll lm ln lo gt lp kw lq lr aw ls bi"><span id="45dd" class="lt lu iq kw b gy lv lw l lx ly">$ helm install -n monitoring redis-exporter — set “redisAddress=redis://redis-svc.redis-test.svc.cluster.local:6379” stable/prometheus-redis-exporter</span></pre><p id="1e87" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">检查其服务:</p><pre class="ll lm ln lo gt lp kw lq lr aw ls bi"><span id="8a57" class="lt lu iq kw b gy lv lw l lx ly">$ kk -n monitoring get svc<br/>NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE<br/>alertmanager-operated ClusterIP None &lt;none&gt; 9093/TCP,9094/TCP,9094/UDP 89m<br/>…<br/>redis-exporter-prometheus-redis-exporter ClusterIP 172.20.239.67 &lt;none&gt; 9121/TCP 84s</span></pre><p id="6c98" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">它的终点:</p><pre class="ll lm ln lo gt lp kw lq lr aw ls bi"><span id="0639" class="lt lu iq kw b gy lv lw l lx ly">$ kk -n monitoring get endpoints redis-exporter-prometheus-redis-exporter -o yaml<br/>apiVersion: v1<br/>kind: Endpoints<br/>metadata:<br/>…<br/>labels:<br/>app: prometheus-redis-exporter<br/>app.kubernetes.io/managed-by: Helm<br/>chart: prometheus-redis-exporter-3.4.1<br/>heritage: Helm<br/>release: redis-exporter<br/>name: redis-exporter-prometheus-redis-exporter<br/>namespace: monitoring<br/>…<br/>ports:<br/>- name: redis-exporter<br/>port: 9121<br/>protocol: TCP</span></pre><p id="5e81" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">转到检查指标—旋转一个新的pod，例如用Debian，并安装<code class="fe kt ku kv kw b">curl</code>:</p><pre class="ll lm ln lo gt lp kw lq lr aw ls bi"><span id="b63e" class="lt lu iq kw b gy lv lw l lx ly">$ kk -n monitoring run — rm -ti debug — image=debian — restart=Never bash</span></pre><p id="8ac8" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">如果看不到命令提示符，请尝试按enter键。</p><pre class="ll lm ln lo gt lp kw lq lr aw ls bi"><span id="007c" class="lt lu iq kw b gy lv lw l lx ly">root@debug:/# apt update &amp;&amp; apt -y install curl</span></pre><p id="4abd" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">并向<code class="fe kt ku kv kw b">redis_exporter</code>提出要求:</p><pre class="ll lm ln lo gt lp kw lq lr aw ls bi"><span id="7fcb" class="lt lu iq kw b gy lv lw l lx ly">root@debug:/# curl redis-exporter-prometheus-redis-exporter:9121/metrics<br/>…<br/>HELP redis_up Information about the Redis instance<br/>TYPE redis_up gauge<br/>redis_up 1<br/>HELP redis_uptime_in_seconds uptime_in_seconds metric<br/>TYPE redis_uptime_in_seconds gauge<br/>redis_uptime_in_seconds 2793</span></pre><p id="d829" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">或者没有额外的端口—只需将<code class="fe kt ku kv kw b">port-forward</code>运行到<code class="fe kt ku kv kw b">redis-svc</code>:</p><pre class="ll lm ln lo gt lp kw lq lr aw ls bi"><span id="4bb1" class="lt lu iq kw b gy lv lw l lx ly">$ kk -n monitoring port-forward svc/redis-exporter-prometheus-redis-exporter 9121:9121<br/>Forwarding from 127.0.0.1:9121 -&gt; 9121<br/>Forwarding from [::1]:9121 -&gt; 9121</span></pre><p id="50e9" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">并从本地PC运行:</p><pre class="ll lm ln lo gt lp kw lq lr aw ls bi"><span id="5823" class="lt lu iq kw b gy lv lw l lx ly">$ curl localhost:9121/metrics<br/>…<br/>redis_up 1<br/>HELP redis_uptime_in_seconds uptime_in_seconds metric<br/>TYPE redis_uptime_in_seconds gauge<br/>redis_uptime_in_seconds 8818</span></pre><p id="5060" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">好的——我们已经有了Redis服务器应用程序及其Prometheus exporter，通过<code class="fe kt ku kv kw b">/metrics</code> URI和9121端口可以获得指标。</p><p id="66c7" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">下一件事是配置Prometheus Operator将这些指标收集到它的数据库中，以便以后通过Prometheus federation由“中央”监控提取这些指标。</p><h2 id="b321" class="lt lu iq bd ma ng nh dn me ni nj dp mi kf nk nl mm kj nm nn mq kn no np mu nq bi translated">添加Kubernetes ServiceMonitor</h2><p id="3cb8" class="pw-post-body-paragraph ju jv iq jw b jx mw jz ka kb mx kd ke kf nb kh ki kj nc kl km kn nd kp kq kr ij bi translated">检查我们的<code class="fe kt ku kv kw b">redis_exporter</code>标签:</p><pre class="ll lm ln lo gt lp kw lq lr aw ls bi"><span id="13eb" class="lt lu iq kw b gy lv lw l lx ly">$ kk -n monitoring get deploy redis-exporter-prometheus-redis-exporter -o yaml<br/>apiVersion: extensions/v1beta1<br/>kind: Deployment<br/>metadata:<br/>…<br/>generation: 1<br/>labels:<br/>app: prometheus-redis-exporter<br/>app.kubernetes.io/managed-by: Helm<br/>chart: prometheus-redis-exporter-3.4.1<br/>heritage: Helm<br/>release: redis-exporter<br/>…</span></pre><p id="f75e" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">并检查上面创建的<code class="fe kt ku kv kw b">prometheus</code>资源的<code class="fe kt ku kv kw b">serviceMonitorSelector</code>选择器:</p><pre class="ll lm ln lo gt lp kw lq lr aw ls bi"><span id="8a26" class="lt lu iq kw b gy lv lw l lx ly">$ kk -n monitoring get prometheus -o yaml</span></pre><p id="09b4" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">在输出的末尾，找到以下几行:</p><pre class="ll lm ln lo gt lp kw lq lr aw ls bi"><span id="8f0c" class="lt lu iq kw b gy lv lw l lx ly">...<br/>serviceMonitorSelector: <br/>  matchLabels:<br/>    release: prometheus</span></pre><p id="8207" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">因此，Prometheus将寻找带有<em class="nf"> release </em>标签和<em class="nf"> prometheus </em>值的<code class="fe kt ku kv kw b">ServiceMonitors</code>。</p><p id="acdf" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">创建一个额外的<code class="fe kt ku kv kw b">ServiceMonitor</code>:</p><pre class="ll lm ln lo gt lp kw lq lr aw ls bi"><span id="1dd2" class="lt lu iq kw b gy lv lw l lx ly">apiVersion: monitoring.coreos.com/v1<br/>kind: ServiceMonitor<br/>metadata:<br/>  labels:<br/>    serviceapp: redis-servicemonitor<br/>    release: prometheus<br/>  name: redis-servicemonitor<br/>  namespace: monitoring<br/>spec:<br/>  endpoints:<br/>  - bearerTokenFile: /var/run/secrets/kubernetes.io/serviceaccount/token<br/>    interval: 15s<br/>    port: redis-exporter<br/>  namespaceSelector:<br/>    matchNames:<br/>    - monitoring<br/>  selector:<br/>    matchLabels:<br/>      release: redis-exporter</span></pre><p id="4699" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">在它的<code class="fe kt ku kv kw b">labels</code>中，我们设置了<em class="nf"> release: prometheus </em>以便prometheus可以找到它，并在<code class="fe kt ku kv kw b">selector.matchLabels</code>中指定查找任何标记为<em class="nf"> release: redis-exporter </em>的服务。</p><p id="453b" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">应用它:</p><pre class="ll lm ln lo gt lp kw lq lr aw ls bi"><span id="67b4" class="lt lu iq kw b gy lv lw l lx ly">$ kk -n monitoring apply -f redis-service-monitor.yaml<br/>servicemonitor.monitoring.coreos.com/redis-servicemonitor created</span></pre><p id="215f" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">检查普罗米修斯的目标:</p><figure class="ll lm ln lo gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="ns nt di nu bf nv"><div class="gh gi nx"><img src="../Images/c163285e5a3b052ae1da425650ba70fd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*9vzT3mFXtyhz-KsO.png"/></div></div></figure><p id="dcc4" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">Redis服务器指标:</p><figure class="ll lm ln lo gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="ns nt di nu bf nv"><div class="gh gi ny"><img src="../Images/fdd8d19f05e7dabccb07f83a0d1d857b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*P5-HWn3y_0mOIPcG.png"/></div></div></figure><p id="bc65" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">太好了——“管用！”</p><p id="9367" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">下一步是什么？</p><p id="739c" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">接下来要做的是从我们的Prometheus操作员堆栈中删除Alertmanager和Grafana。</p><h1 id="d464" class="lz lu iq bd ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp mq mr ms mt mu mv bi translated">普罗米修斯操作员头盔部署及其服务配置</h1><p id="2641" class="pw-post-body-paragraph ju jv iq jw b jx mw jz ka kb mx kd ke kf nb kh ki kj nc kl km kn nd kp kq kr ij bi translated">实际上，为什么需要移除Grafana？它已经准备好了非常有用的仪表板，所以就让它留在那里吧。</p><p id="60c0" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">更好的方法似乎是:</p><ul class=""><li id="b779" class="kx ky iq jw b jx jy kb kc kf kz kj la kn lb kr lc ld le lf bi translated">在每艘EKS上，我们将配备普罗米修斯操作员，但没有警报器管理器</li><li id="8979" class="kx ky iq jw b jx lg kb lh kf li kj lj kn lk kr lc ld le lf bi translated">在集群的本地Prometheus服务器上，我们将存储指标的默认保留期设置为2周</li><li id="3f8d" class="kx ky iq jw b jx lg kb lh kf li kj lj kn lk kr lc ld le lf bi translated">将从那里删除Alertmanager——将使用我们的“中央”监控alert manager和已经定义的路由和警报(有关路由的详细信息，请参见<a class="ae ks" href="https://rtfm.co.ua/en/prometheus-alertmanagers-alerts-receivers-and-routing-based-on-severity-level-and-tags/" rel="noopener ugc nofollow" target="_blank"> Prometheus: Alertmanager的警报接收器和基于严重性级别和标签的路由</a>帖子)</li><li id="4890" class="kx ky iq jw b jx lg kb lh kf li kj lj kn lk kr lc ld le lf bi translated">在中央监控服务器上，我们将保留我们的指标一年，并将在那里放置一些Grafana仪表板</li></ul><p id="b360" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">因此，我们需要添加两个负载平衡器——一个用于Grafana服务的<em class="nf">面向互联网的</em>类型，另一个用于Prometheus的<em class="nf">内部</em>类型，因为它将通过<a class="ae ks" href="https://rtfm.co.ua/aws-nastrojka-vpc-peering/" rel="noopener ugc nofollow" target="_blank"> AWS VPC对等</a>与我们的中央监控主机通信。</p><p id="f419" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">稍后我们需要将它添加到我们的自动化中— <a class="ae ks" href="https://rtfm.co.ua/en/aws-elastic-kubernetes-service-a-cluster-creation-automation-part-2-ansible-eksctl/" rel="noopener ugc nofollow" target="_blank"> AWS Elastic Kubernetes服务:集群创建自动化，第2部分— Ansible，eksctl </a>。</p><p id="37f2" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">但是现在，让我们手动操作。</p><p id="045a" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">那么，我们需要改变普罗米修斯操作者的默认部署吗？</p><ul class=""><li id="88a3" class="kx ky iq jw b jx jy kb kc kf kz kj la kn lb kr lc ld le lf bi translated">丢弃警报管理器</li><li id="38c6" class="kx ky iq jw b jx lg kb lh kf li kj lj kn lk kr lc ld le lf bi translated">添加设置:</li><li id="e6e1" class="kx ky iq jw b jx lg kb lh kf li kj lj kn lk kr lc ld le lf bi translated">Prometheus和Grafana —它们必须部署在AWS负载平衡器之后</li><li id="00b3" class="kx ky iq jw b jx lg kb lh kf li kj lj kn lk kr lc ld le lf bi translated">设置登录:通过логин-парольдля·格拉夫纳</li></ul><p id="04b9" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">所有可用的选项都可以在文档中找到—<a class="ae ks" href="https://github.com/helm/charts/tree/master/stable/prometheus-operator" rel="noopener ugc nofollow" target="_blank">https://github . com/helm/charts/tree/master/stable/Prometheus-operator</a>。</p><p id="9703" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">目前，我们从移除Alertmanager开始。</p><p id="0b0b" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">为此需要传递<code class="fe kt ku kv kw b">alertmanager.enabled</code>参数。</p><p id="7c73" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">现在检查它的吊舱:</p><pre class="ll lm ln lo gt lp kw lq lr aw ls bi"><span id="5947" class="lt lu iq kw b gy lv lw l lx ly">$ kk -n monitoring get pod<br/>NAME READY STATUS RESTARTS AGE<br/>alertmanager-prometheus-prometheus-oper-alertmanager-0 2/2 Running 0 24h<br/>…</span></pre><p id="af2b" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">重新部署它，并通过<code class="fe kt ku kv kw b">--set</code>指定<em class="nf">alert manager . enabled = false</em>:</p><pre class="ll lm ln lo gt lp kw lq lr aw ls bi"><span id="ae64" class="lt lu iq kw b gy lv lw l lx ly">$ helm upgrade — install — namespace monitoring — create-namespace prometheus stable/prometheus-operator — set “alertmanager.enabled=false”</span></pre><p id="64a9" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">再次检查窗格—堆栈中现在不能有任何警报管理器。</p><h2 id="b833" class="lt lu iq bd ma ng nh dn me ni nj dp mi kf nk nl mm kj nm nn mq kn no np mu nq bi translated">AWS负载平衡器配置</h2><p id="1c03" class="pw-post-body-paragraph ju jv iq jw b jx mw jz ka kb mx kd ke kf nb kh ki kj nc kl km kn nd kp kq kr ij bi translated">为了让我们的Grafana在互联网上对外可用，我们需要为Grafana添加一个<code class="fe kt ku kv kw b">Ingress</code>资源，为Prometheus添加一个专用的<code class="fe kt ku kv kw b">Ingress</code>。</p><p id="ed17" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">我们在文档中有什么:</p><p id="8d45" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated"><code class="fe kt ku kv kw b">grafana.ingress.enabled</code>启用Grafana的入口<code class="fe kt ku kv kw b">false</code> <code class="fe kt ku kv kw b">grafana.ingress.hosts</code>入口接受Grafana的主机名<code class="fe kt ku kv kw b">[]</code></p><p id="6f2d" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">为Grafana添加<code class="fe kt ku kv kw b">Ingress</code>:</p><pre class="ll lm ln lo gt lp kw lq lr aw ls bi"><span id="a044" class="lt lu iq kw b gy lv lw l lx ly">$ helm upgrade — install — namespace monitoring — create-namespace prometheus stable/prometheus-operator — set “alertmanager.enabled=false” — set grafana.ingress.enabled=true<br/>…<br/>Error: UPGRADE FAILED: failed to create resource: Ingress.extensions “prometheus-grafana” is invalid: spec: Invalid value: []networking.IngressRule(nil): either `backend` or `rules` must be specified</span></pre><p id="9293" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">呃…</p><p id="7581" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">文档中没有提到负载平衡器的配置，但是我在Jupyter的文档中搜索了一些。</p><p id="4d12" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">让我们试试吧——现在通过<code class="fe kt ku kv kw b">values.yaml</code>文件来避免一堆<code class="fe kt ku kv kw b">--set</code>。</p><p id="ff12" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">将<code class="fe kt ku kv kw b">hosts</code>添加到文件中:</p><pre class="ll lm ln lo gt lp kw lq lr aw ls bi"><span id="ee60" class="lt lu iq kw b gy lv lw l lx ly">grafana:<br/>  ingress:<br/>    enabled: true<br/>    annotations:<br/>      kubernetes.io/ingress.class: "alb"<br/>      alb.ingress.kubernetes.io/scheme: "internet-facing"<br/>    hosts:<br/>      - "dev-0.eks.monitor.example.com"</span></pre><p id="508b" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">部署:</p><pre class="ll lm ln lo gt lp kw lq lr aw ls bi"><span id="c78f" class="lt lu iq kw b gy lv lw l lx ly">$ helm upgrade — install — namespace monitoring — create-namespace prometheus stable/prometheus-operator -f oper.yaml</span></pre><p id="f68c" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">检查<a class="ae ks" href="https://rtfm.co.ua/en/aws-elastic-kubernetes-service-running-alb-ingress-controller/" rel="noopener ugc nofollow" target="_blank"> Kubernetes ALB控制器</a>日志:</p><blockquote class="nz oa ob"><p id="f001" class="ju jv nf jw b jx jy jz ka kb kc kd ke oc kg kh ki od kk kl km oe ko kp kq kr ij bi translated">I 0617 11:37:48.272749 1 tags . go:43]monitoring/Prometheus-graf ana:修改标签{ ingress.k8s.aws/cluster: " bttrm-eks-dev-0 "、ingress.k8s.aws/stack: " monitoring/Prometheus-graf ana "、kubernetes.io/service-name: " Prometheus-grafa<br/>na "、kubernetes.io/service-port: " 80 "、ingress.k8s.aws/resource: " monitoring/Prometheus-graf ana-graf ana:80 "、kubernetes.io/cluster/bttrm-eks-dev-0: " owned "、kubernetes.io/namespace: " monitoring "、kubernetes.io/ingress-name<br/>:" Prometheus-graf ana " } on arn:AWS</p></blockquote><p id="89af" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">好的—添加<code class="fe kt ku kv kw b">/target-type: "ip"</code>以便AWS ALB将流量直接发送到Grafana的pod，而不是WorkerNodes端口，让我们添加有效的HTTP代码:</p><pre class="ll lm ln lo gt lp kw lq lr aw ls bi"><span id="0f00" class="lt lu iq kw b gy lv lw l lx ly">grafana:<br/>  ingress:<br/>    enabled: true<br/>    annotations:<br/>      kubernetes.io/ingress.class: "alb"  <br/>      alb.ingress.kubernetes.io/scheme: "internet-facing"<br/>      alb.ingress.kubernetes.io/target-type: "ip"<br/>      alb.ingress.kubernetes.io/success-codes: 200,302<br/>    hosts:<br/>      - "dev-0.eks.monitor.example.com"</span></pre><p id="d88f" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">或者换一种方式—重新配置Grafana的服务以使用<code class="fe kt ku kv kw b">NodePort</code>:</p><pre class="ll lm ln lo gt lp kw lq lr aw ls bi"><span id="23ad" class="lt lu iq kw b gy lv lw l lx ly">grafana:<br/>  service:<br/>    type: NodePort<br/>    port: 80<br/>    annotations: {}<br/>    labels: {}  <br/>  ingress:<br/>    enabled: true<br/>    annotations:<br/>      kubernetes.io/ingress.class: "alb"<br/>      alb.ingress.kubernetes.io/scheme: "internet-facing"<br/>      alb.ingress.kubernetes.io/success-codes: 200,302<br/>    hosts:<br/>      - "dev-0.eks.monitor.example.com"</span></pre><p id="f600" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">重新部署运营商的堆栈:</p><pre class="ll lm ln lo gt lp kw lq lr aw ls bi"><span id="afe0" class="lt lu iq kw b gy lv lw l lx ly">$ helm upgrade — install — namespace monitoring — create-namespace prometheus stable/prometheus-operator -f oper.yaml</span></pre><p id="2f13" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">等待一分钟，然后再次检查AWS负载平衡器:</p><pre class="ll lm ln lo gt lp kw lq lr aw ls bi"><span id="d720" class="lt lu iq kw b gy lv lw l lx ly">$ kk -n monitoring get ingress<br/>NAME HOSTS ADDRESS PORTS AGE<br/>prometheus-grafana dev-0.eks.monitor.example.com 96759da8-monitoring-promet-***.us-east-2.elb.amazonaws.com 80 30m</span></pre><p id="2b03" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">但是现在<em class="nf">dev-0.eks.monitor.example.com</em>将从我们的负载平衡器返回404代码:</p><pre class="ll lm ln lo gt lp kw lq lr aw ls bi"><span id="c7dc" class="lt lu iq kw b gy lv lw l lx ly">$ curl -vL dev-0.eks.monitor.example.com<br/>* Trying 3.***.***.247:80…<br/>* Connected to dev-0.eks.monitor.example.com (3.***.***.247) port 80 (#0)<br/>&gt; GET / HTTP/1.1<br/>&gt; Host: dev-0.eks.monitor.example.com<br/>&gt; User-Agent: curl/7.70.0<br/>&gt; Accept: */*<br/>&gt;<br/>* Mark bundle as not supporting multiuse<br/>&lt; HTTP/1.1 302 Found<br/>…<br/>&lt; Location: /login<br/>…<br/>* Connection #0 to host dev-0.eks.monitor.example.com left intact<br/>* Issue another request to this URL: ‘http://dev-0.eks.monitor.example.com/login'<br/>…<br/>&gt; GET /login HTTP/1.1<br/>…<br/>&lt; HTTP/1.1 404 Not Found<br/>&lt; Server: awselb/2.0</span></pre><p id="1a5f" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">为什么会这样？</p><ol class=""><li id="bece" class="kx ky iq jw b jx jy kb kc kf kz kj la kn lb kr nw ld le lf bi translated">ALB接受对<em class="nf">dev-0.eks.monitor.example.com</em>URL的请求，并将其重定向到带有Grafana pod的WorkerNodes TargetGroup</li><li id="3cc7" class="kx ky iq jw b jx lg kb lh kf li kj lj kn lk kr nw ld le lf bi translated">Grafana将302重定向代码返回给<code class="fe kt ku kv kw b">/login</code> URI</li><li id="9734" class="kx ky iq jw b jx lg kb lh kf li kj lj kn lk kr nw ld le lf bi translated">该请求将返回到ALB，但此时使用的是<code class="fe kt ku kv kw b">/login</code> URI</li></ol><p id="0f8a" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">检查ALB的监听器规则:</p><figure class="ll lm ln lo gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="ns nt di nu bf nv"><div class="gh gi of"><img src="../Images/9593b093b06eb6c8df22f2dbcae6df98.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*U6-krw-Np32baoA2.png"/></div></div></figure><p id="d2ea" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">好了，就是这样——我们将为任何URI请求返回404代码，除了<code class="fe kt ku kv kw b">/</code>。相应地，<code class="fe kt ku kv kw b">/login</code>请求也将随着404一起被丢弃。</p><p id="c787" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">我想看看开发者的评论，他们把这个设置为<code class="fe kt ku kv kw b">path</code>的默认行为。</p><p id="8149" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">回到我们的<code class="fe kt ku kv kw b">values.yaml</code>，将<code class="fe kt ku kv kw b">path</code>从<code class="fe kt ku kv kw b">/</code>更换到<code class="fe kt ku kv kw b">/*</code>。</p><p id="c543" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">并更新а<code class="fe kt ku kv kw b">hosts</code>以避免“<strong class="jw ir"> <em class="nf">无效值:【联网】。Ingres rule(nil):必须指定“后端”或“规则”</em> </strong>"错误。</p><p id="1a53" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">为了不将自己与任何特定的域名捆绑在一起，将其设置为<code class="fe kt ku kv kw b">""</code>值:</p><pre class="ll lm ln lo gt lp kw lq lr aw ls bi"><span id="366f" class="lt lu iq kw b gy lv lw l lx ly">grafana:<br/>  ingress:<br/>    enabled: true<br/>    annotations:<br/>      kubernetes.io/ingress.class: "alb"<br/>      alb.ingress.kubernetes.io/target-type: "ip"<br/>      alb.ingress.kubernetes.io/scheme: "internet-facing"<br/>      alb.ingress.kubernetes.io/success-codes: 200,302<br/>    hosts:<br/>      - ""<br/>    path: /*</span></pre><p id="b562" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">重新部署，检查:</p><pre class="ll lm ln lo gt lp kw lq lr aw ls bi"><span id="e5ab" class="lt lu iq kw b gy lv lw l lx ly">$ kk -n monitoring get ingress<br/>NAME HOSTS ADDRESS PORTS AGE<br/>prometheus-grafana * 96759da8-monitoring-promet-bb6c-2076436438.us-east-2.elb.amazonaws.com 80 15m</span></pre><p id="6780" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">在浏览器中打开:</p><figure class="ll lm ln lo gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="ns nt di nu bf nv"><div class="gh gi nr"><img src="../Images/091c7b46dc72e2ae7652bbc0ea554b9f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*2mcN9NQXOsD7fnY2.png"/></div></div></figure><p id="c7fb" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">更重要的是，现在我们能够看到我们的开发人员使用的<a class="ae ks" href="https://github.com/lensapp/lens" rel="noopener ugc nofollow" target="_blank">镜头</a>实用程序中的所有图形，之前他们得到了“<strong class="jw ir"> <em class="nf">指标不可用，原因是缺少或无效的普罗米修斯配置</em></strong>【и】<strong class="jw ir"><em class="nf">指标此刻不可用</em> </strong>”错误消息:</p><figure class="ll lm ln lo gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="ns nt di nu bf nv"><div class="gh gi og"><img src="../Images/bd7d8965697a460c486fff9602cca0a2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*HmC2rTyiRln7GZ19.png"/></div></div></figure><p id="d3b8" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">实际上，这就是开始使用Prometheus Operator监视您的Kubernetes集群的全部内容</p><h1 id="409e" class="lz lu iq bd ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp mq mr ms mt mu mv bi translated">有用的链接</h1><ul class=""><li id="5772" class="kx ky iq jw b jx mw kb mx kf my kj mz kn na kr lc ld le lf bi translated"><a class="ae ks" href="https://sysdig.com/blog/kubernetes-monitoring-prometheus-operator-part3/" rel="noopener ugc nofollow" target="_blank"> Kubernetes用Prometheus监控——Prometheus操作员教程</a></li><li id="a499" class="kx ky iq jw b jx lg kb lh kf li kj lj kn lk kr lc ld le lf bi translated"><a class="ae ks" href="https://kruschecompany.com/kubernetes-prometheus-operator/" rel="noopener ugc nofollow" target="_blank"> Prometheus操作员—在Kubernetes环境中安装Prometheus监控系统</a></li><li id="6d5c" class="kx ky iq jw b jx lg kb lh kf li kj lj kn lk kr lc ld le lf bi translated"><a class="ae ks" href="https://docs.couchbase.com/operator/current/tutorial-prometheus.html" rel="noopener ugc nofollow" target="_blank">快速启动普罗米修斯监控</a></li><li id="2be8" class="kx ky iq jw b jx lg kb lh kf li kj lj kn lk kr lc ld le lf bi translated"><a class="ae ks" href="https://devops.college/prometheus-operator-how-to-monitor-an-external-service-3cb6ac8d5acb" rel="noopener ugc nofollow" target="_blank"> Prometheus运营商——如何监控外部服务</a></li><li id="73d6" class="kx ky iq jw b jx lg kb lh kf li kj lj kn lk kr lc ld le lf bi translated"><a class="ae ks" href="https://www.digitalocean.com/community/tutorials/how-to-set-up-digitalocean-kubernetes-cluster-monitoring-with-helm-and-prometheus-operator" rel="noopener ugc nofollow" target="_blank">如何用Helm和Prometheus操作员设置数字海洋Kubernetes集群监控</a></li><li id="e4fc" class="kx ky iq jw b jx lg kb lh kf li kj lj kn lk kr lc ld le lf bi translated"><a class="ae ks" href="https://medium.com/zolo-engineering/configuring-prometheus-operator-helm-chart-with-aws-eks-c12fac3b671a" rel="noopener">用自动气象站EKS配置普罗米修斯操作员舵图</a></li><li id="f917" class="kx ky iq jw b jx lg kb lh kf li kj lj kn lk kr lc ld le lf bi translated"><a class="ae ks" href="https://zero-to-jupyterhub.readthedocs.io/en/latest/administrator/advanced.html#ingress" rel="noopener ugc nofollow" target="_blank">零到JupyterHub与Kubernetes </a></li><li id="66bf" class="kx ky iq jw b jx lg kb lh kf li kj lj kn lk kr lc ld le lf bi translated"><a class="ae ks" href="https://github.com/helm/charts/issues/11471" rel="noopener ugc nofollow" target="_blank">如何用nginx入口暴露prometheus、grafana和alertmanager】</a></li><li id="e522" class="kx ky iq jw b jx lg kb lh kf li kj lj kn lk kr lc ld le lf bi translated"><a class="ae ks" href="https://github.com/kubernetes-sigs/aws-alb-ingress-controller/issues/1053" rel="noopener ugc nofollow" target="_blank">如何使用nginx ingressEKS公开prometheus、grafana和alertmanager:由于没有匹配关键字的对象，无法加载serviceAnnotation，因此无法协调target groups</a></li></ul></div><div class="ab cl oh oi hu oj" role="separator"><span class="ok bw bk ol om on"/><span class="ok bw bk ol om on"/><span class="ok bw bk ol om"/></div><div class="ij ik il im in"><p id="ab71" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated"><em class="nf">最初发布于</em> <a class="ae ks" href="https://rtfm.co.ua/en/kubernetes-a-clusters-monitoring-with-the-prometheus-operator/" rel="noopener ugc nofollow" target="_blank"> <em class="nf"> RTFM: Linux、DevOps、系统管理</em> </a> <em class="nf">。</em></p></div></div>    
</body>
</html>