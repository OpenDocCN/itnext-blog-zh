<html>
<head>
<title>Use EC2 Spot Instances For Production Web Servers</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">将EC2 Spot实例用于生产Web服务器</h1>
<blockquote>原文：<a href="https://itnext.io/use-ec2-spot-instances-for-production-web-servers-1e40e774652b?source=collection_archive---------4-----------------------#2022-02-06">https://itnext.io/use-ec2-spot-instances-for-production-web-servers-1e40e774652b?source=collection_archive---------4-----------------------#2022-02-06</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="6c6c" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">下面是如何在保持可靠性的同时使用AWS Spot实例。</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/a5f9e22a84887320e39b8151659933f1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*hsUUYbFBefjgtzTK"/></div></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">托马斯·詹森在<a class="ae ky" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</figcaption></figure><p id="ba91" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果您熟悉EC2 Spot实例，这个标题可能会显得非常矛盾。然而，<strong class="lb iu">却是真的</strong>。您<strong class="lb iu">可以</strong>使用spot实例进行生产<strong class="lb iu">，同时保持稳定的web服务</strong>！是的，我说的是web服务器，比如fastify、express、jetty等等。</p><p id="e5f9" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这正是我在上周发布的最新SaaS<a class="ae ky" href="https://speedyshot.com/?ref=md" rel="noopener ugc nofollow" target="_blank">SpeedyShot.com</a>中所做的——一个PDF生成、网页截图和抓取服务。大部分服务运行在EC2 spot实例上——对用户的影响非常小。</p><p id="344d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">相反，在spot实例上运行服务允许您用更少的钱运行更多的实例，实际上增强了用户体验。</p><p id="42f2" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我将在本文中解释的技巧特别适用于新的web服务，但也可以适用于现有的服务。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="76bb" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">什么是EC2 Spot实例？</h1><p id="1ffc" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">如果您可能不知道什么是spot实例，这里有一个快速复习。</p><p id="013b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">EC2实例可以通过不同的方式计费。通常的方法是拥有按需实例。一旦您请求，这些实例将随时可供您使用。</p><p id="f5b4" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">定点实例的工作方式不同。您可以随时请求spot实例，但是AWS也可以随时中断它，几乎没有时间处理中断。计费价格取决于AWS当时拥有的免费资源数量。使用spot实例通常可以节省大约70%的成本。</p><p id="8792" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">例如，在撰写本文时，以下是一些现货与按需价格:</p><p id="615a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><strong class="lb iu"> c3.large </strong>:点播:$ 0.12；现货:0.03美元；每小时。<br/> <strong class="lb iu"> t4g.micro </strong>:点播:$ 0.009；现货:0.002美元；每小时。<br/> <strong class="lb iu"> t4g.large </strong>:点播:$ 0.07；现货:0.02美元；每小时。</p><p id="e061" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">你可以在这个AWS页面上找到<a class="ae ky" href="https://aws.amazon.com/ec2/spot/pricing/" rel="noopener ugc nofollow" target="_blank">完整的现货定价。</a></p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="3b34" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">但是Spot实例不稳定？</h1><p id="a47e" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">对于spot实例有一个警告，因为AWS可以随时中断您的实例，这也意味着任何正在进行的处理都可能丢失。无论是处理新用户注册、发送电子邮件还是处理付款。这是不对的！</p><p id="4fd4" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">有趣的部分来了，在生产中仍然能够使用spot实例的技巧。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="f18e" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">服务路由架构</h1><p id="0a50" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">现在是时候将web服务的路由组织成两类了。</p><ul class=""><li id="3294" class="mz na it lb b lc ld lf lg li nb lm nc lq nd lu ne nf ng nh bi translated">关键任务</li><li id="7e5e" class="mz na it lb b lc ni lf nj li nk lm nl lq nm lu ne nf ng nh bi translated">可重试次数</li></ul><p id="d7ac" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">路线<strong class="lb iu">是关键任务</strong>还是<strong class="lb iu">可重试</strong>？关键任务路线，处理中的每一步都很重要，不能丢失，不应该在现场实例中运行<strong class="lb iu">。例如，购买、注册等等。</strong></p><p id="ce60" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">有趣的部分是<strong class="lb iu">可重试的部分</strong>。如果端点以相对罕见的速率失败是正常的，并且可以重试，这意味着您可以利用spot实例。</p><p id="9ac8" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">最坏的情况，很少，spot实例被AWS中断，一些请求失败。这些请求不是关键任务，可以重试。如果这对您的用例来说没问题，那么您可以从spot实例中获益。</p><p id="f46d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">一旦您将您的端点分成这两类，您就应该在路由中找到一个模式。</p><p id="6d37" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">例如，你可以说<code class="fe nn no np nq b">/api/system</code>和<code class="fe nn no np nq b">/api/user</code>总是关键任务，而其他的是可重试的。</p><p id="9e74" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果您构建一个新的web服务，您甚至可以根据它们是否可重试来确定路由结构。例如，<code class="fe nn no np nq b">/api/core/*</code>用于关键任务端点，而<code class="fe nn no np nq b">/api/general/*</code>用于可重试端点。</p><p id="e237" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在，只需要设置spot实例和按需(或储蓄计划)实例，然后将请求路由到正确的实例。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="4870" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">设置实例</h1><p id="d6be" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">您必须设置:</p><ul class=""><li id="f656" class="mz na it lb b lc ld lf lg li nb lm nc lq nd lu ne nf ng nh bi translated">按需(或节约计划)实例，将处理关键任务请求</li><li id="5027" class="mz na it lb b lc ni lf nj li nk lm nl lq nm lu ne nf ng nh bi translated">Spot实例，将处理可重试的请求</li></ul><p id="53f2" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">两者都应该在独立的自动缩放组中结束，这样您就可以精确地控制每个组需要多少个实例。他们都应该运行适当的代码库。</p><p id="5646" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果您的服务侧重于可重试的端点，那么您很幸运，因为您可以将大部分成本集中在更便宜的spot实例上。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="0898" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">利用您的负载平衡器</h1><p id="5a33" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">既然我们已经划分了路由，并且设置了实例，我们需要将正确的请求路由到正确的实例，无论是现场还是按需。</p><p id="9067" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这可以使用应用程序负载平衡器来完成。打开负载平衡器的侦听器规则，并按如下方式更新它们。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nr"><img src="../Images/81e95d5279db6a81c65ff83ce1b48375.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*n7H2DF9fEvo8vLdpnu5PqQ.png"/></div></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">负载平衡器设置将路由分割到spots或按需实例。</figcaption></figure><p id="9926" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">您将能够设置<code class="fe nn no np nq b">Path</code>到您的可重试端点或关键任务端点。然后，您可以链接这些条件，将请求转发到正确的实例目标组(无论是spots还是按需实例)。一个重要的注意事项是，每个侦听器条件只能创建5个路径规则，因此在创建路由结构时考虑这一点很重要。</p><p id="18df" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">此时，您应该触发一些负载，并检查您的监控工具以确保您在正确的实例上，并且自动伸缩工作正常。</p><p id="1567" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">您还应该运行一些负载测试，并找出多个较小的实例是否比较少的较大实例工作得更好。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="ee68" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">摘要</h1><p id="df3c" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">Web服务的端点可以分为两类:任务关键型和可重试型。</p><p id="6d5b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果您的服务预计在可重试的端点上会有高CPU使用率或高负载，请考虑对这些端点使用spot实例。</p><p id="9e9a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">您可以设置负载平衡器，根据端点路径将流量路由到按需实例或现场实例。</p><p id="7a98" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这样，根据您的具体需求，可以更容易地负担许多小实例或几个大实例。</p><p id="f007" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">Spot实例可以被中断，但中断似乎非常罕见。</p><p id="955d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这是我们在<a class="ae ky" href="https://speedyshot.com" rel="noopener ugc nofollow" target="_blank">https://speedyshot.com</a>的设置，它允许我们以相对较低的成本提供许多实例。我们还将现货实例的最大成本设置为按需价格，这样，如果现货价格突然改变，我们就可以切换到按需实例。</p></div></div>    
</body>
</html>