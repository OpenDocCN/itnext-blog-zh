<html>
<head>
<title>Kubernetes troubleshooting Saga Part 1: Pods, Deployments and Cluster .</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Kubernetes故障排除传奇第1部分:豆荚，部署和集群。</h1>
<blockquote>原文：<a href="https://itnext.io/kubernetes-troubleshooting-saga-part-1-pods-deployments-and-cluster-52df5017df93?source=collection_archive---------2-----------------------#2019-11-22">https://itnext.io/kubernetes-troubleshooting-saga-part-1-pods-deployments-and-cluster-52df5017df93?source=collection_archive---------2-----------------------#2019-11-22</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/e2b65601749b1eec9ed7283587de13c9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*SalcdDkKGUcc9aVlXpWeHA.jpeg"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">当你迷失在日志中…</figcaption></figure><p id="7a53" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">Kubernetes于2015年发布，世界各地的许多公司已经接受它作为他们的容器编排器。在许多组织中，整个平台本身都构建在kubernetes之上。尽管kubernetes似乎是许多容器和平台用例的灵丹妙药，但对它进行故障排除仍然是一件痛苦的事情。</p><p id="790a" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">在过去的三年里，我一直在与kubernetes合作，我遇到了许多问题。我想写这个系列来帮助像我一样是kubernetes爱好者的开发者和SRE。这应该是这个系列的第一部分，我会继续添加更多不同主题的指南。以下是该系列的第二部分:</p><p id="0ad1" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated"><a class="ae la" href="https://medium.com/@krishna.sharma1408/kubernetes-troubleshooting-saga-part-2-networking-and-dns-connectivity-7f11013f6148" rel="noopener"> Kubernetes故障排除传奇第二部分:网络和DNS </a></p><h1 id="d8ff" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">有用的工具:</h1><p id="40d4" class="pw-post-body-paragraph kc kd iq ke b kf lz kh ki kj ma kl km kn mb kp kq kr mc kt ku kv md kx ky kz ij bi translated">拥有像Prometheus或Datadog这样的监控工具必须能够更深入地了解您的集群。为了进一步调试一些问题，Kubectl之类的CLI工具很方便。此外，还有许多其他CLI工具可用于调试错误或轻松获取有关部署的信息。下面是一些有用的例子:</p><ul class=""><li id="c337" class="me mf iq ke b kf kg kj kk kn mg kr mh kv mi kz mj mk ml mm bi translated"><strong class="ke ir">斯特恩</strong>:有没有想过如何方便地同时查看所有部署单元的日志？？如果是，那么斯特恩就是你要找的人。<a class="ae la" href="https://github.com/wercker/stern" rel="noopener ugc nofollow" target="_blank">将</a>链接到文档。<br/>举例:<code class="fe mn mo mp mq b">stern kubernetes-dashboard</code></li><li id="928c" class="me mf iq ke b kf mr kj ms kn mt kr mu kv mv kz mj mk ml mm bi translated">kubectx :如果您正在使用多个集群，那么kubectx可以帮助您在集群之间进行切换。<a class="ae la" href="https://github.com/ahmetb/kubectx" rel="noopener ugc nofollow" target="_blank">将</a>链接至文档。<br/>例如:<code class="fe mn mo mp mq b">kubectx production</code></li><li id="1b4c" class="me mf iq ke b kf mr kj ms kn mt kr mu kv mv kz mj mk ml mm bi translated"><strong class="ke ir"> kube-resource-report </strong>:很多时候，问题不在于您的部署，而在于您的节点耗尽了资源。kube-resource-report有助于了解集群中资源的使用情况。<a class="ae la" href="https://github.com/hjacobs/kube-resource-report" rel="noopener ugc nofollow" target="_blank">将</a>链接至文档。</li><li id="a5d8" class="me mf iq ke b kf mr kj ms kn mt kr mu kv mv kz mj mk ml mm bi translated"><strong class="ke ir"> kube-shell </strong>:如果你是自动补全的粉丝。将链接到文档。</li></ul><p id="c14b" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">除了上面列出的工具之外，还有许多其他可用的CLI工具。你可以在谷歌上查看，例如<strong class="ke ir"> kubens </strong>。</p><h1 id="94bd" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">部署、pod、Daemonsets的故障排除:</h1><figure class="mx my mz na gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mw"><img src="../Images/fbdd15e82befc9062fef0ad12b502413.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*tQnPsHZV_DaKw_rFfk2E3g.png"/></div></div></figure><p id="0ac9" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">让我们假设您的部署或daemonset webapp已关闭。起点应该是检查部署webapp的pod的状态。下面是一些有用的命令，以便更深入地了解:</p><ul class=""><li id="a24f" class="me mf iq ke b kf kg kj kk kn mg kr mh kv mi kz mj mk ml mm bi translated">获取属于部署webapp的所有窗格的状态:<br/> <code class="fe mn mo mp mq b">kubectl get pod -l app=webapp</code></li><li id="06c3" class="me mf iq ke b kf mr kj ms kn mt kr mu kv mv kz mj mk ml mm bi translated">如果上面的命令显示，pod处于<strong class="ke ir"><em class="nb"/></strong><strong class="ke ir"><em class="nb"/></strong><strong class="ke ir"><em class="nb">【逐出】</em> </strong>等状态。，那我们就要深入挖掘了。以webapp-wertr: <br/> <code class="fe mn mo mp mq b">kubectl describe pod webapp-wertr</code>的名称返回故障pod状态的详细报告</li><li id="eed1" class="me mf iq ke b kf mr kj ms kn mt kr mu kv mv kz mj mk ml mm bi translated">如果describe命令不能帮助你，你可以查看日志:<br/> <code class="fe mn mo mp mq b">kubectl logs webapp-wertr</code>或<code class="fe mn mo mp mq b">stern webapp</code></li><li id="539c" class="me mf iq ke b kf mr kj ms kn mt kr mu kv mv kz mj mk ml mm bi translated">有时，pod正在运行，但您的服务仍然不能按预期工作。下面的命令可以帮助你在pod的容器上运行命令:<br/> <code class="fe mn mo mp mq b">kubectl exec -it webapp-wertr -- ps -aux</code></li><li id="3174" class="me mf iq ke b kf mr kj ms kn mt kr mu kv mv kz mj mk ml mm bi translated">节点上的资源不足可能会导致pod出现问题。对于<strong class="ke ir"> <em class="nb"> daemonsets </em> </strong>来说，每个节点都有足够的资源是很重要的。找出pod运行的节点:<br/> <code class="fe mn mo mp mq b">kubectl get pod webapp-wertr -o wide</code></li><li id="af1e" class="me mf iq ke b kf mr kj ms kn mt kr mu kv mv kz mj mk ml mm bi translated">上一点中的命令将告诉我们pod正在哪个节点上运行(假设worker-1)。找出工人-1的资源:<br/> <code class="fe mn mo mp mq b">kubectl top node worker-1</code></li><li id="4eeb" class="me mf iq ke b kf mr kj ms kn mt kr mu kv mv kz mj mk ml mm bi translated">我们还可以使用:<br/> <code class="fe mn mo mp mq b">kubectl describe node worker-1</code>获得关于worker节点的详细报告</li></ul><h1 id="297d" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">pod的常见问题:</h1><p id="95a1" class="pw-post-body-paragraph kc kd iq ke b kf lz kh ki kj ma kl km kn mb kp kq kr mc kt ku kv md kx ky kz ij bi translated">以下是部署和pod最常见的问题:</p><h2 id="67a3" class="nc lc iq bd ld nd ne dn lh nf ng dp ll kn nh ni lp kr nj nk lt kv nl nm lx nn bi translated">创建Pod需要很长时间:</h2><ul class=""><li id="b9b9" class="me mf iq ke b kf lz kj ma kn no kr np kv nq kz mj mk ml mm bi translated">拉码头形象可能需要时间。要对此进行检查，请使用ssh进入worker节点并运行<code class="fe mn mo mp mq b">journalctl -f -u docker</code></li><li id="0438" class="me mf iq ke b kf mr kj ms kn mt kr mu kv mv kz mj mk ml mm bi translated">如果您使用持久卷声明，那么请确保您使用的是符合您的云的正确配置。创建卷本身也可能需要时间。</li><li id="2d6e" class="me mf iq ke b kf mr kj ms kn mt kr mu kv mv kz mj mk ml mm bi translated">如果pod为<code class="fe mn mo mp mq b">pending</code>或<code class="fe mn mo mp mq b">evicted </code>，则可能会因可用资源而出现问题。为pod定义的结帐限制和资源。还要检查集群中的资源。</li><li id="27a3" class="me mf iq ke b kf mr kj ms kn mt kr mu kv mv kz mj mk ml mm bi translated">签出资源配额或限制范围配置。</li></ul><h2 id="96f3" class="nc lc iq bd ld nd ne dn lh nf ng dp ll kn nh ni lp kr nj nk lt kv nl nm lx nn bi translated">ImagePullBackoff或ErrImagePull:</h2><ul class=""><li id="8c9d" class="me mf iq ke b kf lz kj ma kn no kr np kv nq kz mj mk ml mm bi translated">确保您输入了正确的图像名称和标签。</li><li id="0235" class="me mf iq ke b kf mr kj ms kn mt kr mu kv mv kz mj mk ml mm bi translated">请确保节点具有提取图像的权限。</li></ul><h2 id="f373" class="nc lc iq bd ld nd ne dn lh nf ng dp ll kn nh ni lp kr nj nk lt kv nl nm lx nn bi translated">Pod在创建后立即崩溃:</h2><ul class=""><li id="bcdb" class="me mf iq ke b kf lz kj ma kn no kr np kv nq kz mj mk ml mm bi translated">如果pod引用任何配置映射或机密，则应该在pod之前创建它们。</li><li id="3dcc" class="me mf iq ke b kf mr kj ms kn mt kr mu kv mv kz mj mk ml mm bi translated">如果pod中有多个容器，则检查单个容器的状态。为此，您可以使用<code class="fe mn mo mp mq b">kubectl describe</code>。</li><li id="952d" class="me mf iq ke b kf mr kj ms kn mt kr mu kv mv kz mj mk ml mm bi translated">活动性或就绪性探测器可能会出现问题。</li><li id="c1d7" class="me mf iq ke b kf mr kj ms kn mt kr mu kv mv kz mj mk ml mm bi translated">查看日志以获取更多信息。</li></ul><h2 id="a7e4" class="nc lc iq bd ld nd ne dn lh nf ng dp ll kn nh ni lp kr nj nk lt kv nl nm lx nn bi translated">持续量声明的问题:</h2><p id="d61c" class="pw-post-body-paragraph kc kd iq ke b kf lz kh ki kj ma kl km kn mb kp kq kr mc kt ku kv md kx ky kz ij bi translated">对于有状态的pod，卷可能是一个棘手的问题。以下是获取pvc信息的一些要求:</p><pre class="mx my mz na gt nr mq ns nt aw nu bi"><span id="e9eb" class="nc lc iq mq b gy nv nw l nx ny">## Persistent volume information:<br/>kubectl get pv<br/>kubectl describe pv &lt;persisten volume name&gt;</span><span id="1c4e" class="nc lc iq mq b gy nz nw l nx ny">## Persistent volume claims information:<br/>kubectl get pvc<br/>kubectl describe pvc &lt;pvc name&gt;</span></pre><p id="fc1d" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">Kubernetes关于持久性卷的文档非常棒，包含大量信息:</p><div class="oa ob gp gr oc od"><a href="https://kubernetes.io/docs/concepts/storage/persistent-volumes/" rel="noopener  ugc nofollow" target="_blank"><div class="oe ab fo"><div class="of ab og cl cj oh"><h2 class="bd ir gy z fp oi fr fs oj fu fw ip bi translated">持久卷</h2><div class="ok l"><h3 class="bd b gy z fp oi fr fs oj fu fw dk translated">编辑此页面此文档描述了Kubernetes中持久卷的当前状态。熟悉卷…</h3></div><div class="ol l"><p class="bd b dl z fp oi fr fs oj fu fw dk translated">kubernetes.io</p></div></div><div class="om l"><div class="on l oo op oq om or jw od"/></div></div></a></div><blockquote class="os ot ou"><p id="ae46" class="kc kd nb ke b kf kg kh ki kj kk kl km ov ko kp kq ow ks kt ku ox kw kx ky kz ij bi translated"><strong class="ke ir"> <em class="iq">注意:</em> </strong>如果你的pullpolicy是<strong class="ke ir"> IfNotPresent </strong>那么确保你所有的构建都有不同的标签。带有现有标签的新构建将不会被提取，这可能会导致一些奇怪的错误。</p></blockquote><h1 id="618f" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">Kubernetes日志路径:</h1><p id="435b" class="pw-post-body-paragraph kc kd iq ke b kf lz kh ki kj ma kl km kn mb kp kq kr mc kt ku kv md kx ky kz ij bi translated">根据节点的类型，从节点访问日志的方式会有所不同。</p><h2 id="0a55" class="nc lc iq bd ld nd ne dn lh nf ng dp ll kn nh ni lp kr nj nk lt kv nl nm lx nn bi translated">对于非systemd主节点:</h2><ul class=""><li id="ff21" class="me mf iq ke b kf lz kj ma kn no kr np kv nq kz mj mk ml mm bi translated"><strong class="ke ir">API server</strong>:/var/log/kube-API server . log</li><li id="08b4" class="me mf iq ke b kf mr kj ms kn mt kr mu kv mv kz mj mk ml mm bi translated"><strong class="ke ir">调度器</strong>:var/log/kube-scheduler . log</li><li id="e3fe" class="me mf iq ke b kf mr kj ms kn mt kr mu kv mv kz mj mk ml mm bi translated"><strong class="ke ir">控制器管理器</strong>:var/log/kube-scheduler . log</li></ul><h2 id="e097" class="nc lc iq bd ld nd ne dn lh nf ng dp ll kn nh ni lp kr nj nk lt kv nl nm lx nn bi translated">对于非systemd工作节点:</h2><ul class=""><li id="80cf" class="me mf iq ke b kf lz kj ma kn no kr np kv nq kz mj mk ml mm bi translated"><strong class="ke ir">kube let</strong>:/var/log/kube let . log</li><li id="67bd" class="me mf iq ke b kf mr kj ms kn mt kr mu kv mv kz mj mk ml mm bi translated"><strong class="ke ir">kube-proxy</strong>:/var/log/kube-proxy . log</li></ul><h2 id="1acc" class="nc lc iq bd ld nd ne dn lh nf ng dp ll kn nh ni lp kr nj nk lt kv nl nm lx nn bi translated">对于systemd节点:</h2><p id="fd67" class="pw-post-body-paragraph kc kd iq ke b kf lz kh ki kj ma kl km kn mb kp kq kr mc kt ku kv md kx ky kz ij bi translated">检查日志的最佳方式是使用journalctl命令。使用<code class="fe mn mo mp mq b">journalctl --unit kubelet</code>检查kubelet日志的示例</p></div><div class="ab cl oy oz hu pa" role="separator"><span class="pb bw bk pc pd pe"/><span class="pb bw bk pc pd pe"/><span class="pb bw bk pc pd"/></div><div class="ij ik il im in"><h2 id="60ff" class="nc lc iq bd ld nd ne dn lh nf ng dp ll kn nh ni lp kr nj nk lt kv nl nm lx nn bi translated">以下是更多的参考资料:</h2><p id="1a32" class="pw-post-body-paragraph kc kd iq ke b kf lz kh ki kj ma kl km kn mb kp kq kr mc kt ku kv md kx ky kz ij bi translated"><strong class="ke ir">故障排除服务:</strong><a class="ae la" href="https://kubernetes.io/docs/tasks/debug-application-cluster/debug-application/" rel="noopener ugc nofollow" target="_blank">https://kubernetes . io/docs/tasks/debug-application-cluster/debug-application/</a></p><p id="c250" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated"><strong class="ke ir">集群故障排除:</strong><a class="ae la" href="https://kubernetes.io/docs/tasks/debug-application-cluster/debug-cluster/" rel="noopener ugc nofollow" target="_blank">https://kubernetes . io/docs/tasks/debug-application-cluster/debug-cluster/</a></p><p id="a9cb" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated"><strong class="ke ir">Kubernetes dashboard:</strong><a class="ae la" href="https://kubernetes.io/docs/tasks/access-application-cluster/web-ui-dashboard/" rel="noopener ugc nofollow" target="_blank">https://Kubernetes . io/docs/tasks/access-application-cluster/we b-ui-dashboard/</a></p><h1 id="92da" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">最后的话:</h1><p id="f618" class="pw-post-body-paragraph kc kd iq ke b kf lz kh ki kj ma kl km kn mb kp kq kr mc kt ku kv md kx ky kz ij bi translated">希望这对你有帮助。如果还有什么可以补充的，请留言</p></div></div>    
</body>
</html>