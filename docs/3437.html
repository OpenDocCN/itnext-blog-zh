<html>
<head>
<title>Using NSwag to Generate Angular Client for an ASP.NET Core 3 API</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用NSwag为ASP.NET Core 3 API生成Angular客户端</h1>
<blockquote>原文：<a href="https://itnext.io/using-nswag-to-generate-angular-client-for-an-asp-net-core-3-api-ed88cc2e786d?source=collection_archive---------3-----------------------#2019-12-16">https://itnext.io/using-nswag-to-generate-angular-client-for-an-asp-net-core-3-api-ed88cc2e786d?source=collection_archive---------3-----------------------#2019-12-16</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="d4df" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">本周我们将添加一个Angular项目，该项目将利用我们几周前创建的API。这篇文章是我的ASP.NET核心基础回购改造的一部分，我开始时。网芯3.0发布。关于我们如何在应用程序中达到当前点的详细信息，请查看以下帖子。</p><p id="5883" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><a class="ae kl" href="https://elanderson.net/2019/10/swagger-openapi-with-nswag-and-asp-net-core-3/" rel="noopener ugc nofollow" target="_blank"> Swagger/OpenAPI与NSwag和ASP.NET核心3</a><br/><a class="ae kl" href="https://elanderson.net/2019/11/asp-net-core-3-add-entity-framework-core-to-existing-project/" rel="noopener ugc nofollow" target="_blank">ASP.NET核心3:将实体框架核心添加到现有项目</a> <br/> <a class="ae kl" href="https://elanderson.net/2019/12/new-razor-pages-application-backed-with-an-api/" rel="noopener ugc nofollow" target="_blank">新的Razor Pages项目以API为后盾</a></p><p id="ca2a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">请注意，我意识到在这个示例中使用ASP.NET核心支持的Angular项目是多余的，一个普通的Angular应用程序就足够了，但是我想使用ASP.NET核心模板作为这个系列中所有项目的基础。在最初的应用程序创建之后，除了应用程序的主API之外，如果有帮助的话，您可以将这个示例视为设置对辅助API的访问。</p><p id="7739" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这篇文章中的任何改变之前的示例代码可以在<a class="ae kl" href="https://github.com/elanderson/ASP.NET-Core-Basics-Refresh/tree/30bda427fdc7db27b754c0263e4bb76f855bfeb7" rel="noopener ugc nofollow" target="_blank">这里</a>找到。</p><p id="f224" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">API变更</p><p id="32fb" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在我们进入本帖的实际角度之前，我们将更新相关的API以接受所有的<a class="ae kl" href="https://developer.mozilla.org/en-US/docs/Web/HTTP/CORS" rel="noopener ugc nofollow" target="_blank">跨源资源共享</a> (CORS)请求。ASP.NET核心设置有很多选项，如果可以的话，我建议你明确地告诉我你的API会接受什么。查看官方的<a class="ae kl" href="https://docs.microsoft.com/en-us/aspnet/core/security/cors?view=aspnetcore-3.0" rel="noopener ugc nofollow" target="_blank">微软CORS文档</a>了解更多信息。</p><p id="b804" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">所有需要的更改都在API项目的<strong class="jp ir">启动</strong>类中。CORS设置是基于策略的，每个策略都需要一个名称，我将它存储在下面的类级别常量中。</p><pre class="km kn ko kp gt kq kr ks kt aw ku bi"><span id="7c31" class="kv kw iq kr b gy kx ky l kz la">private const string AllowAllCors = "AllowAll";</span></pre><p id="c169" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在<strong class="jp ir"> ConfigureServices </strong>函数中添加以下内容以注册CORS策略。同样，如果可以的话，对您的策略进行更多的限制，但是对于这个示例，我们将开放API以允许任何请求。</p><pre class="km kn ko kp gt kq kr ks kt aw ku bi"><span id="5828" class="kv kw iq kr b gy kx ky l kz la">services.AddCors(options =&gt;<br/>                 {<br/>                     options.AddPolicy(AllowAllCors,<br/>                                       builder =&gt;<br/>                                       {<br/>                                           builder.AllowAnyHeader();<br/>                                           builder.AllowAnyMethod();<br/>                                           builder.AllowAnyOrigin();<br/>                                       });<br/>                 });</span></pre><p id="50e2" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">最后，在<strong class="jp ir"> Configure </strong>函数中添加以下内容，以将CORS添加到HTTP管道处理中。我不是100%确定你把它加在管道的什么地方是否重要，但是我把它加在了靠近前面的地方。我在示例应用程序中包含了一个位管道以供参考。</p><pre class="km kn ko kp gt kq kr ks kt aw ku bi"><span id="9af4" class="kv kw iq kr b gy kx ky l kz la">if (env.IsDevelopment())<br/>{<br/>    app.UseDeveloperExceptionPage();<br/>}<br/><br/>app.UseCors(AllowAllCors);<br/><br/>app.UseHttpsRedirection();</span></pre><p id="c631" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这就是API所需的所有更改，接下来我们将创建一个新的Angular项目。</p><h2 id="842b" class="kv kw iq bd lb lc ld dn le lf lg dp lh jy li lj lk kc ll lm ln kg lo lp lq lr bi translated">创建角度项目</h2><p id="a43f" class="pw-post-body-paragraph jn jo iq jp b jq ls js jt ju lt jw jx jy lu ka kb kc lv ke kf kg lw ki kj kk ij bi translated">为应用程序添加一个新目录，然后在终端中导航到该目录。然后，以下命令可用于创建新的角度项目。目标框架不是必需的，但是我有一个预览。NET Core 3.1安装，我想确保这个项目是针对。网芯3.0。</p><pre class="km kn ko kp gt kq kr ks kt aw ku bi"><span id="8def" class="kv kw iq kr b gy kx ky l kz la">dotnet new angular -f netcoreapp3.0</span></pre><p id="8e8f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">接下来，使用下面的命令将新项目添加到repo根目录下的解决方案文件中。当然，如果你不能使用相同的代码，你的文件名和路径会有所不同。</p><pre class="km kn ko kp gt kq kr ks kt aw ku bi"><span id="5ae2" class="kv kw iq kr b gy kx ky l kz la">dotnet sln ..\..\BasicsRefresh.sln add ContactsAngular.csproj</span></pre><h2 id="46e1" class="kv kw iq bd lb lc ld dn le lf lg dp lh jy li lj lk kc ll lm ln kg lo lp lq lr bi translated">使用NSwagStudio生成角度客户端</h2><p id="6e32" class="pw-post-body-paragraph jn jo iq jp b jq ls js jt ju lt jw jx jy lu ka kb kc lv ke kf kg lw ki kj kk ij bi translated">NSwag为客户端生成提供了多种选项，包括CLI选项、代码和Windows应用程序。这篇文章将使用名为NSwagStudio的Windows应用程序。从<a class="ae kl" href="http://rsuter.com/Projects/NSwagStudio/installer.php" rel="noopener ugc nofollow" target="_blank">这里</a>下载并安装NSwagStudio。</p><p id="8c9a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">接下来，确保您的API正在运行，并获取其OpenAPI/Swagger规范URL的URL。例如，我正在使用我的API的本地实例，我需要的URL是<a class="ae kl" href="https://localhost:5001/swagger/v1/swagger.json." rel="noopener ugc nofollow" target="_blank"><strong class="jp ir">https://localhost:5001/swagger/v1/swagger . JSON</strong>。如果你使用的是Swagger UI，你可以在API标题下找到一个到swagger.json的链接。</a></p><figure class="km kn ko kp gt ly gh gi paragraph-image"><div class="gh gi lx"><img src="../Images/28763ee825c845523019a464c5b9dad7.png" data-original-src="https://miro.medium.com/v2/resize:fit:678/format:webp/0*ftTzqP6WZHTk7GT7.png"/></div></figure><p id="4b39" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在我们已经有了API的OpenAPI/Swager规范URL，切换到NSwagStudio。应用程序将打开，并带有一个准备就绪的新文档。我们需要设置几个选项。首先，选择<strong class="jp ir"> OpenAPI/Swagger规范</strong>选项卡，并在<strong class="jp ir">规范URL </strong>框中输入您的API规范URL。</p><figure class="km kn ko kp gt ly gh gi paragraph-image"><div role="button" tabindex="0" class="mc md di me bf mf"><div class="gh gi mb"><img src="../Images/8eab72954b404e1c91f267fe3a54b142.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*AtDC9wjbHjDdJHm9.png"/></div></div></figure><p id="1ded" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在<strong class="jp ir">输出</strong>部分勾选<strong class="jp ir">打字稿客户端</strong>复选框，然后选择<strong class="jp ir">打字稿客户端</strong>选项卡。有很多选项可以使用，但是我突出显示了为生成这个示例的客户机而更改的选项。首先，我输入了一个名为的<strong class="jp ir">模块，这样生成的代码就都在那个模块中了。对于<strong class="jp ir">模板</strong>，选择<strong class="jp ir"> Angular </strong>非常重要，这样产生的代码将被设置用于Angular的依赖注入。此外，如果您使用的是新版本的Angular，请确保将<strong class="jp ir">注入令牌类型</strong>更改为<strong class="jp ir">注入令牌</strong>。需要设置的最后一个选项是<strong class="jp ir">输出文件</strong>路径，这是您希望生成的文件所在的位置。我在client app \ src \ app \ APIs \ contact API . ts下输出Angular项目目录，设置好所有选项后点击<strong class="jp ir">生成文件</strong>。</strong></p><figure class="km kn ko kp gt ly gh gi paragraph-image"><div class="gh gi mg"><img src="../Images/9fe8b80f99991a13a31962265e7f547d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1248/format:webp/0*5HQqdM-wRxM8hQ0w.png"/></div></figure><p id="de17" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">有关生成角度客户的更多信息，请查看关于该主题的<a class="ae kl" href="https://github.com/RicoSuter/NSwag/wiki/TypeScriptClientGenerator-Angular" rel="noopener ugc nofollow" target="_blank">官方文件</a>。</p><h2 id="97db" class="kv kw iq bd lb lc ld dn le lf lg dp lh jy li lj lk kc ll lm ln kg lo lp lq lr bi translated">创建UI并使用生成的客户端</h2><p id="fda1" class="pw-post-body-paragraph jn jo iq jp b jq ls js jt ju lt jw jx jy lu ka kb kc lv ke kf kg lw ki kj kk ij bi translated">示例API是用于联系人管理的，所以我们将要构建的UI将显示一个联系人列表。新组件将放在ClientApp\src\app下的新<strong class="jp ir"> contacts </strong>目录中。在这个目录中，我们需要两个新文件，一个用于HTML，<strong class="jp ir">contact-list.component.html，</strong>，另一个用于后台类型脚本类，<strong class="jp ir">contact-list . component . ts</strong>。</p><p id="4bb4" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">以下是HTML文件上的全部内容。在这篇文章中，我不打算详细讨论Angular，但是即使你不知道Angular，你也会知道发生了什么。呈现的结果将是一个联系人列表。</p><pre class="km kn ko kp gt kq kr ks kt aw ku bi"><span id="3af9" class="kv kw iq kr b gy kx ky l kz la">&lt;h1 id="tableLabel"&gt;Contacts&lt;/h1&gt;<br/><br/>&lt;p *ngIf="!contacts"&gt;&lt;em&gt;Loading...&lt;/em&gt;&lt;/p&gt;<br/><br/>&lt;table class='table table-striped' aria-labelledby="tableLabel" *ngIf="contacts"&gt;<br/>  &lt;thead&gt;<br/>    &lt;tr&gt;<br/>      &lt;th&gt;Name&lt;/th&gt;<br/>      &lt;th&gt;Address&lt;/th&gt;<br/>      &lt;th&gt;City&lt;/th&gt;<br/>      &lt;th&gt;State&lt;/th&gt;<br/>      &lt;th&gt;Postal Code&lt;/th&gt;<br/>      &lt;th&gt;Phone&lt;/th&gt;<br/>      &lt;th&gt;Email&lt;/th&gt;<br/>    &lt;/tr&gt;<br/>  &lt;/thead&gt;<br/>  &lt;tbody&gt;<br/>    &lt;tr *ngFor="let contact of contacts"&gt;<br/>      &lt;td&gt;{{ contact.name }}&lt;/td&gt;<br/>      &lt;td&gt;{{ contact.address }}&lt;/td&gt;<br/>      &lt;td&gt;{{ contact.city }}&lt;/td&gt;<br/>      &lt;td&gt;{{ contact.state }}&lt;/td&gt;<br/>      &lt;td&gt;{{ contact.postalCode }}&lt;/td&gt;<br/>      &lt;td&gt;{{ contact.phone }}&lt;/td&gt;<br/>      &lt;td&gt;{{ contact.email }}&lt;/td&gt;<br/>    &lt;/tr&gt;<br/>  &lt;/tbody&gt;<br/>&lt;/table&gt;</span></pre><p id="9f56" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">接下来是联系人列表的TypeScript类。在这里，您可以看到NSwag生成的客户机的使用情况。相关行将突出显示。</p><pre class="km kn ko kp gt kq kr ks kt aw ku bi"><span id="f0c2" class="kv kw iq kr b gy kx ky l kz la">import { Component } from '@angular/core';<br/>import { contacts as Contacts } from "../apis/contactApi";<br/><br/>@Component({<br/>  selector: 'app-contact-list',<br/>  templateUrl: './contact-list.component.html'<br/>})<br/>export class ContactListComponent {<br/>  public contacts: Contacts.IContact[];<br/><br/>  constructor(contactsClient : Contacts.ContactsClient) {<br/>    contactsClient.getContacts().subscribe(result =&gt; {<br/>        this.contacts = result;<br/>      },<br/>      error =&gt; console.error(error));<br/>  }<br/>}</span></pre><p id="fc66" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">正如你从上面的代码中看到的，我们注入了<strong class="jp ir"> ContactClient </strong>，然后调用它的<strong class="jp ir"> getContracts </strong>，并将结果赋给类的局部<strong class="jp ir"> contacts </strong>变量。</p><p id="5e42" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在我们的组件已经构建好了，我们需要将它们注册到应用程序中。这些更改位于ClientApp\src\app目录下的<strong class="jp ir"> app.module.ts </strong>文件中。以下是完整的文件，不包括已有的导入，其中突出显示了与我们的联系人相关的项目的更改。</p><pre class="km kn ko kp gt kq kr ks kt aw ku bi"><span id="e250" class="kv kw iq kr b gy kx ky l kz la">import { ContactListComponent } from "./contacts/contact-list.component";<br/>import { contacts } from "./apis/contactApi";<br/><br/>@NgModule({<br/>  declarations: [<br/>    AppComponent,<br/>    NavMenuComponent,<br/>    HomeComponent,<br/>    CounterComponent,<br/>    FetchDataComponent,<br/>    ContactListComponent<br/>  ],<br/>  imports: [<br/>    BrowserModule.withServerTransition({ appId: 'ng-cli-universal' }),<br/>    HttpClientModule,<br/>    FormsModule, <br/>    RouterModule.forRoot([<br/>      { path: '', component: HomeComponent, pathMatch: 'full' },<br/>      { path: 'contact-list', component: ContactListComponent },<br/>      { path: 'counter', component: CounterComponent },<br/>      { path: 'fetch-data', component: FetchDataComponent },<br/>    ])<br/>  ],<br/>  providers: [contacts.ContactsClient],<br/>  bootstrap: [AppComponent]<br/>})<br/>export class AppModule { }</span></pre><p id="5535" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">第一个变化是导入了联系人客户端的联系人列表组件和联系人T2。接下来，<strong class="jp ir"> ContactListComponent </strong>被添加到<strong class="jp ir">声明</strong>数组中。然后我们将<strong class="jp ir"> ContactListComponent </strong>添加到<strong class="jp ir"> RouterModule </strong>中，这样Angular将知道如何将我们带到联系人列表页面。最后，我们将<strong class="jp ir"> ContractsClient </strong>添加到<strong class="jp ir"> providers </strong>数组中，这将允许Angular将客户端注入到我们的联系人列表组件中。</p><p id="ae57" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">要将联系人列表添加到导航菜单中，我们需要更改ClientApp\src\app\nav-menu目录中的<strong class="jp ir">nav-menu.component.html</strong>文件。添加以下列表项以在导航栏中添加联系人链接。</p><pre class="km kn ko kp gt kq kr ks kt aw ku bi"><span id="4458" class="kv kw iq kr b gy kx ky l kz la">&lt;li class="nav-item" [routerLinkActive]="['link-active']"&gt;<br/>  &lt;a class="nav-link text-dark" [routerLink]="['/contact-list']"<br/>    &gt;Contacts&lt;/a<br/>  &gt;<br/>&lt;/li&gt;</span></pre><h2 id="ddf1" class="kv kw iq bd lb lc ld dn le lf lg dp lh jy li lj lk kc ll lm ln kg lo lp lq lr bi translated">包扎</h2><p id="c784" class="pw-post-body-paragraph jn jo iq jp b jq ls js jt ju lt jw jx jy lu ka kb kc lv ke kf kg lw ki kj kk ij bi translated">我在重复我自己，但是NSwag的客户端生成使得开始使用API变得非常简单，但是即使随着时间的推移，能够为API重新生成客户端并准备好API中的任何更改也是非常好的。</p><p id="00eb" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">本帖修改后的样本项目可以在<a class="ae kl" href="https://github.com/elanderson/ASP.NET-Core-Basics-Refresh/tree/36b8b22e058a998a856bef8b7c95108b7555aaa2" rel="noopener ugc nofollow" target="_blank">这里</a>找到。</p></div><div class="ab cl mh mi hu mj" role="separator"><span class="mk bw bk ml mm mn"/><span class="mk bw bk ml mm mn"/><span class="mk bw bk ml mm"/></div><div class="ij ik il im in"><p id="1419" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><em class="mo">原载于</em> <a class="ae kl" href="https://elanderson.net/2019/12/using-nswag-to-generate-angular-client-for-an-asp-net-core-3-api/" rel="noopener ugc nofollow" target="_blank"> <em class="mo">埃里克·安德森</em> </a> <em class="mo">。</em></p></div></div>    
</body>
</html>