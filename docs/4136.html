<html>
<head>
<title>Designing a Notifications Service with SQS and SNS</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用SQS和社交网络设计通知服务</h1>
<blockquote>原文：<a href="https://itnext.io/designing-a-notifications-service-with-sqs-and-sns-176adad42fa1?source=collection_archive---------1-----------------------#2020-05-04">https://itnext.io/designing-a-notifications-service-with-sqs-and-sns-176adad42fa1?source=collection_archive---------1-----------------------#2020-05-04</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><figure class="is it gp gr iu iv gh gi paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="gh gi ir"><img src="../Images/2b88a66de5b226a57238742c514b351a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*RDi_N6Hi6oaHIQJJ"/></div></div><figcaption class="jc jd gj gh gi je jf bd b be z dk translated">照片由<a class="ae jg" href="https://unsplash.com/@jamie452?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">杰米街</a>在<a class="ae jg" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a></figcaption></figure><div class=""/><h1 id="1b46" class="kg kh jj bd ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld bi translated">背景</h1><p id="915c" class="pw-post-body-paragraph le lf jj lg b lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated">我工作的公司有许多不同的系统，这些系统都通过API连接在一起。每个系统都存储和处理有关企业运营的不同信息。将这些系统分开对于我们的开发团队来说非常有效，因为这使得人们独立地使用和部署它们变得非常简单。</p><p id="3ae4" class="pw-post-body-paragraph le lf jj lg b lh mc lj lk ll md ln lo lp me lr ls lt mf lv lw lx mg lz ma mb im bi translated">我们的用户不必考虑所有这些独立的系统。我们有许多应用程序，但它们是根据用户的使用情况来划分的，而不是根据它们与之对话的后端服务。我们目前正在使用Apollo Federation将所有不同的后端连接在一起，以便我们的前端代码可以轻松使用。</p><h1 id="b2a3" class="kg kh jj bd ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld bi translated">目标</h1><p id="8f69" class="pw-post-body-paragraph le lf jj lg b lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated">我们需要能够向用户发送通知，以响应系统中的各种“事件”。我们需要能够发送的初始通知集很小，但是，我们预计它会快速增长和变化。这些事件可能来自我们所有不同的服务，我们可能希望通过多个不同的渠道(例如，本地推送通知、web推送通知、slack消息)将它们发送给我们的用户。</p><h1 id="7f77" class="kg kh jj bd ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld bi translated">我如何设计这个系统</h1><h2 id="2feb" class="mh kh jj bd ki mi mj dn km mk ml dp kq lp mm mn ku lt mo mp ky lx mq mr lc ms bi translated">目标</h2><p id="927e" class="pw-post-body-paragraph le lf jj lg b lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated">这类事情的第一步是考虑我们希望我们的系统实现什么。我想到了:</p><ul class=""><li id="c894" class="mt mu jj lg b lh mc ll md lp mv lt mw lx mx mb my mz na nb bi translated">我们希望能够向用户发送即时推送通知，以响应各种事件</li><li id="2d16" class="mt mu jj lg b lh nc ll nd lp ne lt nf lx ng mb my mz na nb bi translated">我们维护的其他服务不需要知道这些通知是如何传递的</li><li id="7a99" class="mt mu jj lg b lh nc ll nd lp ne lt nf lx ng mb my mz na nb bi translated">我们应该能够支持通过各种不同的渠道发送通知(例如，推送通知、松弛消息等)。)</li><li id="ef53" class="mt mu jj lg b lh nc ll nd lp ne lt nf lx ng mb my mz na nb bi translated">改变我们所有通知的措辞以及通知送达的地点/时间应该简单快捷</li></ul><h2 id="f1d0" class="mh kh jj bd ki mi mj dn km mk ml dp kq lp mm mn ku lt mo mp ky lx mq mr lc ms bi translated">选择</h2><p id="d76c" class="pw-post-body-paragraph le lf jj lg b lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated">接下来，我为如何构建它列出了一个简短的高级选项列表。</p><ol class=""><li id="2f62" class="mt mu jj lg b lh mc ll md lp mv lt mw lx mx mb nh mz na nb bi translated">单个API服务通过slack、web push、iOS等各种API直接推送通知。</li><li id="afe5" class="mt mu jj lg b lh nc ll nd lp ne lt nf lx ng mb nh mz na nb bi translated">单个API服务将通知推送到亚马逊简单通知服务(SNS)中。我们为每个想要推送通知的渠道创建一个Amazon简单队列服务(SQS)队列(例如Slack消息和推送通知)。然后，我们为每个通道提供一个通知服务。每个通知服务都会侦听SQS队列中的新消息，并负责发送通知。</li></ol><blockquote class="ni nj nk"><p id="a9bb" class="le lf nl lg b lh mc lj lk ll md ln lo nm me lr ls nn mf lv lw no mg lz ma mb im bi translated"><strong class="lg jk">亚马逊简单通知服务(SNS) </strong>是亚马逊提供的一项服务，允许您发布许多不同服务可以消费的事件。每个事件都发送给每个消费者。消费者必须在消息发送时在线才能接收它，因此需要一个队列来创建一个可靠的系统。</p><p id="fca0" class="le lf nl lg b lh mc lj lk ll md ln lo nm me lr ls nn mf lv lw no mg lz ma mb im bi translated"><strong class="lg jk">亚马逊简单队列服务(SQS) </strong>是亚马逊提供的一项服务，可以让你创建消息队列。它可以直接订阅一个或多个SNS主题，也可以直接将消息推送到队列中。如果消费服务运行太慢，队列负责缓冲消息，并处理重试。如果一个队列有多个监听消息的服务，则每条消息都被传递给一个使用者。如果队列变得太长，这允许您增加从队列中消耗的工作线程的数量。</p></blockquote><p id="480f" class="pw-post-body-paragraph le lf jj lg b lh mc lj lk ll md ln lo lp me lr ls lt mf lv lw lx mg lz ma mb im bi translated">我画了一张表，列出了每个解决方案的利弊。每个人都很清楚，虽然选项1对于最初的几个通知来说是最快实现的，但随着复杂性的增加，它不会很好地扩展，因为每个API服务都需要处理发送每种类型的推送通知的所有复杂性。</p><p id="6c23" class="pw-post-body-paragraph le lf jj lg b lh mc lj lk ll md ln lo lp me lr ls lt mf lv lw lx mg lz ma mb im bi translated">我们决定选择选项2，在这里我们使用SNS和SQS将事件从我们的API服务路由到专用的通知服务来发送通知。</p><h2 id="6ad0" class="mh kh jj bd ki mi mj dn km mk ml dp kq lp mm mn ku lt mo mp ky lx mq mr lc ms bi translated">系统图</h2><p id="f6fc" class="pw-post-body-paragraph le lf jj lg b lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated"><em class="nl">我们对这些进行了重新绘制和简化，删除了我们其他内部系统的细节。</em></p><p id="c494" class="pw-post-body-paragraph le lf jj lg b lh mc lj lk ll md ln lo lp me lr ls lt mf lv lw lx mg lz ma mb im bi translated">我们已经决定使用单独的服务来发送通知，通过SNS和SQS连接到我们的API服务，但我们仍然有多种方式来构建它。画出这些系统是感受它们的大小和结构的一个非常好的方法。在这一点上，我们考虑了两种广泛的方法。</p><figure class="nq nr ns nt gt iv gh gi paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="gh gi np"><img src="../Images/08f5808dc3d1b95ede2d086f31184188.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*LEdNC4nb3rzXK3rTDhrYQg.png"/></div></div><figcaption class="jc jd gj gh gi je jf bd b be z dk translated">每个API服务将事件发布到自己的SNS主题</figcaption></figure><p id="5b84" class="pw-post-body-paragraph le lf jj lg b lh mc lj lk ll md ln lo lp me lr ls lt mf lv lw lx mg lz ma mb im bi translated">在第一张图中，每个API服务都有自己的SNS主题，并向其发布事件。每个通知服务都有一个订阅多个SNS主题的SQS队列，以便获得所有相关事件。</p><figure class="nq nr ns nt gt iv gh gi paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="gh gi np"><img src="../Images/b37adf08526bd8f9619263a69baa2187.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*74WVB0w_kXBebO6bHJGeBw.png"/></div></div><figcaption class="jc jd gj gh gi je jf bd b be z dk translated">每个服务将事件发布到一个共享的中央SNS主题</figcaption></figure><p id="cf17" class="pw-post-body-paragraph le lf jj lg b lh mc lj lk ll md ln lo lp me lr ls lt mf lv lw lx mg lz ma mb im bi translated">在第二张图中，每个API服务将事件推送到一个共享的SNS主题。每个通知服务都有一个订阅该中心SNS主题的SQS队列。</p><p id="50c4" class="pw-post-body-paragraph le lf jj lg b lh mc lj lk ll md ln lo lp me lr ls lt mf lv lw lx mg lz ma mb im bi translated">我一会儿会回到这个决定，但首先，让我们看看事件本身。</p><h2 id="cb8b" class="mh kh jj bd ki mi mj dn km mk ml dp kq lp mm mn ku lt mo mp ky lx mq mr lc ms bi translated">事件内容</h2><p id="47bf" class="pw-post-body-paragraph le lf jj lg b lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated">流经这些系统的事件有两种形式:</p><p id="9586" class="pw-post-body-paragraph le lf jj lg b lh mc lj lk ll md ln lo lp me lr ls lt mf lv lw lx mg lz ma mb im bi translated">描述发生了什么:</p><pre class="nq nr ns nt gt nu nv nw nx aw ny bi"><span id="9fc5" class="mh kh jj nv b gy nz oa l ob oc">{event: 'contact_edited', contactId: 1}</span></pre><p id="bbb6" class="pw-post-body-paragraph le lf jj lg b lh mc lj lk ll md ln lo lp me lr ls lt mf lv lw lx mg lz ma mb im bi translated">描述应该发生的情况:</p><pre class="nq nr ns nt gt nu nv nw nx aw ny bi"><span id="5d7e" class="mh kh jj nv b gy nz oa l ob oc">{<br/>  userIdsToNotify: [1, 2, 3],<br/>  message: 'The contact Jane Smith was updated'<br/>  action: {type: 'open_contact', id: 1}<br/>}</span></pre><p id="89bd" class="pw-post-body-paragraph le lf jj lg b lh mc lj lk ll md ln lo lp me lr ls lt mf lv lw lx mg lz ma mb im bi translated">第一个告诉我们一个联系人已经被编辑。我们可以包含被编辑的联系人的详细信息，或者我们可以让这个API的消费者根据ID获取他们需要的任何详细信息。通知服务将通过构造实际的消息内容并确定应该通知哪些用户来决定如何处理这个问题。</p><p id="22d8" class="pw-post-body-paragraph le lf jj lg b lh mc lj lk ll md ln lo lp me lr ls lt mf lv lw lx mg lz ma mb im bi translated">第二个告诉我们发送什么通知，以我们设计的格式。通知服务不需要了解太多的业务领域，它只需要知道如何将消息作为推送通知/松弛消息等发送。</p><h1 id="ecbc" class="kg kh jj bd ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld bi translated">公共API和封装</h1><p id="892a" class="pw-post-body-paragraph le lf jj lg b lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated">在这一点上，我们对如何构建SNS主题有两种不同的想法，对消息应该包含什么也有两种不同的想法。在我们作为一个团队就这里的最佳行动方案达成一致之前，需要进行相当多的讨论。</p><p id="8991" class="pw-post-body-paragraph le lf jj lg b lh mc lj lk ll md ln lo lp me lr ls lt mf lv lw lx mg lz ma mb im bi translated">我把这两个决定放在一起，因为它们的理由是一样的。问自己这两个问题:</p><blockquote class="od"><p id="cfee" class="oe of jj bd og oh oi oj ok ol om mb dk translated">每个服务的边界是什么？</p><p id="e4eb" class="oe of jj bd og oh oi oj ok ol om mb dk translated">每个服务的公共API是什么？</p></blockquote><p id="6519" class="pw-post-body-paragraph le lf jj lg b lh on lj lk ll oo ln lo lp op lr ls lt oq lv lw lx or lz ma mb im bi translated">为了回答第一个问题，我试着在之前的图上画出边界:</p><figure class="nq nr ns nt gt iv gh gi paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="gh gi os"><img src="../Images/4c7a024e570f4b86b4844967120002d0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*IRdAhwyMP27lJRrU8jQi4A.png"/></div></div><figcaption class="jc jd gj gh gi je jf bd b be z dk translated">每个API和SNS主题对被分组到一个服务中</figcaption></figure><p id="5db0" class="pw-post-body-paragraph le lf jj lg b lh mc lj lk ll md ln lo lp me lr ls lt mf lv lw lx mg lz ma mb im bi translated">在这里，围绕各种服务划分界限非常容易。SNS主题是每个API服务的公共API的一部分，就像它的GraphQL或REST APIs一样。从外部，您可以订阅一个SNS主题，以便从该API服务接收事件。</p><p id="5dda" class="pw-post-body-paragraph le lf jj lg b lh mc lj lk ll md ln lo lp me lr ls lt mf lv lw lx mg lz ma mb im bi translated">可以将通知服务组合成一个更大的服务，但是我在这里将它们成对绘制。他们没有任何面向公众的API。相反，它们使用各种其他API的SNS端点，并推送到各种外部服务。</p><figure class="nq nr ns nt gt iv gh gi paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="gh gi ot"><img src="../Images/4f150580aa70824e383f0c6adf455e4c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*OyM8i627Q1mfN-XtiwXRxg.png"/></div></div><figcaption class="jc jd gj gh gi je jf bd b be z dk translated">共享的SNS话题最终在它自己的单独群组中结束</figcaption></figure><p id="98a8" class="pw-post-body-paragraph le lf jj lg b lh mc lj lk ll md ln lo lp me lr ls lt mf lv lw lx mg lz ma mb im bi translated">当我们查看单个共享SNS主题方法时，一切都变得更加混乱，或者至少更加随意。很明显，SNS主题不能是各种API服务的一部分，因为那样的话，它将属于多个服务。如果我们认为每个通知服务都是独立的，那么它也不可能是它们的一部分。这就是为什么我把它画成一个独立的实体。它实际上是一个完整的独立的概念构建块，需要有自己的公共API，用于将它推送到的API端和从中消费其事件的通知端。</p><p id="187a" class="pw-post-body-paragraph le lf jj lg b lh mc lj lk ll md ln lo lp me lr ls lt mf lv lw lx mg lz ma mb im bi translated">根据这些图表，很明显，如果每个服务都拥有自己独立的SNS主题，那么在每个服务周围画一个边界会容易得多。接下来我们可以看看定义公共API的问题。</p><p id="2f9c" class="pw-post-body-paragraph le lf jj lg b lh mc lj lk ll md ln lo lp me lr ls lt mf lv lw lx mg lz ma mb im bi translated">如果事件类似于“联系人123已更新”，那么contacts服务的公共API只包含它可以发布的可能事件(及其模式)的列表。</p><p id="65e2" class="pw-post-body-paragraph le lf jj lg b lh mc lj lk ll md ln lo lp me lr ls lt mf lv lw lx mg lz ma mb im bi translated">如果事件说“发送‘联系人简·史密斯已更新’给用户1”，我们就处于尴尬的境地。该消息的类型显然是存在于通知服务中的，因为它是所有各种API服务使用的一致结构。因此，contacts服务的公共API包含了一个人类可读消息的SNS主题，以便发送给用户。</p><blockquote class="od"><p id="879b" class="oe of jj bd og oh oi oj ok ol om mb dk translated">我们决定使用两个系统图中的第一个，让事件包含描述发生了什么的结构化数据，而不是应该发送什么通知。</p></blockquote><h1 id="93e2" class="kg kh jj bd ki kj kk kl km kn ko kp kq kr ou kt ku kv ov kx ky kz ow lb lc ld bi translated">权衡</h1><p id="26e3" class="pw-post-body-paragraph le lf jj lg b lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated">对于任何系统，了解所做的权衡是很重要的。在这里，我们可以选择:</p><ul class=""><li id="f8de" class="mt mu jj lg b lh mc ll md lp mv lt mw lx mx mb my mz na nb bi translated">我们可以让API服务知道推送通知的结构和内容。这使得API边界不太清晰，迫使我们采用最小公分母方法(我们需要一个事件结构用于所有的通知服务，即使它们有不同的功能)。如果我们想要触发其他动作来响应各种API中的变化，这些事件也不能被容易地重用或改变用途。</li><li id="20ee" class="mt mu jj lg b lh nc ll nd lp ne lt nf lx ng mb my mz na nb bi translated"><strong class="lg jk">我们可以让通知服务知道业务数据。</strong>这使得通知服务不那么抽象。这也意味着为一个全新的事件添加一个通知涉及两个而不是一个更改。您必须在API服务中添加事件，并在通知服务中为其添加处理程序。</li></ul><p id="2036" class="pw-post-body-paragraph le lf jj lg b lh mc lj lk ll md ln lo lp me lr ls lt mf lv lw lx mg lz ma mb im bi translated">在这种情况下，收益似乎超过了成本，因此我们将构建一个通知服务，它能够识别发送通知的业务逻辑。我们相信这将极大地简化我们的API服务，因为它们已经需要在某些地方触发这样的事件，以便被其他服务获取。我们还认为，将我们所有的消息模板和逻辑放在一个集中的地方来决定发送什么通知是很有价值的。</p><p id="c724" class="pw-post-body-paragraph le lf jj lg b lh mc lj lk ll md ln lo lp me lr ls lt mf lv lw lx mg lz ma mb im bi translated">在撰写本文时，我们实际上还没有开始构建这个通知服务，所以我非常想听听您的想法。你会怎么做这个？你认为我遗漏了什么权衡？如果您觉得这很有用，可以注册我的电子邮件简讯，以接收更多类似这样的内容:</p><figure class="nq nr ns nt gt iv"><div class="bz fp l di"><div class="ox oy l"/></div></figure></div></div>    
</body>
</html>