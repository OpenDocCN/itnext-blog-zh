<html>
<head>
<title>Grafana Labs: Loki — distributed system, labels, and filters</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Grafana实验室:Loki——分布式系统、标签和过滤器</h1>
<blockquote>原文：<a href="https://itnext.io/grafana-labs-loki-distributed-system-labels-and-filters-82458e77936b?source=collection_archive---------3-----------------------#2019-02-07">https://itnext.io/grafana-labs-loki-distributed-system-labels-and-filters-82458e77936b?source=collection_archive---------3-----------------------#2019-02-07</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div class="gh gi jn"><img src="../Images/99d3505cb5552979ece2e0a05ea2a816.png" data-original-src="https://miro.medium.com/v2/resize:fit:260/format:webp/0*2J045XOsLxnJHqs8.png"/></div></figure><p id="3690" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">上一篇帖子— <a class="ae ks" href="https://rtfm.co.ua/en/grafana-labs-loki-logs-collector-and-monitoring-system/" rel="noopener ugc nofollow" target="_blank"> Grafana Labs: Loki —日志收集和监控系统</a>。</p><p id="105c" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">Loki、<code class="fe kt ku kv kw b">promtail</code>和Grafana在同一台主机上配置在一个Docker合成堆栈中。</p><p id="dc36" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">现在我想尝试一些分布式设置:</p><ol class=""><li id="7bca" class="kx ky iq jw b jx jy kb kc kf kz kj la kn lb kr lc ld le lf bi translated">Grafana将在一台主机上工作</li><li id="2d3d" class="kx ky iq jw b jx lg kb lh kf li kj lj kn lk kr lc ld le lf bi translated"><strong class="jw ir">洛基</strong>——另一个</li><li id="9f47" class="kx ky iq jw b jx lg kb lh kf li kj lj kn lk kr lc ld le lf bi translated"><strong class="jw ir">提示</strong> —将从第三个服务器收集日志</li></ol><p id="a277" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">接下来的想法是:</p><ul class=""><li id="746c" class="kx ky iq jw b jx jy kb kc kf kz kj la kn lb kr ll ld le lf bi translated">我们有一个有2台服务器的<em class="lm">开发</em>环境</li><li id="96f2" class="kx ky iq jw b jx lg kb lh kf li kj lj kn lk kr ll ld le lf bi translated">我们与Grafana、Prometheus等有专门的监控堆栈</li></ul><p id="f1ed" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">在<em class="lm">开发</em>环境中，我们将运行我们的<code class="fe kt ku kv kw b">promtail</code>代理，它将收集数据并<code class="fe kt ku kv kw b">PUSH</code>到Loki。</p><p id="6a4a" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">Grafana将使用Loki作为其数据源，在仪表板上显示日志。</p><p id="8856" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">一般来说，接下来会是这样的(这个方案是使用<a class="ae ks" href="https://cloudcraft.co" rel="noopener ugc nofollow" target="_blank">https://cloudcraft.co</a>制定的):</p><figure class="lo lp lq lr gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="ls lt di lu bf lv"><div class="gh gi ln"><img src="../Images/057e0914443a3ed189f4aa2f444823bd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*XEqTYzSGJE9NaG7Z.png"/></div></div></figure><p id="2b59" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">在下一篇文章中，我们将配置Loki使用ASW DynamoDB和AWS S3桶来存储数据和索引。</p><h2 id="0b1a" class="lw lx iq bd ly lz ma dn mb mc md dp me kf mf mg mh kj mi mj mk kn ml mm mn mo bi translated">准备主机</h2><p id="f7db" class="pw-post-body-paragraph ju jv iq jw b jx mp jz ka kb mq kd ke kf mr kh ki kj ms kl km kn mt kp kq kr ij bi translated">让我们启动三台服务器:</p><figure class="lo lp lq lr gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="ls lt di lu bf lv"><div class="gh gi mu"><img src="../Images/03f23c9e28439ef7e4a2bbc0c335a07e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*OlYXmSYvU5eLElvT.png"/></div></div></figure><p id="6e9b" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">并创建三个要使用的域:</p><p id="6ae0" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">11 promtail.setevoy.org.ua</p><p id="eae0" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">12 loki.setevoy.org.ua</p><p id="6634" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">13 grafana.setevoy.org.ua</p></div><div class="ab cl mv mw hu mx" role="separator"><span class="my bw bk mz na nb"/><span class="my bw bk mz na nb"/><span class="my bw bk mz na"/></div><div class="ij ik il im in"><h2 id="dfb8" class="lw lx iq bd ly lz ma dn mb mc md dp me kf mf mg mh kj mi mj mk kn ml mm mn mo bi translated">Promtail</h2><p id="86af" class="pw-post-body-paragraph ju jv iq jw b jx mp jz ka kb mq kd ke kf mr kh ki kj ms kl km kn mt kp kq kr ij bi translated">从<code class="fe kt ku kv kw b">promtail</code>开始。</p><p id="ddc2" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">我们希望收集NGINX日志，然后将它们推送到Loki实例。</p><p id="5bb9" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">创建<code class="fe kt ku kv kw b">promtail-conf.yml</code>文件:</p><pre class="lo lp lq lr gt nc kw nd ne aw nf bi"><span id="7ed3" class="lw lx iq kw b gy ng nh l ni nj">server:<br/><br/>  http_listen_port: 9080<br/>  grpc_listen_port: 0<br/><br/>positions:<br/><br/>  filename: /tmp/positions.yaml<br/><br/>client:<br/><br/>  url: <a class="ae ks" href="http://loki.setevoy.org.ua:3100/api/prom/push" rel="noopener ugc nofollow" target="_blank">http://loki.setevoy.org.ua:3100/api/prom/push</a><br/><br/>scrape_configs:<br/><br/>  - job_name: system<br/>    entry_parser: raw<br/>    static_configs:<br/>    - targets:<br/>        - localhost<br/>      labels:<br/>        job: varlogs<br/>        __path__: /var/log/*log<br/><br/>  - job_name: nginx<br/>    entry_parser: raw<br/>    static_configs:<br/>    - targets:<br/>        - localhost<br/>      labels:<br/>        job: nginx<br/>        __path__: /var/log/nginx/*log</span></pre><p id="cb4c" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">创建一个合成文件来运行<code class="fe kt ku kv kw b">promtail</code>的容器- <code class="fe kt ku kv kw b">promtail-compose.yml</code>:</p><pre class="lo lp lq lr gt nc kw nd ne aw nf bi"><span id="85dd" class="lw lx iq kw b gy ng nh l ni nj">version: "3"<br/><br/>services:<br/><br/>  promtail:<br/>    image: grafana/promtail:master<br/>    volumes:<br/>      - /home/admin/promtail-conf.yml:/etc/promtail/docker-config.yaml<br/>      - /var/log:/var/log<br/>    command: -config.file=/etc/promtail/docker-config.yaml</span></pre><p id="920d" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">运行它:</p><pre class="lo lp lq lr gt nc kw nd ne aw nf bi"><span id="8c33" class="lw lx iq kw b gy ng nh l ni nj">root@ip-172–31–32–175:/home/admin# docker-compose -f promtail-compose.yml up -d</span></pre><p id="6ae5" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">检查它是否工作:</p><pre class="lo lp lq lr gt nc kw nd ne aw nf bi"><span id="b66b" class="lw lx iq kw b gy ng nh l ni nj">root@ip-172–31–32–175:/home/admin# curl -s localhost:9080/metrics | head -5<br/>#HELP go_gc_duration_seconds A summary of the GC invocation durations.<br/>#TYPE go_gc_duration_seconds summary<br/>go_gc_duration_seconds{quantile=”0.0"} 3.6174e-05<br/>go_gc_duration_seconds{quantile=”0.25"} 3.6174e-05<br/>go_gc_duration_seconds{quantile=”0.5"} 4.6829e-05</span></pre><h2 id="7353" class="lw lx iq bd ly lz ma dn mb mc md dp me kf mf mg mh kj mi mj mk kn ml mm mn mo bi translated">洛基</h2><p id="d0d2" class="pw-post-body-paragraph ju jv iq jw b jx mp jz ka kb mq kd ke kf mr kh ki kj ms kl km kn mt kp kq kr ij bi translated">现在去洛基的主机那里。</p><p id="ed50" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">在此创建一个新的Loki配置- <code class="fe kt ku kv kw b">loki-conf.yml</code>:</p><pre class="lo lp lq lr gt nc kw nd ne aw nf bi"><span id="d9bd" class="lw lx iq kw b gy ng nh l ni nj">auth_enabled: false<br/><br/>server:<br/>  http_listen_port: 3100<br/><br/>ingester:<br/>  lifecycler:<br/>    address: 0.0.0.0<br/>    ring:<br/>      store: inmemory<br/>      replication_factor: 1<br/>  chunk_idle_period: 15m<br/><br/>schema_config:<br/>  configs:<br/>  - from: 0<br/>    store: boltdb<br/>    object_store: filesystem<br/>    schema: v9<br/>    index:<br/>      prefix: index_<br/>      period: 168h<br/><br/>storage_config:<br/>  boltdb:<br/>    directory: /tmp/loki/index<br/><br/>  filesystem:<br/>    directory: /tmp/loki/chunks<br/><br/>limits_config:<br/>  enforce_metric_name: false</span></pre><p id="0ea7" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">在<em class="lm">地址:0.0.0.0 </em>中，我们设置监听所有可用的接口，因为我们想通过互联网访问它。</p><p id="ff6f" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">创建一个合成文件— <code class="fe kt ku kv kw b">loki-compose.yml</code>:</p><pre class="lo lp lq lr gt nc kw nd ne aw nf bi"><span id="33bd" class="lw lx iq kw b gy ng nh l ni nj">version: "3"<br/><br/>services:<br/>  loki:<br/>    image: grafana/loki:master<br/>    volumes:<br/>      - /home/admin/loki-conf.yml:/etc/loki/local-config.yaml<br/>    ports:<br/>      - "3100:3100"<br/>    command: -config.file=/etc/loki/local-config.yaml</span></pre><p id="6c1f" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">运行它:</p><pre class="lo lp lq lr gt nc kw nd ne aw nf bi"><span id="389d" class="lw lx iq kw b gy ng nh l ni nj">root@ip-172–31–38–97:/home/admin# docker-compose -f loki-compose.yml up -d<br/>Starting admin_loki_1 … done</span></pre><p id="9e4c" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">检查:</p><pre class="lo lp lq lr gt nc kw nd ne aw nf bi"><span id="ff22" class="lw lx iq kw b gy ng nh l ni nj">root@ip-172–31–38–97:/home/admin# curl -s localhost:3100/metrics | head -5<br/>#HELP cortex_cache_corrupt_chunks_total Total count of corrupt chunks found in cache.<br/>#TYPE cortex_cache_corrupt_chunks_total counter<br/>cortex_cache_corrupt_chunks_total 0.0<br/>#HELP cortex_chunk_store_chunks_per_query Distribution of #chunks per query.<br/>#TYPE cortex_chunk_store_chunks_per_query histogram</span></pre><p id="e997" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">很好。</p><p id="232a" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">现在让我们试着从<em class="lm">提示符</em>连接——主机:</p><pre class="lo lp lq lr gt nc kw nd ne aw nf bi"><span id="7caf" class="lw lx iq kw b gy ng nh l ni nj">root@ip-172–31–32–175:/home/admin# curl -s loki.setevoy.org.ua:3100/metrics | head -5<br/>#HELP cortex_cache_corrupt_chunks_total Total count of corrupt chunks found in cache.<br/>#TYPE cortex_cache_corrupt_chunks_total counter<br/>cortex_cache_corrupt_chunks_total 0.0<br/>#HELP cortex_chunk_store_chunks_per_query Distribution of #chunks per query.<br/>#TYPE cortex_chunk_store_chunks_per_query histogram</span></pre><p id="4c5f" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">目前为止一切顺利。</p><h2 id="df5e" class="lw lx iq bd ly lz ma dn mb mc md dp me kf mf mg mh kj mi mj mk kn ml mm mn mo bi translated">格拉夫纳</h2><p id="836e" class="pw-post-body-paragraph ju jv iq jw b jx mp jz ka kb mq kd ke kf mr kh ki kj ms kl km kn mt kp kq kr ij bi translated">在Grafana的主机上创建一个合成文件来运行Grafana容器— <code class="fe kt ku kv kw b">grafana-compose.yml</code>:</p><pre class="lo lp lq lr gt nc kw nd ne aw nf bi"><span id="a4fe" class="lw lx iq kw b gy ng nh l ni nj">version: "3"<br/><br/>services:<br/>  grafana:<br/>    image: grafana/grafana:master<br/>    ports:<br/>      - "3000:3000"</span></pre><p id="6f16" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">运行它:</p><pre class="lo lp lq lr gt nc kw nd ne aw nf bi"><span id="e972" class="lw lx iq kw b gy ng nh l ni nj">root@ip-172–31–43–174:/opt/loki# docker-compose -f grafana-compose.yml up -d</span></pre><p id="ff94" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">检查UI—<a class="ae ks" href="http://grafana.setevoy.org.ua:3000:" rel="noopener ugc nofollow" target="_blank"><em class="lm">http://grafana.setevoy.org.ua:3000</em>:</a></p><figure class="lo lp lq lr gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="ls lt di lu bf lv"><div class="gh gi nk"><img src="../Images/8ffbee0f6dcb562cf00ac58e45d09ae8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*Vep4uKwbWlrzmVfU.png"/></div></div></figure><p id="2357" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">配置Loki数据源:</p><figure class="lo lp lq lr gt jr gh gi paragraph-image"><div class="gh gi nl"><img src="../Images/e865331f7264607e494dfeeedb8b5184.png" data-original-src="https://miro.medium.com/v2/resize:fit:1376/format:webp/0*DjXpgiB0lc14kjwq.png"/></div></figure><p id="9a89" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">呃…</p><p id="c831" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">我的日志在哪里？</p><figure class="lo lp lq lr gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="ls lt di lu bf lv"><div class="gh gi nm"><img src="../Images/0c9fc4f804dc8210ea6b294f77ed73cc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*aG0at4H5dFmG7m5a.png"/></div></div></figure><p id="3326" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">而且这里没有<em class="lm"> nginx </em>组…</p><p id="f2f2" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">让我们检查一下<code class="fe kt ku kv kw b">promtail</code>的日志:</p><pre class="lo lp lq lr gt nc kw nd ne aw nf bi"><span id="bcbd" class="lw lx iq kw b gy ng nh l ni nj">root@ip-172–31–32–175:/home/admin# docker logs -f admin_promtail_1<br/>…<br/>l=error ts=2019–02–07T12:13:23.938327315Z caller=client.go:129 msg=”error sending batch” error=”Post <a class="ae ks" href="http://loki.setevoy.org.ua:3100/api/prom/push:" rel="noopener ugc nofollow" target="_blank">http://loki.setevoy.org.ua:3100/api/prom/push:</a> dial tcp 52.16.65.121:3100: connect: connection refused”<br/>level=error ts=2019–02–07T12:13:24.946257437Z caller=client.go:129 msg=”error sending batch” error=”Post <a class="ae ks" href="http://loki.setevoy.org.ua:3100/api/prom/push:" rel="noopener ugc nofollow" target="_blank">http://loki.setevoy.org.ua:3100/api/prom/push:</a> dial tcp 52.16.65.121:3100: connect: connection refused”</span></pre><p id="0110" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">为什么？</p><p id="0cb5" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">重启<code class="fe kt ku kv kw b">promtail</code>的容器:</p><pre class="lo lp lq lr gt nc kw nd ne aw nf bi"><span id="58ec" class="lw lx iq kw b gy ng nh l ni nj">root@ip-172–31–32–175:/home/admin# docker-compose -f promtail-compose.yml restart</span></pre><p id="a038" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">几分钟后，我们现在有了格拉夫纳的数据:</p><figure class="lo lp lq lr gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="ls lt di lu bf lv"><div class="gh gi nm"><img src="../Images/3b66cd491b68f1f6a69ecd31467fa02b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*ekUcubDRQZoyECjh.png"/></div></div></figure><h2 id="2206" class="lw lx iq bd ly lz ma dn mb mc md dp me kf mf mg mh kj mi mj mk kn ml mm mn mo bi translated">标签</h2><p id="ccae" class="pw-post-body-paragraph ju jv iq jw b jx mp jz ka kb mq kd ke kf mr kh ki kj ms kl km kn mt kp kq kr ij bi translated">好的——现在一切正常，但我们将有一堆具有不同主机名的<em class="lm"> Dev </em>服务器，我们希望能够从不同的主机选择Grafana中的数据，因此——需要为每个主机添加额外的标签。</p><p id="5825" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">让我们添加一个新的主机，在那里有<code class="fe kt ku kv kw b">promtail</code>，类似于第一个:</p><figure class="lo lp lq lr gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="ls lt di lu bf lv"><div class="gh gi nn"><img src="../Images/4b7338421ba84fa81297429b03537583.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*dcd4agGIXDUS9ClL.png"/></div></div></figure><p id="ca5d" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">在那里创建一个类似的<code class="fe kt ku kv kw b">promtail2-conf.yml</code>配置:</p><pre class="lo lp lq lr gt nc kw nd ne aw nf bi"><span id="c5d9" class="lw lx iq kw b gy ng nh l ni nj">server:<br/><br/>  http_listen_port: 9080<br/>  grpc_listen_port: 0<br/><br/>positions:<br/><br/>  filename: /tmp/positions.yaml<br/><br/>client:<br/><br/>  url: <a class="ae ks" href="http://loki.setevoy.org.ua:3100/api/prom/push" rel="noopener ugc nofollow" target="_blank">http://loki.setevoy.org.ua:3100/api/prom/push</a><br/><br/>scrape_configs:<br/><br/>  - job_name: system<br/>    entry_parser: raw<br/>    static_configs:<br/>    - targets:<br/>        - localhost<br/>      labels:<br/>        job: varlogs<br/>        __path__: /var/log/*log<br/><br/>  - job_name: nginx<br/>    entry_parser: raw<br/>    static_configs:<br/>    - targets:<br/>        - localhost<br/>      labels:<br/>        job: nginx<br/>        host: promtail2<br/>        __path__: /var/log/nginx/*log</span></pre><p id="8b9f" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">这里唯一的区别是<em class="lm">主机:promtail2 </em>标签。</p><p id="6bf2" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">在第一个Dev的主机上添加带有<em class="lm"> promtail1 </em>值的相同的<code class="fe kt ku kv kw b">job</code>标签:</p><pre class="lo lp lq lr gt nc kw nd ne aw nf bi"><span id="3b9e" class="lw lx iq kw b gy ng nh l ni nj">...<br/>      labels:<br/>        job: nginx<br/>        host: promtail1<br/>        __path__: /var/log/nginx/*log<br/>...</span></pre><p id="ce77" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">首先，我想使用<code class="fe kt ku kv kw b">external_labels</code>通过<code class="fe kt ku kv kw b">global</code>部分添加它，因为我现在已经在我的普罗米修斯生产设置上安装了它:</p><pre class="lo lp lq lr gt nc kw nd ne aw nf bi"><span id="48c2" class="lw lx iq kw b gy ng nh l ni nj">global:<br/><br/>  scrape_interval:     15s<br/>  external_labels:<br/>    monitor: 'monitoring-production'<br/><br/>...</span></pre><p id="f4d6" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">但是洛基的<code class="fe kt ku kv kw b">global</code>没有这样的选项:</p><blockquote class="no np nq"><p id="c9b6" class="ju jv lm jw b jx jy jz ka kb kc kd ke nr kg kh ki ns kk kl km nt ko kp kq kr ij bi translated">正在创建admin_promtail_1 … done <br/>附加到admin _ prom tail _ 1<br/>prom tail _ 1 | level = error ts = 2019–02–07t 13:32:36.436335841 z caller = main . go:36 msg = " error loading config " filename =/etc/prom tail/docker-config . YAML err = " YAML:unmarshal错误:\n第1行:在类型api中未找到字段全局。配置"</p></blockquote><p id="12e4" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">由于文档没有关于可用选项的信息——让我们检查Loki的<a class="ae ks" href="https://github.com/grafana/loki/blob/master/pkg/promtail/api/config.go#L20" rel="noopener ugc nofollow" target="_blank">来源</a>:</p><pre class="lo lp lq lr gt nc kw nd ne aw nf bi"><span id="0f42" class="lw lx iq kw b gy ng nh l ni nj">...<br/><br/>type Config struct {<br/>  ServerConfig    server.Config    `yaml:"server,omitempty"`<br/>  ClientConfig    client.Config    `yaml:"client,omitempty"`<br/>  PositionsConfig positions.Config `yaml:"positions,omitempty"`<br/>  ScrapeConfig    []ScrapeConfig   `yaml:"scrape_configs,omitempty"`<br/>}<br/><br/>...<br/><br/>type ScrapeConfig struct {<br/>  JobName                string                           `yaml:"job_name,omitempty"`<br/>  EntryParser            EntryParser                      `yaml:"entry_parser"`<br/>  RelabelConfigs         []*relabel.Config                `yaml:"relabel_configs,omitempty"`<br/>  ServiceDiscoveryConfig sd_config.ServiceDiscoveryConfig `yaml:",inline"`<br/>}<br/><br/>...</span></pre><p id="25d0" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">有两个描述可用字段的结构——general和<code class="fe kt ku kv kw b">scrape_configs</code>。</p><p id="6826" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">在<em class="lm">提示符2 </em>主机上创建合成文件:</p><pre class="lo lp lq lr gt nc kw nd ne aw nf bi"><span id="b44f" class="lw lx iq kw b gy ng nh l ni nj">version: "3"<br/><br/>services:<br/><br/>  promtail:<br/>    image: grafana/promtail:master<br/>    volumes:<br/>      - /home/admin/promtail2-conf.yml:/etc/promtail/docker-config.yaml<br/>      - /var/log:/var/log<br/>    command: -config.file=/etc/promtail/docker-config.yaml<br/>    ports:<br/>      - "9080:9080"</span></pre><p id="841d" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">这也和我们的第一个相似，只是映射到容器的文件是<code class="fe kt ku kv kw b">/home/admin/promtail2-conf.yml</code>而不是<code class="fe kt ku kv kw b">/home/admin/promtail-conf.yml</code>。</p><p id="c321" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">在第一台主机上重新启动容器:</p><pre class="lo lp lq lr gt nc kw nd ne aw nf bi"><span id="ae29" class="lw lx iq kw b gy ng nh l ni nj">root@ip-172–31–32–175:/home/admin# docker-compose -f promtail-compose.yml restart</span></pre><p id="1b4c" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">从第二个开始:</p><pre class="lo lp lq lr gt nc kw nd ne aw nf bi"><span id="a976" class="lw lx iq kw b gy ng nh l ni nj">root@ip-172–31–44–176:/home/admin# docker-compose -f promtail-compose.yml up -d</span></pre><p id="b26c" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">并在其输出中得到错误— <em class="lm">“守望者。添加:没有这样的文件或目录"</em>:</p><blockquote class="no np nq"><p id="9882" class="ju jv lm jw b jx jy jz ka kb kc kd ke nr kg kh ki ns kk kl km nt ko kp kq kr ij bi translated">prom tail _ 1 | level = info ts = 2019–02–07t 13:55:05.004415129 z caller = file target manager . go:165 msg = " Adding target " key = " { job = \ " var logs \ " } "<br/>prom tail _ 1 | level = info ts = 2019–02–07t 13:55:05.004815207 z caller = file target manager . go:165 msg = "正在添加目标添加:没有这样的文件或目录"</p></blockquote><p id="36af" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">但是第一个问题很棘手:</p><blockquote class="no np nq"><p id="b408" class="ju jv lm jw b jx jy jz ka kb kc kd ke nr kg kh ki ns kk kl km nt ko kp kq kr ij bi translated">level = info ts = 2019–02–07t 13:43:52.153207236 z caller = file target manager . go:165 msg = " Adding target " key = " { job = \ " varlogs \ " } "<br/>level = info ts = 2019–02–07t 13:43:52.153657621 z caller = file target manager . go:165 msg = " Adding target " key = " { host = \ " prom tail 1</p></blockquote><p id="6531" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">WTF？</p><p id="3d62" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">嗯…</p><p id="d639" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">我在这里安装了NGINX吗？</p><pre class="lo lp lq lr gt nc kw nd ne aw nf bi"><span id="f9e0" class="lw lx iq kw b gy ng nh l ni nj">root@ip-172–31–44–176:/home/admin# dpkg -l | grep nginx</span></pre><p id="e346" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">嗯——没有……:-)</p><pre class="lo lp lq lr gt nc kw nd ne aw nf bi"><span id="865d" class="lw lx iq kw b gy ng nh l ni nj">root@ip-172–31–44–176:/home/admin# ls -l /var/log/nginx<br/>ls: cannot access ‘/var/log/nginx’: No such file or directory</span></pre><p id="4255" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">现在“<em class="lm">没有这样的文件或目录</em>”的错误就清楚了。</p><p id="5433" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">安装NGINX并重启<code class="fe kt ku kv kw b">promtail</code>:</p><pre class="lo lp lq lr gt nc kw nd ne aw nf bi"><span id="40a8" class="lw lx iq kw b gy ng nh l ni nj">root@ip-172–31–44–176:/home/admin# apt -y install nginx</span></pre><p id="d3e9" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">现在检查其输出:</p><blockquote class="no np nq"><p id="207c" class="ju jv lm jw b jx jy jz ka kb kc kd ke nr kg kh ki ns kk kl km nt ko kp kq kr ij bi translated">prom tail _ 1 | level = info ts = 2019–02–07t 13:59:54.422710535 z caller = file target manager . go:165 msg = " Adding target " key = " { job = \ " varlogs \ " } "<br/>prom tail _ 1 | level = info ts = 2019–02–07t 13:59:54.423260616 z caller = file target manager . go:165 msg = " Adding target "</p></blockquote><p id="885e" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">很好。</p><p id="da49" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">去格拉夫纳:</p><figure class="lo lp lq lr gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="ls lt di lu bf lv"><div class="gh gi nk"><img src="../Images/44d8894060ed49eab90ab587908986a0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*jxqQnJP3LBFQMltF.png"/></div></div></figure><p id="98f5" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">我们从两个主持人那里得到了两个标签。</p><h2 id="79ce" class="lw lx iq bd ly lz ma dn mb mc md dp me kf mf mg mh kj mi mj mk kn ml mm mn mo bi translated">洛基的查询过滤器示例</h2><p id="a080" class="pw-post-body-paragraph ju jv iq jw b jx mp jz ka kb mq kd ke kf mr kh ki kj ms kl km kn mt kp kq kr ij bi translated">今天的最后一件事——我们如何在Grafana中搜索和过滤结果的几个例子。</p><p id="aa59" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">此处的文档可用<a class="ae ks" href="http://docs.grafana.org/features/explore/#search-expression" rel="noopener ugc nofollow" target="_blank">&gt;&gt;&gt;</a>。</p><p id="ebf8" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">让我们从另一台主机向NGINX实例发出一些URL请求，以便在日志中记录一些内容:</p><pre class="lo lp lq lr gt nc kw nd ne aw nf bi"><span id="018d" class="lw lx iq kw b gy ng nh l ni nj">16:24:39 [setevoy@venti ~] $ curl <a class="ae ks" href="http://54.194.13.55/someuri" rel="noopener ugc nofollow" target="_blank">http://54.194.13.55/someuri</a></span></pre><p id="27bc" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">现在使用<em class="lm"> job == nginx </em>和<em class="lm"> host == promtail2 </em>进行搜索:</p><figure class="lo lp lq lr gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="ls lt di lu bf lv"><div class="gh gi nu"><img src="../Images/a6be87316d45894ebea461d67d48a50e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*as_rXvTYZj-NO5R5.png"/></div></div></figure><p id="1329" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">您也可以仅通过<em class="lm">77.120.103.20</em>IP过滤结果:</p><figure class="lo lp lq lr gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="ls lt di lu bf lv"><div class="gh gi nv"><img src="../Images/c71a8e02cadf004babe4cd7279f47203.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*G6w15kVqFKuMfhhw.png"/></div></div></figure><p id="7dca" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">或者使用正则表达式:</p><p id="fe5b" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated"><code class="fe kt ku kv kw b">{job="nginx", host="promtail2"} 77.120.[\d\.]</code></p><figure class="lo lp lq lr gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="ls lt di lu bf lv"><div class="gh gi nv"><img src="../Images/d65787bc337df83c0f1cc5d5427d9377.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*6ACqNZrb3_58B-5X.png"/></div></div></figure><p id="398c" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">或者用77.120中的“<em class="lm"> IP。[\d\]掩码，或者如果请求中有someuri单词</em>:</p><p id="fd7c" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated"><code class="fe kt ku kv kw b">{job="nginx", host="promtail2"} (77.120.[\d\.]|someuri)</code></p><figure class="lo lp lq lr gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="ls lt di lu bf lv"><div class="gh gi nv"><img src="../Images/258b10e0bf2127e17c930db67a85d42d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*CC7Wp1Q0qLzEZsvt.png"/></div></div></figure><p id="4ce2" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">目前就这些。</p><p id="154b" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">下一步将是为Loki配置AWS S3铲斗和AWS dynamo db——我将开始在我们的试运行环境中推广它。</p></div><div class="ab cl mv mw hu mx" role="separator"><span class="my bw bk mz na nb"/><span class="my bw bk mz na nb"/><span class="my bw bk mz na"/></div><div class="ij ik il im in"><p id="144d" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated"><em class="lm">最初发布于</em> <a class="ae ks" href="https://rtfm.co.ua/en/grafana-labs-loki-distributed-system-labels-and-filters/" rel="noopener ugc nofollow" target="_blank"> <em class="lm"> RTFM: Linux、DevOps和系统管理</em> </a> <em class="lm">。</em></p></div></div>    
</body>
</html>