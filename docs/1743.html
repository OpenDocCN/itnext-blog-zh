<html>
<head>
<title>Jaeger Tracing on Kubernetes with ASP.NET Core and Traefik</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用ASP.NET岩心和Traefik对Kubernetes进行Jaeger示踪</h1>
<blockquote>原文：<a href="https://itnext.io/jaeger-tracing-on-kubernetes-with-asp-net-core-and-traefik-86b1d9fd5489?source=collection_archive---------3-----------------------#2019-01-16">https://itnext.io/jaeger-tracing-on-kubernetes-with-asp-net-core-and-traefik-86b1d9fd5489?source=collection_archive---------3-----------------------#2019-01-16</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="8073" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">可能是艰难的方式</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/91503b49bb8b669e21eb0d6ccaceb0a4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*H_ZH25guMR28DDV6LhBwAg.png"/></div></div></figure><p id="0393" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated"><em class="ln">这是我之前写的一篇</em> <a class="ae lo" href="https://medium.com/imaginelearning/jaeger-tracing-on-kubernetes-with-net-core-8b5feddb6f2f" rel="noopener"> <em class="ln">文章</em> </a> <em class="ln">的后续文章，其中使用了Jaeger一体化部署。本教程将演示一个生产就绪的Jaeger部署，以及一些改进。net核心代码。与前一篇文章不同，我用Elasticsearch将Jaeger收集器、查询和代理分成单独的组件进行存储。我们还为</em><a class="ae lo" href="https://traefik.io/" rel="noopener ugc nofollow" target="_blank"><em class="ln">Traefik</em></a><em class="ln">添加了对Jaeger跟踪的支持，以通过我们的边缘路由器跟踪轨迹。</em></p><p id="87fd" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated"><em class="ln">值得一提的是，Jaeger空间变化很快，在你的集群上设置Jaeger可能有更简单的方法，比如</em> <a class="ae lo" href="https://medium.com/jaegertracing/jaeger-operator-for-kubernetes-b3128f3c4943" rel="noopener"> <em class="ln">这个</em> </a> <em class="ln">。</em></p><h1 id="b3f0" class="lp lq iq bd lr ls lt lu lv lw lx ly lz jw ma jx mb jz mc ka md kc me kd mf mg bi translated">耶格特工</h1><p id="c968" class="pw-post-body-paragraph kr ks iq kt b ku mh jr kw kx mi ju kz la mj lc ld le mk lg lh li ml lk ll lm ij bi translated">Jaeger代理监听来自客户端的跨度，并将它们发送到Jaeger收集器。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="mm mn l"/></div></figure><p id="6825" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">代理yaml基本上与模板相同，只是添加了一些资源限制，并将配置嵌入到一个秘密中，如果您有敏感的配置数据，如elasticsearch密码，这就更好了。如果你正在考虑是使用边车还是daemonset，<a class="ae lo" href="https://medium.com/jaegertracing/deployment-strategies-for-the-jaeger-agent-1d6f91796d09" rel="noopener">这篇</a>是一篇比较两者区别的好博文。我们选择使用daemonset，作为daemonset，我们可以通过Kubernetes downwards api访问代理ip，如下所示:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="mm mn l"/></div><figcaption class="mo mp gj gh gi mq mr bd b be z dk translated">通过env变量访问代理/节点ip。</figcaption></figure><p id="2b3f" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">这使得pods能够访问运行它们的节点ip，即jaeger代理主机ip。</p><h1 id="84a6" class="lp lq iq bd lr ls lt lu lv lw lx ly lz jw ma jx mb jz mc ka md kc me kd mf mg bi translated">耶格收集器</h1><p id="c038" class="pw-post-body-paragraph kr ks iq kt b ku mh jr kw kx mi ju kz la mj lc ld le mk lg lh li ml lk ll lm ij bi translated">Jaeger收集器从Jaeger代理中提取跟踪信息，并对其进行验证、索引、转换和存储。对于我们的存储，我们使用了现有的Elasticsearch集群。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="mm mn l"/></div></figure><p id="de6b" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">同样，这类似于这里提供的收集器模板<a class="ae lo" href="https://github.com/jaegertracing/jaeger-kubernetes/blob/master/jaeger-production-template.yml" rel="noopener ugc nofollow" target="_blank"/>，除了我们添加了资源限制和请求(我们发现收集器不是非常资源密集型的)并从秘密中提取配置值。如果您的Elasticsearch实例是通过TLS访问的，那么您需要在Jaeger收集器上安装您的证书，并包含<code class="fe ms mt mu mv b">--es.tls</code>标志。我们还挂载了一个采样策略json文件来支持远程采样。远程采样允许您直接从收集器动态控制不同服务和端点的采样策略。这意味着您可以更改跟踪吞吐量，而不必重新启动服务。</p><h1 id="1d8b" class="lp lq iq bd lr ls lt lu lv lw lx ly lz jw ma jx mb jz mc ka md kc me kd mf mg bi translated">耶格查询</h1><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="mm mn l"/></div></figure><p id="f4c5" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">我们在这里做了一些小的改动，即把服务隐藏在入口后面，这样我们就可以很容易地在一个组织的主机名中公开我们的UI。我们还通过基本认证保护了Jaeger UI。类似于耶格收集器，我们需要<code class="fe ms mt mu mv b">--es.tls</code>旗帜和安装证书。</p><p id="05a0" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">配置jaeger使用elasticsearch需要什么？基本上，您需要告诉Jaeger查询和收集器在哪里查找证书，如下所示:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="mm mn l"/></div></figure><h1 id="ff10" class="lp lq iq bd lr ls lt lu lv lw lx ly lz jw ma jx mb jz mc ka md kc me kd mf mg bi translated">用Jaeger配置Traefik</h1><p id="509b" class="pw-post-body-paragraph kr ks iq kt b ku mh jr kw kx mi ju kz la mj lc ld le mk lg lh li ml lk ll lm ij bi translated">如果您想通过您的边缘路由器(在本例中为Traefik)跟踪您的服务，您可以这样做。以下几行可以添加到您的<code class="fe ms mt mu mv b">traefik.toml</code>文件中。我们将跟踪类型设置为速率限制，并对1/1000个请求进行采样。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="mm mn l"/></div></figure><p id="d642" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">Traefik还需要知道Jaeger代理主机和端口。对我们来说，这些值存在于环境变量中(参见上面的Jaeger Agent部分)。这意味着我们不能在toml文件中设置<code class="fe ms mt mu mv b">localagenthostport</code>或<code class="fe ms mt mu mv b">samplingserverurl</code>配置值，而是必须将它们作为参数传递给docker映像。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="mm mn l"/></div></figure><p id="b38d" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">设置好Treafik后，下一步是将其跟踪链接到您的服务。因为边缘路由器应该作为所有服务子跨度的父出现。</p><h1 id="4991" class="lp lq iq bd lr ls lt lu lv lw lx ly lz jw ma jx mb jz mc ka md kc me kd mf mg bi translated">Asp。网络核心代码</h1><p id="a775" class="pw-post-body-paragraph kr ks iq kt b ku mh jr kw kx mi ju kz la mj lc ld le mk lg lh li ml lk ll lm ij bi translated">为了让其他开发者更容易使用Jaeger，我建立了一些默认值和配置，可以在<code class="fe ms mt mu mv b">startup.cs</code>的依赖注入中使用。为此，我首先定义了一些默认的Jaeger选项，如下所示:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="mm mn l"/></div></figure><p id="05a5" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">此外，我实现了IServiceCollection扩展，简化了Jaeger的初始设置。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="mm mn l"/></div></figure><p id="bf2f" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">我们的默认设置包括一个<code class="fe ms mt mu mv b">GuaranteedThroughputSampler</code>和一个配置了jaeger代理主机和端口的报告器。此外，添加<code class="fe ms mt mu mv b">services.AddOpenTracing()</code>将能够自动跟踪我们的端点。然而，这意味着您的<code class="fe ms mt mu mv b">/health</code>和<code class="fe ms mt mu mv b">/metrics</code>端点也将生成踪迹。所以为了避免这些痕迹的膨胀，你可以通过指定忽略模式来忽略它们。现在我们已经有了易用的代码，我们可以在<code class="fe ms mt mu mv b">startup.cs</code>中用下面几行简单的代码设置Jaeger:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="mm mn l"/></div></figure><p id="7743" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">通过设置<code class="fe ms mt mu mv b">options.SamplingRate</code>和<code class="fe ms mt mu mv b">options.LowerBound</code>覆盖默认值。</p><p id="b071" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">感谢您的阅读，希望这能简化您使用Jaeger tracing的过程。</p><h1 id="d1c5" class="lp lq iq bd lr ls lt lu lv lw lx ly lz jw ma jx mb jz mc ka md kc me kd mf mg bi translated">额外资源</h1><ul class=""><li id="ff27" class="mw mx iq kt b ku mh kx mi la my le mz li na lm nb nc nd ne bi translated">将Jaeger部署到您的Kubernetes集群看起来是一种令人兴奋且可能更简单的方式</li><li id="44b0" class="mw mx iq kt b ku nf kx ng la nh le ni li nj lm nb nc nd ne bi translated">改进的<a class="ae lo" href="https://medium.com/jaegertracing/jaeger-elasticsearch-and-kibana-7ecb846137b6" rel="noopener"> Elasticsearch和Kibana </a>支持</li><li id="1b59" class="mw mx iq kt b ku nf kx ng la nh le ni li nj lm nb nc nd ne bi translated"><a class="ae lo" href="https://www.jaegertracing.io/docs/1.8/deployment/" rel="noopener ugc nofollow" target="_blank">耶格部署</a></li><li id="9c4e" class="mw mx iq kt b ku nf kx ng la nh le ni li nj lm nb nc nd ne bi translated"><a class="ae lo" href="https://github.com/jaegertracing/jaeger-kubernetes" rel="noopener ugc nofollow" target="_blank">https://github.com/jaegertracing/jaeger-kubernetes</a></li><li id="7746" class="mw mx iq kt b ku nf kx ng la nh le ni li nj lm nb nc nd ne bi translated"><a class="ae lo" href="https://github.com/jaegertracing/jaeger-client-csharp" rel="noopener ugc nofollow" target="_blank">https://github.com/jaegertracing/jaeger-client-csharp</a></li></ul></div></div>    
</body>
</html>