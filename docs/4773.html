<html>
<head>
<title>Kubernetes Production Cluster with Vagrant and Virtualbox on MacOS</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Kubernetes生产集群，带有MacOS上的vagger和Virtualbox</h1>
<blockquote>原文：<a href="https://itnext.io/kubernetes-production-cluster-with-vagrant-and-virtualbox-on-mac-8718586f179f?source=collection_archive---------0-----------------------#2020-09-14">https://itnext.io/kubernetes-production-cluster-with-vagrant-and-virtualbox-on-mac-8718586f179f?source=collection_archive---------0-----------------------#2020-09-14</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><figure class="gl gn jr js jt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi jq"><img src="../Images/483e78a1951e14e1627ae889476166de.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*PXuTeJTsKrNuAeh3"/></div></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated">约瑟夫·巴里恩托斯在<a class="ae kf" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</figcaption></figure><p id="c263" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">出于开发的目的，在本地拥有一个Kubernetes生产集群是非常好的，在这篇文章中，我将介绍基本的设置，以便开始使用一个好的集群。</p><h1 id="1635" class="le lf it bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated"><strong class="ak">库比斯普雷前来救援</strong></h1><p id="638d" class="pw-post-body-paragraph kg kh it ki b kj mc kl km kn md kp kq kr me kt ku kv mf kx ky kz mg lb lc ld im bi translated">很少有开源解决方案可以完成部署生产就绪的Kubernetes集群的任务，但是我选择了Kubespray。</p><p id="bc70" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">它附带了可翻译的行动手册(部署、升级、实用程序和附加程序)以及大量测试。</p><p id="110d" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">应该已经安装了什么:</p><ul class=""><li id="f4c9" class="mh mi it ki b kj kk kn ko kr mj kv mk kz ml ld mm mn mo mp bi translated">无赖</li><li id="9f40" class="mh mi it ki b kj mq kn mr kr ms kv mt kz mu ld mm mn mo mp bi translated">Virtualbox</li><li id="0d63" class="mh mi it ki b kj mq kn mr kr ms kv mt kz mu ld mm mn mo mp bi translated">Python + Pip</li></ul><p id="0be2" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">让我们克隆一下官方回购:</p><pre class="mv mw mx my gt mz na nb nc aw nd bi"><span id="0347" class="ne lf it na b gy nf ng l nh ni">git clone <a class="ae kf" href="https://github.com/kubernetes-sigs/kubespray" rel="noopener ugc nofollow" target="_blank">https://github.com/kubernetes-sigs/kubespray</a></span></pre><p id="26e1" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">之后，进入克隆的repo，我们可以开始安装所需的工具:</p><pre class="mv mw mx my gt mz na nb nc aw nd bi"><span id="e036" class="ne lf it na b gy nf ng l nh ni">cd kubespray &amp;&amp; pip3 install -r requirements.txt</span><span id="6669" class="ne lf it na b gy nj ng l nh ni"># OR</span><span id="0334" class="ne lf it na b gy nj ng l nh ni">cd kubespray &amp;&amp; pip install -r requirements.txt</span></pre><p id="2057" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">一旦一切都被正确安装，我们可以开始流浪:</p><pre class="mv mw mx my gt mz na nb nc aw nd bi"><span id="f8a4" class="ne lf it na b gy nf ng l nh ni">vagrant up</span></pre><p id="cdd1" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">该命令将生成虚拟机，在其上安装Kubernetes，并配置网络。在没有定制的情况下调用时，它会获取位于<em class="nk"> /inventory/sample </em>中的示例配置。内部YAML文件允许为计划的集群定制所需的任何内容。此外,<em class="nk">流浪者文件</em>包含了所产生的虚拟机的所有必要规范(因此它允许我们配置网络、虚拟机的映像、其属性等等)。</p><p id="781a" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">当这个过程完成时，集群被成功创建，我们可以使用自动注入到工件文件夹中的配置。</p><p id="f844" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">让我们进入<em class="nk">。移动</em>文件夹以便访问它:</p><pre class="mv mw mx my gt mz na nb nc aw nd bi"><span id="9909" class="ne lf it na b gy nf ng l nh ni">cd .vagrant/provisioners/ansible/inventory/artifacts</span></pre><p id="9528" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">有3个文件:</p><pre class="mv mw mx my gt mz na nb nc aw nd bi"><span id="7f49" class="ne lf it na b gy nf ng l nh ni">admin.conf     kubectl    kubectl.sh</span></pre><p id="43f0" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">我们需要的是“<em class="nk"> admin.conf </em>”，它包含我们新创建的本地集群的配置(并设置Kubectl使用它)。</p><pre class="mv mw mx my gt mz na nb nc aw nd bi"><span id="9c1f" class="ne lf it na b gy nf ng l nh ni">export KUBECONFIG=$(pwd)/admin.conf</span></pre><p id="38d7" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">因此，让我们检查到我们的集群的连接:</p><pre class="mv mw mx my gt mz na nb nc aw nd bi"><span id="dc90" class="ne lf it na b gy nf ng l nh ni">$ kubectl cluster-info</span><span id="a33d" class="ne lf it na b gy nj ng l nh ni">Kubernetes master is running at <a class="ae kf" href="https://172.18.8.101:6443" rel="noopener ugc nofollow" target="_blank">https://172.18.8.101:6443</a></span><span id="f041" class="ne lf it na b gy nj ng l nh ni">To further debug and diagnose cluster problems, use 'kubectl cluster-info dump'.</span></pre><p id="32ab" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">太好了，我们现在连接到集群了。</p><p id="06b6" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">默认情况下，Virtualbox使用NAT网络类型来隔离所创建的虚拟机，因此我们需要使用端口转发来从外部访问所需的虚拟机。</p><pre class="mv mw mx my gt mz na nb nc aw nd bi"><span id="86bd" class="ne lf it na b gy nf ng l nh ni">$ vagrant status</span><span id="178e" class="ne lf it na b gy nj ng l nh ni">Current machine states:</span><span id="54a7" class="ne lf it na b gy nj ng l nh ni">k8s-1                     running (virtualbox) # usually master node<br/>k8s-2                     running (virtualbox)<br/>k8s-3                     running (virtualbox)</span></pre><p id="5c08" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">和列出Virtualbox实例</p><pre class="mv mw mx my gt mz na nb nc aw nd bi"><span id="fc06" class="ne lf it na b gy nf ng l nh ni">$ vboxmanage list vms</span><span id="87b1" class="ne lf it na b gy nj ng l nh ni">"kubespray_k8s-1_1599909087609_21866" {30ba6c6e-6a1d-4647-8f67-9f3f8276d660}<br/>"kubespray_k8s-2_1599909125366_77977" {f618bfd4-fe82-4437-8e57-2bce2bb9e2b1}<br/>"kubespray_k8s-3_1599909169592_4503" {86275e53-025f-4021-85a8-2ff23a0099cb}</span></pre><p id="0aec" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">因此，我们想要做的是，公开id为"<em class="nk">30 ba 6 c6e-6a1d-4647–8f 67–9f3f 8276d 660</em>"的k8s-1机器。对于NAT网络，我们需要使用从主机到客户机的端口转发，这样做是可能的:</p><pre class="mv mw mx my gt mz na nb nc aw nd bi"><span id="1ad5" class="ne lf it na b gy nf ng l nh ni">vboxmanage controlvm 30ba6c6e-6a1d-4647–8f67–9f3f8276d660 natpf1 "master-node,tcp,,6443,,6443"</span></pre><p id="d1a7" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">此命令正在为k8s-1主节点创建端口转发规则。“主节点”是您想要的任意名称，TCP是协议，在两个逗号之间我们不指定任何IP(做两次)，并且对于主机/客户机我们分配相同的端口(在本例中是6443)。</p><p id="2bca" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">一旦启动，该命令将通过端口转发暴露我们的集群。</p><p id="c218" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">Kubespray可以配置很多东西，比如网络管理解决方案、入口控制器、节点数量等...我推荐查看以下链接的官方页面<a class="ae kf" href="https://kubespray.io/" rel="noopener ugc nofollow" target="_blank">https://kubespray.io/</a></p><p id="86ba" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">希望有帮助！</p><p id="66e9" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">干杯:)</p></div></div>    
</body>
</html>