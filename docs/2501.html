<html>
<head>
<title>How to setup CodeClimate and CircleCI 2.0 parallel builds to run RSpec with SimpleCov and JUnit formatter</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何设置CodeClimate和CircleCI 2.0并行版本以使用SimpleCov和JUnit格式化程序运行RSpec</h1>
<blockquote>原文：<a href="https://itnext.io/how-to-setup-codeclimate-and-circleci-2-0-3a85e559bca6?source=collection_archive---------7-----------------------#2019-06-03">https://itnext.io/how-to-setup-codeclimate-and-circleci-2-0-3a85e559bca6?source=collection_archive---------7-----------------------#2019-06-03</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="5790" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如何为你的<strong class="jp ir"> RSpec </strong>测试套件合并<strong class="jp ir"> CodeClimate </strong>报告，该测试套件在CircleCI 2.0上执行并行构建？您将学习如何使用CircleCI为您的for <strong class="jp ir"> Ruby on Rails </strong>项目运行RSpec并行测试，以及如何将并行作业合并的测试覆盖发送到CodeClimate。我们将介绍以下配置示例:</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi kl"><img src="../Images/6686cf507a4e3afb041211cade572999.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*y4X4foFAQVddY1wD.jpg"/></div></div></figure><ul class=""><li id="870a" class="kx ky iq jp b jq jr ju jv jy kz kc la kg lb kk lc ld le lf bi translated">如何使用CodeClimate Test Reporter所需的<strong class="jp ir"> SimpleCov </strong>来准备每个并行作业上的RSpec测试覆盖摘要，然后如何合并它，以便您能够将其发送到CodeClimate dashboard。</li><li id="3f8d" class="kx ky iq jp b jq lg ju lh jy li kc lj kg lk kk lc ld le lf bi translated">如何使用并行作业上运行的RSpec的<strong class="jp ir"> JUnit </strong>格式化程序。多亏了JUnit formatter，您可以在CircleCI UI视图中看到漂亮的测试结果。例如，当您的测试失败时，CircleCI会在CI构建步骤的顶部显示失败的测试。</li><li id="7b87" class="kx ky iq jp b jq lg ju lh jy li kc lj kg lk kk lc ld le lf bi translated">如何<a class="ae ll" href="https://knapsackpro.com/?utm_source=medium&amp;utm_medium=blog&amp;utm_campaign=codeclimate-and-circleci-2-0-parallel-builds-config-for-rspec-with-simplecov-and-junit-formatter" rel="noopener ugc nofollow" target="_blank">使用backpack Pro队列模式</a>将您的RSpec测试拆分到并行作业中。在文章的最后，您将看到一个视频，解释backpackage _ pro ruby gem中的队列模式如何在并行作业之间动态分配规格，以确保每个作业花费相似的时间，从而确保CI构建尽可能快(以获得最佳的CI构建时间)。</li></ul><h1 id="ccd8" class="lm ln iq bd lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj bi translated">基于CircleCI 2.0的CodeClimate和并行构建</h1><p id="3854" class="pw-post-body-paragraph jn jo iq jp b jq mk js jt ju ml jw jx jy mm ka kb kc mn ke kf kg mo ki kj kk ij bi translated">让我们从CircleCI 2.0的完整YAML配置开始。您会发现每个重要步骤的注释及其作用。您可能已经在项目中配置了一些东西，所以查看下面的完整示例可能对您更熟悉。如果你是第一次将CodeClimate添加到你的项目中，那么除了下面的配置之外，你需要设置simplecov gem，这将在下一节中介绍。</p><p id="fe0a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">下面是使用RSpec和CodeClimate进行并行构建的完整CircleCI 2.0示例。</p><pre class="km kn ko kp gt mp mq mr ms aw mt bi"><span id="f2ea" class="mu ln iq mq b gy mv mw l mx my"><em class="mz"># .circleci/config.yml</em><br/>version: 2<br/>jobs:<br/>  build:<br/>    <em class="mz"># set here how many parallel jobs you want to run.</em><br/>    <em class="mz"># more parallel jobs the faster is your CI build</em><br/>    parallelism: 2<br/>    docker:<br/>      <em class="mz"># specify the version you desire here</em><br/>      - image: circleci/ruby:2.6.3-node-browsers<br/>        environment:<br/>          PGHOST: 127.0.0.1<br/>          PGUSER: rails-app-with-knapsack_pro<br/>          RAILS_ENV: test<br/>          RACK_ENV: test<br/><br/>          <em class="mz"># API token should be set in CircleCI environment variables settings instead of here</em><br/>          <em class="mz"># KNAPSACK_PRO_TEST_SUITE_TOKEN_RSPEC: rspec-token</em><br/><br/>      <em class="mz"># Specify service dependencies here if necessary</em><br/>      <em class="mz"># CircleCI maintains a library of pre-built images</em><br/>      <em class="mz"># documented at https://circleci.com/docs/2.0/circleci-images/</em><br/>      - image: circleci/postgres:9.4.12-alpine<br/>        environment:<br/>          POSTGRES_DB: rails-app-with-knapsack_pro_test<br/>          POSTGRES_PASSWORD: ""<br/>          POSTGRES_USER: rails-app-with-knapsack_pro<br/><br/>    working_directory: ~/repo<br/><br/>    steps:<br/>      - checkout<br/><br/>      <em class="mz"># create directory for xml reports created by junit formatter</em><br/>      - run: mkdir -p tmp/test-reports/rspec/queue_mode/<br/><br/>      - run:<br/>          name: Install Code Climate Test Reporter<br/>          command: |<br/>            curl -L https://codeclimate.com/downloads/test-reporter/test-reporter-latest-linux-amd64 &gt; ./cc-test-reporter<br/>            chmod +x ./cc-test-reporter<br/>      - run: ./cc-test-reporter before-build<br/><br/>      <em class="mz"># Download and cache dependencies</em><br/>      - restore_cache:<br/>          keys:<br/>          - v2-dependencies-bundler-{{ checksum "Gemfile.lock" }}<br/>          <em class="mz"># fallback to using the latest cache if no exact match is found</em><br/>          - v2-dependencies-bundler-<br/><br/>      - run:<br/>          name: install ruby dependencies<br/>          command: |<br/>            bundle install --jobs=4 --retry=3 --path vendor/bundle<br/><br/>      - save_cache:<br/>          paths:<br/>            - ./vendor/bundle<br/>          key: v2-dependencies-bundler-{{ checksum "Gemfile.lock" }}<br/><br/>      <em class="mz"># wait for postgres to be available</em><br/>      - run: dockerize -wait tcp://localhost:5432 -timeout 1m<br/>      <em class="mz"># Database setup</em><br/>      - run: bin/rails db:setup<br/><br/>      <em class="mz"># Run RSpec tests with knapsack_pro Queue Mode and use junit formatter</em><br/>      <em class="mz"># junit formatter must be configured as described in FAQ for knapsack_pro Queue Mode</em><br/>      <em class="mz"># this is also described in this article later</em><br/>      <em class="mz"># https://github.com/KnapsackPro/knapsack_pro-ruby#how-to-use-junit-formatter-with-knapsack_pro-queue-mode</em><br/>      - run: bundle exec rake "knapsack_pro:queue:rspec[--format documentation --format RspecJunitFormatter --out tmp/test-reports/rspec/queue_mode/rspec.xml]"<br/><br/>      - run:<br/>          name: Code Climate Test Coverage<br/>          command: |<br/>            ./cc-test-reporter format-coverage -t simplecov -o "coverage/codeclimate.$CIRCLE_NODE_INDEX.json"<br/><br/>      <em class="mz"># store coverage directory with CodeClimate reports prepared based on simplecov reports</em><br/>      <em class="mz"># it's special step used to persist a temporary file to be used by another job in the workflow</em><br/>      - persist_to_workspace:<br/>          root: coverage<br/>          paths:<br/>            - codeclimate.*.json<br/><br/>      <em class="mz"># store test reports created with junit formatter in order to allow CircleCI </em><br/>      <em class="mz"># show info about executed tests in UI on top of CI build steps</em><br/>      - store_test_results:<br/>          path: tmp/test-reports<br/><br/>      <em class="mz"># store test reports created with junit formatter in order to allow CircleCI </em><br/>      <em class="mz"># let you browse recorded xml files in Artifacts tab</em><br/>      - store_artifacts:<br/>          path: tmp/test-reports<br/><br/>  upload-coverage:<br/>    docker:<br/>      - image: circleci/ruby:2.6.3-node<br/>    environment:<br/>      <em class="mz"># you can add your CodeClimate test report ID here or in CircleCI</em><br/>      <em class="mz"># settings for environment variables</em><br/>      CC_TEST_REPORTER_ID: use-here-your-codeclimate-test-report-id<br/>    working_directory: ~/repo<br/><br/>    steps:<br/>      <em class="mz"># This will restore files from persist_to_workspace step</em><br/>      <em class="mz"># Thanks to it we will have access to CodeClimate test coverage files from</em><br/>      <em class="mz"># each parallel job. We need them in order to merge it into one file in next step.</em><br/>      - attach_workspace:<br/>          at: ~/repo<br/>      - run:<br/>          name: Install Code Climate Test Reporter<br/>          command: |<br/>            curl -L https://codeclimate.com/downloads/test-reporter/test-reporter-latest-linux-amd64 &gt; ./cc-test-reporter<br/>            chmod +x ./cc-test-reporter<br/>      - run:<br/>          <em class="mz"># merge CodeClimate files from each parallel job into sum coverage</em><br/>          <em class="mz"># and then upload it to CodeClimate dashboard</em><br/>          command: |<br/>            ./cc-test-reporter sum-coverage --output - codeclimate.*.json | ./cc-test-reporter upload-coverage --debug --input -<br/><br/>workflows:<br/>  version: 2<br/><br/>  commit:<br/>    jobs:<br/>      <em class="mz"># run our CI build with tests</em><br/>      - build<br/>      <em class="mz"># once CI build is completed then we merge CodeClimate reports</em><br/>      <em class="mz"># from each parallel job and upload summary coverage to CodeClimate</em><br/>      - upload-coverage:<br/>          requires:<br/>             - build</span></pre><h1 id="63bf" class="lm ln iq bd lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj bi translated">RSpec的SimpleCov配置</h1><p id="6f3d" class="pw-post-body-paragraph jn jo iq jp b jq mk js jt ju ml jw jx jy mm ka kb kc mn ke kf kg mo ki kj kk ij bi translated">当您使用<a class="ae ll" href="https://github.com/colszowka/simplecov" rel="noopener ugc nofollow" target="_blank"> simplecov </a> gem来为RSpec创建测试覆盖时，当您想要在许多CircleCI作业上并行运行测试时，您需要记住另外一件事情。使用<code class="fe na nb nc mq b">SimpleCov.command_name</code>为simplecov报告设置一个唯一的名称。</p><pre class="km kn ko kp gt mp mq mr ms aw mt bi"><span id="3940" class="mu ln iq mq b gy mv mw l mx my"><em class="mz"># spec/rails_helper.rb or spec/spec_helper.rb</em><br/>require 'simplecov'<br/>SimpleCov.<strong class="mq ir">start</strong><br/><br/><em class="mz"># this is needed when you use knapsack_pro Queue Mode</em><br/>KnapsackPro<strong class="mq ir">::</strong>Hooks<strong class="mq ir">::</strong>Queue.<strong class="mq ir">before_queue</strong> <strong class="mq ir">do</strong><br/>  SimpleCov.<strong class="mq ir">command_name</strong>("rspec_ci_node_#{KnapsackPro<strong class="mq ir">::</strong>Config<strong class="mq ir">::</strong>Env.<strong class="mq ir">ci_node_index</strong>}")<br/><strong class="mq ir">end</strong></span></pre><h1 id="a724" class="lm ln iq bd lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj bi translated">RSpec的JUnit格式化程序</h1><p id="ba07" class="pw-post-body-paragraph jn jo iq jp b jq mk js jt ju ml jw jx jy mm ka kb kc mn ke kf kg mo ki kj kk ij bi translated">为了在CircleCI UI中显示关于您的测试套件的信息，比如失败的测试，您需要使用JUnit formatter为您的RSpec测试套件生成xml报告。</p><p id="7f5b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">由于gem<a class="ae ll" href="https://github.com/sj26/rspec_junit_formatter" rel="noopener ugc nofollow" target="_blank">RSpec _ JUnit _ formatter</a>，您可以为RSpec使用junit formatter。</p><pre class="km kn ko kp gt mp mq mr ms aw mt bi"><span id="ef9d" class="mu ln iq mq b gy mv mw l mx my"><em class="mz"># knapsack_pro Queue Mode</em><br/>bundle exec rake "knapsack_pro:queue:rspec[--format documentation --format RspecJunitFormatter --out tmp/test-reports/rspec/queue_mode/rspec.xml]"</span></pre><p id="4dea" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">xml报告将包含在基于工作队列的中间测试子集运行中执行的所有测试。您需要在子集队列钩子之后添加一个钩子来将<code class="fe na nb nc mq b">rspec.xml</code>重命名为<code class="fe na nb nc mq b">rspec_final_results.xml</code>,因为最终的结果文件将只包含一个xml标签，所有的测试都在CI节点上执行。这与队列模式的工作方式有关。详细解释在<a class="ae ll" href="https://github.com/KnapsackPro/knapsack_pro-ruby/issues/40" rel="noopener ugc nofollow" target="_blank">刊</a>中。</p><pre class="km kn ko kp gt mp mq mr ms aw mt bi"><span id="1f41" class="mu ln iq mq b gy mv mw l mx my"><em class="mz"># spec_helper.rb or rails_helper.rb</em><br/><br/><em class="mz"># TODO This must be the same path as value for rspec --out argument</em><br/><em class="mz"># Note the path should not contain sign ~, for instance path ~/project/tmp/rspec.xml may not work. Please use full path instead.</em><br/>TMP_RSPEC_XML_REPORT <strong class="mq ir">=</strong> 'tmp/test-reports/rspec/queue_mode/rspec.xml'<br/><em class="mz"># move results to FINAL_RSPEC_XML_REPORT so the results won't accumulate with duplicated xml tags in TMP_RSPEC_XML_REPORT</em><br/>FINAL_RSPEC_XML_REPORT <strong class="mq ir">=</strong> 'tmp/test-reports/rspec/queue_mode/rspec_final_results.xml'<br/><br/>KnapsackPro<strong class="mq ir">::</strong>Hooks<strong class="mq ir">::</strong>Queue.<strong class="mq ir">after_subset_queue</strong> <strong class="mq ir">do</strong> <strong class="mq ir">|</strong>queue_id, subset_queue_id<strong class="mq ir">|</strong><br/>  <strong class="mq ir">if</strong> File.<strong class="mq ir">exist?</strong>(TMP_RSPEC_XML_REPORT)<br/>    FileUtils.<strong class="mq ir">mv</strong>(TMP_RSPEC_XML_REPORT, FINAL_RSPEC_XML_REPORT)<br/>  <strong class="mq ir">end</strong><br/><strong class="mq ir">end</strong></span></pre><p id="3c64" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这个例子基于<a class="ae ll" href="https://github.com/KnapsackPro/knapsack_pro-ruby#how-to-use-junit-formatter" rel="noopener ugc nofollow" target="_blank">常见问题</a>。</p><h1 id="2873" class="lm ln iq bd lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj bi translated">摘要和队列模式来做动态测试套件拆分</h1><p id="234f" class="pw-post-body-paragraph jn jo iq jp b jq mk js jt ju ml jw jx jy mm ka kb kc mn ke kf kg mo ki kj kk ij bi translated">由于利用了Circle CI 2.0上的并行作业和任何CI提供者上的CI并行化，CI构建可以快得多(<a class="ae ll" href="https://docs.knapsackpro.com/" rel="noopener ugc nofollow" target="_blank">查看更多CI提供者的并行化示例</a>)。您可以查看<a class="ae ll" href="https://knapsackpro.com/?utm_source=medium&amp;utm_medium=blog&amp;utm_campaign=codeclimate-and-circleci-2-0-parallel-builds-config-for-rspec-with-simplecov-and-junit-formatter" rel="noopener ugc nofollow" target="_blank">背包Pro CI并行化工具</a>，并在下面的视频中了解更多关于队列模式及其解决的问题。</p><figure class="km kn ko kp gt kq"><div class="bz fp l di"><div class="nd ne l"/></div></figure><p id="b81e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><a class="ae ll" href="https://docs.knapsackpro.com/knapsack_pro-ruby/guide/" rel="noopener ugc nofollow" target="_blank">可以在这里找到backpack _ pro gem</a>的安装指南，以便设置您的RSpec测试套件。</p><p id="b747" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi">— — —</p><p id="c5c7" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">最初发布于:<a class="ae ll" href="https://docs.knapsackpro.com/2019/codeclimate-and-circleci-2-0-parallel-builds-config-for-rspec-with-simplecov-and-junit-formatter" rel="noopener ugc nofollow" target="_blank">https://docs . knapsackpro . com/2019/code climate-and-circle ci-2-0-parallel-builds-config-for-rspec-with-simple cov-and-JUnit-formatter</a></p></div></div>    
</body>
</html>