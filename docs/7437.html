<html>
<head>
<title>Multi-tenancy with Loki, Promtail, and Grafana demystified</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">解除了Loki、Promtail和Grafana的多租户功能</h1>
<blockquote>原文：<a href="https://itnext.io/multi-tenancy-with-loki-promtail-and-grafana-demystified-e93a2a314473?source=collection_archive---------0-----------------------#2022-09-23">https://itnext.io/multi-tenancy-with-loki-promtail-and-grafana-demystified-e93a2a314473?source=collection_archive---------0-----------------------#2022-09-23</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/533e2dea97593ced59bcf5e110fa71a1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*m3lvdr7YGtJ17Cu0MM_fwQ.png"/></div></div></figure><p id="ae39" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">了解如何使用Loki、Grafana和Promtail创建企业级多租户日志记录设置。</p><p id="2042" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">上周，我们在<a class="ae kw" href="https://github.com/redkubes/otomi-core" rel="noopener ugc nofollow" target="_blank"> otomi </a>中遇到了Loki多租户功能的问题。虽然otomi-core代码的结构非常好，但是还需要一些研究。在我的研究中，我注意到缺少描述如何设置Loki多租户的好文章。在本文中，我将解释如何使用otomi-core作为参考架构来实现Loki、Promtail和Grfana的多租户。</p><p id="0a41" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">但是回答你的第一个问题:“你解决问题了吗？”。是的，我做到了。在调试了几天之后，我首先认为我们必须从头开始，但是最终(当多个解决方案粘在一起工作时，通常会出现这种情况)这个问题是由Grafana图表中关于如何在<code class="fe kx ky kz la b">additionalDataSources</code>中配置密码的变化引起的。稍后将详细介绍。</p><p id="5377" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">让我从描述设置的高级架构开始。</p><h1 id="1c41" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">体系结构</h1><p id="90c1" class="pw-post-body-paragraph jy jz iq ka b kb lz kd ke kf ma kh ki kj mb kl km kn mc kp kq kr md kt ku kv ij bi translated">下图显示了设置的架构。</p><figure class="mf mg mh mi gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi me"><img src="../Images/aa5f8ee17d41ce5a92aa85ebfc5c6977.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*VoI5kN_4QdVFo2Sx26AInw.png"/></div></div><figcaption class="mj mk gj gh gi ml mm bd b be z dk translated">洛基多租户架构</figcaption></figure><p id="56f2" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">工作原理:</p><ol class=""><li id="2fe3" class="mn mo iq ka b kb kc kf kg kj mp kn mq kr mr kv ms mt mu mv bi translated">用户使用Oauth2登录(使用身份代理或提供商)。只有属于某个租户组的用户才可以访问该租户的Grafana实例。规范化的JWT令牌被传递给Grafana。</li><li id="0c11" class="mn mo iq ka b kb mw kf mx kj my kn mz kr na kv ms mt mu mv bi translated">每个租户名称空间运行自己的Grafana，但是用户不能自己在Grafana中创建/更新数据源。数据源由平台管理员定义，不能更改。Loki的数据源指向一个反向代理，在同一个Pod中作为Loki旁边的边车运行。</li><li id="7078" class="mn mo iq ka b kb mw kf mx kj my kn mz kr na kv ms mt mu mv bi translated">反向代理使用包含租户的用户/密码组合和租户名称的密码。当认证成功时，租户名称将被用在<em class="nb"> X-Scope-OrgID </em>头中，并被传递给Loki。</li><li id="f12b" class="mn mo iq ka b kb mw kf mx kj my kn mz kr na kv ms mt mu mv bi translated">Loki配置有<code class="fe kx ky kz la b">auth_enabled=true</code></li><li id="df23" class="mn mo iq ka b kb mw kf mx kj my kn mz kr na kv ms mt mu mv bi translated">Promtail配置了一个默认的<code class="fe kx ky kz la b">tenant_id=admins</code>,一个代码片段用于配置管道阶段，用租户的名字“标记”属于特定租户的所有日志。</li></ol><p id="6a73" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">看起来很简单，对吗？让我们再深入一点。使用oauth2/Istio/nginx/Keycloak的入口设置超出了这里的范围。</p><h1 id="220e" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">Promtail</h1><p id="7b9b" class="pw-post-body-paragraph jy jz iq ka b kb lz kd ke kf ma kh ki kj mb kl km kn mc kp kq kr md kt ku kv ij bi translated">我不打算讨论所有可能的Promtail配置选项，而只关注多租户设置的相关配置。</p><ol class=""><li id="13f9" class="mn mo iq ka b kb kc kf kg kj mp kn mq kr mr kv ms mt mu mv bi translated">在Promtail图表值中配置<code class="fe kx ky kz la b">clients</code>部分。yaml:</li></ol><pre class="mf mg mh mi gt nc la nd ne aw nf bi"><span id="be57" class="ng lc iq la b gy nh ni l nj nk">config:<br/>  clients:<br/>    - url: <a class="ae kw" href="http://loki.monitoring:3100/loki/api/v1/push" rel="noopener ugc nofollow" target="_blank">http://loki.monitoring:3100/loki/api/v1/push</a><br/>      tenant_id: admins</span></pre><p id="16f5" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">请注意，我们没有提供用户名和密码。Promtail连接到Loki服务时没有经过身份验证。Promtail和Loki运行在一个只有管理员才能访问的隔离(监控)命名空间中。</p><p id="6e6d" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">2.添加一个代码片段来配置<code class="fe kx ky kz la b">pipelineStages</code>:</p><pre class="mf mg mh mi gt nc la nd ne aw nf bi"><span id="819a" class="ng lc iq la b gy nh ni l nj nk">snippets:<br/>  pipelineStages:<br/>    - cri: {}<br/>    - json:<br/>      expressions:<br/>      namespace:<br/>    - labels:<br/>      namespace:<br/>    - match:<br/>      selector: '{namespace="tenant-1"}'<br/>      stages:<br/>        - tenant:<br/>          value: tenant-1<br/>    - match:<br/>      selector: '{namespace="tenant-2"}'<br/>      stages:<br/>        - tenant:<br/>          value: tenant-2<br/>    - output:<br/>      source: message</span></pre><p id="6457" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">管道(来源可以在这里找到<a class="ae kw" href="https://grafana.com/docs/loki/latest/clients/promtail/pipelines/" rel="noopener ugc nofollow" target="_blank"/>)被用来转换一个日志行、它的标签和它的时间戳。管道由一组阶段组成。有4种类型的阶段:</p><ol class=""><li id="85e0" class="mn mo iq ka b kb kc kf kg kj mp kn mq kr mr kv ms mt mu mv bi translated">解析阶段解析当前日志行并从中提取数据。然后，提取的数据可供其他阶段使用。</li><li id="a09f" class="mn mo iq ka b kb mw kf mx kj my kn mz kr na kv ms mt mu mv bi translated">转换阶段转换从先前阶段提取的数据。</li><li id="16a7" class="mn mo iq ka b kb mw kf mx kj my kn mz kr na kv ms mt mu mv bi translated">行动阶段从前面的阶段中提取数据，并对其进行处理。</li><li id="436c" class="mn mo iq ka b kb mw kf mx kj my kn mz kr na kv ms mt mu mv bi translated">过滤阶段根据某些条件选择性地应用阶段的子集或删除条目。</li></ol><p id="2438" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">简而言之:所有与租户的名称空间名称匹配的日志都被标记为由租户“拥有”。如果租户名称与发送给Loki的HTTP头中的<em class="nb"> X-Scope-OrgID </em>匹配，Loki将只返回该租户的日志。</p><h1 id="290c" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">洛基</h1><p id="dca8" class="pw-post-body-paragraph jy jz iq ka b kb lz kd ke kf ma kh ki kj mb kl km kn mc kp kq kr md kt ku kv ij bi translated">要在多租户模式下使用Loki，您需要做两件事:</p><ol class=""><li id="50a2" class="mn mo iq ka b kb kc kf kg kj mp kn mq kr mr kv ms mt mu mv bi translated">使用auth_enabled配置Loki:</li></ol><pre class="mf mg mh mi gt nc la nd ne aw nf bi"><span id="123d" class="ng lc iq la b gy nh ni l nj nk">config:<br/>  auth_enabled: true</span></pre><p id="89ce" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">2.添加一个反向代理来处理认证，并为Loki添加<code class="fe kx ky kz la b">X-Scope-OrgID</code> HTTP头。我偶然发现了一个简便的解决方案，并把它分了出来:<a class="ae kw" href="https://github.com/redkubes/loki-multi-tenant-proxy" rel="noopener ugc nofollow" target="_blank">https://github.com/redkubes/loki-multi-tenant-proxy</a>但是你也可以自己创建一个。反向代理作为侧车容器添加到Loki Pod中。</p><pre class="mf mg mh mi gt nc la nd ne aw nf bi"><span id="1b03" class="ng lc iq la b gy nh ni l nj nk">extraContainers:<br/>  - name: reverse-proxy<br/>    image: k8spin/loki-multi-tenant-proxy:v1.0.0<br/>    args:<br/>      - "run"<br/>      - "--port=3101"<br/>      - "--loki-server=http://localhost:3100"<br/>      - "--auth-config=/etc/reverse-proxy-conf/authn.yaml"<br/>    ports:<br/>      - name: http<br/>        containerPort: 3101<br/>        protocol: TCP<br/>    resources:<br/>      limits:<br/>        cpu: 250m<br/>        memory: 200Mi<br/>      requests:<br/>        cpu: 50m<br/>        memory: 40Mi<br/>    volumeMounts:<br/>      - name: reverse-proxy-auth-config<br/>        mountPath: /etc/reverse-proxy-conf</span><span id="1ecf" class="ng lc iq la b gy nl ni l nj nk">extraVolumes:<br/>  - name: reverse-proxy-auth-config<br/>    secret:<br/>      secretName: reverse-proxy-auth-config</span><span id="30e2" class="ng lc iq la b gy nl ni l nj nk">extraPorts:<br/>  - port: 3101<br/>    protocol: TCP<br/>    name: http<br/>    targetPort: http</span></pre><p id="4c02" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">3.创建一个包含authn.yaml文件的密码，该文件包含所有租户的用户名、密码和租户名称。这个秘密将被安装到反向代理上。</p><pre class="mf mg mh mi gt nc la nd ne aw nf bi"><span id="5b0e" class="ng lc iq la b gy nh ni l nj nk">apiVersion: v1<br/>kind: Secret<br/>metadata:<br/>  name: mysecret<br/>type: Opaque<br/>stringData:<br/>  authn.yaml: |<br/>    - username: admin<br/>      password: password<br/>      orgid: admins<br/>    - username: tentant-1<br/>      password: password<br/>      orgid: tenant-1<br/>    - username: tenant-2<br/>      password: password<br/>      orgid: tenant-2</span></pre><h1 id="68d7" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">格拉夫纳</h1><p id="db15" class="pw-post-body-paragraph jy jz iq ka b kb lz kd ke kf ma kh ki kj mb kl km kn mc kp kq kr md kt ku kv ij bi translated">要使租户能够查询其日志，请向租户的Grafana实例添加额外的数据源:</p><pre class="mf mg mh mi gt nc la nd ne aw nf bi"><span id="b73f" class="ng lc iq la b gy nh ni l nj nk">additionalDataSources:<br/>  - name: Loki<br/>    editable: false<br/>    type: loki<br/>    access: proxy<br/>    url: <a class="ae kw" href="http://loki.monitoring:3101" rel="noopener ugc nofollow" target="_blank">http://loki.monitoring:3101</a><br/>    basicAuth: true<br/>    basicAuthUser: tenant-1<br/>    secureJsonData:<br/>      basicAuthPassword: password</span></pre><p id="59c8" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">请注意，需要为每个租户的Grafana实例完成这项工作！点击阅读更多关于配置数据源<a class="ae kw" href="https://grafana.com/docs/grafana/latest/administration/provisioning/#datasources" rel="noopener ugc nofollow" target="_blank">的信息。</a></p><p id="e76b" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">现在，这就是导致我的问题的原因:<code class="fe kx ky kz la b">basicAuthPassword</code>的用法在一个最新的Grafana版本中已经改变，并且只作为<code class="fe kx ky kz la b">secureJsonData</code>属性被支持。一个在升级过程中自动检查值变化的工具会很好；-)</p><p id="498d" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在loki中，用户将看到他们可以使用(但不能编辑)的预配数据源:</p><figure class="mf mg mh mi gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nm"><img src="../Images/a836bd707b05f6bb34a9c947b9e049fb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*81_x9uSdPdLjH6d1JdQ0bw.png"/></div></div></figure><h1 id="2841" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">包扎</h1><p id="c7a2" class="pw-post-body-paragraph jy jz iq ka b kb lz kd ke kf ma kh ki kj mb kl km kn mc kp kq kr md kt ku kv ij bi translated">请注意，我在这里描述的设置仍然依赖于良好的身份验证和授权机制，以确保只有租户用户能够访问租户自己的Grafana。完成后，用户只能访问他们所属租户的日志。如果你想了解如何使用oauth2、Istio、Nginx入口控制器和Keycloak建立一个高级的多租户入口架构，请查看otomi-core repo</p><p id="37c4" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在弄清楚如何做之后，为Loki创建多租户设置似乎并不复杂。但是要记住，这里的精髓不在于如何设置，而在于如何操作。如果您每天都有多个租户需要加入，那么您可能会在这上面花费大量时间。</p><p id="bd0f" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在Otomi中，你只需点击两下就可以创建一个新的租户:点击创建团队，提供一个名字，然后点击提交。然后，Otomi将为租户创建一个名称空间，在其中安装Grafana，创建租户密码(使用sop加密)，将租户添加到身份验证代理，将带有租户信息的Loki数据源添加到Grafana，并将租户添加到Promtail管道阶段。一切都是完全自动化的，所有租户的配置都存储在Git中。</p><p id="961c" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">希望你喜欢我们在<a class="ae kw" href="https://github.com/redkubes/otomi-core" rel="noopener ugc nofollow" target="_blank">大友</a>项目上的努力，并通过主演来支持我们。谢谢！</p><p id="4592" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">如果有任何问题，可以在L<a class="ae kw" href="https://www.linkedin.com/in/srodenhuis/" rel="noopener ugc nofollow" target="_blank">ink din</a>或<a class="ae kw" href="https://twitter.com/SanderRodenhuis" rel="noopener ugc nofollow" target="_blank"> Twitter </a>上联系我。</p></div></div>    
</body>
</html>