<html>
<head>
<title>Hitting the Apex: Onboard a root or apex domain and add a self-managed SSL certificate</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">访问apex:在根域或Apex域中添加自我管理的SSL证书</h1>
<blockquote>原文：<a href="https://itnext.io/hitting-the-apex-onboard-a-root-or-apex-domain-and-a-self-managed-ssl-certificate-e1a6cf5d90f9?source=collection_archive---------1-----------------------#2022-07-15">https://itnext.io/hitting-the-apex-onboard-a-root-or-apex-domain-and-a-self-managed-ssl-certificate-e1a6cf5d90f9?source=collection_archive---------1-----------------------#2022-07-15</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/80ae0de115713a9edffe1b71acef6a97.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*I6ewoXEXy6rMRdNHKKzqmQ.jpeg"/></div></div></figure><p id="3194" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在本文中，我们将介绍如何将根域或apex域添加到CDN端点，并添加自我管理的SSL证书。我们还将介绍如何在您的CDN端点上实施HTTPS流量。</p><p id="781c" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">如果你正在阅读这篇文章，很可能你想创建自己的静态网站，想了解更多关于静态站点生成器的信息，想知道如何使用Azure服务托管你的静态网站，或者想知道如何自动化你的web代码的完全集成和你的站点构建的部署。不管怎样，下面的一系列博客文章可能对你有帮助！</p><p id="d803" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">本文是一个系列的后续文章，该系列包括:</p><ul class=""><li id="ce16" class="kw kx iq ka b kb kc kf kg kj ky kn kz kr la kv lb lc ld le bi translated">对于Azure中的静态网站，你需要的唯一指南是:第1部分:创建一个静态网站。在这篇文章中，我介绍了什么是静态网站，有什么可供选择，以及如何创建一个(本地)静态网站。</li><li id="aa77" class="kw kx iq ka b kb lg kf lh kj li kn lj kr lk kv lb lc ld le bi translated"><a class="ae lf" rel="noopener ugc nofollow" target="_blank" href="/the-only-guide-you-need-for-a-static-website-in-azure-part-2-host-your-static-site-in-azure-9114b7069db2">Azure静态网站的唯一指南——第2部分:使用Azure Blob存储托管你的站点</a>。在这篇文章中，我介绍了如何在Azure Blob存储中托管静态网站，有什么可供选择，以及一些关于内容交付网络(CDN)的基础知识。</li><li id="37cf" class="kw kx iq ka b kb lg kf lh kj li kn lj kr lk kv lb lc ld le bi translated"><a class="ae lf" rel="noopener ugc nofollow" target="_blank" href="/the-only-guide-you-need-for-a-static-website-in-azure-part-3-automate-using-azure-devops-e53aa65c1fba">Azure静态网站的唯一指南——第3部分:使用Azure DevOps管道实现自动化</a>。在本文中，我将介绍什么是Azure DevOps服务，以及如何将静态网站的构建和部署自动化到Azure storage。</li></ul><p id="910c" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">让我们开始吧。</p></div><div class="ab cl ll lm hu ln" role="separator"><span class="lo bw bk lp lq lr"/><span class="lo bw bk lp lq lr"/><span class="lo bw bk lp lq"/></div><div class="ij ik il im in"><h1 id="a34c" class="ls lt iq bd lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp bi translated">什么是Azure DNS？</h1><p id="b386" class="pw-post-body-paragraph jy jz iq ka b kb mq kd ke kf mr kh ki kj ms kl km kn mt kp kq kr mu kt ku kv ij bi translated">Azure DNS是DNS域的托管服务，通过使用Microsoft Azure基础架构提供名称解析。通过在Azure中托管您的域，您可以使用与其他Azure服务相同的凭据、API、工具和计费来管理您的DNS记录。不能用Azure DNS买域名。</p><p id="d4ad" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">如果你想了解更多关于Azure DNS的知识，请查看微软的官方文档。</p></div><div class="ab cl ll lm hu ln" role="separator"><span class="lo bw bk lp lq lr"/><span class="lo bw bk lp lq lr"/><span class="lo bw bk lp lq"/></div><div class="ij ik il im in"><h1 id="214d" class="ls lt iq bd lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp bi translated">什么是Azure Key Vault？</h1><p id="c145" class="pw-post-body-paragraph jy jz iq ka b kb mq kd ke kf mr kh ki kj ms kl km kn mt kp kq kr mu kt ku kv ij bi translated">Azure Key Vault是一个云服务，用于安全地存储和访问机密、API密钥、密码、证书和加密密钥，因此您可以保持它们的私密性。</p><p id="2f1d" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">如果你想了解更多关于Azure Key Vault的信息，请查看微软的官方文档。</p></div><div class="ab cl ll lm hu ln" role="separator"><span class="lo bw bk lp lq lr"/><span class="lo bw bk lp lq lr"/><span class="lo bw bk lp lq"/></div><div class="ij ik il im in"><h1 id="24fc" class="ls lt iq bd lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp bi translated">先决条件</h1><p id="1e5f" class="pw-post-body-paragraph jy jz iq ka b kb mq kd ke kf mr kh ki kj ms kl km kn mt kp kq kr mu kt ku kv ij bi translated">要开始将apex或根域加入CDN端点并添加自我管理的SSL证书，请确保您满足以下先决条件。</p><h2 id="6c63" class="mv lt iq bd lu mw mx dn ly my mz dp mc kj na nb mg kn nc nd mk kr ne nf mo ng bi translated">Azure订阅</h2><p id="c527" class="pw-post-body-paragraph jy jz iq ka b kb mq kd ke kf mr kh ki kj ms kl km kn mt kp kq kr mu kt ku kv ij bi translated">对于本指南，您需要一个Azure订阅，<a class="ae lf" href="https://docs.microsoft.com/en-us/azure/role-based-access-control/built-in-roles" rel="noopener ugc nofollow" target="_blank">一个本地用户帐户，有权</a>创建和编辑Azure存储帐户，并将静态网站版本上传到此帐户。</p><h2 id="f623" class="mv lt iq bd lu mw mx dn ly my mz dp mc kj na nb mg kn nc nd mk kr ne nf mo ng bi translated">Azure托管的网站</h2><p id="3ab9" class="pw-post-body-paragraph jy jz iq ka b kb mq kd ke kf mr kh ki kj ms kl km kn mt kp kq kr mu kt ku kv ij bi translated">对于这个指南，你需要一个Azure托管的网站。本指南以Azure Blob存储中的一个静态网站为起点。您还需要一个带有静态网站端点的CDN配置文件。如果你还没有准备好这些东西，按照我的<em class="nh">“Azure静态网站的唯一指南”</em>博客系列的<a class="ae lf" rel="noopener ugc nofollow" target="_blank" href="/the-only-guide-you-need-for-a-static-website-in-azure-part-1-create-a-static-website-da00ddc85f2d">第一篇</a>和<a class="ae lf" rel="noopener ugc nofollow" target="_blank" href="/the-only-guide-you-need-for-a-static-website-in-azure-part-2-host-your-static-site-in-azure-9114b7069db2">第二篇</a>创建你的静态网站。</p><h2 id="4d69" class="mv lt iq bd lu mw mx dn ly my mz dp mc kj na nb mg kn nc nd mk kr ne nf mo ng bi translated">自我管理的SSL证书</h2><p id="3f44" class="pw-post-body-paragraph jy jz iq ka b kb mq kd ke kf mr kh ki kj ms kl km kn mt kp kq kr mu kt ku kv ij bi translated">如果您打算按照完整的指南学习，并带上您自己的SSL证书，那么您将需要一个SSL证书来学习本指南。不可能为apex或根域选择Azure管理的证书。您可以从最常见的域提供商那里购买SSL证书，例如<a class="ae lf" href="https://www.cloudflare.com/ssl/dedicated-certificates/" rel="noopener ugc nofollow" target="_blank"> Cloudflare </a>、<a class="ae lf" href="https://www.namecheap.com/security/ssl-certificates/" rel="noopener ugc nofollow" target="_blank"> Namecheap </a>，或者像荷兰的<a class="ae lf" href="https://www.transip.nl/ssl-certificaten/" rel="noopener ugc nofollow" target="_blank"> TransIP </a>这样的本地提供商。</p><h2 id="4538" class="mv lt iq bd lu mw mx dn ly my mz dp mc kj na nb mg kn nc nd mk kr ne nf mo ng bi translated">Azure CLI</h2><p id="1fe0" class="pw-post-body-paragraph jy jz iq ka b kb mq kd ke kf mr kh ki kj ms kl km kn mt kp kq kr mu kt ku kv ij bi translated">在本指南中，您将为Azure CLI使用Azure云外壳。然而，如果你喜欢在本地工作站工作，你可以<a class="ae lf" href="https://docs.microsoft.com/en-us/cli/azure/install-azure-cli" rel="noopener ugc nofollow" target="_blank">在本地安装Azure CLI</a>。</p></div><div class="ab cl ll lm hu ln" role="separator"><span class="lo bw bk lp lq lr"/><span class="lo bw bk lp lq lr"/><span class="lo bw bk lp lq"/></div><div class="ij ik il im in"><h1 id="04a0" class="ls lt iq bd lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp bi translated">加入您的根或apex域</h1><p id="0f29" class="pw-post-body-paragraph jy jz iq ka b kb mq kd ke kf mr kh ki kj ms kl km kn mt kp kq kr mu kt ku kv ij bi translated">apex是您的域的“根”级别，例如<em class="nh"> schutten.cloud </em>。域顶点是域名层次结构的“根”。这个(例如<em class="nh"> www.schutten.cloud </em>的每个子域都不是域顶点，而是<em class="nh"> schutten.cloud </em>的一个子域。<br/>让我们将apex域装载到Azure CDN端点。</p><h2 id="5d56" class="mv lt iq bd lu mw mx dn ly my mz dp mc kj na nb mg kn nc nd mk kr ne nf mo ng bi translated">创建DNS区域</h2><p id="4bb3" class="pw-post-body-paragraph jy jz iq ka b kb mq kd ke kf mr kh ki kj ms kl km kn mt kp kq kr mu kt ku kv ij bi translated">登录<a class="ae lf" href="https://portal.azure.com/" rel="noopener ugc nofollow" target="_blank"> Azure门户</a>后，使用链接或点击图标打开<a class="ae lf" href="https://shell.azure.com/" rel="noopener ugc nofollow" target="_blank"> Azure云外壳</a>。</p><figure class="nj nk nl nm gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi ni"><img src="../Images/b54cb29edf24d3d4325b3e1fb84a015b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*pL1fDz51_WwrhM2R.png"/></div></div><figcaption class="nn no gj gh gi np nq bd b be z dk translated"><em class="nr">图片由Rolf Schutten于</em><a class="ae lf" href="https://www.schutten.cloud/" rel="noopener ugc nofollow" target="_blank"><em class="nr">Schutten . cloud</em></a></figcaption></figure><p id="580f" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">如果你在本地使用Azure CLI，你首先需要使用<code class="fe ns nt nu nv b">az login</code>命令登录以使用任何CLI命令。</p><p id="2f45" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">现在创建一个包含DNS区域的资源组。在下面的例子中，我在西欧地区创建了一个名为rg-p-weu-schuttencloud的资源组。使用示例，通过用您自己的值替换值来创建您自己的资源组:</p><pre class="nj nk nl nm gt nw nv nx ny aw nz bi"><span id="f952" class="mv lt iq nv b gy oa ob l oc od">az group create \<br/>    --name <!-- -->rg-p-weu-schuttencloud <!-- -->\<br/>    --location westeurope</span></pre><p id="d8aa" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">现在创建一个DNS区域。在下面的例子中，我在资源组<em class="nh"> rg-p-weu-schuttencloud </em>中创建了一个名为<em class="nh"> schutten.cloud </em>的DNS区域。使用示例，通过用您自己的值替换这些值来创建您自己的DNS区域:</p><pre class="nj nk nl nm gt nw nv nx ny aw nz bi"><span id="00fd" class="mv lt iq nv b gy oa ob l oc od">az network dns zone create \<br/>    --name schutten.cloud \ <br/>    --resource-group rg-p-weu-schuttencloud</span></pre><h2 id="639a" class="mv lt iq bd lu mw mx dn ly my mz dp mc kj na nb mg kn nc nd mk kr ne nf mo ng bi translated">为区域apex创建别名记录</h2><p id="94ab" class="pw-post-body-paragraph jy jz iq ka b kb mq kd ke kf mr kh ki kj ms kl km kn mt kp kq kr mu kt ku kv ij bi translated">现在在区域的顶点创建一个记录集。在下面的例子中，我在<em class="nh"> schutten.cloud </em>区域的顶点创建了一个记录集，TTL(生存时间)为60秒，我的CDN端点作为目标资源。使用示例，通过用您自己的值替换这些值来创建您自己的DNS区域:</p><pre class="nj nk nl nm gt nw nv nx ny aw nz bi"><span id="0490" class="mv lt iq nv b gy oa ob l oc od">az network dns record-set a create \<br/>    --name "@" \<br/>    --resource-group rg-p-weu-schuttencloud \<br/>    --zone-name schutten.cloud \<br/>    --target-resource YourCDNEndpoint \<br/>    --ttl 60</span></pre><p id="9e0e" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">这将创建一个指向您的CDN资源的zone apex记录，该记录使用CNAME记录映射<em class="nh"> cdnverify </em>在您的CDN配置文件中加入域。在我的情况下，cdnverify.schuttencloud.com。</p><h2 id="0bad" class="mv lt iq bd lu mw mx dn ly my mz dp mc kj na nb mg kn nc nd mk kr ne nf mo ng bi translated">委派域</h2><p id="c37a" class="pw-post-body-paragraph jy jz iq ka b kb mq kd ke kf mr kh ki kj ms kl km kn mt kp kq kr mu kt ku kv ij bi translated">下一步要做的是向域名注册商更新域名的NS(域名服务器)记录。</p><p id="f5c2" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在将您的DNS区域委派给Azure DNS之前，您需要知道您的区域的名称服务器。在下面的示例中，我检索了早期DNS区域<em class="nh"> schutten.cloud </em>所需的信息。使用示例检索您自己的DNS区域信息，方法是将这些值替换为您自己的值:</p><pre class="nj nk nl nm gt nw nv nx ny aw nz bi"><span id="0f61" class="mv lt iq nv b gy oa ob l oc od">az network dns zone show \<br/>    --resource-group rg-p-weu-schuttencloud \<br/>    --name schutten.cloud</span></pre><p id="a597" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">返回的答案应该如下图所示，其中<em class="nh">“名称服务器”</em>后面的四行是我们下一步需要的。把这些写下来。</p><figure class="nj nk nl nm gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi oe"><img src="../Images/b5c4483ccf8f838ee883cd49b21f421e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*4hmYvLXymAfQo5jXT9wnuA.png"/></div></div><figcaption class="nn no gj gh gi np nq bd b be z dk translated"><em class="nr">图片由Rolf Schutten上传于</em><a class="ae lf" href="https://www.schutten.cloud/" rel="noopener ugc nofollow" target="_blank"><em class="nr">Schutten . cloud</em></a></figcaption></figure><p id="7543" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">由于每个注册服务商都有自己的DNS管理工具来更改域名的域名服务器记录，因此不可能在本手册中包含这些内容。您的域注册商可能有更新NS记录的文档。如果没有，请联系您的域名注册商。</p><p id="b827" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">要验证NS记录是否正确更新，您可以使用<code class="fe ns nt nu nv b">nslookup</code>命令。使用下面的示例，并用您自己的值替换这些值:</p><p id="e8ef" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><code class="fe ns nt nu nv b">nslookup -type=SOA schutten.cloud</code></p><p id="83e3" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">您的响应应该类似于下面的<code class="fe ns nt nu nv b">nslookup</code>输出:</p><figure class="nj nk nl nm gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi of"><img src="../Images/83eabe0679216ba73456d6ee71d1b741.png" data-original-src="https://miro.medium.com/v2/resize:fit:1362/format:webp/1*PNJCJY4uJPksVWzkKijNtw.png"/></div></div><figcaption class="nn no gj gh gi np nq bd b be z dk translated"><em class="nr">图片由Rolf Schutten上传</em><a class="ae lf" href="https://www.schutten.cloud/" rel="noopener ugc nofollow" target="_blank"><em class="nr">Schutten . cloud</em></a></figcaption></figure><h2 id="251a" class="mv lt iq bd lu mw mx dn ly my mz dp mc kj na nb mg kn nc nd mk kr ne nf mo ng bi translated">在您的CDN上装载自定义域</h2><p id="272b" class="pw-post-body-paragraph jy jz iq ka b kb mq kd ke kf mr kh ki kj ms kl km kn mt kp kq kr mu kt ku kv ij bi translated">既然我们已经注册了apex域，我们可以将其添加到CDN端点。在下面的例子中，我将域<em class="nh"> schutten.cloud </em>添加到我的cdn端点<em class="nh"> ep-cdn-schuttencloud </em>中，这是CDN配置文件<em class="nh"> cdn-schuttencloud </em>的一部分。使用示例将您自己的自定义域添加到CDN端点，方法是用您自己的值替换这些值:</p><pre class="nj nk nl nm gt nw nv nx ny aw nz bi"><span id="96bd" class="mv lt iq nv b gy oa ob l oc od">az cdn custom-domain create \<br/>    --name schuttenclouddomain \<br/>    --resource-group rg-p-weu-schuttencloud \<br/>    --hostname schutten.cloud \<br/>    --endpoint-name ep-cdn-schuttencloud \<br/>    --profile-name cdn-schuttencloud</span></pre><p id="efc4" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">Azure会验证您输入的自定义域名的CNAME记录是否存在。如果CNAME是正确的，您的自定义域将被验证。</p><p id="567a" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">您现在已经将apex/根域添加到CDN端点，并且应该能够在web浏览器中访问您的Azure (Blob)存储帐户中托管的静态网站。</p></div><div class="ab cl ll lm hu ln" role="separator"><span class="lo bw bk lp lq lr"/><span class="lo bw bk lp lq lr"/><span class="lo bw bk lp lq"/></div><div class="ij ik il im in"><h1 id="4934" class="ls lt iq bd lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp bi translated">使用自我管理的SSL证书</h1><p id="9c2f" class="pw-post-body-paragraph jy jz iq ka b kb mq kd ke kf mr kh ki kj ms kl km kn mt kp kq kr mu kt ku kv ij bi translated">在<a class="ae lf" rel="noopener ugc nofollow" target="_blank" href="/the-only-guide-you-need-for-a-static-website-in-azure-part-2-host-your-static-site-in-azure-9114b7069db2">这篇博客</a>中，我们为<a class="ae lf" href="https://schutten.cloud/" rel="noopener ugc nofollow" target="_blank"><em class="nh">www . schutten . cloud</em></a>子域创建了一个带有CDN托管证书的CDN端点。遗憾的是，无法将CDN管理的证书用于apex/根域。因此，你有义务提交你自己的证明。Azure Key Vault是存储证书的明显选择。让我们开始吧。</p><h2 id="860f" class="mv lt iq bd lu mw mx dn ly my mz dp mc kj na nb mg kn nc nd mk kr ne nf mo ng bi translated">创建Azure密钥库</h2><p id="775e" class="pw-post-body-paragraph jy jz iq ka b kb mq kd ke kf mr kh ki kj ms kl km kn mt kp kq kr mu kt ku kv ij bi translated">现在创建一个Azure Key Vault来存储您的证书。在下面的例子中，我在与Azure DNS区域相同的资源组内创建了一个Azure Key Vault，该资源组是<em class="nh"> rg-p-weu-schuttencloud </em>，同样位于w <em class="nh"> est-europe </em>区域。使用下面的示例，通过用您自己的值替换这些值来创建您的密钥库。</p><pre class="nj nk nl nm gt nw nv nx ny aw nz bi"><span id="4765" class="mv lt iq nv b gy oa ob l oc od">az keyvault create \<br/>    --name "kv-p-weu-schuttencloud" \<br/>    --resource-group "rg-p-weu-schuttencloud" \<br/>    --location westeurope</span></pre><h2 id="7a6f" class="mv lt iq bd lu mw mx dn ly my mz dp mc kj na nb mg kn nc nd mk kr ne nf mo ng bi translated">注册CDN/前门的服务主体</h2><p id="948c" class="pw-post-body-paragraph jy jz iq ka b kb mq kd ke kf mr kh ki kj ms kl km kn mt kp kq kr mu kt ku kv ij bi translated">为了使CDN端点能够访问密钥库中的证书，我们注册了一个服务主体。在下面的例子中，我在Azure Active Directory中注册了一个服务主体作为app。执行以下命令:</p><pre class="nj nk nl nm gt nw nv nx ny aw nz bi"><span id="e71c" class="mv lt iq nv b gy oa ob l oc od">az ad sp create --id 205478c0-bd83-4e1b-a9d6-db63a3e1e1c8</span></pre><p id="1da4" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在这之后，我们必须给予服务主体访问权，以便能够请求证书。在下面的例子中，我将密钥库中的秘密和证书的权限授予服务主体。使用下面的示例，并用您自己的值替换这些值:</p><pre class="nj nk nl nm gt nw nv nx ny aw nz bi"><span id="936a" class="mv lt iq nv b gy oa ob l oc od">az keyvault set-policy \<br/>    --name "kv-p-weu-schuttencloud" \<br/>    --certificate-permissions get \<br/>    --secret-permissions get \<br/>    --application-id 205478c0-bd83-4e1b-a9d6-db63a3e1e1c8</span></pre><p id="684e" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">服务主体现在可以访问这个密钥库及其包含的证书。</p><h2 id="fd2b" class="mv lt iq bd lu mw mx dn ly my mz dp mc kj na nb mg kn nc nd mk kr ne nf mo ng bi translated">准备您的证书(可选)</h2><p id="80ce" class="pw-post-body-paragraph jy jz iq ka b kb mq kd ke kf mr kh ki kj ms kl km kn mt kp kq kr mu kt ku kv ij bi translated">Azure Key Vault只接受<a class="ae lf" href="https://en.wikipedia.org/wiki/PKCS_12" rel="noopener ugc nofollow" target="_blank"> PKCS12 </a>和<a class="ae lf" href="https://en.wikipedia.org/wiki/Privacy-Enhanced_Mail" rel="noopener ugc nofollow" target="_blank"> PEM </a>证书，但有时SSL证书供应商会以不同的格式提供证书。在我的案例中，我的供应商以<a class="ae lf" href="https://en.wikipedia.org/wiki/X.509#Certificate_filename_extensions" rel="noopener ugc nofollow" target="_blank"> CRT格式</a>提供证书。使用<code class="fe ns nt nu nv b">openssl</code>我们可以解决这个问题，并从。CRT证书。你可以从他们的网站下载<a class="ae lf" href="https://www.openssl.org/" rel="noopener ugc nofollow" target="_blank"> OpenSSL，或者执行<code class="fe ns nt nu nv b">choco install openssl</code>命令，如果你像我一样使用Chocolatey的话。</a></p><p id="544d" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在您下载的证书的文件夹中运行以下命令，其中密钥文件应该只是一个包含您的私有文件的文本文件，该文件是从您的SSL证书提供商处获得的:</p><pre class="nj nk nl nm gt nw nv nx ny aw nz bi"><span id="ef42" class="mv lt iq nv b gy oa ob l oc od">openssl pkcs12 -export -out schutten.cloud.pfx -inkey certificate.key -in certificate.crt -in rootca.crt</span></pre><p id="d2e1" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">您现在有一个证书，可以导入到Azure Key Vault中。</p><h2 id="0077" class="mv lt iq bd lu mw mx dn ly my mz dp mc kj na nb mg kn nc nd mk kr ne nf mo ng bi translated">将证书导入Azure密钥库</h2><p id="64fa" class="pw-post-body-paragraph jy jz iq ka b kb mq kd ke kf mr kh ki kj ms kl km kn mt kp kq kr mu kt ku kv ij bi translated">现在将您的证书导入到Azure Key Vault。在下面的例子中，我将证书命名为<em class="nh"> SchuttenCloud </em>，并将<em class="nh">certificate . pfx</em>PKCS12-文件导入到之前创建的密钥库。使用下面的示例，通过用您自己的值替换您自己的值，将您自己的证书导入到您的密钥库中。</p><pre class="nj nk nl nm gt nw nv nx ny aw nz bi"><span id="b2dc" class="mv lt iq nv b gy oa ob l oc od">az keyvault certificate import \<br/>    --name "SchuttenCloud" \<br/>    --file "certificate.pfx" \<br/>    --vault-name "kv-p-weu-schuttencloud"</span></pre><h2 id="6dc0" class="mv lt iq bd lu mw mx dn ly my mz dp mc kj na nb mg kn nc nd mk kr ne nf mo ng bi translated">在CDN端点上启用HTTPS</h2><p id="879d" class="pw-post-body-paragraph jy jz iq ka b kb mq kd ke kf mr kh ki kj ms kl km kn mt kp kq kr mu kt ku kv ij bi translated">现在，通过使用下面的示例并用您自己的值替换这些值，在自定义域上为Azure CDN启用HTTPS:</p><pre class="nj nk nl nm gt nw nv nx ny aw nz bi"><span id="365e" class="mv lt iq nv b gy oa ob l oc od">az cdn custom-domain enable-https \<br/>    --name schuttenclouddomain \<br/>    --resource-group rg-p-weu-schuttencloud \<br/>    --endpoint-name ep-cdn-schuttencloud \<br/>    --profile-name cdn-schuttencloud \<br/>    --min-tls-version 1.2 \<br/>    --user-cert-grou-name rg-p-weu-schuttencloud \<br/>    --user-cert-secret-name SchuttenCloud \<br/>    --user-cert-vault-name kv-p-weu-schuttencloud</span></pre><p id="d4b2" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">您现在已经在您的CDN端点上启用了HTTPS，应该能够通过HTTPS在您的web浏览器中访问您的Azure (Blob)存储帐户中托管的静态网站。</p></div><div class="ab cl ll lm hu ln" role="separator"><span class="lo bw bk lp lq lr"/><span class="lo bw bk lp lq lr"/><span class="lo bw bk lp lq"/></div><div class="ij ik il im in"><h1 id="02b7" class="ls lt iq bd lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp bi translated">将HTTP请求重定向到HTTPS</h1><p id="6a7e" class="pw-post-body-paragraph jy jz iq ka b kb mq kd ke kf mr kh ki kj ms kl km kn mt kp kq kr mu kt ku kv ij bi translated">显然，我们希望将所有HTTP请求重定向到HTTPS。如果你不知道这为什么重要，我建议你看一下<a class="ae lf" rel="noopener ugc nofollow" target="_blank" href="/monitor-ssl-tls-certificates-with-azure-application-insights-4f55c792786b">这篇博客文章</a>。</p><p id="7b0e" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在下面的示例中，添加了一个CDN引擎规则，将所有通过HTTP进入的流量转发到HTTPS协议。关于CDN引擎规则中的参数和字段的更多信息可以在微软的官方文档网站上找到。使用下面的示例，通过用您自己的值替换这些值来自己创建规则:</p><pre class="nj nk nl nm gt nw nv nx ny aw nz bi"><span id="8b33" class="mv lt iq nv b gy oa ob l oc od">az cdn endpoint rule add \<br/>    --name ep-cdn-schuttencloud \<br/>    --resource-group group rg-p-weu-schuttencloud \<br/>    --profile-name cdn-schuttencloud \ <br/>    --order 1 \<br/>    --rule-name "EnforceHTTPS" \<br/>    --match-variable RequestScheme \<br/>    --operator Equal \<br/>    --match-values HTTP \<br/>    --action-name "UrlRedirect" \<br/>    --redirect-protocol Https \<br/>    --redirect-type Moved</span></pre><p id="a4ea" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">所有通过HTTP请求进入的流量现在都被重定向到HTTPS。</p></div><div class="ab cl ll lm hu ln" role="separator"><span class="lo bw bk lp lq lr"/><span class="lo bw bk lp lq lr"/><span class="lo bw bk lp lq"/></div><div class="ij ik il im in"><h1 id="7fda" class="ls lt iq bd lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp bi translated">结论</h1><p id="fd35" class="pw-post-body-paragraph jy jz iq ka b kb mq kd ke kf mr kh ki kj ms kl km kn mt kp kq kr mu kt ku kv ij bi translated">在本文中，您已经了解了什么是Azure DNS，什么是Azure Key Vault，如何将apex或根域加载到CDN端点，如何使用存储在Azure Key Vault中的自我管理SSL证书，以及如何在CDN端点上实施HTTPS流量。不要忘记，监视您的SSL证书是非常重要的。当证书过期时，Azure不会通知您，也不会自动续订，因为它们会为您提供Azure管理的证书。在这篇博客文章中，我解释了如何使用Azure Application Insights来监控SSL证书。</p></div></div>    
</body>
</html>