<html>
<head>
<title>How to automate repetitive tasks in Kubernetes with runbooks?</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何用runbooks自动化Kubernetes中的重复性任务？</h1>
<blockquote>原文：<a href="https://itnext.io/how-to-automate-repetitive-tasks-in-kubetneres-with-runbooks-8b039976f546?source=collection_archive---------2-----------------------#2022-09-11">https://itnext.io/how-to-automate-repetitive-tasks-in-kubetneres-with-runbooks-8b039976f546?source=collection_archive---------2-----------------------#2022-09-11</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><figure class="ip iq gp gr ir is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi io"><img src="../Images/ea22e5e493a0e4a4674323bbc24d41c1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*0Rdx7UsnB2b0fgp3"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">马库斯·温克勒在<a class="ae jd" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</figcaption></figure><div class=""/><div class=""><h2 id="6a27" class="pw-subtitle-paragraph kd jf jg bd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku dk translated">介绍</h2></div><p id="884a" class="pw-post-body-paragraph kv kw jg kx b ky kz kh la lb lc kk ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">使用runbooks可以通过自动化可重复的任务来简化和改进Kubernetes的工作。额外的一点是，我们可以只用开源工具做到这一点。</p><p id="e1fc" class="pw-post-body-paragraph kv kw jg kx b ky kz kh la lb lc kk ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">如果您在运营部门工作，是platform或DevOps团队的一员，或者只是想了解更多关于使用自动化来简化Kubernetes体验的信息，那么您将从这个博客中受益匪浅。</p><blockquote class="lr ls lt"><p id="6464" class="kv kw lu kx b ky kz kh la lb lc kk ld lv lf lg lh lw lj lk ll lx ln lo lp lq ij bi translated">请继续关注关于这一主题的视频和互动场景。</p></blockquote><h2 id="3539" class="ly lz jg bd ma mb mc dn md me mf dp mg le mh mi mj li mk ml mm lm mn mo mp mq bi translated">库伯内特复杂性</h2><p id="354e" class="pw-post-body-paragraph kv kw jg kx b ky mr kh la lb ms kk ld le mt lg lh li mu lk ll lm mv lo lp lq ij bi translated">在了解了pod和部署、服务、配置图和秘密之后，Kubetneres看起来没那么可怕了。</p><p id="df28" class="pw-post-body-paragraph kv kw jg kx b ky kz kh la lb lc kk ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">正如一句著名的谚语所说。</p><blockquote class="mw"><p id="738c" class="mx my jg bd mz na nb nc nd ne nf lq dk translated">你不知道的不会伤害你。</p></blockquote><p id="2463" class="pw-post-body-paragraph kv kw jg kx b ky ng kh la lb nh kk ld le ni lg lh li nj lk ll lm nk lo lp lq ij bi translated">过了一段时间，你的需求超过了基本的Kubetneres资源所能给你的，你发现在表面之下有一个巨大的复杂“冰山”。</p><figure class="nm nn no np gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi nl"><img src="../Images/1e465de46856de027dae6e1dc9431807.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*2RlTlfkIcOxljwHWq6VClQ.png"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated"><a class="ae jd" href="https://www.reddit.com/r/kubernetes/comments/u9b95u/kubernetes_iceberg_the_bigger_picture_of_what_you/" rel="noopener ugc nofollow" target="_blank">https://www . Reddit . com/r/kubernetes/comments/u9b 95 u/kubernetes _ iceberg _ the _ bigger _ picture _ of _ what _ you/</a></figcaption></figure><h2 id="08f5" class="ly lz jg bd ma mb mc dn md me mf dp mg le mh mi mj li mk ml mm lm mn mo mp mq bi translated">运行手册</h2><p id="1d7e" class="pw-post-body-paragraph kv kw jg kx b ky mr kh la lb ms kk ld le mt lg lh li mu lk ll lm mv lo lp lq ij bi translated">page duty给出的一个简单定义告诉我们什么是runbook:</p><blockquote class="lr ls lt"><p id="2aba" class="kv kw lu kx b ky kz kh la lb lc kk ld lv lf lg lh lw lj lk ll lx ln lo lp lq ij bi translated">操作手册是一份详细的“如何”指南，用于完成公司IT运营流程中经常重复的任务或程序。Runbooks旨在为团队中的每个人(无论是新成员还是有经验的成员)提供快速、准确解决特定问题的知识和步骤。例如，操作手册可能会概述日常操作任务，如修补服务器或更新网站的SSL证书。</p></blockquote><h2 id="d236" class="ly lz jg bd ma mb mc dn md me mf dp mg le mh mi mj li mk ml mm lm mn mo mp mq bi translated">Runbooks是干什么用的？</h2><p id="deae" class="pw-post-body-paragraph kv kw jg kx b ky mr kh la lb ms kk ld le mt lg lh li mu lk ll lm mv lo lp lq ij bi translated">使用runbooks自动完成3种常见的任务</p><ul class=""><li id="f3c7" class="nq nr jg kx b ky kz lb lc le ns li nt lm nu lq nv nw nx ny bi translated">处理<strong class="kx jh">事件</strong></li><li id="1d85" class="nq nr jg kx b ky nz lb oa le ob li oc lm od lq nv nw nx ny bi translated">执行可重复的任务</li><li id="2ebe" class="nq nr jg kx b ky nz lb oa le ob li oc lm od lq nv nw nx ny bi translated">问题<strong class="kx jh">诊断</strong></li></ul><p id="b463" class="pw-post-body-paragraph kv kw jg kx b ky kz kh la lb lc kk ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">下图显示了从事件缓解和诊断开始收集有关新问题或可重复任务的信息的流程。</p><figure class="nm nn no np gt is gh gi paragraph-image"><div class="gh gi oe"><img src="../Images/bb0b4425045a307991ef6be5a2f20ec8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1338/format:webp/1*tgeUot7pJ0rGTrs2FvDcMQ.png"/></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">来源:作者</figcaption></figure><p id="3f69" class="pw-post-body-paragraph kv kw jg kx b ky kz kh la lb lc kk ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">当然，Runbooks不仅限于Kubernetes，这也是我们今天要关注的内容。</p><h2 id="ca1a" class="ly lz jg bd ma mb mc dn md me mf dp mg le mh mi mj li mk ml mm lm mn mo mp mq bi translated">诊断学</h2><p id="27c3" class="pw-post-body-paragraph kv kw jg kx b ky mr kh la lb ms kk ld le mt lg lh li mu lk ll lm mv lo lp lq ij bi translated">诊断是操作手册的一个特例，其中有许多探索性的步骤还没有以操作手册的形式记录下来。</p><p id="bc3b" class="pw-post-body-paragraph kv kw jg kx b ky kz kh la lb lc kk ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">使用和维护一个专用的调试容器，尤其是带有临时容器特性的调试容器，有助于在团队中共享最佳的诊断实践和工具。然而，这是一个单独的博客的主题！</p><div class="ip iq gp gr ir of"><a href="https://github.com/Piotr1215/debug/blob/master/Dockerfile" rel="noopener  ugc nofollow" target="_blank"><div class="og ab fo"><div class="oh ab oi cl cj oj"><h2 class="bd jh gy z fp ok fr fs ol fu fw jf bi translated">主Piotr1215/debug的调试/docker文件</h2><div class="om l"><h3 class="bd b gy z fp ok fr fs ol fu fw dk translated">此文件包含双向Unicode文本，其解释或编译可能与下面显示的不同…</h3></div><div class="on l"><p class="bd b dl z fp ok fr fs ol fu fw dk translated">github.com</p></div></div><div class="oo l"><div class="op l oq or os oo ot ix of"/></div></div></a></div><h2 id="5a59" class="ly lz jg bd ma mb mc dn md me mf dp mg le mh mi mj li mk ml mm lm mn mo mp mq bi translated">自动化目标</h2><p id="b219" class="pw-post-body-paragraph kv kw jg kx b ky mr kh la lb ms kk ld le mt lg lh li mu lk ll lm mv lo lp lq ij bi translated">为什么不用一个脚本或一个程序来实现自动化呢？</p><p id="d4c4" class="pw-post-body-paragraph kv kw jg kx b ky kz kh la lb lc kk ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">操作手册是需要人工干预的任务的支持工具和指南，根据定义，这些任务不能自动化。他们获取运营知识，并为改进提供重要来源。</p><p id="5e91" class="pw-post-body-paragraph kv kw jg kx b ky kz kh la lb lc kk ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">从构建和执行操作手册中获得的经验可以也应该成为提高它们所涉及的系统的自动化水平的灵感。</p><p id="72e7" class="pw-post-body-paragraph kv kw jg kx b ky kz kh la lb lc kk ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">runbooks自动化有什么帮助？</p><ul class=""><li id="b589" class="nq nr jg kx b ky kz lb lc le ns li nt lm nu lq nv nw nx ny bi translated">能够以可重复的方式执行操作手册中的步骤</li><li id="8179" class="nq nr jg kx b ky nz lb oa le ob li oc lm od lq nv nw nx ny bi translated">以事件处理文件的形式留下<strong class="kx jh">审计线索</strong></li><li id="96cb" class="nq nr jg kx b ky nz lb oa le ob li oc lm od lq nv nw nx ny bi translated">每个有权限的人都应该能够执行操作手册</li></ul></div><div class="ab cl ou ov hu ow" role="separator"><span class="ox bw bk oy oz pa"/><span class="ox bw bk oy oz pa"/><span class="ox bw bk oy oz"/></div><div class="ij ik il im in"><h1 id="e752" class="pb lz jg bd ma pc pd pe md pf pg ph mg km pi kn mj kp pj kq mm ks pk kt mp pl bi translated">实践中的自动化操作手册</h1><p id="ab0a" class="pw-post-body-paragraph kv kw jg kx b ky mr kh la lb ms kk ld le mt lg lh li mu lk ll lm mv lo lp lq ij bi translated">首先，创建一个文件夹结构，每个文件夹对应一个单独的Kubernetes集群。通过这种方式，我们可以保持集群连接完全分离。</p><p id="e578" class="pw-post-body-paragraph kv kw jg kx b ky kz kh la lb lc kk ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">随着时间的推移。kube/config文件将包含开发、测试和生产集群参考。很容易忘记从prod集群上下文中关闭，并出错运行例如<code class="fe pm pn po pp b">kubectl delete ns crossplane-system</code>。</p><h2 id="5927" class="ly lz jg bd ma mb mc dn md me mf dp mg le mh mi mj li mk ml mm lm mn mo mp mq bi translated">使用direnv加载k8s配置</h2><p id="e394" class="pw-post-body-paragraph kv kw jg kx b ky mr kh la lb ms kk ld le mt lg lh li mu lk ll lm mv lo lp lq ij bi translated">使用下面的设置来避免这种错误，并保持集群的独立性。</p><ol class=""><li id="d09b" class="nq nr jg kx b ky kz lb lc le ns li nt lm nu lq pq nw nx ny bi translated">安装目录环境</li></ol><p id="46dc" class="pw-post-body-paragraph kv kw jg kx b ky kz kh la lb lc kk ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">大多数Linux发行版上都有Direnv，在Mac上设置它很容易</p><pre class="nm nn no np gt pr pp ps pt aw pu bi"><span id="ccb1" class="ly lz jg pp b gy pv pw l px py">brew install direnv<br/>echo eval "$(direnv hook bash)" &gt;&gt; ~/.bashrc # or ~/.zshrc</span></pre><p id="44dc" class="pw-post-body-paragraph kv kw jg kx b ky kz kh la lb lc kk ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">2.为每个集群创建一个目录</p><p id="6811" class="pw-post-body-paragraph kv kw jg kx b ky kz kh la lb lc kk ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">特别是对于连接重要的prod集群，使用专用目录要安全得多。</p><p id="445b" class="pw-post-body-paragraph kv kw jg kx b ky kz kh la lb lc kk ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated"><code class="fe pm pn po pp b">mkdir prod-cluster-xxx &amp;&amp; cd prod-cluster-xxx</code></p><p id="25ff" class="pw-post-body-paragraph kv kw jg kx b ky kz kh la lb lc kk ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">3.创造。envrc文件</p><p id="bfac" class="pw-post-body-paragraph kv kw jg kx b ky kz kh la lb lc kk ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">这个文件包含了<strong class="kx jh"> KUBECONFIG </strong>变量，该变量的作用范围仅限于当前目录和所有子目录</p><p id="96cc" class="pw-post-body-paragraph kv kw jg kx b ky kz kh la lb lc kk ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated"><code class="fe pm pn po pp b">echo export KUBECONFIG="$PWD"/config &gt;&gt; .envrc</code></p><p id="ed05" class="pw-post-body-paragraph kv kw jg kx b ky kz kh la lb lc kk ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">大多数云提供商提供一个命令，将凭证合并到活动配置文件中。例如，添加一个命令</p><pre class="nm nn no np gt pr pp ps pt aw pu bi"><span id="2e9f" class="ly lz jg pp b gy pv pw l px py">gcloud container clusters get-credentials ...</span></pre><p id="5f9e" class="pw-post-body-paragraph kv kw jg kx b ky kz kh la lb lc kk ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">设置完<code class="fe pm pn po pp b">KUBECONFIG</code>后，变量将使用Google Cloud中远程GKE集群的凭证进行更新。</p><p id="7afa" class="pw-post-body-paragraph kv kw jg kx b ky kz kh la lb lc kk ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated"><code class="fe pm pn po pp b">.envrc</code>文件还可以保存需要按文件夹加载的静态变量，比如名称空间名称、部署名称等。</p><p id="53cf" class="pw-post-body-paragraph kv kw jg kx b ky kz kh la lb lc kk ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">4.在目录中启用direnv</p><p id="db1a" class="pw-post-body-paragraph kv kw jg kx b ky kz kh la lb lc kk ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated"><code class="fe pm pn po pp b">direnv allow</code></p><h2 id="1334" class="ly lz jg bd ma mb mc dn md me mf dp mg le mh mi mj li mk ml mm lm mn mo mp mq bi translated">文件夹=集群</h2><p id="0ba2" class="pw-post-body-paragraph kv kw jg kx b ky mr kh la lb ms kk ld le mt lg lh li mu lk ll lm mv lo lp lq ij bi translated">每次进入文件夹，KUBECONFIG变量都会改变，指向文件夹本地的配置文件。通过离开文件夹，<strong class="kx jh"> direnv </strong>将卸载本地<strong class="kx jh"> KUBECONFIG </strong>变量并设置先前的shell变量。</p><h2 id="e15e" class="ly lz jg bd ma mb mc dn md me mf dp mg le mh mi mj li mk ml mm lm mn mo mp mq bi translated">操作手册</h2><p id="f435" class="pw-post-body-paragraph kv kw jg kx b ky mr kh la lb ms kk ld le mt lg lh li mu lk ll lm mv lo lp lq ij bi translated">每个runbook都是一个markdown文件，包含与我们想要执行的操作相关的代码块。把它们想象成你行动的蓝图。</p><p id="2fb0" class="pw-post-body-paragraph kv kw jg kx b ky kz kh la lb lc kk ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">每个操作手册都是从一个模板文件中复制的，并且可以用一个专用的`. envrc '文件存储在一个单独的文件夹中，以便更好地捕获执行步骤的结果。</p><p id="f5d1" class="pw-post-body-paragraph kv kw jg kx b ky kz kh la lb lc kk ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">专用文件夹允许存储笔记、故障排除步骤等，如果需要，可以很容易地转换成git存储库。</p><h2 id="f67e" class="ly lz jg bd ma mb mc dn md me mf dp mg le mh mi mj li mk ml mm lm mn mo mp mq bi translated">示例操作手册</h2><p id="2893" class="pw-post-body-paragraph kv kw jg kx b ky mr kh la lb ms kk ld le mt lg lh li mu lk ll lm mv lo lp lq ij bi translated">该文件本身是一个简单的标记，带有由代码运行器执行的隔离代码块和在命令下收集的结果。</p><p id="cca5" class="pw-post-body-paragraph kv kw jg kx b ky kz kh la lb lc kk ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">完成操作手册后，命令输出将直接位于命令之下。您可以/应该添加关于执行这些步骤的注释和附加信息。</p><p id="60a1" class="pw-post-body-paragraph kv kw jg kx b ky kz kh la lb lc kk ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">最后，将新文件提交给一个<code class="fe pm pn po pp b">runbooks-repository</code>并使用PR过程来合并它，并从您的同事那里获得反馈和改进建议。</p><figure class="nm nn no np gt is"><div class="bz fp l di"><div class="pz qa l"/></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">来源:作者</figcaption></figure><h2 id="b845" class="ly lz jg bd ma mb mc dn md me mf dp mg le mh mi mj li mk ml mm lm mn mo mp mq bi translated">结论</h2><p id="7458" class="pw-post-body-paragraph kv kw jg kx b ky mr kh la lb ms kk ld le mt lg lh li mu lk ll lm mv lo lp lq ij bi translated">我们已经看到如何使用开源工具，如neovim、direnv、git和kubectl，我们能够创建一个可重用的自动化运行手册。</p><p id="3185" class="pw-post-body-paragraph kv kw jg kx b ky kz kh la lb lc kk ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">自动化操作手册库将不断增长，并有助于以更干净、更快速的方式处理事件、更优化的手动配置任务，并帮助获取探索性诊断的结果。</p></div></div>    
</body>
</html>