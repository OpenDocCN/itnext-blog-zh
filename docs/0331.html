<html>
<head>
<title>Building an ARM Kubernetes Cluster</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">构建ARM Kubernetes集群</h1>
<blockquote>原文：<a href="https://itnext.io/building-an-arm-kubernetes-cluster-ef31032636f9?source=collection_archive---------0-----------------------#2018-02-21">https://itnext.io/building-an-arm-kubernetes-cluster-ef31032636f9?source=collection_archive---------0-----------------------#2018-02-21</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><blockquote class="jq jr js"><p id="1a2a" class="jt ju jv jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr im bi translated">自从我发布了这篇文章，我已经有超过30k的浏览量和大量的反馈。我最近写了一篇关于部署Kubernetes 1.13和一些新增内容的更新文章。请查阅<a class="ae ks" href="https://medium.com/@carlosedp/building-a-hybrid-x86-64-and-arm-kubernetes-cluster-e7f94ff6e51d" rel="noopener">https://medium . com/@ carlosedp/building-a-hybrid-x86-64-and-arm-kubernetes-cluster-e 7 f 94 ff 6 e 51d</a>并以此为参考了解更多详情。</p></blockquote><p id="7bf1" class="pw-post-body-paragraph jt ju it jw b jx jy jz ka kb kc kd ke kt kg kh ki ku kk kl km kv ko kp kq kr im bi translated">在本指南中，我想分享我使用Rock64板和SBC(如Raspberry Pi等单板计算机)构建完整的Kubernetes集群(具有负载平衡器、入口和外部存储)的经验及其背后的历史。我学到了一些经验，对于拥有一个完全集成的环境，避免我在这个过程中遇到的一些问题可能会有帮助。</p><h2 id="9717" class="kw kx it bd ky kz la dn lb lc ld dp le kt lf lg lh ku li lj lk kv ll lm ln lo bi translated">树莓Pi 3首发</h2><p id="42f9" class="pw-post-body-paragraph jt ju it jw b jx lp jz ka kb lq kd ke kt lr kh ki ku ls kl km kv lt kp kq kr im bi translated">在我开始玩我的第一个SBC，一个Raspberry Pi 3之后，我部署了一个完整的<a class="ae ks" href="https://github.com/carlosedp/rpi-media-server" rel="noopener ugc nofollow" target="_blank">媒体服务器栈</a>，由Transmission、SickRage、CouchPotato、Plex和HTPCmanager组成(基于来自<a class="ae ks" href="https://www.htpcguides.com/arm-pi-media-server-installer-images-download-page/" rel="noopener ugc nofollow" target="_blank"> HTPCGuides </a>的漂亮包)。工作之后，我开始将所有这些应用程序转换成Docker容器，并使用docker-compose文件自动部署。后来我部署了一套完整的<a class="ae ks" href="https://github.com/carlosedp/arm-monitoring" rel="noopener ugc nofollow" target="_blank">监控解决方案</a>和<a class="ae ks" href="https://github.com/carlosedp/container-mgmt" rel="noopener ugc nofollow" target="_blank">管理</a>，由<a class="ae ks" href="https://portainer.io/" rel="noopener ugc nofollow" target="_blank"> Portainer </a>、cAdvisor、<a class="ae ks" href="https://prometheus.io/" rel="noopener ugc nofollow" target="_blank"> Prometheus </a>、<a class="ae ks" href="https://grafana.com" rel="noopener ugc nofollow" target="_blank"> Grafana </a>甚至<a class="ae ks" href="https://traefik.io/" rel="noopener ugc nofollow" target="_blank"> Traefik </a>组成，将一些app作为入口和HTTPS前端(带Letsencrypt证书)暴露在互联网上。</p><figure class="lv lw lx ly gt lz gh gi paragraph-image"><div role="button" tabindex="0" class="ma mb di mc bf md"><div class="gh gi lu"><img src="../Images/96e1da161bb6a1848a72195c8679ad07.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*nPzSOVV2dDE4yVJgF0e8rA.png"/></div></div></figure><p id="4d75" class="pw-post-body-paragraph jt ju it jw b jx jy jz ka kb kc kd ke kt kg kh ki ku kk kl km kv ko kp kq kr im bi translated">在这个过程中，我学到了很多东西，我必须构建许多映像来运行这些应用程序，组成部署，甚至在Travis 上设置一个<a class="ae ks" href="https://travis-ci.org/carlosedp/" rel="noopener ugc nofollow" target="_blank"> CI来自动交叉构建AMD64/ARM32/ARM64 </a>的<a class="ae ks" href="https://hub.docker.com/r/carlosedp/" rel="noopener ugc nofollow" target="_blank"> Docker映像。</a></p><figure class="lv lw lx ly gt lz gh gi paragraph-image"><div role="button" tabindex="0" class="ma mb di mc bf md"><div class="gh gi mg"><img src="../Images/4df09632cc0a49281a750f7833b84df6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*SoZukubbV6C2gOKJuW3ZyQ.png"/></div></div></figure><p id="1d0c" class="pw-post-body-paragraph jt ju it jw b jx jy jz ka kb kc kd ke kt kg kh ki ku kk kl km kv ko kp kq kr im bi translated">但是它并没有就此停止，在阅读了大量关于用这些Pi构建家庭集群的文章之后，我真的想要一个。但是更强大。</p><h2 id="2770" class="kw kx it bd ky kz la dn lb lc ld dp le kt lf lg lh ku li lj lk kv ll lm ln lo bi translated">硬件选择</h2><p id="1c58" class="pw-post-body-paragraph jt ju it jw b jx lp jz ka kb lq kd ke kt lr kh ki ku ls kl km kv lt kp kq kr im bi translated">我最终选择了Pine64的<a class="ae ks" href="https://www.pine64.org/?page_id=7147" rel="noopener ugc nofollow" target="_blank"> Rock64 </a> SBC，这是一款四核A53 ARM板，可以运行64位Linux，4GB RAM和一个eMMC连接器，使用这种内存来代替Pi上使用的缓慢的sd卡。这是我的购物清单:</p><ul class=""><li id="5c74" class="mh mi it jw b jx jy kb kc kt mj ku mk kv ml kr mm mn mo mp bi translated">3个Rock64 4GB SBCs，带电源和散热器</li><li id="0bc7" class="mh mi it jw b jx mq kb mr kt ms ku mt kv mu kr mm mn mo mp bi translated">3张32GB eMMC存储卡</li><li id="b242" class="mh mi it jw b jx mq kb mr kt ms ku mt kv mu kr mm mn mo mp bi translated">USB3转SATA适配器，用于运行外部存储驱动器</li><li id="8f54" class="mh mi it jw b jx mq kb mr kt ms ku mt kv mu kr mm mn mo mp bi translated">1个外部SATA磁盘，用于通过NFS存储部署数据</li><li id="1fcc" class="mh mi it jw b jx mq kb mr kt ms ku mt kv mu kr mm mn mo mp bi translated"><a class="ae ks" href="https://www.pine64.org/?product=padi-serial-console" rel="noopener ugc nofollow" target="_blank">串行转USB适配器</a>(对调试和初始配置很重要)</li><li id="ac0f" class="mh mi it jw b jx mq kb mr kt ms ku mt kv mu kr mm mn mo mp bi translated"><a class="ae ks" href="https://www.pine64.org/?product=usb-adapter-for-emmc-module" rel="noopener ugc nofollow" target="_blank"> USB转eMMC适配器</a>将图像刷新到eMMC模块</li><li id="c19f" class="mh mi it jw b jx mq kb mr kt ms ku mt kv mu kr mm mn mo mp bi translated"><a class="ae ks" href="http://amzn.to/2F0IzJ6" rel="noopener ugc nofollow" target="_blank"> TP-Link 8端口</a>千兆以太网Easy智能交换机</li><li id="2be3" class="mh mi it jw b jx mq kb mr kt ms ku mt kv mu kr mm mn mo mp bi translated">一个<a class="ae ks" href="http://amzn.to/2F2udYC" rel="noopener ugc nofollow" target="_blank">可堆叠机箱</a>和扁平<a class="ae ks" href="http://amzn.to/2COZ7l8" rel="noopener ugc nofollow" target="_blank">以太网电缆</a></li></ul><p id="3075" class="pw-post-body-paragraph jt ju it jw b jx jy jz ka kb kc kd ke kt kg kh ki ku kk kl km kv ko kp kq kr im bi translated">一切都到了，准备好享受一个愉快的周末。</p><figure class="lv lw lx ly gt lz gh gi paragraph-image"><div role="button" tabindex="0" class="ma mb di mc bf md"><div class="gh gi mv"><img src="../Images/4bc24edb1eeebdc42b666c721e499d1e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*d93KSu_1eXXMczSO.jpg"/></div></div></figure><h2 id="42f4" class="kw kx it bd ky kz la dn lb lc ld dp le kt lf lg lh ku li lj lk kv ll lm ln lo bi translated">规划和安装</h2><p id="6cd3" class="pw-post-body-paragraph jt ju it jw b jx lp jz ka kb lq kd ke kt lr kh ki ku ls kl km kv lt kp kq kr im bi translated">由于我已经在规划集群，所以我为我的家庭网络做了一个简单的IP规划。这对于设置用于客户端的DHCP范围、负载平衡器范围和固定IP非常重要。</p><pre class="lv lw lx ly gt mw mx my mz aw na bi"><span id="d1ea" class="kw kx it mx b gy nb nc l nd ne">Network: 192.168.1.0/24</span><span id="8833" class="kw kx it mx b gy nf nc l nd ne">Gateway: 192.168.1.1<br/>DNS: 192.168.1.1 (running dnsmasq on DD-WRT Router)<br/>Router DHCP range: 192.168.1.101 - 192.168.1.200</span><span id="71c3" class="kw kx it mx b gy nf nc l nd ne">Reserved: 192.168.1.2 - 192.168.1.15</span><span id="7f2e" class="kw kx it mx b gy nf nc l nd ne">* 192.168.1.1 - Router<br/>* 192.168.1.3 - Managed Switch<br/>* 192.168.1.4 - RPi3 (media server)</span><span id="3c63" class="kw kx it mx b gy nf nc l nd ne">Kubernetes Nodes:<br/>    - Master1: 192.168.1.50<br/>    - Node1: 192.168.1.55<br/>    - Node2: 192.168.1.56</span><span id="5067" class="kw kx it mx b gy nf nc l nd ne">MetalLB CIDR: 192.168.1.16/28<br/>    - 192.168.1.17 - 192.168.1.30</span><span id="6051" class="kw kx it mx b gy nf nc l nd ne">Traefik Internal Ingress IP: 192.168.1.20<br/>Traefik External Ingress IP: 192.168.1.21</span></pre><p id="619f" class="pw-post-body-paragraph jt ju it jw b jx jy jz ka kb kc kd ke kt kg kh ki ku kk kl km kv ko kp kq kr im bi translated">起初，我从<a class="ae ks" href="https://github.com/ayufan-rock64/linux-build/releases" rel="noopener ugc nofollow" target="_blank"> Ayufan的存储库</a>下载了Debian Stretch映像。他负责为这些主板维护最新的Linux版本。我用的是最新版本(在撰写本文时是0.6.20 ),它被标记为预发布版本(它崩溃了，稍后会详细介绍)。</p><p id="f0c1" class="pw-post-body-paragraph jt ju it jw b jx jy jz ka kb kc kd ke kt kg kh ki ku kk kl km kv ko kp kq kr im bi translated">非常简单，我使用eMMC USB适配器上的<a class="ae ks" href="https://etcher.io/" rel="noopener ugc nofollow" target="_blank">蚀刻机</a>将图像刷新到eMMC模块，将卡插入板中，<a class="ae ks" href="https://forum.pine64.org/showthread.php?tid=5029" rel="noopener ugc nofollow" target="_blank">通过串行USB适配器(GND-GND、Rx-Tx、Tx-Rx)将其连接到我的计算机，并将串行控制台(Windows上的<em class="jv"> Putty </em>或Mac/Linux上的<em class="jv">屏幕</em>)设置为正确的COM端口和速度<em class="jv"> 1500000。</em>您也可以连接HDMI显示器和键盘，而不是串口。</a></p><p id="6684" class="pw-post-body-paragraph jt ju it jw b jx jy jz ka kb kc kd ke kt kg kh ki ku kk kl km kv ko kp kq kr im bi translated">我检查了所有的<a class="ae ks" href="https://gist.github.com/carlosedp/4df3cd58a489a3c4022f97a474439b90" rel="noopener ugc nofollow" target="_blank">基本配置</a>板，主机名，IP，<a class="ae ks" href="https://gist.github.com/carlosedp/0e72aab68c89ca5accc6ad9c14d11a87#file-install_container_service-sh" rel="noopener ugc nofollow" target="_blank">安装Docker/Kubernetes </a>实用程序等(检查链接的要点和我使用的步骤脚本)。</p><p id="d627" class="pw-post-body-paragraph jt ju it jw b jx jy jz ka kb kc kd ke kt kg kh ki ku kk kl km kv ko kp kq kr im bi translated">起初，一切都很完美，但是在安装了Kubernetes和MetalLB(稍后会有更多介绍)之后，我立刻遇到了<a class="ae ks" href="https://gist.github.com/carlosedp/6ea80434782604a80242b06f358329b4" rel="noopener ugc nofollow" target="_blank">内核崩溃</a>。用以前的0.6.15版本再试一次，但是现在用Ubuntu Xenial我遇到了同样的问题。<a class="ae ks" href="https://github.com/ayufan-rock64/linux-build/issues/106" rel="noopener ugc nofollow" target="_blank">发行</a>已满。</p><p id="09cb" class="pw-post-body-paragraph jt ju it jw b jx jy jz ka kb kc kd ke kt kg kh ki ku kk kl km kv ko kp kq kr im bi translated">为了避免急躁，我下载了Debian Strech的最后一个稳定版本<a class="ae ks" href="https://github.com/ayufan-rock64/linux-build/releases/tag/0.5.15" rel="noopener ugc nofollow" target="_blank"> 0.5.15 </a>，一切都很好，所以暂时坚持这个版本。过了一段时间，我把板组装好并安装好了。</p><figure class="lv lw lx ly gt lz gh gi paragraph-image"><div class="gh gi ng"><img src="../Images/7fe07538430bf672fa5c883ff668c1ee.png" data-original-src="https://miro.medium.com/v2/resize:fit:1350/format:webp/0*7pvIdfgWRQcc8w2z.jpg"/></div></figure><h2 id="ccd3" class="kw kx it bd ky kz la dn lb lc ld dp le kt lf lg lh ku li lj lk kv ll lm ln lo bi translated">Kubernetes集群堆栈</h2><ul class=""><li id="fd9d" class="mh mi it jw b jx lp kb lq kt nh ku ni kv nj kr mm mn mo mp bi translated">Kubernetes 1.9.3 (kubeadm安装最新的稳定版本，您可以使用参数指定不同的版本)</li><li id="c4e3" class="mh mi it jw b jx mq kb mr kt ms ku mt kv mu kr mm mn mo mp bi translated">编织网作为覆盖网</li><li id="661e" class="mh mi it jw b jx mq kb mr kt ms ku mt kv mu kr mm mn mo mp bi translated">MetalLB负载平衡器—它与Kubernetes完美集成，您可以像使用云提供商一样请求LB服务</li><li id="0a32" class="mh mi it jw b jx mq kb mr kt ms ku mt kv mu kr mm mn mo mp bi translated">Traefik作为入口控制器，能够将URL映射到内部Kubernetes部署(例如，dashboard.yourdomain.com可以指向特定的pod服务)。还有另一个Traefik实例，用于通过Letsencrypt的外部入口和外部证书</li><li id="8425" class="mh mi it jw b jx mq kb mr kt ms ku mt kv mu kr mm mn mo mp bi translated">DNS服务器，用于将我的内部名称解析为Traefik或其他可能创建的服务上的负载平衡器的IP</li></ul><p id="3ced" class="pw-post-body-paragraph jt ju it jw b jx jy jz ka kb kc kd ke kt kg kh ki ku kk kl km kv ko kp kq kr im bi translated">对于内部DNS服务器，我首先考虑在基础设施中的容器上运行Bind，但是我在Kubernetes上发现了一个“设计决策”,它避免在同一服务中使用TCP和UDP端口(DNS在端口53上使用TCP和UDP)。这可能会在未来被MetalLB 缓解。</p><p id="c7fb" class="pw-post-body-paragraph jt ju it jw b jx jy jz ka kb kc kd ke kt kg kh ki ku kk kl km kv ko kp kq kr im bi translated">最后，我决定采用一种更可靠的方式，将DD-WRT闪存到我的Netgear R7000P路由器中，以便能够配置它的内部dnsmasq守护程序。简单的任务，全部配置完毕，只需向DD-WRT添加一行。现在我的路由器是我网络上的内部DNS服务器和缓存。</p><figure class="lv lw lx ly gt lz gh gi paragraph-image"><div class="gh gi nk"><img src="../Images/e686719f57ff565cafb880a578f600fc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1188/format:webp/1*JRqOlsUoqLnBAeUfxfQnLQ.png"/></div></figure><p id="fc1f" class="pw-post-body-paragraph jt ju it jw b jx jy jz ka kb kc kd ke kt kg kh ki ku kk kl km kv ko kp kq kr im bi translated">如果您无法部署内部DNS，请将所有将用于您计算机“主机”文件上的应用程序的域映射到已配置的Traefik入口IP。</p><pre class="lv lw lx ly gt mw mx my mz aw na bi"><span id="e068" class="kw kx it mx b gy nb nc l nd ne">cat /etc/hosts</span><span id="559a" class="kw kx it mx b gy nf nc l nd ne">192.168.1.20 application.internal.mydomain.com<br/>192.168.1.20 grafana.internal.mydomain.com<br/>192.168.1.20 dashboard.internal.mydomain.com</span><span id="9240" class="kw kx it mx b gy nf nc l nd ne">...</span></pre><h2 id="25cd" class="kw kx it bd ky kz la dn lb lc ld dp le kt lf lg lh ku li lj lk kv ll lm ln lo bi translated">Kubernetes部署</h2><p id="9b7a" class="pw-post-body-paragraph jt ju it jw b jx lp jz ka kb lq kd ke kt lr kh ki ku ls kl km kv lt kp kq kr im bi translated">我跟随官方<a class="ae ks" href="https://kubernetes.io/docs/setup/independent/create-cluster-kubeadm/" rel="noopener ugc nofollow" target="_blank"> kubeam指南</a>:</p><pre class="lv lw lx ly gt mw mx my mz aw na bi"><span id="ee11" class="kw kx it mx b gy nb nc l nd ne">sudo kubeadm init</span><span id="6288" class="kw kx it mx b gy nf nc l nd ne"># After init is finished<br/>mkdir -p $HOME/.kube<br/>sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config<br/>sudo chown $(id -u):$(id -g) $HOME/.kube/config</span><span id="9d37" class="kw kx it mx b gy nf nc l nd ne"># Install Weave Net as overlay network<br/>export kubever=$(kubectl version | base64 | tr -d '\n')<br/>kubectl apply -f "<a class="ae ks" href="https://cloud.weave.works/k8s/net?k8s-version=$kubever" rel="noopener ugc nofollow" target="_blank">https://cloud.weave.works/k8s/net?k8s-version=$kubever</a>"</span><span id="d5be" class="kw kx it mx b gy nf nc l nd ne"># Taint the master node so application pods can run on it too<br/>kubectl taint nodes --all node-role.kubernetes.io/master-</span><span id="dbf7" class="kw kx it mx b gy nf nc l nd ne"># Join other nodes (Get the command from kubeadm init command)<br/>kubeadm join --token secret.yourtoken 192.168.1.50:6443 --discovery-token-ca-cert-hash sha256:a57508843sdasdas6303d879722885710dsdsdacb502f9d8370ef5c354</span></pre><p id="9b1c" class="pw-post-body-paragraph jt ju it jw b jx jy jz ka kb kc kd ke kt kg kh ki ku kk kl km kv ko kp kq kr im bi translated">这将为您提供一个非常实用的Kubernetes集群，它具有一个覆盖网络，允许所有节点上的所有pods相互通信，但我添加了一些其他模块来获得一个更完整的集群。</p><p id="3eb1" class="pw-post-body-paragraph jt ju it jw b jx jy jz ka kb kc kd ke kt kg kh ki ku kk kl km kv ko kp kq kr im bi translated"><strong class="jw iu">要跟进下一个任务，从</strong> <a class="ae ks" href="https://github.com/carlosedp/kubernetes-arm" rel="noopener ugc nofollow" target="_blank"> <strong class="jw iu"> GitHub </strong> </a> <strong class="jw iu">克隆我的回购更容易。</strong></p><p id="e4fe" class="pw-post-body-paragraph jt ju it jw b jx jy jz ka kb kc kd ke kt kg kh ki ku kk kl km kv ko kp kq kr im bi translated"><em class="jv">如果您需要重置您的部署并重新开始(发生在我身上)，您需要清理添加到您的节点的每个规则kubernetes和Weave。我用需要的步骤做了一个</em> <a class="ae ks" href="https://gist.github.com/carlosedp/5040f4a1b2c97c1fa260a3409b5f14f9" rel="noopener ugc nofollow" target="_blank"> <em class="jv">要诀</em> </a> <em class="jv">。遵循这一点，以避免你的吊舱在重新部署后不互相交谈。</em></p><figure class="lv lw lx ly gt lz gh gi paragraph-image"><div role="button" tabindex="0" class="ma mb di mc bf md"><div class="gh gi nl"><img src="../Images/7c3badf6b287922ccb65f01d6dcbee87.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*kcQ0iK_ts5Ydqv6tcO-ctg.png"/></div></div></figure><h2 id="3f45" class="kw kx it bd ky kz la dn lb lc ld dp le kt lf lg lh ku li lj lk kv ll lm ln lo bi translated">负载平衡器和入口</h2><p id="f9c0" class="pw-post-body-paragraph jt ju it jw b jx lp jz ka kb lq kd ke kt lr kh ki ku ls kl km kv lt kp kq kr im bi translated"><a class="ae ks" href="https://metallb.universe.tf/" rel="noopener ugc nofollow" target="_blank"> <strong class="jw iu"> MetalLB </strong> </a>是一个直接集成到API的Kubernetes负载平衡器。这样，您可以使用<em class="jv">类型:LoadBalancer </em>请求服务，您的服务将从MetalLB中配置的池中分配一个IP。查看他们的网站了解更多信息。</p><p id="b488" class="pw-post-body-paragraph jt ju it jw b jx jy jz ka kb kc kd ke kt kg kh ki ku kk kl km kv ko kp kq kr im bi translated">对于安装和配置，运行脚本<code class="fe nm nn no mx b">install_metallb.sh</code>并从<a class="ae ks" href="https://github.com/carlosedp/kubernetes-arm/tree/master/1-MetalLB" rel="noopener ugc nofollow" target="_blank"> 1-MetalLB </a>目录部署清单<code class="fe nm nn no mx b">kubectl apply -f metallb-conf.yaml</code>。调整网络清单上的IP CIDR。</p><p id="ee75" class="pw-post-body-paragraph jt ju it jw b jx jy jz ka kb kc kd ke kt kg kh ki ku kk kl km kv ko kp kq kr im bi translated"><a class="ae ks" href="https://traefik.io/" rel="noopener ugc nofollow" target="_blank"><strong class="jw iu">Traefik</strong></a><strong class="jw iu"/>是一个入口控制器，可以在Kubernetes的服务层充当反向代理/负载平衡器。</p><figure class="lv lw lx ly gt lz gh gi paragraph-image"><div role="button" tabindex="0" class="ma mb di mc bf md"><div class="gh gi np"><img src="../Images/2159eeb315d3cbcdb770bd835fb21be2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*hcsdM12OTsRGdYB5.png"/></div></div></figure><p id="002b" class="pw-post-body-paragraph jt ju it jw b jx jy jz ka kb kc kd ke kt kg kh ki ku kk kl km kv ko kp kq kr im bi translated">有了Traefik，任何应用程序部署都可以在网络的一个子域上公开其服务。Traefik使用负载平衡器服务类型和固定IP进行自我部署。此IP在我的内部DNS上被映射为通配符，因此所有对<code class="fe nm nn no mx b">*.internal.mydomain.com</code>的调用都将转到此IP，并根据入口规则将Traefik转发到正确的pod。如果你没有域名系统，使用<em class="jv">主机</em>文件。例如:</p><pre class="lv lw lx ly gt mw mx my mz aw na bi"><span id="d47c" class="kw kx it mx b gy nb nc l nd ne">myapp.internal.mydomain.com -&gt; Internal DNS -&gt; resolved to the MetalLB IP allocated to Traefik -&gt; Traefik matches the called domain to the associated service -&gt; traffic is sent to the pod.</span></pre><p id="e3e9" class="pw-post-body-paragraph jt ju it jw b jx jy jz ka kb kc kd ke kt kg kh ki ku kk kl km kv ko kp kq kr im bi translated">Traefik有两种部署，一种用于内部入口(在domain *.internal.mydomain.com上)，另一种用于外部入口(在domain *.cloud.mydomain.com上)。这些部署有两个由负载平衡器分配的不同IP。这种分离是由于外部Traefik处理Letsencrypt上的证书生成。</p><p id="0867" class="pw-post-body-paragraph jt ju it jw b jx jy jz ka kb kc kd ke kt kg kh ki ku kk kl km kv ko kp kq kr im bi translated">为此，您需要使用路由器上的端口转发功能，将您的HTTP和HTTPS端口指向外部Traefik上分配的负载平衡器IP。</p><p id="5459" class="pw-post-body-paragraph jt ju it jw b jx jy jz ka kb kc kd ke kt kg kh ki ku kk kl km kv ko kp kq kr im bi translated">调整<a class="ae ks" href="https://github.com/carlosedp/kubernetes-arm/tree/master/2-Traefik" rel="noopener ugc nofollow" target="_blank"> 2-Traefik </a>目录上的配置文件(主要是<em class="jv"> configmaps </em>和<em class="jv"> services </em>上的LoadbalancerIP)以适应您的域和IPs，并使用<code class="fe nm nn no mx b"><em class="jv">kubectl apply -f traefik*</em></code> <em class="jv"> </em>部署所有内容。如果您不使用外部访问并且不需要证书，请不要部署<em class="jv"> external-traefik* </em>清单。</p><h2 id="3b1d" class="kw kx it bd ky kz la dn lb lc ld dp le kt lf lg lh ku li lj lk kv ll lm ln lo bi translated">Kubernetes储物和仪表板</h2><p id="562e" class="pw-post-body-paragraph jt ju it jw b jx lp jz ka kb lq kd ke kt lr kh ki ku ls kl km kv lt kp kq kr im bi translated">为了在应用程序上实现数据持久性，您需要在Kubernetes上创建持久性卷。实现这一点最灵活的方法是设置一个存储类，允许您的部署请求卷来存储数据。</p><p id="e1b4" class="pw-post-body-paragraph jt ju it jw b jx jy jz ka kb kc kd ke kt kg kh ki ku kk kl km kv ko kp kq kr im bi translated">我选择通过USB3将一个外部磁盘连接到我的一个节点(我选择了<em class="jv"> kubenode1 </em>)并在该节点上通过NFS共享该卷。格式化并安装外部驱动器，并安装NFS服务器(调整安装路径和网络):</p><pre class="lv lw lx ly gt mw mx my mz aw na bi"><span id="169e" class="kw kx it mx b gy nb nc l nd ne">sudo apt-get install nfs-kernel-server nfs-common<br/>sudo systemctl enable nfs-kernel-server</span><span id="3f1f" class="kw kx it mx b gy nf nc l nd ne"># Add following like to /etc/exports</span><span id="2594" class="kw kx it mx b gy nf nc l nd ne">/mnt/extssd1/kube/ 192.168.1.*(rw,sync,no_subtree_check,no_root_squash)</span><span id="c14f" class="kw kx it mx b gy nf nc l nd ne">sudo exportfs -a</span></pre><p id="d0b6" class="pw-post-body-paragraph jt ju it jw b jx jy jz ka kb kc kd ke kt kg kh ki ku kk kl km kv ko kp kq kr im bi translated">然后，我使用<a class="ae ks" href="https://github.com/kubernetes-incubator/external-storage/tree/master/nfs-client" rel="noopener ugc nofollow" target="_blank"> nfs-client-provisioner </a>使用<a class="ae ks" href="https://github.com/carlosedp/kubernetes-arm/tree/master/3-NFS_Storage" rel="noopener ugc nofollow" target="_blank">3-nfs _存储</a>上的文件在指向NFS服务器的Kubernetes上创建StorageClass(调整<em class="jv"> deployment-arm.yaml </em>上的IP和挂载点)。</p><pre class="lv lw lx ly gt mw mx my mz aw na bi"><span id="6c3c" class="kw kx it mx b gy nb nc l nd ne">kubectl apply -f auth/*<br/>kubectl apply -f deployment-arm.yaml<br/>kubectl apply -f class.yaml</span></pre><p id="74f0" class="pw-post-body-paragraph jt ju it jw b jx jy jz ka kb kc kd ke kt kg kh ki ku kk kl km kv ko kp kq kr im bi translated">检查您的存储类别是否为默认类别:</p><pre class="lv lw lx ly gt mw mx my mz aw na bi"><span id="efb8" class="kw kx it mx b gy nb nc l nd ne">rock64@kubemaster1:~/kube $ kubectl get storageclass<br/>NAME                      PROVISIONER       AGE<br/>nfs-ssd-node1 (default)   fuseim.pri/ssd1   2d</span></pre><p id="2356" class="pw-post-body-paragraph jt ju it jw b jx jy jz ka kb kc kd ke kt kg kh ki ku kk kl km kv ko kp kq kr im bi translated">如果没有，请使用命令</p><pre class="lv lw lx ly gt mw mx my mz aw na bi"><span id="4ed1" class="kw kx it mx b gy nb nc l nd ne">kubectl patch storageclass nfs-ssd-node1 -p '{"metadata":{"annotations": {"storageclass.kubernetes.io/is-default-class": "true"}}}'</span></pre><h2 id="5c31" class="kw kx it bd ky kz la dn lb lc ld dp le kt lf lg lh ku li lj lk kv ll lm ln lo bi translated">仪表板、heapster和InfluxDB</h2><p id="06f0" class="pw-post-body-paragraph jt ju it jw b jx lp jz ka kb lq kd ke kt lr kh ki ku ls kl km kv lt kp kq kr im bi translated">Heapster和InfluxDB从集群中收集一些统计数据，并在web GUI上显示它们。仪表板允许使用web控制台管理集群。</p><p id="224d" class="pw-post-body-paragraph jt ju it jw b jx jy jz ka kb kc kd ke kt kg kh ki ku kk kl km kv ko kp kq kr im bi translated">从<a class="ae ks" href="https://github.com/carlosedp/kubernetes-arm/tree/master/4-Dashboard" rel="noopener ugc nofollow" target="_blank"> 4-Dashboard </a>和<a class="ae ks" href="https://github.com/carlosedp/kubernetes-arm/tree/master/5-Heapster-Influx" rel="noopener ugc nofollow" target="_blank">5-heap ster-influence</a>目录安装清单。可以选择使用HTTPS和身份验证在外部部署仪表板，这取决于外部Traefik。使用<em class="jv"> generate_auth.sh </em>生成您的认证，并应用<em class="jv"> external-ingress.yaml </em>清单。</p><pre class="lv lw lx ly gt mw mx my mz aw na bi"><span id="9f5e" class="kw kx it mx b gy nb nc l nd ne">cd 4-Dashboard<br/>kubectl apply -f dashboard*</span><span id="cfbd" class="kw kx it mx b gy nf nc l nd ne">cd 5-Heapster-Influx<br/>kubectl apply -f *</span></pre><figure class="lv lw lx ly gt lz gh gi paragraph-image"><div role="button" tabindex="0" class="ma mb di mc bf md"><div class="gh gi nq"><img src="../Images/9d8953d5bebf0d788a325687b0958e4b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*nP6QnK-JUdHnrETyQ7n8ow.png"/></div></div></figure><p id="ad4d" class="pw-post-body-paragraph jt ju it jw b jx jy jz ka kb kc kd ke kt kg kh ki ku kk kl km kv ko kp kq kr im bi translated">你有一个很好的仪表板来管理你的豆荚。</p><h2 id="27d1" class="kw kx it bd ky kz la dn lb lc ld dp le kt lf lg lh ku li lj lk kv ll lm ln lo bi translated">监控堆栈</h2><p id="7507" class="pw-post-body-paragraph jt ju it jw b jx lp jz ka kb lq kd ke kt lr kh ki ku ls kl km kv lt kp kq kr im bi translated">自从部署集群以来，我使用Prometheus-operator将解决方案迁移到了一个更复杂的版本。</p><p id="da8b" class="pw-post-body-paragraph jt ju it jw b jx jy jz ka kb kc kd ke kt kg kh ki ku kk kl km kv ko kp kq kr im bi translated">我为此写了一篇新文章，有详细的解释，请遵循指南，因为我将只保留以下关于历史事件的信息:</p><p id="8ada" class="pw-post-body-paragraph jt ju it jw b jx jy jz ka kb kc kd ke kt kg kh ki ku kk kl km kv ko kp kq kr im bi translated"><a class="ae ks" href="https://medium.com/@carlosedp/creating-a-full-monitoring-solution-for-arm-kubernetes-cluster-53b3671186cb" rel="noopener">https://medium . com/@ carlosedp/creating-a-full-monitoring-solution-for-arm-kubernetes-cluster-53b 3671186 CB</a></p><blockquote class="jq jr js"><p id="c084" class="jt ju jv jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr im bi translated">作为一个选项，您可以部署一个很好的监控堆栈，与Prometheus、Grafana及其支持应用程序一起使用。我建议这是有点沉重的资源，但视觉效果和定制是伟大的。从<a class="ae ks" href="https://github.com/carlosedp/kubernetes-arm/tree/master/6-Monitoring" rel="noopener ugc nofollow" target="_blank"> 6-Monitoring </a>目录部署所有清单。记得调整<em class="it"> grafana/ingress.yaml </em>和<em class="it">Prometheus/ingress . YAML</em>的入口域。</p><p id="911b" class="jt ju jv jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr im bi translated">之后，您需要在grafana中配置Prometheus datasource(添加URL为<a class="ae ks" href="http://prometheus:9090" rel="noopener ugc nofollow" target="_blank"> http://prometheus:9090 </a>的数据源)并从Grafana中的<em class="it"> dashboards </em>目录导入仪表板。</p><p id="91bc" class="jt ju jv jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr im bi translated">进入你的入口域名:<a class="ae ks" href="http://grafana.internal.mydomain.com" rel="noopener ugc nofollow" target="_blank">http://grafana.internal.mydomain.com</a>。</p></blockquote><figure class="lv lw lx ly gt lz gh gi paragraph-image"><div role="button" tabindex="0" class="ma mb di mc bf md"><div class="gh gi nr"><img src="../Images/17d62a35664f98f661e5ee8f5a898116.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*uJ570GDa0JMoBGDlBNasfA.png"/></div></div><figcaption class="ns nt gj gh gi nu nv bd b be z dk translated">Kubernetes仪表板</figcaption></figure><figure class="lv lw lx ly gt lz gh gi paragraph-image"><div role="button" tabindex="0" class="ma mb di mc bf md"><div class="gh gi nw"><img src="../Images/1c9b42b82346bf38629c643d3ad3734b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*hPbs_skd2lmRwUkICO063A.png"/></div></div><figcaption class="ns nt gj gh gi nu nv bd b be z dk translated">系统和容器仪表板</figcaption></figure><p id="187a" class="pw-post-body-paragraph jt ju it jw b jx jy jz ka kb kc kd ke kt kg kh ki ku kk kl km kv ko kp kq kr im bi translated">从这里开始，您就拥有了一个功能齐全的集群，可以随时部署您的应用程序或使用不同的堆栈。<a class="ae ks" href="https://github.com/openfaas/faas" rel="noopener ugc nofollow" target="_blank"> OpenFaaS </a>、<a class="ae ks" href="http://7-Helm" rel="noopener ugc nofollow" target="_blank"> Helm </a>以及更多选项尽在你的掌握之中。请记住，您需要找到(或构建)ARM32或ARM64映像来部署在这个集群上。</p><p id="5cf9" class="pw-post-body-paragraph jt ju it jw b jx jy jz ka kb kc kd ke kt kg kh ki ku kk kl km kv ko kp kq kr im bi translated">用于安装的所有配置脚本和清单都托管在<a class="ae ks" href="https://github.com/carlosedp/kubernetes-arm" rel="noopener ugc nofollow" target="_blank">https://github.com/carlosedp/kubernetes-arm</a>中。</p><p id="61a9" class="pw-post-body-paragraph jt ju it jw b jx jy jz ka kb kc kd ke kt kg kh ki ku kk kl km kv ko kp kq kr im bi translated">To keep up on news or send suggestions, follow me on <a class="ae ks" href="https://twitter.com/carlosedp" rel="noopener ugc nofollow" target="_blank"> Twitter @carlosedp </a></p><h2 id="cea7" class="kw kx it bd ky kz la dn lb lc ld dp le kt lf lg lh ku li lj lk kv ll lm ln lo bi translated">References:</h2><ul class=""><li id="be37" class="mh mi it jw b jx lp kb lq kt nh ku ni kv nj kr mm mn mo mp bi translated"><a class="ae ks" href="https://blog.alexellis.io/serverless-kubernetes-on-raspberry-pi/" rel="noopener ugc nofollow" target="_blank">https://blog.alexellis.io/serverless-kubernetes-on-raspberry-pi/</a></li><li id="f127" class="mh mi it jw b jx mq kb mr kt ms ku mt kv mu kr mm mn mo mp bi translated"><a class="ae ks" href="http://blog.kars7e.io/2018/01/14/Kubernetes-cluster-on-ARM-using-Asus-Tinkerboard/?utm_content=buffer69682&amp;utm_medium=social&amp;utm_source=twitter.com&amp;utm_campaign=buffer" rel="noopener ugc nofollow" target="_blank"> WEB //blog.kars7e.io/2018/01/14/Kubernetes-cluster-on-ARM-using-Asus-Tinkerboard </a></li><li id="d5c4" class="mh mi it jw b jx mq kb mr kt ms ku mt kv mu kr mm mn mo mp bi translated"><a class="ae ks" href="https://www.hanselman.com/blog/HowToBuildAKubernetesClusterWithARMRaspberryPiThenRunNETCoreOnOpenFaas.aspx" rel="noopener ugc nofollow" target="_blank">https://www.hanselman.com/blog/HowToBuildAKubernetesClusterWithARMRaspberryPiThenRunNETCoreOnOpenFaas.aspx </a></li><li id="4e24" class="mh mi it jw b jx mq kb mr kt ms ku mt kv mu kr mm mn mo mp bi translated"><a class="ae ks" href="https://github.com/carlosedp/kubernetes-arm" rel="noopener ugc nofollow" target="_blank">https://github.com/carlosedp/kubernetes-arm </a></li><li id="1858" class="mh mi it jw b jx mq kb mr kt ms ku mt kv mu kr mm mn mo mp bi translated"><a class="ae ks" href="https://github.com/carlosedp/kubernetes-kit" rel="noopener ugc nofollow" target="_blank">https://github.com/carlosedp/kubernetes-kit </a></li></ul></div></div>    
</body>
</html>