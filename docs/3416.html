<html>
<head>
<title>Chromium: Linux, keyrings &amp;&amp; Secret Service, passwords encryption and store</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">铬:Linux，钥匙圈和秘密服务，密码加密和存储</h1>
<blockquote>原文：<a href="https://itnext.io/chromium-linux-keyrings-secret-service-passwords-encryption-and-store-d2b30d87ec08?source=collection_archive---------5-----------------------#2019-12-10">https://itnext.io/chromium-linux-keyrings-secret-service-passwords-encryption-and-store-d2b30d87ec08?source=collection_archive---------5-----------------------#2019-12-10</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div class="gh gi jn"><img src="../Images/2ac14cd8a1f3d341bbfcdc44a7f7f2f4.png" data-original-src="https://miro.medium.com/v2/resize:fit:260/format:webp/0*sozC61rJyrOL-TCD.png"/></div></figure><p id="4f26" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">深入研究密匙环(参见<a class="ae ks" href="https://rtfm.co.ua/en/what-is-linux-keyring-gnome-keyring-secret-service-and-d-bus/" rel="noopener ugc nofollow" target="_blank">什么是:Linux密匙环、gnome-密匙环、秘密服务和D-Bus post </a>)的动机之一是，如果Linux系统没有启用密匙环和/或秘密服务，Chromium会保持密码不加密。</p><p id="eab3" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">所以，让我们试着找出Chromium如何存储密码，在哪里存储密码，以及主要的问题——它们是加密存储的，还是不加密？</p><ul class=""><li id="2b9b" class="kt ku iq jw b jx jy kb kc kf kv kj kw kn kx kr ky kz la lb bi translated"><a class="ae ks" href="https://rtfm.co.ua/en/chromium-linux-keyrings-secret-service-passwords-encryption-and-store/#Chromium_and_keyring" rel="noopener ugc nofollow" target="_blank">铬和钥匙圈</a></li><li id="ee5a" class="kt ku iq jw b jx lc kb ld kf le kj lf kn lg kr ky kz la lb bi translated"><a class="ae ks" href="https://rtfm.co.ua/en/chromium-linux-keyrings-secret-service-passwords-encryption-and-store/#Chromium_without_a_keyring" rel="noopener ugc nofollow" target="_blank">没有钥匙圈的铬</a></li><li id="9378" class="kt ku iq jw b jx lc kb ld kf le kj lf kn lg kr ky kz la lb bi translated"><a class="ae ks" href="https://rtfm.co.ua/en/chromium-linux-keyrings-secret-service-passwords-encryption-and-store/#Chromium_with_a_keyring" rel="noopener ugc nofollow" target="_blank">带钥匙圈的铬</a></li><li id="6eb2" class="kt ku iq jw b jx lc kb ld kf le kj lf kn lg kr ky kz la lb bi translated"><a class="ae ks" href="https://rtfm.co.ua/en/chromium-linux-keyrings-secret-service-passwords-encryption-and-store/#Chromium_passwords_decrypt" rel="noopener ugc nofollow" target="_blank">铬密码解密</a></li><li id="b4a2" class="kt ku iq jw b jx lc kb ld kf le kj lf kn lg kr ky kz la lb bi translated"><a class="ae ks" href="https://rtfm.co.ua/en/chromium-linux-keyrings-secret-service-passwords-encryption-and-store/#Chrome_v10_vs_v11" rel="noopener ugc nofollow" target="_blank">铬v10 vs v11 </a></li><li id="b7c3" class="kt ku iq jw b jx lc kb ld kf le kj lf kn lg kr ky kz la lb bi translated"><a class="ae ks" href="https://rtfm.co.ua/en/chromium-linux-keyrings-secret-service-passwords-encryption-and-store/#Python_script_to_obtain_Chromiums_passwords" rel="noopener ugc nofollow" target="_blank"> Python脚本获取Chromium的密码</a></li><li id="3314" class="kt ku iq jw b jx lc kb ld kf le kj lf kn lg kr ky kz la lb bi translated"><a class="ae ks" href="https://rtfm.co.ua/en/chromium-linux-keyrings-secret-service-passwords-encryption-and-store/#Chromium_Secret_Service" rel="noopener ugc nofollow" target="_blank">铬&amp; &amp;特勤</a></li><li id="1c49" class="kt ku iq jw b jx lc kb ld kf le kj lf kn lg kr ky kz la lb bi translated"><a class="ae ks" href="https://rtfm.co.ua/en/chromium-linux-keyrings-secret-service-passwords-encryption-and-store/#Summary" rel="noopener ugc nofollow" target="_blank">总结</a></li></ul><h2 id="f01f" class="lh li iq bd lj lk ll dn lm ln lo dp lp kf lq lr ls kj lt lu lv kn lw lx ly lz bi translated">铬和钥匙圈</h2><p id="5d21" class="pw-post-body-paragraph ju jv iq jw b jx ma jz ka kb mb kd ke kf mc kh ki kj md kl km kn me kp kq kr ij bi translated"><a class="ae ks" href="https://chromium.googlesource.com/chromium/src/+/master/docs/security/faq.md#Does-the-Password-Manager-store-my-passwords-encrypted-on-disk" rel="noopener ugc nofollow" target="_blank">文档</a>指出:</p><blockquote class="mf mg mh"><p id="cca1" class="ju jv mi jw b jx jy jz ka kb kc kd ke mj kg kh ki mk kk kl km ml ko kp kq kr ij bi translated">在Linux上，Chrome以前将凭证直接存储在用户的Gnome Keyring或KWallet中，但由于技术原因，它已经将凭证存储在Chrome用户配置文件目录的“登录数据”中，但在磁盘上用一个密钥加密，然后存储在用户的Gnome Keyring或KWallet中。如果没有可用的Keyring或KWallet，数据在存储时不会加密。</p></blockquote><p id="ea4f" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">即:</p><ol class=""><li id="0334" class="kt ku iq jw b jx jy kb kc kf kv kj kw kn kx kr mm kz la lb bi translated">Chromium将密码存储在一个名为“登录数据”(<code class="fe mn mo mp mq b">'/home/setevoy/.config/chromium/Default/Login Data'</code>)的本地SQLite数据库中</li><li id="2f07" class="kt ku iq jw b jx lc kb ld kf le kj lf kn lg kr mm kz la lb bi translated">如果安装了<code class="fe mn mo mp mq b">gnome-keyring</code>或KWallet，那么Chromium将使用一个生成的密码对其数据库中的密码进行加密，该密码将存储在这样一个密钥环中</li><li id="7dc7" class="kt ku iq jw b jx lc kb ld kf le kj lf kn lg kr mm kz la lb bi translated">在其他情况下，如果特勤局根本不活动，密码将保持“原样”，纯文本</li></ol><p id="3aa5" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">嗯——让我们检查一下。</p><h2 id="fc43" class="lh li iq bd lj lk ll dn lm ln lo dp lp kf lq lr ls kj lt lu lv kn lw lx ly lz bi translated">没有钥匙圈的铬</h2><p id="796b" class="pw-post-body-paragraph ju jv iq jw b jx ma jz ka kb mb kd ke kf mc kh ki kj md kl km kn me kp kq kr ij bi translated">首先，当系统没有配置密匙环时，让我们尝试从SQLite获取密码。</p><p id="2119" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">要指定使用哪个后端，我们可以添加<code class="fe mn mo mp mq b">google-chrome --password-store=basic</code>选项，将密码存储为“纯文本”。</p><p id="5277" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">此外，检查其他参数— <em class="mi"> gnome </em>或<em class="mi"> kwallet，</em>参见<code class="fe mn mo mp mq b">man chromium</code>:</p><pre class="mr ms mt mu gt mv mq mw mx aw my bi"><span id="69c3" class="lh li iq mq b gy mz na l nb nc">--password-store=&lt;basic|gnome|kwallet&gt;<br/>Set the password store to use. The default is to automatically<br/>detect based on the desktop environment. basic selects the<br/>built in, unencrypted password store. gnome selects Gnome<br/>keyring. kwallet selects (KDE) KWallet. (Note that KWallet may<br/>not work reliably outside KDE.)</span></pre><p id="b61b" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">除此之外，让我们检查D-Bus服务，以确保我们没有启用秘密服务:</p><pre class="mr ms mt mu gt mv mq mw mx aw my bi"><span id="e457" class="lh li iq mq b gy mz na l nb nc">$ qdbus — session org.freedesktop.DBus / org.freedesktop.DBus.GetConnectionUnixProcessID org.freedesktop.secrets<br/>Error: org.freedesktop.DBus.Error.NameHasNoOwner<br/>Could not get PID of name ‘org.freedesktop.secrets’: no such name</span></pre><p id="32e7" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">好吧。</p><p id="6ad1" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">现在，为Chromium的数据创建一个新目录:</p><pre class="mr ms mt mu gt mv mq mw mx aw my bi"><span id="ba19" class="lh li iq mq b gy mz na l nb nc">$ mkdir /tmp/data-chrome-test-1</span></pre><p id="1d51" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">运行浏览器，将此目录作为主目录，并使用— password-store=basic选项来保持密码“不加密”:</p><pre class="mr ms mt mu gt mv mq mw mx aw my bi"><span id="ce53" class="lh li iq mq b gy mz na l nb nc">$ chromium — user-data-dir=/tmp/data-chrome-test-1 — password-store=basic</span></pre><p id="2ce0" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">现在，登录到某个网站，关闭浏览器，并检查其数据库:</p><pre class="mr ms mt mu gt mv mq mw mx aw my bi"><span id="1419" class="lh li iq mq b gy mz na l nb nc">$ sqlite3 /tmp/data-chrome-test-1/Default/Login\ Data ‘select username_value, password_value from logins;’<br/>testuser|v10�#�c�yF�b�f���</span></pre><p id="aa88" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">酷SQLite数据库的<code class="fe mn mo mp mq b">password_value</code>字段现在存储了一些密码。</p><p id="247b" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">顺便说一下，您可以使用<code class="fe mn mo mp mq b">.schema</code>命令获得表格的方案:</p><pre class="mr ms mt mu gt mv mq mw mx aw my bi"><span id="73b8" class="lh li iq mq b gy mz na l nb nc">$ sqlite3 ~/.config/chromium/Default/Login\ Data ‘.schema logins’<br/>CREATE TABLE IF NOT EXISTS “logins” (origin_url VARCHAR NOT NULL, action_url VARCHAR, \<br/>username_element VARCHAR, username_value VARCHAR, password_element VARCHAR, password_value BLOB \<br/>…));<br/>CREATE INDEX logins_signon ON logins (signon_realm);</span></pre><h2 id="136e" class="lh li iq bd lj lk ll dn lm ln lo dp lp kf lq lr ls kj lt lu lv kn lw lx ly lz bi translated">带钥匙圈的铬合金</h2><p id="ea3c" class="pw-post-body-paragraph ju jv iq jw b jx ma jz ka kb mb kd ke kf mc kh ki kj md kl km kn me kp kq kr ij bi translated">现在，让我们进一步尝试在启用密匙环时从Chromium的SQLite数据库获取密码。为此，<a class="ae ks" href="https://rtfm.co.ua/en/what-is-linux-keyring-gnome-keyring-secret-service-and-d-bus/#KeePass" rel="noopener ugc nofollow" target="_blank">在KeePass </a>中启用特勤支持，我们将使用KeePass代替“standard”<code class="fe mn mo mp mq b">gnome-keyring</code>，并为Chromium的数据创建一个新目录:</p><pre class="mr ms mt mu gt mv mq mw mx aw my bi"><span id="4963" class="lh li iq mq b gy mz na l nb nc">$ mkdir /tmp/data-chrome-test-2</span></pre><p id="effe" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">再次运行浏览器，但这次指定<code class="fe mn mo mp mq b">--password-store=gnome</code>，并将<code class="fe mn mo mp mq b">user-data-dir</code>更改为使用一个新的、清晰的SQLite数据库:</p><pre class="mr ms mt mu gt mv mq mw mx aw my bi"><span id="34b7" class="lh li iq mq b gy mz na l nb nc">$ chromium — user-data-dir=/tmp/data-chrome-test-2 — password-store=gnome</span></pre><p id="7478" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">再次登录某个地方，保存密码，检查数据库:</p><pre class="mr ms mt mu gt mv mq mw mx aw my bi"><span id="0297" class="lh li iq mq b gy mz na l nb nc">$ sqlite3 /tmp/data-chrome-test-2/Default/Login\ Data ‘select username_value, password_value from logins;’<br/>testuser|v11���H!@���2�jA�</span></pre><p id="b830" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">啊哈！</p><p id="d03c" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">首先，这里的前缀是<em class="mi"> v11 </em>，而不是<em class="mi"> v10 </em>，因为它是来自“未加密”数据库的密码，其次，字符串本身更长。</p><p id="f501" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">所以，密码以不同的方式存储。但是——他们的加密技术如何？</p><h2 id="a2e2" class="lh li iq bd lj lk ll dn lm ln lo dp lp kf lq lr ls kj lt lu lv kn lw lx ly lz bi translated">铬密码解密</h2><p id="5ec7" class="pw-post-body-paragraph ju jv iq jw b jx ma jz ka kb mb kd ke kf mc kh ki kj md kl km kn me kp kq kr ij bi translated">让我们试着弄清楚以下问题:</p><ol class=""><li id="a428" class="kt ku iq jw b jx jy kb kc kf kv kj kw kn kx kr mm kz la lb bi translated">首先，我们从“未加密”存储中获取密码，而不是明文形式，为什么会这样呢？</li><li id="1105" class="kt ku iq jw b jx lc kb ld kf le kj lf kn lg kr mm kz la lb bi translated">第二，我们如何从“加密”存储中获取可读的密码？</li></ol><p id="f31b" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">为了看到这一点，让我们来看看Chromium的<a class="ae ks" href="https://cs.chromium.org/chromium/src/components/os_crypt/" rel="noopener ugc nofollow" target="_blank">源代码</a>。</p><h2 id="28cd" class="lh li iq bd lj lk ll dn lm ln lo dp lp kf lq lr ls kj lt lu lv kn lw lx ly lz bi translated">Chrome v10与v11</h2><p id="9b75" class="pw-post-body-paragraph ju jv iq jw b jx ma jz ka kb mb kd ke kf mc kh ki kj md kl km kn me kp kq kr ij bi translated">首先，v10和v11前缀是什么？</p><p id="ee92" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">转到<code class="fe mn mo mp mq b">os_crypt_linux.cc</code>文件内容-<a class="ae ks" href="https://cs.chromium.org/chromium/src/components/os_crypt/os_crypt_linux.cc?l=38" rel="noopener ugc nofollow" target="_blank">https://cs . chromium . org/chromium/src/components/OS _ crypt/OS _ crypt _ Linux . cc？l=38 </a>:</p><pre class="mr ms mt mu gt mv mq mw mx aw my bi"><span id="2e2b" class="lh li iq mq b gy mz na l nb nc">...<br/>// Password version. V10 means that the hardcoded password will be used.<br/>// V11 means that a password is/will be stored using an OS-level library (e.g<br/>// Libsecret). V11 will not be used if such a library is not available.<br/>// Used for array indexing.<br/>enum Version {<br/>  V10 = 0,<br/>  V11 = 1,<br/>};<br/>...</span></pre><p id="bc4d" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">啊哈，所以<em class="mi"> v10 </em>是未加密密码的前缀，而<em class="mi"> v11 </em> —是加密的。</p><p id="b642" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">虽然在这两种情况下，我们得到的密码是一些奇怪的符号串，而不是一个明确的密码。</p><p id="a5fc" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">现在明白为什么了。</p><p id="e7bc" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">从文件的结尾开始，从<code class="fe mn mo mp mq b">DecryptString()</code>功能开始:</p><ol class=""><li id="317d" class="kt ku iq jw b jx jy kb kc kf kv kj kw kn kx kr mm kz la lb bi translated"><code class="fe mn mo mp mq b">DecryptString()</code>:在<code class="fe mn mo mp mq b">version</code>变量(<em class="mi"> v10 </em> или <em class="mi"> v11 </em>中存储一个版本；</li></ol><pre class="mr ms mt mu gt mv mq mw mx aw my bi"><span id="6ed1" class="lh li iq mq b gy mz na l nb nc">… if (base::StartsWith(ciphertext, kObfuscationPrefix[Version::V10], base::CompareCase::SENSITIVE)) { version = Version::V10; …</span></pre><ol class=""><li id="19c1" class="kt ku iq jw b jx jy kb kc kf kv kj kw kn kx kr mm kz la lb bi translated"><a class="ae ks" href="https://cs.chromium.org/chromium/src/components/os_crypt/os_crypt_linux.cc?l=197" rel="noopener ugc nofollow" target="_blank">https://cs . chromium . org/chromium/src/components/OS _ crypt/OS _ crypt _ Linux . cc？l=197 </a></li><li id="7c03" class="kt ku iq jw b jx lc kb ld kf le kj lf kn lg kr mm kz la lb bi translated"><code class="fe mn mo mp mq b">DecryptString()</code>试图通过调用<code class="fe mn mo mp mq b">GetEncryptionKey()</code>函数传递版本来获取加密密钥</li></ol><pre class="mr ms mt mu gt mv mq mw mx aw my bi"><span id="4eef" class="lh li iq mq b gy mz na l nb nc">… std::unique_ptr&lt;crypto::SymmetricKey&gt; encryption_key( GetEncryptionKey(version)); if (!encryption_key) { VLOG(1) &lt;&lt; “Decryption failed: could not get the key”; return false; } …</span></pre><ol class=""><li id="42a7" class="kt ku iq jw b jx jy kb kc kf kv kj kw kn kx kr mm kz la lb bi translated"><a class="ae ks" href="https://cs.chromium.org/chromium/src/components/os_crypt/os_crypt_linux.cc?gsn=GetEncryptionKey&amp;l=211" rel="noopener ugc nofollow" target="_blank">https://cs . chromium . org/chromium/src/components/OS _ crypt/OS _ crypt _ Linux . cc？gsn = GetEncryptionKey&amp;l = 211</a></li><li id="d71c" class="kt ku iq jw b jx lc kb ld kf le kj lf kn lg kr mm kz la lb bi translated"><code class="fe mn mo mp mq b">GetEncryptionKey()</code>依次调用<code class="fe mn mo mp mq b">g_get_password()</code>函数:</li></ol><pre class="mr ms mt mu gt mv mq mw mx aw my bi"><span id="e08e" class="lh li iq mq b gy mz na l nb nc">… std::string* password = g_get_password[version](); if (!password) return nullptr; …</span></pre><ol class=""><li id="d91e" class="kt ku iq jw b jx jy kb kc kf kv kj kw kn kx kr mm kz la lb bi translated"><a class="ae ks" href="https://cs.chromium.org/chromium/src/components/os_crypt/os_crypt_linux.cc?gsn=GetEncryptionKey&amp;l=119" rel="noopener ugc nofollow" target="_blank">https://cs . chromium . org/chromium/src/components/OS _ crypt/OS _ crypt _ Linux . cc？gsn = GetEncryptionKey&amp;l = 119</a></li><li id="514f" class="kt ku iq jw b jx lc kb ld kf le kj lf kn lg kr mm kz la lb bi translated">а <code class="fe mn mo mp mq b">g_get_password()</code>是指向<code class="fe mn mo mp mq b">GetPasswordV10()</code>和<code class="fe mn mo mp mq b">GetPasswordV11()</code>功能的指针:</li></ol><pre class="mr ms mt mu gt mv mq mw mx aw my bi"><span id="5772" class="lh li iq mq b gy mz na l nb nc">… std::string* (*g_get_password[])() = { &amp;GetPasswordV10, &amp;GetPasswordV11, }; …</span></pre><ol class=""><li id="3542" class="kt ku iq jw b jx jy kb kc kf kv kj kw kn kx kr mm kz la lb bi translated"><a class="ae ks" href="https://cs.chromium.org/chromium/src/components/os_crypt/os_crypt_linux.cc?l=109" rel="noopener ugc nofollow" target="_blank">https://cs . chromium . org/chromium/src/components/OS _ crypt/OS _ crypt _ Linux . cc？l=109 </a></li><li id="3b0c" class="kt ku iq jw b jx lc kb ld kf le kj lf kn lg kr mm kz la lb bi translated">还有里面的<code class="fe mn mo mp mq b">GetPasswordV10()</code>...我们看到了...什么？？？密码？！？</li></ol><pre class="mr ms mt mu gt mv mq mw mx aw my bi"><span id="4c12" class="lh li iq mq b gy mz na l nb nc">… if (!g_cache.Get().password_v10_cache.get()) { g_cache.Get().password_v10_cache.reset(new std::string(“peanuts”)); } …</span></pre><ol class=""><li id="dba2" class="kt ku iq jw b jx jy kb kc kf kv kj kw kn kx kr mm kz la lb bi translated"><a class="ae ks" href="https://cs.chromium.org/chromium/src/components/os_crypt/os_crypt_linux.cc?l=86" rel="noopener ugc nofollow" target="_blank">https://cs . chromium . org/chromium/src/components/OS _ crypt/OS _ crypt _ Linux . cc？l=86 </a></li></ol><p id="b817" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">所以，这就简单多了:</p><ol class=""><li id="a0a9" class="kt ku iq jw b jx jy kb kc kf kv kj kw kn kx kr mm kz la lb bi translated">如果存在一个密匙环服务，那么Chromium将会生成一个密码，并将它存储在这个密匙环中</li><li id="3cd5" class="kt ku iq jw b jx lc kb ld kf le kj lf kn lg kr mm kz la lb bi translated">如果没有钥匙圈和/或没有启用秘密服务，那么Chromium将使用硬编码的主密码“<em class="mi">花生</em></li></ol><p id="56bb" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">并且以后使用这个密码—将构造一个主密钥，用于加密SQLite数据库中的密码。</p><h2 id="6df6" class="lh li iq bd lj lk ll dn lm ln lo dp lp kf lq lr ls kj lt lu lv kn lw lx ly lz bi translated">Python脚本获取Chromium的密码</h2><p id="dde4" class="pw-post-body-paragraph ju jv iq jw b jx ma jz ka kb mb kd ke kf mc kh ki kj md kl km kn me kp kq kr ij bi translated">现在，让我们在实践中检查所有这些，看看它是否如我们在上面的代码中建议的那样工作。</p><p id="9dcc" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">此外，我们可以看到这里使用了AES 128位CBC加密:</p><pre class="mr ms mt mu gt mv mq mw mx aw my bi"><span id="6c97" class="lh li iq mq b gy mz na l nb nc">...<br/>// Key size required for 128 bit AES.<br/>const size_t kDerivedKeySizeInBits = 128;<br/>...</span></pre><p id="83d7" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">接下来，在<code class="fe mn mo mp mq b">GetEncryptionKey()</code>中，我们可以看到加密密钥是如何构造的:</p><pre class="mr ms mt mu gt mv mq mw mx aw my bi"><span id="7444" class="lh li iq mq b gy mz na l nb nc">...<br/>  // Create an encryption key from our password and salt.<br/>  std::unique_ptr&lt;crypto::SymmetricKey&gt; encryption_key(<br/>      crypto::SymmetricKey::DeriveKeyFromPasswordUsingPbkdf2(<br/>          crypto::SymmetricKey::AES, *password, salt, kEncryptionIterations,<br/>          kDerivedKeySizeInBits));<br/>  DCHECK(encryption_key);<br/><br/>  return encryption_key;<br/>...</span></pre><p id="a7c7" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">因此，要从数据库中解密一条记录，我们需要在下面的数据中，这是在文件的const变量中设置的:</p><ol class=""><li id="94fe" class="kt ku iq jw b jx jy kb kc kf kv kj kw kn kx kr mm kz la lb bi translated">主密码—将返回给<code class="fe mn mo mp mq b">GetPasswordV10()</code>或<code class="fe mn mo mp mq b">GetPasswordV11()</code></li><li id="0b2c" class="kt ku iq jw b jx lc kb ld kf le kj lf kn lg kr mm kz la lb bi translated">盐— <code class="fe mn mo mp mq b">const char kSalt[] = "saltysalt"</code></li><li id="704c" class="kt ku iq jw b jx lc kb ld kf le kj lf kn lg kr mm kz la lb bi translated">迭代— <code class="fe mn mo mp mq b">const size_t kEncryptionIterations = 1</code></li><li id="2831" class="kt ku iq jw b jx lc kb ld kf le kj lf kn lg kr mm kz la lb bi translated">钥匙的尺寸— <code class="fe mn mo mp mq b">const size_t kDerivedKeySizeInBits = 128</code></li></ol><p id="9f8f" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">为了解密密码——谷歌了这样一个简单的脚本<a class="ae ks" href="https://stackoverflow.com/a/23727331/2720802" rel="noopener ugc nofollow" target="_blank">这里&gt; &gt; &gt; </a>，在为自己使用进行了一点更新之后，我得到了下面的代码:</p><pre class="mr ms mt mu gt mv mq mw mx aw my bi"><span id="88f9" class="lh li iq mq b gy mz na l nb nc">#! /usr/bin/env python3                                                                                                                                                                                                                       <br/><br/>import sqlite3<br/><br/>from Crypto.Cipher import AES<br/>from Crypto.Protocol.KDF import PBKDF2<br/><br/><br/>def get_encrypted_data(db_path):<br/><br/>    # choose a database<br/>    conn = sqlite3.connect(db_path)<br/>    cursor = conn.cursor()<br/>    # connect and egt exncypted data<br/>    data = cursor.execute('SELECT action_url, username_value, password_value FROM logins')<br/>    <br/>    return data<br/><br/><br/># to get rid of padding<br/>def clean(x): <br/>    return x[:-x[-1]].decode('utf8')<br/><br/><br/>def get_decrypted_data(encrypted_password):<br/><br/>    print("Decrypting the string: {}".format(encrypted_password))<br/><br/>    # trim off the 'v10' that Chrome/ium prepends<br/>    encrypted_password = encrypted_password[3:]<br/><br/>    # making the key<br/>    salt = b'saltysalt'<br/>    iv = b' ' * 16<br/>    length = 16<br/>    iterations = 1<br/>    pb_pass = "peanuts".encode('utf8')<br/><br/>    key = PBKDF2(pb_pass, salt, length, iterations)<br/>    cipher = AES.new(key, AES.MODE_CBC, IV=iv)<br/>    <br/>    decrypted = cipher.decrypt(encrypted_password)<br/>    print(clean(decrypted))<br/><br/><br/>if __name__ == "__main__":<br/>    <br/>    db_path = '/tmp/data-chrome-test-1/Default/Login Data'<br/>    for url, user, encrypted_password in get_encrypted_data(db_path):<br/>        get_decrypted_data(encrypted_password)</span></pre><p id="f0d5" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">运行它:</p><pre class="mr ms mt mu gt mv mq mw mx aw my bi"><span id="7a85" class="lh li iq mq b gy mz na l nb nc">./get_chrome_pass.py<br/>Decrypting the string: b’v10\xd4#\xd6c\xabyF\xc6b\xdef\x06\xce\x14\xe3\xc5'<br/>test911911</span></pre><p id="82ca" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">太好了——我们从未加密的数据库中获得了密码。</p><h2 id="cb53" class="lh li iq bd lj lk ll dn lm ln lo dp lp kf lq lr ls kj lt lu lv kn lw lx ly lz bi translated">铬&amp;特勤局</h2><p id="18c2" class="pw-post-body-paragraph ju jv iq jw b jx ma jz ka kb mb kd ke kf mc kh ki kj md kl km kn me kp kq kr ij bi translated">现在，在KeePass中启用秘密存储支持(参见<a class="ae ks" href="https://rtfm.co.ua/what-is-linux-keyring-gnome-keyring-secret-service-i-d-bus/#KeePass" rel="noopener ugc nofollow" target="_blank">什么是:Linux keyring，gnome-keyring，Secret Service，и D-Bus </a>)来模拟一个已安装的<code class="fe mn mo mp mq b">gnome-keepass</code>并重启KeePass。</p><p id="5e28" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">为Chromium的数据添加一个新目录:</p><pre class="mr ms mt mu gt mv mq mw mx aw my bi"><span id="3a8f" class="lh li iq mq b gy mz na l nb nc">$ mkdir /tmp/data-chrome-test-2/</span></pre><p id="da2a" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">使用<em class="mi">data-chrome-test-2</em>data-directory运行chrome并指定<code class="fe mn mo mp mq b">--password-store=gnome</code>选项:</p><pre class="mr ms mt mu gt mv mq mw mx aw my bi"><span id="e366" class="lh li iq mq b gy mz na l nb nc">$ chromium — user-data-dir=/tmp/data-chrome-test-2/ — password-store=gnome</span></pre><p id="9608" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">在某处登录，再次保存密码，现在我们可以观察到Chromium在KeePass数据库中创建了两个新记录:</p><ol class=""><li id="1f5b" class="kt ku iq jw b jx jy kb kc kf kv kj kw kn kx kr mm kz la lb bi translated"><em class="mi">铬安全储存控制</em></li><li id="fa8e" class="kt ku iq jw b jx lc kb ld kf le kj lf kn lg kr mm kz la lb bi translated"><em class="mi">铬的安全储存</em></li></ol><p id="44c5" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">请检查它们的属性，了解有关每个属性的更多信息:</p><figure class="mr ms mt mu gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="ne nf di ng bf nh"><div class="gh gi nd"><img src="../Images/9d8bebb1642e8f6ba556ce300564fdeb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*JwrpkI_AkiaCyM9-.png"/></div></div></figure><p id="db71" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">此外，您可以检查D-Bus和特勤局，看看现在使用的是哪个集合:</p><pre class="mr ms mt mu gt mv mq mw mx aw my bi"><span id="d201" class="lh li iq mq b gy mz na l nb nc">$ secret-tool search Title ‘Chromium Safe Storage’<br/>[/org/freedesktop/secrets/collection/Main/f0fdc4706ef44958b716e28c13d66bed]<br/>label = Chromium Safe Storage<br/>secret = P5pUwxbWaIBBVU0+LATOcw==<br/>…<br/>schema = chrome_libsecret_os_crypt_password_v2<br/>…<br/>attribute.Title = Chromium Safe Storage<br/>…<br/>attribute.application = chromium<br/>…<br/>attribute.Path = /Chromium Safe Storage</span></pre><p id="b93d" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">现在，让我们尝试使用来自<em class="mi"> Chromium安全存储</em>条目的<em class="mi"> secret </em>属性的密码作为脚本中<code class="fe mn mo mp mq b">pb_pass</code>变量的值。</p><p id="a06e" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">从Chromium中退出以解锁数据库，否则，您会看到以下错误:</p><pre class="mr ms mt mu gt mv mq mw mx aw my bi"><span id="b5e9" class="lh li iq mq b gy mz na l nb nc">$ ./get_chrome_pass.py<br/>Traceback (most recent call last):<br/>File “./get_chrome_pass.py”, line 50, in &lt;module&gt;<br/>for url, user, encrypted_password in get_encrypted_data(db_path):<br/>File “./get_chrome_pass.py”, line 15, in get_encrypted_data<br/>data = cursor.execute(‘SELECT action_url, username_value, password_value FROM logins’)<br/>sqlite3.OperationalError: database is locked</span></pre><p id="8f32" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">更新脚本—数据库的路径:</p><pre class="mr ms mt mu gt mv mq mw mx aw my bi"><span id="8014" class="lh li iq mq b gy mz na l nb nc">...<br/>if __name__ == "__main__":<br/><br/>#   db_path = '/tmp/data-chrome-test-1/Default/Login Data'<br/>    db_path = '/tmp/data-chrome-test-2/Default/Login Data'<br/><br/>    for url, user, encrypted_password in get_encrypted_data(db_path):<br/>        get_decrypted_data(encrypted_password)</span></pre><p id="0b32" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">并且密码-代替<code class="fe mn mo mp mq b">pb_pass</code>中的“<em class="mi">花生</em>”，设置从KeePass的<em class="mi">铬安全存储</em>条目中获取的值:</p><pre class="mr ms mt mu gt mv mq mw mx aw my bi"><span id="c328" class="lh li iq mq b gy mz na l nb nc">...<br/>#    pb_pass = "peanuts".encode('utf8')                                                                                                                                                                                                       <br/>    pb_pass = "P5pUwxbWaIBBVU0+LATOcw==".encode('utf8')<br/>...</span></pre><p id="e3eb" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">试试看:</p><pre class="mr ms mt mu gt mv mq mw mx aw my bi"><span id="7217" class="lh li iq mq b gy mz na l nb nc">$ ./get_chrome_pass.py<br/>Decrypting the string: b’v11\xfc\x82\xf7H\n!@\x86\xb7\x982\xa8\x1fjA\xfd’<br/>test911911</span></pre><p id="a7b5" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">酷！我们得到了解密的密码。</p><h2 id="d91d" class="lh li iq bd lj lk ll dn lm ln lo dp lp kf lq lr ls kj lt lu lv kn lw lx ly lz bi translated">摘要</h2><p id="6bed" class="pw-post-body-paragraph ju jv iq jw b jx ma jz ka kb mb kd ke kf mc kh ki kj md kl km kn me kp kq kr ij bi translated">实际上，我试图弄清楚的主要事情是:Chromium的SQLite数据库中的密码总是以加密的方式存储，而不仅仅是明文。</p><p id="a461" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">只是对于没有密匙环服务的系统，比如启用了秘密服务的<code class="fe mn mo mp mq b">gnome-keyring</code>,用于加密的密码将是Chromium的同一个用户，这显然不能被认为是一种安全的方法。</p></div><div class="ab cl ni nj hu nk" role="separator"><span class="nl bw bk nm nn no"/><span class="nl bw bk nm nn no"/><span class="nl bw bk nm nn"/></div><div class="ij ik il im in"><p id="2edc" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated"><em class="mi">最初发布于</em> <a class="ae ks" href="https://rtfm.co.ua/en/chromium-linux-keyrings-secret-service-passwords-encryption-and-store/" rel="noopener ugc nofollow" target="_blank"> <em class="mi"> RTFM: Linux、DevOps和系统管理</em> </a> <em class="mi">。</em></p></div></div>    
</body>
</html>