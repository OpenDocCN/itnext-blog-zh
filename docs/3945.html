<html>
<head>
<title>Redux in Worker: Off-main-thread Redux Reducers and Middleware</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">工作线程中的Redux:脱离主线程的Redux Reducers和中间件</h1>
<blockquote>原文：<a href="https://itnext.io/redux-in-worker-off-main-thread-redux-reducers-and-middleware-508e0cad8ac6?source=collection_archive---------3-----------------------#2020-03-29">https://itnext.io/redux-in-worker-off-main-thread-redux-reducers-and-middleware-508e0cad8ac6?source=collection_archive---------3-----------------------#2020-03-29</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="b6d8" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">异步中间件示例</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/df76874279f01d468318ac8719f729f7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*eRRCiy1AfcEbL7IW.jpg"/></div></div></figure><h1 id="9b03" class="ku kv it bd kw kx ky kz la lb lc ld le jz lf ka lg kc lh kd li kf lj kg lk ll bi translated">介绍</h1><p id="2318" class="pw-post-body-paragraph lm ln it lo b lp lq ju lr ls lt jx lu lv lw lx ly lz ma mb mc md me mf mg mh im bi translated">Redux是一个框架无关的全局状态库。它经常与React连用。</p><p id="c7ac" class="pw-post-body-paragraph lm ln it lo b lp mi ju lr ls mj jx lu lv mk lx ly lz ml mb mc md mm mf mg mh im bi translated">虽然我喜欢Redux的抽象，但React将在不久的将来引入并发模式。如果我们想得到<code class="fe mn mo mp mq b">useTransition</code>的好处，状态必须在React内部以允许状态分支。这意味着我们无法从Redux中获益。</p><p id="b2c3" class="pw-post-body-paragraph lm ln it lo b lp mi ju lr ls mj jx lu lv mk lx ly lz ml mb mc md mm mf mg mh im bi translated">我一直在为允许状态分支的全局状态开发<a class="ae mr" href="https://react-tracked.js.org/" rel="noopener ugc nofollow" target="_blank">反应跟踪</a>。它在并发模式下运行良好。这给我留下了一个问题:只有Redux能做的用例是什么。</p><p id="8501" class="pw-post-body-paragraph lm ln it lo b lp mi ju lr ls mj jx lu lv mk lx ly lz ml mb mc md mm mf mg mh im bi translated">Redux不允许状态分支的原因是状态在外部存储中。那么，拥有一个外部商店的好处是什么。<a class="ae mr" href="https://redux-toolkit.js.org/" rel="noopener ugc nofollow" target="_blank"> Redux Toolkit </a>可以是一个答案。我有另一个答案，一个允许脱离主线程的外部存储。</p><p id="b90b" class="pw-post-body-paragraph lm ln it lo b lp mi ju lr ls mj jx lu lv mk lx ly lz ml mb mc md mm mf mg mh im bi translated">React是一个UI库，它打算在主UI线程中运行。Redux通常是UI不可知的，所以我们可以在工作线程中运行它。</p><p id="ab41" class="pw-post-body-paragraph lm ln it lo b lp mi ju lr ls mj jx lu lv mk lx ly lz ml mb mc md mm mf mg mh im bi translated">已经进行了几次实验来从主线程中卸载Redux，并在Web Workers中运行Redux的部分或全部工作。我开发了一个库来卸载整个Redux商店。</p><h1 id="317f" class="ku kv it bd kw kx ky kz la lb lc ld le jz lf ka lg kc lh kd li kf lj kg lk ll bi translated">裁员</h1><p id="2225" class="pw-post-body-paragraph lm ln it lo b lp lq ju lr ls lt jx lu lv lw lx ly lz ma mb mc md me mf mg mh im bi translated">这个库叫做redux-in-worker。请查看GitHub库。</p><div class="mt mu gp gr mv mw"><a href="https://github.com/dai-shi/redux-in-worker" rel="noopener  ugc nofollow" target="_blank"><div class="mx ab fo"><div class="my ab mz cl cj na"><h2 class="bd iu gy z fp nb fr fs nc fu fw is bi translated">戴氏/复工</h2><div class="nd l"><h3 class="bd b gy z fp nb fr fs nc fu fw dk translated">受React+Redux+Comlink = Off-main-thread启发的Web Worker中的完整Redux。这仍然是一个实验…</h3></div><div class="ne l"><p class="bd b dl z fp nb fr fs nc fu fw dk translated">github.com</p></div></div><div class="nf l"><div class="ng l nh ni nj nf nk ks mw"/></div></div></a></div><p id="cb61" class="pw-post-body-paragraph lm ln it lo b lp mi ju lr ls mj jx lu lv mk lx ly lz ml mb mc md mm mf mg mh im bi translated">虽然这个库不依赖于React，但它是为了与React一起使用而开发的。也就是说，它将确保保持对象引用相等，从而防止React中不必要的重新渲染。</p><p id="902c" class="pw-post-body-paragraph lm ln it lo b lp mi ju lr ls mj jx lu lv mk lx ly lz ml mb mc md mm mf mg mh im bi translated">请查看我写的关于此事的博文。</p><p id="dd71" class="pw-post-body-paragraph lm ln it lo b lp mi ju lr ls mj jx lu lv mk lx ly lz ml mb mc md mm mf mg mh im bi translated"><a class="ae mr" href="https://blog.axlight.com/posts/off-main-thread-react-redux-with-performance/" rel="noopener ugc nofollow" target="_blank">脱离主线程的反应与性能的降低</a></p><p id="4b4d" class="pw-post-body-paragraph lm ln it lo b lp mi ju lr ls mj jx lu lv mk lx ly lz ml mb mc md mm mf mg mh im bi translated">在接下来的部分中，我将展示一些使用redux-in-worker进行异步操作的代码。</p><h1 id="13e8" class="ku kv it bd kw kx ky kz la lb lc ld le jz lf ka lg kc lh kd li kf lj kg lk ll bi translated">redux-api中间件</h1><p id="caf8" class="pw-post-body-paragraph lm ln it lo b lp lq ju lr ls lt jx lu lv lw lx ly lz ma mb mc md me mf mg mh im bi translated">redux-api-middleware 是早期就存在的库之一。它接收动作并运行动作中描述的API调用。action对象是可序列化的，因此我们可以毫无问题地将其发送给worker。</p><p id="82e7" class="pw-post-body-paragraph lm ln it lo b lp mi ju lr ls mj jx lu lv mk lx ly lz ml mb mc md mm mf mg mh im bi translated">下面是示例代码:</p><pre class="kj kk kl km gt nl mq nm nn aw no bi"><span id="901e" class="np kv it mq b gy nq nr l ns nt">import { createStore, applyMiddleware } from 'redux';<br/>import { apiMiddleware } from 'redux-api-middleware';</span><span id="1d4c" class="np kv it mq b gy nu nr l ns nt">import { exposeStore } from 'redux-in-worker';</span><span id="5752" class="np kv it mq b gy nu nr l ns nt">export const initialState = {<br/>  count: 0,<br/>  person: {<br/>    name: '',<br/>    loading: false,<br/>  },<br/>};</span><span id="4b30" class="np kv it mq b gy nu nr l ns nt">export type State = typeof initialState;</span><span id="6322" class="np kv it mq b gy nu nr l ns nt">export type Action =<br/>  | { type: 'increment' }<br/>  | { type: 'decrement' }<br/>  | { type: 'setName'; name: string }<br/>  | { type: 'REQUEST' }<br/>  | { type: 'SUCCESS'; payload: { name: string } }<br/>  | { type: 'FAILURE' };</span><span id="92ac" class="np kv it mq b gy nu nr l ns nt">const reducer = (state = initialState, action: Action) =&gt; {<br/>  console.log({ state, action });<br/>  switch (action.type) {<br/>    case 'increment': return {<br/>      ...state,<br/>      count: state.count + 1,<br/>    };<br/>    case 'decrement': return {<br/>      ...state,<br/>      count: state.count - 1,<br/>    };<br/>    case 'setName': return {<br/>      ...state,<br/>      person: {<br/>        ...state.person,<br/>        name: action.name,<br/>      },<br/>    };<br/>    case 'REQUEST': return {<br/>      ...state,<br/>      person: {<br/>        ...state.person,<br/>        loading: true,<br/>      },<br/>    };<br/>    case 'SUCCESS': return {<br/>      ...state,<br/>      person: {<br/>        ...state.person,<br/>        name: action.payload.name,<br/>        loading: false,<br/>      },<br/>    };<br/>    case 'FAILURE': return {<br/>      ...state,<br/>      person: {<br/>        ...state.person,<br/>        name: 'ERROR',<br/>        loading: false,<br/>      },<br/>    };<br/>    default: return state;<br/>  }<br/>};</span><span id="5756" class="np kv it mq b gy nu nr l ns nt">const store = createStore(reducer, applyMiddleware(apiMiddleware));</span><span id="7bd6" class="np kv it mq b gy nu nr l ns nt">exposeStore(store);</span></pre><p id="9a85" class="pw-post-body-paragraph lm ln it lo b lp mi ju lr ls mj jx lu lv mk lx ly lz ml mb mc md mm mf mg mh im bi translated">上面的代码运行在一个worker中。</p><p id="e1ff" class="pw-post-body-paragraph lm ln it lo b lp mi ju lr ls mj jx lu lv mk lx ly lz ml mb mc md mm mf mg mh im bi translated">主线程中运行的代码如下:</p><pre class="kj kk kl km gt nl mq nm nn aw no bi"><span id="4ebd" class="np kv it mq b gy nq nr l ns nt">import { wrapStore } from 'redux-in-worker';<br/>import { initialState } from './store.worker';</span><span id="e7ba" class="np kv it mq b gy nu nr l ns nt">const store = wrapStore(<br/>  new Worker('./store.worker', { type: 'module' }),<br/>  initialState,<br/>  window.__REDUX_DEVTOOLS_EXTENSION__ &amp;&amp; window.__REDUX_DEVTOOLS_EXTENSION__(),<br/>);</span></pre><p id="c626" class="pw-post-body-paragraph lm ln it lo b lp mi ju lr ls mj jx lu lv mk lx ly lz ml mb mc md mm mf mg mh im bi translated">请在存储库中找到完整的示例:</p><p id="9cb1" class="pw-post-body-paragraph lm ln it lo b lp mi ju lr ls mj jx lu lv mk lx ly lz ml mb mc md mm mf mg mh im bi translated"><a class="ae mr" href="https://github.com/dai-shi/redux-in-worker/tree/master/examples/04_api" rel="noopener ugc nofollow" target="_blank">https://github . com/Dai-Shi/redux-in-worker/tree/master/examples/04 _ API</a></p><h1 id="99f9" class="ku kv it bd kw kx ky kz la lb lc ld le jz lf ka lg kc lh kd li kf lj kg lk ll bi translated">还原传奇</h1><p id="6a1f" class="pw-post-body-paragraph lm ln it lo b lp lq ju lr ls lt jx lu lv lw lx ly lz ma mb mc md me mf mg mh im bi translated">另一个可以和redux-in-worker一起使用的库是<a class="ae mr" href="https://redux-saga.js.org/" rel="noopener ugc nofollow" target="_blank"> redux-saga </a>。对于任何带有生成器的异步函数来说，这都是一个强大的库。因为它的动作对象是可序列化的，所以它只是工作。</p><p id="2e17" class="pw-post-body-paragraph lm ln it lo b lp mi ju lr ls mj jx lu lv mk lx ly lz ml mb mc md mm mf mg mh im bi translated">下面是示例代码:</p><pre class="kj kk kl km gt nl mq nm nn aw no bi"><span id="6087" class="np kv it mq b gy nq nr l ns nt">import { createStore, applyMiddleware } from 'redux';<br/>import createSagaMiddleware from 'redux-saga';<br/>import {<br/>  call,<br/>  put,<br/>  delay,<br/>  takeLatest,<br/>  takeEvery,<br/>  all,<br/>} from 'redux-saga/effects';</span><span id="55d2" class="np kv it mq b gy nu nr l ns nt">import { exposeStore } from 'redux-in-worker';</span><span id="3da9" class="np kv it mq b gy nu nr l ns nt">const sagaMiddleware = createSagaMiddleware();</span><span id="b713" class="np kv it mq b gy nu nr l ns nt">export const initialState = {<br/>  count: 0,<br/>  person: {<br/>    name: '',<br/>    loading: false,<br/>  },<br/>};</span><span id="fb70" class="np kv it mq b gy nu nr l ns nt">export type State = typeof initialState;</span><span id="9e06" class="np kv it mq b gy nu nr l ns nt">type ReducerAction =<br/>  | { type: 'INCREMENT' }<br/>  | { type: 'DECREMENT' }<br/>  | { type: 'SET_NAME'; name: string }<br/>  | { type: 'START_FETCH_USER' }<br/>  | { type: 'SUCCESS_FETCH_USER'; name: string }<br/>  | { type: 'ERROR_FETCH_USER' };</span><span id="dabc" class="np kv it mq b gy nu nr l ns nt">type AsyncActionFetch = { type: 'FETCH_USER'; id: number }<br/>type AsyncActionDecrement = { type: 'DELAYED_DECREMENT' };<br/>type AsyncAction = AsyncActionFetch | AsyncActionDecrement;</span><span id="d700" class="np kv it mq b gy nu nr l ns nt">export type Action = ReducerAction | AsyncAction;</span><span id="482d" class="np kv it mq b gy nu nr l ns nt">function* userFetcher(action: AsyncActionFetch) {<br/>  try {<br/>    yield put&lt;ReducerAction&gt;({ type: 'START_FETCH_USER' });<br/>    const response = yield call(() =&gt; fetch(`<a class="ae mr" href="https://jsonplaceholder.typicode.com/users/" rel="noopener ugc nofollow" target="_blank">https://jsonplaceholder.typicode.com/users/</a>${action.id}`));<br/>    const data = yield call(() =&gt; response.json());<br/>    yield delay(500);<br/>    const { name } = data;<br/>    if (typeof name !== 'string') throw new Error();<br/>    yield put&lt;ReducerAction&gt;({ type: 'SUCCESS_FETCH_USER', name });<br/>  } catch (e) {<br/>    yield put&lt;ReducerAction&gt;({ type: 'ERROR_FETCH_USER' });<br/>  }<br/>}</span><span id="f953" class="np kv it mq b gy nu nr l ns nt">function* delayedDecrementer() {<br/>  yield delay(500);<br/>  yield put&lt;ReducerAction&gt;({ type: 'DECREMENT' });<br/>}</span><span id="8b1f" class="np kv it mq b gy nu nr l ns nt">function* userFetchingSaga() {<br/>  yield takeLatest&lt;AsyncActionFetch&gt;('FETCH_USER', userFetcher);<br/>}</span><span id="1492" class="np kv it mq b gy nu nr l ns nt">function* delayedDecrementingSaga() {<br/>  yield takeEvery&lt;AsyncActionDecrement&gt;('DELAYED_DECREMENT', delayedDecrementer);<br/>}</span><span id="823a" class="np kv it mq b gy nu nr l ns nt">function* rootSaga() {<br/>  yield all([<br/>    userFetchingSaga(),<br/>    delayedDecrementingSaga(),<br/>  ]);<br/>}</span><span id="3b9c" class="np kv it mq b gy nu nr l ns nt">const reducer = (state = initialState, action: ReducerAction) =&gt; {<br/>  console.log({ state, action });<br/>  switch (action.type) {<br/>    case 'INCREMENT': return {<br/>      ...state,<br/>      count: state.count + 1,<br/>    };<br/>    case 'DECREMENT': return {<br/>      ...state,<br/>      count: state.count - 1,<br/>    };<br/>    case 'SET_NAME': return {<br/>      ...state,<br/>      person: {<br/>        ...state.person,<br/>        name: action.name,<br/>      },<br/>    };<br/>    case 'START_FETCH_USER': return {<br/>      ...state,<br/>      person: {<br/>        ...state.person,<br/>        loading: true,<br/>      },<br/>    };<br/>    case 'SUCCESS_FETCH_USER': return {<br/>      ...state,<br/>      person: {<br/>        ...state.person,<br/>        name: action.name,<br/>        loading: false,<br/>      },<br/>    };<br/>    case 'ERROR_FETCH_USER': return {<br/>      ...state,<br/>      person: {<br/>        ...state.person,<br/>        name: 'ERROR',<br/>        loading: false,<br/>      },<br/>    };<br/>    default: return state;<br/>  }<br/>};</span><span id="ba80" class="np kv it mq b gy nu nr l ns nt">const store = createStore(reducer, applyMiddleware(sagaMiddleware));<br/>sagaMiddleware.run(rootSaga);</span><span id="c7f8" class="np kv it mq b gy nu nr l ns nt">exposeStore(store);</span></pre><p id="319b" class="pw-post-body-paragraph lm ln it lo b lp mi ju lr ls mj jx lu lv mk lx ly lz ml mb mc md mm mf mg mh im bi translated">上面的代码运行在一个worker中。</p><p id="db15" class="pw-post-body-paragraph lm ln it lo b lp mi ju lr ls mj jx lu lv mk lx ly lz ml mb mc md mm mf mg mh im bi translated">主线程中运行的代码如下:</p><pre class="kj kk kl km gt nl mq nm nn aw no bi"><span id="90d3" class="np kv it mq b gy nq nr l ns nt">import { wrapStore } from 'redux-in-worker';<br/>import { initialState } from './store.worker';</span><span id="09cc" class="np kv it mq b gy nu nr l ns nt">const store = wrapStore(<br/>  new Worker('./store.worker', { type: 'module' }),<br/>  initialState,<br/>  window.__REDUX_DEVTOOLS_EXTENSION__ &amp;&amp; window.__REDUX_DEVTOOLS_EXTENSION__(),<br/>);</span></pre><p id="6db9" class="pw-post-body-paragraph lm ln it lo b lp mi ju lr ls mj jx lu lv mk lx ly lz ml mb mc md mm mf mg mh im bi translated">这和前面的例子一模一样。</p><p id="3e72" class="pw-post-body-paragraph lm ln it lo b lp mi ju lr ls mj jx lu lv mk lx ly lz ml mb mc md mm mf mg mh im bi translated">请在存储库中找到完整的示例:</p><p id="5715" class="pw-post-body-paragraph lm ln it lo b lp mi ju lr ls mj jx lu lv mk lx ly lz ml mb mc md mm mf mg mh im bi translated"><a class="ae mr" href="https://github.com/dai-shi/redux-in-worker/tree/master/examples/05_saga" rel="noopener ugc nofollow" target="_blank">https://github . com/Dai-Shi/redux-in-worker/tree/master/examples/05 _ saga</a></p><h1 id="389d" class="ku kv it bd kw kx ky kz la lb lc ld le jz lf ka lg kc lh kd li kf lj kg lk ll bi translated">结束语</h1><p id="1791" class="pw-post-body-paragraph lm ln it lo b lp lq ju lr ls lt jx lu lv lw lx ly lz ma mb mc md me mf mg mh im bi translated">这种方法的最大障碍之一是<a class="ae mr" href="https://github.com/reduxjs/redux-thunk" rel="noopener ugc nofollow" target="_blank">的重复。redux-thunk采用不可序列化的函数操作。它是官方工具，也包含在Redux Toolkit中。这意味着这种方法不会成为主流。</a></p><p id="a9a1" class="pw-post-body-paragraph lm ln it lo b lp mi ju lr ls mj jx lu lv mk lx ly lz ml mb mc md mm mf mg mh im bi translated">但无论如何，我希望有人喜欢这种方法，并在一些真实的环境中进行评估。请随时在<a class="ae mr" href="https://github.com/dai-shi/redux-in-worker/issues" rel="noopener ugc nofollow" target="_blank"> GitHub问题</a>中展开讨论。</p><p id="1e5a" class="pw-post-body-paragraph lm ln it lo b lp mi ju lr ls mj jx lu lv mk lx ly lz ml mb mc md mm mf mg mh im bi translated">顺便说一下，我为React开发了另一个库来使用Web Workers。</p><div class="mt mu gp gr mv mw"><a href="https://github.com/dai-shi/react-hooks-worker" rel="noopener  ugc nofollow" target="_blank"><div class="mx ab fo"><div class="my ab mz cl cj na"><h2 class="bd iu gy z fp nb fr fs nc fu fw is bi translated">戴氏/反应钩-工人</h2><div class="nd l"><h3 class="bd b gy z fp nb fr fs nc fu fw dk translated">React为网络工作者定制钩子。Web Workers是浏览器中主线程的另一个线程。我们可以负重奔跑…</h3></div><div class="ne l"><p class="bd b dl z fp nb fr fs nc fu fw dk translated">github.com</p></div></div><div class="nf l"><div class="nv l nh ni nj nf nk ks mw"/></div></div></a></div><p id="4782" class="pw-post-body-paragraph lm ln it lo b lp mi ju lr ls mj jx lu lv mk lx ly lz ml mb mc md mm mf mg mh im bi translated">这个库可以让你脱离主线程运行任何函数。这是一个小图书馆，相当稳定。也来看看。</p></div><div class="ab cl nw nx hx ny" role="separator"><span class="nz bw bk oa ob oc"/><span class="nz bw bk oa ob oc"/><span class="nz bw bk oa ob"/></div><div class="im in io ip iq"><p id="6b3e" class="pw-post-body-paragraph lm ln it lo b lp mi ju lr ls mj jx lu lv mk lx ly lz ml mb mc md mm mf mg mh im bi translated"><em class="ms">原载于2020年3月29日https://blog.axlight.com</em><em class="ms">的</em> <a class="ae mr" href="https://blog.axlight.com/posts/redux-in-worker-off-main-thread-redux-reducers-and-middleware/" rel="noopener ugc nofollow" target="_blank"> <em class="ms">。</em></a></p></div></div>    
</body>
</html>