<html>
<head>
<title>Cloud native applications with kubebuilder and kind aka kubernetes operators</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用kubebuilder和kind(又名kubernetes)操作器的云本地应用程序</h1>
<blockquote>原文：<a href="https://itnext.io/cloud-native-applications-with-kubebuilder-and-kind-aka-kubernetes-operators-2cf68dc27bea?source=collection_archive---------3-----------------------#2020-01-25">https://itnext.io/cloud-native-applications-with-kubebuilder-and-kind-aka-kubernetes-operators-2cf68dc27bea?source=collection_archive---------3-----------------------#2020-01-25</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div class="gh gi jn"><img src="../Images/c69acf2ad8e24b3ba70c04ae714734c8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1238/format:webp/1*7EIfcgQj_2J_MgG-R_v_0w.png"/></div></figure><p id="0480" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated"><strong class="jw ir">简介</strong></p><p id="c3cf" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">在本文中，我们将看到如何使用<a class="ae ks" href="https://github.com/kubernetes-sigs/kubebuilder" rel="noopener ugc nofollow" target="_blank"> kubebuilder </a>和<a class="ae ks" href="https://github.com/kubernetes-sigs/kind" rel="noopener ugc nofollow" target="_blank"> Kind </a>来创建一个本地测试集群和一个操作符，然后在集群中部署该操作符并对其进行测试，包含文件的存储库可以在这里找到，如果您想了解关于这个想法和项目的更多信息，请点击<a class="ae ks" href="https://github.com/kainlite/forward" rel="noopener ugc nofollow" target="_blank"> forward </a>。</p><p id="bddd" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">基本上，代码所做的是创建一个alpine/socat pod，您可以指定主机、端口和协议，它会为您创建一个隧道，这样您就可以使用端口转发或服务或入口或任何其他方式来公开另一个私有子网中的内容，虽然这听起来可能不是一个好主意，但它有一些用例，所以在执行任何操作之前，请检查您的安全约束。在正常情况下，它应该是安全的。 在进行调试或测试时，它对于测试或访问数据库可能很有用，但这是另一个讨论，这里使用的工具是它如此有趣的原因，这是一个云原生应用程序，因为它是kubernetes的原生应用程序，这也是我们将在这里探讨的内容。</p><p id="e657" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">虽然Kind实际上不是一个需求，但我用它来测试，并且非常喜欢它，它比minikube更快更简单。</p><p id="8cdf" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">另外，如果你对我是如何让这个操作员检查这个<a class="ae ks" href="https://github.com/kubernetes/kubernetes/issues/72597" rel="noopener ugc nofollow" target="_blank"> github问题</a>感兴趣的话。</p><p id="936e" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated"><strong class="jw ir">先决条件</strong></p><ul class=""><li id="5304" class="kt ku iq jw b jx jy kb kc kf kv kj kw kn kx kr ky kz la lb bi translated"><a class="ae ks" href="https://github.com/kubernetes-sigs/kubebuilder" rel="noopener ugc nofollow" target="_blank"> kubebuilder </a></li><li id="5c3c" class="kt ku iq jw b jx lc kb ld kf le kj lf kn lg kr ky kz la lb bi translated"><a class="ae ks" href="https://github.com/kubernetes-sigs/kustomize" rel="noopener ugc nofollow" target="_blank"> kustomize </a></li><li id="e6a6" class="kt ku iq jw b jx lc kb ld kf le kj lf kn lg kr ky kz la lb bi translated"><a class="ae ks" href="https://golang.org/dl/" rel="noopener ugc nofollow" target="_blank"> Go 1.13 </a></li><li id="de3f" class="kt ku iq jw b jx lc kb ld kf le kj lf kn lg kr ky kz la lb bi translated"><a class="ae ks" href="https://github.com/kubernetes-sigs/kind" rel="noopener ugc nofollow" target="_blank">种类</a></li><li id="396e" class="kt ku iq jw b jx lc kb ld kf le kj lf kn lg kr ky kz la lb bi translated">码头工人</li></ul><p id="0989" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated"><strong class="jw ir">创建项目</strong></p><p id="778d" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">在这一步中，我们需要创建kubebuilder项目，因此在一个空文件夹中，我们运行:</p><figure class="lh li lj lk gt jr"><div class="bz fp l di"><div class="ll lm l"/></div></figure><p id="3503" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated"><strong class="jw ir">创建API </strong></p><p id="dfc8" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">接下来让我们创建一个API，一些我们可以控制的东西(我们的控制器)。</p><figure class="lh li lj lk gt jr"><div class="bz fp l di"><div class="ll lm l"/></div></figure><p id="f26f" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">在此之前，我们只有一些样板文件和基本的或空的默认项目，如果您现在测试它，它将工作，但它不会做任何有趣的事情，但它覆盖了很多领域，我们应该感谢这样一个工具的存在。</p><p id="e346" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">将我们的代码添加到组合中</p><p id="60b2" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">首先我们将把它添加到<code class="fe ln lo lp lq b">api/v1beta1/map_types.go</code>，这将把我们的字段添加到我们的类型中。基本上我们只是编辑了<code class="fe ln lo lp lq b">MapSpec</code>和<code class="fe ln lo lp lq b">MapStatus</code>结构。</p><figure class="lh li lj lk gt jr"><div class="bz fp l di"><div class="ll lm l"/></div></figure><p id="8305" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">现在我们需要将代码添加到<code class="fe ln lo lp lq b">controllers/map_controller.go</code>中的控制器中</p><figure class="lh li lj lk gt jr"><div class="bz fp l di"><div class="ll lm l"/></div></figure><p id="06fd" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">在这个控制器中，我们添加了两个函数，一个创建了一个pod，基本上修改了整个Reconcile函数(这个负责检查状态并进行转换，换句话说，使控制器像控制器一样工作)，还要注意kubebuilder注释，它将为我们生成rbac配置，非常方便！对吗？</p><p id="8f95" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated"><strong class="jw ir">启动集群</strong></p><figure class="lh li lj lk gt jr"><div class="bz fp l di"><div class="ll lm l"/></div></figure><p id="a084" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">现在我们将使用<a class="ae ks" href="https://github.com/kubernetes-sigs/kind" rel="noopener ugc nofollow" target="_blank">种类</a>来创建一个本地集群，以测试它是否可以如此简单！？！？！是的，它是！</p><p id="68d6" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">在本地运行我们的操作员</p><p id="2a07" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">为了进行测试，您可以像这样在本地运行您的操作符:</p><figure class="lh li lj lk gt jr"><div class="bz fp l di"><div class="ll lm l"/></div></figure><p id="b0c4" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated"><strong class="jw ir">测试它</strong></p><figure class="lh li lj lk gt jr"><div class="bz fp l di"><div class="ll lm l"/></div></figure><p id="fa9e" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">首先我们旋转一个吊舱，发射<code class="fe ln lo lp lq b">nc -l -p 8000</code></p><p id="24a9" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">然后我们编辑我们的清单并应用它，检查一切是否就绪，进行端口转发并启动另一个<code class="fe ln lo lp lq b">nc localhost 8000</code>来测试一切是否顺利。首先是清单</p><figure class="lh li lj lk gt jr"><div class="bz fp l di"><div class="ll lm l"/></div></figure><p id="b0c1" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">然后是端口转发和测试</p><figure class="lh li lj lk gt jr"><div class="bz fp l di"><div class="ll lm l"/></div></figure><p id="1457" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">公开发布</p><figure class="lh li lj lk gt jr"><div class="bz fp l di"><div class="ll lm l"/></div></figure><p id="0920" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">在这里，我们只需构建docker映像并将其推送到dockerhub或我们最喜欢的公共注册表中。然后可以用<code class="fe ln lo lp lq b">make deploy IMG=kainlite/forward:0.0.1</code>安装，用<code class="fe ln lo lp lq b">make uninstall</code>卸载</p><p id="38b1" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated"><strong class="jw ir">结束注释</strong></p><p id="d7d2" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">如果你想了解更多，请务必查看<a class="ae ks" href="https://book.kubebuilder.io/" rel="noopener ugc nofollow" target="_blank"> kubebuilder的书</a>和<a class="ae ks" href="https://kind.sigs.k8s.io/docs/user/quick-start" rel="noopener ugc nofollow" target="_blank"> kind docs </a>，我希望你喜欢它，并希望在<a class="ae ks" href="https://twitter.com/kainlite" rel="noopener ugc nofollow" target="_blank"> twitter </a>或<a class="ae ks" href="https://github.com/kainlite" rel="noopener ugc nofollow" target="_blank"> github </a>上看到你！</p><h1 id="ccae" class="lr ls iq bd lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo bi translated">正误表</h1><p id="b153" class="pw-post-body-paragraph ju jv iq jw b jx mp jz ka kb mq kd ke kf mr kh ki kj ms kl km kn mt kp kq kr ij bi translated">如果您发现任何错误或有任何建议，请给我发消息，以便解决问题。</p><p id="6b0d" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">此外，您可以在<a class="ae ks" href="https://github.com/kainlite/kainlite.github.io" rel="noopener ugc nofollow" target="_blank">生成的代码</a>和<a class="ae ks" href="https://github.com/kainlite/blog" rel="noopener ugc nofollow" target="_blank">源代码</a>中查看源代码和变更</p></div><div class="ab cl mu mv hu mw" role="separator"><span class="mx bw bk my mz na"/><span class="mx bw bk my mz na"/><span class="mx bw bk my mz"/></div><div class="ij ik il im in"><p id="826b" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated"><em class="nb">原载于</em><a class="ae ks" href="https://techsquad.rocks/blog/cloud_native_applications_with_kubebuilder_and_kind_aka_kubernetes_operators/" rel="noopener ugc nofollow" target="_blank"><em class="nb">https://tech squad . rocks</em></a><em class="nb">。</em></p></div></div>    
</body>
</html>