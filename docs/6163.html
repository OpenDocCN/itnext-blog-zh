<html>
<head>
<title>How To Forward Call Information From Android Device to Web Side? Part 01: Android Application</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何将Android设备的来电信息转发到Web端？第1部分:Android应用程序</h1>
<blockquote>原文：<a href="https://itnext.io/how-to-forwarding-a-call-information-from-android-device-to-web-side-part-01-android-application-6f2ddfba0291?source=collection_archive---------5-----------------------#2021-09-05">https://itnext.io/how-to-forwarding-a-call-information-from-android-device-to-web-side-part-01-android-application-6f2ddfba0291?source=collection_archive---------5-----------------------#2021-09-05</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/552c6a079b8467d2708a249e658959f2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*H-GaA5GJ4UpmS4DSpkzNVw.png"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">振铃状态</figcaption></figure><p id="e449" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">在这个故事中，我们将学习如何通过api将android设备与我们的服务器连接起来，服务器通过web socket将数据发送到web客户端。转移呼叫状态就是一个很好的例子。当你想建立一个CRM(客户关系管理)(或类似的东西)时，这是一个核心特性。当您接到客户的电话时，所有客户信息(姓名、订单、备注……)都会出现在web应用程序上。</p><p id="eb81" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">这个故事需要一些关于Android，NodeJS开发的知识。我们不会深入探讨如何创建一个android应用程序，以及带有Mongo数据库的NodeJS服务器。这是我们将达到的目标列表:</p><ul class=""><li id="32de" class="la lb iq ke b kf kg kj kk kn lc kr ld kv le kz lf lg lh li bi translated">Android应用:开发环境有Android studio，Kotlin，BroadcastReceiver，调用http api有改造…</li><li id="6823" class="la lb iq ke b kf lj kj lk kn ll kr lm kv ln kz lf lg lh li bi translated">NodeJS服务器:Typescript，express，socket.io，mongo，mongose…</li></ul><p id="732e" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">这个故事包括两部分，你正在阅读的是第一部分——构建android应用程序。</p><h1 id="8856" class="lo lp iq bd lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml bi translated">概观</h1><figure class="mn mo mp mq gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mm"><img src="../Images/1fff930b3f210c4986244f6d73cba648.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*DW7UhhBypcYtXB9KrCjlow.png"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">系统概述。通过<a class="ae mr" href="https://excalidraw.com/" rel="noopener ugc nofollow" target="_blank">https://excalidraw.com/</a>创建</figcaption></figure><p id="3b93" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">我们的服务器是http服务器，它提供了一个api — <code class="fe ms mt mu mv b">POST /api/v1/call-states</code>。Android应用程序将通过这个api发送通话数据。</p><p id="3294" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">它也是一个套接字服务器，一个web客户端可以连接到服务器并等待关于<code class="fe ms mt mu mv b">call_state_change</code>事件的消息。</p><h1 id="43f6" class="lo lp iq bd lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml bi translated">Android应用程序</h1><p id="6126" class="pw-post-body-paragraph kc kd iq ke b kf mw kh ki kj mx kl km kn my kp kq kr mz kt ku kv na kx ky kz ij bi translated">让我们用android studio创建一个简单的Android应用程序。您可以创建一个<code class="fe ms mt mu mv b">No Activity</code>应用程序，因为在这个故事中一个活动是多余的。</p><figure class="mn mo mp mq gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nb"><img src="../Images/0aaf8fc66ead31930880464e7134b9a9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*U--IB-C_AwuSRdz_cuAQjA.png"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">新项目</figcaption></figure><p id="b030" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">我们在项目中使用Kotlin，并选择API 21作为最低SDK版本。</p></div><div class="ab cl nc nd hu ne" role="separator"><span class="nf bw bk ng nh ni"/><span class="nf bw bk ng nh ni"/><span class="nf bw bk ng nh"/></div><div class="ij ik il im in"><p id="38bf" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">接下来是一个http客户端库，这是可选部分。你可以使用你最喜欢的图书馆，这取决于你。<a class="ae mr" href="https://square.github.io/retrofit/" rel="noopener ugc nofollow" target="_blank">改造</a>是我最喜欢的库。</p><p id="dfbc" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">将此代码片段添加到app gradle文件的依赖关系块中</p><pre class="mn mo mp mq gt nj mv nk nl aw nm bi"><span id="58af" class="nn lp iq mv b gy no np l nq nr">// app/build.gradle</span><span id="3e80" class="nn lp iq mv b gy ns np l nq nr">...<br/>dependencies <strong class="mv ir">{<br/>    ...<br/>    </strong>// Network<br/>    implementation 'com.squareup.retrofit2:retrofit:2.9.0'<br/>    implementation(platform("com.squareup.okhttp3:okhttp-bom:4.9.1"))<br/>    implementation('com.squareup.okhttp3:okhttp:5.0.0-alpha.2')<strong class="mv ir">}<br/></strong>...</span></pre><p id="adf6" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">创建一个Kotlin文件来创建一个改型实例和函数来调用api。</p><pre class="mn mo mp mq gt nj mv nk nl aw nm bi"><span id="a0ec" class="nn lp iq mv b gy no np l nq nr">// ApiInterface.kt<br/>import okhttp3.OkHttpClient<br/>import okhttp3.RequestBody<br/>import retrofit2.Call<br/>import retrofit2.Retrofit<br/>import retrofit2.http.Body<br/>import retrofit2.http.POST<br/><br/>interface ApiInterface {<br/><br/>    // <em class="nt">TODO: Update api path @POST("call-states")<br/>    </em>@POST(".")<br/>    fun postPhoneState(@Body body: RequestBody): Call&lt;Any&gt;<br/><br/>    companion object {<br/>        // <em class="nt">TODO: Update base url value<br/>        </em>private const val BASE_URL = "<a class="ae mr" href="https://hookb.in/eKpVgPo0DNilwQmmwoxK/" rel="noopener ugc nofollow" target="_blank">https://hookbin.com/eKpVgPo0DNilwQmmwoxK</a>/"<br/><br/>        fun retrofit(): ApiInterface {<br/>            val okHttpClient = OkHttpClient.Builder()<br/>                .build()<br/><br/>            val retrofit = Retrofit.Builder()<br/>                .baseUrl(BASE_URL)<br/>                .client(okHttpClient)<br/>                .build()<br/><br/>            return retrofit.create(ApiInterface::class.<em class="nt">java</em>)<br/>        }<br/>    }<br/>}</span></pre><p id="56f3" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">我们有一个静态函数，它返回一个改型实例— <code class="fe ms mt mu mv b">retrofit</code>。</p><p id="3300" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated"><code class="fe ms mt mu mv b">@POST(“.”)</code>向<code class="fe ms mt mu mv b">BASE_URL</code>提出发布请求。</p><p id="4a16" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">此时，我们使用<a class="ae mr" href="https://hookbin.com/" rel="noopener ugc nofollow" target="_blank">https://hookbin.com/</a>服务来检查来自我们应用程序的http请求。</p></div><div class="ab cl nc nd hu ne" role="separator"><span class="nf bw bk ng nh ni"/><span class="nf bw bk ng nh ni"/><span class="nf bw bk ng nh"/></div><div class="ij ik il im in"><p id="aaee" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">现在我们进入这个故事的主要部分——创建一个<code class="fe ms mt mu mv b">BroadcastReceiver</code>。<code class="fe ms mt mu mv b">onReceive</code>该类的功能将在电话有呼入或呼出时执行。呼出将被忽略，我们只处理呼入。</p><figure class="mn mo mp mq gt jr"><div class="bz fp l di"><div class="nu nv l"/></div></figure><p id="71db" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated"><code class="fe ms mt mu mv b">currentState</code>是一个静态变量，它用于检测一个呼出。如果电话状态从<code class="fe ms mt mu mv b">IDLE</code>变为<code class="fe ms mt mu mv b">OFFF_HOOK</code> = &gt;呼出。</p><p id="6b0b" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated"><code class="fe ms mt mu mv b">onReceive</code>当手机状态改变时，将执行该功能。我们将电话号码和状态传递给一个私有函数— <code class="fe ms mt mu mv b">postStateToServer</code>。在这个函数中，我们将所有逻辑放在一个try/catch块中，以忽略所有意外的异常。try/catch blook确保应用程序在出错时仍能运行。</p><p id="d9a4" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated"><code class="fe ms mt mu mv b">postStateToServer</code>只需创建一个http请求。它创建一个json对象，该对象包含<code class="fe ms mt mu mv b">phone_number</code>、<code class="fe ms mt mu mv b">state</code>和<code class="fe ms mt mu mv b">timestamp</code>属性。然后将json对象传递给<code class="fe ms mt mu mv b">ApiInterface.retrofit().postPhoneState</code>。在android应用程序中，我们不关心api响应。</p></div><div class="ab cl nc nd hu ne" role="separator"><span class="nf bw bk ng nh ni"/><span class="nf bw bk ng nh ni"/><span class="nf bw bk ng nh"/></div><div class="ij ik il im in"><p id="e142" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">我们已经有一个<code class="fe ms mt mu mv b">BroadcastReceiver</code>，现在，我们必须为android系统注册它。更新<code class="fe ms mt mu mv b">AndroidManifest.xml</code>文件:</p><figure class="mn mo mp mq gt jr"><div class="bz fp l di"><div class="nu nv l"/></div></figure><p id="d745" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">第5、6、7行定义了所需的权限:</p><ul class=""><li id="2967" class="la lb iq ke b kf kg kj kk kn lc kr ld kv le kz lf lg lh li bi translated"><code class="fe ms mt mu mv b">READ_CALL_STATE</code>进入手机的通话状态。</li><li id="10c5" class="la lb iq ke b kf lj kj lk kn ll kr lm kv ln kz lf lg lh li bi translated"><code class="fe ms mt mu mv b">READ_CALL_LOG</code>获取来电号码。</li><li id="56e4" class="la lb iq ke b kf lj kj lk kn ll kr lm kv ln kz lf lg lh li bi translated"><code class="fe ms mt mu mv b">INTERNET</code>调用我们的api。</li></ul><p id="5f09" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">第28到35行将我们的类— <code class="fe ms mt mu mv b">CallReceiver</code>注册为接收者，其动作是<code class="fe ms mt mu mv b">PHONE_STATE</code>。</p></div><div class="ab cl nc nd hu ne" role="separator"><span class="nf bw bk ng nh ni"/><span class="nf bw bk ng nh ni"/><span class="nf bw bk ng nh"/></div><div class="ij ik il im in"><p id="bd41" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">现在，让我们在android手机上构建我们的应用程序。你可以使用一个虚拟设备，我们可以创建一个虚假的来电设备。</p><figure class="mn mo mp mq gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nw"><img src="../Images/9b643b4d9f6fadc30c930d401b28a4ce.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*h71uIX7dd9NoM9t9yHI9pw.png"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">打个假电话</figcaption></figure><p id="e77a" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">然后刷新hookbin.com的链接，我们可以看到一些类似这样的内容:</p><figure class="mn mo mp mq gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nx"><img src="../Images/a23b62ca75e593e5e17809b0301537eb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*M9V6auqRUhYP3UuJvaRqOw.png"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">Http请求内容</figcaption></figure><p id="63d7" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">仅此而已！</p><h1 id="c707" class="lo lp iq bd lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml bi translated">结论</h1><p id="9a03" class="pw-post-body-paragraph kc kd iq ke b kf mw kh ki kj mx kl km kn my kp kq kr mz kt ku kv na kx ky kz ij bi translated">我们已经完成了android应用程序。如果你是一个android开发者，这将是非常容易的。但我希望它足够简单，让你们都能理解。</p><p id="ade3" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">在下一个故事中，我们将创建一个http服务器来处理电话状态请求，并将电话状态转发给一个简单的web客户端。</p><p id="44eb" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">应用源代码没有完成，那么我会在下一个故事里上传到Github。</p><p id="dca1" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">感谢您的阅读！</p></div></div>    
</body>
</html>