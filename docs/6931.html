<html>
<head>
<title>GCP Cloud Functions (gen 2nd) Pub/Sub Development &amp; Testing</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">GCP云功能(第二代)发布/订阅开发和测试</h1>
<blockquote>原文：<a href="https://itnext.io/gcp-cloud-functions-gen-2nd-pub-sub-development-testing-2c498fa4464e?source=collection_archive---------1-----------------------#2022-04-16">https://itnext.io/gcp-cloud-functions-gen-2nd-pub-sub-development-testing-2c498fa4464e?source=collection_archive---------1-----------------------#2022-04-16</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><figure class="gl gn jr js jt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi jq"><img src="../Images/d4e1fdbe5178a76e9cac12ce443c9f67.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*dfsS7OnQVKWPu-1OsXkD0g.png"/></div></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated">Nx WorkSpace中的发布/订阅功能开发</figcaption></figure><blockquote class="kf kg kh"><p id="dbb8" class="ki kj kk kl b km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg im bi translated">注意:第二代包含在谷歌云服务条款的<a class="ae lh" href="https://cloud.google.com/terms/service-terms#1" rel="noopener ugc nofollow" target="_blank">预发布条款</a>中。请避免在产品中使用它，直到它完全发布。</p></blockquote><p id="71b4" class="pw-post-body-paragraph ki kj it kl b km kn ko kp kq kr ks kt li kv kw kx lj kz la lb lk ld le lf lg im bi translated"><a class="ae lh" rel="noopener ugc nofollow" target="_blank" href="/deploy-2nd-gen-gcp-cloud-functions-with-nx-workspace-5d75fcf21566">快速浏览:使用Nx Workspace </a> <strong class="kl iu"> <br/> </strong> <a class="ae lh" href="https://dalenguyen.medium.com/2nd-gen-cloud-functions-local-testing-development-7c518f7bd0b1" rel="noopener">部署第二代GCP云函数本地测试&amp;开发</a> <br/> <a class="ae lh" href="https://dalenguyen.medium.com/create-rest-apis-with-express-2nd-gen-gcp-cloud-functions-d244dd9a4717" rel="noopener">使用Express创建REST API&amp;第二代GCP云函数</a> <br/> <a class="ae lh" href="https://dalenguyen.medium.com/a-perfect-match-nestjs-cloud-functions-2nd-gen-nx-workspace-f13fb044e9a4" rel="noopener">完美匹配:NestJs &amp;云函数(第二代)&amp;Nx Workspace</a><strong class="kl iu"><br/></strong><a class="ae lh" href="https://dalenguyen.medium.com/gcp-cloud-functions-gen-2nd-pub-sub-development-testing-2c498fa4464e" rel="noopener"><strong class="kl iu">GCP云函数(第二代)发布/订阅开发</strong></a></p><h2 id="f0fb" class="ll lm it bd ln lo lp dn lq lr ls dp lt li lu lv lw lj lx ly lz lk ma mb mc md bi translated">先决条件</h2><p id="cba2" class="pw-post-body-paragraph ki kj it kl b km me ko kp kq mf ks kt li mg kw kx lj mh la lb lk mi le lf lg im bi translated">在创建发布/订阅云函数之前，必须首先启用发布/订阅以在项目中创建身份验证令牌:</p><pre class="mj mk ml mm gt mn mo mp mq aw mr bi"><span id="0071" class="ll lm it mo b gy ms mt l mu mv">PROJECT_ID=$(gcloud config get-value project)<br/>PROJECT_NUMBER=$(gcloud projects list --filter="project_id:$PROJECT_ID" --format='value(project_number)')<br/><br/># Allow service account token creation<br/>gcloud projects add-iam-policy-binding $PROJECT_ID \<br/>--member=serviceAccount:service-$PROJECT_NUMBER@gcp-sa-pubsub.iam.gserviceaccount.com \<br/>--role=roles/iam.serviceAccountTokenCreator</span></pre><h2 id="b910" class="ll lm it bd ln lo lp dn lq lr ls dp lt li lu lv lw lj lx ly lz lk ma mb mc md bi translated">创建新主题</h2><pre class="mj mk ml mm gt mn mo mp mq aw mr bi"><span id="70be" class="ll lm it mo b gy ms mt l mu mv">dalenguyen$ gcloud pubsub topics create my-topic<br/>Created topic [projects/sherpa-lab/topics/my-topic].</span></pre><p id="7e11" class="pw-post-body-paragraph ki kj it kl b km kn ko kp kq kr ks kt li kv kw kx lj kz la lb lk ld le lf lg im bi translated">您可以在GCP仪表板中看到这个新主题</p><figure class="mj mk ml mm gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi mw"><img src="../Images/188edead5e6f5d356d09bef2b71bcd12.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*tH5X9TbaghCeKBVMk2qPpw.png"/></div></div></figure><p id="7894" class="pw-post-body-paragraph ki kj it kl b km kn ko kp kq kr ks kt li kv kw kx lj kz la lb lk ld le lf lg im bi translated"><strong class="kl iu">创建样本功能</strong></p><p id="9855" class="pw-post-body-paragraph ki kj it kl b km kn ko kp kq kr ks kt li kv kw kx lj kz la lb lk ld le lf lg im bi translated">cloudEvent函数将允许回调在调用时接收cloudEvent对象</p><pre class="mj mk ml mm gt mn mo mp mq aw mr bi"><span id="f57b" class="ll lm it mo b gy ms mt l mu mv">// main.ts</span><span id="e53f" class="ll lm it mo b gy mx mt l mu mv">import { cloudEvent } from '<a class="ae lh" href="http://twitter.com/google" rel="noopener ugc nofollow" target="_blank">@google</a>-cloud/functions-framework'</span><span id="8faa" class="ll lm it mo b gy mx mt l mu mv">// Register a CloudEvent callback with the Functions Framework that will<br/>// be executed when the Pub/Sub trigger topic receives a message.</span><span id="e940" class="ll lm it mo b gy mx mt l mu mv">cloudEvent&lt;{ message: { data: string } }&gt;('helloPubSub', (event) =&gt; {<br/>  // The Pub/Sub message is passed as the CloudEvent's data payload.<br/>  const name = getName(event)<br/>  console.log(`Hello, ${name}!`)<br/>})</span><span id="f7d6" class="ll lm it mo b gy mx mt l mu mv">export const getName = (event: any) =&gt; {<br/>  const base64name = event.data.message.data<br/>  return base64name ? Buffer.from(base64name, 'base64').toString() : 'World'<br/>}</span></pre><h2 id="bddf" class="ll lm it bd ln lo lp dn lq lr ls dp lt li lu lv lw lj lx ly lz lk ma mb mc md bi translated">部署云功能</h2><p id="6cda" class="pw-post-body-paragraph ki kj it kl b km me ko kp kq mf ks kt li mg kw kx lj mh la lb lk mi le lf lg im bi translated">在部署之前，您需要更新project.json中的部署脚本</p><pre class="mj mk ml mm gt mn mo mp mq aw mr bi"><span id="467f" class="ll lm it mo b gy ms mt l mu mv">// project.json</span><span id="5710" class="ll lm it mo b gy mx mt l mu mv">"deploy": {<br/>  "executor": "<a class="ae lh" href="http://twitter.com/nrwl/workspace" rel="noopener ugc nofollow" target="_blank">@nrwl/workspace</a>:run-commands",<br/>  "options": {<br/>    "commands": [<br/><strong class="mo iu">      "gcloud beta functions deploy nx-pubsub --region us-central1 --gen2 --runtime nodejs16 --trigger-topic my-topic --entry-point helloPubSub --source ./dist/apps/api-nest --project {args.gcpProject}"</strong><br/>    ],<br/>    "color": true,<br/>    "parallel": false<br/>  }<br/>}</span></pre><p id="2294" class="pw-post-body-paragraph ki kj it kl b km kn ko kp kq kr ks kt li kv kw kx lj kz la lb lk ld le lf lg im bi translated">构建应用程序</p><pre class="mj mk ml mm gt mn mo mp mq aw mr bi"><span id="07ca" class="ll lm it mo b gy ms mt l mu mv">dalenguyen$ npx nx build api-nest</span><span id="51dc" class="ll lm it mo b gy mx mt l mu mv">&gt; nx run api-nest:build</span><span id="6353" class="ll lm it mo b gy mx mt l mu mv">chunk (runtime: main) index.js (main) 2.65 KiB [entry] [rendered]<br/>webpack compiled successfully (90f062bcb8b8b600)</span><span id="b472" class="ll lm it mo b gy mx mt l mu mv">&gt;  NX   Successfully ran target build for project api-nest (6s)<br/> </span></pre><p id="6a4f" class="pw-post-body-paragraph ki kj it kl b km kn ko kp kq kr ks kt li kv kw kx lj kz la lb lk ld le lf lg im bi translated">运行部署脚本</p><pre class="mj mk ml mm gt mn mo mp mq aw mr bi"><span id="a86c" class="ll lm it mo b gy ms mt l mu mv">dalenguyen$ npx nx deploy-pubsub api-nest --gcpProject YOUR_PROJECT</span><span id="8d7a" class="ll lm it mo b gy mx mt l mu mv">&gt; nx run api-nest:deploy-pubsub --gcpProject=YOUR_PROJECT</span><span id="5aa8" class="ll lm it mo b gy mx mt l mu mv">Preparing function...</span><span id="55cf" class="ll lm it mo b gy mx mt l mu mv">  timeoutSeconds: 60<br/>  uri: <a class="ae lh" href="https://nx-pubsub-eyoojzj54q-uc.a.run.app" rel="noopener ugc nofollow" target="_blank">https://nx-pubsub-000-uc.a.run.app</a><br/>state: ACTIVE<br/>updateTime: '2022-04-15T23:01:41.239409158Z'</span><span id="b060" class="ll lm it mo b gy mx mt l mu mv">———————————————————————————————————————————————————————————————</span><span id="dfff" class="ll lm it mo b gy mx mt l mu mv">&gt;  NX   Successfully ran target deploy for project api-nest</span></pre><p id="e978" class="pw-post-body-paragraph ki kj it kl b km kn ko kp kq kr ks kt li kv kw kx lj kz la lb lk ld le lf lg im bi translated">你可以在你的GCP &gt;云功能中找到新功能</p><figure class="mj mk ml mm gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi my"><img src="../Images/07e9fbf36c4dc93580b5ea17b4ccbb94.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*D0JQH908BwgcpE90RU5Zlw.png"/></div></div></figure><p id="36e9" class="pw-post-body-paragraph ki kj it kl b km kn ko kp kq kr ks kt li kv kw kx lj kz la lb lk ld le lf lg im bi translated"><strong class="kl iu">测试发布/订阅功能</strong></p><pre class="mj mk ml mm gt mn mo mp mq aw mr bi"><span id="6a1f" class="ll lm it mo b gy ms mt l mu mv">dalenguyen$ gcloud pubsub topics publish my-topic --message="Friend"</span><span id="8477" class="ll lm it mo b gy mx mt l mu mv">messageIds:<br/>- '4423022555302472'</span></pre><p id="0b54" class="pw-post-body-paragraph ki kj it kl b km kn ko kp kq kr ks kt li kv kw kx lj kz la lb lk ld le lf lg im bi translated">如果您查看云运行中的日志，您会在日志中看到<code class="fe mz na nb mo b">Hello Friend</code></p><figure class="mj mk ml mm gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi nc"><img src="../Images/22d63d2d0d1a838e4a9003fed8612195.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*nahz1lVpqnyagjtmgmISqA.png"/></div></div></figure><p id="c8ef" class="pw-post-body-paragraph ki kj it kl b km kn ko kp kq kr ks kt li kv kw kx lj kz la lb lk ld le lf lg im bi translated">您也可以使用命令来检查功能</p><pre class="mj mk ml mm gt mn mo mp mq aw mr bi"><span id="146b" class="ll lm it mo b gy ms mt l mu mv">dalenguyen$ gcloud beta functions logs read nx-pubsub --gen2</span><span id="bbfc" class="ll lm it mo b gy mx mt l mu mv">LEVEL  NAME       TIME_UTC                 LOG<br/>I      nx-pubsub  2022-04-15 23:07:02.011<br/>       nx-pubsub  2022-04-15 23:07:02.010  Hello, Friend!</span></pre><h2 id="b3d4" class="ll lm it bd ln lo lp dn lq lr ls dp lt li lu lv lw lj lx ly lz lk ma mb mc md bi translated">本地测试和开发</h2><p id="5fcd" class="pw-post-body-paragraph ki kj it kl b km me ko kp kq mf ks kt li mg kw kx lj mh la lb lk mi le lf lg im bi translated">您可以使用的另一种方法是利用测试驱动开发(TDD)方法。您可以编写一组单元测试，并观察开发过程中的变化。通过这样做，您可以节省大量时间，因为您可以模拟cloudEvent的行为&amp;事件中使用的函数。</p><p id="b9c0" class="pw-post-body-paragraph ki kj it kl b km kn ko kp kq kr ks kt li kv kw kx lj kz la lb lk ld le lf lg im bi translated">由于我使用的是TypeScript，所以存在类型不匹配的问题，如果你有任何建议，请告诉我。</p><pre class="mj mk ml mm gt mn mo mp mq aw mr bi"><span id="3eb9" class="ll lm it mo b gy ms mt l mu mv">// pubsub.spec.ts</span><span id="9b2f" class="ll lm it mo b gy mx mt l mu mv">import { getFunction } from '<a class="ae lh" href="http://twitter.com/google" rel="noopener ugc nofollow" target="_blank">@google</a>-cloud/functions-framework/build/src/testing'<br/>import { CloudEvent } from 'cloudevents'<br/>import * as Main from './main'</span><span id="7f04" class="ll lm it mo b gy mx mt l mu mv">describe('HelloCloudEvent', () =&gt; {<br/>  beforeAll(async () =&gt; {<br/>    // load the module that defines HelloCloudEvent<br/>    await import('./main')<br/>  })</span><span id="a630" class="ll lm it mo b gy mx mt l mu mv">it('uses getName', () =&gt; {<br/>    const getName = jest.spyOn(Main, 'getName')</span><span id="6e21" class="ll lm it mo b gy mx mt l mu mv">const helloPubSub = getFunction('helloPubSub') as any<br/>    helloPubSub(<br/>      new CloudEvent({<br/>        type: 'com.google.cloud.functions.test',<br/>        source: '<a class="ae lh" href="https://github.com/GoogleCloudPlatform/functions-framework-nodejs'" rel="noopener ugc nofollow" target="_blank">https://github.com/GoogleCloudPlatform/functions-framework-nodejs'</a>,<br/>        data: {<br/>          message: {<br/>            data: 'V29ybGQ=',<br/>          },<br/>        },<br/>      }),<br/>    )<br/>    // assert that the cloud function invoked `getName()`<br/>    expect(getName).toHaveBeenCalled()<br/>    expect(getName).toHaveReturned()<br/>    expect(getName).toHaveNthReturnedWith(1, 'World')<br/>  })<br/>})</span></pre><p id="5f87" class="pw-post-body-paragraph ki kj it kl b km kn ko kp kq kr ks kt li kv kw kx lj kz la lb lk ld le lf lg im bi translated">然后可以边看测试边开发逻辑。</p><figure class="mj mk ml mm gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi nd"><img src="../Images/caeb6f36b53e9a79eca44b78ad5d392f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*UYuY_2d8YS4x4QWRXpYopg.png"/></div></div></figure><h2 id="9d61" class="ll lm it bd ln lo lp dn lq lr ls dp lt li lu lv lw lj lx ly lz lk ma mb mc md bi translated">参考</h2><p id="c43b" class="pw-post-body-paragraph ki kj it kl b km me ko kp kq mf ks kt li mg kw kx lj mh la lb lk mi le lf lg im bi translated"><a class="ae lh" href="https://cloud.google.com/functions/docs/2nd-gen/getting-started" rel="noopener ugc nofollow" target="_blank">https://cloud . Google . com/functions/docs/2nd-gen/getting-started</a></p></div></div>    
</body>
</html>