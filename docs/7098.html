<html>
<head>
<title>Building Real-time communication with Apache Spark through Apache Livy</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">通过Apache Livy与Apache Spark建立实时通信</h1>
<blockquote>原文：<a href="https://itnext.io/building-real-time-interactions-with-apache-spark-through-apache-livy-53169d87d012?source=collection_archive---------3-----------------------#2022-06-12">https://itnext.io/building-real-time-interactions-with-apache-spark-through-apache-livy-53169d87d012?source=collection_archive---------3-----------------------#2022-06-12</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="4ac1" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">编写和使用Apache Livy环境</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi ki"><img src="../Images/47297b9ed7987683faf45083a59d4371.png" data-original-src="https://miro.medium.com/v2/resize:fit:1232/format:webp/1*HbAb-TZbRbhwf4QGUlB3_w.png"/></div><figcaption class="kq kr gj gh gi ks kt bd b be z dk translated">编写和使用Apache Livy环境</figcaption></figure><p id="48e9" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">我们都知道Apache Spark是什么，有两种通过编程向Apache Spark集群提交作业的方法，每种方法都有一些限制，以便实现实时交互，<strong class="kw iu"> spark-submit </strong>和<strong class="kw iu"> spark-shell </strong>是向Apache Spark集群提交Spark应用程序的唯一选项，但是，<strong class="kw iu"> <em class="lq">如果您想从web或移动应用程序</em> </strong>交互提交spark-jobs，会发生什么情况呢？</p><p id="bc86" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">有些情况下，您的Apache <strong class="kw iu"> <em class="lq"> Spark集群可以托管在本地基础架构</em> </strong>中，您可能需要许多用户从他们的手机、web或桌面应用程序中同时消费和运行针对您组织的数据源的大量聚合，创建一个“<strong class="kw iu"> Spark即服务</strong>”环境来解决我上面提到的问题<strong class="kw iu"> <em class="lq">并不像听起来那么困难</em> </strong>，一个解决方案可以是通过公开您的JDBC/ODBC数据源</p><p id="805f" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">我不知道Apache Livy现在是否应该被视为一种变通方法，因为Apache Spark通过像<a class="ae lr" href="https://cloud.google.com/dataproc" rel="noopener ugc nofollow" target="_blank"><strong class="kw iu">Google Cloud data proc</strong></a>或<a class="ae lr" href="https://aws.amazon.com/es/emr/" rel="noopener ugc nofollow" target="_blank"> <strong class="kw iu"> AWS EMR </strong> </a>这样的技术积极地进军云领域，但是，本文展示并解释了一个文档化的环境<em class="lq">，您可以使用它作为模板来快速部署一个可使用的Apache Livy环境</em>。</p><p id="56cb" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">我会尽量简短地解释什么是Apache Livy:<em class="lq">是一个服务，它可以通过REST接口与Apache Spark集群轻松交互</em>，请看下图:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="lt lu di lv bf lw"><div class="gh gi ls"><img src="../Images/017b01f1a5d0010c42877d82aa1e9839.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Wcq3vZnhKjJtkFHxMsa26A.png"/></div></div><figcaption class="kq kr gj gh gi ks kt bd b be z dk translated">一个<strong class="bd lx"> Apache Livy接口的基本例子</strong></figcaption></figure><p id="7e51" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">如您所见，为了重现一个真实的例子，我们需要三个组件:</p><ol class=""><li id="9b52" class="ly lz it kw b kx ky la lb ld ma lh mb ll mc lp md me mf mg bi translated">阿帕奇火花集群</li><li id="6ebd" class="ly lz it kw b kx mh la mi ld mj lh mk ll ml lp md me mf mg bi translated">Apache Livy服务器</li><li id="b7fd" class="ly lz it kw b kx mh la mi ld mj lh mk ll ml lp md me mf mg bi translated">Apache Livy客户端</li></ol><p id="df74" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">作为一个额外的组件，我将添加<strong class="kw iu"> docker </strong>来实现更快的实现，并添加<strong class="kw iu"> PostgreSQL </strong>数据库服务器来模拟Apache Spark可用的外部数据源。</p><h1 id="32ee" class="mm mn it bd lx mo mp mq mr ms mt mu mv jz mw ka mx kc my kd mz kf na kg nb nc bi translated">我们开始吧</h1><h2 id="1b3a" class="nd mn it bd lx ne nf dn mr ng nh dp mv ld ni nj mx lh nk nl mz ll nm nn nb no bi translated"><strong class="ak">阿帕奇星火集群</strong></h2><p id="ce51" class="pw-post-body-paragraph ku kv it kw b kx np ju kz la nq jx lc ld nr lf lg lh ns lj lk ll nt ln lo lp im bi translated">我将创建一个<strong class="kw iu"> docker-compose.yaml </strong>文件，并且我将添加三个容器<strong class="kw iu"> spark-master </strong>、<strong class="kw iu"> spark-worker1 </strong>和<strong class="kw iu"> spark-worker2 </strong>使用图像:<strong class="kw iu">docker.io/bitnami/spark:2</strong></p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="lt lu di lv bf lw"><div class="gh gi nu"><img src="../Images/a8aec890c9d0fc7fca007c9f41439254.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*YNbkTpMOIFGnMvq2dkv9zw.png"/></div></div><figcaption class="kq kr gj gh gi ks kt bd b be z dk translated">Docker上的Apache Spark集群</figcaption></figure><h2 id="c12f" class="nd mn it bd lx ne nf dn mr ng nh dp mv ld ni nj mx lh nk nl mz ll nm nn nb no bi translated">Apache Livy服务器</h2><p id="eefd" class="pw-post-body-paragraph ku kv it kw b kx np ju kz la nq jx lc ld nr lf lg lh ns lj lk ll nt ln lo lp im bi translated">在同一个<strong class="kw iu"> docker-compose.yaml </strong>文件中，我将使用后面显示的docker文件添加一个Apache Livy服务器作为新容器:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="lt lu di lv bf lw"><div class="gh gi ls"><img src="../Images/19c5f992b4090f0de69102094409866e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*kVsYFgP4Ng1lxa6Xi4Y5XQ.png"/></div></div><figcaption class="kq kr gj gh gi ks kt bd b be z dk translated">Docker上的Apache Livy服务器</figcaption></figure><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nv nw l"/></div><figcaption class="kq kr gj gh gi ks kt bd b be z dk translated">Apache Livy服务器文档</figcaption></figure><h2 id="10ea" class="nd mn it bd lx ne nf dn mr ng nh dp mv ld ni nj mx lh nk nl mz ll nm nn nb no bi translated"><strong class="ak"> PostgreSQL </strong>数据库服务器</h2><p id="2a84" class="pw-post-body-paragraph ku kv it kw b kx np ju kz la nq jx lc ld nr lf lg lh ns lj lk ll nt ln lo lp im bi translated">我使用图像将名为<strong class="kw iu"> pg_container </strong>的容器添加到<strong class="kw iu"> docker-compose.yaml </strong>中:<strong class="kw iu"> postgres，</strong>我们的示例执行一个pyspark脚本，该脚本使用apache spark与外部数据源交互，这将是我们的外部数据源。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="lt lu di lv bf lw"><div class="gh gi nx"><img src="../Images/c459ed10bb5647d4c6fdc81802618144.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*H7mYM-HdMJAaYZZY_mpcbA.png"/></div></div><figcaption class="kq kr gj gh gi ks kt bd b be z dk translated">docker上的PostgreSQL</figcaption></figure><p id="1eb6" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated"><strong class="kw iu"> <em class="lq">我们的docker-compose.yaml文件准备好了，下面查看:</em> </strong></p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nv nw l"/></div></figure><h2 id="9fce" class="nd mn it bd lx ne nf dn mr ng nh dp mv ld ni nj mx lh nk nl mz ll nm nn nb no bi translated">Apache Livy客户端</h2><p id="c4b5" class="pw-post-body-paragraph ku kv it kw b kx np ju kz la nq jx lc ld nr lf lg lh ns lj lk ll nt ln lo lp im bi translated">我找了一些类来消费一个Apache Livy REST接口，我对它做了一些细微的改编，在<a class="ae lr" href="https://pypi.org/" rel="noopener ugc nofollow" target="_blank"><strong class="kw iu">PyPi</strong></a><strong class="kw iu"/>上发布成Python包，名字叫<a class="ae lr" href="https://pypi.org/project/livyc/" rel="noopener ugc nofollow" target="_blank"> <em class="lq"> livyc </em> </a> <strong class="kw iu">。</strong>你可以在这里查看github库:<a class="ae lr" href="https://github.com/Wittline/livyc" rel="noopener ugc nofollow" target="_blank"> <strong class="kw iu"> livyc </strong> </a></p><p id="251e" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">为了重现实验，我们需要遵循以下步骤:</p><ul class=""><li id="3a13" class="ly lz it kw b kx ky la lb ld ma lh mb ll mc lp ny me mf mg bi translated">在Windows   上安装<a class="ae lr" href="https://docs.docker.com/docker-for-windows/install/" rel="noopener ugc nofollow" target="_blank"> <strong class="kw iu"> <em class="lq"> Docker桌面，它也会安装Docker Compose，Docker Compose将允许你运行多个容器应用程序。</em></strong></a></li><li id="0eb5" class="ly lz it kw b kx mh la mi ld mj lh mk ll ml lp ny me mf mg bi translated">安装<a class="ae lr" href="https://www.stanleyulili.com/git/how-to-install-git-bash-on-windows/" rel="noopener ugc nofollow" target="_blank"><strong class="kw iu"><em class="lq">git-bash for windows</em></strong></a>，安装完成后，打开git bash并下载这个库，这样就会下载<strong class="kw iu"><em class="lq">docker-compose . YAML</em></strong>文件，以及其他需要的文件。</li></ul><pre class="kj kk kl km gt nz oa ob oc aw od bi"><span id="4f13" class="nd mn it oa b gy oe of l og oh">ramse@DESKTOP-K6K6E5A MINGW64 /c<br/>$ git clone <a class="ae lr" href="https://github.com/Wittline/docker-livy.git" rel="noopener ugc nofollow" target="_blank">https://github.com/Wittline/docker-livy.git</a></span></pre><ul class=""><li id="e9c5" class="ly lz it kw b kx ky la lb ld ma lh mb ll mc lp ny me mf mg bi translated">一旦从存储库中下载了所有需要的文件，让我们运行所有的程序。我们将再次使用git bash工具，转到文件夹<strong class="kw iu"> <em class="lq"> docker-livy </em> </strong>并运行Docker Compose命令:</li></ul></div><div class="ab cl oi oj hx ok" role="separator"><span class="ol bw bk om on oo"/><span class="ol bw bk om on oo"/><span class="ol bw bk om on"/></div><div class="im in io ip iq"><blockquote class="op oq or"><p id="4451" class="ku kv lq kw b kx ky ju kz la lb jx lc os le lf lg ot li lj lk ou lm ln lo lp im bi translated">查看我的GitHub库<a class="ae lr" href="https://github.com/Wittline/docker-livy" rel="noopener ugc nofollow" target="_blank"> docker-livy </a>以获得关于该项目的更多信息。</p></blockquote></div><div class="ab cl oi oj hx ok" role="separator"><span class="ol bw bk om on oo"/><span class="ol bw bk om on oo"/><span class="ol bw bk om on"/></div><div class="im in io ip iq"><pre class="kj kk kl km gt nz oa ob oc aw od bi"><span id="6028" class="nd mn it oa b gy oe of l og oh">ramse@DESKTOP-K6K6E5A MINGW64 /c<br/>$ cd docker-livy</span><span id="69cf" class="nd mn it oa b gy ov of l og oh">ramse@DESKTOP-K6K6E5A MINGW64 /c/docker-livy<br/>$ cd code</span><span id="e666" class="nd mn it oa b gy ov of l og oh">ramse@DESKTOP-K6K6E5A MINGW64 /c/docker-livy/code<br/>$ cd apps</span><span id="bc4e" class="nd mn it oa b gy ov of l og oh">@DESKTOP-K6K6E5A MINGW64 /c/docker-livy/code/apps<br/>$ docker-compose up -d --build</span></pre><ul class=""><li id="68d1" class="ly lz it kw b kx ky la lb ld ma lh mb ll mc lp ny me mf mg bi translated">等待一分钟，当最后一个命令执行完毕时，使用下面的命令检查所有容器的状态。</li></ul><pre class="kj kk kl km gt nz oa ob oc aw od bi"><span id="9e8f" class="nd mn it oa b gy oe of l og oh">docker ps</span></pre><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="lt lu di lv bf lw"><div class="gh gi ow"><img src="../Images/0b3f7acd9143f4b02b9914335064d40d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Tc3PtOvny1YDlOzTX54GIQ.png"/></div></div><figcaption class="kq kr gj gh gi ks kt bd b be z dk translated">docker ps</figcaption></figure><ul class=""><li id="0330" class="ly lz it kw b kx ky la lb ld ma lh mb ll mc lp ny me mf mg bi translated">如果一切正常，那么我们将继续前进，使用<a class="ae lr" href="https://github.com/Wittline/livyc" rel="noopener ugc nofollow" target="_blank"><strong class="kw iu"/></a>与Apache Livy接口进行交互</li><li id="7e35" class="ly lz it kw b kx mh la mi ld mj lh mk ll ml lp ny me mf mg bi translated"><strong class="kw iu">使用Google Colab设置本地环境</strong></li><li id="9e53" class="ly lz it kw b kx mh la mi ld mj lh mk ll ml lp ny me mf mg bi translated">转到<strong class="kw iu"> <em class="lq"> git-bash </em> </strong>并输入下一条命令:</li></ul><pre class="kj kk kl km gt nz oa ob oc aw od bi"><span id="4c76" class="nd mn it oa b gy oe of l og oh">ramse@DESKTOP-K6K6E5A MINGW64 ~<br/><strong class="oa iu">jupyter notebook --NotebookApp.allow_origin='https://colab.research.google.com' --port=8888 --NotebookApp.port_retries=0</strong></span></pre><ul class=""><li id="a269" class="ly lz it kw b kx ky la lb ld ma lh mb ll mc lp ny me mf mg bi translated">执行最后一个命令后，复制本地主机URL，您将需要它用于colab</li><li id="1d15" class="ly lz it kw b kx mh la mi ld mj lh mk ll ml lp ny me mf mg bi translated">前往<a class="ae lr" href="https://colab.research.google.com/" rel="noopener ugc nofollow" target="_blank"><strong class="kw iu"><em class="lq">Google Colab</em></strong></a></li><li id="d662" class="ly lz it kw b kx mh la mi ld mj lh mk ll ml lp ny me mf mg bi translated">创建新笔记本</li><li id="f45c" class="ly lz it kw b kx mh la mi ld mj lh mk ll ml lp ny me mf mg bi translated">转到-&gt;连接-&gt;连接到本地运行时-&gt;粘贴从上一步复制的网址，并把它放在后端网址-&gt;连接</li><li id="be1d" class="ly lz it kw b kx mh la mi ld mj lh mk ll ml lp ny me mf mg bi translated">上传文件<strong class="kw iu"><em class="lq">test-livy . ipynb</em></strong>，并将其使用到您的colab本地env:</li><li id="7c2f" class="ly lz it kw b kx mh la mi ld mj lh mk ll ml lp ny me mf mg bi translated">运行每个单元格并查看每个步骤的结果。</li></ul><p id="a180" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">请注意，在<strong class="kw iu"><em class="lq">test-livy . ipynb</em></strong>文件中采取的操作中，postgres数据库正在使用外部。csv文件，这是为了让apache spark拥有与之交互的数据。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nv nw l"/></div><figcaption class="kq kr gj gh gi ks kt bd b be z dk translated"><a class="ae lr" href="https://gist.github.com/Wittline/9308a337ec28503b49760faa6bd5bb1e#file-test_livy-ipynb" rel="noopener ugc nofollow" target="_blank"> test_livy.ipynb </a></figcaption></figure><ul class=""><li id="b455" class="ly lz it kw b kx ky la lb ld ma lh mb ll mc lp ny me mf mg bi translated">如果您想监控Apache Livy服务器中创建的所有会话，请访问地址:<a class="ae lr" href="http://localhost:8998/ui" rel="noopener ugc nofollow" target="_blank">http://localhost:8998/ui</a></li></ul><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="lt lu di lv bf lw"><div class="gh gi ox"><img src="../Images/bde156cb01411f77c89abbdf9351c44e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*q946XNw3Zx6C33s6TWGYXQ.png"/></div></div><figcaption class="kq kr gj gh gi ks kt bd b be z dk translated">李维·塞申斯</figcaption></figure><blockquote class="oy"><p id="2a6c" class="oz pa it bd pb pc pd pe pf pg ph lp dk translated">查看我的GitHub库<a class="ae lr" href="https://github.com/Wittline/docker-livy" rel="noopener ugc nofollow" target="_blank"> docker-livy </a>以获得关于该项目的更多信息。</p></blockquote><h2 id="6a97" class="nd mn it bd lx ne pi dn mr ng pj dp mv ld pk nj mx lh pl nl mz ll pm nn nb no bi translated">结论</h2><p id="b859" class="pw-post-body-paragraph ku kv it kw b kx np ju kz la nq jx lc ld nr lf lg lh ns lj lk ll nt ln lo lp im bi translated">Python包<a class="ae lr" href="https://github.com/Wittline/livyc" rel="noopener ugc nofollow" target="_blank"><strong class="kw iu">livyc</strong></a><strong class="kw iu"/>可以很好地动态和异步地向Apache Livy服务器提交pyspark脚本，这反过来以透明的方式与Apache Spark集群交互，检查这个项目并记住在与jupyter笔记本文件交互之前检查所有文件。</p><blockquote class="oy"><p id="e373" class="oz pa it bd pb pc pn po pp pq pr lp dk translated">查看我的GitHub库<a class="ae lr" href="https://github.com/Wittline/docker-livy" rel="noopener ugc nofollow" target="_blank"> docker-livy </a>以获得关于该项目的更多信息。</p></blockquote></div></div>    
</body>
</html>