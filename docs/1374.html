<html>
<head>
<title>Setup a basic Kubernetes cluster with ease using RKE</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用RKE轻松设置基本的Kubernetes集群</h1>
<blockquote>原文：<a href="https://itnext.io/setup-a-basic-kubernetes-cluster-with-ease-using-rke-a5f3cc44f26f?source=collection_archive---------0-----------------------#2018-09-28">https://itnext.io/setup-a-basic-kubernetes-cluster-with-ease-using-rke-a5f3cc44f26f?source=collection_archive---------0-----------------------#2018-09-28</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="24d2" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在本文中，您将通过几个简单的步骤从3个Ubuntu 16.04节点升级到一个基本的Kubernetes集群。为此，您将使用牧场主Kubernetes发动机(RKE)。为了能够使用RKE，你需要3个安装了Docker的Linux节点(见下面的<strong class="jp ir">需求</strong>)。</p><p id="5a64" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这不会是一个生产就绪的集群，但足以让您熟悉RKE和一些Kubernetes，并能够使用该集群。关注构建生产就绪集群的帖子。</p><p id="3750" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这个帖子也发表在Rancher博客上:<a class="ae kl" href="https://rancher.com/blog/2018/2018-09-26-setup-basic-kubernetes-cluster-with-ease-using-rke/" rel="noopener ugc nofollow" target="_blank">https://Rancher . com/Blog/2018/2018-09-26-setup-basic-kubernetes-cluster-with-easy-using-rke/</a></p><h2 id="b8af" class="km kn iq bd ko kp kq dn kr ks kt dp ku jy kv kw kx kc ky kz la kg lb lc ld le bi translated">要求</h2><ul class=""><li id="2096" class="lf lg iq jp b jq lh ju li jy lj kc lk kg ll kk lm ln lo lp bi translated">RKE你将在你的工作站上使用RKE。从<br/><a class="ae kl" href="https://github.com/rancher/rke/releases/latest" rel="noopener ugc nofollow" target="_blank">https://github.com/rancher/rke/releases/latest</a>下载您平台的最新版本</li><li id="7a4c" class="lf lg iq jp b jq lq ju lr jy ls kc lt kg lu kk lm ln lo lp bi translated"><strong class="jp ir"> kubectl <br/> </strong>创建集群后，我们将使用默认的名为<code class="fe lv lw lx ly b">kubectl</code>的Kubernetes命令行工具与集群进行交互。<br/>从<br/><a class="ae kl" href="https://kubernetes.io/docs/tasks/tools/install-kubectl/" rel="noopener ugc nofollow" target="_blank">https://kubernetes.io/docs/tasks/tools/install-kubectl/</a>获取您平台的最新版本</li><li id="459b" class="lf lg iq jp b jq lq ju lr jy ls kc lt kg lu kk lm ln lo lp bi translated"><strong class="jp ir"> 3个Ubuntu 16.04节点，2个(v)CPU，4GB内存，禁用交换<br/> </strong>最常用的Linux发行版是Ubuntu 16.04，这是本文将使用的。通过运行<code class="fe lv lw lx ly b">swapoff -a</code>并删除<code class="fe lv lw lx ly b">/etc/fstab</code>中的任何<code class="fe lv lw lx ly b">swap</code>条目，确保swap被禁用。您必须能够使用SSH访问节点。由于这是一个多节点集群，<a class="ae kl" href="https://rancher.com/docs/rke/v0.1.x/en/os/#ports" rel="noopener ugc nofollow" target="_blank">在继续之前，需要打开所需的端口</a>。</li><li id="8188" class="lf lg iq jp b jq lq ju lr jy ls kc lt kg lu kk lm ln lo lp bi translated"><strong class="jp ir">安装在每个Linux节点上的Docker<br/></strong>Kubernetes只验证Docker到<strong class="jp ir"> 17.03.2 </strong>(参见<a class="ae kl" href="https://github.com/kubernetes/kubernetes/blob/master/CHANGELOG-1.11.md#external-dependencies" rel="noopener ugc nofollow" target="_blank">https://github . com/Kubernetes/Kubernetes/blob/master/CHANGELOG-1.11 . MD # external-dependencies</a>)。<br/>你可以使用<a class="ae kl" href="https://docs.docker.com/install/linux/docker-ce/ubuntu/" rel="noopener ugc nofollow" target="_blank">https://docs.docker.com/install/linux/docker-ce/ubuntu/</a>来安装Docker(确保你安装了<strong class="jp ir"> 17.03.2 </strong>)或者使用这个一行程序来安装正确的版本:<br/> <code class="fe lv lw lx ly b">curl <a class="ae kl" href="https://releases.rancher.com/install-docker/17.03.sh" rel="noopener ugc nofollow" target="_blank">https://releases.rancher.com/install-docker/17.03.sh</a> | sh</code></li></ul><p id="e4ba" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在继续之前，请确保满足上面列出的要求。</p><h2 id="53b9" class="km kn iq bd ko kp kq dn kr ks kt dp ku jy kv kw kx kc ky kz la kg lb lc ld le bi translated">RKE是如何运作的</h2><p id="27fa" class="pw-post-body-paragraph jn jo iq jp b jq lh js jt ju li jw jx jy lz ka kb kc ma ke kf kg mb ki kj kk ij bi translated">RKE可以在任何平台上运行(二进制文件可用于MacOS/Linux/Windows)，在这个例子中，它将在您的工作站/笔记本电脑/计算机上运行。本文中的例子是基于MacOS/Linux的。</p><p id="dd84" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">RKE将使用配置的SSH私钥连接到节点(节点应该为SSH用户安装匹配的SSH公钥)，并设置一个隧道来访问Docker套接字(默认为<code class="fe lv lw lx ly b">/var/run/docker.sock</code>，但可配置)。这意味着已配置的SSH用户必须能够访问机器上的Docker套接字，我们将在<strong class="jp ir">创建Linux用户帐户</strong>中讨论这一点。</p><figure class="md me mf mg gt mh gh gi paragraph-image"><div class="gh gi mc"><img src="../Images/b437c3da6bd3ca57f706704549a7e504.png" data-original-src="https://miro.medium.com/v2/resize:fit:1010/format:webp/1*Fk-h09tAgw-LRATG59J1tQ.png"/></div></figure><h2 id="f42e" class="km kn iq bd ko kp kq dn kr ks kt dp ku jy kv kw kx kc ky kz la kg lb lc ld le bi translated">创建Linux用户帐户</h2><p id="8063" class="pw-post-body-paragraph jn jo iq jp b jq lh js jt ju li jw jx jy lz ka kb kc ma ke kf kg mb ki kj kk ij bi translated"><em class="mk">注意:确保Docker按照上面</em> <strong class="jp ir"> <em class="mk">要求</em> </strong> <em class="mk">部分的说明进行安装。</em></p><p id="33ac" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">需要在每个节点上执行以下步骤。如果你需要使用sudo，在每个命令前面加上<code class="fe lv lw lx ly b">sudo</code>。如果已经有用户可以使用SSH密钥访问机器，并且可以访问Docker套接字，那么可以跳过这一步。</p><pre class="md me mf mg gt ml ly mm mn aw mo bi"><span id="6d3c" class="km kn iq ly b gy mp mq l mr ms"># Login to the node<br/>$ ssh your_user@hostname<br/># Create a Linux user called rke, create home directory, and add to docker group<br/>$ useradd -m -G docker rke<br/># Switch user to rke and create SSH directories<br/>$ su - rke<br/>$ mkdir $HOME/.ssh<br/>$ chmod 700 $HOME/.ssh<br/>$ touch $HOME/.ssh/authorized_keys<br/># Test Docker socket access<br/>$ docker version<br/>Client:<br/> Version:      17.03.2-ce<br/> API version:  1.27<br/> Go version:   go1.7.5<br/> Git commit:   f5ec1e2<br/> Built:        Tue Jun 27 03:35:14 2017<br/> OS/Arch:      linux/amd64</span><span id="59cd" class="km kn iq ly b gy mt mq l mr ms">Server:<br/> Version:      17.03.2-ce<br/> API version:  1.27 (minimum version 1.12)<br/> Go version:   go1.7.5<br/> Git commit:   f5ec1e2<br/> Built:        Tue Jun 27 03:35:14 2017<br/> OS/Arch:      linux/amd64<br/> Experimental: false</span></pre><h2 id="de88" class="km kn iq bd ko kp kq dn kr ks kt dp ku jy kv kw kx kc ky kz la kg lb lc ld le bi translated">配置SSH密钥</h2><p id="c1cd" class="pw-post-body-paragraph jn jo iq jp b jq lh js jt ju li jw jx jy lz ka kb kc ma ke kf kg mb ki kj kk ij bi translated">在本帖中，我们将创建新的密钥，但请随意使用您现有的密钥。当我们在RKE配置密钥时，请确保正确指定它们。</p><p id="2467" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><em class="mk">注意:如果您想将SSH密钥与密码一起使用，您需要添加密钥运行</em> <code class="fe lv lw lx ly b"><em class="mk">ssh-agent</em></code> <em class="mk">，并在运行RKE时指定</em> <code class="fe lv lw lx ly b"><em class="mk">--ssh-agent-auth</em></code> <em class="mk">。</em></p><p id="2199" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">创建SSH密钥对<br/>强烈建议在您的SSH私有密钥上放置一个密码短语。如果您丢失了SSH私有密钥(并且上面没有密码)，任何人都可以使用它来访问您的节点。</strong></p><pre class="md me mf mg gt ml ly mm mn aw mo bi"><span id="22f7" class="km kn iq ly b gy mp mq l mr ms">ssh-keygen<br/>Generating public/private rsa key pair.<br/>Enter file in which to save the key ($HOME/.ssh/id_rsa):<br/>Enter passphrase (empty for no passphrase):<br/>Enter same passphrase again:<br/>Your identification has been saved in $HOME/.ssh/id_rsa.<br/>Your public key has been saved in $HOME/.ssh/id_rsa.pub.<br/>The key fingerprint is:<br/>xxx</span></pre><p id="753e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">创建SSH密钥对后，您应该拥有以下文件:</p><ul class=""><li id="80a5" class="lf lg iq jp b jq jr ju jv jy mu kc mv kg mw kk lm ln lo lp bi translated"><code class="fe lv lw lx ly b">$HOME/.ssh/id_rsa</code> (SSH私钥，保持安全)</li><li id="7cf6" class="lf lg iq jp b jq lq ju lr jy ls kc lt kg lu kk lm ln lo lp bi translated"><code class="fe lv lw lx ly b">$HOME/.ssh/id_rsa.pub</code> (SSH公钥)</li></ul><p id="3754" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">将SSH公钥复制到节点:<br/> </strong>为了能够使用创建的SSH密钥对访问节点，您需要将SSH公钥安装到节点上。</p><p id="51ca" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">对每个节点执行此操作(其中<code class="fe lv lw lx ly b">hostname</code>是节点的IP/主机名):</p><pre class="md me mf mg gt ml ly mm mn aw mo bi"><span id="3d6b" class="km kn iq ly b gy mp mq l mr ms"># Install the SSH public key on the node<br/>$ cat $HOME/.ssh/id_rsa.pub | ssh hostname "sudo tee -a /home/rke/.ssh/authorized_keys"</span></pre><p id="820f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><em class="mk">注意:这篇文章演示了如何为RKE创建一个单独的用户。正因为如此，我们不能使用</em> <code class="fe lv lw lx ly b"><em class="mk">ssh-copy-id</em></code> <em class="mk">，因为它只能为SSH连接使用的同一个用户安装密钥。</em></p><p id="a8fb" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">设置ssh-agent <br/> </strong> <em class="mk">注意:如果您选择不在您的ssh私有密钥上设置密码，您可以跳过这一步。</em></p><p id="fbd1" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这需要在您的工作站/笔记本电脑/计算机上执行:</p><pre class="md me mf mg gt ml ly mm mn aw mo bi"><span id="3dd4" class="km kn iq ly b gy mp mq l mr ms"># Run ssh-agent and configure the correct environment variables<br/>$ eval $(ssh-agent)<br/>Agent pid 5151<br/># Add the private key to the ssh-agent<br/>$ ssh-add $HOME/.ssh/id_rsa<br/>Identity added: $HOME/.ssh/id_rsa ($HOME/.ssh/id_rsa)</span></pre><p id="72c7" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">测试SSH连接<br/> </strong>最后一步是测试我们是否可以使用SSH私钥访问节点。这需要在您的工作站/笔记本电脑/计算机上执行，将<code class="fe lv lw lx ly b">hostname</code>替换为每个节点的IP/主机名):</p><pre class="md me mf mg gt ml ly mm mn aw mo bi"><span id="ace3" class="km kn iq ly b gy mp mq l mr ms">$ ssh -i $HOME/.ssh/id_rsa rke@hostname docker version<br/>Client:<br/> Version:      17.03.2-ce<br/> API version:  1.27<br/> Go version:   go1.7.5<br/> Git commit:   f5ec1e2<br/> Built:        Tue Jun 27 03:35:14 2017<br/> OS/Arch:      linux/amd64</span><span id="bb23" class="km kn iq ly b gy mt mq l mr ms">Server:<br/> Version:      17.03.2-ce<br/> API version:  1.27 (minimum version 1.12)<br/> Go version:   go1.7.5<br/> Git commit:   f5ec1e2<br/> Built:        Tue Jun 27 03:35:14 2017<br/> OS/Arch:      linux/amd64<br/> Experimental: false</span></pre><h2 id="949e" class="km kn iq bd ko kp kq dn kr ks kt dp ku jy kv kw kx kc ky kz la kg lb lc ld le bi translated">配置和运行RKE</h2><p id="bb16" class="pw-post-body-paragraph jn jo iq jp b jq lh js jt ju li jw jx jy lz ka kb kc ma ke kf kg mb ki kj kk ij bi translated">通过<br/><a class="ae kl" href="https://github.com/rancher/rke/releases/latest" rel="noopener ugc nofollow" target="_blank">https://github.com/rancher/rke/releases/latest</a>获取RKE平台。</p><p id="cd37" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">RKE将在你的工作站/笔记本电脑/计算机上运行。</p><p id="4960" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在这篇文章中，我将RKE二进制文件重命名为<code class="fe lv lw lx ly b">rke</code>，以使命令对每个平台通用。您可以通过运行以下命令来完成同样的操作:</p><pre class="md me mf mg gt ml ly mm mn aw mo bi"><span id="87e3" class="km kn iq ly b gy mp mq l mr ms">mv rke_darwin-amd64 rke</span></pre><p id="dc9a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">使用以下命令测试RKE是否可以成功执行:</p><pre class="md me mf mg gt ml ly mm mn aw mo bi"><span id="eaf0" class="km kn iq ly b gy mp mq l mr ms"># Download RKE for MacOS (Darwin)<br/>$ wget <a class="ae kl" href="https://github.com/rancher/rke/releases/download/v0.1.9/rke_darwin-amd64" rel="noopener ugc nofollow" target="_blank">https://github.com/rancher/rke/releases/download/v0.1.9/rke_darwin-amd64</a><br/># Rename binary to rke<br/>mv rke_darwin-amd64 rke<br/># Make RKE binary executable<br/>$ chmod +x rke<br/># Show RKE version<br/>$ ./rke --version<br/>rke version v0.1.9</span></pre><p id="b610" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">下一步是创建一个集群配置文件(默认为<code class="fe lv lw lx ly b">cluster.yml</code>)。这包含了构建Kubernetes集群的所有信息，比如节点连接信息、什么角色应用于什么节点等等。所有<a class="ae kl" href="https://rancher.com/docs/rke/v0.1.x/en/config-options/" rel="noopener ugc nofollow" target="_blank">配置选项</a>都可以在文档中找到。您可以通过运行<code class="fe lv lw lx ly b">./rke config</code>并回答问题来创建集群配置文件。在这篇文章中，您将创建一个3节点集群，每个节点上有每个角色(每个角色回答<code class="fe lv lw lx ly b">y</code>)，我们将添加Kubernetes仪表板作为插件(使用<a class="ae kl" href="https://raw.githubusercontent.com/kubernetes/dashboard/master/src/deploy/recommended/kubernetes-dashboard.yaml" rel="noopener ugc nofollow" target="_blank">https://raw . githubusercontent . com/Kubernetes/Dashboard/master/src/deploy/recommended/Kubernetes-Dashboard . YAML</a>)。要访问Kubernetes仪表板，您需要一个服务帐户令牌，该令牌将通过向附加组件添加<a class="ae kl" href="https://gist.githubusercontent.com/superseb/499f2caa2637c404af41cfb7e5f4a938/raw/930841ac00653fdff8beca61dab9a20bb8983782/k8s-dashboard-user.yml" rel="noopener ugc nofollow" target="_blank">https://gist . githubusercontent . com/superseb/499 F2 CAA 2637 c 404 af 41 CFB 7 e 5 F4 a 938/raw/930841 AC 00653 fdff 8 beca 61 dab 9 a 20 bb 8983782/k8s-Dashboard-user . yml</a>来创建。</p><p id="4d15" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">关于回答创建集群配置文件的问题:</p><ul class=""><li id="edb0" class="lf lg iq jp b jq jr ju jv jy mu kc mv kg mw kk lm ln lo lp bi translated">括号中的值，例如SSH端口的<code class="fe lv lw lx ly b">[22]</code>是默认值，只需按下回车键即可使用。</li><li id="2b1b" class="lf lg iq jp b jq lq ju lr jy ls kc lt kg lu kk lm ln lo lp bi translated">默认的SSH私有密钥就可以了，如果您有另一个密钥，请更改它。</li></ul><pre class="md me mf mg gt ml ly mm mn aw mo bi"><span id="0ada" class="km kn iq ly b gy mp mq l mr ms">$ ./rke config<br/>[+] Cluster Level SSH Private Key Path [~/.ssh/id_rsa]: ~/.ssh/id_rsa<br/>[+] Number of Hosts [1]: 3<br/>[+] SSH Address of host (1) [none]: ip_or_dns_host1<br/>[+] SSH Port of host (1) [22]:<br/>[+] SSH Private Key Path of host (ip_or_dns_host1) [none]:<br/>[-] You have entered empty SSH key path, trying fetch from SSH key parameter<br/>[+] SSH Private Key of host (ip_or_dns_host1) [none]:<br/>[-] You have entered empty SSH key, defaulting to cluster level SSH key: ~/.ssh/id_rsa<br/>[+] SSH User of host (ip_or_dns_host1) [ubuntu]: rke<br/>[+] Is host (ip_or_dns_host1) a Control Plane host (y/n)? [y]: y<br/>[+] Is host (ip_or_dns_host1) a Worker host (y/n)? [n]: y<br/>[+] Is host (ip_or_dns_host1) an etcd host (y/n)? [n]: y<br/>[+] Override Hostname of host (ip_or_dns_host1) [none]:<br/>[+] Internal IP of host (ip_or_dns_host1) [none]:<br/>[+] Docker socket path on host (ip_or_dns_host1) [/var/run/docker.sock]:<br/>[+] SSH Address of host (2) [none]: ip_or_dns_host2<br/>[+] SSH Port of host (2) [22]:<br/>[+] SSH Private Key Path of host (ip_or_dns_host2) [none]:<br/>[-] You have entered empty SSH key path, trying fetch from SSH key parameter<br/>[+] SSH Private Key of host (ip_or_dns_host2) [none]:<br/>[-] You have entered empty SSH key, defaulting to cluster level SSH key: ~/.ssh/id_rsa<br/>[+] SSH User of host (ip_or_dns_host2) [ubuntu]: rke<br/>[+] Is host (ip_or_dns_host2) a Control Plane host (y/n)? [y]: y<br/>[+] Is host (ip_or_dns_host2) a Worker host (y/n)? [n]: y<br/>[+] Is host (ip_or_dns_host2) an etcd host (y/n)? [n]: y<br/>[+] Override Hostname of host (ip_or_dns_host2) [none]:<br/>[+] Internal IP of host (ip_or_dns_host2) [none]:<br/>[+] Docker socket path on host (ip_or_dns_host2) [/var/run/docker.sock]:<br/>[+] SSH Address of host (3) [none]: ip_or_dns_host3<br/>[+] SSH Port of host (3) [22]:<br/>[+] SSH Private Key Path of host (ip_or_dns_host3) [none]:<br/>[-] You have entered empty SSH key path, trying fetch from SSH key parameter<br/>[+] SSH Private Key of host (ip_or_dns_host3) [none]:<br/>[-] You have entered empty SSH key, defaulting to cluster level SSH key: ~/.ssh/id_rsa<br/>[+] SSH User of host (ip_or_dns_host3) [ubuntu]: rke<br/>[+] Is host (ip_or_dns_host3) a Control Plane host (y/n)? [y]: y<br/>[+] Is host (ip_or_dns_host3) a Worker host (y/n)? [n]: y<br/>[+] Is host (ip_or_dns_host3) an etcd host (y/n)? [n]: y<br/>[+] Override Hostname of host (ip_or_dns_host3) [none]:<br/>[+] Internal IP of host (ip_or_dns_host3) [none]:<br/>[+] Docker socket path on host (ip_or_dns_host3) [/var/run/docker.sock]:<br/>[+] Network Plugin Type (flannel, calico, weave, canal) [canal]:<br/>[+] Authentication Strategy [x509]:<br/>[+] Authorization Mode (rbac, none) [rbac]:<br/>[+] Kubernetes Docker image [rancher/hyperkube:v1.11.1-rancher1]:<br/>[+] Cluster domain [cluster.local]:<br/>[+] Service Cluster IP Range [10.43.0.0/16]:<br/>[+] Enable PodSecurityPolicy [n]:<br/>[+] Cluster Network CIDR [10.42.0.0/16]:<br/>[+] Cluster DNS Service IP [10.43.0.10]:<br/>[+] Add addon manifest URLs or YAML files [no]: yes<br/>[+] Enter the Path or URL for the manifest [none]: <a class="ae kl" href="https://raw.githubusercontent.com/kubernetes/dashboard/master/src/deploy/recommended/kubernetes-dashboard.yaml" rel="noopener ugc nofollow" target="_blank">https://raw.githubusercontent.com/kubernetes/dashboard/master/src/deploy/recommended/kubernetes-dashboard.yaml</a>                                                                                                                    <br/>[+] Add another addon [no]: yes<br/>[+] Enter the Path or URL for the manifest [none]: <a class="ae kl" href="https://gist.githubusercontent.com/superseb/499f2caa2637c404af41cfb7e5f4a938/raw/930841ac00653fdff8beca61dab9a20bb8983782/k8s-dashboard-user.yml" rel="noopener ugc nofollow" target="_blank">https://gist.githubusercontent.com/superseb/499f2caa2637c404af41cfb7e5f4a938/raw/930841ac00653fdff8beca61dab9a20bb8983782/k8s-dashboard-user.yml</a>                                                                                                                    <br/>[+] Add another addon [no]: no</span></pre><p id="ac20" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">当最后一个问题被回答时，<code class="fe lv lw lx ly b">cluster.yml</code>文件将被创建在运行RKE的同一个目录下:</p><pre class="md me mf mg gt ml ly mm mn aw mo bi"><span id="822b" class="km kn iq ly b gy mp mq l mr ms">ls -la cluster.yml <br/>-rw-r----- 1 user user 3688 Sep 17 12:50 cluster.yml</span></pre><p id="9454" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">您现在已经准备好构建您的Kubernetes集群了。这可以通过运行<code class="fe lv lw lx ly b">rke up</code>来完成。在运行该命令之前，请确保工作站/笔记本电脑/计算机与节点之间以及每个节点之间所需的<a class="ae kl" href="https://rancher.com/docs/rke/v0.1.x/en/os/#ports" rel="noopener ugc nofollow" target="_blank">端口</a>已打开。现在，您可以使用以下命令构建集群:</p><pre class="md me mf mg gt ml ly mm mn aw mo bi"><span id="0d80" class="km kn iq ly b gy mp mq l mr ms">$ ./rke up<br/>INFO[0000] Building Kubernetes cluster<br/>...<br/>INFO[0151] Finished building Kubernetes cluster successfully</span></pre><p id="0ae8" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果一切顺利，该命令应该会有很多输出，但应该以<code class="fe lv lw lx ly b">Finished building Kubernetes cluster successfully</code>结束。它还将写一个kubeconfig文件作为<code class="fe lv lw lx ly b">kube_config_cluster.yml</code>。您可以使用该文件连接到您的Kubernetes集群。</p><h2 id="e924" class="km kn iq bd ko kp kq dn kr ks kt dp ku jy kv kw kx kc ky kz la kg lb lc ld le bi translated">探索您的Kubernetes集群</h2><p id="416a" class="pw-post-body-paragraph jn jo iq jp b jq lh js jt ju li jw jx jy lz ka kb kc ma ke kf kg mb ki kj kk ij bi translated">确保您已经安装了<code class="fe lv lw lx ly b">kubectl</code>，参见<a class="ae kl" href="https://kubernetes.io/docs/tasks/tools/install-kubectl/" rel="noopener ugc nofollow" target="_blank">https://kubernetes.io/docs/tasks/tools/install-kubectl/</a>如何为您的平台获取它。</p><p id="9603" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><em class="mk">注:运行</em> <code class="fe lv lw lx ly b"><em class="mk">kubectl</em></code> <em class="mk">时，自动尝试使用默认位置的kubeconfig</em> <code class="fe lv lw lx ly b"><em class="mk">$HOME/.kube/config</em></code> <em class="mk">。在示例中，我们使用</em> <code class="fe lv lw lx ly b"><em class="mk">--kubeconfig kube_config_cluster.yml</em></code> <em class="mk">显式指定kubeconfig文件。如果不想每次都指定kubeconfig文件，可以将文件</em> <code class="fe lv lw lx ly b"><em class="mk">kube_config_cluster.yml</em></code> <em class="mk">复制到</em> <code class="fe lv lw lx ly b"><em class="mk">$HOME/.kube/config</em></code> <em class="mk">。(你可能需要先创建目录</em><code class="fe lv lw lx ly b"><em class="mk">$HOME/.kube</em></code><em class="mk">)</em></p><p id="b870" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">从查询服务器的版本开始:</p><pre class="md me mf mg gt ml ly mm mn aw mo bi"><span id="42f3" class="km kn iq ly b gy mp mq l mr ms">$ kubectl --kubeconfig kube_config_cluster.yml version</span><span id="278e" class="km kn iq ly b gy mt mq l mr ms">Client Version: version.Info{Major:"1", Minor:"11", GitVersion:"v1.11.3", GitCommit:"a4529464e4629c21224b3d52edfe0ea91b072862", GitTreeState:"clean", BuildDate:"2018-09-10T11:44:36Z", GoVersion:"go1.11", Compiler:"gc", Platform:"darwin/amd64"}                                                                   <br/>Server Version: version.Info{Major:"1", Minor:"11", GitVersion:"v1.11.1", GitCommit:"b1b29978270dc22fecc592ac55d903350454310a", GitTreeState:"clean", BuildDate:"2018-07-17T18:43:26Z", GoVersion:"go1.10.3", Compiler:"gc", Platform:"linux/amd64"}</span></pre><p id="0364" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">首先要检查的事情之一是，是否所有节点都处于<code class="fe lv lw lx ly b">Ready</code>状态:</p><pre class="md me mf mg gt ml ly mm mn aw mo bi"><span id="1fb8" class="km kn iq ly b gy mp mq l mr ms">$ kubectl --kubeconfig kube_config_cluster.yml get nodes<br/>NAME    STATUS    ROLES                      AGE       VERSION<br/>host1   Ready     controlplane,etcd,worker   11m       v1.11.1<br/>host2   Ready     controlplane,etcd,worker   11m       v1.11.1<br/>host3   Ready     controlplane,etcd,worker   11m       v1.11.1</span></pre><p id="0c93" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">当您生成集群配置文件时，您添加了要在集群上部署的Kubernetes dashboard插件。您可以使用以下命令检查部署状态:</p><pre class="md me mf mg gt ml ly mm mn aw mo bi"><span id="591a" class="km kn iq ly b gy mp mq l mr ms">$ kubectl --kubeconfig kube_config_cluster.yml get deploy -n kube-system -l k8s-app=kubernetes-dashboard</span><span id="d37c" class="km kn iq ly b gy mt mq l mr ms">NAME                   DESIRED   CURRENT   UP-TO-DATE   AVAILABLE   AGE<br/>kubernetes-dashboard   1         1         1            1           17m</span></pre><p id="8917" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">默认情况下，部署不对外公开。如果您想在浏览器中访问Kubernetes仪表板，您将需要向外公开部署(稍后我们将在我们的演示应用程序中这样做)或者使用kubectl的内置代理功能。这将打开<code class="fe lv lw lx ly b">127.0.0.1:8001</code>(您的本地机器在端口8001上)并将它隧道化到Kubernetes集群。</p><p id="4e46" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在访问Kubernetes仪表板之前，您需要检索令牌来登录仪表板。默认情况下，它在一个非常有限的帐户下运行，无法显示集群中的所有资源。我们在创建集群配置文件时添加的第二个插件创建了我们需要的帐户和令牌(这是基于<a class="ae kl" href="https://github.com/kubernetes/dashboard/wiki/Creating-sample-user" rel="noopener ugc nofollow" target="_blank">https://github . com/kubernetes/dashboard/wiki/Creating-sample-user</a>)</p><p id="afe6" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">您可以通过运行以下命令来检索令牌:</p><pre class="md me mf mg gt ml ly mm mn aw mo bi"><span id="05e1" class="km kn iq ly b gy mp mq l mr ms">$ kubectl --kubeconfig kube_config_cluster.yml -n kube-system describe secret $(kubectl --kubeconfig kube_config_cluster.yml -n kube-system get secret | grep admin-user | awk '{print $1}') | grep ^token: | awk '{ print $2 }'</span><span id="0491" class="km kn iq ly b gy mt mq l mr ms">eyJhbGciOiJSUzI1NiIs....&lt;more_characters&gt;</span></pre><p id="5294" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">返回的字符串是您登录仪表板所需的令牌。复制整个字符串。</p><p id="086a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">按如下方式设置kubectl代理:</p><pre class="md me mf mg gt ml ly mm mn aw mo bi"><span id="d002" class="km kn iq ly b gy mp mq l mr ms">$ kubectl --kubeconfig kube_config_cluster.yml proxy</span><span id="7d0a" class="km kn iq ly b gy mt mq l mr ms">Starting to serve on 127.0.0.1:8001</span></pre><p id="da49" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">并打开以下URL:</p><p id="d25c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><a class="ae kl" href="http://localhost:8001/api/v1/namespaces/kube-system/services/https:kubernetes-dashboard:/proxy/" rel="noopener ugc nofollow" target="_blank">http://localhost:8001/API/v1/namespaces/kube-system/services/https:kubernetes-dashboard:/proxy/</a></p><p id="20c3" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">当提示登录时，选择<strong class="jp ir">令牌</strong>，粘贴令牌，点击<strong class="jp ir">登录</strong>。</p><p id="2acf" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><em class="mk">注意:当您没有看到登录屏幕时，请通过点击右上角的登录来手动打开它。</em></p><h2 id="fdbf" class="km kn iq bd ko kp kq dn kr ks kt dp ku jy kv kw kx kc ky kz la kg lb lc ld le bi translated">运行演示应用程序</h2><p id="d810" class="pw-post-body-paragraph jn jo iq jp b jq lh js jt ju li jw jx jy lz ka kb kc ma ke kf kg mb ki kj kk ij bi translated">本文的最后一步，运行一个演示应用程序并公开它。对于这个例子，您将运行一个演示应用程序<code class="fe lv lw lx ly b">superseb/rancher-demo</code>，它是一个显示部署规模的web UI。它将使用Ingress公开，这由默认部署的NGINX Ingress控制器处理。如果你想了解更多关于Ingress的信息，请参见<a class="ae kl" href="https://kubernetes.io/docs/concepts/services-networking/ingress/" rel="noopener ugc nofollow" target="_blank">https://kubernetes . io/docs/concepts/services-networking/Ingress/</a></p><p id="947d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">首先部署并公开演示应用程序(运行在端口8080上):</p><pre class="md me mf mg gt ml ly mm mn aw mo bi"><span id="1033" class="km kn iq ly b gy mp mq l mr ms">$ kubectl --kubeconfig kube_config_cluster.yml run --image=superseb/rancher-demo rancher-demo --port 8080 --expose<br/>service/rancher-demo created<br/>deployment.apps/rancher-demo created</span></pre><p id="11cc" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">检查您的部署状态:</p><pre class="md me mf mg gt ml ly mm mn aw mo bi"><span id="fdce" class="km kn iq ly b gy mp mq l mr ms">$ kubectl --kubeconfig kube_config_cluster.yml rollout status deployment/rancher-demo<br/>...<br/>deployment "rancher-demo" successfully rolled out</span></pre><p id="5640" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">命令<code class="fe lv lw lx ly b">kubectl run</code>是让容器在集群上运行的最简单的方法。它需要一个图像参数来指定Docker图像和至少一个名称。在这种情况下，我们还想配置这个容器公开的端口(内部)，并公开它。所发生的是，创建了一个部署(和一个复制集),规模为1(默认),并且创建了一个服务来抽象对pod的访问(它可以包含一个或多个容器，在本例中为1)。有关这些主题的更多信息，请查看以下链接:</p><ul class=""><li id="a925" class="lf lg iq jp b jq jr ju jv jy mu kc mv kg mw kk lm ln lo lp bi translated"><a class="ae kl" href="https://kubernetes.io/docs/tutorials/kubernetes-basics/deploy-app/deploy-intro/" rel="noopener ugc nofollow" target="_blank">https://kubernetes . io/docs/tutorials/kubernetes-basics/deploy-app/deploy-intro/</a></li><li id="311c" class="lf lg iq jp b jq lq ju lr jy ls kc lt kg lu kk lm ln lo lp bi translated"><a class="ae kl" href="https://kubernetes.io/docs/tutorials/kubernetes-basics/expose/expose-intro/" rel="noopener ugc nofollow" target="_blank">https://kubernetes . io/docs/tutorials/kubernetes-basics/expose/expose-intro/</a></li></ul><p id="0460" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">默认情况下，RKE在每个节点上部署NGINX入口控制器。这将打开op端口80和端口443，并且可以作为任何创建的入口的主入口点。入口可以包含单个主机或多个路径，并且您可以配置SSL证书。在本帖中，您将配置一个基本入口，使我们的演示应用程序可以在某个主机名上访问。在示例中，我们将使用<code class="fe lv lw lx ly b">rancher-demo.domain.test</code>作为主机名来访问演示应用程序。</p><p id="79c8" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><em class="mk">注意:要访问我们的测试域，您必须将域名添加到/etc/hosts以访问UI，因为它不是有效的DNS名称。如果您可以访问自己的域，您可以添加一个DNS A记录，指向每个节点。</em></p><figure class="md me mf mg gt mh gh gi paragraph-image"><div class="gh gi mx"><img src="../Images/25dd1a67b854d532d76232ada6aeb8c6.png" data-original-src="https://miro.medium.com/v2/resize:fit:802/format:webp/1*1QWVZauO1CPPF9HxNrQx7w.png"/></div></figure><p id="6634" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">唯一没有创建的部分是入口。让我们创建一个名为<code class="fe lv lw lx ly b">rancher-demo-ingress</code>的入口，它有一个主机规范来匹配对我们的测试域(<code class="fe lv lw lx ly b">rancher-demo.domain.test</code>)的请求，并将它指向端口8080上名为<code class="fe lv lw lx ly b">rancher-demo</code>的服务。将以下内容保存到名为<code class="fe lv lw lx ly b">ingress.yml</code>的文件中:</p><pre class="md me mf mg gt ml ly mm mn aw mo bi"><span id="b50d" class="km kn iq ly b gy mp mq l mr ms">apiVersion: extensions/v1beta1<br/>kind: Ingress<br/>metadata:<br/>  name: rancher-demo-ingress<br/>spec:<br/>  rules:<br/>  - host: rancher-demo.domain.test<br/>    http:<br/>      paths:<br/>      - path: /<br/>        backend:<br/>          serviceName: rancher-demo<br/>          servicePort: 8080</span></pre><p id="6c00" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">使用kubectl创建这个入口:</p><pre class="md me mf mg gt ml ly mm mn aw mo bi"><span id="f157" class="km kn iq ly b gy mp mq l mr ms">$ kubectl --kubeconfig kube_config_cluster.yml apply -f ingress.yml<br/>ingress.extensions/rancher-demo-ingress created</span></pre><p id="f971" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">测试访问演示应用程序的时间到了。您可以首先在命令行上尝试，指示<code class="fe lv lw lx ly b">curl</code>将测试域解析到每个节点:</p><pre class="md me mf mg gt ml ly mm mn aw mo bi"><span id="7fc0" class="km kn iq ly b gy mp mq l mr ms"># Get node IP addresses<br/>$ kubectl --kubeconfig kube_config_cluster.yml get nodes                                                                                                                                                                                                                           <br/>NAME       STATUS    ROLES                      AGE       VERSION<br/>10.0.0.1   Ready     controlplane,etcd,worker   3h        v1.11.1<br/>10.0.0.2   Ready     controlplane,etcd,worker   3h        v1.11.1<br/>10.0.0.3   Ready     controlplane,etcd,worker   3h        v1.11.1<br/># Test accessing the demo application<br/>$ curl --resolve rancher-demo.domain.test:80:10.0.0.1 <a class="ae kl" href="http://rancher-demo.domain.test/ping" rel="noopener ugc nofollow" target="_blank">http://rancher-demo.domain.test/ping</a><br/>                                                                                                                                                                                <br/>{"instance":"rancher-demo-5cbfb4b4-thmbh","version":"0.1"}<br/>$ curl --resolve rancher-demo.domain.test:80:10.0.0.2 <a class="ae kl" href="http://rancher-demo.domain.test/ping" rel="noopener ugc nofollow" target="_blank">http://rancher-demo.domain.test/ping</a><br/>                                                                                                                                                                                  <br/>{"instance":"rancher-demo-5cbfb4b4-thmbh","version":"0.1"}<br/>$ curl --resolve rancher-demo.domain.test:80:10.0.0.3<br/><a class="ae kl" href="http://rancher-demo.domain.test/ping" rel="noopener ugc nofollow" target="_blank">http://rancher-demo.domain.test/ping</a><br/>                                                                                                                                                                          <br/>{"instance":"rancher-demo-5cbfb4b4-thmbh","version":"0.1"}</span></pre><p id="97e9" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果您使用测试域，您需要将它添加到您机器的<code class="fe lv lw lx ly b">/etc/hosts</code>文件中，以便能够正确地访问它。</p><pre class="md me mf mg gt ml ly mm mn aw mo bi"><span id="8827" class="km kn iq ly b gy mp mq l mr ms">echo "10.0.0.1  rancher-demo.domain.test" | sudo tee -a /etc/hosts</span></pre><p id="a422" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在在你的浏览器中访问<a class="ae kl" href="http://rancher-demo.domain.test" rel="noopener ugc nofollow" target="_blank">http://rancher-demo . domain . test</a>。</p><p id="6719" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果这一切都解决了，您可以通过扩展您的部署来填充演示应用程序:</p><pre class="md me mf mg gt ml ly mm mn aw mo bi"><span id="a002" class="km kn iq ly b gy mp mq l mr ms">$ kubectl --kubeconfig kube_config_cluster.yml scale deploy/rancher-demo --replicas=10<br/>deployment.extensions/rancher-demo scaled</span></pre><p id="d9e3" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><em class="mk">注:完成后，请务必清理</em> <code class="fe lv lw lx ly b"><em class="mk">/etc/hosts</em></code> <em class="mk">条目。</em></p><h2 id="2819" class="km kn iq bd ko kp kq dn kr ks kt dp ku jy kv kw kx kc ky kz la kg lb lc ld le bi translated">结束语</h2><p id="f2a0" class="pw-post-body-paragraph jn jo iq jp b jq lh js jt ju li jw jx jy lz ka kb kc ma ke kf kg mb ki kj kk ij bi translated">这是一篇如何在10分钟内创建一个Kubernetes集群的帖子，但是在这个过程中，我试图添加一些关于某些部分如何工作的有用信息。为了避免有一个帖子需要一天的时间来阅读(解释每个部分)，会有其他帖子描述某些部分。现在，我已经将尽可能多的资源链接到现有的文档，您可以在那里了解更多。</p><ul class=""><li id="482e" class="lf lg iq jp b jq jr ju jv jy mu kc mv kg mw kk lm ln lo lp bi translated"><a class="ae kl" href="https://rancher.com/docs/rke/v0.1.x/en/" rel="noopener ugc nofollow" target="_blank"> RKE文档</a></li><li id="018a" class="lf lg iq jp b jq lq ju lr jy ls kc lt kg lu kk lm ln lo lp bi translated"><a class="ae kl" href="https://kubernetes.github.io/ingress-nginx/" rel="noopener ugc nofollow" target="_blank"> NGINX入口控制器</a></li><li id="49d0" class="lf lg iq jp b jq lq ju lr jy ls kc lt kg lu kk lm ln lo lp bi translated"><a class="ae kl" href="https://kubernetes.io/docs/tutorials/kubernetes-basics/" rel="noopener ugc nofollow" target="_blank">学习Kubernetes基础知识</a></li></ul></div></div>    
</body>
</html>