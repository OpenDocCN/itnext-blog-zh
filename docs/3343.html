<html>
<head>
<title>AWS CloudFormation to update Lambda Functions</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">更新Lambda函数的AWS CloudFormation</h1>
<blockquote>原文：<a href="https://itnext.io/aws-cloudformation-to-update-lambda-functions-b95ce2eba4cf?source=collection_archive---------1-----------------------#2019-11-26">https://itnext.io/aws-cloudformation-to-update-lambda-functions-b95ce2eba4cf?source=collection_archive---------1-----------------------#2019-11-26</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><p id="cf32" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">大多数人已经熟悉了AWS Lambda函数。如果您有一个完全无服务器的部署，您可以利用<a class="ae ko" href="https://docs.aws.amazon.com/serverless-application-model/latest/developerguide/what-is-sam.html" rel="noopener ugc nofollow" target="_blank"> AWS SAM </a>来管理、打包、部署和更新您的部署。山姆规模非常好，非常容易使用！但在许多情况下，云部署并非完全无服务器，即与EC2、ECS类型的资源混合。在这种情况下，SAM是有帮助的，但还不够，因为要部署其他AWS资源类型，您需要在CloudFormation堆栈中管理它们。在大范围内，这可能会成为一个非常复杂的问题！</p><p id="0672" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">在这种情况下，您仍然可以受益于<a class="ae ko" href="https://medium.com/@amolkokje/package-and-deploy-aws-lambda-functions-4b734e7c8f8e" rel="noopener"> SAM来创建和维护您的lambda部署包</a>，但是您需要一种方法来更新您的CloudFormation堆栈。所以，现在这变成了一个两步的过程，可以用一些简单的技巧来管理。我在最近的项目中遇到了这个问题，所以在这篇文章中，我将提供一个对我非常有效的方法。</p><p id="3bb3" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">在这个例子中，我们有一个staging bucket，它包含用于部署的lambda包。SAM用于使用更新的Lambda包更新暂存桶。CloudFormation模板定制资源代码复制包并在它们的Lambda函数资源中使用它们。</p><figure class="kq kr ks kt gt ku gh gi paragraph-image"><div role="button" tabindex="0" class="kv kw di kx bf ky"><div class="gh gi kp"><img src="../Images/f24cb6b946df84b1a4a4364bdd3c86ea.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*4t0Hkz1n8OWvcZbATgpvVg.png"/></div></div><figcaption class="lb lc gj gh gi ld le bd b be z dk translated">更新Lambda函数的AWS CloudFormation</figcaption></figure><h1 id="e0ae" class="lf lg it bd lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc bi translated">当代码或依赖关系发生变化时，我们如何更新Lambda函数资源？</h1><p id="7b3e" class="pw-post-body-paragraph jq jr it js b jt md jv jw jx me jz ka kb mf kd ke kf mg kh ki kj mh kl km kn im bi translated">当您应用CloudFormation堆栈更新时，它将检查任何已部署资源的属性是否有更新。如果没有更新，它将不会采取任何行动。它将只对已有属性更新的资源起作用。</p><p id="b5b1" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">当内存、超时、环境变量等Lambda资源属性发生更新时，不会有任何问题，因为CloudFormation会选择这些更改并相应地更新。</p><p id="012e" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><em class="mi">当Lambda函数代码或其任何依赖项</em>有更新时，问题就出现了。由于这些不是资源属性更新，CloudFormation无法知道是否有变化，也无法更新受影响的组件。</p><p id="85ba" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">因此，在这里的解决方案中，这里的技巧是更新自定义资源中的属性以更新包，更新Lambda函数中的属性以更新Lambda函数包。这样，CloudFormation就知道发生了变化，资源需要更新。</p><p id="acaa" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><strong class="js iu">注意</strong> : <em class="mi">如果Lambda函数是使用部署在s3 bucket中的包创建的，更新包不足以更新Lambda函数。还需要调用Lambda函数更新API。</em></p><p id="2bd4" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">这个例子的所有源代码都位于我的<a class="ae ko" href="https://github.com/amolkokje/cfn_update_lambda" rel="noopener ugc nofollow" target="_blank"> GitHub repo </a>中。</p><p id="72df" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">在这个例子中，SAM用于生成Lambda包(SAM不是这个解决方案的要求。你可以选择你喜欢的包装方式。).唯一需要注意的是<em class="mi">这个包必须有一个唯一的名字</em>，它将被CloudFormation用来检测资源属性的变化。</p><p id="d1e7" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">正如您在代码片段中看到的，'<strong class="js iu"> CopyZips </strong>资源将把'<strong class="js iu"> Objects </strong>中所有指定的包从暂存桶复制到部署桶。因此，我们需要在这个地方更新名称，以便添加/更新的名称将被复制到堆栈中。<a class="ae ko" href="https://github.com/amolkokje/cfn_update_lambda/blob/master/template/update_lambda.yaml" rel="noopener ugc nofollow" target="_blank">完整模板代码</a>。</p><figure class="kq kr ks kt gt ku"><div class="bz fp l di"><div class="mj mk l"/></div><figcaption class="lb lc gj gh gi ld le bd b be z dk translated">CloudFormation模板中的CopyZips资源</figcaption></figure><p id="dc2e" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">现在，我们有了更新的包，但是我们仍然需要更新Lambda函数。要实现这一点，您需要用包名更新Lambda函数资源'<strong class="js iu"> S3Key </strong>'属性。参见下面的片段以供参考。</p><figure class="kq kr ks kt gt ku"><div class="bz fp l di"><div class="mj mk l"/></div><figcaption class="lb lc gj gh gi ld le bd b be z dk translated">CloudFormation模板中的Lambda函数资源</figcaption></figure><p id="93c5" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">为了简单起见，在这个例子中，只使用了一个Lambda函数。所以，要更新Lambda函数，你需要做的就是更新一个栈参数。但是真正的部署要复杂得多，可能有许多Lambda函数需要更新。对于这种情况，您必须使用一些高级的CloudFormation技巧来更新模板中的相关字符串。</p><p id="5b28" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">实现这一点的一个方法是使用Lambda函数名到它们部署/使用的包名的映射。当需要更新时，用户只需更新映射中受影响包的包名。因为所有的模板代码都引用映射，所以当应用栈更新时，所有相关的Lambda函数都将被更新。</p><p id="2ca8" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">请参见下面的示例映射以供参考:</p><pre class="kq kr ks kt gt ml mm mn mo aw mp bi"><span id="a3df" class="mq lg it mm b gy mr ms l mt mu">LambdaFunctionPackageMap:<br/>    FirstLambdaFunction:<br/>        PackageName: “b8a6ddc8a38e569f23eb12d0d8d020c9”<br/>    SecondLambdaFunction:<br/>        PackageName: “cd5dff37f7581343bd5e7e2851569dd2”</span></pre><p id="359c" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">只要模板中使用了包名，就使用下面的结构从映射中获取名称。</p><pre class="kq kr ks kt gt ml mm mn mo aw mp bi"><span id="ec14" class="mq lg it mm b gy mr ms l mt mu">!FindInMap [LambdaFunctionPackageMap, FirstLambdaFunction, PackageName]</span></pre><p id="134e" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">在我的部署中，我花了相当多的迭代来找出一个干净的方法来实现这个功能。所以，我希望这篇文章和<a class="ae ko" href="https://github.com/amolkokje/cfn_update_lambda" rel="noopener ugc nofollow" target="_blank">示例代码</a>对你有用！如果您有任何相关问题，请随时联系我们。</p></div></div>    
</body>
</html>