<html>
<head>
<title>Azure DevOps Pipelines: Use YAML Across Repos</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Azure DevOps管道:跨回购使用YAML</h1>
<blockquote>原文：<a href="https://itnext.io/azure-devops-pipelines-use-yaml-across-repos-1faa8d2409b?source=collection_archive---------6-----------------------#2020-04-06">https://itnext.io/azure-devops-pipelines-use-yaml-across-repos-1faa8d2409b?source=collection_archive---------6-----------------------#2020-04-06</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="b2d4" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在上周的帖子中，我们将一些可重用的YAML重构为一个新文件。这篇文章将介绍如何将相同的可重用YAML迁移到一个新的回购中，然后在我们现有的示例回购中使用它。这篇文章将建立在以前文章中创建的Azure DevOps项目的基础上，如果你刚刚加入这个系列，请查看以前的文章，了解该项目的进展情况。</p><p id="9775" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><a class="ae kl" href="https://elanderson.net/2020/02/getting-started-with-azure-devops/" rel="noopener ugc nofollow" target="_blank">Azure devo PS入门</a><br/><a class="ae kl" href="https://elanderson.net/2020/03/pipeline-creation-in-azure-devops/" rel="noopener ugc nofollow" target="_blank">Azure devo PS中的管道创建</a> <br/> <a class="ae kl" href="https://elanderson.net/2020/03/azure-devops-publish-asp-net-core/" rel="noopener ugc nofollow" target="_blank"> Azure DevOps为ASP.NET核心发布工件</a> <br/> <a class="ae kl" href="https://elanderson.net/2020/03/azure-devops-pipelines-multiple-jobs-in-yaml/" rel="noopener ugc nofollow" target="_blank"> Azure DevOps管道:YAML的多个作业</a> <br/> <a class="ae kl" href="https://elanderson.net/2020/03/azure-devops-pipelines-reuseable-yaml/" rel="noopener ugc nofollow" target="_blank"> Azure DevOps管道:可重用的YAML </a></p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div class="gh gi km"><img src="../Images/6d0d54bc59407847bf43b7ea9fa46112.png" data-original-src="https://miro.medium.com/v2/resize:fit:600/format:webp/0*6QCvatbziAerHGbM.png"/></div></figure><h2 id="36aa" class="ku kv iq bd kw kx ky dn kz la lb dp lc jy ld le lf kc lg lh li kg lj lk ll lm bi translated">创建新的存储库</h2><p id="6e66" class="pw-post-body-paragraph jn jo iq jp b jq ln js jt ju lo jw jx jy lp ka kb kc lq ke kf kg lr ki kj kk ij bi translated">首先，我们需要创建一个新的存储库，用于共享正在讨论的YAML。使用Azure DevOps的<strong class="jp ir"> Repos </strong>部分作为起点，单击带有当前选择的repo名称的下拉菜单，在本例中为<strong class="jp ir"> Playground </strong>，然后单击<strong class="jp ir"> New repository </strong>。</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="lt lu di lv bf lw"><div class="gh gi ls"><img src="../Images/2271d0589326e3f7763c20257b66ba63.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*KYPV-VSOMVXaMnhw.png"/></div></div></figure><p id="eeb2" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">您将会看到一个对话框，在这里您需要输入<strong class="jp ir">库名</strong>和任何其他您想要配置的选项。在本例中，我们将repo命名为Shared，并为Visual Studio添加了一个Git ignore文件。完成后点击<strong class="jp ir">创建</strong>按钮。</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div class="gh gi lx"><img src="../Images/198e4756f4ad566da09250dab2d7b71c.png" data-original-src="https://miro.medium.com/v2/resize:fit:900/format:webp/0*ymjMgzw6KowSQMFF.png"/></div></figure><p id="8f8a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">应对新的共享回购采取以下步骤。此时，您可以克隆回购并在本地执行其余步骤，然后将更改推送到回购，或者您可以使用web界面进行所有更改，这是本文将要展示的路线。无论哪种方式，你去不应该太难适应的步骤。对于在回购根目录中添加新文件的web界面，单击回购名称右侧的三点菜单，然后选择<strong class="jp ir">新建</strong>，然后选择<strong class="jp ir">文件</strong>。</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div class="gh gi ly"><img src="../Images/6969d36cd5bab515abbcb199d5f951ea.png" data-original-src="https://miro.medium.com/v2/resize:fit:1014/format:webp/0*WPkIrbGC2uf-8976.png"/></div></figure><p id="a3bb" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">下一个提示会要求输入文件名，我用的是<strong class="jp ir">buildcorewebproject . yml</strong>。点击<strong class="jp ir">创建</strong>继续。</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div class="gh gi lz"><img src="../Images/039329c3a040eab0765907c135b45370.png" data-original-src="https://miro.medium.com/v2/resize:fit:904/format:webp/0*Zei2WiC5intlUC5_.png"/></div></figure><p id="b44b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">您将进入文件编辑器。将前一篇文章中使用的build.yml中的代码复制并粘贴到新文件中。以下是来自build.yml的完整YAML，供参考。</p><pre class="kn ko kp kq gt ma mb mc md aw me bi"><span id="0ba9" class="ku kv iq mb b gy mf mg l mh mi">parameters:<br/>- name: buildConfiguration<br/>  type: string<br/>  default: 'Release'<br/>- name: project<br/>  type: string<br/>  default: ''<br/>- name: artifactName<br/>  type: string<br/>  default: ''<br/><br/>steps:<br/>  - task: UseDotNet@2<br/>    displayName: 'Use .NET 3.1.x'<br/>    inputs:<br/>      packageType: 'sdk'<br/>      version: '3.1.x'<br/><br/>  - task: DotNetCoreCLI@2<br/>    displayName: 'Build'<br/>    inputs:<br/>      command: 'build'<br/>      projects: '**/${{ parameters.project }}'<br/>      arguments: '--configuration ${{ parameters.buildConfiguration }}' <br/>  <br/>  - task: DotNetCoreCLI@2<br/>    displayName: 'Publish Application'<br/>    inputs:<br/>      command: 'publish'<br/>      publishWebProjects: false<br/>      projects: '**/${{ parameters.project }}'<br/>      arguments: '--configuration ${{ parameters.buildConfiguration }} --output $(Build.ArtifactStagingDirectory)'<br/><br/>  - task: PublishPipelineArtifact@1<br/>    displayName: 'Publish Artifacts'<br/>    inputs:<br/>      targetPath: '$(Build.ArtifactStagingDirectory)'<br/>      artifact: ${{ parameters.artifactName }}<br/>      publishLocation: 'pipeline'</span></pre><p id="6225" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">一旦代码被复制，点击<strong class="jp ir"> Commit </strong>按钮保存对主分支的修改。</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="lt lu di lv bf lw"><div class="gh gi mj"><img src="../Images/2b9f16cfb9fa6ff50e2c21a3d2dfcc92.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*6WvkOw9JGjpa70KI.png"/></div></div></figure><p id="7a1a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">切换回我们最初的回购，<strong class="jp ir">游乐场</strong>在这个例子中，我们需要在我们的<strong class="jp ir"> azure-pipelines.yml </strong>文件中添加<strong class="jp ir">共享</strong>回购作为资源。下面是使用另一个Azure DevOps repo的资源交付。<a class="ae kl" href="https://docs.microsoft.com/en-us/azure/devops/pipelines/repos/multi-repo-checkout?view=azure-devops" rel="noopener ugc nofollow" target="_blank">签出多个存储库</a>的官方文档也展示了GitHub和Bitbucket的例子。我还发现他的stackoverflow问题很有帮助。</p><pre class="kn ko kp kq gt ma mb mc md aw me bi"><span id="7648" class="ku kv iq mb b gy mf mg l mh mi">resources: <br/>  repositories: <br/>  - repository: Shared <br/>    name: Playground/Shared <br/>    type: git <br/>    ref: master #branch name</span></pre><p id="6a40" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">存储库行上的<strong class="jp ir"> Shared </strong>是我们在共享存储库中引用文件时将使用的名称。<strong class="jp ir">名称</strong>是Azure DevOps项目和回购名称。<strong class="jp ir">类型</strong>是回购类型，在我们的例子中是Git。最后，<strong class="jp ir"> ref </strong>是我们想要使用的共享回购的分支名称。既然我们可以从共享存储库中访问文件，我们可以使用它的buildCoreWebProject.yml而不是本地的build.yml作为模板。</p><pre class="kn ko kp kq gt ma mb mc md aw me bi"><span id="5942" class="ku kv iq mb b gy mf mg l mh mi">Before:<br/>  - template: build.yml<br/>    parameters:<br/>      buildConFiguration: $(buildConfiguration)<br/>      project: WebApp1.csproj<br/>      artifactName: WebApp1<br/><br/>After:<br/>  - template: buildCoreWebProject.yml@Shared<br/>    parameters:<br/>      buildConFiguration: $(buildConfiguration)<br/>      project: WebApp1.csproj<br/>      artifactName: WebApp1</span></pre><p id="f4c4" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">注意，唯一的变化是在<strong class="jp ir">模板</strong>行上，从<strong class="jp ir"> build.yml </strong>变成了<strong class="jp ir">buildcorewebproject . yml @ Shared</strong>。文件名末尾的@Shared告诉管道文件的来源是共享的repo。以下是完整的azure-pipeline.yml供参考。第一项工作是使用共享回购的模板，第二项工作是使用本地模板。</p><pre class="kn ko kp kq gt ma mb mc md aw me bi"><span id="9655" class="ku kv iq mb b gy mf mg l mh mi">resources:      <br/>  repositories: <br/>  - repository: Shared<br/>    name: Playground/Shared<br/>    type: git <br/>    ref: master #branch name<br/><br/>trigger: none<br/><br/>variables:<br/>  buildConfiguration: 'Release'<br/><br/>jobs:<br/>- job: WebApp1<br/>  displayName: 'Build WebApp1'<br/>  pool:<br/>    vmImage: 'ubuntu-latest'<br/><br/>  steps:<br/>  - template: buildCoreWebProject.yml@Shared<br/>    parameters:<br/>      buildConFiguration: $(buildConfiguration)<br/>      project: WebApp1.csproj<br/>      artifactName: WebApp1<br/><br/>- job: WebApp2<br/>  displayName: 'Build WebApp2'<br/>  pool:<br/>    vmImage: 'ubuntu-latest'<br/><br/>  steps:<br/>  - template: build.yml<br/>    parameters:<br/>      buildConFiguration: $(buildConfiguration)<br/>      project: WebApp2.csproj<br/>      artifactName: WebApp2</span></pre><h2 id="9cd2" class="ku kv iq bd kw kx ky dn kz la lb dp lc jy ld le lf kc lg lh li kg lj lk ll lm bi translated">包扎</h2><p id="2d0f" class="pw-post-body-paragraph jn jo iq jp b jq ln js jt ju lo jw jx jy lp ka kb kc lq ke kf kg lr ki kj kk ij bi translated">能够从不同的回购中利用YAML可以帮助减少重复的YAML，并有助于保持您的回购渠道更加清洁。与其他任何东西一样，如果应用得当，这是一个有用的工具。</p></div><div class="ab cl mk ml hu mm" role="separator"><span class="mn bw bk mo mp mq"/><span class="mn bw bk mo mp mq"/><span class="mn bw bk mo mp"/></div><div class="ij ik il im in"><p id="6799" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><em class="mr">原载于</em> <a class="ae kl" href="https://elanderson.net/2020/04/azure-devops-pipelines-use-yaml-across-repos/" rel="noopener ugc nofollow" target="_blank"> <em class="mr">埃里克·安德森</em> </a> <em class="mr">。</em></p></div></div>    
</body>
</html>