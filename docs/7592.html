<html>
<head>
<title>Implementing and troubleshooting a custom Azure Policy Definition [Step-by-step Guide]</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">实施自定义Azure策略定义和故障排除[分步指南]</h1>
<blockquote>原文：<a href="https://itnext.io/implementing-and-troubleshooting-a-custom-azure-policy-definition-1ab8d0634bb2?source=collection_archive---------0-----------------------#2022-11-17">https://itnext.io/implementing-and-troubleshooting-a-custom-azure-policy-definition-1ab8d0634bb2?source=collection_archive---------0-----------------------#2022-11-17</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="daae" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">Azure Policy是Microsoft Azure中的一个工具，它允许您管理Azure资源的使用，并强制执行组织标准以确保合规性。这在许多组织中至关重要，在Azure环境中有多个独立工作的开发团队，确保安全性、遵守数据法律和业务连续性可能是一项挑战。</p><h1 id="167d" class="kl km iq bd kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li bi translated">这篇文章是写给谁的？</h1><p id="e871" class="pw-post-body-paragraph jn jo iq jp b jq lj js jt ju lk jw jx jy ll ka kb kc lm ke kf kg ln ki kj kk ij bi translated">顾名思义，这是一个创建<em class="lo">自定义</em>策略的分步指南，它比使用微软<em class="lo">内置</em>策略更进了一步。因此，这篇文章假设你有一些关于<a class="ae lp" href="https://learn.microsoft.com/en-us/azure/governance/policy/overview" rel="noopener ugc nofollow" target="_blank"> Azure Policy </a>的经验，并且熟悉基础知识。您应该已经知道策略定义、计划(定义集)和任务之间的区别。您还应该对<a class="ae lp" href="https://learn.microsoft.com/en-us/azure/governance/policy/concepts/effects" rel="noopener ugc nofollow" target="_blank">策略效果</a>有一些基本的了解，比如Deny、Audit、Modify和DeployIfNotExists。理想情况下，您已经实现了一个简单的内置策略，如“允许的位置”，它限制了您的环境中可以部署资源的位置。我跳过了很多细节，但这里有一篇精彩的博客文章<a class="ae lp" href="https://andrewmatveychuk.com/azure-policy-starter-guide/" rel="noopener ugc nofollow" target="_blank"/>提供了一份精彩的政策入门指南。这是相当高的，并为门外汉提供了更广泛的原则/最佳实践。</p><p id="b59f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">本文记录了在我确定了我的组织想要实施的特定效果后，我实现自定义Azure策略的方法。从我确定我想要实施的特定政策开始，它就是一步一步的指南。在我们深入本文之前，先阅读一下关于<a class="ae lp" href="https://learn.microsoft.com/en-us/azure/governance/policy/troubleshoot/general" rel="noopener ugc nofollow" target="_blank">故障排除</a>的微软文档是有帮助的。</p><p id="7065" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><em class="lo">开始之前的最后一点—如果您只是为了SQL数据库短期备份保留策略而来，请滚动到文章末尾！</em></p><h1 id="eb46" class="kl km iq bd kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li bi translated">案例研究:对Azure SQL数据库强制执行7天的短期备份保留</h1><p id="2b5d" class="pw-post-body-paragraph jn jo iq jp b jq lj js jt ju lk jw jx jy ll ka kb kc lm ke kf kg ln ki kj kk ij bi translated">为了让您了解这一过程，我将使用一个创建策略的示例来强制Azure SQL数据库至少保留7天的短期备份。预期的策略效果是DeployIfNotExists，它补救不符合的资源。这通常是首选选项，而不是直接的“拒绝”(防止创建不合规的资源)或“审核”(如果资源不合规，则向您发出警报，但不对其采取任何措施)。</p><h1 id="e051" class="kl km iq bd kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li bi translated">步骤1:查找相似(或完全相同)政策的例子</h1><p id="f456" class="pw-post-body-paragraph jn jo iq jp b jq lj js jt ju lk jw jx jy ll ka kb kc lm ke kf kg ln ki kj kk ij bi translated">没有必要在这里重新发明轮子；首先，尝试查找名为万维网的惊人发明，以检查是否有来自Azure的内置策略，或其他人已经建立的其他自定义策略。AzAdvertiser 是一个很棒的资源，它收集了大量的Azure政策，所有这些政策都经过了很好的整理和组织，以便你过滤相关的元数据。此外，如果有好心人写了一篇分享特定定制政策的博文或文章，请在Google上快速查看一下。</p><p id="7d61" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我没有找到完全符合我所寻找的内置策略，所以这是一个很好的例子来说明我从头开始创建自定义策略的过程。</p><p id="d6a4" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在实际创建策略之前，我先在Azure中做一些调查工作。</p><h1 id="a550" class="kl km iq bd kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li bi translated">步骤2:创建1-2个资源，并检查在门户中何处设置策略实施的预期效果。稍后还需要这些资源来测试策略。</h1><p id="f84f" class="pw-post-body-paragraph jn jo iq jp b jq lj js jt ju lk jw jx jy ll ka kb kc lm ke kf kg ln ki kj kk ij bi translated">我创建了一个SQL数据库，它需要在SQL服务器中。这些都是通过在Azure门户中创建测试资源来完成的。</p><p id="c347" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">要在门户中配置短期备份策略，您必须导航到托管SQL数据库的SQL server。</p><p id="06a6" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">具体来说，它位于SQL Server下的“备份”&gt;“保留策略”&gt;“配置策略”下(1–35天之间)。</p><figure class="lr ls lt lu gt lv gh gi paragraph-image"><div role="button" tabindex="0" class="lw lx di ly bf lz"><div class="gh gi lq"><img src="../Images/e5f5eacb8853a0324aa78f50b1e83433.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*QheFAyed-pcST12yDyPufA.png"/></div></div></figure><p id="b609" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">此时，故意修改资源，使其不兼容。在我的例子中，我将把备份天数修改为6天，这样我就有合规和不合规的资源来进行比较和测试。</p><h1 id="e97d" class="kl km iq bd kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li bi translated">步骤3:查看在“导出模板”下生成的ARM模板，以了解您想要实施的特定设置是在哪里定义的。</h1><p id="e1ce" class="pw-post-body-paragraph jn jo iq jp b jq lj js jt ju lk jw jx jy ll ka kb kc lm ke kf kg ln ki kj kk ij bi translated">在我的例子中，它是子资源“Microsoft”下的属性设置“retentionDays”。SQL/服务器/数据库/backupshorttermtretentionpolicies”。</p><p id="51c8" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在Azure中，<a class="ae lp" href="https://learn.microsoft.com/en-us/azure/azure-sql/database/sql-database-paas-overview?view=azuresql" rel="noopener ugc nofollow" target="_blank"> SQL数据库</a>运行在SQL服务器内部。因此，这两种资源都可能包含在我的策略中。“retentionDays”属性同时位于门户中的SQL数据库和SQL server资源中(下面显示的示例是SQL数据库下的“导出模板”)，但我想直接定位数据库。在这种情况下，策略的目标资源类型将是“Microsoft”。SQL/服务器/数据库”。</p><p id="ff95" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><em class="lo">注意:您也可以选择以Microsoft.Sql/servers,为目标，但是如果您这样做了，您的策略合规性概述会向您指出哪个服务器不合规，而不是哪个数据库不合规。后者是我想要的，所以我用Microsoft.Sql/servers/databases.</em></p><figure class="lr ls lt lu gt lv gh gi paragraph-image"><div role="button" tabindex="0" class="lw lx di ly bf lz"><div class="gh gi lq"><img src="../Images/9a942f25d29c7eba516295b6540aee84.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*frFmf7n4DtvZXUXDyfay2w.png"/></div></div></figure><h1 id="49e3" class="kl km iq bd kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li bi translated">步骤4:使用PowerShell命令“Get-AzPolicyAlias”检查控制后端资源的策略别名。</h1><p id="3180" class="pw-post-body-paragraph jn jo iq jp b jq lj js jt ju lk jw jx jy ll ka kb kc lm ke kf kg ln ki kj kk ij bi translated">Azure策略使用策略别名来引用资源类型属性。神奇的命令是<a class="ae lp" href="https://learn.microsoft.com/en-us/powershell/module/az.resources/get-azpolicyalias?view=azps-9.0.1" rel="noopener ugc nofollow" target="_blank"><strong class="jp ir">Get-azpolicyalas</strong></a>，如果安装了Azure PowerShell模块，可以在Windows终端或Visual Studio代码终端运行。</p><p id="d24e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">您可以使用上面提到的命令列出所有策略别名，这有点大材小用。要缩小别名范围，请与Microsoft进行名称空间匹配。Sql:</p><p id="ff32" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">get-azpolicyalas<strong class="jp ir"><em class="lo">-namespace match微软。Sql </em> </strong></p><p id="9a30" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">然后，过滤掉所有与数据库相关的别名，并展开属性，以便获得一个更好的表:</p><p id="37a5" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">get-AzPolicyAlias-namespace match Microsoft。SQL |<strong class="jp ir"><em class="lo">where resource type-like ' servers/databases * ' | Select-Object-expand property '别名' | Select Name，defaultPath </em> </strong></p><p id="2e6b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">最后但同样重要的是，找出与备份相关的别名:</p><p id="c8e9" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">get-AzPolicyAlias-namespace match Microsoft。SQL |<strong class="jp ir"><em class="lo">where resource type-like ' servers/databases * '</em></strong><em class="lo"/>| Select-Object-expand property ' Aliases ' | where Name-like ' * backup * ' | Select Name，defaultPath</p><p id="c97b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这是上面最后一个命令的输出，突出显示了有问题的别名:</p><figure class="lr ls lt lu gt lv gh gi paragraph-image"><div role="button" tabindex="0" class="lw lx di ly bf lz"><div class="gh gi lq"><img src="../Images/9bdb83200eb917b760dcf82e41039cc0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Pl8cr7LP299H0JiCkR5qGg.png"/></div></div></figure><h1 id="91b2" class="kl km iq bd kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li bi translated">步骤4b:如果您打算使用“修改”或“部署不存在”效果，还要检查预期效果的策略别名是否可修改。</h1><p id="a02e" class="pw-post-body-paragraph jn jo iq jp b jq lj js jt ju lk jw jx jy ll ka kb kc lm ke kf kg ln ki kj kk ij bi translated">在我的组织中，如果可能的话，我们更喜欢“修改”或“部署不存在”,因为它允许部署潜在不符合的资源并随后补救该资源，而不是“拒绝”,这可能会对您的用户产生反作用，因为您完全禁止创建该资源。</p><p id="d590" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">Modify和DeployIfNotExists之间的区别在于，Modify更容易实现，在某种程度上，就像切换开关或更改资源的属性。DeployIfNotExists使用策略中的ARM模板部署资源(或子资源)来修复资源。最好使用Modify，因为它实现起来不太复杂，但是并不是每个别名都可以修改，因此有时DeployIfNotExists是您唯一的选择。</p><p id="7cce" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">长话短说，我想要强制执行的属性是不可修改的。我知道下面的命令没有返回任何结果。该命令基于步骤4中的命令。</p><p id="af73" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">get-AzPolicyAlias-namespace match Microsoft。SQL | Where resource type-like ' * servers/database * ' | Select-Object-expand property Aliases |<strong class="jp ir"><em class="lo">Where-Object { $ _ . default metadata . attributes-eq ' modified ' }</em></strong>| Where Name-like ' * backup * ' | Select Name，DefaultPath</p><p id="8712" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><em class="lo">关于策略效果的说明:关于策略效果的决策不同于类似的资源，我们希望在MySql服务器上实施相同的备份保留策略。对于MySQL服务器，保留天数只能在创建资源时设置，并且在创建资源后不能更改。在这种情况下，审计或拒绝更有意义。</em></p><h1 id="c484" class="kl km iq bd kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li bi translated">第五步:写保单！</h1><p id="926c" class="pw-post-body-paragraph jn jo iq jp b jq lj js jt ju lk jw jx jy ll ka kb kc lm ke kf kg ln ki kj kk ij bi translated">我们现在终于到了制定政策的阶段。策略定义基本上是一个JSON文档，它定义了所有必需的策略步骤。策略的结构记录在<a class="ae lp" href="https://learn.microsoft.com/en-us/azure/governance/policy/concepts/definition-structure" rel="noopener ugc nofollow" target="_blank">这里</a>。</p><p id="9030" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">实际上，您将找到一个(通常是内置的)策略定义，它与您试图实现的内容足够相似，就像这个<a class="ae lp" href="https://learn.microsoft.com/en-us/azure/azure-sql/database/policy-reference?view=azuresql" rel="noopener ugc nofollow" target="_blank">内置的</a>策略<a class="ae lp" href="https://github.com/Azure/azure-policy/blob/master/built-in-policies/policyDefinitions/SQL/GeoRedundant_SQLDatabase_AuditIfNotExists.json" rel="noopener ugc nofollow" target="_blank">这里的</a>关于启用长期地理冗余备份，将它们全部复制，并尝试在那里进行修改。</p><p id="027a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这就是我所做的，我还添加了一个额外的参数，即我希望保留我的保留策略的天数，因为我希望这可以很容易地参数化，并且在我们公司的策略发生变化时可以更改。</p><p id="004e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我的政策初稿是这样的:</p><p id="4fe4" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><em class="lo">(剧透警告，此草稿包含演示故障排除流程的错误。如果你在这里只是为了最终的工作政策，滚动到文章的结尾。)</em></p><pre class="lr ls lt lu gt mc md me bn mf mg bi"><span id="a8f7" class="mh km iq md b be mi mj l mk ml">{<br/>    "properties": {<br/>        "displayName": " SQL DB Backup Retention",<br/>        "policyType": "custom",<br/>        "mode": "Indexed",<br/>        "description": "This policy modifies any Azure SQL Database to ensure a minimum number of retention days for short-term backups.",<br/>        "metadata": {<br/>            "version": "1.0.0",<br/>            "category": "SQL"<br/>        },<br/>        "parameters": {<br/>            "SqlDBBackupRetention.PolicyEffect": {<br/>                "type": "string",<br/>                "defaultValue": "AuditIfNotExists",<br/>                "allowedValues": [<br/>                    "AuditIfNotExists",<br/>                    "DeployIfNotExists",<br/>                    "Disabled"<br/>                ],<br/>                "metadata": {<br/>                    "displayName": " SqlDBBackupRetention.PolicyEffect",<br/>                    "description": "Enable or disable the execution of the policy"<br/>                }<br/>            },<br/>            " SqlDBBackupRetention.RetentionDays": {<br/>                "type": "integer",<br/>                "defaultValue": 7,<br/>                "metadata": {<br/>                    "displayName": " SqlDBBackupRetention.RetentionDays",<br/>                    "description": "Minimum number of days for short-term backup retention"<br/>                }<br/>            }<br/>        },<br/>        "policyRule": {<br/>            "if": {<br/>                "allOf": [<br/>                    {<br/>                        "field": "type",<br/>                        "equals": "Microsoft.Sql/servers/databases"<br/>                    },<br/>                    {<br/>                        "field": "name",<br/>                        "notEquals": "master"<br/>                    }<br/>                ]<br/>            },<br/>            "then": {<br/>                "effect": "[parameters(SqlDBBackupRetention.PolicyEffect')]",<br/>                "details": {<br/>                    "type": "Microsoft.Sql/servers/databases/backupShortTermRetentionPolicies",<br/>                    "name": "default",<br/>                    "existenceCondition": {<br/>                        "anyOf": [<br/>                            {<br/>                                "field": "Microsoft.Sql/servers/databases/backupShortTermRetentionPolicies/retentionDays",<br/>                                "greaterOrEquals": "[parameters(SqlDBBackupRetention.RetentionDays')]"<br/>                            }<br/>                        ]<br/>                    },<br/>                    "deployment": {<br/>                        "properties": {<br/>                            "mode": "incremental",<br/>                            "template": {<br/>                                "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",<br/>                                "contentVersion": "1.0.0.0",<br/>                                "parameters": {<br/>                                    "fullDbName": {<br/>                                        "type": "string"<br/>                                    }<br/>                                },<br/>                                "resources": [<br/>                                    {<br/>                                        "name": "[concat(parameters('fullDbName'), '/default')]",<br/>                                        "type": "Microsoft.Sql/servers/databases/backupShortTermRetentionPolicies",<br/>                                        "apiVersion": "2014-04-01",<br/>                                        "properties": {<br/>                                            "retentionDays": "[parameters('retentionDays')]"<br/>                                        }<br/>                                    }<br/>                                ]<br/>                            },<br/>                            "parameters": {<br/>                                "fullDbName": {<br/>                                    "value": "[field('fullName')]"<br/>                                },<br/>                                "retentionDays": {<br/>                                    "value": "[parameters(SqlDBBackupRetention.RetentionDays')]"<br/>                                }<br/>                            }<br/>                        }<br/>                    }<br/>                }<br/>            }<br/>        }<br/>    },<br/>    "type": "Microsoft.Authorization/policyDefinitions"<br/>}</span></pre><h1 id="7aea" class="kl km iq bd kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li bi translated">步骤6:创建您的策略定义，然后将它分配到期望的范围，最好包含您在步骤2中创建的测试资源。</h1><p id="c469" class="pw-post-body-paragraph jn jo iq jp b jq lj js jt ju lk jw jx jy ll ka kb kc lm ke kf kg ln ki kj kk ij bi translated">你可以通过Azure门户的Policy &gt; Definitions &gt;+Policy definition来实现，也可以通过管道来实现。我不会讨论如何设置管道，因为这超出了本文的范围。也许这是下次的话题。</p><p id="3556" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在测试策略时，我主要想验证两件事:</p><ol class=""><li id="5c0b" class="mm mn iq jp b jq jr ju jv jy mo kc mp kg mq kk mr ms mt mu bi translated">政策正在正确地提高合规性</li><li id="4a36" class="mm mn iq jp b jq mv ju mw jy mx kc my kg mz kk mr ms mt mu bi translated">期望的策略效果，即修改或部署不存在的策略是否正常工作</li></ol><p id="b600" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在分配期间，您还可以提供策略中定义的参数。在我的例子中，我将效果设置为DeployIfNotExists，并将天数设置为7天。</p><h1 id="2442" class="kl km iq bd kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li bi translated">步骤7:检查合规性</h1><p id="e488" class="pw-post-body-paragraph jn jo iq jp b jq lj js jt ju lk jw jx jy ll ka kb kc lm ke kf kg ln ki kj kk ij bi translated">将策略分配给某个范围后，等待合规状态更新。这通常需要一段时间，如果是一项新任务，有时大约需要10分钟。</p><p id="d643" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><em class="lo">附注:对于您已经重复分配但未删除之前分配的保单，合规状态可能需要更长时间才能更新。Azure Policy每24小时自动对策略合规性进行一次重新评估，对于已经评估过的策略，有时似乎没有重新评估，所以拿杯茶或做一些其他工作，或者如果你像我一样不耐烦，就删除分配并再次重新分配相同的策略进行重新评估。</em></p><figure class="lr ls lt lu gt lv gh gi paragraph-image"><div role="button" tabindex="0" class="lw lx di ly bf lz"><div class="gh gi lq"><img src="../Images/024ec6f0b06e50908fb565ed29b4742f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*wKKjHcKtzmYlrLhjeQXPQQ.png"/></div></div></figure><p id="fd8a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">对我来说，我的合规性表似乎运行良好，1个不合规的数据库已被标记出来(我手动将备份天数更改为4)。</p><figure class="lr ls lt lu gt lv gh gi paragraph-image"><div role="button" tabindex="0" class="lw lx di ly bf lz"><div class="gh gi lq"><img src="../Images/20ebf693798d2e8d68c1c71deb1e8782.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Wutyhz5hd4wE35SMcyAhFg.png"/></div></div></figure><p id="4c35" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在同一页面上，如果您单击“Compliance reason”下的“Details ”,您还将能够检查策略评估是否正确，这在我的情况下是正确的，因为已经选择了正确的策略别名。</p><h1 id="c98e" class="kl km iq bd kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li bi translated">步骤7:使用任务修正检查策略效果，部署不存在是否正常工作</h1><p id="c328" class="pw-post-body-paragraph jn jo iq jp b jq lj js jt ju lk jw jx jy ll ka kb kc lm ke kf kg ln ki kj kk ij bi translated">一旦部署了策略，它将对所有创建的新资源生效。测试Modify或DeployIfNotExists效果是否正常工作的一个好方法是使用任务修正，它可以修复在策略生效之前创建的资源。</p><p id="7b02" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">完成合规性评估后，单击策略平面中的“修复”选项。现在，您将为不符合的资源创建一个修正任务。单击要修复的策略定义。</p><p id="1ead" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">为不合规的资源创建补救任务:</p><figure class="lr ls lt lu gt lv gh gi paragraph-image"><div role="button" tabindex="0" class="lw lx di ly bf lz"><div class="gh gi lq"><img src="../Images/c5e0c84475b1440c32b65bf093567e57.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*bgGDedFSz8MSZ90hcgh-Bw.png"/></div></div></figure><h1 id="50e5" class="kl km iq bd kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li bi translated">步骤8:策略修正故障排除</h1><p id="03a3" class="pw-post-body-paragraph jn jo iq jp b jq lj js jt ju lk jw jx jy ll ka kb kc lm ke kf kg ln ki kj kk ij bi translated">在我的案例中，修复任务失败了。这告诉我，我的策略中包含ARM模板的“部署”部分有问题。</p><p id="3f5c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">为了找出问题所在，请打开修复任务，然后单击“相关事件”查看错误消息。</p><figure class="lr ls lt lu gt lv gh gi paragraph-image"><div role="button" tabindex="0" class="lw lx di ly bf lz"><div class="gh gi lq"><img src="../Images/0e0f8bd33312ce0fa50f9a3b06d0a39e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*R7Zuu9BtPuxKVzCk2IXhow.png"/></div></div></figure><figure class="lr ls lt lu gt lv gh gi paragraph-image"><div class="gh gi na"><img src="../Images/1c60cf80ed95c2e0b2acfb79ba0a6243.png" data-original-src="https://miro.medium.com/v2/resize:fit:996/format:webp/1*IOGDSishwjFCpOXXFkWIEQ.png"/></div></figure><p id="7884" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这表示我缺少一个名为retentionDays的参数，这个参数没有提供。是的，我忘了在部署参数中包括这一点:</p><pre class="lr ls lt lu gt mc md me bn mf mg bi"><span id="8acc" class="mh km iq md b be mi mj l mk ml">"parameters": {<br/>                "fullDbName": {<br/>                          "type": "string"<br/>                 },<br/>                 "retentionDays": {<br/>                          "type": "integer"<br/>                 }<br/>},</span></pre><p id="6fb0" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">修正你的政策可能是一个相当重复的过程。它包括修改策略，再次部署和分配它，然后等待评估符合性，以便您可以恢复测试。</p><p id="d899" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">最后，上面的错误并不是我的政策唯一的错误。在修复上面的消息后，我在修复任务中遇到了另一个错误消息，这次是“无效的部署模板”。在困惑了几次之后，我终于想到，也许参数的“整数”类型是无效的，ARM模板的正确类型是“int”。这记录在ARM模板的<a class="ae lp" href="https://learn.microsoft.com/en-us/azure/azure-resource-manager/templates/data-types" rel="noopener ugc nofollow" target="_blank">数据类型</a>页面中。</p><pre class="lr ls lt lu gt mc md me bn mf mg bi"><span id="7397" class="mh km iq md b be mi mj l mk ml">"parameters": {<br/>               "fullDbName": {<br/>                          "type": "string"<br/>                },<br/>                "retentionDays": {<br/>                           "type": "int"<br/>                }<br/>},</span></pre><p id="b4e9" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">修复任务最终成功了:</p><figure class="lr ls lt lu gt lv gh gi paragraph-image"><div role="button" tabindex="0" class="lw lx di ly bf lz"><div class="gh gi lq"><img src="../Images/a418c9754a8f30d61269dd8f98ef8a2a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Pn0mOaReVlnzlu-CAXi68g.png"/></div></div></figure><p id="0502" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我返回到我创建的资源，SQL Server页面中的保留策略确实反映了成功的更改:</p><figure class="lr ls lt lu gt lv gh gi paragraph-image"><div role="button" tabindex="0" class="lw lx di ly bf lz"><div class="gh gi lq"><img src="../Images/786e7419c70215ca23bc32a0b46e88ee.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*7qLRbUTf6LUjPva4hujP_A.png"/></div></div></figure><h1 id="497a" class="kl km iq bd kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li bi translated">第九步:你的政策任务从此幸福生活！或者不是。一些最后的注释…</h1><p id="3958" class="pw-post-body-paragraph jn jo iq jp b jq lj js jt ju lk jw jx jy ll ka kb kc lm ke kf kg ln ki kj kk ij bi translated">很好地完成了部署和测试策略的步骤。如果你已经做到了这一步，我希望你会发现这些步骤很有用，并且能够实现你自己的自定义Azure策略。</p><p id="5fff" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">你可能会忍不住拍拍自己的背，忘记刚刚实施的政策。不幸的是，自定义策略确实需要维护，不像微软的内置策略，如果策略别名或Azure资源本身发生变化，就会维护和更新内置策略。因此，您应该注意为组织内的自定义策略创建策略维护计划。</p><p id="c60b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">另一个最后的提示是，如果你确信你已经撞上了一堵墙，检查这个<a class="ae lp" href="https://github.com/azure/azure-policy#known-issues" rel="noopener ugc nofollow" target="_blank">链接</a>，了解微软针对特定资源记录的已知问题。如果你在那里没有得到任何线索，开一个微软支持票(如果你的组织已经购买了支持计划)也是非常有见地的，因为他们通常会从从事该资源的开发团队那里找到更多。</p><p id="8265" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我希望这篇文章对你有用！如果您对Azure Policy有进一步的问题或意见，请随时在LinkedIn上留言。</p><p id="a52b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">供参考的最终工作政策:</p><pre class="lr ls lt lu gt mc md me bn mf mg bi"><span id="17c6" class="mh km iq md b be mi mj l mk ml">{<br/>    "properties": {<br/>        "displayName": "SQL DB Backup Retention",<br/>        "policyType": "custom",<br/>        "mode": "Indexed",<br/>        "description": "This policy modifies any Azure SQL Database to ensure a minimum number of retention days for short-term backups.",<br/>        "metadata": {<br/>            "version": "1.0.0",<br/>            "category": "SQL"<br/>        },<br/>        "parameters": {<br/>            "SqlDBBackupRetention.PolicyEffect": {<br/>                "type": "string",<br/>                "defaultValue": "DeployIfNotExists",<br/>                "allowedValues": [<br/>                    "AuditIfNotExists",<br/>                    "DeployIfNotExists",<br/>                    "Disabled"<br/>                ],<br/>                "metadata": {<br/>                    "displayName": "SqlDBBackupRetention.PolicyEffect",<br/>                    "description": "Enable or disable the execution of the policy"<br/>                }<br/>            },<br/>            "SqlDBBackupRetention.RetentionDays": {<br/>                "type": "integer",<br/>                "defaultValue": 7,<br/>                "metadata": {<br/>                    "displayName": "SqlDBBackupRetention.RetentionDays",<br/>                    "description": "Minimum number of days for short-term backup retention"<br/>                }<br/>            }<br/>        },<br/>        "policyRule": {<br/>            "if": {<br/>                "allOf": [<br/>                    {<br/>                        "field": "type",<br/>                        "equals": "Microsoft.Sql/servers/databases"<br/>                    },<br/>                    {<br/>                        "field": "name",<br/>                        "notEquals": "master"<br/>                    }<br/>                ]<br/>            },<br/>            "then": {<br/>                "effect": "[parameters('SqlDBBackupRetention.PolicyEffect')]",<br/>                "details": {<br/>                    "type": "Microsoft.Sql/servers/databases/backupShortTermRetentionPolicies",<br/>                    "name": "default",<br/>                    "evaluationDelay": "AfterProvisioning",<br/>                    "roleDefinitionIds": [<br/>                        "/providers/microsoft.authorization/roleDefinitions/9b7fa17d-e63e-47b0-bb0a-15c516ac86ec",<br/>                        "/providers/Microsoft.Authorization/roleDefinitions/056cd41c-7e88-42e1-933e-88ba6a50c9c3"<br/>                    ],<br/>                    "existenceCondition": {<br/>                        "field": "Microsoft.Sql/servers/databases/backupShortTermRetentionPolicies/retentionDays",<br/>                        "greaterOrEquals": "[parameters('SqlDBBackupRetention.RetentionDays')]"<br/>                    },<br/>                    "deployment": {<br/>                        "properties": {<br/>                            "mode": "incremental",<br/>                            "template": {<br/>                                "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",<br/>                                "contentVersion": "1.0.0.0",<br/>                                "parameters": {<br/>                                    "fullDbName": {<br/>                                        "type": "string"<br/>                                    },<br/>                                    "retentionDays": {<br/>                                        "type": "int"<br/>                                    }<br/>                                },<br/>                                "resources": [<br/>                                    {<br/>                                        "type": "Microsoft.Sql/servers/databases/backupShortTermRetentionPolicies",<br/>                                        "name": "[concat(parameters('fullDbName'), '/default')]",<br/>                                        "apiVersion": "2017-10-01-preview",<br/>                                        "properties": {<br/>                                            "retentionDays": "[parameters('retentionDays')]"<br/>                                        }<br/>                                    }<br/>                                ]<br/>                            },<br/>                            "parameters": {<br/>                                "fullDbName": {<br/>                                    "value": "[field('fullName')]"<br/>                                },<br/>                                "retentionDays": {<br/>                                    "value": "[parameters('SqlDBBackupRetention.RetentionDays')]"<br/>                                }<br/>                            }<br/>                        }<br/>                    }<br/>                }<br/>            }<br/>        }<br/>    },<br/>    "type": "Microsoft.Authorization/policyDefinitions"<br/>}</span></pre></div></div>    
</body>
</html>