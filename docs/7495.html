<html>
<head>
<title>State Machine in Elixir using Erlang’s gen_statem Behaviour</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Elixir中的状态机使用Erlang的gen_statem行为</h1>
<blockquote>原文：<a href="https://itnext.io/state-machine-in-elixir-using-erlangs-gen-statem-a3f90d5c536?source=collection_archive---------1-----------------------#2022-10-10">https://itnext.io/state-machine-in-elixir-using-erlangs-gen-statem-a3f90d5c536?source=collection_archive---------1-----------------------#2022-10-10</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><p id="450d" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi ko translated">inite状态机是程序中常见的现象，程序需要维护多个状态，并根据一定的动作在它们之间进行转换。Erlang的<a class="ae kx" href="https://www.erlang.org/doc/man/gen_statem.html" rel="noopener ugc nofollow" target="_blank"> <strong class="js iu"> gen_statem </strong> </a>提供了一个通用的状态机行为。在本文中，我将使用<code class="fe ky kz la lb b"><strong class="js iu">gen_statem</strong></code>实现一个简单的ATM取款状态机。</p><h2 id="658b" class="lc ld it bd le lf lg dn lh li lj dp lk kb ll lm ln kf lo lp lq kj lr ls lt lu bi translated">gen_statem概述</h2><p id="3202" class="pw-post-body-paragraph jq jr it js b jt lv jv jw jx lw jz ka kb lx kd ke kf ly kh ki kj lz kl km kn im bi translated"><code class="fe ky kz la lb b"><strong class="js iu">gen_statem</strong></code>在OTP 19.0中引入。以前，Erlang有用于实现状态机的<code class="fe ky kz la lb b"><strong class="js iu">gen_fsm</strong></code>模块。哪个<code class="fe ky kz la lb b"><strong class="js iu">gen_fsm</strong></code>保留在OTP中，新代码应该使用<code class="fe ky kz la lb b"><strong class="js iu">gen_statem</strong></code>。</p><p id="9da0" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">像Erlang中的任何通用行为一样，<code class="fe ky kz la lb b"><strong class="js iu">gen_statem</strong></code> module提供了许多API和回调函数，这些API和回调函数需要由使用该行为的模块来实现。如该行为的官方手册所述，行为函数和回调之间的关系如下</p><figure class="mb mc md me gt mf gh gi paragraph-image"><div class="gh gi ma"><img src="../Images/1a0eace726cad92aee563502edd25113.png" data-original-src="https://miro.medium.com/v2/resize:fit:1130/format:webp/1*sbvOzWJNMODOHk6GlEhSPg.png"/></div><figcaption class="mi mj gj gh gi mk ml bd b be z dk translated">https://www.erlang.org/doc/man/gen_statem.html</figcaption></figure><p id="3626" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><code class="fe ky kz la lb b"><strong class="js iu">gen_statem</strong></code>支持两种不同的回调模式—</p><ul class=""><li id="24b2" class="mm mn it js b jt ju jx jy kb mo kf mp kj mq kn mr ms mt mu bi translated"><strong class="js iu"> state_functions </strong> —每个状态由一个回调函数表示(<em class="mv">本文将使用这种模式</em>)</li><li id="b84f" class="mm mn it js b jt mw jx mx kb my kf mz kj na kn mr ms mt mu bi translated"><strong class="js iu">handle _ event _ functions</strong>—一个处理所有状态的中央回调函数(<em class="mv">你可以在官方手册中看到这种模式的例子—</em><a class="ae kx" href="https://www.erlang.org/doc/man/gen_statem.html" rel="noopener ugc nofollow" target="_blank"><em class="mv">https://www.erlang.org/doc/man/gen_statem.html</em></a>)</li></ul><p id="277a" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">我觉得<code class="fe ky kz la lb b">state_functions</code>更直观。在本文中，我将使用<code class="fe ky kz la lb b">state_functions</code>和必要的函数和回调来实现下面的ATM取款状态机—</p><figure class="mb mc md me gt mf gh gi paragraph-image"><div role="button" tabindex="0" class="nc nd di ne bf nf"><div class="gh gi nb"><img src="../Images/9370749dc50c25ef3496745c1faa2a01.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*p98wul3cBBI4fZsfr4ju4A.png"/></div></div><figcaption class="mi mj gj gh gi mk ml bd b be z dk translated">src:<a class="ae kx" href="https://andrealeopardi.com/posts/connection-managers-with-gen_statem/" rel="noopener ugc nofollow" target="_blank">https://andrealeopardi . com/posts/connection-managers-with-gen _ statem/</a></figcaption></figure><h2 id="ad48" class="lc ld it bd le lf lg dn lh li lj dp lk kb ll lm ln kf lo lp lq kj lr ls lt lu bi translated">状态和动作</h2><p id="79b6" class="pw-post-body-paragraph jq jr it js b jt lv jv jw jx lw jz ka kb lx kd ke kf ly kh ki kj lz kl km kn im bi translated">重要的是要识别状态和每个状态中可能的动作，以正确地确定状态转换。状态和动作用原子来表示。根据上图，我们可以列出如下的状态和相应的动作。—</p><ul class=""><li id="bb3c" class="mm mn it js b jt ju jx jy kb mo kf mp kj mq kn mr ms mt mu bi translated"><strong class="js iu">:空闲</strong>(初始状态)——动作:<strong class="js iu">:插卡</strong></li><li id="5aa5" class="mm mn it js b jt mw jx mx kb my kf mz kj na kn mr ms mt mu bi translated">:<strong class="js iu">引脚</strong>(等待引脚)—动作:<strong class="js iu">:插入_正确_引脚</strong>，<strong class="js iu">:插入_错误_引脚</strong></li><li id="e0ca" class="mm mn it js b jt mw jx mx kb my kf mz kj na kn mr ms mt mu bi translated">:<strong class="js iu">现金</strong>(等待现金)—动作:<strong class="js iu">插入_金额</strong></li></ul><p id="5482" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">在每个状态中，我还将有一个<strong class="js iu"> :message </strong>动作，返回一个用户友好的状态特定消息，而不改变状态。</p><h2 id="a1ec" class="lc ld it bd le lf lg dn lh li lj dp lk kb ll lm ln kf lo lp lq kj lr ls lt lu bi translated">履行</h2><p id="f6d3" class="pw-post-body-paragraph jq jr it js b jt lv jv jw jx lw jz ka kb lx kd ke kf ly kh ki kj lz kl km kn im bi translated">状态机的完整实现如下所示—</p><figure class="mb mc md me gt mf"><div class="bz fp l di"><div class="ng nh l"/></div></figure><p id="99e2" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">这里—</p><ul class=""><li id="5549" class="mm mn it js b jt ju jx jy kb mo kf mp kj mq kn mr ms mt mu bi translated"><strong class="js iu">第2行</strong>:声明这是<code class="fe ky kz la lb b"><strong class="js iu">gen_statem</strong></code>行为的实现</li><li id="e425" class="mm mn it js b jt mw jx mx kb my kf mz kj na kn mr ms mt mu bi translated"><strong class="js iu">第13行</strong>:从<code class="fe ky kz la lb b"><strong class="js iu">gen_statem</strong></code>模块调用<code class="fe ky kz la lb b"><a class="ae kx" href="https://www.erlang.org/doc/man/gen_statem.html#start-4" rel="noopener ugc nofollow" target="_blank"><strong class="js iu">start/4</strong></a></code>。<strong class="js iu"> start/4 </strong>参数是服务器名称、回调模块、将传递给相应<code class="fe ky kz la lb b"><strong class="js iu">init/1</strong></code>回调的参数、附加选项。</li><li id="d92b" class="mm mn it js b jt mw jx mx kb my kf mz kj na kn mr ms mt mu bi translated"><strong class="js iu">第31行</strong>:执行<strong class="js iu"> start/4 </strong>时调用的<code class="fe ky kz la lb b"><a class="ae kx" href="https://www.erlang.org/doc/man/gen_statem.html#Module:init-1" rel="noopener ugc nofollow" target="_blank"><strong class="js iu">init/1</strong></a></code>回调。<strong class="js iu"> start/4 </strong>会等到<strong class="js iu"> init/1 </strong>完成。正如我们看到的，它返回一个元组的形式—</li></ul><pre class="mb mc md me gt ni lb nj nk aw nl bi"><span id="f409" class="lc ld it lb b gy nm nn l no np">{:ok, :idle, @idle_message}</span></pre><p id="fc52" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">这里，它用<strong class="js iu"> :idle </strong>初始状态初始化状态机。元组中的第三个值称为服务器数据，它不是状态的一部分，但可以用来存储它需要的任何服务器数据。这里，它返回被定义为模块属性的<code class="fe ky kz la lb b"><strong class="js iu">@idle_message</strong></code>。</p><ul class=""><li id="5cff" class="mm mn it js b jt ju jx jy kb mo kf mp kj mq kn mr ms mt mu bi translated"><strong class="js iu">第15行</strong>:从<code class="fe ky kz la lb b"><strong class="js iu">gen_statem</strong></code>模块调用<code class="fe ky kz la lb b"><a class="ae kx" href="https://www.erlang.org/doc/man/gen_statem.html#stop-1" rel="noopener ugc nofollow" target="_blank"><strong class="js iu">stop/1</strong></a></code>。这个调用导致相应的<code class="fe ky kz la lb b"><a class="ae kx" href="https://www.erlang.org/doc/man/gen_statem.html#Module:terminate-3" rel="noopener ugc nofollow" target="_blank"><strong class="js iu">terminate/3</strong></a></code>回调。</li><li id="af09" class="mm mn it js b jt mw jx mx kb my kf mz kj na kn mr ms mt mu bi translated"><strong class="js iu">第33行</strong>:定义<code class="fe ky kz la lb b"><a class="ae kx" href="https://www.erlang.org/doc/man/gen_statem.html#Module:terminate-3" rel="noopener ugc nofollow" target="_blank"><strong class="js iu">terminate/3</strong></a></code>回调，用于在<code class="fe ky kz la lb b"><strong class="js iu">gen_statem</strong></code>停止/终止前做任何必要的清理。</li><li id="a578" class="mm mn it js b jt mw jx mx kb my kf mz kj na kn mr ms mt mu bi translated"><strong class="js iu">第17–28行</strong>:实现之前定义的动作API。每个动作都会导致相应的状态特定的回调函数。我将解释:<strong class="js iu">引脚</strong>状态和附属于它的动作。休息也要类似，容易跟上。</li></ul><p id="a5ff" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">当ATM机处于<strong class="js iu"> pin码</strong>状态时，客户可以使用api -输入pin码</p><pre class="mb mc md me gt ni lb nj nk aw nl bi"><span id="d89e" class="lc ld it lb b gy nm nn l no np">def insert_pin(pin) when is_binary(pin) do<br/>    case correct_pin?(pin) do<br/>      true -&gt; :gen_statem.call(@name, :insert_correct_pin)<br/>      false -&gt; :gen_statem.call(@name, :insert_wrong_pin)<br/>    end<br/>end</span></pre><p id="9197" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">我有一个<strong class="js iu">正确_pin？/1 </strong>本地函数，返回真/假，并基于此调用两个<code class="fe ky kz la lb b"><strong class="js iu">gen_statem</strong></code> <code class="fe ky kz la lb b"><a class="ae kx" href="https://www.erlang.org/doc/man/gen_statem.html#call-2" rel="noopener ugc nofollow" target="_blank"><strong class="js iu">call/2</strong></a></code>函数中的一个。<code class="fe ky kz la lb b"><a class="ae kx" href="https://www.erlang.org/doc/man/gen_statem.html#call-2" rel="noopener ugc nofollow" target="_blank"><strong class="js iu">call/2</strong></a></code>是同步呼叫，等待回复到达。</p><p id="9c33" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">相应的状态回调函数如下所示—</p><pre class="mb mc md me gt ni lb nj nk aw nl bi"><span id="4d63" class="lc ld it lb b gy nm nn l no np">def pin({:call, from}, :insert_correct_pin, _data),<br/>     do: {:next_state, :cash, @cash_message, [{:reply, from, :cash}]}<br/><br/>def pin({:call, from}, :insert_wrong_pin, _data),<br/>     do: {:next_state, :idle, @idle_message, [{:reply, from, :idle}]}</span><span id="50cd" class="lc ld it lb b gy nq nn l no np">def pin(event_type, event_content, data),<br/>     do: handle_event(event_type, event_content, data)</span></pre><p id="a65e" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">根据上述代码片段，如果收到<code class="fe ky kz la lb b"><strong class="js iu">:insert_correct_pin</strong></code>动作，ATM机切换到下一个状态<code class="fe ky kz la lb b"><strong class="js iu">:cash</strong></code>，服务器数据<code class="fe ky kz la lb b"><strong class="js iu">@cash_message</strong></code>。它还用下一个状态(<code class="fe ky kz la lb b">:<strong class="js iu">cash</strong></code>)回复调用者(由<code class="fe ky kz la lb b"><strong class="js iu">from</strong></code>表示)。</p><p id="8bba" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">如果收到<code class="fe ky kz la lb b">:<strong class="js iu">insert_wrong_pin</strong></code>动作，ATM机切换到下一个状态<code class="fe ky kz la lb b">:<strong class="js iu">idle</strong> </code>，服务器数据<code class="fe ky kz la lb b"><strong class="js iu">@idle_message</strong></code>。它还用下一状态(<code class="fe ky kz la lb b"><strong class="js iu">:idle</strong></code> <strong class="js iu"> ) </strong>回复呼叫者(用<code class="fe ky kz la lb b"><strong class="js iu">from</strong></code>表示)。</p><p id="aae0" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">如果执行了其他动作，包括<code class="fe ky kz la lb b"><strong class="js iu">:message</strong></code>动作，则调用内部回退功能<code class="fe ky kz la lb b"><strong class="js iu">handle_event/3</strong>.</code></p><ul class=""><li id="6d8c" class="mm mn it js b jt ju jx jy kb mo kf mp kj mq kn mr ms mt mu bi translated"><strong class="js iu">第58–62行</strong>:实现内部功能<code class="fe ky kz la lb b"><strong class="js iu">handle_event/3</strong></code>。</li></ul><p id="9036" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">由于在任何状态下都可以调用<code class="fe ky kz la lb b">:<strong class="js iu">message</strong></code> action，所以第一个子句将保持当前状态，并用当前状态特定数据(可以是@ idle _ message/@ pin _ message/@ cash _ message之一)进行回复。</p><p id="9942" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">如果采取了某个未知的动作，则调用第二个子句，该子句也保持当前状态。</p><pre class="mb mc md me gt ni lb nj nk aw nl bi"><span id="fc3d" class="lc ld it lb b gy nm nn l no np">defp handle_event({:call, from}, :message, data),<br/>       do: {:keep_state, data, [{:reply, from, data}]}</span><span id="64ba" class="lc ld it lb b gy nq nn l no np">defp handle_event({:call, from}, _, data),<br/>      do: {:keep_state, data, [{:reply, from, data}]}</span></pre><h2 id="6d78" class="lc ld it bd le lf lg dn lh li lj dp lk kb ll lm ln kf lo lp lq kj lr ls lt lu bi translated">样本运行(有效操作)</h2><p id="28f0" class="pw-post-body-paragraph jq jr it js b jt lv jv jw jx lw jz ka kb lx kd ke kf ly kh ki kj lz kl km kn im bi translated">具有有效动作的状态机的示例运行—</p><figure class="mb mc md me gt mf gh gi paragraph-image"><div class="gh gi nr"><img src="../Images/b498947e6f7a8c3a06b9cccc19315327.png" data-original-src="https://miro.medium.com/v2/resize:fit:1092/format:webp/1*6-abc6BKoW2LFST3Zw1b8A.png"/></div></figure><h2 id="c5b4" class="lc ld it bd le lf lg dn lh li lj dp lk kb ll lm ln kf lo lp lq kj lr ls lt lu bi translated">样本运行(无效操作)</h2><p id="6b4a" class="pw-post-body-paragraph jq jr it js b jt lv jv jw jx lw jz ka kb lx kd ke kf ly kh ki kj lz kl km kn im bi translated">带有一些无效操作的状态机运行示例—</p><figure class="mb mc md me gt mf gh gi paragraph-image"><div class="gh gi ns"><img src="../Images/c71f1397a0014c2dd05359a3e25a4f28.png" data-original-src="https://miro.medium.com/v2/resize:fit:1140/format:webp/1*X6zF2Da2ckm82frSPLlHvA.png"/></div></figure><h2 id="6635" class="lc ld it bd le lf lg dn lh li lj dp lk kb ll lm ln kf lo lp lq kj lr ls lt lu bi translated">附加注释</h2><p id="e787" class="pw-post-body-paragraph jq jr it js b jt lv jv jw jx lw jz ka kb lx kd ke kf ly kh ki kj lz kl km kn im bi translated"><code class="fe ky kz la lb b"><strong class="js iu">gen_statem</strong></code>还提供了start的链接版本，名为— <code class="fe ky kz la lb b"><a class="ae kx" href="https://www.erlang.org/doc/man/gen_statem.html#start_link-4" rel="noopener ugc nofollow" target="_blank"><strong class="js iu">start_link</strong></a></code>。如果使用该版本，<code class="fe ky kz la lb b"><strong class="js iu">gen_statem</strong></code>模块应置于监督树下，以便自动重启。还有，对应<code class="fe ky kz la lb b"><strong class="js iu">call</strong></code>函数，有一个异步<code class="fe ky kz la lb b"><a class="ae kx" href="https://www.erlang.org/doc/man/gen_statem.html#cast-2" rel="noopener ugc nofollow" target="_blank"><strong class="js iu">cast/2</strong></a></code>函数，不等待状态回调的回复就立即返回。</p><h2 id="69b6" class="lc ld it bd le lf lg dn lh li lj dp lk kb ll lm ln kf lo lp lq kj lr ls lt lu bi translated"><strong class="ak">结论</strong></h2><p id="5c56" class="pw-post-body-paragraph jq jr it js b jt lv jv jw jx lw jz ka kb lx kd ke kf ly kh ki kj lz kl km kn im bi translated">在本文中，我使用Erlang的<strong class="js iu"> gen_statem </strong>行为实现了一个样本ATM机取款状态机。这个项目的完整代码可以在这里找到—<a class="ae kx" href="https://github.com/imeraj/Elixir_Playground/tree/master/atm_statem" rel="noopener ugc nofollow" target="_blank">https://github . com/imeraj/Elixir _ Playground/tree/master/ATM _ statem</a></p><p id="4a7e" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><em class="mv">更多详细和深入的未来技术帖子请关注我这里或点击</em> <a class="ae kx" href="https://twitter.com/meraj_enigma" rel="noopener ugc nofollow" target="_blank"> <em class="mv"> twitter </em> </a> <em class="mv">。</em></p></div></div>    
</body>
</html>