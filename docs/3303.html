<html>
<head>
<title>Secure Pub/Sub With NATS</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">NATS的安全酒吧/订阅</h1>
<blockquote>原文：<a href="https://itnext.io/secure-pub-sub-with-nats-fcda983d0612?source=collection_archive---------2-----------------------#2019-11-18">https://itnext.io/secure-pub-sub-with-nats-fcda983d0612?source=collection_archive---------2-----------------------#2019-11-18</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="98b7" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">使用TLS和authn/authz设置NATS服务器</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/5788f71b908b73ec31224b8004e53e07.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*NmJrLGLI9zmnnM1zkpstmg.png"/></div></div></figure><p id="8780" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">在本文中，我们将运行一个NATS服务器并保护它；因此，客户端的连接是TLS加密的，最终用户通过JWT认证，只允许对主题进行有限的访问。我们将使用NATS 2.0账户管理功能来隔离信息流。</p><p id="59c8" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">本文分为几个部分:</p><ul class=""><li id="349f" class="lq lr it kw b kx ky la lb ld ls lh lt ll lu lp lv lw lx ly bi translated">一个简单用例的演示</li><li id="a5bd" class="lq lr it kw b kx lz la ma ld mb lh mc ll md lp lv lw lx ly bi translated">服务器证书的创建</li><li id="5cf0" class="lq lr it kw b kx lz la ma ld mb lh mc ll md lp lv lw lx ly bi translated">使用TLS运行NATS服务器</li><li id="7000" class="lq lr it kw b kx lz la ma ld mb lh mc ll md lp lv lw lx ly bi translated">NATS的认证/授权</li><li id="9318" class="lq lr it kw b kx lz la ma ld mb lh mc ll md lp lv lw lx ly bi translated">设置操作员、帐户和用户</li><li id="48f9" class="lq lr it kw b kx lz la ma ld mb lh mc ll md lp lv lw lx ly bi translated">整个设置的测试</li></ul></div><div class="ab cl me mf hx mg" role="separator"><span class="mh bw bk mi mj mk"/><span class="mh bw bk mi mj mk"/><span class="mh bw bk mi mj"/></div><div class="im in io ip iq"><h1 id="d53c" class="ml mm it bd mn mo mp mq mr ms mt mu mv jz mw ka mx kc my kd mz kf na kg nb nc bi translated">一个简单的发布/订阅用例</h1><p id="6f25" class="pw-post-body-paragraph ku kv it kw b kx nd ju kz la ne jx lc ld nf lf lg lh ng lj lk ll nh ln lo lp im bi translated">在之前的文章<a class="ae ni" rel="noopener ugc nofollow" target="_blank" href="/getting-started-with-nats-b752cbb17f74">NATS入门</a>中，我们展示了NATS可用的模式。我们现在将关注发布/订阅。</p><p id="d06f" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">假设我们有一个由几个客户使用的web应用程序。当客户使用浏览器访问应用程序时，它会自动订阅一个WebSocket来接收任何类型的事件通知。为了强化这个过程，并且不过度依赖WebSockets，尤其是在生成大量事件的情况下，我们决定使用NATS消息传递系统来设置发布/订阅。要求非常简单:</p><ul class=""><li id="ac24" class="lq lr it kw b kx ky la lb ld ls lh lt ll lu lp lv lw lx ly bi translated">与此系统的连接必须使用TLS来保护</li><li id="2f2f" class="lq lr it kw b kx lz la ma ld mb lh mc ll md lp lv lw lx ly bi translated">所有连接到消息传递系统的用户都必须经过身份验证</li><li id="75ef" class="lq lr it kw b kx lz la ma ld mb lh mc ll md lp lv lw lx ly bi translated">该应用程序必须使用一个特殊的用户帐户，授权发布任何类型的消息</li><li id="b6af" class="lq lr it kw b kx lz la ma ld mb lh mc ll md lp lv lw lx ly bi translated">该应用程序在“<em class="nj">客户”上发布客户的相关事件。NAME.events" </em> NATS的主题，名称为客户名称</li><li id="726f" class="lq lr it kw b kx lz la ma ld mb lh mc ll md lp lv lw lx ly bi translated">一个客户只能订阅“<em class="nj"> customers.NAME. &gt; </em>”主题，这样才能接收发布在“<em class="nj">客户上的消息。NAME.events" </em>还要将所有消息下发给"<em class="nj">客户。命名</em>“层次结构(以防将来需要)</li></ul><p id="a98a" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">下面的模式给出了由应用程序(<em class="nj">发布者</em>)生成的两条消息的示例。每条消息都发布在一个特定的主题上，包含与该消息相关的客户的名称。每个客户(模式底部的3个虚假公司名称)都订阅了一个专用主题，因此它只能接收通过该主题发送的消息。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nk"><img src="../Images/f2a171e116d825c9961d3f3076015023.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*p0kxgykes2Euw_Qis0RJRg.png"/></div></div><figcaption class="nl nm gj gh gi nn no bd b be z dk translated">消息流隔离的发布/订阅示例</figcaption></figure></div><div class="ab cl me mf hx mg" role="separator"><span class="mh bw bk mi mj mk"/><span class="mh bw bk mi mj mk"/><span class="mh bw bk mi mj"/></div><div class="im in io ip iq"><h1 id="fd12" class="ml mm it bd mn mo mp mq mr ms mt mu mv jz mw ka mx kc my kd mz kf na kg nb nc bi translated">创建服务器证书</h1><p id="0d12" class="pw-post-body-paragraph ku kv it kw b kx nd ju kz la ne jx lc ld nf lf lg lh ng lj lk ll nh ln lo lp im bi translated">为了保护我们的NATS服务器，我们将创建一个x509证书。我们将使用我们自己的自签名证书颁发机构来签署此证书。</p><p id="46f8" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">对于这个任务，我们使用<a class="ae ni" href="https://github.com/cloudflare/cfssl" rel="noopener ugc nofollow" target="_blank"> cfssl </a>，一个来自<a class="ae ni" href="https://cloudflare.com" rel="noopener ugc nofollow" target="_blank"> Cloudflare </a>的TLS工具包。</p><div class="np nq gp gr nr ns"><a href="https://github.com/cloudflare/cfssl" rel="noopener  ugc nofollow" target="_blank"><div class="nt ab fo"><div class="nu ab nv cl cj nw"><h2 class="bd iu gy z fp nx fr fs ny fu fw is bi translated">cloudflare/cfssl</h2><div class="nz l"><h3 class="bd b gy z fp nx fr fs ny fu fw dk translated">CFSSL是CloudFlare的PKI/TLS瑞士军刀。它既是一个命令行工具，也是一个HTTP API服务器，用于签名…</h3></div><div class="oa l"><p class="bd b dl z fp nx fr fs ny fu fw dk translated">github.com</p></div></div><div class="ob l"><div class="oc l od oe of ob og ks ns"/></div></div></a></div><p id="015b" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">注意:我们可以使用<a class="ae ni" href="https://www.openssl.org" rel="noopener ugc nofollow" target="_blank"> OpenSSL </a>命令，但是cfssl工具更友好:)</p><h2 id="15bb" class="oh mm it bd mn oi oj dn mr ok ol dp mv ld om on mx lh oo op mz ll oq or nb os bi translated">认证机构</h2><p id="563f" class="pw-post-body-paragraph ku kv it kw b kx nd ju kz la ne jx lc ld nf lf lg lh ng lj lk ll nh ln lo lp im bi translated">使用cfssl，创建自签名CA很容易，因为它只需要一个如下所示的配置文件。</p><pre class="kj kk kl km gt ot ou ov ow aw ox bi"><span id="25ac" class="oh mm it ou b gy oy oz l pa pb">{<br/>    "CN": "Techwhale CA",<br/>    "key": {<br/>        "algo": "rsa",<br/>        "size": 2048<br/>    },<br/>    "names": [<br/>        {<br/>               "C": "FR",<br/>               "L": "Antibes",<br/>               "O": "Techwhale",<br/>               "ST": "PACA"<br/>        }<br/>    ]<br/>}</span></pre><p id="cc81" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">在这个文件中，我们提供了一个名为Techwhale的虚构公司的信息，该公司位于法国昂蒂布(顺便说一下，是一个伟大的城市:)。我们将这些内容保存在一个<em class="nj"> ca.json </em>文件中，并创建ca:</p><pre class="kj kk kl km gt ot ou ov ow aw ox bi"><span id="4d9d" class="oh mm it ou b gy oy oz l pa pb">$ cfssl gencert -initca ca.json | cfssljson -bare ca</span></pre><p id="6278" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">该命令创建了几个文件:</p><pre class="kj kk kl km gt ot ou ov ow aw ox bi"><span id="62fb" class="oh mm it ou b gy oy oz l pa pb">$ tree .<br/>.<br/>├── ca-key.pem<br/>├── ca.csr<br/>├── ca.json<br/>└── ca.pem</span></pre><p id="4d46" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">我们将在下一部分使用<em class="nj"> ca.pem </em>和<em class="nj"> ca-key.pem </em>来签署服务器证书。</p><h2 id="5493" class="oh mm it bd mn oi oj dn mr ok ol dp mv ld om on mx lh oo op mz ll oq or nb os bi translated">服务器证书</h2><p id="1d98" class="pw-post-body-paragraph ku kv it kw b kx nd ju kz la ne jx lc ld nf lf lg lh ng lj lk ll nh ln lo lp im bi translated">首先，在一个<em class="nj"> config.json </em>配置文件中，我们定义我们想要创建的证书的概要文件。这里只定义了一个配置文件，因为我们将只为服务器创建一个证书。</p><pre class="kj kk kl km gt ot ou ov ow aw ox bi"><span id="e6ab" class="oh mm it ou b gy oy oz l pa pb">{<br/>    "signing": {<br/>        "default": {<br/>            "expiry": "43800h"<br/>        },<br/>        "profiles": {   <br/>            "server": {<br/>                <!-- -->"expiry": "43800h",<br/>                "usages": [<br/>                    "signing",<br/>                    "digital signing",<br/>                    "key encipherment",<br/>                    "server auth"<br/>                ]<br/>            }<br/>        }<br/>    }<br/>}</span></pre><p id="dc0d" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">注意:可以设置mTLS (mutual TLS)连接，这样服务器也可以验证客户端。但是有了mTLS，认证撤销会变得很痛苦。我们将在下面看到，NATS为基于jwt发布的客户端认证提供了一个很好的机制。</p><p id="ce74" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">为了创建服务器的证书，我们首先定义一个<em class="nj"> server.json </em>文件，列出我们希望服务器证书包含的域。在当前示例中，我们假设我们的NATS服务器在域<em class="nj">messaging . tech whale . io .</em>上可用</p><pre class="kj kk kl km gt ot ou ov ow aw ox bi"><span id="53ba" class="oh mm it ou b gy oy oz l pa pb">{<br/>    "CN": "Server",<br/>    "hosts": [<br/>        "127.0.0.1",<br/>        <!-- -->"messaging.techwhale.io"<br/>    ]<br/>}</span></pre><p id="2553" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">接下来，我们生成服务器的证书，并用之前创建的CA对其进行签名。</p><pre class="kj kk kl km gt ot ou ov ow aw ox bi"><span id="7560" class="oh mm it ou b gy oy oz l pa pb">$ cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=config.json \<br/>  -profile=server server.json | cfssljson -bare server</span></pre><p id="4499" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">我们现在已经准备好了CA和服务器证书。</p><pre class="kj kk kl km gt ot ou ov ow aw ox bi"><span id="ae3d" class="oh mm it ou b gy oy oz l pa pb">$ tree .<br/>.<br/>├── <strong class="ou iu">ca-key.pem</strong><br/>├── ca.csr<br/>├── ca.json<br/>├── <strong class="ou iu">ca.pem</strong><br/>├── config.json<br/>├── <strong class="ou iu">server-key.pem</strong><br/>├── server.csr<br/>├── server.json<br/>└── <strong class="ou iu">server.pem</strong></span></pre><p id="9907" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">在下一部分中，我们将使用这些证书(<em class="nj"> *)。pem </em>文件)来保护我们的NATS服务器。</p></div><div class="ab cl me mf hx mg" role="separator"><span class="mh bw bk mi mj mk"/><span class="mh bw bk mi mj mk"/><span class="mh bw bk mi mj"/></div><div class="im in io ip iq"><h1 id="da31" class="ml mm it bd mn mo mp mq mr ms mt mu mv jz mw ka mx kc my kd mz kf na kg nb nc bi translated">使用TLS运行NATS服务器</h1><p id="8764" class="pw-post-body-paragraph ku kv it kw b kx nd ju kz la ne jx lc ld nf lf lg lh ng lj lk ll nh ln lo lp im bi translated">当我们访问一个安全的网站时，我们习惯了TLS。客户端(web浏览器)有一个可信的证书颁发机构列表，其中一个用于签署服务器证书，因此它知道它可以信任服务器。</p><p id="a52b" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">在这篇文章的例子中，我们将设置服务器，以便用它的证书和私钥来配置它。此外，我们将向客户端提供CA，以便它可以对服务器进行身份验证。</p><h2 id="373d" class="oh mm it bd mn oi oj dn mr ok ol dp mv ld om on mx lh oo op mz ll oq or nb os bi translated">服务器配置</h2><p id="b7e2" class="pw-post-body-paragraph ku kv it kw b kx nd ju kz la ne jx lc ld nf lf lg lh ng lj lk ll nh ln lo lp im bi translated">我们将使用下面的<em class="nj"> server.conf </em>文件来配置NATS服务器。</p><pre class="kj kk kl km gt ot ou ov ow aw ox bi"><span id="0895" class="oh mm it ou b gy oy oz l pa pb">listen: 0.0.0.0:4222</span><span id="83ee" class="oh mm it ou b gy pc oz l pa pb">tls: {<br/>  cert_file: "./certs/server.pem"<br/>  key_file: "./certs/server-key.pem"<br/>}</span></pre><p id="12db" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">服务器在TLS握手期间发送其证书(<em class="nj"> server.pem </em>),以便客户端可以验证它已经由它知道的CA签名。</p><p id="50a5" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">然后，我们可以运行服务器:</p><pre class="kj kk kl km gt ot ou ov ow aw ox bi"><span id="29c4" class="oh mm it ou b gy oy oz l pa pb">$ nats-server -c server.conf</span></pre><h2 id="3c5f" class="oh mm it bd mn oi oj dn mr ok ol dp mv ld om on mx lh oo op mz ll oq or nb os bi translated">客户端配置</h2><p id="7c88" class="pw-post-body-paragraph ku kv it kw b kx nd ju kz la ne jx lc ld nf lf lg lh ng lj lk ll nh ln lo lp im bi translated">Python客户端的例子可以在<a class="ae ni" href="https://gitlab.com/lucj/nats-demo/blob/master/consumer-TLS.py" rel="noopener ugc nofollow" target="_blank">https://git lab . com/lucj/NATs-demo/blob/master/consumer-TLS . py</a>找到。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi pd"><img src="../Images/c3c41be43598d703599313d846601acf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*hGNGfcfa3Ap7bZdZrLuEFQ.png"/></div></div><figcaption class="nl nm gj gh gi nn no bd b be z dk translated">通过TLS连接到NATS服务器的示例应用程序代码</figcaption></figure><p id="9bd7" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">从这个片段中，我们可以看到:</p><ul class=""><li id="f523" class="lq lr it kw b kx ky la lb ld ls lh lt ll lu lp lv lw lx ly bi translated">客户端连接到位于<em class="nj"> messaging.techwhale.io </em>上的NATS服务器</li><li id="ecae" class="lq lr it kw b kx lz la ma ld mb lh mc ll md lp lv lw lx ly bi translated">客户端被给予CA ( <em class="nj"> ca.pem) </em>文件。在TLS握手期间，它可以验证服务器提供的证书，确保它已经由该CA签名</li></ul><h2 id="f09a" class="oh mm it bd mn oi oj dn mr ok ol dp mv ld om on mx lh oo op mz ll oq or nb os bi translated">测试连接</h2><p id="4d43" class="pw-post-body-paragraph ku kv it kw b kx nd ju kz la ne jx lc ld nf lf lg lh ng lj lk ll nh ln lo lp im bi translated">我们现在可以运行NATS服务器，并通过TLS连接来连接客户端。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi pe"><img src="../Images/edc5fe389642b0e3e4eb2367ab5773a8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*XBcb37HqOK-pxAWvvUbxqA.png"/></div></div><figcaption class="nl nm gj gh gi nn no bd b be z dk translated">客户端通过TLS连接到NATS服务器</figcaption></figure><p id="8435" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">从上面的服务器日志中，我们可以看到:</p><ul class=""><li id="b2d3" class="lq lr it kw b kx ky la lb ld ls lh lt ll lu lp lv lw lx ly bi translated">服务器启动时会激活TLS选项(“客户端连接需要TLS”)</li><li id="bf40" class="lq lr it kw b kx lz la ma ld mb lh mc ll md lp lv lw lx ly bi translated">客户端可以通过TLS连接(“TLS手动检查完成”)并订阅<em class="nj"> nats.demo </em>主题</li></ul><p id="1029" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">通过这种设置，客户端和NATS服务器之间的通信是加密的。客户端可以对服务器进行身份验证，但是服务器还不能识别客户端。在下一步中，我们将使用NATS 2.0安全模型来设置客户端身份验证(因此服务器知道它可以信任客户端)和授权(因此客户端对它可以发布或订阅的主题具有受限的访问权限)。</p></div><div class="ab cl me mf hx mg" role="separator"><span class="mh bw bk mi mj mk"/><span class="mh bw bk mi mj mk"/><span class="mh bw bk mi mj"/></div><div class="im in io ip iq"><h1 id="c9be" class="ml mm it bd mn mo mp mq mr ms mt mu mv jz mw ka mx kc my kd mz kf na kg nb nc bi translated">NATS的认证/授权</h1><p id="a1e2" class="pw-post-body-paragraph ku kv it kw b kx nd ju kz la ne jx lc ld nf lf lg lh ng lj lk ll nh ln lo lp im bi translated">NATS 2.0采用了一种新的分散式安全模型，其中包含几个分层组织的实体:</p><ul class=""><li id="de45" class="lq lr it kw b kx ky la lb ld ls lh lt ll lu lp lv lw lx ly bi translated">一个<strong class="kw iu">操作员</strong>负责运行一个NATS集群，并签署账户jwt。运营商有一个私钥和一个用该私钥签名的公共JWT</li><li id="e57c" class="lq lr it kw b kx lz la ma ld mb lh mc ll md lp lv lw lx ly bi translated">一个<strong class="kw iu">账户</strong>是通信的隔离层。默认情况下，不同帐户的用户不能通信，但可以在帐户之间安全地共享消息流和服务。由运营商签署的作为公共JWT的账户</li><li id="7e1e" class="lq lr it kw b kx lz la ma ld mb lh mc ll md lp lv lw lx ly bi translated"><strong class="kw iu">用户</strong>由一个账号发布。它定义了关于主题空间的使用和授权的限制。用户作为公共JWT由发行帐户签名。用户的JWT及其私钥保存在一个creds(凭证)文件中，该文件是用户对NATS服务器进行身份验证所需要的全部内容</li></ul><p id="48a0" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">NATS还提供了其他几种验证用户身份的方法:</p><ul class=""><li id="0163" class="lq lr it kw b kx ky la lb ld ls lh lt ll lu lp lv lw lx ly bi translated">令牌认证</li><li id="3a74" class="lq lr it kw b kx lz la ma ld mb lh mc ll md lp lv lw lx ly bi translated">用户名/密码凭据</li><li id="6040" class="lq lr it kw b kx lz la ma ld mb lh mc ll md lp lv lw lx ly bi translated">TLS证书</li><li id="f32f" class="lq lr it kw b kx lz la ma ld mb lh mc ll md lp lv lw lx ly bi translated">有挑战的NKEY</li><li id="29db" class="lq lr it kw b kx lz la ma ld mb lh mc ll md lp lv lw lx ly bi translated">帐目</li></ul><p id="05c1" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">注:如果你想知道更多关于如何使用每个配置选项的信息，你可以参考<a class="ae ni" href="https://docs.nats.io/nats-server/configuration/securing_nats/auth_intro" rel="noopener ugc nofollow" target="_blank">NATS官方文档</a></p><p id="7236" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">在这篇博文的例子中，我们将使用JWT方法来认证系统中的不同实体。那些在NATS被认为是公开的代币(更多信息见<a class="ae ni" href="https://jwt.io/" rel="noopener ugc nofollow" target="_blank">https://jwt.io/</a>)是由<a class="ae ni" href="https://docs.nats.io/nats-tools/nsc" rel="noopener ugc nofollow" target="_blank"> NSC </a>创造的。该工具简化了创建和管理身份和其他JWT工件的任务。默认情况下，jwt保存在<em class="nj"> ~/中。nsc </em>和<em class="nj"> ~/中的秘密。nkeys </em></p></div><div class="ab cl me mf hx mg" role="separator"><span class="mh bw bk mi mj mk"/><span class="mh bw bk mi mj mk"/><span class="mh bw bk mi mj"/></div><div class="im in io ip iq"><h1 id="034d" class="ml mm it bd mn mo mp mq mr ms mt mu mv jz mw ka mx kc my kd mz kf na kg nb nc bi translated">设置操作员、帐户和用户</h1><p id="0f51" class="pw-post-body-paragraph ku kv it kw b kx nd ju kz la ne jx lc ld nf lf lg lh ng lj lk ll nh ln lo lp im bi translated">首先，我们创建一个负责运行NATS服务器的操作员:</p><pre class="kj kk kl km gt ot ou ov ow aw ox bi"><span id="c744" class="oh mm it ou b gy oy oz l pa pb">$ nsc add operator -n op</span></pre><p id="71aa" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">我们可以使用NSC来描述一个实体并获得额外的信息。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi pf"><img src="../Images/a53c521175b8c1bcd9d7127eec5b4844.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*zPBBe1u5GEPlWY_fZjmEiw.png"/></div></div><figcaption class="nl nm gj gh gi nn no bd b be z dk translated">将负责NATS服务器的运营商的详细信息</figcaption></figure><p id="1bfc" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">这里需要注意的重要一点是，<em class="nj">操作者ID </em>与<em class="nj">发行者ID </em>相同，因为操作者已经自己签名。</p><p id="02d7" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">接下来，我们创建一个名为<em class="nj"> admin </em>的帐户，我们将使用这个帐户作为主要实体，稍后我们将在其中定义一个admin用户。</p><pre class="kj kk kl km gt ot ou ov ow aw ox bi"><span id="306a" class="oh mm it ou b gy oy oz l pa pb">$ nsc add account -n admin</span></pre><p id="dd00" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">注意:nsc也可以交互使用，提问各种设置，使用<em class="nj"> -i </em> / <em class="nj"> - interactive </em>标志。</p><pre class="kj kk kl km gt ot ou ov ow aw ox bi"><span id="c12a" class="oh mm it ou b gy oy oz l pa pb">luc@saturn:~$ nsc add account -i<br/>? account name admin<br/>? generate an account nkey Yes<br/>? valid 0<br/>? valid until (0 is always) 0</span></pre><p id="1a8b" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">我们可以像描述操作员一样描述帐户。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi pg"><img src="../Images/99346fc6180803db812011886de5cd1e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*yRmEvqMjjJoSKQSfzXhIUA.png"/></div></div><figcaption class="nl nm gj gh gi nn no bd b be z dk translated">用于管理目的的帐户详细信息</figcaption></figure><p id="7280" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">在上面的输出中，我们可以看到<em class="nj">发行者ID </em>是<em class="nj">操作员ID </em>，因为帐户令牌已经由我们之前创建的操作员签名。从所有的<em class="nj">无限制</em>值中可以看出，在账户级别没有设置特殊配置。我们很快就会回到进口/出口部分。</p><p id="90b1" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">接下来，我们在admin帐户中创建一个用户，并授予其发布和订阅“&gt;”的权限。使用这个特殊的char赋予用户发布和订阅所有可能主题的权利。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ph"><img src="../Images/9772fb7833220512b3597342a8b330fe.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*SXhOn8INlYPN8xYDpId0vg.png"/></div></div><figcaption class="nl nm gj gh gi nn no bd b be z dk translated">在管理员帐户中创建用户</figcaption></figure><p id="974c" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">创建用户时，出现一个<em class="nj">。creds </em>文件被创建(正如我们在上面的命令结果中看到的)。用户将使用其凭据文件对NATS服务器进行身份验证。</p><p id="088d" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">描述用户，我们可以看到它已经由<em class="nj">管理员</em>帐户签名。我们还可以看到它可以发布和订阅的主题。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi pi"><img src="../Images/84e20b211b774bfefdf3709dfe66b654.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*60AJw3_YPZZRiMlciwm4zg.png"/></div></div><figcaption class="nl nm gj gh gi nn no bd b be z dk translated">在管理员帐户中创建的管理员用户的详细信息</figcaption></figure><p id="d0dd" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">接下来，我们为客户创建一个帐户，让我们考虑一个名为OrtizPLC的虚假公司</p><pre class="kj kk kl km gt ot ou ov ow aw ox bi"><span id="24f6" class="oh mm it ou b gy oy oz l pa pb">$ nsc add account -n OrtizPLC</span></pre><p id="fbf0" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">在这个帐户中，我们创建一个名为<em class="nj"> ortiz的用户。</em>我们只希望这个用户能够订阅“<em class="nj">customers . Ortiz PLC .&gt;”</em>subjects(<em class="nj">customers下的所有subjects)。OrtizPLC </em>层级)。此外，它不应该有权发表任何主题。</p><pre class="kj kk kl km gt ot ou ov ow aw ox bi"><span id="998a" class="oh mm it ou b gy oy oz l pa pb">$ nsc add user -a OrtizPLC -n ortiz \<br/>  --deny-pub "&gt;" \<br/>  --allow-sub "customers.OrtizPLC.&gt;"</span></pre><p id="9f58" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">注意:如果用户被拒绝发布任何主题，我们可以给它响应权限，这样它就可以发布到它已经被给予的回复主题(请求/回复模式)。</p><h2 id="cfda" class="oh mm it bd mn oi oj dn mr ok ol dp mv ld om on mx lh oo op mz ll oq or nb os bi translated">快速看一下JWT和恩基斯</h2><p id="7da6" class="pw-post-body-paragraph ku kv it kw b kx nd ju kz la ne jx lc ld nf lf lg lh ng lj lk ll nh ln lo lp im bi translated">在~/内。nsc文件夹中，我们可以看到创建的所有JWT，每个实体一个(1个操作员，2个帐户，每个帐户一个用户)。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi pj"><img src="../Images/a584856af2fc96e0a59d28fd1c96638b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*sagUp8RdqUqoDBhvHQHXZw.png"/></div></div><figcaption class="nl nm gj gh gi nn no bd b be z dk translated">JWT为每个实体创建了</figcaption></figure><p id="2aeb" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">让我们关注一下从<em class="nj"> OrtizPLC </em>账户发出的为<em class="nj"> ortiz </em>用户创建的JWT。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi pk"><img src="../Images/f84feaaec00feb00a0e17bf00a31e4c5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*iDfI4FgeuS3do3TgO0kPqQ.png"/></div></div></figure><p id="ce51" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">从<a class="ae ni" href="https://jwt.io" rel="noopener ugc nofollow" target="_blank"> JWT.io </a>我们可以很容易地解码这个JWT的内容，并得到几个用户相关的信息，其中包括附加给用户的权限:</p><ul class=""><li id="4a65" class="lq lr it kw b kx ky la lb ld ls lh lt ll lu lp lv lw lx ly bi translated">拒绝在'<em class="nj"> &gt; </em>'上发布</li><li id="84d8" class="lq lr it kw b kx lz la ma ld mb lh mc ll md lp lv lw lx ly bi translated">允许订阅'<em class="nj"> customers.OrtizPLC. &gt; </em>'</li></ul><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi pl"><img src="../Images/c534539d24715c9c991780ea71efd66b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*qttallRAcMNgQiQbYhCgLg.png"/></div></div><figcaption class="nl nm gj gh gi nn no bd b be z dk translated">用户ortiz的creds(凭证文件)</figcaption></figure><p id="7567" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">还有，来自<em class="nj"> ~/。nkeys </em>文件夹(其中的所有信息必须保密)我们可以看到为每个用户创建的creds(凭证)文件。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi pj"><img src="../Images/002700d1b7e689743f676d2e1e6ccf01.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*EaDRlM6rOIVWfIp8IdeCpQ.png"/></div></div></figure><p id="d76c" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">让我们仔细看看<em class="nj"> ortiz </em>用户的creds文件的内容。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ph"><img src="../Images/6145dc42cefde2fd20ac4a5cb499921e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*7lwdGHaQduo1OcbTGP0Gaw.png"/></div></div><figcaption class="nl nm gj gh gi nn no bd b be z dk translated">为ortiz用户创建的creds(凭据)文件</figcaption></figure><p id="07c1" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">正如我们所看到的，它包含了它的公共JWT密钥和相关的私有密钥。当用户连接到提供其creds文件的NATS服务器时，因为服务器是在知道运营商的JWT的情况下启动的，所以信任链得到验证。它一直从用户到签署JWT的账户，再到签署账户JWT的运营商。这个信任链允许服务器对用户进行身份验证，并确保它可以信任用户。</p><h2 id="f8ff" class="oh mm it bd mn oi oj dn mr ok ol dp mv ld om on mx lh oo op mz ll oq or nb os bi translated">在帐户之间共享邮件</h2><p id="90c1" class="pw-post-body-paragraph ku kv it kw b kx nd ju kz la ne jx lc ld nf lf lg lh ng lj lk ll nh ln lo lp im bi translated">我们现在要确保<em class="nj"> ortiz </em>用户可以订阅由<em class="nj"> admin </em>用户在“<em class="nj">customers . Ortiz PLC .&gt;</em>”主题上发布的消息。</p><p id="3a27" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">为了在帐户之间共享消息，我们必须从<em class="nj"> admin </em>帐户导出一个流，并将其导入OrtizPLC帐户。</p><ul class=""><li id="c00d" class="lq lr it kw b kx ky la lb ld ls lh lt ll lu lp lv lw lx ly bi translated">创建导出</li></ul><p id="bd1a" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">以下命令从<em class="nj"> admin </em>帐户创建一个<em class="nj">导出</em>。它将允许导入它的帐户订阅“<em class="nj">customers . ortizplc .&gt;</em>”主题。这个<em class="nj">出口</em>是不公开的。</p><pre class="kj kk kl km gt ot ou ov ow aw ox bi"><span id="45c5" class="oh mm it ou b gy oy oz l pa pb">$ nsc add export -a admin -n admin \<br/>  -s "customers.OrtizPLC.&gt;" --private</span></pre><p id="89d4" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">再次描述admin帐户，我们看到一个显示我们刚刚导出的私有流的表格。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi pm"><img src="../Images/e56c6a0d0d3e64c76e251a6b30f0a58f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*EyEE3f_F_5D-NjBfD2CKdQ.png"/></div></div><figcaption class="nl nm gj gh gi nn no bd b be z dk translated">由管理员帐户导出流，以便邮件可以与其他帐户共享</figcaption></figure><p id="e5d2" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">接下来，我们将把这个流导入到<em class="nj"> OrtizPLC </em>账户中。</p><p id="08b6" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">我们首先需要获得OrtizPLC账户的ID</p><pre class="kj kk kl km gt ot ou ov ow aw ox bi"><span id="2ba1" class="oh mm it ou b gy oy oz l pa pb">$ export ID=$(nsc describe account OrtizPLC | grep "Account ID" | awk '{print $5}')</span></pre><p id="aa15" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">然后我们创建一个激活令牌来允许OrtizPLC账户导入流</p><pre class="kj kk kl km gt ot ou ov ow aw ox bi"><span id="6250" class="oh mm it ou b gy oy oz l pa pb">$ nsc generate activation -o activation.jwt \<br/>  --account admin \<br/>  --target-account $ID \ <br/>  --subject "customers.OrtizPLC.&gt;"</span></pre><p id="ec9b" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">使用这个激活令牌，我们可以创建一个到<em class="nj"> OrtizPLC </em>帐户的导入:</p><pre class="kj kk kl km gt ot ou ov ow aw ox bi"><span id="0f10" class="oh mm it ou b gy oy oz l pa pb">$ nsc add import -a OrtizPLC --token activation.jwt</span></pre><p id="3088" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">描述<em class="nj"> OrtiZPLC </em>账户，我们可以看到一个显示可用导入的表格。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi pn"><img src="../Images/0911e906be6ec0e95bea6c9a9ae1ab47.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*iyjnl2vJEEgi6M1CUFF3rw.png"/></div></div><figcaption class="nl nm gj gh gi nn no bd b be z dk translated">导入到OrtizPLC帐户的流</figcaption></figure><p id="ba05" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated"><em class="nj"> OrtizPLC </em>账户内的用户现在可以订阅<em class="nj">" customers . OrtizPLC .&gt;"</em>主题，并接收管理员用户发布的消息。这是我们即将测试的内容。</p><h2 id="98db" class="oh mm it bd mn oi oj dn mr ok ol dp mv ld om on mx lh oo op mz ll oq or nb os bi translated">使用NATS帐户服务器</h2><p id="b1ea" class="pw-post-body-paragraph ku kv it kw b kx nd ju kz la ne jx lc ld nf lf lg lh ng lj lk ll nh ln lo lp im bi translated"><a class="ae ni" href="https://github.com/nats-io/nats-account-server" rel="noopener ugc nofollow" target="_blank"> NATS帐户服务器</a>是一个HTTP服务器，托管和服务用于NATS 2.0帐户认证的jwt。它可以供应几家商店的jwt:</p><ul class=""><li id="8107" class="lq lr it kw b kx ky la lb ld ls lh lt ll lu lp lv lw lx ly bi translated">目录</li><li id="72e2" class="lq lr it kw b kx lz la ma ld mb lh mc ll md lp lv lw lx ly bi translated">NSC目录</li><li id="aa8b" class="lq lr it kw b kx lz la ma ld mb lh mc ll md lp lv lw lx ly bi translated">内存(用于测试目的)</li></ul><p id="350f" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">在下面，我们将运行一个NATS帐户服务器，并配置NATS，以便它从该服务器获取jwt。</p><p id="10b3" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">注意:我们可以设置NATS服务器，使其直接从内存或目录中读取jwt，但是在这种配置中，更新实体需要重新加载服务器。此外，还可以配置NATS，以便在帐户/用户更新时，帐户服务器会自动通知它。</p><p id="bbeb" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">首先，我们使用以下命令检索帐户服务器:</p><pre class="kj kk kl km gt ot ou ov ow aw ox bi"><span id="f5c8" class="oh mm it ou b gy oy oz l pa pb">$ go get github.com/nats-io/nats-account-server</span></pre><p id="de39" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">接下来，我们运行它，为我们之前创建的操作符提供一条路径。</p><pre class="kj kk kl km gt ot ou ov ow aw ox bi"><span id="6586" class="oh mm it ou b gy oy oz l pa pb">$ nats-account-server -nsc ~/.nsc/nats/op</span></pre><p id="0aae" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">注意:帐户服务器也可以从<a class="ae ni" href="https://hub.docker.com/r/synadia/nats-account-server" rel="noopener ugc nofollow" target="_blank"> DockerHub </a>中的容器映像运行</p><p id="7263" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">接下来，为了让NATS服务器从帐户服务器读取jwt，我们需要更新它的配置文件，提供:</p><ul class=""><li id="f9b9" class="lq lr it kw b kx ky la lb ld ls lh lt ll lu lp lv lw lx ly bi translated">对运算符JWT的引用</li><li id="6e1a" class="lq lr it kw b kx lz la ma ld mb lh mc ll md lp lv lw lx ly bi translated">帐户服务器的URL</li></ul><pre class="kj kk kl km gt ot ou ov ow aw ox bi"><span id="37b6" class="oh mm it ou b gy oy oz l pa pb">listen: 0.0.0.0:4222</span><span id="3a4f" class="oh mm it ou b gy pc oz l pa pb"><strong class="ou iu">operator: /Users/luc/.nsc/nats/op/op.jwt<br/>resolver: URL(http://localhost:9090/jwt/v1/accounts/)</strong></span><span id="5334" class="oh mm it ou b gy pc oz l pa pb">tls: {<br/>  cert_file: "./certs/server.pem"<br/>  key_file: "./certs/server-key.pem"<br/>}</span></pre><p id="4b3f" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">然后，我们可以使用这个新配置启动NATS服务器。</p><pre class="kj kk kl km gt ot ou ov ow aw ox bi"><span id="54f8" class="oh mm it ou b gy oy oz l pa pb">$ nats-server -DV -c server.conf</span></pre><p id="b55b" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">在下面的截图中，<em class="nj"> nats-server-account </em>被启动(上图),一个<em class="nj"> nats-server </em>被运行(下图),使用帐户服务器作为身份(JWTs)提供者。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi po"><img src="../Images/24ff189de6493e1f540ba40c4395ecd5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*USLqXEMxQR_otLaXdXw20A.png"/></div></div><figcaption class="nl nm gj gh gi nn no bd b be z dk translated">NATS服务器从帐户服务器获取jwt</figcaption></figure></div><div class="ab cl me mf hx mg" role="separator"><span class="mh bw bk mi mj mk"/><span class="mh bw bk mi mj mk"/><span class="mh bw bk mi mj"/></div><div class="im in io ip iq"><h1 id="37d2" class="ml mm it bd mn mo mp mq mr ms mt mu mv jz mw ka mx kc my kd mz kf na kg nb nc bi translated">测试整个设置</h1><p id="b46a" class="pw-post-body-paragraph ku kv it kw b kx nd ju kz la ne jx lc ld nf lf lg lh ng lj lk ll nh ln lo lp im bi translated">为了确保一切按预期运行，我们现在将:</p><ul class=""><li id="1f3f" class="lq lr it kw b kx ky la lb ld ls lh lt ll lu lp lv lw lx ly bi translated">使用用户<em class="nj"> ortiz </em>进行连接，并订阅“客户。<em class="nj"> OrtizPLC </em>。&gt;“主题</li><li id="0469" class="lq lr it kw b kx lz la ma ld mb lh mc ll md lp lv lw lx ly bi translated">使用用户<em class="nj"> admin </em>进行连接，并发布主题为<em class="nj"> customers的消息。OrtizPLC.events </em></li><li id="4f8d" class="lq lr it kw b kx lz la ma ld mb lh mc ll md lp lv lw lx ly bi translated">确保用户<em class="nj"> ortiz </em>收到消息</li></ul><p id="c8f4" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">用于本测试的示例<em class="nj"> consumer.py </em>和<em class="nj"> producer.py </em> Python客户端可在<a class="ae ni" href="https://gitlab.com/lucj/nats-demo" rel="noopener ugc nofollow" target="_blank">https://gitlab.com/lucj/nats-demo</a>资源库中获得。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi pp"><img src="../Images/3b9b429527eecaf2a0a43778dba5a65a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*rNExjQoh1eWVCiVKKfvohQ.png"/></div></div><figcaption class="nl nm gj gh gi nn no bd b be z dk translated">用户ortiz收到管理员用户发布的主题为<em class="pq"> customers的消息。OrtizPLC.events </em></figcaption></figure><p id="44d8" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">用户<em class="nj"> ortiz </em>只允许订阅一个主题下的<em class="nj">客户。OrtizPLC </em>"层级结构(例如:<em class="nj">客户。OrtizPLC.events </em>，<em class="nj">客户。OrtizPLC.alerts </em>，…)。下面的屏幕截图显示了当它试图订阅属于另一个客户(LynchLLC，可能是它的竞争对手之一)的主题时遇到的错误</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi pp"><img src="../Images/b611bc7d0f441f3d9d9b68b6f92c45d7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*20ayKGQEZ3RKZFbqEjphTA.png"/></div></div><figcaption class="nl nm gj gh gi nn no bd b be z dk translated">用户ortiz试图订阅与另一个客户相关的消息</figcaption></figure></div><div class="ab cl me mf hx mg" role="separator"><span class="mh bw bk mi mj mk"/><span class="mh bw bk mi mj mk"/><span class="mh bw bk mi mj"/></div><div class="im in io ip iq"><h1 id="b251" class="ml mm it bd mn mo mp mq mr ms mt mu mv jz mw ka mx kc my kd mz kf na kg nb nc bi translated">摘要</h1><p id="f4f6" class="pw-post-body-paragraph ku kv it kw b kx nd ju kz la ne jx lc ld nf lf lg lh ng lj lk ll nh ln lo lp im bi translated">我希望这个演练给你一些关于如何设置NATS的发布/订阅消息的见解。我们在本文中使用的方法被定义为“最多一次”传递，因为消息不被消息传递系统保存。在下一篇文章中，我们将关注NATS流，确保消息的持久性，以获得“至少一次”的传递。</p><p id="eece" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">鸣谢:感谢<a class="pr ps ep" href="https://medium.com/u/8bbe93befbfc?source=post_page-----fcda983d0612--------------------------------" rel="noopener" target="_blank">德里克·科利森</a>审阅这篇文章，并帮助我更好地理解NATS的认证模型。</p></div></div>    
</body>
</html>