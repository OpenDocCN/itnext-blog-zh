<html>
<head>
<title>Angular Universal in Production</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">生产中的角度通用</h1>
<blockquote>原文：<a href="https://itnext.io/angular-universal-in-production-8be56b750e92?source=collection_archive---------3-----------------------#2018-04-01">https://itnext.io/angular-universal-in-production-8be56b750e92?source=collection_archive---------3-----------------------#2018-04-01</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/></div><div class="ab cl jn jo hu jp" role="separator"><span class="jq bw bk jr js jt"/><span class="jq bw bk jr js jt"/><span class="jq bw bk jr js"/></div><div class="ij ik il im in"><p id="77b6" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">我目前正在做的一个项目需要使用<a class="ae ks" href="https://universal.angular.io/" rel="noopener ugc nofollow" target="_blank"> Angular Universal </a>服务器端渲染进行SEO优化。虽然有很多很棒的文章可以帮助你开始使用Angular Universal(如果你正在使用Angular CLI，我推荐<a class="ae ks" href="https://github.com/angular/angular-cli/wiki/stories-universal-rendering" rel="noopener ugc nofollow" target="_blank">这篇</a>)，但是没有太多关于在实际生产环境中使用它的信息。在这篇文章中，我将讨论在生产环境中运行Universal时需要考虑的一些额外的事情。四个主要考虑因素是:</p><ul class=""><li id="f005" class="kt ku iq jw b jx jy kb kc kf kv kj kw kn kx kr ky kz la lb bi translated">从CDN而不是通过节点服务器提供静态资产</li><li id="cd64" class="kt ku iq jw b jx lc kb ld kf le kj lf kn lg kr ky kz la lb bi translated">将请求代理到后端API以避免对CORS的需求</li><li id="1a18" class="kt ku iq jw b jx lc kb ld kf le kj lf kn lg kr ky kz la lb bi translated">贮藏</li><li id="570b" class="kt ku iq jw b jx lc kb ld kf le kj lf kn lg kr ky kz la lb bi translated">记录</li></ul><p id="6d05" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">首先要考虑的是，在生产环境中，我们不希望通过通用节点服务器提供静态资产，如图像或CSS和JavaScript文件。我们还希望将请求代理到后端API，以便可以使用相对路径进行API调用，并且可以避免CORS配置。在开发中，我们使用这样的设置通过节点服务器提供静态文件，并代理对后端API的请求，以避免对CORS的需求:</p><pre class="lh li lj lk gt ll lm ln lo aw lp bi"><span id="623c" class="lq lr iq lm b gy ls lt l lu lv">// proxy api requests and serve static files if we're in the development environment<br/>if (environment === 'development') {<br/><br/>    // Serve static files from /browser<br/>    app.get('*.*', express.static(join(DIST_FOLDER, 'browser')));<br/><br/>    const proxy = httpProxy.createProxyServer();<br/>    app.all('/api/*', function (req, res) {<br/>        proxy.web(req, res, {<br/>        target: 'test-docker.learning.com/catalogservice',<br/>        secure: false<br/>        });<br/>    });<br/>}</span></pre><p id="13bc" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">“*”。* '模式意味着任何文件扩展名为(.css，。js，。png等。)将由“浏览器”目录提供，该目录是在编译通用应用程序时创建的，包含客户端Angular应用程序的所有静态文件。<a class="ae ks" href="https://www.npmjs.com/package/http-proxy" rel="noopener ugc nofollow" target="_blank"> http-proxy </a> NPM包用于代理API对后端服务的请求。</p><p id="b961" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">在生产中，我们使用Amazon Cloudfront CDN来提供相同的行为。首先，我们在Cloudfront发行版中为这个通用应用程序设置了三个来源。</p><ol class=""><li id="fc9f" class="kt ku iq jw b jx jy kb kc kf kv kj kw kn kx kr lw kz la lb bi translated">一个自定义原点，指向运行通用节点服务器的主机。</li><li id="9446" class="kt ku iq jw b jx lc kb ld kf le kj lf kn lg kr lw kz la lb bi translated">一个自定义原点，指向运行我们后端API的主机。</li><li id="c36a" class="kt ku iq jw b jx lc kb ld kf le kj lf kn lg kr lw kz la lb bi translated">一个S3源，在那里部署了我们的客户端通用应用程序的静态资产。</li></ol><p id="d74e" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">第二，我们用规则设置了行为，这些规则将请求转发到上面设置的每个源，优先级如下</p><ol class=""><li id="828c" class="kt ku iq jw b jx jy kb kc kf kv kj kw kn kx kr lw kz la lb bi translated">路径模式为“api/*”的行为，指向我们的后端api服务源</li><li id="0b8b" class="kt ku iq jw b jx lc kb ld kf le kj lf kn lg kr lw kz la lb bi translated">路径模式为“*”的行为。*，它指向包含客户端Angular应用程序的S3原点</li><li id="5125" class="kt ku iq jw b jx lc kb ld kf le kj lf kn lg kr lw kz la lb bi translated">指向通用节点服务器源的总括“*”模式。</li></ol><p id="2d15" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">通过这种设置，对应用程序的初始请求将转到通用服务器，并将返回服务器呈现的index.html页面。这种行为还设置了30分钟的TTL，以便对特定页面的任何后续请求都将直接从边缘缓存得到服务，而不是到达我们的通用服务器。一旦页面加载到浏览器中，所有对静态资产和加载客户端应用程序的请求都将转到S3源。最后，来自客户端应用程序的任何API请求都将被代理到我们的后端API服务。这样，所有通过节点服务器的都是初始页面加载请求，所有静态资产都从S3桶提供服务，并缓存在Cloudfront edge服务器上。</p><p id="9d72" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">最后，生产环境中的任何应用程序都需要考虑一个问题，那就是为故障排除提供可靠的日志记录。我们使用ELK栈(Elasticsearch、Logstash、Kibana)进行所有的日志聚合和监控。在我们的万能服务器中，我们为此使用了<a class="ae ks" href="https://www.npmjs.com/package/bunyan" rel="noopener ugc nofollow" target="_blank">班扬</a>和<a class="ae ks" href="https://www.npmjs.com/package/bunyan-elasticsearch" rel="noopener ugc nofollow" target="_blank">班扬-弹性搜索</a>包。该设置如下所示:</p><pre class="lh li lj lk gt ll lm ln lo aw lp bi"><span id="896e" class="lq lr iq lm b gy ls lt l lu lv">// Set up logger<br/>let logger;<br/>const appName = `Catalog Universal Server - ${environment}`;<br/>if (environment !== 'development') {<br/>const esStream = new elasticsearch({<br/>    indexPattern: '[catalog-universal-]YYYY.MM.DD',<br/>    type: environment,<br/>    host: 'http://elk.ldc.aws'<br/>});<br/>esStream.on('error', function (err) {<br/>    console.log('Elasticsearch Stream Error:', err.stack);<br/>});<br/><br/>logger = bunyan.createLogger({<br/>    name: appName,<br/>    streams: [<br/>    { stream: process.stdout },<br/>    { stream: esStream }<br/>    ],<br/>    serializers: bunyan.stdSerializers<br/>});<br/>} else {<br/>    logger = bunyan.createLogger({ name: appName });<br/>}</span></pre><p id="1c3d" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">然后，我们设置bunyan中间件来记录基本的请求数据，如请求IP地址、请求长度、请求持续时间等。</p><pre class="lh li lj lk gt ll lm ln lo aw lp bi"><span id="0025" class="lq lr iq lm b gy ls lt l lu lv">// request logging<br/>app.use(bunyanMiddleware(<br/>    {<br/>        headerName: 'X-Request-Id',<br/>        propertyName: 'reqId',<br/>        logName: 'req_id',<br/>        obscureHeaders: [],<br/>        logger: logger,<br/>        additionalRequestFinishData: function (req, res) {<br/>            return { example: true };<br/>        }<br/>    }<br/>));</span></pre><p id="4a57" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">最后，我们设置了全局错误处理程序来将任何错误记录到bunyan</p><pre class="lh li lj lk gt ll lm ln lo aw lp bi"><span id="e994" class="lq lr iq lm b gy ls lt l lu lv">// Handle errors<br/>app.use((err, req, res, next) =&gt; {<br/>    // log the error<br/>    logger.error(err);<br/>    // pass the error to the default express error handler<br/>    next(err);<br/>});</span></pre><p id="5b08" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">感谢阅读，希望这已经给了你一些关于如何设置一个用于生产的Angular通用应用程序的想法。</p></div><div class="ab cl jn jo hu jp" role="separator"><span class="jq bw bk jr js jt"/><span class="jq bw bk jr js jt"/><span class="jq bw bk jr js"/></div><div class="ij ik il im in"><p id="29d6" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated"><strong class="jw ir">类别:</strong> <a class="ae ks" href="https://tommooney.net/categories/#angular" rel="noopener ugc nofollow" target="_blank">角度</a>，<a class="ae ks" href="https://tommooney.net/categories/#programming" rel="noopener ugc nofollow" target="_blank">编程</a></p><p id="4ee2" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated"><strong class="jw ir">更新:</strong>2018年04月01日</p></div><div class="ab cl jn jo hu jp" role="separator"><span class="jq bw bk jr js jt"/><span class="jq bw bk jr js jt"/><span class="jq bw bk jr js"/></div><div class="ij ik il im in"><p id="5800" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated"><a class="ae ks" href="https://twitter.com/intent/tweet?text=Angular+Universal+in+Production%20https%3A%2F%2Ftommooney.net%2Fprogramming%2Fangular%2Funiversal-in-production%2F" rel="noopener ugc nofollow" target="_blank">推特</a> <a class="ae ks" href="https://www.facebook.com/sharer/sharer.php?u=https%3A%2F%2Ftommooney.net%2Fprogramming%2Fangular%2Funiversal-in-production%2F" rel="noopener ugc nofollow" target="_blank">脸书</a> <a class="ae ks" href="https://plus.google.com/share?url=https%3A%2F%2Ftommooney.net%2Fprogramming%2Fangular%2Funiversal-in-production%2F" rel="noopener ugc nofollow" target="_blank">谷歌+ </a> <a class="ae ks" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3A%2F%2Ftommooney.net%2Fprogramming%2Fangular%2Funiversal-in-production%2F" rel="noopener ugc nofollow" target="_blank">领英</a></p></div><div class="ab cl jn jo hu jp" role="separator"><span class="jq bw bk jr js jt"/><span class="jq bw bk jr js jt"/><span class="jq bw bk jr js"/></div><div class="ij ik il im in"><p id="c9a1" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated"><em class="lx">原载于2018年4月1日</em><a class="ae ks" href="https://tommooney.net/programming/angular/universal-in-production/" rel="noopener ugc nofollow" target="_blank"><em class="lx">【tommooney.net】</em></a><em class="lx">。</em></p></div></div>    
</body>
</html>