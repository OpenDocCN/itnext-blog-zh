<html>
<head>
<title>Interactive R debugger (REPL) for shiny apps</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用于闪亮应用的交互式R调试器(REPL)</h1>
<blockquote>原文：<a href="https://itnext.io/interactive-r-debugger-repl-for-shiny-apps-87c769be4859?source=collection_archive---------7-----------------------#2019-12-20">https://itnext.io/interactive-r-debugger-repl-for-shiny-apps-87c769be4859?source=collection_archive---------7-----------------------#2019-12-20</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="16b5" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我想到这个主意是为了帮助调试R闪亮的应用程序，当它运行时你可以与之交互。当闪亮的应用程序运行时，你可以在R控制台上输入任何内容。</p><p id="e58b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">于是我就想，用JavaScript写的浏览器内部交互shell可以吗？这个帖子是我写这个交互shell的结果。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi kl"><img src="../Images/4f7ef1ae1b12fcaa708d2d3e9ea52d01.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ESdTe_DuO2lwrc-a_qxOpA.png"/></div></div></figure><p id="9e16" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">首先，当我们想要编写R语言解释器时，我们需要eval函数，它将返回一个字符串的结果。这个函数看起来像这样。</p><pre class="km kn ko kp gt kx ky kz la aw lb bi"><span id="f9f1" class="lc ld iq ky b gy le lf l lg lh">r.eval &lt;- <strong class="ky ir">function</strong>(code) {<br/>  paste(capture.output(eval(parse(text = code))), collapse = "\n")<br/>}</span></pre><p id="c6f6" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在，在JavaScript中，我们需要从浏览器向R进程发送我们想要评估的字符串。</p><pre class="km kn ko kp gt kx ky kz la aw lb bi"><span id="88d4" class="lc ld iq ky b gy le lf l lg lh"><strong class="ky ir">var</strong> index = 0;<br/><strong class="ky ir">function</strong> exec(str) {<br/>  <strong class="ky ir">var</strong> id = index++;<br/>  Shiny.onInputChange('__EVAL__', {id: id, value: str});<br/>}</span></pre><p id="5c3a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们使用非常不寻常的事件名称，你应该选择另一个，这样你就不会被黑客攻击，如果有人试图在你的应用程序中公开这个字符串。另一种解决方案是只为特定用户(如开发人员或管理员)添加这些代码。</p><p id="7207" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们以后会改进这个函数，它将是从r返回一个承诺和结果的函数。</p><p id="aeb8" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在我们需要编写observeEvent(在服务器函数内部)，从JavaScript中获取值，在R中计算该值，并将结果发送回浏览器。</p><pre class="km kn ko kp gt kx ky kz la aw lb bi"><span id="9618" class="lc ld iq ky b gy le lf l lg lh">observeEvent(input[["__EVAL__"]], {<br/>  data &lt;- input[["__EVAL__"]]<br/>  tryCatch({<br/>    payload &lt;- list(id = data$id, result = r.eval(data$value))<br/>    session$sendCustomMessage("__EVAL__", payload)<br/>  }, error = function(cond) {<br/>    error &lt;- paste(capture.output(traceback(cond)), collapse = "\n")<br/>    payload &lt;-  list(id = data$id, error = error) <br/>    session$sendCustomMessage("__EVAL__", payload)<br/>  })<br/>})</span></pre><p id="eccb" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在R里面我们什么都有。接下来我们需要更好的JavaScript代码。如果您不关心这些代码，并且想要解决方案，那么最后有一个书签，可以用来创建终端，而无需编写任何JavaScript。</p><p id="8afc" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">对于那些想要跟随的人，我们需要编写更好的exec函数。这是:</p><pre class="km kn ko kp gt kx ky kz la aw lb bi"><span id="ae74" class="lc ld iq ky b gy le lf l lg lh"><strong class="ky ir">var</strong> exec = (<strong class="ky ir">function</strong>() {<br/>  <strong class="ky ir">var</strong> handlers = [];<br/>  <strong class="ky ir">if</strong> (<strong class="ky ir">typeof</strong> Shiny !== 'undefined') {<br/>    Shiny.addCustomMessageHandler("__EVAL__", <strong class="ky ir">function</strong>(data) {<br/>      handlers.forEach(<strong class="ky ir">function</strong>(handler) {<br/>        handler(data);<br/>      });<br/>    });<br/>  }<br/>  <strong class="ky ir">var</strong> index = 0;<br/>  <strong class="ky ir">function</strong> exec(str, callback) {<br/>    <strong class="ky ir">if</strong> (!str.trim()) { // no data<br/>      <strong class="ky ir">return</strong> Promise.resolve();<br/>    }<br/>    <strong class="ky ir">return</strong> <strong class="ky ir">new</strong> Promise(<strong class="ky ir">function</strong>(resolve, reject) {<br/>      <strong class="ky ir">var</strong> id = index++;<br/>      <br/>      handlers.push(<strong class="ky ir">function</strong> handler(data) {<br/>        <strong class="ky ir">if</strong> (data.id === id) {<br/>          <strong class="ky ir">if</strong> (data.error) {<br/>            reject(data.error);<br/>          } <strong class="ky ir">else</strong> {<br/>            resolve(data.result);<br/>          }<br/>        }<br/>        handlers = handlers.filter(<strong class="ky ir">function</strong>(f) {<br/>          <strong class="ky ir">return</strong> f !== handler;<br/>        });<br/>      });<br/>      Shiny.onInputChange('__EVAL__', {id: id, value: str});<br/>    });<br/>  }<br/>  <strong class="ky ir">return</strong> exec;<br/>})();</span></pre><p id="19b7" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">代码使用ES5语法，可以随意重构它以使用ES6 (ES2015)或任何新版本JavaScript。</p><p id="a9ca" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在你可以在JavaScript开发工具控制台writs中评估R代码并得到响应:</p><pre class="km kn ko kp gt kx ky kz la aw lb bi"><span id="3a40" class="lc ld iq ky b gy le lf l lg lh">await exec("10 + 10")<br/>[1] 20</span></pre><p id="1993" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">顶级await可能只在开发人员工具中工作。如果不起作用，您可以使用:</p><pre class="km kn ko kp gt kx ky kz la aw lb bi"><span id="3c51" class="lc ld iq ky b gy le lf l lg lh">exec("10 + 10").then(result =&gt; console.log(result));</span></pre><p id="76bd" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在所有需要做的，就是写一个好看的终端，这样你就可以输入命令并从闪亮的应用程序中得到响应。我会用我的<a class="ae li" href="https://terminal.jcubic.pl/" rel="noopener ugc nofollow" target="_blank"> JavaScript库jQuery终端</a>。</p><p id="0da6" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们需要首先包含库:</p><pre class="km kn ko kp gt kx ky kz la aw lb bi"><span id="9f49" class="lc ld iq ky b gy le lf l lg lh">&lt;script src="<a class="ae li" href="https://unpkg.com/jquery.terminal@2.10.0/js/jquery.terminal.min.js" rel="noopener ugc nofollow" target="_blank">https://unpkg.com/jquery.terminal/js/jquery.terminal.min.js</a>"&gt;&lt;/script&gt;<br/>&lt;link href="<a class="ae li" href="https://unpkg.com/jquery.terminal@2.10.0/js/jquery.terminal.min.js" rel="noopener ugc nofollow" target="_blank">https://unpkg.com/jquery.terminal/css/jquery.terminal.min.</a>css" rel="stylesheet"/&gt;</span></pre><p id="3cae" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们还可以突出显示R语法，这样看起来更好。我们需要这个html包含适当的库:</p><pre class="km kn ko kp gt kx ky kz la aw lb bi"><span id="a55a" class="lc ld iq ky b gy le lf l lg lh">&lt;link href="https://unpkg.com/prismjs/themes/prism-coy.css" rel="stylesheet"/&gt;<br/>&lt;script src="https://unpkg.com/prismjs/prism.js"&gt;&lt;/script&gt;<br/>&lt;script src="https://unpkg.com/jquery.terminal/js/prism.js"&gt;&lt;/script&gt;<br/>&lt;script src="https://unpkg.com/prismjs/components/prism-r.min.js"&gt;&lt;/script&gt;</span></pre><p id="f96c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">添加完依赖项后，我们需要创建终端。我们希望终端在屏幕的底部，所以我们首先编写基本的html结构。</p><pre class="km kn ko kp gt kx ky kz la aw lb bi"><span id="25c1" class="lc ld iq ky b gy le lf l lg lh">&lt;div class="shell-wrapper"&gt;<br/>  &lt;span class="shell-destroy"&gt;[x]&lt;/span&gt;<br/>  &lt;div id="r-term"&gt;&lt;/div&gt;<br/>&lt;/div&gt;</span></pre><p id="f7c1" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在我们需要给出一些风格:</p><pre class="km kn ko kp gt kx ky kz la aw lb bi"><span id="55df" class="lc ld iq ky b gy le lf l lg lh">.terminal {<br/>  <strong class="ky ir">--size</strong>: 1.2;<br/>  <strong class="ky ir">height</strong>: 100%;<br/>}<br/>.shell-wrapper {<br/>  <strong class="ky ir">position</strong>: fixed;<br/>  <strong class="ky ir">z-index</strong>: 99999;<br/>  <strong class="ky ir">bottom</strong>: 0;<br/>  <strong class="ky ir">left</strong>: 0;<br/>  <strong class="ky ir">right</strong>: 0;<br/>  <strong class="ky ir">height</strong>: 150px;<br/>}<br/>.shell-destroy {<br/>  <strong class="ky ir">position</strong>: absolute;<br/>  <strong class="ky ir">right</strong>: 10px;<br/>  <strong class="ky ir">color</strong>: #ccc;<br/>  <strong class="ky ir">top</strong>: 10px;<br/>  <strong class="ky ir">z-index</strong>: 10;<br/>  <strong class="ky ir">cursor</strong>: pointer;<br/>  <strong class="ky ir">font-family</strong>: monospace;<br/>}</span></pre><p id="cbcb" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在最后的部分是创建具有交互式R shell的终端。</p><pre class="km kn ko kp gt kx ky kz la aw lb bi"><span id="8414" class="lc ld iq ky b gy le lf l lg lh"><strong class="ky ir">var</strong> term = $('#r-term').terminal(<strong class="ky ir">function</strong>(cmd, term) {<br/>  <strong class="ky ir">if</strong> (!cmd.trim()) {<br/>    // we ignore empty command but exec will also handle that<br/>    <strong class="ky ir">return</strong>;<br/>  }<br/>  <strong class="ky ir">return</strong> exec(cmd).then(<strong class="ky ir">function</strong>(result) {<br/>    result = result.trim();<br/>    <strong class="ky ir">if</strong> (result) {<br/>      term.echo($.terminal.escape_brackets(result));<br/>    }<br/>  }).catch(<strong class="ky ir">function</strong>(e) {<br/>    term.error(e);<br/>  });<br/>}, {<br/>  greetings: 'R console\n'<br/>});</span></pre><p id="2829" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在你在浏览器中有了真正终端，用JavaScript给你真正的交互式会话。</p><p id="de2c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">你也可以用一个叫做tilda的插件来代替上面的代码，你只需要用tilda来代替终端。你的应用程序中会有类似雷神之锤的控制台，当你按下键盘上的tidla ~时就会打开。</p><p id="37f5" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">Tidla可以在<a class="ae li" href="https://github.com/jcubic/jquery.terminal/blob/master/examples/tilda-demo.html" rel="noopener ugc nofollow" target="_blank"> GitHub上找到，作为jQuery终端示例之一</a>。像R控制台一样添加Quake是留给读者的练习。</p><p id="3f13" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">正如我所承诺的,<a class="ae li" href="https://gist.github.com/jcubic/665c15b9867ef8d0d6f6f2f4509fa1f7" rel="noopener ugc nofollow" target="_blank">这里是书签的链接,</a>,它看起来不是很好，但它有这篇文章的所有内容。它加载所有的文件，你可以点击它多次，它会破坏以前的终端。</p><p id="c4e3" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">更新:</strong></p><p id="1e35" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">当我将这个调试器集成到我闪亮的应用程序中时，我做了一些改进，我想分享一下。</p><p id="f96e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我创建了两个函数<strong class="jp ir"> debugger.init() </strong>和<strong class="jp ir"> debugger() </strong>。Init应该在服务器函数内部调用，因为它需要<strong class="jp ir">输入</strong>和<strong class="jp ir">会话</strong>。而调试器功能可以用来改变上下文，解释器在计算表达式，就像<strong class="jp ir"> browser() </strong>一样，但是app还在运行。</p><p id="e6d5" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这是代码，可以放在一个包里。</p><pre class="km kn ko kp gt kx ky kz la aw lb bi"><span id="f728" class="lc ld iq ky b gy le lf l lg lh">#' To use Debugger you need to call debugger.init(input, session)<br/>#' inside shiny server function. Then you need complementary JS code<br/>#' that is avaiable as bookmarklet. Then in any context you can<br/>#' call debugger function to change the context (it's optional).<br/>#' If you call that function in constructor  you will be able <br/>#' to access self and private properties of the object.</span><span id="70c0" class="lc ld iq ky b gy lj lf l lg lh">#' eval to string function that work the same as R REPL<br/>#' <a class="ae li" href="http://twitter.com/param" rel="noopener ugc nofollow" target="_blank"><strong class="ky ir">@param</strong></a> code - string to evaluate<br/>#' <a class="ae li" href="http://twitter.com/param" rel="noopener ugc nofollow" target="_blank"><strong class="ky ir">@param</strong></a> env - enviroment in which to evaluate the code<br/>#' <a class="ae li" href="http://twitter.com/export" rel="noopener ugc nofollow" target="_blank"><strong class="ky ir">@export</strong></a><br/>r.eval &lt;- function(code, env = parent.frame()) {<br/>  paste(<br/>    capture.output(eval(parse(text = code), envir = env)),<br/>    collapse = "\n"<br/>  )<br/>}</span><span id="e35c" class="lc ld iq ky b gy lj lf l lg lh">#' debugger environment<br/>.global &lt;- list2env(list(env = NULL))</span><span id="7c2b" class="lc ld iq ky b gy lj lf l lg lh">#' function to use instead of browser() and put context of debugger in this place<br/>#'<strong class="ky ir"> </strong><a class="ae li" href="http://twitter.com/export" rel="noopener ugc nofollow" target="_blank"><strong class="ky ir">@export</strong></a><br/>debugger &lt;- function() {<br/>   .global$env &lt;- parent.frame()<br/>}</span><span id="693d" class="lc ld iq ky b gy lj lf l lg lh">#' Initialization of the debugger<br/>#' <a class="ae li" href="http://twitter.com/param" rel="noopener ugc nofollow" target="_blank"><strong class="ky ir">@param</strong></a> input - shiny input<br/>#' <a class="ae li" href="http://twitter.com/param" rel="noopener ugc nofollow" target="_blank"><strong class="ky ir">@param</strong></a><strong class="ky ir"> </strong>session - shiny session<br/>#' <a class="ae li" href="http://twitter.com/export" rel="noopener ugc nofollow" target="_blank"><strong class="ky ir">@export</strong></a><br/>debugger.init &lt;- <strong class="ky ir">function</strong>(input, session, env = parent.frame()) {<br/>  .global$env &lt;- env<br/>  shiny::observeEvent(input[["__EVAL__"]], {<br/>    data &lt;- input[["__EVAL__"]]<br/>    tryCatch({<br/>      payload &lt;- list(<br/>        id = data$id,<br/>        result = r.eval(data$value, env = .global$env)<br/>      )<br/>      session$sendCustomMessage("__EVAL__", payload)<br/>    }, error = function(cond) {<br/>      error &lt;- paste(<br/>          capture.output(traceback(cond)),<br/>          collapse = "\n"<br/>      )<br/>      payload &lt;-  list(id = data$id, error = error)<br/>      session$sendCustomMessage("__EVAL__", payload)<br/>    })<br/>  })<br/>}</span></pre></div></div>    
</body>
</html>