<html>
<head>
<title>Running Envoy API Gateways on Kubernetes or Consul or both</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在Kubernetes或Consul或两者上运行Envoy API网关</h1>
<blockquote>原文：<a href="https://itnext.io/running-envoy-api-gateways-on-kubernetes-or-consul-or-both-7a22deb27312?source=collection_archive---------4-----------------------#2019-08-16">https://itnext.io/running-envoy-api-gateways-on-kubernetes-or-consul-or-both-7a22deb27312?source=collection_archive---------4-----------------------#2019-08-16</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="d8e0" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">业界已经将<a class="ae kl" href="https://medium.com/solo-io/guidance-for-building-a-control-plane-to-manage-envoy-proxy-at-the-edge-as-a-gateway-or-in-a-mesh-badb6c36a2af" rel="noopener">特使代理</a>作为L7网络的事实上的数据平面代理。你会发现Envoy作为数据层运行于许多不同的<a class="ae kl" href="https://www.consul.io/docs/connect/index.html" rel="noopener ugc nofollow" target="_blank">服务网格实现</a>以及入口和<a class="ae kl" href="https://medium.com/solo-io/decentralized-approach-to-api-gateways-for-openshift-on-your-way-to-service-mesh-cd3b4892c73f" rel="noopener">分散API网关解决方案</a>。如今，Envoy如此受欢迎的最大原因之一是它的<a class="ae kl" href="https://blog.envoyproxy.io/the-universal-data-plane-api-d15cec7a" rel="noopener ugc nofollow" target="_blank">可插拔控制平面的开放接口</a>。</p><p id="63dd" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">Envoy使用其xDS接口在运行时动态地控制代理的方方面面。这意味着你可以有一个<a class="ae kl" href="https://medium.com/solo-io/guidance-for-building-a-control-plane-for-envoy-part-4-build-for-extensibility-40f8ac8e48e" rel="noopener">可插拔的实现，用于服务发现、路由和安全</a>。要实现这一点，您需要有一个控制平面，可以插入这些不同的后端，并通过xDS提供正确的特使配置。</p><p id="1aa5" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><a class="ae kl" href="https://gloo.solo.io" rel="noopener ugc nofollow" target="_blank"> Gloo是来自<a class="ae kl" href="https://www.solo.io" rel="noopener ugc nofollow" target="_blank"> Solo.io </a>的一个开源API Gateway </a>项目，它构建在Envoy Proxy之上，具体工作如下:它为控制平面提供了一个<a class="ae kl" href="https://medium.com/solo-io/guidance-for-building-a-control-plane-for-envoy-part-4-build-for-extensibility-40f8ac8e48e" rel="noopener">清晰的关注点分离，并允许您根据自己的环境来构建控制平面。</a>没有两个环境和进程是完全相同的，因此Gloo遵循<a class="ae kl" href="https://en.wikipedia.org/wiki/Open%E2%80%93closed_principle" rel="noopener ugc nofollow" target="_blank">“开放-封闭”原则</a>，其中核心是封闭的，以便进行修改，但我们可以通过用插件扩展它来丰富它的功能。这种方法在<a class="ae kl" href="https://medium.com/solo-io/guidance-for-building-a-control-plane-to-manage-envoy-proxy-at-the-edge-as-a-gateway-or-in-a-mesh-badb6c36a2af" rel="noopener">构建控制平面管理特使</a>指南中有详细讨论。</p><p id="5db1" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这种可扩展性的一个例子是在Kubernetes中使用CRDs(<a class="ae kl" href="https://kubernetespodcast.com/episode/041-ingress/" rel="noopener ugc nofollow" target="_blank">not hacky annotations</a>)本地运行Gloo，或者在Kubernetes之外使用类似的声明性配置独立运行Gloo。我们可以利用<a class="ae kl" href="https://www.vaultproject.io" rel="noopener ugc nofollow" target="_blank">金库</a>和<a class="ae kl" href="https://www.consul.io" rel="noopener ugc nofollow" target="_blank">领事</a>项目，从我们在<a class="ae kl" href="https://www.hashicorp.com" rel="noopener ugc nofollow" target="_blank"> Hashicorp </a>的朋友那里让这一切发生。<a class="ae kl" href="https://medium.com/solo-io/guidance-for-building-a-control-plane-for-envoy-part-5-deployment-tradeoffs-a6ef55c06327" rel="noopener">使用Gloo作为特使</a>的控制平面，我们可以利用这两个重要的用例:</p><ol class=""><li id="d158" class="km kn iq jp b jq jr ju jv jy ko kc kp kg kq kk kr ks kt ku bi translated">在Kubernetes内部或外部运行API网关</li><li id="2ada" class="km kn iq jp b jq kv ju kw jy kx kc ky kg kz kk kr ks kt ku bi translated">路由到Kubernetes内部或外部的服务</li></ol><p id="17f1" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">用例2与Gloo关系密切，因此得名。Gloo打算提供L7网络控制和可观测性，以统一混合环境(运行虚拟机、容器，甚至<a class="ae kl" href="https://gloo.solo.io/gloo_routing/virtual_services/routes/route_destinations/single_upstreams/function_routing/" rel="noopener ugc nofollow" target="_blank">FaaS/λ</a>)。让我们更仔细地看看用Consul和Vault解决这两个用例。</p><h1 id="1693" class="la lb iq bd lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx bi translated">在Kubernetes之外运行我们的API网关</h1><p id="612b" class="pw-post-body-paragraph jn jo iq jp b jq ly js jt ju lz jw jx jy ma ka kb kc mb ke kf kg mc ki kj kk ij bi translated">Kubernetes为Gloo(以及一般的应用程序)提供了一些很好的操作简化。Kubernetes拥有良好的声明式配置结构、服务发现机制、存储和秘密API等。如果我们选择在Kubernetes之外运营，我们需要有一种方法:</p><ul class=""><li id="d8a7" class="km kn iq jp b jq jr ju jv jy ko kc kp kg kq kk md ks kt ku bi translated">定义我们的声明性配置</li><li id="9d05" class="km kn iq jp b jq kv ju kw jy kx kc ky kg kz kk md ks kt ku bi translated">存储我们的声明性配置</li><li id="d32b" class="km kn iq jp b jq kv ju kw jy kx kc ky kg kz kk md ks kt ku bi translated">储存我们的秘密和钥匙</li></ul><p id="131c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">使用Gloo与领事和金库，我们可以做到这一点。</p><figure class="mf mg mh mi gt mj gh gi paragraph-image"><div class="gh gi me"><img src="../Images/57ff8a4dd3ff53ec3754199b741e207a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1042/format:webp/1*cjSWI3xI00dexx1H58xTMw.png"/></div></figure><p id="259e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在此模型中，Gloo被配置为使用Consul作为路由配置的后备存储，并使用Vault来存储/访问机密(即，设置TLS、与Lambda对话等所需的密钥)</p><p id="4791" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">用户以声明格式指定他们的配置(类似于Kubernetes资源), Gloo具体化配置。当直接与Consul对话时，用户可以做类似这样的事情:</p><pre class="mf mg mh mi gt mm mn mo mp aw mq bi"><span id="e4cc" class="mr lb iq mn b gy ms mt l mu mv">curl -v <strong class="mn ir">\<br/></strong>    -XPUT <strong class="mn ir">\<br/></strong>    --data-binary "@&lt;resource yaml file&gt;.yaml" <strong class="mn ir">\<br/></strong>    "http://127.0.0.1:8500/v1/kv/gloo/&lt;resource group&gt;/&lt;group version&gt;/&lt;resource kind&gt;/&lt;namespace&gt;/&lt;name&gt;"</span></pre><p id="090a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这将插入Gloo配置到领事和Gloo将阅读它，并提交给特使。请参见<a class="ae kl" href="https://gloo.solo.io/advanced_configuration/consul_kv/" rel="noopener ugc nofollow" target="_blank">关于Consul后端的文档以了解更多</a>。</p><h1 id="7795" class="la lb iq bd lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx bi translated">路由到Kubernetes以外的服务</h1><p id="a4f4" class="pw-post-body-paragraph jn jo iq jp b jq ly js jt ju lz jw jx jy ma ka kb kc mb ke kf kg mc ki kj kk ij bi translated">另一个非常重要的企业用例是使用多个不同来源进行服务发现的能力。当在Kubernetes中运行时，我们获得了内置的服务发现，但是组织可能使用Consul(或其他方法)来发现我们希望融入L7应用程序网络控制(服务网格或API网关)的服务。使用Gloo，我们可以将Consul配置为服务发现源，并路由到这些服务。</p><figure class="mf mg mh mi gt mj gh gi paragraph-image"><div role="button" tabindex="0" class="mx my di mz bf na"><div class="gh gi mw"><img src="../Images/787389eb12148f24e19a52684a14307e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*XNC3vhmVImAgswUa3yW1kA.png"/></div></div></figure><p id="ae06" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">向Consul注册的服务可以在任何地方运行:虚拟机、容器、物理机器等。如果在EC2上运行，<a class="ae kl" href="https://gloo.solo.io/gloo_routing/virtual_services/routes/route_destinations/single_upstreams/ec2_upstream/" rel="noopener ugc nofollow" target="_blank"> Gloo也支持直接EC2发现</a>。</p><p id="a32c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">有关路由到领事注册服务的更多信息，请参见文档。</p><h1 id="4890" class="la lb iq bd lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx bi translated">包扎</h1><p id="32e0" class="pw-post-body-paragraph jn jo iq jp b jq ly js jt ju lz jw jx jy ma ka kb kc mb ke kf kg mc ki kj kk ij bi translated">Envoy是一个通用的L7数据平面，只要您的控制平面能够支持它。Gloo支持在Kubernetes内部以及在Consul和Vault的帮助下在Kubernetes外部运行。请<a class="ae kl" href="https://gloo.solo.io" rel="noopener ugc nofollow" target="_blank">看看Gloo </a>项目，看看一个现代的、<a class="ae kl" href="https://medium.com/solo-io/decentralized-approach-to-api-gateways-for-openshift-on-your-way-to-service-mesh-cd3b4892c73f" rel="noopener">分散式API网关</a>是什么样子的，它建立在支持多平台的Envoy之上。请在<a class="ae kl" href="http://slack.solo.io" rel="noopener ugc nofollow" target="_blank"> Slack </a>或Twitter上关注<a class="ae kl" href="https://twitter.com/christianposta" rel="noopener ugc nofollow" target="_blank">@ Christian posta</a><a class="ae kl" href="https://twitter.com/soloio_inc" rel="noopener ugc nofollow" target="_blank">@ solio _ Inc</a>了解更多信息！</p></div><div class="ab cl nb nc hu nd" role="separator"><span class="ne bw bk nf ng nh"/><span class="ne bw bk nf ng nh"/><span class="ne bw bk nf ng"/></div><div class="ij ik il im in"><p id="d7d0" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><em class="ni">原载于2019年8月16日</em><a class="ae kl" href="https://medium.com/solo-io/running-envoy-api-gateways-on-kubernetes-or-consul-or-both-f195eede19c1" rel="noopener"><em class="ni">https://medium.com</em></a><em class="ni">。</em></p></div></div>    
</body>
</html>