<html>
<head>
<title>How to build a React Hook to make AJAX calls</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何构建一个React钩子来调用AJAX</h1>
<blockquote>原文：<a href="https://itnext.io/how-to-create-a-react-hook-to-make-ajax-calls-5d5052e08269?source=collection_archive---------1-----------------------#2020-04-16">https://itnext.io/how-to-create-a-react-hook-to-make-ajax-calls-5d5052e08269?source=collection_archive---------1-----------------------#2020-04-16</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><figure class="gl gn jr js jt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi jq"><img src="../Images/8fc3de0d1402d88242f06941e0932181.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*qmu6NGdViY3bpdRMRNmvgA.png"/></div></div></figure><p id="903e" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">今天，我们将创建一个简单的钩子，它可以在我的React项目中每天帮助我，包括web和react-native:一个钩子可以进行Ajax调用并返回响应。</p><p id="48cb" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">为了测试这个钩子，我们将构建一个简单的应用程序，显示由<a class="ae kz" href="https://www.anapioficeandfire.com" rel="noopener ugc nofollow" target="_blank">https://www.anapioficeandfire.com</a>提供的《权力的游戏》中的所有房子。</p><p id="6a6c" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">总而言之，这就是我们在本文中要做的事情:</p><ul class=""><li id="a8e7" class="la lb it kd b ke kf ki kj km lc kq ld ku le ky lf lg lh li bi translated">创建新的React挂钩</li><li id="ab02" class="la lb it kd b ke lj ki lk km ll kq lm ku ln ky lf lg lh li bi translated">这个钩子将接受一个要获取的URL和一系列选项(查询、方法和主体)</li><li id="cec0" class="la lb it kd b ke lj ki lk km ll kq lm ku ln ky lf lg lh li bi translated">这个钩子将返回一个带有AJAX响应、加载和错误布尔值的对象</li><li id="15e1" class="la lb it kd b ke lj ki lk km ll kq lm ku ln ky lf lg lh li bi translated">每次钩子的一个选项改变时，钩子将再次获取URL</li><li id="cd95" class="la lb it kd b ke lj ki lk km ll kq lm ku ln ky lf lg lh li bi translated">创建一个演示应用程序来测试这个useFetch挂钩</li></ul><h1 id="800d" class="lo lp it bd lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml bi translated">首先，让我们创建骨架应用程序☠️</h1><p id="94f3" class="pw-post-body-paragraph kb kc it kd b ke mm kg kh ki mn kk kl km mo ko kp kq mp ks kt ku mq kw kx ky im bi translated">我想在过去的几年里我已经做了300次了，但是我总是发现自己在谷歌上搜索正确的命令来使用create-react-app。我想我对这个简单的命令有某种选择性遗忘…所以这部分更多是给未来的我而不是你:)</p><figure class="mr ms mt mu gt ju"><div class="bz fp l di"><div class="mv mw l"/></div></figure><p id="d8aa" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">安装完所有正确的模块后，我们进入<a class="ae kz" href="https://localhost:3000" rel="noopener ugc nofollow" target="_blank"> https://localhost:3000 </a>，应用程序开始运行:)</p><figure class="mr ms mt mu gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi mx"><img src="../Images/e643f0a9d72bc42b567679a26bc6b713.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*UXasrHzlfzae04lxnOJeDg.png"/></div></div></figure><h1 id="805e" class="lo lp it bd lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml bi translated">创建钩子</h1><p id="dd4f" class="pw-post-body-paragraph kb kc it kd b ke mm kg kh ki mn kk kl km mo ko kp kq mp ks kt ku mq kw kx ky im bi translated">让我们首先在<code class="fe my mz na nb b">src</code>中创建一个名为<code class="fe my mz na nb b">hooks</code>的文件夹，并在其中创建一个名为<code class="fe my mz na nb b">useFetch.js</code>的文件。</p><figure class="mr ms mt mu gt ju"><div class="bz fp l di"><div class="mv mw l"/></div></figure><p id="34ba" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">我们将在文件中放入:</p><figure class="mr ms mt mu gt ju"><div class="bz fp l di"><div class="mv mw l"/></div></figure><p id="df96" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">让我们一起来看看我们钩子的代码。这里我不打算解释两个效用函数，但是如果你需要任何帮助，你可以随时<a class="ae kz" href="https://twitter.com/urcoilbisurco" rel="noopener ugc nofollow" target="_blank">联系我</a>并询问:)</p><p id="7652" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">我们将一部分一部分地探索这个钩子:</p><figure class="mr ms mt mu gt ju"><div class="bz fp l di"><div class="mv mw l"/></div></figure><p id="f7c1" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">钩子将接受两个参数:</p><ul class=""><li id="8ea4" class="la lb it kd b ke kf ki kj km lc kq ld ku le ky lf lg lh li bi translated">一个网址</li><li id="611e" class="la lb it kd b ke lj ki lk km ll kq lm ku ln ky lf lg lh li bi translated">一个“选项”对象，里面会有</li><li id="9715" class="la lb it kd b ke lj ki lk km ll kq lm ku ln ky lf lg lh li bi translated">一个HTTP方法(GET，POST)</li><li id="6015" class="la lb it kd b ke lj ki lk km ll kq lm ku ln ky lf lg lh li bi translated">一个体，如果你要用POST方法的话</li><li id="2bf0" class="la lb it kd b ke lj ki lk km ll kq lm ku ln ky lf lg lh li bi translated">一个查询，您将在其中放置AJAX调用的所有查询参数。</li></ul><p id="a9d0" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated"><strong class="kd iu">重要的</strong>:我只指定了GET和POST方法。这是因为该挂钩仅用于<strong class="kd iu">获取</strong>数据，而不是更新/创建资源。通常你应该总是使用GET请求来获取数据，但是由于互联网上的一些API也使用POST请求，所以我决定也添加这个。</p><figure class="mr ms mt mu gt ju"><div class="bz fp l di"><div class="mv mw l"/></div></figure><p id="b180" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">我们将使用钩子<strong class="kd iu"> useState </strong>来存储一些内部变量，这些变量在钩子结束时将被返回给React组件。我们将用一个带有3个参数的对象来初始化状态:</p><ul class=""><li id="00be" class="la lb it kd b ke kf ki kj km lc kq ld ku le ky lf lg lh li bi translated">响应，它将包含调用的API的JSON响应</li><li id="d4d9" class="la lb it kd b ke lj ki lk km ll kq lm ku ln ky lf lg lh li bi translated">错误，如果响应状态不正常</li><li id="cf55" class="la lb it kd b ke lj ki lk km ll kq lm ku ln ky lf lg lh li bi translated">如果钩子仍然在获取请求，这将是真的。因为下一步我们将调用请求，所以loading已经被设置为true</li></ul><h1 id="186a" class="lo lp it bd lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml bi translated">内部使用效果</h1><p id="2d1f" class="pw-post-body-paragraph kb kc it kd b ke mm kg kh ki mn kk kl km mo ko kp kq mp ks kt ku mq kw kx ky im bi translated">让我们继续探索钩子。这里我们将使用钩子<strong class="kd iu"> useEffect </strong>来做一些事情，只有当参数发生变化时；如果组件更改了url或选项(查询、主体、方法)中的任何参数，则<strong class="kd iu"> useEffect </strong>函数将重新运行。</p><figure class="mr ms mt mu gt ju"><div class="bz fp l di"><div class="mv mw l"/></div></figure><p id="00e6" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">我们使用JSON.stringify返回我们的<strong class="kd iu">选项</strong>值的字符串。这样，即使对象是嵌套的，useEffect也不会有任何问题。</p><p id="6974" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">我们要做的第一件事是用以下方式更改数据状态<strong class="kd iu">的值:</strong></p><ul class=""><li id="9a32" class="la lb it kd b ke kf ki kj km lc kq ld ku le ky lf lg lh li bi translated">加载设置为真</li><li id="e81b" class="la lb it kd b ke lj ki lk km ll kq lm ku ln ky lf lg lh li bi translated">错误设置为假</li><li id="a387" class="la lb it kd b ke lj ki lk km ll kq lm ku ln ky lf lg lh li bi translated">响应仍然是以前的响应(第一次为空)。如果您希望即使在获取新数据时也显示旧数据，这将很有帮助。</li></ul><h1 id="315a" class="lo lp it bd lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml bi translated">去营救🚀</h1><p id="110b" class="pw-post-body-paragraph kb kc it kd b ke mm kg kh ki mn kk kl km mo ko kp kq mp ks kt ku mq kw kx ky im bi translated">我们将使用<strong class="kd iu"> fetch </strong>函数来进行AJAX调用。我们将添加头<code class="fe my mz na nb b">Content-Type</code>到<code class="fe my mz na nb b">application/json</code>，因为我们将只使用请求json参数的API。</p><p id="f986" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">请注意:如果响应不正常(像axios一样)，fetch不会抛出错误，而是仍然解析成功，但是会将response.ok设置为<strong class="kd iu"> false </strong>。因此，我们需要检查已解析的数据，看看response.ok是真还是假，并相应地设置<code class="fe my mz na nb b">error</code>状态字段。</p><figure class="mr ms mt mu gt ju"><div class="bz fp l di"><div class="mv mw l"/></div></figure><p id="e3de" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">每当fetch方法解析或抛出错误时，我们将使用所有正确的字段更新数据状态，并将<code class="fe my mz na nb b">loading</code>设置为false。</p><h2 id="35a9" class="nc lp it bd lq nd ne dn lu nf ng dp ly km nh ni mc kq nj nk mg ku nl nm mk nn bi translated">就这样，✨</h2><p id="dd7c" class="pw-post-body-paragraph kb kc it kd b ke mm kg kh ki mn kk kl km mo ko kp kq mp ks kt ku mq kw kx ky im bi translated">这是关于钩子的一切，现在我们只需要使用它🚀</p><h1 id="9366" class="lo lp it bd lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml bi translated">让我们构建我们的演示应用程序吧！</h1><p id="600a" class="pw-post-body-paragraph kb kc it kd b ke mm kg kh ki mn kk kl km mo ko kp kq mp ks kt ku mq kw kx ky im bi translated">我们将使用“冰与火的API”<a class="ae kz" href="https://www.anapioficeandfire.com/" rel="noopener ugc nofollow" target="_blank">https://www.anapioficeandfire.com/</a>创建一个简单的分页应用程序，显示“冰与火之歌”系列中所有不同的房子。</p><figure class="mr ms mt mu gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi no"><img src="../Images/dc1b85830b99f52e0c0f554f3addd1de.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*V8vp3iH7LFUpwkTy20efRg.png"/></div></div></figure><p id="ec2e" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">注意:所有代码都可以在<a class="ae kz" href="https://github.com/urcoilbisurco/useFetchDemoApp" rel="noopener ugc nofollow" target="_blank">我的Github页面</a>找到。如您所见，我从样板文件create-react-app中删除了一些未使用的文件。还要注意，这是最终结果，在本文的最后。</p><p id="3f95" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">我们去<code class="fe my mz na nb b">src/App.js</code>把内容换成这样:</p><figure class="mr ms mt mu gt ju"><div class="bz fp l di"><div class="mv mw l"/></div></figure><p id="6d32" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">这就是结果。</p><figure class="mr ms mt mu gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi np"><img src="../Images/a1c3395408fe2ede4cb7d82116714849.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*TtaOu0E9qIWqsn07Pcm3wA.png"/></div></div></figure><p id="f358" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">我们还没有添加任何样式，所以它很漂亮<strong class="kd iu">丑</strong>。我们可以通过在<code class="fe my mz na nb b">src/App.css</code>中添加一些CSS来解决这个问题(我们不会使用任何花哨的样式组件或scss模块，也不会使用酷孩子目前正在使用的任何东西，因为这只是一个演示)。</p><figure class="mr ms mt mu gt ju"><div class="bz fp l di"><div class="mv mw l"/></div></figure><p id="81d1" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">那就好多了！</p><figure class="mr ms mt mu gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi nq"><img src="../Images/6b1ea21836b19f8ba6615018198cb55f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*AY-QxNzkp4t_g3r6KmVzCw.png"/></div></div></figure><h1 id="2387" class="lo lp it bd lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml bi translated">支持分页(和使用Fetch的查询)</h1><p id="4ad6" class="pw-post-body-paragraph kb kc it kd b ke mm kg kh ki mn kk kl km mo ko kp kq mp ks kt ku mq kw kx ky im bi translated">所以现在我们只展示了10栋房子。没关系，但我认为我们可以做得更好。我们将改变代码，以添加一些按钮，前往下一页(或上一页)，并查看新的结果✨</p><h2 id="2405" class="nc lp it bd lq nd ne dn lu nf ng dp ly km nh ni mc kq nj nk mg ku nl nm mk nn bi translated">但是首先，添加一些风格</h2><p id="489e" class="pw-post-body-paragraph kb kc it kd b ke mm kg kh ki mn kk kl km mo ko kp kq mp ks kt ku mq kw kx ky im bi translated">让我们添加一些我们将在接下来的步骤中需要的额外样式:打开src/App.css并用以下内容替换内容:</p><figure class="mr ms mt mu gt ju"><div class="bz fp l di"><div class="mv mw l"/></div></figure><h1 id="32e3" class="lo lp it bd lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml bi translated">使用useState处理currentPage变量</h1><p id="5dfd" class="pw-post-body-paragraph kb kc it kd b ke mm kg kh ki mn kk kl km mo ko kp kq mp ks kt ku mq kw kx ky im bi translated">我们将使用一个<code class="fe my mz na nb b">currentPage</code>变量来了解应用程序中显示的当前页面，所以让我们在我们的<code class="fe my mz na nb b">src/App.js</code>中设置它</p><figure class="mr ms mt mu gt ju"><div class="bz fp l di"><div class="mv mw l"/></div></figure><p id="3bb7" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">我们将currentPage的值初始化为1，还编辑了useFetch查询对象的<code class="fe my mz na nb b">page</code>值，以使用currentPage代替之前的常量1。</p><p id="3a84" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">现在，让我们在JSX中添加一些额外的部分。我们将:</p><ul class=""><li id="10a8" class="la lb it kd b ke kf ki kj km lc kq ld ku le ky lf lg lh li bi translated">添加标题，里面有当前页码；</li><li id="6006" class="la lb it kd b ke lj ki lk km ll kq lm ku ln ky lf lg lh li bi translated">在房屋列表下添加分页部分，用2个按钮来改变页面；</li><li id="db7d" class="la lb it kd b ke lj ki lk km ll kq lm ku ln ky lf lg lh li bi translated">移动加载div，这样标题和分页部分将始终可见。</li></ul><figure class="mr ms mt mu gt ju"><div class="bz fp l di"><div class="mv mw l"/></div></figure><p id="f25d" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">我们准备好了！让我们在localhost:3000上试试</p><figure class="mr ms mt mu gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi nr"><img src="../Images/ee13330ee8eeb76127780920936a02cf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*LL7dcYDwmHeX0bTxEx9OSQ.gif"/></div></div></figure><p id="552c" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">让我们回顾一下我们今天所做的事情:</p><ul class=""><li id="3dfc" class="la lb it kd b ke kf ki kj km lc kq ld ku le ky lf lg lh li bi translated">创造了一个新的反应钩✔️</li><li id="89b7" class="la lb it kd b ke lj ki lk km ll kq lm ku ln ky lf lg lh li bi translated">这个钩子将接受一个要获取的URL和一系列选项(查询、方法和主体)</li><li id="7085" class="la lb it kd b ke lj ki lk km ll kq lm ku ln ky lf lg lh li bi translated">这个钩子将返回一个带有AJAX响应、加载和错误布尔值✔️的对象</li><li id="afd0" class="la lb it kd b ke lj ki lk km ll kq lm ku ln ky lf lg lh li bi translated">每次钩子的一个选项改变时，钩子将再次获取URL ✔️</li><li id="4a42" class="la lb it kd b ke lj ki lk km ll kq lm ku ln ky lf lg lh li bi translated">创建一个演示应用程序来测试这个useFetch挂钩✔️</li></ul><p id="4698" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">我们还可以做得更好。</p><p id="8709" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">在接下来的几周内，我将发布一个新的教程来增强useFetch:</p><ul class=""><li id="cd41" class="la lb it kd b ke kf ki kj km lc kq ld ku le ky lf lg lh li bi translated">自动转换响应</li><li id="29e0" class="la lb it kd b ke lj ki lk km ll kq lm ku ln ky lf lg lh li bi translated">有条件地调用AJAX调用(现在它立即调用它)</li><li id="3958" class="la lb it kd b ke lj ki lk km ll kq lm ku ln ky lf lg lh li bi translated">添加默认响应(如果您不想立即调用API，这很有用)</li><li id="6423" class="la lb it kd b ke lj ki lk km ll kq lm ku ln ky lf lg lh li bi translated">添加对redux和dispatch的支持</li></ul><p id="b568" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">一如既往，如果您有任何问题，请在Twitter上发送<a class="ae kz" href="https://twitter.com/urcoilbisurco" rel="noopener ugc nofollow" target="_blank">消息或关注我</a>💛</p></div></div>    
</body>
</html>