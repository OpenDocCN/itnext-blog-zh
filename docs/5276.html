<html>
<head>
<title>Automatic HTTPS with Azure Container Instances (ACI)</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">带有Azure容器实例(ACI)的自动HTTPS</h1>
<blockquote>原文：<a href="https://itnext.io/automatic-https-with-azure-container-instances-aci-4c4c8b03e8c9?source=collection_archive---------0-----------------------#2021-01-31">https://itnext.io/automatic-https-with-azure-container-instances-aci-4c4c8b03e8c9?source=collection_archive---------0-----------------------#2021-01-31</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/f79038edbe925728a73f78cb5c640db2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*p8EzcFyr8boDJEz81SnRiw.png"/></div></div></figure><p id="c267" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">让我们假设您想要将一个简单的容器化应用程序或服务部署到Azure cloud。此外，您的服务需要能够通过HTTPS公开访问。这篇技术文章向您展示了如何实现这个目标。</p><h2 id="59bc" class="kw kx iq bd ky kz la dn lb lc ld dp le kj lf lg lh kn li lj lk kr ll lm ln lo bi translated">Azure容器实例</h2><p id="8a4c" class="pw-post-body-paragraph jy jz iq ka b kb lp kd ke kf lq kh ki kj lr kl km kn ls kp kq kr lt kt ku kv ij bi translated">根据架构指南<a class="ae lu" href="https://docs.microsoft.com/en-us/azure/architecture/guide/technology-choices/compute-decision-tree" rel="noopener ugc nofollow" target="_blank">选择Azure计算服务</a>您有几种选择来部署您的容器化服务，其中之一是<a class="ae lu" href="https://docs.microsoft.com/en-us/azure/container-instances/container-instances-overview" rel="noopener ugc nofollow" target="_blank"> Azure容器实例(ACI) </a>:</p><blockquote class="lv lw lx"><p id="66d1" class="jy jz ly ka b kb kc kd ke kf kg kh ki lz kk kl km ma ko kp kq mb ks kt ku kv ij bi translated">容器实例:在Azure中运行容器的最快和最简单的方式，无需提供任何虚拟机，也无需采用更高级别的服务。</p></blockquote><p id="c468" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><em class="ly">简单</em>也意味着你无法获得成熟的流程编排解决方案的所有选项和功能，例如<a class="ae lu" href="https://docs.microsoft.com/en-us/azure/aks/" rel="noopener ugc nofollow" target="_blank">Azure Kubernetes Service(AKS)</a>。ACI提供了sidecars和持久卷等功能。然而，使用ACI，您必须忍受升级部署时的停机时间。</p><p id="913d" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">您必须手动设置TLS。有一个指南，<a class="ae lu" href="https://docs.microsoft.com/en-us/azure/container-instances/container-instances-container-group-ssl" rel="noopener ugc nofollow" target="_blank">Enable TLS with a sidecar container</a>，它告诉你如何用Nginx和自签名证书设置HTTPS。呃。该指南还提到Caddy是另一家TLS提供商，但没有提供更多细节。</p><h2 id="0d2d" class="kw kx iq bd ky kz la dn lb lc ld dp le kj lf lg lh kn li lj lk kr ll lm ln lo bi translated">小盒子</h2><blockquote class="lv lw lx"><p id="8bed" class="jy jz ly ka b kb kc kd ke kf kg kh ki lz kk kl km ma ko kp kq mb ks kt ku kv ij bi translated">Caddy<a class="ae lu" href="https://caddyserver.com/" rel="noopener ugc nofollow" target="_blank">2是一个强大的企业级开源web服务器，具有用Go编写的自动HTTPS。</a></p></blockquote><p id="74ff" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">好，听起来不错！<a class="ae lu" href="https://caddyserver.com/docs/automatic-https" rel="noopener ugc nofollow" target="_blank">自动HTTPS </a>听起来确实耐人寻味。这是什么意思？" Caddy自动为您的站点获取和更新TLS证书。它甚至引起了OCSP的反应。”哇！但是这是怎么做到的呢？</p><p id="8cf7" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">“Caddy使用来自公共ACME CA的证书通过HTTPS提供公共DNS名称，例如<a class="ae lu" href="https://letsencrypt.org/" rel="noopener ugc nofollow" target="_blank">让我们加密</a>。这意味着，您只需要一个公共DNS记录，并且Caddy需要通过端口80和443可到达。不错！</p><h2 id="c726" class="kw kx iq bd ky kz la dn lb lc ld dp le kj lf lg lh kn li lj lk kr ll lm ln lo bi translated">安装说明</h2><p id="54b4" class="pw-post-body-paragraph jy jz iq ka b kb lp kd ke kf lq kh ki kj lr kl km kn ls kp kq kr lt kt ku kv ij bi translated">所以让我们结合ACI和Caddy来实现我们的目标。我将使用Terraform在Azure中建立基础设施。我们将从一个新的Terraform文件开始，并用Azure提供者(<em class="ly">Azure erm</em>)和Azure区域的本地值对其进行配置:</p><figure class="mc md me mf gt jr"><div class="bz fp l di"><div class="mg mh l"/></div></figure><p id="7919" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">接下来，我们将定义三个资源，以便为Caddy提供持久存储:</p><figure class="mc md me mf gt jr"><div class="bz fp l di"><div class="mg mh l"/></div></figure><p id="55a9" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">这是必需的，以便来自“让我们加密”的证书不会在部署之间丢失。如果您频繁部署，而Caddy不记得以前的证书，您可能会遇到加密的<a class="ae lu" href="https://letsencrypt.org/docs/rate-limits/" rel="noopener ugc nofollow" target="_blank">速率限制</a>，这意味着您在一段时间内将无法为您的域获得任何新证书。</p><p id="978e" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">现在我们准备定义我们的主资源，容器实例(在Terraform中称为<a class="ae lu" href="https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/resources/container_group" rel="noopener ugc nofollow" target="_blank"> <em class="ly">容器组</em> </a>):</p><figure class="mc md me mf gt jr"><div class="bz fp l di"><div class="mg mh l"/></div></figure><p id="fcf9" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">注意，我们定义了两个容器。在第9行，我们使用了一个Nginx非特权映像，它作为我们真实服务的代理，监听端口8080。</p><p id="f7a8" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在第16行，我们定义了另一个包含Caddy服务器的容器(sidecar)。如前所述，Caddy需要端口80和443，所以我们分配了这些端口。另外，请注意，我们使用的是公共IP(第7行)，并且定义了DNS子域(第6行)。</p><p id="16a5" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">第32–38行包含共享卷的配置，它引用了我们之前定义的存储资源。Caddy将其数据存储在<em class="ly"> /data </em>目录中。</p><p id="5909" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">第40行包含了启动Caddy的所有魔力。我们告诉它充当我们主服务的反向代理，要监听的地址(<em class="ly"> from </em>参数)，以及我们主服务的转发地址(<em class="ly"> to </em>参数)，即<em class="ly"> localhost:8080 </em>。就是这样。Caddy可以从一行程序开始，几乎不需要任何配置！(这是一个我称之为<em class="ly">零配置</em>的概念，我将在以后的文章中讨论它。)</p><p id="e640" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">最后，我们打印新服务的地址，该地址应该可以通过HTTPS使用来自Let's Encrypt的有效证书进行访问。</p><p id="9619" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">让我们使用<a class="ae lu" href="https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/guides/azure_cli" rel="noopener ugc nofollow" target="_blank"> Azure CLI </a> (az)登录，并初始化和应用我们的新Terraform配置:</p><figure class="mc md me mf gt jr"><div class="bz fp l di"><div class="mg mh l"/></div></figure><p id="7cfa" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">干得好！让我们通过调用输出中提供的URL在浏览器中测试我们的服务。如果页面显示“欢迎使用nginx！”并且浏览器不会抱怨无效的证书，那么我们就达到了我们的目标。</p><p id="940a" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">您需要了解一些限制:首先，对于每个服务，您必须启动一个单独的Caddy服务。这消耗了额外的资源。其次，您还必须确保您的服务不监听端口80和443，因为这些端口是为Caddy保留的。第三，球童需要一个公共IP。</p><h2 id="4666" class="kw kx iq bd ky kz la dn lb lc ld dp le kj lf lg lh kn li lj lk kr ll lm ln lo bi translated">结论</h2><p id="3971" class="pw-post-body-paragraph jy jz iq ka b kb lp kd ke kf lq kh ki kj lr kl km kn ls kp kq kr lt kt ku kv ij bi translated">在本技术指南中，我展示了如何克服ACI在管理HTTPS连接的TLS证书方面的一个缺点。</p></div></div>    
</body>
</html>