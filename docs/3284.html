<html>
<head>
<title>VMware Fling: vCenter Event Broker Appliance</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">VMware Fling: vCenter事件代理设备</h1>
<blockquote>原文：<a href="https://itnext.io/vmware-fling-vcenter-event-broker-appliance-c97514c9e902?source=collection_archive---------6-----------------------#2019-11-13">https://itnext.io/vmware-fling-vcenter-event-broker-appliance-c97514c9e902?source=collection_archive---------6-----------------------#2019-11-13</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="d11a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">有一个新的VMware产品上市了，它非常强大。每当您想到根据VMware vSphere事件做出反应时，vCenter Event Broker应用装置(vEBA)可能是您的选择。迈克尔·加施和T2·林柏希的优秀团队创造了这个精巧的装置。</p><p id="ae65" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">对于没有耐心的人，你可以在这里下载设备和文档，跳过这篇博文:</p><p id="9046" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><a class="ae kl" href="https://flings.vmware.com/vcenter-event-broker-appliance#summary" rel="noopener ugc nofollow" target="_blank">https://flings . VMware . com/vcenter-event-broker-appliance #摘要</a></p><p id="11e3" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果您想获得一些真实的生活体验，我们开始吧，基本上是相同的示例，每当虚拟机启动时添加一个标记:</p><p id="5e9b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">将虚拟设备作为ova文件下载后，只需按常规方式部署即可:</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div class="gh gi km"><img src="../Images/8fbab037c28632507955202ab3fb7603.png" data-original-src="https://miro.medium.com/v2/resize:fit:920/format:webp/0*nNAf2P7Foo5huZ9j.png"/></div></figure><p id="afa5" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">为了避免以后令人讨厌的故障排除，请确保正确设置设备的主机名，以便可以对其进行解析。输入vCenter地址时，请确保vEBA可以解析它。</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="kv kw di kx bf ky"><div class="gh gi ku"><img src="../Images/0f2f2fdc7bf18730b053bafa1715b69c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*H4UVaaEfV7TdFIuE.png"/></div></div></figure><p id="f4c8" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我真的建议确保名称解析设置正确，因为web应用程序可能不会出现。</p><p id="33cc" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">不要只是尝试ip地址或不同于部署期间使用的名称。</strong></p><p id="d3dd" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">因此，要么设置DNS，要么在客户端和您用来部署FaaS的系统上使用您的本地主机文件(以防不是同一个系统)。</p><p id="d780" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">那么它就会像预期的那样工作。</p><h1 id="d606" class="kz la iq bd lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw bi translated">第一次开始</h1><p id="407c" class="pw-post-body-paragraph jn jo iq jp b jq lx js jt ju ly jw jx jy lz ka kb kc ma ke kf kg mb ki kj kk ij bi translated">启动虚拟机后，系统将在内部设置一个整洁的Kubernetes集群。</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="kv kw di kx bf ky"><div class="gh gi ku"><img src="../Images/f13ff021a6344e553d24f02c19360571.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*9m5w3YhUQSrsoAnX.png"/></div></div></figure><p id="b740" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">要检查OpenFaaS，只需访问https:// <the fqdn="" you="" choose="">并使用<strong class="jp ir"> admin </strong>和您在部署期间配置的密码登录。</the></p><p id="68cf" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">您应该会看到一个空的OpenFaaS门户，没有任何功能。我们现在要改变这种情况。</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="kv kw di kx bf ky"><div class="gh gi ku"><img src="../Images/70074313d30482300813346928f274a4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*NRv84xGKRwDCFX-3.png"/></div></div></figure><h1 id="6a8d" class="kz la iq bd lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw bi translated">安装所需的工具</h1><p id="42db" class="pw-post-body-paragraph jn jo iq jp b jq lx js jt ju ly jw jx jy lz ka kb kc ma ke kf kg mb ki kj kk ij bi translated">下一步是安装配置vCenter事件代理所需的工具。</p><h1 id="cdec" class="kz la iq bd lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw bi translated">govc</h1><p id="f9c2" class="pw-post-body-paragraph jn jo iq jp b jq lx js jt ju ly jw jx jy lz ka kb kc ma ke kf kg mb ki kj kk ij bi translated">当然，你也可以自己创建我们将在演示中使用的标签，并弄清楚它是什么URN，但是govc让它变得非常简单。</p><p id="7ce3" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><a class="ae kl" href="https://github.com/vmware/govmomi/releases" rel="noopener ugc nofollow" target="_blank">https://github.com/vmware/govmomi/releases</a></p><pre class="kn ko kp kq gt mc md me mf aw mg bi"><span id="1dbd" class="mh la iq md b gy mi mj l mk ml"># Download govc<br/>wget <a class="ae kl" href="https://github.com/vmware/govmomi/releases/download/v0.21.0/govc_linux_amd64.gz" rel="noopener ugc nofollow" target="_blank">https://github.com/vmware/govmomi/releases/download/v0.21.0/govc_linux_amd64.gz</a></span><span id="fe68" class="mh la iq md b gy mm mj l mk ml"># extract<br/>gunzip govc_linux_amd64.gz</span><span id="bc71" class="mh la iq md b gy mm mj l mk ml"># make executable<br/>chmod +x govc_linux_amd64.gz</span><span id="46db" class="mh la iq md b gy mm mj l mk ml"># move into a path<br/>sudo mv govc_linux_amd64 /usr/local/bin/govc</span></pre><p id="64dc" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">您已经可以设置govc所需的环境变量:</p><pre class="kn ko kp kq gt mc md me mf aw mg bi"><span id="6db5" class="mh la iq md b gy mi mj l mk ml"># only required if you have a self-signed certificate<br/>export GOVC_INSECURE=true</span><span id="9031" class="mh la iq md b gy mm mj l mk ml"># set the password<br/>GOVC_URL="administrator@vsphere.local:whatastrongpassword@vcsa.mydomain.local"</span></pre><h1 id="89c7" class="kz la iq bd lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw bi translated">饭桶</h1><p id="82ee" class="pw-post-body-paragraph jn jo iq jp b jq lx js jt ju ly jw jx jy lz ka kb kc ma ke kf kg mb ki kj kk ij bi translated">反正大部分人大概都安装了。以防万一，如果你用的是Ubuntu或者Debian:<strong class="jp ir">sudo apt-get install git</strong></p><h1 id="7ea0" class="kz la iq bd lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw bi translated">OpenFaaS CLI</h1><p id="9ec4" class="pw-post-body-paragraph jn jo iq jp b jq lx js jt ju ly jw jx jy lz ka kb kc ma ke kf kg mb ki kj kk ij bi translated">这种情况很少安装，但是很容易得到:</p><p id="991e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><a class="ae kl" href="https://github.com/openfaas/faas-cli" rel="noopener ugc nofollow" target="_blank">https://github.com/openfaas/faas-cli</a></p><pre class="kn ko kp kq gt mc md me mf aw mg bi"><span id="aa99" class="mh la iq md b gy mi mj l mk ml"># install OpenFaaS cli <br/>curl -sSL <a class="ae kl" href="https://cli.openfaas.com" rel="noopener ugc nofollow" target="_blank">https://cli.openfaas.com</a> | sudo sh</span><span id="cd3e" class="mh la iq md b gy mm mj l mk ml"># let's set the environment variable for the server connection as well <br/>export OPENFAAS_URL=https://veba.mydomain.local</span></pre><h1 id="beae" class="kz la iq bd lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw bi translated">创建要使用的标签</h1><p id="affb" class="pw-post-body-paragraph jn jo iq jp b jq lx js jt ju ly jw jx jy lz ka kb kc ma ke kf kg mb ki kj kk ij bi translated">因为我们已经设置了govc环境变量，所以让我们首先检查现有的标签:<strong class="jp ir"> govc tags.ls </strong></p><p id="ea89" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果有一个你想使用的标记，获取urn路径:<strong class="jp ir"> govc tags.info &lt;标记名&gt; </strong></p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="kv kw di kx bf ky"><div class="gh gi ku"><img src="../Images/70aee9cd4015b823291204ba503fe4f5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*02PYf_FpZQyS8O-Q.png"/></div></div></figure><p id="8e6e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">记住骨灰盒！</p><p id="707f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果没有您想要使用的标签，您可以简单地创建一个:</p><pre class="kn ko kp kq gt mc md me mf aw mg bi"><span id="22c9" class="mh la iq md b gy mi mj l mk ml"># first create the category <br/>govc tags.category.create democat1</span><span id="352f" class="mh la iq md b gy mm mj l mk ml"># then create the tag using that category <br/>govc tags.create -c democat1 demotag1</span></pre><p id="9903" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">当创建标签时，结果显示的是骨灰盒。收到了。</strong></p><h1 id="dffe" class="kz la iq bd lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw bi translated">配置OpenFaaS</h1><p id="e679" class="pw-post-body-paragraph jn jo iq jp b jq lx js jt ju ly jw jx jy lz ka kb kc ma ke kf kg mb ki kj kk ij bi translated">接下来要做的是，当vCenter事件发生时，告诉OpenFaaS该做什么。Fling的创建者迈克尔·加施和林柏希非常好，也创建了一个演示库。</p><p id="7239" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">从克隆存储库开始:</p><p id="dcc2" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir"> git克隆</strong><a class="ae kl" href="https://github.com/embano1/pytagfn" rel="noopener ugc nofollow" target="_blank"><strong class="jp ir">https://github.com/embano1/pytagfn</strong></a></p><h1 id="49f4" class="kz la iq bd lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw bi translated">第一步:更改密码</h1><p id="7682" class="pw-post-body-paragraph jn jo iq jp b jq lx js jt ju ly jw jx jy lz ka kb kc ma ke kf kg mb ki kj kk ij bi translated">输入<strong class="jp ir"> vCSA URL </strong>、您的<strong class="jp ir">用户帐户</strong>和<strong class="jp ir">密码</strong>以及您在创建标签时记住的urn。</p><pre class="kn ko kp kq gt mc md me mf aw mg bi"><span id="7102" class="mh la iq md b gy mi mj l mk ml">cd pytagfn</span><span id="b532" class="mh la iq md b gy mm mj l mk ml">cat vcconfig.toml<br/>[vcenter]<br/>server = "vcsa.mydomain.local"<br/>user = "administrator@vsphere.local"<br/>password = "whatastrongpassword"</span><span id="f9f4" class="mh la iq md b gy mm mj l mk ml">[tag]<br/>urn = "urn:vmomi:InventoryServiceTag:d1c0516f-ec8a-4e3d-b064-21dc573e3cf2:GLOBAL"<br/>action = "attach" # or detach</span></pre><p id="caa6" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">将秘密部署到OpenFaaS</p><p id="6bf7" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir"> faas-cli登录-p &lt; vEBA密码&gt; -tls-no-verify </strong></p><p id="dc2c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">FAAS-CLI secret create VC config-from-file = VC config . toml-TLS-no-verify</p><p id="0682" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果返回代码是success，就可以删除vcconfig.toml。</p><h1 id="6144" class="kz la iq bd lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw bi translated">步骤2:配置和部署功能</h1><p id="5df8" class="pw-post-body-paragraph jn jo iq jp b jq lx js jt ju ly jw jx jy lz ka kb kc ma ke kf kg mb ki kj kk ij bi translated">只需更改git项目stack.yml中的函数文件，以反映您的环境:</p><pre class="kn ko kp kq gt mc md me mf aw mg bi"><span id="9b97" class="mh la iq md b gy mi mj l mk ml">cat stack.yml</span><span id="94e8" class="mh la iq md b gy mm mj l mk ml">provider:<br/>  name: faas<br/>  gateway: <a class="ae kl" href="https://veba.dzlabs.local" rel="noopener ugc nofollow" target="_blank">https://veba.dzlabs.local</a><br/>functions:<br/>  pytag-fn:<br/>    lang: python3<br/>    handler: ./pytag-fn<br/>    image: embano1/pytag-fn:0.2<br/>    environment:<br/>      write_debug: true<br/>      read_debuge: true<br/>    secrets:<br/>      - vcconfig<br/>    annotations:<br/>      topic: drs.vm.powered.on</span></pre><p id="4def" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">值得注意的是，网关需要设置为您的vEBA FQDN，注释需要包含您想要做出反应的事件。</p><p id="52e2" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir"> vm.powered.on </strong> =虚拟机在没有DRS的情况下启动</p><p id="0874" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir"> drs.vm.powered.on </strong> =虚拟机由drs启动</p><pre class="kn ko kp kq gt mc md me mf aw mg bi"><span id="82f9" class="mh la iq md b gy mi mj l mk ml"># required if you never used faas-cli before to deploy something </span><span id="1ff7" class="mh la iq md b gy mm mj l mk ml">faas-cli template pull</span><span id="db82" class="mh la iq md b gy mm mj l mk ml"># deploy the function </span><span id="eb50" class="mh la iq md b gy mm mj l mk ml">faas deploy -f stack.yml --tls-no-verify</span></pre><p id="84f6" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">您也应该能够在OpenFaaS门户中看到该功能:</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="kv kw di kx bf ky"><div class="gh gi ku"><img src="../Images/9f6a08d9e6141d2eddf569ae7c52e07b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*JzaaTWPXk2S9GIrW.png"/></div></div></figure><h1 id="c237" class="kz la iq bd lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw bi translated">结果</h1><p id="4384" class="pw-post-body-paragraph jn jo iq jp b jq lx js jt ju ly jw jx jy lz ka kb kc ma ke kf kg mb ki kj kk ij bi translated">启动虚拟机时，vCenter事件代理会自动添加一个标记。</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="kv kw di kx bf ky"><div class="gh gi mn"><img src="../Images/7d080f8297ebac880c0176a7dbf2eeb1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*NrWk44EgCQUBgwng.png"/></div></div></figure><p id="10c9" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这是一个好的开始，但是使用事件驱动的方法还可以做很多其他的事情。很好奇社区要在上面建什么。</p><h1 id="3d72" class="kz la iq bd lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw bi translated">解决纷争</h1><p id="e972" class="pw-post-body-paragraph jn jo iq jp b jq lx js jt ju ly jw jx jy lz ka kb kc ma ke kf kg mb ki kj kk ij bi translated">这部分可能会很难。首先要确保你仔细地遵循了所有的步骤，尤其是DNS部分。然后确保根据手动或DRS选择正确的事件。</p><p id="fbdf" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">您也可以使用root帐户和配置的密码并运行以下命令，通过ssh登录设备:</p><p id="3c95" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir"> kubectl -n openfaas日志部署/vcenter-connector -f </strong></p><p id="7eac" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这样，您就可以获得有关vCenter connector从vCenter接收的事件的信息。这有助于检查连接是否工作良好，以及您是否对正确的事件做出反应。</p></div><div class="ab cl mo mp hu mq" role="separator"><span class="mr bw bk ms mt mu"/><span class="mr bw bk ms mt mu"/><span class="mr bw bk ms mt"/></div><div class="ij ik il im in"><p id="1f67" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><em class="mv">原载于2019年11月13日</em><a class="ae kl" href="https://www.opvizor.com/vmware-fling-vcenter-event-broker-appliance" rel="noopener ugc nofollow" target="_blank"><em class="mv">【https://www.opvizor.com】</em></a><em class="mv">。</em></p></div></div>    
</body>
</html>