<html>
<head>
<title>Kubernetes on Devstack part 1: Deploying the Devstack cloud</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">关于Devstack的Kubernetes第1部分:部署Devstack云</h1>
<blockquote>原文：<a href="https://itnext.io/a-single-server-devstack-cloud-as-a-kubernetes-platform-cd30e28e405a?source=collection_archive---------2-----------------------#2020-11-06">https://itnext.io/a-single-server-devstack-cloud-as-a-kubernetes-platform-cd30e28e405a?source=collection_archive---------2-----------------------#2020-11-06</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="4fcc" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这篇文章是关于在Devstack云上运行Kubernetes集群的<a class="ae kl" href="https://berndbausch.medium.com/running-a-kubernetes-cluster-on-devstack-533d579bb2f9" rel="noopener">系列文章的一部分。它讨论了云的设置。</a></p><p id="5861" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">目标是在单节点Devstack服务器上创建Kubernetes集群。本文档涵盖了服务器本身、部署Devstack和一些部署后配置步骤。</p><h1 id="62e6" class="km kn iq bd ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj bi translated">目录</h1><ol class=""><li id="8982" class="lk ll iq jp b jq lm ju ln jy lo kc lp kg lq kk lr ls lt lu bi translated"><a class="ae kl" href="https://medium.com/p/cd30e28e405a#426c" rel="noopener">dev stack服务器</a></li><li id="a455" class="lk ll iq jp b jq lv ju lw jy lx kc ly kg lz kk lr ls lt lu bi translated"><a class="ae kl" href="https://medium.com/p/cd30e28e405a#ad9b" rel="noopener">准备Devstack服务器并部署云</a></li><li id="d104" class="lk ll iq jp b jq lv ju lw jy lx kc ly kg lz kk lr ls lt lu bi translated"><a class="ae kl" href="https://medium.com/p/cd30e28e405a#305d" rel="noopener">配置您的云</a></li><li id="80fa" class="lk ll iq jp b jq lv ju lw jy lx kc ly kg lz kk lr ls lt lu bi translated"><a class="ae kl" href="https://medium.com/p/cd30e28e405a#8acc" rel="noopener">如果需要重启Devstack服务器</a></li><li id="0f0c" class="lk ll iq jp b jq lv ju lw jy lx kc ly kg lz kk lr ls lt lu bi translated"><a class="ae kl" href="https://medium.com/p/cd30e28e405a#833a" rel="noopener">可选:测试负载平衡是否工作</a></li></ol><h1 id="426c" class="km kn iq bd ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj bi translated">Devstack服务器</h1><p id="4ea0" class="pw-post-body-paragraph jn jo iq jp b jq lm js jt ju ln jw jx jy ma ka kb kc mb ke kf kg mc ki kj kk ij bi translated">在具有以下属性的计算机上安装Ubuntu 18.04的服务器版本:</p><ul class=""><li id="7026" class="lk ll iq jp b jq jr ju jv jy md kc me kg mf kk mg ls lt lu bi translated">大约15GB的内存，操作舒适。12GB可能就足够了。除了云开销之外，还需要运行至少两个Kubernetes节点(每个4GB)和一个1GB负载平衡器实例。</li><li id="467d" class="lk ll iq jp b jq lv ju lw jy lx kc ly kg lz kk mg ls lt lu bi translated">大约50GB的存储空间</li><li id="86dc" class="lk ll iq jp b jq lv ju lw jy lx kc ly kg lz kk mg ls lt lu bi translated">几个CPU(最少2个，越多越好)</li><li id="b318" class="lk ll iq jp b jq lv ju lw jy lx kc ly kg lz kk mg ls lt lu bi translated">一个可以连接到互联网并且可以从外部连接的网卡</li></ul><p id="7609" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这台计算机(此后命名为Devstack server)可以是您实验室或公共提供商的物理计算机，也可以是您实验室或公共云中运行的虚拟机。</p><p id="a42d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果您选择在实验室的虚拟机中运行Devstack服务器，请确保虚拟机管理程序支持<strong class="jp ir">嵌套虚拟化</strong>并允许网络流量流向嵌套虚拟机。KVM满足这两个条件。以我的经验来看，VirtualBox和Xen会阻塞到嵌套虚拟机的流量，可能是因为它们拒绝与未知的IP地址对话(我是Xen新手；可能存在改变这种行为的配置设置)。我没有试过Vmware、Hyper-V或WSL。</p><p id="4889" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果没有嵌套虚拟化，许多操作将非常缓慢，例如，在嵌套虚拟机上安装软件需要一个小时或更长时间。</p><p id="f6a5" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">要在KVM上启用嵌套虚拟化，请将<code class="fe mh mi mj mk b">kvm-intel.nested=1</code>或<code class="fe mh mi mj mk b">kvm-amd.nested=1</code>添加到Linux内核参数中。或者，创建一个<code class="fe mh mi mj mk b">modprobe.conf.d</code>文件，用<code class="fe mh mi mj mk b">nested=1</code>参数加载相应的内核模块<code class="fe mh mi mj mk b">kvm_adm</code>或<code class="fe mh mi mj mk b">kvm_intel</code>。</p><p id="baf9" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">下面是我的设置:</strong>dev stack服务器运行在一个KVM虚拟机上，该虚拟机通过一个Linuxbridge连接到外部网络。K8s集群节点(主节点和工作节点)是运行在Devstack服务器内部的OpenStack实例。<em class="ml"> br-ex </em>是一个Openvswitch桥，它将所有OpenStack实例连接到外部世界。Devstack服务器的单个NIC插入到<em class="ml"> br-ex </em>中。</p><pre class="mm mn mo mp gt mq mk mr ms aw mt bi"><span id="a9d5" class="mu kn iq mk b gy mv mw l mx my"> +---------------- Physical host -----------------+<br/> |                                                |<br/> |                                                |<br/> | +------ Devstack server (a KVM VM) ----------+ |<br/> | |                                            | |<br/> | |  +------------+          +------------+    | |<br/> | |  | K8s master |          | K8s worker |    | |<br/> | |  +------------+          +------------+    | |<br/> | |          \                     /           | |<br/> | |           \-----\   /---------/            | |<br/> | |                 |   |                      | |<br/> | |               /-------\                    | |<br/> | |               | br-ex |                    | |<br/> | |               \-------/                    | |<br/> | |                   |                        | |<br/> | +------------- Virtual NIC ------------------+ |<br/> |                     |                          |<br/> |              /-------------\                   |<br/> |              | Linuxbridge |                   |<br/> |              \-------------/                   |<br/> |                     |                          |<br/> +-----------------Physical NIC-------------------+<br/>                       | <br/>_______________________|_________External Network_______________</span></pre><p id="d02a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">由于这些桥，Devstack服务器和K8s节点可以从外部网络获得IP地址。这是可取的，因为它允许向外界公开K8s集群服务。</p><h1 id="ad9b" class="km kn iq bd ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj bi translated">准备Devstack服务器并部署云</h1><p id="169b" class="pw-post-body-paragraph jn jo iq jp b jq lm js jt ju ln jw jx jy ma ka kb kc mb ke kf kg mc ki kj kk ij bi translated">Devstack文档站点有关于<a class="ae kl" href="https://docs.openstack.org/devstack" rel="noopener ugc nofollow" target="_blank">部署Devstack </a>和<a class="ae kl" href="https://docs.openstack.org/devstack/latest/guides/devstack-with-lbaas-v2.html" rel="noopener ugc nofollow" target="_blank">启用负载平衡器</a>的说明。这些说明并没有涵盖所有内容；例如，他们不知道如何将云连接到外部网络，或者如何启用负载平衡器的GUI。下面的步骤对我有效。</p><p id="1a61" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">从带有SSH访问的默认Ubuntu 18.04安装开始。在设置Devstack之前:</p><ul class=""><li id="818b" class="lk ll iq jp b jq jr ju jv jy md kc me kg mf kk mg ls lt lu bi translated">配置一个静态IP地址(DHCP可能也可以，但静态更安全)</li><li id="8031" class="lk ll iq jp b jq lv ju lw jy lx kc ly kg lz kk mg ls lt lu bi translated">创建一个名为<em class="ml"> stack </em>的用户，使用Devstack站点上记录的无密码sudo。</li><li id="b1be" class="lk ll iq jp b jq lv ju lw jy lx kc ly kg lz kk mg ls lt lu bi translated">我有Ubuntu默认DNS解析的问题，它在云部署期间被神奇地破坏了。虽然我不知道为什么会发生这种情况，但我通过链接/etc/resolv.conf解决了这个问题，如下所示:<br/> <code class="fe mh mi mj mk b">ln -s /run/systemd/resolve/resolv.conf /etc</code></li></ul><p id="cccc" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">做好这些准备后，以<em class="ml"> stack </em>用户身份登录，克隆Ussuri版本的Devstack: <br/> <code class="fe mh mi mj mk b">git clone https://opendev.org/openstack/devstack -b stable/ussuri</code></p><p id="d62a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这将创建$HOME/devstack目录并将devstack复制到其中。Devstack是Bash脚本的集合，我鼓励您分析它们。</p><p id="c438" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">Devstack使用一个名为<em class="ml"> local.conf </em>的配置文件。从我的Github repo 中改编<a class="ae kl" href="https://github.com/berndbausch/Devstack-Kubernetes/blob/main/local.conf" rel="noopener ugc nofollow" target="_blank"> local.conf模板，并将其复制到＄HOME/dev stack。然后推出<br/>云:<code class="fe mh mi mj mk b">cd $HOME/devstack; ./stack.sh</code></a></p><p id="cfcd" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这将生成大量输出，这些输出也被写入<code class="fe mh mi mj mk b">/opt/stack/logs/stack.sh.log</code>。部署过程从互联网上安装Ubuntu和Python包，并获取VM镜像。因此，安装时间在很大程度上取决于您的互联网带宽，但也取决于您的硬盘速度。粗略估计:一到两个小时。</p><p id="92f6" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">部署失败的原因有很多，包括:</p><ul class=""><li id="831f" class="lk ll iq jp b jq jr ju jv jy md kc me kg mf kk mg ls lt lu bi translated"><code class="fe mh mi mj mk b">apt</code>或者<code class="fe mh mi mj mk b">dpkg</code>在后台运行，可能是因为Ubuntu目前正在寻找更新。等apt/dpkg安静了再试试。</li><li id="b2b6" class="lk ll iq jp b jq lv ju lw jy lx kc ly kg lz kk mg ls lt lu bi translated">由于网络问题，对某些包的访问失败。几分钟后重试。</li><li id="9574" class="lk ll iq jp b jq lv ju lw jy lx kc ly kg lz kk mg ls lt lu bi translated">Python包之间的不兼容性。这需要来自软件包维护者或Devstack团队的修复。最少24小时。</li><li id="0bce" class="lk ll iq jp b jq lv ju lw jy lx kc ly kg lz kk mg ls lt lu bi translated">你的Devstack服务器的问题:<br/>网络故障，空间不足，…</li></ul><p id="3a6f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">只要不改变<em class="ml"> local.conf </em>，应该可以重新运行一个不成功的部署。部署修改后的<em class="ml"> local.conf </em>可能需要从头开始安装Ubuntu。</p><p id="4e52" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">当部署以类似以下的消息结束时，您就知道部署成功了:</p><pre class="mm mn mo mp gt mq mk mr ms aw mt bi"><span id="5f86" class="mu kn iq mk b gy mv mw l mx my">=========================<br/>DevStack Component Timing<br/> (times are in seconds)<br/>=========================<br/>run_process           39<br/>test_with_retry        4<br/>apt-get-update         5<br/>osc                  437<br/>wait_for_service      18<br/>git_timed            260<br/>dbsync               422<br/>pip_install          455<br/>apt-get              898<br/>-------------------------<br/>Unaccounted time     2074<br/>=========================<br/>Total runtime        4612</span><span id="6b7c" class="mu kn iq mk b gy mz mw l mx my">This is your host IP address: 192.168.1.200<br/>This is your host IPv6 address: ::1<br/>Horizon is now available at http://192.168.1.200/dashboard<br/>Keystone is serving at http://192.168.1.200/identity/<br/>The default users are: admin and demo<br/>The password: pw</span><span id="d19e" class="mu kn iq mk b gy mz mw l mx my">WARNING:<br/>Using lib/neutron-legacy is deprecated, and it will be removed in the future<br/></span><span id="609f" class="mu kn iq mk b gy mz mw l mx my">Services are running under systemd unit files.<br/>For more information see:<br/>https://docs.openstack.org/devstack/latest/systemd.html</span><span id="f7d6" class="mu kn iq mk b gy mz mw l mx my">DevStack Version: ussuri<br/>Change: f482957e89d1ee938da679529aa10f13b2d07631 Bionic: Enable Train UCA for updated QEMU and libvirt 2020-09-18 09:10:58 +0100<br/>OS Version: Ubuntu 18.04 bionic</span></pre><h1 id="305d" class="km kn iq bd ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj bi translated">配置您的云</h1><p id="2723" class="pw-post-body-paragraph jn jo iq jp b jq lm js jt ju ln jw jx jy ma ka kb kc mb ke kf kg mc ki kj kk ij bi translated">成功部署后，您可以通过将浏览器定向到Devstack服务器的IP地址来访问云的GUI。对于命令行访问，使用Devstack服务器上的shell。</p><p id="0529" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在安装Kubernetes集群之前，向云中添加以下内容:项目和用户、网络、安全组、密钥对、Centos映像以及主实例和工作实例。创建所有这些云资源的准备脚本是可用的。</p><h1 id="8acc" class="km kn iq bd ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj bi translated">如果需要重新启动Devstack服务器</h1><p id="e06b" class="pw-post-body-paragraph jn jo iq jp b jq lm js jt ju ln jw jx jy ma ka kb kc mb ke kf kg mc ki kj kk ij bi translated">Devstack被设计成一个崩溃-烧毁系统，它的一些配置是非持久的。如果您计划关闭Devstack服务器，您需要使它防重启。</p><p id="9dba" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><em class="ml"> br-ex </em>桥必须配置有Devstack服务器的IP地址。这可以通过<a class="ae kl" href="https://github.com/berndbausch/Devstack-Kubernetes/blob/main/00-installer-config.yaml" rel="noopener ugc nofollow" target="_blank">网络计划配置文件</a>来完成。复制给<code class="fe mh mi mj mk b">/etc/netplan</code>。</p><p id="56b0" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">为了重新创建剩余的配置设置，我在每次重启后运行脚本<a class="ae kl" href="https://github.com/berndbausch/Devstack-Kubernetes/blob/main/restore-devstack.sh" rel="noopener ugc nofollow" target="_blank"> restore-devstack.sh </a>。</p><p id="a4bc" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">最后，重新启动时正在运行的任何实例现在都处于关闭状态。用<code class="fe mh mi mj mk b">openstack server start</code>命令复活它们。</p><h1 id="833a" class="km kn iq bd ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj bi translated">可选:测试负载平衡是否有效</h1><p id="757e" class="pw-post-body-paragraph jn jo iq jp b jq lm js jt ju ln jw jx jy ma ka kb kc mb ke kf kg mc ki kj kk ij bi translated">基于<a class="ae kl" href="https://docs.openstack.org/devstack/latest/guides/devstack-with-lbaas-v2.html" rel="noopener ugc nofollow" target="_blank"> Devstack负载平衡器指南</a>。</p><p id="45df" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这并不是真正必需的，但是如果您对OpenStack云中的负载平衡器的设置感兴趣，它会为您提供一些见解。</p><p id="b681" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在<a class="ae kl" href="#305d" rel="noopener ugc nofollow">配置您的云</a>之后执行这些步骤。从<em class="ml"> kube </em>项目中的两个Cirros实例开始。</p><pre class="mm mn mo mp gt mq mk mr ms aw mt bi"><span id="99d4" class="mu kn iq mk b gy mv mw l mx my">source ~/devstack/openrc kube kube<br/>openstack server create --image cirros --network kubenet \<br/>                  --flavor 1 --key-name kubekey --min 2 --max 2 c</span></pre><p id="bb02" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这将启动两个名为<em class="ml"> c-1 </em>和<em class="ml"> c-2 </em>的实例。要为ICMP和网络端口22和80打开防火墙，请将它们添加到<em class="ml"> kubesg </em>安全组。要启用网络访问，请给他们浮动IP地址。</p><pre class="mm mn mo mp gt mq mk mr ms aw mt bi"><span id="2d48" class="mu kn iq mk b gy mv mw l mx my">openstack floating ip create public<br/>openstack floating ip create public   # you need two floating IPs<br/>openstack server add security group c-1 kubesg<br/>openstack server add security group c-2 kubesg<br/>openstack server add floating IP c-1 FLOATING-IP-1<br/>openstack server add floating IP c-2 FLOATING-IP-2</span></pre><p id="0267" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在两个实例上安装一个基本的HTTP服务器。</p><pre class="mm mn mo mp gt mq mk mr ms aw mt bi"><span id="05ee" class="mu kn iq mk b gy mv mw l mx my">ssh -i kubekey cirros@FLOATING-IP-1<br/>$ while true<br/>do <br/>     echo -e "HTTP/1.0 200 OK\r\n\r\nWelcome to server 1" | <br/>     sudo nc -l -p 80 <br/>done &amp;<br/>$ exit</span></pre><p id="e19d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">当服务器收到一个HTTP请求时，这个简短的脚本会响应“欢迎使用服务器1”。对另一个实例执行相同的操作。</p><pre class="mm mn mo mp gt mq mk mr ms aw mt bi"><span id="b932" class="mu kn iq mk b gy mv mw l mx my">ssh -i kubekey cirros@FLOATING-IP-2<br/>$ while true<br/>do <br/>     echo -e "HTTP/1.0 200 OK\r\n\r\nThis is server 2" | <br/>     sudo nc -l -p 80 <br/>done &amp;<br/>$ exit</span></pre><p id="4218" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">测试这个:<br/> <code class="fe mh mi mj mk b">curl FLOATING-IP-1 <br/>curl FLOATING-IP-2</code></p><p id="4f4e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在创建一个负载平衡器，将这两个实例作为后端。您需要创建负载平衡器、侦听器、该侦听器的池，并将这两个实例添加为池成员。GUI允许您直观地做到这一点。以下是CLI指令，几乎一字不差地来自<a class="ae kl" href="https://docs.openstack.org/devstack/latest/guides/devstack-with-lbaas-v2.html#phase-2-create-your-load-balancer" rel="noopener ugc nofollow" target="_blank"> Devstack指南</a>，并添加了来自<a class="ae kl" href="https://docs.openstack.org/octavia/latest/user/guides/basic-cookbook.html#deploy-a-basic-http-load-balancer-using-a-floating-ip" rel="noopener ugc nofollow" target="_blank">基本负载平衡指南</a>的内容:</p><pre class="mm mn mo mp gt mq mk mr ms aw mt bi"><span id="c162" class="mu kn iq mk b gy mv mw l mx my"># Obtain fixed IP addresses from the Cirros instances<br/>FIXED-IP-1=$(openstack server show c-1 -c addresses -f value | <br/>sed -e 's/kubenet=//' -e 's/,.*//')<br/>FIXED-IP-2=$(openstack server show c-2 -c addresses -f value | <br/>sed -e 's/kubenet=//' -e 's/,.*//')</span><span id="c15a" class="mu kn iq mk b gy mz mw l mx my">openstack loadbalancer create --name testlb \<br/>                              --vip-subnet-id kubesubnet<br/>openstack loadbalancer show testlb  <br/># Repeat the above `show` command <br/># until the provisioning status turns ACTIVE.</span><span id="39a7" class="mu kn iq mk b gy mz mw l mx my"># Create a listener<br/>openstack loadbalancer listener create --protocol HTTP \<br/>                       --protocol-port 80 --name testlistener testlb</span><span id="12cc" class="mu kn iq mk b gy mz mw l mx my"># Create a pool<br/>openstack loadbalancer pool create --lb-algorithm ROUND_ROBIN \<br/>             --listener testlistener --protocol HTTP --name testpool</span><span id="5ab6" class="mu kn iq mk b gy mz mw l mx my"># Add the two Cirros instances as members to the pool<br/>openstack loadbalancer member create --subnet-id kubesubnet \<br/>                   --address $FIXED-IP-1 --protocol-port 80 testpool<br/>openstack loadbalancer member create --subnet-id kubesubnet \<br/>                   --address $FIXED-IP-2 --protocol-port 80 testpool</span></pre><p id="ef21" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">负载平衡器已经就位。最后一步，添加一个浮动IP，这样就可以从云外部访问它。这个有点牵扯。</p><p id="61f9" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">获取负载平衡器的ID: <br/> <code class="fe mh mi mj mk b">LB_ID=$(openstack loadbalancer show testlb -c id -f value)</code></p><p id="6caf" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">获取承载负载均衡器虚拟IP的中子端口:<br/> <code class="fe mh mi mj mk b">PORT_ID=$(openstack port list --device-id lb-$LB_ID -c ID -f value)</code></p><p id="4336" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">创建一个新的浮动IP并保存其ID: <br/> <code class="fe mh mi mj mk b">FLOATINGIP_ID=$(openstack floating ip create public -c id -f value)</code></p><p id="6b78" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">将此浮动IP与负载平衡器的VIP端口关联:<br/> <code class="fe mh mi mj mk b">openstack floating ip set --port $PORT_ID $FLOATINGIP_ID</code></p><p id="d178" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在获取浮动IP地址，反复访问。您应该会收到来自运行在Cirros实例上的两个“web服务器”的响应。</p><pre class="mm mn mo mp gt mq mk mr ms aw mt bi"><span id="c9be" class="mu kn iq mk b gy mv mw l mx my">FIP=$(openstack floating ip show $<!-- -->FLOATINGIP_ID \<br/>                              -c floating_ip_address -f value)<br/>for i in 1 2 3 4 5 6<br/>do curl $FIP<br/>done</span></pre><p id="f5df" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">接下来:</strong> <a class="ae kl" href="https://berndbausch.medium.com/a-kubernetes-cluster-with-openstack-cloud-provider-and-cinder-plugin-b3f058ce898c" rel="noopener">使用<em class="ml"> OpenStack云提供商</em>和<em class="ml"> Cinder CSI </em>插件</a>创建Kubernetes集群</p></div></div>    
</body>
</html>