<html>
<head>
<title>How I Developed React Hooks for Web Workers</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">我是如何为网络工作者开发React钩子的</h1>
<blockquote>原文：<a href="https://itnext.io/how-i-developed-react-hooks-for-web-workers-9e97efc86266?source=collection_archive---------6-----------------------#2019-09-08">https://itnext.io/how-i-developed-react-hooks-for-web-workers-9e97efc86266?source=collection_archive---------6-----------------------#2019-09-08</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="8296" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">利用异步发电机</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/5f3f04f4fe72aba8f4e828ae8e68eeb1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*w_qaWfsGqFqcqF6dGrk4oA.jpeg"/></div></div></figure><h1 id="5d4a" class="ku kv it bd kw kx ky kz la lb lc ld le jz lf ka lg kc lh kd li kf lj kg lk ll bi translated">介绍</h1><p id="1506" class="pw-post-body-paragraph lm ln it lo b lp lq ju lr ls lt jx lu lv lw lx ly lz ma mb mc md me mf mg mh im bi translated">我一直在开发几个react hooks库。他们为特定的目的提供定制的钩子。其中一个是给网络工作者的。我开始是为了好玩。得到了一些反馈，改进了。这篇文章展示了当前的实现，目标是在生产中使用。</p><p id="5429" class="pw-post-body-paragraph lm ln it lo b lp mi ju lr ls mj jx lu lv mk lx ly lz ml mb mc md mm mf mg mh im bi translated">在这个领域，<a class="ae mn" href="https://github.com/GoogleChromeLabs/comlink" rel="noopener ugc nofollow" target="_blank"> Comlink </a>提供了一个很好的带有代理的透明API。有些人可能已经用React试过了。我有两个理由不把它用于我的图书馆。</p><ol class=""><li id="f152" class="mo mp it lo b lp mi ls mj lv mq lz mr md ms mh mt mu mv mw bi translated">React钩子本质上是反应性的，所以不需要异步接口。对于Comlink，主线程中的API是一个异步函数。你需要把<code class="fe mx my mz na b">await</code>放在<code class="fe mx my mz na b">Comlink.wrap</code>前面。有了React，我们可以在钩子中隐藏异步行为。</li><li id="cb5b" class="mo mp it lo b lp nb ls nc lv nd lz ne md nf mh mt mu mv mw bi translated">RPC样式是有限的。网络工作者通常用于耗时的任务。为了更好的UX，我们可能需要显示任务的进展或中间结果。</li></ol><h1 id="f470" class="ku kv it bd kw kx ky kz la lb lc ld le jz lf ka lg kc lh kd li kf lj kg lk ll bi translated">图书馆</h1><p id="6ebd" class="pw-post-body-paragraph lm ln it lo b lp lq ju lr ls lt jx lu lv lw lx ly lz ma mb mc md me mf mg mh im bi translated">我开发了一个库来提供一个定制的钩子，方便工人使用。它没有依赖性，代码也很小。</p><div class="ng nh gp gr ni nj"><a href="https://github.com/dai-shi/react-hooks-worker" rel="noopener  ugc nofollow" target="_blank"><div class="nk ab fo"><div class="nl ab nm cl cj nn"><h2 class="bd iu gy z fp no fr fs np fu fw is bi translated">戴氏/反应钩-工人</h2><div class="nq l"><h3 class="bd b gy z fp no fr fs np fu fw dk translated">React为网络工作者定制钩子。Web Workers是浏览器中主线程的另一个线程。我们可以负重奔跑…</h3></div><div class="nr l"><p class="bd b dl z fp no fr fs np fu fw dk translated">github.com</p></div></div><div class="ns l"><div class="nt l nu nv nw ns nx ks nj"/></div></div></a></div><h1 id="1408" class="ku kv it bd kw kx ky kz la lb lc ld le jz lf ka lg kc lh kd li kf lj kg lk ll bi translated">基本用法</h1><p id="70e8" class="pw-post-body-paragraph lm ln it lo b lp lq ju lr ls lt jx lu lv lw lx ly lz ma mb mc md me mf mg mh im bi translated">这里有一个计算斐波那契数列的基本例子。你需要两个文件用于工作线程和主线程。该库为每个文件导出两个函数。</p><p id="3538" class="pw-post-body-paragraph lm ln it lo b lp mi ju lr ls mj jx lu lv mk lx ly lz ml mb mc md mm mf mg mh im bi translated">工人文件如下所示。</p><pre class="kj kk kl km gt ny na nz oa aw ob bi"><span id="753c" class="oc kv it na b gy od oe l of og">// fib.worker.js</span><span id="9091" class="oc kv it na b gy oh oe l of og">import { exposeWorker } from 'react-hooks-worker';</span><span id="679c" class="oc kv it na b gy oh oe l of og">const fib = i =&gt; (i &lt;= 1 ? i : fib(i - 1) + fib(i - 2));</span><span id="f5c0" class="oc kv it na b gy oh oe l of og">exposeWorker(fib);</span></pre><p id="6d83" class="pw-post-body-paragraph lm ln it lo b lp mi ju lr ls mj jx lu lv mk lx ly lz ml mb mc md mm mf mg mh im bi translated">react文件如下所示。</p><pre class="kj kk kl km gt ny na nz oa aw ob bi"><span id="dc29" class="oc kv it na b gy od oe l of og">// App.jsx</span><span id="daff" class="oc kv it na b gy oh oe l of og">import React from 'react';<br/>import { useWorker } from 'react-hooks-worker';</span><span id="f3a3" class="oc kv it na b gy oh oe l of og">const createWorker = () =&gt; new Worker('./fib.worker', { type: 'module' });</span><span id="e3e3" class="oc kv it na b gy oh oe l of og">const CalcFib = ({ count }) =&gt; {<br/>  const { result, error } = useWorker(createWorker, count);<br/>  if (error) return &lt;div&gt;Error: {error}&lt;/div&gt;;<br/>  return &lt;div&gt;Result: {result}&lt;/div&gt;;<br/>};</span><span id="00ed" class="oc kv it na b gy oh oe l of og">export const App = () =&gt; (<br/>  &lt;div&gt;<br/>    &lt;CalcFib count={5} /&gt;<br/>  &lt;/div&gt;<br/>);</span></pre><h1 id="776c" class="ku kv it bd kw kx ky kz la lb lc ld le jz lf ka lg kc lh kd li kf lj kg lk ll bi translated">异步发电机</h1><p id="c200" class="pw-post-body-paragraph lm ln it lo b lp lq ju lr ls lt jx lu lv lw lx ly lz ma mb mc md me mf mg mh im bi translated">正如我暗示的，这个库提供了非RPC接口。我们使用(异步)生成器来返回中间状态。</p><p id="d9d7" class="pw-post-body-paragraph lm ln it lo b lp mi ju lr ls mj jx lu lv mk lx ly lz ml mb mc md mm mf mg mh im bi translated">这里有一个例子来展示斐波那契数列的计算步骤。</p><pre class="kj kk kl km gt ny na nz oa aw ob bi"><span id="ebe6" class="oc kv it na b gy od oe l of og">// fib-steps.worker.js</span><span id="0d63" class="oc kv it na b gy oh oe l of og">import { exposeWorker } from 'react-hooks-worker';</span><span id="4345" class="oc kv it na b gy oh oe l of og">async function* fib(x) {<br/>  let x1 = 0;<br/>  let x2 = 1;<br/>  let i = 0;<br/>  while (i &lt; x) {<br/>    yield `(calculating...) ${x1}`;<br/>    await new Promise(r =&gt; setTimeout(r, 100));<br/>    [x1, x2] = [x2, x1 + x2];<br/>    i += 1;<br/>  }<br/>  yield x1;<br/>}</span><span id="2203" class="oc kv it na b gy oh oe l of og">exposeWorker(fib);</span></pre><h1 id="85ec" class="ku kv it bd kw kx ky kz la lb lc ld le jz lf ka lg kc lh kd li kf lj kg lk ll bi translated">实施</h1><p id="397d" class="pw-post-body-paragraph lm ln it lo b lp lq ju lr ls lt jx lu lv lw lx ly lz ma mb mc md me mf mg mh im bi translated"><code class="fe mx my mz na b">exposeWorker</code>的实现出奇的简单。</p><pre class="kj kk kl km gt ny na nz oa aw ob bi"><span id="d55f" class="oc kv it na b gy od oe l of og">export const exposeWorker = (func) =&gt; {<br/>  self.onmessage = async (e) =&gt; {<br/>    const r = func(e.data);<br/>    if (r[Symbol.asyncIterator]) {<br/>      for await (const i of r) self.postMessage(i);<br/>    } else if (r[Symbol.iterator]) {<br/>      for (const i of r) self.postMessage(i);<br/>    } else {<br/>      self.postMessage(await r);<br/>    }<br/>  };<br/>};</span></pre><p id="9ded" class="pw-post-body-paragraph lm ln it lo b lp mi ju lr ls mj jx lu lv mk lx ly lz ml mb mc md mm mf mg mh im bi translated"><code class="fe mx my mz na b">useWorker</code>的实现可以是各种风格。目前，它是用useReducer实现的。</p><pre class="kj kk kl km gt ny na nz oa aw ob bi"><span id="d4f8" class="oc kv it na b gy od oe l of og">import {<br/>  useEffect,<br/>  useMemo,<br/>  useRef,<br/>  useReducer,<br/>} from 'react';</span><span id="777b" class="oc kv it na b gy oh oe l of og">const initialState = { result: null, error: null };<br/>const reducer = (state, action) =&gt; {<br/>  switch (action.type) {<br/>    case 'init':<br/>      return initialState;<br/>    case 'result':<br/>      return { result: action.result, error: null };<br/>    case 'error':<br/>      return { result: null, error: 'error' };<br/>    case 'messageerror':<br/>      return { result: null, error: 'messageerror' };<br/>    default:<br/>      throw new Error('no such action type');<br/>  }<br/>};</span><span id="e1e7" class="oc kv it na b gy oh oe l of og">export const useWorker = (createWorker, input) =&gt; {<br/>  const [state, dispatch] = useReducer(reducer, initialState);<br/>  const worker = useMemo(createWorker, [createWorker]);<br/>  const lastWorker = useRef(null);<br/>  useEffect(() =&gt; {<br/>    lastWorker.current = worker;<br/>    let dispatchSafe = action =&gt; dispatch(action);<br/>    worker.onmessage = e =&gt; dispatchSafe({ type: 'result', result: e.data });<br/>    worker.onerror = () =&gt; dispatchSafe({ type: 'error' });<br/>    worker.onmessageerror = () =&gt; dispatchSafe({ type: 'messageerror' });<br/>    const cleanup = () =&gt; {<br/>      dispatchSafe = () =&gt; null; // we should not dispatch after cleanup.<br/>      worker.terminate();<br/>      dispatch({ type: 'init' });<br/>    };<br/>    return cleanup;<br/>  }, [worker]);<br/>  useEffect(() =&gt; {<br/>    lastWorker.current.postMessage(input);<br/>  }, [input]);<br/>  return state;<br/>};</span></pre><p id="1e71" class="pw-post-body-paragraph lm ln it lo b lp mi ju lr ls mj jx lu lv mk lx ly lz ml mb mc md mm mf mg mh im bi translated">重要提示:如果<code class="fe mx my mz na b">createWorker</code>与前一个不同，它会停止前一个工人并开始一个新工人。否则，它将重用该工作实例。目前没有办法通过对单个worker实例的多次调用来区分结果。</p><h1 id="93de" class="ku kv it bd kw kx ky kz la lb lc ld le jz lf ka lg kc lh kd li kf lj kg lk ll bi translated">结束语</h1><p id="5765" class="pw-post-body-paragraph lm ln it lo b lp lq ju lr ls lt jx lu lv lw lx ly lz ma mb mc md me mf mg mh im bi translated">如果我们使用worker来处理非平凡的用例，我们可能会在worker中使用一些库。这需要更多的支持。到目前为止，我只在webpack中用<a class="ae mn" href="https://github.com/GoogleChromeLabs/worker-plugin" rel="noopener ugc nofollow" target="_blank"> worker-plugin </a>试过。webpack中还有其他插件。其他捆绑器支持类似的功能。欢迎您试用它们，并向项目报告结果。</p></div><div class="ab cl oi oj hx ok" role="separator"><span class="ol bw bk om on oo"/><span class="ol bw bk om on oo"/><span class="ol bw bk om on"/></div><div class="im in io ip iq"><p id="a958" class="pw-post-body-paragraph lm ln it lo b lp mi ju lr ls mj jx lu lv mk lx ly lz ml mb mc md mm mf mg mh im bi translated"><em class="op">原载于2019年9月8日</em><a class="ae mn" href="https://blog.axlight.com/posts/how-i-developed-react-hooks-for-web-workers/" rel="noopener ugc nofollow" target="_blank"><em class="op">【https://blog.axlight.com】</em></a><em class="op">。</em></p></div></div>    
</body>
</html>