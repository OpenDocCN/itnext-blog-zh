<html>
<head>
<title>Kubernetes and Secrets Management in the Cloud</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Kubernetes和云中的秘密管理</h1>
<blockquote>原文：<a href="https://itnext.io/kubernetes-and-secrets-management-in-cloud-858533c20dca?source=collection_archive---------1-----------------------#2019-12-26">https://itnext.io/kubernetes-and-secrets-management-in-cloud-858533c20dca?source=collection_archive---------1-----------------------#2019-12-26</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="5da0" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">许多生产系统的运作都离不开秘密。意外泄露机密是应该妥善解决的最大风险之一。开发人员应该尽力保护应用程序的秘密。</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="ks kt di ku bf kv"><div class="gh gi km"><img src="../Images/01964014502ec0c5c3131c74bfb78442.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*yhMInSD3pkjVkscQDxVPgQ.jpeg"/></div></div></figure><p id="1e05" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">一旦公司转向微服务架构，多个服务需要访问不同的秘密才能正常工作，问题就变得更加棘手。这就带来了一个新的挑战:如何分发、管理、监控和轮换应用程序机密，避免意外暴露？</p><h2 id="ff08" class="ky kz iq bd la lb lc dn ld le lf dp lg jy lh li lj kc lk ll lm kg ln lo lp lq bi translated">库伯内特的秘密</h2><p id="edbe" class="pw-post-body-paragraph jn jo iq jp b jq lr js jt ju ls jw jx jy lt ka kb kc lu ke kf kg lv ki kj kk ij bi translated">Kubernetes提供了一个名为Secret的对象，可以用来存储应用程序敏感数据，比如密码、SSH密钥、API密钥、令牌等等。Kubernetes Secret可以作为环境变量或作为文件装入到Pod容器中。使用Kubernetes Secrets允许我们从应用程序部署中抽象出敏感数据和配置。</p><p id="063e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">例如，可以用命令<code class="fe lw lx ly lz b">kubectl create secret</code>创建一个Kubernetes秘密:</p><figure class="kn ko kp kq gt kr"><div class="bz fp l di"><div class="ma mb l"/></div></figure><p id="ff68" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">或者Kubernetes <code class="fe lw lx ly lz b">db-credentials.yaml</code>文件，描述了同样的秘密:</p><figure class="kn ko kp kq gt kr"><div class="bz fp l di"><div class="ma mb l"/></div></figure><figure class="kn ko kp kq gt kr"><div class="bz fp l di"><div class="ma mb l"/></div></figure><p id="f5f8" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">请注意，在Kubernetes Secret中存储敏感数据并不能保证它的安全。默认情况下，Kubernetes Secrets中的所有数据都存储为用<code class="fe lw lx ly lz b">base64</code>编码的明文。</p><p id="26c3" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">从版本1.13开始，Kubernetes支持<a class="ae mc" href="https://kubernetes.io/docs/tasks/administer-cluster/encrypt-data/" rel="noopener ugc nofollow" target="_blank">加密静态的秘密数据</a>，使用内置或外部加密提供者的<code class="fe lw lx ly lz b">EncryptionConfiguration</code>对象。</p><p id="7001" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">当前支持的加密提供程序列表:</p><p id="8b15" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><a class="ae mc" href="https://kubernetes.io/docs/tasks/administer-cluster/encrypt-data/#providers" rel="noopener ugc nofollow" target="_blank">内置提供者</a> : <code class="fe lw lx ly lz b">aescbc</code>、<code class="fe lw lx ly lz b">aesgsm</code>、<code class="fe lw lx ly lz b">secretbox</code></p><p id="94e5" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><a class="ae mc" href="https://kubernetes.io/docs/tasks/administer-cluster/kms-provider/" rel="noopener ugc nofollow" target="_blank"> KMS供应商</a>:</p><ul class=""><li id="3ea7" class="md me iq jp b jq jr ju jv jy mf kc mg kg mh kk mi mj mk ml bi translated"><a class="ae mc" href="https://cloud.google.com/kubernetes-engine/docs/how-to/encrypting-secrets" rel="noopener ugc nofollow" target="_blank">谷歌KMS提供商</a></li><li id="0fd4" class="md me iq jp b jq mm ju mn jy mo kc mp kg mq kk mi mj mk ml bi translated"><a class="ae mc" href="https://github.com/kubernetes-sigs/aws-encryption-provider" rel="noopener ugc nofollow" target="_blank"> AWS KMS提供商</a></li><li id="1328" class="md me iq jp b jq mm ju mn jy mo kc mp kg mq kk mi mj mk ml bi translated"><a class="ae mc" href="https://github.com/Azure/kubernetes-kms" rel="noopener ugc nofollow" target="_blank">蔚蓝KMS提供商</a></li></ul><p id="46f7" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">但是，默认情况下不会强制静态机密加密。即使启用，它也是不够的，不能被认为是一个完整的机密管理解决方案。</p><p id="3e6c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">完整的机密管理解决方案还必须支持:秘密分发、轮换、细粒度访问控制、审计日志、使用监控、版本控制、高度加密的存储、方便的API和客户端SDK/s，可能还有一些其他有用的功能。</p><h2 id="3a29" class="ky kz iq bd la lb lc dn ld le lf dp lg jy lh li lj kc lk ll lm kg ln lo lp lq bi translated">云秘密管理</h2><p id="53fd" class="pw-post-body-paragraph jn jo iq jp b jq lr js jt ju ls jw jx jy lt ka kb kc lu ke kf kg lv ki kj kk ij bi translated">多家云供应商提供秘密管理服务，作为其云平台产品的一部分，帮助您保护访问应用程序、服务和API所需的秘密。使用这些服务消除了以明文形式硬编码敏感信息的需要，并开发了自主开发的机密管理生命周期。机密管理服务使您能够使用细粒度的权限和审核来控制对应用程序机密的访问。</p><h2 id="27cf" class="ky kz iq bd la lb lc dn ld le lf dp lg jy lh li lj kc lk ll lm kg ln lo lp lq bi translated">将Kubernetes与秘密管理服务相集成</h2><p id="a308" class="pw-post-body-paragraph jn jo iq jp b jq lr js jt ju ls jw jx jy lt ka kb kc lu ke kf kg lv ki kj kk ij bi translated">通常，任何应用程序都可以使用特定于供应商的SDK/API来访问存储在机密管理服务中的机密。通常，这需要修改应用程序代码或使用某种引导脚本或<a class="ae mc" href="https://kubernetes.io/docs/concepts/workloads/pods/init-containers/" rel="noopener ugc nofollow" target="_blank"> Init容器</a>，使用客户端CLI工具或web APIs。</p><h2 id="99c9" class="ky kz iq bd la lb lc dn ld le lf dp lg jy lh li lj kc lk ll lm kg ln lo lp lq bi translated">使用<code class="fe lw lx ly lz b">secrets-init</code>工具让它变得简单</h2><p id="9740" class="pw-post-body-paragraph jn jo iq jp b jq lr js jt ju ls jw jx jy lt ka kb kc lu ke kf kg lv ki kj kk ij bi translated">今天，我们发布了<a class="ae mc" href="https://github.com/doitintl/secrets-init" rel="noopener ugc nofollow" target="_blank"> doitintl/secrets-init </a> -开源工具(Apache License 2.0)，简化了云原生机密管理服务与在云管理或自我管理的Kubernetes集群上运行的容器化工作负载的集成。</p><p id="8847" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">从本质上来说，<code class="fe lw lx ly lz b">secrets-init</code>是一个极简的<strong class="jp ir"> init </strong>系统，设计为在容器环境中作为<code class="fe lw lx ly lz b">PID 1</code>运行，类似于<a class="ae mc" href="https://github.com/Yelp/dumb-init" rel="noopener ugc nofollow" target="_blank"> dumb-init </a>，并提供与多个云原生秘密管理服务的流畅集成，例如:</p><ul class=""><li id="318f" class="md me iq jp b jq jr ju jv jy mf kc mg kg mh kk mi mj mk ml bi translated"><a class="ae mc" href="https://aws.amazon.com/secrets-manager/" rel="noopener ugc nofollow" target="_blank"> AWS秘密管理器</a></li><li id="f4f2" class="md me iq jp b jq mm ju mn jy mo kc mp kg mq kk mi mj mk ml bi translated"><a class="ae mc" href="https://docs.aws.amazon.com/systems-manager/latest/userguide/systems-manager-parameter-store.html" rel="noopener ugc nofollow" target="_blank"> AWS系统管理器参数存储</a></li><li id="3683" class="md me iq jp b jq mm ju mn jy mo kc mp kg mq kk mi mj mk ml bi translated"><a class="ae mc" href="https://cloud.google.com/secret-manager/docs/" rel="noopener ugc nofollow" target="_blank">谷歌秘密管理器(测试版)</a></li></ul><h2 id="3485" class="ky kz iq bd la lb lc dn ld le lf dp lg jy lh li lj kc lk ll lm kg ln lo lp lq bi translated">为什么Docker容器中需要一个init系统？</h2><p id="eff1" class="pw-post-body-paragraph jn jo iq jp b jq lr js jt ju ls jw jx jy lt ka kb kc lu ke kf kg lv ki kj kk ij bi translated">请<a class="ae mc" href="https://github.com/Yelp/dumb-init/blob/v1.2.0/README.md#why-you-need-an-init-system" rel="noopener ugc nofollow" target="_blank">阅读Yelp <em class="kl"> dumb-init </em>回购解释</a></p><p id="45d8" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">总结:</p><ul class=""><li id="bc09" class="md me iq jp b jq jr ju jv jy mf kc mg kg mh kk mi mj mk ml bi translated">正确的信号转发</li><li id="f245" class="md me iq jp b jq mm ju mn jy mo kc mp kg mq kk mi mj mk ml bi translated">孤儿僵尸收割</li></ul><h2 id="c019" class="ky kz iq bd la lb lc dn ld le lf dp lg jy lh li lj kc lk ll lm kg ln lo lp lq bi translated"><code class="fe lw lx ly lz b">secrets-init</code>做什么</h2><p id="aa67" class="pw-post-body-paragraph jn jo iq jp b jq lr js jt ju ls jw jx jy lt ka kb kc lu ke kf kg lv ki kj kk ij bi translated"><code class="fe lw lx ly lz b">secrets-init</code>作为<code class="fe lw lx ly lz b">PID 1</code>运行，就像一个简单的init系统充当<code class="fe lw lx ly lz b">ENTRYPOINT</code>或第一个容器命令，它负责启动一个子进程，将所有系统信号代理给一个以该子进程为根的会话。这是init进程的本质。另一方面，<code class="fe lw lx ly lz b">secrets-init</code>也不加修改地传递<em class="kl">几乎</em>所有的环境变量，用来自秘密管理服务的值替换特殊的<em class="kl">秘密变量</em>。</p><h2 id="2ec3" class="ky kz iq bd la lb lc dn ld le lf dp lg jy lh li lj kc lk ll lm kg ln lo lp lq bi translated">与Docker集成</h2><p id="8151" class="pw-post-body-paragraph jn jo iq jp b jq lr js jt ju ls jw jx jy lt ka kb kc lu ke kf kg lv ki kj kk ij bi translated"><code class="fe lw lx ly lz b">secrets-init</code>是一个静态编译的二进制文件(没有外部依赖)，可以很容易地嵌入到任何Docker映像中。下载<code class="fe lw lx ly lz b">secrets-init</code>二进制并将其用作Docker容器<code class="fe lw lx ly lz b">ENTRYPOINT</code>。</p><p id="8238" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">例如:</p><figure class="kn ko kp kq gt kr"><div class="bz fp l di"><div class="ma mb l"/></div></figure><h2 id="49e8" class="ky kz iq bd la lb lc dn ld le lf dp lg jy lh li lj kc lk ll lm kg ln lo lp lq bi translated">与Kubernetes集成</h2><p id="3616" class="pw-post-body-paragraph jn jo iq jp b jq lr js jt ju ls jw jx jy lt ka kb kc lu ke kf kg lv ki kj kk ij bi translated">为了在不修改Docker映像的情况下将<code class="fe lw lx ly lz b">secrets-init</code>与Kubernetes对象(Pod/Deployment/Job/etc)一起使用，可以考虑通过<a class="ae mc" href="https://kubernetes.io/docs/concepts/workloads/pods/init-containers/" rel="noopener ugc nofollow" target="_blank"> initContainer </a>将<code class="fe lw lx ly lz b">secrets-init</code>注入到目标Pod中。您可以使用<a class="ae mc" href="https://hub.docker.com/r/doitintl/secrets-init" rel="noopener ugc nofollow" target="_blank">doit int/secrets-init</a>Docker映像或创建自己的映像。将<code class="fe lw lx ly lz b">secrets-init</code>二进制文件从init容器复制到一个公共共享卷，并将Pod <code class="fe lw lx ly lz b">command</code>改为作为第一个命令运行<code class="fe lw lx ly lz b">secrets-init</code>。</p><h2 id="080e" class="ky kz iq bd la lb lc dn ld le lf dp lg jy lh li lj kc lk ll lm kg ln lo lp lq bi translated">与AWS Secrets Manager集成</h2><p id="8ec2" class="pw-post-body-paragraph jn jo iq jp b jq lr js jt ju ls jw jx jy lt ka kb kc lu ke kf kg lv ki kj kk ij bi translated">要开始将<code class="fe lw lx ly lz b">secrets-init</code>与AWS Secrets Manager一起使用，用户应该将AWS Secrets ARN作为环境变量值。<code class="fe lw lx ly lz b">secrets-init</code>将使用指定的ARN将任何环境值解析为引用的秘密值。</p><p id="1d7a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">例如，在Kubernetes作业中使用<code class="fe lw lx ly lz b">secrets-init</code>:</p><figure class="kn ko kp kq gt kr"><div class="bz fp l di"><div class="ma mb l"/></div></figure><h2 id="27b7" class="ky kz iq bd la lb lc dn ld le lf dp lg jy lh li lj kc lk ll lm kg ln lo lp lq bi translated">与AWS系统管理器参数存储集成</h2><p id="5f47" class="pw-post-body-paragraph jn jo iq jp b jq lr js jt ju ls jw jx jy lt ka kb kc lu ke kf kg lv ki kj kk ij bi translated">可以使用AWS Systems Manager参数存储将应用程序参数存储为明文或加密(一种秘密)。</p><p id="fb42" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">与前面的例子一样，用户可以将AWS参数存储ARN作为环境变量值。<code class="fe lw lx ly lz b">secrets-init</code>将使用指定的ARN将任何环境值解析为参考参数值。</p><p id="8e24" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">AWS系统管理器参数存储格式示例:</p><figure class="kn ko kp kq gt kr"><div class="bz fp l di"><div class="ma mb l"/></div></figure><p id="2414" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">为了从AWS机密管理器和参数存储中解析AWS机密，<code class="fe lw lx ly lz b">secrets-init</code>应在有权访问所需机密的IAM角色下运行。</p><p id="55a0" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这可以通过将IAM角色分配给Kubernetes Pod或ECS任务来实现。参见<a class="ae mc" href="https://aws.amazon.com/blogs/opensource/introducing-fine-grained-iam-roles-service-accounts/" rel="noopener ugc nofollow" target="_blank">介绍服务账户的细粒度IAM角色</a> EKS博客文章。</p><p id="9ef1" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">可以将IAM角色分配给EC2实例，容器在EC2实例中运行，但是这种方法不太安全，不推荐使用。</p><h2 id="307a" class="ky kz iq bd la lb lc dn ld le lf dp lg jy lh li lj kc lk ll lm kg ln lo lp lq bi translated">与谷歌秘密管理集成</h2><p id="a163" class="pw-post-body-paragraph jn jo iq jp b jq lr js jt ju ls jw jx jy lt ka kb kc lu ke kf kg lv ki kj kk ij bi translated">谷歌云最近发布了一项新的管理云中秘密的服务:<a class="ae mc" href="https://cloud.google.com/secret-manager" rel="noopener ugc nofollow" target="_blank">谷歌秘密管理器</a></p><p id="4dcd" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">用户可以输入Google secret name，使用<code class="fe lw lx ly lz b">secrets-init</code>可识别的前缀(<code class="fe lw lx ly lz b">gcp:secretmanager:</code>)，后面的secret name ( <code class="fe lw lx ly lz b">projects/{PROJECT_ID}/secrets/{SECRET_NAME}</code>或<code class="fe lw lx ly lz b">projects/{PROJECT_ID}/secrets/{SECRET_NAME}/versions/{VERSION}</code>)作为环境变量值。<code class="fe lw lx ly lz b">secrets-init</code>将使用指定的名称将任何环境值解析为引用的秘密值。</p><figure class="kn ko kp kq gt kr"><div class="bz fp l di"><div class="ma mb l"/></div></figure><p id="0ba3" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">为了从Google Secret Manager解析Google secrets，<code class="fe lw lx ly lz b">secrets-init</code>应该在IAM角色下运行，该角色有权访问所需的机密。</p><p id="d7f3" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这可以通过将IAM角色分配给具有<a class="ae mc" href="https://cloud.google.com/kubernetes-engine/docs/how-to/workload-identity" rel="noopener ugc nofollow" target="_blank">工作负载标识</a>的Kubernetes Pod来实现。可以将IAM角色分配给运行容器的GCE实例，但是这个选项不太安全。</p><h2 id="8781" class="ky kz iq bd la lb lc dn ld le lf dp lg jy lh li lj kc lk ll lm kg ln lo lp lq bi translated">(15–03–2020)更新:Kubernetes入场网钩</h2><p id="602f" class="pw-post-body-paragraph jn jo iq jp b jq lr js jt ju ls jw jx jy lt ka kb kc lu ke kf kg lv ki kj kk ij bi translated"><a class="ae mc" href="https://github.com/doitintl/kube-secrets-init" rel="noopener ugc nofollow" target="_blank"> kube-secrets-init </a>项目实现了一个Kubernetes<a class="ae mc" href="https://kubernetes.io/docs/reference/access-authn-authz/extensible-admission-controllers/#admission-webhooks" rel="noopener ugc nofollow" target="_blank">admission web hook</a>，它通过显式(环境变量)或隐式(Kubernetes <code class="fe lw lx ly lz b">Secrets</code>和<code class="fe lw lx ly lz b">ConfigMaps</code>)引用云秘密将<code class="fe lw lx ly lz b">initContainer</code>注入到任何Pod中。</p><h2 id="1cea" class="ky kz iq bd la lb lc dn ld le lf dp lg jy lh li lj kc lk ll lm kg ln lo lp lq bi translated">有用的链接</h2><ul class=""><li id="dfa8" class="md me iq jp b jq lr ju ls jy mr kc ms kg mt kk mi mj mk ml bi translated"><a class="ae mc" href="https://blog.doit-intl.com/kubernetes-gke-workload-identity-75fa197ff6bf" rel="noopener ugc nofollow" target="_blank"> Kubernetes GKE工作量标识</a> DoiT博文</li><li id="5bd8" class="md me iq jp b jq mm ju mn jy mo kc mp kg mq kk mi mj mk ml bi translated"><a class="ae mc" href="https://github.com/doitintl/secrets-init" rel="noopener ugc nofollow" target="_blank">doit intl/secrets-init</a>GitHub知识库</li><li id="a075" class="md me iq jp b jq mm ju mn jy mo kc mp kg mq kk mi mj mk ml bi translated"><a class="ae mc" href="https://github.com/doitintl/kube-secrets-init" rel="noopener ugc nofollow" target="_blank">kube-secrets-init</a>Kubernetes接纳webhook GitHub知识库</li></ul><h2 id="f50d" class="ky kz iq bd la lb lc dn ld le lf dp lg jy lh li lj kc lk ll lm kg ln lo lp lq bi translated">摘要</h2><p id="e814" class="pw-post-body-paragraph jn jo iq jp b jq lr js jt ju ls jw jx jy lt ka kb kc lu ke kf kg lv ki kj kk ij bi translated">我希望，这篇文章对你有用。我期待您的评论和任何问题。</p><p id="21e4" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">想要更多的故事？查看我们在<a class="ae mc" href="http://blog.doit-intl.com/" rel="noopener ugc nofollow" target="_blank"> Medium </a>上的博客，或者<a class="ae mc" href="https://twitter.com/alexeiled" rel="noopener ugc nofollow" target="_blank">在Twitter上关注阿列克谢</a>。</p></div></div>    
</body>
</html>