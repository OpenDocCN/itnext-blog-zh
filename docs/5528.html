<html>
<head>
<title>Distributed testing with JMeter and Azure Container Instances</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用JMeter和Azure容器实例进行分布式测试</h1>
<blockquote>原文：<a href="https://itnext.io/distributed-testing-with-jmeter-and-azure-container-instances-d0ef658086ad?source=collection_archive---------1-----------------------#2021-03-25">https://itnext.io/distributed-testing-with-jmeter-and-azure-container-instances-d0ef658086ad?source=collection_archive---------1-----------------------#2021-03-25</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="4888" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">当开发web应用程序时，您希望确保您的产品已经准备好处理成功和流量，这就是为什么负载测试和压力测试对于确保web应用程序的性能和可伸缩性非常重要。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div class="gh gi kl"><img src="../Images/b8f0e1c38ad0138868acf230a8d88667.png" data-original-src="https://miro.medium.com/v2/resize:fit:1152/format:webp/1*0Y4sCz_jrL4XnNq9DE1BqQ.png"/></div></figure><p id="6f11" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在有大量的负载测试解决方案，有商业的也有免费的，所以你可以考虑在这个时候什么是最适合你的项目的。负载测试并不总是CI/CD管道的一部分，通常是为季节性事件启动的，如报税、夏季销售、黑色星期五、圣诞节等。因此，许多项目选择免费的解决方案，这不会给财务带来额外的负担，但会给经过测试的web应用程序带来负担:)</p><p id="9f2a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在这篇文章中，我想分享我的分布式测试方法，使用<a class="ae kt" href="https://jmeter.apache.org/" rel="noopener ugc nofollow" target="_blank"> Apache JMeter </a>、<a class="ae kt" href="https://www.docker.com/" rel="noopener ugc nofollow" target="_blank"> Docker </a>和<a class="ae kt" href="https://azure.microsoft.com/en-gb/services/container-instances/" rel="noopener ugc nofollow" target="_blank"> Azure容器实例</a>。我更喜欢这种设置，因为您可以在相对较短的时间内以相对较低的价格、相对较低的工作量创建高负载。</p><p id="8f77" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">好吧，好吧，我知道你已经在想:“哦，来吧！说重点，你这个该死的******！”。整个想法并不新颖，简单来说就是这样:</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kv kw di kx bf ky"><div class="gh gi ku"><img src="../Images/ce58674b73fbb3481a4a7c8852f2c666.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*YqdZTKefuRKba85eveBByQ.png"/></div></div><figcaption class="kz la gj gh gi lb lc bd b be z dk translated">使用JMeter和Azure容器实例进行分布式测试</figcaption></figure><p id="9aee" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">JMeter控制器实例正在向JMeter服务器发送测试和必要的指令，这些服务器正在我们的测试网站上创建负载。为了设置和运行这个程序，我们用JMeter在非Gui模式下构建了两个Docker映像——JMeter控制器映像和JMeter服务器映像。然后，我们在一个容器实例中运行控制器，并根据需要启动尽可能多的服务器(工作器)实例。为了使控制器更容易访问工作节点，它们被放置在同一个虚拟网络和子网中。因为我们需要一些地方来保存我们的测试文件、日志和测试报告，所以我们将Azure文件共享作为卷安装到我们的容器中。当我们的基础设施被填充时，控制器节点向工作节点发出命令，它们开始向我们的web应用程序施加负载。在测试执行之后，报告存储在我们的文件共享中。</p><p id="c7e9" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">出于演示的目的，我部署了一个简单的Asp.net核心应用程序，具有注册和登录功能，并从6个工作人员那里运行测试，其中每个工作人员在10秒内添加40个用户的负载。因为我的测试访问了几个页面，所以在峰值负载时会产生10k个请求。观察响应时间如何变化也很有趣。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kv kw di kx bf ky"><div class="gh gi ld"><img src="../Images/d4e293d7d4c51ec239e0d25f2a99b8ba.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Qzlxx4Hxk3MeeYfT_AYBGg.png"/></div></div></figure><p id="25de" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">测试执行后，日志和测试报告存储在我们的Azure文件共享中，看起来有点像这样。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kv kw di kx bf ky"><div class="gh gi le"><img src="../Images/f6eb08427db1f68053805f26038de7b0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*vuvl5C7RI4QwbZfNxxhKEQ.png"/></div></div></figure><p id="975b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">可以使用<a class="ae kt" href="https://azure.microsoft.com/en-us/features/storage-explorer/" rel="noopener ugc nofollow" target="_blank"> Azure Storage Explorer </a>下载报告，或者我们可以在脚本的末尾添加一个下载命令(最后我有点懒)。使用不同的JMeter插件\插件也有很多调整/升级报告的可能性。JMeter社区真的很好，很有帮助。</p><p id="1060" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">为了自动化整个过程，我准备了Docker文件和一个运行Azure CLI命令的PowerShell脚本。这个脚本提供所有的基础设施，然后运行测试。由于它运行的是Azure CLI命令，如果有必要，它可以很容易地转换成其他shell脚本——我使用PowerShell是因为我目前在Windows上工作。我将在下面列出脚本中的主要步骤:</p><ol class=""><li id="1e67" class="lf lg iq jp b jq jr ju jv jy lh kc li kg lj kk lk ll lm ln bi translated">为测试设置创建Azure资源组。</li><li id="de9b" class="lf lg iq jp b jq lo ju lp jy lq kc lr kg ls kk lk ll lm ln bi translated">创建虚拟网络和子网。</li><li id="0f35" class="lf lg iq jp b jq lo ju lp jy lq kc lr kg ls kk lk ll lm ln bi translated">创建存储帐户。</li><li id="a94d" class="lf lg iq jp b jq lo ju lp jy lq kc lr kg ls kk lk ll lm ln bi translated">创建文件共享并获取访问密钥。</li><li id="f512" class="lf lg iq jp b jq lo ju lp jy lq kc lr kg ls kk lk ll lm ln bi translated">将JMeter测试计划上传到文件共享。</li><li id="468c" class="lf lg iq jp b jq lo ju lp jy lq kc lr kg ls kk lk ll lm ln bi translated">为控制器和服务器构建和推送docker映像。</li><li id="1bbb" class="lf lg iq jp b jq lo ju lp jy lq kc lr kg ls kk lk ll lm ln bi translated">使用JMeter服务器映像创建和运行容器实例，并收集它们的IP地址。</li><li id="c340" class="lf lg iq jp b jq lo ju lp jy lq kc lr kg ls kk lk ll lm ln bi translated">使用Jmeter控制器映像创建实例并运行测试。</li></ol><blockquote class="lt lu lv"><p id="2582" class="jn jo lw jp b jq jr js jt ju jv jw jx lx jz ka kb ly kd ke kf lz kh ki kj kk ij bi translated">注意，所有必要的参数，如<code class="fe ma mb mc md b">TEST_DIR, TEST_FILE, SERVERS</code>都作为环境变量传递给docker容器。</p></blockquote><p id="a020" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">要获得完整的解决方案，请查看我的<a class="ae kt" href="https://github.com/f1xxxer/jmetertests" rel="noopener ugc nofollow" target="_blank"> Github库</a>，不要犹豫修改脚本，甚至发送一些拉请求；)</p><blockquote class="lt lu lv"><p id="f57b" class="jn jo lw jp b jq jr js jt ju jv jw jx lx jz ka kb ly kd ke kf lz kh ki kj kk ij bi translated">另外，在运行脚本之前，不要忘记使用<code class="fe ma mb mc md b">az login</code>登录azure。</p></blockquote><p id="5da9" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">GL&amp;HF</p></div></div>    
</body>
</html>