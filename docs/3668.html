<html>
<head>
<title>ActiveInteractor</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">ActiveInteractor</h1>
<blockquote>原文：<a href="https://itnext.io/activeinteractor-8557c0dc78db?source=collection_archive---------6-----------------------#2020-01-27">https://itnext.io/activeinteractor-8557c0dc78db?source=collection_archive---------6-----------------------#2020-01-27</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><figure class="ip iq gp gr ir is gh gi paragraph-image"><div class="gh gi io"><img src="../Images/fc805285bc0171916ff5741c0bff5b2b.png" data-original-src="https://miro.medium.com/v2/resize:fit:894/format:webp/1*dBlyPBXGZwzNIomt7b5DsQ.png"/></div></figure><div class=""/><p id="25c5" class="pw-post-body-paragraph ju jv ix jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">这个周末，我发布了<a class="ae ks" href="https://rubygems.org/gems/activeinteractor/versions/1.0.0" rel="noopener ugc nofollow" target="_blank"> ActiveInteractor </a>的1.0.0版本，这是一个基于<a class="ae ks" href="https://github.com/collectiveidea/interactor" rel="noopener ugc nofollow" target="_blank"> interactor </a> gem的带有<a class="ae ks" href="https://api.rubyonrails.org/classes/ActiveModel/Validations.html" rel="noopener ugc nofollow" target="_blank"> ActiveModel::Validations </a>的Ruby的<a class="ae ks" href="https://en.wikipedia.org/wiki/Command_pattern" rel="noopener ugc nofollow" target="_blank">命令模式</a>的实现，具有对属性、回调、验证和线程安全性能方法的丰富支持。</p><p id="8d15" class="pw-post-body-paragraph ju jv ix jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">我想复习一下宝石的一些基本用法。交互器是一个简单的、单一用途的服务对象。交互器可以用来减少控制器、工人和模型的责任，并封装应用程序的业务逻辑。每个交互器代表应用程序做的一件事。</p><p id="07bd" class="pw-post-body-paragraph ju jv ix jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">ActiveInteractor的主要组件称为Interactor，每个interactor都有自己的不可变上下文，其中包含interactor完成工作所需的一切。当一个交互体完成它的单一目的时，它会影响它给定的上下文。ActiveInteractor内置了两种交互器:基本交互器和组织器。基本交互器是一个从<code class="fe kt ku kv kw b">ActiveInteractor::Base</code>继承的类，它定义了一个<code class="fe kt ku kv kw b">#perform</code>方法。</p><h1 id="1e67" class="kx ky ix bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">基本用法:</h1><p id="aad4" class="pw-post-body-paragraph ju jv ix jw b jx lv jz ka kb lw kd ke kf lx kh ki kj ly kl km kn lz kp kq kr ij bi translated">大多数时候，你的应用程序会从它的控制器中使用它的交互器。以下控制器:</p><pre class="ma mb mc md gt me kw mf mg aw mh bi"><span id="70d5" class="mi ky ix kw b gy mj mk l ml mm">class SessionsController &lt; ApplicationController<br/>  def create<br/>    if user = User.authenticate(session_params[:email], session_params[:password])<br/>      session[:user_token] = user.secret_token<br/>      redirect_to user<br/>    else<br/>      flash.now[:message] = "Please try again."<br/>      render :new<br/>    end<br/>  end<br/><br/>  private<br/><br/>  def session_params<br/>    params.require(:session).permit(:email, :password)<br/>  end<br/>end</span></pre><p id="44a5" class="pw-post-body-paragraph ju jv ix jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">可以重构为:</p><pre class="ma mb mc md gt me kw mf mg aw mh bi"><span id="17e7" class="mi ky ix kw b gy mj mk l ml mm"># app/interactors/authenticate_user_context.rb<br/>class AuthenticateUserContext &lt; ActiveInteractor::Context::Base<br/>  attributes :email, :password, :user, :token<br/>  validates :email, presence: true,<br/>                    format: { with: URI::MailTo::EMAIL_REGEXP }<br/>  validates :password, presence: true<br/>  validates :user, presence: true, on: :called<br/>end</span><span id="b487" class="mi ky ix kw b gy mn mk l ml mm"># app/interactors/authenticate_user.rb<br/>class AuthenticateUser &lt; ActiveInteractor::Base<br/>  def perform<br/>    context.user = User.authenticate(<br/>      context.email,<br/>      context.password<br/>    )<br/>    context.token = context.user.secret_token<br/>  end<br/>end</span><span id="a78e" class="mi ky ix kw b gy mn mk l ml mm"># app/controllers/sessions_controller.rb<br/>class SessionsController &lt; ApplicationController<br/>  def create<br/>    result = AuthenticateUser.perform(session_params)<br/><br/>    if result.success?<br/>      session[:user_token] = result.token<br/>      redirect_to result.user<br/>    else<br/>      flash.now[:message] = t(result.errors.full_messages)<br/>      render :new<br/>    end<br/>  end<br/><br/>  private<br/><br/>  def session_params<br/>    params.require(:session).permit(:email, :password)<br/>  end<br/>end</span></pre><h1 id="a271" class="kx ky ix bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">组织者:</h1><p id="8a9b" class="pw-post-body-paragraph ju jv ix jw b jx lv jz ka kb lw kd ke kf lx kh ki kj ly kl km kn lz kp kq kr ij bi translated">组织者是基本交互者的一个重要变体。它的唯一目的是运行其他交互器。</p><pre class="ma mb mc md gt me kw mf mg aw mh bi"><span id="5162" class="mi ky ix kw b gy mj mk l ml mm">class CreateOrder &lt; ActiveInteractor::Base<br/>  def perform<br/>    ...<br/>  end<br/>end<br/><br/>class ChargeCard &lt; ActiveInteractor::Base<br/>  def perform<br/>    ...<br/>  end<br/>end<br/><br/>class SendThankYou &lt; ActiveInteractor::Base<br/>  def perform<br/>    ...<br/>  end<br/>end<br/><br/>class PlaceOrder &lt; ActiveInteractor::Organizer::Base<br/><br/>  organize :create_order, :charge_card, :send_thank_you<br/>end</span></pre><p id="5fd5" class="pw-post-body-paragraph ju jv ix jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">在控制器中，您可以像运行任何其他交互器一样运行<code class="fe kt ku kv kw b">PlaceOrder</code>管理器:</p><pre class="ma mb mc md gt me kw mf mg aw mh bi"><span id="fcca" class="mi ky ix kw b gy mj mk l ml mm">class OrdersController &lt; ApplicationController<br/>  def create<br/>    result = PlaceOrder.perform(order_params: order_params)<br/><br/>    if result.success?<br/>      redirect_to result.order<br/>    else<br/>      @order = result.order<br/>      render :new<br/>    end<br/>  end<br/><br/>  private<br/><br/>  def order_params<br/>    params.require(:order).permit!<br/>  end<br/>end</span></pre><p id="3744" class="pw-post-body-paragraph ju jv ix jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">组织者将其上下文传递给它所组织的交互者，一次一个，按顺序传递。每个交互器都可以在上下文传递给下一个交互器之前改变上下文。</p><h2 id="4ba0" class="mi ky ix bd kz mo mp dn ld mq mr dp lh kf ms mt ll kj mu mv lp kn mw mx lt my bi translated">有条件地组织互动者</h2><p id="aec4" class="pw-post-body-paragraph ju jv ix jw b jx lv jz ka kb lw kd ke kf lx kh ki kj ly kl km kn lz kp kq kr ij bi translated">我们还可以通过向<code class="fe kt ku kv kw b">.organize</code>方法传递一个块来向我们的组织者添加条件语句:</p><pre class="ma mb mc md gt me kw mf mg aw mh bi"><span id="4b9e" class="mi ky ix kw b gy mj mk l ml mm">class PlaceOrder &lt; ActiveInteractor::Organizer::Base<br/>  organize do<br/>    add :create_order, if :user_registered?<br/>    add :charge_card, if: -&gt; { context.order }<br/>    add :send_thank_you, if: -&gt; { context.order }<br/>  end<br/><br/>  private<br/><br/>  def user_registered?<br/>    context.user&amp;.registered?<br/>  end<br/>end</span></pre><h1 id="0f4c" class="kx ky ix bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">使用轨道</h1><p id="eaea" class="pw-post-body-paragraph ju jv ix jw b jx lv jz ka kb lw kd ke kf lx kh ki kj ly kl km kn lz kp kq kr ij bi translated">如果您正在使用rails项目，ActiveInteractor附带了一些有用的生成器来帮助加快开发速度。您应该首先使用以下命令运行安装生成器:</p><pre class="ma mb mc md gt me kw mf mg aw mh bi"><span id="d641" class="mi ky ix kw b gy mj mk l ml mm">rails generate active_interactor:install</span></pre><p id="4643" class="pw-post-body-paragraph ju jv ix jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">在某些情况下，您可能想要使用一个<code class="fe kt ku kv kw b">ActiveRecord</code>模型作为交互器的上下文。您可以通过在任何<code class="fe kt ku kv kw b">ActiveRecord</code>模型上调用<code class="fe kt ku kv kw b">.acts_as_context</code>方法来实现这一点，然后简单地在您的交互器或组织器上调用<code class="fe kt ku kv kw b">.contextualize_with</code>方法来将它指向适当的类。</p><pre class="ma mb mc md gt me kw mf mg aw mh bi"><span id="255d" class="mi ky ix kw b gy mj mk l ml mm"># app/models/user.rb<br/>class User &lt; ApplicationRecord<br/>  acts_as_context<br/>end<br/><br/># app/interactors/create_user.rb<br/>class CreateUser &lt; ApplicationInteractor<br/>  contextualize_with :user<br/><br/>  def perform<br/>    context.email&amp;.downcase!<br/>    context.save<br/>  end<br/>end<br/><br/>CreateUser.perform(email: 'HELLO@AARONMALLEN.ME')<br/>#=&gt; &lt;#User id=1 email='hello@aaronmallen.me'&gt;</span></pre><p id="a152" class="pw-post-body-paragraph ju jv ix jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">我希望ruby社区发现这个宝石是有用的，并且我喜欢任何反馈，问题，或者你愿意给出的<a class="ae ks" href="https://github.com/aaronmallen/activeinteractor" rel="noopener ugc nofollow" target="_blank">库</a>上的星星。宝石的详细用法可以在<a class="ae ks" href="https://github.com/aaronmallen/activeinteractor/wiki" rel="noopener ugc nofollow" target="_blank">维基</a>上找到。gem的技术文档可在<a class="ae ks" href="https://www.rubydoc.info/gems/activeinteractor" rel="noopener ugc nofollow" target="_blank"> rubydoc </a>上找到。</p></div></div>    
</body>
</html>