<html>
<head>
<title>Bringing realtime to serverless web applications</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">为无服务器web应用带来实时性</h1>
<blockquote>原文：<a href="https://itnext.io/using-iot-to-send-messages-back-to-your-serverless-front-end-fb335a099576?source=collection_archive---------1-----------------------#2019-03-16">https://itnext.io/using-iot-to-send-messages-back-to-your-serverless-front-end-fb335a099576?source=collection_archive---------1-----------------------#2019-03-16</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><p id="3740" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">有许多方法可以将结果返回到前端，但使用AWS IoT最容易实现实时选项。</p><p id="344b" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">在web应用程序中，通常有一个前端与REST APIs通信，以在后端完成工作。一般来说，API会返回一个结果，表示成功或者您正在从系统中检索某个值。</p><p id="9185" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">但是，在无服务器基础设施中有一类棘手的调用，返回值“消失”或者很难推回到前端，要么是因为花费的时间太长，要么是由于事件的连锁性质，发起调用方不再能够访问最终结果。</p><p id="c7ef" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">看一下这个例子:</p><figure class="kq kr ks kt gt ku gh gi paragraph-image"><div role="button" tabindex="0" class="kv kw di kx bf ky"><div class="gh gi kp"><img src="../Images/01dc8fcf26148128b68e9551d0118b17.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*OptI8ri3-5MMSjwYNMNPRg.png"/></div></div></figure><p id="168b" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">在这个图中，一些前端代码调用API gateway，在DynamoDB中产生一个条目，生成一个流，触发一个Lambda函数。但是最后一个Lambda函数的返回值无处可去。因此，如果有错误、问题或我们需要原始前端代码知道的东西，我们就有点卡住了。</p><p id="c88c" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">事实上，任何时候你将函数附加到S3、DynamoDB或任何其他AWS服务生成的事件上，返回值都不能被推回到链上。例如，如果您使用Rekognition来分析放入S3桶中的照片，则响应需要发送到函数返回值之外的其他地方。</p><p id="cc61" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">这些问题有几种解决方案，每一种都有自己的优缺点，这取决于您的使用情况。</p><h2 id="6583" class="lb lc it bd ld le lf dn lg lh li dp lj kb lk ll lm kf ln lo lp kj lq lr ls lt bi translated">选项1:等待</h2><figure class="kq kr ks kt gt ku gh gi paragraph-image"><div role="button" tabindex="0" class="kv kw di kx bf ky"><div class="gh gi kp"><img src="../Images/03c3ef0370befcd513315666037c3729.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*oncSTZWsz75m5gZWuXYE3A.png"/></div></div></figure><p id="6c45" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">在最简单的情况下，您有一个需要一段时间的函数，您可以等待。您受到API Gateway 30秒超时的限制，因此对于长期进程来说，这是行不通的。从成本角度来看，这也不好，因为你是在为等待付费。但是对于简单的、特定的、低使用率的应用程序，这是最简单的解决方案。</p><p id="b65b" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><em class="ko">示例</em>:每月一次，前端请求将一个大对象从一个S3桶复制到另一个区域，并等待3-5秒，直到S3确认成功完成。在这种情况下，可能不值得努力设计任何更复杂的东西。</p><h2 id="d348" class="lb lc it bd ld le lf dn lg lh li dp lj kb lk ll lm kf ln lo lp kj lq lr ls lt bi translated">选项2:轮询</h2><figure class="kq kr ks kt gt ku gh gi paragraph-image"><div role="button" tabindex="0" class="kv kw di kx bf ky"><div class="gh gi lu"><img src="../Images/4592969851bbb78b4e8aa70cc84a4822.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*VDP0fLT-XIV-fbATCdrYng.png"/></div></div></figure><p id="96f5" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">这适用于后端流程耗时超过几秒钟，或者执行时间可能超过API Gateway上30秒超时的情况。</p><p id="4008" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">这里，前端向API发出请求，发生了两件事:</p><ul class=""><li id="6a42" class="lv lw it js b jt ju jx jy kb lx kf ly kj lz kn ma mb mc md bi translated">被调用的函数立即响应，确认请求已被成功接收(但不是工作的结果)。该响应可能包括供前端稍后参考的ID(如果ID不是由前端首先生成的)。</li><li id="90a8" class="lv lw it js b jt me jx mf kb mg kf mh kj mi kn ma mb mc md bi translated">接下来，还有第二个API用于检查工作的状态，前端会定期轮询，直到报告工作完成，函数返回响应。在AWS中，这个状态函数通常会检查一个DynamoDB表，该表的ID是管理请求状态的ID。</li></ul><p id="bf66" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">这种方法很容易实现，但是会产生许多不必要的请求，并且不是实时的。例如，如果一个事务需要20秒，前端每秒轮询一次，那么在前端收到完成的响应之前，需要20-21个轮询请求。</p><p id="a047" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">在无服务器中，从成本的角度来看，这可能仍然是更可取的——20 x 100毫秒的请求比等待20秒的请求成本低，但有一个开销，这相当于让孩子在汽车后座反复问“我们到了吗？”。</p><h2 id="0933" class="lb lc it bd ld le lf dn lg lh li dp lj kb lk ll lm kf ln lo lp kj lq lr ls lt bi translated">选项3:物联网</h2><figure class="kq kr ks kt gt ku gh gi paragraph-image"><div role="button" tabindex="0" class="kv kw di kx bf ky"><div class="gh gi mj"><img src="../Images/f68ccea43d0af205583ef162246eb70a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*O_efEZ6JBn_GYvVgpJ350Q.png"/></div></div></figure><p id="86dd" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">虽然物联网让人联想到硬件设备的图像，但它也可以用于无服务器的网络应用。物联网使用名为MQTT的轻量级消息协议，这是一种简单高效的消息推送方式。</p><p id="ca3d" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">发布-订阅方法通常用于实时应用程序，但可以很好地解决这个问题。好处是你不需要写一个轮询函数或者做多个必要的请求，也不受API网关30秒超时的限制。更好的是，无论该过程需要5秒钟还是5分钟，前端都会立即知道任务何时完成，因为通信是实时的。</p><p id="0a39" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">对于仪表板这样的前端来说，这是一个很好的解决方案，在仪表板中，网页只需加载一次，但需要与后端数据的变化保持同步。但是，对于任何希望最大限度减少等待时间的时间关键型前端应用程序来说，它也非常有效。</p><p id="843c" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">在幕后，发布-订阅是复杂的，这是一个喋喋不休的过程，需要定期进行保持活动的pings，以确保各方仍在那里。幸运的是，AWS物联网设备SDK将这一切抽象化，使我们可以轻松构建一个前端，来侦听后端中一些远程进程生成的消息。</p><p id="1c48" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">从<a class="ae mk" href="https://aws.amazon.com/iot-core/pricing/" rel="noopener ugc nofollow" target="_blank">成本角度来看</a>，AWS按连接分钟数和消息数量收费(还有一个慷慨的免费层津贴)。一个客户端连接一整年将花费4.2美分(不包括数据费用)，因此，如果你有成千上万的用户，这些钱很重要，但仍然相对便宜。</p><h2 id="e5d1" class="lb lc it bd ld le lf dn lg lh li dp lj kb lk ll lm kf ln lo lp kj lq lr ls lt bi translated">构建物联网解决方案。</h2><p id="42a5" class="pw-post-body-paragraph jq jr it js b jt ml jv jw jx mm jz ka kb mn kd ke kf mo kh ki kj mp kl km kn im bi translated">举个简单的例子，我构建了将消息返回到浏览器前端所需的绝对最小值。我选择VueJS是因为更新显示很简单，如果您打算使用这种解决方案，单页面应用程序框架是一个很好的用例。</p><p id="74fa" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">首先，克隆我的来自https://gitlab.com/jbesw/askjames-iot-demo<a class="ae mk" href="https://gitlab.com/jbesw/askjames-iot-demo" rel="noopener ugc nofollow" target="_blank">的回购协议。这是一个包含许多文件的VueJs应用程序，但我们只关心这两个文件:</a></p><ul class=""><li id="b02b" class="lv lw it js b jt ju jx jy kb lx kf ly kj lz kn ma mb mc md bi translated">components/IoT.vue:它包含了所有的逻辑，并且基于IoT核心开发者网站的样板代码。</li><li id="00fb" class="lv lw it js b jt me jx mf kb mg kf mh kj mi kn ma mb mc md bi translated">App.vue:监听新消息并将内容放入<code class="fe mq mr ms mt b">&lt;h1&gt;</code>标签的主网页。</li></ul><p id="1919" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">在你能让这个做任何有意义的事情之前，你需要做两件事。首先，转到<a class="ae mk" href="https://console.aws.amazon.com/cognito/users/?region=us-east-1" rel="noopener ugc nofollow" target="_blank"> AWS Cognito </a>并点击“创建用户池”——提供一个名称，点击“查看默认值”，然后点击“创建池”。以下屏幕将显示一个池ID，您稍后需要复制该ID:</p><figure class="kq kr ks kt gt ku gh gi paragraph-image"><div role="button" tabindex="0" class="kv kw di kx bf ky"><div class="gh gi mu"><img src="../Images/877f96c70680f6cc27e369d3b251c705.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*15iScaH519nZf4xImFisCQ.png"/></div></div></figure><p id="b674" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">接下来，进入<a class="ae mk" href="https://console.aws.amazon.com/iot/" rel="noopener ugc nofollow" target="_blank"> AWS物联网控制台</a>。点击“管理”(自动选择“物品”子类别)，点击“创建”，然后点击“创建单个物品”。提供一个名称，单击“下一步”，然后单击“创建证书”(在“一键创建证书”选项旁边)。单击默认设置，直到看到新的https端点，并将其复制下来以备后用:</p><figure class="kq kr ks kt gt ku gh gi paragraph-image"><div role="button" tabindex="0" class="kv kw di kx bf ky"><div class="gh gi mv"><img src="../Images/ecd9576c4e126254002585432a0c257b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*9FC-X1qomfbFnKdt6CwTLg.png"/></div></div></figure><p id="bbc7" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">回到repo，打开IoT.vue，在AWSConfiguration中输入您的池ID和主机(端点):</p><figure class="kq kr ks kt gt ku gh gi paragraph-image"><div class="gh gi mw"><img src="../Images/99d4d17fbf0ba23a67922a9a83ba5799.png" data-original-src="https://miro.medium.com/v2/resize:fit:1260/format:webp/1*3NdbM0Nm8Kn_cNLTabJtvA.png"/></div></figure><p id="2664" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">在控制台中键入<code class="fe mq mr ms mt b">npm run dev</code>并访问<a class="ae mk" href="http://localhost:8080" rel="noopener ugc nofollow" target="_blank"> http://localhost:8080 </a>来启动您的应用程序:</p><figure class="kq kr ks kt gt ku gh gi paragraph-image"><div role="button" tabindex="0" class="kv kw di kx bf ky"><div class="gh gi mx"><img src="../Images/7630b75900ed4499e589d4d7f26f065b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*YbzxZ-Ul55sdJzX4gJDQyA.png"/></div></div></figure><p id="bde3" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">现在回到物联网控制台，单击左侧菜单中的“测试”选项。选择“发布”，输入“askJames”作为主题，然后在下面的JSON中输入消息。当您单击“发布到主题”时，消息将立即出现在浏览器窗口中:</p><figure class="kq kr ks kt gt ku gh gi paragraph-image"><div role="button" tabindex="0" class="kv kw di kx bf ky"><div class="gh gi my"><img src="../Images/4291d05756fb1e6f7c7de8bfdccb0b0c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*cs_ODD810Jp7VLcVnmPAMw.png"/></div></div></figure><p id="e2c9" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">刚刚发生了什么？我们创造了一个物联网“东西”,既可以发布，也可以订阅。实际上，您可以在整个应用程序中使用Lambda函数进行发布，使用类似repo:</p><figure class="kq kr ks kt gt ku gh gi paragraph-image"><div role="button" tabindex="0" class="kv kw di kx bf ky"><div class="gh gi mz"><img src="../Images/304308683e10ca7adfa2e7d12b219a70.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*XYjEOoq1oC1nR0HQ7G_KDw.png"/></div></div></figure><p id="a810" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">有趣的是，前端应用程序使用SDK连接到物联网基础设施，并等待消息。它足够聪明，能够在断线和多日开放的情况下存活下来。它还可以处理大规模扇出操作，因此如果您有数万个(或更多)用户，它将毫无问题地进行扩展。此外，在生产系统中，您可以使用Cognito来确保订阅者只收听他们被授权的主题。</p><p id="9487" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">回到我们最初的问题，如果操作ID作为消息有效负载的一部分通过物联网基础设施传递回来，前端可以对此进行过滤，并检测操作何时完成。总的来说，这是一种简单、优雅的方式来解决将响应推回到前端应用程序的问题。</p></div></div>    
</body>
</html>