<html>
<head>
<title>Debugging Kubernetes PVCs</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">调试Kubernetes PVCs</h1>
<blockquote>原文：<a href="https://itnext.io/debugging-kubernetes-pvcs-a150f5efbe95?source=collection_archive---------1-----------------------#2018-08-03">https://itnext.io/debugging-kubernetes-pvcs-a150f5efbe95?source=collection_archive---------1-----------------------#2018-08-03</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="796e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">有时我发现容器中出现问题，存储在持久卷中的一些数据被破坏。这可能导致我不得不亲自动手，在文件系统中摸索一番。</p><p id="45b2" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">最近我试着用一个<a class="ae kl" href="https://github.com/prometheus/prometheus" rel="noopener ugc nofollow" target="_blank">普罗米修斯</a>容器做这件事，发现容器里面没有外壳和环境(最佳实践！).这意味着我需要将<a class="ae kl" href="https://kubernetes.io/docs/concepts/storage/persistent-volumes/#persistentvolumeclaims" rel="noopener ugc nofollow" target="_blank"> PVC </a>连接到一个不同的pod上，我可以用它来调试环境。</p><h1 id="a936" class="km kn iq bd ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj bi translated">分离该卷</h1><p id="d3dc" class="pw-post-body-paragraph jn jo iq jp b jq lk js jt ju ll jw jx jy lm ka kb kc ln ke kf kg lo ki kj kk ij bi translated">由于数据损坏，容器陷入重新启动循环。所以第一步是将部署规模缩小到零。</p><pre class="lp lq lr ls gt lt lu lv lw aw lx bi"><span id="995e" class="ly kn iq lu b gy lz ma l mb mc">$ kubectl scale deployment my-deployment --replicas=0<br/>deployment.extensions "my-deployment" scaled</span></pre><h1 id="2063" class="km kn iq bd ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj bi translated">创建调试窗格</h1><p id="f312" class="pw-post-body-paragraph jn jo iq jp b jq lk js jt ju ll jw jx jy lm ka kb kc ln ke kf kg lo ki kj kk ij bi translated">现在，我需要检查部署，找出我想要探索的PVC。</p><pre class="lp lq lr ls gt lt lu lv lw aw lx bi"><span id="8876" class="ly kn iq lu b gy lz ma l mb mc">$ kubectl describe deployment my-deployment | grep ClaimName<br/>ClaimName:  my-claim</span></pre><p id="284f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">然后，我想创建一个新的pod规格，它安装相同的PVC，但使用不同的docker映像。在这个例子中，我将使用busybox，因为我只需要一个基本的shell，但是您可以使用任何调试工具映像。</p><pre class="lp lq lr ls gt lt lu lv lw aw lx bi"><span id="c3af" class="ly kn iq lu b gy lz ma l mb mc"># my-pvc-debugger.yaml</span><span id="c9b0" class="ly kn iq lu b gy md ma l mb mc">kind: Pod<br/>apiVersion: v1<br/>metadata:<br/>  name: volume-debugger<br/>spec:<br/>  volumes:<br/>    - name: volume-to-debug<br/>      persistentVolumeClaim:<br/>       claimName: &lt;CLAIM NAME GOES HERE&gt;<br/>  containers:<br/>    - name: debugger<br/>      image: busybox<br/>      command: ['sleep', '3600']<br/>      volumeMounts:<br/>        - mountPath: "/data"<br/>          name: volume-to-debug</span></pre><p id="a7c2" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">然后，我创建这个pod，并在其中运行一个shell。</p><pre class="lp lq lr ls gt lt lu lv lw aw lx bi"><span id="9998" class="ly kn iq lu b gy lz ma l mb mc">$ kubectl create -f /path/to/my-pvc-debugger.yaml<br/>pod "volume-debugger" created<br/>$ kubectl exec -it volume-debugger sh<br/>/ #</span></pre><p id="b4b2" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在我在容器内部，我可以探索在<code class="fe me mf mg lu b">/data</code>装载的卷并修复问题。</p><h1 id="6500" class="km kn iq bd ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj bi translated">缩小比例</h1><p id="d3dd" class="pw-post-body-paragraph jn jo iq jp b jq lk js jt ju ll jw jx jy lm ka kb kc ln ke kf kg lo ki kj kk ij bi translated">一旦我对这个卷满意了，我就可以在容器中退出我的shell并删除debugger pod。</p><pre class="lp lq lr ls gt lt lu lv lw aw lx bi"><span id="c5bc" class="ly kn iq lu b gy lz ma l mb mc">/ # logout<br/>$ kubectl delete -f /path/to/my-pvc-debugger.yaml</span></pre><p id="f36c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">最后，我可以扩展我的部署。</p><pre class="lp lq lr ls gt lt lu lv lw aw lx bi"><span id="e0b7" class="ly kn iq lu b gy lz ma l mb mc">$ kubectl scale deployment my-deployment --replicas=1<br/>deployment.extensions "my-deployment" scaled</span></pre><h1 id="59a2" class="km kn iq bd ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj bi translated">结论</h1><p id="b4c5" class="pw-post-body-paragraph jn jo iq jp b jq lk js jt ju ll jw jx jy lm ka kb kc ln ke kf kg lo ki kj kk ij bi translated">在一个完美的世界里，我们永远都不应该接触到我们的卷，但是偶尔的错误会导致我们不得不去清理东西。此示例显示了一种快速跳转到没有任何用户环境的容器的卷中的方法。</p></div></div>    
</body>
</html>