<html>
<head>
<title>Traffic Management using Istio 101</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Istio 101进行交通管理</h1>
<blockquote>原文：<a href="https://itnext.io/traffic-management-using-istio-b49663da3e8d?source=collection_archive---------1-----------------------#2022-08-31">https://itnext.io/traffic-management-using-istio-b49663da3e8d?source=collection_archive---------1-----------------------#2022-08-31</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><h1 id="abd7" class="jn jo iq bd jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk bi translated">目的</h1><p id="bdbc" class="pw-post-body-paragraph kl km iq kn b ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">最近我读了一位同事的博客，内容是关于Istio如何超越所有其他Kubernetes部署的入口解决方案。博客提到，Istio有一个巨大的流量管理功能集，这让我对Istio及其功能感兴趣。所以我钻研了非常全面和描述性的Istio文档。我写这些是为了巩固我的理解，并分享我在玩它时学到的东西。Istio有许多特性，但在本文中，我们将触及由Istio服务网格提供的流量管理特性的基础。</p><h1 id="88b0" class="jn jo iq bd jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk bi translated">Istio交通管理简介</h1><p id="49c4" class="pw-post-body-paragraph kl km iq kn b ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated"><strong class="kn ir">流量管理</strong> t是<a class="ae lj" href="https://istio.io/latest/" rel="noopener ugc nofollow" target="_blank"> Istio </a>服务网格除了<strong class="kn ir">可观察性、安全性、可扩展性之外提供的主要特性。</strong>为了在您的网状网络中引导流量，Istio需要知道您的所有端点在哪里，以及它们属于哪些服务。为了填充自己的服务注册中心，Istio连接到一个服务发现系统。例如，如果您在Kubernetes集群上安装了Istio，那么Istio会自动检测该集群中的服务和端点。</p><p id="a2ee" class="pw-post-body-paragraph kl km iq kn b ko lk kq kr ks ll ku kv kw lm ky kz la ln lc ld le lo lg lh li ij bi translated">虽然Istio的基本服务发现和负载平衡为您提供了一个有效的服务网格，但这还远远不够。在许多情况下，您可能希望对网格流量进行更细粒度的控制。作为A/B测试的一部分，您可能<strong class="kn ir">希望将特定百分比的流量</strong>导向新版本的服务，或者对特定服务实例子集的流量应用不同的负载平衡策略。您可能还想对进出网格的流量应用特殊的规则，或者将网格的外部依赖关系添加到服务注册中心。通过使用Istio的流量管理API向Istio添加您自己的流量配置，您可以做到所有这些以及更多。</p><p id="9e30" class="pw-post-body-paragraph kl km iq kn b ko lk kq kr ks ll ku kv kw lm ky kz la ln lc ld le lo lg lh li ij bi translated">像其他Istio配置一样，<strong class="kn ir"> API是使用Kubernetes自定义资源定义(CRDs) </strong>指定的，您可以使用YAML进行配置。我们将研究大部分流量管理API资源，以及使用Istio提供的示例应用程序可以做些什么。</p><p id="3bed" class="pw-post-body-paragraph kl km iq kn b ko lk kq kr ks ll ku kv kw lm ky kz la ln lc ld le lo lg lh li ij bi translated">Istio还支持典型的<a class="ae lj" href="https://istio.io/latest/docs/tasks/traffic-management/ingress/kubernetes-ingress/" rel="noopener ugc nofollow" target="_blank"> Kubernetes ingress </a>资源。但是建议使用<a class="ae lj" href="https://istio.io/latest/docs/tasks/traffic-management/ingress/ingress-control/" rel="noopener ugc nofollow" target="_blank"> Istio网关</a>，而不是Ingress，以利用Istio提供的全部功能，例如丰富的流量管理和安全功能。您将在测试中使用Istio入口网关。</p><h1 id="02f6" class="jn jo iq bd jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk bi translated">测试设置</h1><ol class=""><li id="6bb0" class="lp lq iq kn b ko kp ks kt kw lr la ls le lt li lu lv lw lx bi translated">创建一个GKE集群<a class="ae lj" href="https://cloud.google.com/kubernetes-engine/docs/deploy-app-cluster#create_cluster" rel="noopener ugc nofollow" target="_blank">https://cloud . Google . com/kubernetes-engine/docs/deploy-app-cluster # create _ cluster</a></li><li id="4692" class="lp lq iq kn b ko ly ks lz kw ma la mb le mc li lu lv lw lx bi translated">打开cloud shell，对GKE集群进行身份验证，以便可以在cloud shell中使用kubectl和helm。</li><li id="0e97" class="lp lq iq kn b ko ly ks lz kw ma la mb le mc li lu lv lw lx bi translated">在云shell中运行下面的shell脚本</li></ol><figure class="md me mf mg gt mh"><div class="bz fp l di"><div class="mi mj l"/></div><figcaption class="mk ml gj gh gi mm mn bd b be z dk translated">setup-istio.sh</figcaption></figure><p id="ba14" class="pw-post-body-paragraph kl km iq kn b ko lk kq kr ks ll ku kv kw lm ky kz la ln lc ld le lo lg lh li ij bi translated">4.运行下面的脚本来部署BookInfo应用程序(由Istio提供用于演示目的)。</p><figure class="md me mf mg gt mh"><div class="bz fp l di"><div class="mi mj l"/></div><figcaption class="mk ml gj gh gi mm mn bd b be z dk translated">setup-biapp.sh</figcaption></figure><p id="5465" class="pw-post-body-paragraph kl km iq kn b ko lk kq kr ks ll ku kv kw lm ky kz la ln lc ld le lo lg lh li ij bi translated">使用以下命令查看配置</p><pre class="md me mf mg gt mo mp mq mr aw ms bi"><span id="d262" class="mt jo iq mp b gy mu mv l mw mx">alias kgar="kubectl api-resources -o name --namespaced=true --verbs=list | xargs -n 1 kubectl get --ignore-not-found=true --show-kind"</span><span id="2637" class="mt jo iq mp b gy my mv l mw mx">kgar -n appbi<br/>kgar -n istio-ingress<br/>kgar -n istio-system</span></pre><p id="8db8" class="pw-post-body-paragraph kl km iq kn b ko lk kq kr ks ll ku kv kw lm ky kz la ln lc ld le lo lg lh li ij bi translated">5.通过执行以下命令来配置网关和虚拟服务</p><figure class="md me mf mg gt mh"><div class="bz fp l di"><div class="mi mj l"/></div><figcaption class="mk ml gj gh gi mm mn bd b be z dk translated">bookinfo-gateway.yaml</figcaption></figure><pre class="md me mf mg gt mo mp mq mr aw ms bi"><span id="e624" class="mt jo iq mp b gy mu mv l mw mx">kubectl apply -f bookinfo-gateway.yaml -n appbi</span></pre><p id="a16a" class="pw-post-body-paragraph kl km iq kn b ko lk kq kr ks ll ku kv kw lm ky kz la ln lc ld le lo lg lh li ij bi translated">此时，您的配置如下所示(这是我的<a class="ae lj" href="https://kiali.io/" rel="noopener ugc nofollow" target="_blank"> kiali </a>仪表板的快照)</p><figure class="md me mf mg gt mh gh gi paragraph-image"><div role="button" tabindex="0" class="na nb di nc bf nd"><div class="gh gi mz"><img src="../Images/399a42824e2c612f4ab661336ab8d82f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*6GxUSe5blrZrgxWiKm8wfw.png"/></div></div><figcaption class="mk ml gj gh gi mm mn bd b be z dk translated">图1 Bookinfo应用图表</figcaption></figure><p id="a59c" class="pw-post-body-paragraph kl km iq kn b ko lk kq kr ks ll ku kv kw lm ky kz la ln lc ld le lo lg lh li ij bi translated">正如您所看到的，istio-ingress pod将流量定向到productpage-v1部署，而productpage-v1连接到reviews应用程序，该应用程序有3个部署，分别使用不同版本的应用程序。productpage-v1还连接到details-v1部署。评论应用v2和v3连接到评级-v1应用。</p><h1 id="67e2" class="jn jo iq bd jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk bi translated">方法</h1><p id="7a2f" class="pw-post-body-paragraph kl km iq kn b ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">您将使用一个<a class="ae lj" href="https://istio.io/latest/docs/reference/config/networking/gateway/#Gateway" rel="noopener ugc nofollow" target="_blank">网关</a>来管理您的网格的入站和出站流量，让您指定想要进入或离开网格的流量。<strong class="kn ir">网关配置适用于在网格边缘运行的独立特使代理，即istio-ingress(在命名空间istio-ingress中)</strong>，而不是与您的服务工作负载一起运行的sidecar特使代理。<code class="fe ng nh ni mp b">Gateway</code>配置资源允许外部流量进入Istio服务网格，并使Istio的流量管理和策略功能可用于边缘服务。</p><p id="b833" class="pw-post-body-paragraph kl km iq kn b ko lk kq kr ks ll ku kv kw lm ky kz la ln lc ld le lo lg lh li ij bi translated">Istio的网关资源只允许您配置第4层到第6层负载平衡属性，如要公开的端口、TLS设置等。然后，不是将应用层流量路由(L7)添加到同一个API资源，而是将一个常规的Istio <a class="ae lj" href="https://istio.io/latest/docs/concepts/traffic-management/#virtual-services" rel="noopener ugc nofollow" target="_blank">虚拟服务</a>绑定到网关。这使您可以像管理Istio网格中的任何其他数据平面流量一样管理网关流量。</p><p id="ae55" class="pw-post-body-paragraph kl km iq kn b ko lk kq kr ks ll ku kv kw lm ky kz la ln lc ld le lo lg lh li ij bi translated">让我们检查一下网关CRD的定义。</p><pre class="md me mf mg gt mo mp mq mr aw ms bi"><span id="27d5" class="mt jo iq mp b gy mu mv l mw mx">kubectl get gateway -n appbi -o yaml</span></pre><ul class=""><li id="0e03" class="lp lq iq kn b ko lk ks ll kw nj la nk le nl li nm lv lw lx bi translated">选择器<em class="nn"> istio: ingress </em>应该是命名空间istio-ingress(独立特使代理)中部署istio-ingress的标签</li><li id="6fa2" class="lp lq iq kn b ko ly ks lz kw ma la mb le mc li nm lv lw lx bi translated">此网关配置允许来自<code class="fe ng nh ni mp b">bookinfo.app.io</code>(来自主机列表)的HTTP流量通过端口80进入网状网络，但不为流量指定任何路由。</li><li id="8df3" class="lp lq iq kn b ko ly ks lz kw ma la mb le mc li nm lv lw lx bi translated">如果您使用子域，主机列表中可以有“n”个主机，您可以从这些主机允许流量进入服务网格。</li><li id="e25e" class="lp lq iq kn b ko ly ks lz kw ma la mb le mc li nm lv lw lx bi translated">要指定路由并使网关按预期工作，还必须将网关绑定到虚拟服务。您可以使用虚拟服务的<code class="fe ng nh ni mp b">gateways</code>字段来实现这一点(稍后您将会看到)。</li><li id="0f7f" class="lp lq iq kn b ko ly ks lz kw ma la mb le mc li nm lv lw lx bi translated">您也可以在网关上配置tls配置(本文没有涉及)，您可以使用下面的命令检查选项。</li></ul><pre class="md me mf mg gt mo mp mq mr aw ms bi"><span id="c75e" class="mt jo iq mp b gy mu mv l mw mx">kubectl explain gateway.spec.servers.tls</span></pre><p id="43b1" class="pw-post-body-paragraph kl km iq kn b ko lk kq kr ks ll ku kv kw lm ky kz la ln lc ld le lo lg lh li ij bi translated"><strong class="kn ir">注意:要使用网关资源，必须存在Istio ingress独立特使代理(</strong> <em class="nn"> istio-ingress名称空间</em> <strong class="kn ir">中的istio-ingress部署)。</strong></p><p id="10d0" class="pw-post-body-paragraph kl km iq kn b ko lk kq kr ks ll ku kv kw lm ky kz la ln lc ld le lo lg lh li ij bi translated">要研究和查看所有选项，请参考<a class="ae lj" href="https://istio.io/latest/docs/reference/config/networking/gateway/" rel="noopener ugc nofollow" target="_blank">官方指南</a>。</p><h1 id="26b3" class="jn jo iq bd jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk bi translated">虚拟服务</h1><p id="3714" class="pw-post-body-paragraph kl km iq kn b ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">虚拟服务以及<a class="ae lj" href="https://istio.io/latest/docs/concepts/traffic-management/#destination-rules" rel="noopener ugc nofollow" target="_blank">目的地规则</a>，是Istio流量路由功能的关键组成部分。虚拟服务允许您配置如何将请求路由到Istio服务网格中的服务。每个虚拟服务由一组按顺序评估的路由规则组成，让Istio将虚拟服务的每个给定请求匹配到网格中的一个特定实际目的地。路由规则按从上到下的顺序进行评估，虚拟服务定义中的第一个规则被赋予最高优先级。根据您的使用情况，您的网格可能需要多个虚拟服务，也可能不需要。</p><p id="109d" class="pw-post-body-paragraph kl km iq kn b ko lk kq kr ks ll ku kv kw lm ky kz la ln lc ld le lo lg lh li ij bi translated">如果您希望基于不同服务版本之间的百分比来配置流量路由，或者将流量从内部用户定向到一组特定的实例，虚拟服务非常有用。你可以在使用Istio  的 <a class="ae lj" href="https://istio.io/latest/blog/2017/0.1-canary/" rel="noopener ugc nofollow" target="_blank"> <strong class="kn ir">金丝雀部署中了解更多关于虚拟服务如何帮助<strong class="kn ir">金丝雀部署的信息。</strong></strong></a></p><p id="bc75" class="pw-post-body-paragraph kl km iq kn b ko lk kq kr ks ll ku kv kw lm ky kz la ln lc ld le lo lg lh li ij bi translated">使用虚拟服务，您可以为一个或多个主机名指定流量行为。您在虚拟服务中使用路由规则，告诉Envoy如何将虚拟服务的流量发送到适当的目的地。路径目的地可以是相同服务的版本，也可以是完全不同的服务。</p><p id="9144" class="pw-post-body-paragraph kl km iq kn b ko lk kq kr ks ll ku kv kw lm ky kz la ln lc ld le lo lg lh li ij bi translated">让我们检查一下您部署的虚拟服务CRD定义。</p><pre class="md me mf mg gt mo mp mq mr aw ms bi"><span id="acc9" class="mt jo iq mp b gy mu mv l mw mx">kubectl  get virtualservice -n appbi -o yaml</span></pre><ul class=""><li id="242f" class="lp lq iq kn b ko lk ks ll kw nj la nk le nl li nm lv lw lx bi translated"><code class="fe ng nh ni mp b">hosts</code>字段列出了虚拟服务的主机——这是客户端向服务发送请求时使用的一个或多个地址。在本例中是“bookinfo.app.io”。</li><li id="d3ba" class="lp lq iq kn b ko ly ks lz kw ma la mb le mc li nm lv lw lx bi translated"><code class="fe ng nh ni mp b">gateways</code>字段列出了与虚拟服务相关的网关对象。您将这个虚拟服务与您之前定义的网关“bookinfo”相关联。</li><li id="ceda" class="lp lq iq kn b ko ly ks lz kw ma la mb le mc li nm lv lw lx bi translated"><code class="fe ng nh ni mp b">http</code>部分包含虚拟服务的<strong class="kn ir">路由规则</strong>，描述匹配条件和动作，用于路由发送到主机字段中指定的目的地的HTTP/1.1、HTTP2和gRPC流量。</li></ul><p id="7a4b" class="pw-post-body-paragraph kl km iq kn b ko lk kq kr ks ll ku kv kw lm ky kz la ln lc ld le lo lg lh li ij bi translated"><strong class="kn ir">路由规则</strong></p><ul class=""><li id="69ac" class="lp lq iq kn b ko lk ks ll kw nj la nk le nl li nm lv lw lx bi translated">如您所见，有两条路由规则。</li><li id="c886" class="lp lq iq kn b ko ly ks lz kw ma la mb le mc li nm lv lw lx bi translated">第一个具有匹配的条件，即请求uri是“/productpage”还是“/static”或“/login”等。，将请求路由到端口9080处的目标服务“product page . app bi . SVC . cluster . local”。然后，Envoy代理将接管与服务“product page . appbi . SVC . cluster . local”相关联的pod的请求并对其进行负载平衡。当客户试图联系http://bookinfo.app.io/productpage.时，上述规则适用</li><li id="2563" class="lp lq iq kn b ko ly ks lz kw ma la mb le mc li nm lv lw lx bi translated">第二个路由没有匹配的条件，所以它充当所有请求的默认路由，没有任何URI上下文路径。路线目的地与上一个相同，但有一个额外的地图“重写”。“重写”有助于在转发到目的地之前重写URI。因此，如果客户端试图访问http://bookinfo.app.io/,特使代理设置目的地为与端口9080的服务“product page . appbi . SVC . cluster . local”相关联的pod，URI上下文路径为“/productpage”。</li></ul><p id="020b" class="pw-post-body-paragraph kl km iq kn b ko lk kq kr ks ll ku kv kw lm ky kz la ln lc ld le lo lg lh li ij bi translated">我们之前讨论了使用虚拟服务基于不同服务版本的百分比来配置路由的方法，但是到目前为止还没有这样的方法。因为您有一个“reviews”应用程序，它有3个部署，分别使用不同版本的应用程序，所以您可以使用一个新的虚拟服务来基于百分比定义路线。</p><figure class="md me mf mg gt mh"><div class="bz fp l di"><div class="mi mj l"/></div><figcaption class="mk ml gj gh gi mm mn bd b be z dk translated">vs-review.yaml</figcaption></figure><pre class="md me mf mg gt mo mp mq mr aw ms bi"><span id="bdd5" class="mt jo iq mp b gy mu mv l mw mx">kubectl apply -f vs-reviews.yaml -n appbi</span></pre><p id="2df2" class="pw-post-body-paragraph kl km iq kn b ko lk kq kr ks ll ku kv kw lm ky kz la ln lc ld le lo lg lh li ij bi translated">这将创建一个新的虚拟服务“评论”。</p><ul class=""><li id="4c33" class="lp lq iq kn b ko lk ks ll kw nj la nk le nl li nm lv lw lx bi translated">没有与之相关联的网关，因为这是用于服务网格内的流量。</li><li id="15d3" class="lp lq iq kn b ko ly ks lz kw ma la mb le mc li nm lv lw lx bi translated">没有匹配的条件，所以它适用于所有定向到点评应用程序的流量。</li><li id="f61e" class="lp lq iq kn b ko ly ks lz kw ma la mb le mc li nm lv lw lx bi translated">有一个路由规则定义了3条不同的目的地路由。每个目的地有不同的权重(以百分比表示)。虽然主机字段(不同于virtualservice.spec.hosts下的字段)对于所有目的地都是相同的，但是请注意“子集”是不同的，并且与同一应用程序的不同版本相关联。子集定义将在destinationrule CRD中介绍(稍后将介绍)。<strong class="kn ir">这个规则基本上说，服务“评论”的流量的50%应该被定向到子集v1，40 %应该被定向到子集v2，10%应该被定向到子集v3。</strong></li></ul><p id="5d28" class="pw-post-body-paragraph kl km iq kn b ko lk kq kr ks ll ku kv kw lm ky kz la ln lc ld le lo lg lh li ij bi translated">为了实现上述功能，您需要定义一个目的地规则，在这里您将定义子集v1、v2和v3的含义。</p><p id="a8be" class="pw-post-body-paragraph kl km iq kn b ko lk kq kr ks ll ku kv kw lm ky kz la ln lc ld le lo lg lh li ij bi translated">正如您在上面看到的，路由规则是将特定流量子集路由到特定目的地的强大工具。您可以在流量端口、报头字段、URIs等方面设置匹配条件。<strong class="kn ir">所有选项的完整参考可以在官方</strong> <a class="ae lj" href="https://istio.io/latest/docs/reference/config/networking/virtual-service/" rel="noopener ugc nofollow" target="_blank"> <strong class="kn ir">文档</strong> </a> <strong class="kn ir">中找到。</strong></p><h1 id="6160" class="jn jo iq bd jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk bi translated">目的地规则</h1><p id="2d09" class="pw-post-body-paragraph kl km iq kn b ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">与虚拟服务一样，目的地规则也是Istio流量路由功能的关键部分。您可以将虚拟服务视为如何将流量路由到给定目的地，然后使用目的地规则来配置该目的地的流量。评估虚拟服务路由规则后应用目的地规则，因此它们适用于流量的“真实”目的地。</p><p id="55d5" class="pw-post-body-paragraph kl km iq kn b ko lk kq kr ks ll ku kv kw lm ky kz la ln lc ld le lo lg lh li ij bi translated">特别是，您使用目的地规则来指定命名的服务子集，例如按版本对所有给定服务的实例进行分组。然后，您可以在虚拟服务的路由规则中使用这些服务子集来控制到不同服务实例的流量。</p><p id="d52d" class="pw-post-body-paragraph kl km iq kn b ko lk kq kr ks ll ku kv kw lm ky kz la ln lc ld le lo lg lh li ij bi translated">让我们为评论应用程序做它。</p><figure class="md me mf mg gt mh"><div class="bz fp l di"><div class="mi mj l"/></div><figcaption class="mk ml gj gh gi mm mn bd b be z dk translated">dr-reviews.yaml</figcaption></figure><pre class="md me mf mg gt mo mp mq mr aw ms bi"><span id="0edd" class="mt jo iq mp b gy mu mv l mw mx">kubectl apply -f dr-reviews.yaml -n appbi</span></pre><p id="d5fb" class="pw-post-body-paragraph kl km iq kn b ko lk kq kr ks ll ku kv kw lm ky kz la ln lc ld le lo lg lh li ij bi translated">让我们检查您部署的目标规则CRD定义。</p><ul class=""><li id="311d" class="lp lq iq kn b ko lk ks ll kw nj la nk le nl li nm lv lw lx bi translated">您已经定义了子集列表。列表项是为每个子集定义标签的地图。</li><li id="8bbc" class="lp lq iq kn b ko ly ks lz kw ma la mb le mc li nm lv lw lx bi translated">每个子集都是基于一个或多个<code class="fe ng nh ni mp b">labels</code>定义的，在Kubernetes中，这些是附属于对象(如pod)的键/值对。这些标签作为<code class="fe ng nh ni mp b">metadata</code>应用于Kubernetes服务的部署中，以识别不同的版本。标签实际上是目的舱的选择器。您可以检查特定子集的流量将被定向到哪个pod。例如，假设您想要查找子集v1的窗格，您可以使用下面的命令进行检查。</li></ul><pre class="md me mf mg gt mo mp mq mr aw ms bi"><span id="76d8" class="mt jo iq mp b gy mu mv l mw mx">kubectl get pod -n appbi --selector=version=v1,app=reviews</span></pre><p id="c8f7" class="pw-post-body-paragraph kl km iq kn b ko lk kq kr ks ll ku kv kw lm ky kz la ln lc ld le lo lg lh li ij bi translated">现在您已经为reviews应用程序部署了虚拟服务和DestinationRule，您可以进行测试了。</p><pre class="md me mf mg gt mo mp mq mr aw ms bi"><span id="9fb1" class="mt jo iq mp b gy mu mv l mw mx">kubectl get svc istio-ingress -n istio-ingress -o jsonpath='{.status.loadBalancer.ingress[0].ip}';echo ""</span></pre><p id="8e01" class="pw-post-body-paragraph kl km iq kn b ko lk kq kr ks ll ku kv kw lm ky kz la ln lc ld le lo lg lh li ij bi translated">使用上面的命令获取LB的公共IP，并将其作为“bookinfo.app.io”添加到客户机上的hosts文件中。观察书评区显示不同的“书评”用户界面，即v1没有星星，v2有黑星，v3有红星。经常查看刷新应用程序页面时显示的UI。</p><p id="3f29" class="pw-post-body-paragraph kl km iq kn b ko lk kq kr ks ll ku kv kw lm ky kz la ln lc ld le lo lg lh li ij bi translated">如官方Istio博客所示，这一特性可用于canary部署。</p><p id="6efc" class="pw-post-body-paragraph kl km iq kn b ko lk kq kr ks ll ku kv kw lm ky kz la ln lc ld le lo lg lh li ij bi translated">您可以在<a class="ae lj" href="https://istio.io/latest/docs/reference/config/networking/destination-rule/" rel="noopener ugc nofollow" target="_blank">目的地规则参考</a>中看到目的地规则选项的完整列表。</p><h2 id="7b72" class="mt jo iq bd jp no np dn jt nq nr dp jx kw ns nt kb la nu nv kf le nw nx kj ny bi translated">入口请求流</h2><p id="64b9" class="pw-post-body-paragraph kl km iq kn b ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">下图显示了流量如何通过负载平衡器、Istio入口网关和服务于web应用程序的服务网格从客户端流向pods。</p><figure class="md me mf mg gt mh gh gi paragraph-image"><div role="button" tabindex="0" class="na nb di nc bf nd"><div class="gh gi nz"><img src="../Images/1bc1f6b01a107a60074d7db351f0e6d5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*rp5Ux7kkFKGqypJAXmblCw.png"/></div></div><figcaption class="mk ml gj gh gi mm mn bd b be z dk translated">IstioIngressGateway</figcaption></figure><p id="ec47" class="pw-post-body-paragraph kl km iq kn b ko lk kq kr ks ll ku kv kw lm ky kz la ln lc ld le lo lg lh li ij bi translated">流量一旦到达作为istio-ingress运行的独立特使代理，就进入网状网络。</p><h1 id="203b" class="jn jo iq bd jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk bi translated">服务条目</h1><p id="52b1" class="pw-post-body-paragraph kl km iq kn b ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">您使用一个<a class="ae lj" href="https://istio.io/latest/docs/reference/config/networking/service-entry/#ServiceEntry" rel="noopener ugc nofollow" target="_blank">服务条目</a>向Istio内部维护的服务注册中心添加一个条目。添加服务条目后，特使代理可以向该服务发送流量，就像它是您的网格中的服务一样。</p><p id="3d09" class="pw-post-body-paragraph kl km iq kn b ko lk kq kr ks ll ku kv kw lm ky kz la ln lc ld le lo lg lh li ij bi translated">通过配置服务条目，您可以管理在网格外部运行的服务的流量，包括以下任务:</p><ul class=""><li id="c72a" class="lp lq iq kn b ko lk ks ll kw nj la nk le nl li nm lv lw lx bi translated">重定向和转发外部目的地的流量，例如从web使用的API，或者到传统基础设施中的服务的流量。</li><li id="6b29" class="lp lq iq kn b ko ly ks lz kw ma la mb le mc li nm lv lw lx bi translated">为外部目的地定义<a class="ae lj" href="https://istio.io/latest/docs/concepts/traffic-management/#retries" rel="noopener ugc nofollow" target="_blank">重试</a>、<a class="ae lj" href="https://istio.io/latest/docs/concepts/traffic-management/#timeouts" rel="noopener ugc nofollow" target="_blank">超时</a>和<a class="ae lj" href="https://istio.io/latest/docs/concepts/traffic-management/#fault-injection" rel="noopener ugc nofollow" target="_blank">故障注入</a>策略。</li><li id="2906" class="lp lq iq kn b ko ly ks lz kw ma la mb le mc li nm lv lw lx bi translated">通过<a class="ae lj" href="https://istio.io/latest/docs/examples/virtual-machines/" rel="noopener ugc nofollow" target="_blank">将虚拟机添加到您的网格</a>，在虚拟机(VM)中运行网格服务。</li></ul><figure class="md me mf mg gt mh"><div class="bz fp l di"><div class="mi mj l"/></div><figcaption class="mk ml gj gh gi mm mn bd b be z dk translated">serviceEntry.yaml</figcaption></figure><pre class="md me mf mg gt mo mp mq mr aw ms bi"><span id="3b2e" class="mt jo iq mp b gy mu mv l mw mx">kubectl apply -f serviceEntry.yaml -n appbi</span></pre><p id="f46c" class="pw-post-body-paragraph kl km iq kn b ko lk kq kr ks ll ku kv kw lm ky kz la ln lc ld le lo lg lh li ij bi translated">在这个服务条目示例中，您将为googleapis.com添加一个服务条目，然后在虚拟服务和destinationrule定义中使用外部服务端点，就好像该服务是服务网格的一部分一样。</p><h1 id="5c9c" class="jn jo iq bd jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk bi translated">边车</h1><p id="a66b" class="pw-post-body-paragraph kl km iq kn b ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">默认情况下，Istio将每个Envoy代理配置为接受其相关工作负载的所有端口上的流量，并在转发流量时到达网格中的每个工作负载。您可以使用边车配置来执行以下操作:</p><ul class=""><li id="f298" class="lp lq iq kn b ko lk ks ll kw nj la nk le nl li nm lv lw lx bi translated">微调特使代理接受的端口和协议集。</li><li id="6539" class="lp lq iq kn b ko ly ks lz kw ma la mb le mc li nm lv lw lx bi translated">限制特使代理可以访问的服务集。</li></ul><p id="8323" class="pw-post-body-paragraph kl km iq kn b ko lk kq kr ks ll ku kv kw lm ky kz la ln lc ld le lo lg lh li ij bi translated">在较大的应用程序中，您可能希望像这样限制sidecar的可到达性，在这些应用程序中，配置每个代理以到达网格中的每个其他服务可能会由于高内存使用率而潜在地影响网格性能。</p><figure class="md me mf mg gt mh"><div class="bz fp l di"><div class="mi mj l"/></div><figcaption class="mk ml gj gh gi mm mn bd b be z dk translated">Sidecar.yaml</figcaption></figure><pre class="md me mf mg gt mo mp mq mr aw ms bi"><span id="f471" class="mt jo iq mp b gy mu mv l mw mx">kubectl apply -f Sidecar.yaml -n appbi</span></pre><p id="4e26" class="pw-post-body-paragraph kl km iq kn b ko lk kq kr ks ll ku kv kw lm ky kz la ln lc ld le lo lg lh li ij bi translated">您可以指定希望sidecar配置应用于特定名称空间中的所有工作负载，或者使用<code class="fe ng nh ni mp b">workloadSelector</code>选择特定的工作负载。在上面的sidecar配置中，<code class="fe ng nh ni mp b">appbi</code>名称空间中的所有服务都被配置为只能访问运行在相同名称空间和Istio控制平面中的服务(Istio的出口和遥测功能需要这些服务)。</p><p id="76e6" class="pw-post-body-paragraph kl km iq kn b ko lk kq kr ks ll ku kv kw lm ky kz la ln lc ld le lo lg lh li ij bi translated">注意:<strong class="kn ir">虚拟服务、目的地规则、服务入口、Sidecar等资源不需要Istio ingress独立特使代理(</strong> <em class="nn"> istio-ingress命名空间</em> <strong class="kn ir">中的istio-ingress部署)。</strong></p><h1 id="4df3" class="jn jo iq bd jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk bi translated">网络弹性和测试</h1><p id="3007" class="pw-post-body-paragraph kl km iq kn b ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">除了帮助您引导网格周围的流量，Istio还提供了可选的故障恢复和故障注入功能，您可以在运行时动态配置这些功能。</p><h2 id="af7f" class="mt jo iq bd jp no np dn jt nq nr dp jx kw ns nt kb la nu nv kf le nw nx kj ny bi translated">超时设定</h2><p id="7f8b" class="pw-post-body-paragraph kl km iq kn b ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">超时是指特使代理应该等待来自给定服务的回复的时间量，以确保服务不会无休止地等待回复，并确保调用在可预测的时间范围内成功或失败。默认情况下，Istio中禁用HTTP请求的特使超时。</p><p id="9ca6" class="pw-post-body-paragraph kl km iq kn b ko lk kq kr ks ll ku kv kw lm ky kz la ln lc ld le lo lg lh li ij bi translated">对于某些应用程序和服务，Istio的默认超时可能不合适。为了找到并使用您的最佳超时设置，Istio允许您使用<a class="ae lj" href="https://istio.io/latest/docs/concepts/traffic-management/#virtual-services" rel="noopener ugc nofollow" target="_blank">虚拟服务</a>轻松地动态调整每个服务的超时，而无需编辑您的服务代码。</p><p id="f205" class="pw-post-body-paragraph kl km iq kn b ko lk kq kr ks ll ku kv kw lm ky kz la ln lc ld le lo lg lh li ij bi translated"><strong class="kn ir">在vs-reviews.yaml中，您为所有目的地路由指定了10秒的超时时间</strong></p><h2 id="d916" class="mt jo iq bd jp no np dn jt nq nr dp jx kw ns nt kb la nu nv kf le nw nx kj ny bi translated">重试次数</h2><p id="9852" class="pw-post-body-paragraph kl km iq kn b ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">重试设置指定如果初始调用失败，特使代理尝试连接到服务的最大次数。重试可以提高服务可用性和应用程序性能，因为它可以确保呼叫不会因为暂时的问题(如暂时过载的服务或网络)而永久失败。重试间隔(25毫秒以上)是可变的，由Istio自动确定，防止被叫服务被请求淹没。HTTP请求的默认重试行为是在返回错误之前重试两次。</p><p id="35cf" class="pw-post-body-paragraph kl km iq kn b ko lk kq kr ks ll ku kv kw lm ky kz la ln lc ld le lo lg lh li ij bi translated">与超时一样，Istio的默认重试行为在延迟(对失败的服务重试太多次会减慢速度)或可用性方面可能不适合您的应用程序需求。同样像超时一样，你可以在<a class="ae lj" href="https://istio.io/latest/docs/concepts/traffic-management/#virtual-services" rel="noopener ugc nofollow" target="_blank">虚拟服务</a>中基于每个服务调整你的重试设置，而不必接触你的服务代码。</p><p id="54d0" class="pw-post-body-paragraph kl km iq kn b ko lk kq kr ks ll ku kv kw lm ky kz la ln lc ld le lo lg lh li ij bi translated"><strong class="kn ir">在vs-reviews.yaml中，您配置了在初始呼叫失败后最多3次重试连接该服务子集，每次有2秒钟的超时。</strong></p><h2 id="4bcc" class="mt jo iq bd jp no np dn jt nq nr dp jx kw ns nt kb la nu nv kf le nw nx kj ny bi translated">断路器</h2><p id="d956" class="pw-post-body-paragraph kl km iq kn b ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">断路器是Istio为创建弹性微服务应用提供的另一个有用机制。在断路器中，您可以设置对服务中各个主机的调用限制，例如并发连接数或对此主机的调用失败的次数。一旦达到该限制，断路器就会“跳闸”并停止与该主机的进一步连接。使用断路器模式支持快速故障，而不是客户端尝试连接到过载或故障主机。</p><p id="29ed" class="pw-post-body-paragraph kl km iq kn b ko lk kq kr ks ll ku kv kw lm ky kz la ln lc ld le lo lg lh li ij bi translated">在dr-reviews.yaml中，您将所有子集的<code class="fe ng nh ni mp b">reviews</code>服务工作负载的并发连接数限制为100。</p><h2 id="3cfb" class="mt jo iq bd jp no np dn jt nq nr dp jx kw ns nt kb la nu nv kf le nw nx kj ny bi translated">故障注入</h2><p id="6e8d" class="pw-post-body-paragraph kl km iq kn b ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">您可以使用Istio的故障注入机制来测试整个应用程序的故障恢复能力。故障注入是一种测试方法，它将错误引入系统，以确保系统能够承受错误条件并从中恢复。使用故障注入特别有助于确保故障恢复策略不会不兼容或限制过多，从而可能导致关键服务不可用。</p><p id="dae4" class="pw-post-body-paragraph kl km iq kn b ko lk kq kr ks ll ku kv kw lm ky kz la ln lc ld le lo lg lh li ij bi translated">目前，故障注入配置不能与同一虚拟服务上的重试或超时配置结合使用，参见<a class="ae lj" href="https://istio.io/latest/docs/ops/common-problems/network-issues/#virtual-service-with-fault-injection-and-retry-timeout-policies-not-working-as-expected" rel="noopener ugc nofollow" target="_blank">流量管理问题</a>。</p><figure class="md me mf mg gt mh"><div class="bz fp l di"><div class="mi mj l"/></div><figcaption class="mk ml gj gh gi mm mn bd b be z dk translated">故障注入. yaml</figcaption></figure><pre class="md me mf mg gt mo mp mq mr aw ms bi"><span id="8afb" class="mt jo iq mp b gy mu mv l mw mx">kubectl apply -f faultInjection.yaml -n appbi</span></pre><p id="7dba" class="pw-post-body-paragraph kl km iq kn b ko lk kq kr ks ll ku kv kw lm ky kz la ln lc ld le lo lg lh li ij bi translated">在本例中，您为details-v1应用程序部署了虚拟服务，并为其部署了目标规则。在虚拟服务定义中，您在specs下引入了一个故障图。您在该故障图中为100%的传入请求引入了HTTP代码为555的错误。</p><p id="6605" class="pw-post-body-paragraph kl km iq kn b ko lk kq kr ks ll ku kv kw lm ky kz la ln lc ld le lo lg lh li ij bi translated">当您访问URL<a class="ae lj" href="http://bookinfo.app.io/" rel="noopener ugc nofollow" target="_blank">http://bookinfo.app.io/</a>或者使用下面的命令查看productpage-v1 pod的日志时，您会看到错误。</p><pre class="md me mf mg gt mo mp mq mr aw ms bi"><span id="5be1" class="mt jo iq mp b gy mu mv l mw mx">kubectl logs -n appbi --selector=app=productpage -n appbi -f</span></pre><figure class="md me mf mg gt mh gh gi paragraph-image"><div role="button" tabindex="0" class="na nb di nc bf nd"><div class="gh gi oa"><img src="../Images/2814ada443c48d8e38d078b62bbea796.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*xPLsMXnfkQfjanhsZt0R3Q.png"/></div></div><figcaption class="mk ml gj gh gi mm mn bd b be z dk translated">故障注入</figcaption></figure><h1 id="17b6" class="jn jo iq bd jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk bi translated">一起使用Nginx入口控制器和Istio流量管理</h1><p id="65a4" class="pw-post-body-paragraph kl km iq kn b ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">我的问题是你为什么要这么做？嗯，我出于好奇测试了一下，它确实有效。我也可以使用<a class="ae lj" href="https://github.com/kubernetes/ingress-nginx" rel="noopener ugc nofollow" target="_blank"> Nginx ingress </a>访问bookinfo应用程序。在productpage应用程序的pod尝试访问其他服务后，请求进入网格。<strong class="kn ir">一旦请求进入网格，特使代理仍然接管并应用您在虚拟服务(与入口网关不相关的服务)、目的地规则、服务条目和侧柜中定义的所有配置。</strong>只是请求没有通过Istio入口网关进入mesh，您无法享受与Istio入口网关相关的功能。</p><h1 id="6e9d" class="jn jo iq bd jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk bi translated">结束了</h1><p id="dca5" class="pw-post-body-paragraph kl km iq kn b ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated"><strong class="kn ir">嗯，不尽然！！！</strong>其实是很基础的，入门的101式文章。如果你对Istio的流量管理能力感兴趣，这是一个入门的东西。<a class="ae lj" href="https://istio.io/latest/docs/reference/config/networking/" rel="noopener ugc nofollow" target="_blank"> Istio的官方文档</a>非常全面，有很多例子。正如我在本文开头所说的，目的是触及Istio流量管理功能的基础，这些功能确实有用，但也很复杂。</p><p id="23e9" class="pw-post-body-paragraph kl km iq kn b ko lk kq kr ks ll ku kv kw lm ky kz la ln lc ld le lo lg lh li ij bi translated">此外，Istio还有其他<a class="ae lj" href="https://istio.io/latest/docs/concepts/" rel="noopener ugc nofollow" target="_blank">有价值的功能</a>，您可能会感兴趣。您还可以考虑托管解决方案，如由Istio支持的<a class="ae lj" href="https://cloud.google.com/service-mesh/docs/overview" rel="noopener ugc nofollow" target="_blank"> Anthos service mesh </a>。</p><p id="02cb" class="pw-post-body-paragraph kl km iq kn b ko lk kq kr ks ll ku kv kw lm ky kz la ln lc ld le lo lg lh li ij bi translated"><strong class="kn ir">如何使用带有Istio的WAF？下面是我关于</strong> <a class="ae lj" href="https://harinderjitss.medium.com/using-application-gateway-waf-with-istio-315b907b8ed7" rel="noopener"> <strong class="kn ir">用Istio </strong> </a> <strong class="kn ir">使用应用网关WAF的文章。</strong></p></div><div class="ab cl ob oc hu od" role="separator"><span class="oe bw bk of og oh"/><span class="oe bw bk of og oh"/><span class="oe bw bk of og"/></div><div class="ij ik il im in"><p id="d292" class="pw-post-body-paragraph kl km iq kn b ko lk kq kr ks ll ku kv kw lm ky kz la ln lc ld le lo lg lh li ij bi translated">请阅读我的其他文章，并分享您的反馈。如果你喜欢分享的内容，请点赞、评论并订阅新文章。</p></div></div>    
</body>
</html>