<html>
<head>
<title>How to Deploy an Always-Free K3s Cluster on the Oracle Cloud Infrastructure</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何在Oracle云基础架构上部署始终免费的K3s集群</h1>
<blockquote>原文：<a href="https://itnext.io/how-to-deploy-an-always-free-k3s-cluster-on-the-oracle-cloud-infrastructure-4aed6d6d8604?source=collection_archive---------2-----------------------#2022-02-22">https://itnext.io/how-to-deploy-an-always-free-k3s-cluster-on-the-oracle-cloud-infrastructure-4aed6d6d8604?source=collection_archive---------2-----------------------#2022-02-22</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><figure class="gl gn jr js jt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi jq"><img src="../Images/9a192d174e0a86c8a6e944e565ddb880.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*VYoL9KnzbsKYoKt0tr9NQA.jpeg"/></div></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated">照片由<a class="ae kf" href="https://pixabay.com/de/users/niklas9416-4093236/" rel="noopener ugc nofollow" target="_blank"> Niklas9416 </a>从<a class="ae kf" href="https://pixabay.com/de/photos/hamburg-hafen-schiff-container-6849995/" rel="noopener ugc nofollow" target="_blank"> Pixabay </a>拍摄</figcaption></figure><p id="b427" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">Kubernetes现在几乎可以在每个现代公司找到，这就是为什么对教程和培训的兴趣增长强劲。他们中的大多数人在学习过程中都面临着这样的问题，即他们希望在不花费很高成本的情况下将所学的知识应用到自己的服务中。通常有两种方法可以做到这一点，要么在自己的硬件上建立自托管集群，要么使用云基础设施。在大多数情况下，这两种方法都要花不少钱。这正是本文的切入点，它解释了如何在Oracle云基础架构(OCI)的永久免费资源上全自动部署4节点K3s集群。</p><p id="84de" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">这个项目中使用的所有资源都可以在我的<a class="ae kf" href="https://github.com/r0b2g1t/k3s-cluster-on-oracle-cloud-infrastructure" rel="noopener ugc nofollow" target="_blank"> Gitlab资源库</a>中找到，并且可以用于这个目的。</p><h1 id="8436" class="le lf it bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">体系结构</h1><p id="d0dc" class="pw-post-body-paragraph kg kh it ki b kj mc kl km kn md kp kq kr me kt ku kv mf kx ky kz mg lb lc ld im bi translated">集群基础设施基于四个节点，两个服务器节点和两个代理节点用于您的工作负载。负载平衡器将流量分配到端口443上的节点。服务器节点位于可用性域2 (AD-2)中，代理节点在AD-1中创建。它们由<a class="ae kf" href="https://www.terraform.io" rel="noopener ugc nofollow" target="_blank"> Terraform </a>提供，并将自动安装<a class="ae kf" href="https://k3os.io" rel="noopener ugc nofollow" target="_blank"> k3os </a>，k3os会自行设置集群。集群使用存储解决方案<a class="ae kf" href="https://longhorn.io/" rel="noopener ugc nofollow" target="_blank"> Longhorn </a>，它将使用OCI实例的块存储，并在它们之间共享Kubernetes卷。下图概述了基础设施。</p><figure class="mi mj mk ml gt ju gh gi paragraph-image"><div class="gh gi mh"><img src="../Images/3d5b274ebdfafa5cea3917be43db181c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1216/format:webp/0*55Km-MtJaCB3jhdQ.png"/></div></figure></div><div class="ab cl mm mn hx mo" role="separator"><span class="mp bw bk mq mr ms"/><span class="mp bw bk mq mr ms"/><span class="mp bw bk mq mr"/></div><div class="im in io ip iq"><h1 id="7b88" class="le lf it bd lg lh mt lj lk ll mu ln lo lp mv lr ls lt mw lv lw lx mx lz ma mb bi translated">配置</h1><p id="ddcb" class="pw-post-body-paragraph kg kh it ki b kj mc kl km kn md kp kq kr me kt ku kv mf kx ky kz mg lb lc ld im bi translated">首先，您需要设置一些OCI平台提供商所需的环境变量。<a class="ae kf" href="https://docs.oracle.com/en-us/iaas/developer-tutorials/tutorials/tf-provider/01-summary.htm" rel="noopener ugc nofollow" target="_blank"> Oracle云基础设施文档</a>很好地概述了id和信息的位置，并解释了如何设置Terraform。</p><pre class="mi mj mk ml gt my mz na nb aw nc bi"><span id="c159" class="nd lf it mz b gy ne nf l ng nh">export TF_VAR_compartment_id="&lt;COMPARTMENT_ID&gt;"<br/>export TF_VAR_region="&lt;REGION_NAME&gt;"<br/>export TF_VAR_tenancy_ocid="&lt;TENANCY_OICD&gt;"<br/>export TF_VAR_user_ocid="&lt;USER_OICD&gt;"<br/>export TF_VAR_fingerprint="&lt;RSA_FINGERPRINT&gt;"<br/>export TF_VAR_private_key_path="&lt;PATH_TO_YOUR_PRIVATE_KEY&gt;"<br/>export TF_VAR_ssh_authorized_keys='["&lt;SSH_PUBLIC_KEY&gt;"]'</span></pre><h1 id="2f40" class="le lf it bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">部署</h1><p id="2daf" class="pw-post-body-paragraph kg kh it ki b kj mc kl km kn md kp kq kr me kt ku kv mf kx ky kz mg lb lc ld im bi translated">部署是一个简单的过程。首先，从Terraform init开始:</p><pre class="mi mj mk ml gt my mz na nb aw nc bi"><span id="ae78" class="nd lf it mz b gy ne nf l ng nh">terraform init</span></pre><p id="cf1b" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">其次，您必须通过以下命令创建一个地形平面图:</p><pre class="mi mj mk ml gt my mz na nb aw nc bi"><span id="5d7c" class="nd lf it mz b gy ne nf l ng nh">terraform plan -out .tfplan</span></pre><p id="cc5e" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">最后应用计划:</p><pre class="mi mj mk ml gt my mz na nb aw nc bi"><span id="22f3" class="nd lf it mz b gy ne nf l ng nh">terraform apply ".tfplan"</span></pre><p id="bdf9" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">几分钟后，OCI实例创建完毕，集群启动并运行。并且能够通过SSH连接到您的服务器node-1来获取kube-config。</p><pre class="mi mj mk ml gt my mz na nb aw nc bi"><span id="13d6" class="nd lf it mz b gy ne nf l ng nh">scp rancher@&lt;SERVER_NODE_1_PUBLIC_IP&gt;:/etc/rancher/k3s/k3s.yaml ~/.kube/config</span></pre><p id="a7a6" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">现在您可以使用<code class="fe ni nj nk mz b">kubectl</code>来管理您的集群并检查节点:</p><pre class="mi mj mk ml gt my mz na nb aw nc bi"><span id="6f1d" class="nd lf it mz b gy ne nf l ng nh">kubectl get nodes</span></pre><h1 id="b26b" class="le lf it bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">长角牛装置</h1><p id="39b7" class="pw-post-body-paragraph kg kh it ki b kj mc kl km kn md kp kq kr me kt ku kv mf kx ky kz mg lb lc ld im bi translated">最后，您必须通过<code class="fe ni nj nk mz b">kubectl</code>或<code class="fe ni nj nk mz b">helm</code>方法的以下命令来部署<a class="ae kf" href="https://longhorn.io/" rel="noopener ugc nofollow" target="_blank"> Longhorn </a>分布式块存储:</p><p id="fc3b" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">方法一通过<code class="fe ni nj nk mz b">kubectl</code>:</p><pre class="mi mj mk ml gt my mz na nb aw nc bi"><span id="d2cb" class="nd lf it mz b gy ne nf l ng nh">kubectl apply -f <a class="ae kf" href="https://raw.githubusercontent.com/longhorn/longhorn/v1.2.3/deploy/longhorn.yaml" rel="noopener ugc nofollow" target="_blank">https://raw.githubusercontent.com/longhorn/longhorn/v1.2.3/deploy/longhorn.yaml</a></span></pre><p id="c604" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><code class="fe ni nj nk mz b">helm</code>的方法2:你可以在<code class="fe ni nj nk mz b">services</code>文件夹中找到一个包含所有命令的shell脚本，它可以同时运行以下所有命令。</p><pre class="mi mj mk ml gt my mz na nb aw nc bi"><span id="e5a9" class="nd lf it mz b gy ne nf l ng nh">helm repo add longhorn https://charts.longhorn.io<br/>helm repo update<br/>kubectl create namespace longhorn-system<br/>helm install longhorn longhorn/longhorn --namespace longhorn-system</span></pre><p id="da6c" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">此外，对于这两种方法，您都必须删除作为默认置备程序的本地路径，并将Longhorn设置为默认路径:</p><pre class="mi mj mk ml gt my mz na nb aw nc bi"><span id="b2db" class="nd lf it mz b gy ne nf l ng nh">kubectl patch storageclass local-path -p '{"metadata": {"annotations":{"storageclass.kubernetes.io/is-default-class":"false"}}}'<br/>kubectl patch storageclass longhorn -p '{"metadata": {"annotations":{"storageclass.kubernetes.io/is-default-class":"true"}}}'</span></pre><p id="1644" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">检查长角牛<code class="fe ni nj nk mz b">storageclass</code>:</p><pre class="mi mj mk ml gt my mz na nb aw nc bi"><span id="c086" class="nd lf it mz b gy ne nf l ng nh">kubectl get storageclass</span></pre><p id="ebbe" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">几分钟后，所有pod都处于运行状态，您可以通过将端口转发到您的计算机来连接到Longhorn UI:</p><pre class="mi mj mk ml gt my mz na nb aw nc bi"><span id="1564" class="nd lf it mz b gy ne nf l ng nh">kubectl port-forward deployment/longhorn-ui 8000:8000 -n longhorn-system</span></pre><p id="85f5" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">使用这个URL访问接口:<code class="fe ni nj nk mz b">http://127.0.0.1:8000</code>。</p><h1 id="8936" class="le lf it bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">通过“让我们加密”自动创建证书</h1><p id="5687" class="pw-post-body-paragraph kg kh it ki b kj mc kl km kn md kp kq kr me kt ku kv mf kx ky kz mg lb lc ld im bi translated">为了传播您的服务，强烈建议使用SSL加密。在这种情况下，您必须为您的所有服务部署证书，这些服务应该可以在internet上访问。为了满足这个需求，您可以使用<code class="fe ni nj nk mz b">services\cert-manager</code>文件夹中的<code class="fe ni nj nk mz b"><a class="ae kf" href="https://cert-manager.io/" rel="noopener ugc nofollow" target="_blank">cert-manager</a></code>部署。</p><p id="21a4" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">首先，你必须执行<code class="fe ni nj nk mz b">cert-manager.sh</code>或以下命令:</p><pre class="mi mj mk ml gt my mz na nb aw nc bi"><span id="852d" class="nd lf it mz b gy ne nf l ng nh">helm repo add jetstack https://charts.jetstack.io<br/>helm repo update</span><span id="a6df" class="nd lf it mz b gy nl nf l ng nh">helm install \<br/>  cert-manager jetstack/cert-manager \<br/>  --namespace cert-manager \<br/>  --create-namespace \<br/>  --version v1.7.1 \<br/>  --set installCRDs=true</span></pre><p id="bb58" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">其次，通过编辑添加一个集群发布者，并通过用您的电子邮件地址和域替换它来部署<code class="fe ni nj nk mz b">cluster_issuer.yaml </code>文件:</p><pre class="mi mj mk ml gt my mz na nb aw nc bi"><span id="4561" class="nd lf it mz b gy ne nf l ng nh">...<br/>spec:<br/>  acme:<br/>    email: &lt;your_email&gt;@&lt;your-domain&gt;.&lt;tld&gt; # replace<br/>...</span></pre><p id="3ae4" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">最后，当您部署服务时，您必须添加入口资源。您可以使用示例文件<code class="fe ni nj nk mz b">ingress_example.yaml</code>并为您的服务编辑它:</p><pre class="mi mj mk ml gt my mz na nb aw nc bi"><span id="7ebd" class="nd lf it mz b gy ne nf l ng nh">...<br/>spec:<br/>  rules:<br/>  - host: &lt;subdomain&gt;.&lt;your-domain&gt;.&lt;tld&gt;                # replace<br/>    http:<br/>      paths:<br/>      - path: /<br/>        backend:<br/>          serviceName: &lt;service-name&gt;                    # replace<br/>          servicePort: 80<br/>  tls:<br/>  - hosts:<br/>    - &lt;subdomain&gt;.&lt;your-domain&gt;.&lt;tld&gt;                    # replace<br/>    secretName: &lt;subdomain&gt;-&lt;your-domain&gt;-&lt;tld&gt;-prod-tls # replace<br/>...</span></pre><p id="9f5c" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">每个服务都需要完成最后一步。在这个部署步骤中，cert-manager将处理通信，让我们加密证书并将其添加到您的服务入口资源中。</p><h1 id="c273" class="le lf it bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">结论</h1><p id="81af" class="pw-post-body-paragraph kg kh it ki b kj mc kl km kn md kp kq kr me kt ku kv mf kx ky kz mg lb lc ld im bi translated">该部署表明，在Oracle云基础设施上部署免费资源相当容易，并使每个感兴趣的人都能够在自己的4节点Kubernetes集群上部署自己的服务和共享存储。在另一篇文章中，我计划深入讨论集群的维护。</p><h1 id="0b06" class="le lf it bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">链接</h1><p id="1d68" class="pw-post-body-paragraph kg kh it ki b kj mc kl km kn md kp kq kr me kt ku kv mf kx ky kz mg lb lc ld im bi translated"><em class="nm"> Gitlab资源库:</em><a class="ae kf" href="https://github.com/r0b2g1t/k3s-cluster-on-oracle-cloud-infrastructure" rel="noopener ugc nofollow" target="_blank">https://github . com/r0 B2 G1 t/k3s-cluster-on-Oracle-cloud-infra structure</a></p><p id="c20c" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><em class="nm">K3os:</em>T21】https://K3os . io</p><p id="e90b" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><em class="nm">K3s:</em>T2】https://K3s . io</p><p id="8e88" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><em class="nm">terra form:</em><a class="ae kf" href="https://www.terraform.io/" rel="noopener ugc nofollow" target="_blank">https://www . terra form . io</a></p></div></div>    
</body>
</html>