<html>
<head>
<title>Working With ClickHouse From Spring Data Using MySql Driver</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用MySql驱动程序从Spring数据使用ClickHouse</h1>
<blockquote>原文：<a href="https://itnext.io/working-with-clickhouse-from-spring-data-using-mysql-driver-92f754550259?source=collection_archive---------6-----------------------#2021-04-16">https://itnext.io/working-with-clickhouse-from-spring-data-using-mysql-driver-92f754550259?source=collection_archive---------6-----------------------#2021-04-16</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jn jo jp jq gh gi paragraph-image"><div class="ab gu cl jr"><img src="../Images/5f4e0fabd4c5d9fe5a38389ce40327d4.png" data-original-src="https://miro.medium.com/v2/0*KOyFfIEBhe29ssEd"/></div><figcaption class="ju jv gj gh gi jw jx bd b be z dk translated">由<a class="ae jy" href="https://unsplash.com/@kaleidico" rel="noopener ugc nofollow" target="_blank">万花筒</a>在<a class="ae jy" href="https://unsplash.com" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</figcaption></figure><p id="0042" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">前一段时间我接到一个任务，要写一个将数据插入ClickHouse的服务。我的团队使用Kotlin和Spring框架，所以我决定尝试Spring Data JDBC作为ClickHouse的ORM框架。经过一番研究，我发现ClickHouse有一个<a class="ae jy" href="https://clickhouse.tech/docs/en/interfaces/mysql/" rel="noopener ugc nofollow" target="_blank"> MySql接口</a>。因此，Spring Data JDBC很可能能够使用MySql驱动程序与ClickHouse进行通信。</p><p id="b930" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">不幸的是，Spring Data JDBC并不能通过MySql驱动程序与ClickHouse一起使用。在这种方法行得通之前，必须解决几个问题。</p><p id="cf60" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">这篇文章是关于克服我在执行任务时遇到的问题和解决方法的。</p></div><div class="ab cl kx ky hu kz" role="separator"><span class="la bw bk lb lc ld"/><span class="la bw bk lb lc ld"/><span class="la bw bk lb lc"/></div><div class="ij ik il im in"><p id="7ca5" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated"><strong class="kb ir">更新:</strong>写完这篇文章后，我发现了关于<a class="ae jy" href="https://github.com/pelenthium/clickhouse-dialect-spring-boot-starter" rel="noopener ugc nofollow" target="_blank"> ClickHouse方言的春天数据JDBC </a>。从Spring数据中使用ClickHouse似乎是更正确的方式。在实现我的方法之前检查一下这个库。</p></div><div class="ab cl kx ky hu kz" role="separator"><span class="la bw bk lb lc ld"/><span class="la bw bk lb lc ld"/><span class="la bw bk lb lc"/></div><div class="ij ik il im in"><p id="b12e" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated"><strong class="kb ir">免责声明</strong>:我写的是ClickHouse的一个罕见用例。ClickHouse是OLAP数据库，不能用作OLTP数据库，所以除非你确信这种方法是正确的，否则不要重复它。ClickHouse不支持更新/删除和许多其他SQL语句，在为您的项目选择ClickHouse时要小心。</p></div><div class="ab cl kx ky hu kz" role="separator"><span class="la bw bk lb lc ld"/><span class="la bw bk lb lc ld"/><span class="la bw bk lb lc"/></div><div class="ij ik il im in"><h1 id="baf8" class="le lf iq bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">演示项目</h1><p id="b91d" class="pw-post-body-paragraph jz ka iq kb b kc mc ke kf kg md ki kj kk me km kn ko mf kq kr ks mg ku kv kw ij bi translated">在这篇文章中，我使用了科特林、Spring Boot和ClickHouse的官方docker图片。你可以在我的GitHub上的<a class="ae jy" href="https://github.com/Jaitl/clickhouse-spring-data-demo" rel="noopener ugc nofollow" target="_blank">这个repo </a>里找到源代码。在<code class="fe mh mi mj mk b">README.MD</code>文件中有一个指南，向您解释如何运行和测试演示项目。</p><h2 id="efa3" class="ml lf iq bd lg mm mn dn lk mo mp dp lo kk mq mr ls ko ms mt lw ks mu mv ma mw bi translated">演示项目的API和DB模式</h2><p id="0217" class="pw-post-body-paragraph jz ka iq kb b kc mc ke kf kg md ki kj kk me km kn ko mf kq kr ks mg ku kv kw ij bi translated">为了演示基本原理，我在演示项目中创建了一个简单的API和简单的DB模式。我的API只有两个方法:<strong class="kb ir">创建一个项目</strong>和<strong class="kb ir">获取所有项目</strong>因为ClickHouse不支持更新和删除操作，所以我不能实现所有的CRUD方法。</p><p id="e64c" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated"><code class="fe mh mi mj mk b">DataItem</code>是我的<code class="fe mh mi mj mk b">items</code>表的数据模型。<code class="fe mh mi mj mk b">items</code>表中的项目将被映射到<code class="fe mh mi mj mk b">DataItem</code>。</p><figure class="mx my mz na gt jq"><div class="bz fp l di"><div class="nb nc l"/></div></figure><p id="1d4e" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">以下是我的API的端点:</p><pre class="mx my mz na gt nd mk ne nf aw ng bi"><span id="a9f3" class="ml lf iq mk b gy nh ni l nj nk">POST <strong class="mk ir">v1/demo/item<br/>GET v1/demo/item</strong></span></pre><p id="6811" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated"><code class="fe mh mi mj mk b">POST</code>方法将创建一个带有<code class="fe mh mi mj mk b">DataItem</code>模型的新条目，而<code class="fe mh mi mj mk b">GET</code>方法将从<code class="fe mh mi mj mk b">items</code>表中返回所有条目。</p></div><div class="ab cl kx ky hu kz" role="separator"><span class="la bw bk lb lc ld"/><span class="la bw bk lb lc ld"/><span class="la bw bk lb lc"/></div><div class="ij ik il im in"><p id="80cd" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">让我们来看看我遇到的问题以及如何解决它们。</p><h1 id="3753" class="le lf iq bd lg lh nl lj lk ll nm ln lo lp nn lr ls lt no lv lw lx np lz ma mb bi translated">问题1。交易</h1><p id="86d0" class="pw-post-body-paragraph jz ka iq kb b kc mc ke kf kg md ki kj kk me km kn ko mf kq kr ks mg ku kv kw ij bi translated">Spring Data在每次查询后执行提交事务，但是ClickHouse不支持事务，因此在执行对ClickHouse的查询时会抛出异常。</p><p id="bb90" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">为了解决这个问题，我通过用空的<code class="fe mh mi mj mk b">commit</code>和<code class="fe mh mi mj mk b">rollback</code>方法覆盖<code class="fe mh mi mj mk b">PlatformTransactionManager</code>类来禁止提交事务。</p><figure class="mx my mz na gt jq"><div class="bz fp l di"><div class="nb nc l"/></div></figure><h1 id="7018" class="le lf iq bd lg lh nl lj lk ll nm ln lo lp nn lr ls lt no lv lw lx np lz ma mb bi translated">问题二。调试日志记录级别</h1><p id="d0f1" class="pw-post-body-paragraph jz ka iq kb b kc mc ke kf kg md ki kj kk me km kn ko mf kq kr ks mg ku kv kw ij bi translated">当<code class="fe mh mi mj mk b">DEBUG</code>级别为Spring数据JDBC启用时，MySql驱动程序将崩溃，并出现异常。发生这种情况是因为驱动程序试图执行<code class="fe mh mi mj mk b">WARNINGS</code>命令来从DB获取用于调试的附加信息，但是ClickHouse不支持这种声明。</p><p id="3502" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">为了解决这个问题，我将Spring数据JDBC记录器的记录器级别设置为<code class="fe mh mi mj mk b">INFO</code>。</p><pre class="mx my mz na gt nd mk ne nf aw ng bi"><span id="dcea" class="ml lf iq mk b gy nh ni l nj nk">&lt;<strong class="mk ir">logger name="org.springframework.jdbc" level="INFO" </strong>/&gt;</span></pre><h1 id="f543" class="le lf iq bd lg lh nl lj lk ll nm ln lo lp nn lr ls lt no lv lw lx np lz ma mb bi translated">问题三。数组数据类型</h1><p id="f2bc" class="pw-post-body-paragraph jz ka iq kb b kc mc ke kf kg md ki kj kk me km kn ko mf kq kr ks mg ku kv kw ij bi translated">MySql不支持数组数据类型，因此当我将一个列表或数组保存到数据库时，MySql驱动程序会抛出一个异常。</p><p id="0f00" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">为了解决这个问题，我围绕列表数据类型创建了一个自定义包装器，并为自定义包装器创建了自定义转换器。</p><figure class="mx my mz na gt jq"><div class="bz fp l di"><div class="nb nc l"/></div></figure><p id="3a90" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">不要忘记注册自定义转换。</p><figure class="mx my mz na gt jq"><div class="bz fp l di"><div class="nb nc l"/></div></figure><p id="2ad3" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">如果您遇到不支持的数据类型的问题，您必须为每个类型创建一个自定义的转换器。</p><h1 id="4bca" class="le lf iq bd lg lh nl lj lk ll nm ln lo lp nn lr ls lt no lv lw lx np lz ma mb bi translated">问题4。主要ID生成</h1><p id="ae40" class="pw-post-body-paragraph jz ka iq kb b kc mc ke kf kg md ki kj kk me km kn ko mf kq kr ks mg ku kv kw ij bi translated">ClickHouse没有为ID自动增加数据类型。ClickHouse假定ID字段是由用户分配的。如果您在代码中填写项目的<code class="fe mh mi mj mk b">ID</code>字段，那么当Spring Data试图更新一个项目而不是创建一个新项目时，问题就出现了。</p><p id="15be" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">为了解决这个问题，我从<code class="fe mh mi mj mk b">Persistable</code>接口继承了我的模型，并覆盖了<code class="fe mh mi mj mk b">isNew</code>方法，这样它总是返回<code class="fe mh mi mj mk b">true</code>。</p><figure class="mx my mz na gt jq"><div class="bz fp l di"><div class="nb nc l"/></div></figure></div><div class="ab cl kx ky hu kz" role="separator"><span class="la bw bk lb lc ld"/><span class="la bw bk lb lc ld"/><span class="la bw bk lb lc"/></div><div class="ij ik il im in"><h1 id="76ad" class="le lf iq bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">结论</h1><p id="fd16" class="pw-post-body-paragraph jz ka iq kb b kc mc ke kf kg md ki kj kk me km kn ko mf kq kr ks mg ku kv kw ij bi translated">正如你所看到的，当你使用JDBC Spring Data的ClickHouse时会有一些困难。幸运的是，所有的困难都可以解决，您可以享受使用强大的ORM库向ClickHouse插入数据，而无需手动将实体映射到SQL语句。</p><p id="405a" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">感谢阅读。我希望这有所帮助。如果你有任何问题，请随时回复。</p><h1 id="0f27" class="le lf iq bd lg lh nl lj lk ll nm ln lo lp nn lr ls lt no lv lw lx np lz ma mb bi translated">依赖</h1><ol class=""><li id="9782" class="nq nr iq kb b kc mc kg md kk ns ko nt ks nu kw nv nw nx ny bi translated"><a class="ae jy" href="https://github.com/Jaitl/clickhouse-spring-data-demo" rel="noopener ugc nofollow" target="_blank">演示项目的源代码</a></li><li id="deea" class="nq nr iq kb b kc nz kg oa kk ob ko oc ks od kw nv nw nx ny bi translated"><a class="ae jy" href="https://clickhouse.tech/docs/en/interfaces/mysql/" rel="noopener ugc nofollow" target="_blank"> ClickHouse MySql接口</a></li></ol></div></div>    
</body>
</html>