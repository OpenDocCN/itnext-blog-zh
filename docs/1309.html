<html>
<head>
<title>Curveball — a TypeScript micro-framework</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">curve ball——一个打字稿微框架</h1>
<blockquote>原文：<a href="https://itnext.io/curveball-a-typescript-micro-framework-1b04ebe50720?source=collection_archive---------3-----------------------#2018-09-06">https://itnext.io/curveball-a-typescript-micro-framework-1b04ebe50720?source=collection_archive---------3-----------------------#2018-09-06</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/31c4c01419568261cec4ea22ead89f9a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*BMXzGmahgmphE6CYv3KB1A.png"/></div></div></figure><p id="da03" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我从事Node.js开发已经有一段时间了，我想尝试编写一个框架。虽然这不是我的第一次，但这可能是我人生中的一个仪式。</p><p id="0e19" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">通过今天发布它，我想看看这是否值得在未来投入时间，或者我是否应该将精力集中在其他地方。</p><p id="c024" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">这个项目被称为曲线球，这是它与众不同的特点:</p><h1 id="0c80" class="kw kx iq bd ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt bi translated">项目目标</h1><p id="f58a" class="pw-post-body-paragraph jy jz iq ka b kb lu kd ke kf lv kh ki kj lw kl km kn lx kp kq kr ly kt ku kv ij bi translated">我是微框架的忠实粉丝。《快递》出来的时候很棒，但是现在感觉有点过时了。<a class="ae lz" href="https://koajs.com/" rel="noopener ugc nofollow" target="_blank"> Koa </a>由express背后的团队编写。Koa在面向承诺的代码库中更有意义，而不是面向回调的，这不是唯一的改进。团队等待发布稳定版本，直到Node.js发布稳定的<code class="fe ma mb mc md b">async</code> / <code class="fe ma mb mc md b">await</code>支持。</p><p id="91f9" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我会推荐大家去看看。我怀疑你在使用Koa一段时间后会想回到Express。</p><p id="f762" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">一段时间以来，Koa一直是我选择的框架，但也有一些东西是我喜欢的。我认为写一些检查这些框的东西会很有趣。</p><ol class=""><li id="c74e" class="me mf iq ka b kb kc kf kg kj mg kn mh kr mi kv mj mk ml mm bi translated">曲球是一个非常小的球，就像Koa。</li><li id="3a9f" class="me mf iq ka b kb mn kf mo kj mp kn mq kr mr kv mj mk ml mm bi translated">它很大程度上遵循了Koa架构和API设计，有一些微妙的变化。中间件看起来会非常熟悉。</li><li id="39c9" class="me mf iq ka b kb mn kf mo kj mp kn mq kr mr kv mj mk ml mm bi translated">完全是用打字稿写的。</li><li id="1c52" class="me mf iq ka b kb mn kf mo kj mp kn mq kr mr kv mj mk ml mm bi translated">它包含了现代的HTTP特性，内置了对HTTP/2 Push和<code class="fe ma mb mc md b">103 Early Hints</code>的支持，并以一种感觉像是框架的一部分的方式集成了这些特性。</li><li id="2864" class="me mf iq ka b kb mn kf mo kj mp kn mq kr mr kv mj mk ml mm bi translated">很容易在框架内部“模拟”HTTP请求，而不必通过真正的HTTP堆栈。</li></ol><p id="fe15" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">第3-5点是我从其他我看过的框架中漏掉的，也是为什么我认为它可能对其他人有用。</p><p id="e665" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">一些例子:</p><h1 id="7f7d" class="kw kx iq bd ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt bi translated">你好世界</h1><pre class="ms mt mu mv gt mw md mx my aw mz bi"><span id="21a1" class="na kx iq md b gy nb nc l nd ne">import { Application, Context } from '@curveball/core';</span><span id="f643" class="na kx iq md b gy nf nc l nd ne">const app = new Application();<br/>app.use((ctx: Context) =&gt; {</span><span id="9edf" class="na kx iq md b gy nf nc l nd ne">  ctx.response.body = 'Hello world! You used the following HTTP method: '  + ctx.request.method;</span><span id="7623" class="na kx iq md b gy nf nc l nd ne">});<br/>app.listen(4000);</span></pre><h1 id="7c03" class="kw kx iq bd ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt bi translated">路由器</h1><pre class="ms mt mu mv gt mw md mx my aw mz bi"><span id="7cba" class="na kx iq md b gy nb nc l nd ne">import { Application } from '@curveball/core';<br/>import router from '@curveball/router';</span><span id="d8c3" class="na kx iq md b gy nf nc l nd ne">app.use(router('/contact', ctx =&gt; {</span><span id="a16d" class="na kx iq md b gy nf nc l nd ne">  ctx.response.body = 'Contact us!';</span><span id="aa63" class="na kx iq md b gy nf nc l nd ne">});<br/>app.listen(4000);</span></pre><h1 id="f9b9" class="kw kx iq bd ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt bi translated">HTTP/2推送</h1><p id="66b3" class="pw-post-body-paragraph jy jz iq ka b kb lu kd ke kf lv kh ki kj lw kl km kn lx kp kq kr ly kt ku kv ij bi translated">无论何时你可以访问<code class="fe ma mb mc md b">Context</code>对象，你也可以推。对于HTTP/1连接，推送将被忽略。</p><pre class="ms mt mu mv gt mw md mx my aw mz bi"><span id="b97a" class="na kx iq md b gy nb nc l nd ne">app.use(ctx =&gt; async {</span><span id="92ff" class="na kx iq md b gy nf nc l nd ne">  ctx.response.body = 'Hello world!'<br/>  await ctx.response.push( pushCtx =&gt; {</span><span id="5e20" class="na kx iq md b gy nf nc l nd ne">    // This function is not called unless the client indicated <br/>    // they support push.<br/>    // You get a special Context object that has a request and<br/>    // response.<br/>    pushCtx.request.path = '/assets/foo.css';<br/>    pushCtx.response.type = 'text/css';<br/>    pushCtx.response.body =  'body { background: blue; }';</span><span id="05ec" class="na kx iq md b gy nf nc l nd ne">  });</span><span id="835b" class="na kx iq md b gy nf nc l nd ne">})</span></pre><p id="0f04" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">上面的例子允许您以编程方式生成推送，这允许您进行某些优化，而这些优化对于基于截取<code class="fe ma mb mc md b">Link:</code>头的HTTP/2推送实现来说是很难做到的。</p><p id="bc4c" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">但是，如果您想要推送一个请求和响应，使其通过整个中间件堆栈，那么您可以使用子请求来实现:</p><pre class="ms mt mu mv gt mw md mx my aw mz bi"><span id="626f" class="na kx iq md b gy nb nc l nd ne">app.use(ctx =&gt; async {</span><span id="7cf5" class="na kx iq md b gy nf nc l nd ne">  ctx.response.body = 'Hello world!'<br/>  await ctx.response.push( pushCtx =&gt; {</span><span id="e630" class="na kx iq md b gy nf nc l nd ne">    pushCtx.request.path = '/assets/foo.css';<br/>    // Handle does an internal sub request and calls every <br/>    // middleware.<br/>    return app.handle(pushCtx);</span><span id="267f" class="na kx iq md b gy nf nc l nd ne">  });</span><span id="4739" class="na kx iq md b gy nf nc l nd ne">});</span></pre><h1 id="250e" class="kw kx iq bd ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt bi translated">发送103早期提示响应</h1><pre class="ms mt mu mv gt mw md mx my aw mz bi"><span id="175e" class="na kx iq md b gy nb nc l nd ne">app.use(ctx =&gt; async {</span><span id="6df9" class="na kx iq md b gy nf nc l nd ne">  ctx.response.body = 'Hello world!'<br/>  ctx.response.sendInformational(103, {<br/>    'Link' : [<br/>      '&lt;/style.css&gt; rel="prefetch" as="style"',<br/>      '&lt;/script.js&gt; rel="prefetch" as="script"',<br/>    ]<br/>  });</span><span id="38ef" class="na kx iq md b gy nf nc l nd ne">});</span></pre><h1 id="16e5" class="kw kx iq bd ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt bi translated">中间件升级</h1><p id="d989" class="pw-post-body-paragraph jy jz iq ka b kb lu kd ke kf lv kh ki kj lw kl km kn lx kp kq kr ly kt ku kv ij bi translated">如果您来自Express，您也将获得Koa会给予您的所有好处。所以这并不是曲线球的卖点。</p><p id="35e0" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">尝试用express编写以下中间件:</p><pre class="ms mt mu mv gt mw md mx my aw mz bi"><span id="526e" class="na kx iq md b gy nb nc l nd ne">app.use( async (ctx, next) =&gt; {</span><span id="ac81" class="na kx iq md b gy nf nc l nd ne">  // Let the entire middleware stack run<br/>  await next();<br/>  <br/>  // HTML encode JSON responses if the client was a browser.<br/>  if (ctx.accepts('text/html') <br/>    &amp;&amp; ctx.response.type ==== 'application/json') {</span><span id="6fb7" class="na kx iq md b gy nf nc l nd ne">      ctx.response.type = 'text/html';<br/>      ctx.response.body = '&lt;h1&gt;JSON source&lt;/h1&gt;&lt;pre&gt;' +  <br/>        JSON.stringify(ctx.response.body) + '&lt;/pre&gt;';</span><span id="5321" class="na kx iq md b gy nf nc l nd ne">  }</span><span id="47e8" class="na kx iq md b gy nf nc l nd ne">});</span></pre><h1 id="1227" class="kw kx iq bd ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt bi translated">去哪里打弧线球</h1><p id="0c59" class="pw-post-body-paragraph jy jz iq ka b kb lu kd ke kf lv kh ki kj lw kl km kn lx kp kq kr ly kt ku kv ij bi translated">可以在<a class="ae lz" href="http://github.com/curveballjs/core" rel="noopener ugc nofollow" target="_blank"> Github项目页面</a>找到。</p><h1 id="f07e" class="kw kx iq bd ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt bi translated">我能怎么做呢？</h1><p id="6d38" class="pw-post-body-paragraph jy jz iq ka b kb lu kd ke kf lv kh ki kj lw kl km kn lx kp kq kr ly kt ku kv ij bi translated">如果我是唯一的用户，这个项目就玩完了，我可能会停止工作，把我的项目转换回Koa。</p><p id="643a" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">如果你认为这值得维护，我很想知道。<a class="ae lz" href="https://twitter.com/evertp" rel="noopener ugc nofollow" target="_blank">在推特上给我发信息</a>，或者给我写邮件！</p><p id="9321" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">如果你有兴趣帮忙，有很多事情可以做。我不想成为唯一的失败点。</p><p id="d2cb" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">感谢你一路走到了最后！</p></div></div>    
</body>
</html>