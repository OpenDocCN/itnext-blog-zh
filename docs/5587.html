<html>
<head>
<title>Apply CustomResource fragments using Eclipse JKube Kubernetes Maven Plugin</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Eclipse JKube Kubernetes Maven插件应用自定义资源片段</h1>
<blockquote>原文：<a href="https://itnext.io/apply-customresource-fragments-using-eclipse-jkube-kubernetes-maven-plugin-be2cba65b58f?source=collection_archive---------2-----------------------#2021-04-10">https://itnext.io/apply-customresource-fragments-using-eclipse-jkube-kubernetes-maven-plugin-be2cba65b58f?source=collection_archive---------2-----------------------#2021-04-10</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div class="gh gi jn"><img src="../Images/47d070768d1a77f5505555855fcc3df7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1164/format:webp/1*VPk4GCUqHoQwIQ_v5bqWCw.png"/></div><figcaption class="ju jv gj gh gi jw jx bd b be z dk translated"><a class="ae jy" href="https://github.com/eclipse/jkube" rel="noopener ugc nofollow" target="_blank">日蚀JKube </a></figcaption></figure><p id="6294" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">有时候，您希望将一些自定义资源与应用程序的工作负载资源一起应用，如<code class="fe kx ky kz la b">Deployment</code>、<code class="fe kx ky kz la b">Service</code>等。对于这个用例，您可能想要使用Kubernetes Maven插件的<a class="ae jy" href="https://www.eclipse.org/jkube/docs/kubernetes-maven-plugin#_resource_fragments" rel="noopener ugc nofollow" target="_blank">资源片段</a>特性来为JKube提供定制的YAML片段，以便在应用阶段进行部署。在这篇博文中，我们将看看如何向Kubernetes Maven插件提供我们的CustomResource片段，以便在应用阶段部署它们。</p><h2 id="d93f" class="lb lc iq bd ld le lf dn lg lh li dp lj kk lk ll lm ko ln lo lp ks lq lr ls lt bi translated">将Kubernetes Maven插件添加到项目:</h2><p id="7d72" class="pw-post-body-paragraph jz ka iq kb b kc lu ke kf kg lv ki kj kk lw km kn ko lx kq kr ks ly ku kv kw ij bi translated">为了使用Eclipse JKube部署CustomResource片段，您需要在pom.xml中添加Kubernetes Maven插件，如下所示:</p><pre class="lz ma mb mc gt md la me mf aw mg bi"><span id="e7b9" class="lb lc iq la b gy mh mi l mj mk"><strong class="la ir">&lt;plugin&gt; </strong><br/>   <strong class="la ir">&lt;groupId&gt;</strong>org.eclipse.jkube<strong class="la ir">&lt;/groupId&gt; </strong><br/>   <strong class="la ir">&lt;artifactId&gt;</strong>kubernetes-maven-plugin<strong class="la ir">&lt;/artifactId&gt;</strong> <br/>   <strong class="la ir">&lt;version&gt;</strong>1.2.0<strong class="la ir">&lt;/version&gt; </strong><br/><strong class="la ir">&lt;/plugin&gt;</strong></span></pre><h2 id="e55e" class="lb lc iq bd ld le lf dn lg lh li dp lj kk lk ll lm ko ln lo lp ks lq lr ls lt bi translated">将自定义资源片段放入<code class="fe kx ky kz la b">src/main/jkube</code>:</h2><p id="9e41" class="pw-post-body-paragraph jz ka iq kb b kc lu ke kf kg lv ki kj kk lw km kn ko lx kq kr ks ly ku kv kw ij bi translated">为了提供CustomResource片段，我们需要将它们放在Kubernetes Maven插件的资源目录中(默认为<code class="fe kx ky kz la b">${baseDir}/src/main/jkube</code>)。</p><p id="3abd" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">对于标准资源，我们需要为核心Kubernetes资源命名我们的资源片段，如<code class="fe kx ky kz la b">Deployment</code>、<code class="fe kx ky kz la b">Service</code>等。尊重他们的同类。因此，用于部署的片段将被命名为<code class="fe kx ky kz la b">deployment.yaml</code>，用于服务的片段将被命名为<code class="fe kx ky kz la b">service.yaml</code>。但是在CustomResources的情况下，这种类型的元素是不固定的，因此您需要为您的CustomResource片段添加一个后缀<code class="fe kx ky kz la b">*-cr.yml</code>，以便Eclipse JKube可以检测到指定的片段是CustomResource片段。下面是您的资源目录的样子:</p><pre class="lz ma mb mc gt md la me mf aw mg bi"><span id="4eaf" class="lb lc iq la b gy mh mi l mj mk"><strong class="la ir">jkube-custom-resource-fragments : $ </strong>ls -l src/main/jkube/ <br/>total 312 <br/>-rw-rw-r--. 1 rohaan rohaan    388 Mar 26 19:04 ats-crd.yml <br/>-rw-rw-r--. 1 rohaan rohaan    160 Mar 26 19:04 ats-cr.yml <br/>-rw-rw-r--. 1 rohaan rohaan   1371 Mar 26 19:04 crontab-crd.yml <br/>-rw-rw-r--. 1 rohaan rohaan    164 Mar 26 19:04 crontab-cr.yml <br/>-rw-rw-r--. 1 rohaan rohaan    304 Mar 26 19:04 dummy-crd.yml <br/>-rw-rw-r--. 1 rohaan rohaan    105 Mar 26 19:04 dummy-cr.yml <br/>-rw-rw-r--. 1 rohaan rohaan   1259 Mar 26 19:04 ingressroute-cr.yml <br/>-rw-rw-r--. 1 rohaan rohaan 258715 Mar 26 19:04 istio-crd.yaml <br/>-rw-rw-r--. 1 rohaan rohaan    539 Mar 26 19:04 podset-crd.yaml <br/>-rw-rw-r--. 1 rohaan rohaan    107 Mar 26 19:04 second-dummy-cr.yml <br/>-rw-rw-r--. 1 rohaan rohaan    132 Mar 26 19:04 test2-cr.yml <br/>-rw-rw-r--. 1 rohaan rohaan   2327 Mar 26 19:04 traefic-crd.yaml <br/>-rw-rw-r--. 1 rohaan rohaan    225 Mar 26 19:04 traefic-ingressroute2-cr.yml <br/>-rw-rw-r--. 1 rohaan rohaan    303 Mar 26 19:04 virtualservice-cr.yml</span></pre><p id="716d" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">注意，在我的例子中，我在我的<code class="fe kx ky kz la b">src/main/jkube</code>目录中也有一些CustomResourceDefinitions。但是，CustomResourceDefinitions是一个群集范围的资源，应该由Cluster-Admin安装；您还可以通过将CustomResourceDefinitions作为资源片段来部署它们。</p><p id="72c0" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">资源片段中也可以有maven属性占位符，如下所示:</p><pre class="lz ma mb mc gt md la me mf aw mg bi"><span id="3e8f" class="lb lc iq la b gy mh mi l mj mk"><strong class="la ir">apiVersion:</strong> demo.fabric8.io/v1alpha1 <br/><strong class="la ir">kind:</strong> PodSet <br/><strong class="la ir">metadata:</strong> <br/>  <strong class="la ir">name:</strong> ${podset.name} <br/><strong class="la ir">spec: </strong><br/>  <strong class="la ir">replicas:</strong> ${podset.replicas}</span></pre><p id="4ee3" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">您可以将这些配置为maven属性，如下所示:</p><pre class="lz ma mb mc gt md la me mf aw mg bi"><span id="f8ad" class="lb lc iq la b gy mh mi l mj mk"><strong class="la ir">&lt;properties&gt;   <br/>   &lt;podset.replicas&gt;</strong>3<strong class="la ir">&lt;/podset.replicas&gt; <br/>   &lt;podset.name&gt;</strong>example-podset<strong class="la ir">&lt;/podset.name&gt; <br/>&lt;/properties&gt;</strong></span></pre><h2 id="1386" class="lb lc iq bd ld le lf dn lg lh li dp lj kk lk ll lm ko ln lo lp ks lq lr ls lt bi translated">生成+应用自定义资源片段:</h2><p id="fd17" class="pw-post-body-paragraph jz ka iq kb b kc lu ke kf kg lv ki kj kk lw km kn ko lx kq kr ks ly ku kv kw ij bi translated">一旦你把你的自定义资源片段放到插件的资源目录中。您应该能够利用<code class="fe kx ky kz la b">k8s:resource</code>目标生成资源。您的所有CustomResource片段都将在资源阶段得到丰富。</p><pre class="lz ma mb mc gt md la me mf aw mg bi"><span id="3610" class="lb lc iq la b gy mh mi l mj mk"><strong class="la ir">$</strong> mvn k8s:resource</span></pre><figure class="lz ma mb mc gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="mm mn di mo bf mp"><div class="gh gi ml"><img src="../Images/bd6df3272571a4315840d52b2d443728.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*9z_pGKe4rtC30o_dM_Auyw.png"/></div></div><figcaption class="ju jv gj gh gi jw jx bd b be z dk translated">k8s:资源目标</figcaption></figure><p id="8fcf" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">您应该能够在<code class="fe kx ky kz la b">target/classes/META-INF/jkube/kubernetes</code>目录中看到最终的丰富清单。</p><p id="f474" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">一旦生成了资源清单，就可以使用apply目标将它们应用到Kubernetes集群。如果您没有为资源目录中的这些CustomResource提供CustomResourceDefinitions，则需要确保该特定CustomResource的CustomResourceDefinition已经存在。然后，您可以像这样继续运行应用目标:</p><pre class="lz ma mb mc gt md la me mf aw mg bi"><span id="b083" class="lb lc iq la b gy mh mi l mj mk"><strong class="la ir">$ </strong>mvn k8s:apply</span></pre><figure class="lz ma mb mc gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="mm mn di mo bf mp"><div class="gh gi ml"><img src="../Images/432abe7c759cd5b1407ef3f55c9b6b44.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*c82zWjfFPzcNOiCkfROU8A.png"/></div></div><figcaption class="ju jv gj gh gi jw jx bd b be z dk translated">k8s:应用目标</figcaption></figure><p id="ce06" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">然后，您可以检查您的自定义资源是否得到应用。对我来说，他们得到了预期的申请。</p><pre class="lz ma mb mc gt md la me mf aw mg bi"><span id="3e79" class="lb lc iq la b gy mh mi l mj mk">jkube-custom-resource-fragments : $ kubectl get dummy <br/>NAME           AGE <br/>first-dummy    4m43s <br/>second-dummy   4m42s <br/>jkube-custom-resource-fragments : $ kubectl get podset <br/>NAME             AGE <br/>example-podset   4m48s <br/>jkube-custom-resource-fragments : $ kubectl get virtualservice <br/>NAME                    GATEWAYS   HOSTS   AGE <br/>valid-virtual-service              ["c"]   4m52s <br/>jkube-custom-resource-fragments : $ kubectl get crontab <br/>NAME                 AGE <br/>my-new-cron-object   5m4s <br/>jkube-custom-resource-fragments : $</span></pre><h2 id="521c" class="lb lc iq bd ld le lf dn lg lh li dp lj kk lk ll lm ko ln lo lp ks lq lr ls lt bi translated">从Kubernetes群集中删除应用的资源:</h2><p id="957a" class="pw-post-body-paragraph jz ka iq kb b kc lu ke kf kg lv ki kj kk lw km kn ko lx kq kr ks ly ku kv kw ij bi translated">一旦您完成了对应用的定制资源工作负载的测试，并且想要清理已部署的所有内容。您可以简单地运行取消部署目标:</p><pre class="lz ma mb mc gt md la me mf aw mg bi"><span id="d059" class="lb lc iq la b gy mh mi l mj mk"><strong class="la ir">$</strong> mvn k8s:undeploy</span></pre><figure class="lz ma mb mc gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="mm mn di mo bf mp"><div class="gh gi ml"><img src="../Images/150d0488cd31473329351fae5fdb88f5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*WPqf56uVQJuudDYq_oacAw.png"/></div></div><figcaption class="ju jv gj gh gi jw jx bd b be z dk translated">k8s:取消部署目标</figcaption></figure><h2 id="ed8c" class="lb lc iq bd ld le lf dn lg lh li dp lj kk lk ll lm ko ln lo lp ks lq lr ls lt bi translated">结论:</h2><p id="3fa4" class="pw-post-body-paragraph jz ka iq kb b kc lu ke kf kg lv ki kj kk lw km kn ko lx kq kr ks ly ku kv kw ij bi translated">今天的博文到此结束。我希望您已经了解了如何利用Eclipse JKube来部署您的定制资源片段。您可以在以下github资源库中找到代码:</p><div class="mq mr gp gr ms mt"><a href="https://github.com/r0haaaan/jkube-custom-resource-fragments" rel="noopener  ugc nofollow" target="_blank"><div class="mu ab fo"><div class="mv ab mw cl cj mx"><h2 class="bd ir gy z fp my fr fs mz fu fw ip bi translated">r0haaaan/jkube-自定义资源-片段</h2><div class="na l"><h3 class="bd b gy z fp my fr fs mz fu fw dk translated">您还可以向Eclipse jbu be的源目录(src/main/jbu be)和Eclipse jbu be提供定制的资源片段…</h3></div><div class="nb l"><p class="bd b dl z fp my fr fs mz fu fw dk translated">github.com</p></div></div></div></a></div><p id="131f" class="pw-post-body-paragraph jz ka iq kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ij bi translated">请试用并通过常规渠道提供反馈:</p><ul class=""><li id="47eb" class="nc nd iq kb b kc kd kg kh kk ne ko nf ks ng kw nh ni nj nk bi translated">推特:<a class="ae jy" href="https://twitter.com/jkubeio" rel="noopener ugc nofollow" target="_blank">https://twitter.com/jkubeio</a></li><li id="582b" class="nc nd iq kb b kc nl kg nm kk nn ko no ks np kw nh ni nj nk bi translated">吉特:<a class="ae jy" href="https://gitter.im/eclipse/jkube" rel="noopener ugc nofollow" target="_blank">https://gitter.im/eclipse/jkube</a></li><li id="4cc9" class="nc nd iq kb b kc nl kg nm kk nn ko no ks np kw nh ni nj nk bi translated">Github问题:<a class="ae jy" href="https://github.com/eclipse/jkube/issues" rel="noopener ugc nofollow" target="_blank">https://github.com/eclipse/jkube/issues</a></li></ul></div></div>    
</body>
</html>