<html>
<head>
<title>Using Maven to Build Docker</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Maven构建Docker</h1>
<blockquote>原文：<a href="https://itnext.io/using-maven-to-build-docker-73c83e626025?source=collection_archive---------0-----------------------#2019-05-30">https://itnext.io/using-maven-to-build-docker-73c83e626025?source=collection_archive---------0-----------------------#2019-05-30</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><figure class="gl gn jr js jt ju gh gi paragraph-image"><div class="gh gi jq"><img src="../Images/13dae0cba9ffd2f41d69524f5405e14c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1280/format:webp/1*52g7I_jsPNx9NN80ctntMQ.jpeg"/></div><figcaption class="jx jy gj gh gi jz ka bd b be z dk translated">图片由来自<a class="ae kb" href="https://pixabay.com/?utm_source=link-attribution&amp;utm_medium=referral&amp;utm_campaign=image&amp;utm_content=1080589" rel="noopener ugc nofollow" target="_blank"> Pixabay </a>的<a class="ae kb" href="https://pixabay.com/users/jarmoluk-143740/?utm_source=link-attribution&amp;utm_medium=referral&amp;utm_campaign=image&amp;utm_content=1080589" rel="noopener ugc nofollow" target="_blank"> Michal Jarmoluk </a>拍摄</figcaption></figure><p id="5792" class="pw-post-body-paragraph kc kd it ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz im bi translated">Docker正迅速成为服务的标准交付和部署工具。但是对于Java web应用程序呢？我们怎么才能加入码头工人派对？</p><h1 id="ff1b" class="la lb it bd lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx bi translated">传统码头建筑</h1><p id="42b8" class="pw-post-body-paragraph kc kd it ke b kf ly kh ki kj lz kl km kn ma kp kq kr mb kt ku kv mc kx ky kz im bi translated">传统的docker构建不需要太多。安装docker和docker文件就可以满足你的所有需求。有许多预构建的docker容器可以用作您的基础:</p><ul class=""><li id="1f22" class="md me it ke b kf kg kj kk kn mf kr mg kv mh kz mi mj mk ml bi translated"><a class="ae kb" href="https://hub.docker.com/_/java" rel="noopener ugc nofollow" target="_blank">香草爪哇</a></li><li id="a651" class="md me it ke b kf mm kj mn kn mo kr mp kv mq kz mi mj mk ml bi translated">雄猫</li></ul><p id="5fed" class="pw-post-body-paragraph kc kd it ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz im bi translated">设置您的docker文件:</p><pre class="mr ms mt mu gt mv mw mx my aw mz bi"><span id="9048" class="na lb it mw b gy nb nc l nd ne"><strong class="mw iu">FROM </strong>openjdk:8-jdk-alpine<br/><strong class="mw iu">VOLUME /</strong>tmp<br/><strong class="mw iu">EXPOSE </strong>8080<br/><strong class="mw iu">ARG <em class="nf">JAR_FILE<br/></em>COPY </strong>${<strong class="mw iu"><em class="nf">JAR_FILE</em></strong>} app.jar<br/><strong class="mw iu">ENTRYPOINT </strong>[<strong class="mw iu">"java"</strong>,<strong class="mw iu">"-Djava.security.egd=file:/dev/./urandom"</strong>,<strong class="mw iu">"-jar"</strong>,<strong class="mw iu">"/app.jar"</strong>]</span></pre><p id="49be" class="pw-post-body-paragraph kc kd it ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz im bi translated">然后运行您的构建:</p><pre class="mr ms mt mu gt mv mw mx my aw mz bi"><span id="2518" class="na lb it mw b gy nb nc l nd ne">docker build \<br/>-t io.github.efenglu.example/mavenDocker:0.0.1-SNAPSHOT \<br/>--build-arg JAR_FIlE=target/dependencies/service.jar \<br/>--no-cache .</span></pre><p id="2fcd" class="pw-post-body-paragraph kc kd it ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz im bi translated">当然，这会让你跑起来，但我们在这里错过了很多。</p><ul class=""><li id="7988" class="md me it ke b kf kg kj kk kn mf kr mg kv mh kz mi mj mk ml bi translated">我们如何将它与我们的持续集成过程集成呢？</li><li id="c897" class="md me it ke b kf mm kj mn kn mo kr mp kv mq kz mi mj mk ml bi translated">web.war正走在一条神奇的道路上(共享隐性知识)</li><li id="b7a9" class="md me it ke b kf mm kj mn kn mo kr mp kv mq kz mi mj mk ml bi translated">我们的应用程序版本是作为命令行参数提供的</li></ul><h1 id="ae71" class="la lb it bd lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx bi translated">Maven Docker构建</h1><p id="5c39" class="pw-post-body-paragraph kc kd it ke b kf ly kh ki kj lz kl km kn ma kp kq kr mb kt ku kv mc kx ky kz im bi translated">您可能已经在使用maven构建您的jar和war了。Maven有版本信息，并且已经集成到我们的持续集成过程中。</p><p id="d471" class="pw-post-body-paragraph kc kd it ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz im bi translated">但是我们如何让它构建docker呢？</p><p id="0e08" class="pw-post-body-paragraph kc kd it ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz im bi translated">Maven构建java…对吧？</p><p id="ddfd" class="pw-post-body-paragraph kc kd it ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz im bi translated">是的，maven构建java。但其核心Maven只是一个构建框架。你可以写一个maven插件来做任何事情。因此，让我们让maven来构建我们的容器。有几种不同的方法。各有利弊。</p></div><div class="ab cl ng nh hx ni" role="separator"><span class="nj bw bk nk nl nm"/><span class="nj bw bk nk nl nm"/><span class="nj bw bk nk nl"/></div><div class="im in io ip iq"><h1 id="8ecd" class="la lb it bd lc ld nn lf lg lh no lj lk ll np ln lo lp nq lr ls lt nr lv lw lx bi translated">Maven Exec</h1><p id="d7de" class="pw-post-body-paragraph kc kd it ke b kf ly kh ki kj lz kl km kn ma kp kq kr mb kt ku kv mc kx ky kz im bi translated">maven exec插件提供了一种简单的方法来执行作为maven构建一部分的任何程序。让我们像从命令行那样使用它来构建docker。</p><p id="7b45" class="pw-post-body-paragraph kc kd it ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz im bi translated">首先，我们需要得到我们需要部署到容器中的工件。我们可以使用依赖插件将所有工件提取到一个已知的位置。</p><pre class="mr ms mt mu gt mv mw mx my aw mz bi"><span id="09c2" class="na lb it mw b gy nb nc l nd ne">&lt;<strong class="mw iu">plugin</strong>&gt;<br/>    &lt;<strong class="mw iu">groupId</strong>&gt;org.apache.maven.plugins&lt;/<strong class="mw iu">groupId</strong>&gt;<br/>    &lt;<strong class="mw iu">artifactId</strong>&gt;maven-dependency-plugin&lt;/<strong class="mw iu">artifactId</strong>&gt;<br/>    &lt;<strong class="mw iu">executions</strong>&gt;<br/>        &lt;<strong class="mw iu">execution</strong>&gt;<br/>            &lt;<strong class="mw iu">goals</strong>&gt;<br/>                &lt;<strong class="mw iu">goal</strong>&gt;copy&lt;/<strong class="mw iu">goal</strong>&gt;<br/>            &lt;/<strong class="mw iu">goals</strong>&gt;<br/>            &lt;<strong class="mw iu">phase</strong>&gt;prepare-package&lt;/<strong class="mw iu">phase</strong>&gt;<br/>            &lt;<strong class="mw iu">configuration</strong>&gt;<br/>                &lt;<strong class="mw iu">artifactItems</strong>&gt;<br/>                    &lt;<strong class="mw iu">artifactItem</strong>&gt;<br/>                        &lt;<strong class="mw iu">groupId</strong>&gt;${project.groupId}&lt;/<strong class="mw iu">groupId</strong>&gt;<br/>                        &lt;<strong class="mw iu">artifactId</strong>&gt;example-service&lt;/<strong class="mw iu">artifactId</strong>&gt;<br/>                        &lt;<strong class="mw iu">version</strong>&gt;${project.version}&lt;/<strong class="mw iu">version</strong>&gt;<br/>                        &lt;<strong class="mw iu">overWrite</strong>&gt;true&lt;/<strong class="mw iu">overWrite</strong>&gt;<br/>                        &lt;<strong class="mw iu">outputDirectory</strong>&gt;target/dependency&lt;/<strong class="mw iu">outputDirectory</strong>&gt;<br/>                        &lt;<strong class="mw iu">destFileName</strong>&gt;service.jar&lt;/<strong class="mw iu">destFileName</strong>&gt;<br/>                    &lt;/<strong class="mw iu">artifactItem</strong>&gt;<br/>                &lt;/<strong class="mw iu">artifactItems</strong>&gt;<br/>            &lt;/<strong class="mw iu">configuration</strong>&gt;<br/>        &lt;/<strong class="mw iu">execution</strong>&gt;<br/>    &lt;/<strong class="mw iu">executions</strong>&gt;<br/>&lt;/<strong class="mw iu">plugin</strong>&gt;</span></pre><p id="e71f" class="pw-post-body-paragraph kc kd it ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz im bi translated">这里，我们将工件jar复制到我们的目标/依赖文件夹中，命名为service.jar</p><p id="c236" class="pw-post-body-paragraph kc kd it ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz im bi translated">我们现在可以将它传递给我们的docker构建，以及其他信息，如版本:</p><pre class="mr ms mt mu gt mv mw mx my aw mz bi"><span id="5044" class="na lb it mw b gy nb nc l nd ne">&lt;<strong class="mw iu">plugin</strong>&gt;<br/>    &lt;<strong class="mw iu">groupId</strong>&gt;org.codehaus.mojo&lt;/<strong class="mw iu">groupId</strong>&gt;<br/>    &lt;<strong class="mw iu">artifactId</strong>&gt;exec-maven-plugin&lt;/<strong class="mw iu">artifactId</strong>&gt;<br/>    &lt;<strong class="mw iu">version</strong>&gt;1.6.0&lt;/<strong class="mw iu">version</strong>&gt;<br/>    &lt;<strong class="mw iu">executions</strong>&gt;<br/>        &lt;<strong class="mw iu">execution</strong>&gt;<br/>            &lt;<strong class="mw iu">id</strong>&gt;docker-package&lt;/<strong class="mw iu">id</strong>&gt;<br/>            &lt;<strong class="mw iu">phase</strong>&gt;package&lt;/<strong class="mw iu">phase</strong>&gt;<br/>            &lt;<strong class="mw iu">goals</strong>&gt;<br/>                &lt;<strong class="mw iu">goal</strong>&gt;exec&lt;/<strong class="mw iu">goal</strong>&gt;<br/>            &lt;/<strong class="mw iu">goals</strong>&gt;<br/>            &lt;<strong class="mw iu">configuration</strong>&gt;<br/>                &lt;<strong class="mw iu">executable</strong>&gt;docker&lt;/<strong class="mw iu">executable</strong>&gt;<br/>                &lt;<strong class="mw iu">workingDirectory</strong>&gt;${project.basedir}&lt;/<strong class="mw iu">workingDirectory</strong>&gt;<br/>                &lt;<strong class="mw iu">arguments</strong>&gt;<br/>                    &lt;<strong class="mw iu">argument</strong>&gt;build&lt;/<strong class="mw iu">argument</strong>&gt;<br/>                    &lt;<strong class="mw iu">argument</strong>&gt;.&lt;/<strong class="mw iu">argument</strong>&gt;<br/>                    &lt;<strong class="mw iu">argument</strong>&gt;-t&lt;/<strong class="mw iu">argument</strong>&gt;<br/>                    &lt;<strong class="mw iu">argument</strong>&gt;${project.groupId}/${project.artifactId}:${project.version}&lt;/<strong class="mw iu">argument</strong>&gt;<br/>                    &lt;<strong class="mw iu">argument</strong>&gt;--build-arg&lt;/<strong class="mw iu">argument</strong>&gt;<br/>                    &lt;<strong class="mw iu">argument</strong>&gt;JAR_FILE=target/dependency/service.jar&lt;/<strong class="mw iu">argument</strong>&gt;<br/>                &lt;/<strong class="mw iu">arguments</strong>&gt;<br/>            &lt;/<strong class="mw iu">configuration</strong>&gt;<br/>        &lt;/<strong class="mw iu">execution</strong>&gt;<br/>    &lt;/<strong class="mw iu">executions</strong>&gt;<br/>&lt;/<strong class="mw iu">plugin</strong>&gt;</span></pre><p id="49c1" class="pw-post-body-paragraph kc kd it ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz im bi translated">在这里，您可以看到我们正在当前项目目录中调用docker命令。我们传递参数，使命令看起来像这样:</p><pre class="mr ms mt mu gt mv mw mx my aw mz bi"><span id="e5cf" class="na lb it mw b gy nb nc l nd ne">docker build . -t ${project.groupId}/${project.artifactId}:${project.version} --build-arg JAR_FILE=target/dependency/service.jar</span></pre><p id="bdc2" class="pw-post-body-paragraph kc kd it ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz im bi translated">组id、工件id和版本将被maven值替换。</p><h2 id="8e61" class="na lb it bd lc ns nt dn lg nu nv dp lk kn nw nx lo kr ny nz ls kv oa ob lw oc bi translated">优势:</h2><ul class=""><li id="49ca" class="md me it ke b kf ly kj lz kn od kr oe kv of kz mi mj mk ml bi translated">简单的</li><li id="5956" class="md me it ke b kf mm kj mn kn mo kr mp kv mq kz mi mj mk ml bi translated">完整的Dockerfile文件支持</li></ul><h2 id="d501" class="na lb it bd lc ns nt dn lg nu nv dp lk kn nw nx lo kr ny nz ls kv oa ob lw oc bi translated">不足之处</h2><ul class=""><li id="0acb" class="md me it ke b kf ly kj lz kn od kr oe kv of kz mi mj mk ml bi translated">docker文件系统分层效率不高</li><li id="cf26" class="md me it ke b kf mm kj mn kn mo kr mp kv mq kz mi mj mk ml bi translated">需要访问docker代理来构建</li><li id="9194" class="md me it ke b kf mm kj mn kn mo kr mp kv mq kz mi mj mk ml bi translated">maven和docker之间的原始集成级别</li></ul><h2 id="1ebe" class="na lb it bd lc ns nt dn lg nu nv dp lk kn nw nx lo kr ny nz ls kv oa ob lw oc bi translated">进一步阅读</h2><ul class=""><li id="b318" class="md me it ke b kf ly kj lz kn od kr oe kv of kz mi mj mk ml bi translated"><a class="ae kb" href="https://www.mojohaus.org/exec-maven-plugin/" rel="noopener ugc nofollow" target="_blank">https://www.mojohaus.org/exec-maven-plugin/</a></li></ul></div><div class="ab cl ng nh hx ni" role="separator"><span class="nj bw bk nk nl nm"/><span class="nj bw bk nk nl nm"/><span class="nj bw bk nk nl"/></div><div class="im in io ip iq"><h1 id="5b45" class="la lb it bd lc ld nn lf lg lh no lj lk ll np ln lo lp nq lr ls lt nr lv lw lx bi translated">Spotify Maven Docker插件</h1><p id="e72e" class="pw-post-body-paragraph kc kd it ke b kf ly kh ki kj lz kl km kn ma kp kq kr mb kt ku kv mc kx ky kz im bi translated">Spotify Maven插件抽象了一些docker概念，并提供了一个更传统的类似Maven的界面来配置docker版本。然而，它仍然利用docker代理来执行实际的构建。</p><p id="a5de" class="pw-post-body-paragraph kc kd it ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz im bi translated">首先，通过在我们的构建参数中设置从哪里获取jar来配置插件，并设置一个归档清单以包含大量的构建元数据。</p><pre class="mr ms mt mu gt mv mw mx my aw mz bi"><span id="3af4" class="na lb it mw b gy nb nc l nd ne">&lt;<strong class="mw iu">plugin</strong>&gt;<br/>    &lt;<strong class="mw iu">groupId</strong>&gt;com.spotify&lt;/<strong class="mw iu">groupId</strong>&gt;<br/>    &lt;<strong class="mw iu">artifactId</strong>&gt;dockerfile-maven-plugin&lt;/<strong class="mw iu">artifactId</strong>&gt;<br/>    &lt;<strong class="mw iu">version</strong>&gt;1.4.9&lt;/<strong class="mw iu">version</strong>&gt;<br/>    &lt;<strong class="mw iu">configuration</strong>&gt;<br/>        &lt;<strong class="mw iu">buildArgs</strong>&gt;<br/>            &lt;<strong class="mw iu">DEPENDENCY</strong>&gt;target/dependency&lt;/<strong class="mw iu">DEPENDENCY</strong>&gt;<br/>        &lt;/<strong class="mw iu">buildArgs</strong>&gt;<br/>        &lt;<strong class="mw iu">archive</strong>&gt;<br/>            &lt;<strong class="mw iu">manifest</strong>&gt;<br/>                &lt;<strong class="mw iu">addDefaultImplementationEntries</strong>&gt;true&lt;/<strong class="mw iu">addDefaultImplementationEntries</strong>&gt;<br/>                &lt;<strong class="mw iu">addDefaultSpecificationEntries</strong>&gt;true&lt;/<strong class="mw iu">addDefaultSpecificationEntries</strong>&gt;<br/>            &lt;/<strong class="mw iu">manifest</strong>&gt;<br/>            &lt;<strong class="mw iu">manifestEntries</strong>&gt;<br/>                &lt;<strong class="mw iu">Specification-Title</strong>&gt;${project.name}&lt;/<strong class="mw iu">Specification-Title</strong>&gt;<br/>                &lt;<strong class="mw iu">Specification-Version</strong>&gt;${project.version}&lt;/<strong class="mw iu">Specification-Version</strong>&gt;<br/>                &lt;<strong class="mw iu">Implementation-Title</strong>&gt;${project.groupId}.${project.artifactId}&lt;/<strong class="mw iu">Implementation-Title</strong>&gt;<br/>                &lt;<strong class="mw iu">Implementation-Build-Time</strong>&gt;${maven.build.timestamp}&lt;/<strong class="mw iu">Implementation-Build-Time</strong>&gt;<br/>                &lt;<strong class="mw iu">X-Docker-Repo</strong>&gt;${docker.org}/${docker.image}:${project.version}&lt;/<strong class="mw iu">X-Docker-Repo</strong>&gt;<br/>            &lt;/<strong class="mw iu">manifestEntries</strong>&gt;<br/>        &lt;/<strong class="mw iu">archive</strong>&gt;<br/>    &lt;/<strong class="mw iu">configuration</strong>&gt;</span></pre><p id="7683" class="pw-post-body-paragraph kc kd it ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz im bi translated">然后，我想在适当的maven阶段添加一个执行:</p><p id="4ec7" class="pw-post-body-paragraph kc kd it ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz im bi translated">在打包阶段，我们构建容器:</p><pre class="mr ms mt mu gt mv mw mx my aw mz bi"><span id="d120" class="na lb it mw b gy nb nc l nd ne">&lt;<strong class="mw iu">execution</strong>&gt;<br/>    &lt;<strong class="mw iu">id</strong>&gt;build&lt;/<strong class="mw iu">id</strong>&gt;<br/>    &lt;<strong class="mw iu">phase</strong>&gt;package&lt;/<strong class="mw iu">phase</strong>&gt;<br/>    &lt;<strong class="mw iu">goals</strong>&gt;<br/>        &lt;<strong class="mw iu">goal</strong>&gt;build&lt;/<strong class="mw iu">goal</strong>&gt;<br/>    &lt;/<strong class="mw iu">goals</strong>&gt;<br/>    &lt;<strong class="mw iu">configuration</strong>&gt;<br/>        &lt;<strong class="mw iu">repository</strong>&gt;${docker.org}/${docker.image}&lt;/<strong class="mw iu">repository</strong>&gt;<br/>        &lt;<strong class="mw iu">tag</strong>&gt;${project.version}&lt;/<strong class="mw iu">tag</strong>&gt;<br/>        &lt;<strong class="mw iu">classifier</strong>&gt;docker-local&lt;/<strong class="mw iu">classifier</strong>&gt;<br/>    &lt;/<strong class="mw iu">configuration</strong>&gt;<br/>&lt;/<strong class="mw iu">execution</strong>&gt;</span></pre><p id="8a14" class="pw-post-body-paragraph kc kd it ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz im bi translated">在安装阶段，我们用一个本地标签和一个更适合部署到DTR存储库的标签来标记容器:</p><pre class="mr ms mt mu gt mv mw mx my aw mz bi"><span id="7da2" class="na lb it mw b gy nb nc l nd ne">&lt;<strong class="mw iu">execution</strong>&gt;<br/>    &lt;<strong class="mw iu">id</strong>&gt;tag&lt;/<strong class="mw iu">id</strong>&gt;<br/>    &lt;<strong class="mw iu">phase</strong>&gt;install&lt;/<strong class="mw iu">phase</strong>&gt;<br/>    &lt;<strong class="mw iu">goals</strong>&gt;<br/>        &lt;<strong class="mw iu">goal</strong>&gt;tag&lt;/<strong class="mw iu">goal</strong>&gt;<br/>    &lt;/<strong class="mw iu">goals</strong>&gt;<br/>    &lt;<strong class="mw iu">configuration</strong>&gt;<br/>        &lt;<strong class="mw iu">repository</strong>&gt;${docker.org}/${docker.image}&lt;/<strong class="mw iu">repository</strong>&gt;<br/>        &lt;<strong class="mw iu">tag</strong>&gt;latest&lt;/<strong class="mw iu">tag</strong>&gt;<br/>        &lt;<strong class="mw iu">classifier</strong>&gt;docker-local-latest&lt;/<strong class="mw iu">classifier</strong>&gt;<br/>    &lt;/<strong class="mw iu">configuration</strong>&gt;<br/>&lt;/<strong class="mw iu">execution</strong>&gt;<br/>&lt;<strong class="mw iu">execution</strong>&gt;<br/>    &lt;<strong class="mw iu">id</strong>&gt;tag-repo-deploy&lt;/<strong class="mw iu">id</strong>&gt;<br/>    &lt;<strong class="mw iu">phase</strong>&gt;install&lt;/<strong class="mw iu">phase</strong>&gt;<br/>    &lt;<strong class="mw iu">goals</strong>&gt;<br/>        &lt;<strong class="mw iu">goal</strong>&gt;tag&lt;/<strong class="mw iu">goal</strong>&gt;<br/>    &lt;/<strong class="mw iu">goals</strong>&gt;<br/>    &lt;<strong class="mw iu">configuration</strong>&gt;<br/>        &lt;<strong class="mw iu">repository</strong>&gt;${docker.registry}/${docker.org}/${docker.image}&lt;/<strong class="mw iu">repository</strong>&gt;<br/>        &lt;<strong class="mw iu">tag</strong>&gt;${docker.deploy.tag}&lt;/<strong class="mw iu">tag</strong>&gt;<br/>        &lt;<strong class="mw iu">classifier</strong>&gt;docker-info-tag&lt;/<strong class="mw iu">classifier</strong>&gt;<br/>    &lt;/<strong class="mw iu">configuration</strong>&gt;<br/>&lt;/<strong class="mw iu">execution</strong>&gt;</span></pre><p id="5b6b" class="pw-post-body-paragraph kc kd it ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz im bi translated">最后，在部署阶段，我们将容器推送到DTR:</p><pre class="mr ms mt mu gt mv mw mx my aw mz bi"><span id="e7b6" class="na lb it mw b gy nb nc l nd ne">&lt;<strong class="mw iu">execution</strong>&gt;<br/>    &lt;<strong class="mw iu">id</strong>&gt;push-version&lt;/<strong class="mw iu">id</strong>&gt;<br/>    &lt;<strong class="mw iu">phase</strong>&gt;deploy&lt;/<strong class="mw iu">phase</strong>&gt;<br/>    &lt;<strong class="mw iu">goals</strong>&gt;<br/>        &lt;<strong class="mw iu">goal</strong>&gt;push&lt;/<strong class="mw iu">goal</strong>&gt;<br/>    &lt;/<strong class="mw iu">goals</strong>&gt;<br/>    &lt;<strong class="mw iu">configuration</strong>&gt;<br/>        &lt;<strong class="mw iu">repository</strong>&gt;${docker.registry}/${docker.org}/${docker.image}&lt;/<strong class="mw iu">repository</strong>&gt;<br/>        &lt;<strong class="mw iu">tag</strong>&gt;${docker.deploy.tag}&lt;/<strong class="mw iu">tag</strong>&gt;<br/>        &lt;<strong class="mw iu">classifier</strong>&gt;docker-info&lt;/<strong class="mw iu">classifier</strong>&gt;<br/>    &lt;/<strong class="mw iu">configuration</strong>&gt;<br/>&lt;/<strong class="mw iu">execution</strong>&gt;</span></pre><h2 id="c729" class="na lb it bd lc ns nt dn lg nu nv dp lk kn nw nx lo kr ny nz ls kv oa ob lw oc bi translated">优势:</h2><ul class=""><li id="51af" class="md me it ke b kf ly kj lz kn od kr oe kv of kz mi mj mk ml bi translated">简单的</li><li id="7270" class="md me it ke b kf mm kj mn kn mo kr mp kv mq kz mi mj mk ml bi translated">对docker概念更直接的支持</li><li id="c163" class="md me it ke b kf mm kj mn kn mo kr mp kv mq kz mi mj mk ml bi translated">支持Dockerfile</li></ul><h2 id="b67f" class="na lb it bd lc ns nt dn lg nu nv dp lk kn nw nx lo kr ny nz ls kv oa ob lw oc bi translated">缺点:</h2><ul class=""><li id="ad9f" class="md me it ke b kf ly kj lz kn od kr oe kv of kz mi mj mk ml bi translated">Docker文件系统层</li><li id="2235" class="md me it ke b kf mm kj mn kn mo kr mp kv mq kz mi mj mk ml bi translated">需要码头代理</li></ul><h2 id="2ce1" class="na lb it bd lc ns nt dn lg nu nv dp lk kn nw nx lo kr ny nz ls kv oa ob lw oc bi translated">延伸阅读:</h2><ul class=""><li id="bfb4" class="md me it ke b kf ly kj lz kn od kr oe kv of kz mi mj mk ml bi translated"><a class="ae kb" href="https://github.com/spotify/docker-maven-plugin" rel="noopener ugc nofollow" target="_blank"> Spotify Docker Maven插件</a></li></ul></div><div class="ab cl ng nh hx ni" role="separator"><span class="nj bw bk nk nl nm"/><span class="nj bw bk nk nl nm"/><span class="nj bw bk nk nl"/></div><div class="im in io ip iq"><h1 id="fc34" class="la lb it bd lc ld nn lf lg lh no lj lk ll np ln lo lp nq lr ls lt nr lv lw lx bi translated">谷歌三角帆</h1><p id="9e1b" class="pw-post-body-paragraph kc kd it ke b kf ly kh ki kj lz kl km kn ma kp kq kr mb kt ku kv mc kx ky kz im bi translated">JIB插件比Spotify更进一步。JIB直接从Java与docker文件系统层进行交互。这消除了对任何外部工具的需要，如运行docker代理。但这也意味着您只能将文件复制到基本容器中。您不能执行任何运行操作。</p><p id="3418" class="pw-post-body-paragraph kc kd it ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz im bi translated">JIB插件没有太多需要配置的。</p><pre class="mr ms mt mu gt mv mw mx my aw mz bi"><span id="c1c8" class="na lb it mw b gy nb nc l nd ne">&lt;<strong class="mw iu">configuration</strong>&gt;<br/>    &lt;<strong class="mw iu">allowInsecureRegistries</strong>&gt;true&lt;/<strong class="mw iu">allowInsecureRegistries</strong>&gt;<br/>    &lt;<strong class="mw iu">to</strong>&gt;<br/>        &lt;<strong class="mw iu">image</strong>&gt;${project.groupId}/${project.artifactId}:${project.version}&lt;/<strong class="mw iu">image</strong>&gt;<br/>    &lt;/<strong class="mw iu">to</strong>&gt;<br/>    &lt;<strong class="mw iu">container</strong>&gt;<br/>        &lt;<strong class="mw iu">ports</strong>&gt;<br/>            &lt;<strong class="mw iu">port</strong>&gt;${jib.app.port}&lt;/<strong class="mw iu">port</strong>&gt;<br/>        &lt;/<strong class="mw iu">ports</strong>&gt;<br/>        &lt;<strong class="mw iu">jvmFlags</strong>&gt;<br/>            &lt;<strong class="mw iu">jvmFlag</strong>&gt;-Xms512m&lt;/<strong class="mw iu">jvmFlag</strong>&gt;<br/>            &lt;<strong class="mw iu">jvmFlag</strong>&gt;-Xmx1024m&lt;/<strong class="mw iu">jvmFlag</strong>&gt;<br/>        &lt;/<strong class="mw iu">jvmFlags</strong>&gt;<br/>    &lt;/<strong class="mw iu">container</strong>&gt;<br/>&lt;/<strong class="mw iu">configuration</strong>&gt;</span></pre><p id="b424" class="pw-post-body-paragraph kc kd it ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz im bi translated">因为JIB不需要docker容器，所以默认情况下它不会提供容器的本地docker版本。要创建本地容器构建，您可以添加以下执行:</p><pre class="mr ms mt mu gt mv mw mx my aw mz bi"><span id="289d" class="na lb it mw b gy nb nc l nd ne">&lt;<strong class="mw iu">execution</strong>&gt;<br/>    &lt;<strong class="mw iu">id</strong>&gt;docker daemon install&lt;/<strong class="mw iu">id</strong>&gt;<br/>    &lt;<strong class="mw iu">phase</strong>&gt;install&lt;/<strong class="mw iu">phase</strong>&gt;<br/>    &lt;<strong class="mw iu">goals</strong>&gt;<br/>        &lt;<strong class="mw iu">goal</strong>&gt;dockerBuild&lt;/<strong class="mw iu">goal</strong>&gt;<br/>    &lt;/<strong class="mw iu">goals</strong>&gt;<br/>    &lt;<strong class="mw iu">configuration</strong>&gt;<br/>        &lt;<strong class="mw iu">skip</strong>&gt;${jib.skip.install}&lt;/<strong class="mw iu">skip</strong>&gt;<br/>    &lt;/<strong class="mw iu">configuration</strong>&gt;<br/>&lt;/<strong class="mw iu">execution</strong>&gt;</span></pre><p id="4496" class="pw-post-body-paragraph kc kd it ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz im bi translated">这将使用本地docker代理构建容器。这对调试很有用。但是，您应该在CI/CD框架的构建过程中禁用它，以避免依赖docker代理。因此，跳过我们定义的属性。</p><p id="23e3" class="pw-post-body-paragraph kc kd it ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz im bi translated">最后，您还需要配置JIB以部署到您的DTR实例:</p><pre class="mr ms mt mu gt mv mw mx my aw mz bi"><span id="ffb8" class="na lb it mw b gy nb nc l nd ne">&lt;<strong class="mw iu">execution</strong>&gt;<br/>    &lt;<strong class="mw iu">id</strong>&gt;DTR Deploy&lt;/<strong class="mw iu">id</strong>&gt;<br/>    &lt;<strong class="mw iu">phase</strong>&gt;deploy&lt;/<strong class="mw iu">phase</strong>&gt;<br/>    &lt;<strong class="mw iu">goals</strong>&gt;<br/>        &lt;<strong class="mw iu">goal</strong>&gt;build&lt;/<strong class="mw iu">goal</strong>&gt;<br/>    &lt;/<strong class="mw iu">goals</strong>&gt;<br/>    &lt;<strong class="mw iu">configuration</strong>&gt;<br/>        &lt;<strong class="mw iu">skip</strong>&gt;${jib.skip.deploy}&lt;/<strong class="mw iu">skip</strong>&gt;<br/>        &lt;<strong class="mw iu">to</strong>&gt;<br/>            &lt;<strong class="mw iu">auth</strong>&gt;<br/>                &lt;<strong class="mw iu">username</strong>&gt;${jib.dtr.auth.username}&lt;/<strong class="mw iu">username</strong>&gt;<br/>                &lt;<strong class="mw iu">password</strong>&gt;${jib.dtr.auth.password}&lt;/<strong class="mw iu">password</strong>&gt;<br/>            &lt;/<strong class="mw iu">auth</strong>&gt;<br/>        &lt;/<strong class="mw iu">to</strong>&gt;<br/>    &lt;/<strong class="mw iu">configuration</strong>&gt;<br/>&lt;/<strong class="mw iu">execution</strong>&gt;</span></pre><h2 id="0d0b" class="na lb it bd lc ns nt dn lg nu nv dp lk kn nw nx lo kr ny nz ls kv oa ob lw oc bi translated">优势:</h2><ul class=""><li id="bde1" class="md me it ke b kf ly kj lz kn od kr oe kv of kz mi mj mk ml bi translated">小而快</li><li id="d1fa" class="md me it ke b kf mm kj mn kn mo kr mp kv mq kz mi mj mk ml bi translated">不需要代理或任何其他外部可执行文件(在ci/cd中)</li><li id="6cf5" class="md me it ke b kf mm kj mn kn mo kr mp kv mq kz mi mj mk ml bi translated">更小的文件系统分层直接与maven依赖项集成</li></ul><h2 id="ecbc" class="na lb it bd lc ns nt dn lg nu nv dp lk kn nw nx lo kr ny nz ls kv oa ob lw oc bi translated">缺点:</h2><ul class=""><li id="aead" class="md me it ke b kf ly kj lz kn od kr oe kv of kz mi mj mk ml bi translated">只有简单的容器，没有Dockerfile支持</li></ul><h2 id="f23b" class="na lb it bd lc ns nt dn lg nu nv dp lk kn nw nx lo kr ny nz ls kv oa ob lw oc bi translated">延伸阅读:</h2><ul class=""><li id="702f" class="md me it ke b kf ly kj lz kn od kr oe kv of kz mi mj mk ml bi translated"><a class="ae kb" href="https://github.com/GoogleContainerTools/jib" rel="noopener ugc nofollow" target="_blank">谷歌JIB插件</a></li></ul></div><div class="ab cl ng nh hx ni" role="separator"><span class="nj bw bk nk nl nm"/><span class="nj bw bk nk nl nm"/><span class="nj bw bk nk nl"/></div><div class="im in io ip iq"><h1 id="4f52" class="la lb it bd lc ld nn lf lg lh no lj lk ll np ln lo lp nq lr ls lt nr lv lw lx bi translated">结论</h1><p id="2c75" class="pw-post-body-paragraph kc kd it ke b kf ly kh ki kj lz kl km kn ma kp kq kr mb kt ku kv mc kx ky kz im bi translated">一般来说，对于基于Java的web服务，你主要是将一个jar复制到一个容器JIB中，这绝对是正确的做法。使用docker代理在持续集成环境中构建容器可能非常复杂，尤其是当您的构建环境已经在容器中时。您将很快遇到这样的问题，要么必须将/var/docker.sock卷装载到您的构建容器中(这是一个巨大的安全风险)，要么以某种方式让docker-in-docker工作。那还不容易！有许多文件系统问题、主机系统兼容性问题、版本和性能问题。一般情况下，不要使用docker-in-docker。这是为了调试docker，而不是在您的CI/CD框架中使用。</p><p id="eeae" class="pw-post-body-paragraph kc kd it ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz im bi translated">如果你想试试DIND码头，你可以在这里找到更多的细节:<a class="ae kb" href="https://github.com/jpetazzo/dind" rel="noopener ugc nofollow" target="_blank">https://github.com/jpetazzo/dind</a></p><p id="9a0d" class="pw-post-body-paragraph kc kd it ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz im bi translated">JIB没有这些问题。它不需要任何外部程序或服务来运行。这是一个巨大的优势。</p><p id="9da8" class="pw-post-body-paragraph kc kd it ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz im bi translated">但是如果除了文件复制之外，您还需要以任何方式定制容器，那么您真的需要使用Maven exec或SonaType。但实际上，我可能会建议您也看看您的云为docker构建提供了哪些本机支持，也许不要使用maven来编排这些构建。</p><p id="f81b" class="pw-post-body-paragraph kc kd it ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz im bi translated">总的来说，我建议你使用类似<a class="ae kb" href="https://github.com/GoogleContainerTools/kaniko" rel="noopener ugc nofollow" target="_blank"> Kaniko </a>的东西来构建容器，然后限制自己只为你的应用程序安装jar。</p><p id="0b3f" class="pw-post-body-paragraph kc kd it ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz im bi translated">完整的例子请查看我的Github Repo:</p><div class="og oh gp gr oi oj"><a href="https://github.com/efenglu/docker-maven-build" rel="noopener  ugc nofollow" target="_blank"><div class="ok ab fo"><div class="ol ab om cl cj on"><h2 class="bd iu gy z fp oo fr fs op fu fw is bi translated">埃丰路/码头-马文-建造</h2><div class="oq l"><h3 class="bd b gy z fp oo fr fs op fu fw dk translated">使用maven构建docker容器的一组示例配置</h3></div><div class="or l"><p class="bd b dl z fp oo fr fs op fu fw dk translated">github.com</p></div></div><div class="os l"><div class="ot l ou ov ow os ox jv oj"/></div></div></a></div></div></div>    
</body>
</html>