<html>
<head>
<title>Kafka on Kubernetes, the Strimzi way! (Part 2)</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">库伯内特斯上的卡夫卡，斯特里姆兹之路！(第二部分)</h1>
<blockquote>原文：<a href="https://itnext.io/kafka-on-kubernetes-the-strimzi-way-part-2-43192f1dd831?source=collection_archive---------1-----------------------#2020-06-18">https://itnext.io/kafka-on-kubernetes-the-strimzi-way-part-2-43192f1dd831?source=collection_archive---------1-----------------------#2020-06-18</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="00e1" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">欢迎来到这个关于在Kubernetes上运行卡夫卡的博客系列:</p><ul class=""><li id="e8a2" class="kl km iq jp b jq jr ju jv jy kn kc ko kg kp kk kq kr ks kt bi translated"><a class="ae ku" rel="noopener ugc nofollow" target="_blank" href="/kafka-on-kubernetes-the-strimzi-way-part-1-bdff3e451788">第一部</a></li><li id="06d2" class="kl km iq jp b jq kv ju kw jy kx kc ky kg kz kk kq kr ks kt bi translated">第二部分——这个博客</li><li id="7262" class="kl km iq jp b jq kv ju kw jy kx kc ky kg kz kk kq kr ks kt bi translated"><a class="ae ku" rel="noopener ugc nofollow" target="_blank" href="/kafka-on-kubernetes-the-strimzi-way-part-3-19cfdfe86660?source=friends_link&amp;sk=f4adf9abd626390e8425422e7cd725a6">第三部分</a></li><li id="48f5" class="kl km iq jp b jq kv ju kw jy kx kc ky kg kz kk kq kr ks kt bi translated"><a class="ae ku" href="https://medium.com/@abhishek1987/kafka-on-kubernetes-the-strimzi-way-part-4-bf1e651e25b8" rel="noopener">第四部分</a></li></ul></div><div class="ab cl la lb hu lc" role="separator"><span class="ld bw bk le lf lg"/><span class="ld bw bk le lf lg"/><span class="ld bw bk le lf"/></div><div class="ij ik il im in"><p id="9e02" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们通过建立一个单节点Kafka集群开始了本系列第的第<a class="ae ku" rel="noopener ugc nofollow" target="_blank" href="/kafka-on-kubernetes-the-strimzi-way-part-1-bdff3e451788">部分，该集群只有同一个Kubernetes集群中的内部客户端可以访问，没有加密、认证或授权，使用临时持久性。在这个博客系列的过程中，我们将继续迭代/改进这个问题。</a></p><figure class="li lj lk ll gt lm gh gi paragraph-image"><div role="button" tabindex="0" class="ln lo di lp bf lq"><div class="gh gi lh"><img src="../Images/9db541c0cf9f2110a3bc6bc61f37de50.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*4F5vaOK5LoMHrTbEj4DSuw.png"/></div></div></figure><p id="fc18" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">本部分将涵盖以下主题:</p><ul class=""><li id="7a6d" class="kl km iq jp b jq jr ju jv jy kn kc ko kg kp kk kq kr ks kt bi translated">向外部应用程序公开Kafka集群</li><li id="fd5a" class="kl km iq jp b jq kv ju kw jy kx kc ky kg kz kk kq kr ks kt bi translated">应用<code class="fe lt lu lv lw b">TLS</code>加密</li><li id="28ac" class="kl km iq jp b jq kv ju kw jy kx kc ky kg kz kk kq kr ks kt bi translated">探索Kubernetes幕后的资源</li><li id="190f" class="kl km iq jp b jq kv ju kw jy kx kc ky kg kz kk kq kr ks kt bi translated">使用Kafka CLI和Go客户端应用程序来测试我们的集群设置</li></ul><blockquote class="lx ly lz"><p id="2d52" class="jn jo ma jp b jq jr js jt ju jv jw jx mb jz ka kb mc kd ke kf md kh ki kj kk ij bi translated"><em class="iq">代码在GitHub上可以找到—</em><a class="ae ku" href="https://github.com/abhirockzz/kafka-kubernetes-strimzi/" rel="noopener ugc nofollow" target="_blank"><em class="iq">https://github.com/abhirockzz/kafka-kubernetes-strimzi/</em></a></p></blockquote></div><div class="ab cl la lb hu lc" role="separator"><span class="ld bw bk le lf lg"/><span class="ld bw bk le lf lg"/><span class="ld bw bk le lf"/></div><div class="ij ik il im in"><h1 id="603f" class="me mf iq bd mg mh mi mj mk ml mm mn mo mp mq mr ms mt mu mv mw mx my mz na nb bi translated">我需要什么来尝试这个？</h1><p id="6ae1" class="pw-post-body-paragraph jn jo iq jp b jq nc js jt ju nd jw jx jy ne ka kb kc nf ke kf kg ng ki kj kk ij bi translated"><code class="fe lt lu lv lw b">kubectl</code>-<a class="ae ku" href="https://kubernetes.io/docs/tasks/tools/install-kubectl/" rel="noopener ugc nofollow" target="_blank">https://kubernetes.io/docs/tasks/tools/install-kubectl/</a></p><p id="89e1" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我将使用<a class="ae ku" href="https://docs.microsoft.com/azure/aks/intro-kubernetes?WT.mc_id=medium-blog-abhishgu" rel="noopener ugc nofollow" target="_blank">Azure Kubernetes Service(AKS)</a>来演示概念，但总的来说，它是独立于Kubernetes提供商的(例如，可以随意使用本地设置，如<code class="fe lt lu lv lw b">minikube</code>)。如果你想使用<code class="fe lt lu lv lw b">AKS</code>，你只需要一个<a class="ae ku" href="https://docs.microsoft.com/azure/?WT.mc_id=medium-blog-abhishgu" rel="noopener ugc nofollow" target="_blank">微软Azure账户</a>，如果你还没有的话，你可以<a class="ae ku" href="https://azure.microsoft.com/free/?WT.mc_id=medium-blog-abhishgu" rel="noopener ugc nofollow" target="_blank">免费获得</a>。</p><blockquote class="lx ly lz"><p id="3ca5" class="jn jo ma jp b jq jr js jt ju jv jw jx mb jz ka kb mc kd ke kf md kh ki kj kk ij bi translated"><em class="iq">在本系列的本部分或后续部分中，我不会重复一些常见部分(如Helm、Strimzi、Azure Kubernetes服务以及Strimzi概述的安装/设置),并会要求您</em> <a class="ae ku" rel="noopener ugc nofollow" target="_blank" href="/kafka-on-kubernetes-the-strimzi-way-part-1-bdff3e451788"> <em class="iq">参考第一部分</em> </a> <em class="iq">了解那些详细信息</em></p></blockquote></div><div class="ab cl la lb hu lc" role="separator"><span class="ld bw bk le lf lg"/><span class="ld bw bk le lf lg"/><span class="ld bw bk le lf"/></div><div class="ij ik il im in"><h1 id="c1d7" class="me mf iq bd mg mh mi mj mk ml mm mn mo mp mq mr ms mt mu mv mw mx my mz na nb bi translated">让我们创建一个外部可访问的Kafka集群</h1><p id="6a01" class="pw-post-body-paragraph jn jo iq jp b jq nc js jt ju nd jw jx jy ne ka kb kc nf ke kf kg ng ki kj kk ij bi translated">为了实现这一点，我们只需要稍微调整Strimzi <code class="fe lt lu lv lw b">Kafka</code>资源。我强调了下面的关键部分- <a class="ae ku" href="https://github.com/abhirockzz/kafka-kubernetes-strimzi/raw/master/part-1/kafka.yaml" rel="noopener ugc nofollow" target="_blank">这是第1部分的原始清单</a></p><pre class="li lj lk ll gt nh lw ni nj aw nk bi"><span id="cf42" class="nl mf iq lw b gy nm nn l no np">spec:<br/>  kafka:<br/>    version: 2.4.0<br/>    replicas: 1<br/>    listeners:<br/>      plain: {}<br/><strong class="lw ir">      external:<br/>        type: loadbalancer<br/>        tls: true</strong></span></pre><p id="e440" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">什么变了？</strong></p><p id="1d46" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">为了让外部客户端应用程序可以访问Kafka，我们添加了一个<code class="fe lt lu lv lw b">loadbalancer</code>类型的<code class="fe lt lu lv lw b">external</code>监听器。由于我们将把我们的应用程序暴露给公共互联网，我们需要额外的保护层，如传输层(<code class="fe lt lu lv lw b">TLS/SSL</code>加密)和应用层安全性(认证和授权)。在这一部分中，我们将只配置加密，并在另一篇博客中探讨其他方面。为了配置端到端的TLS加密，我们添加了<code class="fe lt lu lv lw b">tls: true</code></p><blockquote class="lx ly lz"><p id="1428" class="jn jo ma jp b jq jr js jt ju jv jw jx mb jz ka kb mc kd ke kf md kh ki kj kk ij bi translated"><code class="fe lt lu lv lw b"><em class="iq">tls: true</em></code> <em class="iq">配置实际上被用作默认设置，但是为了清楚起见，我已经明确地添加了它</em></p></blockquote><p id="022c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">要创建集群，请执行以下操作:</p><pre class="li lj lk ll gt nh lw ni nj aw nk bi"><span id="ef4f" class="nl mf iq lw b gy nm nn l no np">kubectl apply -f <a class="ae ku" href="https://github.com/abhirockzz/kafka-kubernetes-strimzi/raw/master/part-2/kafka.yaml" rel="noopener ugc nofollow" target="_blank">https://github.com/abhirockzz/kafka-kubernetes-strimzi/raw/master/part-2/kafka.yaml</a></span></pre><h2 id="9880" class="nl mf iq bd mg nq nr dn mk ns nt dp mo jy nu nv ms kc nw nx mw kg ny nz na oa bi translated">库伯内特魔法！</h2><p id="4b34" class="pw-post-body-paragraph jn jo iq jp b jq nc js jt ju nd jw jx jy ne ka kb kc nf ke kf kg ng ki kj kk ij bi translated">Strimzi操作员开始行动，为我们完成所有繁重的工作:</p><ul class=""><li id="14e5" class="kl km iq jp b jq jr ju jv jy kn kc ko kg kp kk kq kr ks kt bi translated">它创建了一个Kubernetes <code class="fe lt lu lv lw b"><a class="ae ku" href="https://kubernetes.io/docs/concepts/services-networking/service/#loadbalancer" rel="noopener ugc nofollow" target="_blank">LoadBalancer</a></code>服务..</li><li id="a085" class="kl km iq jp b jq kv ju kw jy kx kc ky kg kz kk kq kr ks kt bi translated">..并在<code class="fe lt lu lv lw b">ConfigMap</code>中播种适当的Kafka服务器配置</li></ul><p id="9901" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我将重点介绍与外部侦听器和TLS加密相对应的资源。要浏览作为Kafka集群的一部分创建的所有资源，<a class="ae ku" rel="noopener ugc nofollow" target="_blank" href="/kafka-on-kubernetes-the-strimzi-way-part-1-bdff3e451788">请参考第1部分</a></p><p id="7061" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果您查找<code class="fe lt lu lv lw b">Service</code> s，您将会看到与此类似的内容:</p><pre class="li lj lk ll gt nh lw ni nj aw nk bi"><span id="5d78" class="nl mf iq lw b gy nm nn l no np">kubectl get svc</span><span id="3cfb" class="nl mf iq lw b gy ob nn l no np">my-kafka-cluster-kafka-0                    LoadBalancer   10.0.162.98    40.119.233.2    9094:31860/TCP               60s<br/>my-kafka-cluster-kafka-bootstrap            ClusterIP      10.0.200.20    &lt;none&gt;          9091/TCP,9092/TCP            60s<br/>my-kafka-cluster-kafka-brokers              ClusterIP      None           &lt;none&gt;          9091/TCP,9092/TCP            60s<br/>my-kafka-cluster-kafka-external-bootstrap   LoadBalancer   10.0.122.211   20.44.239.202   9094:32267/TCP               60s<br/>my-kafka-cluster-zookeeper-client           ClusterIP      10.0.137.33    &lt;none&gt;          2181/TCP                     82s<br/>my-kafka-cluster-zookeeper-nodes            ClusterIP      None           &lt;none&gt;          2181/TCP,2888/TCP,3888/TCP   82s</span></pre><p id="f86b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">注意类型<code class="fe lt lu lv lw b">LoadBalancer</code>的<code class="fe lt lu lv lw b">my-kafka-cluster-kafka-external-bootstrapService</code>？因为我使用的是Azure Kubernetes服务，所以它由一个<a class="ae ku" href="https://docs.microsoft.com/azure/load-balancer/load-balancer-overview?WT.mc_id=medium-blog-abhishgu" rel="noopener ugc nofollow" target="_blank"> Azure负载均衡器</a>提供支持，这个负载均衡器有一个公共IP(在这个例子中是<code class="fe lt lu lv lw b">20.44.239.202</code>)，并通过端口<code class="fe lt lu lv lw b">9094</code>向外部客户端公开Kafka。通过使用<code class="fe lt lu lv lw b"><a class="ae ku" href="https://docs.microsoft.com/cli/azure/network/lb?view=azure-cli-latest&amp;WT.mc_id=medium-blog-abhishgu#az-network-lb-list" rel="noopener ugc nofollow" target="_blank">az network lb list</a></code>命令，您应该能够使用Azure CLI(或者Azure portal，如果您喜欢的话)找到它</p><pre class="li lj lk ll gt nh lw ni nj aw nk bi"><span id="a057" class="nl mf iq lw b gy nm nn l no np">export AKS_RESOURCE_GROUP=[replace with resource group name]<br/>export AKS_CLUSTER_NAME=[replace with AKS cluster name]<br/>export AKS_LOCATION=[replace with region e.g. southeastasia]</span><span id="8e3a" class="nl mf iq lw b gy ob nn l no np">az network lb list -g MC_${AKS_RESOURCE_GROUP}_${AKS_CLUSTER_NAME}_${AKS_LOCATION}</span></pre><p id="277b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">加密部分呢？</strong></p><p id="561e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">为了弄清楚这一点，让我们反思一下Kafka服务器的配置:</p><blockquote class="lx ly lz"><p id="d157" class="jn jo ma jp b jq jr js jt ju jv jw jx mb jz ka kb mc kd ke kf md kh ki kj kk ij bi translated"><em class="iq">如</em> <a class="ae ku" href="https://dev.to/azure/kafka-on-kubernetes-the-strimzi-way-part-1-57g7" rel="noopener ugc nofollow" target="_blank"> <em class="iq">上一篇博客</em> </a> <em class="iq">中所解释的，这是存储在</em> <code class="fe lt lu lv lw b"><em class="iq">ConfigMap</em></code>中的</p></blockquote><pre class="li lj lk ll gt nh lw ni nj aw nk bi"><span id="c002" class="nl mf iq lw b gy nm nn l no np">export CLUSTER_NAME=my-kafka-cluster<br/>kubectl get configmap/${CLUSTER_NAME}-kafka-config -o yaml</span></pre><p id="5fb5" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这就是<code class="fe lt lu lv lw b">server.config</code>中的<code class="fe lt lu lv lw b">Common listener configuration</code>所揭示的:</p><pre class="li lj lk ll gt nh lw ni nj aw nk bi"><span id="70a8" class="nl mf iq lw b gy nm nn l no np">listeners=REPLICATION-9091://0.0.0.0:9091,PLAIN-9092://0.0.0.0:9092,<strong class="lw ir">EXTERNAL-9094://0.0.0.0:9094</strong></span><span id="8a29" class="nl mf iq lw b gy ob nn l no np">advertised.listeners=REPLICATION-9091://my-kafka-cluster-kafka-${STRIMZI_BROKER_ID}.my-kafka-cluster-kafka-brokers.default.svc:9091,PLAIN-9092://my-kafka-cluster-kafka-${STRIMZI_BROKER_ID}.my-kafka-cluster-kafka-brokers.default.svc:9092,<strong class="lw ir">EXTERNAL-9094://${STRIMZI_EXTERNAL_9094_ADVERTISED_HOSTNAME}:${STRIMZI_EXTERNAL_9094_ADVERTISED_PORT}</strong></span><span id="235d" class="nl mf iq lw b gy ob nn l no np">listener.security.protocol.map=REPLICATION-9091:SSL,PLAIN-9092:PLAINTEXT,<strong class="lw ir">EXTERNAL-9094:SSL</strong></span></pre><p id="45d1" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">请注意，除了代理间复制(通过端口<code class="fe lt lu lv lw b">9091</code>)和非<code class="fe lt lu lv lw b">TLS</code>端口<code class="fe lt lu lv lw b">9092</code>上的未加密内部(Kubernetes集群内)客户端访问之外，还为通过端口<code class="fe lt lu lv lw b">9094</code>的TLS加密访问添加了适当的监听器配置</p></div><div class="ab cl la lb hu lc" role="separator"><span class="ld bw bk le lf lg"/><span class="ld bw bk le lf lg"/><span class="ld bw bk le lf"/></div><div class="ij ik il im in"><h1 id="a409" class="me mf iq bd mg mh mi mj mk ml mm mn mo mp mq mr ms mt mu mv mw mx my mz na nb bi translated">关键时刻到了…</h1><p id="8071" class="pw-post-body-paragraph jn jo iq jp b jq nc js jt ju nd jw jx jy ne ka kb kc nf ke kf kg ng ki kj kk ij bi translated">为了证实这一点，让我们尝试几个客户端应用程序，它们将与我们在Kubernetes上新创建的Kafka集群进行通信！我们将使用以下内容生成和使用消息:</p><ul class=""><li id="e6bf" class="kl km iq jp b jq jr ju jv jy kn kc ko kg kp kk kq kr ks kt bi translated">Kafka CLI(控制台)生产者和消费者</li><li id="e611" class="kl km iq jp b jq kv ju kw jy kx kc ky kg kz kk kq kr ks kt bi translated">Go应用程序(使用<a class="ae ku" href="https://github.com/confluentinc/confluent-kafka-go" rel="noopener ugc nofollow" target="_blank">合流Kafka Go客户端</a></li></ul><p id="aa49" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">与Kafka集群的通信必须加密(非TLS客户端连接将被拒绝)。<code class="fe lt lu lv lw b">TLS/SSL</code>隐含着单向认证，客户端验证Kafka经纪人的身份。为此，客户端应用程序需要信任群集CA证书。记住集群CA证书存储在Kubernetes <code class="fe lt lu lv lw b">Secret</code>中(参见第1部分中的<a class="ae ku" rel="noopener ugc nofollow" target="_blank" href="/kafka-on-kubernetes-the-strimzi-way-part-1-bdff3e451788">细节)。默认情况下，这些是由Strimzi自动生成的，但是您也可以提供自己的证书(请参考</a><a class="ae ku" href="https://strimzi.io/docs/operators/master/using.html#kafka-listener-certificates-str" rel="noopener ugc nofollow" target="_blank">https://strim zi . io/docs/operators/master/using . html # Kafka-listener-certificates-str</a>)</p><p id="8608" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">首先提取群集CA证书和密码:</p><pre class="li lj lk ll gt nh lw ni nj aw nk bi"><span id="0c31" class="nl mf iq lw b gy nm nn l no np">export CLUSTER_NAME=my-kafka-cluster</span><span id="dad5" class="nl mf iq lw b gy ob nn l no np">kubectl get secret $CLUSTER_NAME-cluster-ca-cert -o jsonpath='{.data.ca\.crt}' | base64 --decode &gt; ca.crt</span><span id="d43b" class="nl mf iq lw b gy ob nn l no np">kubectl get secret $CLUSTER_NAME-cluster-ca-cert -o jsonpath='{.data.ca\.password}' | base64 --decode &gt; ca.password</span></pre><blockquote class="lx ly lz"><p id="6421" class="jn jo ma jp b jq jr js jt ju jv jw jx mb jz ka kb mc kd ke kf md kh ki kj kk ij bi translated"><em class="iq">你应该有两个文件:</em> <code class="fe lt lu lv lw b"><em class="iq">ca.crt</em></code> <em class="iq">和</em> <code class="fe lt lu lv lw b"><em class="iq">ca.password</em></code> <em class="iq">。请随意查看他们的内容</em></p></blockquote><p id="be4d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">一些Kafka客户端(例如Confluent Go客户端)直接使用CA证书，而其他客户端(例如Java客户端、Kafka CLI等)则直接使用CA证书。)要求通过<code class="fe lt lu lv lw b">truststore</code>访问CA证书。我使用的是JDK (Java)安装自带的内置<code class="fe lt lu lv lw b">truststore</code>——但这只是为了方便，你可以自由使用其他选项(比如创建自己的选项)</p><pre class="li lj lk ll gt nh lw ni nj aw nk bi"><span id="6757" class="nl mf iq lw b gy nm nn l no np">export CERT_FILE_PATH=ca.crt<br/>export CERT_PASSWORD_FILE_PATH=ca.password</span><span id="b367" class="nl mf iq lw b gy ob nn l no np"># replace this with the path to your truststore</span><span id="0b8d" class="nl mf iq lw b gy ob nn l no np">export KEYSTORE_LOCATION=/Library/Java/JavaVirtualMachines/jdk1.8.0_221.jdk/Contents/Home/jre/lib/security/cacerts</span><span id="6c72" class="nl mf iq lw b gy ob nn l no np">export PASSWORD=`cat $CERT_PASSWORD_FILE_PATH`</span><span id="016a" class="nl mf iq lw b gy ob nn l no np">export CA_CERT_ALIAS=strimzi-kafka-cert</span><span id="a070" class="nl mf iq lw b gy ob nn l no np"># you will prompted for the truststore password. for JDK truststore, the default password is "changeit"<br/># Type yes in response to the 'Trust this certificate? [no]:' prompt</span><span id="704d" class="nl mf iq lw b gy ob nn l no np">sudo keytool -importcert -alias $CA_CERT_ALIAS -file $CERT_FILE_PATH -keystore $KEYSTORE_LOCATION -keypass $PASSWORD</span><span id="523c" class="nl mf iq lw b gy ob nn l no np">sudo keytool -list -alias $CA_CERT_ALIAS -keystore $KEYSTORE_LOCATION</span></pre><p id="76b7" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这就是基本设置—您已经准备好试用Kafka CLI客户端了！</p><blockquote class="lx ly lz"><p id="f9b2" class="jn jo ma jp b jq jr js jt ju jv jw jx mb jz ka kb mc kd ke kf md kh ki kj kk ij bi translated"><em class="iq">请注意，下面详述的Kafka CLI配置步骤也适用于Java客户端——试一试吧！</em></p></blockquote><p id="3d68" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">提取Kafka集群的<code class="fe lt lu lv lw b">LoadBalancer</code>公共IP</p><pre class="li lj lk ll gt nh lw ni nj aw nk bi"><span id="f845" class="nl mf iq lw b gy nm nn l no np">export KAFKA_CLUSTER_NAME=my-kafka-cluster</span><span id="f4a9" class="nl mf iq lw b gy ob nn l no np">kubectl get service/${KAFKA_CLUSTER_NAME}-kafka-external-bootstrap --output=jsonpath={.status.loadBalancer.ingress[0].ip}</span></pre><p id="861f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">用以下内容创建一个名为<code class="fe lt lu lv lw b">client-ssl.properties</code>的文件:</p><pre class="li lj lk ll gt nh lw ni nj aw nk bi"><span id="db4d" class="nl mf iq lw b gy nm nn l no np">bootstrap.servers=[LOADBALANCER_PUBLIC_IP]:9094<br/>security.protocol=SSL<br/>ssl.truststore.location=[TRUSTSTORE_LOCATION]<br/>//for JDK truststore, the default password is "changeit"<br/>ssl.truststore.password=changeit</span></pre><p id="7839" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">要使用Kafka CLI，如果你还没有的话，下载<code class="fe lt lu lv lw b">Kafka</code>-<a class="ae ku" href="https://kafka.apache.org/downloads" rel="noopener ugc nofollow" target="_blank">https://kafka.apache.org/downloads</a></p><p id="4461" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">您所需要做的就是通过将<code class="fe lt lu lv lw b">kafka-console-producer</code>和<code class="fe lt lu lv lw b">kafka-console-consumer</code>指向您刚刚创建的<code class="fe lt lu lv lw b">client-ssl.properties</code>文件来使用它们</p><pre class="li lj lk ll gt nh lw ni nj aw nk bi"><span id="f5d6" class="nl mf iq lw b gy nm nn l no np">export KAFKA_HOME=[replace with Kafka installation path] e.g. /Users/foobar/kafka_2.12-2.3.0</span><span id="2d6a" class="nl mf iq lw b gy ob nn l no np">export LOADBALANCER_PUBLIC_IP=[replace with public IP of Load Balancer]</span><span id="22ba" class="nl mf iq lw b gy ob nn l no np">export TOPIC_NAME=test-strimzi-topic</span><span id="a704" class="nl mf iq lw b gy ob nn l no np"># on a terminal, start producer and send a few messages<br/>$KAFKA_HOME/bin/kafka-console-producer.sh --broker-list $LOADBALANCER_PUBLIC_IP:9094 --topic $TOPIC_NAME --producer.config client-ssl.properties</span><span id="855a" class="nl mf iq lw b gy ob nn l no np"># on another terminal, start consumer<br/>$KAFKA_HOME/bin/kafka-console-consumer.sh --bootstrap-server $LOADBALANCER_PUBLIC_IP:9094 --topic $TOPIC_NAME --consumer.config client-ssl.properties --from-beginning</span></pre><p id="d645" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">你应该看到生产者和消费者协同工作。太好了！</p><blockquote class="lx ly lz"><p id="91f6" class="jn jo ma jp b jq jr js jt ju jv jw jx mb jz ka kb mc kd ke kf md kh ki kj kk ij bi translated"><em class="iq">如果您遇到SSL握手错误，请检查CA证书及其正确密码是否已正确导入。如果Kafka集群不可达，请确保您对公共IP使用了正确的值</em></p></blockquote><p id="4e56" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在，让我们尝试一个编程式客户端。因为Java客户端行为(必需的配置属性)与CLI相同，所以我使用Go客户端来尝试一些不同的东西。不要担心，如果你不是一个Go程序员，这应该很容易理解——我不会遍历整个程序，只是我们创建连接相关配置的部分。</p><p id="6c7a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">以下是片段:</p><pre class="li lj lk ll gt nh lw ni nj aw nk bi"><span id="bda6" class="nl mf iq lw b gy nm nn l no np">bootstrapServers = os.Getenv("KAFKA_BOOTSTRAP_SERVERS")<br/>caLocation = os.Getenv("CA_CERT_LOCATION")<br/>topic = os.Getenv("KAFKA_TOPIC")</span><span id="2002" class="nl mf iq lw b gy ob nn l no np">config := &amp;kafka.ConfigMap{"bootstrap.servers": bootstrapServers, "security.protocol": "SSL", "ssl.ca.location": caLocation}</span></pre><p id="5d9f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">请注意，<code class="fe lt lu lv lw b">bootstrap.servers</code>和<code class="fe lt lu lv lw b">security.protocol</code>与您在Kafka CLI客户端中使用的相同(对于Java也是如此)。唯一的区别是<code class="fe lt lu lv lw b">ssl.ca.location</code>用于直接指向CA证书，而不是<code class="fe lt lu lv lw b">truststore</code></p><p id="1d56" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果你安装了<code class="fe lt lu lv lw b">Go</code>，你可以试试。克隆Git repo...</p><pre class="li lj lk ll gt nh lw ni nj aw nk bi"><span id="42d7" class="nl mf iq lw b gy nm nn l no np">git clone https://github.com/abhirockzz/kafka-kubernetes-strimzi<br/>cd part-2/go-client-app</span></pre><p id="fa26" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">..并运行程序:</p><pre class="li lj lk ll gt nh lw ni nj aw nk bi"><span id="1977" class="nl mf iq lw b gy nm nn l no np">export KAFKA_BOOTSTRAP_SERVERS=[replace with loadbalancer_ip:9094] e.g. 42.42.424.424:9094</span><span id="ad12" class="nl mf iq lw b gy ob nn l no np">export CA_CERT_LOCATION=[replace with path to ca.crt file which you downloaded]</span><span id="8149" class="nl mf iq lw b gy ob nn l no np">export KAFKA_TOPIC=test-strimzi-topic</span><span id="d331" class="nl mf iq lw b gy ob nn l no np">go run kafka-client.go</span></pre><p id="9d04" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">您应该会看到类似这样的日志，并确认正在生成和使用消息</p><blockquote class="lx ly lz"><p id="bea5" class="jn jo ma jp b jq jr js jt ju jv jw jx mb jz ka kb mc kd ke kf md kh ki kj kk ij bi translated"><em class="iq">按</em> <code class="fe lt lu lv lw b"><em class="iq">ctrl+c</em></code> <em class="iq">退出app </em></p></blockquote><pre class="li lj lk ll gt nh lw ni nj aw nk bi"><span id="504d" class="nl mf iq lw b gy nm nn l no np">started consumer<br/>started producer delivery goroutine<br/>started producer goroutine</span><span id="346e" class="nl mf iq lw b gy ob nn l no np">delivered messaged test-strimzi-topic[0]@122<br/>delivered messaged test-strimzi-topic[0]@123<br/>delivered messaged test-strimzi-topic[0]@124<br/>received message from test-strimzi-topic[0]@122: value-2020-06-08 16:23:05.913303 +0530 IST m=+0.020529419<br/>received message from test-strimzi-topic[0]@123: value-2020-06-08 16:23:07.915252 +0530 IST m=+2.022455867<br/>received message from test-strimzi-topic[0]@124: value-2020-06-08 16:23:09.915875 +0530 IST m=+4.023055601<br/>received message from test-strimzi-topic[0]@125: value-2020-06-08 16:23:11.915977 +0530 IST m=+6.023134961<br/>....</span></pre></div><div class="ab cl la lb hu lc" role="separator"><span class="ld bw bk le lf lg"/><span class="ld bw bk le lf lg"/><span class="ld bw bk le lf"/></div><div class="ij ik il im in"><h1 id="e910" class="me mf iq bd mg mh mi mj mk ml mm mn mo mp mq mr ms mt mu mv mw mx my mz na nb bi translated">这就是现在的全部，但还有更多的来了！</h1><p id="6e17" class="pw-post-body-paragraph jn jo iq jp b jq nc js jt ju nd jw jx jy ne ka kb kc nf ke kf kg ng ki kj kk ij bi translated">所以我们取得了一些进步！我们现在在Kubernetes上有一个Kafka集群，可以公开访问，但由于TLS加密，它是(部分)安全的。我们还使用不是一个，而是两个(不同的)客户端应用程序做了一些健全性测试。在下一部分，我们将进一步改进这一点…敬请期待！</p></div></div>    
</body>
</html>