<html>
<head>
<title>Testing the Operator SDK and making a prefetch mechanism for Kubernetes</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">测试运营商SDK并为Kubernetes制定预取机制</h1>
<blockquote>原文：<a href="https://itnext.io/testing-the-operator-sdk-and-making-a-prefetch-mechanism-for-kubernetes-7508577efdd7?source=collection_archive---------6-----------------------#2020-11-01">https://itnext.io/testing-the-operator-sdk-and-making-a-prefetch-mechanism-for-kubernetes-7508577efdd7?source=collection_archive---------6-----------------------#2020-11-01</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div class="gh gi jn"><img src="../Images/08700f6bc6220ca5c9a91ad430b554bf.png" data-original-src="https://miro.medium.com/v2/resize:fit:720/format:webp/0*ae1grIEjr7dD4cbV.png"/></div></figure><h2 id="6861" class="ju jv iq bd jw jx jy dn jz ka kb dp kc kd ke kf kg kh ki kj kk kl km kn ko kp bi translated">介绍</h2><p id="4b87" class="pw-post-body-paragraph kq kr iq ks b kt ku kv kw kx ky kz la kd lb lc ld kh le lf lg kl lh li lj lk ij bi translated">在本文中，我们将探索如何使用Operator SDK创建一个可以预取我们的映像(从我们的部署到所有节点)的操作器，您可能想知道为什么要这样做？主要的想法是提前获取图像，这样当pod实际上需要在给定的节点上开始运行时，您就不必再调用它们了，这样可以加快速度，而且这也是一个有趣的练习。</p><p id="6f11" class="pw-post-body-paragraph kq kr iq ks b kt ll kv kw kx lm kz la kd ln lc ld kh lo lf lg kl lp li lj lk ij bi translated">如果你读过文章<a class="ae lq" href="https://techsquad.rocks/blog/cloud_native_applications_with_kubebuilder_and_kind_aka_kubernetes_operators/" rel="noopener ugc nofollow" target="_blank">用kubebuilder和kind aka kubernetes operators </a>云原生应用，你会注意到命令彼此之间非常相似，因为现在operator-sdk使用kubebuilder，你可以在这里阅读更多<a class="ae lq" href="https://github.com/operator-framework/operator-sdk/issues/3558#issuecomment-664206538" rel="noopener ugc nofollow" target="_blank"/>。</p><p id="9db7" class="pw-post-body-paragraph kq kr iq ks b kt ll kv kw kx lm kz la kd ln lc ld kh lo lf lg kl lp li lj lk ij bi translated">这篇文章的来源是<a class="ae lq" href="https://github.com/kainlite/kubernetes-prefetch-operator/" rel="noopener ugc nofollow" target="_blank">这里</a></p><p id="d029" class="pw-post-body-paragraph kq kr iq ks b kt ll kv kw kx lm kz la kd ln lc ld kh lo lf lg kl lp li lj lk ij bi translated"><strong class="ks ir">先决条件</strong></p><ul class=""><li id="5e7c" class="lr ls iq ks b kt ll kx lm kd lt kh lu kl lv lk lw lx ly lz bi translated"><a class="ae lq" href="https://sdk.operatorframework.io/docs/installation/install-operator-sdk/" rel="noopener ugc nofollow" target="_blank">运营商SDK </a></li><li id="653c" class="lr ls iq ks b kt ma kx mb kd mc kh md kl me lk lw lx ly lz bi translated"><a class="ae lq" href="https://golang.org/dl/" rel="noopener ugc nofollow" target="_blank">开始</a></li><li id="f67d" class="lr ls iq ks b kt ma kx mb kd mc kh md kl me lk lw lx ly lz bi translated"><a class="ae lq" href="https://github.com/kubernetes-sigs/kind" rel="noopener ugc nofollow" target="_blank">种类</a></li><li id="d94b" class="lr ls iq ks b kt ma kx mb kd mc kh md kl me lk lw lx ly lz bi translated"><a class="ae lq" href="https://hub.docker.com/?overlay=onboarding" rel="noopener ugc nofollow" target="_blank">码头工人</a></li><li id="5491" class="lr ls iq ks b kt ma kx mb kd mc kh md kl me lk lw lx ly lz bi translated"><a class="ae lq" href="https://github.com/kubernetes-sigs/kustomize" rel="noopener ugc nofollow" target="_blank">草薙</a></li></ul><h2 id="7c47" class="ju jv iq bd jw jx jy dn jz ka kb dp kc kd ke kf kg kh ki kj kk kl km kn ko kp bi translated">创建我们的本地集群</h2><p id="3d6f" class="pw-post-body-paragraph kq kr iq ks b kt ku kv kw kx ky kz la kd lb lc ld kh le lf lg kl lh li lj lk ij bi translated">多集群的种类配置</p><p id="e4e9" class="pw-post-body-paragraph kq kr iq ks b kt ll kv kw kx lm kz la kd ln lc ld kh lo lf lg kl lp li lj lk ij bi translated">这是本地多节点设置所必需的配置:<code class="fe mf mg mh mi b">kind create cluster --config kind.yaml</code></p><figure class="mj mk ml mm gt jr"><div class="bz fp l di"><div class="mn mo l"/></div></figure><p id="f8f6" class="pw-post-body-paragraph kq kr iq ks b kt ll kv kw kx lm kz la kd ln lc ld kh lo lf lg kl lp li lj lk ij bi translated">你可以在这里找到文件<a class="ae lq" href="https://github.com/kainlite/kubernetes-prefetch-operator/blob/master/kind.yaml" rel="noopener ugc nofollow" target="_blank"/></p><p id="b3ee" class="pw-post-body-paragraph kq kr iq ks b kt ll kv kw kx lm kz la kd ln lc ld kh lo lf lg kl lp li lj lk ij bi translated"><strong class="ks ir">创建集群</strong></p><p id="9038" class="pw-post-body-paragraph kq kr iq ks b kt ll kv kw kx lm kz la kd ln lc ld kh lo lf lg kl lp li lj lk ij bi translated">我们将需要一个集群来运行和测试我们的操作符，所以kind非常简单，并且足够轻量，可以在任何地方运行。</p><figure class="mj mk ml mm gt jr"><div class="bz fp l di"><div class="mn mo l"/></div></figure><h2 id="5a91" class="ju jv iq bd jw jx jy dn jz ka kb dp kc kd ke kf kg kh ki kj kk kl km kn ko kp bi translated">创建我们的操作员</h2><p id="29dc" class="pw-post-body-paragraph kq kr iq ks b kt ku kv kw kx ky kz la kd lb lc ld kh le lf lg kl lh li lj lk ij bi translated">在这里，我们引导我们的go项目，即kubernetes操作符</p><figure class="mj mk ml mm gt jr"><div class="bz fp l di"><div class="mn mo l"/></div></figure><h2 id="fc10" class="ju jv iq bd jw jx jy dn jz ka kb dp kc kd ke kf kg kh ki kj kk kl km kn ko kp bi translated">创建我们的API</h2><p id="4f41" class="pw-post-body-paragraph kq kr iq ks b kt ku kv kw kx ky kz la kd lb lc ld kh le lf lg kl lh li lj lk ij bi translated">这个对象将保存给定图像的所有重要信息，我们首先需要修改的文件在:<code class="fe mf mg mh mi b">controllers/*_controller.go</code>和<code class="fe mf mg mh mi b">api/v1/*_types.go</code></p><figure class="mj mk ml mm gt jr"><div class="bz fp l di"><div class="mn mo l"/></div></figure><h2 id="3c0b" class="ju jv iq bd jw jx jy dn jz ka kb dp kc kd ke kf kg kh ki kj kk kl km kn ko kp bi translated">构建和推送(docker图像)</h2><p id="9006" class="pw-post-body-paragraph kq kr iq ks b kt ku kv kw kx ky kz la kd lb lc ld kh le lf lg kl lh li lj lk ij bi translated">使用项目助手基本构建和推送操作员映像</p><figure class="mj mk ml mm gt jr"><div class="bz fp l di"><div class="mn mo l"/></div></figure><h2 id="f7b0" class="ju jv iq bd jw jx jy dn jz ka kb dp kc kd ke kf kg kh ki kj kk kl km kn ko kp bi translated">部署</h2><p id="ac93" class="pw-post-body-paragraph kq kr iq ks b kt ku kv kw kx ky kz la kd lb lc ld kh le lf lg kl lh li lj lk ij bi translated">既然我们已经将项目构建到docker映像中并存储在dockerhub中，那么我们可以安装我们的CRD，然后部署操作符</p><figure class="mj mk ml mm gt jr"><div class="bz fp l di"><div class="mn mo l"/></div></figure><p id="5d79" class="pw-post-body-paragraph kq kr iq ks b kt ll kv kw kx lm kz la kd ln lc ld kh lo lf lg kl lp li lj lk ij bi translated"><strong class="ks ir">部署操作员</strong></p><p id="1458" class="pw-post-body-paragraph kq kr iq ks b kt ll kv kw kx lm kz la kd ln lc ld kh lo lf lg kl lp li lj lk ij bi translated">然后我们可以部署我们的操作员</p><figure class="mj mk ml mm gt jr"><div class="bz fp l di"><div class="mn mo l"/></div></figure><p id="0e89" class="pw-post-body-paragraph kq kr iq ks b kt ll kv kw kx lm kz la kd ln lc ld kh lo lf lg kl lp li lj lk ij bi translated">检查我们的吊舱正在运行</p><figure class="mj mk ml mm gt jr"><div class="bz fp l di"><div class="mn mo l"/></div></figure><p id="b5b6" class="pw-post-body-paragraph kq kr iq ks b kt ll kv kw kx lm kz la kd ln lc ld kh lo lf lg kl lp li lj lk ij bi translated">到目前为止，一切都很好，但我们的操作员目前什么都不做，所以让我们删除一些代码，让它做我们想要的…</p><h2 id="b243" class="ju jv iq bd jw jx jy dn jz ka kb dp kc kd ke kf kg kh ki kj kk kl km kn ko kp bi translated">我们的准则</h2><p id="9ec7" class="pw-post-body-paragraph kq kr iq ks b kt ku kv kw kx ky kz la kd lb lc ld kh le lf lg kl lh li lj lk ij bi translated">我们使用的很多东西都是生成的，但是我们需要给它一些特定的权限和行为给我们的操作者，这样当我们在kubernetes中创建一个对象时，它就会做我们想要做的事情</p><p id="b999" class="pw-post-body-paragraph kq kr iq ks b kt ll kv kw kx lm kz la kd ln lc ld kh lo lf lg kl lp li lj lk ij bi translated"><strong class="ks ir">我们的清单</strong></p><p id="2e8c" class="pw-post-body-paragraph kq kr iq ks b kt ll kv kw kx lm kz la kd ln lc ld kh lo lf lg kl lp li lj lk ij bi translated">这将是我们将用来告诉我们的操作员我们想要预取映像的部署的清单</p><figure class="mj mk ml mm gt jr"><div class="bz fp l di"><div class="mn mo l"/></div></figure><p id="3cd0" class="pw-post-body-paragraph kq kr iq ks b kt ll kv kw kx lm kz la kd ln lc ld kh lo lf lg kl lp li lj lk ij bi translated">nginx部署示例</p><figure class="mj mk ml mm gt jr"><div class="bz fp l di"><div class="mn mo l"/></div></figure><p id="2257" class="pw-post-body-paragraph kq kr iq ks b kt ll kv kw kx lm kz la kd ln lc ld kh lo lf lg kl lp li lj lk ij bi translated">这个nginx部署将用于验证是否在所有节点中获取了图像。我们实际上不需要这样做，但是这样很容易确保如果标签不存在，就不会调度一个pod:<code class="fe mf mg mh mi b">kubectl label nodes kind-worker3 nginx-schedulable="true"</code></p><p id="8850" class="pw-post-body-paragraph kq kr iq ks b kt ll kv kw kx lm kz la kd ln lc ld kh lo lf lg kl lp li lj lk ij bi translated"><strong class="ks ir">我们的实际逻辑(这让我窃笑了这么多自举只是为了到这里，但是想象一下你必须自己做所有这些只是为了得到足够的东西让一个pod以受控的方式运行)</strong></p><p id="aa60" class="pw-post-body-paragraph kq kr iq ks b kt ll kv kw kx lm kz la kd ln lc ld kh lo lf lg kl lp li lj lk ij bi translated">这是事情实际发生的地方，首先我们更新我们的规范:</p><figure class="mj mk ml mm gt jr"><div class="bz fp l di"><div class="mn mo l"/></div></figure><p id="2738" class="pw-post-body-paragraph kq kr iq ks b kt ll kv kw kx lm kz la kd ln lc ld kh lo lf lg kl lp li lj lk ij bi translated">然后我们可以放一些代码，稍后我会在代码中添加更多的注释来解释每件事的作用:</p><figure class="mj mk ml mm gt jr"><div class="bz fp l di"><div class="mn mo l"/></div></figure><p id="4afd" class="pw-post-body-paragraph kq kr iq ks b kt ll kv kw kx lm kz la kd ln lc ld kh lo lf lg kl lp li lj lk ij bi translated">基本上，我们所做的是设置一个计时器，在每个节点中创建一个pod，以强制它获取部署(我们按标签筛选)需要或将要使用的映像，通过这样做，如果节点已经有了映像，则不会发生任何情况，它将在下次运行时被删除，但是如果映像不在那里，它将被获取，因此如果发生任何情况，pod需要实际安排在那里，它将不需要下载所有内容，因此它应该相对更快。</p><p id="0f83" class="pw-post-body-paragraph kq kr iq ks b kt ll kv kw kx lm kz la kd ln lc ld kh lo lf lg kl lp li lj lk ij bi translated">我们应该在集群中看到什么</p><figure class="mj mk ml mm gt jr"><div class="bz fp l di"><div class="mn mo l"/></div></figure><p id="a03b" class="pw-post-body-paragraph kq kr iq ks b kt ll kv kw kx lm kz la kd ln lc ld kh lo lf lg kl lp li lj lk ij bi translated">确保<code class="fe mf mg mh mi b">kubectl apply -f config/samples/k8s_nginx_deployment.yaml</code>和<code class="fe mf mg mh mi b">kubectl apply -f config/samples/cache_v1_prefetch.yaml</code></p><h2 id="8e7d" class="ju jv iq bd jw jx jy dn jz ka kb dp kc kd ke kf kg kh ki kj kk kl km kn ko kp bi translated">清理</h2><p id="0936" class="pw-post-body-paragraph kq kr iq ks b kt ku kv kw kx ky kz la kd lb lc ld kh le lf lg kl lh li lj lk ij bi translated">要从集群中清理运营商，您可以这样做，同时记住清理您的集群或您正在使用的任何东西，如果它在云中，以避免意外的账单</p><figure class="mj mk ml mm gt jr"><div class="bz fp l di"><div class="mn mo l"/></div></figure><p id="4ffb" class="pw-post-body-paragraph kq kr iq ks b kt ll kv kw kx lm kz la kd ln lc ld kh lo lf lg kl lp li lj lk ij bi translated"><strong class="ks ir">成交单据</strong></p><p id="d35f" class="pw-post-body-paragraph kq kr iq ks b kt ll kv kw kx lm kz la kd ln lc ld kh lo lf lg kl lp li lj lk ij bi translated">如果你想了解更多关于这个项目的信息，请务必查看链接，我希望你喜欢它，在<a class="ae lq" href="https://twitter.com/kainlite" rel="noopener ugc nofollow" target="_blank"> twitter </a>或<a class="ae lq" href="https://github.com/kainlite" rel="noopener ugc nofollow" target="_blank"> github </a>上再见！</p><p id="bd26" class="pw-post-body-paragraph kq kr iq ks b kt ll kv kw kx lm kz la kd ln lc ld kh lo lf lg kl lp li lj lk ij bi translated">这篇文章的来源是<a class="ae lq" href="https://github.com/kainlite/kubernetes-prefetch-operator/" rel="noopener ugc nofollow" target="_blank">这里</a></p><h1 id="a193" class="mp jv iq bd jw mq mr ms jz mt mu mv kc mw mx my kg mz na nb kk nc nd ne ko nf bi translated">正误表</h1><p id="709d" class="pw-post-body-paragraph kq kr iq ks b kt ku kv kw kx ky kz la kd lb lc ld kh le lf lg kl lh li lj lk ij bi translated">如果您发现任何错误或有任何建议，请给我发消息，以便解决问题。</p><p id="fbd0" class="pw-post-body-paragraph kq kr iq ks b kt ll kv kw kx lm kz la kd ln lc ld kh lo lf lg kl lp li lj lk ij bi translated">此外，您可以在这里查看源代码和<a class="ae lq" href="https://github.com/kainlite/kainlite.github.io" rel="noopener ugc nofollow" target="_blank">生成代码</a>和<a class="ae lq" href="https://github.com/kainlite/blog" rel="noopener ugc nofollow" target="_blank">源代码</a>的变化</p></div><div class="ab cl ng nh hu ni" role="separator"><span class="nj bw bk nk nl nm"/><span class="nj bw bk nk nl nm"/><span class="nj bw bk nk nl"/></div><div class="ij ik il im in"><p id="64ef" class="pw-post-body-paragraph kq kr iq ks b kt ll kv kw kx lm kz la kd ln lc ld kh lo lf lg kl lp li lj lk ij bi translated"><em class="nn">原载于2020年11月1日</em><a class="ae lq" href="https://techsquad.rocks/blog/testing_the_operator_sdk_and_making_a_prefetch_mechanism_for_kubernetes/" rel="noopener ugc nofollow" target="_blank"><em class="nn">https://tech squad . rocks</em></a><em class="nn">。</em></p></div></div>    
</body>
</html>