# 构建可换肤的多租户 Angular 应用程序

> 原文：<https://itnext.io/building-a-skinnable-multi-tenant-angular-application-7bc6f558fc0c?source=collection_archive---------0----------------------->

这是一个常见的故事:你开始一个构建应用程序的项目，比方说，一个为客户售票的应用程序。事情进展顺利。你的客户喜欢这个应用程序。一切都很好，直到你的客户问你是否有可能为他们的另一个资产部署应用程序——问题是外观和感觉必须不同于你一直在开发的那个。哦，也许，只是为了好玩，让我们说它与不同的认证提供者对话。

祝贺您:您刚刚进入了多租户区域。

![](img/b9f45edbdebf369616c83f32487ea0c4.png)

这是应用程序开发中的一个常见问题，根据语言/工具包/框架的不同，有许多既定的解决方案。大体上，我们可以认为解决方案有两种不同的风格:

1.  **静**。在静态解决方案中，人们会产生不同的代码，这些代码将被单独编译和部署。
2.  **动态**。在动态解决方案中，人们会生成一个单一的代码库，在运行时确定正确的租户。

我认为很容易想到静态解决方案是如何工作的。动态的那个？不太明显。

在这篇文章中，我将分享一个基于 Angular 框架的动态方法来解决这个问题。本文中的示例是在 Angular 8 的上下文中开发的，但是很可能与 Angular 7 以及更早版本的 Angular 兼容。因此，让我们开始吧…

# 多租户角度应用程序的核心

要建立多租户，我们需要做的第一件事是创建一组负责管理应用程序中当前租户的组件。它将负责以下任务:

1.  基于 URL 确定当前租户是谁。
2.  用一个特殊的头装饰我们发送回应用程序服务器部分的头，让后端知道我们代表哪个租户。

根据这两个简单的功能，我们将启用以下多租户功能:

1.  基于租户的可换肤组件。
2.  基于租户的服务变体的自动注入。
3.  基于租户的自动模块级路由重新配置。

当然，在概念上更多的特性是可能的，但是本文只考虑这两个。

首先，让我们启动一个新的角度应用程序:

```
# ng new multi-tenant-angular
```

这将创造一个新鲜的，但空白的新的角度应用，这将作为我们将要建立的基础。

# 构建租户服务

我们需要做的第一件事是构建一个服务，它可以确定给定 URL 的正确租户。以这种方式建立租赁是一种非常常见的模式，下面是它的工作方式。

首先，考虑一个如下所示的 URL:

```
http://**tenant-name**.applicationdomain.dom
```

在上面的 URL 中，域的第一部分(租户名称)是租户的来源。这允许我们构建一个 URL 结构，例如:

```
[http://client1.applicationdomain.dom](http://client1.applicationdomain.dom)
http://client2.applicationdomain.dom
http://client3.applicationdomain.dom
```

其中客户机 1、客户机 2 和客户机 3 都是我们应用程序的租户。为了实现这个功能，让我们在应用程序中的一个模块中创建一个 TenantService，我们用它来保存所有的租户功能。我们可以用下面两个命令完成所有这些。

```
# ng generate module tenant
# ng generate service tenant/tenant
```

第一个命令将在文件`src/app/tenant/tenant.module.ts`中创建模块`TenantModule`，第二个命令将在文件`src/app/tenant/tenant.service.ts`中创建服务`TenantService`。

现在，我们不需要做任何事情来实现租户模块，下面我们提供服务的最小可行实现。

在文件`src/app/tenant/tenant.service.ts`

TenantService 的基本实现。

在上面的定义中，我们为三件事提供了方法:

1.  根据主机名获取当前租户。
2.  向一组 HttpHeaders 添加特殊的租户头。
3.  为不同的租户定义一组枚举。

这个类现在可以被注入到任何你需要的地方。在下一节中，我们将这样做来注入我们的自定义头。

# 用租户信息装饰标题

既然我们已经勾勒出了多租户应用程序的基础，现在您可以在任何需要的地方注入您的租户服务。TenantService 的目标不是基于租户执行不同的操作，而是注入不同的功能。我们将在下一节介绍如何在我们的应用程序中做到这一点，但在此之前，让我们先介绍另一个小细节:在后端处理多租户。

为了在后端处理多租户，我们将用一个特殊的头来修饰我们发送到后端的任何 HTTP 请求，该头指示请求的当前租户。为此，我们将使用 HTTP 拦截器。

为了在您的项目中做到这一点，您将首先创建拦截器，然后将它连接到您的模块中。

首先，在 src/app/tenant 目录下创建文件`tenant.interceptor.ts`。您的文件应该如下所示:

我们的房客拦截者。

在上面的文件中，我们简单地截取了 HTTP 请求，并在其中添加了一个头，表明当前租户是谁。取决于租户，后端会做一些不同的事情。

接下来，在您的租户中连接拦截器。

我们更新的租户模块。

完成这两项更改后，对后端的任何请求都会自动添加正确的租用标题。

# 基于租户动态注入服务

好了，现在来点更有趣的。假设在我们的应用程序中，我们有一个负责实现登录的服务。对于客户端 1，服务应该以一种方式工作，但是对于客户端 2，行为与客户端 1 不同但相似。

从面向对象的角度来看，我们将使用的设计是简单地创建一个基类，比如说，`LoginService`，并从中派生两个类，比如说，`Client1LoginService`和`Client2LoginService`。如何才能实现这一点？

我将在本节中详细介绍的模式可以重复用于任何需要像这样注入服务的情况。基本成分是:

1.  **它需要在一个模块里**。为了实现这一点，我们将挂钩 Angular 的提供者特性。我们可以很容易地在模块级做到这一点。
2.  **需要定义一个工厂**。在该模块中，当您配置提供者时，您将配置一个获取服务的正确实例的工厂。

所以让我们开始吧。

首先，创建一个名为 LoginModule 的新模块，并创建三个服务:

1.  LoginService:基类
2.  Client1LoginService:专门用于 client1 的服务。
3.  Client2LoginService:专门为 client2 提供的服务。

我们可以通过下面的命令序列来实现:

```
# ng generate module login
# ng generate service login/login
# ng generate service login/client1login
# ng generate service login/client2login
```

为了简单起见，让我们假设这两种实现的区别在于，client1 需要一个 localStorage 键集，而 as client2 不需要。

首先，我们需要定义基本的 LoginService，它需要包含用于访问登录服务的正确实例的工厂。

下面的清单在 login.service.ts 中实现了该功能:

LoginService 的实现。

关于上述实现，有几点需要注意:

1.  与大多数服务不同，我们已经移除了`Injectable`注释。那是因为你不能直接注入这个服务。
2.  在文件的顶部，我们定义了一个工厂，稍后我们将使用它来注入服务的正确版本。请注意，我们将句柄注入到我们将动态返回的服务中。
3.  在我们抽象的 LoginService 中，我们定义了一个方法`login`，它将返回一个布尔值，表明登录是否成功。

接下来，我们以常规方式实现两个子类，从 LoginService 扩展:

Client1 登录服务的实现。

Client2 登录服务的实现。

好了，现在，为了把它绑起来，我们需要更新登录模块的模块定义。我们在下面的 login.module.ts 清单中这样做:

登录模块的定义，包括提供者定义。

在登录模块的清单中值得注意的是，我们已经为 LoginService 显式定义了一个提供者。要使用它，您只需在任何您想要为客户机引用登录服务的地方注入 LoginService。例如:

```
constructor(private loginService: LoginService) {}
```

确保将登录模块添加到您的模块的导入列表中！

**注意:永远不要试图显式地注入派生的登录类:让工厂来处理！**

# 基于租户动态更改路由

除了动态注入服务之外，有时您可能希望动态更改模块提供的路由。基于上一节中的 LoginModule，在这一节中，我们将演示如何基于租户动态切换应用程序中可用的路由。

这里的技巧是在 LoginModule 的构造函数中实现这个切换逻辑。在下面的列表中，我们演示了如何实现这一点:

我们更新的登录模块。

# 基于租户动态设计组件样式

到目前为止，在本文中，我们已经看到了一些非常简单的概念如何允许我们基于多租户的实现注入一些相当复杂的动态行为。在这一节中，我们将把注意力转向基于租户的组件样式。

然而，在我们开始编写代码之前，让我们先来讨论一下让它工作的想法。

我们方法背后的技巧是在根应用程序组件上使用 CSS 选择器`host-context`。加载到应用程序根组件中的任何组件都可以访问这个选择器。实际情况是这样的:

在`app.component.ts`

在应用程序中使用主题。

在上面的清单中，有几点需要注意:

1.  该组件实现了`OnInit`。这很重要，因为我们希望在加载组件时建立租户(以及样式)。
2.  我们使用`HostBinding` 注释来有选择地启用`theme-client1`或`theme-client2`类。
3.  在 ngOnInit 函数中，我们基于租户启用主题。

要为这个配置编写主题，只需提供一个如下所示的样式表:

我们的应用程序的简单样式表由两个皮肤组成。

这种配置的好处在于，我们在应用程序组件中展示的代码是初始化代码需要存在的唯一地方。模块中的任何组件只需要为各种主题提供 css 选择器。也就是说，在您创建的每个组件中，您只需为您的组件提供`host-context`样式。

# 结论

在本文中，我们介绍了构建多租户角度应用程序的基础。具体来说，我们涵盖了:

1.  如何创建基本的租户服务？
2.  如何用当前租户装饰传出标头？
3.  如何基于租户动态注入正确的类实例。
4.  如何基于租户动态调整应用程序的路由。
5.  如何根据租户设计应用程序的样式。

希望这篇文章对你有用。如果你有任何建议、问题或意见，请在下面的评论中提出来！

如果你想试试本文开发的应用程序，你可以在 GitHub 上找到源代码，这里:【https://github.com/jsinglet/multi-tenant-angular

要进行本地测试，请确保为 client1 和 client2 创建`hosts`文件条目，如下所示:

在`hosts`中:

```
127.0.0.1 client1.localhost
127.0.0.1 client2.localhost
```

当您在本地访问应用程序时，请确保通过这些主机名之一进行访问，以便租赁能够正常工作。