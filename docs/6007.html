<html>
<head>
<title>Integrating Vertx application with Spring framework</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">将Vertx应用程序与Spring框架集成</h1>
<blockquote>原文：<a href="https://itnext.io/integrating-vertx-application-with-spring-framework-fb8fca81a357?source=collection_archive---------4-----------------------#2021-07-23">https://itnext.io/integrating-vertx-application-with-spring-framework-fb8fca81a357?source=collection_archive---------4-----------------------#2021-07-23</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="e0ff" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如前所示，我们在<code class="fe kl km kn ko b">MainVerticle</code>类中手工组装了所有东西。我们将使用Spring IOC来管理依赖关系。</p><figure class="kq kr ks kt gt ku gh gi paragraph-image"><div role="button" tabindex="0" class="kv kw di kx bf ky"><div class="gh gi kp"><img src="../Images/d92eb3cc46094db4a7d3eb59a8ac2552.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*BK5r0YsZvSKWQGD9exxvzQ.jpeg"/></div></div><figcaption class="lb lc gj gh gi ld le bd b be z dk translated"><a class="ae lf" href="https://unsplash.com/@hansonluu?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Hanson Lu </a>在<a class="ae lf" href="https://unsplash.com/s/photos/china-landscape?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</figcaption></figure><p id="585f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">例如，它看起来像下面这样。</p><pre class="kq kr ks kt gt lg ko lh li aw lj bi"><span id="9416" class="lk ll iq ko b gy lm ln l lo lp">//Create a PgPool instance<br/>var pgPool = pgPool();</span><span id="074f" class="lk ll iq ko b gy lq ln l lo lp">//Creating PostRepository<br/>var postRepository = PostRepository.create(pgPool);</span><span id="fa24" class="lk ll iq ko b gy lq ln l lo lp">//Creating PostHandler<br/>var postHandlers = PostsHandler.create(postRepository);</span><span id="c9bb" class="lk ll iq ko b gy lq ln l lo lp">// Initializing the sample data<br/>var initializer = DataInitializer.create(pgPool);<br/>initializer.run();</span><span id="db02" class="lk ll iq ko b gy lq ln l lo lp">// Configure routes<br/>var router = routes(postHandlers);</span><span id="1a1b" class="lk ll iq ko b gy lq ln l lo lp">// Create the HTTP server<br/>vertx.createHttpServer()...</span></pre><p id="c064" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在本帖中，我们将介绍Spring框架来管理上述项目的依赖关系。</p><p id="2f42" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">将Spring上下文依赖添加到项目<em class="lr"> pom.xml </em>文件中。</p><pre class="kq kr ks kt gt lg ko lh li aw lj bi"><span id="523f" class="lk ll iq ko b gy lm ln l lo lp">&lt;dependency&gt;<br/>    &lt;groupId&gt;org.springframework&lt;/groupId&gt;<br/>    &lt;artifactId&gt;spring-context&lt;/artifactId&gt;<br/>&lt;/dependency&gt;</span></pre><p id="721a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><code class="fe kl km kn ko b">spring-context</code>提供了基本的IOC功能，用于组装依赖项和提供依赖项注入。</p><p id="dcbc" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">创建一个<code class="fe kl km kn ko b">@Configuration</code>类来启动Spring应用程序上下文。</p><pre class="kq kr ks kt gt lg ko lh li aw lj bi"><span id="2609" class="lk ll iq ko b gy lm ln l lo lp">@Configuration<br/>@ComponentScan<br/>public class DemoApplication {</span><span id="5536" class="lk ll iq ko b gy lq ln l lo lp">    public static void main(String[] args) {<br/>        var context = new AnnotationConfigApplicationContext(DemoApplication.class);<br/>        var vertx = context.getBean(Vertx.class);<br/>        var factory  = context.getBean(VerticleFactory.class);</span><span id="29d4" class="lk ll iq ko b gy lq ln l lo lp">        // deploy MainVerticle via verticle identifier name<br/>        vertx.deployVerticle(factory.prefix()+":"+MainVerticle.class.getName());<br/>    }</span><span id="a8f1" class="lk ll iq ko b gy lq ln l lo lp">    @Bean<br/>    public Vertx vertx(VerticleFactory verticleFactory) {<br/>        Vertx vertx = Vertx.vertx();<br/>        vertx.registerVerticleFactory(verticleFactory);<br/>        return vertx;<br/>    }</span><span id="1528" class="lk ll iq ko b gy lq ln l lo lp">    @Bean<br/>    public PgPool pgPool(Vertx vertx) {<br/>        PgConnectOptions connectOptions = new PgConnectOptions()<br/>            .setPort(5432)<br/>            .setHost("localhost")<br/>            .setDatabase("blogdb")<br/>            .setUser("user")<br/>            .setPassword("password");</span><span id="23fb" class="lk ll iq ko b gy lq ln l lo lp">        // Pool Options<br/>        PoolOptions poolOptions = new PoolOptions().setMaxSize(5);</span><span id="22f8" class="lk ll iq ko b gy lq ln l lo lp">        // Create the pool from the data object<br/>        PgPool pool = PgPool.pool(vertx, connectOptions, poolOptions);</span><span id="7a63" class="lk ll iq ko b gy lq ln l lo lp">        return pool;<br/>    }<br/>}</span></pre><p id="9076" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在main方法中，我们使用一个<code class="fe kl km kn ko b">AnnotationConfigApplicationContext</code>来扫描Spring组件并组装依赖项。然后从Spring应用上下文中取出<code class="fe kl km kn ko b">Vertx</code> bean和<code class="fe kl km kn ko b">VerticleFactory</code> bean，调用<code class="fe kl km kn ko b">vertx.deployVerticle</code>。</p><blockquote class="ls lt lu"><p id="4403" class="jn jo lr jp b jq jr js jt ju jv jw jx lv jz ka kb lw kd ke kf lx kh ki kj kk ij bi translated"><em class="iq"/><code class="fe kl km kn ko b"><em class="iq">VerticleFactory</em></code><em class="iq">是一个Vertx内置钩子，用于实例化一个Verticle实例。</em></p></blockquote><p id="dcf0" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在这个配置中，我们还声明了beans:</p><ul class=""><li id="e9c1" class="ly lz iq jp b jq jr ju jv jy ma kc mb kg mc kk md me mf mg bi translated"><code class="fe kl km kn ko b">Vertx</code>接受<code class="fe kl km kn ko b">VerticleFactory</code> bean并在<code class="fe kl km kn ko b">Vertx</code> bean中注册一个<code class="fe kl km kn ko b">VerticleFactory</code>。</li><li id="020c" class="ly lz iq jp b jq mh ju mi jy mj kc mk kg ml kk md me mf mg bi translated"><code class="fe kl km kn ko b">PgPool</code>用于访问Postgres数据库。您可以将数据库配置移动到一个<em class="lr">属性</em>文件中，并通过Spring <code class="fe kl km kn ko b">@PropertySource</code>注释加载它。</li></ul><p id="d3b6" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">让我们来看看<code class="fe kl km kn ko b">VerticleFactory</code>bean——一个Spring上下文感知的VerticleFactory实现。</p><pre class="kq kr ks kt gt lg ko lh li aw lj bi"><span id="9f93" class="lk ll iq ko b gy lm ln l lo lp">@Component<br/>public class SpringAwareVerticleFactory implements VerticleFactory, ApplicationContextAware {</span><span id="7d92" class="lk ll iq ko b gy lq ln l lo lp">    private ApplicationContext applicationContext;</span><span id="11ce" class="lk ll iq ko b gy lq ln l lo lp">    @Override<br/>    public String prefix() {<br/>        return "spring";<br/>    }</span><span id="5815" class="lk ll iq ko b gy lq ln l lo lp">    @Override<br/>    public void createVerticle(String verticleName, ClassLoader classLoader, Promise&lt;Callable&lt;Verticle&gt;&gt; promise) {<br/>        String clazz = VerticleFactory.removePrefix(verticleName);<br/>        promise.complete(() -&gt; (Verticle) applicationContext.getBean(Class.forName(clazz)));<br/>    }</span><span id="43ea" class="lk ll iq ko b gy lq ln l lo lp">    @Override<br/>    public void setApplicationContext(ApplicationContext applicationContext) throws BeansException {<br/>        this.applicationContext = applicationContext;<br/>    }<br/>}</span></pre><p id="7b3b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">当按名称实例化一个<code class="fe kl km kn ko b">Verticle</code>时，它将调用<code class="fe kl km kn ko b">createVerticle</code>方法，该方法在Spring应用程序上下文中查找beans。</p><p id="2e5b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">再来看看其他的类，直接声明为Spring <code class="fe kl km kn ko b">@Component</code>。关于完整的源代码，请查看来自我的Github的<a class="ae lf" href="https://github.com/hantsy/vertx-sandbox/tree/master/post-service-spring" rel="noopener ugc nofollow" target="_blank">vertx-sandbox/post-service-spring</a>。</p><pre class="kq kr ks kt gt lg ko lh li aw lj bi"><span id="8868" class="lk ll iq ko b gy lm ln l lo lp">@Component<br/>@RequiredArgsConstructor<br/>public class MainVerticle extends AbstractVerticle {<br/>    final PostsHandler postHandlers;<br/>    <br/>    //...<br/>}</span><span id="833e" class="lk ll iq ko b gy lq ln l lo lp">@Component<br/>@RequiredArgsConstructor<br/>class PostsHandler {<br/>    private final PostRepository posts;<br/>    <br/>    //...<br/>}</span><span id="c802" class="lk ll iq ko b gy lq ln l lo lp">@Component<br/>@RequiredArgsConstructor<br/>public class PostRepository {</span><span id="b85d" class="lk ll iq ko b gy lq ln l lo lp">    private final PgPool client;<br/>    <br/>    //...<br/>}</span><span id="4b4d" class="lk ll iq ko b gy lq ln l lo lp">@Component<br/>@RequiredArgsConstructor<br/>public class DataInitializer {</span><span id="dda9" class="lk ll iq ko b gy lq ln l lo lp">    private  final PgPool client;<br/>    <br/>    //...<br/>}</span></pre><p id="a3c8" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">当<code class="fe kl km kn ko b">DemoApplicaiton</code>运行时，可以扫描所有的<code class="fe kl km kn ko b">@Component</code>。</p><p id="daea" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如您所见，通过Spring IOC容器，我们删除了组装依赖项的所有手动步骤。</p><p id="9ec9" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在让我们尝试启动应用程序。</p><p id="6b25" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在前一种应用中，应用可以通过maven exec插件和jar文件运行。但是它使用一个内置的<code class="fe kl km kn ko b">Launcher</code>类来部署<code class="fe kl km kn ko b">Verticle</code>。我们已经配置了使用Spring来完成同样的工作，所以将maven exec插件和maven shade插件的配置改为如下。</p><pre class="kq kr ks kt gt lg ko lh li aw lj bi"><span id="5c38" class="lk ll iq ko b gy lm ln l lo lp">&lt;plugin&gt;<br/>    &lt;artifactId&gt;maven-shade-plugin&lt;/artifactId&gt;<br/>    &lt;version&gt;${maven-shade-plugin.version}&lt;/version&gt;<br/>    &lt;executions&gt;<br/>        &lt;execution&gt;<br/>            &lt;phase&gt;package&lt;/phase&gt;<br/>            &lt;goals&gt;<br/>                &lt;goal&gt;shade&lt;/goal&gt;<br/>            &lt;/goals&gt;<br/>            &lt;configuration&gt;<br/>                &lt;transformers&gt;<br/>                    &lt;transformer<br/>                                 implementation="org.apache.maven.plugins.shade.resource.ManifestResourceTransformer"&gt;<br/>                        &lt;manifestEntries&gt;<br/>                            &lt;Main-Class&gt;com.example.demo.DemoApplication&lt;/Main-Class&gt;<br/>                        &lt;/manifestEntries&gt;<br/>                    &lt;/transformer&gt;<br/>                    &lt;transformer<br/>                                 implementation="org.apache.maven.plugins.shade.resource.ServicesResourceTransformer"/&gt;<br/>                &lt;/transformers&gt;<br/>                &lt;artifactSet&gt;<br/>                &lt;/artifactSet&gt;<br/>                &lt;outputFile&gt;${project.build.directory}/${project.artifactId}-${project.version}-fat.jar<br/>                &lt;/outputFile&gt;<br/>            &lt;/configuration&gt;<br/>        &lt;/execution&gt;<br/>    &lt;/executions&gt;<br/>&lt;/plugin&gt;<br/>&lt;plugin&gt;<br/>    &lt;groupId&gt;org.codehaus.mojo&lt;/groupId&gt;<br/>    &lt;artifactId&gt;exec-maven-plugin&lt;/artifactId&gt;<br/>    &lt;version&gt;${exec-maven-plugin.version}&lt;/version&gt;<br/>    &lt;configuration&gt;<br/>        &lt;mainClass&gt;com.example.demo.DemoApplication&lt;/mainClass&gt;<br/>    &lt;/configuration&gt;<br/>&lt;/plugin&gt;</span></pre><p id="5a64" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在运行以下命令来启动应用程序。</p><pre class="kq kr ks kt gt lg ko lh li aw lj bi"><span id="d0d3" class="lk ll iq ko b gy lm ln l lo lp">mvn clean compile exec:java</span><span id="434c" class="lk ll iq ko b gy lq ln l lo lp">//or<br/>mvn clean package<br/>java -jar target\xxx-fat.jar</span></pre><p id="cf90" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在<code class="fe kl km kn ko b">TestMainVerticle</code>中，让我们做一些修改来使用Spring IOC容器，例如，您可以从Spring应用程序上下文中获得一个<code class="fe kl km kn ko b">Vertx</code>实例。</p><pre class="kq kr ks kt gt lg ko lh li aw lj bi"><span id="b35f" class="lk ll iq ko b gy lm ln l lo lp">@SpringJUnitConfig(classes = DemoApplication.class)<br/>@TestInstance(TestInstance.Lifecycle.PER_CLASS)<br/>@ExtendWith(VertxExtension.class)<br/>public class TestMainVerticle {<br/>    private final static Logger LOGGER = Logger.getLogger(TestMainVerticle.class.getName());</span><span id="8d8e" class="lk ll iq ko b gy lq ln l lo lp">    @Autowired<br/>    ApplicationContext context;</span><span id="4775" class="lk ll iq ko b gy lq ln l lo lp">    Vertx vertx;</span><span id="0302" class="lk ll iq ko b gy lq ln l lo lp">    @BeforeAll<br/>    public void setupAll(VertxTestContext testContext) {<br/>        vertx = context.getBean(Vertx.class);<br/>        var factory = context.getBean(VerticleFactory.class);<br/>        vertx.deployVerticle(factory.prefix() + ":" + MainVerticle.class.getName())<br/>            .onSuccess(id -&gt; {<br/>                LOGGER.info("deployed:" + id);<br/>                testContext.completeNow();<br/>            })<br/>            .onFailure(testContext::failNow);<br/>    }</span><span id="a551" class="lk ll iq ko b gy lq ln l lo lp">    @Test<br/>    public void testVertx(VertxTestContext testContext) {<br/>        assertThat(vertx).isNotNull();<br/>        testContext.completeNow();<br/>    }<br/></span><span id="a2b4" class="lk ll iq ko b gy lq ln l lo lp">    @Test<br/>    void testGetAll(VertxTestContext testContext) {<br/>        LOGGER.log(Level.INFO, "running test: {0}", "testGetAll");<br/>        var options = new HttpClientOptions()<br/>            .setDefaultPort(8888);<br/>        var client = vertx.createHttpClient(options);</span><span id="039f" class="lk ll iq ko b gy lq ln l lo lp">        client.request(HttpMethod.GET, "/posts")<br/>            .flatMap(req -&gt; req.send().flatMap(HttpClientResponse::body))<br/>            .onSuccess(<br/>                buffer -&gt; testContext.verify(<br/>                    () -&gt; {<br/>                        LOGGER.log(Level.INFO, "response buffer: {0}", new Object[]{buffer.toString()});<br/>                        assertThat(buffer.toJsonArray().size()).isGreaterThan(0);<br/>                        testContext.completeNow();<br/>                    }<br/>                )<br/>            )<br/>            .onFailure(e -&gt; {<br/>                LOGGER.log(Level.ALL, "error: {0}", e.getMessage());<br/>                testContext.failNow(e);<br/>            });<br/>    }<br/>}</span></pre><p id="80ee" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">从我的github 中获取<a class="ae lf" href="https://github.com/hantsy/vertx-sandbox/tree/master//post-service-spring" rel="noopener ugc nofollow" target="_blank">示例代码。</a></p></div></div>    
</body>
</html>