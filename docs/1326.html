<html>
<head>
<title>Mutation Observers to The Rescue</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">突变观察者前来救援</h1>
<blockquote>原文：<a href="https://itnext.io/mutation-observers-to-the-rescue-c73e786158c0?source=collection_archive---------1-----------------------#2018-09-12">https://itnext.io/mutation-observers-to-the-rescue-c73e786158c0?source=collection_archive---------1-----------------------#2018-09-12</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="8f19" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">不，不是x战警超级粉丝，是Javascript的<code class="fe kl km kn ko b">MutationObserver</code>接口！</p><figure class="kq kr ks kt gt ku gh gi paragraph-image"><div role="button" tabindex="0" class="kv kw di kx bf ky"><div class="gh gi kp"><img src="../Images/123916b4590ed86c00a2a032c819d8fd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*PDU74447oaLoWaMbLJBseQ.jpeg"/></div></div><figcaption class="lb lc gj gh gi ld le bd b be z dk translated">红色eft——水生东部蝾螈的陆地幼体阶段。诺拉·布朗</figcaption></figure><p id="3880" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">有时候，你对一个站点的代码没有多少控制权。也许你正在做一个用Squarespace，或者Wordpress + plugins + more plugins构建的客户端站点。在这种情况下，当您想要进行改进或改变行为时，Javascript通常是我们求助的工具。但是有时，甚至通常的Javascript挂钩都不可用。</p><p id="5cc9" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">例如，一种常见的模式是等待页面的DOM内容被加载，然后访问页面上的某个元素，并对其进行更改。但是，如果您想要访问的元素是在页面的<code class="fe kl km kn ko b">load</code>事件触发后动态加载的呢？</p><p id="4cd8" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">或者，您可能希望对页面上发生的事情做出反应，但是无论是什么代码的开发人员都没有发布一个您可以收听的友好事件列表。也许甚至没有一个适当的事件被解雇(震惊！).</p><h1 id="3d50" class="lf lg iq bd lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc bi translated">进入突变观察者，舞台左侧</h1><p id="b8b4" class="pw-post-body-paragraph jn jo iq jp b jq md js jt ju me jw jx jy mf ka kb kc mg ke kf kg mh ki kj kk ij bi translated">我们可以向得到大力支持的<code class="fe kl km kn ko b">MutationObserver</code>寻求一点帮助。它易于理解和实现，并且在IE10 之后的现代浏览器也支持<a class="ae mi" href="https://caniuse.com/#feat=mutationobserver" rel="noopener ugc nofollow" target="_blank">。真的很棒。</a></p><p id="afeb" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">一般模式是:</p><ol class=""><li id="4257" class="mj mk iq jp b jq jr ju jv jy ml kc mm kg mn kk mo mp mq mr bi translated">创建新的观察者</li><li id="ee48" class="mj mk iq jp b jq ms ju mt jy mu kc mv kg mw kk mo mp mq mr bi translated">告诉它当突变发生时该做什么</li><li id="4c0d" class="mj mk iq jp b jq ms ju mt jy mu kc mv kg mw kk mo mp mq mr bi translated">指导它观察你想要的元素，有一定的选项:</li></ol><pre class="kq kr ks kt gt mx ko my mz aw na bi"><span id="76ad" class="nb lg iq ko b gy nc nd l ne nf">// DOM element we want to observe<br/>var targetNode = ...;</span><span id="3c43" class="nb lg iq ko b gy ng nd l ne nf">// Options for the observer<br/>var config = { ...options... };</span><span id="3c5c" class="nb lg iq ko b gy ng nd l ne nf">// Callback will execute when mutations are observed<br/>var callback = function(mutationsList){ ...do stuff... };</span><span id="d172" class="nb lg iq ko b gy ng nd l ne nf">// Create a new observer, passing in the callback function<br/>var observer = new MutationObserver(callback);</span><span id="923d" class="nb lg iq ko b gy ng nd l ne nf">// Start observing the targetNode with the given configuration<br/>observer.observe(targetNode, config);</span></pre><p id="ea00" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">观察者配置有几个选项:</p><ul class=""><li id="d561" class="mj mk iq jp b jq jr ju jv jy ml kc mm kg mn kk nh mp mq mr bi translated">最重要的是，它描述了<strong class="jp ir">观察什么</strong> : <code class="fe kl km kn ko b">childList</code>、<code class="fe kl km kn ko b">attributes</code>、<code class="fe kl km kn ko b">characterData</code>，或者任意组合。</li><li id="d507" class="mj mk iq jp b jq ms ju mt jy mu kc mv kg mw kk nh mp mq mr bi translated">如果您正在监视属性，您可以另外指定一个<code class="fe kl km kn ko b">attributeFilter</code>，它将观察到的属性限制在您提供的数组中。</li><li id="32b5" class="mj mk iq jp b jq ms ju mt jy mu kc mv kg mw kk nh mp mq mr bi translated">如果您正在观察属性或角色数据，您可以通过将<code class="fe kl km kn ko b">attributeOldValue</code>或<code class="fe kl km kn ko b">characterDataOldValue</code>选项分别设置为<code class="fe kl km kn ko b">true</code>来记录预变异值。</li><li id="537d" class="mj mk iq jp b jq ms ju mt jy mu kc mv kg mw kk nh mp mq mr bi translated">默认情况下，变异观察器只会观察你指定的节点；要查看它包含的整个子树，请将<code class="fe kl km kn ko b">subtree</code>选项设置为<code class="fe kl km kn ko b">true</code>。</li></ul><p id="85be" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">因此，配置可能看起来像这样:</p><pre class="kq kr ks kt gt mx ko my mz aw na bi"><span id="9230" class="nb lg iq ko b gy nc nd l ne nf">var config = {<br/>    attributes: true,<br/>    attributeOldValue: true,<br/>    attributeFilter: ['class'],<br/>    subtree: true<br/>}</span></pre><p id="60a8" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">上面将配置我们的观察者来观察我们的目标节点和任何后代节点上的<code class="fe kl km kn ko b">class</code>属性的变化，并跟踪变异前的值。</p><h1 id="5e1f" class="lf lg iq bd lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc bi translated">操作动态加载的DOM内容</h1><figure class="kq kr ks kt gt ku gh gi paragraph-image"><div role="button" tabindex="0" class="kv kw di kx bf ky"><div class="gh gi ni"><img src="../Images/fc27be76bbfc9aeb67145cdf1aedb427.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*JgpZ8l5wRSANtbd4GwvNKg.png"/></div></div><figcaption class="lb lc gj gh gi ld le bd b be z dk translated">向Squarespace购物车页面添加“继续购物”链接</figcaption></figure><p id="ad97" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">让我们用一个突变观察者来处理我们的第一个用例。我们想在Squarespace购物车页面上添加一个突出的(但也很微妙的)“继续购物”链接。很简单，对吧？只要抓住那个漂亮的标题，添加一个链接，就万事大吉了(为了简洁，这里使用了jQuery):</p><pre class="kq kr ks kt gt mx ko my mz aw na bi"><span id="fb13" class="nb lg iq ko b gy nc nd l ne nf">$('.cart-title').append('&lt;br&gt;&lt;a href="/shop-home" style="font-size: .5em"&gt;Continue Shopping&lt;/a&gt;');</span></pre><p id="a93a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果这是在一个<code class="fe kl km kn ko b">$(document).ready</code>回调中，或者包含在结束的<code class="fe kl km kn ko b">&lt;/body&gt;</code>标签之前，它应该可以很好地工作。当然，除非整个购物车，包括标题，在页面加载后被添加到DOM <em class="nj">中。</em></p><p id="f892" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">没问题。我们可以使用一个<code class="fe kl km kn ko b">MutationObserver</code>来观察DOM或者DOM的一个特定部分的变化，并且当我们看到我们的<code class="fe kl km kn ko b">cart-title</code>被添加时做出反应:</p><figure class="kq kr ks kt gt ku"><div class="bz fp l di"><div class="nk nl l"/></div></figure><p id="58d6" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">正如您所看到的，突变观察者的回调可以接受一个参数(上面代码中的<code class="fe kl km kn ko b">mutationsList</code>，这是一个<code class="fe kl km kn ko b"><a class="ae mi" href="https://developer.mozilla.org/en-US/docs/Web/API/MutationRecord" rel="noopener ugc nofollow" target="_blank">MutationRecord </a></code> <a class="ae mi" href="https://developer.mozilla.org/en-US/docs/Web/API/MutationRecord" rel="noopener ugc nofollow" target="_blank">对象</a>的数组。</p><figure class="kq kr ks kt gt ku gh gi paragraph-image"><div class="gh gi nm"><img src="../Images/86f5297ee3368ae774bd1f9b386b3b00.png" data-original-src="https://miro.medium.com/v2/resize:fit:1312/format:webp/1*4RW58EqTdqlyDVwKv7bo-A.png"/></div><figcaption class="lb lc gj gh gi ld le bd b be z dk translated">Chrome DevTools中的一个变异记录</figcaption></figure><p id="857b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">每个突变记录都有许多有用的属性，包括:</p><ul class=""><li id="ae0a" class="mj mk iq jp b jq jr ju jv jy ml kc mm kg mn kk nh mp mq mr bi translated"><code class="fe kl km kn ko b">type</code> : <code class="fe kl km kn ko b">childList</code>、<code class="fe kl km kn ko b">attributes</code>或<code class="fe kl km kn ko b">characterData</code>，如果您正在观察多种突变类型，并希望根据类型采取不同的行动，这将非常有用。</li><li id="fac3" class="mj mk iq jp b jq ms ju mt jy mu kc mv kg mw kk nh mp mq mr bi translated"><code class="fe kl km kn ko b">target</code>:子节点或属性已经改变的元素，或一个<code class="fe kl km kn ko b">CharacterData</code>节点。请注意，这可能是也可能不是您正在观察的原始<code class="fe kl km kn ko b">targetNode</code>——如果<code class="fe kl km kn ko b">subtree: true</code>是<code class="fe kl km kn ko b">targetNode</code>的任何后代。</li><li id="6260" class="mj mk iq jp b jq ms ju mt jy mu kc mv kg mw kk nh mp mq mr bi translated"><code class="fe kl km kn ko b">addedNodes</code>、<code class="fe kl km kn ko b">removedNodes</code>、<code class="fe kl km kn ko b">previousSibling</code>、<code class="fe kl km kn ko b">nextSibling</code>:前两个是广告，previous和next是相对于增加或删除的节点。</li><li id="c9be" class="mj mk iq jp b jq ms ju mt jy mu kc mv kg mw kk nh mp mq mr bi translated"><code class="fe kl km kn ko b">attributeName</code>:如果突变类型为<code class="fe kl km kn ko b">attributes</code>，则更新的属性名称。如果您对多个属性的更改感兴趣，这很方便。</li><li id="7081" class="mj mk iq jp b jq ms ju mt jy mu kc mv kg mw kk nh mp mq mr bi translated">如果你已经配置了观察器来记录突变前的值，这就是它们的位置。对于<code class="fe kl km kn ko b">attributes</code>，是突变前的值，对于<code class="fe kl km kn ko b">characterData</code>，是突变前的字符数据。</li></ul><h1 id="0c60" class="lf lg iq bd lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc bi translated">响应属性更改</h1><p id="3c01" class="pw-post-body-paragraph jn jo iq jp b jq md js jt ju me jw jx jy mf ka kb kc mg ke kf kg mh ki kj kk ij bi translated">在我们的第二个场景中，我们希望对页面上发生的事情做出响应——我们无法控制的事情以及我们无法访问的事件。对于这个例子，让我们想象一个“添加到购物车”动作:用户点击“添加到购物车”按钮，站点的代码发出一个Ajax调用，商品被添加到用户的购物车。此时，您希望将用户带到购物车页面。</p><figure class="kq kr ks kt gt ku gh gi paragraph-image"><div role="button" tabindex="0" class="kv kw di kx bf ky"><div class="gh gi nn"><img src="../Images/55d75397f43f20ff19079440c56b453e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*gKndtQl8TcTctEDfA6lLyg.gif"/></div></div><figcaption class="lb lc gj gh gi ld le bd b be z dk translated">在添加到购物车的整个过程中，类别和其他属性会发生变化</figcaption></figure><p id="4f98" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在这个添加到购物车的过程中，按钮和周围元素的许多属性都发生了变化，包括类。我们可以设置一个变异观察者来观察它们并做出反应:</p><figure class="kq kr ks kt gt ku"><div class="bz fp l di"><div class="nk nl l"/></div></figure><p id="80c1" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在这里，由于我们没有观察子树，我们知道<code class="fe kl km kn ko b">mutation.target</code>将是我们最初的<code class="fe kl km kn ko b">targetNode</code>。所以我们可以简单地等待<code class="fe kl km kn ko b">cart-added</code>类出现在类列表中，表明添加到购物车的过程已经完成，然后将用户带到购物车页面。</p><h1 id="7fb5" class="lf lg iq bd lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc bi translated">突变观察者的其他用例</h1><p id="8ac4" class="pw-post-body-paragraph jn jo iq jp b jq md js jt ju me jw jx jy mf ka kb kc mg ke kf kg mh ki kj kk ij bi translated">在上面的两个场景中，当我们不得不求助于观察DOM的变化时，突变观察者API救了我们，因为我们无法控制进行这些变化的代码。但是可能有其他场景使用<code class="fe kl km kn ko b">MutationObserver</code>模式。假设您想要对添加到页面的新元素做出反应，有几种方式可以实现(单击按钮、点击return、ajax调用)。不需要以所有这些方式触发，或者使用发布/订阅模式，也许您只需观察DOM的最终结果——添加新元素。</p><p id="9996" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">你用过<code class="fe kl km kn ko b">MutationObserver</code>吗？下面留言评论！感谢阅读。</p><h2 id="81d1" class="nb lg iq bd lh no np dn ll nq nr dp lp jy ns nt lt kc nu nv lx kg nw nx mb ny bi translated">更多关于突变观察者的信息</h2><ul class=""><li id="b02b" class="mj mk iq jp b jq md ju me jy nz kc oa kg ob kk nh mp mq mr bi translated"><code class="fe kl km kn ko b"><a class="ae mi" href="https://developer.mozilla.org/en-US/docs/Web/API/MutationObserver" rel="noopener ugc nofollow" target="_blank">MutationObserver</a></code><a class="ae mi" href="https://developer.mozilla.org/en-US/docs/Web/API/MutationObserver" rel="noopener ugc nofollow" target="_blank">Mozilla上的API文档</a></li><li id="545e" class="mj mk iq jp b jq ms ju mt jy mu kc mv kg mw kk nh mp mq mr bi translated"><a class="ae mi" href="https://hacks.mozilla.org/2012/05/dom-mutationobserver-reacting-to-dom-changes-without-killing-browser-performance/" rel="noopener ugc nofollow" target="_blank">Mozilla博客上的文章</a></li><li id="ec10" class="mj mk iq jp b jq ms ju mt jy mu kc mv kg mw kk nh mp mq mr bi translated"><a class="ae mi" href="https://addyosmani.com/blog/mutation-observers/" rel="noopener ugc nofollow" target="_blank">用突变观察器实现撤销/重做</a></li></ul></div></div>    
</body>
</html>