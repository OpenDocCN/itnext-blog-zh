<html>
<head>
<title>Deploy 2nd gen GCP Cloud Functions with Nx Workspace</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">借助Nx Workspace部署第二代GCP云功能</h1>
<blockquote>原文：<a href="https://itnext.io/deploy-2nd-gen-gcp-cloud-functions-with-nx-workspace-5d75fcf21566?source=collection_archive---------2-----------------------#2022-03-20">https://itnext.io/deploy-2nd-gen-gcp-cloud-functions-with-nx-workspace-5d75fcf21566?source=collection_archive---------2-----------------------#2022-03-20</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><figure class="gl gn jr js jt ju gh gi paragraph-image"><div class="gh gi jq"><img src="../Images/32c557804c65d117b53197bddfb6a84c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1242/format:webp/1*QDez9PHz2FVUVV9LCKyaRg.png"/></div><figcaption class="jx jy gj gh gi jz ka bd b be z dk translated">Nx WorkSpace + GCP云功能(第二代)</figcaption></figure><blockquote class="kb kc kd"><p id="9346" class="ke kf kg kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">注意:谷歌云服务条款的<a class="ae ld" href="https://cloud.google.com/terms/service-terms#1" rel="noopener ugc nofollow" target="_blank">预发布条款</a>涵盖了第二代产品。请避免在产品中使用它，直到它完全发布。</p></blockquote><p id="3adf" class="pw-post-body-paragraph ke kf it kh b ki kj kk kl km kn ko kp le kr ks kt lf kv kw kx lg kz la lb lc im bi translated"><a class="ae ld" rel="noopener ugc nofollow" target="_blank" href="/deploy-2nd-gen-gcp-cloud-functions-with-nx-workspace-5d75fcf21566"> <strong class="kh iu">快速游览:部署第二代GCP云函数与Nx Workspace</strong></a><strong class="kh iu"><br/></strong><a class="ae ld" href="https://dalenguyen.medium.com/2nd-gen-cloud-functions-local-testing-development-7c518f7bd0b1" rel="noopener">云函数本地测试&amp;开发</a> <br/> <a class="ae ld" href="https://dalenguyen.medium.com/create-rest-apis-with-express-2nd-gen-gcp-cloud-functions-d244dd9a4717" rel="noopener">创建REST APIs与Express &amp;第二代GCP云函数</a> <br/> <a class="ae ld" href="https://dalenguyen.medium.com/a-perfect-match-nestjs-cloud-functions-2nd-gen-nx-workspace-f13fb044e9a4" rel="noopener">完美匹配:NestJs &amp;云函数(第二代)&amp;Nx Workspace</a><br/><a class="ae ld" href="https://dalenguyen.medium.com/gcp-cloud-functions-gen-2nd-pub-sub-development-testing-2c498fa4464e" rel="noopener">GCP云函数(第二代)发布/订阅开发&amp;测试</a></p><p id="8b7e" class="pw-post-body-paragraph ke kf it kh b ki kj kk kl km kn ko kp le kr ks kt lf kv kw kx lg kz la lb lc im bi translated"><a class="ae ld" href="https://cloud.google.com/functions/docs/2nd-gen/overview" rel="noopener ugc nofollow" target="_blank">云功能(第二代)</a>是谷歌云的下一代功能即服务产品。这个新版本的云函数带有一个高级功能集，为您提供更强大的基础设施、对性能和可扩展性的高级控制、对函数运行时的更多控制，以及来自90多个事件源的触发。此外，该产品由谷歌云的尖端无服务器和事件基础设施、<a class="ae ld" href="https://cloud.google.com/run" rel="noopener ugc nofollow" target="_blank">云运行</a>和<a class="ae ld" href="https://cloud.google.com/eventarc/docs" rel="noopener ugc nofollow" target="_blank">事件弧</a>提供支持。</p><p id="e918" class="pw-post-body-paragraph ke kf it kh b ki kj kk kl km kn ko kp le kr ks kt lf kv kw kx lg kz la lb lc im bi translated">在Nx WorkSpace的帮助下，我们有望找到一个不错的结构，你可以在monorepo中利用GCP云函数。这是正在进行中的工作，如果你有任何建议，请让我知道。</p><h2 id="f649" class="lh li it bd lj lk ll dn lm ln lo dp lp le lq lr ls lf lt lu lv lg lw lx ly lz bi translated">创建一个示例应用程序</h2><pre class="ma mb mc md gt me mf mg mh aw mi bi"><span id="634c" class="lh li it mf b gy mj mk l ml mm">npx nx g <a class="ae ld" href="http://twitter.com/nrwl/node" rel="noopener ugc nofollow" target="_blank">@nrwl/node</a>:application scraper</span></pre><h2 id="c079" class="lh li it bd lj lk ll dn lm ln lo dp lp le lq lr ls lf lt lu lv lg lw lx ly lz bi translated">制作简单的HTTP请求函数</h2><pre class="ma mb mc md gt me mf mg mh aw mi bi"><span id="2bf5" class="lh li it mf b gy mj mk l ml mm">// main.ts</span><span id="4f55" class="lh li it mf b gy mn mk l ml mm">import { http } from '<a class="ae ld" href="http://twitter.com/google" rel="noopener ugc nofollow" target="_blank">@google</a>-cloud/functions-framework'<br/>import 'tslib' // needed until importHelpers is set to false</span><span id="61f9" class="lh li it mf b gy mn mk l ml mm">http('helloGET', (req, res) =&gt; {<br/>  res.send(`Hello ${req.query.name || req.body.name || 'World'}!`)<br/>})</span></pre><p id="fd69" class="pw-post-body-paragraph ke kf it kh b ki kj kk kl km kn ko kp le kr ks kt lf kv kw kx lg kz la lb lc im bi translated">更新Project.json以支持GCP函数。它将在部署云函数之前生成package.json文件&amp; index.js。</p><pre class="ma mb mc md gt me mf mg mh aw mi bi"><span id="2008" class="lh li it mf b gy mj mk l ml mm">// project.json</span><span id="3155" class="lh li it mf b gy mn mk l ml mm">// generate package.json &amp; index.js<br/>"targets": {<br/>    "build": {<br/>      "executor": "<a class="ae ld" href="http://twitter.com/nrwl/node" rel="noopener ugc nofollow" target="_blank">@nrwl/node</a>:build",<br/>      "outputs": ["{options.outputPath}"],<br/>      "options": {<br/>        "outputPath": "dist/apps/scraper",<br/>        "main": "apps/scraper/src/main.ts",<br/>        "tsConfig": "apps/scraper/tsconfig.app.json",<br/>        "assets": ["apps/scraper/src/assets"],<br/>        "externalDependencies": "all",<br/><strong class="mf iu">        "outputFileName": "index.js",<br/>        "generatePackageJson": true</strong><br/>      },</span><span id="6add" class="lh li it mf b gy mn mk l ml mm">// deploy script --&gt; yarn deploy:scraper<br/>"deploy": {<br/>      "executor": "<a class="ae ld" href="http://twitter.com/nrwl/workspace" rel="noopener ugc nofollow" target="_blank">@nrwl/workspace</a>:run-commands",<br/>      "options": {<br/>        "commands": [<br/><strong class="mf iu">          "gcloud beta functions deploy scraper --region us-central1 --gen2 --runtime nodejs16 --trigger-http --entry-point helloGET --source ./dist/apps/scraper --allow-unauthenticated --project {args.gcpProject}"</strong><br/>        ],<br/>        "color": true,<br/>        "parallel": false<br/>      }<br/>    }</span></pre><p id="1bbc" class="pw-post-body-paragraph ke kf it kh b ki kj kk kl km kn ko kp le kr ks kt lf kv kw kx lg kz la lb lc im bi translated">此后，无论何时您想要部署云功能，您都可以运行这些脚本</p><pre class="ma mb mc md gt me mf mg mh aw mi bi"><span id="28cf" class="lh li it mf b gy mj mk l ml mm">// build functions<br/>yarn build scraper --prod</span><span id="3ffb" class="lh li it mf b gy mn mk l ml mm">// deploy functions<br/>yarn nx run scraper:deploy --gcpProject YOUR_PROJECT_ID</span></pre><h2 id="d78a" class="lh li it bd lj lk ll dn lm ln lo dp lp le lq lr ls lf lt lu lv lg lw lx ly lz bi translated">准备GCP服务</h2><p id="f54a" class="pw-post-body-paragraph ke kf it kh b ki mo kk kl km mp ko kp le mq ks kt lf mr kw kx lg ms la lb lc im bi translated">确保为您的云项目启用了计费。了解如何<a class="ae ld" href="https://cloud.google.com/billing/docs/how-to/verify-billing-enabled" rel="noopener ugc nofollow" target="_blank">检查项目</a>是否启用了计费。</p><p id="3174" class="pw-post-body-paragraph ke kf it kh b ki kj kk kl km kn ko kp le kr ks kt lf kv kw kx lg kz la lb lc im bi translated"><a class="ae ld" href="https://console.cloud.google.com/apis/enableflow?apiid=cloudbuild.googleapis.com,artifactregistry.googleapis.com,eventarc.googleapis.com,run.googleapis.com,logging.googleapis.com,pubsub.googleapis.com,cloudfunctions.googleapis.com&amp;redirect=https:%2F%2Fcloud.google.com%2Ffunctions%2Fquickstart&amp;_ga=2.102189761.1901670236.1647740179-970591310.1643643162&amp;_gac=1.216638948.1645902088.CjwKCAiAvOeQBhBkEiwAxutUVEXz2xo4XUIddi0i4DE6vHJ-XFr8T6zMXCjxfNiwYUzPlIKbafGOihoCWzgQAvD_BwE" rel="noopener ugc nofollow" target="_blank">启用云功能、云构建、工件注册、Eventarc、云运行、日志和发布/订阅API。</a></p><p id="05dc" class="pw-post-body-paragraph ke kf it kh b ki kj kk kl km kn ko kp le kr ks kt lf kv kw kx lg kz la lb lc im bi translated">安装和更新GCP组件和测试版命令</p><pre class="ma mb mc md gt me mf mg mh aw mi bi"><span id="63ac" class="lh li it mf b gy mj mk l ml mm">gcloud components update<br/>gcloud components install beta</span><span id="c5cb" class="lh li it mf b gy mn mk l ml mm">gcloud config set project YOUR_PROJECT_NAME</span></pre><p id="32e6" class="pw-post-body-paragraph ke kf it kh b ki kj kk kl km kn ko kp le kr ks kt lf kv kw kx lg kz la lb lc im bi translated">确保您的云构建具有这些角色</p><figure class="ma mb mc md gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="mu mv di mw bf mx"><div class="gh gi mt"><img src="../Images/a5f763c04d70c6ccdd5f9d0fd771840b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*PuEATVFAhOuhztl3HZ3geg.png"/></div></div></figure><h2 id="86ad" class="lh li it bd lj lk ll dn lm ln lo dp lp le lq lr ls lf lt lu lv lg lw lx ly lz bi translated">部署第二代功能</h2><p id="40ea" class="pw-post-body-paragraph ke kf it kh b ki mo kk kl km mp ko kp le mq ks kt lf mr kw kx lg ms la lb lc im bi translated">您需要做的就是运行部署命令</p><pre class="ma mb mc md gt me mf mg mh aw mi bi"><span id="a6af" class="lh li it mf b gy mj mk l ml mm">dalenguyen$ yarn nx run scraper:deploy --gcpProject YOUR_PROJECT_ID<br/>yarn run v1.22.17<br/>$ nx run scraper:deploy</span><span id="66fb" class="lh li it mf b gy mn mk l ml mm">Preparing function...<br/>.done.<br/>Deploying function...<br/>[Build].............................................................<br/>  [WARNING] *** Improve build performance by generating and committing package-lock.json.<br/><br/>  timeoutSeconds: 60<br/>  uri: <a class="ae ld" href="https://scraper-eyoojzj54q-uc.a.run.app" rel="noopener ugc nofollow" target="_blank">https://scraper-eyoojzj54q-uc.a.run.app</a><br/>state: ACTIVE<br/>updateTime: '2022-03-20T03:29:11.978231913Z'</span><span id="dc09" class="lh li it mf b gy mn mk l ml mm">——————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————</span><span id="2c6b" class="lh li it mf b gy mn mk l ml mm">&gt;  NX   Successfully ran target deploy for project scraper</span><span id="37d7" class="lh li it mf b gy mn mk l ml mm">✨  Done in 45.99s.</span></pre><figure class="ma mb mc md gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="mu mv di mw bf mx"><div class="gh gi my"><img src="../Images/1c4567d8a3fd2ae59315b6bfd4414459.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*1ltUBXx18CEghXvhFD9GlQ.png"/></div></div></figure><figure class="ma mb mc md gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="mu mv di mw bf mx"><div class="gh gi mz"><img src="../Images/09e8c578e0c9f8a84299637caa27f489.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*e5k7CVAH18KSjgJgb5CjOQ.png"/></div></div></figure></div></div>    
</body>
</html>