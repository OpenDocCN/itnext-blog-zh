<html>
<head>
<title>I’m making an offline first WordPress PWA, part 3</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">我正在做一个离线的第一个WordPress PWA，第三部分</h1>
<blockquote>原文：<a href="https://itnext.io/im-making-an-offline-first-wordpress-pwa-part-3-1ddf61891121?source=collection_archive---------2-----------------------#2018-07-26">https://itnext.io/im-making-an-offline-first-wordpress-pwa-part-3-1ddf61891121?source=collection_archive---------2-----------------------#2018-07-26</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="fd0c" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">带工具箱的服务人员</h2></div><p id="1a23" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这是这一系列博客帖子开始变得真正有趣的时候了！我们已经通过<a class="ae lb" href="https://medium.com/@stefanledin/im-making-an-offline-first-wordpress-pwa-part-1-6ae90ea672a4" rel="noopener">让HTTPS在本地领域</a>上工作而温和地开始了。我们还创建了一个manifest.json文件。<br/>但现在是时候开始真正的工作了，并深入研究服务人员，这是渐进式网络应用程序中最重要的组成部分。</p></div><div class="ab cl lc ld hu le" role="separator"><span class="lf bw bk lg lh li"/><span class="lf bw bk lg lh li"/><span class="lf bw bk lg lh"/></div><div class="ij ik il im in"><h2 id="1757" class="lj lk iq bd ll lm ln dn lo lp lq dp lr ko ls lt lu ks lv lw lx kw ly lz ma mb bi translated">但是什么是服务人员呢？</h2><p id="445f" class="pw-post-body-paragraph kf kg iq kh b ki mc jr kk kl md ju kn ko me kq kr ks mf ku kv kw mg ky kz la ij bi translated">这听起来有点可怕，完全不可理解，就像这个行业的大多数事情一样。但就像那些事情一样，它们最终往往并不复杂。</p><blockquote class="mh"><p id="e4d6" class="mi mj iq bd mk ml mm mn mo mp mq la dk translated">服务人员是一个在后台运行的JavaScript文件，即使访问者已经离开网站，它也可以继续做事情。</p></blockquote><p id="fe46" class="pw-post-body-paragraph kf kg iq kh b ki mr jr kk kl ms ju kn ko mt kq kr ks mu ku kv kw mv ky kz la ij bi translated">这听起来可能有点可怕，尤其是因为我们已经被脸书和谷歌全天候跟踪。但是一个更加用户友好的使用领域是保持网络应用程序更新的可能性。假设你的PWA是一个待办事项列表。服务人员可以让它与数据库保持同步，而无需用户在浏览器中打开应用程序。</p><p id="2ea6" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">服务人员可以做的另一个例子是，您的PWA可以向用户发送推送通知。</p><blockquote class="mh"><p id="0a73" class="mi mj iq bd mk ml mm mn mo mp mq la dk translated">但也许最重要的是，所有进出网络的请求和响应都要经过服务人员。</p></blockquote><p id="0058" class="pw-post-body-paragraph kf kg iq kh b ki mr jr kk kl ms ju kn ko mt kq kr ks mu ku kv kw mv ky kz la ij bi translated">这意味着您可以用JavaScript操纵这些请求和响应。例如，如果您想将所有对扩展名为<code class="fe mw mx my mz b">.jpg</code>的文件的请求替换为类似于<code class="fe mw mx my mz b">funny.gif</code>的内容，服务人员允许您这样做。在这种情况下，请求会在服务人员处停止，甚至不会发送到网络。</p><p id="042c" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">一个更实际的例子是，服务人员可以管理一个专用于您的PWA的缓存，稍后我将回到这个例子。例如，<code class="fe mw mx my mz b">style.css</code>可以存储在那个缓存中。<br/>由于所有网络请求都要经过服务工作者，它可以检查<code class="fe mw mx my mz b">style.css</code>是否已经存储在那里。在这种情况下，服务人员可以直接从那里返回样式表，而不是从服务器下载。</p><p id="55cd" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">换句话说，通过减少网络请求的数量，服务人员可以对加载时间产生相当大的影响。</p></div><div class="ab cl lc ld hu le" role="separator"><span class="lf bw bk lg lh li"/><span class="lf bw bk lg lh li"/><span class="lf bw bk lg lh"/></div><div class="ij ik il im in"><p id="8a68" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">现在说够了。在这个小项目中，我的下一步是创建一个服务工作者，它将所有资产存储在一个缓存中。</p><p id="c85e" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><a class="ae lb" href="https://medium.com/@stefanledin/a-basic-service-worker-with-workbox-473fff5bbd9b" rel="noopener">我之前写过</a>关于我试用WorkBox的时候。这是谷歌的一个库，它能以一种简单的方式为你管理缓存。</p><p id="393d" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">但我的第一个想法是在培训目的上从头开始编写自己的服务人员。serviceworke.rs是一个很好的资源。</p><p id="eadc" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在这种情况下，在缓存中保存<code class="fe mw mx my mz b">style.css</code>的函数应该是这样的:</p><figure class="na nb nc nd gt ne"><div class="bz fp l di"><div class="nf ng l"/></div></figure><p id="588a" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">如您所见，您需要知道到<code class="fe mw mx my mz b">style.css</code>的确切路径，这可能还不是一个问题，但它将成为一个问题。由于我将使用优秀的WordPress插件<a class="ae lb" href="https://wordpress.org/plugins/autoptimize/" rel="noopener ugc nofollow" target="_blank">自动优化</a>来连接和缩小我的JavaScript和CSS文件，我不知道优化后的文件将被称为什么。</p><p id="3824" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">例如，优化文件可以这样命名:</p><pre class="na nb nc nd gt nh mz ni nj aw nk bi"><span id="25c9" class="lj lk iq mz b gy nl nm l nn no">./wp-content/cache/autoptimize/css/autoptimize_537ce15b533c7419959db13d757c910e.css</span></pre><p id="691d" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">用正则表达式代替绝对路径可以解决这个问题。幸运的是，这可以通过WorkBox来完成。</p><pre class="na nb nc nd gt nh mz ni nj aw nk bi"><span id="2f54" class="lj lk iq mz b gy nl nm l nn no">workbox.routing.registerRoute(<br/>  new RegExp('.*\.js'),<br/>  workbox.strategies.networkFirst()<br/>);</span></pre><p id="e510" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这就是我选择在这个项目中使用工具箱的原因。决定下来后，让我们开始工作吧！</p><h2 id="2ee7" class="lj lk iq bd ll lm ln dn lo lp lq dp lr ko ls lt lu ks lv lw lx kw ly lz ma mb bi translated">创建并安装服务人员</h2><p id="371c" class="pw-post-body-paragraph kf kg iq kh b ki mc jr kk kl md ju kn ko me kq kr ks mf ku kv kw mg ky kz la ij bi translated">第一步是注册服务工作者脚本。这是在“常规”JavaScript文件中完成的。<code class="fe mw mx my mz b">app.js</code>既然如此。</p><figure class="na nb nc nd gt ne"><div class="bz fp l di"><div class="nf ng l"/></div></figure><p id="65d2" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><code class="fe mw mx my mz b">serviceworker.js</code>与所有常规的WordPress文件和<code class="fe mw mx my mz b">manifest.json</code>文件一起被创建在项目根目录下。</p><h2 id="a0cc" class="lj lk iq bd ll lm ln dn lo lp lq dp lr ko ls lt lu ks lv lw lx kw ly lz ma mb bi translated">用WorkBox缓存CSS和JavaScript文件</h2><p id="5873" class="pw-post-body-paragraph kf kg iq kh b ki mc jr kk kl md ju kn ko me kq kr ks mf ku kv kw mg ky kz la ij bi translated">WorkBox让生活变得非常容易，至少在这种情况下。这些简单的代码行是实现我的目标所需要的一切:</p><figure class="na nb nc nd gt ne"><div class="bz fp l di"><div class="nf ng l"/></div></figure><p id="3673" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">首先导入工作箱脚本本身，然后注册一个“路径”。<code class="fe mw mx my mz b">registerRoute</code>函数的第一个参数是一个正则表达式，它将捕获所有的<code class="fe mw mx my mz b">.js</code>和<code class="fe mw mx my mz b">.css</code>文件。我可能会对此进行调整，使其仅捕获来自<code class="fe mw mx my mz b">/cache/autoptimize/</code>目录的文件，但我将在以后看到这一点。</p><p id="a7ff" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">第二个参数是我们选择应用于这些文件的策略。那么这种情况下的策略是什么呢？这是您选择处理网络请求的方式。<br/>我选择了<code class="fe mw mx my mz b">cacheFirst()</code>策略，这意味着服务工作者应该直接从缓存中提供文件。这当然需要将文件存储在缓存中。如果没有，服务人员将照常从服务器下载。</p><p id="af99" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">也有像<code class="fe mw mx my mz b">networkOnly()</code>这样做完全相反的策略。缓存将被忽略，文件将总是通过网络从服务器下载。但是因为我想让网站尽可能的快和可靠，即使是在不稳定的连接上，我会选择<code class="fe mw mx my mz b">cacheFirst()</code>策略。</p><p id="5720" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">该策略将设置对象作为参数。目前唯一相关的设置是应该创建的缓存的名称。这个博客看起来像是我迪拜之旅的日记，因此得名<code class="fe mw mx my mz b">dubai-travel-diary</code></p><h2 id="f129" class="lj lk iq bd ll lm ln dn lo lp lq dp lr ko ls lt lu ks lv lw lx kw ly lz ma mb bi translated">有用吗？</h2><p id="95f3" class="pw-post-body-paragraph kf kg iq kh b ki mc jr kk kl md ju kn ko me kq kr ks mf ku kv kw mg ky kz la ij bi translated">重要的是要记住，当你第一次访问PWA时，它就像一个普通的网站。服务人员在第一次访问时安装，因此在第二次访问时生效。</p><p id="5e01" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">您可以打开开发者工具，点击<strong class="kh ir">应用</strong>选项卡，查看服务人员是否处于活动状态。在左侧的面板中，有一个名为<strong class="kh ir">维修工人</strong>的菜单项。</p><figure class="na nb nc nd gt ne gh gi paragraph-image"><div role="button" tabindex="0" class="nq nr di ns bf nt"><div class="gh gi np"><img src="../Images/61deb99509a55224797fe69e42d19825.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*CUreM9S3JBSH8oHQUdrXnA.png"/></div></div></figure><p id="4a1b" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">但是如果你点击<strong class="kh ir">缓存</strong>，你会看到它是空的！<code class="fe mw mx my mz b">dubai-travel-diary</code>缓存不是应该在吗？</p><figure class="na nb nc nd gt ne gh gi paragraph-image"><div role="button" tabindex="0" class="nq nr di ns bf nt"><div class="gh gi np"><img src="../Images/40f6577abfac522d1acacbfc961304ad.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*kjZUV-0Mvp2XpUu-2TT1Qg.png"/></div></div></figure><p id="d450" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">不，不是第一次来的时候。第二次访问网站后，文件才会出现在那里。(不，你不能只是重新加载网站，你必须在一个新的标签页/窗口中再次打开它。)</p><figure class="na nb nc nd gt ne gh gi paragraph-image"><div role="button" tabindex="0" class="nq nr di ns bf nt"><div class="gh gi np"><img src="../Images/d3892b1ba1aefa0d9300574044a90021.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*D6HtQUGmUG5DQmBnetBksw.png"/></div></div></figure><p id="671f" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">如果您切换到<strong class="kh ir">网络</strong>选项卡，您可以看到文件不再通过网络下载。由于服务工作器的存在，它们被从本地缓存中提供。</p><figure class="na nb nc nd gt ne gh gi paragraph-image"><div role="button" tabindex="0" class="nq nr di ns bf nt"><div class="gh gi nw"><img src="../Images/594c3fe3cc38ec8d7279dad5350d3984.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*hwzd_wsMVbcBBsTMJ9MGrQ.png"/></div></div></figure><p id="ae14" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这是没有维修人员的情况:</p><figure class="na nb nc nd gt ne gh gi paragraph-image"><div role="button" tabindex="0" class="nq nr di ns bf nt"><div class="gh gi nw"><img src="../Images/05512fa00cc3b924b770e9540c6b1dee.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*3ArSq1z2y9dslMkM9yyYwQ.png"/></div></div></figure><h2 id="21a1" class="lj lk iq bd ll lm ln dn lo lp lq dp lr ko ls lt lu ks lv lw lx kw ly lz ma mb bi translated">灯塔报告</h2><p id="87cc" class="pw-post-body-paragraph kf kg iq kh b ki mc jr kk kl md ju kn ko me kq kr ks mf ku kv kw mg ky kz la ij bi translated">有了这个，灯塔报告中的PWA评分从73分提高到了82分！</p><figure class="na nb nc nd gt ne gh gi paragraph-image"><div role="button" tabindex="0" class="nq nr di ns bf nt"><div class="gh gi nx"><img src="../Images/3fee0cf8ccb04257426208dc88d3bfe0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*DYHqVJecEjhjNM-QIjuKnA.png"/></div></div></figure><p id="5c6b" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这给我们留下了以下问题:</p><ul class=""><li id="3e7d" class="ny nz iq kh b ki kj kl km ko oa ks ob kw oc la od oe of og bi translated">脱机时不响应200</li><li id="6e03" class="ny nz iq kh b ki oh kl oi ko oj ks ok kw ol la od oe of og bi translated">不会提示用户安装web应用程序</li></ul><p id="1b45" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">事实上，这两个问题都可以一蹴而就。</p><h2 id="c47a" class="lj lk iq bd ll lm ln dn lo lp lq dp lr ko ls lt lu ks lv lw lx kw ly lz ma mb bi translated">缓存首页</h2><p id="1ad2" class="pw-post-body-paragraph kf kg iq kh b ki mc jr kk kl md ju kn ko me kq kr ks mf ku kv kw mg ky kz la ij bi translated">通过注册另一个将影响首页的路由，即<code class="fe mw mx my mz b">/</code>路径，它也将被存储在缓存中。</p><figure class="na nb nc nd gt ne"><div class="bz fp l di"><div class="nf ng l"/></div></figure><p id="6c2d" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">至少在最初，我会使用<code class="fe mw mx my mz b">cacheFirst()</code>策略，但是使用<code class="fe mw mx my mz b">networkFirst()</code>可能更合适，因为这是一个博客。我当然希望用户能在新的博客文章发表后立即看到它们。</p><p id="ad84" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">但是现在是实验的时候了！也许<code class="fe mw mx my mz b">backgroundSync</code>可以用在某些方面？也许我应该重新构建主题，使其遵循<a class="ae lb" href="https://developers.google.com/web/fundamentals/architecture/app-shell" rel="noopener ugc nofollow" target="_blank">应用程序外壳模型</a>，并且用JavaScript将博客文章加载到静态模板中？</p><h2 id="0f30" class="lj lk iq bd ll lm ln dn lo lp lq dp lr ko ls lt lu ks lv lw lx kw ly lz ma mb bi translated">100% PWA</h2><p id="48cc" class="pw-post-body-paragraph kf kg iq kh b ki mc jr kk kl md ju kn ko me kq kr ks mf ku kv kw mg ky kz la ij bi translated">可能性有很多，这将在本系列的下一部分中探讨！可喜的是，该博客已经在灯塔报告中获得100 PWA分！</p><figure class="na nb nc nd gt ne gh gi paragraph-image"><div role="button" tabindex="0" class="nq nr di ns bf nt"><div class="gh gi om"><img src="../Images/d7de9a8016435e89f36e269b9018dc8b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*x1cA6blhJo5TIaOgpDLAXg.png"/></div></div></figure></div><div class="ab cl lc ld hu le" role="separator"><span class="lf bw bk lg lh li"/><span class="lf bw bk lg lh li"/><span class="lf bw bk lg lh"/></div><div class="ij ik il im in"><p id="696f" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">以前的零件:</p><ul class=""><li id="d065" class="ny nz iq kh b ki kj kl km ko oa ks ob kw oc la od oe of og bi translated">第一部分:HTTPS </li><li id="17b3" class="ny nz iq kh b ki oh kl oi ko oj ks ok kw ol la od oe of og bi translated"><a class="ae lb" href="https://medium.com/@stefanledin/im-making-an-offline-first-wordpress-pwa-part-2-b313659bfc9c" rel="noopener">第二部分:Manifest.json </a></li></ul></div></div>    
</body>
</html>