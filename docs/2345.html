<html>
<head>
<title>Protect your docker environment using Performance Analyzer and CodeNotary</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用性能分析器和代码公证保护您的docker环境</h1>
<blockquote>原文：<a href="https://itnext.io/protect-your-docker-environment-using-performance-analyzer-and-codenotary-edef3f780b5?source=collection_archive---------6-----------------------#2019-05-08">https://itnext.io/protect-your-docker-environment-using-performance-analyzer-and-codenotary-edef3f780b5?source=collection_archive---------6-----------------------#2019-05-08</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="7830" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">无数的IT基础设施运行docker容器进行测试、生产或研究。</p><p id="0b9a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">大多数docker容器都基于从Docker Hub下载的图像。这个决定包含了很大一部分信任，即Docker Hub上的形象是好的。</p><p id="e8f6" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">大约一周前，随着dockerhub.com事件的发生，情况突然发生了变化。尽管与总用户群相比，只有少数帐户(按百分比)受到影响，但这让人对您自己的数据中心正在运行的内容产生了不好的感觉。</p><p id="46f8" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">由于我们想要保护我们自己的开发环境以及我们的一些客户的环境(例如零信任联盟)，我们找到了一个体面的解决方案来一劳永逸地解决这个问题。</p><p id="8c77" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这篇博文将涵盖以下内容，以保护您的docker环境:</p><ul class=""><li id="25cf" class="km kn iq jp b jq jr ju jv jy ko kc kp kg kq kk kr ks kt ku bi translated">以不变的方式标记你的docker图片</li><li id="d423" class="km kn iq jp b jq kv ju kw jy kx kc ky kg kz kk kr ks kt ku bi translated">检查您正在运行的docker容器是否基于您支持的容器映像</li><li id="0187" class="km kn iq jp b jq kv ju kw jy kx kc ky kg kz kk kr ks kt ku bi translated">使用性能分析器跟踪和监控容器</li></ul><h1 id="dc59" class="la lb iq bd lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx bi translated">背景</h1><p id="6808" class="pw-post-body-paragraph jn jo iq jp b jq ly js jt ju lz jw jx jy ma ka kb kc mb ke kf kg mc ki kj kk ij bi translated">我们的(<a class="ae kl" href="https://www.opvizor.com" rel="noopener ugc nofollow" target="_blank"> Opvizor </a>)客户<a class="ae kl" href="https://www.zerotrustconsortium.org" rel="noopener ugc nofollow" target="_blank">零信任财团</a>，他经营着一个软件行业的区块链财团，基于平价以太坊。您最不希望发生在区块链上的事情是，您运行的节点基于软件的操纵版本。想象一下，您会因为docker容器映像的更改而失去多数，并且所有块内容都会因为变得不可信而消失。</p><p id="43e2" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">奇偶校验团队非常清楚这一点，并在得知dockerhub.com的违规事件后删除了Docker Hub图像。</p><figure class="me mf mg mh gt mi gh gi paragraph-image"><div role="button" tabindex="0" class="mj mk di ml bf mm"><div class="gh gi md"><img src="../Images/b22f0978cb4fd2452233e0baa160f160.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*cEquyMx45Kcvm1zi.png"/></div></div></figure><p id="32db" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><a class="ae kl" href="https://github.com/paritytech/parity-ethereum/issues/10627" rel="noopener ugc nofollow" target="_blank">https://github.com/paritytech/parity-ethereum/issues/10627</a></p><p id="43ea" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">奇偶校验只是该用例的一个例子。事实上，有数不清集装箱在疯狂运行，你需要保护你的码头环境。</p><p id="25e3" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">因此，我们Opvizor公司决定创建一个解决方案来保护ZTC节点。我们对结果感到非常自豪，最棒的是，该解决方案可以通用。</p><p id="2e73" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">需要什么:</p><ol class=""><li id="256c" class="km kn iq jp b jq jr ju jv jy ko kc kp kg kq kk mp ks kt ku bi translated">标记和验证客户允许运行的docker图像的可靠方法(类似于白名单)</li><li id="56a1" class="km kn iq jp b jq kv ju kw jy kx kc ky kg kz kk mp ks kt ku bi translated">连续监控和验证运行中的容器</li><li id="1316" class="km kn iq jp b jq kv ju kw jy kx kc ky kg kz kk mp ks kt ku bi translated">结果的数据转发器</li><li id="81b5" class="km kn iq jp b jq kv ju kw jy kx kc ky kg kz kk mp ks kt ku bi translated">包括警报的可视化</li></ol><p id="da01" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">让我们一步一步开始。</p><h1 id="5c20" class="la lb iq bd lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx bi translated">标记和验证客户允许运行的docker图像的可靠方法(类似于白名单)</h1><p id="c9f2" class="pw-post-body-paragraph jn jo iq jp b jq ly js jt ju lz jw jx jy ma ka kb kc mb ke kf kg mc ki kj kk ij bi translated">运行在ZTC区块链之上的软件公司code公证人(code公证人)几周前发布了一个docker容器支持(T3)。</p><p id="25c0" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这样，我们可以确保所有我们想要使用的图像都在使用中。docker的一个大问题是有自己的版本标签。虽然在部署过程中非常方便(尤其是最新的或稳定的)，但是很难确定在整个环境中是否所有容器都运行相同的版本。</p><p id="bfd4" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在ZTC，节点分布在全球各地，由完全独立的公司维护。尽管版本被用作标签，但他们绝对需要确保docker图像的完整性。最佳解决方案是在无缝集成的同时持续检查。</p><p id="f112" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">由于ZTC已经有了一个公证帐户，他们签署了所有码头集装箱图像，他们肯定是真实的和良好的。</p><p id="7a10" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">vcn命令会发生这种情况(每个人都可以<a class="ae kl" href="https://github.com/vchain-us/vcn" rel="noopener ugc nofollow" target="_blank">下载或构建</a>他们命令):</p><p id="2505" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir"> vcn标志docker://parity/parity:ztc </strong></p><p id="2332" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">虽然该命令看起来很简单，但实际情况是计算容器映像的唯一校验和，并将其写入包含签名者信息的区块链。</p><p id="1ded" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这样，没有人可以像dockerhub.com一样通过入侵网页来改变校验和。</p><p id="4be0" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">当然，您可以在事后直接验证容器映像:</p><p id="b9f5" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir"> vcn验证docker://parity/parity:ztc </strong></p><p id="8c83" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果您想了解有关该流程的更多信息，请查看下图:</p><figure class="me mf mg mh gt mi gh gi paragraph-image"><div role="button" tabindex="0" class="mj mk di ml bf mm"><div class="gh gi mq"><img src="../Images/2095d8d70a165d43d6e44570061f127f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*h8iGbZ69LY8sUw0c.png"/></div></div></figure><p id="c9a8" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">让我们继续添加监控和验证部分。</p><h1 id="35cb" class="la lb iq bd lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx bi translated">连续监控和验证运行中的容器</h1><p id="61f1" class="pw-post-body-paragraph jn jo iq jp b jq ly js jt ju lz jw jx jy ma ka kb kc mb ke kf kg mc ki kj kk ij bi translated">为了能够持续监控运行中的docker容器和构建它们的docker容器映像，我们需要一个对docker主机具有读权限的sidecar容器。</p><p id="e2c9" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">code公证人开发团队帮了大忙，因为他们维护了一个新的Github项目，在一个容器中构建并运行一个vcn看门狗:<a class="ae kl" href="https://github.com/vchain-us/vcn-watchdog" rel="noopener ugc nofollow" target="_blank"> vcn-watchdog </a></p><h1 id="039d" class="la lb iq bd lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx bi translated">结果的数据转发器</h1><p id="f8c8" class="pw-post-body-paragraph jn jo iq jp b jq ly js jt ju lz jw jx jy ma ka kb kc mb ke kf kg mc ki kj kk ij bi translated">构建非常简单:</p><ol class=""><li id="2158" class="km kn iq jp b jq jr ju jv jy ko kc kp kg kq kk mp ks kt ku bi translated">克隆回购</li><li id="a984" class="km kn iq jp b jq kv ju kw jy kx kc ky kg kz kk mp ks kt ku bi translated">构建容器</li><li id="1479" class="km kn iq jp b jq kv ju kw jy kx kc ky kg kz kk mp ks kt ku bi translated">根据您的需要更改验证脚本</li><li id="7b0a" class="km kn iq jp b jq kv ju kw jy kx kc ky kg kz kk mp ks kt ku bi translated">运行容器</li></ol><pre class="me mf mg mh gt mr ms mt mu aw mv bi"><span id="d8f9" class="mw lb iq ms b gy mx my l mz na">git clone <a class="ae kl" href="https://github.com/vchain-us/vcn-watchdog.git" rel="noopener ugc nofollow" target="_blank">https://github.com/vchain-us/vcn-watchdog.git</a> <br/>docker-compose build <br/>docker-compose up -d</span></pre><p id="8c76" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们使用了一个稍加修改的构建，它将在几天后发布，产生-json输出。如果你今天已经想使用它，请使用不稳定版本。</p><p id="2a90" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">否则，您需要稍微修改一下验证脚本，或者只使用err函数。</p><p id="5fd9" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们更改了验证脚本，将结果转发到我们的InfluxDB:</p><pre class="me mf mg mh gt mr ms mt mu aw mv bi"><span id="7c03" class="mw lb iq ms b gy mx my l mz na">#!/bin/bash<br/>export CHECK_INTERVAL="60"<br/>node=$(echo "${NODENAME}")</span><span id="954e" class="mw lb iq ms b gy nb my l mz na">function ok() {<br/>    name=$(jq -r ".artifact.name" &lt;&lt;&lt; ${2})<br/>    level=$(jq -r ".verification.level" &lt;&lt;&lt; ${2})<br/>    status=$(jq -r ".verification.status" &lt;&lt;&lt; ${2})<br/>    publisher=$(jq -r ".artifact.publisher" &lt;&lt;&lt; ${2})<br/>    echo "Container ${1} (${name}) check successful (publisher: ${publisher}, level: ${level}, status: ${status})"<br/>    curl -i -XPOST '<a class="ae kl" href="http://influx:8086/write?db=mydb'" rel="noopener ugc nofollow" target="_blank">http://influx:8086/write?db=mydb'</a> \ <br/> --data-binary "vcn_verification,hostname=$node,container_name=${3},container_id=${1},status=${status},level=${level} failed=0,status=${status},level=${level}" \<br/> &gt; /dev/null 2&gt;&amp;1<br/>   }</span><span id="78b2" class="mw lb iq ms b gy nb my l mz na">function err() {<br/>    echo "Container ${1} (${2}) verification failed" &gt;&amp;2<br/>    curl -i -XPOST '<a class="ae kl" href="http://influx:8086/write?db=mydb'" rel="noopener ugc nofollow" target="_blank">http://influx:8086/write?db=mydb'</a> --data-binary \<br/> "vcn_verification,hostname=$node,container_name=${2},container_id=${1} failed=1" \<br/> &gt; /dev/null 2&gt;&amp;1<br/>   }</span><span id="b453" class="mw lb iq ms b gy nb my l mz na">while true; do<br/>    docker ps -q | grep -v ${HOSTNAME} | while read id; do<br/>        image=$(docker inspect "${id}" | jq '.[0].Config.Image' | sed 's/"//g')<br/>        json=$(vcn v -o=json "docker://${image}" 2&gt; /dev/null)<br/>        if [ $? -eq 0 ] ; then<br/>            ok "${id}" "${json}" "${image}"<br/>        else<br/>            err "${id}" "${image}"<br/>        fi<br/>    done<br/>    sleep "${CHECK_INTERVAL}"<br/>done</span></pre><p id="0713" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">一旦容器启动，它就使用vcn verify验证所有正在运行的容器，并将结果发送到<a class="ae kl" href="https://influxdata.com" rel="noopener ugc nofollow" target="_blank"> InfluxDB </a> TimeSeries数据库，这样我们就可以对其进行可视化或警告。</p><h1 id="f4ce" class="la lb iq bd lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx bi translated">包括警报的可视化</h1><p id="5885" class="pw-post-body-paragraph jn jo iq jp b jq ly js jt ju lz jw jx jy ma ka kb kc mb ke kf kg mc ki kj kk ij bi translated">ZTC操作仪表板包含几个面板，以查明问题，在我们的情况下，验证失败。这样，ZTC成员就不会在运营团队不知情的情况下意外获取错误的图像。</p><p id="6c7d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这张图片展示了我们测试阶段的小部件。</p><figure class="me mf mg mh gt mi gh gi paragraph-image"><div role="button" tabindex="0" class="mj mk di ml bf mm"><div class="gh gi md"><img src="../Images/4793ad669d7924c29186effa3c986399.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*n_N6ty4GqzXeDNqZ.png"/></div></div></figure><p id="982a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果您不想使用Performance Analyzer，要创建metrics视图，您可以配置指向InfluxDB的面板，如下所示:</p><figure class="me mf mg mh gt mi gh gi paragraph-image"><div class="gh gi nc"><img src="../Images/e35df4f9ab263b8fb4f055a91da8e9b5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1358/format:webp/0*F79P0G0Eu2k2N671.png"/></div></figure><p id="529a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果您想在指标上发出警报，请确保使用图表，因为Grafana只允许在那里发出警报:</p><figure class="me mf mg mh gt mi gh gi paragraph-image"><div role="button" tabindex="0" class="mj mk di ml bf mm"><div class="gh gi md"><img src="../Images/9413c4ba340038ca11235eb2e9c4e7dd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*MixGbjeRhm90yEb2.png"/></div></div></figure><h1 id="daab" class="la lb iq bd lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx bi translated">后续步骤</h1><p id="f011" class="pw-post-body-paragraph jn jo iq jp b jq ly js jt ju lz jw jx jy ma ka kb kc mb ke kf kg mc ki kj kk ij bi translated">读完这篇博客后，我们确信你也想保护你的docker环境。</p><p id="7335" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">作为<a class="ae kl" href="https://www.opvizor.com" rel="noopener ugc nofollow" target="_blank">性能分析器</a>的客户，你可以在<a class="ae kl" href="https://www.codenotary.io" rel="noopener ugc nofollow" target="_blank">公证处</a>注册，使用我们的vcn边车容器报告脚本。</p><p id="00e7" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果您还不是<a class="ae kl" href="https://www.opvizor.com" rel="noopener ugc nofollow" target="_blank">性能分析器</a>的客户，现在是开始免费试用的好时机，涵盖容器性能和完整性！</p><p id="17f7" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">你也可以期待一个Kubernetes-ready版本即将推出。</p></div><div class="ab cl nd ne hu nf" role="separator"><span class="ng bw bk nh ni nj"/><span class="ng bw bk nh ni nj"/><span class="ng bw bk nh ni"/></div><div class="ij ik il im in"><p id="d9e9" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><em class="nk">原载于2019年5月8日</em><a class="ae kl" href="https://www.opvizor.com/protect-your-docker-environment-using-performance-analyzer-and-codenotary" rel="noopener ugc nofollow" target="_blank"><em class="nk">https://www.opvizor.com</em></a><em class="nk">。</em></p></div></div>    
</body>
</html>