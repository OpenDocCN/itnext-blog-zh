<html>
<head>
<title>How to secure Kubernetes in-cluster communication</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何保护Kubernetes集群内通信的安全</h1>
<blockquote>原文：<a href="https://itnext.io/how-to-secure-kubernetes-in-cluster-communication-5a9927be415b?source=collection_archive---------0-----------------------#2022-01-28">https://itnext.io/how-to-secure-kubernetes-in-cluster-communication-5a9927be415b?source=collection_archive---------0-----------------------#2022-01-28</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><figure class="ip iq gp gr ir is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi io"><img src="../Images/687f96193995373470ea77a94eb9708e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*fXkZe5AHsso1Ib-sppNqbw.jpeg"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">Pixabay上的杰洛特</figcaption></figure><div class=""/><div class=""><h2 id="c691" class="pw-subtitle-paragraph kd jf jg bd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku dk translated">Linkerd服务网格简介</h2></div><h2 id="091e" class="kv kw jg bd kx ky kz dn la lb lc dp ld le lf lg lh li lj lk ll lm ln lo lp lq bi translated">介绍</h2><p id="0242" class="pw-post-body-paragraph lr ls jg lt b lu lv kh lw lx ly kk lz le ma mb mc li md me mf lm mg mh mi mj ij bi translated">开发Kubernetes意味着开发云原生应用程序。<a class="ae jd" href="https://www.cncf.io/" rel="noopener ugc nofollow" target="_blank"> CNCF </a>将云原生定义为:</p><p id="9cd9" class="pw-post-body-paragraph lr ls jg lt b lu mk kh lw lx ml kk lz le mm mb mc li mn me mf lm mo mh mi mj ij bi translated">云原生技术使组织能够在现代动态环境(如公共云、私有云和混合云)中构建和运行可扩展的应用程序。容器、<strong class="lt jh">服务网格</strong>、微服务、不可变基础设施和声明式API都是这种方法的例子。</p><p id="ab44" class="pw-post-body-paragraph lr ls jg lt b lu mk kh lw lx ml kk lz le mm mb mc li mn me mf lm mo mh mi mj ij bi translated">这些技术使得松散耦合的系统具有弹性、可管理性和可观察性。与强大的自动化相结合，它们允许工程师以最少的劳动频繁地、可预测地做出高影响力的改变。</p><p id="7418" class="pw-post-body-paragraph lr ls jg lt b lu mk kh lw lx ml kk lz le mm mb mc li mn me mf lm mo mh mi mj ij bi translated"><em class="mp">来源:</em><a class="ae jd" href="https://github.com/cncf/foundation/blob/master/charter.md" rel="noopener ugc nofollow" target="_blank"><em class="mp">https://github.com/cncf/foundation/blob/master/charter.md</em></a></p><p id="cd50" class="pw-post-body-paragraph lr ls jg lt b lu mk kh lw lx ml kk lz le mm mb mc li mn me mf lm mo mh mi mj ij bi translated">云原生应用需要不同的架构方法。服务网格通过将复杂性从应用转移到底层基础设施，帮助实现云原生架构目标</p><blockquote class="mq mr ms"><p id="813c" class="lr ls mp lt b lu mk kh lw lx ml kk lz mt mm mb mc mu mn me mf mv mo mh mi mj ij bi translated"><em class="jg">如果您需要复习关于</em> <a class="ae jd" href="https://linkerd.io/what-is-a-service-mesh/" rel="noopener ugc nofollow" target="_blank"> <em class="jg">服务网格</em> </a> <em class="jg">的内容，请访问Linkerd文档。</em></p></blockquote><h2 id="47e6" class="kv kw jg bd kx ky kz dn la lb lc dp ld le lf lg lh li lj lk ll lm ln lo lp lq bi translated">服务网格解决什么问题？</h2><p id="84ba" class="pw-post-body-paragraph lr ls jg lt b lu lv kh lw lx ly kk lz le ma mb mc li md me mf lm mg mh mi mj ij bi translated">服务网格通过在平台层而不是应用层透明地插入可观察性、安全性和可靠性功能，为“云原生”应用程序增加了这些功能。</p><ul class=""><li id="9b71" class="mw mx jg lt b lu mk lx ml le my li mz lm na mj nb nc nd ne bi translated">平台级指标:在不改变配置或源代码的情况下，跟踪低级指标</li><li id="c655" class="mw mx jg lt b lu nf lx ng le nh li ni lm nj mj nb nc nd ne bi translated"><strong class="lt jh"> Mutual TLS — mLTS </strong>:为集群工作负载添加加密和基于身份的证书</li><li id="2598" class="mw mx jg lt b lu nf lx ng le nh li ni lm nj mj nb nc nd ne bi translated">提高弹性:延迟感知负载平衡、重试、超时和高级部署模式</li><li id="8ec9" class="mw mx jg lt b lu nf lx ng le nh li ni lm nj mj nb nc nd ne bi translated">授权策略:在服务级别实施流量规则</li></ul><p id="e4c3" class="pw-post-body-paragraph lr ls jg lt b lu mk kh lw lx ml kk lz le mm mb mc li mn me mf lm mo mh mi mj ij bi translated">服务网格是一个高级而复杂的主题，因此我们不会一次关注所有的功能，而是一次解决一个。我们将探讨服务网格如何帮助保护集群间的通信。</p><h1 id="cf0f" class="nk kw jg bd kx nl nm nn la no np nq ld km nr kn lh kp ns kq ll ks nt kt lp nu bi translated">验证和加密地狱流量</h1><p id="5cb9" class="pw-post-body-paragraph lr ls jg lt b lu lv kh lw lx ly kk lz le ma mb mc li md me mf lm mg mh mi mj ij bi translated">服务网格的前提是将意外的架构复杂性(如日志记录、监控、加密和身份验证)转移到底层平台，而不是要求单个应用程序在框架或编程级别实现类似的逻辑。</p><p id="19a8" class="pw-post-body-paragraph lr ls jg lt b lu mk kh lw lx ml kk lz le mm mb mc li mn me mf lm mo mh mi mj ij bi translated">有两个流行的服务网格，<a class="ae jd" href="https://istio.io/" rel="noopener ugc nofollow" target="_blank"> Istio </a>和<a class="ae jd" href="https://linkerd.io/" rel="noopener ugc nofollow" target="_blank"> Linkerd </a>。我们将使用Linkerd来了解如何加密和认证流量，但同样的方法也适用于Istio。</p><blockquote class="mq mr ms"><p id="0be9" class="lr ls mp lt b lu mk kh lw lx ml kk lz mt mm mb mc mu mn me mf mv mo mh mi mj ij bi translated"><em class="jg">2021年Linkerd </em> <a class="ae jd" href="https://www.cncf.io/announcements/2021/07/28/cloud-native-computing-foundation-announces-linkerd-graduation/" rel="noopener ugc nofollow" target="_blank"> <em class="jg">移至</em>毕业<em class="jg">状态</em> </a> <em class="jg">的CNCF项目，加盟项目如</em> Kubernetes <em class="jg">、</em> etcd <em class="jg">、</em> rook <em class="jg">或</em> helm</p></blockquote><p id="1fd9" class="pw-post-body-paragraph lr ls jg lt b lu mk kh lw lx ml kk lz le mm mb mc li mn me mf lm mo mh mi mj ij bi translated">一旦安装到集群上，linkerd控制平面将把边盘注入到Kubernetes系统单元中。从那里，我们可以注入侧柜到豆荚，并创建一个服务网。</p><figure class="nw nx ny nz gt is gh gi paragraph-image"><div class="gh gi nv"><img src="../Images/73d6b88453c324e5729537c09feffcac.png" data-original-src="https://miro.medium.com/v2/resize:fit:1370/0*L0lJnQxc7aee7Z14"/></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">来源:作者</figcaption></figure><h1 id="6dd4" class="nk kw jg bd kx nl nm nn la no np nq ld km nr kn lh kp ns kq ll ks nt kt lp nu bi translated">演示示例</h1><p id="9551" class="pw-post-body-paragraph lr ls jg lt b lu lv kh lw lx ly kk lz le ma mb mc li md me mf lm mg mh mi mj ij bi translated">如果您想尝试Linkerd如何保护和认证Kubernetes集群中的流量，请前往Katacoda并跟随这个自定进度的实验。</p><div class="ip iq gp gr ir oa"><a href="https://www.katacoda.com/decoder/courses/k8s-networking/k8s-networking-linkerd" rel="noopener  ugc nofollow" target="_blank"><div class="ob ab fo"><div class="oc ab od cl cj oe"><h2 class="bd jh gy z fp of fr fs og fu fw jf bi translated">Kubernetes网络:使用Linkerd的服务网格|解码器| Katacoda</h2><div class="oh l"><h3 class="bd b gy z fp of fr fs og fu fw dk translated">☕后台脚本将执行以下任务:重要。如果任何步骤失败，或者您在…中看到CrashLoopBackOff</h3></div><div class="oi l"><p class="bd b dl z fp of fr fs og fu fw dk translated">www.katacoda.com</p></div></div><div class="oj l"><div class="ok l ol om on oj oo ix oa"/></div></div></a></div><figure class="nw nx ny nz gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi op"><img src="../Images/174393d455789903c63f38c464a960ce.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ij063QEMtV52ViguLMKNZQ.png"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">卡塔科达情景</figcaption></figure><h2 id="57da" class="kv kw jg bd kx ky kz dn la lb lc dp ld le lf lg lh li lj lk ll lm ln lo lp lq bi translated">实验室场景流程</h2><ul class=""><li id="099a" class="mw mx jg lt b lu lv lx ly le oq li or lm os mj nb nc nd ne bi translated">安装linkerd CLI <code class="fe ot ou ov ow b">linkerd version</code></li><li id="cb58" class="mw mx jg lt b lu nf lx ng le nh li ni lm nj mj nb nc nd ne bi translated">检查集群是否准备好安装控制面板<code class="fe ot ou ov ow b">linkerd check --pre</code></li><li id="0831" class="mw mx jg lt b lu nf lx ng le nh li ni lm nj mj nb nc nd ne bi translated">安装linkerd控制平面</li></ul><pre class="nw nx ny nz gt ox ow oy oz aw pa bi"><span id="35e2" class="kv kw jg ow b gy pb pc l pd pe">linkerd install | kubectl apply -f -</span></pre><ul class=""><li id="297d" class="mw mx jg lt b lu mk lx ml le my li mz lm na mj nb nc nd ne bi translated">检查linkerd安装<code class="fe ot ou ov ow b">linkerd check</code></li><li id="c125" class="mw mx jg lt b lu nf lx ng le nh li ni lm nj mj nb nc nd ne bi translated">创建示例部署</li></ul><p id="c39c" class="pw-post-body-paragraph lr ls jg lt b lu mk kh lw lx ml kk lz le mm mb mc li mn me mf lm mo mh mi mj ij bi translated"><code class="fe ot ou ov ow b">kubectl create deployment --image=gcr.io/kuar-demo/kuard-amd64:blue kuard</code></p><ul class=""><li id="c96a" class="mw mx jg lt b lu mk lx ml le my li mz lm na mj nb nc nd ne bi translated">等待分离舱上升</li></ul><p id="9a05" class="pw-post-body-paragraph lr ls jg lt b lu mk kh lw lx ml kk lz le mm mb mc li mn me mf lm mo mh mi mj ij bi translated"><code class="fe ot ou ov ow b">kubectl wait deployment kuard --for=condition=Available --timeout=1m</code></p><ul class=""><li id="a50f" class="mw mx jg lt b lu mk lx ml le my li mz lm na mj nb nc nd ne bi translated">将流量转发到pod</li></ul><p id="4b6e" class="pw-post-body-paragraph lr ls jg lt b lu mk kh lw lx ml kk lz le mm mb mc li mn me mf lm mo mh mi mj ij bi translated"><code class="fe ot ou ov ow b">kubectl port-forward deploy/kuard 8080:8080 --address 0.0.0.0 &amp;</code></p><figure class="nw nx ny nz gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi pf"><img src="../Images/34817a308e268952de30a415e2d9df9c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*j7f5QEFo__Dm0h7-.png"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">Kuard网页</figcaption></figure><ul class=""><li id="baed" class="mw mx jg lt b lu mk lx ml le my li mz lm na mj nb nc nd ne bi translated">注射linkerd边车</li></ul><figure class="nw nx ny nz gt is gh gi paragraph-image"><div class="gh gi pg"><img src="../Images/049a8bf3725dfad35685c802dc4f90fc.png" data-original-src="https://miro.medium.com/v2/resize:fit:128/format:webp/0*6tvTrQ5swsHlZtB3.png"/></div></figure><blockquote class="mq mr ms"><p id="d62e" class="lr ls mp lt b lu mk kh lw lx ml kk lz mt mm mb mc mu mn me mf mv mo mh mi mj ij bi translated"><em class="jg">在注入linkerd边车之前，让我们看看kuard pod内部运行了多少个容器。应该只有kuard容器在运行。</em></p></blockquote><p id="6962" class="pw-post-body-paragraph lr ls jg lt b lu mk kh lw lx ml kk lz le mm mb mc li mn me mf lm mo mh mi mj ij bi translated"><code class="fe ot ou ov ow b">kubectl get pods -l app=kuard -o jsonpath='{.items[*].spec.containers[*].name}{"\n"}'</code></p><ul class=""><li id="3c66" class="mw mx jg lt b lu mk lx ml le my li mz lm na mj nb nc nd ne bi translated">将linkerd边车注入kuard pod</li></ul><pre class="nw nx ny nz gt ox ow oy oz aw pa bi"><span id="5d8f" class="kv kw jg ow b gy pb pc l pd pe">kubectl get deploy kuard -o yaml \<br/>  | linkerd inject - \<br/>  | kubectl apply -f -</span></pre><ul class=""><li id="611a" class="mw mx jg lt b lu mk lx ml le my li mz lm na mj nb nc nd ne bi translated">确保正确使用linkerd边车</li></ul><p id="31b2" class="pw-post-body-paragraph lr ls jg lt b lu mk kh lw lx ml kk lz le mm mb mc li mn me mf lm mo mh mi mj ij bi translated"><code class="fe ot ou ov ow b">linkerd -n default check --proxy</code></p><ul class=""><li id="a5dc" class="mw mx jg lt b lu mk lx ml le my li mz lm na mj nb nc nd ne bi translated">我们应该看到linkerd边车在舱中运行</li></ul><p id="90fc" class="pw-post-body-paragraph lr ls jg lt b lu mk kh lw lx ml kk lz le mm mb mc li mn me mf lm mo mh mi mj ij bi translated"><code class="fe ot ou ov ow b">kubectl get pods -l app=kuard -o jsonpath='{.items[*].spec.containers[*].name}{"\n"}'</code></p><ul class=""><li id="0c92" class="mw mx jg lt b lu mk lx ml le my li mz lm na mj nb nc nd ne bi translated">安装可观察性扩展</li></ul><p id="f7c8" class="pw-post-body-paragraph lr ls jg lt b lu mk kh lw lx ml kk lz le mm mb mc li mn me mf lm mo mh mi mj ij bi translated"><code class="fe ot ou ov ow b">helm repo add linkerd <a class="ae jd" href="https://helm.linkerd.io/stable" rel="noopener ugc nofollow" target="_blank">https://helm.linkerd.io/stable</a></code></p><pre class="nw nx ny nz gt ox ow oy oz aw pa bi"><span id="62c0" class="kv kw jg ow b gy pb pc l pd pe">helm install linkerd-viz \<br/>  --set dashboard.enforcedHostRegexp=.* \<br/>  linkerd/linkerd-viz</span></pre><ul class=""><li id="accf" class="mw mx jg lt b lu mk lx ml le my li mz lm na mj nb nc nd ne bi translated">确保安装成功<code class="fe ot ou ov ow b">linkerd check</code></li><li id="a6ea" class="mw mx jg lt b lu nf lx ng le nh li ni lm nj mj nb nc nd ne bi translated">在后台启动仪表板</li></ul><pre class="nw nx ny nz gt ox ow oy oz aw pa bi"><span id="edfc" class="kv kw jg ow b gy pb pc l pd pe">linkerd viz dashboard --address 0.0.0.0 &amp;</span></pre><ul class=""><li id="1191" class="mw mx jg lt b lu mk lx ml le my li mz lm na mj nb nc nd ne bi translated">检查mTLS在系统盒和kuard盒之间是否工作</li></ul><figure class="nw nx ny nz gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi ph"><img src="../Images/f67f14bc167cbbdb437cc2b7d3f85c92.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*dFTBt1nWpMQSizNA.png"/></div></div></figure><figure class="nw nx ny nz gt is gh gi paragraph-image"><div class="gh gi pg"><img src="../Images/6a591d030757c20e63bef47f1d90c049.png" data-original-src="https://miro.medium.com/v2/resize:fit:128/format:webp/0*5EhU8Rr-16UBHIbN.png"/></div></figure><ul class=""><li id="0eff" class="mw mx jg lt b lu mk lx ml le my li mz lm na mj nb nc nd ne bi translated">相互TLS</li></ul><blockquote class="mq mr ms"><p id="7c81" class="lr ls mp lt b lu mk kh lw lx ml kk lz mt mm mb mc mu mn me mf mv mo mh mi mj ij bi translated"><em class="jg">默认情况下，所有注入了linkerd sidecar的pod通过加密和认证流量进行通信</em></p></blockquote><ul class=""><li id="78c5" class="mw mx jg lt b lu mk lx ml le my li mz lm na mj nb nc nd ne bi translated">重启pod以启用tap配置</li></ul><pre class="nw nx ny nz gt ox ow oy oz aw pa bi"><span id="ed57" class="kv kw jg ow b gy pb pc l pd pe">kubectl rollout restart deployment kuard</span></pre><ul class=""><li id="01a3" class="mw mx jg lt b lu mk lx ml le my li mz lm na mj nb nc nd ne bi translated">浏览仪表板以查看连接详细信息</li></ul><figure class="nw nx ny nz gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi pi"><img src="../Images/5e540d08d54d856e4d5d3c1f0a9d1109.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*02268mu_WgjYQDFZ.png"/></div></div></figure><h1 id="8a34" class="nk kw jg bd kx nl nm nn la no np nq ld km nr kn lh kp ns kq ll ks nt kt lp nu bi translated">结论</h1><p id="dbe4" class="pw-post-body-paragraph lr ls jg lt b lu lv kh lw lx ly kk lz le ma mb mc li md me mf lm mg mh mi mj ij bi translated">在您开始在集群上安装Linkerd或Istio之前，请确保您了解服务网格带来的操作和认知复杂性。</p><p id="0df0" class="pw-post-body-paragraph lr ls jg lt b lu mk kh lw lx ml kk lz le mm mb mc li mn me mf lm mo mh mi mj ij bi translated">对于大多数工作负载，您不需要服务网格。通常有替代方案，它们只满足您需要的需求，而不会增加您不需要的功能的复杂性。</p></div></div>    
</body>
</html>