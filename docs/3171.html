<html>
<head>
<title>Launching “$ npm run” programmatically with `npm.run()`</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用“npm.run()”以编程方式启动“$ npm run”</h1>
<blockquote>原文：<a href="https://itnext.io/launching-npm-run-programmatically-with-npm-run-f2a1b8a569a6?source=collection_archive---------2-----------------------#2019-10-16">https://itnext.io/launching-npm-run-programmatically-with-npm-run-f2a1b8a569a6?source=collection_archive---------2-----------------------#2019-10-16</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="3b77" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">不需要<em class="kl"> child_process.exec() </em>等。<em class="kl">前期</em>和<em class="kl">后期</em>剧本也很受尊重。在<a class="ae km" href="https://dev.to/noriste/launching-npm-run-programmatically-with-npm-run-3mmc" rel="noopener ugc nofollow" target="_blank"> dev.to </a>上阅读此处。</p><figure class="ko kp kq kr gt ks gh gi paragraph-image"><div role="button" tabindex="0" class="kt ku di kv bf kw"><div class="gh gi kn"><img src="../Images/90df055baf954912fe39ddcc1bd5bf75.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*aSygJwQVKYhb7fRZuk3j5w.jpeg"/></div></div></figure><p id="7e5a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><em class="kl">已弃用！请检查出</em> <a class="ae km" href="https://fig.io/" rel="noopener ugc nofollow" target="_blank"> <em class="kl">图</em> </a> <em class="kl">或</em> <a class="ae km" href="https://github.com/antfu/ni" rel="noopener ugc nofollow" target="_blank"> <em class="kl">倪</em> </a> <em class="kl">作为可能的替代品！</em></p></div><div class="ab cl kz la hu lb" role="separator"><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le"/></div><div class="ij ik il im in"><h1 id="f067" class="lg lh iq bd li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md bi translated">我的问题</h1><p id="2c8c" class="pw-post-body-paragraph jn jo iq jp b jq me js jt ju mf jw jx jy mg ka kb kc mh ke kf kg mi ki kj kk ij bi translated">在开发cypress-wait-until库的时候，我想把测试视频上传到cypress仪表盘上。这样做非常简单，我只需要更新我的package.json专用脚本:</p><pre class="ko kp kq kr gt mj mk ml mm aw mn bi"><span id="8bb7" class="mo lh iq mk b gy mp mq l mr ms">{<br/>  "scripts": {<br/>    // from<br/>    "cy:run": "cypress run"</span><span id="ff74" class="mo lh iq mk b gy mt mq l mr ms">    // to<br/>    "cy:run": "cypress run --record --key YOUR_SECRET_KEY"<br/>  }<br/>}</span></pre><p id="7874" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">但是我不得不面对一个大问题:YOUR_SECRET_KEY环境变量只能在Travis构建中使用，而不能在本地使用。如果您在本地机器上运行它，而没有定义YOUR_SECRET_KEY，<em class="kl"> cypress run </em>命令就会失败。</p><p id="9c3f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">有很多解决上述问题的方法(比如<em class="kl"> child_process.exec </em>)，但是所有的方法都有成本和一些需要管理的影响。更多:我还需要改变管理package.json脚本的方式。</p><p id="266a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我希望有一个<strong class="jp ir">透明的解决方案</strong>，允许我将YOUR_SECRET_KEY设置为可选的，但不改变我的脚本管理。</p><h1 id="0c22" class="lg lh iq bd li lj mu ll lm ln mv lp lq lr mw lt lu lv mx lx ly lz my mb mc md bi translated">作为本地依赖项的Npm</h1><p id="3eef" class="pw-post-body-paragraph jn jo iq jp b jq me js jt ju mf jw jx jy mg ka kb kc mh ke kf kg mi ki kj kk ij bi translated">在谷歌搜索时，我发现了一个有趣的解决方案:在本地安装Npm并利用它的API。工作原理:</p><ul class=""><li id="0c44" class="mz na iq jp b jq jr ju jv jy nb kc nc kg nd kk ne nf ng nh bi translated">首先，安装npm</li></ul><pre class="ko kp kq kr gt mj mk ml mm aw mn bi"><span id="0e81" class="mo lh iq mk b gy mp mq l mr ms">$ npm install --save-dev npm</span></pre><ul class=""><li id="e1cb" class="mz na iq jp b jq jr ju jv jy nb kc nc kg nd kk ne nf ng nh bi translated">然后，创建一个. js文件</li></ul><pre class="ko kp kq kr gt mj mk ml mm aw mn bi"><span id="dd57" class="mo lh iq mk b gy mp mq l mr ms">$ touch index.js &amp;&amp; open index.js</span></pre><ul class=""><li id="68f2" class="mz na iq jp b jq jr ju jv jy nb kc nc kg nd kk ne nf ng nh bi translated">导入npm</li></ul><pre class="ko kp kq kr gt mj mk ml mm aw mn bi"><span id="8652" class="mo lh iq mk b gy mp mq l mr ms">const npm = require("npm");</span></pre><ul class=""><li id="775b" class="mz na iq jp b jq jr ju jv jy nb kc nc kg nd kk ne nf ng nh bi translated">让npm加载当前项目</li></ul><pre class="ko kp kq kr gt mj mk ml mm aw mn bi"><span id="c93e" class="mo lh iq mk b gy mp mq l mr ms">npm.load();</span></pre><ul class=""><li id="5293" class="mz na iq jp b jq jr ju jv jy nb kc nc kg nd kk ne nf ng nh bi translated">向<em class="kl"> npm.load() </em> API传递一个回调，并运行您的</li></ul><pre class="ko kp kq kr gt mj mk ml mm aw mn bi"><span id="d4f0" class="mo lh iq mk b gy mp mq l mr ms">npm.load(() <em class="kl">=&gt;</em> npm.run("SCRIPT_NAME"));</span></pre><p id="2c2c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">关于<em class="kl"> npm.run() </em> API的一些注意事项:</p><ul class=""><li id="a29f" class="mz na iq jp b jq jr ju jv jy nb kc nc kg nd kk ne nf ng nh bi translated">不提前调用<em class="kl"> npm.load </em>就无法运行。如果您尝试这样做，您会得到一个“错误:在使用这个命令之前调用npm.load(config，cb)”错误</li><li id="c667" class="mz na iq jp b jq ni ju nj jy nk kc nl kg nm kk ne nf ng nh bi translated">第一个参数是脚本名，如果你需要传递一些选项，你必须传递一个字符串数组</li></ul><pre class="ko kp kq kr gt mj mk ml mm aw mn bi"><span id="805b" class="mo lh iq mk b gy mp mq l mr ms">npm.run("test param"); // Error: missing script: test param</span><span id="71c5" class="mo lh iq mk b gy mt mq l mr ms">npm.run("test", "param"); // "param" is passed to the "test" script</span></pre><ul class=""><li id="0378" class="mz na iq jp b jq jr ju jv jy nb kc nc kg nd kk ne nf ng nh bi translated"><a class="ae km" href="https://docs.npmjs.com/misc/scripts" rel="noopener ugc nofollow" target="_blank"> <em class="kl">前置</em>和<em class="kl">后置</em> package.json脚本</a>也被启动</li></ul><p id="43f4" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我分享了一个<a class="ae km" href="https://github.com/NoriSte/npm-run-programmatically-example" rel="noopener ugc nofollow" target="_blank">NPM-run-programmable-example</a>存储库，你可以在那里使用它，这里有一个存储库终端会话的gif记录:</p><figure class="ko kp kq kr gt ks gh gi paragraph-image"><div role="button" tabindex="0" class="kt ku di kv bf kw"><div class="gh gi nn"><img src="../Images/67bf2d5ae4430093d8df712b7af1560a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*MtctuCY57cobDTb4NTE1rQ.gif"/></div></div><figcaption class="no np gj gh gi nq nr bd b be z dk translated">你也可以在<a class="ae km" href="https://asciinema.org/" rel="noopener ugc nofollow" target="_blank"> asciicinema </a>上<a class="ae km" href="https://asciinema.org/a/274563" rel="noopener ugc nofollow" target="_blank">观看同样的视频</a>。</figcaption></figure><h1 id="bab2" class="lg lh iq bd li lj mu ll lm ln mv lp lq lr mw lt lu lv mx lx ly lz my mb mc md bi translated">该解决方案如何满足我的需求</h1><p id="3cf5" class="pw-post-body-paragraph jn jo iq jp b jq me js jt ju mf jw jx jy mg ka kb kc mh ke kf kg mi ki kj kk ij bi translated">我这样解决了原来的问题:</p><ul class=""><li id="87e1" class="mz na iq jp b jq jr ju jv jy nb kc nc kg nd kk ne nf ng nh bi translated">我增加了一个<em class="kl">cy:run-upload-videos</em>脚本来代替<em class="kl"> cy:run </em></li></ul><pre class="ko kp kq kr gt mj mk ml mm aw mn bi"><span id="ddda" class="mo lh iq mk b gy mp mq l mr ms">{<br/>  "scripts": {<br/>    "cy:run-uploading-videos": "node cypress-run.js",<br/>    "cy:run": "cypress run"<br/>  }<br/>}</span></pre><ul class=""><li id="067f" class="mz na iq jp b jq jr ju jv jy nb kc nc kg nd kk ne nf ng nh bi translated">cypress-run.js文件如下所示</li></ul><pre class="ko kp kq kr gt mj mk ml mm aw mn bi"><span id="2d4c" class="mo lh iq mk b gy mp mq l mr ms">const npm = require('npm');<br/>npm.load(() =&gt; {<br/>  const key = process.env.CYPRESS_RECORD_KEY;<br/>  const options = key ? ['--record', '--key', key] : [];<br/>  npm.run('cy:run', ...options);<br/>});</span></pre><p id="7f5f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">因此，我可以在本地启动通常的<em class="kl"> cy:run </em>脚本，并在Travis上启动<em class="kl">cy:run-uploading-videos</em>🎉(无需重复<em class="kl"> cypress run </em>调用，该调用将来可能有更多参数)。</p><h1 id="b5ef" class="lg lh iq bd li lj mu ll lm ln mv lp lq lr mw lt lu lv mx lx ly lz my mb mc md bi translated">我可以用npm.run()做什么？</h1><p id="3b5d" class="pw-post-body-paragraph jn jo iq jp b jq me js jt ju mf jw jx jy mg ka kb kc mh ke kf kg mi ki kj kk ij bi translated">我的一个想法是<a class="ae km" href="https://github.com/NoriSte/nprr" rel="noopener ugc nofollow" target="_blank"> nprr </a>，一个用自动完成增强npm运行的工具。当你不记得你想要运行的脚本的名字的时候，你有过这种感觉吗？于是你打开package.json文件，寻找脚本名然后运行……好了，<a class="ae km" href="https://github.com/NoriSte/nprr" rel="noopener ugc nofollow" target="_blank"> nprr </a>解决了这个问题！观看它的运行:</p><figure class="ko kp kq kr gt ks gh gi paragraph-image"><div role="button" tabindex="0" class="kt ku di kv bf kw"><div class="gh gi ns"><img src="../Images/c409e1b1d7169d59f74e0e2c8018c551.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*sdyrHUtG9X0LlG1dgJS5Iw.gif"/></div></div><figcaption class="no np gj gh gi nq nr bd b be z dk translated">你也可以在<a class="ae km" href="https://asciinema.org/" rel="noopener ugc nofollow" target="_blank"> asciicinema </a>上<a class="ae km" href="https://asciinema.org/a/274468" rel="noopener ugc nofollow" target="_blank">看同样的视频</a>。</figcaption></figure><p id="e5f4" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">可能性是无限的，如果你以编程的方式利用npm，请留下你的实验/包/工具等的评论。😊</p></div><div class="ab cl kz la hu lb" role="separator"><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le"/></div><div class="ij ik il im in"><p id="ce0f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">你好👋我是Stefano Magni，我是一名充满激情的<strong class="jp ir"> JavaScript开发人员</strong>，一名<strong class="jp ir"> Cypress大使、</strong>和一名<strong class="jp ir">导师</strong>。我喜欢创造高质量的产品，测试和自动化一切，学习和分享我的知识，帮助别人，在会议上发言和面对新的挑战。我在意大利比特币初创公司<a class="ae km" href="https://conio.com/it/?source=post_page---------------------------" rel="noopener ugc nofollow" target="_blank"> Conio </a>工作。<br/>你可以在<a class="ae km" href="https://twitter.com/NoriSte?source=post_page---------------------------" rel="noopener ugc nofollow" target="_blank"> Twitter </a>、<a class="ae km" href="https://github.com/NoriSte?source=post_page---------------------------" rel="noopener ugc nofollow" target="_blank"> GitHub </a>、<a class="ae km" href="https://www.linkedin.com/in/noriste/?source=post_page---------------------------" rel="noopener ugc nofollow" target="_blank"> LinkedIn </a>上找到我。你可以找到我最近所有的文章/演讲等等。这里。</p></div></div>    
</body>
</html>