<html>
<head>
<title>Modify Helm 3 Release Manifest</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">修改头盔3发布清单</h1>
<blockquote>原文：<a href="https://itnext.io/modify-helm-3-release-manifest-c3870b90213?source=collection_archive---------1-----------------------#2020-10-19">https://itnext.io/modify-helm-3-release-manifest-c3870b90213?source=collection_archive---------1-----------------------#2020-10-19</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/4e8546a5e03b1553b1e454a8e8f0d867.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*06NbmtO32cTuPuE7"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">乔·什切潘斯卡在<a class="ae kc" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</figcaption></figure><h1 id="a898" class="kd ke iq bd kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la bi translated">为什么我们要修改已部署的头盔发布清单？</h1><p id="8c86" class="pw-post-body-paragraph lb lc iq ld b le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly ij bi translated">Helm总是试图通过“种类”(例如<code class="fe lz ma mb mc b">Deployment</code>)和“API版本”(例如<code class="fe lz ma mb mc b">apps/v1</code>)来匹配清单中的Kubernetes对象。但是，您的Kubernetes集群支持的“API版本”可能会发生变化，例如在将集群升级到更高版本或为第三方应用程序安装不同版本<a class="ae kc" href="https://kubernetes.io/docs/tasks/extend-kubernetes/custom-resources/custom-resource-definitions/" rel="noopener ugc nofollow" target="_blank"> CRD(自定义资源定义)</a>(例如<a class="ae kc" href="https://cert-manager.io/docs/installation/kubernetes/" rel="noopener ugc nofollow" target="_blank">证书管理器</a>)之后。</p><p id="0662" class="pw-post-body-paragraph lb lc iq ld b le md lg lh li me lk ll lm mf lo lp lq mg ls lt lu mh lw lx ly ij bi translated">当集群不再支持用于部署“种类”的Kubernetes对象的“API版本”时，Helm将无法匹配发布清单中的对象并报告错误:</p><pre class="mi mj mk ml gt mm mc mn mo aw mp bi"><span id="4030" class="mq ke iq mc b gy mr ms l mt mu">unable to recognize "": no matches for kind "xxxxx" in version "xxxxx"</span></pre><p id="14dc" class="pw-post-body-paragraph lb lc iq ld b le md lg lh li me lk ll lm mf lo lp lq mg ls lt lu mh lw lx ly ij bi translated">您可以要求Helm重试升级(在某些情况下，您可能需要<a class="ae kc" href="https://medium.com/@t83714/how-to-fix-helm-upgrade-error-has-no-deployed-releases-mystery-3dd67b2eb126" rel="noopener">这种技术</a>来强制Helm重试)，但Helm永远无法从该错误中恢复，除非您手动修改最新的发布清单并将“API版本”更新为您的集群支持的版本。显然，删除Helm版本并重新安装Helm图表是可行的——但这不太可能是大多数生产站点的选项。</p><h1 id="0eae" class="kd ke iq bd kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la bi translated">出口放行清单</h1><p id="14a3" class="pw-post-body-paragraph lb lc iq ld b le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly ij bi translated">为了修改Helm发布清单，您需要首先将清单导出为纯文本文件。内置的<code class="fe lz ma mb mc b">helm get manifest</code>命令也可以检索清单内容，但它不是我们将清单保存回编码数据所需的格式。</p><p id="1b79" class="pw-post-body-paragraph lb lc iq ld b le md lg lh li me lk ll lm mf lo lp lq mg ls lt lu mh lw lx ly ij bi translated">从Helm 3开始，发布数据在您的应用程序名称空间中存储为Kubernetes " <a class="ae kc" href="https://kubernetes.io/docs/concepts/configuration/secret/" rel="noopener ugc nofollow" target="_blank"> Secret </a>"。如果通过以下方式列出应用程序命名空间中的所有机密:</p><pre class="mi mj mk ml gt mm mc mn mo aw mp bi"><span id="e30f" class="mq ke iq mc b gy mr ms l mt mu">kubectl -n [your namespace] get secrets</span></pre><p id="a071" class="pw-post-body-paragraph lb lc iq ld b le md lg lh li me lk ll lm mf lo lp lq mg ls lt lu mh lw lx ly ij bi translated">您会发现发布数据机密是按发布版本列出的:</p><pre class="mi mj mk ml gt mm mc mn mo aw mp bi"><span id="14f7" class="mq ke iq mc b gy mr ms l mt mu">NAME                           TYPE                Data  AGE<br/>sh.helm.release.v1.xxxx.v3    helm.sh/release.v1   1     1d<br/>sh.helm.release.v1.xxxx.v2    helm.sh/release.v1   1     1d<br/>sh.helm.release.v1.xxxx.v1    helm.sh/release.v1   1     1d</span></pre><p id="d57a" class="pw-post-body-paragraph lb lc iq ld b le md lg lh li me lk ll lm mf lo lp lq mg ls lt lu mh lw lx ly ij bi translated">这里的“xxxx”是你的头盔部署的发布名称。而<code class="fe lz ma mb mc b">v1</code>、<code class="fe lz ma mb mc b">v2</code>、&amp;、<code class="fe lz ma mb mc b">v3</code>都是你掌舵部署的发布版本。您通常会想要修改最新的发布版本(最高版本号)。要导出<code class="fe lz ma mb mc b">v3</code>发布清单，您可以运行以下命令:</p><pre class="mi mj mk ml gt mm mc mn mo aw mp bi"><span id="d370" class="mq ke iq mc b gy mr ms l mt mu">kubectl get secrets -n [my-namespace] sh.helm.release.v1.xxxx.v3 -o json | jq .data.release -r | base64 --decode | base64 --decode | gunzip - &gt; manifest.json</span></pre><p id="a3fc" class="pw-post-body-paragraph lb lc iq ld b le md lg lh li me lk ll lm mf lo lp lq mg ls lt lu mh lw lx ly ij bi translated">请注意，要运行这个命令，您需要安装【https://github.com/stedolan/jq】(<a class="ae kc" href="https://github.com/stedolan/jq" rel="noopener ugc nofollow" target="_blank"/>)并确保<code class="fe lz ma mb mc b">base64</code> &amp; <code class="fe lz ma mb mc b">gunzip</code>可用。</p><p id="6f43" class="pw-post-body-paragraph lb lc iq ld b le md lg lh li me lk ll lm mf lo lp lq mg ls lt lu mh lw lx ly ij bi translated">命令成功运行后，您可以在JSON文件“manifest.json”中找到清单。现在，您可以使用任何文本编辑器编辑这个JSON文件。</p><h1 id="d869" class="kd ke iq bd kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la bi translated">保存修改后的清单数据</h1><p id="274d" class="pw-post-body-paragraph lb lc iq ld b le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly ij bi translated">更正清单内容后，可以通过以下命令将“manifest.json”保存回发布历史:</p><pre class="mi mj mk ml gt mm mc mn mo aw mp bi"><span id="8cdb" class="mq ke iq mc b gy mr ms l mt mu"># encode manifest.json to variable DATA<br/>DATA=`cat manifest.json | gzip -c | base64 | base64`</span><span id="58e0" class="mq ke iq mc b gy mv ms l mt mu"># patch secret with new data<br/>kubectl patch secret -n [my-namespace] sh.helm.release.v1.xxxx.v3 --type='json' -p="[{\"op\":\"replace\",\"path\":\"/data/release\",\"value\":\"$DATA\"}]"</span></pre><blockquote class="mw mx my"><p id="dcd0" class="lb lc mz ld b le md lg lh li me lk ll na mf lo lp nb mg ls lt nc mh lw lx ly ij bi translated">更新:默认情况下，macOS上的base64不会输出链接中断，但在其他平台上不会。如果您需要在其他平台(例如Linux)上运行它，您需要从输出中删除换行符。您可以改为运行以下代码:DATA = ` cat manifest . JSON | gzip-c | base64 | base64 | tr-d ' \ n \ r ' `<br/>感谢Kyle Barton在他的评论中提供了这个解决方案。</p></blockquote><p id="f968" class="pw-post-body-paragraph lb lc iq ld b le md lg lh li me lk ll lm mf lo lp lq mg ls lt lu mh lw lx ly ij bi translated">您可以使用内置的Helm命令来验证清单的正确性:</p><pre class="mi mj mk ml gt mm mc mn mo aw mp bi"><span id="13ca" class="mq ke iq mc b gy mr ms l mt mu">helm -n [my-namespace] get manifest xxxx --revision 3</span></pre><p id="9396" class="pw-post-body-paragraph lb lc iq ld b le md lg lh li me lk ll lm mf lo lp lq mg ls lt lu mh lw lx ly ij bi translated">这里，` xxxx '是您的发布名称，而` 3 '是发布历史修订/版本号。</p><h1 id="7957" class="kd ke iq bd kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la bi translated">修改头盔2发布清单？</h1><p id="07a9" class="pw-post-body-paragraph lb lc iq ld b le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly ij bi translated">修改圣盔2发布清单也是可能的，但是要麻烦得多。您可以根据自己的目的修改以下脚本:</p><p id="e541" class="pw-post-body-paragraph lb lc iq ld b le md lg lh li me lk ll lm mf lo lp lq mg ls lt lu mh lw lx ly ij bi translated"><a class="ae kc" href="https://gist.github.com/t83714/9317f8933223d3c4bd626128ee306208" rel="noopener ugc nofollow" target="_blank">https://gist . github . com/t 83714/9317 f 8933223d 3c 4 BD 626128 ee 306208</a></p></div></div>    
</body>
</html>