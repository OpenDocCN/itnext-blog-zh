<html>
<head>
<title>Developing Go Services For Kubernetes with Telepresence and konfig</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用网真和konfig为Kubernetes开发Go服务</h1>
<blockquote>原文：<a href="https://itnext.io/developing-go-services-for-kubernetes-with-telepresence-and-konfig-13018203e819?source=collection_archive---------2-----------------------#2019-07-15">https://itnext.io/developing-go-services-for-kubernetes-with-telepresence-and-konfig-13018203e819?source=collection_archive---------2-----------------------#2019-07-15</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="7e1a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">最初发表<a class="ae kl" href="https://milad.dev/posts/telepresence-with-konfig" rel="noopener ugc nofollow" target="_blank">此处</a>。</p><h1 id="99c8" class="km kn iq bd ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj bi translated">问题是</h1><p id="4dc0" class="pw-post-body-paragraph jn jo iq jp b jq lk js jt ju ll jw jx jy lm ka kb kc ln ke kf kg lo ki kj kk ij bi translated">作为一名开发人员，当您在本地机器上开发Kubernetes应用程序时，如果您想测试或调试某些东西，您有以下选择:</p><ul class=""><li id="8461" class="lp lq iq jp b jq jr ju jv jy lr kc ls kg lt kk lu lv lw lx bi translated">使用<a class="ae kl" href="https://docs.docker.com/compose" rel="noopener ugc nofollow" target="_blank"> docker-compose </a>运行的完整环境。</li><li id="07b5" class="lp lq iq jp b jq ly ju lz jy ma kc mb kg mc kk lu lv lw lx bi translated">在本地Kubernetes集群中运行的完整环境(<a class="ae kl" href="https://kubernetes.io/docs/setup/learning-environment/minikube" rel="noopener ugc nofollow" target="_blank"> Minikube </a>或<a class="ae kl" href="https://www.docker.com/products/docker-desktop" rel="noopener ugc nofollow" target="_blank"> Docker-for-Desktop </a>)</li><li id="87da" class="lp lq iq jp b jq ly ju lz jy ma kc mb kg mc kk lu lv lw lx bi translated">通过CI/CD管道推送插装代码、构建、测试和部署到一个<em class="md"> dev </em> Kubernetes集群。</li></ul><p id="b178" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">前两个选项的问题是，您获得的环境无论如何都不接近您的实际最终环境(<em class="md">准备</em>和<em class="md">生产</em>)。而且，最后一个选项对于开发人员来说非常耗时，每次都要做一个小的更改并遍历完整的CI/CD管道。</p><figure class="mf mg mh mi gt mj gh gi paragraph-image"><div role="button" tabindex="0" class="mk ml di mm bf mn"><div class="gh gi me"><img src="../Images/5da68be6579138bde875fd0b40672f22.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*cYL40oK9YGFXelgWA1Deow.png"/></div></div></figure><h1 id="cde0" class="km kn iq bd ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj bi translated">什么是网真？</h1><p id="82f4" class="pw-post-body-paragraph jn jo iq jp b jq lk js jt ju ll jw jx jy lm ka kb kc ln ke kf kg lo ki kj kk ij bi translated"><a class="ae kl" href="https://www.telepresence.io/" rel="noopener ugc nofollow" target="_blank">网真</a>是由<a class="ae kl" href="https://www.datawire.io/" rel="noopener ugc nofollow" target="_blank">数据线</a>创建的<a class="ae kl" href="https://www.cncf.io/" rel="noopener ugc nofollow" target="_blank"> CNCF </a>项目。对于开发人员来说，这是一个非常好的工具，他们可以在本地调试和测试他们的代码，而无需经历整个部署到Kubernetes集群的过程。</p><p id="9840" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">网真在一个<em class="md"> Pod </em>和一个在你的机器上本地运行的进程之间创建了一个双向网络代理。<em class="md"> TCP连接</em>、<em class="md">环境变量</em>、<em class="md">卷</em>等。从您的pod代理到本地进程。本地进程的网络也被透明地改变了，所以来自本地进程的<em class="md"> DNS </em>调用和<em class="md"> TCP连接</em>将被代理到远程Kubernetes集群。</p><p id="124f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在<a class="ae kl" href="https://www.telepresence.io/reference/install" rel="noopener ugc nofollow" target="_blank">安装</a>远程呈现后，您可以尝试以下操作:</p><pre class="mf mg mh mi gt mq mr ms mt aw mu bi"><span id="d205" class="mv kn iq mr b gy mw mx l my mz">telepresence --swap-deployment &lt;name&gt; --run-shell</span></pre><p id="685b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这将在本地运行一个<em class="md">外壳</em>，同时来自pod <code class="fe na nb nc mr b">&lt;name&gt;</code>的所有<em class="md"> TCP连接</em>、<em class="md">环境变量</em>、<em class="md">卷</em>都可用。</p><h1 id="c05f" class="km kn iq bd ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj bi translated">konfig是什么？</h1><p id="ed1e" class="pw-post-body-paragraph jn jo iq jp b jq lk js jt ju ll jw jx jy lm ka kb kc ln ke kf kg lo ki kj kk ij bi translated"><a class="ae kl" href="https://github.com/moorara/konfig" rel="noopener ugc nofollow" target="_blank"> konfig </a>是一个最小的非个人化库，用于读取Go应用中的配置值。你可以在这里阅读更多关于它和如何使用它的信息<a class="ae kl" href="https://milad.dev/projects/konfig" rel="noopener ugc nofollow" target="_blank">。使用<code class="fe na nb nc mr b">konfig</code>，读取和解析配置值就像定义一个struct一样简单！这里有一个例子:</a></p><pre class="mf mg mh mi gt mq mr ms mt aw mu bi"><span id="f7f4" class="mv kn iq mr b gy mw mx l my mz">package main</span><span id="d85d" class="mv kn iq mr b gy nd mx l my mz">import (<br/>  "fmt"<br/>  "net/url"<br/>  "time"</span><span id="c951" class="mv kn iq mr b gy nd mx l my mz">  "github.com/moorara/konfig"<br/>)</span><span id="f6dc" class="mv kn iq mr b gy nd mx l my mz">var config = struct {<br/>  Port        int<br/>  LogLevel    string<br/>  Timeout     time.Duration<br/>  DatabaseURL []url.URL<br/>} {<br/>  Port:     3000,   // default port<br/>  LogLevel: "info", // default logging level<br/>}</span><span id="ed04" class="mv kn iq mr b gy nd mx l my mz">func main() {<br/>  konfig.Pick(&amp;config)<br/>  // ...<br/>}</span></pre><h1 id="b14c" class="km kn iq bd ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj bi translated">konfig有什么帮助？</h1><p id="937a" class="pw-post-body-paragraph jn jo iq jp b jq lk js jt ju ll jw jx jy lm ka kb kc ln ke kf kg lo ki kj kk ij bi translated">当使用Kubernetes <a class="ae kl" href="https://kubernetes.io/docs/concepts/configuration/secret" rel="noopener ugc nofollow" target="_blank"> Secrets </a>时，您希望将它们作为挂载的卷和文件来访问。这样，您可以为已安装的机密设置文件权限，当您更改机密时，这些权限会自动更新。</p><p id="8a8a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在远程呈现会话中，包括所有卷的pod文件系统从<code class="fe na nb nc mr b">TELEPRESENCE_ROOT</code>环境变量中指定的路径挂载。如果你想在远程呈现会话中运行你的应用程序，就像在你的pod中一样，你需要在你的应用程序中建立一些逻辑来考虑<code class="fe na nb nc mr b">TELEPRESENCE_ROOT</code>。</p><p id="54b5" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><code class="fe na nb nc mr b">konfig</code>是一种开箱即用的解决方案，可在真实Pod环境或远程呈现会话中透明地读取您的配置值。</p><h1 id="c23f" class="km kn iq bd ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj bi translated">一个例子</h1><p id="b81f" class="pw-post-body-paragraph jn jo iq jp b jq lk js jt ju ll jw jx jy lm ka kb kc ln ke kf kg lo ki kj kk ij bi translated">你可以在这里找到这个例子<a class="ae kl" href="https://github.com/moorara/konfig/tree/master/examples/4-telepresence" rel="noopener ugc nofollow" target="_blank">的源代码。</a></p><p id="00be" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">让我们构建并推送Docker映像，然后将资源部署到Kubernetes。</p><pre class="mf mg mh mi gt mq mr ms mt aw mu bi"><span id="9627" class="mv kn iq mr b gy mw mx l my mz"># current directory: examples/4-telepresence<br/>make docker k8s-deploy</span></pre><p id="c8d2" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果我们获得了pod ( <code class="fe na nb nc mr b">kubectl logs &lt;pod_name&gt;</code>)的日志，我们应该会看到类似下面这样的内容:</p><pre class="mf mg mh mi gt mq mr ms mt aw mu bi"><span id="1dec" class="mv kn iq mr b gy mw mx l my mz">2019/07/14 23:45:54 making service-to-service calls using this token: super-strong-secret</span></pre><p id="8c18" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在，我们将看看如何使用<em class="md">网真</em>和<code class="fe na nb nc mr b">konfig</code>。首先，让我们看看网真是如何工作的。运行以下命令:</p><pre class="mf mg mh mi gt mq mr ms mt aw mu bi"><span id="73f3" class="mv kn iq mr b gy mw mx l my mz">go build -o app<br/>telepresence --swap-deployment example --run ./app</span></pre><p id="75ef" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果你运行<code class="fe na nb nc mr b">ls</code>命令，你会看到你的本地文件。如果您运行<code class="fe na nb nc mr b">env</code>命令，您会看到<code class="fe na nb nc mr b">AUTH_TOKEN_FILE</code>环境变量存在。接下来，尝试运行<code class="fe na nb nc mr b">echo $TELEPRESENCE_ROOT</code>，然后运行<code class="fe na nb nc mr b">cd $TELEPRESENCE_ROOT</code>。这是安装pod文件系统的地方。在远程呈现会话中，您需要在已挂载卷的路径前添加<code class="fe na nb nc mr b">$TELEPRESENCE_ROOT</code>。我们将看到<code class="fe na nb nc mr b">konfig</code>如何自动检测远程呈现会话，并像在pod中一样读取您的秘密。</p><p id="aa81" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在，让我们对代码进行如下更改:</p><pre class="mf mg mh mi gt mq mr ms mt aw mu bi"><span id="6438" class="mv kn iq mr b gy mw mx l my mz">konfig.Pick(&amp;Config, konfig.Telepresence(), konfig.Debug(5))<br/>log.Printf("auth token: %s", Config.AuthToken)</span></pre><p id="8fe7" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">无需构建新的Docker映像并推送它，我们只需编译我们的应用程序并使用<code class="fe na nb nc mr b">telepresence</code>命令运行它。</p><pre class="mf mg mh mi gt mq mr ms mt aw mu bi"><span id="cb7f" class="mv kn iq mr b gy mw mx l my mz">go build -o app<br/>telepresence --swap-deployment example --run ./app</span></pre><p id="4924" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">您将看到我们的应用程序正在本地运行，并且从远程呈现环境中成功读取了<code class="fe na nb nc mr b">AuthToken</code>。</p><pre class="mf mg mh mi gt mq mr ms mt aw mu bi"><span id="a602" class="mv kn iq mr b gy mw mx l my mz">2019/07/14 19:58:24 ----------------------------------------------------------------------------------------------------<br/>2019/07/14 19:58:24 Options: Debug&lt;5&gt; + Telepresence<br/>2019/07/14 19:58:24 ----------------------------------------------------------------------------------------------------<br/>2019/07/14 19:58:24 [AuthToken] expecting flag name: auth.token<br/>2019/07/14 19:58:24 [AuthToken] expecting environment variable name: AUTH_TOKEN<br/>2019/07/14 19:58:24 [AuthToken] expecting file environment variable name: AUTH_TOKEN_FILE<br/>2019/07/14 19:58:24 [AuthToken] expecting list separator: ,<br/>2019/07/14 19:58:24 [AuthToken] value read from flag auth.token:<br/>2019/07/14 19:58:24 [AuthToken] value read from environment variable AUTH_TOKEN:<br/>2019/07/14 19:58:24 [AuthToken] value read from file environment variable AUTH_TOKEN_FILE: /secrets/myappsecret/auth-token<br/>2019/07/14 19:58:24 [AuthToken] telepresence root path: /tmp/tel-deewv8wa/fs<br/>2019/07/14 19:58:24 [AuthToken] value read from file /tmp/tel-deewv8wa/fs/secrets/myappsecret/auth-token: super-strong-secret<br/>2019/07/14 19:58:24 [AuthToken] setting string value: super-strong-secret<br/>2019/07/14 19:58:24 ----------------------------------------------------------------------------------------------------<br/>2019/07/14 19:58:24 auth token: super-strong-secret</span></pre><h1 id="3232" class="km kn iq bd ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj bi translated">结论</h1><p id="6c58" class="pw-post-body-paragraph jn jo iq jp b jq lk js jt ju ll jw jx jy lm ka kb kc ln ke kf kg lo ki kj kk ij bi translated"><a class="ae kl" href="https://www.telepresence.io/" rel="noopener ugc nofollow" target="_blank">网真</a>是为Kubernetes开发应用程序的一个伟大工具。<a class="ae kl" href="https://github.com/moorara/konfig" rel="noopener ugc nofollow" target="_blank"> konfig </a>使得读取和解析Go应用程序的配置值变得极其容易。它还可以透明地读取远程呈现会话中的配置值。</p></div></div>    
</body>
</html>