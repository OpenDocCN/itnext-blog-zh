<html>
<head>
<title>Monitoring Kubernetes Control Plane using KubeSphere</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用KubeSphere监控Kubernetes控制平面</h1>
<blockquote>原文：<a href="https://itnext.io/monitoring-kubernetes-control-plane-using-kubesphere-7885461f40b1?source=collection_archive---------1-----------------------#2020-03-29">https://itnext.io/monitoring-kubernetes-control-plane-using-kubesphere-7885461f40b1?source=collection_archive---------1-----------------------#2020-03-29</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><h1 id="93e7" class="jn jo iq bd jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk bi translated">Kubernetes控制平面简介</h1><p id="97d5" class="pw-post-body-paragraph kl km iq kn b ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">在Kubernetes集群中，有两个机器角色，包括主节点和工作节点。主节点运行Kubernetes控制平面，它负责管理工作节点，做出调度决策，并实施更改以将集群驱动到所需的状态。工作节点，顾名思义，它们运行工作负载并在其上Pod。</p><figure class="lk ll lm ln gt lo gh gi paragraph-image"><div role="button" tabindex="0" class="lp lq di lr bf ls"><div class="gh gi lj"><img src="../Images/6fb07709ba51f4504983211e32673f4b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*QWJijlj7kwd0hIYk8Wsnow.png"/></div></div><figcaption class="lv lw gj gh gi lx ly bd b be z dk translated">Kubernetes控制平面</figcaption></figure><p id="ded7" class="pw-post-body-paragraph kl km iq kn b ko lz kq kr ks ma ku kv kw mb ky kz la mc lc ld le md lg lh li ij bi translated">上图显示了在Kubernetes控制平面中运行的四个组件，每个组件对于运行一个健康的Kubernetes集群都是至关重要的，它们在集群中扮演不同的角色:</p><ul class=""><li id="6906" class="me mf iq kn b ko lz ks ma kw mg la mh le mi li mj mk ml mm bi translated">kube-API server:Kubernetes控制平面的一个组件，它公开了Kubernetes API。API服务器是Kubernetes控制平面的前端。</li><li id="5efe" class="me mf iq kn b ko mn ks mo kw mp la mq le mr li mj mk ml mm bi translated"><strong class="kn ir"> etcd </strong>:一致且高度可用的键值存储，用作Kubernetes所有集群数据的后备存储。</li><li id="de59" class="me mf iq kn b ko mn ks mo kw mp la mq le mr li mj mk ml mm bi translated"><strong class="kn ir"> kube-scheduler </strong>:监视新创建的没有分配节点的pod，并选择一个节点让它们运行。</li><li id="4fca" class="me mf iq kn b ko mn ks mo kw mp la mq le mr li mj mk ml mm bi translated"><strong class="kn ir"> kube-controller-manager </strong>:通过API server watch特性监视集群的状态，并进行更改以将集群移向所需状态。</li></ul><h1 id="a2cb" class="jn jo iq bd jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk bi translated">为什么要监控控制平面</h1><p id="060f" class="pw-post-body-paragraph kl km iq kn b ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">为了保持Kubernetes集群的高可靠性，通过监控控制平面的组件，集群管理员可以更快地诊断集群中发生的调度和协调问题。因此，我们需要收集控制平面的指标来可视化实时数据，并深入挖掘每个控制平面组件的状态和性能。</p><h1 id="c24a" class="jn jo iq bd jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk bi translated">控制平面监控的工具</h1><p id="6b7d" class="pw-post-body-paragraph kl km iq kn b ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">不可否认，Prometheus是领先的开源监控解决方案。加上Grafana dashboard，它们可以成为监控Kubernetes控制面板组件的完美组合解决方案。但是，要快速设置目标指标并将其收集到一个统一的监控仪表板中，这两种方法都有点复杂。</p><p id="44ce" class="pw-post-body-paragraph kl km iq kn b ko lz kq kr ks ma ku kv kw mb ky kz la mc lc ld le md lg lh li ij bi translated">幸运的是，<a class="ae ms" href="https://github.com/kubesphere/kubesphere" rel="noopener ugc nofollow" target="_blank"> KubeSphere </a>利用这些工具，包括Prometheus、Kube-state-metrics Node-exporter、ServiceMonitor，以及PrometheusRule中的预定义规则，<strong class="kn ir">提供从应用到基础设施的现成监控指标</strong>。</p><figure class="lk ll lm ln gt lo gh gi paragraph-image"><div role="button" tabindex="0" class="lp lq di lr bf ls"><div class="gh gi mt"><img src="../Images/f198aa7f175a4588371f9f8ebf9c921f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ZUoIyymgd9s2P9gemu11Vw.png"/></div></div><figcaption class="lv lw gj gh gi lx ly bd b be z dk translated">KubeSphere监控架构</figcaption></figure><h1 id="bbf1" class="jn jo iq bd jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk bi translated">KubeSphere中的指标</h1><p id="c151" class="pw-post-body-paragraph kl km iq kn b ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">为了有效地监控控制面板组件，每个组件的运行状况和状态的可见性至关重要。您可以安装KubeSphere来轻松获得控制平面组件监控的整体洞察力，并显示时序数据。</p><h1 id="312b" class="jn jo iq bd jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk bi translated">API服务器的关键指标</h1><ul class=""><li id="a16b" class="me mf iq kn b ko kp ks kt kw mu la mv le mw li mj mk ml mm bi translated"><code class="fe mx my mz na b">apiserver_request_by_verb_latencies</code> (ms):每个动词、资源和子资源的响应延迟分布，以微秒计。</li><li id="09a0" class="me mf iq kn b ko mn ks mo kw mp la mq le mr li mj mk ml mm bi translated"><code class="fe mx my mz na b">apiserver_request_rate</code>(次/秒):apiserver请求的速率</li></ul><figure class="lk ll lm ln gt lo gh gi paragraph-image"><div role="button" tabindex="0" class="lp lq di lr bf ls"><div class="gh gi nb"><img src="../Images/5cbdf120c4e1ce939c76d795e5520af5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*d3x5fIK4rgNfjcAkVp2nEg.png"/></div></div><figcaption class="lv lw gj gh gi lx ly bd b be z dk translated">API服务器监控</figcaption></figure><h1 id="1d68" class="jn jo iq bd jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk bi translated">Etcd的关键指标</h1><ul class=""><li id="2126" class="me mf iq kn b ko kp ks kt kw mu la mv le mw li mj mk ml mm bi translated"><code class="fe mx my mz na b">has_leader</code>:领导者是否存在。</li><li id="78cd" class="me mf iq kn b ko mn ks mo kw mp la mq le mr li mj mk ml mm bi translated"><code class="fe mx my mz na b">etcd_mvcc_db_size</code> (MiB):底层数据库的总大小，以字节为单位。</li><li id="b1f5" class="me mf iq kn b ko mn ks mo kw mp la mq le mr li mj mk ml mm bi translated"><code class="fe mx my mz na b">client_grpc_sent/received_bytes_total</code> (MB/s):包括发送和接收到grpc客户端的总字节数。</li><li id="b2b1" class="me mf iq kn b ko mn ks mo kw mp la mq le mr li mj mk ml mm bi translated"><code class="fe mx my mz na b">etcd_grpc_server_msg_sent/received_rate</code>:服务器接收和发送的gRPC流消息总数。</li><li id="adf4" class="me mf iq kn b ko mn ks mo kw mp la mq le mr li mj mk ml mm bi translated"><code class="fe mx my mz na b">etcd_disk_wal_fsync_duration (ms)</code>:wal调用fsync的延迟分布。</li><li id="5865" class="me mf iq kn b ko mn ks mo kw mp la mq le mr li mj mk ml mm bi translated"><code class="fe mx my mz na b">etcd_disk_backend_commit_duration</code> (ms):描述一下你的磁盘写性能。</li><li id="b78d" class="me mf iq kn b ko mn ks mo kw mp la mq le mr li mj mk ml mm bi translated"><code class="fe mx my mz na b">Raft Proposals</code>(次/秒):raft协议确保建议被正确地应用到集群</li></ul><figure class="lk ll lm ln gt lo gh gi paragraph-image"><div role="button" tabindex="0" class="lp lq di lr bf ls"><div class="gh gi nc"><img src="../Images/b08ed35479d4e3106900c469473c4631.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*IB0TRfl8QMvVFXeUAlc5Eg.png"/></div></div><figcaption class="lv lw gj gh gi lx ly bd b be z dk translated">Etcd监控指标</figcaption></figure><h1 id="2257" class="jn jo iq bd jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk bi translated">kube-scheduler的关键指标</h1><ul class=""><li id="e8f7" class="me mf iq kn b ko kp ks kt kw mu la mv le mw li mj mk ml mm bi translated"><code class="fe mx my mz na b">scheduler_schedule_attempts</code>:根据结果，安排pod的尝试次数的差异。不可调度表示无法调度pod，而错误表示内部调度程序问题。</li><li id="85ed" class="me mf iq kn b ko mn ks mo kw mp la mq le mr li mj mk ml mm bi translated"><code class="fe mx my mz na b">scheduler_schedule_attempt_rate</code>:按结果排列的调度单元尝试次数的比率。不可调度表示无法调度pod，而错误表示内部调度程序问题。</li><li id="1637" class="me mf iq kn b ko mn ks mo kw mp la mq le mr li mj mk ml mm bi translated"><code class="fe mx my mz na b">scheduler_e2e_scheduling_latency</code>:端到端调度延迟，是调度算法延迟和绑定延迟之和。</li></ul><figure class="lk ll lm ln gt lo gh gi paragraph-image"><div role="button" tabindex="0" class="lp lq di lr bf ls"><div class="gh gi nd"><img src="../Images/7d4d3a39d96f7ef326736888a528a939.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*1vVAOzOfH2mJk1y7E2Uckg.png"/></div></div><figcaption class="lv lw gj gh gi lx ly bd b be z dk translated">kube-调度程序监控指标</figcaption></figure><h1 id="b69d" class="jn jo iq bd jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk bi translated">如何安装KubeSphere</h1><p id="3d6a" class="pw-post-body-paragraph kl km iq kn b ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated"><a class="ae ms" href="https://github.com/kubesphere/kubesphere" rel="noopener ugc nofollow" target="_blank"> KubeSphere </a>是一个分布式操作系统，提供以Kubernetes为内核的云原生栈，提供从应用到基础设施丰富的可观察性。KubeSphere支持在云托管和本地Kubernetes集群上安装，或者在Linux机器上安装。本指南仅引导您完成在现有Kubernetes集群上的安装。</p><h1 id="7d2d" class="jn jo iq bd jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk bi translated">先决条件</h1><ul class=""><li id="085c" class="me mf iq kn b ko kp ks kt kw mu la mv le mw li mj mk ml mm bi translated"><code class="fe mx my mz na b">Kubernetes version</code> : <code class="fe mx my mz na b">1.15.x, 1.16.x, 1.17.x</code></li><li id="6220" class="me mf iq kn b ko mn ks mo kw mp la mq le mr li mj mk ml mm bi translated"><code class="fe mx my mz na b">Helm version</code>&gt;=<code class="fe mx my mz na b">2.10.0</code>&lt;<code class="fe mx my mz na b">3.0</code>，参见<a class="ae ms" href="https://devopscube.com/install-configure-helm-kubernetes/" rel="noopener ugc nofollow" target="_blank">在Kubernetes </a>中安装和配置头盔；KubeSphere 3.0将支持Helm 3.0。</li><li id="c4a3" class="me mf iq kn b ko mn ks mo kw mp la mq le mr li mj mk ml mm bi translated">Kubernetes群集中的默认存储类已配置；使用<code class="fe mx my mz na b">kubectl get sc</code>进行验证。</li><li id="3a17" class="me mf iq kn b ko mn ks mo kw mp la mq le mr li mj mk ml mm bi translated">可用资源CPU &gt;= 1个内核，内存&gt; = 2G</li><li id="a9d2" class="me mf iq kn b ko mn ks mo kw mp la mq le mr li mj mk ml mm bi translated">在kube-apiserver中激活了CSR签名功能，请参见<a class="ae ms" href="https://github.com/kubesphere/kubesphere/issues/1925#issuecomment-591698309" rel="noopener ugc nofollow" target="_blank"> RKE安装问题</a>。</li></ul><h1 id="e097" class="jn jo iq bd jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk bi translated">在Kubernetes上部署KubeSphere</h1><blockquote class="ne nf ng"><p id="0cf6" class="kl km nh kn b ko lz kq kr ks ma ku kv ni mb ky kz nj mc lc ld nk md lg lh li ij bi translated"><em class="iq">不能上网？参考</em> <a class="ae ms" href="https://kubesphere.io/docs/installation/install-on-k8s-airgapped/" rel="noopener ugc nofollow" target="_blank"> <em class="iq">气隙安装</em> </a> <em class="iq">了解如何使用自己的私有注册表安装KubeSphere。</em></p></blockquote><p id="8292" class="pw-post-body-paragraph kl km iq kn b ko lz kq kr ks ma ku kv kw mb ky kz la mc lc ld le md lg lh li ij bi translated">使用kubectl安装KubeSphere，假设您的集群可以访问互联网。</p><ul class=""><li id="33f8" class="me mf iq kn b ko lz ks ma kw mg la mh le mi li mj mk ml mm bi translated">如果集群中有1个内核和2 GB RAM可用，请使用以下命令仅触发默认最小安装:</li></ul><pre class="lk ll lm ln gt nl na nm nn aw no bi"><span id="0cd3" class="np jo iq na b gy nq nr l ns nt">kubectl apply -f https://raw.githubusercontent.com/kubesphere/ks-installer/master/kubesphere-minimal.yaml</span></pre><ul class=""><li id="bd83" class="me mf iq kn b ko lz ks ma kw mg la mh le mi li mj mk ml mm bi translated">如果集群中有8个内核和16 GB RAM，请使用下面的命令安装一个完整的KubeSphere，即启用所有组件:</li></ul><pre class="lk ll lm ln gt nl na nm nn aw no bi"><span id="0893" class="np jo iq na b gy nq nr l ns nt">kubectl apply -f https://raw.githubusercontent.com/kubesphere/ks-installer/master/kubesphere-complete-setup.yaml</span></pre><p id="120b" class="pw-post-body-paragraph kl km iq kn b ko lz kq kr ks ma ku kv kw mb ky kz la mc lc ld le md lg lh li ij bi translated">验证实时日志。当您看到以下输出时，恭喜您！您现在可以在浏览器中访问KubeSphere控制台。</p><pre class="lk ll lm ln gt nl na nm nn aw no bi"><span id="2c71" class="np jo iq na b gy nq nr l ns nt">$ kubectl logs -n kubesphere-system $(kubectl get pod -n kubesphere-system -l app=ks-install -o jsonpath='{.items[0].metadata.name}') -f<br/><br/>#####################################################<br/>###              Welcome to KubeSphere!           ###<br/>#####################################################<br/>Console: http://10.128.0.34:30880<br/>Account: admin<br/>Password: P@88w0rd<br/><br/>NOTE：Please modify the default password after login.<br/>#####################################################</span></pre><figure class="lk ll lm ln gt lo gh gi paragraph-image"><div role="button" tabindex="0" class="lp lq di lr bf ls"><div class="gh gi nu"><img src="../Images/b7d38391e0c19ca4762ece134bd89788.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*0TsZG_AkO3ZyKR5oY4KdNQ.png"/></div></div><figcaption class="lv lw gj gh gi lx ly bd b be z dk translated">KubeSphere控制台</figcaption></figure><figure class="lk ll lm ln gt lo gh gi paragraph-image"><div role="button" tabindex="0" class="lp lq di lr bf ls"><div class="gh gi nd"><img src="../Images/e67587647b34b993ced3bb28f7e7102e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*xPxpbspouDNilisUl7sNYw.png"/></div></div><figcaption class="lv lw gj gh gi lx ly bd b be z dk translated">KubeSphere项目</figcaption></figure><h1 id="b831" class="jn jo iq bd jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk bi translated">启用Etcd监控</h1><ol class=""><li id="09d3" class="me mf iq kn b ko kp ks kt kw mu la mv le mw li nv mk ml mm bi translated">在您的Kubernetes集群中为etcd创建证书的秘密。</li></ol><blockquote class="ne nf ng"><p id="7df5" class="kl km nh kn b ko lz kq kr ks ma ku kv ni mb ky kz nj mc lc ld nk md lg lh li ij bi translated"><em class="iq">注意:根据您所在集群的实际ETCD证书路径创建密钥；如果ETCD没有配置证书，需要创建一个空的秘密</em></p></blockquote><ul class=""><li id="d376" class="me mf iq kn b ko lz ks ma kw mg la mh le mi li mj mk ml mm bi translated">如果ETCD已经配置了证书，请参考以下步骤(以下命令是一个示例，仅用于由<code class="fe mx my mz na b">kubeadm</code>创建的集群):</li></ul><pre class="lk ll lm ln gt nl na nm nn aw no bi"><span id="64b6" class="np jo iq na b gy nq nr l ns nt">kubectl -n kubesphere-monitoring-system create secret generic kube-etcd-client-certs  \<br/>--from-file=etcd-client-ca.crt=/etc/kubernetes/pki/etcd/ca.crt  \<br/>--from-file=etcd-client.crt=/etc/kubernetes/pki/etcd/healthcheck-client.crt  \<br/>--from-file=etcd-client.key=/etc/kubernetes/pki/etcd/healthcheck-client.key</span></pre><ul class=""><li id="34cd" class="me mf iq kn b ko lz ks ma kw mg la mh le mi li mj mk ml mm bi translated">如果ETCD尚未配置证书。</li></ul><pre class="lk ll lm ln gt nl na nm nn aw no bi"><span id="4f11" class="np jo iq na b gy nq nr l ns nt">kubectl -n kubesphere-monitoring-system create secret generic kube-etcd-client-certs</span></pre><p id="effb" class="pw-post-body-paragraph kl km iq kn b ko lz kq kr ks ma ku kv kw mb ky kz la mc lc ld le md lg lh li ij bi translated">您可以通过使用以下命令编辑ks-installer的配置图来启用可插拔组件:</p><pre class="lk ll lm ln gt nl na nm nn aw no bi"><span id="a4c0" class="np jo iq na b gy nq nr l ns nt">kubectl edit cm ks-installer -n kubesphere-system</span></pre><p id="5cd7" class="pw-post-body-paragraph kl km iq kn b ko lz kq kr ks ma ku kv kw mb ky kz la mc lc ld le md lg lh li ij bi translated">然后启用etcd，用您的地址替换Etcd地址。</p><pre class="lk ll lm ln gt nl na nm nn aw no bi"><span id="a837" class="np jo iq na b gy nq nr l ns nt">etcd: <br/>  monitoring: true <br/>  endpointIps: 192.168.0.7,192.168.0.8,192.168.0.9 <br/>  port: 2379 <br/>  tlsEnable: True</span></pre><p id="4071" class="pw-post-body-paragraph kl km iq kn b ko lz kq kr ks ma ku kv kw mb ky kz la mc lc ld le md lg lh li ij bi translated">同上，保存您的更改，并等待片刻。当您看到欢迎日志出来时，这意味着etcd监控准备就绪。</p><h1 id="763b" class="jn jo iq bd jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk bi translated">参考</h1><ul class=""><li id="ba37" class="me mf iq kn b ko kp ks kt kw mu la mv le mw li mj mk ml mm bi translated"><a class="ae ms" href="https://www.sumologic.com/blog/kubernetes-monitoring/" rel="noopener ugc nofollow" target="_blank">监控Kubernetes:监控什么(速成班，第2部分)</a></li><li id="097e" class="me mf iq kn b ko mn ks mo kw mp la mq le mr li mj mk ml mm bi translated"><a class="ae ms" href="https://kubernetes.io/docs/concepts/overview/components/" rel="noopener ugc nofollow" target="_blank"> Kubernetes组件</a></li><li id="0e6d" class="me mf iq kn b ko mn ks mo kw mp la mq le mr li mj mk ml mm bi translated"><a class="ae ms" href="https://www.datadoghq.com/blog/kubernetes-control-plane-monitoring/" rel="noopener ugc nofollow" target="_blank"> Kubernetes用Datadog监控控制平面</a></li></ul></div></div>    
</body>
</html>