<html>
<head>
<title>Simple and lean secrets management in AWS EKS using aws-ssm-operator and terraform</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用aws-ssm-operator和terraform在AWS EKS进行简单和精益的机密管理</h1>
<blockquote>原文：<a href="https://itnext.io/simple-and-lean-secrets-management-in-aws-eks-using-aws-ssm-operator-and-terraform-585f149c221a?source=collection_archive---------2-----------------------#2021-07-25">https://itnext.io/simple-and-lean-secrets-management-in-aws-eks-using-aws-ssm-operator-and-terraform-585f149c221a?source=collection_archive---------2-----------------------#2021-07-25</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="3194" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">如何使用AWS SSM参数存储作为中央机密存储，并使用aws-ssm-operator生成Kubernetes机密</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/a1a4e6cc7561458b23cca9ffaa769fd3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*ixriqp4D83LSW7Z7"/></div></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk translated">由<a class="ae kv" href="https://unsplash.com/@glenncarstenspeters?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">格伦·卡斯滕斯-彼得斯</a>在<a class="ae kv" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</figcaption></figure><h2 id="b053" class="kw kx iq bd ky kz la dn lb lc ld dp le lf lg lh li lj lk ll lm ln lo lp lq lr bi translated">介绍</h2><p id="d554" class="pw-post-body-paragraph ls lt iq lu b lv lw jr lx ly lz ju ma lf mb mc md lj me mf mg ln mh mi mj mk ij bi translated">在Kubernetes中管理秘密可能是一项艰巨的任务。一般来说，<strong class="lu ir">绝不推荐将未加密的秘密存储在任何git-repository </strong>中。这通常会导致不同开发人员或devops工程师之间分发秘密文件，这些文件不受git的版本控制，但需要以某种方式进行交换和管理。<a class="ae kv" href="https://www.vaultproject.io/" rel="noopener ugc nofollow" target="_blank"> <strong class="lu ir"> Hashicorp Vault </strong> </a>已经演变为解决这个问题的<strong class="lu ir">事实上的标准解决方案</strong>。然而，有时建立、维护和操作一个健壮的、高可用性的和适当配置的存储集群是不可行的。</p><p id="f06a" class="pw-post-body-paragraph ls lt iq lu b lv ml jr lx ly mm ju ma lf mn mc md lj mo mf mg ln mp mi mj mk ij bi translated">在这篇文章中，我将使用“<a class="ae kv" href="https://github.com/toVersus/aws-ssm-operator" rel="noopener ugc nofollow" target="_blank"> aws-ssm-operator </a>”展示一个用于AWS环境的<strong class="lu ir">精简而简单的解决方案，这是一个开源的Github项目(<a class="ae kv" href="https://github.com/toVersus/aws-ssm-operator" rel="noopener ugc nofollow" target="_blank">https://github.com/toVersus/aws-ssm-operator</a>)。</strong></p><h2 id="f84f" class="kw kx iq bd ky kz la dn lb lc ld dp le lf lg lh li lj lk ll lm ln lo lp lq lr bi translated">SSM算子</h2><p id="28ba" class="pw-post-body-paragraph ls lt iq lu b lv lw jr lx ly lz ju ma lf mb mc md lj me mf mg ln mh mi mj mk ij bi translated">AWS-SSM操作器是一个Kubernetes操作器，<strong class="lu ir">自动将保存在AWS SSM参数库中的参数映射到Kubernetes秘密</strong>中。与AWS Secrets Manager不同，AWS Secrets Manager引入了每个秘密每月0.4美元的额外费用，而AWS SSM参数存储是免费的。</p><p id="b1a0" class="pw-post-body-paragraph ls lt iq lu b lv ml jr lx ly mm ju ma lf mn mc md lj mo mf mg ln mp mi mj mk ij bi translated">让我们看看如何部署操作员。基于位于<a class="ae kv" href="https://github.com/toVersus/aws-ssm-operator#installation" rel="noopener ugc nofollow" target="_blank">https://github.com/toVersus/aws-ssm-operator#installation</a>的操作员库的安装说明，我们使用<code class="fe mq mr ms mt b"><a class="ae kv" href="https://kustomize.io/" rel="noopener ugc nofollow" target="_blank">kustomize</a></code>定义k8s对象。查看位于<a class="ae kv" href="https://github.com/yandok/aws-ssm-operator-demo.git" rel="noopener ugc nofollow" target="_blank">https://github.com/yandok/aws-ssm-operator-demo.git</a>的演示库——<code class="fe mq mr ms mt b">k8s</code>目录包含部署的基本和覆盖库定制定义:</p><pre class="kg kh ki kj gt mu mt mv mw aw mx bi"><span id="1492" class="kw kx iq mt b gy my mz l na nb">k8s<br/>├── base<br/>│   ├── 200-serviceaccount.yaml<br/>│   ├── 201-clusterrole.yaml<br/>│   ├── 202-clusterrolebinding.yaml<br/>│   ├── 300-ssm-parameterstore-v1alpha1-crd.yaml<br/>│   ├── kustomization.yaml<br/>│   └── operator.yaml<br/>├── dev<br/>│   ├── 200-serviceaccount-patch.yaml<br/>│   ├── kustomization.yaml</span></pre><p id="889d" class="pw-post-body-paragraph ls lt iq lu b lv ml jr lx ly mm ju ma lf mn mc md lj mo mf mg ln mp mi mj mk ij bi translated"><code class="fe mq mr ms mt b">deployment</code> —对象与<code class="fe mq mr ms mt b">ServiceAccount</code> <code class="fe mq mr ms mt b">aws-ssm-operator</code>一起运行，后者是用<code class="fe mq mr ms mt b">dev</code> —覆盖中的覆盖定义定制的，如:</p><pre class="kg kh ki kj gt mu mt mv mw aw mx bi"><span id="7ad5" class="kw kx iq mt b gy my mz l na nb">apiVersion: v1<br/>kind: ServiceAccount<br/>metadata:<br/>  name: aws-ssm-operator<br/>  namespace: kube-system<br/>  annotations:<br/>    <em class="nc"># Substitute your account ID and IAM service role name below.<br/>    </em>eks.amazonaws.com/role-arn: arn:aws:iam::&lt;aws-account-number&gt;:role/&lt;iam-role-name&gt;</span></pre><p id="f192" class="pw-post-body-paragraph ls lt iq lu b lv ml jr lx ly mm ju ma lf mn mc md lj mo mf mg ln mp mi mj mk ij bi translated">用<code class="fe mq mr ms mt b">kustomize build k8s/dev &gt; k8s/dev/out/dev.yaml</code>构建k8s定义，用<code class="fe mq mr ms mt b">kubectl apply -f k8s/dev/out/dev.yaml</code>部署它们。</p><h2 id="7a76" class="kw kx iq bd ky kz la dn lb lc ld dp le lf lg lh li lj lk ll lm ln lo lp lq lr bi translated">EKS-先决条件</h2><p id="4916" class="pw-post-body-paragraph ls lt iq lu b lv lw jr lx ly lz ju ma lf mb mc md lj me mf mg ln mh mi mj mk ij bi translated">为了让运营商服务账户承担kustomize-overlay中定义的AWS IAM角色，EKS集群必须提供<strong class="lu ir"> IAM OIDC身份提供者。</strong></p><p id="281c" class="pw-post-body-paragraph ls lt iq lu b lv ml jr lx ly mm ju ma lf mn mc md lj mo mf mg ln mp mi mj mk ij bi translated">如果您正在使用<a class="ae kv" href="https://registry.terraform.io/modules/terraform-aws-modules/eks/aws/latest" rel="noopener ugc nofollow" target="_blank">eks-terra form-module</a>(<a class="ae kv" href="https://registry.terraform.io/modules/terraform-aws-modules/eks/aws/latest" rel="noopener ugc nofollow" target="_blank">https://registry . terra form . io/modules/terra form-AWS-modules/eks/AWS/latest</a>)这可以通过将<code class="fe mq mr ms mt b">enable_irsa</code>-属性设置为<code class="fe mq mr ms mt b">true</code>来完成。</p><pre class="kg kh ki kj gt mu mt mv mw aw mx bi"><span id="0327" class="kw kx iq mt b gy my mz l na nb">module "eks" {<br/>  source = "terraform-aws-modules/eks/aws"<br/>  version         = "13.1.0"<br/>  cluster_version = "1.18"<br/>  cluster_name    = local.cluster_name  <br/>  ...</span><span id="f3b7" class="kw kx iq mt b gy nd mz l na nb">  <strong class="mt ir">enable_irsa = true</strong><br/>  ...<br/>}</span></pre><p id="bcf9" class="pw-post-body-paragraph ls lt iq lu b lv ml jr lx ly mm ju ma lf mn mc md lj mo mf mg ln mp mi mj mk ij bi translated">对于IAM-setup，我们定义了一个<code class="fe mq mr ms mt b"><a class="ae kv" href="https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/iam_role" rel="noopener ugc nofollow" target="_blank">aws_iam_role</a></code> <a class="ae kv" href="https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/iam_role" rel="noopener ugc nofollow" target="_blank"> —资源</a>，它允许<code class="fe mq mr ms mt b">aws-ssm-operator</code> — <code class="fe mq mr ms mt b">ServiceAccount</code>承担角色-</p><pre class="kg kh ki kj gt mu mt mv mw aw mx bi"><span id="7b4b" class="kw kx iq mt b gy my mz l na nb">resource "aws_iam_role" "aws-ssm-role" {<br/><br/>  name = "aws-ssm-role"<br/><br/>  assume_role_policy = &lt;&lt;EOF<br/>{<br/>  "Version": "2012-10-17",<br/>  "Statement": [<br/>    {<br/>      "Effect": "Allow",<br/>      "Principal": {<br/>       <strong class="mt ir"> "Federated": "${module.eks.oidc_provider_arn}"</strong><br/>      },<br/>      "Action": "sts:AssumeRoleWithWebIdentity",<br/>      "Condition": {<br/>        <strong class="mt ir">"StringEquals": {<br/>          "${local.cluster_oidc_issuer_url_short}:sub": "system:serviceaccount:kube-system:aws-ssm-operator"<br/>        }</strong><br/>      }<br/>    }<br/>  ]<br/>}<br/>EOF<br/><br/>}</span></pre><p id="10fc" class="pw-post-body-paragraph ls lt iq lu b lv ml jr lx ly mm ju ma lf mn mc md lj mo mf mg ln mp mi mj mk ij bi translated">一个<code class="fe mq mr ms mt b"><a class="ae kv" href="https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/iam_policy_attachment" rel="noopener ugc nofollow" target="_blank">aws_iam_policy_attachment</a></code> <a class="ae kv" href="https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/iam_policy_attachment" rel="noopener ugc nofollow" target="_blank"> —资源</a>将一个相关的策略附加到角色上</p><pre class="kg kh ki kj gt mu mt mv mw aw mx bi"><span id="3a68" class="kw kx iq mt b gy my mz l na nb">resource "aws_iam_policy_attachment" "aws-ssm-policy-attachment" {<br/>  name       = "aws-ssm-policy-attachment"<br/>  roles      = [aws_iam_role.aws-ssm-role.name]<br/>  policy_arn = aws_iam_policy.aws-ssm-policy.arn<br/>}</span></pre><p id="eb47" class="pw-post-body-paragraph ls lt iq lu b lv ml jr lx ly mm ju ma lf mn mc md lj mo mf mg ln mp mi mj mk ij bi translated">和一个<code class="fe mq mr ms mt b"><a class="ae kv" href="https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/iam_policy" rel="noopener ugc nofollow" target="_blank">aws_iam_policy</a></code> <a class="ae kv" href="https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/iam_policy" rel="noopener ugc nofollow" target="_blank"> —资源</a>，它允许角色访问AWS SSM参数存储中的参数。</p><pre class="kg kh ki kj gt mu mt mv mw aw mx bi"><span id="e7cb" class="kw kx iq mt b gy my mz l na nb">resource "aws_iam_policy" "aws-ssm-policy" {<br/> <br/>  # ... other configuration ...<br/>  name   = "aws-ssm-policy"<br/>  policy = &lt;&lt;EOF<br/>{<br/>    "Version": "2012-10-17",<br/>    "Statement": [<br/>        {<br/>            "Effect": "Allow",<br/>            "Action": [<br/>                "ssm:Describe*",<br/>                "ssm:Get*",<br/>                "ssm:List*"<br/>            ],<br/>            "Resource": "*"<br/>        }<br/>    ]<br/>}<br/>EOF<br/>}</span></pre><h2 id="43d1" class="kw kx iq bd ky kz la dn lb lc ld dp le lf lg lh li lj lk ll lm ln lo lp lq lr bi translated">创建k8s秘密，由aws-ssm-operator生成</h2><p id="4bcc" class="pw-post-body-paragraph ls lt iq lu b lv lw jr lx ly lz ju ma lf mb mc md lj me mf mg ln mh mi mj mk ij bi translated">现在，我们已经使用<strong class="lu ir"> IAM OIDC身份提供者</strong>创建了一个EKS集群，并提供了所需的IAM设置，我们可以定义一个k8s <code class="fe mq mr ms mt b">ParameterStore</code>，如下所示:</p><pre class="kg kh ki kj gt mu mt mv mw aw mx bi"><span id="6051" class="kw kx iq mt b gy my mz l na nb">apiVersion: ssm.aws/v1alpha1<br/>kind: ParameterStore<br/>metadata:<br/>  name: demo-parameter-store<br/>spec:<br/>  valueFrom:<br/>    parameterStoreRef:<br/>      path: /path/to/parameters</span></pre><p id="5fb8" class="pw-post-body-paragraph ls lt iq lu b lv ml jr lx ly mm ju ma lf mn mc md lj mo mf mg ln mp mi mj mk ij bi translated">aws-ssm-operator将获取该路径下管理的参数，并创建一个k8s <code class="fe mq mr ms mt b">secret</code> —包含key = parameter-name参数的对象，可以用<code class="fe mq mr ms mt b">kubectl get secret demo-parameter-store -o yaml</code>来检查。</p><h2 id="6bbb" class="kw kx iq bd ky kz la dn lb lc ld dp le lf lg lh li lj lk ll lm ln lo lp lq lr bi translated">资源</h2><div class="ne nf gp gr ng nh"><a href="https://github.com/toVersus/aws-ssm-operator" rel="noopener  ugc nofollow" target="_blank"><div class="ni ab fo"><div class="nj ab nk cl cj nl"><h2 class="bd ir gy z fp nm fr fs nn fu fw ip bi translated">GitHub-toVersus/AWS-SSM-operator:AWS SSM参数存储库的Kubernetes操作员</h2><div class="no l"><h3 class="bd b gy z fp nm fr fs nn fu fw dk translated">一个Kubernetes操作器，它自动将存储在AWS SSM参数存储中的内容映射到Kubernetes机密…</h3></div><div class="np l"><p class="bd b dl z fp nm fr fs nn fu fw dk translated">github.com</p></div></div><div class="nq l"><div class="nr l ns nt nu nq nv kp nh"/></div></div></a></div><div class="ne nf gp gr ng nh"><a href="https://docs.aws.amazon.com/eks/latest/userguide/specify-service-account-role.html" rel="noopener  ugc nofollow" target="_blank"><div class="ni ab fo"><div class="nj ab nk cl cj nl"><h2 class="bd ir gy z fp nm fr fs nn fu fw ip bi translated">将IAM角色与服务帐户相关联</h2><div class="no l"><h3 class="bd b gy z fp nm fr fs nn fu fw dk translated">在Kubernetes中，您可以通过添加以下内容来定义与集群中的服务帐户相关联的IAM角色…</h3></div><div class="np l"><p class="bd b dl z fp nm fr fs nn fu fw dk translated">docs.aws.amazon.com</p></div></div></div></a></div><p id="3cce" class="pw-post-body-paragraph ls lt iq lu b lv ml jr lx ly mm ju ma lf mn mc md lj mo mf mg ln mp mi mj mk ij bi translated"><a class="ae kv" href="https://registry.terraform.io/modules/terraform-aws-modules/eks/aws/latest" rel="noopener ugc nofollow" target="_blank">https://registry . terra form . io/modules/terra form-AWS-modules/eks/AWS/latest</a></p><div class="ne nf gp gr ng nh"><a href="https://github.com/mumoshu/aws-secret-operator" rel="noopener  ugc nofollow" target="_blank"><div class="ni ab fo"><div class="nj ab nk cl cj nl"><h2 class="bd ir gy z fp nm fr fs nn fu fw ip bi translated">GitHub-mumo Shu/AWS-secret-operator:一个Kubernetes操作器，可以自动创建和更新…</h2><div class="no l"><h3 class="bd b gy z fp nm fr fs nn fu fw dk translated">一个Kubernetes操作员，它根据AWS中存储的内容自动创建和更新Kubernetes秘密…</h3></div><div class="np l"><p class="bd b dl z fp nm fr fs nn fu fw dk translated">github.com</p></div></div><div class="nq l"><div class="nw l ns nt nu nq nv kp nh"/></div></div></a></div><div class="ne nf gp gr ng nh"><a href="https://kustomize.io/" rel="noopener  ugc nofollow" target="_blank"><div class="ni ab fo"><div class="nj ab nk cl cj nl"><h2 class="bd ir gy z fp nm fr fs nn fu fw ip bi translated">Kubernetes本地配置管理</h2><div class="no l"><h3 class="bd b gy z fp nm fr fs nn fu fw dk translated">纯声明式的配置定制方法，内置于kubectl中，可管理任意数量的…</h3></div><div class="np l"><p class="bd b dl z fp nm fr fs nn fu fw dk translated">kustomize.io</p></div></div><div class="nq l"><div class="nx l ns nt nu nq nv kp nh"/></div></div></a></div></div></div>    
</body>
</html>