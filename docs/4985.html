<html>
<head>
<title>NATScaled : Distributed Services on TailScale Network</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">NAT scaled:TailScale网络上的分布式服务</h1>
<blockquote>原文：<a href="https://itnext.io/natscaled-distributed-services-on-tailscale-network-d9947b291e57?source=collection_archive---------2-----------------------#2020-11-09">https://itnext.io/natscaled-distributed-services-on-tailscale-network-d9947b291e57?source=collection_archive---------2-----------------------#2020-11-09</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="6ec9" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">玩具应用程序在一个大规模网络中运行多个NATS服务器</p><h2 id="2698" class="kl km iq bd kn ko kp dn kq kr ks dp kt jy ku kv kw kc kx ky kz kg la lb lc ld bi translated">最终产品</h2><p id="63c3" class="pw-post-body-paragraph jn jo iq jp b jq le js jt ju lf jw jx jy lg ka kb kc lh ke kf kg li ki kj kk ij bi translated">这个<strong class="jp ir">玩具</strong>应用的目的是实验Tailscale(更多关于tailscale的内容见下文)。当我们运行应用程序(实际上是一个二进制文件)时，它将:</p><ol class=""><li id="50e4" class="lj lk iq jp b jq jr ju jv jy ll kc lm kg ln kk lo lp lq lr bi translated">要求用户通过Gmail/Microsoft/Tailscale登录</li><li id="652a" class="lj lk iq jp b jq ls ju lt jy lu kc lv kg lw kk lo lp lq lr bi translated">登录后，将启动服务器</li><li id="1ac6" class="lj lk iq jp b jq ls ju lt jy lu kc lv kg lw kk lo lp lq lr bi translated">在具有相同登录帐户的多个系统(位于任何地方)中重复步骤1和2将导致所有这些服务器彼此安全地通信，即这些服务器将形成一个集群。</li></ol><p id="7e6a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">概略地说，在三台机器上运行后，它看起来像这样:</p><figure class="ly lz ma mb gt mc gh gi paragraph-image"><div role="button" tabindex="0" class="md me di mf bf mg"><div class="gh gi lx"><img src="../Images/8d8c48ca1936353c0e4ae71efeee2a3e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*vqWpcoqxQpWLr-uOW2p7Uw.png"/></div></div><figcaption class="mj mk gj gh gi ml mm bd b be z dk translated">图1:三台NAT服务器(机器)使用Tailscale相互连接(点对点)。[ <em class="mn">箭头是双向的，但为了美观，画的是单向的] </em></figcaption></figure><p id="d45d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">科技栈:</strong> <a class="ae mo" href="https://golang.org/" rel="noopener ugc nofollow" target="_blank"> Go </a>，<a class="ae mo" href="https://tailscale.com/" rel="noopener ugc nofollow" target="_blank"> TailScale </a>，<a class="ae mo" href="https://docs.nats.io/" rel="noopener ugc nofollow" target="_blank"> NATS </a></p><p id="a492" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在让我们试着一层一层地剥开它</p><h2 id="8e14" class="kl km iq bd kn ko kp dn kq kr ks dp kt jy ku kv kw kc kx ky kz kg la lb lc ld bi translated">海军运输航空处(Naval Air Transport Service)</h2><p id="4336" class="pw-post-body-paragraph jn jo iq jp b jq le js jt ju lf jw jx jy lg ka kb kc lh ke kf kg li ki kj kk ij bi translated">想象一下这样一种情况，作为开发人员，您的任务是创建一个发布事件(用户事件)的服务，这些事件由多个服务(分析、通知)消费。如果你打算使用NATS套餐，这是你要经历的</p><ol class=""><li id="8332" class="lj lk iq jp b jq jr ju jv jy ll kc lm kg ln kk lo lp lq lr bi translated">在计算机中启动NATS服务器</li><li id="dfee" class="lj lk iq jp b jq ls ju lt jy lu kc lv kg lw kk lo lp lq lr bi translated">创建使用NATS发布者客户端向主题发布消息的服务</li><li id="2bf2" class="lj lk iq jp b jq ls ju lt jy lu kc lv kg lw kk lo lp lq lr bi translated">使用NATS订阅服务器创建订阅服务，以订阅已发布的主题</li></ol><figure class="ly lz ma mb gt mc gh gi paragraph-image"><div role="button" tabindex="0" class="md me di mf bf mg"><div class="gh gi mp"><img src="../Images/815e117a0c77884264300eaf298eaf6b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Pm05yzp1AqVd8HG3HAoC5w.png"/></div></div><figcaption class="mj mk gj gh gi ml mm bd b be z dk translated">图2:一个NATS发布者客户端在主题“foo”下发布，2个NATS订阅者客户端正在收听“foo”下的事件</figcaption></figure><p id="b256" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在生产环境中，为了避免单点故障和许多其他原因，我们需要2台以上的服务器。NATS服务器支持将多台机器组合成集群，允许服务器相互通信(图3)。</p><figure class="ly lz ma mb gt mc gh gi paragraph-image"><div role="button" tabindex="0" class="md me di mf bf mg"><div class="gh gi mq"><img src="../Images/6a3663de6c937c12b4d87ce6379cfce8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*T99UlSicpiyZxwuW9q5QtA.png"/></div></div><figcaption class="mj mk gj gh gi ml mm bd b be z dk translated">图3:与图2相同，但是多个NATS服务器形成一个集群</figcaption></figure><p id="1e1e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">为了让NATS服务器组成一个集群，它们需要知道现有集群中至少一个 其他服务器的<a class="ae mo" href="https://docs.nats.io/nats-server/nats_admin/upgrading_cluster#seed-servers" rel="noopener ugc nofollow" target="_blank"> <em class="mr">的IP地址，也就是说，每次我们(重新)启动一个服务器时，我们都需要用集群中任何其他正在运行的服务器的IP信息来播种它。这个识别其他服务的过程通常被称为服务发现。</em></a></p><p id="d0de" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果每次都给服务器分配动态IP地址，任务会变得更加麻烦。有各种各样的解决方案可以解决这个问题，但是我们将使用Tailscale进行实验(非常非常规！).</p><h2 id="1572" class="kl km iq bd kn ko kp dn kq kr ks dp kt jy ku kv kw kc kx ky kz kg la lb lc ld bi translated">尾秤</h2><p id="670f" class="pw-post-body-paragraph jn jo iq jp b jq le js jt ju lf jw jx jy lg ka kb kc lh ke kf kg li ki kj kk ij bi translated"><a class="ae mo" href="https://tailscale.com/" rel="noopener ugc nofollow" target="_blank"> Tailscale </a>在设备(或机器)之间创建一个<strong class="jp ir">专用网络，</strong></p><ol class=""><li id="66ad" class="lj lk iq jp b jq jr ju jv jy ll kc lm kg ln kk lo lp lq lr bi translated">你可以在你的笔记本电脑，手机，云服务器，树莓派，大脑的小脑里安装Tailscale应用程序[这里不严肃！]等…</li><li id="c1ea" class="lj lk iq jp b jq ls ju lt jy lu kc lv kg lw kk lo lp lq lr bi translated">使用谷歌/微软/Tailscale登录</li><li id="3fd7" class="lj lk iq jp b jq ls ju lt jy lu kc lv kg lw kk lo lp lq lr bi translated">所有这些设备都将通过专用网络连接。</li></ol><figure class="ly lz ma mb gt mc gh gi paragraph-image"><div role="button" tabindex="0" class="md me di mf bf mg"><div class="gh gi ms"><img src="../Images/cc0dd346d90c397952539a501a0ad1ad.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*egAzZP-ZGjBTV_Ml_PnNfA.png"/></div></div><figcaption class="mj mk gj gh gi ml mm bd b be z dk translated">图4:借用自<a class="ae mo" href="https://tailscale.com/" rel="noopener ugc nofollow" target="_blank"> tailscale </a>的图片，展示了如何在没有VPN网关或跳线盒的情况下直接连接到多台机器</figcaption></figure><p id="31d7" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><em class="mr">对其工作感兴趣的人，请阅读</em> <a class="ae mo" href="https://tailscale.com/blog/how-tailscale-works/" rel="noopener ugc nofollow" target="_blank"> <em class="mr">这篇</em> </a> <em class="mr">牛逼的帖子。</em></p><p id="ccbf" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">除了提供安全的点对点专用网络，tailscale还确保为每台设备分配一个唯一的Tailscale IP地址，该地址对于登录帐户保持不变。</p></div><div class="ab cl mt mu hu mv" role="separator"><span class="mw bw bk mx my mz"/><span class="mw bw bk mx my mz"/><span class="mw bw bk mx my"/></div><div class="ij ik il im in"><p id="985f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在我们已经看到了零件，让我们开始组装玩具吧</p><h2 id="3e5e" class="kl km iq bd kn ko kp dn kq kr ks dp kt jy ku kv kw kc kx ky kz kg la lb lc ld bi translated">驯养</h2><p id="39ec" class="pw-post-body-paragraph jn jo iq jp b jq le js jt ju lf jw jx jy lg ka kb kc lh ke kf kg li ki kj kk ij bi translated">当我们在机器上运行tailscale应用程序时，Tailscale守护进程开始与协调服务器通信。<a class="ae mo" href="https://github.com/nnanto/tamed" rel="noopener ugc nofollow" target="_blank">Tamed</a>(Tailscale As Membership Discovery)是一个<strong class="jp ir"> tailscale客户端库</strong>，它监听来自Tailscale守护进程的事件，并维护对等体的成员信息。</p><figure class="ly lz ma mb gt mc gh gi paragraph-image"><div role="button" tabindex="0" class="md me di mf bf mg"><div class="gh gi na"><img src="../Images/db081ef48b1c39746699bb4c36197820.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Q-gOO43q0EnkAmH0mcMdrQ.png"/></div></div><figcaption class="mj mk gj gh gi ml mm bd b be z dk translated">图5:驯服客户在尾秤堆栈中的位置描述。机器之间的通信仍然以对等的方式进行</figcaption></figure><p id="ee92" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">被驯服的客户端公开了AllPeers()   <em class="mr"> </em>函数，我们可以用它来获取对等体的Tailscale IP地址。此外，当前的实现也运行Tailscale守护进程(即，你不需要安装Tailscale应用程序),因为ping请求更新在Mac上仍然不可用，但听说它正在路上</p><blockquote class="nb nc nd"><p id="88cd" class="jn jo mr jp b jq jr js jt ju jv jw jx ne jz ka kb nf kd ke kf ng kh ki kj kk ij bi translated">声明:驯服是我个人的实现，它甚至没有接近生产就绪。请将其用于概念验证或用作<a class="ae mo" href="https://github.com/nnanto/tamed/blob/main/example/client/client.go" rel="noopener ugc nofollow" target="_blank">参考</a>。</p></blockquote><h2 id="39b5" class="kl km iq bd kn ko kp dn kq kr ks dp kt jy ku kv kw kc kx ky kz kg la lb lc ld bi translated">NATScaled</h2><p id="67eb" class="pw-post-body-paragraph jn jo iq jp b jq le js jt ju lf jw jx jy lg ka kb kc lh ke kf kg li ki kj kk ij bi translated">既然我们可以获得所有对等体的IP地址(在运行时当前连接到tailscale ),我们可以通过提及集群中其他服务器的可能路由来启动NATS服务器。NATS将负责新服务器的启用和停用。希望图1现在更有意义。</p><p id="a5ef" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">NATScaled是运行在tailscale网络上的NATS服务器的一个示例实现。它首先启动提供对等体列表的被驯服的客户端，然后启动NATS服务器并通知服务器我们的tailscale网络中所有可能的对等体。</p><h2 id="ea63" class="kl km iq bd kn ko kp dn kq kr ks dp kt jy ku kv kw kc kx ky kz kg la lb lc ld bi translated">到处跑</h2><p id="d094" class="pw-post-body-paragraph jn jo iq jp b jq le js jt ju lf jw jx jy lg ka kb kc lh ke kf kg li ki kj kk ij bi translated">多亏了GoLang和它的交叉编译，我们可以用一个命令为其他平台生成二进制文件。<em class="mr">(所以还不需要码头工人)</em></p><figure class="ly lz ma mb gt mc gh gi paragraph-image"><div role="button" tabindex="0" class="md me di mf bf mg"><div class="gh gi nh"><img src="../Images/419fa9270c2e2f1134ab62304553a0c1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*IEEid9WnkXno4JkMarM5kg.png"/></div></div><figcaption class="mj mk gj gh gi ml mm bd b be z dk translated">图6:在美国各地运行NATScaled</figcaption></figure><p id="062f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">由于<a class="ae mo" href="https://github.com/nnanto/natscaled" rel="noopener ugc nofollow" target="_blank"> NATScaled </a>二进制包含tailscale和NATS服务器，我只需运行`<strong class="jp ir"> <em class="mr"> sudo。/NAT scaled-TSD</em></strong><em class="mr">`</em>in</p><ol class=""><li id="81b0" class="lj lk iq jp b jq jr ju jv jy ll kc lm kg ln kk lo lp lq lr bi translated">我的个人笔记本电脑(加州)</li><li id="a014" class="lj lk iq jp b jq ls ju lt jy lu kc lv kg lw kk lo lp lq lr bi translated">Azure虚拟机(美国中部)</li><li id="6480" class="lj lk iq jp b jq ls ju lt jy lu kc lv kg lw kk lo lp lq lr bi translated">我朋友的笔记本电脑(纽约)</li></ol><p id="6969" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">让NATServer在我们的三台机器上安全地运行和通信。</p><p id="7de3" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><em class="mr">运行NATScaled启动tailscale守护进程，驯服客户端，通知NATS服务器的对等点，并启动NATS服务器</em></p><h2 id="ec8c" class="kl km iq bd kn ko kp dn kq kr ks dp kt jy ku kv kw kc kx ky kz kg la lb lc ld bi translated">等等……你意识到了吗？</h2><ol class=""><li id="d861" class="lj lk iq jp b jq le ju lf jy ni kc nj kg nk kk lo lp lq lr bi translated">我没有撞到防火墙或NAT穿越或开放端口。</li><li id="935b" class="lj lk iq jp b jq ls ju lt jy lu kc lv kg lw kk lo lp lq lr bi translated">我不必跨机器处理TLS证书。</li><li id="542f" class="lj lk iq jp b jq ls ju lt jy lu kc lv kg lw kk lo lp lq lr bi translated">人们甚至可以在Android/iOS上运行它(尽管TAMED现在还不能工作)</li><li id="361b" class="lj lk iq jp b jq ls ju lt jy lu kc lv kg lw kk lo lp lq lr bi translated">我只需要从那台机器上登录到Google/Microsoft/Tailscale就可以连接这些机器了。</li><li id="f74a" class="lj lk iq jp b jq ls ju lt jy lu kc lv kg lw kk lo lp lq lr bi translated">NATS服务器只是为了展示，您可以通过使用Tailscale作为引擎盖下的成员发现来实现自己的系统。</li></ol><p id="2719" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">简单来说，Tailscale就是牛逼！这只是一个玩具应用程序，但我希望看到有趣的应用程序将建立在Tailscale。</p><p id="bc9a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><em class="mr"> P.S:我最初试图通过在所有设备上运行git server并同步存储库(目录)来创建一个共享目录。对于玩具应用程序来说，这似乎是太多的工作了，但是你可以考虑一下！</em></p></div></div>    
</body>
</html>