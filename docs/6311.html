<html>
<head>
<title>A bash solution for docker and iptables conflict</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">docker和iptables冲突的bash解决方案</h1>
<blockquote>原文：<a href="https://itnext.io/a-bash-solution-for-docker-and-iptables-conflict-498d5209fb0c?source=collection_archive---------3-----------------------#2021-10-14">https://itnext.io/a-bash-solution-for-docker-and-iptables-conflict-498d5209fb0c?source=collection_archive---------3-----------------------#2021-10-14</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div class="gh gi jn"><img src="../Images/40682b457b19b5027c8057d63a724d01.png" data-original-src="https://miro.medium.com/v2/resize:fit:990/format:webp/1*DN537IIL9Ue3002VuouMrg.png"/></div></figure><p id="2e7e" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">如果您曾经试图在运行docker守护进程的同一台机器上设置防火墙规则，您可能已经注意到docker(默认情况下)操纵您的iptables链。如果你想完全控制你的iptables规则，这可能是一个问题。</p><h1 id="9ea5" class="ks kt iq bd ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp bi translated">Docker和iptables</h1><p id="af62" class="pw-post-body-paragraph ju jv iq jw b jx lq jz ka kb lr kd ke kf ls kh ki kj lt kl km kn lu kp kq kr ij bi translated">Docker使用iptables“NAT”来解析进出其容器的数据包，并使用“filter”进行隔离，默认情况下，docker会在iptables设置中创建一些链:</p><pre class="lv lw lx ly gt lz ma mb mc aw md bi"><span id="6143" class="me kt iq ma b gy mf mg l mh mi">sudo iptables -L<br/><br/>Chain INPUT (policy ACCEPT)<br/>target     prot opt source               destination         <br/><br/>Chain FORWARD (policy DROP)<br/>target     prot opt source               destination         <br/>DOCKER-USER  all  --  anywhere             anywhere            <br/>DOCKER-ISOLATION-STAGE-1  all  --  anywhere             anywhere            <br/>ACCEPT     all  --  anywhere             anywhere             ctstate RELATED,ESTABLISHED<br/>DOCKER     all  --  anywhere             anywhere            <br/>ACCEPT     all  --  anywhere             anywhere            <br/>ACCEPT     all  --  anywhere             anywhere            <br/><br/>Chain OUTPUT (policy ACCEPT)<br/>target     prot opt source               destination         <br/><br/>Chain DOCKER (1 references)<br/>target     prot opt source               destination         <br/><br/>Chain DOCKER-INGRESS (0 references)<br/>target     prot opt source               destination         <br/><br/>Chain DOCKER-ISOLATION-STAGE-1 (1 references)<br/>target     prot opt source               destination         <br/>DOCKER-ISOLATION-STAGE-2  all  --  anywhere             anywhere            <br/>RETURN     all  --  anywhere             anywhere            <br/><br/>Chain DOCKER-ISOLATION-STAGE-2 (1 references)<br/>target     prot opt source               destination         <br/>DROP       all  --  anywhere             anywhere            <br/>RETURN     all  --  anywhere             anywhere            <br/><br/>Chain DOCKER-USER (1 references)<br/>target     prot opt source               destination         <br/>RETURN     all  --  anywhere             anywhere</span></pre><p id="9e1d" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">例如，现在我们需要向外界公开我们的nginx容器:</p><pre class="lv lw lx ly gt lz ma mb mc aw md bi"><span id="eca0" class="me kt iq ma b gy mf mg l mh mi">docker run --name some-nginx -d -p 8080:80 nginx:latest<br/>47a12adff13aa7609020a1aa0863b0dff192fbcf29507788a594e8b098ffe47a<br/><br/>docker ps<br/>CONTAINER ID   IMAGE          COMMAND                  CREATED          STATUS          PORTS                                   NAMES<br/>47a12adff13a   nginx:latest   "/docker-entrypoint.…"   27 seconds ago   Up 24 seconds   0.0.0.0:8080-&gt;80/tcp, :::8080-&gt;80/tcp   some-nginx</span></pre><p id="1f53" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">现在我们可以进入nginx的默认页面:</p><pre class="lv lw lx ly gt lz ma mb mc aw md bi"><span id="45f9" class="me kt iq ma b gy mf mg l mh mi">curl -v http://192.168.25.200:8080<br/><br/>*   Trying 192.168.25.200:8080...<br/>* TCP_NODELAY set<br/>* Connected to 192.168.25.200 (192.168.25.200) port 8080 (#0)<br/>&gt; GET / HTTP/1.1<br/>&gt; Host: 192.168.25.200:8080<br/>&gt; User-Agent: curl/7.68.0<br/>&gt; Accept: */*<br/>&gt; <br/>* Mark bundle as not supporting multiuse<br/>&lt; HTTP/1.1 200 OK<br/>&lt; Server: nginx/1.21.1<br/>&lt; Date: Thu, 14 Oct 2021 10:31:38 GMT<br/>&lt; Content-Type: text/html<br/>&lt; Content-Length: 612<br/>&lt; Last-Modified: Tue, 06 Jul 2021 14:59:17 GMT<br/>&lt; Connection: keep-alive<br/>&lt; ETag: "60e46fc5-264"<br/>&lt; Accept-Ranges: bytes<br/>&lt; <br/>&lt;!DOCTYPE html&gt;<br/>&lt;html&gt;<br/>&lt;head&gt;<br/>&lt;title&gt;Welcome to nginx!&lt;/title&gt;<br/>&lt;style&gt;<br/>    body {<br/>        width: 35em;<br/>        margin: 0 auto;<br/>        font-family: Tahoma, Verdana, Arial, sans-serif;<br/>    }<br/>...<br/>* Connection #0 to host 192.168.25.200 left intact</span></pre><p id="632e" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated"><strong class="jw ir">注意</strong>使用外部机器进行连接测试，而不是运行docker容器的同一台机器。</p><p id="62c6" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">添加的“神奇”iptables规则也允许我们的容器到达外部世界:</p><pre class="lv lw lx ly gt lz ma mb mc aw md bi"><span id="ec48" class="me kt iq ma b gy mf mg l mh mi">docker run --rm nginx curl ipinfo.io/ip<br/>  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current<br/>                                 Dload  Upload   Total   Spent    Left  Speed<br/>100    15  100    15    0     0     94      0 --:--:-- --:--:-- --:--:--    94<br/><br/>1.2.3.4</span></pre><p id="7566" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">现在看看我们的iptables规则发生了什么变化:</p><pre class="lv lw lx ly gt lz ma mb mc aw md bi"><span id="b41c" class="me kt iq ma b gy mf mg l mh mi">iptables -L<br/><br/>...<br/>Chain DOCKER (1 references)<br/>target     prot opt source               destination         <br/>ACCEPT     tcp  --  anywhere             172.17.0.2           tcp dpt:http<br/>...</span></pre><p id="9e7f" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">一条新的规则出现了，但不是唯一加到我们锁链上的规则。</p><p id="caec" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">为了更详细地查看我们的iptables链，我们可以使用<em class="mj"> iptables-save </em>来转储完整的iptables规则:</p><pre class="lv lw lx ly gt lz ma mb mc aw md bi"><span id="a398" class="me kt iq ma b gy mf mg l mh mi"># Generated by iptables-save v1.8.4 on Thu Oct 14 12:32:46 2021<br/>*mangle<br/>:PREROUTING ACCEPT [33102:3022248]<br/>:INPUT ACCEPT [33102:3022248]<br/>:FORWARD ACCEPT [0:0]<br/>:OUTPUT ACCEPT [32349:12119113]<br/>:POSTROUTING ACCEPT [32357:12120329]<br/>COMMIT<br/># Completed on Thu Oct 14 12:32:46 2021<br/># Generated by iptables-save v1.8.4 on Thu Oct 14 12:32:46 2021<br/>*nat<br/>:PREROUTING ACCEPT [1:78]<br/>:INPUT ACCEPT [1:78]<br/>:OUTPUT ACCEPT [13:1118]<br/>:POSTROUTING ACCEPT [13:1118]<br/>:DOCKER - [0:0]<br/>:DOCKER-INGRESS - [0:0]<br/>-A PREROUTING -m addrtype --dst-type LOCAL -j DOCKER<br/>-A OUTPUT ! -d 127.0.0.0/8 -m addrtype --dst-type LOCAL -j DOCKER<br/>-A POSTROUTING -s 172.17.0.0/16 ! -o docker0 -j MASQUERADE<br/>-A POSTROUTING -s 172.17.0.2/32 -d 172.17.0.2/32 -p tcp -m tcp --dport 80 -j MASQUERADE<br/>-A DOCKER -i docker0 -j RETURN<br/>-A DOCKER ! -i docker0 -p tcp -m tcp --dport 8080 -j DNAT --to-destination 172.17.0.2:80<br/>COMMIT<br/># Completed on Thu Oct 14 12:32:46 2021<br/># Generated by iptables-save v1.8.4 on Thu Oct 14 12:32:46 2021<br/>*filter<br/>:INPUT ACCEPT [4758:361293]<br/>:FORWARD DROP [0:0]<br/>:OUTPUT ACCEPT [4622:357552]<br/>:DOCKER - [0:0]<br/>:DOCKER-INGRESS - [0:0]<br/>:DOCKER-ISOLATION-STAGE-1 - [0:0]<br/>:DOCKER-ISOLATION-STAGE-2 - [0:0]<br/>:DOCKER-USER - [0:0]<br/>-A FORWARD -j DOCKER-USER<br/>-A FORWARD -j DOCKER-ISOLATION-STAGE-1<br/>-A FORWARD -o docker0 -m conntrack --ctstate RELATED,ESTABLISHED -j ACCEPT<br/>-A FORWARD -o docker0 -j DOCKER<br/>-A FORWARD -i docker0 ! -o docker0 -j ACCEPT<br/>-A FORWARD -i docker0 -o docker0 -j ACCEPT<br/>-A DOCKER -d 172.17.0.2/32 ! -i docker0 -o docker0 -p tcp -m tcp --dport 80 -j ACCEPT<br/>-A DOCKER-ISOLATION-STAGE-1 -i docker0 ! -o docker0 -j DOCKER-ISOLATION-STAGE-2<br/>-A DOCKER-ISOLATION-STAGE-1 -j RETURN<br/>-A DOCKER-ISOLATION-STAGE-2 -o docker0 -j DROP<br/>-A DOCKER-ISOLATION-STAGE-2 -j RETURN<br/>-A DOCKER-USER -j RETURN<br/>COMMIT<br/># Completed on Thu Oct 14 12:32:46 2021</span></pre><p id="6cd6" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">在我们的转储中，我们可以看到docker添加的一些其他规则:</p><p id="4b4e" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated"><strong class="jw ir"> DOCKER-INGRESS (nat表)</strong></p><pre class="lv lw lx ly gt lz ma mb mc aw md bi"><span id="ea10" class="me kt iq ma b gy mf mg l mh mi">-A POSTROUTING -s 172.17.0.0/16 ! -o docker0 -j MASQUERADE<br/>-A POSTROUTING -s 172.17.0.2/32 -d 172.17.0.2/32 -p tcp -m tcp --dport 80 -j MASQUERADE<br/>-A DOCKER -i docker0 -j RETURN<br/>-A DOCKER ! -i docker0 -p tcp -m tcp --dport 8080 -j DNAT --to-destination 172.17.0.2:80</span></pre><p id="300a" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated"><strong class="jw ir"> DOCKER-USER(过滤表)</strong></p><pre class="lv lw lx ly gt lz ma mb mc aw md bi"><span id="725c" class="me kt iq ma b gy mf mg l mh mi">-A POSTROUTING -s 172.17.0.0/16 ! -o docker0 -j MASQUERADE<br/>-A POSTROUTING -s 172.17.0.2/32 -d 172.17.0.2/32 -p tcp -m tcp --dport 80 -j MASQUERADE<br/>-A DOCKER -i docker0 -j RETURN<br/>-A DOCKER ! -i docker0 -p tcp -m tcp --dport 8080 -j DNAT --to-destination 172.17.0.2:80</span></pre><p id="47c5" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">要详细了解iptables和docker的工作原理:</p><ul class=""><li id="b16d" class="mk ml iq jw b jx jy kb kc kf mm kj mn kn mo kr mp mq mr ms bi translated">Docker <a class="ae mt" href="https://docs.docker.com/network/iptables/" rel="noopener ugc nofollow" target="_blank"> docs </a></li><li id="137e" class="mk ml iq jw b jx mu kb mv kf mw kj mx kn my kr mp mq mr ms bi translated">Docker论坛<a class="ae mt" href="https://forums.docker.com/t/understanding-iptables-rules-added-by-docker/77210" rel="noopener ugc nofollow" target="_blank">问题</a></li><li id="dcab" class="mk ml iq jw b jx mu kb mv kf mw kj mx kn my kr mp mq mr ms bi translated">来自x-yuri的<a class="ae mt" href="https://gist.github.com/x-yuri/abf90a18895c62f8d4c9e4c0f7a5c188" rel="noopener ugc nofollow" target="_blank">要点</a></li><li id="3491" class="mk ml iq jw b jx mu kb mv kf mw kj mx kn my kr mp mq mr ms bi translated">argus-sec.com<a class="ae mt" href="https://argus-sec.com/docker-networking-behind-the-scenes/" rel="noopener ugc nofollow" target="_blank">岗位</a></li></ul><h1 id="0434" class="ks kt iq bd ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp bi translated">问题是</h1><p id="49c8" class="pw-post-body-paragraph ju jv iq jw b jx lq jz ka kb lr kd ke kf ls kh ki kj lt kl km kn lu kp kq kr ij bi translated">但是如果我们停止并重启防火墙会发生什么呢？</p><pre class="lv lw lx ly gt lz ma mb mc aw md bi"><span id="e29a" class="me kt iq ma b gy mf mg l mh mi">systemctl stop ufw|firewalld # &lt;- the service (ufw or firewalld) may change from distro to distro<br/>systemctl stop ufw|firewalld<br/><br/><br/>curl -v http://192.168.25.200:8080<br/>*   Trying 192.168.25.200:8080...<br/>* TCP_NODELAY set<br/><br/><br/>docker run --rm nginx curl ipinfo.io/ip<br/>  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current<br/>                                 Dload  Upload   Total   Spent    Left  Speed<br/>  0     0    0     0    0     0      0      0 --:--:--  0:00:06 --:--:--     0</span></pre><p id="8498" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">我们可以看到:</p><ul class=""><li id="5e0e" class="mk ml iq jw b jx jy kb kc kf mm kj mn kn mo kr mp mq mr ms bi translated">我们的容器从外部世界是无法到达的</li><li id="867c" class="mk ml iq jw b jx mu kb mv kf mw kj mx kn my kr mp mq mr ms bi translated">我们的容器无法访问互联网</li></ul><h1 id="9d96" class="ks kt iq bd ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp bi translated">解决方案</h1><p id="a6b4" class="pw-post-body-paragraph ju jv iq jw b jx lq jz ka kb lr kd ke kf ls kh ki kj lt kl km kn lu kp kq kr ij bi translated">这个问题的<a class="ae mt" href="https://github.com/garutilorenzo/iptables-docker" rel="noopener ugc nofollow" target="_blank">解决方案</a>是一个简单的bash脚本(结合awk脚本)来管理我们的iptables规则。简而言之，该脚本解析<em class="mj"> iptables-save </em>命令的输出，并保留一组链。保存下来的链条有:</p><p id="a8af" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">对于表格nat:</p><ul class=""><li id="9131" class="mk ml iq jw b jx jy kb kc kf mm kj mn kn mo kr mp mq mr ms bi translated">邮政路由</li><li id="1eba" class="mk ml iq jw b jx mu kb mv kf mw kj mx kn my kr mp mq mr ms bi translated">预路由</li><li id="c16d" class="mk ml iq jw b jx mu kb mv kf mw kj mx kn my kr mp mq mr ms bi translated">码头工人</li><li id="4a86" class="mk ml iq jw b jx mu kb mv kf mw kj mx kn my kr mp mq mr ms bi translated">码头入口</li><li id="b388" class="mk ml iq jw b jx mu kb mv kf mw kj mx kn my kr mp mq mr ms bi translated">输出</li></ul><p id="2a3c" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">对于表格过滤器:</p><ul class=""><li id="3442" class="mk ml iq jw b jx jy kb kc kf mm kj mn kn mo kr mp mq mr ms bi translated">向前</li><li id="508c" class="mk ml iq jw b jx mu kb mv kf mw kj mx kn my kr mp mq mr ms bi translated">对接-隔离-第一阶段</li><li id="62c7" class="mk ml iq jw b jx mu kb mv kf mw kj mx kn my kr mp mq mr ms bi translated">对接-隔离-第二阶段</li><li id="e75b" class="mk ml iq jw b jx mu kb mv kf mw kj mx kn my kr mp mq mr ms bi translated">码头工人</li><li id="5b77" class="mk ml iq jw b jx mu kb mv kf mw kj mx kn my kr mp mq mr ms bi translated">码头入口</li><li id="544f" class="mk ml iq jw b jx mu kb mv kf mw kj mx kn my kr mp mq mr ms bi translated">码头工人-用户</li></ul><h1 id="eabe" class="ks kt iq bd ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp bi translated">安装iptables-docker</h1><p id="8dbb" class="pw-post-body-paragraph ju jv iq jw b jx lq jz ka kb lr kd ke kf ls kh ki kj lt kl km kn lu kp kq kr ij bi translated">第一步是克隆<a class="ae mt" href="https://github.com/garutilorenzo/iptables-docker" rel="noopener ugc nofollow" target="_blank">这个</a>库</p><h2 id="153e" class="me kt iq bd ku mz na dn ky nb nc dp lc kf nd ne lg kj nf ng lk kn nh ni lo nj bi translated">本地安装(sh)</h2><p id="74ec" class="pw-post-body-paragraph ju jv iq jw b jx lq jz ka kb lr kd ke kf ls kh ki kj lt kl km kn lu kp kq kr ij bi translated"><strong class="jw ir">注意</strong>这种安装使用静态文件(src/iptables-docker.sh)。默认情况下<strong class="jw ir">只允许</strong> ssh访问本地机器。要允许特定的流量，您必须使用自己的规则手动编辑该文件:</p><pre class="lv lw lx ly gt lz ma mb mc aw md bi"><span id="3da2" class="me kt iq ma b gy mf mg l mh mi"># Other firewall rules<br/># insert here your firewall rules<br/>$IPT -A INPUT -p tcp --dport 1234 -m state --state NEW -s 0.0.0.0/0 -j ACCEPT</span></pre><p id="e2b1" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated"><strong class="jw ir">注2 </strong>如果您使用群集群，取消注释<em class="mj">群模式下的行——取消注释以启用群访问(调整源局域网)</em>并调整您的局域网子网</p><p id="69bf" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">要在本地机器上安装iptables-docker，克隆这个存储库并运行<em class="mj"> sudo sh install.sh </em></p><pre class="lv lw lx ly gt lz ma mb mc aw md bi"><span id="c7d5" class="me kt iq ma b gy mf mg l mh mi">sudo sh install.sh <br/><br/>Set iptables to iptables-legacy<br/>Disable ufw,firewalld<br/>Synchronizing state of ufw.service with SysV service script with /lib/systemd/systemd-sysv-install.<br/>Executing: /lib/systemd/systemd-sysv-install disable ufw<br/>Failed to stop firewalld.service: Unit firewalld.service not loaded.<br/>Failed to disable unit: Unit file firewalld.service does not exist.<br/>Install iptables-docker.sh<br/>Create systemd unit<br/>Enable iptables-docker.service<br/>Created symlink /etc/systemd/system/multi-user.target.wants/iptables-docker.service → /etc/systemd/system/iptables-docker.service.<br/>start iptables-docker.service</span></pre><h2 id="d788" class="me kt iq bd ku mz na dn ky nb nc dp lc kf nd ne lg kj nf ng lk kn nh ni lo nj bi translated">自动安装(ansible)</h2><p id="ea7e" class="pw-post-body-paragraph ju jv iq jw b jx lq jz ka kb lr kd ke kf ls kh ki kj lt kl km kn lu kp kq kr ij bi translated">还可以使用ansible在任何地方部署iptables-docker。为此，请调整group_vars/main.yml下的设置。</p><p id="57f2" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">这些设置是:</p><ul class=""><li id="3b5f" class="mk ml iq jw b jx jy kb kc kf mm kj mn kn mo kr mp mq mr ms bi translated">docker_preserve:默认，是。保留docker iptables规则</li><li id="fce3" class="mk ml iq jw b jx mu kb mv kf mw kj mx kn my kr mp mq mr ms bi translated">swarm_enabled:默认值，no。告诉ansible为swarm集群打开所需的端口。</li><li id="1d16" class="mk ml iq jw b jx mu kb mv kf mw kj mx kn my kr mp mq mr ms bi translated">enable_icmp_messages:默认值，是。启用对ping请求的响应</li><li id="8680" class="mk ml iq jw b jx mu kb mv kf mw kj mx kn my kr mp mq mr ms bi translated">swarm_cidr:默认值，192.168.1.0/24。本地码头群子网</li><li id="a2df" class="mk ml iq jw b jx mu kb mv kf mw kj mx kn my kr mp mq mr ms bi translated">ssh_allow_cidr:默认值为0.0.0.0/0。SSH允许的子网(各处默认)</li><li id="77c2" class="mk ml iq jw b jx mu kb mv kf mw kj mx kn my kr mp mq mr ms bi translated">iptables_allow_rules:默认值，[]。动态打开端口的字典列表。每个字典都有以下键:desc、proto、from、port。有关示例，请参见group_vars/all.yml</li><li id="cbb7" class="mk ml iq jw b jx mu kb mv kf mw kj mx kn my kr mp mq mr ms bi translated">iptables_docker_uninstall:默认，否。卸载iptables-docker</li></ul><p id="36cd" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">现在创建清单(hosts.ini文件)或使用内联清单并运行行动手册:</p><pre class="lv lw lx ly gt lz ma mb mc aw md bi"><span id="28a3" class="me kt iq ma b gy mf mg l mh mi">ansible-playbook -i hosts.ini site.yml</span></pre><h1 id="1d1e" class="ks kt iq bd ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp bi translated">使用</h1><p id="b146" class="pw-post-body-paragraph ju jv iq jw b jx lq jz ka kb lr kd ke kf ls kh ki kj lt kl km kn lu kp kq kr ij bi translated">要启动该服务，请使用:</p><pre class="lv lw lx ly gt lz ma mb mc aw md bi"><span id="9e6c" class="me kt iq ma b gy mf mg l mh mi">sudo systemctl start iptables-docker<br/><br/>or <br/><br/>sudo iptables-docker.sh start</span></pre><p id="2335" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">要停止服务，请使用:</p><pre class="lv lw lx ly gt lz ma mb mc aw md bi"><span id="35eb" class="me kt iq ma b gy mf mg l mh mi">sudo systemctl stop iptables-docker<br/><br/>or <br/><br/>sudo iptables-docker.sh stop</span></pre><h1 id="7a23" class="ks kt iq bd ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp bi translated">测试iptables-docker</h1><p id="fe6b" class="pw-post-body-paragraph ju jv iq jw b jx lq jz ka kb lr kd ke kf ls kh ki kj lt kl km kn lu kp kq kr ij bi translated">现在，如果您使用<em class="mj">sudo system CTL stop iptables-docker</em>关闭防火墙，并且检查iptable-save输出，您会看到docker规则仍然存在:</p><pre class="lv lw lx ly gt lz ma mb mc aw md bi"><span id="ee06" class="me kt iq ma b gy mf mg l mh mi">sudo iptables-save<br/><br/># Generated by iptables-save v1.8.4 on Thu Oct 14 15:52:30 2021<br/>*mangle<br/>:PREROUTING ACCEPT [346:23349]<br/>:INPUT ACCEPT [346:23349]<br/>:FORWARD ACCEPT [0:0]<br/>:OUTPUT ACCEPT [340:24333]<br/>:POSTROUTING ACCEPT [340:24333]<br/>COMMIT<br/># Completed on Thu Oct 14 15:52:30 2021<br/># Generated by iptables-save v1.8.4 on Thu Oct 14 15:52:30 2021<br/>*nat<br/>:PREROUTING ACCEPT [0:0]<br/>:INPUT ACCEPT [0:0]<br/>:OUTPUT ACCEPT [0:0]<br/>:POSTROUTING ACCEPT [0:0]<br/>:DOCKER - [0:0]<br/>:DOCKER-INGRESS - [0:0]<br/>-A PREROUTING -m addrtype --dst-type LOCAL -j DOCKER<br/>-A OUTPUT ! -d 127.0.0.0/8 -m addrtype --dst-type LOCAL -j DOCKER<br/>-A POSTROUTING -s 172.17.0.0/16 ! -o docker0 -j MASQUERADE<br/>-A POSTROUTING -s 172.17.0.2/32 -d 172.17.0.2/32 -p tcp -m tcp --dport 80 -j MASQUERADE<br/>-A DOCKER -i docker0 -j RETURN<br/>-A DOCKER ! -i docker0 -p tcp -m tcp --dport 8080 -j DNAT --to-destination 172.17.0.2:80<br/>COMMIT<br/># Completed on Thu Oct 14 15:52:30 2021<br/># Generated by iptables-save v1.8.4 on Thu Oct 14 15:52:30 2021<br/>*filter<br/>:INPUT ACCEPT [357:24327]<br/>:FORWARD DROP [0:0]<br/>:OUTPUT ACCEPT [355:26075]<br/>:DOCKER - [0:0]<br/>:DOCKER-INGRESS - [0:0]<br/>:DOCKER-ISOLATION-STAGE-1 - [0:0]<br/>:DOCKER-ISOLATION-STAGE-2 - [0:0]<br/>:DOCKER-USER - [0:0]<br/>-A FORWARD -j DOCKER-USER<br/>-A FORWARD -j DOCKER-ISOLATION-STAGE-1<br/>-A FORWARD -o docker0 -m conntrack --ctstate RELATED,ESTABLISHED -j ACCEPT<br/>-A FORWARD -o docker0 -j DOCKER<br/>-A FORWARD -i docker0 ! -o docker0 -j ACCEPT<br/>-A FORWARD -i docker0 -o docker0 -j ACCEPT<br/>-A DOCKER -d 172.17.0.2/32 ! -i docker0 -o docker0 -p tcp -m tcp --dport 80 -j ACCEPT<br/>-A DOCKER-ISOLATION-STAGE-1 -i docker0 ! -o docker0 -j DOCKER-ISOLATION-STAGE-2<br/>-A DOCKER-ISOLATION-STAGE-1 -j RETURN<br/>-A DOCKER-ISOLATION-STAGE-2 -o docker0 -j DROP<br/>-A DOCKER-ISOLATION-STAGE-2 -j RETURN<br/>-A DOCKER-USER -j RETURN<br/>COMMIT<br/># Completed on Thu Oct 14 15:52:30 2021</span></pre><p id="5f7e" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">我们的容器仍然可以从外面进入:</p><pre class="lv lw lx ly gt lz ma mb mc aw md bi"><span id="e3bd" class="me kt iq ma b gy mf mg l mh mi">curl -v http://192.168.25.200:8080<br/>*   Trying 192.168.25.200:8080...<br/>* TCP_NODELAY set<br/>* Connected to 192.168.25.200 (192.168.25.200) port 8080 (#0)<br/>&gt; GET / HTTP/1.1<br/>&gt; Host: 192.168.25.200:8080<br/>&gt; User-Agent: curl/7.68.0<br/>&gt; Accept: */*<br/>&gt; <br/>* Mark bundle as not supporting multiuse<br/>&lt; HTTP/1.1 200 OK<br/>&lt; Server: nginx/1.21.1<br/>&lt; Date: Thu, 14 Oct 2021 13:53:33 GMT<br/>&lt; Content-Type: text/html<br/>&lt; Content-Length: 612<br/>&lt; Last-Modified: Tue, 06 Jul 2021 14:59:17 GMT<br/>&lt; Connection: keep-alive<br/>&lt; ETag: "60e46fc5-264"<br/>&lt; Accept-Ranges: bytes</span></pre><p id="2bea" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">我们的集装箱可以上网:</p><pre class="lv lw lx ly gt lz ma mb mc aw md bi"><span id="997d" class="me kt iq ma b gy mf mg l mh mi">docker run --rm nginx curl ipinfo.io/ip<br/>  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current<br/>                                 Dload  Upload   Total   Spent    Left  Speed<br/>100    15  100    15    0     0     94      0 --:--:-- --:--:-- --:--:--    94<br/>my-public-ip-address</span></pre><h1 id="608c" class="ks kt iq bd ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp bi translated">重要注意事项</h1><p id="bbff" class="pw-post-body-paragraph ju jv iq jw b jx lq jz ka kb lr kd ke kf ls kh ki kj lt kl km kn lu kp kq kr ij bi translated">在安装iptables-docker之前，请阅读以下说明:</p><ul class=""><li id="06a3" class="mk ml iq jw b jx jy kb kc kf mm kj mn kn mo kr mp mq mr ms bi translated">本地安装和ansible安装都将您的系统配置为使用<strong class="jw ir"> iptables-legacy </strong></li><li id="348f" class="mk ml iq jw b jx mu kb mv kf mw kj mx kn my kr mp mq mr ms bi translated">默认情况下<strong class="jw ir">只允许</strong>端口22</li><li id="de8e" class="mk ml iq jw b jx mu kb mv kf mw kj mx kn my kr mp mq mr ms bi translated">ufw和防火墙将被永久禁用<strong class="jw ir"/></li><li id="d949" class="mk ml iq jw b jx mu kb mv kf mw kj mx kn my kr mp mq mr ms bi translated">禁用所有docker接口上的过滤</li></ul><p id="d53a" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">Docker接口包括:</p><ul class=""><li id="09ec" class="mk ml iq jw b jx jy kb kc kf mm kj mn kn mo kr mp mq mr ms bi translated">vethXXXXXX接口</li><li id="a31b" class="mk ml iq jw b jx mu kb mv kf mw kj mx kn my kr mp mq mr ms bi translated">br-XXXXXXXXXXX接口</li><li id="d2b6" class="mk ml iq jw b jx mu kb mv kf mw kj mx kn my kr mp mq mr ms bi translated">docker0接口</li><li id="5d1b" class="mk ml iq jw b jx mu kb mv kf mw kj mx kn my kr mp mq mr ms bi translated">docker_gwbridge接口</li></ul><h1 id="868f" class="ks kt iq bd ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp bi translated">扩展iptables-docker</h1><p id="2c2f" class="pw-post-body-paragraph ju jv iq jw b jx lq jz ka kb lr kd ke kf ls kh ki kj lt kl km kn lu kp kq kr ij bi translated">您可以通过编辑来扩展或修改iptables-docker:</p><ul class=""><li id="749c" class="mk ml iq jw b jx jy kb kc kf mm kj mn kn mo kr mp mq mr ms bi translated">本地安装的src/iptables-docker . sh(sh)</li><li id="a164" class="mk ml iq jw b jx mu kb mv kf mw kj mx kn my kr mp mq mr ms bi translated">用于自动安装的roles/iptables-docker/templates/iptables-docker . sh . J2模板文件(ansible)</li></ul><h1 id="a01b" class="ks kt iq bd ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp bi translated">从计算机上卸载</h1><h2 id="7fca" class="me kt iq bd ku mz na dn ky nb nc dp lc kf nd ne lg kj nf ng lk kn nh ni lo nj bi translated">本地安装(sh)</h2><p id="1c65" class="pw-post-body-paragraph ju jv iq jw b jx lq jz ka kb lr kd ke kf ls kh ki kj lt kl km kn lu kp kq kr ij bi translated">运行uninstall.sh</p><h2 id="3ec5" class="me kt iq bd ku mz na dn ky nb nc dp lc kf nd ne lg kj nf ng lk kn nh ni lo nj bi translated">自动安装(ansible)</h2><p id="53c1" class="pw-post-body-paragraph ju jv iq jw b jx lq jz ka kb lr kd ke kf ls kh ki kj lt kl km kn lu kp kq kr ij bi translated">将group_vars/all.yml中的变量“iptables_docker_uninstall”设置为“yes ”,然后运行剧本。</p></div><div class="ab cl nk nl hu nm" role="separator"><span class="nn bw bk no np nq"/><span class="nn bw bk no np nq"/><span class="nn bw bk no np"/></div><div class="ij ik il im in"><p id="e305" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated"><em class="mj">原载于2021年10月14日</em><a class="ae mt" href="https://garutilorenzo.github.io/a-bash-solution-for-docker-and-iptables-conflict/" rel="noopener ugc nofollow" target="_blank"><em class="mj">https://garutilorenzo . github . io</em></a><em class="mj">。</em></p></div></div>    
</body>
</html>