<html>
<head>
<title>Simple Redis Cache on Kubernetes with Prometheus Metrics</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Kubernetes上的简单Redis缓存和普罗米修斯指标</h1>
<blockquote>原文：<a href="https://itnext.io/simple-redis-cache-on-kubernetes-with-prometheus-metrics-8667baceab6b?source=collection_archive---------3-----------------------#2018-08-24">https://itnext.io/simple-redis-cache-on-kubernetes-with-prometheus-metrics-8667baceab6b?source=collection_archive---------3-----------------------#2018-08-24</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="93fd" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们有一个ASP.NET核心应用程序，它依靠Redis缓存来优化大负载响应。它被设计为容忍缓存故障(即它不能连接或获取键/值对)，这意味着非持久性和暂时不可用的缓存对我们来说不是什么大问题。所以我决定在我们的Kubernetes集群上部署一个基本的Redis实例，同时在Elasticache Redis上节省一些钱。下面是一个简单的教程来演示做了什么。</p><p id="262c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><em class="kl">我的Redis部署没有使用主/从复制策略。有关该部署策略的更多信息，Kubernetes有一个很好的例子，您可以在这里找到</em><a class="ae km" href="https://kubernetes.io/docs/tutorials/stateless-application/guestbook/" rel="noopener ugc nofollow" target="_blank"><em class="kl"/></a><em class="kl">。</em></p><h1 id="e5ea" class="kn ko iq bd kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk bi translated">配置演练</h1><p id="3567" class="pw-post-body-paragraph jn jo iq jp b jq ll js jt ju lm jw jx jy ln ka kb kc lo ke kf kg lp ki kj kk ij bi translated">大多数神奇之处都在一个配置中。让我们来看看一些重要的部分。</p><figure class="lq lr ls lt gt lu"><div class="bz fp l di"><div class="lv lw l"/></div><figcaption class="lx ly gj gh gi lz ma bd b be z dk translated">Redis配置</figcaption></figure><h2 id="9772" class="mb ko iq bd kp mc md dn kt me mf dp kx jy mg mh lb kc mi mj lf kg mk ml lj mm bi translated">修复安全警告</h2><p id="4423" class="pw-post-body-paragraph jn jo iq jp b jq ll js jt ju lm jw jx jy ln ka kb kc lo ke kf kg lp ki kj kk ij bi translated">要注意的第一个重要的行是<code class="fe mn mo mp mq b">prometheus.io/port</code>注释。您会注意到我们在服务和部署配置中都需要它。如果您没有包括这些Prometheus注释，您会注意到您的日志充满了以下安全警告:</p><figure class="lq lr ls lt gt lu gh gi paragraph-image"><div role="button" tabindex="0" class="ms mt di mu bf mv"><div class="gh gi mr"><img src="../Images/87c7c0914eeb76b99fa848b1c1a39594.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Opbsfi5zJeGRPy6RBD7hRw.png"/></div></div></figure><p id="83ea" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这是因为Prometheus将试图清除您的服务所暴露的每个目标端口，并将向您的Redis实例在端口<code class="fe mn mo mp mq b">6379</code>上发送<code class="fe mn mo mp mq b">Host</code>命令。</p><h2 id="40f3" class="mb ko iq bd kp mc md dn kt me mf dp kx jy mg mh lb kc mi mj lf kg mk ml lj mm bi translated">如果我们想要普罗米修斯的实际指标呢？</h2><p id="66e2" class="pw-post-body-paragraph jn jo iq jp b jq ll js jt ju lm jw jx jy ln ka kb kc lo ke kf kg lp ki kj kk ij bi translated">你可以在这里找到一个很棒的Prometheus metrics exporter for Redis<a class="ae km" href="https://github.com/oliver006/redis_exporter" rel="noopener ugc nofollow" target="_blank">，</a>我们把它部署在同一个pod上，把它作为边车运行。现在，有了您的<code class="fe mn mo mp mq b">prometheus.io/port: "9121"</code>注释，我们将开始看到Redis pod的指标。在那里你还可以找到一个漂亮的Grafana仪表板。</p><figure class="lq lr ls lt gt lu gh gi paragraph-image"><div role="button" tabindex="0" class="ms mt di mu bf mv"><div class="gh gi my"><img src="../Images/efa2ac14704606c022a4ccb61887d01a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*a1o0bi3nXhsZS1TopVc0EA.png"/></div></div></figure><h2 id="d367" class="mb ko iq bd kp mc md dn kt me mf dp kx jy mg mh lb kc mi mj lf kg mk ml lj mm bi translated">禁用透明大页面</h2><p id="ad23" class="pw-post-body-paragraph jn jo iq jp b jq ll js jt ju lm jw jx jy ln ka kb kc lo ke kf kg lp ki kj kk ij bi translated">您可能会得到一个类似于<code class="fe mn mo mp mq b">WARNING you have Transparent Huge Pages (THP) support enabled in your kernel</code>的错误，这会影响您的Redis pod的性能。这一错误通过添加以下几行得以解决</p><figure class="lq lr ls lt gt lu"><div class="bz fp l di"><div class="lv lw l"/></div></figure><p id="ff35" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">你可以在这里了解关于这个错误<a class="ae km" href="https://stackoverflow.com/questions/45279477/disable-transparent-huge-pages-from-kubernetes" rel="noopener ugc nofollow" target="_blank">的更多信息。初始化容器是在主应用程序容器之前运行一些设置的好方法。在这种情况下，我们装入一个卷并运行一个简单的命令来禁用THP。</a></p><h1 id="1692" class="kn ko iq bd kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk bi translated">使用群集DNS解析服务IP</h1><p id="2cfe" class="pw-post-body-paragraph jn jo iq jp b jq ll js jt ju lm jw jx jy ln ka kb kc lo ke kf kg lp ki kj kk ij bi translated">对于主应用程序上的Redis连接字符串，我们所需要的就是下面的环境变量<code class="fe mn mo mp mq b">REDISCONNECTIONSTRING: media-redis-svc.test.svc:6379</code>。你可以在这里阅读更多关于这个<a class="ae km" href="https://kubernetes.io/docs/concepts/services-networking/dns-pod-service/" rel="noopener ugc nofollow" target="_blank">的内容，但是基本格式是<code class="fe mn mo mp mq b">{service-name}.{namespace}.svc</code>。<em class="kl">注意，Redis服务可以部署在任何名称空间中。</em></a></p><p id="61c0" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">仅此而已。使用Prometheus Metrics将Redis部署到您的Kubernetes集群非常简单。你也可以<code class="fe mn mo mp mq b">exec</code>进入你的吊舱，用<code class="fe mn mo mp mq b">redis-cli monitor</code>监控Redis。感谢阅读。</p></div></div>    
</body>
</html>