<html>
<head>
<title>Using KinD to run EKS-D</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用KinD运行EKS-D</h1>
<blockquote>原文：<a href="https://itnext.io/using-kind-to-run-eks-d-c4603d3d7f83?source=collection_archive---------3-----------------------#2021-06-29">https://itnext.io/using-kind-to-run-eks-d-c4603d3d7f83?source=collection_archive---------3-----------------------#2021-06-29</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><figure class="ip iq gp gr ir is gh gi paragraph-image"><div class="gh gi io"><img src="../Images/7fc922b5491c0e2986230e96aa897277.png" data-original-src="https://miro.medium.com/v2/resize:fit:1024/format:webp/1*3vsiO4mpEhGjfmtgzwY85A.png"/></div></figure><div class=""/><p id="9d7a" class="pw-post-body-paragraph ju jv ix jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">2020年12月，亚马逊发布了EKS-发行版，这是一个可以在各种不同环境下运行的Kubernetes发行版，包括内部环境。这个发行版经过了AWS的实战测试，包含了EKS使用的所有安全补丁和更新，为您提供了安全、可复制的Kubernetes版本。介绍EKS-D的博客包括几个构建EKS-D集群的资源。在这篇博客中，我将描述如何在Docker (KinD)中使用Kubernetes在您的本地机器上运行EKS-D。KinD，如Minikube和Microk8s，是在本地机器上托管Kubernetes的一种方式，只是它不需要额外的驱动程序或虚拟机。我个人发现它对于构建不同解决方案的原型非常有用。</p><p id="7000" class="pw-post-body-paragraph ju jv ix jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">第一步包括从Kubestack创建一个<a class="ae ks" href="https://github.com/kbst/kind-eks-d" rel="noopener ugc nofollow" target="_blank"> kbst/kind </a>项目的分支。一旦项目被分叉，用环境变量更新根目录中的<code class="fe kt ku kv kw b">Makefile</code>，例如，您想要使用的构建的<code class="fe kt ku kv kw b">RELEASE_BRANCH</code>、<code class="fe kt ku kv kw b">VERSION</code>和<code class="fe kt ku kv kw b">SOURCE_URL</code>。</p><pre class="kx ky kz la gt lb kw lc ld aw le bi"><span id="2714" class="lf lg ix kw b gy lh li l lj lk">RELEASE_BRANCH = 1-20<br/>VERSION := v$(subst -,.,$(RELEASE_BRANCH)).4<br/>SOURCE_URL = <a class="ae ks" href="https://distro.eks.amazonaws.com/kubernetes-${RELEASE_BRANCH}/releases/1/artifacts/kubernetes/${VERSION}/kubernetes-src.tar.gz" rel="noopener ugc nofollow" target="_blank">https://distro.eks.amazonaws.com/kubernetes-${RELEASE_BRANCH}/releases/1/artifacts/kubernetes/${VERSION}/kubernetes-src.tar.gz</a><br/>GIT_SHA := $(shell echo `git rev-parse --verify HEAD^{commit}`)<br/>IMAGE_NAME = public.ecr.aws/jicowan/kind-eks-d<br/>TEST_IMAGE = ${IMAGE_NAME}:${GIT_SHA}</span></pre><p id="da47" class="pw-post-body-paragraph ju jv ix jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">在本例中，我使用的是Kubernetes v1.20.4。我还将生成的容器映像推送到ECR public。你可以在https://distro.eks.amazonaws.com/#releases找到可用版本列表。要获得发布的<code class="fe kt ku kv kw b">SOURCE_URL</code>，下载发布清单并运行下面的<code class="fe kt ku kv kw b">yq</code>查询:</p><pre class="kx ky kz la gt lb kw lc ld aw le bi"><span id="3b56" class="lf lg ix kw b gy lh li l lj lk">yq eval '.status.components.[] | select(.name="kubernetes") | .assets.[] | select(.name=="kubernetes-src.tar.gz")' ./kubernetes-1-20-eks-1.yaml</span></pre><p id="dd79" class="pw-post-body-paragraph ju jv ix jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">输出应该如下所示:</p><pre class="kx ky kz la gt lb kw lc ld aw le bi"><span id="e943" class="lf lg ix kw b gy lh li l lj lk">archive:<br/>  sha256: 7b642868c905e41a93beded9968d2c48daef7ecd57815bf0f83ca1337e1f6176<br/>  sha512: 095e57e905a041963689ff9b2d1de30dd6f0344530253cccd4e3d91985091cc37564b95f45c1ed160129306d06f5d2670feb457cbb01e274f5a0c0f3c724f834<br/>  uri: <a class="ae ks" href="https://distro.eks.amazonaws.com/kubernetes-1-20/releases/1/artifacts/kubernetes/v1.20.4/kubernetes-src.tar.gz" rel="noopener ugc nofollow" target="_blank">https://distro.eks.amazonaws.com/kubernetes-1-20/releases/1/artifacts/kubernetes/v1.20.4/kubernetes-src.tar.gz</a><br/>description: Kubernetes source tarball<br/>name: kubernetes-src.tar.gz<br/>type: Archive</span></pre><p id="4120" class="pw-post-body-paragraph ju jv ix jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">验证<code class="fe kt ku kv kw b">SOURCE_URL</code>与<code class="fe kt ku kv kw b"><a class="ae ks" href="https://mikefarah.gitbook.io/yq/" rel="noopener ugc nofollow" target="_blank">yq</a></code>输出中的URI匹配。确保保持<code class="fe kt ku kv kw b">RELEASE_BRANCH</code>和<code class="fe kt ku kv kw b">VERSION</code>变量不变，因为它们将由您之前指定的值填充。</p><p id="4b38" class="pw-post-body-paragraph ju jv ix jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">如果像我一样，您想将图像推送到您自己的注册表中，您将需要更新GitHub actions下的<code class="fe kt ku kv kw b">main.yml</code>文件。当我将生成的图像推送到ECR时，我需要用我的AWS访问密钥ID和密钥的环境变量更新Docker登录部分。GitHub actions将使用这些秘密向ECR public认证。</p><pre class="kx ky kz la gt lb kw lc ld aw le bi"><span id="e35c" class="lf lg ix kw b gy lh li l lj lk">- name: Docker login      <br/>  uses: docker/login-action@v1      <br/>  with:        <br/>    registry: public.ecr.aws        <br/>    username: ${{ secrets.AWS_ACCESS_KEY_ID }}        <br/>    password: ${{ secrets.AWS_SECRET_ACCESS_KEY }}      <br/>  env:        <br/>  AWS_REGION: us-east-1</span></pre><p id="f01f" class="pw-post-body-paragraph ju jv ix jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">在保存您的更改之前，为<code class="fe kt ku kv kw b">AWS_ACCESS_KEY_ID</code>和<code class="fe kt ku kv kw b">AWS_SECRET_ACCESS_KEY</code>创建GitHub secret。如果你不熟悉如何创建github秘密，请参考<a class="ae ks" href="https://docs.github.com/en/actions/reference/encrypted-secrets" rel="noopener ugc nofollow" target="_blank">https://docs . GitHub . com/en/actions/reference/encrypted-secrets</a>。当你保存更改<code class="fe kt ku kv kw b">main.yml</code>时，它将触发一个工作流，该工作流将构建并推送你的图像到你的注册表中。</p><p id="c567" class="pw-post-body-paragraph ju jv ix jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">接下来，为KinD创建一个名为<code class="fe kt ku kv kw b">kind-eks-d-v1.20.conf</code>的配置文件，如下所示:</p><pre class="kx ky kz la gt lb kw lc ld aw le bi"><span id="b2ed" class="lf lg ix kw b gy lh li l lj lk">kind: Cluster<br/>apiVersion: kind.x-k8s.io/v1alpha4<br/>name: eks-d-1-20<br/>nodes:<br/>- role: control-plane<br/>  image: public.ecr.aws/jicowan/kind-eks-d:4e13a3f38c26a14e6a333fc7b8246c02ac4b33b2<br/>- role: worker<br/>  image: public.ecr.aws/jicowan/kind-eks-d:4e13a3f38c26a14e6a333fc7b8246c02ac4b33b2</span></pre><p id="33c1" class="pw-post-body-paragraph ju jv ix jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">请注意，您可能需要使用您的图像的URI来更新图像，尽管您可以免费使用我推送到ECR public的图像。</p><p id="b6ca" class="pw-post-body-paragraph ju jv ix jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">最后，通过执行以下命令创建一个KinD集群:</p><pre class="kx ky kz la gt lb kw lc ld aw le bi"><span id="a3d2" class="lf lg ix kw b gy lh li l lj lk">kind create cluster --config ./kind-eks-d-v1.20.conf</span></pre><p id="bc7a" class="pw-post-body-paragraph ju jv ix jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">大约3-5分钟后，您将有一个EKS D集群运行在您的本地机器上！</p></div></div>    
</body>
</html>