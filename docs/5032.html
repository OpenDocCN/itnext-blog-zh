<html>
<head>
<title>Build and Run Telegram-iOS v7.2 in Xcode 12.x Simulator</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在Xcode 12.x模拟器中构建并运行Telegram-iOS v7.2</h1>
<blockquote>原文：<a href="https://itnext.io/build-and-run-telegram-ios-on-xcode-12-x-simulator-2aff89c25a9f?source=collection_archive---------3-----------------------#2020-11-21">https://itnext.io/build-and-run-telegram-ios-on-xcode-12-x-simulator-2aff89c25a9f?source=collection_archive---------3-----------------------#2020-11-21</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><blockquote class="jn jo jp"><p id="2f00" class="jq jr js jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko ij bi translated"><a class="ae kp" href="https://hubo.dev/2020-11-20-build-and-run-telegram-on-xcode-12-x-simulator/" rel="noopener ugc nofollow" target="_blank"> hubo.dev的镜像</a></p></blockquote><figure class="kr ks kt ku gt kv gh gi paragraph-image"><div role="button" tabindex="0" class="kw kx di ky bf kz"><div class="gh gi kq"><img src="../Images/0de27c4d800b3c7c0e240255a9919e80.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*M2cUGuQdhAd_zh43"/></div></div><figcaption class="lc ld gj gh gi le lf bd b be z dk translated"><a class="ae kp" href="https://unsplash.com/@xavi_cabrera?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">哈维·卡夫雷拉</a>在<a class="ae kp" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</figcaption></figure><p id="f8ff" class="pw-post-body-paragraph jq jr iq jt b ju jv jw jx jy jz ka kb lg kd ke kf lh kh ki kj li kl km kn ko ij bi translated">Telegram启动了针对iOS和Android的[ <a class="ae kp" href="https://core.telegram.org/reproducible-builds" rel="noopener ugc nofollow" target="_blank">可复制构建项目</a>，以更有规律的时间表发布其客户端源代码。虽然这是一个伟大的举措，但你可能会发现如何以最小的影响构建和运行iOS项目仍然令人困惑。<a class="ae kp" href="https://core.telegram.org/reproducible-builds#reproducible-builds-for-ios" rel="noopener ugc nofollow" target="_blank">官方指南</a>用于验证构建是否可复制，这需要在Parallels虚拟机中安装macOS Catalina、Xcode 11.x和其他工具。</p><p id="a3bc" class="pw-post-body-paragraph jq jr iq jt b ju jv jw jx jy jz ka kb lg kd ke kf lh kh ki kj li kl km kn ko ij bi translated">对于想要使用代码的开发人员来说，该指南存在一些问题:</p><p id="e8c2" class="pw-post-body-paragraph jq jr iq jt b ju jv jw jx jy jz ka kb lg kd ke kf lh kh ki kj li kl km kn ko ij bi translated">-运行macOS和Xcode的另一个克隆需要一个强大的机器。<br/> - Xcode 11.x已经过时，最新的Xcode 12.x在代码完成方面比<a class="ae kp" href="https://developer.apple.com/documentation/xcode-release-notes/xcode-12-release-notes" rel="noopener ugc nofollow" target="_blank">快15倍</a>。<br/> -它运行自动化脚本文件来生成IPA文件，而不显示如何在Xcode IDE中打开项目。<br/> -不包括如何在模拟器中构建和运行。</p><p id="4a43" class="pw-post-body-paragraph jq jr iq jt b ju jv jw jx jy jz ka kb lg kd ke kf lh kh ki kj li kl km kn ko ij bi translated">本教程演示了我解决这些问题的方法。它包括安装必要的工具和修改部分项目代码，以使其工作。如果不想看细节，可以快进到最后一节。</p><blockquote class="jn jo jp"><p id="4de5" class="jq jr js jt b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko ij bi translated">如果您使用macOS Big Sur，请参考<a class="ae kp" href="https://bohu.medium.com/build-and-run-telegram-ios-v7-3-in-simulator-with-bazel-fe36f305bd55" rel="noopener">使用Bazel在模拟器中构建并运行Telegram-iOS v7.3。</a></p></blockquote><h1 id="044b" class="lj lk iq bd ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg bi translated">安装降压装置</h1><p id="8173" class="pw-post-body-paragraph jq jr iq jt b ju mh jw jx jy mi ka kb lg mj ke kf lh mk ki kj li ml km kn ko ij bi translated">我的开发机器运行的是macOS Catalina 10.15.7和Xcode 12.2 (12B45b)。Telegram-iOS使用<a class="ae kp" href="https://buck.build/" rel="noopener ugc nofollow" target="_blank"> <strong class="jt ir"> buck </strong> </a>构建第三方库，生成Xcode工作区文件。我们可以通过自制软件安装巴克和它的附属设备JDK 8:</p><pre class="kr ks kt ku gt mm mn mo mp aw mq bi"><span id="d509" class="mr lk iq mn b gy ms mt l mu mv">brew tap AdoptOpenJDK/openjdk<br/>brew cask install adoptopenjdk8</span><span id="0f31" class="mr lk iq mn b gy mw mt l mu mv">brew tap facebook/fb<br/>brew install buck</span></pre><p id="70bd" class="pw-post-body-paragraph jq jr iq jt b ju jv jw jx jy jz ka kb lg kd ke kf lh kh ki kj li kl km kn ko ij bi translated">请检查您的终端会话，以确保它使用JDK 8和降压工程:</p><pre class="kr ks kt ku gt mm mn mo mp aw mq bi"><span id="0617" class="mr lk iq mn b gy ms mt l mu mv">$ java -version<br/>openjdk version "1.8.0_272"<br/>OpenJDK Runtime Environment (AdoptOpenJDK)(build 1.8.0_272-b10)<br/>OpenJDK 64-Bit Server VM (AdoptOpenJDK)(build 25.272-b10, mixed mode)</span><span id="cab0" class="mr lk iq mn b gy mw mt l mu mv">$ buck --version<br/>buck version 2020.10.21.01</span></pre><h1 id="04c6" class="lj lk iq bd ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg bi translated">构建和生成Xcode工作空间</h1><h2 id="9872" class="mr lk iq bd ll mx my dn lp mz na dp lt lg nb nc lx lh nd ne mb li nf ng mf nh bi translated">#1查看代码</h2><pre class="kr ks kt ku gt mm mn mo mp aw mq bi"><span id="7405" class="mr lk iq mn b gy ms mt l mu mv">git clone --recursive <a class="ae kp" href="https://github.com/TelegramMessenger/telegram-ios.git" rel="noopener ugc nofollow" target="_blank">https://github.com/TelegramMessenger/telegram-ios.git</a><br/>cd telegram-ios</span></pre><h2 id="a9c5" class="mr lk iq bd ll mx my dn lp mz na dp lt lg nb nc lx lh nd ne mb li nf ng mf nh bi translated">#2设置环境变量</h2><p id="0c06" class="pw-post-body-paragraph jq jr iq jt b ju mh jw jx jy mi ka kb lg mj ke kf lh mk ki kj li ml km kn ko ij bi translated">由于Telegram-iOS使开发人员能够定制和构建他们自己的客户端变体，构建系统需要一堆环境变量来提供设置。我们可以重用可再生构建指南中的设置，因为我们只想在模拟器中运行它。</p><figure class="kr ks kt ku gt kv"><div class="bz fp l di"><div class="ni nj l"/></div></figure><p id="95c2" class="pw-post-body-paragraph jq jr iq jt b ju jv jw jx jy jz ka kb lg kd ke kf lh kh ki kj li kl km kn ko ij bi translated">我对<a class="ae kp" href="https://github.com/openaphid/Telegram-iOS/blob/main/build-system/verify.sh" rel="noopener ugc nofollow" target="_blank"> build-system/verify.sh </a>中的原始设置做了一些小的调整:</p><ul class=""><li id="aef0" class="nk nl iq jt b ju jv jy jz lg nm lh nn li no ko np nq nr ns bi translated">添加<code class="fe nt nu nv mn b">BUCK</code>变量。<code class="fe nt nu nv mn b">makefile</code>依靠它来定位降压命令。</li><li id="c153" class="nk nl iq jt b ju nw jy nx lg ny lh nz li oa ko np nq nr ns bi translated">添加<code class="fe nt nu nv mn b">BUILD_NUMBER</code>变量。</li><li id="6a64" class="nk nl iq jt b ju nw jy nx lg ny lh nz li oa ko np nq nr ns bi translated">将<code class="fe nt nu nv mn b">IS_INTERNAL_BUILD</code>翻转到<code class="fe nt nu nv mn b">true</code>，将<code class="fe nt nu nv mn b">IS_APPSTORE_BUILD</code>翻转到<code class="fe nt nu nv mn b">false</code>。</li></ul><h2 id="234e" class="mr lk iq bd ll mx my dn lp mz na dp lt lg nb nc lx lh nd ne mb li nf ng mf nh bi translated">#3启用死代码剥离</h2><p id="1aa5" class="pw-post-body-paragraph jq jr iq jt b ju mh jw jx jy mi ka kb lg mj ke kf lh mk ki kj li ml km kn ko ij bi translated">我们需要通过将死代码添加到<a class="ae kp" href="https://github.com/openaphid/Telegram-iOS/blob/main/Config/utils.bzl" rel="noopener ugc nofollow" target="_blank"> Config/utils.bzl </a>来为所有模块启用死代码剥离:</p><figure class="kr ks kt ku gt kv"><div class="bz fp l di"><div class="ni nj l"/></div></figure><p id="339f" class="pw-post-body-paragraph jq jr iq jt b ju jv jw jx jy jz ka kb lg kd ke kf lh kh ki kj li kl km kn ko ij bi translated">否则，在使用Xcode构建项目时，您可能会遇到以下错误:</p><figure class="kr ks kt ku gt kv"><div class="bz fp l di"><div class="ni nj l"/></div></figure><h2 id="da28" class="mr lk iq bd ll mx my dn lp mz na dp lt lg nb nc lx lh nd ne mb li nf ng mf nh bi translated">#4调整mozjpeg的构建设置</h2><p id="d71c" class="pw-post-body-paragraph jq jr iq jt b ju mh jw jx jy mi ka kb lg mj ke kf lh mk ki kj li ml km kn ko ij bi translated">一些第三方库的构建设置没有模拟器要求的<code class="fe nt nu nv mn b">x86_64</code>目标，除非你有一台苹果M1电脑。需要我们自己加。</p><p id="82c3" class="pw-post-body-paragraph jq jr iq jt b ju jv jw jx jy jz ka kb lg kd ke kf lh kh ki kj li kl km kn ko ij bi translated">是其中一个需要改进的地方。在<a class="ae kp" href="https://github.com/openaphid/Telegram-iOS/blob/main/third-party/mozjpeg/BUCK" rel="noopener ugc nofollow" target="_blank">第三方/mozjpeg/BUCK </a>内部，声明了<code class="fe nt nu nv mn b">arm64</code>和<code class="fe nt nu nv mn b">armv7</code>两个目标。我们可以将<code class="fe nt nu nv mn b">armv7</code>改为<code class="fe nt nu nv mn b">x86_64</code>，因为我们在模拟器和大多数设备上不需要<code class="fe nt nu nv mn b">armv7</code>。</p><figure class="kr ks kt ku gt kv"><div class="bz fp l di"><div class="ni nj l"/></div></figure><h2 id="d510" class="mr lk iq bd ll mx my dn lp mz na dp lt lg nb nc lx lh nd ne mb li nf ng mf nh bi translated">#5针对webrtc-ios的修复版本</h2><p id="7927" class="pw-post-body-paragraph jq jr iq jt b ju mh jw jx jy mi ka kb lg mj ke kf lh mk ki kj li ml km kn ko ij bi translated">Telegram-iOS将其视频通话建立在<code class="fe nt nu nv mn b">webrtc-ios</code>之上，这是今年引入的一个巨大模块。它应该在生成工作空间文件之前由buck构建到一个框架中。不幸的是，官方回购中的代码无法与Xcode 12.x编译，也不支持<code class="fe nt nu nv mn b">x86_64</code>目标。</p><p id="8198" class="pw-post-body-paragraph jq jr iq jt b ju jv jw jx jy jz ka kb lg kd ke kf lh kh ki kj li kl km kn ko ij bi translated">第一个变化是关于python脚本<a class="ae kp" href="https://github.com/ali-fareed/webrtc-ios/blob/782743c7931d09c1d2e4a0cf6cd349ee45452f1d/src/build/mac/find_sdk.py" rel="noopener ugc nofollow" target="_blank"> find_sdk.py </a>，它是<code class="fe nt nu nv mn b">webrtc-ios</code>构建系统的一部分。它有助于在Xcode.app中定位SDK路径。原始正则表达式<code class="fe nt nu nv mn b">^MacOSX(10\.\d+)\.sdk$</code>不适用于Xcode 12.x，因为SDK路径名已被更改为<code class="fe nt nu nv mn b">Contents/Developer/Platforms/MacOSX.platform/Developer/SDKs/MacOSX11.0.sdk</code>。我们需要将表达式改为<code class="fe nt nu nv mn b">^MacOSX(1[01]\.\d+)\.sdk$</code>，它匹配<code class="fe nt nu nv mn b">MacOSX10</code>和<code class="fe nt nu nv mn b">MacOSX11</code> SDK名称。</p><figure class="kr ks kt ku gt kv"><div class="bz fp l di"><div class="ni nj l"/></div></figure><p id="4b35" class="pw-post-body-paragraph jq jr iq jt b ju jv jw jx jy jz ka kb lg kd ke kf lh kh ki kj li kl km kn ko ij bi translated">另一个修正是添加如下<code class="fe nt nu nv mn b">x86_64</code>目标:</p><figure class="kr ks kt ku gt kv"><div class="bz fp l di"><div class="ni nj l"/></div></figure><h2 id="fa3a" class="mr lk iq bd ll mx my dn lp mz na dp lt lg nb nc lx lh nd ne mb li nf ng mf nh bi translated">#6生成工作空间文件</h2><p id="3dba" class="pw-post-body-paragraph jq jr iq jt b ju mh jw jx jy mi ka kb lg mj ke kf lh mk ki kj li ml km kn ko ij bi translated">现在可以运行下面的命令来构建库并生成工作区文件了:</p><pre class="kr ks kt ku gt mm mn mo mp aw mq bi"><span id="db2e" class="mr lk iq mn b gy ms mt l mu mv">make project</span></pre><p id="37d4" class="pw-post-body-paragraph jq jr iq jt b ju jv jw jx jy jz ka kb lg kd ke kf lh kh ki kj li kl km kn ko ij bi translated">这可能需要一段时间才能完成，因为它需要构建像openssl、ffmpeg和webrtc-ios这样的库。一旦完成，它会在<code class="fe nt nu nv mn b">Telegram/Telegram_Buck.xcworkspace</code>打开Xcode IDE，并显示生成的工作空间文件。</p><h1 id="8741" class="lj lk iq bd ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg bi translated">在模拟器中构建和运行</h1><p id="4652" class="pw-post-body-paragraph jq jr iq jt b ju mh jw jx jy mi ka kb lg mj ke kf lh mk ki kj li ml km kn ko ij bi translated">看到Xcode正在运行令人兴奋，但是我们还需要最后一个改变。否则，在模拟器中运行的构建过程将失败，并出现许多链接阶段错误:</p><pre class="kr ks kt ku gt mm mn mo mp aw mq bi"><span id="2142" class="mr lk iq mn b gy ms mt l mu mv">Undefined symbols for architecture x86_64:<br/>  "static UIKit.UIPointerShape.defaultCornerRadius.getter : CoreGraphics.CGFloat", referenced from:<br/>      Display.(PointerInteractionImpl in _B39DD7E7F85F24DF4F7212BCFE28692F).pointerInteraction(_: __C.UIPointerInteraction, styleFor: __C.UIPointerRegion) -&gt; __C.UIPointerStyle? in PointerInteraction.o<br/>  "enum case for UIKit.UIPointerShape.roundedRect(UIKit.UIPointerShape.Type) -&gt; (__C.CGRect, CoreGraphics.CGFloat) -&gt; UIKit.UIPointerShape", referenced from:<br/>      Display.(PointerInteractionImpl in _B39DD7E7F85F24DF4F7212BCFE28692F).pointerInteraction(_: __C.UIPointerInteraction, styleFor: __C.UIPointerRegion) -&gt; __C.UIPointerStyle? in PointerInteraction.o<br/>  "enum case for UIKit.UIPointerEffect.highlight(UIKit.UIPointerEffect.Type) -&gt; (__C.UITargetedPreview) -&gt; UIKit.UIPointerEffect", referenced from:<br/>      Display.(PointerInteractionImpl in _B39DD7E7F85F24DF4F7212BCFE28692F).pointerInteraction(_: __C.UIPointerInteraction, styleFor: __C.UIPointerRegion) -&gt; __C.UIPointerStyle? in PointerInteraction.o</span></pre><p id="b5a6" class="pw-post-body-paragraph jq jr iq jt b ju jv jw jx jy jz ka kb lg kd ke kf lh kh ki kj li kl km kn ko ij bi translated">链接器找不到关于指针交互的符号。不知道背后的真正原因。这可能是Xcode的问题，或者buck可能会生成一些不正确的项目文件。我的解决方案是在<a class="ae kp" href="https://github.com/openaphid/Telegram-iOS/blob/main/submodules/Display/Source/PointerInteraction.swift#L44" rel="noopener ugc nofollow" target="_blank">子模块/Display/Source/pointer interaction . swift</a>中使用指针交互注释掉代码，因为我不打算在模拟器中测试该特性。</p><figure class="kr ks kt ku gt kv"><div class="bz fp l di"><div class="ni nj l"/></div></figure><p id="be03" class="pw-post-body-paragraph jq jr iq jt b ju jv jw jx jy jz ka kb lg kd ke kf lh kh ki kj li kl km kn ko ij bi translated">现在，您应该能够在Simulator中构建、运行和调试Telegram-iOS。</p><h1 id="a61d" class="lj lk iq bd ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg bi translated">快进</h1><p id="a2ab" class="pw-post-body-paragraph jq jr iq jt b ju mh jw jx jy mi ka kb lg mj ke kf lh mk ki kj li ml km kn ko ij bi translated">如果你没有时间享受与复杂构建系统战斗的乐趣，并且想要快进到最后阶段，我已经将这些更改作为补丁文件放在我的<a class="ae kp" href="https://github.com/openaphid/Telegram-iOS" rel="noopener ugc nofollow" target="_blank">forged repo of Telegram-iOS</a>中。您可以查看官方回购，并运行命令来下载和使用简化过程的补丁程序:</p><figure class="kr ks kt ku gt kv"><div class="bz fp l di"><div class="ni nj l"/></div></figure></div></div>    
</body>
</html>