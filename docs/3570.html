<html>
<head>
<title>How to optimize a serverless typescript eslint webpack setup for performance</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何优化无服务器的typescript eslint webpack设置以提高性能</h1>
<blockquote>原文：<a href="https://itnext.io/how-to-optimise-your-serverless-typescript-webpack-eslint-setup-for-performance-86d052284505?source=collection_archive---------0-----------------------#2020-01-10">https://itnext.io/how-to-optimise-your-serverless-typescript-webpack-eslint-setup-for-performance-86d052284505?source=collection_archive---------0-----------------------#2020-01-10</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="f0fb" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">或者我如何通过调整Typescript设置、webpack、serverless.yml和eslint，在构建时间和软件包大小方面改进无服务器AWS NodeJS Typescript模板(<a class="ae kl" href="https://github.com/serverless/serverless/tree/master/lib/plugins/create/templates/aws-nodejs-typescript" rel="noopener ugc nofollow" target="_blank"> aws-nodejs-typescript </a>)。</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="ks kt di ku bf kv"><div class="gh gi km"><img src="../Images/6aaf9aa3b6fa83284dc68eb5d32a5f70.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*YDyJpHrHPbjP7Fm-rPFtUg.png"/></div></div></figure><p id="f318" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果你的typescript、eslint或webpack安装很慢，你可以按照下面的提示来优化它们。</p><h2 id="9ce1" class="ky kz iq bd la lb lc dn ld le lf dp lg jy lh li lj kc lk ll lm kg ln lo lp lq bi translated">优化Typescript — tsconfig.json</h2><ol class=""><li id="5640" class="lr ls iq jp b jq lt ju lu jy lv kc lw kg lx kk ly lz ma mb bi translated">仅包括<code class="fe mc md me mf b">**/*.ts</code>文件，排除<code class="fe mc md me mf b">node_modules</code>和构建目录。</li><li id="70e2" class="lr ls iq jp b jq mg ju mh jy mi kc mj kg mk kk ly lz ma mb bi translated">通过在<code class="fe mc md me mf b">compilerOptions</code>下设置<code class="fe mc md me mf b">“removeComments”: true</code>，从捆绑中删除注释。</li><li id="c9b5" class="lr ls iq jp b jq mg ju mh jy mi kc mj kg mk kk ly lz ma mb bi translated">启用增量API和观察API。</li></ol><pre class="kn ko kp kq gt ml mf mm mn aw mo bi"><span id="740a" class="ky kz iq mf b gy mp mq l mr ms">// tsconfig.json<br/><strong class="mf ir"><br/></strong>{</span><span id="5fb6" class="ky kz iq mf b gy mt mq l mr ms">  "compilerOptions": {</span><span id="4571" class="ky kz iq mf b gy mt mq l mr ms">  "lib": [</span><span id="7008" class="ky kz iq mf b gy mt mq l mr ms">    "es2017"</span><span id="1df4" class="ky kz iq mf b gy mt mq l mr ms">  ],</span><span id="730b" class="ky kz iq mf b gy mt mq l mr ms">  "removeComments": true,</span><span id="8022" class="ky kz iq mf b gy mt mq l mr ms">  "moduleResolution": "node",</span><span id="187f" class="ky kz iq mf b gy mt mq l mr ms">  "resolveJsonModule": true,</span><span id="82e4" class="ky kz iq mf b gy mt mq l mr ms">  "noUnusedLocals": false,</span><span id="63a7" class="ky kz iq mf b gy mt mq l mr ms">  "noUnusedParameters": false,</span><span id="6ffa" class="ky kz iq mf b gy mt mq l mr ms">  "sourceMap": true,</span><span id="2c4b" class="ky kz iq mf b gy mt mq l mr ms">  "allowSyntheticDefaultImports": true,</span><span id="9f44" class="ky kz iq mf b gy mt mq l mr ms">  "forceConsistentCasingInFileNames": true,</span><span id="71b1" class="ky kz iq mf b gy mt mq l mr ms">  "importHelpers": true,</span><span id="6f5a" class="ky kz iq mf b gy mt mq l mr ms">  "incremental": true,</span><span id="fba9" class="ky kz iq mf b gy mt mq l mr ms">  "watch": true,</span><span id="fe62" class="ky kz iq mf b gy mt mq l mr ms">  "target": "es2017",</span><span id="2594" class="ky kz iq mf b gy mt mq l mr ms">  "outDir": "lib"</span><span id="b55d" class="ky kz iq mf b gy mt mq l mr ms">},</span><span id="87b8" class="ky kz iq mf b gy mt mq l mr ms">"include": [</span><span id="4203" class="ky kz iq mf b gy mt mq l mr ms">  "./**/*.ts"</span><span id="815a" class="ky kz iq mf b gy mt mq l mr ms">],</span><span id="1044" class="ky kz iq mf b gy mt mq l mr ms">"exclude": [</span><span id="50da" class="ky kz iq mf b gy mt mq l mr ms">  "node_modules/**/*",</span><span id="c024" class="ky kz iq mf b gy mt mq l mr ms">  ".serverless/**/*",</span><span id="46e6" class="ky kz iq mf b gy mt mq l mr ms">  ".webpack/**/*",</span><span id="cefa" class="ky kz iq mf b gy mt mq l mr ms">  "_warmup/**/*",</span><span id="9bfd" class="ky kz iq mf b gy mt mq l mr ms">  ".vscode/**/*",</span><span id="6e54" class="ky kz iq mf b gy mt mq l mr ms">  "*.config.js",</span><span id="a6e9" class="ky kz iq mf b gy mt mq l mr ms">  "**/*.js"</span><span id="397c" class="ky kz iq mf b gy mt mq l mr ms"> ]</span><span id="ded8" class="ky kz iq mf b gy mt mq l mr ms">}</span></pre><h2 id="bcfe" class="ky kz iq bd la lb lc dn ld le lf dp lg jy lh li lj kc lk ll lm kg ln lo lp lq bi translated">优化eslint — .eslintrc.js</h2><p id="1afc" class="pw-post-body-paragraph jn jo iq jp b jq lt js jt ju lu jw jx jy mu ka kb kc mv ke kf kg mw ki kj kk ij bi translated">现在<a class="ae kl" href="https://github.com/palantir/tslint/issues/4534" rel="noopener ugc nofollow" target="_blank"> tslint被弃用了</a>，我们应该使用eslint和<a class="ae kl" href="https://github.com/typescript-eslint/typescript-eslint/" rel="noopener ugc nofollow" target="_blank"> typescript-eslint </a>来代替。然而，我不禁注意到切换后的性能差异，eslint比tslint慢。下面是你可以做的最有效的方法:</p><ol class=""><li id="8d4c" class="lr ls iq jp b jq jr ju jv jy mx kc my kg mz kk ly lz ma mb bi translated">设置一个<code class="fe mc md me mf b">.eslintignore</code>文件来忽略<code class="fe mc md me mf b">node_modules</code>以及编译/非类型脚本文件。</li><li id="0e9a" class="lr ls iq jp b jq mg ju mh jy mi kc mj kg mk kk ly lz ma mb bi translated">运行eslint时使用<code class="fe mc md me mf b">--cache</code>标志，例如:<code class="fe mc md me mf b">eslint --cache **/*.ts</code>。</li><li id="78c3" class="lr ls iq jp b jq mg ju mh jy mi kc mj kg mk kk ly lz ma mb bi translated">不要在eslint配置中扩展昂贵的<code class="fe mc md me mf b">"plugin:@typescript-eslint/recommended-requiring-type-checking"</code>配置。</li><li id="6ee5" class="lr ls iq jp b jq mg ju mh jy mi kc mj kg mk kk ly lz ma mb bi translated">添加一个<code class="fe mc md me mf b">.eslintignore</code>文件来忽略node_modules并构建目录</li></ol><pre class="kn ko kp kq gt ml mf mm mn aw mo bi"><span id="8dac" class="ky kz iq mf b gy mp mq l mr ms">//.eslintrc.js<br/>module.exports = {</span><span id="3bca" class="ky kz iq mf b gy mt mq l mr ms">"extends": [</span><span id="9124" class="ky kz iq mf b gy mt mq l mr ms">  "eslint:recommended",</span><span id="51b0" class="ky kz iq mf b gy mt mq l mr ms">  "plugin:@typescript-eslint/eslint-recommended",</span><span id="dbea" class="ky kz iq mf b gy mt mq l mr ms">  "plugin:@typescript-eslint/recommended",</span><span id="f539" class="ky kz iq mf b gy mt mq l mr ms">  "standard"</span><span id="5c30" class="ky kz iq mf b gy mt mq l mr ms">],</span><span id="11db" class="ky kz iq mf b gy mt mq l mr ms">"env": {</span><span id="210e" class="ky kz iq mf b gy mt mq l mr ms">  "node": true</span><span id="aa3d" class="ky kz iq mf b gy mt mq l mr ms">},</span><span id="02b7" class="ky kz iq mf b gy mt mq l mr ms">"parser": "@typescript-eslint/parser",</span><span id="6931" class="ky kz iq mf b gy mt mq l mr ms">"plugins": [</span><span id="0541" class="ky kz iq mf b gy mt mq l mr ms">  "@typescript-eslint",</span><span id="c431" class="ky kz iq mf b gy mt mq l mr ms">],</span><span id="7d3f" class="ky kz iq mf b gy mt mq l mr ms">"settings": {</span><span id="8c6a" class="ky kz iq mf b gy mt mq l mr ms">  "import/parsers": {</span><span id="b1ca" class="ky kz iq mf b gy mt mq l mr ms">    "@typescript-eslint/parser": [</span><span id="2396" class="ky kz iq mf b gy mt mq l mr ms">    ".ts",</span><span id="a089" class="ky kz iq mf b gy mt mq l mr ms">    ".tsx"</span><span id="e6a8" class="ky kz iq mf b gy mt mq l mr ms">  ]</span><span id="b03b" class="ky kz iq mf b gy mt mq l mr ms">  },</span><span id="7c26" class="ky kz iq mf b gy mt mq l mr ms">  "import/resolver": {</span><span id="b9e3" class="ky kz iq mf b gy mt mq l mr ms">    "typescript": {} </span><span id="7401" class="ky kz iq mf b gy mt mq l mr ms">  }</span><span id="60a7" class="ky kz iq mf b gy mt mq l mr ms">},</span><span id="6a6c" class="ky kz iq mf b gy mt mq l mr ms">"parserOptions": {</span><span id="9577" class="ky kz iq mf b gy mt mq l mr ms">  "project": "./tsconfig.json",</span><span id="f5a3" class="ky kz iq mf b gy mt mq l mr ms">  "tsconfigRootDir": "./",</span><span id="e6aa" class="ky kz iq mf b gy mt mq l mr ms">  "sourceType": "module",</span><span id="7ba4" class="ky kz iq mf b gy mt mq l mr ms">  "ecmaVersion": 2018</span><span id="252e" class="ky kz iq mf b gy mt mq l mr ms">},</span><span id="3c04" class="ky kz iq mf b gy mt mq l mr ms">"rules": {</span><span id="d569" class="ky kz iq mf b gy mt mq l mr ms">  "@typescript-eslint/no-explicit-any": "off",</span><span id="a54d" class="ky kz iq mf b gy mt mq l mr ms">  }</span><span id="1f6f" class="ky kz iq mf b gy mt mq l mr ms">}</span></pre><p id="768b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">添加一个<code class="fe mc md me mf b">.eslintignore</code>文件来忽略不需要链接的非src文件</p><pre class="kn ko kp kq gt ml mf mm mn aw mo bi"><span id="33cb" class="ky kz iq mf b gy mp mq l mr ms">//.eslintignore<br/>node_modules</span><span id="6c6a" class="ky kz iq mf b gy mt mq l mr ms">.serverless</span><span id="ac53" class="ky kz iq mf b gy mt mq l mr ms">.vscode</span><span id="772b" class="ky kz iq mf b gy mt mq l mr ms">*.config.js</span><span id="be9c" class="ky kz iq mf b gy mt mq l mr ms">.webpack</span><span id="3098" class="ky kz iq mf b gy mt mq l mr ms">_warmup</span><span id="202c" class="ky kz iq mf b gy mt mq l mr ms">**/*.js</span></pre><h2 id="64e3" class="ky kz iq bd la lb lc dn ld le lf dp lg jy lh li lj kc lk ll lm kg ln lo lp lq bi translated">优化webpack.config.js</h2><ol class=""><li id="030c" class="lr ls iq jp b jq lt ju lu jy lv kc lw kg lx kk ly lz ma mb bi translated">安装<a class="ae kl" href="https://github.com/liady/webpack-node-externals" rel="noopener ugc nofollow" target="_blank"> webpack-node-externals </a>以从构建中移除未使用的<code class="fe mc md me mf b">node_modules</code>。</li><li id="a306" class="lr ls iq jp b jq mg ju mh jy mi kc mj kg mk kk ly lz ma mb bi translated">对于开发/本地构建，将<code class="fe mc md me mf b">devtool</code>设置为<code class="fe mc md me mf b">cheap-module-eval-source-map</code>。</li><li id="9620" class="lr ls iq jp b jq mg ju mh jy mi kc mj kg mk kk ly lz ma mb bi translated">从“resolve”属性中删除不必要的扩展名。</li><li id="a855" class="lr ls iq jp b jq mg ju mh jy mi kc mj kg mk kk ly lz ma mb bi translated">从加载器规则中排除<code class="fe mc md me mf b">node_modules</code>以及构建/非src目录。</li><li id="1544" class="lr ls iq jp b jq mg ju mh jy mi kc mj kg mk kk ly lz ma mb bi translated">通过<a class="ae kl" href="https://webpack.js.org/guides/build-performance/" rel="noopener ugc nofollow" target="_blank">这些提示</a>优化你的webpack构建性能。</li><li id="4906" class="lr ls iq jp b jq mg ju mh jy mi kc mj kg mk kk ly lz ma mb bi translated">从<code class="fe mc md me mf b">ts-loader</code>禁用类型检查，并启用新的观察API。</li><li id="457e" class="lr ls iq jp b jq mg ju mh jy mi kc mj kg mk kk ly lz ma mb bi translated">使用<a class="ae kl" href="https://www.npmjs.com/package/fork-ts-checker-webpack-plugin" rel="noopener ugc nofollow" target="_blank">fork-ts-web pack-checker-plugin</a>在单独的进程上运行类型检查。</li></ol><pre class="kn ko kp kq gt ml mf mm mn aw mo bi"><span id="480d" class="ky kz iq mf b gy mp mq l mr ms">// webpack.config.js<br/>const path = require('path');<br/>const slsw = require('serverless-webpack');<br/>const nodeExternals = require('webpack-node-externals');<br/>const ForkTsCheckerWebpackPlugin = require('fork-ts-checker-webpack-plugin');<br/><br/>module.exports = {<br/>  context: __dirname,<br/>  mode: slsw.lib.webpack.isLocal ? 'development' : 'production',<br/>  entry: slsw.lib.entries,<br/>  devtool: slsw.lib.webpack.isLocal ? 'cheap-module-eval-source-map' : 'source-map',<br/>  resolve: {<br/>    extensions: ['.mjs', '.json', '.ts'],<br/>    symlinks: false,<br/>    cacheWithContext: false,<br/>  },<br/>  output: {<br/>    libraryTarget: 'commonjs',<br/>    path: path.join(__dirname, '.webpack'),<br/>    filename: '[name].js',<br/>  },<br/>  target: 'node',<br/>  externals: [nodeExternals()],<br/>  module: {<br/>    rules: [<br/>      // all files with a `.ts` or `.tsx` extension will be handled by `ts-loader`<br/>      {<br/>        test: /\.(tsx?)$/,<br/>        loader: 'ts-loader',<br/>        exclude: [<br/>          [<br/>            path.resolve(__dirname, 'node_modules'),<br/>            path.resolve(__dirname, '.serverless'),<br/>            path.resolve(__dirname, '.webpack'),<br/>          ],<br/>        ],<br/>        options: {<br/>          transpileOnly: true,<br/>          experimentalWatchApi: true,<br/>        },<br/>      },<br/>    ],<br/>  },<br/>  plugins: [<br/>    // new ForkTsCheckerWebpackPlugin({<br/>    //   eslint: true,<br/>    //   eslintOptions: {<br/>    //     cache: true<br/>    //   }<br/>    // })<br/>  ],<br/>};</span></pre><p id="85f5" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">8.(奖励)升级到web pack V5<a class="ae kl" href="https://webpack.js.org/migrate/5/" rel="noopener ugc nofollow" target="_blank">https://webpack.js.org/migrate/5/</a></p><h2 id="9451" class="ky kz iq bd la lb lc dn ld le lf dp lg jy lh li lj kc lk ll lm kg ln lo lp lq bi translated">优化serverless.yml</h2><ol class=""><li id="f1e4" class="lr ls iq jp b jq lt ju lu jy lv kc lw kg lx kk ly lz ma mb bi translated">为了用<code class="fe mc md me mf b">serverless-webpack </code>插件正确设置节点外部插件，你需要在你的无服务器. yml文件中设置<code class="fe mc md me mf b">custom: webpack: includeModules</code>选项，如无服务器webpack插件在这里提到的<a class="ae kl" href="https://github.com/serverless-heaven/serverless-webpack#node-modules--externals" rel="noopener ugc nofollow" target="_blank">，以便正确支持</a><a class="ae kl" href="https://github.com/liady/webpack-node-externals" rel="noopener ugc nofollow" target="_blank"> webpack节点外部插件</a></li><li id="930f" class="lr ls iq jp b jq mg ju mh jy mi kc mj kg mk kk ly lz ma mb bi translated">通过在<code class="fe mc md me mf b">serverless.yml</code>文件中设置<code class="fe mc md me mf b">apiGateway:minimumCompressionSize: 1024</code>，启用GZip压缩以最小化返回的响应大小</li><li id="a8d3" class="lr ls iq jp b jq mg ju mh jy mi kc mj kg mk kk ly lz ma mb bi translated">通过将<code class="fe mc md me mf b">environment: AWS_NODEJS_CONNECTION_REUSE_ENABLED: 1</code>设置为<a class="ae kl" href="https://docs.aws.amazon.com/sdk-for-javascript/v2/developer-guide/node-reusing-connections.html" rel="noopener ugc nofollow" target="_blank">重用HTTP连接</a>来启用AWS连接重用</li></ol><pre class="kn ko kp kq gt ml mf mm mn aw mo bi"><span id="f735" class="ky kz iq mf b gy mp mq l mr ms">//serverless.yml<br/>service:<br/>  name: aws-nodejs-typescript<br/># app and org for use with dashboard.serverless.com<br/>#app: your-app-name<br/>#org: your-org-name<br/><br/>custom:<br/>  webpack:<br/>    webpackConfig: ./webpack.config.js<br/>    includeModules: true<br/><br/># Add the serverless-webpack plugin<br/>plugins:<br/>  - serverless-webpack<br/><br/>provider:<br/>  name: aws<br/>  runtime: nodejs10.x<br/>  apiGateway:<br/>    minimumCompressionSize: 1024 # Enable gzip compression for responses &gt; 1 KB<br/>  environment:<br/>    AWS_NODEJS_CONNECTION_REUSE_ENABLED: 1<br/><br/>functions:<br/>  hello:<br/>    handler: handler.hello<br/>    events:<br/>      - http:<br/>          method: get<br/>          path: hello</span></pre><h2 id="bae9" class="ky kz iq bd la lb lc dn ld le lf dp lg jy lh li lj kc lk ll lm kg ln lo lp lq bi translated">结果:</h2><p id="ccbf" class="pw-post-body-paragraph jn jo iq jp b jq lt js jt ju lu jw jx jy mu ka kb kc mv ke kf kg mw ki kj kk ij bi translated">现在让我们来看看实施上述优化后的结果。感谢github用户<a class="ae kl" href="https://github.com/sapher" rel="noopener ugc nofollow" target="_blank"> <em class="na"> sapher </em> </a>在我<a class="ae kl" href="https://github.com/serverless/serverless/pull/6904" rel="noopener ugc nofollow" target="_blank">拉请求</a>后提供了自己对一个大项目的反馈。这些是他的结果</p><p id="c39d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">之前:</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="ks kt di ku bf kv"><div class="gh gi nb"><img src="../Images/e74747a346d2ee51a6578a4686fe81c2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ni8umos4z7BIVFaDfmUbGQ.png"/></div></div></figure><p id="f87d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">之后:</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="ks kt di ku bf kv"><div class="gh gi nc"><img src="../Images/1173c3f4d6f184d6fe9923941ebec307.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*2wpGDwNrSImtCTWaGAgdZw.png"/></div></div></figure><p id="5682" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如您所见，第一个文件的<strong class="jp ir"> 37 000% </strong>文件大小从<strong class="jp ir"> 5.9MB </strong>到<strong class="jp ir"> 13.8 KB </strong>，构建速度提高了<strong class="jp ir"> 3410% </strong>(从<strong class="jp ir"> 45.5秒</strong>到<strong class="jp ir"> 1.3秒</strong>！).</p><p id="7f29" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这些是模板hello world项目中没有依赖项的结果</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div class="gh gi nd"><img src="../Images/73549314dd7a54797a3f133abc01e803.png" data-original-src="https://miro.medium.com/v2/resize:fit:1224/format:webp/1*fF9ouBa_HltXHZaB3r6BMg.png"/></div></figure><p id="96c4" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">我在这里做了一个</strong> <a class="ae kl" href="https://github.com/serverless/serverless/pull/6904" rel="noopener ugc nofollow" target="_blank"> <strong class="jp ir">的拉请求</strong> </a> <strong class="jp ir">对2019年11月已经合并的</strong> <a class="ae kl" href="https://github.com/serverless/serverless" rel="noopener ugc nofollow" target="_blank"> <strong class="jp ir">无服务器库</strong> </a> <strong class="jp ir">做了这些改动。</strong></p><p id="04d5" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果您的项目是早期创建的，您可能希望通过查看pull请求中的更改来手动更新您的设置，正如您所看到的，它们实际上非常小，但是非常重要。</p></div><div class="ab cl ne nf hu ng" role="separator"><span class="nh bw bk ni nj nk"/><span class="nh bw bk ni nj nk"/><span class="nh bw bk ni nj"/></div><div class="ij ik il im in"><h2 id="6c61" class="ky kz iq bd la lb lc dn ld le lf dp lg jy lh li lj kc lk ll lm kg ln lo lp lq bi translated">优化总包装尺寸和部署速度</h2><p id="b55a" class="pw-post-body-paragraph jn jo iq jp b jq lt js jt ju lu jw jx jy mu ka kb kc mv ke kf kg mw ki kj kk ij bi translated">后来，我将打包的zip文件减少了一半以上，并通过以下方式加快了打包和部署速度:</p><ol class=""><li id="f349" class="lr ls iq jp b jq jr ju jv jy mx kc my kg mz kk ly lz ma mb bi translated"><a class="ae kl" href="https://webpack.js.org/migrate/5/#upgrade-webpack-cli-to-the-latest-available-version-when-used" rel="noopener ugc nofollow" target="_blank">更新到webpack v5 </a></li><li id="3402" class="lr ls iq jp b jq mg ju mh jy mi kc mj kg mk kk ly lz ma mb bi translated">运行<code class="fe mc md me mf b">sls deploy</code>时，通过使用<code class="fe mc md me mf b">aws-s3-accelerate</code>标志使用<a class="ae kl" href="https://docs.aws.amazon.com/AmazonS3/latest/dev/transfer-acceleration.html" rel="noopener ugc nofollow" target="_blank"> s3传输加速</a>,以更快地上传到s3，但需要额外付费。</li><li id="fc0f" class="lr ls iq jp b jq mg ju mh jy mi kc mj kg mk kk ly lz ma mb bi translated">从npm切换到yarn，通过运行<code class="fe mc md me mf b">yarn autoclean — init</code>和<code class="fe mc md me mf b">yarn autoclean — force</code>来利用<a class="ae kl" href="https://yarnpkg.com/en/docs/cli/autoclean" rel="noopener ugc nofollow" target="_blank">自动清理</a>功能，这清理了我的node_modules并从那里删除了不必要的文件，这要感谢serverless-webpack中的这个<a class="ae kl" href="https://github.com/serverless-heaven/serverless-webpack/issues/519" rel="noopener ugc nofollow" target="_blank"> github问题</a>。</li><li id="ea41" class="lr ls iq jp b jq mg ju mh jy mi kc mj kg mk kk ly lz ma mb bi translated">将<code class="fe mc md me mf b">serverless-webpack</code>插件配置为使用<code class="fe mc md me mf b">yarn autoclean</code>来包含<code class="fe mc md me mf b">node_modules</code>，并通过将它添加到我的serverless.yml来使用我配置的<code class="fe mc md me mf b">.yarnclean</code>文件</li></ol><pre class="kn ko kp kq gt ml mf mm mn aw mo bi"><span id="d0fc" class="ky kz iq mf b gy mp mq l mr ms">//serverless.yml<br/>webpack:</span><span id="e04e" class="ky kz iq mf b gy mt mq l mr ms">webpackConfig: ./webpack.config.js</span><span id="583f" class="ky kz iq mf b gy mt mq l mr ms">includeModules: true</span><span id="1b0a" class="ky kz iq mf b gy mt mq l mr ms">forceExclude:</span><span id="7963" class="ky kz iq mf b gy mt mq l mr ms">- aws-sdk</span><span id="f191" class="ky kz iq mf b gy mt mq l mr ms">packager: "yarn"</span><span id="36bd" class="ky kz iq mf b gy mt mq l mr ms">packagerOptions:</span><span id="e326" class="ky kz iq mf b gy mt mq l mr ms">scripts:</span><span id="27bf" class="ky kz iq mf b gy mt mq l mr ms">- yarn autoclean --init</span><span id="eb55" class="ky kz iq mf b gy mt mq l mr ms">- rm .yarnclean &amp;&amp; cat ../../.yarnclean &gt;&gt; .yarnclean &amp;&amp; echo '\n*.ts' &gt;&gt; .yarnclean</span><span id="a597" class="ky kz iq mf b gy mt mq l mr ms">- rm -rf node_modules/aws-sdk</span><span id="ad95" class="ky kz iq mf b gy mt mq l mr ms">- yarn autoclean --force</span></pre><p id="ea9d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">6.配置一个比通过<code class="fe mc md me mf b">yarn autoclean — init</code>创建的<a class="ae kl" href="https://gist.github.com/khaledosman/e145fffc2de691e780c7da246e2b3da4" rel="noopener ugc nofollow" target="_blank">文件更高级的</a> <code class="fe mc md me mf b"><a class="ae kl" href="https://gist.github.com/khaledosman/e145fffc2de691e780c7da246e2b3da4" rel="noopener ugc nofollow" target="_blank">.yarnclean</a></code>文件，该文件也使用由<a class="ae kl" href="https://github.com/tj/node-prune" rel="noopener ugc nofollow" target="_blank">节点修剪</a>删除的文件</p><p id="aeb2" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">7.通过serverless-webpack的<code class="fe mc md me mf b">packagerOptions.scripts</code>将aws-sdk从我的包中强制移除，我注意到即使aws-sdk被声明为devDependency并被externals pugin排除，它仍然通过<code class="fe mc md me mf b">aws-xray-sdk-core</code>被添加到我的包中，它将<code class="fe mc md me mf b">aws-sdk</code>声明为Dependency而不是peerDependency，所以它仍然出现在我的包中，在aws-xray-sdk中已经有一个关于这个的<a class="ae kl" href="https://github.com/aws/aws-xray-sdk-node/issues/113" rel="noopener ugc nofollow" target="_blank"> github问题</a>。</p><p id="d6d0" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">以上步骤有助于将我的一辆lambdas的包装尺寸从<strong class="jp ir"> 18MB </strong>一直减小到<strong class="jp ir"> 7MB </strong>，其他的从<strong class="jp ir"> 11MB </strong>减小到<strong class="jp ir">2.7 MB</strong></p></div></div>    
</body>
</html>