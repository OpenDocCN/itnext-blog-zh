<html>
<head>
<title>5 common pitfalls in Infrastructure as Code</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">代码基础设施中的5个常见陷阱</h1>
<blockquote>原文：<a href="https://itnext.io/5-common-pitfalls-in-infrastructure-as-code-3637ab6b02e0?source=collection_archive---------0-----------------------#2021-03-27">https://itnext.io/5-common-pitfalls-in-infrastructure-as-code-3637ab6b02e0?source=collection_archive---------0-----------------------#2021-03-27</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><figure class="ip iq gp gr ir is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi io"><img src="../Images/dddfa6da8a0f54c052f56f14e905852a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*7RTz2NJ_PVuxU8_b7gNSKg.jpeg"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">图片来自<a class="ae jd" href="https://pixabay.com/?utm_source=link-attribution&amp;utm_medium=referral&amp;utm_campaign=image&amp;utm_content=4280758" rel="noopener ugc nofollow" target="_blank"> Pixabay </a></figcaption></figure><div class=""/><h1 id="dff7" class="kd ke jg bd kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la bi translated">介绍</h1><p id="965e" class="pw-post-body-paragraph lb lc jg ld b le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly ij bi translated">现代的云原生基础架构可以在几分钟内创建和销毁。它可以根据负载和使用模式进行伸缩。</p><p id="31b1" class="pw-post-body-paragraph lb lc jg ld b le lz lg lh li ma lk ll lm mb lo lp lq mc ls lt lu md lw lx ly ij bi translated"><strong class="ld jh">基础设施即代码(IaC) </strong>是一种常见的模式，其中虚拟化基础设施和辅助服务可以使用几乎任何语言表达的配置来管理，通常托管在源代码库中。</p><h2 id="5e7b" class="me ke jg bd kf mf mg dn kj mh mi dp kn lm mj mk kr lq ml mm kv lu mn mo kz mp bi translated">为什么这很重要？</h2><p id="ed30" class="pw-post-body-paragraph lb lc jg ld b le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly ij bi translated">IaC支持自动、可重复且可靠地创建和维护任何虚拟化基础架构。如果您有兴趣了解更多可用的工具和实践，这里有一个列表供您参考:</p><p id="2260" class="pw-post-body-paragraph lb lc jg ld b le lz lg lh li ma lk ll lm mb lo lp lq mc ls lt lu md lw lx ly ij bi translated">Terraform、Pulumi和Crossplane都支持多个提供商，非常适合跨云运营。</p><p id="d055" class="pw-post-body-paragraph lb lc jg ld b le lz lg lh li ma lk ll lm mb lo lp lq mc ls lt lu md lw lx ly ij bi translated">Crossplane采用了一种非常有趣的IaC方法，利用了原生的Kubernetes结构，并自动“继承”了丰富的Kubernetes生态系统和工具。哦，它还有最酷的标志:)。</p><div class="ip iq gp gr ir mq"><a href="https://www.terraform.io/intro/index.html" rel="noopener  ugc nofollow" target="_blank"><div class="mr ab fo"><div class="ms ab mt cl cj mu"><h2 class="bd jh gy z fp mv fr fs mw fu fw jf bi translated">介绍HashiCorp的Terraform</h2><div class="mx l"><h3 class="bd b gy z fp mv fr fs mw fu fw dk translated">欢迎来到Terraform介绍指南！本指南是从Terraform开始的最佳地方。我们涵盖了什么地形…</h3></div><div class="my l"><p class="bd b dl z fp mv fr fs mw fu fw dk translated">www.terraform.io</p></div></div><div class="mz l"><div class="na l nb nc nd mz ne ix mq"/></div></div></a></div><div class="ip iq gp gr ir mq"><a href="https://www.pulumi.com/" rel="noopener  ugc nofollow" target="_blank"><div class="mr ab fo"><div class="ms ab mt cl cj mu"><h2 class="bd jh gy z fp mv fr fs mw fu fw jf bi translated">Pulumi -作为代码的现代基础设施</h2><div class="mx l"><h3 class="bd b gy z fp mv fr fs mw fu fw dk translated">建立服务于静态网站的基础设施通常比看起来更难——但幸运的是，这是一项任务…</h3></div><div class="my l"><p class="bd b dl z fp mv fr fs mw fu fw dk translated">www.pulumi.com</p></div></div><div class="mz l"><div class="nf l nb nc nd mz ne ix mq"/></div></div></a></div><div class="ip iq gp gr ir mq"><a href="https://crossplane.io/" rel="noopener  ugc nofollow" target="_blank"><div class="mr ab fo"><div class="ms ab mt cl cj mu"><h2 class="bd jh gy z fp mv fr fs mw fu fw jf bi translated">交叉平面</h2><div class="mx l"><h3 class="bd b gy z fp mv fr fs mw fu fw dk translated">Crossplane将Kubernetes风格的声明性和API驱动的配置和管理带到了任何一个…</h3></div><div class="my l"><p class="bd b dl z fp mv fr fs mw fu fw dk translated">交叉平面. io</p></div></div><div class="mz l"><div class="ng l nb nc nd mz ne ix mq"/></div></div></a></div><p id="b56d" class="pw-post-body-paragraph lb lc jg ld b le lz lg lh li ma lk ll lm mb lo lp lq mc ls lt lu md lw lx ly ij bi translated">还有特定于云供应商的工具和标准</p><p id="6350" class="pw-post-body-paragraph lb lc jg ld b le lz lg lh li ma lk ll lm mb lo lp lq mc ls lt lu md lw lx ly ij bi translated">天蓝色:</p><div class="ip iq gp gr ir mq"><a href="https://docs.microsoft.com/en-us/azure/azure-resource-manager/templates/" rel="noopener  ugc nofollow" target="_blank"><div class="mr ab fo"><div class="ms ab mt cl cj mu"><h2 class="bd jh gy z fp mv fr fs mw fu fw jf bi translated">ARM模板文档</h2><div class="mx l"><h3 class="bd b gy z fp mv fr fs mw fu fw dk translated">了解如何开发Azure资源管理器模板并使用它们来部署Azure资源</h3></div><div class="my l"><p class="bd b dl z fp mv fr fs mw fu fw dk translated">docs.microsoft.com</p></div></div><div class="mz l"><div class="nh l nb nc nd mz ne ix mq"/></div></div></a></div><div class="ip iq gp gr ir mq"><a href="https://compositionalit.github.io/farmer/" rel="noopener  ugc nofollow" target="_blank"><div class="mr ab fo"><div class="ms ab mt cl cj mu"><h2 class="bd jh gy z fp mv fr fs mw fu fw jf bi translated">农夫:农夫</h2><div class="mx l"><h3 class="bd b gy z fp mv fr fs mw fu fw dk translated">Farmer是一个简单易学的库，用于快速创作和部署整个Azure架构…</h3></div><div class="my l"><p class="bd b dl z fp mv fr fs mw fu fw dk translated">composition it . github . io</p></div></div></div></a></div><div class="ip iq gp gr ir mq"><a href="https://docs.microsoft.com/en-us/azure/azure-resource-manager/templates/bicep-overview#get-started" rel="noopener  ugc nofollow" target="_blank"><div class="mr ab fo"><div class="ms ab mt cl cj mu"><h2 class="bd jh gy z fp mv fr fs mw fu fw jf bi translated">用于Azure资源管理器模板的Bicep语言</h2><div class="mx l"><h3 class="bd b gy z fp mv fr fs mw fu fw dk translated">Bicep是一种声明式部署Azure资源的语言。您可以使用Bicep而不是JSON来开发您的…</h3></div><div class="my l"><p class="bd b dl z fp mv fr fs mw fu fw dk translated">docs.microsoft.com</p></div></div><div class="mz l"><div class="ni l nb nc nd mz ne ix mq"/></div></div></a></div><p id="443b" class="pw-post-body-paragraph lb lc jg ld b le lz lg lh li ma lk ll lm mb lo lp lq mc ls lt lu md lw lx ly ij bi translated">AWS:</p><div class="ip iq gp gr ir mq"><a href="https://aws.amazon.com/cloudformation/" rel="noopener  ugc nofollow" target="_blank"><div class="mr ab fo"><div class="ms ab mt cl cj mu"><h2 class="bd jh gy z fp mv fr fs mw fu fw jf bi translated">AWS CloudFormation -基础设施即代码和AWS资源供应</h2><div class="mx l"><h3 class="bd b gy z fp mv fr fs mw fu fw dk translated">通过基础架构加速云配置，因为代码AWS CloudFormation为您提供了一种对集合建模的简单方法…</h3></div><div class="my l"><p class="bd b dl z fp mv fr fs mw fu fw dk translated">aws.amazon.com</p></div></div><div class="mz l"><div class="nj l nb nc nd mz ne ix mq"/></div></div></a></div><p id="d95e" class="pw-post-body-paragraph lb lc jg ld b le lz lg lh li ma lk ll lm mb lo lp lq mc ls lt lu md lw lx ly ij bi translated">GCP:</p><div class="ip iq gp gr ir mq"><a href="https://cloud.google.com/deployment-manager" rel="noopener  ugc nofollow" target="_blank"><div class="mr ab fo"><div class="ms ab mt cl cj mu"><h2 class="bd jh gy z fp mv fr fs mw fu fw jf bi translated">云部署管理器|谷歌云</h2><div class="mx l"><h3 class="bd b gy z fp mv fr fs mw fu fw dk translated">使用简单的模板创建和管理云资源。查看该产品的文档。Google云部署…</h3></div><div class="my l"><p class="bd b dl z fp mv fr fs mw fu fw dk translated">cloud.google.com</p></div></div><div class="mz l"><div class="nk l nb nc nd mz ne ix mq"/></div></div></a></div><h1 id="53a6" class="kd ke jg bd kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la bi translated">常见错误</h1><p id="f059" class="pw-post-body-paragraph lb lc jg ld b le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly ij bi translated">正如每一次新的范式转变一样，在整个行业形成一套模式和采用策略之前，都需要时间。很多时候，许多公司试图在他们的组织中应用IaC原则，但由于常见的错误而失败。</p><p id="4a03" class="pw-post-body-paragraph lb lc jg ld b le lz lg lh li ma lk ll lm mb lo lp lq mc ls lt lu md lw lx ly ij bi translated">几乎所有的错误都来自于组织内思维模式的改变和文化转变的不足。简而言之，当事情变得复杂或不可收拾时，我们都有退回到众所周知的轨道的倾向。</p><h2 id="32e9" class="me ke jg bd kf mf mg dn kj mh mi dp kn lm mj mk kr lq ml mm kv lu mn mo kz mp bi translated">排名第一的宠物和牛</h2><p id="c9a5" class="pw-post-body-paragraph lb lc jg ld b le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly ij bi translated">当服务器和其他基础设施资产被视为固定资源时，通常会出现这种错误，其名称和IP地址位于一个模糊的excel文件中。</p><p id="4101" class="pw-post-body-paragraph lb lc jg ld b le lz lg lh li ma lk ll lm mb lo lp lq mc ls lt lu md lw lx ly ij bi translated">为了充分利用云原生基础设施，请考虑将您的基础设施视为牲畜。这样，基础设施就变成了一种资产或工件，比物理服务器更像应用程序。</p><h2 id="6c1b" class="me ke jg bd kf mf mg dn kj mh mi dp kn lm mj mk kr lq ml mm kv lu mn mo kz mp bi translated">排名第二的虚拟化数据中心</h2><p id="e4d7" class="pw-post-body-paragraph lb lc jg ld b le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly ij bi translated">如果您以前使用过物理数据中心，您可能会尝试将相同的概念移植到IaC。这是一个错误，因为云提供商担心的是数据中心。您应该使用的抽象是100%虚拟化的。</p><p id="caa1" class="pw-post-body-paragraph lb lc jg ld b le lz lg lh li ma lk ll lm mb lo lp lq mc ls lt lu md lw lx ly ij bi translated">数据中心的心理模型在使用IaC完成什么方面非常有限。例如:</p><ul class=""><li id="eebc" class="nl nm jg ld b le lz li ma lm nn lq no lu np ly nq nr ns nt bi translated">分成多个提供商</li><li id="00fa" class="nl nm jg ld b le nu li nv lm nw lq nx lu ny ly nq nr ns nt bi translated">缩减计算规模以降低成本</li><li id="1fbd" class="nl nm jg ld b le nu li nv lm nw lq nx lu ny ly nq nr ns nt bi translated">将交叉问题转移给第三方服务</li></ul><h2 id="9a02" class="me ke jg bd kf mf mg dn kj mh mi dp kn lm mj mk kr lq ml mm kv lu mn mo kz mp bi translated">#3不了解基础架构和数据之间的关系</h2><p id="fad8" class="pw-post-body-paragraph lb lc jg ld b le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly ij bi translated">数据是当今世界最重要的商品，因此保护数据自然成为所有组织关注的焦点。</p><p id="f01c" class="pw-post-body-paragraph lb lc jg ld b le lz lg lh li ma lk ll lm mb lo lp lq mc ls lt lu md lw lx ly ij bi translated">由于担心丢失/损坏数据，这种错误经常导致IaC采用率低。下面是一个非常简单的分步场景，展示了IaC如何安全地用于实时生产数据。</p><figure class="oa ob oc od gt is gh gi paragraph-image"><div class="gh gi nz"><img src="../Images/912cfd4d3fd2926cf0026918d01421a3.png" data-original-src="https://miro.medium.com/v2/resize:fit:904/format:webp/1*T9h8DfgPxUPJD_fXopoltA.png"/></div></figure><p id="77fb" class="pw-post-body-paragraph lb lc jg ld b le lz lg lh li ma lk ll lm mb lo lp lq mc ls lt lu md lw lx ly ij bi translated">理解基础设施随时都可能被创建和破坏是关键的概念。</p><h2 id="8e2e" class="me ke jg bd kf mf mg dn kj mh mi dp kn lm mj mk kr lq ml mm kv lu mn mo kz mp bi translated">#4突破开发和运营</h2><p id="4520" class="pw-post-body-paragraph lb lc jg ld b le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly ij bi translated">一旦开发和运营不再是孤岛，而是同一个连续的、不间断的、自动化的过程的一部分，DevOps移动承诺更快和更可靠的软件交付。</p><p id="0771" class="pw-post-body-paragraph lb lc jg ld b le lz lg lh li ma lk ll lm mb lo lp lq mc ls lt lu md lw lx ly ij bi translated">高度监管的业务领域中的公司往往倾向于孤立心态，因为这似乎是在推卸和分配责任，并且在实践中经常在“指责游戏”中给出明确的目标。这显然是逆向思维，不仅适用于IaC，也适用于其他领域。</p><p id="483f" class="pw-post-body-paragraph lb lc jg ld b le lz lg lh li ma lk ll lm mb lo lp lq mc ls lt lu md lw lx ly ij bi translated">在IaC中，这通常意味着分离开发团队和操作。</p><h2 id="ff0c" class="me ke jg bd kf mf mg dn kj mh mi dp kn lm mj mk kr lq ml mm kv lu mn mo kz mp bi translated">#5使用IaC作为奇特的部署脚本</h2><p id="c1d3" class="pw-post-body-paragraph lb lc jg ld b le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly ij bi translated">不要试图像PowerShell或bash那样将IaC作为一个花哨的脚本来自动创建基础设施。为了获得最大的好处，试着用软件的方式来考虑你的配置文件。它应该有正确的版本，有自己的CI/CD管道，应该经过测试并且是安全的。IaC的最大好处是你可以使用与你习惯的软件开发过程相同的开发人员工作流程。</p><p id="622c" class="pw-post-body-paragraph lb lc jg ld b le lz lg lh li ma lk ll lm mb lo lp lq mc ls lt lu md lw lx ly ij bi translated">此外，请尝试将IaC代码参数化，以提高可重用性。配置往往会增加复杂性，就像任何其他代码一样，努力应用DRY原则(不要重复)。</p><h2 id="787d" class="me ke jg bd kf mf mg dn kj mh mi dp kn lm mj mk kr lq ml mm kv lu mn mo kz mp bi translated">#6加分点:使用IaC作为配置管理</h2><p id="84b0" class="pw-post-body-paragraph lb lc jg ld b le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly ij bi translated">这个反模式很可能在IaC的第二天操作中出现。一旦配置了基础架构，并且一切正常运行，就会弹出一个请求，要求更改所配置资源的配置。</p><p id="adff" class="pw-post-body-paragraph lb lc jg ld b le lz lg lh li ma lk ll lm mb lo lp lq mc ls lt lu md lw lx ly ij bi translated">让我们假设您的基础架构在Azure中，并且想要为您的虚拟机向网络安全组(NSG)添加新规则。使用Terraform这样的工具很容易实现。乍一看，这可能听起来像是一个好的实践，但实际上围绕状态协调和漂移管理产生了问题。使用IaC工具来管理现有基础设施的配置和设置违反了<strong class="ld jh">不变性原则。</strong>相反，请将调配的基础架构视为完全不可变的，您可以调配新的基础架构，也可以销毁它并在其位置上创建新的基础架构。</p><p id="3a24" class="pw-post-body-paragraph lb lc jg ld b le lz lg lh li ma lk ll lm mb lo lp lq mc ls lt lu md lw lx ly ij bi translated">这种方法极大地简化了对基础设施状态的推理，并有助于维护清晰的操作模型。当然，这并不意味着配置更改是不可能的，而是使用专用的工具集来管理配置更改。像Ansible这样的工具与GitOps实践(Flux、ArgoCD等)相结合，将确保正确、等幂的变更过程。</p><p id="e940" class="pw-post-body-paragraph lb lc jg ld b le lz lg lh li ma lk ll lm mb lo lp lq mc ls lt lu md lw lx ly ij bi translated">简而言之，使用IaC工具将您的基础设施配置到期望的状态。使用Ansible或Consul等工具来管理现有基础架构的配置，检测和补救配置偏差。</p><h1 id="9285" class="kd ke jg bd kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la bi translated">最后的想法</h1><p id="e390" class="pw-post-body-paragraph lb lc jg ld b le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly ij bi translated">IaC不是银弹，也有自己的挑战，但在云原生计算的现代时代，没有更好的替代方案来管理基础架构。</p><p id="8fc5" class="pw-post-body-paragraph lb lc jg ld b le lz lg lh li ma lk ll lm mb lo lp lq mc ls lt lu md lw lx ly ij bi translated">稳步推进的所有工作负载的容器化和Kubernetes等编排器的不断出现，推动大多数组织朝着更复杂的软件和更快的变化率发展。</p><p id="702a" class="pw-post-body-paragraph lb lc jg ld b le lz lg lh li ma lk ll lm mb lo lp lq mc ls lt lu md lw lx ly ij bi translated">如果你还在考虑在你的组织中采用一些IaC实践，那就是昨天了。</p></div></div>    
</body>
</html>