<html>
<head>
<title>Better way to get secrets in serverless world</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在无服务器世界获得秘密的更好方法</h1>
<blockquote>原文：<a href="https://itnext.io/better-way-to-get-secrets-in-serverless-world-1aba8a71b3a1?source=collection_archive---------1-----------------------#2021-03-28">https://itnext.io/better-way-to-get-secrets-in-serverless-world-1aba8a71b3a1?source=collection_archive---------1-----------------------#2021-03-28</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="b3eb" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">最有可能的是，如果你正在积极地使用无服务器技术，你已经实现了这样一种助手来在运行时从secret Manager中检索一些秘密数据。我认为可能会有一些陷阱和需要改进的地方。</p><p id="4304" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在这个例子中，我们将实现一个助手来从<a class="ae kl" href="https://aws.amazon.com/ru/secrets-manager/" rel="noopener ugc nofollow" target="_blank"> AWS Secret Manager </a>获取秘密值</p><p id="ed0d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">欢迎你在船上拆卸这样的帮手！我们将使用typescript。基于这里使用的技术，将有可能使用任何编程语言(嗯，几乎)。</p><p id="0a1e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">让我们定义一下我们助手的初始<strong class="jp ir">【外观】</strong></p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="ks kt di ku bf kv"><div class="gh gi km"><img src="../Images/29ed861128c71349ee5887c8ad461394.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*n9h948tYjLwgDNNNyiI3Rw.png"/></div></div></figure><p id="9cad" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">已经可以出现问题了。为什么这么复杂？函数返回一个函数？我们一起想办法。首先，我们需要了解我们将如何使用这个助手。</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="ks kt di ku bf kv"><div class="gh gi ky"><img src="../Images/0455aa2f70eb7af2417699bd4d6c4f4e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*xnTR9J27rdUw_gYYrX8Uqg.png"/></div></div></figure><p id="2571" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><a class="ae kl" href="https://typeofnan.dev/what-is-a-higher-order-function/" rel="noopener ugc nofollow" target="_blank"> HOF </a>帮助我们“<strong class="jp ir">创建</strong>多个不同的函数，这些函数将通过不同的<strong class="jp ir">secret返回秘密值。</strong>这看起来比使用<strong class="jp ir"> secretId </strong>作为外部帮助者的单独参数更准确。如果没有HOF，就需要扩展助手本身的逻辑。</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="ks kt di ku bf kv"><div class="gh gi ky"><img src="../Images/c965bef615eaba691007d158374a5eb5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*sv5nuPidL1v5yNIcxLnf6w.png"/></div></div></figure><p id="883a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">到目前为止应该不会出现新的问题。让我们定义我们的助手的主要逻辑</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="ks kt di ku bf kv"><div class="gh gi km"><img src="../Images/7b56f05374e25e6bd3b16067ec208c69.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*u1YPPxBH0eLFEWbMYHLHmw.png"/></div></div></figure><p id="7ed6" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">没有什么特别的，我们接收<strong class="jp ir"> SecretString </strong>，然后解析它并尝试通过提供的键获取值。</p><p id="e94d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在这一点上，我们可以停下来，去喝杯咖啡/茶，重新观看《瑞克和莫蒂》的最佳剧集，但正如我之前所说的，有一个需要改进的地方有自己的缺陷。</p><blockquote class="kz la lb"><p id="4c3a" class="jn jo lc jp b jq jr js jt ju jv jw jx ld jz ka kb le kd ke kf lf kh ki kj kk ij bi translated">运行无服务器功能时，只要您在运行它，它就会保持活动状态(也称为热状态)。您的容器保持活动状态，准备就绪并等待执行。</p><p id="76bb" class="jn jo lc jp b jq jr js jt ju jv jw jx ld jz ka kb le kd ke kf lf kh ki kj kk ij bi translated">一段时间不活动后，您的云提供商将丢弃容器，您的功能将变为不活动状态(也称为cold)。</p></blockquote><p id="b72d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">来源:<a class="ae kl" href="https://www.serverless.com/blog/keep-your-lambdas-warm" rel="noopener ugc nofollow" target="_blank">https://www.serverless.com/blog/keep-your-lambdas-warm</a></p><p id="0dec" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在，我们可以了解这一事实，而不必再打电话给AWS Secrets Manager，因为这不仅耗费时间，还耗费金钱。一张简单的<strong class="jp ir">地图</strong>会帮助我们。</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="ks kt di ku bf kv"><div class="gh gi km"><img src="../Images/3b49d68d00a34cb6d1a21c804962d166.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*v41gwFMK8ekiJhH4wQ3yqA.png"/></div></div></figure><p id="b7be" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在成功接收到来自<strong class="jp ir"> secretManager </strong>的数据后，我们将它放入map中，其中key是secretId，value是一个经过解析的字符串(secret values)。因此，我们避免重复调用<strong class="jp ir"> secretManager，</strong>，因为我们直接从<strong class="jp ir"> Map </strong>中获取值(当然，以防lambda变暖)。</p><p id="7cd3" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">你可能认为这是结束了。但是有了这样的实现，你就可以很轻松的擦自己的脚了！让我们假设你有一个超级成功的创业公司。持续的交通让您的lambdas保持温暖！您查看日志并了解到您需要更改其中一个秘密值，因为一些API键被错误地定义为prod <em class="lc"> env </em>。打开<em class="lc"> aws控制台</em>，将数值更改为正确值。一段时间过去了，但是根据日志，lambda仍然不能正常工作。这导致永久温暖和助手使用来自<strong class="jp ir">地图的<strong class="jp ir">缓存的</strong>秘密值。</strong>怎么才能修复？正确，为我们的秘密添加一些到期时间，假设没有一个值在地图中的"<strong class="jp ir">缓存</strong>"不应该超过<em class="lc"> 10分钟。</em>来实施吧。这就是我们最终实现的<strong class="jp ir"> getSecretValues </strong> helper的样子</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="ks kt di ku bf kv"><div class="gh gi lg"><img src="../Images/64d4977c0bd68f51adb647b40be9288f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*vpc5YO18C-GFJqoqZ6bqRA.png"/></div></div></figure><p id="e83c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">希望对你有帮助。我欢迎任何形式的反馈。请随意与你的助手/技巧分享，这可能对无服务器世界有用。这个助手是我的<a class="ae kl" href="https://github.com/collierrgbsitisfise/serverless-bonk-template" rel="noopener ugc nofollow" target="_blank">无服务器模板</a>的一部分。在这里你可以找到助手的原始来源。</p></div></div>    
</body>
</html>