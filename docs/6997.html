<html>
<head>
<title>Use Lambda Function URL to write a Serverless app backed by DynamoDB</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Lambda函数URL编写一个由DynamoDB支持的无服务器应用程序</h1>
<blockquote>原文：<a href="https://itnext.io/use-lambda-function-url-to-write-a-serverless-app-backed-by-dynamodb-1fa3a05f3dae?source=collection_archive---------4-----------------------#2022-05-10">https://itnext.io/use-lambda-function-url-to-write-a-serverless-app-backed-by-dynamodb-1fa3a05f3dae?source=collection_archive---------4-----------------------#2022-05-10</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="86ad" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated"><em class="kf">这是一个使用AWS SAM </em>打包和部署的Go Lambda函数</h2></div><p id="fc86" class="pw-post-body-paragraph kg kh iq ki b kj kk jr kl km kn ju ko kp kq kr ks kt ku kv kw kx ky kz la lb ij bi translated"><a class="ae lc" href="https://docs.aws.amazon.com/lambda/latest/dg/lambda-urls.html" rel="noopener ugc nofollow" target="_blank"> Lambda函数URL </a>是一个相对较新的特性(在撰写这篇博客时)，它为您的Lambda函数提供了一个专用的HTTP(S)端点。当您只需要一个功能端点(例如作为一个webhook)并且不想设置和配置API网关时，它真的很有用。看起来我似乎永远也看不够！我已经写了几篇关于这个主题的博客文章，其中包括一个使用它来<a class="ae lc" rel="noopener ugc nofollow" target="_blank" href="/using-aws-lambda-function-url-to-build-a-serverless-backend-for-slack-a292ef355a5d">构建一个无服务器后台</a>然后<a class="ae lc" rel="noopener ugc nofollow" target="_blank" href="/package-and-deploy-a-lambda-function-as-a-docker-container-with-aws-cdk-fd0df5e37de7">使用AWS CDK </a>部署那个解决方案的实际例子。</p><figure class="le lf lg lh gt li gh gi paragraph-image"><div role="button" tabindex="0" class="lj lk di ll bf lm"><div class="gh gi ld"><img src="../Images/cdc3a945c3182c4c9c8117c5d1e1b4ac.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*ufSW66HoN_Cl7Y4w"/></div></div><figcaption class="lp lq gj gh gi lr ls bd b be z dk translated">Gabriel Heinzer 在<a class="ae lc" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</figcaption></figure><p id="f6fa" class="pw-post-body-paragraph kg kh iq ki b kj kk jr kl km kn ju ko kp kq kr ks kt ku kv kw kx ky kz la lb ij bi translated">这又是一篇博文(很短！)演示了如何使用Lambda函数URL编写一个由DynamoDB支持的简单应用程序。您将能够调用由Lambda函数URL公开的API端点，它将依次在DynamoDB上执行操作(<code class="fe lt lu lv lw b">GetItem</code>、<code class="fe lt lu lv lw b">PutItem</code>、<code class="fe lt lu lv lw b">Scan</code>)。使用<a class="ae lc" href="https://aws.amazon.com/sdk-for-go/" rel="noopener ugc nofollow" target="_blank"> AWS Go SDK </a>中的<a class="ae lc" href="https://pkg.go.dev/github.com/aws/aws-sdk-go-v2/service/dynamodb" rel="noopener ugc nofollow" target="_blank"> DynamoDB包</a>在Go中编写函数，并使用<a class="ae lc" href="https://docs.aws.amazon.com/serverless-application-model/latest/developerguide/what-is-sam.html" rel="noopener ugc nofollow" target="_blank"> AWS无服务器应用模型(SAM) </a>快速构建和部署解决方案。</p><blockquote class="lx ly lz"><p id="3b1a" class="kg kh ma ki b kj kk jr kl km kn ju ko mb kq kr ks mc ku kv kw md ky kz la lb ij bi translated"><em class="iq">代码是</em> <a class="ae lc" href="https://github.com/abhirockzz/lambda-functionurl-dynamodb-sam-go" rel="noopener ugc nofollow" target="_blank"> <em class="iq">可在GitHub </em> </a> <em class="iq">上找到供你参考</em></p></blockquote><p id="d0b6" class="pw-post-body-paragraph kg kh iq ki b kj kk jr kl km kn ju ko kp kq kr ks kt ku kv kw kx ky kz la lb ij bi translated">让我们开始吧！在您继续之前，请确保您已准备好以下事项:</p><h1 id="2725" class="me mf iq bd mg mh mi mj mk ml mm mn mo jw mp jx mq jz mr ka ms kc mt kd mu mv bi translated">先决条件</h1><ul class=""><li id="ee4d" class="mw mx iq ki b kj my km mz kp na kt nb kx nc lb nd ne nf ng bi translated"><a class="ae lc" href="https://portal.aws.amazon.com/gp/aws/developer/registration/index.html" rel="noopener ugc nofollow" target="_blank">如果您还没有AWS帐户，请创建一个帐户</a>并登录。您使用的IAM用户必须有足够的权限进行必要的AWS服务调用和管理AWS资源。</li><li id="9317" class="mw mx iq ki b kj nh km ni kp nj kt nk kx nl lb nd ne nf ng bi translated">安装和配置AWS CLI<a class="ae lc" href="https://docs.aws.amazon.com/cli/latest/userguide/install-cliv2.html" rel="noopener ugc nofollow" target="_blank"/></li><li id="eaa3" class="mw mx iq ki b kj nh km ni kp nj kt nk kx nl lb nd ne nf ng bi translated"><a class="ae lc" href="https://go.dev/dl/" rel="noopener ugc nofollow" target="_blank"> Go </a> ( <code class="fe lt lu lv lw b">1.16</code>或以上)安装</li><li id="a302" class="mw mx iq ki b kj nh km ni kp nj kt nk kx nl lb nd ne nf ng bi translated"><a class="ae lc" href="https://docs.aws.amazon.com/serverless-application-model/latest/developerguide/serverless-sam-cli-install.html" rel="noopener ugc nofollow" target="_blank">安装了AWS无服务器应用模型</a> (AWS SAM)</li><li id="eb1c" class="mw mx iq ki b kj nh km ni kp nj kt nk kx nl lb nd ne nf ng bi translated"><a class="ae lc" href="https://git-scm.com/book/en/v2/Getting-Started-Installing-Git" rel="noopener ugc nofollow" target="_blank"> Git已安装</a></li></ul></div><div class="ab cl nm nn hu no" role="separator"><span class="np bw bk nq nr ns"/><span class="np bw bk nq nr ns"/><span class="np bw bk nq nr"/></div><div class="ij ik il im in"><h1 id="d3f5" class="me mf iq bd mg mh nt mj mk ml nu mn mo jw nv jx mq jz nw ka ms kc nx kd mu mv bi translated">部署</h1><p id="2644" class="pw-post-body-paragraph kg kh iq ki b kj my jr kl km mz ju ko kp ny kr ks kt nz kv kw kx oa kz la lb ij bi translated">首先克隆Github repo，然后切换到正确的目录:</p><pre class="le lf lg lh gt ob lw oc od aw oe bi"><span id="588d" class="of mf iq lw b gy og oh l oi oj">git clone https://github.com/abhirockzz/lambda-functionurl-dynamodb-sam-go<br/>cd lambda-functionurl-dynamodb-sam-go</span></pre><p id="eefb" class="pw-post-body-paragraph kg kh iq ki b kj kk jr kl km kn ju ko kp kq kr ks kt ku kv kw kx ky kz la lb ij bi translated">使用AWS SAM构建应用程序:</p><pre class="le lf lg lh gt ob lw oc od aw oe bi"><span id="daad" class="of mf iq lw b gy og oh l oi oj">sam build</span></pre><p id="9f39" class="pw-post-body-paragraph kg kh iq ki b kj kk jr kl km kn ju ko kp kq kr ks kt ku kv kw kx ky kz la lb ij bi translated">现在您已经准备好部署应用程序了:</p><pre class="le lf lg lh gt ob lw oc od aw oe bi"><span id="4503" class="of mf iq lw b gy og oh l oi oj">sam deploy --guided</span></pre><p id="f595" class="pw-post-body-paragraph kg kh iq ki b kj kk jr kl km kn ju ko kp kq kr ks kt ku kv kw kx ky kz la lb ij bi translated">出现提示时，输入所需信息，如堆栈名称等。请参见下面的示例:</p><pre class="le lf lg lh gt ob lw oc od aw oe bi"><span id="cbda" class="of mf iq lw b gy og oh l oi oj">Configuring SAM deploy<br/>======================</span><span id="c744" class="of mf iq lw b gy ok oh l oi oj">        Looking for config file [samconfig.toml] :  Not found</span><span id="ecda" class="of mf iq lw b gy ok oh l oi oj">        Setting default arguments for 'sam deploy'<br/>        =========================================<br/>        Stack Name [sam-app]: <br/>        AWS Region [us-east-1]: <br/>        #Shows you resources changes to be deployed and require a 'Y' to initiate deploy<br/>        Confirm changes before deploy [y/N]: y<br/>        #SAM needs permission to be able to create roles to connect to the resources in your template<br/>        Allow SAM CLI IAM role creation [Y/n]: y<br/>        #Preserves the state of previously provisioned resources when an operation fails<br/>        Disable rollback [y/N]: n<br/>        DemoFunction Function Url may not have authorization defined, Is this okay? [y/N]: y<br/>        Save arguments to configuration file [Y/n]: <br/>        SAM configuration file [samconfig.toml]: <br/>        SAM configuration environment [default]:</span></pre><blockquote class="lx ly lz"><p id="5063" class="kg kh ma ki b kj kk jr kl km kn ju ko mb kq kr ks mc ku kv kw md ky kz la lb ij bi translated"><em class="iq">一旦您运行了一次</em> <code class="fe lt lu lv lw b"><em class="iq">sam deploy --guided</em></code> <em class="iq">模式并将参数保存到配置文件(samconfig.toml)中，您可以在以后使用</em> <code class="fe lt lu lv lw b"><em class="iq">sam deploy</em></code> <em class="iq">来使用这些默认值。</em></p></blockquote><p id="1b4c" class="pw-post-body-paragraph kg kh iq ki b kj kk jr kl km kn ju ko kp kq kr ks kt ku kv kw kx ky kz la lb ij bi translated">如果成功，您现在应该准备好以下内容:</p><ul class=""><li id="4aac" class="mw mx iq ki b kj kk km kn kp ol kt om kx on lb nd ne nf ng bi translated">带有HTTP(S) URL的Lambda函数</li><li id="bcca" class="mw mx iq ki b kj nh km ni kp nj kt nk kx nl lb nd ne nf ng bi translated">DynamoDB表(称为<code class="fe lt lu lv lw b">users</code>)</li><li id="432f" class="mw mx iq ki b kj nh km ni kp nj kt nk kx nl lb nd ne nf ng bi translated">具有Lambda和DynamoDB所需的最低权限的IAM角色(<code class="fe lt lu lv lw b">PutItem</code>、<code class="fe lt lu lv lw b">GetItem</code>和<code class="fe lt lu lv lw b">Scan</code>)</li></ul><blockquote class="lx ly lz"><p id="edea" class="kg kh ma ki b kj kk jr kl km kn ju ko mb kq kr ks mc ku kv kw md ky kz la lb ij bi translated"><em class="iq">注意SAM部署流程的输出。这包含测试所需的函数的HTTP URL端点</em></p></blockquote></div><div class="ab cl nm nn hu no" role="separator"><span class="np bw bk nq nr ns"/><span class="np bw bk nq nr ns"/><span class="np bw bk nq nr"/></div><div class="ij ik il im in"><h1 id="1670" class="me mf iq bd mg mh nt mj mk ml nu mn mo jw nv jx mq jz nw ka ms kc nx kd mu mv bi translated">测试应用程序</h1><p id="b8a2" class="pw-post-body-paragraph kg kh iq ki b kj my jr kl km mz ju ko kp ny kr ks kt nz kv kw kx oa kz la lb ij bi translated">测试集成包括向Lambda函数URL发送HTTP请求。这个例子使用了curl CLI，但是你也可以使用其他选项。</p><p id="7eed" class="pw-post-body-paragraph kg kh iq ki b kj kk jr kl km kn ju ko kp kq kr ks kt ku kv kw kx ky kz la lb ij bi translated">将Lambda函数URL端点导出为环境变量。</p><pre class="le lf lg lh gt ob lw oc od aw oe bi"><span id="8db3" class="of mf iq lw b gy og oh l oi oj">export LAMBDA_FUNCTION_URL_ENDPOINT=&lt;SAM deployment output&gt;</span><span id="2424" class="of mf iq lw b gy ok oh l oi oj">e.g. export LAMBDA_FUNCTION_URL_ENDPOINT=https://qfmpu2n74ik7m2m3ipv3m6yw5a0qiwmp.lambda-url.us-east-1.on.aws/</span></pre><p id="9fba" class="pw-post-body-paragraph kg kh iq ki b kj kk jr kl km kn ju ko kp kq kr ks kt ku kv kw kx ky kz la lb ij bi translated">调用端点在DynamoDB表中创建新条目:</p><pre class="le lf lg lh gt ob lw oc od aw oe bi"><span id="7f35" class="of mf iq lw b gy og oh l oi oj">curl -i -X POST -H "Content-Type: application/json" -d '{"email":"user1@foo.com", "username":"user-1"}' $LAMBDA_FUNCTION_URL_ENDPOINT</span><span id="2d2b" class="of mf iq lw b gy ok oh l oi oj">curl -i -X POST -H "Content-Type: application/json" -d '{"email":"user2@foo.com", "username":"user-2"}' $LAMBDA_FUNCTION_URL_ENDPOINT</span></pre><p id="c5a3" class="pw-post-body-paragraph kg kh iq ki b kj kk jr kl km kn ju ko kp kq kr ks kt ku kv kw kx ky kz la lb ij bi translated">在这两种情况下，您都应该得到HTTP <code class="fe lt lu lv lw b">201 Created</code>响应。这表明物品已经添加到DynamoDB中的<code class="fe lt lu lv lw b">users</code>表中。</p><p id="b0ba" class="pw-post-body-paragraph kg kh iq ki b kj kk jr kl km kn ju ko kp kq kr ks kt ku kv kw kx ky kz la lb ij bi translated">让我们检索刚刚创建的记录的信息(我们通过向URL添加一个<code class="fe lt lu lv lw b">query</code>参数(email)来实现):</p><pre class="le lf lg lh gt ob lw oc od aw oe bi"><span id="af11" class="of mf iq lw b gy og oh l oi oj">curl -i $LAMBDA_FUNCTION_URL_ENDPOINT?email=user2@foo.com</span></pre><p id="ca00" class="pw-post-body-paragraph kg kh iq ki b kj kk jr kl km kn ju ko kp kq kr ks kt ku kv kw kx ky kz la lb ij bi translated">要检索您刚刚添加的所有项目:</p><pre class="le lf lg lh gt ob lw oc od aw oe bi"><span id="0419" class="of mf iq lw b gy og oh l oi oj">curl -i $LAMBDA_FUNCTION_URL_ENDPOINT</span></pre><p id="6a5c" class="pw-post-body-paragraph kg kh iq ki b kj kk jr kl km kn ju ko kp kq kr ks kt ku kv kw kx ky kz la lb ij bi translated">尝试搜索尚未添加的项目:</p><pre class="le lf lg lh gt ob lw oc od aw oe bi"><span id="294b" class="of mf iq lw b gy og oh l oi oj">curl -i $LAMBDA_FUNCTION_URL_ENDPOINT?email=notthere@foo.com</span></pre><p id="7ac1" class="pw-post-body-paragraph kg kh iq ki b kj kk jr kl km kn ju ko kp kq kr ks kt ku kv kw kx ky kz la lb ij bi translated">在这种情况下，您将得到一个<code class="fe lt lu lv lw b">HTTP 404 Not Found</code>响应。</p><p id="9eb3" class="pw-post-body-paragraph kg kh iq ki b kj kk jr kl km kn ju ko kp kq kr ks kt ku kv kw kx ky kz la lb ij bi translated">最后，尝试插入一个重复的记录:</p><pre class="le lf lg lh gt ob lw oc od aw oe bi"><span id="7492" class="of mf iq lw b gy og oh l oi oj">curl -i -X POST -d '{"email":"user2@foo.com", "username":"user-2"}' $LAMBDA_FUNCTION_URL_ENDPOINT</span></pre><p id="928b" class="pw-post-body-paragraph kg kh iq ki b kj kk jr kl km kn ju ko kp kq kr ks kt ku kv kw kx ky kz la lb ij bi translated">在这种情况下，Lambda函数返回一个HTTP <code class="fe lt lu lv lw b">409 Conflict</code>，因为一个<a class="ae lc" href="https://docs.aws.amazon.com/amazondynamodb/latest/developerguide/Expressions.ConditionExpressions.html" rel="noopener ugc nofollow" target="_blank">条件表达式</a> ( <code class="fe lt lu lv lw b">attribute_not_exists(email)</code>)防止一个现有的项目(具有相同的<code class="fe lt lu lv lw b">email</code>)被<code class="fe lt lu lv lw b">PutItem</code>调用覆盖。</p><p id="8529" class="pw-post-body-paragraph kg kh iq ki b kj kk jr kl km kn ju ko kp kq kr ks kt ku kv kw kx ky kz la lb ij bi translated">就是这样！您已经尝试了Lambda函数公开的所有操作。</p></div><div class="ab cl nm nn hu no" role="separator"><span class="np bw bk nq nr ns"/><span class="np bw bk nq nr ns"/><span class="np bw bk nq nr"/></div><div class="ij ik il im in"><h1 id="f9e0" class="me mf iq bd mg mh nt mj mk ml nu mn mo jw nv jx mq jz nw ka ms kc nx kd mu mv bi translated">清除</h1><p id="7477" class="pw-post-body-paragraph kg kh iq ki b kj my jr kl km mz ju ko kp ny kr ks kt nz kv kw kx oa kz la lb ij bi translated">完成后，请删除堆栈:</p><pre class="le lf lg lh gt ob lw oc od aw oe bi"><span id="d41e" class="of mf iq lw b gy og oh l oi oj">sam delete --stack-name STACK_NAME</span></pre><p id="1d99" class="pw-post-body-paragraph kg kh iq ki b kj kk jr kl km kn ju ko kp kq kr ks kt ku kv kw kx ky kz la lb ij bi translated">确认堆栈已被删除</p><pre class="le lf lg lh gt ob lw oc od aw oe bi"><span id="488b" class="of mf iq lw b gy og oh l oi oj">aws cloudformation list-stacks --query "StackSummaries[?contains(StackName,'STACK_NAME')].StackStatus"</span></pre><h1 id="966d" class="me mf iq bd mg mh mi mj mk ml mm mn mo jw mp jx mq jz mr ka ms kc mt kd mu mv bi translated">总结一下！</h1><p id="cfad" class="pw-post-body-paragraph kg kh iq ki b kj my jr kl km mz ju ko kp ny kr ks kt nz kv kw kx oa kz la lb ij bi translated">这是一个简短(但希望有用)的教程！您可以使用它来快速引导一个无服务器应用程序，该应用程序具有DynamoDB后端，其功能由Lambda函数URL公开。</p><p id="356e" class="pw-post-body-paragraph kg kh iq ki b kj kk jr kl km kn ju ko kp kq kr ks kt ku kv kw kx ky kz la lb ij bi translated">编码快乐！</p></div></div>    
</body>
</html>