<html>
<head>
<title>Flutter Web: Razorpay Payment Gateway Integration</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Flutter Web: Razorpay支付网关集成</h1>
<blockquote>原文：<a href="https://itnext.io/flutter-web-razorpay-payment-gateway-integration-792d6e015409?source=collection_archive---------1-----------------------#2020-08-11">https://itnext.io/flutter-web-razorpay-payment-gateway-integration-792d6e015409?source=collection_archive---------1-----------------------#2020-08-11</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="bdbf" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如何使用razorpay web集成方法在flutter web平台上集成razorpay支付网关？</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi kl"><img src="../Images/c015da2f236ab3be005e50f9048dffa8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*a-7_hkm2dQd6NPRF"/></div></div><figcaption class="kx ky gj gh gi kz la bd b be z dk translated">照片由<a class="ae lb" href="https://unsplash.com/@morningbrew?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">晨酿</a>在<a class="ae lb" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>拍摄</figcaption></figure><p id="37e7" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">问题</strong>:官方razorpay <a class="ae lb" href="https://pub.dev/packages/razorpay_flutter" rel="noopener ugc nofollow" target="_blank">插件</a>还不支持web平台(<a class="ae lb" href="https://github.com/razorpay/razorpay-flutter/issues/43" rel="noopener ugc nofollow" target="_blank">参见GitHub问题</a>)而flutter官方webview <a class="ae lb" href="https://pub.dev/packages/webview_flutter" rel="noopener ugc nofollow" target="_blank">插件</a>也还不支持flutter web平台。</p><p id="71f6" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><em class="lc">本文假设您已经注册了RazorPay，并完成了所有手续，获得了API密钥，可以开始在您选择的平台上集成支付网关。</em></p><p id="eacb" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">概述:</strong>虽然flutter web仍处于测试阶段，但随着最近的更新，它的性能已经有所提高，很快我们就会看到正式的稳定版本。虽然flutter团队致力于在webview插件中支持web平台，但我们至少不必等到那时才实现这一功能。</p><p id="7215" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我目前正在使用flutter为iOS、android和web构建一个购物移动应用程序。到目前为止，我对flutter提供的开发经验感到满意。对于这个特殊的用例，我想集成一个支付网关，它可以在我的目标平台上工作。所以我是这样做的:</p><ol class=""><li id="eb7c" class="ld le iq jp b jq jr ju jv jy lf kc lg kg lh kk li lj lk ll bi translated">用IFrameElement注册了一个视图工厂，以便在flutter小部件上加载定制的HTML和javascript。</li><li id="dfc7" class="ld le iq jp b jq lm ju ln jy lo kc lp kg lq kk li lj lk ll bi translated">添加了事件监听器，以处理支付成功和失败事件，并根据事件采取进一步的行动(例如，显示成功页面)。</li><li id="da79" class="ld le iq jp b jq lm ju ln jy lo kc lp kg lq kk li lj lk ll bi translated">在flutter中从javascript调度消息/事件来处理它们。</li></ol><p id="2923" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">解决方案</strong></p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div class="gh gi lr"><img src="../Images/6697711ee1ca7d9d24cc73dcfc97ed2f.png" data-original-src="https://miro.medium.com/v2/resize:fit:860/1*vD_Ve5hKlLXO6Gk9kYR-Mw.gif"/></div><figcaption class="kx ky gj gh gi kz la bd b be z dk translated">Flutter Web上的RazorPay支付集成</figcaption></figure><p id="2e4c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">第一步:注册一个视图工厂</strong></p><p id="6a29" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">创建一个名为<em class="lc"> UiFake.dart </em>的类</p><pre class="km kn ko kp gt ls lt lu lv aw lw bi"><span id="1933" class="lx ly iq lt b gy lz ma l mb mc"><em class="lc">import </em>'dart:ui' <em class="lc">as </em>ui;<br/><br/><em class="lc">// ignore: camel_case_types<br/>class </em>platformViewRegistry {<br/><em class="lc">static registerViewFactory</em>(String viewId, <em class="lc">dynamic </em>cb) {<br/>ui.platformViewRegistry.registerViewFactory(viewId, cb);<br/>}<br/>}</span></pre><p id="af3e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">不要担心这个错误，它说“名称‘platformViewRegistry’通过前缀‘ui’被引用，但是它没有在任何使用该前缀导入的库中定义。”。就这样吧，它不会阻止你构建应用程序，尽管你可以在你的分析器中添加一个规则来忽略这个错误。</p><p id="f09c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">步骤2:创建HTML文件来初始化razorpay checkout </strong></p><p id="298e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在您的资产文件夹中，创建一个名为<strong class="jp ir"> "html" </strong>，<strong class="jp ir"> </strong>的文件夹，创建一个名为<strong class="jp ir"> "payment.html" </strong>的文件，内容如下</p><pre class="km kn ko kp gt ls lt lu lv aw lw bi"><span id="d532" class="lx ly iq lt b gy lz ma l mb mc">&lt;!DOCTYPE <em class="lc">html</em>&gt;&lt;html&gt;<br/>&lt;meta <em class="lc">name</em>="viewport" <em class="lc">content</em>="width=device-width"&gt;<br/>&lt;head&gt;&lt;title&gt;RazorPay Web Payment&lt;/title&gt;&lt;/head&gt;<br/>&lt;body&gt;<br/>&lt;script <em class="lc">src</em>="https://checkout.razorpay.com/v1/checkout.js"&gt;&lt;/script&gt;<br/>&lt;script&gt;<br/><br/>       var options = {<br/>         "key": "YOUR_KEY_HERE",<br/>          "amount": "50000", "currency": "INR",<br/>          "name": "Acme Corp",<br/>          "description": "Test Transaction",<br/>          "image": "https://example.com/your_logo",<br/>          "handler": function (response){<br/>             window.parent.postMessage("SUCCESS","*");      //2 <br/>             alert(response.razorpay_payment_id);<br/>             alert(response.razorpay_order_id);<br/>             alert(response.razorpay_signature)    <br/>          },    <br/>          "prefill": {        <br/>             "name": "Gaurav Kumar",        <br/>             "email": "gaurav.kumar@example.com",<br/>             "contact": "9999999999"   <br/>           },   <br/>           "notes": {        <br/>             "address": "Autofy"    <br/>          },    <br/>          "theme": {<br/>             "color": "#DF0145"    <br/>          },<br/>          "modal": {<br/>            "ondismiss": function(){<br/>               window.parent.postMessage("MODAL_CLOSED","*");   //3<br/>            }<br/>          }<br/>       };<br/><br/>       var rzp1 = new Razorpay(options);<br/>       window.onload = function(e){  //1  <br/>          rzp1.open();<br/>          e.preventDefault();<br/>       }<br/><br/>     &lt;/script&gt;<br/>&lt;/body&gt;<br/>&lt;/html&gt;</span></pre><ol class=""><li id="a0f1" class="ld le iq jp b jq jr ju jv jy lf kc lg kg lh kk li lj lk ll bi translated">在这里，我已经在页面加载时启动了结帐模式，这意味着当您导航到屏幕时(步骤3)，模式应该会立即出现。</li><li id="c819" class="ld le iq jp b jq lm ju ln jy lo kc lp kg lq kk li lj lk ll bi translated">为了处理支付成功，我在javascript中使用了<strong class="jp ir"><em class="lc">window . parent . postmessage(" SUCCESS "，" *)</em></strong>来让我们的flutter代码知道支付已经完成。也可以在这里发送自定义事件(参考:<a class="ae lb" href="https://developer.mozilla.org/en-US/docs/Web/Guide/Events/Creating_and_triggering_events" rel="noopener ugc nofollow" target="_blank"> Javascript自定义事件</a>)。了解更多关于如何安全使用postMessage的信息(参考:<a class="ae lb" href="https://developer.mozilla.org/en-US/docs/Web/API/Window/postMessage" rel="noopener ugc nofollow" target="_blank">本文</a>)。此外，请查看razorpay web集成文档，以更好地理解这些选项和处理函数是如何工作的。(<a class="ae lb" href="https://razorpay.com/docs/payment-gateway/web-integration/standard/" rel="noopener ugc nofollow" target="_blank"> RazorPay Web集成文档</a>)</li><li id="ecd2" class="ld le iq jp b jq lm ju ln jy lo kc lp kg lq kk li lj lk ll bi translated">为了在用户关闭结帐模式时处理事件，我从ondismiss方法中继了<strong class="jp ir"><em class="lc">window . parent . postmessage(" MODAL _ CLOSED "，" *)</em></strong>消息。</li><li id="2960" class="ld le iq jp b jq lm ju ln jy lo kc lp kg lq kk li lj lk ll bi translated">如果支付过程中出现任何错误，razorpay checkout modal只会提供重试支付的选项。</li></ol><p id="6e37" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">第三步:创建一个小工具</strong></p><p id="c895" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在让我们加载这个HTML文件来显示结帐模式并处理事件。</p><pre class="km kn ko kp gt ls lt lu lv aw lw bi"><span id="f3b1" class="lx ly iq lt b gy lz ma l mb mc"><em class="lc">import </em>'dart:html';<br/><em class="lc">import </em>'dart:ui' <em class="lc">as </em>ui;<br/><em class="lc">//conditional import<br/>import </em>'package:autofystore/utils/UiFake.dart' <em class="lc">if </em>(dart.library.html) 'dart:ui' <em class="lc">as </em>ui;<br/><em class="lc">import </em>'package:flutter/material.dart';<br/><br/><em class="lc">class </em>RazorPayWeb <em class="lc">extends </em>StatelessWidget {<br/>  @override<br/>  Widget build(BuildContext context) {<br/>    <em class="lc">//register view factory<br/>    </em>ui.platformViewRegistry.<em class="lc">registerViewFactory</em>("rzp-html",(int viewId) {<br/>      IFrameElement element=IFrameElement();<br/>//Event Listener</span><span id="1c2e" class="lx ly iq lt b gy md ma l mb mc">       window.onMessage.forEach((element) {<br/>        print('Event Received in callback: ${element.data}');<br/>        <em class="lc">if</em>(element.data=='MODAL_CLOSED'){<br/>          Navigator.<em class="lc">pop</em>(context);<br/>        }<em class="lc">else if</em>(element.data=='SUCCESS'){<br/>          print('PAYMENT SUCCESSFULL!!!!!!!');<br/>        }<br/>      });<br/><br/>      element.requestFullscreen();<br/>      element.src='assets/html/payment.html';<br/>      element.style.border = 'none';<br/>      <em class="lc">return </em>element;<br/>    });<br/>    <em class="lc">return </em>Scaffold(<br/>      body: Builder(builder: (BuildContext context) {<br/>          <em class="lc">return </em>Container(<br/>            child: HtmlElementView(viewType: 'rzp-html'),<br/>          );<br/>    }));<br/>  }<br/><br/>}</span></pre><p id="0729" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">让我解释一下这是怎么回事。</p><ol class=""><li id="8f20" class="ld le iq jp b jq jr ju jv jy lf kc lg kg lh kk li lj lk ll bi translated">我们有条件地导入了我们的<strong class="jp ir"> Uifake.dart </strong>类，以使用我们之前创建的静态方法注册我们的视图工厂。</li><li id="3824" class="ld le iq jp b jq lm ju ln jy lo kc lp kg lq kk li lj lk ll bi translated">我们已经注册了一个IFrameElement作为我们的视图工厂，并加载了HTML来显示结帐模式。</li><li id="4a50" class="ld le iq jp b jq lm ju ln jy lo kc lp kg lq kk li lj lk ll bi translated">我们使用onMessage监听器处理来自javascript的消息</li></ol><pre class="km kn ko kp gt ls lt lu lv aw lw bi"><span id="63da" class="lx ly iq lt b gy lz ma l mb mc">window.onMessage.forEach((element) {<br/>        print('Event Received in callback: ${element.data}');<br/>        <em class="lc">if</em>(element.data=='MODAL_CLOSED'){<br/>          Navigator.<em class="lc">pop</em>(context);<br/>        }<em class="lc">else if</em>(element.data=='SUCCESS'){<br/>          print('PAYMENT SUCCESSFULL!!!!!!!');<br/>        }<br/>      });</span></pre><p id="0d69" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果您想发送事件而不是消息，请使用<strong class="jp ir">window . addevent listener</strong>来代替。</p><p id="fabb" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这应该足以让razorpay支付在flutter web上运行。</p><p id="e643" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">那都是乡亲们。让我知道你的想法！</p><blockquote class="me mf mg"><p id="ec89" class="jn jo lc jp b jq jr js jt ju jv jw jx mh jz ka kb mi kd ke kf mj kh ki kj kk ij bi translated"><strong class="jp ir">注意:</strong>虽然这篇文章特别关注的是RazorPay，但是你可以应用同样的技术来集成任何其他的支付网关。</p></blockquote></div></div>    
</body>
</html>