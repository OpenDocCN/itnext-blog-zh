<html>
<head>
<title>New Razor Pages Project Backed with an API</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">由API支持的新Razor Pages项目</h1>
<blockquote>原文：<a href="https://itnext.io/new-razor-pages-project-backed-with-an-api-c4daa50b009d?source=collection_archive---------1-----------------------#2019-12-02">https://itnext.io/new-razor-pages-project-backed-with-an-api-c4daa50b009d?source=collection_archive---------1-----------------------#2019-12-02</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="e29d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">本周我们将添加一个<a class="ae kl" href="https://docs.microsoft.com/en-us/aspnet/core/razor-pages" rel="noopener ugc nofollow" target="_blank"> Razor Pages </a>项目，该项目将利用我们几周前创建的API。这篇文章是我的ASP.NET核心基础回购改造的一部分，我开始时。网芯3.0发布。关于我们如何在应用程序中达到当前点的详细信息，请查看以下帖子。</p><p id="90dc" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><a class="ae kl" href="https://elanderson.net/2019/10/swagger-openapi-with-nswag-and-asp-net-core-3/" rel="noopener ugc nofollow" target="_blank">带有NSwag和ASP.NET核心的Swagger/open API 3</a><br/><a class="ae kl" href="https://elanderson.net/2019/11/asp-net-core-3-add-entity-framework-core-to-existing-project/" rel="noopener ugc nofollow" target="_blank">ASP.NET核心3:向现有项目添加实体框架核心</a></p><p id="858e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这个帖子修改前的代码可以在这个<a class="ae kl" href="https://github.com/elanderson/ASP.NET-Core-Basics-Refresh/tree/14d130df7102c0603d532a2aef4d459292359b9d" rel="noopener ugc nofollow" target="_blank"> GitHub repo </a>里找到。</p><h2 id="6ef6" class="km kn iq bd ko kp kq dn kr ks kt dp ku jy kv kw kx kc ky kz la kg lb lc ld le bi translated">剃刀页项目</h2><p id="0992" class="pw-post-body-paragraph jn jo iq jp b jq lf js jt ju lg jw jx jy lh ka kb kc li ke kf kg lj ki kj kk ij bi translated">为应用程序添加一个新目录，然后在终端中导航到该目录。然后可以使用下面的命令来创建新的Razor Pages应用程序。</p><pre class="lk ll lm ln gt lo lp lq lr aw ls bi"><span id="329e" class="km kn iq lp b gy lt lu l lv lw">dotnet new webapp</span></pre><p id="6239" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">接下来，使用下面的命令将新项目添加到repo根目录下的解决方案文件中。当然，如果你不能使用相同的代码，你的文件名和路径会有所不同。</p><pre class="lk ll lm ln gt lo lp lq lr aw ls bi"><span id="2825" class="km kn iq lp b gy lt lu l lv lw">dotnet sln ..\..\BasicsRefresh.sln add ContactsRazorPages.csproj</span></pre><h2 id="2269" class="km kn iq bd ko kp kq dn kr ks kt dp ku jy kv kw kx kc ky kz la kg lb lc ld le bi translated">API访问设置</h2><p id="655a" class="pw-post-body-paragraph jn jo iq jp b jq lf js jt ju lg jw jx jy lh ka kb kc li ke kf kg lj ki kj kk ij bi translated">对于API访问，我们使用NSwag来生成我们的Razor页面应用程序将使用的客户端。对于API客户端的实际创建，请参见下面的帖子，因为这篇帖子将跳过实际的客户端生成过程。</p><p id="1009" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><a class="ae kl" href="https://elanderson.net/2019/11/using-nswag-to-generate-c-client-classes-for-asp-net-core-3/" rel="noopener ugc nofollow" target="_blank">使用NSwag为ASP.NET核心3 </a> <br/> <a class="ae kl" href="https://elanderson.net/2019/11/use-http-client-factory-with-nswag-generated-classes-in-asp-net-core-3/" rel="noopener ugc nofollow" target="_blank">生成C#客户端类使用HTTP客户端工厂与NSwag生成的类在ASP.NET核心3 </a></p><p id="1891" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">有了客户端生成的和Razor Pages项目中的本地API目录，我们现在可以配置和注册它，以便在我们的新项目中使用。首先，打开<strong class="jp ir"> apppsetting.json </strong>文件，为我们的API的URL添加一个设置，它是下面示例中的<strong class="jp ir"> ContactsApi </strong>值。</p><pre class="lk ll lm ln gt lo lp lq lr aw ls bi"><span id="4c88" class="km kn iq lp b gy lt lu l lv lw">{<br/>  "Logging": {<br/>    "LogLevel": {<br/>      "Default": "Information",<br/>      "Microsoft": "Warning",<br/>      "Microsoft.Hosting.Lifetime": "Information"<br/>    }<br/>  },<br/>  "AllowedHosts": "*",<br/>  "ContactsApi": "https://localhost:5001"<br/>}</span></pre><p id="c8db" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">接下来，在<strong class="jp ir"> Startup </strong>类的<strong class="jp ir"> ConfigureServices </strong>函数中，我们需要为我们的API注册一个HTTP客户端。</p><pre class="lk ll lm ln gt lo lp lq lr aw ls bi"><span id="94fd" class="km kn iq lp b gy lt lu l lv lw">public void ConfigureServices(IServiceCollection services)<br/>{<br/>    services.AddRazorPages()<br/>            .AddNewtonsoftJson();<br/><br/>    services.AddHttpClient&lt;IContactsClient, <br/>                           ContactsClient&gt;(client =&gt; <br/>             client.BaseAddress = new Uri(Configuration.GetSection("ContactsApi").Value));<br/>}</span></pre><h2 id="0963" class="km kn iq bd ko kp kq dn kr ks kt dp ku jy kv kw kx kc ky kz la kg lb lc ld le bi translated">添加页面</h2><p id="880b" class="pw-post-body-paragraph jn jo iq jp b jq lf js jt ju lg jw jx jy lh ka kb kc li ke kf kg lj ki kj kk ij bi translated">既然我们的API访问已经设置好了，我们需要创建允许用户与API交互的页面。首先，在现有的<strong class="jp ir">页面</strong>目录中添加一个<strong class="jp ir">联系人</strong>目录，这样所有处理与联系人API交互的页面将会在一起。</p><p id="47f2" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">注意</strong>下一位可能有用也可能没用。我想为联系人页面生成UI，而不是使用脚手架手动创建它们，但它需要实体框架才能工作，而这个新项目不使用实体框架。本节将向API项目添加一个临时引用，因为它确实使用了实体框架，以便生成相关的UI。如果您想手动创建关联的UI，可以跳过这一部分。</p><p id="1f94" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在<strong class="jp ir"> API项目</strong>中，向<strong class="jp ir"> ContactsDbContext </strong>类添加以下临时更改。</p><pre class="lk ll lm ln gt lo lp lq lr aw ls bi"><span id="1e92" class="km kn iq lp b gy lt lu l lv lw">public ContactsDbContext() {}<br/><br/>protected override void OnConfiguring(DbContextOptionsBuilder options) =&gt; <br/>          options.UseSqlite("Data Source=app.db");</span></pre><p id="8c88" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在我们需要从Razor Pages项目中添加一个对API项目的临时引用。为此，右键单击Razor Pages项目中的<strong class="jp ir">依赖关系</strong>节点，并选择<strong class="jp ir">添加引用</strong>。</p><figure class="lk ll lm ln gt ly gh gi paragraph-image"><div class="gh gi lx"><img src="../Images/69724c50a5bd5f7f907459c836f3a295.png" data-original-src="https://miro.medium.com/v2/resize:fit:630/format:webp/0*EiXAs_FBZd4gMgBN.png"/></div></figure><p id="7f0d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在<strong class="jp ir">项目</strong>部分，选中API项目的复选框，并点击<strong class="jp ir">确定</strong>。</p><figure class="lk ll lm ln gt ly gh gi paragraph-image"><div class="gh gi mb"><img src="../Images/d867623af6442f1c387278eb4aca0a09.png" data-original-src="https://miro.medium.com/v2/resize:fit:1372/format:webp/0*i2YjcrN0_26ZfzD7.png"/></div></figure><p id="604a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在有了上面的内容，我们就可以搭建我们的UI了。右键单击您希望生成的UI所在的文件夹，在我们的例子中是<strong class="jp ir"> Pages/Contacts </strong>目录。从菜单中选择<strong class="jp ir">添加&gt;新脚手架项目</strong>。</p><figure class="lk ll lm ln gt ly gh gi paragraph-image"><div class="gh gi mc"><img src="../Images/c95cab67d10bbc988f083430b52dd119.png" data-original-src="https://miro.medium.com/v2/resize:fit:1396/format:webp/0*b_Ns_2uqI8vl0xRC.png"/></div></figure><p id="ad40" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在显示的对话框中，我们希望使用实体框架(CRUD) 选择<strong class="jp ir"> Razor页面，然后单击<strong class="jp ir">添加</strong>。</strong></p><figure class="lk ll lm ln gt ly gh gi paragraph-image"><div role="button" tabindex="0" class="me mf di mg bf mh"><div class="gh gi md"><img src="../Images/126577cae18dcb5be36630e3df3017d8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*P3enQppI96LsUGgg.png"/></div></div></figure><p id="c8b0" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在下一个屏幕上，我们将从为其生成UI的实体的API项目中选择<strong class="jp ir">模型类</strong>和<strong class="jp ir">数据上下文类</strong>，然后单击<strong class="jp ir">添加</strong>。</p><figure class="lk ll lm ln gt ly gh gi paragraph-image"><div class="gh gi mi"><img src="../Images/31d2a57b496176a4fdf2b7479817a668.png" data-original-src="https://miro.medium.com/v2/resize:fit:1172/format:webp/0*71yoo1fVNafVS9R9.png"/></div></figure><p id="8860" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">几秒钟后，我们需要查看、创建、编辑和删除联系人的所有页面都将存在。现在我们已经生成了页面，我们需要删除对API项目的引用。为此，展开<strong class="jp ir">依赖项&gt;项目</strong>节点，右键单击API项目并选择<strong class="jp ir">移除</strong>。</p><figure class="lk ll lm ln gt ly gh gi paragraph-image"><div role="button" tabindex="0" class="me mf di mg bf mh"><div class="gh gi mj"><img src="../Images/1a716dd2f11b0fd77e2051dac4a5213b.png" data-original-src="https://miro.medium.com/v2/resize:fit:770/format:webp/0*O4HGpo31Yb2hVfFz.png"/></div></div></figure><p id="34e2" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">此外，恢复我们对上面的DbContext所做的更改。</p><p id="245b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">既然对API项目的引用已经消失，那么Razor Pages应用程序就不会构建了。这是意料之中的，因为它使用了API项目中的一些类。我们将遍历修复<strong class="jp ir"> Contacts </strong>目录中的<strong class="jp ir"> Index </strong>页面中的问题所需的编辑，但是所有生成的类都需要相同类型的更改。</p><p id="6729" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">首先，我们需要改变一些用法。移除任何与usings相关的实体框架。然后更改任何与Contacts API相关的内容，改为引用项目本地的API客户端。</p><pre class="lk ll lm ln gt lo lp lq lr aw ls bi"><span id="a68a" class="km kn iq lp b gy lt lu l lv lw">Before:<br/>using Microsoft.EntityFrameworkCore;<br/>using ContactsApi.Data;<br/>using ContactsApi.Models; <br/><br/>After:<br/>using Apis;</span></pre><p id="240c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">另一大项是用API客户机替换实体框架DB上下文的注入，并用对API的调用更新相关调用。以下是存在实体框架位的<strong class="jp ir"> IndexModel </strong>。</p><pre class="lk ll lm ln gt lo lp lq lr aw ls bi"><span id="95bd" class="km kn iq lp b gy lt lu l lv lw">public class IndexModel : PageModel<br/>{<br/>    private readonly ContactsApi.Data.ContactsDbContext _context;<br/><br/>    public IndexModel(ContactsApi.Data.ContactsDbContext context)<br/>    {<br/>        _context = context;<br/>    }<br/><br/>    public IList&lt;Contact&gt; Contact { get;set; }<br/><br/>    public async Task OnGetAsync()<br/>    {<br/>        Contact = await _context.Contacts.ToListAsync();<br/>    }<br/>}</span></pre><p id="a2fd" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这是使用API客户端的最终结果。</p><pre class="lk ll lm ln gt lo lp lq lr aw ls bi"><span id="1bfc" class="km kn iq lp b gy lt lu l lv lw">public class IndexModel : PageModel<br/>{<br/>    private readonly IContactsClient _client;<br/><br/>    public IndexModel(IContactsClient client)<br/>    {<br/>        _client = client;<br/>    }<br/><br/>    public IList&lt;Contact&gt; Contact { get;set; }<br/><br/>    public async Task OnGetAsync()<br/>    {<br/>        Contact = (await _client.GetContactsAsync()).ToList();<br/>    }<br/>}</span></pre><p id="fe14" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如上所述，这种事情需要为其他生成的页面重复。</p><p id="d333" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">结束警告</strong></p><h2 id="1724" class="km kn iq bd ko kp kq dn kr ks kt dp ku jy kv kw kx kc ky kz la kg lb lc ld le bi translated">添加到导航栏</h2><p id="b252" class="pw-post-body-paragraph jn jo iq jp b jq lf js jt ju lg jw jx jy lh ka kb kc li ke kf kg lj ki kj kk ij bi translated">现在我们已经创建了页面，我们需要为用户添加一个访问它们的方法。为此，我们将在导航栏中添加一个联系人选项。打开<strong class="jp ir">Pages/Shared/_ layout . cs html</strong>文件。找到需要进行更改的地方的最简单的方法是搜索一个现有导航链接的文本。下面是添加了新项目的链接部分。</p><pre class="lk ll lm ln gt lo lp lq lr aw ls bi"><span id="a951" class="km kn iq lp b gy lt lu l lv lw">&lt;ul class="navbar-nav flex-grow-1"&gt;<br/>    &lt;li class="nav-item"&gt;<br/>        &lt;a class="nav-link text-dark" asp-area="" asp-page="/Index"&gt;Home&lt;/a&gt;<br/>    &lt;/li&gt;<br/>    &lt;li class="nav-item"&gt;<br/>        &lt;a class="nav-link text-dark" asp-area="" asp-page="Contacts/Index"&gt;Contacts&lt;/a&gt;<br/>    &lt;/li&gt;<br/>    &lt;li class="nav-item"&gt;<br/>        &lt;a class="nav-link text-dark" asp-area="" asp-page="/Privacy"&gt;Privacy&lt;/a&gt;<br/>    &lt;/li&gt;<br/>&lt;/ul&gt;</span></pre><h2 id="ab27" class="km kn iq bd ko kp kq dn kr ks kt dp ku jy kv kw kx kc ky kz la kg lb lc ld le bi translated">包扎</h2><p id="7dea" class="pw-post-body-paragraph jn jo iq jp b jq lf js jt ju lg jw jx jy lh ka kb kc li ke kf kg lj ki kj kk ij bi translated">使用Nswag生成的客户端使得将一个应用程序连接到一个API变得非常简单，并不是说手动操作本身很难。这篇文章的大部分内容都是关于我在客户端应用程序中生成UI的过程。值得吗？我不确定。我想无论哪种方式，当您有可用的实体框架数据时，知道它是一个选项是很好的。</p><p id="213c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><a class="ae kl" href="https://github.com/elanderson/ASP.NET-Core-Basics-Refresh/tree/30bda427fdc7db27b754c0263e4bb76f855bfeb7" rel="noopener ugc nofollow" target="_blank">这里的</a>是这篇帖子最后状态的代码。</p></div><div class="ab cl mk ml hu mm" role="separator"><span class="mn bw bk mo mp mq"/><span class="mn bw bk mo mp mq"/><span class="mn bw bk mo mp"/></div><div class="ij ik il im in"><p id="25d5" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><em class="mr">最初发表于</em> <a class="ae kl" href="https://elanderson.net/2019/12/new-razor-pages-application-backed-with-an-api/" rel="noopener ugc nofollow" target="_blank"> <em class="mr">埃里克·安德森</em> </a> <em class="mr">。</em></p></div></div>    
</body>
</html>