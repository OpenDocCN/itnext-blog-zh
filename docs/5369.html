<html>
<head>
<title>WebRTC for beginners; How calls work from the outside!</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">面向初学者的WebRTC从外面打电话是如何工作的！</h1>
<blockquote>原文：<a href="https://itnext.io/webrtc-for-beginners-how-it-all-works-from-the-outside-3c806f582229?source=collection_archive---------1-----------------------#2021-02-19">https://itnext.io/webrtc-for-beginners-how-it-all-works-from-the-outside-3c806f582229?source=collection_archive---------1-----------------------#2021-02-19</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="523f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">WebRTC是一个支持实时通信(RTC)的开放框架，对于视频音频通话、聊天、P2P文件共享等非常有用</p><p id="1f2b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">它是实时通信的开放标准，为如此多的产品提供动力，并被用于大型组织的生产中。例如，Google Meet，Discord，Facebook Messenger，以及更多由WebRTC支持的应用。像Zoom这样的应用程序间接使用WebRTC作为数据通道。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi kl"><img src="../Images/4aecca209e4a56a9cb8c5f4c66adc366.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*N-pdeZWP4KaZWoQYjApi-w.png"/></div></div></figure><p id="17e5" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">让我们来看看一些与WebRTC相关的术语和材料，同时我们了解在连接两个用户进行视频通话时它是如何工作的。</p><h1 id="32c1" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">&lt;&gt; IP地址和NAT</h1><p id="6d69" class="pw-post-body-paragraph jn jo iq jp b jq lv js jt ju lw jw jx jy lx ka kb kc ly ke kf kg lz ki kj kk ij bi translated">我们都知道每台设备都必须有一个<strong class="jp ir"> <em class="ma">唯一的</em> </strong> IP地址才能访问互联网。但是，当可用IP地址的数量少于想要使用互联网的用户数量时，会发生什么呢？<a class="ae mb" href="https://en.wikipedia.org/wiki/IPv4_address_exhaustion" rel="noopener ugc nofollow" target="_blank"> IPv4地址</a>正是这种情况。</p><figure class="km kn ko kp gt kq"><div class="bz fp l di"><div class="mc md l"/></div></figure><p id="062e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">IPv6经过精心设计，旨在避免未来出现这些问题。</p><p id="b619" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">但是为了解决IPv4的这个问题，在路由器中使用了网络地址转换(NAT)，它为其下面的设备使用自己的一组IP地址，也称为<em class="ma">本地/私有</em> IP地址(10.x.x.x，192.168.x.x，172 . 16 . 0 . 0–172 . 31 . 255 . 255)。只有本地网络的NAT和对等体可以通过这个<em class="ma">私有</em>地址进行通信。</p><p id="8831" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">因此，由于NAT，我们将有两个IP地址；一个是<strong class="jp ir">公共地址，</strong>与<strong class="jp ir"> </strong>路由器相关联，仅从外部可见，另一个是<strong class="jp ir">私有地址</strong>，仅对于连接到同一路由器的那些人可见。</p><h1 id="33a4" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated"><strong class="ak"> &lt; / &gt; </strong></h1><p id="2d1d" class="pw-post-body-paragraph jn jo iq jp b jq lv js jt ju lw jw jx jy lx ka kb kc ly ke kf kg lz ki kj kk ij bi translated">仅仅通过IP地址不可能直接连接两个对等体。大多数连接需要你传递一个唯一的地址来定位你在互联网上的位置，一个中继服务器来传递媒体，如果你的路由器不允许P2P连接，最后但同样重要的是，你必须绕过防火墙。</p><p id="9909" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">为了促进这一点，使用一个称为<a class="ae mb" href="https://www.geeksforgeeks.org/interactive-connectivity-establishment-ice/" rel="noopener ugc nofollow" target="_blank">交互式连接建立(ICE) </a>的框架来连接终端用户。</p><h1 id="81e4" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">建立联系的步骤</h1><p id="de4d" class="pw-post-body-paragraph jn jo iq jp b jq lv js jt ju lw jw jx jy lx ka kb kc ly ke kf kg lz ki kj kk ij bi translated">在建立直接连接之前，我们需要在客户端之间来回传递一些信息。这正是WebRTC不完全是<a class="ae mb" href="https://www.investopedia.com/terms/p/peertopeer-p2p-service.asp" rel="noopener ugc nofollow" target="_blank"> P2P </a>的原因。</p><p id="d50c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">为了初始化连接，需要信令服务器在对等体之间传输一些基本信息。一旦连接建立，我们就不再需要信令服务器了。</p><p id="a144" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在让我们来看看发信号时需要做的步骤。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div class="gh gi me"><img src="../Images/7778b0e808275e6427cf4060104ed57c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1330/format:webp/1*AElvgD3SVUkKvB-BH97gJA.png"/></div></figure><ol class=""><li id="9019" class="mf mg iq jp b jq jr ju jv jy mh kc mi kg mj kk mk ml mm mn bi translated">第一个用户必须向另一个用户发送提供SDP。</li><li id="4759" class="mf mg iq jp b jq mo ju mp jy mq kc mr kg ms kk mk ml mm mn bi translated">第二个用户必须接受该SDP，并发送应答SDP作为回报。</li><li id="024e" class="mf mg iq jp b jq mo ju mp jy mq kc mr kg ms kk mk ml mm mn bi translated">然后，第一个用户应该接受该SDP，此后，他们中的任何一个必须将生成的ICE候选发送给另一个。</li><li id="9e33" class="mf mg iq jp b jq mo ju mp jy mq kc mr kg ms kk mk ml mm mn bi translated">后者必须接受收到的候选人。</li></ol><p id="c3e3" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">做完这些，连接就建立了。</p><p id="3a16" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">但是现在你搞不清楚什么是SDP，什么是ICE候选，对吧？别担心。</p><h1 id="e491" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">会话描述协议(SDP)</h1><p id="5d3b" class="pw-post-body-paragraph jn jo iq jp b jq lv js jt ju lw jw jx jy lx ka kb kc ly ke kf kg lz ki kj kk ij bi translated"><a class="ae mb" href="https://tools.ietf.org/html/rfc4566" rel="noopener ugc nofollow" target="_blank">会话描述协议或简称SDP </a>，是一种用于描述多媒体会话的协议。通常，它包含连接的多媒体内容的描述，如分辨率、格式、编解码器、加密等。这被传送，以便在连接建立之前，另一个对等体可以知道媒体将被发送的内容和方式。</p><p id="d915" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">因此，传输SDP意味着在直接连接(P2P)建立之后，您将告诉其他用户您将要发送的内容。</p><h1 id="4171" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi">&lt;/&gt;</h1><p id="ec61" class="pw-post-body-paragraph jn jo iq jp b jq lv js jt ju lw jw jx jy lx ka kb kc ly ke kf kg lz ki kj kk ij bi translated">现在，在我们看一看ICE候选对象是什么之前，让我们试着了解更多关于如何与ICE框架建立连接的信息。</p><p id="d960" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">让我们尝试一些WebRTC视频通话的场景。</p><p id="a5ec" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir"> <em class="ma">场景1:两个用户都通过本地网络连接:</em> </strong></p><p id="79f4" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果两个用户都在本地网络上，那么相互连接没有问题。他们可以直接相互通信，只需他们的本地/私有IP地址。但大多数情况下，这是不太可能发生的情况。</p><p id="6398" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir"> <em class="ma">场景2:两个用户都通过互联网连接:</em> </strong></p><p id="56ea" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">当两个用户都不在本地网络下时，连接就变得有点复杂。由于NAT，用户只能看到他的<em class="ma">私有</em> IP地址，无法从本地网络外部建立连接。</p><p id="d628" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">为了克服这个问题，我们使用了一个STUN服务器。</p><h1 id="6329" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">&lt;&gt;<strong class="ak">NAT会话遍历实用程序(STUN) </strong></h1><p id="bf08" class="pw-post-body-paragraph jn jo iq jp b jq lv js jt ju lw jw jx jy lx ka kb kc ly ke kf kg lz ki kj kk ij bi translated"><a class="ae mb" href="https://help.singlecomm.com/hc/en-us/articles/115007993947-STUN-servers-A-Quick-Start-Guide" rel="noopener ugc nofollow" target="_blank"> STUN服务器</a>允许客户端找出它们的<em class="ma">公共</em> IP地址和它们背后的NAT类型。该信息用于稍后建立媒体连接。在大多数情况下，STUN是促进连接所必需的。</p><p id="828c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">通过在发送SDP之前联系STUN服务器，一个用户可以与另一个用户连接，即使他们不在本地网络上。</p><h1 id="b7ee" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi">&lt;/&gt;</h1><p id="a600" class="pw-post-body-paragraph jn jo iq jp b jq lv js jt ju lw jw jx jy lx ka kb kc ly ke kf kg lz ki kj kk ij bi translated"><strong class="jp ir"> <em class="ma">场景3:两个用户都通过互联网连接，但无法直接连接:</em> </strong></p><p id="99ef" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">有人可能认为，使用STUN服务器可以解决互联网连接的所有问题。知道<em class="ma">公共</em> IP地址是很好的，但是这可能还不足以建立连接。存在根本不可能直接连接的情况。</p><blockquote class="mt mu mv"><p id="7da8" class="jn jo ma jp b jq jr js jt ju jv jw jx mw jz ka kb mx kd ke kf my kh ki kj kk ij bi translated">大约80%的连接可以通过使用本地IP地址或使用STUN和公共IP地址来解决。</p></blockquote><p id="6a80" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">有些情况可能是。其中一个对等体位于对称NAT(一种更安全的NAT)之后，或者简单地说，防火墙不允许P2P连接。在这些情况下，我们需要一个服务器在整个连接过程中在两个对等体之间中继媒体，不像STUN服务器那样，在连接建立之前只需要一次。</p><p id="1c08" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们这里用的叫回合服务器。</p><h1 id="0fb8" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">&lt;&gt; <strong class="ak">穿越使用中继NAT </strong>(转)</h1><p id="b3b4" class="pw-post-body-paragraph jn jo iq jp b jq lv js jt ju lw jw jx jy lx ka kb kc ly ke kf kg lz ki kj kk ij bi translated">TURN服务器用于绕过对称NAT限制，并通过该服务器中继所有信息/媒体。第一个对等体必须创建到TURN服务器的连接，并要求另一个对等体也这样做，以便另一个对等体发送到服务器的所有信息都被转发给前者。</p><blockquote class="mt mu mv"><p id="2ffe" class="jn jo ma jp b jq jr js jt ju jv jw jx mw jz ka kb mx kd ke kf my kh ki kj kk ij bi translated">TURN服务器通常集成了自己的STUN服务器，因此不需要额外的STUN服务器。轮流服务器通常被称为“中继服务器”。</p></blockquote><p id="f88b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">正如你可能知道的，由于带宽的使用，TURN服务器的维护成本通常很高。因此，只有在没有其他连接方式的情况下才应该使用它。</p><h1 id="da11" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi">&lt;/&gt;</h1><p id="08ca" class="pw-post-body-paragraph jn jo iq jp b jq lv js jt ju lw jw jx jy lx ka kb kc ly ke kf kg lz ki kj kk ij bi translated">现在你可能会想，在建立联系之前，有太多的东西要看。那么，怎么可能总是使用高效的路径进行交流呢？</p><p id="5614" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这就是冰架的切入点。WebRTC为要建立的连接找到最有效的网络路径。</p><h1 id="271b" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">&lt;&gt;冰候选</h1><p id="5b49" class="pw-post-body-paragraph jn jo iq jp b jq lv js jt ju lw jw jx jy lx ka kb kc ly ke kf kg lz ki kj kk ij bi translated">就像SDP用于交换介质信息一样，对等体也必须交换网络连接信息。这就是<a class="ae mb" href="https://developer.mozilla.org/en-US/docs/Web/API/RTCIceCandidate" rel="noopener ugc nofollow" target="_blank"> ICE候选人</a>的作用。它们包含关于可用通信方法的所有细节，如直接连接或通过TURN服务器。</p><p id="1551" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">ICE候选是由WebRTC框架本身自动生成的，并且应该尽快通过信令发送到另一个对等体，以获得可能的最佳连接路由。</p><blockquote class="mt mu mv"><p id="e9e1" class="jn jo ma jp b jq jr js jt ju jv jw jx mw jz ka kb mx kd ke kf my kh ki kj kk ij bi translated">只有在提供/回答交换发生后，才应接受收到的ICE候选。处理ICE候选者是大多数时候人们会发现WebRTC存在问题的地方。</p></blockquote><h1 id="958a" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi">&lt;/&gt;</h1><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi mz"><img src="../Images/bd4ce1bd23c19bb0f8c705b011006719.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*8ZhZ5muYnkz7u2duz4NqzA.png"/></div></div></figure><p id="17c9" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">因此，在WebRTC中已经建立了成功的对等连接。</p></div><div class="ab cl na nb hu nc" role="separator"><span class="nd bw bk ne nf ng"/><span class="nd bw bk ne nf ng"/><span class="nd bw bk ne nf"/></div><div class="ij ik il im in"><h1 id="fed2" class="kx ky iq bd kz la nh lc ld le ni lg lh li nj lk ll lm nk lo lp lq nl ls lt lu bi translated">如果你觉得这份材料有用，请不要忘记鼓掌👏并与你的同伴分享。如果你在上面的材料中发现了错误或误导，请留下评论。</h1><p id="073e" class="pw-post-body-paragraph jn jo iq jp b jq lv js jt ju lw jw jx jy lx ka kb kc ly ke kf kg lz ki kj kk ij bi translated">如果你想支持我，你可以请我喝咖啡</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><a href="https://www.buymeacoffee.com/karthikeyans"><div class="gh gi nm"><img src="../Images/6d60b235fcc46a4bd696b90e886419ee.png" data-original-src="https://miro.medium.com/v2/resize:fit:340/format:webp/1*Dpw8-hNGI2fDmosV4E8DVQ.png"/></div></a></figure><p id="90f2" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">可以在</strong> <a class="ae mb" href="https://www.linkedin.com/in/karthikeyanssvk/" rel="noopener ugc nofollow" target="_blank"> <strong class="jp ir"> LinkedIn </strong> </a> <strong class="jp ir">上联系我，在</strong><a class="ae mb" href="https://github.com/coder-with-a-bushido" rel="noopener ugc nofollow" target="_blank"><strong class="jp ir">GitHub</strong></a><strong class="jp ir">上关注我的作品或者给我发</strong> <a class="ae mb" href="mailto:karthikeyanssvk@gmail.com" rel="noopener ugc nofollow" target="_blank"> <strong class="jp ir">邮件</strong> </a> <strong class="jp ir">。</strong></p></div><div class="ab cl na nb hu nc" role="separator"><span class="nd bw bk ne nf ng"/><span class="nd bw bk ne nf ng"/><span class="nd bw bk ne nf"/></div><div class="ij ik il im in"><h1 id="fe85" class="kx ky iq bd kz la nh lc ld le ni lg lh li nj lk ll lm nk lo lp lq nl ls lt lu bi translated">祝您愉快！🎉</h1></div></div>    
</body>
</html>