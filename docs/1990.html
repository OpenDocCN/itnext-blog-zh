<html>
<head>
<title>Handling Redux Side-Effects — the RxJS way</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">处理Redux副作用RxJS方法</h1>
<blockquote>原文：<a href="https://itnext.io/handling-redux-side-effects-the-rxjs-way-59c057b12cd4?source=collection_archive---------2-----------------------#2019-03-08">https://itnext.io/handling-redux-side-effects-the-rxjs-way-59c057b12cd4?source=collection_archive---------2-----------------------#2019-03-08</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><figure class="is it gp gr iu iv gh gi paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="gh gi ir"><img src="../Images/db85de0b30f8de6d82798ef230144af9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*uzZci5HfxN2sZPs1gUPuTw.png"/></div></div></figure><div class=""/><p id="7b23" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">你好陌生人！如果你正在使用Redux，你可能会遇到我们在Orfium前端团队遇到的同样的问题——Redux副作用(也许这就是为什么你也在读这篇文章😎).如果没有，那就等着吧，很快就会发生的。让我引导你通过我们的故事和发现。</p><h2 id="e7e4" class="kz la je bd lb lc ld dn le lf lg dp lh km li lj lk kq ll lm ln ku lo lp lq lr bi translated">副作用以及我们为什么需要它们</h2><p id="4da4" class="pw-post-body-paragraph kb kc je kd b ke ls kg kh ki lt kk kl km lu ko kp kq lv ks kt ku lw kw kx ky im bi translated">常规操作正在被调度，因此某些状态正在被改变。</p><p id="7427" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">假设现在有一个列表，需要从服务器获取信息来填充它。在这种情况下，您需要调度一个操作—来自服务器的请求—响应(成功/错误)时，调度另一个操作来更新状态(加载、结果等)。这是一个副作用。</p><blockquote class="lx"><p id="dabf" class="ly lz je bd ma mb mc md me mf mg ky dk translated">这是如此普遍和2017年的权利？</p></blockquote><p id="4ce3" class="pw-post-body-paragraph kb kc je kd b ke mh kg kh ki mi kk kl km mj ko kp kq mk ks kt ku ml kw kx ky im bi translated">虽然现在你有一个你实际上不能处理的行动。如果用户点击那个按钮，并且有多个请求，最重要的是多个状态更新，这会破坏您完美的应用程序，那么您可以触发相同的操作。如果你可以取消，等待，去抖和一般处理这些行动。剧透预警，可以！</p><p id="ba00" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">有两个主要选项可以处理具有上述优点的副作用操作(不包括thunks)</p><ul class=""><li id="3ee7" class="mm mn je kd b ke kf ki kj km mo kq mp ku mq ky mr ms mt mu bi translated">redux observable —基于RxJS，使用observable监听动作</li><li id="c889" class="mm mn je kd b ke mv ki mw km mx kq my ku mz ky mr ms mt mu bi translated">redux saga——它使用新添加的javascript生成器来处理副作用</li></ul><h1 id="b58e" class="na la je bd lb nb nc nd le ne nf ng lh nh ni nj lk nk nl nm ln nn no np lq nq bi translated">RX副作用</h1><p id="2c3c" class="pw-post-body-paragraph kb kc je kd b ke ls kg kh ki lt kk kl km lu ko kp kq lv ks kt ku lw kw kx ky im bi translated">使用redux observable你可以改变你的操作方式。我不会详细说明你如何安装它，因为你可以很容易地阅读这个<a class="ae nr" href="https://redux-observable.js.org/docs/basics/Epics.html" rel="noopener ugc nofollow" target="_blank">这里</a>。我会更深入地研究它的复杂部分，比如</p><ul class=""><li id="9589" class="mm mn je kd b ke kf ki kj km mo kq mp ku mq ky mr ms mt mu bi translated">如何形成一部史诗</li><li id="3a78" class="mm mn je kd b ke mv ki mw km mx kq my ku mz ky mr ms mt mu bi translated">冗余表单(如何处理它们)</li><li id="2263" class="mm mn je kd b ke mv ki mw km mx kq my ku mz ky mr ms mt mu bi translated">用状态测试</li><li id="b416" class="mm mn je kd b ke mv ki mw km mx kq my ku mz ky mr ms mt mu bi translated">轻松测试操作</li></ul></div><div class="ab cl ns nt hx nu" role="separator"><span class="nv bw bk nw nx ny"/><span class="nv bw bk nw nx ny"/><span class="nv bw bk nw nx"/></div><div class="im in io ip iq"><p id="b0cc" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">让我们想象一个简单的场景。对服务器的一个请求，如果成功或失败，我们将发送一些动作来更新我们的reducer。</p><p id="82da" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">让我们看看这种情况在代码中是怎样的。</p><figure class="nz oa ob oc gt iv"><div class="bz fp l di"><div class="od oe l"/></div></figure><p id="0450" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">让我把它分解一下。</p><p id="8841" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">在上面的例子中，我们定义了一个新的史诗。然后使用类型的<strong class="kd jf">，我们等待<strong class="kd jf">类型的动作_请求</strong>被触发。当它被触发时，我们转到<strong class="kd jf"> switchMap </strong>，在这里我们限制我们得到的请求。切换映射一次运行一个请求，因此其他任何请求都将被忽略，这样可以避免多个请求。然后通过</strong>中的<strong class="kd jf">，我们将承诺请求转换为可观察的请求。最后，我们使用<strong class="kd jf"> mergeMap </strong>来获取响应(想象a .then on a promise ),然后我们返回一组动作，并对错误进行同样的处理。</strong></p><p id="0203" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">如果您想首先显示一个加载来指示数据的加载/获取，该怎么办？</p><p id="ccb2" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">现在，您可以在请求数据之前轻松添加一个操作。</p><figure class="nz oa ob oc gt iv"><div class="bz fp l di"><div class="od oe l"/></div></figure><p id="898b" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">我们使用<strong class="kd jf"> concat </strong>来按照定义的顺序运行其中的两个动作(loadingList和request)。变得容易了？</p><p id="f857" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">现在您已经做好了所有准备，并且正在使用redux表单来处理您的数据。你怎么知道当你在那个漂亮的表格中按下提交键时，它会得到提交状态来显示正在加载的动画呢？这个想法是一样的。让我们看看这样的事情是如何完成的。</p><figure class="nz oa ob oc gt iv"><div class="bz fp l di"><div class="od oe l"/></div></figure><p id="2522" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">这里我们稍微改变一下逻辑。同样，我们也在等待类型为的<strong class="kd jf">部分的相同操作。在本例中，我们希望将formName传递给Epic，以便执行上面显示的操作。在<strong class="kd jf"> switchMap </strong>中，我们期待两件事，一个有效载荷和一个元！是的一个meta。元持有有效负载不必知道的逻辑。你可以在这里看到<a class="ae nr" href="https://medium.com/@jtbennett/standard-actions-in-redux-c6a415c8aea4" rel="noopener">更多关于为什么以及何时使用它的细节。再次使用concat和redux表单动作startSubmit，我们可以定义表单开始提交内容。不要忘记在成功和错误时都<strong class="kd jf">停止提交</strong>。就是这样！</a></strong></p><p id="2cca" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">我建议你总是用那个名字调度一个请求动作，比如<strong class="kd jf"> ACTION_REQUEST </strong>或者<strong class="kd jf">FETCH _ BLAH _ LIST _ REQUEST</strong>。这样你就会知道这是一个史诗般的副作用。</p><p id="a8b3" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">您现在可以使用<strong class="kd jf"> takeUntil </strong>并在事件发生后停止监听任何成功事件。这有助于解决经典的网飞问题。当你导航到一个详细信息页面开始抓取时，你会返回到另一个详细信息页面，而第一页开始解析并弄乱你当前的页面。</p><p id="191e" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">这个问题在这里<a class="ae nr" href="https://www.youtube.com/watch?v=AslncyG8whg" rel="noopener ugc nofollow" target="_blank">得到了很好的解释</a>来自<a class="of og ep" href="https://medium.com/u/5b0111cff646?source=post_page-----59c057b12cd4--------------------------------" rel="noopener" target="_blank">杰伊菲尔普斯</a>我推荐你去看一看。</p><figure class="nz oa ob oc gt iv"><div class="bz fp l di"><div class="od oe l"/></div></figure><p id="0729" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">现在我们有和以前一样的例子，但是我们只放了<strong class="kd jf"> takeUntil </strong>操作符。现在，如果它监听<strong class="kd jf"> PAGE_CHANGED </strong>动作，它不会取消请求，但会忽略当前请求的任何解析。耶！！现在，如果你愿意，你可以用axios实现一个可取消的请求。</p><h1 id="6a9e" class="na la je bd lb nb nc nd le ne nf ng lh nh ni nj lk nk nl nm ln nn no np lq nq bi translated"><strong class="ak">轻松测试RxJS</strong></h1><p id="ce18" class="pw-post-body-paragraph kb kc je kd b ke ls kg kh ki lt kk kl km lu ko kp kq lv ks kt ku lw kw kx ky im bi translated">我发现redux-observable教程在测试方面有点高级和混乱。我知道为什么，但在大多数情况下，你不需要这样的东西，所以我会提出一个简单的测试解决方案。</p><p id="a2b7" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">Redux observable从模块中给了我们两个东西ActionsObservable和StateObservable。您可以使用它们来创建用于测试的可观测量。我们之所以使用它们，是因为在库上，通过史诗的动作是用这些动作创建的，所以因为我们将尝试比较这两个动作，所以它们需要完全相同。</p><p id="a556" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">让我们试着测试我们的第一个例子。</p><figure class="nz oa ob oc gt iv"><div class="bz fp l di"><div class="od oe l"/></div></figure><p id="7d03" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">在这里，我们定义了两件事:一个是触发史诗的可观察动作的<strong class="kd jf">动作$ </strong>，另一个是我们预期史诗将返回的动作数组的<strong class="kd jf">预期变量</strong>。此外，我们用模拟响应模拟axios (fetch，axios，无论您对http请求有什么)解析。最后，有趣的是，我们将action$传递给我们想要测试的epic，我们将epic的结果转换成一个带有<strong class="kd jf">的数组。pipe(toArray()) </strong>然后我们用<strong class="kd jf">做一个承诺。top promise()</strong>所以我们可以用async await等待它结束。现在我们可以很容易地比较什么史诗返回到我们所期待的！</p><p id="b582" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">下面是对请求错误的测试</p><figure class="nz oa ob oc gt iv"><div class="bz fp l di"><div class="od oe l"/></div></figure><p id="010e" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">使用这种技术，你可以很容易地测试任何epic，并确定每个epic的预期。</p></div><div class="ab cl ns nt hx nu" role="separator"><span class="nv bw bk nw nx ny"/><span class="nv bw bk nw nx ny"/><span class="nv bw bk nw nx"/></div><div class="im in io ip iq"><p id="f8b0" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">希望你喜欢我的例子，redux observables对于日常使用这些例子更有意义。</p><blockquote class="lx"><p id="1df8" class="ly lz je bd ma mb mc md me mf mg ky dk translated">如果你喜欢这篇文章，可以考虑点击clap👏并且你可以随时访问<a class="ae nr" href="https://medium.com/@panagiotisvrs" rel="noopener">我的其他文章</a>🔥</p></blockquote><p id="0021" class="pw-post-body-paragraph kb kc je kd b ke mh kg kh ki mi kk kl km mj ko kp kq mk ks kt ku ml kw kx ky im bi translated">如果你有更多关于如何使用它的例子，请在下面的评论中分享。</p><div class="is it gp gr iu oh"><a href="https://redux-form.com/6.0.0-rc.4/docs/api/actioncreators.md/" rel="noopener  ugc nofollow" target="_blank"><div class="oi ab fo"><div class="oj ab ok cl cj ol"><h2 class="bd jf gy z fp om fr fs on fu fw jd bi translated">冗余形式</h2><div class="oo l"><h3 class="bd b gy z fp om fr fs on fu fw dk translated">在Redux中管理表单状态的最佳方式。</h3></div><div class="op l"><p class="bd b dl z fp om fr fs on fu fw dk translated">redux-form.com</p></div></div></div></a></div><div class="is it gp gr iu oh"><a href="https://redux-observable.js.org/" rel="noopener  ugc nofollow" target="_blank"><div class="oi ab fo"><div class="oj ab ok cl cj ol"><h2 class="bd jf gy z fp om fr fs on fu fw jd bi translated">介绍冗余-可观察</h2><div class="oo l"><h3 class="bd b gy z fp om fr fs on fu fw dk translated">编辑描述</h3></div><div class="op l"><p class="bd b dl z fp om fr fs on fu fw dk translated">redux-observable.js.org</p></div></div><div class="oq l"><div class="or l os ot ou oq ov ja oh"/></div></div></a></div></div></div>    
</body>
</html>