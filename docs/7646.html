<html>
<head>
<title>Serve files at scale with OutSystems, AWS S3 and CloudFront</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">通过OutSystems、AWS S3和CloudFront大规模提供文件服务</h1>
<blockquote>原文：<a href="https://itnext.io/serve-files-at-scale-with-outsystems-and-aws-s3-and-cloudfront-6f0b11a37866?source=collection_archive---------1-----------------------#2022-12-07">https://itnext.io/serve-files-at-scale-with-outsystems-and-aws-s3-and-cloudfront-6f0b11a37866?source=collection_archive---------1-----------------------#2022-12-07</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="2962" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在本文中，我将介绍如何将系统外的文件存储卸载到AWS S3，并使用AWS CloudFront大规模提供私有S3存储桶对象。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi kl"><img src="../Images/bcb5fb955f39ebcfbb120febf76a0633.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*4gFLKLCxWNC9XtBs0B5QtQ.png"/></div></div></figure><p id="880d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在外部系统应用程序中存储和检索文件的最简单方法是在数据模型中使用二进制数据类型。文件在数据库中存储为BLOB(二进制大对象),可以使用聚合进行查询。</p><p id="58c0" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">从我的角度来看，对于较小的文件和较小的数量完全足够了。然而，超过一定的容量，外部系统数据库中的文件存储就不再足够或有用。</p><p id="df73" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">提供文件的二进制数据属性的主要缺点是:</p><ul class=""><li id="d0b2" class="kx ky iq jp b jq jr ju jv jy kz kc la kg lb kk lc ld le lf bi translated">不支持<strong class="jp ir">文件流</strong>和<strong class="jp ir">字节范围请求</strong> —当通过聚合进行查询时，必须从数据库中读取二进制数据属性的完整内容，并在外部系统前端服务器上进行处理。之后，向客户端应用程序的传输又是一次完整的下载。对于流媒体来说，这是不合适的，因为例如不可能直接跳到视频的某个时间点。此外，这会造成延迟，对用户体验有负面影响。</li></ul><p id="c495" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">字节范围支持不仅与流媒体相关，还与通过下载管理器的多个连接(多部分下载)或中断下载的恢复相关。</p><p id="08ae" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">流媒体还包括web优化的PDF文档—线性化PDF —可以直接在应用程序中显示，例如，使用Adobe PDF Embed。</p><p id="eb63" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">Microsoft SQL Server具有FILESTREAM功能，非结构化数据存储在文件系统中，可以通过API作为流再次提供给应用程序。但是，OutSystems不支持FILESTREAM特性。</p><ul class=""><li id="7633" class="kx ky iq jp b jq jr ju jv jy kz kc la kg lb kk lc ld le lf bi translated"><strong class="jp ir">内存使用</strong> —前端服务器从外部系统数据库中检索数据，并缓存在主内存中。随着大量大文件的同时读取，这很快会导致内存溢出和内存交换，从而大大降低性能，甚至会导致超时。</li></ul><p id="bb1e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">Microsoft SQL Server还处理主内存中的数据，如果有许多文件检索，则必须相应地确定主内存使用的优先级，从而导致整体数据查询速度变慢。</p><p id="4ea9" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">总之</strong></p><ul class=""><li id="3c8e" class="kx ky iq jp b jq jr ju jv jy kz kc la kg lb kk lc ld le lf bi translated">不支持流媒体</li><li id="31ca" class="kx ky iq jp b jq lg ju lh jy li kc lj kg lk kk lc ld le lf bi translated">外部系统前端服务器上的高主存要求</li><li id="f44b" class="kx ky iq jp b jq lg ju lh jy li kc lj kg lk kk lc ld le lf bi translated">Microsoft SQL Server实例上的高主内存要求</li><li id="d01d" class="kx ky iq jp b jq lg ju lh jy li kc lj kg lk kk lc ld le lf bi translated">较慢的数据查询和总体较差的外部系统环境性能</li><li id="b929" class="kx ky iq jp b jq lg ju lh jy li kc lj kg lk kk lc ld le lf bi translated">文件查询和资源调配之间的延迟更长</li></ul><p id="1699" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">最后，所有文件都集中存放。例如，如果您的OutSystems环境部署在欧洲(无论是作为云实例还是在您自己的数据中心)，所有其他地区都会由于距离而自动具有更高的延迟。</p><p id="6440" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">总的来说，通过外部系统数据库提供文件有许多缺点。因此，对于大容量配置，建议切换到第三方技术，如<strong class="jp ir"> AWS简单存储服务(S3) </strong>。</p></div><div class="ab cl ll lm hu ln" role="separator"><span class="lo bw bk lp lq lr"/><span class="lo bw bk lp lq lr"/><span class="lo bw bk lp lq"/></div><div class="ij ik il im in"><p id="fbe4" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">OutSystems与Amazon Web Services有着紧密的合作关系，并通过Forge marketplace为AWS服务提供了几个连接器。其中包括对象存储服务S3。</p></div><div class="ab cl ll lm hu ln" role="separator"><span class="lo bw bk lp lq lr"/><span class="lo bw bk lp lq lr"/><span class="lo bw bk lp lq"/></div><div class="ij ik il im in"><h1 id="b72f" class="ls lt iq bd lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp bi translated">AWS简单存储服务(S3)</h1><p id="bb18" class="pw-post-body-paragraph jn jo iq jp b jq mq js jt ju mr jw jx jy ms ka kb kc mt ke kf kg mu ki kj kk ij bi translated">AWS简单存储服务(简称S3)是一种对象级存储，可以存储任何数据，包括文档、视频、图像、完整的网站等等。S3不将数据作为文件存储在文件系统中，而是将它们转换成数字对象。这些对象可以用进一步的信息(元数据)来丰富，这对自动化的后续处理特别有帮助。</p><p id="eedf" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">S3将存储的对象组织到桶中，单个AWS帐户最多可以包含100个桶。如果需要，在向AWS请求扩展后，该数量可以扩展到1000个桶。虽然可以从AWS S3控制台创建文件夹，但S3没有分层存储。虚拟分层存储是通过对象标识符的前缀实现的，对象标识符是由正斜杠分隔的字符串。</p><p id="8390" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">S3，或S3 API，已经成为市场上的一个标准。除了AWS S3，还有一些免费和商业产品完全或部分实现了该标准。其中包括戴尔等存储解决方案提供商。我个人最喜欢的S3兼容商店是MinIO。</p><p id="39c1" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">S3被其他一些AWS服务使用，例如用于存储快照，或者S3桶可以作为AWS内容交付服务Cloudfront的源。</p><p id="7718" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">Forge Marketplace包含几个提供AWS S3访问的组件。OutSystems本身提供了一个受支持的连接器，名为<strong class="jp ir">亚马逊简单存储服务(S3) </strong></p><div class="mv mw gp gr mx my"><a href="https://www.outsystems.com/forge/component-overview/11172/amazon-simple-storage-service-s3" rel="noopener  ugc nofollow" target="_blank"><div class="mz ab fo"><div class="na ab nb cl cj nc"><h2 class="bd ir gy z fp nd fr fs ne fu fw ip bi translated">亚马逊简单存储服务(S3)</h2><div class="nf l"><h3 class="bd b gy z fp nd fr fs ne fu fw dk translated">将您的Amazon简单存储帐户与OutSystems连接起来，以备份关键数据，减轻您的运营负担…</h3></div><div class="ng l"><p class="bd b dl z fp nd fr fs ne fu fw dk translated">www.outsystems.com</p></div></div><div class="nh l"><div class="ni l nj nk nl nh nm kv my"/></div></div></a></div><p id="cb47" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">要在OutSystems应用程序中从S3存储中检索文件，我们有两个选项:</p><h2 id="62be" class="nn lt iq bd lu no np dn ly nq nr dp mc jy ns nt mg kc nu nv mk kg nw nx mo ny bi translated">通过外部系统服务器操作检索S3对象</h2><p id="8a82" class="pw-post-body-paragraph jn jo iq jp b jq mq js jt ju mr jw jx jy ms ka kb kc mt ke kf kg mu ki kj kk ij bi translated">在OutSystems服务器操作中，根据id从存储中检索所需的S3对象。为此，亚马逊简单存储服务(S3)连接器提供了服务器动作<strong class="jp ir"> Object_Get </strong>。授权给S3存储桶的IAM凭据和对象是必需的。</p><p id="7670" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">从S3存储中完整地检索该对象，并使其作为二进制数据可用。然后，它可以通过小部件显示在应用程序中，或者可供下载。</p><p id="3345" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果我们使用服务器动作<strong class="jp ir"> Object_Get </strong>来检索S3对象，我们实际上并没有得到多少。和以前一样，首先从S3存储中检索完整的对象，然后传递给我们的客户端应用程序。这意味着</p><ul class=""><li id="ca0e" class="kx ky iq jp b jq jr ju jv jy kz kc la kg lb kk lc ld le lf bi translated">不支持流媒体(支持字节范围)</li><li id="2086" class="kx ky iq jp b jq lg ju lh jy li kc lj kg lk kk lc ld le lf bi translated">前端服务器上的高内存需求</li><li id="79c0" class="kx ky iq jp b jq lg ju lh jy li kc lj kg lk kk lc ld le lf bi translated">检索和交付之间的等待时间</li></ul><p id="bc46" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们唯一取得的成就是文件不再在数据库中，因此Microsoft SQL Server的负载有所减轻。至少有所进步，但不是真正的进步。</p><p id="ee0c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">最重要的是，我们仍然集中检索文件(通过我们的前端服务器)。</p><h2 id="b659" class="nn lt iq bd lu no np dn ly nq nr dp mc jy ns nt mg kc nu nv mk kg nw nx mo ny bi translated">在客户端应用程序中使用预先指定的URL检索S3对象</h2><p id="7844" class="pw-post-body-paragraph jn jo iq jp b jq mq js jt ju mr jw jx jy ms ka kb kc mt ke kf kg mu ki kj kk ij bi translated">我们的目标是让我们的前端服务器不处理实际的文件。客户端应用程序应该只获取对象的URL，然后从S3存储本身检索文件。</p><p id="19f2" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">默认情况下，S3存储桶是私有的，只有具有适当策略的AWS IAM帐户(或假定角色)才能访问该存储桶和存储在其中的对象。人们可以让一个桶公开访问，但这几乎是不可能的。</p><p id="ecb0" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">AWS S3提供了为文件或对象创建S3预签名URL的能力。预先指定的URL允许在规定的时间内(例如60分钟)访问一个对象。预先设计的URL也可用于替换现有对象或在S3对象库中创建新对象。</p><p id="f665" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">S3连接器允许通过服务器动作<strong class="jp ir"> Object_GetPresignedUrl </strong>生成预先指定的Url。</p><p id="f1cb" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">预先设计的URL包含对象的路径以及访问方法——HTTP动词(GET、HEAD、PUT等)。)—用于访问。包括HTTP动词在内的完整URL是经过签名的，因此不可能通过S3预先签名的URL同时执行GET和HEAD请求。对于每种访问类型，需要一个单独的S3预先指定的URL。</p><p id="dcd9" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">通过使用AWS S3控制台为一个对象生成一个预先指定的URL(您总是在控制台中为GET请求创建预先指定的URL)，可以很容易地重现这种情况。</p><p id="a3ad" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">将URL复制到Postman GET请求中，并提交该请求。请求被成功执行，并以状态码200确认。</p><p id="ce75" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在将HTTP动词改为HEAD，并再次提交请求，这将得到确认，并显示错误代码403禁止。</p><p id="0e4c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">可以将预先设计的URL传递给客户端应用程序，客户端应用程序从存储中检索相应的S3对象。而不需要通过外部系统下载，这减少了延迟。</p><p id="b811" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">对S3对象的直接访问还支持字节范围请求，从而支持流媒体。</p><blockquote class="nz oa ob"><p id="8417" class="jn jo oc jp b jq jr js jt ju jv jw jx od jz ka kb oe kd ke kf of kh ki kj kk ij bi translated"><strong class="jp ir">异常</strong>:一些JavaScript库比如视频播放器或者PDF查看器首先通过HEAD请求查询URL，判断对象是否存在，是否支持字节范围。只有这样，它们才能通过GET请求在同一个URL上检索实际的对象。由于S3预先指定的URL只适用于一种类型的访问，这自动失败，然后库使用没有字节范围支持的对象。</p></blockquote><p id="fd68" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">S3预先指定的URL仅对一个对象有效，并且不可能一次访问多个S3对象，例如，具有特定前缀的所有对象(S3控制台中的文件夹)。</p><p id="5581" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">使用预先设计的URL(并在我们支持URL的客户端应用程序中使用小部件),我们已经实现了几件事情</p><ul class=""><li id="2c79" class="kx ky iq jp b jq jr ju jv jy kz kc la kg lb kk lc ld le lf bi translated">文件的处理不再在我们的前端服务器上完成</li><li id="dda4" class="kx ky iq jp b jq lg ju lh jy li kc lj kg lk kk lc ld le lf bi translated">更低的延迟，因为客户端不再需要等待处理，而是直接访问文件</li><li id="65dd" class="kx ky iq jp b jq lg ju lh jy li kc lj kg lk kk lc ld le lf bi translated">S3支持字节范围请求，从而支持流媒体</li></ul><p id="2657" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">然而，还有一点。S3存储桶在AWS区域提供，因此来自其他区域的访问具有更高的延迟。为了解决这个问题，我们可以使用我们的S3桶作为AWS内容交付网络服务<strong class="jp ir"> CloudFront </strong>的来源，并以低延迟在全球范围内提供文件。</p><blockquote class="nz oa ob"><p id="9c70" class="jn jo oc jp b jq jr js jt ju jv jw jx od jz ka kb oe kd ke kf of kh ki kj kk ij bi translated">S3存储桶内容可以复制到其他存储桶，甚至跨地区复制。然后，可以通过多区域接入点访问内容，AWS确保最靠近客户端的S3存储桶始终响应。然而，OutSystems S3连接器不支持多区域端点(或一般的自定义端点),无论如何跨区域提供存储桶(另请参见帐户存储桶限制)并相应地为内容付费是没有意义的，即使它没有被使用。</p></blockquote></div><div class="ab cl ll lm hu ln" role="separator"><span class="lo bw bk lp lq lr"/><span class="lo bw bk lp lq lr"/><span class="lo bw bk lp lq"/></div><div class="ij ik il im in"><h1 id="f0b4" class="ls lt iq bd lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp bi translated">AWS云锋</h1><p id="6943" class="pw-post-body-paragraph jn jo iq jp b jq mq js jt ju mr jw jx jy ms ka kb kc mt ke kf kg mu ki kj kk ij bi translated">CloudFront是一种内容交付网络(CDN)服务。cdn是在地理上分布的服务器组，可以高效、低延迟地提供任何互联网内容。这是通过确保CDN中的内容总是从最靠近客户端(存在点)的服务器组(边缘服务器)中检索来实现的。</p><p id="6528" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">CDN中的内容可以是视频、音频文件、图像和文档，也可以是HTML、JavaScript和CSS。完整的网络存在可以存储和分布在CDN上，这对于静态网站或通过静态站点生成器框架(如Gatsby)生成的网站特别有意义。</p><p id="0b10" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">内容不会自动分发到所有CloudFront Edge服务器组。相反，内容最初是从一个定义的源(源)中检索的，例如，一个S3存储桶，并缓存一段定义的时间。然后直接从缓存中处理后续请求。这意味着第一次检索花费的时间稍长，因为必须首先从源中检索内容。</p><p id="913e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">对于CDN内容，首先想到的是内容是公开的。有了CloudFront，就有可能使<strong class="jp ir">的私有内容</strong>变得可用，这些内容应该只有在授权后才能访问。这是通过使用<strong class="jp ir">签名的URL</strong>或<strong class="jp ir">cookie</strong>来实现的。签名是在您的外部系统应用程序中使用私钥生成的。</p><p id="99b7" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">S3预签名网址和CloudFront签名网址的区别</strong></p><p id="7425" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">S3预先签名的URL和T2 CloudFront签名的URL都允许访问私人内容。在这两种情况下，都会对URL进行签名，并将签名附加到相应的URL上。在访问时，验证签名，如果成功，则准许访问所请求的资源。<br/>然而，还是有一些显著的不同</p><ul class=""><li id="ef16" class="kx ky iq jp b jq jr ju jv jy kz kc la kg lb kk lc ld le lf bi translated"><strong class="jp ir"> S3预签名</strong>URL使用IAM凭证签名。访问资源时，授予的权限由分配给该IAM用户的策略定义(或在存储桶策略中授予)。</li><li id="7584" class="kx ky iq jp b jq lg ju lh jy li kc lj kg lk kk lc ld le lf bi translated"><strong class="jp ir">CloudFront signed</strong>URL使用自己生成的私钥进行签名。相关的公钥被上传到CloudFront，用于验证签名。用户是否被授权访问资源是由URL和签名的有效性决定的。如果签名对URL有效，则无论如何都会授予访问权限。</li><li id="658b" class="kx ky iq jp b jq lg ju lh jy li kc lj kg lk kk lc ld le lf bi translated"><strong class="jp ir"> S3预先设计的</strong>URL仅适用于商店中的一个对象，包括访问方法(GET、POST等)。).<strong class="jp ir"> CloudFront签名的</strong>URL也可以包含通配符，因此可以访问多个对象(例如，路径下的所有文件)。<strong class="jp ir"> CloudFront签名的</strong>URL总是适用于CloudFront发行版的所有允许的访问方法，因此GET和HEAD请求可以使用同一个签名的URL。</li></ul><blockquote class="nz oa ob"><p id="9edf" class="jn jo oc jp b jq jr js jt ju jv jw jx od jz ka kb oe kd ke kf of kh ki kj kk ij bi translated">CloudFront不仅允许通过GET和HEAD检索对象。您还可以允许上传、发布、修补、删除和选项请求。GET和HEAD请求被缓存，而所有其他请求被直接传递到源端——在我们的例子中是S3存储。然后可以使用CloudFront发行版ARN的S3桶策略来限制实际的权限。</p></blockquote></div><div class="ab cl ll lm hu ln" role="separator"><span class="lo bw bk lp lq lr"/><span class="lo bw bk lp lq lr"/><span class="lo bw bk lp lq"/></div><div class="ij ik il im in"><h1 id="bc6f" class="ls lt iq bd lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp bi translated">履行</h1><p id="273e" class="pw-post-body-paragraph jn jo iq jp b jq mq js jt ju mr jw jx jy ms ka kb kc mt ke kf kg mu ki kj kk ij bi translated">现在让我们结束理论部分，看看这些是如何在一个OutSystems应用程序中结合在一起的。</p><p id="4491" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们会的</p><ul class=""><li id="e2f6" class="kx ky iq jp b jq jr ju jv jy kz kc la kg lb kk lc ld le lf bi translated">创建一个<strong class="jp ir"> S3桶</strong>来存储我们的文件。</li><li id="6011" class="kx ky iq jp b jq lg ju lh jy li kc lj kg lk kk lc ld le lf bi translated">创建一个<strong class="jp ir"> IAM帐户</strong>，该帐户有权访问我们的S3存储桶。此帐户的目的是使用亚马逊简单存储服务(S3)连接器组件上传文件。</li><li id="18e7" class="kx ky iq jp b jq lg ju lh jy li kc lj kg lk kk lc ld le lf bi translated">使用openssl创建一个<strong class="jp ir">公钥/私钥对</strong>。我们将使用<strong class="jp ir">私钥</strong>来签署CloudFront URLs和Cookies。</li><li id="5c9f" class="kx ky iq jp b jq lg ju lh jy li kc lj kg lk kk lc ld le lf bi translated">将<strong class="jp ir">公钥</strong>上传到CloudFront，并创建一个CloudFront密钥组。CloudFront将使用公钥来验证签名的URL和cookies。</li><li id="9c4c" class="kx ky iq jp b jq lg ju lh jy li kc lj kg lk kk lc ld le lf bi translated">以我们的S3桶为原点创建一个<strong class="jp ir">云锋分布</strong>。</li><li id="85d3" class="kx ky iq jp b jq lg ju lh jy li kc lj kg lk kk lc ld le lf bi translated">使用亚马逊简单存储服务(S3)连接器将一些文件上传到bucket</li><li id="9269" class="kx ky iq jp b jq lg ju lh jy li kc lj kg lk kk lc ld le lf bi translated">创建<strong class="jp ir">签名的URL</strong>来直接从我们应用程序的前端访问私有文件。</li></ul><h1 id="ad96" class="ls lt iq bd lu lv og lx ly lz oh mb mc md oi mf mg mh oj mj mk ml ok mn mo mp bi translated">先决条件</h1><p id="118f" class="pw-post-body-paragraph jn jo iq jp b jq mq js jt ju mr jw jx jy ms ka kb kc mt ke kf kg mu ki kj kk ij bi translated">跟随你将需要以下</p><ul class=""><li id="18a4" class="kx ky iq jp b jq jr ju jv jy kz kc la kg lb kk lc ld le lf bi translated">访问AWS帐户，该帐户有权创建S3 Bucket和CloudFront发行版。</li><li id="540e" class="kx ky iq jp b jq lg ju lh jy li kc lj kg lk kk lc ld le lf bi translated">访问AWS身份和访问管理(IAM ),为我们的OutSystems应用程序创建IAM用户。</li><li id="bdce" class="kx ky iq jp b jq lg ju lh jy li kc lj kg lk kk lc ld le lf bi translated">OpenSSL来创建密钥对。</li></ul><blockquote class="nz oa ob"><p id="3b3b" class="jn jo oc jp b jq jr js jt ju jv jw jx od jz ka kb oe kd ke kf of kh ki kj kk ij bi translated">你可以从<a class="ae ol" href="https://slproweb.com/products/Win32OpenSSL.html#" rel="noopener ugc nofollow" target="_blank"> Shining Light Productions </a>下载一个微软Windows版本，或者使用Linux发行版的WSL安装中的openssl命令。</p></blockquote><ul class=""><li id="d7d8" class="kx ky iq jp b jq jr ju jv jy kz kc la kg lb kk lc ld le lf bi translated"><a class="ae ol" href="https://www.outsystems.com/forge/component-overview/11172/amazon-simple-storage-service-s3" rel="noopener ugc nofollow" target="_blank">亚马逊简单存储服务(S3) </a>伪造组件。我们只使用这个上传文件到我们的S3桶。</li></ul><h1 id="3815" class="ls lt iq bd lu lv og lx ly lz oh mb mc md oi mf mg mh oj mj mk ml ok mn mo mp bi translated">创建一个S3桶</h1><p id="95b4" class="pw-post-body-paragraph jn jo iq jp b jq mq js jt ju mr jw jx jy ms ka kb kc mt ke kf kg mu ki kj kk ij bi translated">创建新的S3存储桶时，默认情况下其内容是私有的。这意味着如果没有通过IAM或Bucket策略授予的权限，就不能访问对象。在本演练中，我们将使用默认设置创建一个存储桶。</p><ul class=""><li id="cb27" class="kx ky iq jp b jq jr ju jv jy kz kc la kg lb kk lc ld le lf bi translated">去AWS控制台，切换到亚马逊S3服务</li><li id="c3a6" class="kx ky iq jp b jq lg ju lh jy li kc lj kg lk kk lc ld le lf bi translated">在您选择的区域和名称中创建新的存储桶</li></ul><blockquote class="nz oa ob"><p id="afe6" class="jn jo oc jp b jq jr js jt ju jv jw jx od jz ka kb oe kd ke kf of kh ki kj kk ij bi translated">返回到您的存储桶列表后，请注意您创建的存储桶以及“访问”列中的<strong class="jp ir">存储桶和非公共对象</strong>设置。</p></blockquote><h1 id="95fb" class="ls lt iq bd lu lv og lx ly lz oh mb mc md oi mf mg mh oj mj mk ml ok mn mo mp bi translated">创建IAM用户帐户</h1><p id="be39" class="pw-post-body-paragraph jn jo iq jp b jq mq js jt ju mr jw jx jy ms ka kb kc mt ke kf kg mu ki kj kk ij bi translated">接下来，我们将创建一个具有编程访问权限的新IAM用户帐户。这将给我们以<strong class="jp ir">访问密钥</strong>和<strong class="jp ir">访问秘密</strong>形式的凭证，我们将使用这些凭证通过<strong class="jp ir">亚马逊简单存储服务(S3) </strong>组件将新文件上传到我们的bucket。</p><p id="6f94" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在将用户添加到IAM之前，我们首先创建一个权限策略，该策略只授予向s3存储桶添加新文件的权限</p><ul class=""><li id="bb54" class="kx ky iq jp b jq jr ju jv jy kz kc la kg lb kk lc ld le lf bi translated">切换到IAM服务</li><li id="e552" class="kx ky iq jp b jq lg ju lh jy li kc lj kg lk kk lc ld le lf bi translated">在“策略”下，单击“创建策略”</li></ul><p id="004a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">使用可视化编辑器创建策略</strong></p><ul class=""><li id="290f" class="kx ky iq jp b jq jr ju jv jy kz kc la kg lb kk lc ld le lf bi translated">选择S3服务</li><li id="6516" class="kx ky iq jp b jq lg ju lh jy li kc lj kg lk kk lc ld le lf bi translated">在<strong class="jp ir">动作</strong>下，从<strong class="jp ir">写</strong>权限树中仅选择<strong class="jp ir">放置对象</strong></li><li id="0254" class="kx ky iq jp b jq lg ju lh jy li kc lj kg lk kk lc ld le lf bi translated">在Resources下，为您创建的<strong class="jp ir"> bucket name </strong>添加对象arn，并为对象选择<strong class="jp ir"> Any </strong>。</li></ul><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi om"><img src="../Images/ad03e738a00374380f5beae134afe9be.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*tIAwN4Ri-DPyA2cyZyNzgg.png"/></div></div></figure><ul class=""><li id="c40f" class="kx ky iq jp b jq jr ju jv jy kz kc la kg lb kk lc ld le lf bi translated">在向导中单击，直到您可以提供策略名称并保存新策略。</li></ul><p id="a8d5" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">保存策略后，我们现在可以创建一个IAM用户，并将新策略附加到该帐户。</p><ul class=""><li id="17b7" class="kx ky iq jp b jq jr ju jv jy kz kc la kg lb kk lc ld le lf bi translated">在IAM用户界面，点击<strong class="jp ir">添加用户</strong>。</li><li id="f394" class="kx ky iq jp b jq lg ju lh jy li kc lj kg lk kk lc ld le lf bi translated">输入用户名，确保选中<strong class="jp ir">访问键—编程访问</strong>选项，然后点击<strong class="jp ir">下一步</strong>。</li></ul><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi on"><img src="../Images/516568a7b0350bfab30cbbaeb62f5b70.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Tq8ikvtjTyFspMHgeoUqyQ.png"/></div></div></figure><ul class=""><li id="722b" class="kx ky iq jp b jq jr ju jv jy kz kc la kg lb kk lc ld le lf bi translated">在<strong class="jp ir">权限</strong>屏幕中，点击直接附加现有策略，搜索您之前创建的策略并选中其旁边的复选框。然后浏览向导，直到点击<strong class="jp ir">创建用户</strong>按钮。</li></ul><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi oo"><img src="../Images/0a6f260f53c0c9031fd91fd0f2092ca3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*621DpeqC8xjhRnsU8N29yQ.png"/></div></div></figure><ul class=""><li id="798b" class="kx ky iq jp b jq jr ju jv jy kz kc la kg lb kk lc ld le lf bi translated">点击创建用户按钮后，您将看到帐户凭证页面。确保复制<strong class="jp ir">访问密钥</strong>和<strong class="jp ir">秘密访问密钥</strong>或下载CSV。</li></ul><h1 id="080a" class="ls lt iq bd lu lv og lx ly lz oh mb mc md oi mf mg mh oj mj mk ml ok mn mo mp bi translated">创建密钥对</h1><p id="5816" class="pw-post-body-paragraph jn jo iq jp b jq mq js jt ju mr jw jx jy ms ka kb kc mt ke kf kg mu ki kj kk ij bi translated">如上所述，我们在OutSystems应用程序中需要一个私钥来签署URL和/或Cookies，以便通过CloudFront访问我们的私有S3文件。CloudFront需要公钥来验证签名。</p><p id="86cf" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">创建私钥</strong></p><pre class="km kn ko kp gt op oq or bn os ot bi"><span id="7d6a" class="ou lt iq oq b be ov ow l ox oy">openssl genrsa -out aws_cloudfront_privatekey.pem 2048</span></pre><p id="71e7" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">创建公钥</strong></p><pre class="km kn ko kp gt op oq or bn os ot bi"><span id="a924" class="ou lt iq oq b be ov ow l ox oy">openssl rsa -pubout -in aws_cloudfront_privatekey.pem -out aws_cloudfront_publickey.pem</span></pre><p id="97f7" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">向CloudFront添加公钥</strong></p><ul class=""><li id="8496" class="kx ky iq jp b jq jr ju jv jy kz kc la kg lb kk lc ld le lf bi translated">用文本编辑器打开公钥pem文件，并将内容复制到剪贴板</li><li id="a029" class="kx ky iq jp b jq lg ju lh jy li kc lj kg lk kk lc ld le lf bi translated">在AWS控制台切换到CloudFront服务</li><li id="0dc6" class="kx ky iq jp b jq lg ju lh jy li kc lj kg lk kk lc ld le lf bi translated">在<strong class="jp ir">密钥管理</strong>下的左侧菜单中，选择<strong class="jp ir">公钥</strong>并点击<strong class="jp ir">创建公钥</strong>。</li><li id="3d4b" class="kx ky iq jp b jq lg ju lh jy li kc lj kg lk kk lc ld le lf bi translated">为公钥命名，并将pem文件的内容粘贴到密钥字段。然后点击<strong class="jp ir">创建公钥</strong>。</li></ul><p id="e612" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">请注意您创建的公钥的ID，我们稍后会用到它。</p><p id="2c44" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">创建关键组</strong></p><p id="f114" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">键被分组到键组中，以后会被CloudFront发行版引用。如果相关密钥组中的任何可用公钥都可以验证签名，则签名是有效的。</p><ul class=""><li id="00c0" class="kx ky iq jp b jq jr ju jv jy kz kc la kg lb kk lc ld le lf bi translated">在密钥管理下选择密钥组，点击<strong class="jp ir">创建密钥组</strong>。</li><li id="d916" class="kx ky iq jp b jq lg ju lh jy li kc lj kg lk kk lc ld le lf bi translated">给它一个名称，并从可用公钥列表中选择您添加的公钥。然后点击<strong class="jp ir">创建按键组</strong>。</li></ul><h1 id="01cf" class="ls lt iq bd lu lv og lx ly lz oh mb mc md oi mf mg mh oj mj mk ml ok mn mo mp bi translated">创建一个CloudFront发行版</h1><p id="bcc0" class="pw-post-body-paragraph jn jo iq jp b jq mq js jt ju mr jw jx jy ms ka kb kc mt ke kf kg mu ki kj kk ij bi translated">现在是时候使用我们的S3桶作为原点来创建CloudFront发行版了。</p><ul class=""><li id="a339" class="kx ky iq jp b jq jr ju jv jy kz kc la kg lb kk lc ld le lf bi translated">在CloudFront菜单中选择<strong class="jp ir">发行版</strong>并点击<strong class="jp ir">创建发行版</strong>。</li><li id="b7ea" class="kx ky iq jp b jq lg ju lh jy li kc lj kg lk kk lc ld le lf bi translated">从<strong class="jp ir">源域</strong>列表中选择您的S3存储桶，并为这个新发行版提供一个<strong class="jp ir">名称</strong>。</li><li id="c2cc" class="kx ky iq jp b jq lg ju lh jy li kc lj kg lk kk lc ld le lf bi translated">在<strong class="jp ir">原点访问</strong>下选择<strong class="jp ir">原点访问控制设置(推荐)</strong></li><li id="fc6c" class="kx ky iq jp b jq lg ju lh jy li kc lj kg lk kk lc ld le lf bi translated">点击<strong class="jp ir">创建控制设置</strong>按钮，使用默认选项创建新设置。</li></ul><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi oz"><img src="../Images/a261576c273cb583fa96a2a5e43a6d10.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*MU1oNEegxqLkz8p4TimJBQ.png"/></div></div></figure><ul class=""><li id="cb8c" class="kx ky iq jp b jq jr ju jv jy kz kc la kg lb kk lc ld le lf bi translated">确保在<strong class="jp ir">默认缓存行为</strong>下的<strong class="jp ir">限制查看者访问</strong>设置上点击<strong class="jp ir">是</strong>。</li><li id="373d" class="kx ky iq jp b jq lg ju lh jy li kc lj kg lk kk lc ld le lf bi translated">然后从可用键组列表中选择您创建的<strong class="jp ir">键组</strong>。</li></ul><blockquote class="nz oa ob"><p id="0dd1" class="jn jo oc jp b jq jr js jt ju jv jw jx od jz ka kb oe kd ke kf of kh ki kj kk ij bi translated">这是<strong class="jp ir">最重要的设置</strong>。如果不限制查看者的访问，那么CloudFront中的所有缓存对象都将是公开的。如果设置为Yes，那么CloudFront发行版将只处理带有有效签名URL或cookie的请求。</p></blockquote><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi pa"><img src="../Images/6378ec02ee60bc0a663780c628270de7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*NMwcWdU8Iv9uQJqcg_GlRQ.png"/></div></div><figcaption class="pb pc gj gh gi pd pe bd b be z dk translated">检索查看者访问和可信密钥组</figcaption></figure><ul class=""><li id="30d7" class="kx ky iq jp b jq jr ju jv jy kz kc la kg lb kk lc ld le lf bi translated">保持其余设置不变，并点击<strong class="jp ir">创建分布</strong>。</li></ul><p id="2048" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在你创建了你的CloudFront发行版之后，从General选项卡中记下你的<strong class="jp ir">发行版域名</strong>(例如gfds76768das.cloudfront.net)。我们稍后将需要它来访问文件。</p><p id="7ead" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">尝试使用浏览器访问您的分发域名。您应该会收到以下形式的错误</p><pre class="km kn ko kp gt op oq or bn os ot bi"><span id="bf98" class="ou lt iq oq b be ov ow l ox oy">&lt;Error&gt;<br/>  &lt;Code&gt;MissingKey&lt;/Code&gt;<br/>  &lt;Message&gt;Missing Key-Pair-Id query parameter or cookie value&lt;/Message&gt;<br/>&lt;/Error&gt;</span></pre><p id="5425" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这表明只有使用签名的URL或cookie才能访问这个CloudFront发行版。</p><h1 id="9895" class="ls lt iq bd lu lv og lx ly lz oh mb mc md oi mf mg mh oj mj mk ml ok mn mo mp bi translated">允许CloudFront访问S3存储桶</h1><p id="64e5" class="pw-post-body-paragraph jn jo iq jp b jq mq js jt ju mr jw jx jy ms ka kb kc mt ke kf kg mu ki kj kk ij bi translated">我们需要授权CloudFront——更具体地说是我们的CloudFront发行版——访问我们的S3桶。和其他资源或用户一样，CloudFront需要权限来从存储中检索对象，并将它们放入缓存中。我们通过在S3存储桶中应用存储桶策略来做到这一点。幸运的是，CloudFront为我们提供了一个模板桶策略。</p><ul class=""><li id="0f5b" class="kx ky iq jp b jq jr ju jv jy kz kc la kg lb kk lc ld le lf bi translated">在你创建的CloudFront发行版中选择<strong class="jp ir">源</strong>头。然后从列表中选择您的S3产地，并点击<strong class="jp ir">编辑</strong>。</li></ul><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi pf"><img src="../Images/27b02cc130f70731142f707272fb9189.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*6gZszud9oCVbynk12QxKrw.png"/></div></div></figure><ul class=""><li id="8113" class="kx ky iq jp b jq jr ju jv jy kz kc la kg lb kk lc ld le lf bi translated">点击<strong class="jp ir">复制策略</strong>按钮，将预先创建的存储桶策略复制到剪贴板。</li><li id="ca5d" class="kx ky iq jp b jq lg ju lh jy li kc lj kg lk kk lc ld le lf bi translated">切换到<strong class="jp ir"> S3服务</strong>并从桶列表中点击您的S3桶。</li><li id="bf43" class="kx ky iq jp b jq lg ju lh jy li kc lj kg lk kk lc ld le lf bi translated">选择<strong class="jp ir">权限</strong>选项卡</li><li id="00f5" class="kx ky iq jp b jq lg ju lh jy li kc lj kg lk kk lc ld le lf bi translated">在<strong class="jp ir">Bucket policies</strong>下点击<strong class="jp ir"> Edit </strong>，然后粘贴复制的策略<strong class="jp ir">保存修改</strong>。</li></ul><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi pg"><img src="../Images/2186677ecf64a8b13fd461a860822994.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*pQuelJKxY4p2-WZFD8Vfcw.png"/></div></div><figcaption class="pb pc gj gh gi pd pe bd b be z dk translated">木桶策略</figcaption></figure><p id="3a7c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">好的。到目前为止，这是一段艰难的旅程，但是现在我们已经创建并配置了在我们的应用程序中使用它的所有先决条件。</p></div><div class="ab cl ll lm hu ln" role="separator"><span class="lo bw bk lp lq lr"/><span class="lo bw bk lp lq lr"/><span class="lo bw bk lp lq"/></div><div class="ij ik il im in"><p id="fbae" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">对于下一步，您需要在整个配置步骤中创建的以下信息。</p><ul class=""><li id="22fb" class="kx ky iq jp b jq jr ju jv jy kz kc la kg lb kk lc ld le lf bi translated"><strong class="jp ir"> S3桶名</strong>和<strong class="jp ir">桶区域</strong> —来自AWS S3控制台的桶列表</li><li id="d2a7" class="kx ky iq jp b jq lg ju lh jy li kc lj kg lk kk lc ld le lf bi translated"><strong class="jp ir"> CloudFront分发名称</strong> —来自AWS CloudFront控制台—分发详细信息屏幕。</li><li id="fb6e" class="kx ky iq jp b jq lg ju lh jy li kc lj kg lk kk lc ld le lf bi translated"><strong class="jp ir"> CloudFront Key Id </strong> —您上传的公钥Id—CloudFront控制台密钥管理菜单—公钥</li><li id="aeac" class="kx ky iq jp b jq lg ju lh jy li kc lj kg lk kk lc ld le lf bi translated"><strong class="jp ir">私钥</strong> —您创建的私钥的pem文件，该文件与您上传到CloudFront的公钥相对应</li><li id="49e2" class="kx ky iq jp b jq lg ju lh jy li kc lj kg lk kk lc ld le lf bi translated"><strong class="jp ir"> IAM用户访问密钥和秘密密钥</strong> —您在创建IAM用户帐户时创建的凭证，该帐户具有将对象放入S3商店的相关策略。</li></ul></div><div class="ab cl ll lm hu ln" role="separator"><span class="lo bw bk lp lq lr"/><span class="lo bw bk lp lq lr"/><span class="lo bw bk lp lq"/></div><div class="ij ik il im in"><h1 id="7392" class="ls lt iq bd lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp bi translated">外部系统演示应用程序</h1><p id="6c17" class="pw-post-body-paragraph jn jo iq jp b jq mq js jt ju mr jw jx jy ms ka kb kc mt ke kf kg mu ki kj kk ij bi translated">出于演示目的，我创建了一个示例应用程序，您可以从OutSystems Forge下载。</p><div class="mv mw gp gr mx my"><a href="https://www.outsystems.com/forge/component-overview/14291/serve-files-at-scale-demo-application" rel="noopener  ugc nofollow" target="_blank"><div class="mz ab fo"><div class="na ab nb cl cj nc"><h2 class="bd ir gy z fp nd fr fs ne fu fw ip bi translated">大规模提供文件演示应用程序</h2><div class="nf l"><h3 class="bd b gy z fp nd fr fs ne fu fw dk translated">这个应用程序是我发表的一篇关于medium.com的文章的姊妹篇。它演示了如何访问私人内容…</h3></div><div class="ng l"><p class="bd b dl z fp nd fr fs ne fu fw dk translated">www.outsystems.com</p></div></div><div class="nh l"><div class="ph l nj nk nl nh nm kv my"/></div></div></a></div><p id="0594" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">该应用程序允许您上传图像，这些图像直接上传到您的S3桶。对于您上传的每个图像，都会在图像实体中创建一条记录。这模拟了一个真实的场景，您将在文档中存储文件的附加数据和关系，同时在S3存储桶中存储二进制数据。</p><p id="e021" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">上传一些图像后，会显示一个图库。这些图片是使用一个签名的URL从CloudFront CDN加载的。</p><p id="5ae6" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">服务器action Gallery_GetImages查询数据库中的所有图像，并返回每个图像的签名URL。</p><p id="73d4" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">为了构建和签名URL，我创建了一个组件<strong class="jp ir"> AWS CloudFront Signer </strong>，并将其发布在OutSystems Forge上。它使用AWS CloudFront C# SDK。</p><div class="mv mw gp gr mx my"><a href="https://www.outsystems.com/forge/component-overview/14289/aws-cloudfront-signer" rel="noopener  ugc nofollow" target="_blank"><div class="mz ab fo"><div class="na ab nb cl cj nc"><h2 class="bd ir gy z fp nd fr fs ne fu fw ip bi translated">AWS CloudFront签名者</h2><div class="nf l"><h3 class="bd b gy z fp nd fr fs ne fu fw dk translated">基于AWS CloudFront SDK的实用服务，用于创建带有预设和自定义策略的签名CloudFront URLs</h3></div><div class="ng l"><p class="bd b dl z fp nd fr fs ne fu fw dk translated">www.outsystems.com</p></div></div><div class="nh l"><div class="pi l nj nk nl nh nm kv my"/></div></div></a></div><p id="4515" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">AWS CloudFront Signer组件公开了两种不同的服务器操作来创建已签名的CloudFront URL。</p><ul class=""><li id="b8da" class="kx ky iq jp b jq jr ju jv jy kz kc la kg lb kk lc ld le lf bi translated">CloudFront_GetCannedSignedUrl —用于创建带有固定策略的签名Url。</li><li id="b578" class="kx ky iq jp b jq lg ju lh jy li kc lj kg lk kk lc ld le lf bi translated">CloudFront_GetCustomSignedUrl —用于创建带有自定义策略的签名Url。</li></ul><div class="mv mw gp gr mx my"><a href="https://docs.aws.amazon.com/AmazonCloudFront/latest/DeveloperGuide/private-content-signed-urls.html" rel="noopener  ugc nofollow" target="_blank"><div class="mz ab fo"><div class="na ab nb cl cj nc"><h2 class="bd ir gy z fp nd fr fs ne fu fw ip bi translated">使用签名的URL</h2><div class="nf l"><h3 class="bd b gy z fp nd fr fs ne fu fw dk translated">已签名的URL包含附加信息，例如，到期日期和时间，这使您可以更好地控制…</h3></div><div class="ng l"><p class="bd b dl z fp nd fr fs ne fu fw dk translated">docs.aws.amazon.com</p></div></div><div class="nh l"><div class="pj l nj nk nl nh nm kv my"/></div></div></a></div><p id="f863" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">固定和自定义策略签名URL之间最关键的区别是</p><ul class=""><li id="a546" class="kx ky iq jp b jq jr ju jv jy kz kc la kg lb kk lc ld le lf bi translated">对于固定策略，您不能在资源URL路径中使用通配符。您必须为每个资源创建一个签名的URL。</li><li id="3a5b" class="kx ky iq jp b jq lg ju lh jy li kc lj kg lk kk lc ld le lf bi translated">使用预设策略，您不能为URL指定开始日期时间。在到达到期日期之前，可以立即访问预设策略URL。</li><li id="f99a" class="kx ky iq jp b jq lg ju lh jy li kc lj kg lk kk lc ld le lf bi translated">自定义策略URL较长，因为策略文件包含在base64编码的查询字符串中。</li></ul><p id="6751" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">配置演示应用</strong></p><p id="f0eb" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在尝试演示应用程序之前，您必须设置一些配置站点属性。在“服务中心”中打开模块ServeFilesAtScale _ CS，然后单击“站点属性”选项卡。</p><p id="8c52" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">根据您的AWS配置相应地设置站点属性。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi pk"><img src="../Images/f5dc37877a04fc5fe9e3149e7da7eaa5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*srUKmQOg0aU0zsEzj6j4iw.png"/></div></div></figure><ul class=""><li id="ca07" class="kx ky iq jp b jq jr ju jv jy kz kc la kg lb kk lc ld le lf bi translated"><strong class="jp ir"> AWS_AccessKey </strong> —将其设置为您创建的IAM用户帐户的访问密钥</li><li id="7458" class="kx ky iq jp b jq lg ju lh jy li kc lj kg lk kk lc ld le lf bi translated"><strong class="jp ir"> AWS_SecretKey </strong> —将其设置为您创建的IAM用户帐户的密钥。</li><li id="dbeb" class="kx ky iq jp b jq lg ju lh jy li kc lj kg lk kk lc ld le lf bi translated"><strong class="jp ir">CloudFront _ Distribution</strong>—包含协议https的分发名称，如上图所示。</li><li id="feaa" class="kx ky iq jp b jq lg ju lh jy li kc lj kg lk kk lc ld le lf bi translated"><strong class="jp ir"> CloudFront_KeyPairId </strong> —您在AWS CloudFront控制台中创建的公钥的Id。</li><li id="70f5" class="kx ky iq jp b jq lg ju lh jy li kc lj kg lk kk lc ld le lf bi translated"><strong class="jp ir">CloudFront _ private key</strong>—您用私钥创建的PEM文件的内容</li><li id="bbc7" class="kx ky iq jp b jq lg ju lh jy li kc lj kg lk kk lc ld le lf bi translated"><strong class="jp ir">S3 _存储桶</strong> —您创建的S3存储桶的名称</li><li id="d659" class="kx ky iq jp b jq lg ju lh jy li kc lj kg lk kk lc ld le lf bi translated"><strong class="jp ir">S3 _前缀</strong> —已经用img预定义。这是上传图片的默认前缀(文件夹)。</li><li id="0c29" class="kx ky iq jp b jq lg ju lh jy li kc lj kg lk kk lc ld le lf bi translated"><strong class="jp ir"> S3地区</strong> —您创建了S3存储桶的AWS地区。</li></ul><blockquote class="nz oa ob"><p id="41f2" class="jn jo oc jp b jq jr js jt ju jv jw jx od jz ka kb oe kd ke kf of kh ki kj kk ij bi translated"><strong class="jp ir">注意</strong>:必须用C#枚举格式指定区域。所以eu-central-1就是EUCentral1。在这里你可以找到所有可能值的列表<a class="ae ol" href="https://docs.aws.amazon.com/sdkfornet/v3/apidocs/items/Amazon/TRegionEndpoint.html" rel="noopener ugc nofollow" target="_blank"> AWS SDK。NET V3 API文档(Amazon.com)</a></p></blockquote><p id="5a7c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在尝试一下，上传一些图片。在浏览器中打开开发者工具(F12)并点击网络标签。如果你已经正确配置了所有的东西，你会注意到所有的图片都是由CloudFront提供的，带有一个很长的包含URL签名的URL。</p><p id="8152" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">上传图片到S3桶</strong></p><p id="51a5" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">打开<strong class="jp ir">servefileatscale _ CS</strong>模块和服务器动作<strong class="jp ir"> Gallery_AddImage </strong>。</p><p id="28d4" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这个服务器动作获取一个图像，并将其放入您的S3桶中。它使用配置的S3前缀和提供的文件名作为标识符。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi pl"><img src="../Images/40a9b3a34a6c920b2bc5f89b0c14a1a1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*cczdKybPT2hqxzQ_53qBGQ.png"/></div></div><figcaption class="pb pc gj gh gi pd pe bd b be z dk translated">图库_AddImage</figcaption></figure><blockquote class="nz oa ob"><p id="cfc7" class="jn jo oc jp b jq jr js jt ju jv jw jx od jz ka kb oe kd ke kf of kh ki kj kk ij bi translated"><strong class="jp ir">记住</strong>:当我们为IAM用户帐户配置策略时，我们只允许将对象放入您的存储桶。使用最小特权总是好的。</p></blockquote><p id="db13" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">将文件放入存储桶后，将在图像实体中创建一条记录。这可能是您在实际应用程序中要做的事情。将二进制数据的存储卸载到S3，并在数据库中保留二进制数据的引用。</p><blockquote class="nz oa ob"><p id="40fe" class="jn jo oc jp b jq jr js jt ju jv jw jx od jz ka kb oe kd ke kf of kh ki kj kk ij bi translated"><strong class="jp ir">注意</strong>:将存储卸载到S3时，您需要注意数据库中的图像记录与存储在S3的文件之间的一致性。S3能够在文件删除或修改等情况下引发数据事件。您可以通过订阅webhooks来使用这些事件，并采取适当的措施。</p></blockquote><p id="e212" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">检索图像和已签名的URL</strong></p><p id="820b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">打开<strong class="jp ir"> Gallery_GetImages </strong>服务器动作。第一个流动作是<strong class="jp ir">CloudFront _ GetCustomSignedUrl</strong>。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi pm"><img src="../Images/75ec7ce081baaf207ad241f082b71c50.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*_OJr6sOThzt5HBg-jWz8aA.png"/></div></div><figcaption class="pb pc gj gh gi pd pe bd b be z dk translated">CloudFront_GetCustomSignedUrl</figcaption></figure><p id="e083" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir"> Url </strong>参数被设置为我们的CloudFront发行版名称，后跟已配置的前缀(文件夹),后跟通配符*。这将生成一个对前缀之后的所有内容都有效的签名。</p><p id="e6f7" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir"> ExpiresOn </strong>是签名的URL有效之前的未来日期。过期后，当您尝试使用已签名的URL访问资源时，将会出现错误403 FORBIDDEN。</p><p id="06b9" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir"> ActiveFrom </strong>指定可访问该资源的开始日期时间。如果您想直接访问它，那么您应该将ActiveFrom日期时间设置为至少比当前日期时间早5分钟(CurrDateTime())，以补偿您的外部系统环境和AWS之间的时差。</p><p id="6fb1" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">接下来，从数据库中读取所有图像。</p><p id="22d0" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">对于数据库中的每个图像，使用list append(<strong class="jp ir">construct result</strong>)填充结果结构。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi pn"><img src="../Images/c397fb208bcf39af27cab2a45a39381c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*fjgjOG3-5FBoIn65gODiqQ.png"/></div></div><figcaption class="pb pc gj gh gi pd pe bd b be z dk translated">ListAppend —构造结果</figcaption></figure><p id="6041" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">结果结构的Url属性设置为CloudFront分发名称，后面是存储在数据库中的键(即前缀+文件名)，后面是查询属性<strong class="jp ir">CloudFront _ GetCustomSignedUrl</strong>结果。</p><p id="e0ca" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">因为我们使用了通配符，所以我们不能使用服务器动作的<strong class="jp ir">absolute uri</strong>属性，我们必须手动连接文件资源路径，然后只追加<strong class="jp ir">查询</strong>字符串。<strong class="jp ir">查询</strong>保存URL的签名信息。</p><p id="7d2c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">此URL在UI模块的图库中用作外部URL。</p><p id="bf1a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">仅此而已。我希望您能够重现所有的步骤，并对本文中概述的主题有一点熟悉。</p><p id="116c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">当然，总是有更多的…</p></div><div class="ab cl ll lm hu ln" role="separator"><span class="lo bw bk lp lq lr"/><span class="lo bw bk lp lq lr"/><span class="lo bw bk lp lq"/></div><div class="ij ik il im in"><h1 id="d6de" class="ls lt iq bd lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp bi translated">注意</h1><p id="3cc0" class="pw-post-body-paragraph jn jo iq jp b jq mq js jt ju mr jw jx jy ms ka kb kc mt ke kf kg mu ki kj kk ij bi translated">我们用默认选项配置了S3和CloudFront。在生产环境中，可能需要额外的配置。对S3和CloudFront的良好理解是关键。</p><p id="9a45" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">OutSystems演示应用程序将凭证(AWS和Private)存储为站点属性。在我的项目中，我使用<a class="ae ol" href="https://www.vaultproject.io/" rel="noopener ugc nofollow" target="_blank"> HashiCorp Vault </a>来存储和检索凭证和其他敏感的配置设置。你也可以看看<a class="ae ol" href="https://docs.aws.amazon.com/secretsmanager/latest/userguide/intro.html" rel="noopener ugc nofollow" target="_blank"> AWS SecretsManager </a>，它是即将推出的OutSystems开发者云中的默认安全配置存储。</p></div><div class="ab cl ll lm hu ln" role="separator"><span class="lo bw bk lp lq lr"/><span class="lo bw bk lp lq lr"/><span class="lo bw bk lp lq"/></div><div class="ij ik il im in"><p id="b00d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">感谢您的阅读。我希望你喜欢它，并且我已经很好地解释了重要的部分。如果没有，请告诉我😊</p><p id="123a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果您在启动和运行时遇到困难，请使用<a class="ae ol" href="https://www.outsystems.com/forums" rel="noopener ugc nofollow" target="_blank"> OutSystems论坛</a>获得帮助。非常欢迎对如何改进这篇文章提出建议。通过我的<a class="ae ol" href="https://www.outsystems.com/profile/0qginuc0j5/overview" rel="noopener ugc nofollow" target="_blank"> OutSystems Profile </a>给我发消息，或者直接在medium上回复。</p><p id="dd93" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果你喜欢我的文章，请留下一些掌声。关注我并订阅，以便在我发布新文章时收到通知。低编码快乐！</p></div></div>    
</body>
</html>