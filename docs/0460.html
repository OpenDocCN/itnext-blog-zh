<html>
<head>
<title>Protect Kubernetes Dashboard with OpenID Connect</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用OpenID Connect保护Kubernetes仪表板</h1>
<blockquote>原文：<a href="https://itnext.io/protect-kubernetes-dashboard-with-openid-connect-104b9e75e39c?source=collection_archive---------1-----------------------#2018-03-13">https://itnext.io/protect-kubernetes-dashboard-with-openid-connect-104b9e75e39c?source=collection_archive---------1-----------------------#2018-03-13</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><h1 id="b592" class="jn jo iq bd jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk bi translated">TL；速度三角形定位法(dead reckoning)</h1><p id="95bb" class="pw-post-body-paragraph kl km iq kn b ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated"><a class="ae lj" href="https://github.com/kubernetes/dashboard" rel="noopener ugc nofollow" target="_blank"> Kubernetes Dashboard </a>是一个很酷的用于Kubernetes集群的web UI。您可以使用OpenID Connect反向代理来保护您的Kubernetes仪表板，例如<a class="ae lj" href="https://github.com/gambol99/keycloak-proxy" rel="noopener ugc nofollow" target="_blank"> keycloak-proxy </a>。</p><figure class="ll lm ln lo gt lp gh gi paragraph-image"><div role="button" tabindex="0" class="lq lr di ls bf lt"><div class="gh gi lk"><img src="../Images/b6743f429dd02a14e3ac05d15af74896.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*bvgDPMuNbzSBra7YGAoSPQ.png"/></div></div><figcaption class="lw lx gj gh gi ly lz bd b be z dk translated">Kubernetes仪表板</figcaption></figure><p id="7d39" class="pw-post-body-paragraph kl km iq kn b ko ma kq kr ks mb ku kv kw mc ky kz la md lc ld le me lg lh li ij bi translated">在本文中，我们配置了以下堆栈:</p><ul class=""><li id="f231" class="mf mg iq kn b ko ma ks mb kw mh la mi le mj li mk ml mm mn bi translated">Keycloak / Google帐户(OpenID Connect身份提供者)</li><li id="9d66" class="mf mg iq kn b ko mo ks mp kw mq la mr le ms li mk ml mm mn bi translated">keycloak-proxy (OpenID连接反向代理)</li><li id="4505" class="mf mg iq kn b ko mo ks mp kw mq la mr le ms li mk ml mm mn bi translated">kube-apiserver (Kubernetes API服务器)</li><li id="118b" class="mf mg iq kn b ko mo ks mp kw mq la mr le ms li mk ml mm mn bi translated">Kubernetes仪表板</li></ul><h1 id="8c43" class="jn jo iq bd jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk bi translated">入门指南</h1><h2 id="fdb3" class="mt jo iq bd jp mu mv dn jt mw mx dp jx kw my mz kb la na nb kf le nc nd kj ne bi translated">第1(a)条。安装钥匙锁</h2><p id="4e40" class="pw-post-body-paragraph kl km iq kn b ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">你可以从<a class="ae lj" href="https://github.com/kubernetes/charts/tree/master/stable/keycloak" rel="noopener ugc nofollow" target="_blank">舵图</a>中部署一个Keycloak服务器。</p><p id="b8e9" class="pw-post-body-paragraph kl km iq kn b ko ma kq kr ks mb ku kv kw mc ky kz la md lc ld le me lg lh li ij bi translated">将Keycloak配置为OpenID Connect身份提供者。</p><p id="27b3" class="pw-post-body-paragraph kl km iq kn b ko ma kq kr ks mb ku kv kw mc ky kz la md lc ld le me lg lh li ij bi translated">在本文中，它假设如下:</p><ul class=""><li id="ba08" class="mf mg iq kn b ko ma ks mb kw mh la mi le mj li mk ml mm mn bi translated">你在领域<code class="fe nf ng nh ni b">hello</code></li><li id="1604" class="mf mg iq kn b ko mo ks mp kw mq la mr le ms li mk ml mm mn bi translated">你有用户<code class="fe nf ng nh ni b">foo</code></li><li id="b96d" class="mf mg iq kn b ko mo ks mp kw mq la mr le ms li mk ml mm mn bi translated">你属于<code class="fe nf ng nh ni b">admin</code>组织</li></ul><p id="4fc4" class="pw-post-body-paragraph kl km iq kn b ko ma kq kr ks mb ku kv kw mc ky kz la md lc ld le me lg lh li ij bi translated">添加具有以下属性的客户端:</p><ul class=""><li id="fe0b" class="mf mg iq kn b ko ma ks mb kw mh la mi le mj li mk ml mm mn bi translated">客户端ID: <code class="fe nf ng nh ni b">kubernetes</code></li><li id="3773" class="mf mg iq kn b ko mo ks mp kw mq la mr le ms li mk ml mm mn bi translated">客户端协议:openid-connect</li><li id="cea5" class="mf mg iq kn b ko mo ks mp kw mq la mr le ms li mk ml mm mn bi translated">访问类型:机密</li><li id="0308" class="mf mg iq kn b ko mo ks mp kw mq la mr le ms li mk ml mm mn bi translated">有效重定向URIs: <code class="fe nf ng nh ni b">https://kubernetes-dashboard.example.com/oauth/callback</code></li></ul><p id="b443" class="pw-post-body-paragraph kl km iq kn b ko ma kq kr ks mb ku kv kw mc ky kz la md lc ld le me lg lh li ij bi translated">然后创建一个映射器。它允许基于组的访问控制。</p><ul class=""><li id="4adc" class="mf mg iq kn b ko ma ks mb kw mh la mi le mj li mk ml mm mn bi translated">名称:<code class="fe nf ng nh ni b">groups</code></li><li id="9ff0" class="mf mg iq kn b ko mo ks mp kw mq la mr le ms li mk ml mm mn bi translated">映射器类型:组成员资格</li><li id="7c9f" class="mf mg iq kn b ko mo ks mp kw mq la mr le ms li mk ml mm mn bi translated">令牌声明名称:<code class="fe nf ng nh ni b">groups</code></li></ul><p id="c924" class="pw-post-body-paragraph kl km iq kn b ko ma kq kr ks mb ku kv kw mc ky kz la md lc ld le me lg lh li ij bi translated">现在钥匙锁变成了身份提供者。</p><h2 id="015e" class="mt jo iq bd jp mu mv dn jt mw mx dp jx kw my mz kb la na nb kf le nc nd kj ne bi translated">第1款(b)项。设置Google身份平台</h2><p id="1fb7" class="pw-post-body-paragraph kl km iq kn b ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">你也可以使用你的谷歌账户。这样更容易。</p><p id="3217" class="pw-post-body-paragraph kl km iq kn b ko ma kq kr ks mb ku kv kw mc ky kz la md lc ld le me lg lh li ij bi translated">打开<a class="ae lj" href="https://console.developers.google.com/apis/credentials" rel="noopener ugc nofollow" target="_blank">Google API控制台</a>并创建一个OAuth客户端，如下所示:</p><ul class=""><li id="8cc6" class="mf mg iq kn b ko ma ks mb kw mh la mi le mj li mk ml mm mn bi translated">应用类型:Web应用</li><li id="4432" class="mf mg iq kn b ko mo ks mp kw mq la mr le ms li mk ml mm mn bi translated">重定向网址:<code class="fe nf ng nh ni b"><a class="ae lj" href="https://kubernetes-dashboard.example.com/oauth/callback" rel="noopener ugc nofollow" target="_blank">https://kubernetes-dashboard.example.com/oauth/callback</a></code></li></ul><p id="820e" class="pw-post-body-paragraph kl km iq kn b ko ma kq kr ks mb ku kv kw mc ky kz la md lc ld le me lg lh li ij bi translated">请在后面的部分用<code class="fe nf ng nh ni b"><a class="ae lj" href="https://accounts.google.com." rel="noopener ugc nofollow" target="_blank">https://accounts.google.com</a></code>替换发行者URL。</p><h2 id="a461" class="mt jo iq bd jp mu mv dn jt mw mx dp jx kw my mz kb la na nb kf le nc nd kj ne bi translated">2.设置Kubernetes API</h2><p id="a4ec" class="pw-post-body-paragraph kl km iq kn b ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">配置kube-apiserver接受OpenID Connect的ID令牌。</p><p id="152b" class="pw-post-body-paragraph kl km iq kn b ko ma kq kr ks mb ku kv kw mc ky kz la md lc ld le me lg lh li ij bi translated">如果您使用kops，通过<code class="fe nf ng nh ni b">kops edit cluster</code>添加以下内容:</p><pre class="ll lm ln lo gt nj ni nk nl aw nm bi"><span id="2349" class="mt jo iq ni b gy nn no l np nq">spec:<br/>  kubeAPIServer:<br/>    oidcClientID: kubernetes<br/>    oidcGroupsClaim: groups<br/>    oidcIssuerURL: https://keycloak.example.com/auth/realms/hello</span></pre><p id="e544" class="pw-post-body-paragraph kl km iq kn b ko ma kq kr ks mb ku kv kw mc ky kz la md lc ld le me lg lh li ij bi translated">如果您正在使用kube-aws，将以下内容添加到<code class="fe nf ng nh ni b">cluster.yaml</code>:</p><pre class="ll lm ln lo gt nj ni nk nl aw nm bi"><span id="bac6" class="mt jo iq ni b gy nn no l np nq">       oidc:<br/>         enabled: true<br/>         issuerUrl: https://keycloak.example.com/auth/realms/hello<br/>         clientId: kubernetes<br/>         groupsClaim: groups</span></pre><p id="1086" class="pw-post-body-paragraph kl km iq kn b ko ma kq kr ks mb ku kv kw mc ky kz la md lc ld le me lg lh li ij bi translated">现在kube-apiserver可以通过ID令牌进行身份验证。</p><h2 id="6e76" class="mt jo iq bd jp mu mv dn jt mw mx dp jx kw my mz kb la na nb kf le nc nd kj ne bi translated">3.设置密钥锁代理</h2><p id="6264" class="pw-post-body-paragraph kl km iq kn b ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">运行OpenID连接代理服务器。keycloak-proxy 是一个用Go编写的轻量级代理服务器。</p><p id="4553" class="pw-post-body-paragraph kl km iq kn b ko ma kq kr ks mb ku kv kw mc ky kz la md lc ld le me lg lh li ij bi translated">您可以从<a class="ae lj" href="https://github.com/int128/kubernetes-dashboard-proxy" rel="noopener ugc nofollow" target="_blank">舵图</a>中部署一个keycloak-proxy，如下所示:</p><pre class="ll lm ln lo gt nj ni nk nl aw nm bi"><span id="0cec" class="mt jo iq ni b gy nn no l np nq">helm repo add int128.github.io <a class="ae lj" href="https://int128.github.io/helm-charts" rel="noopener ugc nofollow" target="_blank">https://int128.github.io/helm-charts</a><br/>helm repo update<br/>helm install int128.github.io/kubernetes-dashboard-proxy</span></pre><p id="23ac" class="pw-post-body-paragraph kl km iq kn b ko ma kq kr ks mb ku kv kw mc ky kz la md lc ld le me lg lh li ij bi translated">或者你可以<code class="fe nf ng nh ni b">kubectl apply</code>下面的清单:</p><figure class="ll lm ln lo gt lp"><div class="bz fp l di"><div class="nr ns l"/></div></figure><p id="5a65" class="pw-post-body-paragraph kl km iq kn b ko ma kq kr ks mb ku kv kw mc ky kz la md lc ld le me lg lh li ij bi translated">上面的例子使用了一个入口来发布代理端口，但是你也可以使用一个<code class="fe nf ng nh ni b">NodePort</code>或者<code class="fe nf ng nh ni b">LoadBalancer</code>。</p><p id="410b" class="pw-post-body-paragraph kl km iq kn b ko ma kq kr ks mb ku kv kw mc ky kz la md lc ld le me lg lh li ij bi translated">如果使用<a class="ae lj" href="https://github.com/kubernetes/ingress-nginx" rel="noopener ugc nofollow" target="_blank"> nginx-ingress </a>，确保<code class="fe nf ng nh ni b">proxy_buffer_size</code>选项大于4kB。您可以通过配置图进行配置。</p><pre class="ll lm ln lo gt nj ni nk nl aw nm bi"><span id="6537" class="mt jo iq ni b gy nn no l np nq">    proxy-buffer-size: "64k"</span></pre><h2 id="bd8a" class="mt jo iq bd jp mu mv dn jt mw mx dp jx kw my mz kb la na nb kf le nc nd kj ne bi translated">4.设置Kubernetes仪表板</h2><p id="d2ad" class="pw-post-body-paragraph kl km iq kn b ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">你可以从<a class="ae lj" href="https://github.com/kubernetes/charts/tree/master/stable/kubernetes-dashboard" rel="noopener ugc nofollow" target="_blank">舵图</a>安装一个Kubernetes仪表盘。</p><pre class="ll lm ln lo gt nj ni nk nl aw nm bi"><span id="b947" class="mt jo iq ni b gy nn no l np nq">helm install stable/kubernetes-dashboard --namespace kube-system --name kubernetes-dashboard</span></pre><p id="b421" class="pw-post-body-paragraph kl km iq kn b ko ma kq kr ks mb ku kv kw mc ky kz la md lc ld le me lg lh li ij bi translated">打开<code class="fe nf ng nh ni b">https://kubernetes-dashboard.example.com</code>。</p><p id="070f" class="pw-post-body-paragraph kl km iq kn b ko ma kq kr ks mb ku kv kw mc ky kz la md lc ld le me lg lh li ij bi translated">由于没有给当前用户或组分配角色，仪表板上将显示一条<code class="fe nf ng nh ni b">Unauthorized</code>警告。</p><p id="cc6c" class="pw-post-body-paragraph kl km iq kn b ko ma kq kr ks mb ku kv kw mc ky kz la md lc ld le me lg lh li ij bi translated">将<code class="fe nf ng nh ni b">cluster-admin</code>角色分配给当前组。</p><pre class="ll lm ln lo gt nj ni nk nl aw nm bi"><span id="1e37" class="mt jo iq ni b gy nn no l np nq">kind: ClusterRoleBinding<br/>apiVersion: rbac.authorization.k8s.io/v1<br/>metadata:<br/>  name: keycloak-admin-group<br/>roleRef:<br/>  apiGroup: rbac.authorization.k8s.io<br/>  kind: ClusterRole<br/>  name: cluster-admin<br/>subjects:<br/>- kind: Group<br/>  name: /admin</span></pre><p id="af46" class="pw-post-body-paragraph kl km iq kn b ko ma kq kr ks mb ku kv kw mc ky kz la md lc ld le me lg lh li ij bi translated">现在，所有对象都显示在仪表板中。</p><p id="a87d" class="pw-post-body-paragraph kl km iq kn b ko ma kq kr ks mb ku kv kw mc ky kz la md lc ld le me lg lh li ij bi translated">注意<code class="fe nf ng nh ni b">cluster-admin</code>角色是超级管理员，可以做任何事情。在你的实际操作中考虑一个专门的角色。</p><h1 id="6f8d" class="jn jo iq bd jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk bi translated">深潜</h1><p id="2a9f" class="pw-post-body-paragraph kl km iq kn b ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">在本文中，我们构建了以下堆栈:</p><figure class="ll lm ln lo gt lp gh gi paragraph-image"><div class="gh gi nt"><img src="../Images/1d9141c80f199899016c51f37eb75221.png" data-original-src="https://miro.medium.com/v2/resize:fit:806/format:webp/1*W31s0-BvaubWDRt24i02bw.png"/></div></figure><p id="dd98" class="pw-post-body-paragraph kl km iq kn b ko ma kq kr ks mb ku kv kw mc ky kz la md lc ld le me lg lh li ij bi translated">首先，代理向Keycloak发送一个重定向。如果身份验证成功完成，代理将接收ID令牌并将其存储到浏览器Cookie中。</p><p id="5af0" class="pw-post-body-paragraph kl km iq kn b ko ma kq kr ks mb ku kv kw mc ky kz la md lc ld le me lg lh li ij bi translated">通过身份验证后，代理将带有<code class="fe nf ng nh ni b">Authorization</code>头的请求转发给仪表板。然后<a class="ae lj" href="https://github.com/kubernetes/dashboard/wiki/Access-control" rel="noopener ugc nofollow" target="_blank">仪表板通过使用ID令牌</a>访问kube-apiserver。</p><p id="c725" class="pw-post-body-paragraph kl km iq kn b ko ma kq kr ks mb ku kv kw mc ky kz la md lc ld le me lg lh li ij bi translated">这样，仪表板将认证委托给kube-apiserver。这就是为什么您必须配置kube-apiserver。</p><h1 id="7688" class="jn jo iq bd jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk bi translated">包裹</h1><p id="8995" class="pw-post-body-paragraph kl km iq kn b ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">在本文中，我介绍了如何用OpenID Connect代理服务器保护Kubernetes仪表板。</p><h1 id="7ff2" class="jn jo iq bd jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk bi translated">请参见</h1><ul class=""><li id="8347" class="mf mg iq kn b ko kp ks kt kw nu la nv le nw li mk ml mm mn bi translated"><a class="ae lj" href="https://medium.com/@int128/kubectl-with-openid-connect-43120b451672" rel="noopener">带OpenID连接的ku bectl</a></li></ul></div></div>    
</body>
</html>