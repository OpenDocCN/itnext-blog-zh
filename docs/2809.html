<html>
<head>
<title>Dockerizing an Angular App with Karma and Protractor containers</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用Karma和量角器容器记录一个有角度的应用程序</h1>
<blockquote>原文：<a href="https://itnext.io/dockerizing-an-angular-app-with-karma-and-protractor-containers-3b4c53ea807f?source=collection_archive---------2-----------------------#2019-08-07">https://itnext.io/dockerizing-an-angular-app-with-karma-and-protractor-containers-3b4c53ea807f?source=collection_archive---------2-----------------------#2019-08-07</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><p id="cc34" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">Docker 是一个容器化工具，用于简化各种环境中的应用程序开发和部署工作流。</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi ko"><img src="../Images/bc4f18ae069f3f7332e7d23b77a2d138.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*zFAUQ8n0vZuKJEG5kJnVsQ.png"/></div></div></figure><p id="2a80" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">本教程展示了如何使用Docker和Docker Compose在开发和生产中对Angular应用程序进行Docker化，使用Angular CLI进行构建。我们将特别关注:</p><ol class=""><li id="12f6" class="la lb it js b jt ju jx jy kb lc kf ld kj le kn lf lg lh li bi translated">设置一个docker-compose文件用于热重装开发，其中包括一个用于Karma和量角器测试的Chrome实例</li><li id="05f9" class="la lb it js b jt lj jx lk kb ll kf lm kj ln kn lf lg lh li bi translated">使用多阶段构建配置精简的生产就绪映像</li></ol></div><div class="ab cl lo lp hx lq" role="separator"><span class="lr bw bk ls lt lu"/><span class="lr bw bk ls lt lu"/><span class="lr bw bk ls lt"/></div><div class="im in io ip iq"><p id="abf0" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><em class="lv">我们将使用:</em></p><ul class=""><li id="a985" class="la lb it js b jt ju jx jy kb lc kf ld kj le kn lw lg lh li bi translated">Docker版本19.03.1，内部版本74b1e89</li><li id="18e6" class="la lb it js b jt lj jx lk kb ll kf lm kj ln kn lw lg lh li bi translated">docker-compose版本1.24.1，内部版本号4667896b</li><li id="7eb2" class="la lb it js b jt lj jx lk kb ll kf lm kj ln kn lw lg lh li bi translated">马科斯</li></ul><h1 id="500c" class="lx ly it bd lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp mq mr ms mt mu bi translated">内容</h1><ul class=""><li id="7876" class="la lb it js b jt mv jx mw kb mx kf my kj mz kn lw lg lh li bi translated"><a class="ae na" href="#ee43" rel="noopener ugc nofollow">项目设置</a></li><li id="5475" class="la lb it js b jt lj jx lk kb ll kf lm kj ln kn lw lg lh li bi translated"><a class="ae na" href="#a324" rel="noopener ugc nofollow">生产构建</a></li></ul><h1 id="ee43" class="lx ly it bd lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp mq mr ms mt mu bi translated">项目设置</h1><p id="83c6" class="pw-post-body-paragraph jq jr it js b jt mv jv jw jx mw jz ka kb nb kd ke kf nc kh ki kj nd kl km kn im bi translated">为角度应用程序创建新文件夹:</p><pre class="kp kq kr ks gt ne nf ng nh aw ni bi"><span id="8d60" class="nj ly it nf b gy nk nl l nm nn">$ mkdir myApp</span></pre><p id="65f1" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">创建docker撰写文件:</p><pre class="kp kq kr ks gt ne nf ng nh aw ni bi"><span id="9e97" class="nj ly it nf b gy nk nl l nm nn">$ touch docker-compose.yml</span></pre><p id="7cd4" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">将以下yml配置添加到docker-compose文件中。我们将使用开源angular CLI docker映像来创建和运行新的angular应用程序:</p><pre class="kp kq kr ks gt ne nf ng nh aw ni bi"><span id="a4c1" class="nj ly it nf b gy nk nl l nm nn">version: '3'<br/>services:<br/>  angular_cli:<br/>    image: trion/ng-cli:latest<br/>    container_name: 'angular_cli'<br/>    volumes:<br/>      - .:/usr/app/<br/>    working_dir: /usr/app/<br/>    command: &gt;<br/>      bash -c "ng new myApp --directory ./"</span></pre><p id="7028" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><code class="fe no np nq nf b">command</code>配置中的键具有在容器启动后运行的命令。在这种情况下，它将通过Angular CLI创建一个新项目。</p><p id="be40" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">通过以下命令启动容器。</p><pre class="kp kq kr ks gt ne nf ng nh aw ni bi"><span id="9d0e" class="nj ly it nf b gy nk nl l nm nn">$ docker-compose up</span></pre><p id="a3c9" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">通过完成这一步，我们创建了一个新的angular项目，并在本地环境中启用了热重载特性。这可能需要2-3分钟才能完成。下一步，我们将添加测试服务，并将所有服务一起旋转。</p><h2 id="4dcd" class="nj ly it bd lz nr ns dn md nt nu dp mh kb nv nw ml kf nx ny mp kj nz oa mt ob bi translated">设置Karma和量角器容器</h2><p id="71b7" class="pw-post-body-paragraph jq jr it js b jt mv jv jw jx mw jz ka kb nb kd ke kf nc kh ki kj nd kl km kn im bi translated">由于项目已经创建，我们需要对docker compose文件中的现有服务进行少量更改。这一次我们不希望命令创建一个新项目，我们只想在容器中运行它。此外，我们需要发布相关的端口，以便能够通过浏览器访问它。看起来像这样:</p><pre class="kp kq kr ks gt ne nf ng nh aw ni bi"><span id="7e91" class="nj ly it nf b gy nk nl l nm nn">version: '3'<br/>services:<br/>  angular_cli:<br/>    image: trion/ng-cli:latest<br/>    container_name: 'angular_cli'<br/>    volumes:<br/>      - .:/usr/app/<br/>    working_dir: /usr/app/<br/>    ports:<br/>      - 4200:4200<br/>    command: &gt;<br/>      bash -c "npm install &amp;&amp; ng serve --host 0.0.0.0"</span></pre><p id="c6e7" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">我们需要在docker-compose.yml文件中再添加两个服务。一个是因果报应。为此，我们将使用内置chromium的ng-cli-karma映像。</p><p id="9f7a" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">您将能够通过您的浏览器访问它，并且“更改时自动运行测试”功能已经启用。将以下代码块添加到docker-compose文件中。注意服务名的缩进。</p><pre class="kp kq kr ks gt ne nf ng nh aw ni bi"><span id="3077" class="nj ly it nf b gy nk nl l nm nn">  angular_karma:<br/>    image: trion/ng-cli-karma:latest<br/>    container_name: 'angular_karma'<br/>    volumes:<br/>      - .:/usr/app/<br/>    working_dir: /usr/app/<br/>    ports:<br/>      - 9876:9876<br/>    command: &gt;<br/>      bash -c "ng test"</span></pre><p id="f0f9" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">当这个服务启动时，它将继续运行并观察我们的测试文件的文件变化。您可以通过访问<a class="ae na" href="http://localhost:9876/" rel="noopener ugc nofollow" target="_blank"> http://localhost:9876/ </a>访问Karma UI</p><p id="f3f2" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">下一次点击，我们将通过docker容器中的量角器添加另一个运行e2e测试的图像。将以下代码块添加到docker-compose.yml文件中。</p><pre class="kp kq kr ks gt ne nf ng nh aw ni bi"><span id="ee78" class="nj ly it nf b gy nk nl l nm nn">  angular_e2e:<br/>    image: trion/ng-cli-e2e:latest<br/>    container_name: "angular_e2e"<br/>    volumes:<br/>      - .:/usr/app/<br/>    working_dir: /usr/app/<br/>    command: &gt;<br/>      bash -c "ng e2e"</span></pre><p id="54bf" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">一旦端到端测试容器运行并完成测试，它就会停止。</p><p id="dc64" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">最后，我们可以在本地机器上运行容器。我们可以一次运行所有容器，就像这样使用日志:</p><pre class="kp kq kr ks gt ne nf ng nh aw ni bi"><span id="280d" class="nj ly it nf b gy nk nl l nm nn">$ docker-compose up</span></pre><p id="d356" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">或者我们可以从docker-compose.yml文件中运行单独的服务，如下所示:</p><pre class="kp kq kr ks gt ne nf ng nh aw ni bi"><span id="d8e3" class="nj ly it nf b gy nk nl l nm nn">$ docker-compose up angular_cli angular_karma angular_e2e</span></pre><h1 id="a324" class="lx ly it bd lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp mq mr ms mt mu bi translated">生产构建</h1><p id="c42d" class="pw-post-body-paragraph jq jr it js b jt mv jv jw jx mw jz ka kb nb kd ke kf nc kh ki kj nd kl km kn im bi translated">通常，生产docker的配置与开发docker不同。因此，隔离的最佳方式和归档的最简单方式是在项目根目录下创建新的Dockerfile:</p><pre class="kp kq kr ks gt ne nf ng nh aw ni bi"><span id="ce12" class="nj ly it nf b gy nk nl l nm nn">$ touch Dockerfile</span></pre><p id="ddc7" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">这一次，我们不需要Angular CLI功能和其他工具来改善开发人员的体验。我们只是想把这个项目轻量级的，尽可能高性能的交付给生产。</p><p id="9c19" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">我们将分两步对此进行归档:</p><ul class=""><li id="2fc0" class="la lb it js b jt ju jx jy kb lc kf ld kj le kn lw lg lh li bi translated">构建:使用节点alpine映像构建应用程序</li><li id="fba3" class="la lb it js b jt lj jx lk kb ll kf lm kj ln kn lw lg lh li bi translated">服务:通过在构建过程和Nginx配置之后使用人工制品，我们将服务于应用程序。</li></ul><p id="04fd" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">将以下配置添加到刚刚创建的Dockerfile中:</p><pre class="kp kq kr ks gt ne nf ng nh aw ni bi"><span id="e287" class="nj ly it nf b gy nk nl l nm nn">### STAGE 1: Build ###</span><span id="7979" class="nj ly it nf b gy oc nl l nm nn"># We label our stage as ‘builder’<br/>FROM node:alpine as builder</span><span id="82b8" class="nj ly it nf b gy oc nl l nm nn">COPY package.json package-lock.json ./</span><span id="4a22" class="nj ly it nf b gy oc nl l nm nn">## Storing node modules on a separate layer will prevent unnecessary npm installs at each build</span><span id="066d" class="nj ly it nf b gy oc nl l nm nn">RUN npm ci &amp;&amp; mkdir /ng-app &amp;&amp; mv ./node_modules ./ng-app</span><span id="6b9b" class="nj ly it nf b gy oc nl l nm nn">WORKDIR /ng-app</span><span id="99ae" class="nj ly it nf b gy oc nl l nm nn">COPY . .</span><span id="5327" class="nj ly it nf b gy oc nl l nm nn">## Build the angular app in production mode and store the artifacts in dist folder</span><span id="1d1b" class="nj ly it nf b gy oc nl l nm nn">RUN npm run ng build -- --prod --output-path=dist</span><span id="e4b4" class="nj ly it nf b gy oc nl l nm nn">### STAGE 2: Setup ###</span><span id="c4dd" class="nj ly it nf b gy oc nl l nm nn">FROM nginx:alpine</span><span id="3f6a" class="nj ly it nf b gy oc nl l nm nn">## Copy our default nginx config<br/>COPY nginx/default.conf /etc/nginx/conf.d/</span><span id="7a85" class="nj ly it nf b gy oc nl l nm nn">## Remove default nginx website<br/>RUN rm -rf /usr/share/nginx/html/*</span><span id="165d" class="nj ly it nf b gy oc nl l nm nn">## From ‘builder’ stage copy over the artifacts in dist folder to default nginx public folder<br/>COPY --from=builder /ng-app/dist /usr/share/nginx/html</span><span id="f036" class="nj ly it nf b gy oc nl l nm nn">CMD ["nginx", "-g", "daemon off;"]</span></pre><p id="d1b6" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">然后，您可以像这样构建我们的生产映像:</p><pre class="kp kq kr ks gt ne nf ng nh aw ni bi"><span id="c1a2" class="nj ly it nf b gy nk nl l nm nn">$ docker build -t myapp:prod .</span></pre><p id="e4ab" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">为了进行测试，您可以使用以下命令运行该映像，并访问<a class="ae na" href="http://localhost:8080/" rel="noopener ugc nofollow" target="_blank"> http://localhost:8080/ </a>:</p><pre class="kp kq kr ks gt ne nf ng nh aw ni bi"><span id="4d84" class="nj ly it nf b gy nk nl l nm nn">$ docker run -p 8080:80 myapp:prod</span></pre><p id="cf4e" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">这个应用程序的大小比开发图像小很多，在这种情况下，它大约为21.6 MB</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi od"><img src="../Images/72cf9ddfdd7bbebc7824de731ac7e9e7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*IAwsfPM-BIGqf-MoDmXDgQ.png"/></div></div></figure><p id="e9ca" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">你可以在github上看到完整的例子:【https://github.com/ersah123/angular-docker-karma-protractor T2】</p><p id="d1fa" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">干杯！</p></div></div>    
</body>
</html>