<html>
<head>
<title>Monitoring Spark Streaming on K8s with Prometheus and Grafana</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用普罗米修斯和格拉夫纳监测K8s上的火花流</h1>
<blockquote>原文：<a href="https://itnext.io/monitoring-spark-streaming-on-k8s-with-prometheus-and-grafana-e6d8720c4a02?source=collection_archive---------2-----------------------#2021-05-10">https://itnext.io/monitoring-spark-streaming-on-k8s-with-prometheus-and-grafana-e6d8720c4a02?source=collection_archive---------2-----------------------#2021-05-10</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/aae631efa28cb52f7a6ff165e6531e00.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*2G3ua-5faFkgcj957PuYqw.png"/></div></div></figure><h1 id="eec9" class="jy jz iq bd ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv bi translated">介绍</h1><p id="8669" class="pw-post-body-paragraph kw kx iq ky b kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt ij bi translated">成本效益和可移植性是将Apache Spark工作负载从托管服务(如<a class="ae lu" href="https://aws.amazon.com/emr/" rel="noopener ugc nofollow" target="_blank"> AWS EMR </a>、<a class="ae lu" href="https://azure.microsoft.com/en-us/services/databricks/#:~:text=Azure%20Databricks%20provides%20the%20latest,scale%20and%20availability%20of%20Azure." rel="noopener ugc nofollow" target="_blank"> Azure Databricks </a>或<a class="ae lu" href="https://docs.microsoft.com/en-us/azure/hdinsight/hdinsight-overview#:~:text=Azure%20HDInsight%20is%20a%20managed,Storm%2C%20R%2C%20and%20more." rel="noopener ugc nofollow" target="_blank"> HDInsight </a>迁移到<a class="ae lu" href="https://kubernetes.io/" rel="noopener ugc nofollow" target="_blank"> Kubernetes </a>的主要原因。您可以在下面的<a class="ae lu" rel="noopener ugc nofollow" target="_blank" href="/migrating-apache-spark-workloads-from-aws-emr-to-kubernetes-463742b49fda">文章</a>中了解更多关于从AWS EMR到K8s的迁移过程。然而，离开托管服务也有潜在的隐患。最大的问题可能是失去监控和警报能力。例如，AWS EMR以CloudWatch、Ganglia、CloudTrail和YARN history server的形式提供了非常丰富的内置监控工具箱。在本文中，我们将探索一种通过使用Prometheus和Grafana在K8s上实现Apache Spark监控功能的简单方法</p><h1 id="b215" class="jy jz iq bd ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv bi translated">目标</h1><p id="b110" class="pw-post-body-paragraph kw kx iq ky b kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt ij bi translated">在生产中大规模运行Apache Spark工作负载是一项非常复杂的任务。有很多事情可能会出错:遗嘱执行人可能会失败。外部数据源的延迟可能会增加，由于输入数据性质的变化或代码的更改等原因，性能可能会下降。为了解决所有这些潜在问题，有必要主动实时监控重要指标。Apache Spark中需要监控的一些重要指标是:</p><ol class=""><li id="0744" class="lv lw iq ky b kz lx ld ly lh lz ll ma lp mb lt mc md me mf bi translated">资源利用率:核心数量、CPU时间、使用的内存、分配的最大内存、使用的磁盘。</li><li id="fe9c" class="lv lw iq ky b kz mg ld mh lh mi ll mj lp mk lt mc md me mf bi translated">Spark任务:活动/失败/已完成任务的数量，任务最大/平均/最小持续时间</li><li id="ae8e" class="lv lw iq ky b kz mg ld mh lh mi ll mj lp mk lt mc md me mf bi translated">火花洗牌:总洗牌读/写字节</li><li id="0500" class="lv lw iq ky b kz mg ld mh lh mi ll mj lp mk lt mc md me mf bi translated">Spark调度程序:活动/已完成/失败的作业数</li><li id="8ae3" class="lv lw iq ky b kz mg ld mh lh mi ll mj lp mk lt mc md me mf bi translated">火花流:接收器数量、运行/失败/完成的批次数量、接收/处理的记录数量、平均记录处理时间</li><li id="e849" class="lv lw iq ky b kz mg ld mh lh mi ll mj lp mk lt mc md me mf bi translated">自定义指标:任何应用程序的特定指标都应该与系统指标一起被监控。</li></ol><h1 id="c96d" class="jy jz iq bd ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv bi translated">解决办法</h1><p id="97c0" class="pw-post-body-paragraph kw kx iq ky b kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt ij bi translated">Prometheus 是与Kubernetes一起使用的最受欢迎的监控工具之一。它是开源的、去中心化的、社区驱动的，并且是云计算原生计算基金会的成员。Prometheus将其所有数据存储为时间序列。这些数据可以通过<a class="ae lu" href="https://prometheus.io/docs/prometheus/latest/querying/basics/\" rel="noopener ugc nofollow" target="_blank"> PromQL </a>查询，并在<a class="ae lu" href="https://grafana.com/" rel="noopener ugc nofollow" target="_blank"> Grafana </a>或内置浏览器中可视化。Apache Spark 3.0增加了一种简单的方法来支持Prometheus的一般用例。</p><h2 id="0611" class="ml jz iq bd ka mm mn dn ke mo mp dp ki lh mq mr km ll ms mt kq lp mu mv ku mw bi translated"><strong class="ak">步骤1:准备水槽</strong></h2><p id="10f5" class="pw-post-body-paragraph kw kx iq ky b kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt ij bi translated">在Spark 2x中，您可以使用内置JmxSink和JmxExporter的组合。从<a class="ae lu" href="https://spark.apache.org/releases/spark-release-3-0-0.html" rel="noopener ugc nofollow" target="_blank"> Spark 3.0 </a>开始，引入了一个新的sink——PrometheusServlet。PrometheusServlet相对于JmxSink &amp; JmxExporter的优势是显而易见的:消除对外部JAR的依赖，重用Spark中已经用于监控的现有端口，利用Kubernetes中的Prometheus服务发现。</p><p id="0842" class="pw-post-body-paragraph kw kx iq ky b kz lx lb lc ld ly lf lg lh mx lj lk ll my ln lo lp mz lr ls lt ij bi translated">为了启用新的接收器，在您的项目中创建<strong class="ky ir"> metrics.properties </strong>文件</p><figure class="nb nc nd ne gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi na"><img src="../Images/094c11df713b33021fb95b28aa9117e7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1272/format:webp/1*0FNcAfilAz16h-UkbpjCSQ.png"/></div></div></figure><p id="f3bb" class="pw-post-body-paragraph kw kx iq ky b kz lx lb lc ld ly lf lg lh mx lj lk ll my ln lo lp mz lr ls lt ij bi translated">将以下配置添加到<strong class="ky ir"> metrics.properties: </strong></p><figure class="nb nc nd ne gt jr"><div class="bz fp l di"><div class="nf ng l"/></div><figcaption class="nh ni gj gh gi nj nk bd b be z dk translated"><strong class="ak"> metrics.properties </strong></figcaption></figure><h2 id="6164" class="ml jz iq bd ka mm mn dn ke mo mp dp ki lh mq mr km ll ms mt kq lp mu mv ku mw bi translated">步骤2:部署应用程序</h2><p id="4b48" class="pw-post-body-paragraph kw kx iq ky b kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt ij bi translated">在K8s上部署Spark时，您将Spark应用程序打包在Docker映像中。例如，提供的Dockerfile是一个多阶段映像:第一个阶段用于通过使用<a class="ae lu" href="https://www.scala-sbt.org/" rel="noopener ugc nofollow" target="_blank"> SBT工具</a>编译和构建Spark (scala)应用程序，第二个阶段作为Spark基础层，最后一个阶段用于最终的可部署映像。在第94行，(最终图像阶段)我们将<strong class="ky ir"> metrics.properties </strong>复制到opt/spark/conf/文件夹。</p><figure class="nb nc nd ne gt jr"><div class="bz fp l di"><div class="nf ng l"/></div></figure><h2 id="8791" class="ml jz iq bd ka mm mn dn ke mo mp dp ki lh mq mr km ll ms mt kq lp mu mv ku mw bi translated">步骤3:自定义指标</h2><p id="75ee" class="pw-post-body-paragraph kw kx iq ky b kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt ij bi translated">在生命周期的某个时刻，几乎所有应用程序都需要能够报告自定义指标，如某些方法的延迟、关于内部状态的关键统计数据、应用程序健康检查等。因此，我们需要能够检测代码，然后向Prometheus公开自定义指标。这可以通过使用<a class="ae lu" href="https://metrics.dropwizard.io/4.1.2/" rel="noopener ugc nofollow" target="_blank"> Dropwizard Metrics </a> java库来完成。例如，您可以看到自定义度量类的以下实现:</p><figure class="nb nc nd ne gt jr"><div class="bz fp l di"><div class="nf ng l"/></div><figcaption class="nh ni gj gh gi nj nk bd b be z dk translated">自定义指标实施</figcaption></figure><p id="ae1f" class="pw-post-body-paragraph kw kx iq ky b kz lx lb lc ld ly lf lg lh mx lj lk ll my ln lo lp mz lr ls lt ij bi translated">从代码的任何地方，只需调用您的定制指标并更新计数器、直方图、计量器或计时器。所有自定义指标将通过使用HTTP协议自动公开。</p><figure class="nb nc nd ne gt jr"><div class="bz fp l di"><div class="nf ng l"/></div></figure><p id="be0e" class="pw-post-body-paragraph kw kx iq ky b kz lx lb lc ld ly lf lg lh mx lj lk ll my ln lo lp mz lr ls lt ij bi translated">部署spark应用程序后，您可以导航到K8s集群中的驱动程序窗格，并确保所有Spark和定制指标都被正确地公开。例如，您可以使用curl命令来完成。</p><figure class="nb nc nd ne gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nl"><img src="../Images/15f45a7cd2e095ff5ba13c4b9eb1e708.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*80pldnjK8-qsjaP-ZsAZpQ.png"/></div></div><figcaption class="nh ni gj gh gi nj nk bd b be z dk translated">卷曲输出</figcaption></figure><p id="503e" class="pw-post-body-paragraph kw kx iq ky b kz lx lb lc ld ly lf lg lh mx lj lk ll my ln lo lp mz lr ls lt ij bi translated">Apache Spark Streaming需要额外的配置:Spark . SQL . Streaming . metrics enabled .当<strong class="ky ir">Spark . SQL . Streaming . metrics enabled</strong>设置为true时，会看到以下额外的指标:延迟、处理速率、状态行、事件时间水印等。</p><h2 id="13a7" class="ml jz iq bd ka mm mn dn ke mo mp dp ki lh mq mr km ll ms mt kq lp mu mv ku mw bi translated">步骤4:创建Grafana仪表板</h2><p id="2877" class="pw-post-body-paragraph kw kx iq ky b kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt ij bi translated">一旦部署了spark应用程序并且配置了Prometheus<a class="ae lu" href="https://devopscube.com/setup-prometheus-monitoring-on-kubernetes/" rel="noopener ugc nofollow" target="_blank"/>，您就可以使用Grafana仪表板了。在Grafana上创建一个新的仪表板，选择Prometheus数据源，然后输入您的查询。</p><figure class="nb nc nd ne gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nm"><img src="../Images/0d4a958a9ce7f79f912f8ee840c94319.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*u1M9BFqsCI9CQV4HzcoPvA.png"/></div></div><figcaption class="nh ni gj gh gi nj nk bd b be z dk translated">格拉夫纳</figcaption></figure><p id="2c49" class="pw-post-body-paragraph kw kx iq ky b kz lx lb lc ld ly lf lg lh mx lj lk ll my ln lo lp mz lr ls lt ij bi translated">当您搜索特定指标时，请记住PrometheusServlet遵循Spark 2.x命名约定以保持一致性，而不是使用Prometheus标准。选择您选择的任何指标，并将其放在Grafana仪表板上。</p><figure class="nb nc nd ne gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nn"><img src="../Images/b70ae8cbb056a793a9cf9a7aecb35139.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*cQkM0yBxuGCc_Z4mcF5UIw.png"/></div></div><figcaption class="nh ni gj gh gi nj nk bd b be z dk translated">卡夫卡&amp;火花流</figcaption></figure><p id="67da" class="pw-post-body-paragraph kw kx iq ky b kz lx lb lc ld ly lf lg lh mx lj lk ll my ln lo lp mz lr ls lt ij bi translated">此外，您可以使用Prometheus <a class="ae lu" href="https://prometheus.io/docs/alerting/latest/alertmanager/" rel="noopener ugc nofollow" target="_blank"> Alertmanager </a>来定义重要指标的警报。例如，在失败的作业、长时间运行的任务、大规模洗牌、延迟与批处理间隔(流)等Spark指标上定义警报是一个好主意。</p><h1 id="b7c0" class="jy jz iq bd ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv bi translated">摘要</h1><p id="d6bb" class="pw-post-body-paragraph kw kx iq ky b kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt ij bi translated">如果您正在运行大量的Apache Spark工作负载，并且您关心成本效率和可移植性，那么您可能正在考虑或者已经在使用Kubernetes。阿帕奇Spark 3向K8s方向又迈进了一大步。由于Prometheus Monitoring的本机支持，K8s上的Apache Spark监控和警报非常简单，它可以与我们过去在AWS EMR等托管服务上使用的相媲美。</p></div></div>    
</body>
</html>