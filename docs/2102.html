<html>
<head>
<title>Will it scale? Let’s load test geohashing on DynamoDB</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">它会扩展吗？让我们在DynamoDB上加载测试geohashing</h1>
<blockquote>原文：<a href="https://itnext.io/will-it-scale-lets-load-test-geohashing-on-dynamodb-fbdc612d9ec3?source=collection_archive---------1-----------------------#2019-04-01">https://itnext.io/will-it-scale-lets-load-test-geohashing-on-dynamodb-fbdc612d9ec3?source=collection_archive---------1-----------------------#2019-04-01</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="d877" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">James Beswick和Richard Boyd测试了地理哈希解决方案可以无服务器扩展到什么程度。</h2></div><figure class="kk kl km kn gt ko gh gi paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gh gi kj"><img src="../Images/b3003488ccce93eecc15e5673b682e6b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*Xknl7MwQIWV5sAsp"/></div></div></figure><p id="1cf6" class="pw-post-body-paragraph kv kw it kx b ky kz ju la lb lc jx ld le lf lg lh li lj lk ll lm ln lo lp lq im bi translated">在我关于DynamoDB 的<a class="ae lr" href="https://read.acloud.guru/location-based-search-results-with-dynamodb-and-geohash-267727e5d54f" rel="noopener ugc nofollow" target="_blank">地理哈希的文章中，我展示了一种简单的方法来查询位置列表以找到最近的星巴克店。该方法使用几行代码通过地理哈希NPM包加载和查询数据。</a></p><p id="6fcb" class="pw-post-body-paragraph kv kw it kx b ky kz ju la lb lc jx ld le lf lg lh li lj lk ll lm ln lo lp lq im bi translated">但是这种方法的可扩展性如何呢？下一个问题是如何通过负载测试来衡量这个NPM库的性能，分析使用这个包的成本，并查看大规模的架构选项。</p><p id="0972" class="pw-post-body-paragraph kv kw it kx b ky kz ju la lb lc jx ld le lf lg lh li lj lk ll lm ln lo lp lq im bi translated">今天我和iRobot云工程师<a class="ae lr" href="https://twitter.com/rchrdbyd" rel="noopener ugc nofollow" target="_blank"> Richard Boyd </a>一起工作，他正在帮助我寻找一些提高性能的聪明方法。</p><h2 id="af45" class="ls lt it bd lu lv lw dn lx ly lz dp ma le mb mc md li me mf mg lm mh mi mj mk bi translated">NPM图书馆在做什么？</h2><p id="13f8" class="pw-post-body-paragraph kv kw it kx b ky ml ju la lb mm jx ld le mn lg lh li mo lk ll lm mp lo lp lq im bi translated"><a class="ae lr" href="https://www.npmjs.com/package/dynamodb-geo" rel="noopener ugc nofollow" target="_blank"> DynamoDB-Geo库</a>管理底层DynamoDB表，设置分区键和二级索引来管理查找。通常每个搜索请求运行8个单独的查询，所以它不会从DynamoDB表中一次获取所有结果。</p><p id="859f" class="pw-post-body-paragraph kv kw it kx b ky kz ju la lb lc jx ld le lf lg lh li lj lk ll lm ln lo lp lq im bi translated">这是因为一旦识别了初始geohash正方形，算法还需要知道周围8个正方形中有什么，因为项目可能在正方形的边缘，或者指定的半径可能覆盖多个正方形。</p><p id="6738" class="pw-post-body-paragraph kv kw it kx b ky kz ju la lb lc jx ld le lf lg lh li lj lk ll lm ln lo lp lq im bi translated">一些性能特征也归因于我们对散列键长度的选择——散列越短，方块越大；哈希越大，方块越小。例如，如果您的零售点遍布全球，但使用长哈希和大搜索半径，则性能会比搜索半径较小的短哈希差得多。</p><h2 id="66d4" class="ls lt it bd lu lv lw dn lx ly lz dp ma le mb mc md li me mf mg lm mh mi mj mk bi translated"><strong class="ak">用火炮进行负载测试</strong></h2><p id="a17d" class="pw-post-body-paragraph kv kw it kx b ky ml ju la lb mm jx ld le mn lg lh li mo lk ll lm mp lo lp lq im bi translated">这种服务的可能负载很难估计，但是我们可以使用<a class="ae lr" href="https://artillery.io/" rel="noopener ugc nofollow" target="_blank">火炮</a>工具包非常容易地为API创建一个艰巨的压力测试。</p><p id="0912" class="pw-post-body-paragraph kv kw it kx b ky kz ju la lb lc jx ld le lf lg lh li lj lk ll lm ln lo lp lq im bi translated">这个节点包可以在您的本地开发机器上模拟合理数量的独立并发用户。实际的数量将取决于你的电脑和网络连接，因为在幕后炮兵正在测试多个Chrome实例。</p><p id="cf82" class="pw-post-body-paragraph kv kw it kx b ky kz ju la lb lc jx ld le lf lg lh li lj lk ll lm ln lo lp lq im bi translated">在我的机器上，我发现一秒钟可以模拟20个用户访问API，但是如果我设置一个更高的限制，由于PC上的资源限制，测量变得不可靠。</p><figure class="kk kl km kn gt ko gh gi paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gh gi mq"><img src="../Images/cdd7db9b9df9cb8a3610ac0267b30e78.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*NIbukZrt1kes8z8CFkdJ_g.png"/></div></div><figcaption class="mr ms gj gh gi mt mu bd b be z dk translated">用自定义函数配置cannon，在一个边界框内模拟随机的纬度和经度请求。</figcaption></figure><p id="15c6" class="pw-post-body-paragraph kv kw it kx b ky kz ju la lb lc jx ld le lf lg lh li lj lk ll lm ln lo lp lq im bi translated">在这个测试中，我在曼哈顿地区周围设置了一个边界方块，使用cannon中的自定义函数在这些边界内随机选择一个纬度和经度。我选择这个区域是因为纽约市有大量的星巴克商店——不管测试在哪里进行，我都可能得到多个结果。</p><figure class="kk kl km kn gt ko gh gi paragraph-image"><div class="gh gi mv"><img src="../Images/8b03e8284ea1862d779171a0f3dccc45.png" data-original-src="https://miro.medium.com/v2/resize:fit:716/format:webp/1*vUHysNfutpLFGSwBN4pWZQ.png"/></div><figcaption class="mr ms gj gh gi mt mu bd b be z dk translated">火炮载荷测试结果。</figcaption></figure><p id="e47b" class="pw-post-body-paragraph kv kw it kx b ky kz ju la lb lc jx ld le lf lg lh li lj lk ll lm ln lo lp lq im bi translated">这个测试运行2分钟(每秒20个用户)，总共完成2400个请求。在此期间，DynamoDB RCUs增至86个，延迟降至7–10毫秒:</p><figure class="kk kl km kn gt ko gh gi paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gh gi mw"><img src="../Images/e990962a132f241891f5cd83b5401bb8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*wPyLWFZdSos7303K"/></div></div></figure><figure class="kk kl km kn gt ko gh gi paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gh gi mx"><img src="../Images/cb2e03f672693a071ce8e11e2e999fe8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*pOQy4tn8EYBwyrwlhhHaow.png"/></div></div></figure><p id="89cc" class="pw-post-body-paragraph kv kw it kx b ky kz ju la lb lc jx ld le lf lg lh li lj lk ll lm ln lo lp lq im bi translated">在上面显示的代码和没有缓存的初始配置中，我们可以轻松地每天处理170万次API点击(平均每天每秒20次请求)。但是代价是什么呢？</p><ul class=""><li id="874b" class="my mz it kx b ky kz lb lc le na li nb lm nc lq nd ne nf ng bi translated">DynamoDB:需要不到100个rcu，所以每月不到10美元。</li><li id="c978" class="my mz it kx b ky nh lb ni le nj li nk lm nl lq nd ne nf ng bi translated">API Gateway在最低层按每百万次请求3.50美元收费，因此5230万次请求每月花费约183美元。</li><li id="ceaa" class="my mz it kx b ky nh lb ni le nj li nk lm nl lq nd ne nf ng bi translated">Lambda:函数的平均执行时间是382毫秒，所以400毫秒、1024兆内存和5200万次执行的成本大约是357美元。</li><li id="52a4" class="my mz it kx b ky nh lb ni le nj li nk lm nl lq nd ne nf ng bi translated">在这种设置中，为5200万个查找服务的总估计月成本约为550美元。</li></ul><h2 id="80b1" class="ls lt it bd lu lv lw dn lx ly lz dp ma le mb mc md li me mf mg lm mh mi mj mk bi translated"><strong class="ak">更多位置，更多写入</strong></h2><p id="554a" class="pw-post-body-paragraph kv kw it kx b ky ml ju la lb mm jx ld le mn lg lh li mo lk ll lm mp lo lp lq im bi translated">Starbucks位置列表是相对静态的，数据库表上的活动几乎都是“读取”。根据DynamoDB的性能特征，表中的项数不太可能影响读取性能，并且表可能会大得多，而查询延迟不会有明显的差异。</p><p id="4c5e" class="pw-post-body-paragraph kv kw it kx b ky kz ju la lb lc jx ld le lf lg lh li lj lk ll lm ln lo lp lq im bi translated">但是，NPM图书馆使用geohash作为分区键，因此无法更新表中已有项目的位置(您必须删除并重新创建项目)。对于像星巴克这样的实体场所来说，这不是问题，因为它们通常不会改变位置，但是如果你有一个频繁移动的对象列表，这可能不是使用的正确库。</p><h2 id="0c38" class="ls lt it bd lu lv lw dn lx ly lz dp ma le mb mc md li me mf mg lm mh mi mj mk bi translated"><strong class="ak">全球表格</strong></h2><p id="4883" class="pw-post-body-paragraph kv kw it kx b ky ml ju la lb mm jx ld le mn lg lh li mo lk ll lm mp lo lp lq im bi translated">如果像星巴克这样的大型零售公司使用这项服务来查找他们全球最近的商店，<a class="ae lr" href="https://engineering.opsgenie.com/everything-you-need-to-know-about-dynamodb-global-tables-952d020d9834" rel="noopener ugc nofollow" target="_blank"> DynamoDB Global Tables </a>将是一个很好的选择，可以将负载分散到多个地区，并减少查找的延迟。在这种情况下，如果50%的搜索发生在欧洲，那么将该表复制到该地区可以有效地从us-east-1中的主表分流50%的流量。</p><p id="cd37" class="pw-post-body-paragraph kv kw it kx b ky kz ju la lb lc jx ld le lf lg lh li lj lk ll lm ln lo lp lq im bi translated">这种方法可能不适合所有的业务案例(例如，查找来自单个地理区域，或者数据可能不会移出特定区域)，但是考虑到使用这种特性的简单性，它是在不改变代码的情况下实现更大规模的另一种工具。</p><h2 id="8318" class="ls lt it bd lu lv lw dn lx ly lz dp ma le mb mc md li me mf mg lm mh mi mj mk bi translated"><strong class="ak"> API网关缓存</strong></h2><p id="112e" class="pw-post-body-paragraph kv kw it kx b ky ml ju la lb mm jx ld le mn lg lh li mo lk ll lm mp lo lp lq im bi translated">我们当前的方法让用户提供他们的纬度和经度坐标，而我们的Lambda函数计算geohash (z-index)并完成查找。这对我们的用户来说很好，因为他们不需要知道任何关于geohashing的知识就可以发送请求，但这对缓存来说是不好的。为什么？</p><p id="b080" class="pw-post-body-paragraph kv kw it kx b ky kz ju la lb lc jx ld le lf lg lh li lj lk ll lm ln lo lp lq im bi translated">除非两个用户坐在彼此之上，否则他们的坐标会略有不同，即使他们的位置计算的是相同的geohash。目前，我们无法在API级别利用请求缓存。</p><p id="6ba7" class="pw-post-body-paragraph kv kw it kx b ky kz ju la lb lc jx ld le lf lg lh li lj lk ll lm ln lo lp lq im bi translated">然而，如果我们将哈希计算从Lambda中取出，放入客户端库，一个用户的请求从<strong class="kx iu">POST</strong><em class="nm">/Starbucks body = { lat:45.345，lon:45.123} </em>到<strong class="kx iu"> GET </strong> <em class="nm"> /starbucks？geohash=876543 </em>。有什么区别？</p><p id="d53c" class="pw-post-body-paragraph kv kw it kx b ky kz ju la lb lc jx ld le lf lg lh li lj lk ll lm ln lo lp lq im bi translated">来自许多不同坐标的用户将“折叠”或“存储”到单个geohash索引中，我们可以在缓存中重用他们的请求，以减少我们数据库的负载。比如假设(45.345，45.123) geohashes到<em class="nm"> 876543，</em>很有可能(45。<strong class="kx iu"> 1 </strong> 45、45。<strong class="kx iu"> 3 </strong> 23)也对同一个桶进行了地理哈希，因此他们的新请求都将查询同一个桶，我们可以重用第一个请求的响应来满足第二个请求。</p><p id="2c93" class="pw-post-body-paragraph kv kw it kx b ky kz ju la lb lc jx ld le lf lg lh li lj lk ll lm ln lo lp lq im bi translated">因为星巴克的创建是一个相对缓慢的过程，所以我们可以在缓存上设置一个较高的生存时间(TTL ),以便请求被记住几天。默认情况下，当启用缓存时，API Gateway会在所有GET请求上创建一个缓存，API的所有者可以进一步指定使用哪些querystring参数来确定哪些请求在缓存中“命中”或“未命中”。</p><h2 id="0e0d" class="ls lt it bd lu lv lw dn lx ly lz dp ma le mb mc md li me mf mg lm mh mi mj mk bi translated"><strong class="ak">有没有更好的(无服务器)方式？</strong></h2><p id="a925" class="pw-post-body-paragraph kv kw it kx b ky ml ju la lb mm jx ld le mn lg lh li mo lk ll lm mp lo lp lq im bi translated">Richard在这个问题上有一个有趣的观点:“既然我们已经将Lambda函数的大部分逻辑提取出来，并将其推送到我们应用程序的客户端，我们的Lambda函数就只是一个冰冷的死壳。我们现在能做的最恭敬的事，就是感谢它曾经提供的欢乐(和咖啡因)，深深拥抱它，及时删除！”</p><p id="9a22" class="pw-post-body-paragraph kv kw it kx b ky kz ju la lb lc jx ld le lf lg lh li lj lk ll lm ln lo lp lq im bi translated">这是一个有趣的想法，因为它触及了所有这些决策中权衡的核心。通过在我们的API网关资源上集成AWS服务，我们可以直接将API网关连接到我们的Dynamo表来查询geohashes，而不会增加管理Lambda函数的复杂性。</p><p id="2e73" class="pw-post-body-paragraph kv kw it kx b ky kz ju la lb lc jx ld le lf lg lh li lj lk ll lm ln lo lp lq im bi translated">这种方法的主要缺点是，我们的Lambda函数可能会对位置表进行多次查询调用，并将响应聚合成一个响应。随着服务集成，我们将失去这种能力。理查德总结道，“我认为，如果你获得了附近星巴克超过1Mb的位置数据，第2mb就像谷歌搜索的第二页——它在那里，但如果你现在还没有决定点击哪个链接，第二页就没有你要找的答案。”</p><p id="982a" class="pw-post-body-paragraph kv kw it kx b ky kz ju la lb lc jx ld le lf lg lh li lj lk ll lm ln lo lp lq im bi translated">Richard的想法通过完全消除Lambda极大地降低了成本，但也通过在API Gateway和DynamoDB之间创建一条直线来改善延迟和规模。它可能不适合所有用例，但显示了一些创造性思维如何为这个问题提供其他无服务器解决方案。</p><p id="d9f5" class="pw-post-body-paragraph kv kw it kx b ky kz ju la lb lc jx ld le lf lg lh li lj lk ll lm ln lo lp lq im bi translated"><em class="nm">想了解更多信息？在</em> <a class="ae lr" href="https://rboyd.dev" rel="noopener ugc nofollow" target="_blank"> <em class="nm">查看理查德的云博客https://rboyd.dev </em> </a> <em class="nm">。</em></p></div></div>    
</body>
</html>