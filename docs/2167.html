<html>
<head>
<title>RxJS Bugs Always Have Solutions</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">RxJS Bugs总有解决办法</h1>
<blockquote>原文：<a href="https://itnext.io/fixing-ben-leshs-rxjs-bug-339d2aaafdb6?source=collection_archive---------3-----------------------#2019-04-10">https://itnext.io/fixing-ben-leshs-rxjs-bug-339d2aaafdb6?source=collection_archive---------3-----------------------#2019-04-10</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><figure class="ip iq gp gr ir is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi io"><img src="../Images/2128c1f6745de009baee7cbc0c84add7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*1_Hx7rOFB7R2syDKwEn1Hg.png"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">StackBlitz上<a class="ae jd" href="https://twitter.com/BenLesh" rel="noopener ugc nofollow" target="_blank"> Ben Lesh的</a> <a class="ae jd" href="https://stackblitz.com/edit/rxjs-undo-operator-original-bug" rel="noopener ugc nofollow" target="_blank">原代码</a>截图。</figcaption></figure><div class=""/><div class=""><h2 id="3ff9" class="pw-subtitle-paragraph kd jf jg bd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku dk translated">即使是我们中最优秀的人也会写bug。这家伙是故意的。</h2></div><p id="e223" class="pw-post-body-paragraph kv kw jg kx b ky kz kh la lb lc kk ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated"><em class="lr">我将指出</em><strong class="kx jh"><em class="lr">Ben Lesh</em></strong><em class="lr">的代码中的一个错误，这个错误最终只是语义上的(下面会有更多相关内容)。</em></p><h1 id="5ccf" class="ls lt jg bd lu lv lw lx ly lz ma mb mc km md kn me kp mf kq mg ks mh kt mi mj bi translated">本的原始推文</h1><p id="13fc" class="pw-post-body-paragraph kv kw jg kx b ky mk kh la lb ml kk ld le mm lg lh li mn lk ll lm mo lo lp lq ij bi translated">本·莱什在推特上发布了一些他将在ngconf上做的演讲的代码:</p><figure class="mp mq mr ms gt is"><div class="bz fp l di"><div class="mt mu l"/></div></figure><p id="9104" class="pw-post-body-paragraph kv kw jg kx b ky kz kh la lb lc kk ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">他编写这段代码是为了提供一个简单的例子，在这个例子中，您可以用很少的代码在DOM中添加数字、撤销和重做:</p><figure class="mp mq mr ms gt is"><div class="bz fp l di"><div class="mv mu l"/></div></figure><p id="bcbc" class="pw-post-body-paragraph kv kw jg kx b ky kz kh la lb lc kk ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">我们的目标是解释RxJS，并展示如何只用几个操作符就能做这么多。这也是为什么他没有选择使用Angular或React来呈现DOM元素。这将大大增加膨胀。</p><h1 id="ec55" class="ls lt jg bd lu lv lw lx ly lz ma mb mc km md kn me kp mf kq mg ks mh kt mi mj bi translated">可怕的虫子</h1><p id="2078" class="pw-post-body-paragraph kv kw jg kx b ky mk kh la lb ml kk ld le mm lg lh li mn lk ll lm mo lo lp lq ij bi translated">窃听器在哪里？按“+1”几次，你得到<code class="fe mw mx my mz b">2</code>。然后按“撤销”。您应该会看到您所期望的<code class="fe mw mx my mz b">1</code>，但是如果您再次按“+1”，它将显示<code class="fe mw mx my mz b">3</code>而不是<code class="fe mw mx my mz b">2</code>。</p><p id="8d1c" class="pw-post-body-paragraph kv kw jg kx b ky kz kh la lb lc kk ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">查看代码后，我发现了问题。他提供给<code class="fe mw mx my mz b">scan</code>的reducer继续累加值，而不考虑撤销和重做动作:</p><figure class="mp mq mr ms gt is"><div class="bz fp l di"><div class="na mu l"/></div></figure><p id="caad" class="pw-post-body-paragraph kv kw jg kx b ky kz kh la lb lc kk ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">我有几种方法可以解决这个问题，但我想保持简单。</p><p id="afe2" class="pw-post-body-paragraph kv kw jg kx b ky kz kh la lb lc kk ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">我们也把这个当成专业项目吧。我们是本的编辑。我们在他的代码中发现了一个bug，我们得到报酬，以一种符合他最初要求的方式修复它。</p><p id="c146" class="pw-post-body-paragraph kv kw jg kx b ky kz kh la lb lc kk ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">从他的推文中，我们的要求是要有一个“非常非常简单的撤销操作符”，只用<code class="fe mw mx my mz b">merge</code>、<code class="fe mw mx my mz b">scan</code>、<code class="fe mw mx my mz b">filter</code>和<code class="fe mw mx my mz b">map</code>。</p><h1 id="0d46" class="ls lt jg bd lu lv lw lx ly lz ma mb mc km md kn me kp mf kq mg ks mh kt mi mj bi translated">修复Bug</h1><p id="fee8" class="pw-post-body-paragraph kv kw jg kx b ky mk kh la lb ml kk ld le mm lg lh li mn lk ll lm mo lo lp lq ij bi translated">这是我第一次尝试解决问题:</p><figure class="mp mq mr ms gt is"><div class="bz fp l di"><div class="mv mu l"/></div></figure><p id="8a56" class="pw-post-body-paragraph kv kw jg kx b ky kz kh la lb lc kk ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">虽然这确实解决了问题，但我的解决方案对他的演讲来说还是太激烈了:</p><figure class="mp mq mr ms gt is"><div class="bz fp l di"><div class="na mu l"/></div></figure><p id="b7a6" class="pw-post-body-paragraph kv kw jg kx b ky kz kh la lb lc kk ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">请记住，我们应该保持“非常非常简单”的指导方针，只有4个操作符。现在我们有两个<code class="fe mw mx my mz b">startWith</code>操作符和一个添加的<code class="fe mw mx my mz b">switchMap</code>。</p><p id="9ac9" class="pw-post-body-paragraph kv kw jg kx b ky kz kh la lb lc kk ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">你不需要解释<code class="fe mw mx my mz b">startWith</code>，除非你有两个。现在必须解释运算符的顺序，而在此之前，他可以不解释。</p><p id="51a6" class="pw-post-body-paragraph kv kw jg kx b ky kz kh la lb lc kk ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">最重要的是，我将渲染模式分解成一个名为<code class="fe mw mx my mz b">render$</code>的<code class="fe mw mx my mz b">Subject</code>。现在我已经在混合中引入了主题。不是每个人都已经知道可观测量是如何工作的，现在他必须解释什么是可观测量，它与观察者有什么不同，以及它们的组合是怎样的一个<code class="fe mw mx my mz b">Subject</code>。</p><p id="1801" class="pw-post-body-paragraph kv kw jg kx b ky kz kh la lb lc kk ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">我们现在要干嘛？</p><h1 id="fa8b" class="ls lt jg bd lu lv lw lx ly lz ma mb mc km md kn me kp mf kq mg ks mh kt mi mj bi translated">又一次尝试</h1><p id="ab8e" class="pw-post-body-paragraph kv kw jg kx b ky mk kh la lb ml kk ld le mm lg lh li mn lk ll lm mo lo lp lq ij bi translated">请记住，我们在这里得到假装的报酬，所以我们需要专业一点。</p><p id="f605" class="pw-post-body-paragraph kv kw jg kx b ky kz kh la lb lc kk ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">与其让我们的操作符变得复杂，不如让我们检查一下是否可以简单地改进<code class="fe mw mx my mz b">undo</code>操作符:</p><figure class="mp mq mr ms gt is"><div class="bz fp l di"><div class="na mu l"/></div></figure><p id="7fb0" class="pw-post-body-paragraph kv kw jg kx b ky kz kh la lb lc kk ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">对我来说，这看起来不像是一个“非常非常简单的撤销操作”，但是考虑到它所做的事情，这已经是最简单的了。这意味着我们可能会增加一个“非常”。</p><p id="a4be" class="pw-post-body-paragraph kv kw jg kx b ky kz kh la lb lc kk ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">它是用TypeScript编写的，它返回一个结合了撤销、重做和<code class="fe mw mx my mz b">source</code>可观察值的可观察值。<code class="fe mw mx my mz b">source</code>是包含运行小车后输出值的可观测值:<code class="fe mw mx my mz b">source$</code>。</p><p id="00c6" class="pw-post-body-paragraph kv kw jg kx b ky kz kh la lb lc kk ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">还要注意，这个操作符返回一个带有<code class="fe mw mx my mz b">scan</code>的可观察的。哇，扫描异常！这意味着这个<code class="fe mw mx my mz b">undo</code>操作器也作为一个减速器。正因为如此，它包含了状态，我们可以用这个状态来耍一些花招。</p><p id="ccbe" class="pw-post-body-paragraph kv kw jg kx b ky kz kh la lb lc kk ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">我们可以这样做的唯一原因是，来自前面的<code class="fe mw mx my mz b">scan</code>的错误输出值将进入这个<code class="fe mw mx my mz b">scan</code>。从这里开始，我们可以绕过它。</p><p id="17b0" class="pw-post-body-paragraph kv kw jg kx b ky kz kh la lb lc kk ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">我宁愿不使用这种方法，但是因为我们有一些严格的要求，而且因为我已经开始写这篇文章，所以值得一试。</p><p id="912b" class="pw-post-body-paragraph kv kw jg kx b ky kz kh la lb lc kk ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">在<code class="fe mw mx my mz b">undo</code>的<code class="fe mw mx my mz b">scan</code>操作符中，<code class="fe mw mx my mz b">state</code>是来自<code class="fe mw mx my mz b">source$</code>的所有值的数组。</p><p id="db82" class="pw-post-body-paragraph kv kw jg kx b ky kz kh la lb lc kk ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">每当一个新的值进来时，我们可以将差值存储在这个缩减器中，并每次减去它。</p><figure class="mp mq mr ms gt is"><div class="bz fp l di"><div class="mv mu l"/></div></figure><p id="6bc1" class="pw-post-body-paragraph kv kw jg kx b ky kz kh la lb lc kk ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">哈基。但是很管用！这很容易改变。</p><p id="210a" class="pw-post-body-paragraph kv kw jg kx b ky kz kh la lb lc kk ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">下面是<code class="fe mw mx my mz b">undo</code>的新代码:</p><figure class="mp mq mr ms gt is"><div class="bz fp l di"><div class="na mu l"/></div></figure><p id="240f" class="pw-post-body-paragraph kv kw jg kx b ky kz kh la lb lc kk ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">我们给减速器加了一个<code class="fe mw mx my mz b">subtractor</code>。</p><p id="36b5" class="pw-post-body-paragraph kv kw jg kx b ky kz kh la lb lc kk ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">当推到状态时，我们现在正在做<code class="fe mw mx my mz b">x - subtractor</code>。每当我们输入一个新值，我们总是会从之前的<code class="fe mw mx my mz b">scan</code>中减去不正确的数量。</p><p id="7258" class="pw-post-body-paragraph kv kw jg kx b ky kz kh la lb lc kk ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">每当撤销发生时，我们将未撤销值和新值的差添加到我们的<code class="fe mw mx my mz b">subtractor</code>中。</p><p id="0345" class="pw-post-body-paragraph kv kw jg kx b ky kz kh la lb lc kk ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">当重做发生时，我们仍然从当前值中减去未删除的值，但是然后我们从<code class="fe mw mx my mz b">subtractor</code>中删除该差值。</p><p id="14c1" class="pw-post-body-paragraph kv kw jg kx b ky kz kh la lb lc kk ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">虽然这确实显示了一些TypeScript错误，但是代码可以编译。它修复了错误，符合我们的要求。</p><h2 id="4b88" class="nb lt jg bd lu nc nd dn ly ne nf dp mc le ng nh me li ni nj mg lm nk nl mi nm bi translated">问题</h2><p id="f825" class="pw-post-body-paragraph kv kw jg kx b ky mk kh la lb ml kk ld le mm lg lh li mn lk ll lm mo lo lp lq ij bi translated">这种解决方案的缺点是它很粗糙。它还将我们的<code class="fe mw mx my mz b">undo</code>操作符与代码另一部分中的一个bug联系起来。这意味着我们的<code class="fe mw mx my mz b">undo</code>操作符只能在这个特定的系统中使用。</p><p id="36fa" class="pw-post-body-paragraph kv kw jg kx b ky kz kh la lb lc kk ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">这就是保持事情简单的问题。有时，您需要添加一些操作符来使RxJS更加强大和易于使用。</p><p id="48e4" class="pw-post-body-paragraph kv kw jg kx b ky kz kh la lb lc kk ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">我永远不会推荐任何人使用第二个补丁，因为它会让你的代码变得过于挑剔。即使它解决了这个问题，也会产生许多其他问题。</p><h1 id="1a4b" class="ls lt jg bd lu lv lw lx ly lz ma mb mc km md kn me kp mf kq mg ks mh kt mi mj bi translated">对本来说什么最重要？</h1><p id="46b0" class="pw-post-body-paragraph kv kw jg kx b ky mk kh la lb ml kk ld le mm lg lh li mn lk ll lm mo lo lp lq ij bi translated">对于演讲来说，什么更重要？只使用4个操作符，拥有一个“非常非常简单的撤销操作符”，还是拥有无bug代码？</p><p id="eee4" class="pw-post-body-paragraph kv kw jg kx b ky kz kh la lb lc kk ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">这是需要考虑的最重要的事情。</p><p id="8ce3" class="pw-post-body-paragraph kv kw jg kx b ky kz kh la lb lc kk ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">很有可能这不是一个错误。我猜本希望这样来保持代码简单。我们认为这是一个错误，因为我们对“撤销”和“重做”的工作方式有所期待。他知道这段代码将会出现在一次谈话中，所以他不会在点击<code class="fe mw mx my mz b">undo</code>后再次点击“添加”。简单。</p><p id="145f" class="pw-post-body-paragraph kv kw jg kx b ky kz kh la lb lc kk ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">这才是最重要的。找出对企业来说什么是重要的；而不是你认为对代码或你自己的议程最好的。不要做一个福音传道者，当他的代码不符合他的需求时，替他修改代码，除非你想像我一样找点乐子。:D</p><h1 id="5f7d" class="ls lt jg bd lu lv lw lx ly lz ma mb mc km md kn me kp mf kq mg ks mh kt mi mj bi translated">redux-可观察的FTW！</h1><p id="bd60" class="pw-post-body-paragraph kv kw jg kx b ky mk kh la lb ml kk ld le mm lg lh li mn lk ll lm mo lo lp lq ij bi translated">因为我认为Redux-Observable风格是干净代码的未来，所以我用那种风格完全重写了他的整个例子。这意味着没有他的原始代码，没有类型脚本，垂直编码风格，没有错误！</p><figure class="mp mq mr ms gt is"><div class="bz fp l di"><div class="na mu l"/></div></figure><p id="4f32" class="pw-post-body-paragraph kv kw jg kx b ky kz kh la lb lc kk ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">每个可观察值都在一个称为epic的函数中，该函数提供了一个<code class="fe mw mx my mz b">action$</code>可观察值。我们不必直接听其他可观测的，我们只需要听<code class="fe mw mx my mz b">action$</code>。</p><p id="52d7" class="pw-post-body-paragraph kv kw jg kx b ky kz kh la lb lc kk ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">当<code class="fe mw mx my mz b">action$</code>更新时，我们所有的可观察对象都被激活，我们使用<code class="fe mw mx my mz b">ofType</code>来确定这个动作是否是我们想要处理的。如果有，就把它推进管道。</p><p id="71e3" class="pw-post-body-paragraph kv kw jg kx b ky kz kh la lb lc kk ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">我没有将减速器放入其他减速器中，而是制作了一个减速器(本可以制作成两个)，这使得<em class="lr">大大降低了旧<code class="fe mw mx my mz b">undo</code>功能的复杂性。类似于我在原始代码中的第一个bug修复，我专门用一个单独的observable向DOM呈现新的输出值。</em></p><p id="1acf" class="pw-post-body-paragraph kv kw jg kx b ky kz kh la lb lc kk ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">你可以在这里摆弄它:</p><figure class="mp mq mr ms gt is"><div class="bz fp l di"><div class="mv mu l"/></div></figure><p id="0353" class="pw-post-body-paragraph kv kw jg kx b ky kz kh la lb lc kk ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">我的版本看起来和Ben写的很不一样，但是我没有改变观点，只是改变了背后的商业逻辑。我相信你们中的很多人以前都不得不像这样重构代码。</p><p id="84d2" class="pw-post-body-paragraph kv kw jg kx b ky kz kh la lb lc kk ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">在我的很多项目中，我使用Redux，根本不使用组件状态。正因为如此，我可以花时间在缩减器和史诗上，而不去管视图。这也意味着我可以将视图与核心业务逻辑完全分离。</p><p id="d951" class="pw-post-body-paragraph kv kw jg kx b ky kz kh la lb lc kk ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">我为什么要这么做？因为我可以编写相同的Redux逻辑，并在同一个应用程序中同时在AngularJS或React中使用它。这并不适合所有人，但在我的前两个团队中，这对我们很有效。</p><h1 id="82af" class="ls lt jg bd lu lv lw lx ly lz ma mb mc km md kn me kp mf kq mg ks mh kt mi mj bi translated">结论</h1><p id="5e6a" class="pw-post-body-paragraph kv kw jg kx b ky mk kh la lb ml kk ld le mm lg lh li mn lk ll lm mo lo lp lq ij bi translated">最重要的是业务需求。虽然你可能有一些你认为事情应该如何运作的固有知识，但销售你产品的人是第一位的。</p><p id="a286" class="pw-post-body-paragraph kv kw jg kx b ky kz kh la lb lc kk ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">在这种情况下，本·莱什在一次演讲中销售这种产品(<strong class="kx jh">编辑</strong>:不是这个特定的运营商，只是一般的运营商)。我在写一篇关于如何修复别人RxJS代码中的bug的文章。他的要求和我的完全不同。</p><p id="5a84" class="pw-post-body-paragraph kv kw jg kx b ky kz kh la lb lc kk ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">正因为如此，我相信本不会去修改代码。我敢打赌，他不会修复这个bug，因为正如我前面所说，这可能不是他的bug。</p><h2 id="6591" class="nb lt jg bd lu nc nd dn ly ne nf dp mc le ng nh me li ni nj mg lm nk nl mi nm bi translated">编辑</h2><p id="6e5a" class="pw-post-body-paragraph kv kw jg kx b ky mk kh la lb ml kk ld le mm lg lh li mn lk ll lm mo lo lp lq ij bi translated">Ben Lesh提供了关于<code class="fe mw mx my mz b">undo</code>操作员的说明:</p><figure class="mp mq mr ms gt is"><div class="bz fp l di"><div class="mt mu l"/></div></figure><figure class="mp mq mr ms gt is"><div class="bz fp l di"><div class="mt mu l"/></div></figure><figure class="mp mq mr ms gt is"><div class="bz fp l di"><div class="mt mu l"/></div></figure><p id="93e6" class="pw-post-body-paragraph kv kw jg kx b ky kz kh la lb lc kk ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">他真的打算称它为<code class="fe mw mx my mz b">showPreviousValues</code>而不是<code class="fe mw mx my mz b">undo</code>。这就是我说的。</p><h1 id="4494" class="ls lt jg bd lu lv lw lx ly lz ma mb mc km md kn me kp mf kq mg ks mh kt mi mj bi translated">更多阅读</h1><p id="5084" class="pw-post-body-paragraph kv kw jg kx b ky mk kh la lb ml kk ld le mm lg lh li mn lk ll lm mo lo lp lq ij bi translated">如果你喜欢你所读的，请查看我关于类似的令人大开眼界的主题的其他文章:</p><ul class=""><li id="882b" class="nn no jg kx b ky kz lb lc le np li nq lm nr lq ns nt nu nv bi translated"><a class="ae jd" href="https://medium.com/@Sawtaytoes/redux-observable-can-solve-your-state-problems-15b23a9649d7" rel="noopener"> Redux-Observable可以解决你的状态问题</a></li><li id="8d9c" class="nn no jg kx b ky nw lb nx le ny li nz lm oa lq ns nt nu nv bi translated"><a class="ae jd" rel="noopener ugc nofollow" target="_blank" href="/redux-observable-without-redux-ff4a2b5a4b39">Redux-可观察无Redux </a></li><li id="a07c" class="nn no jg kx b ky nw lb nx le ny li nz lm oa lq ns nt nu nv bi translated"><a class="ae jd" href="https://medium.freecodecamp.org/csp-vs-rxjs-what-you-dont-know-1542cd5dd100" rel="noopener ugc nofollow" target="_blank"> CSP vs RxJS:你不知道的。</a></li><li id="09e5" class="nn no jg kx b ky nw lb nx le ny li nz lm oa lq ns nt nu nv bi translated"><a class="ae jd" rel="noopener ugc nofollow" target="_blank" href="/the-definitive-guide-to-callbacks-in-javascript-44a39c065292">回访:权威指南</a></li><li id="9398" class="nn no jg kx b ky nw lb nx le ny li nz lm oa lq ns nt nu nv bi translated"><a class="ae jd" rel="noopener ugc nofollow" target="_blank" href="/promises-the-definitive-guide-6a49e0dbf3b7">承诺:权威指南</a></li></ul></div></div>    
</body>
</html>