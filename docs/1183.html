<html>
<head>
<title>Using async routes with Express</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在Express中使用异步路由</h1>
<blockquote>原文：<a href="https://itnext.io/using-async-routes-with-express-bcde8ead1de8?source=collection_archive---------1-----------------------#2018-08-07">https://itnext.io/using-async-routes-with-express-bcde8ead1de8?source=collection_archive---------1-----------------------#2018-08-07</a></blockquote><div><div class="fc if ig ih ii ij"/><div class="ik il im in io"><figure class="iq ir gq gs is it gi gj paragraph-image"><div role="button" tabindex="0" class="iu iv di iw bf ix"><div class="gi gj ip"><img src="../Images/49169b6cd83215432daa13ec7b143ca4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*A5f8SkVuvCyipjVu61Gb7w.jpeg"/></div></div><figcaption class="ja jb gk gi gj jc jd bd b be z dk translated">现在我该去哪里？(作者照片，摄于瑞士曼尼利切附近)</figcaption></figure><div class=""/><p id="8c07" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ik bi translated">一段时间以来，<code class="fe lb lc ld le b">NodeJS</code>已经支持了<code class="fe lb lc ld le b">async</code> / <code class="fe lb lc ld le b">await</code>语法，允许你避免<code class="fe lb lc ld le b">Promises</code>和<code class="fe lb lc ld le b">Generators</code>的许多问题。然而，开箱即用的<code class="fe lb lc ld le b"><a class="ae lf" href="https://expressjs.com" rel="noopener ugc nofollow" target="_blank">Express</a></code>并不能很好地处理异步路由控制器。错误处理尤其成问题。然而，通过一些简单的函数组合，实际上很容易解决这个问题。</p><h1 id="0118" class="lg lh jg bd li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md bi translated">一个例子</h1><p id="9901" class="pw-post-body-paragraph kd ke jg kf b kg me ki kj kk mf km kn ko mg kq kr ks mh ku kv kw mi ky kz la ik bi translated">假设您有一个需要调用和<code class="fe lb lc ld le b">await</code>一个名为<code class="fe lb lc ld le b">someAsync</code>的外部异步助手函数的路由。它获取该函数的结果，并通过<code class="fe lb lc ld le b">res.json</code>返回，如下所示:</p><pre class="mj mk ml mm gu mn le mo mp aw mq bi"><span id="1442" class="mr lh jg le b gz ms mt l mu mv">const someAsync = require('./helpers/someAsync')</span><span id="a5ba" class="mr lh jg le b gz mw mt l mu mv">module.exports = async (req, res) =&gt; {<br/>  const result = await someAsync(req.body)<br/>  res.json(result)<br/>}</span></pre><p id="deec" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ik bi translated">这将作为一个<code class="fe lb lc ld le b">Express</code>路由控制器工作得很好，但是如果在<code class="fe lb lc ld le b">someAsync</code>中有什么东西失败了，你永远也不会知道，因为没有什么可以捕捉错误。当然，你可以在你的路由控制器中添加<code class="fe lb lc ld le b">try</code> / <code class="fe lb lc ld le b">catch</code>块，但是这很快就会变得冗长和烦人。</p><p id="9b2c" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ik bi translated">一个简单的解决方案是使用函数组合来包装异步路由:</p><pre class="mj mk ml mm gu mn le mo mp aw mq bi"><span id="4b24" class="mr lh jg le b gz ms mt l mu mv">const asyncRoute = route =&gt; (req, res, next = console.error) =&gt;<br/>  Promise.resolve(route(req, res)).catch(next)</span></pre><p id="6f1d" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ik bi translated">然后，您可以按如下方式使用它:</p><pre class="mj mk ml mm gu mn le mo mp aw mq bi"><span id="cbf3" class="mr lh jg le b gz ms mt l mu mv">const someAsync = require('./helpers/someAsync')</span><span id="16f8" class="mr lh jg le b gz mw mt l mu mv">const myRoute = async (req, res) =&gt; {<br/>  const result = await someAsync(req.body)<br/>  res.json(result)<br/>}</span><span id="d357" class="mr lh jg le b gz mw mt l mu mv">module.exports = <strong class="le jh">asyncRoute</strong>(myRoute)</span></pre><p id="550a" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ik bi translated">所以现在，如果有错误，包装器将<code class="fe lb lc ld le b">catch</code>它并将错误传递给<code class="fe lb lc ld le b">next</code>函数。默认情况下，该函数只是<code class="fe lb lc ld le b">console.error</code>，但是您可以使用自己的自定义错误处理程序来覆盖它。</p><h1 id="66d1" class="lg lh jg bd li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md bi translated">测试您的异步路由</h1><p id="d7a9" class="pw-post-body-paragraph kd ke jg kf b kg me ki kj kk mf km kn ko mg kq kr ks mh ku kv kw mi ky kz la ik bi translated">使用<code class="fe lb lc ld le b"><a class="ae lf" href="https://sinonjs.org" rel="noopener ugc nofollow" target="_blank">sinon</a></code>和<code class="fe lb lc ld le b"><a class="ae lf" href="https://github.com/thlorenz/proxyquire" rel="noopener ugc nofollow" target="_blank">proxyquire</a></code>可以如下测试路线:</p><pre class="mj mk ml mm gu mn le mo mp aw mq bi"><span id="267b" class="mr lh jg le b gz ms mt l mu mv">const { expect } = require('chai')<br/>const sinon = require('sinon')<br/>const proxyquire = require('proxyquire')</span><span id="7f4a" class="mr lh jg le b gz mw mt l mu mv">describe('src/routes/myRoute', () =&gt; {<br/>  const mockSomeAsync = sinon.stub()</span><span id="a90e" class="mr lh jg le b gz mw mt l mu mv">  const myRoute = proxyquire('../../src/routes/myRoute', {<br/>    './helpers/someAsync': mockSomeAsync<br/>  }</span><span id="4c7c" class="mr lh jg le b gz mw mt l mu mv">  const req = { body: 'some body' }<br/>  const res = { json: sinon.stub() }<br/>  const next = sinon.spy()</span><span id="0609" class="mr lh jg le b gz mw mt l mu mv">  const resetStubs = () =&gt; {<br/>    res.json.resetHistory()<br/>    next.resetHistory()<br/>  }</span><span id="c706" class="mr lh jg le b gz mw mt l mu mv">  context('no errors', () =&gt; {<br/>    const result = 'some result'</span><span id="f477" class="mr lh jg le b gz mw mt l mu mv">    before(async () =&gt; {<br/>      mockSomeAsync.resolves(result)<br/>      await myRoute(req, res, next)<br/>    })</span><span id="5b08" class="mr lh jg le b gz mw mt l mu mv">    after(resetStubs)</span><span id="3ffe" class="mr lh jg le b gz mw mt l mu mv">    it('called someAsync with the right data', () =&gt; {<br/>      expect(mockSomeAsync).to.have.been.calledWith(req.body)<br/>    })</span><span id="8ed4" class="mr lh jg le b gz mw mt l mu mv">    it('called res.json with the right data', () =&gt; {<br/>      expect(res.json).to.have.been.calledWith(result)<br/>    })</span><span id="25d9" class="mr lh jg le b gz mw mt l mu mv">    it("didn't call next", () =&gt; {<br/>      expect(next).not.to.have.been.called<br/>    })<br/>  })</span><span id="daea" class="mr lh jg le b gz mw mt l mu mv">  context('has errors', () =&gt; {<br/>    const error = 'some error'</span><span id="b77c" class="mr lh jg le b gz mw mt l mu mv">    before(async () =&gt; {<br/>      mockSomeAsync.rejects(error)<br/>      await myRoute(req, res, next)<br/>    })</span><span id="38f0" class="mr lh jg le b gz mw mt l mu mv">    after(resetStubs)</span><span id="e270" class="mr lh jg le b gz mw mt l mu mv">    it('called someAsync with the right data', () =&gt; {<br/>      expect(mockSomeAsync).to.have.been.calledWith(req.body)<br/>    })</span><span id="8dac" class="mr lh jg le b gz mw mt l mu mv">    it("didn't call res.json", () =&gt; {<br/>      expect(res.json).not.to.have.been.called<br/>    })</span><span id="a61d" class="mr lh jg le b gz mw mt l mu mv">    it('called next with the error', () =&gt; {<br/>      expect(next).to.have.been.calledWith(error)<br/>    })<br/>  })<br/>})</span></pre><h1 id="6dba" class="lg lh jg bd li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md bi translated">密码</h1><p id="c03d" class="pw-post-body-paragraph kd ke jg kf b kg me ki kj kk mf km kn ko mg kq kr ks mh ku kv kw mi ky kz la ik bi translated">我已经将这些代码打包到一个npm库中。要在您的代码中使用它，只需运行:</p><pre class="mj mk ml mm gu mn le mo mp aw mq bi"><span id="9f94" class="mr lh jg le b gz ms mt l mu mv">npm i route-async</span></pre><p id="1c5f" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ik bi translated">然后在您的代码中:</p><pre class="mj mk ml mm gu mn le mo mp aw mq bi"><span id="9d52" class="mr lh jg le b gz ms mt l mu mv">const asyncRoute = require('route-async')</span><span id="5104" class="mr lh jg le b gz mw mt l mu mv">const yourRouteHere = async (req, res) =&gt; {<br/>  // ...<br/>}<br/>module.exports = asyncRoute(yourRouteHere)</span></pre><h1 id="39a8" class="lg lh jg bd li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md bi translated">链接</h1><ul class=""><li id="ab9e" class="mx my jg kf b kg me kk mf ko mz ks na kw nb la nc nd ne nf bi translated"><code class="fe lb lc ld le b"><a class="ae lf" href="https://www.npmjs.com/package/route-async" rel="noopener ugc nofollow" target="_blank">route-async</a></code> <a class="ae lf" href="https://www.npmjs.com/package/route-async" rel="noopener ugc nofollow" target="_blank">上npm </a></li><li id="77f1" class="mx my jg kf b kg ng kk nh ko ni ks nj kw nk la nc nd ne nf bi translated"><code class="fe lb lc ld le b"><a class="ae lf" href="https://github.com/davesag/route-async" rel="noopener ugc nofollow" target="_blank">route-async</a></code> <a class="ae lf" href="https://github.com/davesag/route-async" rel="noopener ugc nofollow" target="_blank">来源于GitHub </a></li><li id="e298" class="mx my jg kf b kg ng kk nh ko ni ks nj kw nk la nc nd ne nf bi translated"><a class="ae lf" href="https://expressjs.com" rel="noopener ugc nofollow" target="_blank"> expressjs </a></li><li id="cdd2" class="mx my jg kf b kg ng kk nh ko ni ks nj kw nk la nc nd ne nf bi translated"><a class="ae lf" href="https://mochajs.org" rel="noopener ugc nofollow" target="_blank">摩卡酒</a></li><li id="2866" class="mx my jg kf b kg ng kk nh ko ni ks nj kw nk la nc nd ne nf bi translated"><a class="ae lf" href="http://www.chaijs.com" rel="noopener ugc nofollow" target="_blank">柴吉斯</a></li><li id="f9d4" class="mx my jg kf b kg ng kk nh ko ni ks nj kw nk la nc nd ne nf bi translated">sinonjs </li><li id="f605" class="mx my jg kf b kg ng kk nh ko ni ks nj kw nk la nc nd ne nf bi translated"><a class="ae lf" href="https://github.com/thlorenz/proxyquire" rel="noopener ugc nofollow" target="_blank">代理查询</a></li></ul><p id="9f17" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ik bi">—</p><p id="f5f2" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ik bi translated">像这样但不是订户？你可以通过<a class="ae lf" href="https://davesag.medium.com/membership" rel="noopener">davesag.medium.com</a>加入来支持作者。</p></div></div>    
</body>
</html>