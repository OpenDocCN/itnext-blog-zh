<html>
<head>
<title>Universal OPA Policies Development</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">通用OPA政策开发</h1>
<blockquote>原文：<a href="https://itnext.io/universal-opa-policies-development-a3f88226e3d5?source=collection_archive---------1-----------------------#2021-03-01">https://itnext.io/universal-opa-policies-development-a3f88226e3d5?source=collection_archive---------1-----------------------#2021-03-01</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><h1 id="44d4" class="jn jo iq bd jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk bi translated">介绍</h1><p id="3a60" class="pw-post-body-paragraph kl km iq kn b ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">编写<a class="ae lj" href="https://www.openpolicyagent.org/docs/latest/#rego" rel="noopener ugc nofollow" target="_blank"> <strong class="kn ir">【减压阀】</strong> </a>文件以及如何解开与<a class="ae lj" href="https://github.com/open-policy-agent/gatekeeper" rel="noopener ugc nofollow" target="_blank"> <strong class="kn ir">看门人</strong></a>vs<a class="ae lj" href="https://github.com/open-policy-agent/conftest" rel="noopener ugc nofollow" target="_blank"><strong class="kn ir">Conftest</strong></a>验证Kubernetes资源的繁琐过程背后的故事。</p><p id="9c3d" class="pw-post-body-paragraph kl km iq kn b ko lk kq kr ks ll ku kv kw lm ky kz la ln lc ld le lo lg lh li ij bi translated">如今，使用符合策略的Kubernetes集群已经成为许多公司关注的焦点，尤其是如果你正在走向流行的认证，如信息安全管理的<strong class="kn ir"> ISO/IEC 27001 </strong>。</p><h1 id="37fb" class="jn jo iq bd jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk bi translated">在Otomi容器平台中实际使用OPA</h1><p id="ad62" class="pw-post-body-paragraph kl km iq kn b ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">正如你们中的一些人可能已经知道的，kubernetes本地的<strong class="kn ir"> PodSecurityPolicy </strong>资源将被弃用，参见<a class="ae lj" href="https://github.com/kubernetes/kubernetes/pull/97171" rel="noopener ugc nofollow" target="_blank"> <em class="lp">此处</em> </a> <em class="lp">和</em> <a class="ae lj" href="https://docs.google.com/document/d/1VKqjUlpU888OYtIrBwidL43FOLhbmOD5tesYwmjzO4E/edit#" rel="noopener ugc nofollow" target="_blank"> <em class="lp">此处</em></a><em class="lp"/>——这为类似于<a class="ae lj" href="https://www.openpolicyagent.org/" rel="noopener ugc nofollow" target="_blank"> <strong class="kn ir">开放策略代理</strong> </a> <strong class="kn ir"> </strong>这样的外部项目留下了余地，它们将被用作开发和执行策略规则的新标准。</p><p id="4d68" class="pw-post-body-paragraph kl km iq kn b ko lk kq kr ks ll ku kv kw lm ky kz la ln lc ld le lo lg lh li ij bi translated"><a class="ae lj" href="https://otomi.io/" rel="noopener ugc nofollow" target="_blank"> Otomi </a>正在使用<strong class="kn ir"> OPA </strong>作为提供政策执行的标准，因为它在kubernetes社区中很受欢迎，易于使用，也是为了未来的项目开发计划。</p><p id="6117" class="pw-post-body-paragraph kl km iq kn b ko lk kq kr ks ll ku kv kw lm ky kz la ln lc ld le lo lg lh li ij bi translated"><a class="ae lj" href="https://otomi.io/" rel="noopener ugc nofollow" target="_blank"> Otomi容器平台</a>的基础是易于使用并提供清晰的集成，允许开发人员轻松扩展任何平台功能，并从头开始为一切提供集成的安全性。—访问redkubes.com<a class="ae lj" href="https://redkubes.com/" rel="noopener ugc nofollow" target="_blank"/>了解更多信息。</p><h1 id="63db" class="jn jo iq bd jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk bi translated">OPA生态系统常识</h1><figure class="lr ls lt lu gt lv gh gi paragraph-image"><div role="button" tabindex="0" class="lw lx di ly bf lz"><div class="gh gi lq"><img src="../Images/522f1d6bb01030f084f658ca9ce93f9f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*wG_jBhAiDURRft61"/></div></div><figcaption class="mc md gj gh gi me mf bd b be z dk translated">照片由<a class="ae lj" href="https://unsplash.com/@elisa_cb?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">伊莉莎·卡尔韦B. </a>在<a class="ae lj" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄</figcaption></figure><p id="e581" class="pw-post-body-paragraph kl km iq kn b ko lk kq kr ks ll ku kv kw lm ky kz la ln lc ld le lo lg lh li ij bi translated">决策是通过<strong class="kn ir">准入控制器</strong>来处理的，比如<strong class="kn ir"> OPA </strong> <strong class="kn ir"> kube-mgmt </strong>项目或者<a class="ae lj" href="https://github.com/open-policy-agent/gatekeeper" rel="noopener ugc nofollow" target="_blank"> <strong class="kn ir"> Gatekeeper </strong> </a> <strong class="kn ir">，</strong>，我马上会谈到这些，但是也要记住，我们可以使用<a class="ae lj" href="https://www.openpolicyagent.org/docs/latest/#rego" rel="noopener ugc nofollow" target="_blank"> <strong class="kn ir">减压阀查询</strong> </a> <strong class="kn ir"> </strong>语言，使用静态分析工具，比如<a class="ae lj" href="https://github.com/open-policy-agent/conftest" rel="noopener ugc nofollow" target="_blank"><strong class="kn ir">【Conftest】</strong></a>对任何普通文件进行验证。conftest支持的格式列表包括但不限于:json、yaml、Dockerfile、INI文件、XML等。</p><p id="27bf" class="pw-post-body-paragraph kl km iq kn b ko lk kq kr ks ll ku kv kw lm ky kz la ln lc ld le lo lg lh li ij bi translated">问题来了，<a class="ae lj" href="https://github.com/open-policy-agent/conftest" rel="noopener ugc nofollow" target="_blank"><strong class="kn ir"/></a>和<strong class="kn ir">看门人</strong>正在分道扬镳，虽然他们说着相同的语言，但两人在某些方面存在分歧。</p></div><div class="ab cl mg mh hu mi" role="separator"><span class="mj bw bk mk ml mm"/><span class="mj bw bk mk ml mm"/><span class="mj bw bk mk ml"/></div><div class="ij ik il im in"><h1 id="160a" class="jn jo iq bd jp jq mn js jt ju mo jw jx jy mp ka kb kc mq ke kf kg mr ki kj kk bi translated">集群内与静态资源策略之战</h1><figure class="lr ls lt lu gt lv gh gi paragraph-image"><div role="button" tabindex="0" class="lw lx di ly bf lz"><div class="gh gi ms"><img src="../Images/877743bc0a43dd6d17ed3e5c0b3826bd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*nF5HqEa-2CiLAgw_"/></div></div><figcaption class="mc md gj gh gi me mf bd b be z dk translated">由<a class="ae lj" href="https://unsplash.com/@jwimmerli?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> jean wimmerlin </a>在<a class="ae lj" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</figcaption></figure><p id="d452" class="pw-post-body-paragraph kl km iq kn b ko lk kq kr ks ll ku kv kw lm ky kz la ln lc ld le lo lg lh li ij bi translated">在策略受限的环境中工作就像为非特权用户打开“家长控制”,允许管理员决定哪种资源和设置对他们的Kubernetes集群最安全。</p><p id="da0e" class="pw-post-body-paragraph kl km iq kn b ko lk kq kr ks ll ku kv kw lm ky kz la ln lc ld le lo lg lh li ij bi translated">从应用程序开发人员的角度来看，拒绝访问部署一些资源意味着他/她没有遵守为该环境强加的规则，并且应该决定找到并修复该设置中缺少的链接。</p><p id="98da" class="pw-post-body-paragraph kl km iq kn b ko lk kq kr ks ll ku kv kw lm ky kz la ln lc ld le lo lg lh li ij bi translated">另一方面，策略管理员/开发人员努力寻找正确的实施策略，并根据期望的状态调整策略参数，或者在策略实施没有意义的情况下允许某些排除(考虑系统名称空间、云供应商特定的名称空间、默认情况下应该避免干预的任何内容)。政策采纳没有金科玉律，如果有什么不对劲，你要负责克服自己的错误。</p><p id="7021" class="pw-post-body-paragraph kl km iq kn b ko lk kq kr ks ll ku kv kw lm ky kz la ln lc ld le lo lg lh li ij bi translated">我将从针对任何种类的YAML资源运行策略检查的简单用例开始，然后继续讨论关于集群内Kubernetes准入审查对象的更多细节。</p><h2 id="e21b" class="mt jo iq bd jp mu mv dn jt mw mx dp jx kw my mz kb la na nb kf le nc nd kj ne bi translated">行动中的冲突</h2><p id="ad8a" class="pw-post-body-paragraph kl km iq kn b ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">通过一个简单的命令，我们可以测试舵图表是否违反了所提供的策略文件夹中的任何规则。</p><pre class="lr ls lt lu gt nf ng nh ni aw nj bi"><span id="d8f2" class="mt jo iq ng b gy nk nl l nm nn"><strong class="ng ir">$ </strong>helm template stable/keycloak | conftest test --policy ./policies/   --all-namespaces -</span><span id="5cd6" class="mt jo iq ng b gy no nl l nm nn"><strong class="ng ir">FAIL</strong> - Policy: container-limits - container &lt;keycloak&gt; has no resource limits<br/><strong class="ng ir">FAIL</strong> - Policy: container-limits - container &lt;keycloak-test&gt; has no resource limits</span><span id="9b7c" class="mt jo iq ng b gy no nl l nm nn"><strong class="ng ir">162 tests, 160 passed, 0 warnings, 2 failures, 0 exceptions</strong></span></pre><p id="e56c" class="pw-post-body-paragraph kl km iq kn b ko lk kq kr ks ll ku kv kw lm ky kz la ln lc ld le lo lg lh li ij bi translated">生成的yaml文件被传输到conftest中，并逐个测试策略。</p><p id="2419" class="pw-post-body-paragraph kl km iq kn b ko lk kq kr ks ll ku kv kw lm ky kz la ln lc ld le lo lg lh li ij bi translated">通过检查日志消息，我们发现<strong class="kn ir">容器限制</strong>策略将两个资源标记为失败——现在我们所要做的就是修改模板，为指定的容器提供“敏感”数量的资源限制，我们的策略检查将成功通过！好哇..</p><p id="f140" class="pw-post-body-paragraph kl km iq kn b ko lk kq kr ks ll ku kv kw lm ky kz la ln lc ld le lo lg lh li ij bi translated">如果我们想采用新的helm应用程序，但不想在集群中部署任何东西，除非<em class="lp">很好地检查了</em>是否有任何违规，这是非常有用的。</p><p id="e6ca" class="pw-post-body-paragraph kl km iq kn b ko lk kq kr ks ll ku kv kw lm ky kz la ln lc ld le lo lg lh li ij bi translated">Conftest支持使用<code class="fe np nq nr ng b">--data</code>选项向策略传递值，这允许策略设计者通过参数配置不同的设置。</p><p id="54aa" class="pw-post-body-paragraph kl km iq kn b ko lk kq kr ks ll ku kv kw lm ky kz la ln lc ld le lo lg lh li ij bi translated"><strong class="kn ir">参数</strong>可以帮助我们控制为资源创建可配置规则的任何方面。</p><p id="a387" class="pw-post-body-paragraph kl km iq kn b ko lk kq kr ks ll ku kv kw lm ky kz la ln lc ld le lo lg lh li ij bi translated">我一会儿会回到这个话题上…</p><h2 id="d54c" class="mt jo iq bd jp mu mv dn jt mw mx dp jx kw my mz kb la na nb kf le nc nd kj ne bi translated">运行看门人</h2><p id="fb1d" class="pw-post-body-paragraph kl km iq kn b ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">Gatekeeper正在成为Kubernetes中实施安全策略的新标准，支持一个广泛的生态系统来传播思想。</p><p id="ddaa" class="pw-post-body-paragraph kl km iq kn b ko lk kq kr ks ll ku kv kw lm ky kz la ln lc ld le lo lg lh li ij bi translated">实施策略决策的工作方式是使用一个验证web挂钩，拦截任何由api-server验证的请求，并检查请求有效负载是否满足已定义策略的要求，否则拒绝它。</p><p id="d8b6" class="pw-post-body-paragraph kl km iq kn b ko lk kq kr ks ll ku kv kw lm ky kz la ln lc ld le lo lg lh li ij bi translated">尝试在启用了网关守护设备的群集中创建不一致的资源对象，会导致出现一条错误消息，解释被拒绝的请求。</p><pre class="lr ls lt lu gt nf ng nh ni aw nj bi"><span id="1957" class="mt jo iq ng b gy nk nl l nm nn"><strong class="ng ir">$</strong> helm template charts/redis | kubectl apply -f -<br/>                                                                                                                                                                  <br/>secret/redis created<br/>configmap/redis created<br/>service/redis-master created</span><span id="ff88" class="mt jo iq ng b gy no nl l nm nn">Error from server (</span><span id="2285" class="mt jo iq ng b gy no nl l nm nn"><strong class="ng ir">[denied by banned-image-tags]</strong> Policy: banned-image-tags - container &lt;redis&gt; has banned image tag &lt;latest&gt;, banned tags are {"latest", "master"}<br/><strong class="ng ir">[denied by psp-allowed-users]</strong> Policy: psp-allowed-users - Container redis is attempting to run as disallowed user 0. Allowed runAsUser: {"rule": "MustRunAsNonRoot"}</span><span id="6339" class="mt jo iq ng b gy no nl l nm nn">)</span><span id="0c6a" class="mt jo iq ng b gy no nl l nm nn">error when creating "redis/templates/redis-master-statefulset.yaml": admission webhook "validation.gatekeeper.sh" denied the request:</span><span id="ea3b" class="mt jo iq ng b gy no nl l nm nn">[...]</span></pre><p id="2efa" class="pw-post-body-paragraph kl km iq kn b ko lk kq kr ks ll ku kv kw lm ky kz la ln lc ld le lo lg lh li ij bi translated">正如我们所看到的，创建了一些资源，但是命令失败了，因为admission webhook拒绝了。</p><p id="c471" class="pw-post-body-paragraph kl km iq kn b ko lk kq kr ks ll ku kv kw lm ky kz la ln lc ld le lo lg lh li ij bi translated">为了使这个资源有效，对<strong class="kn ir">图像标签</strong>和<strong class="kn ir"> securityContext </strong>字段做一些小的调整就可以了。</p><p id="6601" class="pw-post-body-paragraph kl km iq kn b ko lk kq kr ks ll ku kv kw lm ky kz la ln lc ld le lo lg lh li ij bi translated">[有关非根/ securityContext.runAsUser的更多信息… ]</p><h1 id="df7b" class="jn jo iq bd jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk bi translated">把关者背景下的政策制定</h1><p id="ec1b" class="pw-post-body-paragraph kl km iq kn b ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">与Conftest使用的普通策略文件类似，<a class="ae lj" href="https://github.com/open-policy-agent/gatekeeper-library" rel="noopener ugc nofollow" target="_blank"> <strong class="kn ir">网守策略库</strong> </a> <strong class="kn ir"> </strong>的工作原理是将kubernetes <strong class="kn ir"> CRDs </strong>中一组包装好的rego文件加载到内存中，称为<strong class="kn ir"> ConstraintTemplates </strong>。</p><p id="3857" class="pw-post-body-paragraph kl km iq kn b ko lk kq kr ks ll ku kv kw lm ky kz la ln lc ld le lo lg lh li ij bi translated">为了对某些资源类型实施策略，我们需要实例化一个<strong class="kn ir">约束</strong> ( <strong class="kn ir"> CR </strong> resource)，它的行为类似于带有所需值或参数的蓝图。</p><p id="db7d" class="pw-post-body-paragraph kl km iq kn b ko lk kq kr ks ll ku kv kw lm ky kz la ln lc ld le lo lg lh li ij bi translated">配置和约束资源的网关守护设备设置示例:</p><pre class="lr ls lt lu gt nf ng nh ni aw nj bi"><span id="aada" class="mt jo iq ng b gy nk nl l nm nn">--- # Gatekeeper <strong class="ng ir">Config</strong></span><span id="03db" class="mt jo iq ng b gy no nl l nm nn">apiVersion: config.gatekeeper.sh/v1alpha1<br/>kind: Config <br/>metadata: <br/>  name: config <br/>  namespace: gatekeeper-system <br/>spec: <br/>  match: <br/>  - excludedNamespaces: <br/>    - gatekeeper-system <br/>    - kube-system <br/>    processes: <br/>    - '*' <br/>sync: <br/>  syncOnly: <br/>  - group: "" <br/>    kind: Pod <br/>    version: v1</span><span id="d10b" class="mt jo iq ng b gy no nl l nm nn">--- # ContainerLimits <strong class="ng ir">Constraint</strong> </span><span id="405a" class="mt jo iq ng b gy no nl l nm nn">apiVersion: constraints.gatekeeper.sh/v1beta1<br/>kind: ContainerLimits<br/>metadata:<br/>  name: containerlimits<br/>spec:<br/>  match:<br/>    kinds:<br/>    - apiGroups:<br/>        - apps<br/>        - ""<br/>      kinds:<br/>        - DaemonSet<br/>        - Deployment<br/>        - StatefulSet<br/>        - Pod<br/> parameters:<br/>   container-limits:<br/>     enabled: false<br/>     cpu: "2"<br/>     memory: 2000Mi</span></pre><p id="eab2" class="pw-post-body-paragraph kl km iq kn b ko lk kq kr ks ll ku kv kw lm ky kz la ln lc ld le lo lg lh li ij bi translated">到目前为止，这看起来很容易——我们决定对除“gatekeeper-system”和“kube-system”之外的所有名称空间启用该策略，gatekeeper将测试我们所有容器的资源限制。</p><p id="2c44" class="pw-post-body-paragraph kl km iq kn b ko lk kq kr ks ll ku kv kw lm ky kz la ln lc ld le lo lg lh li ij bi translated">继续..这个政策的定义在哪里？</p><p id="dd61" class="pw-post-body-paragraph kl km iq kn b ko lk kq kr ks ll ku kv kw lm ky kz la ln lc ld le lo lg lh li ij bi translated"><strong class="kn ir">减压阀规则</strong>在名为<strong class="kn ir">约束模板</strong>的CRD文件中定义，它们需要在<strong class="kn ir">约束</strong>实例之前部署。</p><pre class="lr ls lt lu gt nf ng nh ni aw nj bi"><span id="1500" class="mt jo iq ng b gy nk nl l nm nn">--- # <strong class="ng ir">ConstraintTemplate</strong> for container-limits policy</span><span id="0ce9" class="mt jo iq ng b gy no nl l nm nn">apiVersion: templates.gatekeeper.sh/v1beta1<br/>kind: ConstraintTemplate<br/>metadata:  <br/>  name: containerlimits  <br/>spec:  <br/>  crd:    <br/>    spec:      <br/>      names:        <br/>        kind: ContainerLimits      <br/>      validation:        # Schema for the `parameters` field<br/>        openAPIV3Schema:          <br/>...<br/>targets:    <br/>- target<strong class="ng ir">:</strong> admission.k8s.gatekeeper.sh      <br/>  <strong class="ng ir">libs:</strong><br/>    - |-<br/>      package lib.utils<br/>      ...<br/>  <strong class="ng ir">rego:</strong> |-        <br/>    package containerlimits<br/>    ...</span></pre><p id="c2e3" class="pw-post-body-paragraph kl km iq kn b ko lk kq kr ks ll ku kv kw lm ky kz la ln lc ld le lo lg lh li ij bi translated">为了简化这个例子，我删除了我们文件的一部分，但是你也可以在<a class="ae lj" href="https://github.com/open-policy-agent/gatekeeper-library/blob/master/library/general/containerlimits/template.yaml" rel="noopener ugc nofollow" target="_blank"> Gatekeeper Library repo </a>上查看它。</p><p id="07e9" class="pw-post-body-paragraph kl km iq kn b ko lk kq kr ks ll ku kv kw lm ky kz la ln lc ld le lo lg lh li ij bi translated"><code class="fe np nq nr ng b">"rego”</code>属性是实际策略定义所在的地方，任何依赖库都可以在<code class="fe np nq nr ng b">"libs"</code>的列表中声明。</p><p id="8eda" class="pw-post-body-paragraph kl km iq kn b ko lk kq kr ks ll ku kv kw lm ky kz la ln lc ld le lo lg lh li ij bi translated">我们现在不会深入研究减压阀违规规则是如何工作的，但是你可以享受学习一种受几十年前的Datalog启发的强大查询语言的乐趣。</p><h1 id="822c" class="jn jo iq bd jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk bi translated">统一规划</h1><p id="095f" class="pw-post-body-paragraph kl km iq kn b ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">虽然创建新策略的过程似乎很重要，但幸运的是有一个简单的CLI工具可以加快我们的工作，它叫做<a class="ae lj" href="https://github.com/plexsystems/konstraint/" rel="noopener ugc nofollow" target="_blank"> Konstraint </a>。</p><p id="3e29" class="pw-post-body-paragraph kl km iq kn b ko lk kq kr ks ll ku kv kw lm ky kz la ln lc ld le lo lg lh li ij bi translated">您可以在<strong class="kn ir">减压阀文件</strong>中定义规则，而<strong class="kn ir"> Konstraint </strong>会将我们的策略和所有依赖库包装在必要的<strong class="kn ir"> CRD </strong> <strong class="kn ir">文件</strong>中，以供看门人使用。Konstraint拥有处理各种kubernetes本地对象的核心库函数，这使得它成为减压阀开发不可或缺的工具。</p><p id="80a2" class="pw-post-body-paragraph kl km iq kn b ko lk kq kr ks ll ku kv kw lm ky kz la ln lc ld le lo lg lh li ij bi translated">好的，这意味着我们只关心写<strong class="kn ir">减压阀文件</strong>，我们可以在Gatekeeper和Conftest中测试它们。</p><h2 id="eb19" class="mt jo iq bd jp mu mv dn jt mw mx dp jx kw my mz kb la na nb kf le nc nd kj ne bi translated">OPA社区中的开放问题</h2><p id="6b12" class="pw-post-body-paragraph kl km iq kn b ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">虽然这是事实，但在深入研究Gatekeeper和Conftest之后，我发现了一些相互冲突的设计概念，它们完全破坏了这种统一的策略开发思维模式。</p><p id="c814" class="pw-post-body-paragraph kl km iq kn b ko lk kq kr ks ll ku kv kw lm ky kz la ln lc ld le lo lg lh li ij bi translated">在两个库中定义参数的方式是不同的，Gatekeeper有一个限制性的解析器，不允许在rego定义中任意导入。</p><p id="0a40" class="pw-post-body-paragraph kl km iq kn b ko lk kq kr ks ll ku kv kw lm ky kz la ln lc ld le lo lg lh li ij bi translated">在这里的<a class="ae lj" href="https://github.com/open-policy-agent/gatekeeper/issues/1046" rel="noopener ugc nofollow" target="_blank">讨论中，有人试图改变这一硬性限制</a>！</p><h2 id="8e13" class="mt jo iq bd jp mu mv dn jt mw mx dp jx kw my mz kb la na nb kf le nc nd kj ne bi translated">减压阀统一后的现状</h2><blockquote class="ns"><p id="58c4" class="nt nu iq bd nv nw nx ny nz oa ob li dk translated">为了再次呼应这个主题，我们对减少样板文件和简化制定政策的过程感兴趣。</p><p id="cf2f" class="nt nu iq bd nv nw nx ny nz oa ob li dk translated">[相同的减压阀==不同的上下文]</p></blockquote><p id="1cad" class="pw-post-body-paragraph kl km iq kn b ko oc kq kr ks od ku kv kw oe ky kz la of lc ld le og lg lh li ij bi translated">使用一个<strong class="kn ir">通用减压阀策略文件集</strong>并使用相同的源代码来测试“静态文件”，这些文件是从CI构建或跨任何“把关上下文”生成的，其中对象是通过kubernetes api创建的。</p><p id="f36b" class="pw-post-body-paragraph kl km iq kn b ko lk kq kr ks ll ku kv kw lm ky kz la ln lc ld le lo lg lh li ij bi translated">让我们切入正题，说我们已经做到了，并在<a class="ae lj" href="https://otomi.io/" rel="noopener ugc nofollow" target="_blank"> Otomi </a>中交付了一个工作解决方案。通过使用可用的社区工具，大量的集成工作和大量的定制添加。</p><p id="69df" class="pw-post-body-paragraph kl km iq kn b ko lk kq kr ks ll ku kv kw lm ky kz la ln lc ld le lo lg lh li ij bi translated">我们现在有了一个为我们的Kubernetes集群定义的丰富的策略和效用函数集合——您可以在<a class="ae lj" href="https://github.com/redkubes/otomi-core/tree/master/policies/" rel="noopener ugc nofollow" target="_blank"> otomi-core库</a>中浏览它们。</p><h2 id="9946" class="mt jo iq bd jp mu mv dn jt mw mx dp jx kw my mz kb la na nb kf le nc nd kj ne bi translated">Istio如何在背景中改变物体</h2><p id="eb6e" class="pw-post-body-paragraph kl km iq kn b ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">到目前为止，我们已经了解了减压阀政策和把关者的所有本质细节，但总会有外部因素改变世界的状态，你会发现自己处于一个封闭的盒子里，无处可去。</p><p id="1c51" class="pw-post-body-paragraph kl km iq kn b ko lk kq kr ks ll ku kv kw lm ky kz la ln lc ld le lo lg lh li ij bi translated">当使用<a class="ae lj" href="https://istio.io/latest/" rel="noopener ugc nofollow" target="_blank"> <strong class="kn ir"> Istio mesh </strong> </a>进行联网时，这种情况就变成了一场噩梦。实际上<a class="ae lj" href="https://istio.io/" rel="noopener ugc nofollow" target="_blank"><strong class="kn ir">Istio</strong></a><strong class="kn ir"/>正在通过将一个Sidecar容器注入到启用了服务网格通信的名称空间中的所有pod来创建一个资源“子空间”。</p><p id="76a4" class="pw-post-body-paragraph kl km iq kn b ko lk kq kr ks ll ku kv kw lm ky kz la ln lc ld le lo lg lh li ij bi translated">这种容器有时会干扰安全<strong class="kn ir">约束</strong>设计策略。</p><h1 id="b305" class="jn jo iq bd jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk bi translated">Otomi策略功能</h1><p id="7d72" class="pw-post-body-paragraph kl km iq kn b ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated"><em class="lp"> —参数、注释、排除、基线参数。</em></p><p id="7b9d" class="pw-post-body-paragraph kl km iq kn b ko lk kq kr ks ll ku kv kw lm ky kz la ln lc ld le lo lg lh li ij bi translated">为了创造一定的灵活性，我们进一步扩展了策略异常功能，检查每个被分析资源的粒度注释信息。</p><p id="6188" class="pw-post-body-paragraph kl km iq kn b ko lk kq kr ks ll ku kv kw lm ky kz la ln lc ld le lo lg lh li ij bi translated">回到前面描述的<strong class="kn ir">参数</strong>想法，如果策略文件可以读取kubernetes对象(或普通静态文件)作为原始输入，为什么不通过注释我们想要跳过检查的资源来允许某些异常，类似于看门人的<strong class="kn ir"> excludeNamespace </strong>选项。</p><p id="ddd7" class="pw-post-body-paragraph kl km iq kn b ko lk kq kr ks ll ku kv kw lm ky kz la ln lc ld le lo lg lh li ij bi translated">减压阀有一个丰富的内置库系统，是一种强大的语言，允许我们轻松地为这个设计创建健壮的实用函数。</p><p id="9cd1" class="pw-post-body-paragraph kl km iq kn b ko lk kq kr ks ll ku kv kw lm ky kz la ln lc ld le lo lg lh li ij bi translated">举例来说，使用以下注释将确保从一个或多个策略检查中排除整个pod或pod中的某些容器:</p><pre class="lr ls lt lu gt nf ng nh ni aw nj bi"><span id="bcc9" class="mt jo iq ng b gy nk nl l nm nn"># Ignore Annotation for entire pod<br/><strong class="ng ir">policy.otomi.io/ignore:</strong> psp-allowed-repos</span><span id="5c2a" class="mt jo iq ng b gy no nl l nm nn"># Ignore Annotation for Istio sidecar based containers <br/><strong class="ng ir">policy.otomi.io/ignore-sidecar:</strong> psp-allowed-users,psp-capabilities</span><span id="686c" class="mt jo iq ng b gy no nl l nm nn"># Ignore Annotation for specific container (name=app-container)<br/><strong class="ng ir">policy.otomi.io/ignore/app-container:</strong> banned-image-tags</span><span id="f7cd" class="mt jo iq ng b gy no nl l nm nn"># Parameters Annotation to extend policy configuration<br/><strong class="ng ir">policy.otomi.io/parameters.psp-allowed-repos: '</strong>{"repos":["*"]}'</span></pre><p id="b1a7" class="pw-post-body-paragraph kl km iq kn b ko lk kq kr ks ll ku kv kw lm ky kz la ln lc ld le lo lg lh li ij bi translated">排除的另一个示例是通过从基线设置中禁用策略来完全关闭策略:</p><pre class="lr ls lt lu gt nf ng nh ni aw nj bi"><span id="6cdd" class="mt jo iq ng b gy nk nl l nm nn"># baseline configuration</span><span id="9520" class="mt jo iq ng b gy no nl l nm nn">policies:<br/>  <strong class="ng ir">container-limits:</strong><br/>    enabled: false<br/>    cpu: '2'<br/>    memory: 2Gi<br/>  <strong class="ng ir">banned-image-tags:</strong><br/>    enabled: false<br/>    tags:<br/>      - latest<br/>      - master<br/><strong class="ng ir">  psp-allowed-users:</strong><br/>    enabled: true<br/>    runAsUser:<br/>      rule: MustRunAs<br/>      ranges:<br/>        - min: 1<br/>          max: 65535<br/> <strong class="ng ir"> psp-allowed-repos:</strong><br/>    enabled: true<br/>    repos:<br/>      - docker.io<br/>      - gke.otomi.cloud<br/>      - aks.otomi.cloud<br/>      - eks.otomi.cloud</span></pre><p id="4e17" class="pw-post-body-paragraph kl km iq kn b ko lk kq kr ks ll ku kv kw lm ky kz la ln lc ld le lo lg lh li ij bi translated">查看我们在<a class="ae lj" href="https://github.com/redkubes/otomi-core/tree/master/policies/" rel="noopener ugc nofollow" target="_blank"> otomi-core仓库</a>中收集的其他策略。</p><h1 id="ad29" class="jn jo iq bd jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk bi translated">结论</h1><p id="46ee" class="pw-post-body-paragraph kl km iq kn b ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">为了确定现状kubernetes策略的设计仍在向新的高度发展，我可以想象在不久的将来会有越来越多的项目从类似于<a class="ae lj" href="https://github.com/policy-hub/policy-hub-cli" rel="noopener ugc nofollow" target="_blank"> policy-hub </a>的注册中心共享相同的策略。</p><p id="82d6" class="pw-post-body-paragraph kl km iq kn b ko lk kq kr ks ll ku kv kw lm ky kz la ln lc ld le lo lg lh li ij bi translated">在花了很多时间反复研究政策定义后，我认为就统一的减压阀达成共识是光明未来的关键。</p><p id="f5e3" class="pw-post-body-paragraph kl km iq kn b ko lk kq kr ks ll ku kv kw lm ky kz la ln lc ld le lo lg lh li ij bi translated">—乐意分享我的想法，敬请期待<strong class="kn ir">第二部。</strong></p><p id="4698" class="pw-post-body-paragraph kl km iq kn b ko lk kq kr ks ll ku kv kw lm ky kz la ln lc ld le lo lg lh li ij bi translated">谢谢大家！</p></div></div>    
</body>
</html>