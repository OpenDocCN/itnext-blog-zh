<html>
<head>
<title>Creating A Github Action to Tag Commits</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">创建Github动作来标记提交</h1>
<blockquote>原文：<a href="https://itnext.io/creating-a-github-action-to-tag-commits-2722f1560dec?source=collection_archive---------1-----------------------#2019-09-08">https://itnext.io/creating-a-github-action-to-tag-commits-2722f1560dec?source=collection_archive---------1-----------------------#2019-09-08</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><figure class="gl gn jr js jt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi jq"><img src="../Images/ee3da9c252b4ee68418a49fcbf0a407a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*_4Ex1uUhL93a3bHyC-TgPg.png"/></div></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated">来源:<a class="ae kf" href="https://github.com/" rel="noopener ugc nofollow" target="_blank"> Github </a></figcaption></figure><blockquote class="kg kh ki"><p id="1287" class="kj kk kl km b kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh im bi translated">GitHub Actions现在拥有世界一流的CI/CD，可以轻松实现所有软件工作流程的自动化。直接从GitHub构建、测试和部署您的代码。按照您想要的方式进行代码审查、分支管理和问题分类。</p><p id="fa99" class="kj kk kl km b kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh im bi translated"><a class="ae kf" href="https://github.com/features/actions" rel="noopener ugc nofollow" target="_blank"> Github动作文档</a></p></blockquote><h1 id="c920" class="li lj it bd lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf bi translated">介绍</h1><p id="c490" class="pw-post-body-paragraph kj kk it km b kn mg kp kq kr mh kt ku mi mj kx ky mk ml lb lc mm mn lf lg lh im bi translated">在本帖中，我们将创建一个新的Github动作，在合并一个pull请求时自动标记提交。</p><p id="07ac" class="pw-post-body-paragraph kj kk it km b kn ko kp kq kr ks kt ku mi kw kx ky mk la lb lc mm le lf lg lh im bi translated">Git标签是存储库历史中被标记为重要的特定点，通常用于标识发布版本。自动标记我们的Github项目是迈向完全自动化的<a class="ae kf" href="https://www.atlassian.com/continuous-delivery/principles/continuous-integration-vs-delivery-vs-deployment" rel="noopener ugc nofollow" target="_blank"> CI </a>管道的第一步，在Github中存储和版本控制！让我们开始吧。</p><div class="mo mp gp gr mq mr"><a href="https://github.com/anothrNick/github-tag-action" rel="noopener  ugc nofollow" target="_blank"><div class="ms ab fo"><div class="mt ab mu cl cj mv"><h2 class="bd iu gy z fp mw fr fs mx fu fw is bi translated">anothrNick/github-tag-action</h2><div class="my l"><h3 class="bd b gy z fp mw fr fs mx fu fw dk translated">一个Github动作，在合并时，用最新的semver格式版本自动碰撞和标记master。名称:凹凸…</h3></div><div class="mz l"><p class="bd b dl z fp mw fr fs mx fu fw dk translated">github.com</p></div></div><div class="na l"><div class="nb l nc nd ne na nf jz mr"/></div></div></a></div><h1 id="2214" class="li lj it bd lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf bi translated">创建标签</h1><p id="90ce" class="pw-post-body-paragraph kj kk it km b kn mg kp kq kr mh kt ku mi mj kx ky mk ml lb lc mm mn lf lg lh im bi translated">首先，我们需要从git存储库中获取最新的标签。这可以通过以下git命令来完成:</p><pre class="ng nh ni nj gt nk nl nm nn aw no bi"><span id="c4f1" class="np lj it nl b gy nq nr l ns nt"># get latest tag<br/>t=$(git describe --tags `git rev-list --tags --max-count=1`)</span><span id="45d0" class="np lj it nl b gy nu nr l ns nt"># print latest<br/>echo $t<br/>1.0.0</span></pre><p id="26d8" class="pw-post-body-paragraph kj kk it km b kn ko kp kq kr ks kt ku mi kw kx ky mk la lb lc mm le lf lg lh im bi translated">示例repo具有最新的标签<code class="fe nv nw nx nl b">1.0.0</code>。我们将使用语义版本化方案来实现这个版本。</p><p id="02f2" class="pw-post-body-paragraph kj kk it km b kn ko kp kq kr ks kt ku mi kw kx ky mk la lb lc mm le lf lg lh im bi translated"><a class="ae kf" href="https://semver.org/" rel="noopener ugc nofollow" target="_blank">语义版本化(又名SemVer) </a>是目前最广为人知和最广泛采用的版本方案。由于SemVer如此受欢迎，已经有很多工具可以产生语义版本标签，所以我最终决定使用<a class="ae kf" href="https://github.com/fsaintjacques/semver-tool" rel="noopener ugc nofollow" target="_blank">fsaintjacques/SEM ver-tool</a>。</p><div class="mo mp gp gr mq mr"><a href="https://github.com/fsaintjacques/semver-tool" rel="noopener  ugc nofollow" target="_blank"><div class="ms ab fo"><div class="mt ab mu cl cj mv"><h2 class="bd iu gy z fp mw fr fs mx fu fw is bi translated">fsainjacques/SEM ver-tool</h2><div class="my l"><h3 class="bd b gy z fp mw fr fs mx fu fw dk translated">semver是一个小工具，用于在遵循semver规范的项目中操纵版本碰撞。它的用途是…</h3></div><div class="mz l"><p class="bd b dl z fp mw fr fs mx fu fw dk translated">github.com</p></div></div></div></a></div><p id="a955" class="pw-post-body-paragraph kj kk it km b kn ko kp kq kr ks kt ku mi kw kx ky mk la lb lc mm le lf lg lh im bi translated">semver-tool是一个bash脚本，给定一个有效的semver标记，它将根据major、minor或patch参数将版本提升到它的下一个值。</p><p id="5ad0" class="pw-post-body-paragraph kj kk it km b kn ko kp kq kr ks kt ku mi kw kx ky mk la lb lc mm le lf lg lh im bi translated">现在我们有了最新的标签、版本控制方案和修改标签的工具，应该增加哪个数字；大调、小调还是补丁？一种简单而直接的方法是基于自最后一个标记以来提交消息中特定语法的存在进行跳转。所以，如果我们要传达一个信息:</p><pre class="ng nh ni nj gt nk nl nm nn aw no bi"><span id="fb6f" class="np lj it nl b gy nq nr l ns nt">git commit -m "Small bug fixes. #patch"</span></pre><p id="59dc" class="pw-post-body-paragraph kj kk it km b kn ko kp kq kr ks kt ku mi kw kx ky mk la lb lc mm le lf lg lh im bi translated">Github动作脚本将知道增加补丁数字，而不是大调或小调。</p><p id="d3b2" class="pw-post-body-paragraph kj kk it km b kn ko kp kq kr ks kt ku mi kw kx ky mk la lb lc mm le lf lg lh im bi translated">以下脚本将检索提交并基于提交消息碰撞标记，如果没有找到标记语法，则默认为<code class="fe nv nw nx nl b">minor</code>:</p><figure class="ng nh ni nj gt ju"><div class="bz fp l di"><div class="ny nz l"/></div></figure><p id="0abb" class="pw-post-body-paragraph kj kk it km b kn ko kp kq kr ks kt ku mi kw kx ky mk la lb lc mm le lf lg lh im bi translated">我们现在有一个新标签可以发布到Github了！</p><h1 id="8f5d" class="li lj it bd lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf bi translated">将新标签推送到Github</h1><p id="cd03" class="pw-post-body-paragraph kj kk it km b kn mg kp kq kr mh kt ku mi mj kx ky mk ml lb lc mm mn lf lg lh im bi translated">接下来，我们需要用新版本标记的当前提交散列。由于这个动作将在每次推(或合并)到master时运行，我们可以假设最新的提交散列将比最新的标签新。</p><pre class="ng nh ni nj gt nk nl nm nn aw no bi"><span id="1b29" class="np lj it nl b gy nq nr l ns nt"># get current commit hash<br/>commit=$(git rev-parse HEAD)</span></pre><p id="1568" class="pw-post-body-paragraph kj kk it km b kn ko kp kq kr ks kt ku mi kw kx ky mk la lb lc mm le lf lg lh im bi translated">标签是一个<a class="ae kf" href="https://git-scm.com/book/en/v2/Git-Internals-Git-References" rel="noopener ugc nofollow" target="_blank"> Git引用</a>。所以要在Github中创建新的标签，我们可以向Github API的ref资源发送一个POST请求，将标签(ref)和提交散列作为请求体。更多详情请参见<a class="ae kf" href="https://developer.github.com/v3/git/refs/#create-a-reference" rel="noopener ugc nofollow" target="_blank"> Github创建参考文档</a>。</p><p id="0f18" class="pw-post-body-paragraph kj kk it km b kn ko kp kq kr ks kt ku mi kw kx ky mk la lb lc mm le lf lg lh im bi translated">下面是一个cURL命令，它将使用API令牌发布对Github API的引用:</p><figure class="ng nh ni nj gt ju"><div class="bz fp l di"><div class="ny nz l"/></div></figure><p id="36d5" class="pw-post-body-paragraph kj kk it km b kn ko kp kq kr ks kt ku mi kw kx ky mk la lb lc mm le lf lg lh im bi translated">使用了两个环境变量:</p><p id="7b5a" class="pw-post-body-paragraph kj kk it km b kn ko kp kq kr ks kt ku mi kw kx ky mk la lb lc mm le lf lg lh im bi translated"><strong class="km iu"> REPO_OWNER </strong>:拥有该REPO的Github用户的名称(即您想要标记的项目的Github用户名)。在为操作设置工作流时，这将是一个可配置的参数。</p><p id="61d2" class="pw-post-body-paragraph kj kk it km b kn ko kp kq kr ks kt ku mi kw kx ky mk la lb lc mm le lf lg lh im bi translated">GITHUB_TOKEN  : API令牌，用于对Github API的请求进行认证和授权。这也需要传递到环境中，但是Github会自动为您创建一个令牌秘密，所以您不需要为您配置的每个项目工作流创建一个新的秘密。更多信息，请参考<a class="ae kf" href="https://help.github.com/en/articles/virtual-environments-for-github-actions#github_token-secret" rel="noopener ugc nofollow" target="_blank">Github动作的虚拟环境</a>。</p><p id="c6c0" class="pw-post-body-paragraph kj kk it km b kn ko kp kq kr ks kt ku mi kw kx ky mk la lb lc mm le lf lg lh im bi translated">我们创建新标签并将其发布到Github的最终脚本应该是这样的:</p><figure class="ng nh ni nj gt ju"><div class="bz fp l di"><div class="ny nz l"/></div></figure><p id="e3a1" class="pw-post-body-paragraph kj kk it km b kn ko kp kq kr ks kt ku mi kw kx ky mk la lb lc mm le lf lg lh im bi translated">现在让我们将我们的操作打包成一个Docker图像:</p><figure class="ng nh ni nj gt ju"><div class="bz fp l di"><div class="ny nz l"/></div></figure><p id="296c" class="pw-post-body-paragraph kj kk it km b kn ko kp kq kr ks kt ku mi kw kx ky mk la lb lc mm le lf lg lh im bi translated">我们的行动已经准备好了！</p><p id="0240" class="pw-post-body-paragraph kj kk it km b kn ko kp kq kr ks kt ku mi kw kx ky mk la lb lc mm le lf lg lh im bi translated">要在您的项目中使用此操作，只需在repo的<code class="fe nv nw nx nl b">.github/workflows/</code>目录中创建一个工作流文件。例如，Github Tag Bump项目用它来标记自己:</p><figure class="ng nh ni nj gt ju"><div class="bz fp l di"><div class="ny nz l"/></div></figure><p id="37bf" class="pw-post-body-paragraph kj kk it km b kn ko kp kq kr ks kt ku mi kw kx ky mk la lb lc mm le lf lg lh im bi translated"><em class="kl">注意:工作流使用</em> <code class="fe nv nw nx nl b"><em class="kl">actions/checkout@master</em></code> <em class="kl">动作来签出git存储库。</em></p><p id="cbbe" class="pw-post-body-paragraph kj kk it km b kn ko kp kq kr ks kt ku mi kw kx ky mk la lb lc mm le lf lg lh im bi translated">只需将<code class="fe nv nw nx nl b">REPO_OWNER</code>改为你的Github用户名或组织。现在推一些修改给master，或者提交一个PR。一旦合并，这个Github操作将运行并标记您的repo。</p><p id="118c" class="pw-post-body-paragraph kj kk it km b kn ko kp kq kr ks kt ku mi kw kx ky mk la lb lc mm le lf lg lh im bi translated">感谢阅读！</p><p id="5b94" class="pw-post-body-paragraph kj kk it km b kn ko kp kq kr ks kt ku mi kw kx ky mk la lb lc mm le lf lg lh im bi translated">Github Tag Bump发布到Github市场:</p><div class="mo mp gp gr mq mr"><a href="https://github.com/marketplace/actions/github-tag-bump" rel="noopener  ugc nofollow" target="_blank"><div class="ms ab fo"><div class="mt ab mu cl cj mv"><h2 class="bd iu gy z fp mw fr fs mx fu fw is bi translated">Github标签碰撞- GitHub市场</h2><div class="my l"><h3 class="bd b gy z fp mw fr fs mx fu fw dk translated">Github动作一个GitHub动作，在合并时，用最新的semver格式版本自动碰撞和标记master</h3></div><div class="mz l"><p class="bd b dl z fp mw fr fs mx fu fw dk translated">github.com</p></div></div><div class="na l"><div class="oa l nc nd ne na nf jz mr"/></div></div></a></div></div></div>    
</body>
</html>