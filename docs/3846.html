<html>
<head>
<title>Kubernetes Multi-Cluster Networking -Cilium Cluster Mesh</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Kubernetes多集群网络-纤毛集群网格</h1>
<blockquote>原文：<a href="https://itnext.io/kubernetes-multi-cluster-networking-cilium-cluster-mesh-bca0f5367d84?source=collection_archive---------0-----------------------#2020-03-10">https://itnext.io/kubernetes-multi-cluster-networking-cilium-cluster-mesh-bca0f5367d84?source=collection_archive---------0-----------------------#2020-03-10</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><figure class="ip iq gp gr ir is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi io"><img src="../Images/88dcc3ebb8b4f1dd8713160681378550.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*yv0wl6-9A1gOf6BF_35_wA.png"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">Cilium的多集群实现</figcaption></figure><div class=""/><p id="2e91" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">在动态变化和非常复杂的微服务生态系统时代，传统的IP和端口管理可能会在管理和扩展方面带来问题。Cilium使用BPF，可用于在Linux内核中转发数据，并可通过代理注入用于服务网格，如Kubernetes基于服务的负载平衡或istio。</p><p id="bcfc" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">BPF和Berkeley Packet Filter一样，最初设想于1992年，目的是提供一种过滤包的方法，避免无用的包从内核复制到用户空间。扩展BPF (eBPF)是对BPF(现在称为cBPF，代表经典BPF)的增强，具有增强的资源，例如10个寄存器和1–8字节加载/存储指令。BPF有向前跳转，而eBPF既有向后跳转又有向前跳转，所以可能会有一个循环，当然，内核会确保正确终止。</p><p id="a8e7" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">如今，诸如x86_64、arm64、ppc64和s390之类的架构已经能够从eBPF程序中编译出本机操作码映像，从而代替通过内核eBPF解释器的执行，所得到的映像可以像任何其他内核代码一样本机运行。然后，tc将程序安装到内核的网络数据路径中，通过有能力的NIC，程序也可以完全卸载到硬件中。</p><p id="4d79" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">Kubernetes使用iptables作为CNI的核心。iptables存在重大问题，这在大量多样的流量条件下造成了问题。iptable规则是按顺序匹配的，对iptable的更新必须通过在单个事务中重新创建和更新所有规则来完成，这可能不适合高度动态的容器空间。如果数据包经常遇到表中较低部分的规则，性能会受到影响。另一方面，BPF与“最接近的”规则匹配，而不是通过迭代整个规则集，这使得它非常适合网络策略的实现。</p><p id="16fa" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">Cilium提供内置于层中的多集群功能(pod-ip路由、服务发现和负载平衡等。)中，用户可以选择使用所有层，也可以根据需要仅选择和使用层。</p><h1 id="b4b8" class="la lb jf bd lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx bi translated">纤毛CNI实施</h1><p id="c639" class="pw-post-body-paragraph kc kd jf ke b kf ly kh ki kj lz kl km kn ma kp kq kr mb kt ku kv mc kx ky kz ij bi translated">Cilium代理、Cilium CLI客户端和CNI插件在集群中的每个节点上运行(部署为daemonset)。Cilium CNI插件执行所有与网络管道相关的任务，如创建链接设备(veth对)，为容器分配IP，配置IP地址，路由表，sysctl参数等。Cilium agent编译BPF程序，并使内核在网络栈的关键点运行这些程序。</p><p id="137b" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">Cilium提供了两种网络模式:</p><ol class=""><li id="7b55" class="md me jf ke b kf kg kj kk kn mf kr mg kv mh kz mi mj mk ml bi translated">覆盖网络模式:最常用和默认的网络模式。使用基于udp的封装协议的隧道网状结构的群集中的所有节点:VXLAN(默认)或Geneve。在这种模式下，Cilium可以自动形成一个覆盖网络，无需用户使用kube-controller-manager中的“— allocate-node-cidrs”选项进行任何配置。</li><li id="1756" class="md me jf ke b kf mm kj mn kn mo kr mp kv mq kz mi mj mk ml bi translated">直接/本地路由模式:在这种配置中，Cilium将所有不是发往另一个本地端点的数据包移交给linux内核的路由子系统。这个设置需要一个额外的路由守护进程，如鸟，奎加，BGPD，斑马等。通过节点的IP向所有其他节点通告非本地节点分配前缀。与VxLAN覆盖相比，BGP解决方案具有更好的性能，更重要的是，它使容器IP可路由，而无需任何额外的网格配置。</li></ol><p id="e2aa" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">考虑到默认网络模式和Kubernetes CNI实施，Cilium支持VETH/IPVLAN作为链接设备。</p><p id="d3a5" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">Cilium在主机网络空间上创建三个虚拟接口:cilium_host、cilium_net和cilium_vxlan。Cilium agent在启动时创建一个名为'<em class="mr">cilium_host←&gt;cilium _ net '</em>的veth对，并将CIDR的第一个IP地址设置为cilium_host，然后cilium _ host作为CIDR的网关。CNI插件将生成BPF规则，编译它们并将其注入内核，以弥合veth对之间的差距。</p><figure class="mt mu mv mw gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi ms"><img src="../Images/080233b9f178b8ae34dc2be0f560ac3a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*rKSUuV8hM5QteG5c"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">CNI库伯内特纤毛——实施</figcaption></figure><p id="3402" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">如上所示，当创建一个pod时，在根名称空间上创建一个带有“lxc-xx”的VETH接口，另一端连接到pod名称空间。pod的默认网关指向“cilium _ host”IP，Cilium代理安装必需的BPF程序来回复ARP请求。LXC接口MAC用于ARP回复。Pod生成的流量的下一个L3跳是cilium_host，Pod生成的流量的下一个L2跳是veth对的主机端。</p><p id="5113" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">在多主机联网中如果使用VxLAN，Cilium会在每个主机中创建一个cilium_vxlan设备，并通过软件进行VxLAN encap/decap。Cilium在元数据模式下使用VXLAN设备，这意味着它可以在多个地址上发送和接收。Cilium将使用它找到的第一个公共IPv4地址作为VXLAN VTEP。Cilium使用<a class="ae mx" href="https://lwn.net/Articles/705609/" rel="noopener ugc nofollow" target="_blank"> BPF </a>进行LWT(轻量级隧道)封装，pods发出的所有网络数据包都封装在一个报头中，该报头可以由VXLAN或Geneve帧组成，这些帧通过标准UDP数据包报头传输。</p><figure class="mt mu mv mw gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi my"><img src="../Images/27078d805646eb910c995e7cfd0a8a32.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*7MdUhTA_068MGKRf"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">CNI库伯内特纤毛——界面</figcaption></figure><p id="264e" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">如上所示，在多主机网络设置中，Cilim在节点之间创建隧道，其中隧道端点映射由Cilium编程。</p><h1 id="0e48" class="la lb jf bd lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx bi translated">纤毛簇网</h1><p id="0ae0" class="pw-post-body-paragraph kc kd jf ke b kf ly kh ki kj lz kl km kn ma kp kq kr mb kt ku kv mc kx ky kz ij bi translated">ClusterMesh是Cilium的多集群实现。ClusterMesh通过隧道或直接路由，以本机性能在多个Kubernetes集群之间实现Pod IP路由，无需任何网关或代理。</p><p id="c9c5" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">使用部署在<a class="ae mx" href="https://www.vultr.com/" rel="noopener ugc nofollow" target="_blank"> Vultr </a>上的不同地区的三个不同的AIO(主+工作)Kubernetes集群尝试ClusterMesh:</p><figure class="mt mu mv mw gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi mz"><img src="../Images/7796d02b8789fd5d6c187836213e0115.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*23gm-jySl9QN1IvT"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">拓扑示例—多区域集群</figcaption></figure><p id="f0c4" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">纤毛CNI安装在每个堆栈上，具有独特的/非重叠的Pod_CIDR，如下所示:</p><figure class="mt mu mv mw gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi na"><img src="../Images/180434d504da71aeaa66a2a4472035bf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*-2KQ2O1-DKmsU3C7"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">拓扑示例-具有唯一Pod_CIDR的多区域集群</figcaption></figure><p id="0bea" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">每个集群中的Cilium堆栈包含一个部署为daemonset的Cilium代理，该代理监听Kubernetes集群中的事件以了解何时创建或删除容器，并且它创建定制的BPF程序，Linux内核使用该程序来控制所有进出这些容器的网络访问。Cilium operator管理一次性任务，如Kubernetes服务与集群网格etcd的同步，以及集群中逻辑上应为整个集群处理一次的其他任务。这使得纤毛能够扩展到超过500个节点。</p><figure class="mt mu mv mw gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi nb"><img src="../Images/540e6e74d080190847fbd4212e634190.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*sjXvtu5yZwyezSQY"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">纤毛成分——Kubernetes</figcaption></figure><figure class="mt mu mv mw gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi nc"><img src="../Images/3dbd3301a0fe84468d3e9eb1c12e89af.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*RQOmCzpRSJdYxMod"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">纤毛剂</figcaption></figure><p id="22df" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">Cilium代理配置以ConfigMap的形式提供，包含所需的配置以及“群集id”和“群集名称”，以便在多群集设置中唯一标识群集。</p><figure class="mt mu mv mw gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi nd"><img src="../Images/2a6e9d727a08cd78ce03d7b6e73be369.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*H8W7KvRx37T1_BAB"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">纤毛配置— Kubernetes配置图</figcaption></figure><p id="7bfb" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">集群网格的先决条件之一是让Cilium <a class="ae mx" href="https://docs.cilium.io/en/v1.7/gettingstarted/k8s-install-etcd-operator/#k8s-install-etcd-operator" rel="noopener ugc nofollow" target="_blank">管理</a> etcd，etcd-operator用于保证仲裁、自动创建证书和管理压缩。可以用任何其他方式管理etcd，但是集群网格需要某些方面，以便在集群之间进行状态传播。</p><p id="1ed1" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">cilium-etcd-operator使用并扩展了etcd-operator来创建和管理集群上的etcd。运营商将始终确保维持法定人数，并在法定人数出现故障时重新创建etcd-cluster:</p><figure class="mt mu mv mw gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi nc"><img src="../Images/a2a36e0a4676c0312eaae577c4765c00.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*mAiBmwuC3L2O8I15"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">纤毛etcd算子</figcaption></figure><p id="2c91" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">每个Kubernetes集群维护自己的etcd集群，其中包含该集群的状态。来自多个集群的状态不会在etcd本身中混合。在其他集群中运行的Cilium代理连接到etcd代理以观察变化，并将多集群相关状态复制到它们自己的集群中。集群网格中的etcd应作为负载平衡器或节点端口公开。这允许Cilium在集群之间同步状态，并提供跨集群连接和策略实施。</p><p id="9b54" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">Cilium代理将使用预定义的命名模式'<em class="mr">{ cluster name } . mesh . cilium . io '</em>'连接到远程集群中的etcd。为了让DNS解析和TLS验证在这些虚拟主机名称上工作，使用daemonset规范中的<em class="mr">‘host aliases’</em>将名称静态映射到服务IP。对于上面的拓扑，配置如下所示:</p><figure class="mt mu mv mw gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi ne"><img src="../Images/4bc17a53ceef73f57e412962779b2229.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*KQxPleWkrv3DDi1P"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">纤毛多簇连接信息</figcaption></figure><p id="844c" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">由于跨集群etcd使用TLS，因此在包含多集群环境中所有其他etcd的证书和密钥的集群网格的所有集群部分上创建Kubernetes秘密。</p><figure class="mt mu mv mw gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi nf"><img src="../Images/8beed960f16ef2a1ab52b453fa26d0c0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*_FnqZWHYb9PhK68j"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">Cilium — etcd集群之间的可达性和身份验证</figcaption></figure><figure class="mt mu mv mw gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi ng"><img src="../Images/9c0b5f43005960586999beb2408f2048.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*JsqBkG_1421GGLiL"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">纤毛——多簇etcd秘密</figcaption></figure><p id="5c74" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">使用上面显示的跨集群配置，纤毛代理在所有其他集群之间形成隧道。例如，上面拓扑中的cluster-atlanta创建了到cluster-singapore和cluster-toronto的隧道，如下所示:</p><figure class="mt mu mv mw gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi nc"><img src="../Images/106e3a76044633d40159731603b5556f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*XYEwmFxANR7J12qQ"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">纤毛代理—入站/出站连接</figcaption></figure><p id="46f0" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">群集上的Cilum代理-atlanta在端口4240(cilum代理)上有来自其他群集(新加坡和多伦多)的Public_IP的入站和出站连接。</p><p id="4cea" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">Cilium config保存隧道模式，便于用户提供要使用的隧道方案，在上面的场景中，使用默认的VXLAN:</p><figure class="mt mu mv mw gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi nh"><img src="../Images/99bf67d1092b3d7cd36e1fb670c5dc3d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*35Gx1NXcMniyNSGS"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">纤毛—隧道模式配置</figcaption></figure><p id="b2ff" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">Cilium代理使用特定集群的Pod_CIDR和从节点列表(集群网格中所有节点的列表)导出的集群的Public_IP(隧道端点)来制定隧道端点映射。例如，在隧道模式下，将在群集亚特兰大和群集新加坡之间创建一个隧道，如下所示:</p><figure class="mt mu mv mw gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi nf"><img src="../Images/9e35773f77a36406b7b0e2b418af3a74.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*R6fTzHQYaVXww9FL"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">纤毛VxLAN隧道</figcaption></figure><p id="5071" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">在其他支持的直接路由模式中，数据包被直接发送到网络。Cilium有一个<a class="ae mx" href="http://docs.cilium.io/en/stable/gettingstarted/kube-router/" rel="noopener ugc nofollow" target="_blank"> kube-router集成</a>来运行BGP路由守护进程以进行路由传播。在这种模式下，VXLAN开销被消除({SrcPodIP}{DstPodIP}{Payload})。</p><p id="0ccd" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">Cilium代理使用Public_IP和cilium_host_IP建立隧道，如下所示:</p><figure class="mt mu mv mw gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi ni"><img src="../Images/78bcd17bc601d970d673d1789344b7cf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*ZylncMC9z43nx8ai"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">纤毛——多簇隧道</figcaption></figure><figure class="mt mu mv mw gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi nj"><img src="../Images/1eb3b86b0f47e43b58f69c25b7a06072.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*ed0kNN7gY4mi5ky5"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">纤毛——多簇隧道</figcaption></figure><p id="3e7c" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">拓扑中三个集群的节点列表和端点如下所示:</p><figure class="mt mu mv mw gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi nk"><img src="../Images/629a852341bccf223d1909463770c2fa.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*-ToF4cgz2nQxWYGP"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">纤毛—隧道图</figcaption></figure><h1 id="e008" class="la lb jf bd lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx bi translated">多节点Pod-Pod数据包流</h1><p id="07c8" class="pw-post-body-paragraph kc kd jf ke b kf ly kh ki kj lz kl km kn ma kp kq kr mb kt ku kv mc kx ky kz ij bi translated">所有的pod流量在退出和进入节点之前都要通过“<em class="mr">纤毛_vxlan </em>接口。cilium_vxlan设备执行vxlan封装/解封装。</p><figure class="mt mu mv mw gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi nf"><img src="../Images/1f13d4b0d5bdb47f55371752ac97de01.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*IxOOAfCZbgMPqh4W"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">节点之间的Pod-Pod数据包流</figcaption></figure><p id="3256" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">BPF程序由Cilium代理安装，用于回复ARP请求，LXC接口MAC用于ARP回复。从群集亚特兰大(10.217.0.67)上的pod ping到群集多伦多(10.219.0.25):</p><p id="166f" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">底层主机接口上的VXLAN数据包— ens3:</p><figure class="mt mu mv mw gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi nl"><img src="../Images/e3d9609183f6c986fb2d09c16ed9b8e7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*m7vEV5BhDsl8quNP"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">底层主机接口上的Cilium-UDP数据包</figcaption></figure><p id="3d2d" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">在'<em class="mr"> cilium_vxlan </em>'接口上解包VXLAN数据包:</p><figure class="mt mu mv mw gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi nm"><img src="../Images/58672b29ea568cd15246fb2c950072e2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*zj_RRwruktM-mK-M"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">Cilium-VxLan在cilium_vxlan接口上封装/解封装</figcaption></figure><p id="d56a" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">连接到pod的根命名空间上的LXC接口回复ARP请求:</p><figure class="mt mu mv mw gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi nn"><img src="../Images/bf3f3e13c5638373e63ac38706ac4b00.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*KFvtOERHBDpu4EpK"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">LXC界面上纤毛-ARP解析</figcaption></figure><h1 id="6a9f" class="la lb jf bd lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx bi translated">使用YugaByteDB测试多集群Pod互连性</h1><p id="fe49" class="pw-post-body-paragraph kc kd jf ke b kf ly kh ki kj lz kl km kn ma kp kq kr mb kt ku kv mc kx ky kz ij bi translated"><a class="ae mx" href="https://github.com/yugabyte/yugabyte-db" rel="noopener ugc nofollow" target="_blank">yugabytdb</a>是一个分布式的符合ACID的数据库，它集合了云原生微服务的三个必备需求，即作为灵活查询语言的SQL、低延迟读取性能和全球分布式写入可扩展性。</p><p id="13d1" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">YugabyteDB使用户能够通过同步或多主复制跨区域和跨云部署。在下面的拓扑中，来自cluster-singapore和cluster-toronto的y B- server与运行在cluster-atlanta上的YB-Master连接在一起。这只是为了测试pod互连性，而不是默认/支持的部署模式。</p><figure class="mt mu mv mw gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi na"><img src="../Images/e5ad050acc03c6344ed7e295cb0dbc49.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*hWDqo276NM2xN9VF"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">拓扑示例— YugaByteDB</figcaption></figure><p id="6575" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">YugabyteDB主服务器部署在cluster-atlanta上，本地服务器位于同一个集群中:</p><figure class="mt mu mv mw gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi nc"><img src="../Images/20c9490c3d49641db27d5ae72eb5691a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*vBqLmRVIjUQOIXso"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">YugaByteDB主机—集群_亚特兰大</figcaption></figure><p id="8a09" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">YugabyteDB门户显示集群上的主服务器和本地服务器-atlanta:</p><figure class="mt mu mv mw gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi no"><img src="../Images/fa7ffdcad5854991f9f4a184b66dbdab.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*ZYocn0o-9VRiqc5y"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">YugaByteDB主机—集群_亚特兰大</figcaption></figure><figure class="mt mu mv mw gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi np"><img src="../Images/8fb2594349e5818dcb5e54c77070d86a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*y09I1xldilGjDFzP"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">YugaByteDB服务器—亚特兰大集群</figcaption></figure><p id="a216" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">yugabytdb服务器部署在cluster-singapore和cluster-toronto上，这两个服务器都配置为加入cluster-atlanta上的yugabytdb主服务器。如下所示，不同子网(10.218.0.0/24和10.219.0.0/24)中的两台服务器都有到cluster-atlanta (10.217.0.30)的出站连接。</p><figure class="mt mu mv mw gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi nc"><img src="../Images/1e6bfb08d540352830514c4600e73c5b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*V_1So3Cu45rTrelT"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">YugaByteDB服务器—新加坡群集和多伦多群集</figcaption></figure><p id="7398" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">YugabyteDB门户显示了来自不同Kubernetes集群的集群中的另外两个活动服务器:</p><figure class="mt mu mv mw gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi nq"><img src="../Images/5749bfb3752cc357640f70148983bb90.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*-p2SwEEUpE9Pbqek"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">YugaByteDB服务器—集群_新加坡</figcaption></figure><figure class="mt mu mv mw gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi nr"><img src="../Images/9f2408b3fb2ee4571820898c66b918b0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*N3rYiTx0VNoCBPUY"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">YugaByteDB服务器—群集_多伦多</figcaption></figure><h1 id="e390" class="la lb jf bd lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx bi translated">多集群网络策略—限制集群之间的Pod-Pod通信</h1><p id="9f27" class="pw-post-body-paragraph kc kd jf ke b kf ly kh ki kj lz kl km kn ma kp kq kr mb kt ku kv mc kx ky kz ij bi translated">在每台主机上运行的Cilium代理不是管理IP表，而是将网络策略定义转换为BPF程序，这些程序加载到内核中并连接到容器的虚拟以太网设备。这些程序在每个发送或接收的数据包上执行。</p><p id="18d6" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">在具有集群网格的多集群环境中，集群名称通过标签'<em class="mr">io . cilium . k8s . policy . cluster</em>公开，可用于将策略限制到特定集群。</p><p id="b289" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">允许从cluster-atlanta上的YB-Master到cluster-singapore和cluster-toronto上的y b-server的入站和出站流量。</p><p id="661c" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">出口允许规则匹配标签:应用和群集:群集名称:</p><figure class="mt mu mv mw gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi nc"><img src="../Images/5dcf172060c25a2f59fa20c954e65c84.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*7fV6oIe9iYXyJDVk"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">Cilium —网络策略—允许集群之间的出口</figcaption></figure><p id="8a3c" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">入口允许规则匹配标签:应用和群集:群集名称:</p><figure class="mt mu mv mw gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi nc"><img src="../Images/38771de30b1a5e1f1c70b881b1c3c94e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*rV3o1oSvy020mLpR"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">Cilium —网络策略—集群之间允许的入口</figcaption></figure><figure class="mt mu mv mw gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi ns"><img src="../Images/f371f02f6f5c5c96cea09572986ce729.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*iX6i5Qz7ew3KENZU"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">纤毛—哈勃界面</figcaption></figure><p id="fd16" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">拒绝来自cluster-singapore上YB-Server的所有出口，这将导致主节点上的健康检查失败，从而将服务器节点标记为死节点，如下所示:</p><figure class="mt mu mv mw gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi nc"><img src="../Images/d6126e80c77fff40e2fc4477ef1a2f16.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*dqAtweY0WK7mZtat"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">Cilium —网络策略出口拒绝集群新加坡</figcaption></figure><figure class="mt mu mv mw gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi nc"><img src="../Images/22c5f0d54959dcb7fd970c52efcb30b3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*3cEPlwstoWip4G19"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">Cilium —网络策略出口拒绝集群新加坡</figcaption></figure><p id="f6de" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">Cilium 1.7提供了集群范围的CNP，可以在集群级别实施策略。借助最新的Hubble，用户可以使用多个过滤器可视化流的粒度信息，还可以通过添加注释获得L7可见性，从而消除为每个选定端点创建完整策略的负担。</p><figure class="mt mu mv mw gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi nc"><img src="../Images/0c2fbba070c321cdaa5aa8087fdc46a2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*Yt4VJPdX1iZT0w-P"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">纤毛——哈勃界面可视化</figcaption></figure><figure class="mt mu mv mw gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi nc"><img src="../Images/6854fabea29e73ff79380d45c346d721.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*3OGndacG3F6KYros"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">纤毛——哈勃度量</figcaption></figure><p id="bdab" class="pw-post-body-paragraph kc kd jf ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">集群网格可以有效地处理各种用例，如高可用性:集群级负载平衡、共享服务:一组服务，如监控、日志记录等。可以在多个集群之间共享，等等。整体Cilium Cluster Mesh可以大大降低每个租户运行单个集群的操作复杂性，或者为不同类别的服务构建集群并实现它们之间的互连。</p></div></div>    
</body>
</html>