<html>
<head>
<title>Goto Hell With Labels in Golang</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">让戈朗的标签见鬼去吧</h1>
<blockquote>原文：<a href="https://itnext.io/goto-hell-with-labels-in-golang-7f59a47ead8d?source=collection_archive---------1-----------------------#2021-08-19">https://itnext.io/goto-hell-with-labels-in-golang-7f59a47ead8d?source=collection_archive---------1-----------------------#2021-08-19</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="6474" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">Goto经常被人诟病，但是标准库使用它们，我们能使用它们吗，它们有那么差吗？让我们探索和看看</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/93c053bcbb321e64baddfe6d0b09da67.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ypSTZphCWo1YDv6ATENWPg.jpeg"/></div></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">由<a class="ae ky" href="https://unsplash.com/@jeswinthomas?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">杰斯温·托马斯</a>在<a class="ae ky" href="https://unsplash.com/s/photos/technology?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</figcaption></figure><p id="98b5" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">许多编程语言都有某种<code class="fe lv lw lx ly b">goto</code>语句。如果你不熟悉<code class="fe lv lw lx ly b">goto</code>，它是一种将代码跳转到某个位置的方式。它可以用来控制执行流程。开发人员社区通常非常讨厌这种说法，因为它会导致难以遵循的代码。我一直很喜欢<code class="fe lv lw lx ly b">goto</code>语句，我开始怀疑，它是不是用在了围棋的标准库中，并决定深入研究一下。</p><p id="3e1e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我见过很多不知道<code class="fe lv lw lx ly b">goto</code>存在的围棋开发者。然而它确实如此，而且在标准库中使用得相当多。在标准库中进行简单的搜索就会发现，如果我们跳过注释和非Go文件，在98个不同的文件中<strong class="lb iu">使用了<code class="fe lv lw lx ly b">goto</code>语句493次。我们将在文章的后面看到其中的一些，让我们先了解一下这个语句是如何工作的。</strong></p><h2 id="fca1" class="lz ma it bd mb mc md dn me mf mg dp mh li mi mj mk lm ml mm mn lq mo mp mq mr bi translated">Go中的Goto语句</h2><p id="6204" class="pw-post-body-paragraph kz la it lb b lc ms ju le lf mt jx lh li mu lk ll lm mv lo lp lq mw ls lt lu im bi translated">它的工作方式是你可以写下一个<code class="fe lv lw lx ly b">label</code>，这是一个自定义的关键字，可以被<code class="fe lv lw lx ly b">goto</code>语句识别。<code class="fe lv lw lx ly b">label</code>是一个字符串，通过在标签后设置分号来创建。</p><pre class="kj kk kl km gt mx ly my mz aw na bi"><span id="59a7" class="lz ma it ly b gy nb nc l nd ne">// Go code<br/>label: <br/>    // Code to execute in label</span></pre><p id="e273" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">Go在实现上有一些安全性，因为必须在与<code class="fe lv lw lx ly b">goto</code>语句相同的函数中创建一个<code class="fe lv lw lx ly b">label</code>。必须使用一个<code class="fe lv lw lx ly b">label</code>,编译器会为你捕捉这个。如果你在<code class="fe lv lw lx ly b">label</code>之后创建一个变量，情况也是如此，在<code class="fe lv lw lx ly b">label</code>中使用的所有变量都必须在作用域中提前定义。</p><p id="057c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">理解它的最好方法可能是看它，这里有一个超级简单的例子，展示了如何设置一个标签，然后跳转到它，跳过中间的任何代码。我们将创建一个执行10次的<code class="fe lv lw lx ly b">for</code>循环，但是当<code class="fe lv lw lx ly b">i</code>等于5时，我们将使用一个<code class="fe lv lw lx ly b">goto</code>来中断执行。注意<code class="fe lv lw lx ly b">label</code>必须在同一个函数中创建，否则编译器会失败。同样，如果不使用<code class="fe lv lw lx ly b">label</code>，编译器将再次失败。在示例中，我将<code class="fe lv lw lx ly b">label</code>命名为<code class="fe lv lw lx ly b">exit</code>。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nf ng l"/></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">main.go使用goto语句中断for循环。<a class="ae ky" href="https://play.golang.org/p/4lYpK9xGyux" rel="noopener ugc nofollow" target="_blank">尝试一下</a></figcaption></figure><p id="755b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">就是这样！没有别的魔法，就是这么简单。请记住，您不能跳转到同一函数之外的标签。这是一个很好的安全措施，消除了很多困惑。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nf ng l"/></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">尝试转到范围外的标签会崩溃— <a class="ae ky" href="https://play.golang.org/p/9TMlt_90g8D" rel="noopener ugc nofollow" target="_blank">在此尝试</a>。</figcaption></figure><p id="4cac" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">需要注意的是，如果您的常规代码流遍历到标签中而没有返回，标签将被执行。如果在一个函数的末尾有多个标签，就会发生这种情况。</p><p id="9124" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我将添加一条<code class="fe lv lw lx ly b">if</code>语句来展示这一点，如果<code class="fe lv lw lx ly b">I</code>计数器变为6，它将打印出来。<code class="fe lv lw lx ly b">I</code>永远不会变成6因为当它是5的时候我们会跳出<code class="fe lv lw lx ly b">for</code>的循环，所以我们永远不会触发第二个标签，对吗？我第一次使用标签时，我以为它会这样工作，但它会运行第一个标签下的任何东西，就像正常的代码执行流。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nf ng l"/></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">确保不要落入多标签执行陷阱— <a class="ae ky" href="https://play.golang.org/p/psorRjkFdy6" rel="noopener ugc nofollow" target="_blank">在此尝试</a></figcaption></figure><h2 id="d060" class="lz ma it bd mb mc md dn me mf mg dp mh li mi mj mk lm ml mm mn lq mo mp mq mr bi translated">转到标准库中</h2><p id="0e74" class="pw-post-body-paragraph kz la it lb b lc ms ju le lf mt jx lh li mu lk ll lm mv lo lp lq mw ls lt lu im bi translated">让我们探索一下<code class="fe lv lw lx ly b">goto</code>语句是如何在标准库中使用的，这样我们就可以更好地掌握它的用法。我将假设std库被认为是很好的用法。</p><p id="efa1" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我发现的一个很好的例子是<code class="fe lv lw lx ly b">go/scanner</code>，它是一个用于扫描Go源代码的包。扫描文本文件可能是一项非常艰巨的任务，尤其是在你不知道里面有什么的情况下。通常使用一种叫做<a class="ae ky" href="https://en.wikipedia.org/wiki/Lexical_analysis" rel="noopener ugc nofollow" target="_blank">词法分析</a>的技术。我不会描述确切的内部工作方式，但是您可以创建称为标记的字符串，用于标识文本的当前位置。想象一下，你自己写一个文本扫描器来读取源代码并自己验证它，这不是一个简单的任务。</p><p id="0319" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们将要看的相当基础的部分是Go团队扫描源代码中的注释的部分。这个函数是<code class="fe lv lw lx ly b">scanComment</code>，包含一个名为exit的<code class="fe lv lw lx ly b">label</code>，就像我们之前使用的例子一样。</p><p id="eadc" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">为了让代码更容易理解，我想给出一些背景。<code class="fe lv lw lx ly b">s.ch</code>是当前被解析的字符。<code class="fe lv lw lx ly b">s.next()</code>将下一个Unicode字符读入<code class="fe lv lw lx ly b">s.ch</code>，当它是常规注释时，第一个<code class="fe lv lw lx ly b">if</code>处有一个<code class="fe lv lw lx ly b">goto</code>，当它是多行注释时，另一个<code class="fe lv lw lx ly b">goto</code>。这是一个很好的例子，说明了如何跳过代码块而不使用多个标志来控制状态。他们可以不使用<code class="fe lv lw lx ly b">goto</code>而是使用一些布尔函数，比如<code class="fe lv lw lx ly b">isSingleLineComment</code>，如果这是真的，那么就跳过多行解析。但是他们避免了很多复杂的流程逻辑，而是使用了一个简单的<code class="fe lv lw lx ly b">goto</code>，我喜欢这个解决方案。</p><p id="bf8a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">第二个<code class="fe lv lw lx ly b">goto</code>在解析多行注释时使用。在其中，他们不断迭代，直到找到一个标记为<code class="fe lv lw lx ly b">*/</code>的注释闭包。这是一个循环，如果没有出现结束，它将一直运行到文件的末尾。当条件满足时，他们不使用<code class="fe lv lw lx ly b">break</code>来取消<code class="fe lv lw lx ly b">for</code>循环，而是使用<code class="fe lv lw lx ly b">goto</code>来控制流量。它们也绕过用于设置发现错误的<code class="fe lv lw lx ly b">s.error</code>。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nf ng l"/></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">go/scanner.scanComments —使用goto跳过状态标志的标准库示例</figcaption></figure><p id="9420" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">使用的第二个例子在<code class="fe lv lw lx ly b">exprInternal</code>函数的<code class="fe lv lw lx ly b">go/types</code>中，该函数用于核心转到类型检查。这是一个很好的例子，当我们有一个<code class="fe lv lw lx ly b">switch</code>需要检查许多条件并且变得有点太大的时候。他们照常使用<code class="fe lv lw lx ly b">continue</code>和<code class="fe lv lw lx ly b">break</code>来管理流程，但是他们也使用<code class="fe lv lw lx ly b">goto</code>来标准化错误处理和避免重复代码。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nf ng l"/></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk translated">go/types/expr . go-使用goto进行标准化错误处理的示例</figcaption></figure><h2 id="ad27" class="lz ma it bd mb mc md dn me mf mg dp mh li mi mj mk lm ml mm mn lq mo mp mq mr bi translated">在Go中何时使用goto</h2><p id="f853" class="pw-post-body-paragraph kz la it lb b lc ms ju le lf mt jx lh li mu lk ll lm mv lo lp lq mw ls lt lu im bi translated">利用我们从标准库中获得的经验，我们可以看到用法有时是有意义的。考虑到Go只允许在同一个函数中使用标签，我认为这不会让代码难以理解。</p><p id="8feb" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我会使用它的场合是当常规的流量控制机制无法在不变得复杂的情况下削减它时，这里是一些案例的要点。</p><ul class=""><li id="c68a" class="nh ni it lb b lc ld lf lg li nj lm nk lq nl lu nm nn no np bi translated">避免像<code class="fe lv lw lx ly b">go/scanner</code>中那样存储状态和跳过代码块的条件标志</li><li id="1a5d" class="nh ni it lb b lc nq lf nr li ns lm nt lq nu lu nm nn no np bi translated">标准化退出计划，以防你有一个<code class="fe lv lw lx ly b">switch</code>或多个<code class="fe lv lw lx ly b">for</code>循环，都可能导致相同的标准退出，如<code class="fe lv lw lx ly b">go/types/expr</code></li><li id="2515" class="nh ni it lb b lc nq lf nr li ns lm nt lq nu lu nm nn no np bi translated">通过使用<code class="fe lv lw lx ly b">goto</code>避免嵌套循环，需要嵌套<code class="fe lv lw lx ly b">for</code>循环的复杂逻辑可以变得更容易阅读和理解</li><li id="405b" class="nh ni it lb b lc nq lf nr li ns lm nt lq nu lu nm nn no np bi translated">如<code class="fe lv lw lx ly b">go/types/expr</code>中的<code class="fe lv lw lx ly b">Error</code>标签一样，通过处理标签中的公共模式来避免重复代码</li></ul></div><div class="ab cl nv nw hx nx" role="separator"><span class="ny bw bk nz oa ob"/><span class="ny bw bk nz oa ob"/><span class="ny bw bk nz oa"/></div><div class="im in io ip iq"><p id="434e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">你对<code class="fe lv lw lx ly b">goto</code>的说法有什么看法？你认为它增加了复杂性和混乱，还是你认为它是处理流程的一个好的解决方案？</p><p id="9543" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">本文到此为止，感谢您的阅读。和往常一样，我很欣赏反馈，或者只是接触，如果你有问题。你可以在medium <a class="ae ky" href="https://twitter.com/percybolmer" rel="noopener ugc nofollow" target="_blank"> twitter </a>或<a class="ae ky" href="https://www.linkedin.com/in/percy-bolmer-bb223b122/" rel="noopener ugc nofollow" target="_blank"> linkedin </a>找到我。</p><p id="767b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果你喜欢我的作品，请随时关注我。我最近在Go中写了关于结构化日志的文章。</p><div class="oc od gp gr oe of"><a href="https://betterprogramming.pub/how-to-use-structured-json-logging-in-golang-applications-7fc5e2751dbd" rel="noopener  ugc nofollow" target="_blank"><div class="og ab fo"><div class="oh ab oi cl cj oj"><h2 class="bd iu gy z fp ok fr fs ol fu fw is bi translated">如何在Golang应用程序中使用结构化JSON日志记录</h2><div class="om l"><h3 class="bd b gy z fp ok fr fs ol fu fw dk translated">结构化日志对于软件调试非常重要。很高兴，在Golang中实现起来非常容易</h3></div></div><div class="on l"><div class="oo l op oq or on os ks of"/></div></div></a></div><div class="oc od gp gr oe of"><a href="https://percybolmer.medium.com/membership" rel="noopener follow" target="_blank"><div class="og ab fo"><div class="oh ab oi cl cj oj"><h2 class="bd iu gy z fp ok fr fs ol fu fw is bi translated">阅读珀西·博尔默(以及媒体上成千上万的其他作家)的每一个故事</h2><div class="om l"><h3 class="bd b gy z fp ok fr fs ol fu fw dk translated">作为一个媒体会员，你的会员费的一部分会给你阅读的作家，你可以完全接触到每一个故事…</h3></div><div class="ot l"><p class="bd b dl z fp ok fr fs ol fu fw dk translated">percybolmer.medium.com</p></div></div><div class="on l"><div class="ou l op oq or on os ks of"/></div></div></a></div></div></div>    
</body>
</html>