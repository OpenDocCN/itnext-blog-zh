<html>
<head>
<title>Building your own kubernetes CRDs</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">构建您自己的kubernetes CRDs</h1>
<blockquote>原文：<a href="https://itnext.io/building-your-own-kubernetes-crds-701de1c9a161?source=collection_archive---------0-----------------------#2019-07-05">https://itnext.io/building-your-own-kubernetes-crds-701de1c9a161?source=collection_archive---------0-----------------------#2019-07-05</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><p id="4e33" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">分享关于构建我自己的kubernetes CRDs的知识。我将使用我的<a class="ae ko" href="https://gitlab.com/pongsatt/githook" rel="noopener ugc nofollow" target="_blank"> Githook </a>例子来解释我用来开发CRDs的步骤。我在来自GIT webhook 的<a class="ae ko" href="https://medium.com/@pongsatt/build-cloud-native-ci-cd-build-pipeline-from-git-webhook-9cd9a57a32e1" rel="noopener">Build cloud native CI/CD Build pipeline中解释了我创建这个CRDs的原因。</a></p><h2 id="9c42" class="kp kq it bd kr ks kt dn ku kv kw dp kx kb ky kz la kf lb lc ld kj le lf lg lh bi translated">注意:</h2><blockquote class="li lj lk"><p id="b419" class="jq jr ll js b jt ju jv jw jx jy jz ka lm kc kd ke ln kg kh ki lo kk kl km kn im bi translated">这篇文章是为初学者写的，他需要学习如何建立CRD库本内特公司</p><p id="c4b5" class="jq jr ll js b jt ju jv jw jx jy jz ka lm kc kd ke ln kg kh ki lo kk kl km kn im bi translated">目标是了解制作CRD的步骤。您可能无法一步一步地遵循它，因为它有一些依赖项，如安装了knative</p></blockquote><h1 id="565d" class="lp kq it bd kr lq lr ls ku lt lu lv kx lw lx ly la lz ma mb ld mc md me lg mf bi translated">您将学到的内容:</h1><ul class=""><li id="db62" class="mg mh it js b jt mi jx mj kb mk kf ml kj mm kn mn mo mp mq bi translated">Kubernetes CRDs概念</li><li id="3b5a" class="mg mh it js b jt mr jx ms kb mt kf mu kj mv kn mn mo mp mq bi translated">如何使用kubebuilder和golang构建kubernetes CRD</li></ul><h1 id="bc37" class="lp kq it bd kr lq lr ls ku lt lu lv kx lw lx ly la lz ma mb ld mc md me lg mf bi translated">为什么我需要CRD？</h1><p id="8689" class="pw-post-body-paragraph jq jr it js b jt mi jv jw jx mj jz ka kb mw kd ke kf mx kh ki kj my kl km kn im bi translated">CRD代表自定义资源定义。这是一种创建自己的kubernetes资源的方法，其工作方式与Kubernetes资源(如Pod或Deployment)相同。通过自定义资源，您可以将如何管理资源的知识放入kubernetes集群，这是非常强大的。</p><p id="a83a" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">例如，<a class="ae ko" href="https://strimzi.io/" rel="noopener ugc nofollow" target="_blank"> Strimzi </a>是一个kubernetes CRD来管理和运行kubernetes上的kafka集群。它通过将管理kafka集群的知识放入CRD控制器本身，消除了运行您自己的kafka集群的许多问题。</p><figure class="na nb nc nd gt ne gh gi paragraph-image"><div role="button" tabindex="0" class="nf ng di nh bf ni"><div class="gh gi mz"><img src="../Images/fc2d6fc487a3d6f6e9b9125d969ccc0d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*1HdQc8st8vYA33ZwwYA7fA.png"/></div></div><figcaption class="nl nm gj gh gi nn no bd b be z dk translated">CRDs控制器调节回路</figcaption></figure><p id="6cca" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">您需要一个控制器(在集群上运行的容器中)来管理您的CRD资源。控制器将在循环中运行，以检查CRD中描述的(期望的)状态是否与现实世界中的实际状态相匹配。例如，您希望容器A和B在集群上运行。如果A或B不运行，控制器将为您创建它。</p><p id="f442" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">这是一种健壮的方式来管理你想要的东西，在一个有弹性的、灵活的分布式环境中。</p><h1 id="6e32" class="lp kq it bd kr lq lr ls ku lt lu lv kx lw lx ly la lz ma mb ld mc md me lg mf bi translated">Githook示例</h1><p id="7d28" class="pw-post-body-paragraph jq jr it js b jt mi jv jw jx mj jz ka kb mw kd ke kf mx kh ki kj my kl km kn im bi translated">这个CRD叫做“GitHook”。它定义了git webhook事件和一个构建管道。GitHook控制器将webhook事件订阅到git repo，当事件发生时，它将运行CRD中定义的构建管道。</p><figure class="na nb nc nd gt ne gh gi paragraph-image"><div role="button" tabindex="0" class="nf ng di nh bf ni"><div class="gh gi np"><img src="../Images/b399f610464f851c3d8933c7eb7a9f3a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*PTT5VXpyYHu1SQxXcULqhg.png"/></div></div><figcaption class="nl nm gj gh gi nn no bd b be z dk translated">“git hook”CRD如何工作</figcaption></figure><p id="3303" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">GitHook CRD管制员的工作是:</p><ol class=""><li id="12a0" class="mg mh it js b jt ju jx jy kb nq kf nr kj ns kn nt mo mp mq bi translated">请确保使用不正确的信息将webhook注册到git repo。</li><li id="9203" class="mg mh it js b jt mr jx ms kb mt kf mu kj mv kn nt mo mp mq bi translated">确保有服务正在运行，并等待webhook事件。我们使用Knative服务来接收webhook，因为它易于实现，且在不使用时可以扩展到0。</li></ol><h1 id="a61c" class="lp kq it bd kr lq lr ls ku lt lu lv kx lw lx ly la lz ma mb ld mc md me lg mf bi translated">使用kubebuilder构建CRD</h1><h1 id="8291" class="lp kq it bd kr lq lr ls ku lt lu lv kx lw lx ly la lz ma mb ld mc md me lg mf bi translated"><em class="nu"> 1。设置</em></h1><h2 id="fa40" class="kp kq it bd kr ks kt dn ku kv kw dp kx kb ky kz la kf lb lc ld kj le lf lg lh bi translated"><strong class="ak">安装kubebuilder和kustomize </strong></h2><p id="04dd" class="pw-post-body-paragraph jq jr it js b jt mi jv jw jx mj jz ka kb mw kd ke kf mx kh ki kj my kl km kn im bi translated"><strong class="js iu"> <em class="ll"> kubebuilder </em> </strong>是一款帮助你快速入门kubernetes CRDs的工具。您只需要定义您的自定义类型和控制器逻辑。<a class="ae ko" href="https://book.kubebuilder.io" rel="noopener ugc nofollow" target="_blank">阅读更多</a>。</p><p id="624f" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">kustomize  是一个工具，kubebuilder用它来产生一个yaml，你的CRD需要它来处理kubernetes</p><p id="367b" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">请在此处遵循安装步骤<a class="ae ko" href="https://book.kubebuilder.io/quick-start.html" rel="noopener ugc nofollow" target="_blank">。</a></p><h2 id="53e6" class="kp kq it bd kr ks kt dn ku kv kw dp kx kb ky kz la kf lb lc ld kj le lf lg lh bi translated"><strong class="ak">初始项目</strong></h2><p id="acde" class="pw-post-body-paragraph jq jr it js b jt mi jv jw jx mj jz ka kb mw kd ke kf mx kh ki kj my kl km kn im bi translated">我们将创建一个带有模块支持的名为“githook-tutorial”的go项目，因此它需要go版本1.11+并且文件夹必须在GOPATH之外。</p><pre class="na nb nc nd gt nv nw nx ny aw nz bi"><span id="e700" class="kp kq it nw b gy oa ob l oc od">mkdir githook-tutorial<br/>cd githook-tutorial</span><span id="7ba4" class="kp kq it nw b gy oe ob l oc od">go mod init <strong class="nw iu">gitlab.com/pongsatt/githook</strong></span><span id="b040" class="kp kq it nw b gy oe ob l oc od">kubebuilder init --domain <strong class="nw iu">my.domain</strong></span></pre><p id="ef96" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">”<strong class="js iu">gitlab.com/pongsatt/githook"</strong>是围棋模块名。如果更改为其他内容，则需要替换示例代码中的导入路径。</p><p id="dfcb" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">“<strong class="js iu"> my.domain </strong>”将是您的资源的API路径。您可以根据需要进行更改</p><h2 id="3904" class="kp kq it bd kr ks kt dn ku kv kw dp kx kb ky kz la kf lb lc ld kj le lf lg lh bi translated">创建您的自定义资源</h2><p id="99c4" class="pw-post-body-paragraph jq jr it js b jt mi jv jw jx mj jz ka kb mw kd ke kf mx kh ki kj my kl km kn im bi translated">这一步是告诉kubebuilder你需要哪种资源。我们将在名为“工具”的组中创建一个名为“<strong class="js iu"> GitHook </strong>的资源。</p><pre class="na nb nc nd gt nv nw nx ny aw nz bi"><span id="ee03" class="kp kq it nw b gy oa ob l oc od">kubebuilder create api --group tools --version v1alpha1 --kind GitHook</span></pre><p id="b60c" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">完成后，你应该会看到。</p><figure class="na nb nc nd gt ne gh gi paragraph-image"><div class="gh gi of"><img src="../Images/6d4dba4fc904d860d172b04b4d4ca2f5.png" data-original-src="https://miro.medium.com/v2/resize:fit:884/format:webp/1*qZWsZCvJbw4b0cMkWAWEuA.png"/></div><figcaption class="nl nm gj gh gi nn no bd b be z dk translated">kubebuilder生成的文件和文件夹</figcaption></figure><p id="f616" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><strong class="js iu">有趣的路径:</strong></p><p id="7a77" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><strong class="js iu"><em class="ll">API/</em></strong><em class="ll"/>:包含你在go中的资源信息。您将在此编辑您的资源类型</p><p id="c555" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><strong class="js iu"> <em class="ll"> config/ </em> </strong>:包含运行控制器所需的所有kubernetes yaml文件</p><p id="0055" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><strong class="js iu"> <em class="ll"> Makefile </em> </strong>:包含构建和部署您的CRD所需的所有脚本</p><h1 id="c3c6" class="lp kq it bd kr lq lr ls ku lt lu lv kx lw lx ly la lz ma mb ld mc md me lg mf bi translated">2.定义资源类型</h1><p id="1715" class="pw-post-body-paragraph jq jr it js b jt mi jv jw jx mj jz ka kb mw kd ke kf mx kh ki kj my kl km kn im bi translated">编辑“api/v1alpha1/githook_types.go”以包含我们的自定义类型。</p><p id="e776" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">完整代码见<a class="ae ko" href="https://gitlab.com/pongsatt/githook/blob/master/api/v1alpha1/githook_types.go" rel="noopener ugc nofollow" target="_blank"> githook_types.go </a>。</p><h2 id="12fa" class="kp kq it bd kr ks kt dn ku kv kw dp kx kb ky kz la kf lb lc ld kj le lf lg lh bi translated">关键注意事项:</h2><p id="1f37" class="pw-post-body-paragraph jq jr it js b jt mi jv jw jx mj jz ka kb mw kd ke kf mx kh ki kj my kl km kn im bi translated">如果我们需要在通过yaml创建资源时验证我们的类型，我们需要在该类型上添加注释。比如我们需要你的gitProvider是gitlab，github或者gogs。</p><pre class="na nb nc nd gt nv nw nx ny aw nz bi"><span id="7aef" class="kp kq it nw b gy oa ob l oc od">// +kubebuilder:validation:Enum=gitlab;github;gogs<br/><br/>// GitProvider providers name of git provider<br/>type GitProvider string</span></pre><p id="22c3" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">下一步是通过运行以下命令生成实用函数，如deepcopy:</p><pre class="na nb nc nd gt nv nw nx ny aw nz bi"><span id="73e1" class="kp kq it nw b gy oa ob l oc od">make generate</span></pre><h1 id="4a99" class="lp kq it bd kr lq lr ls ku lt lu lv kx lw lx ly la lz ma mb ld mc md me lg mf bi translated">3.机具控制器</h1><p id="e2f0" class="pw-post-body-paragraph jq jr it js b jt mi jv jw jx mj jz ka kb mw kd ke kf mx kh ki kj my kl km kn im bi translated">在这一点上，我们已经有了自定义类型，可以被我们的控制器使用了。</p><h2 id="caaf" class="kp kq it bd kr ks kt dn ku kv kw dp kx kb ky kz la kf lb lc ld kj le lf lg lh bi translated">控制器的工作原理:</h2><p id="25b8" class="pw-post-body-paragraph jq jr it js b jt mi jv jw jx mj jz ka kb mw kd ke kf mx kh ki kj my kl km kn im bi translated">我们名为“GitHookReconciler”的控制器有一个“Reconcile”方法，每次创建、更新或删除“GitHook”资源时都会调用该方法。它将使用队列依次处理每个事件。当错误发生时，我们将返回错误状态，因此当前事件将被重新排队并等待稍后处理。</p><p id="c10b" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">我们的控制器将控制另外两个资源:</p><ol class=""><li id="741a" class="mg mh it js b jt ju jx jy kb nq kf nr kj ns kn nt mo mp mq bi translated">Knative服务(能够在发生git事件时处理这些事件)。</li><li id="d219" class="mg mh it js b jt mr jx ms kb mt kf mu kj mv kn nt mo mp mq bi translated">Git webhook(能够接收Git事件)。</li></ol><p id="0303" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><strong class="js iu">创建/更新逻辑:</strong></p><ul class=""><li id="f76d" class="mg mh it js b jt ju jx jy kb nq kf nr kj ns kn mn mo mp mq bi translated">使用提供的k8s客户端按名称获取GitHook信息。</li></ul><pre class="na nb nc nd gt nv nw nx ny aw nz bi"><span id="9f58" class="kp kq it nw b gy oa ob l oc od">// Reconcile main reconcile logic</span><span id="b52b" class="kp kq it nw b gy oe ob l oc od">func (r *GitHookReconciler) <strong class="nw iu">Reconcile</strong>(req ctrl.Request) (ctrl.Result, error) {</span><span id="10bb" class="kp kq it nw b gy oe ob l oc od">...<br/></span><span id="6848" class="kp kq it nw b gy oe ob l oc od">err := <strong class="nw iu">r.Get(context.Background(), req.NamespacedName, sourceOrg)</strong></span><span id="9f32" class="kp kq it nw b gy oe ob l oc od"><br/>...</span></pre><ul class=""><li id="93ae" class="mg mh it js b jt ju jx jy kb nq kf nr kj ns kn mn mo mp mq bi translated">获取由此资源创建的Knative服务。如果不存在，请创建新的。如果存在但信息更新，则更新它。</li></ul><pre class="na nb nc nd gt nv nw nx ny aw nz bi"><span id="1db1" class="kp kq it nw b gy oa ob l oc od">func (r *GitHookReconciler) <strong class="nw iu">reconcile</strong>(source *v1alpha1.GitHook) error {</span><span id="bdff" class="kp kq it nw b gy oe ob l oc od"><br/>...</span><span id="3361" class="kp kq it nw b gy oe ob l oc od">ksvc, err := <strong class="nw iu">r.reconcileWebhookService(source)</strong></span><span id="f3cc" class="kp kq it nw b gy oe ob l oc od">...</span></pre><ul class=""><li id="be7b" class="mg mh it js b jt ju jx jy kb nq kf nr kj ns kn mn mo mp mq bi translated">使用上一步给出的服务URL注册git webhook，并将返回的ID保存在GitHook资源中。</li></ul><pre class="na nb nc nd gt nv nw nx ny aw nz bi"><span id="f00f" class="kp kq it nw b gy oa ob l oc od">func (r *GitHookReconciler) <strong class="nw iu">reconcile</strong>(source *v1alpha1.GitHook) error {</span><span id="bbc2" class="kp kq it nw b gy oe ob l oc od">...</span><span id="0b21" class="kp kq it nw b gy oe ob l oc od">hookID, err := r.reconcileWebhook(source, hookOptions)</span><span id="9b3e" class="kp kq it nw b gy oe ob l oc od">...</span></pre><ul class=""><li id="aec6" class="mg mh it js b jt ju jx jy kb nq kf nr kj ns kn mn mo mp mq bi translated">用最新信息更新当前GitHook资源</li></ul><pre class="na nb nc nd gt nv nw nx ny aw nz bi"><span id="2644" class="kp kq it nw b gy oa ob l oc od">// Reconcile main reconcile logic</span><span id="bf1e" class="kp kq it nw b gy oe ob l oc od">func (r *GitHookReconciler) <strong class="nw iu">Reconcile</strong>(req ctrl.Request) (ctrl.Result, error) {</span><span id="1a02" class="kp kq it nw b gy oe ob l oc od">...</span><span id="db7b" class="kp kq it nw b gy oe ob l oc od">if err := <strong class="nw iu">r.Update(context.Background(), source)</strong>; err != nil {</span><span id="0ee2" class="kp kq it nw b gy oe ob l oc od">    ....</span><span id="1a5b" class="kp kq it nw b gy oe ob l oc od">}</span><span id="f258" class="kp kq it nw b gy oe ob l oc od">...</span></pre><p id="d99f" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><strong class="js iu">删除逻辑:</strong></p><p id="1c07" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">当GitHook资源被删除时，我们通过检查字段“DeletionTimestamp”不为零来检测这一点。然后，我们将通过调用finalize方法删除我们的依赖资源，在本例中是knative service和git webhook。</p><pre class="na nb nc nd gt nv nw nx ny aw nz bi"><span id="0744" class="kp kq it nw b gy oa ob l oc od">// Reconcile main reconcile logic</span><span id="b75c" class="kp kq it nw b gy oe ob l oc od">func (r *GitHookReconciler) <strong class="nw iu">Reconcile</strong>(req ctrl.Request) (ctrl.Result, error) {</span><span id="9bcc" class="kp kq it nw b gy oe ob l oc od">...</span><span id="46e3" class="kp kq it nw b gy oe ob l oc od"><strong class="nw iu">if sourceOrg.ObjectMeta.DeletionTimestamp == nil {</strong></span><span id="2c8d" class="kp kq it nw b gy oe ob l oc od">    ...</span><span id="bb6d" class="kp kq it nw b gy oe ob l oc od">} else {</span><span id="752c" class="kp kq it nw b gy oe ob l oc od">    if r.hasFinalizer(source.(*v1alpha1.GitHook).Finalizers) {</span><span id="b15d" class="kp kq it nw b gy oe ob l oc od">        <strong class="nw iu">reconcileErr = r.finalize(source.(*v1alpha1.GitHook))</strong></span><span id="f510" class="kp kq it nw b gy oe ob l oc od">    }</span><span id="2975" class="kp kq it nw b gy oe ob l oc od">}</span><span id="af07" class="kp kq it nw b gy oe ob l oc od">...</span></pre><p id="234d" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">如果我们不能删除knative服务或git webhook，我们不会通过不从GitHook资源中删除终结器信息来允许我们的GitHook被删除。</p><pre class="na nb nc nd gt nv nw nx ny aw nz bi"><span id="7fbe" class="kp kq it nw b gy oa ob l oc od">func (r *GitHookReconciler) finalize(source *v1alpha1.GitHook) error {</span><span id="1a0e" class="kp kq it nw b gy oe ob l oc od">    ...</span><span id="8dbc" class="kp kq it nw b gy oe ob l oc od"><strong class="nw iu">    r.removeFinalizer(source)</strong><br/>}</span></pre><h2 id="402d" class="kp kq it bd kr ks kt dn ku kv kw dp kx kb ky kz la kf lb lc ld kj le lf lg lh bi translated">代码:</h2><p id="b6e5" class="pw-post-body-paragraph jq jr it js b jt mi jv jw jx mj jz ka kb mw kd ke kf mx kh ki kj my kl km kn im bi translated">编辑文件“控制器/githook_controller.go”</p><p id="c1a7" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">请看完整代码<a class="ae ko" href="https://gitlab.com/pongsatt/githook/blob/master/controllers/githook_controller.go" rel="noopener ugc nofollow" target="_blank"> githook_controller.go </a>。</p><p id="29f0" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><strong class="js iu">重点提示:</strong></p><p id="73d9" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">我们的控制器需要权限来获取、列出、创建和更新另一个kubernetes资源。我们需要为kubebuilder添加注释批注，以便为我们生成权限yaml。</p><pre class="na nb nc nd gt nv nw nx ny aw nz bi"><span id="8ff9" class="kp kq it nw b gy oa ob l oc od">// +kubebuilder:rbac:groups=tools.pongzt.com,resources=githooks,verbs=get;list;watch;create;update;patch;delete</span><span id="bd0a" class="kp kq it nw b gy oe ob l oc od">...</span><span id="20aa" class="kp kq it nw b gy oe ob l oc od">// Reconcile main reconcile logic<br/>func (r *GitHookReconciler) Reconcile(req ctrl.Request) (ctrl.Result, error) {</span><span id="2647" class="kp kq it nw b gy oe ob l oc od">...</span></pre><h1 id="16c7" class="lp kq it bd kr lq lr ls ku lt lu lv kx lw lx ly la lz ma mb ld mc md me lg mf bi translated">4.更新管理器</h1><p id="1480" class="pw-post-body-paragraph jq jr it js b jt mi jv jw jx mj jz ka kb mw kd ke kf mx kh ki kj my kl km kn im bi translated">由于我们的控制器使用其他资源API，如knative，我们需要在“main.go”中注册这些类型。</p><pre class="na nb nc nd gt nv nw nx ny aw nz bi"><span id="85ac" class="kp kq it nw b gy oa ob l oc od">func init() {<br/>    githookv1alpha1.AddToScheme(scheme)<br/>    servingv1alpha1.AddToScheme(scheme)<br/>    servingv1beta1.AddToScheme(scheme)<br/>    tektonv1alpha1.AddToScheme(scheme)<br/>    corev1.AddToScheme(scheme)<br/>    // +kubebuilder:scaffold:scheme</span><span id="4da6" class="kp kq it nw b gy oe ob l oc od">}</span></pre><h1 id="a9f8" class="lp kq it bd kr lq lr ls ku lt lu lv kx lw lx ly la lz ma mb ld mc md me lg mf bi translated">5.测试控制器</h1><p id="4099" class="pw-post-body-paragraph jq jr it js b jt mi jv jw jx mj jz ka kb mw kd ke kf mx kh ki kj my kl km kn im bi translated">您可以通过运行以下命令在本地计算机上测试或调试控制器:</p><pre class="na nb nc nd gt nv nw nx ny aw nz bi"><span id="c56c" class="kp kq it nw b gy oa ob l oc od">make install</span><span id="05ba" class="kp kq it nw b gy oe ob l oc od">make run</span></pre><p id="acaa" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><strong class="js iu"> make install </strong>:将生成CRDs yaml文件并应用到您的kubernetes集群</p><p id="e8b5" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><strong class="js iu"> make run </strong>:将运行测试并运行“main.go”</p><p id="9805" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">您的控制器将开始监控您的资源并执行协调循环。</p><h1 id="2067" class="lp kq it bd kr lq lr ls ku lt lu lv kx lw lx ly la lz ma mb ld mc md me lg mf bi translated">6.部署CRDs和控制器</h1><p id="26a3" class="pw-post-body-paragraph jq jr it js b jt mi jv jw jx mj jz ka kb mw kd ke kf mx kh ki kj my kl km kn im bi translated">这是您需要CRD在集群上可用的时候。您需要运行以下命令进行部署:</p><pre class="na nb nc nd gt nv nw nx ny aw nz bi"><span id="5603" class="kp kq it nw b gy oa ob l oc od">make docker-build IMG=&lt;your image registry&gt;/controller<br/>make docker-push IMG=&lt;your image registry&gt;/controller <br/>make deploy</span></pre><p id="a91f" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><strong class="js iu"> make docker-build </strong>将构建docker图像作为你的IMG变量</p><p id="000c" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><strong class="js iu"> make docker-push </strong>将docker图像推送到注册表</p><p id="dbab" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><strong class="js iu"> make deploy </strong>将生成所有的yaml文件并部署到您的集群中</p><p id="0253" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">或者，您可以发布您yaml文件，让其他人使用以下命令轻松安装您的CRD:</p><pre class="na nb nc nd gt nv nw nx ny aw nz bi"><span id="9428" class="kp kq it nw b gy oa ob l oc od">kustomize build config/default &gt; release.yaml</span></pre></div><div class="ab cl og oh hx oi" role="separator"><span class="oj bw bk ok ol om"/><span class="oj bw bk ok ol om"/><span class="oj bw bk ok ol"/></div><div class="im in io ip iq"><h1 id="4b4e" class="lp kq it bd kr lq on ls ku lt oo lv kx lw op ly la lz oq mb ld mc or me lg mf bi translated">结论</h1><p id="7195" class="pw-post-body-paragraph jq jr it js b jt mi jv jw jx mj jz ka kb mw kd ke kf mx kh ki kj my kl km kn im bi translated">在这篇文章中，我只讨论构建CRD的要点。我没有提到的部分是:</p><ul class=""><li id="ee24" class="mg mh it js b jt ju jx jy kb nq kf nr kj ns kn mn mo mp mq bi translated">作为Knative服务webhook运行的代码</li><li id="a073" class="mg mh it js b jt mr jx ms kb mt kf mu kj mv kn mn mo mp mq bi translated">资源所有者的概念(GitHook拥有它创建的Knative服务)</li><li id="4cc7" class="mg mh it js b jt mr jx ms kb mt kf mu kj mv kn mn mo mp mq bi translated">git api客户端的代码</li><li id="2d1b" class="mg mh it js b jt mr jx ms kb mt kf mu kj mv kn mn mo mp mq bi translated">用于构建和发布GitHook资源的Gitlab CI/CD</li></ul><p id="70e9" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">这篇文章的主要目的是分享我的经验建设我的CRD。</p><p id="efb8" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">希望你觉得有用。</p><p id="8345" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">谢谢:D</p></div></div>    
</body>
</html>