<html>
<head>
<title>Building a Kubernetes deployment pipeline for Microsoft Bot Framework — Part 1</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">为Microsoft Bot框架构建Kubernetes部署管道—第1部分</h1>
<blockquote>原文：<a href="https://itnext.io/building-a-kubernetes-deployment-pipeline-for-microsoft-bot-framework-part-1-ddbb9f6f1796?source=collection_archive---------5-----------------------#2018-02-27">https://itnext.io/building-a-kubernetes-deployment-pipeline-for-microsoft-bot-framework-part-1-ddbb9f6f1796?source=collection_archive---------5-----------------------#2018-02-27</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/c4b3d2ae805b0eb592c4f4baf0137f80.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*uqBk21idGnZCd4G-T97f3Q.jpeg"/></div></div></figure><p id="d8e3" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><a class="ae kw" href="https://www.linkedin.com/cws/share?url=https%3A%2F%2Fitnext.io%2Fbuilding-a-kubernetes-deployment-pipeline-for-microsoft-bot-framework-part-1-ddbb9f6f1796" rel="noopener ugc nofollow" target="_blank"> <em class="kx">点击这里在LinkedIn </em>上分享这篇文章</a></p><p id="2fb0" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在我之前的<a class="ae kw" href="https://chatbotslife.com/writing-a-bot-using-microsoft-bot-framework-in-node-and-typescript-5d62878eb69d" rel="noopener ugc nofollow" target="_blank">帖子</a>中，我讨论了主题公园信息聊天机器人的开发。所有代码都可以在我的GitHub上找到:</p><ul class=""><li id="f7ce" class="ky kz iq ka b kb kc kf kg kj la kn lb kr lc kv ld le lf lg bi translated">主题公园机器人</li><li id="3f1a" class="ky kz iq ka b kb lh kf li kj lj kn lk kr ll kv ld le lf lg bi translated"><a class="ae kw" href="https://github.com/JonJam/themeparks-infrastructure" rel="noopener ugc nofollow" target="_blank">主题公园-基础设施</a></li><li id="1f24" class="ky kz iq ka b kb lh kf li kj lj kn lk kr ll kv ld le lf lg bi translated">主题公园-路易斯</li></ul><p id="003c" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">到目前为止，这个机器人一直在我的机器上本地运行。下一步是托管它，以便人们可以真正开始与它聊天。</p><p id="a418" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我可以用不同的方式来托管这个机器人，但是我决定用Kubernetes。原因是我想学习Kubernetes已经有一段时间了，但只是没有一个合适的项目来冒险。</p><p id="7ac5" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">这篇文章和后续的<a class="ae kw" href="https://medium.com/@jonjam/building-a-kubernetes-deployment-pipeline-for-microsoft-bot-framework-part-2-61b176c2bc26?source=linkShare-8ce1fa774ade-1520462555" rel="noopener">文章</a>将详细介绍我是如何为主题公园机器人建立一个端到端的构建和部署管道的。</p><p id="1ea8" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">第1部分详细介绍了在Azure中设置Kubernetes集群和支持基础设施。所有的代码都可以在我的GitHub上找到:<a class="ae kw" href="https://github.com/JonJam/themeparks-infrastructure" rel="noopener ugc nofollow" target="_blank">主题公园-基础设施</a>。</p></div><div class="ab cl lm ln hu lo" role="separator"><span class="lp bw bk lq lr ls"/><span class="lp bw bk lq lr ls"/><span class="lp bw bk lq lr"/></div><div class="ij ik il im in"><h1 id="1be0" class="lt lu iq bd lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp mq bi translated">工具</h1><p id="8b4d" class="pw-post-body-paragraph jy jz iq ka b kb mr kd ke kf ms kh ki kj mt kl km kn mu kp kq kr mv kt ku kv ij bi translated">在设置部署管道时，我使用了许多不同的工具，下面将逐一介绍。</p><h2 id="7906" class="mw lu iq bd lv mx my dn lz mz na dp md kj nb nc mh kn nd ne ml kr nf ng mp nh bi translated">蔚蓝的</h2><p id="0e40" class="pw-post-body-paragraph jy jz iq ka b kb mr kd ke kf ms kh ki kj mt kl km kn mu kp kq kr mv kt ku kv ij bi translated">Azure是微软的云平台，我用它来托管机器人的所有基础设施。</p><p id="3423" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我决定使用Azure，因为我已经有了很多在Azure上构建和部署应用程序的现有知识。这意味着我可以更专注于学习Kubernetes，而不是云平台的细节。</p><h2 id="9b00" class="mw lu iq bd lv mx my dn lz mz na dp md kj nb nc mh kn nd ne ml kr nf ng mp nh bi translated">Azure CLI</h2><p id="7b2b" class="pw-post-body-paragraph jy jz iq ka b kb mr kd ke kf ms kh ki kj mt kl km kn mu kp kq kr mv kt ku kv ij bi translated">Azure CLI是管理Azure资源的命令行工具。构建和部署脚本使用它向Azure进行身份验证并部署资源。</p><p id="7a0f" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我选择Azure CLI是因为它是跨平台的，允许我在Windows机器上开发，同时也可以在Travis CI的Linux机器上工作。</p><h2 id="d054" class="mw lu iq bd lv mx my dn lz mz na dp md kj nb nc mh kn nd ne ml kr nf ng mp nh bi translated">Azure资源管理器模板</h2><p id="276e" class="pw-post-body-paragraph jy jz iq ka b kb mr kd ke kf ms kh ki kj mt kl km kn mu kp kq kr mv kt ku kv ij bi translated"><a class="ae kw" href="https://docs.microsoft.com/en-us/azure/azure-resource-manager/resource-group-overview" rel="noopener ugc nofollow" target="_blank"> Azure资源管理器</a> <a class="ae kw" href="https://docs.microsoft.com/en-us/azure/azure-resource-manager/resource-group-overview" rel="noopener ugc nofollow" target="_blank"> (ARM </a>)模板允许你使用JSON定义Azure资源。</p><p id="d8a2" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">使用这意味着我可以将我的所有基础设施定义为代码并存储在源代码控制中，而且Azure CLI可以很好地与之集成。</p><h2 id="3971" class="mw lu iq bd lv mx my dn lz mz na dp md kj nb nc mh kn nd ne ml kr nf ng mp nh bi translated">特拉维斯·CI</h2><p id="460e" class="pw-post-body-paragraph jy jz iq ka b kb mr kd ke kf ms kh ki kj mt kl km kn mu kp kq kr mv kt ku kv ij bi translated">Travis CI是GitHub的一个持续集成工具，我用它来构建和部署我的GitHub项目。</p><p id="4c20" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我是看了这篇<a class="ae kw" href="https://github.com/blog/2463-github-welcomes-all-ci-tools" rel="noopener ugc nofollow" target="_blank"> GitHub博文</a>才选择Travis CI的。这篇文章显示了GitHub上大多数使用CI的项目都使用了Travis CI。我不反对。</p><h2 id="b077" class="mw lu iq bd lv mx my dn lz mz na dp md kj nb nc mh kn nd ne ml kr nf ng mp nh bi translated">舵</h2><p id="f28d" class="pw-post-body-paragraph jy jz iq ka b kb mr kd ke kf ms kh ki kj mt kl km kn mu kp kq kr mv kt ku kv ij bi translated"><a class="ae kw" href="https://docs.helm.sh/" rel="noopener ugc nofollow" target="_blank"> Helm </a>是Kubernetes的一个包管理器，我用它来:</p><ul class=""><li id="6037" class="ky kz iq ka b kb kc kf kg kj la kn lb kr lc kv ld le lf lg bi translated">为Kubernetes资源提供模板语言。这允许我在部署过程中轻松地更改容器图像的标记，同样，也可以传入秘密值。</li><li id="e84e" class="ky kz iq ka b kb lh kf li kj lj kn lk kr ll kv ld le lf lg bi translated">定义机器人的依赖关系，如<a class="ae kw" href="https://www.nginx.com/resources/wiki/" rel="noopener ugc nofollow" target="_blank"> NGINX </a>和<a class="ae kw" href="https://redis.io/" rel="noopener ugc nofollow" target="_blank"> Redis </a>。这些是舵图，已经按照最佳实践进行了配置；这意味着我不需要对它们有深入的了解。这些依赖项会随着我的机器人自动部署。</li></ul><h2 id="a6f4" class="mw lu iq bd lv mx my dn lz mz na dp md kj nb nc mh kn nd ne ml kr nf ng mp nh bi translated">库贝特尔</h2><p id="6f7b" class="pw-post-body-paragraph jy jz iq ka b kb mr kd ke kf ms kh ki kj mt kl km kn mu kp kq kr mv kt ku kv ij bi translated"><a class="ae kw" href="https://kubernetes.io/docs/tasks/tools/install-kubectl/" rel="noopener ugc nofollow" target="_blank"> kubectl </a>是用于在Kubernetes上部署和管理应用程序的命令行工具。这是对赫尔姆的依赖。</p></div><div class="ab cl lm ln hu lo" role="separator"><span class="lp bw bk lq lr ls"/><span class="lp bw bk lq lr ls"/><span class="lp bw bk lq lr"/></div><div class="ij ik il im in"><h1 id="2e0c" class="lt lu iq bd lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp mq bi translated">定义Azure资源</h1><p id="9ec4" class="pw-post-body-paragraph jy jz iq ka b kb mr kd ke kf ms kh ki kj mt kl km kn mu kp kq kr mv kt ku kv ij bi translated">以下ARM模板定义了用于托管和由bot使用的各个Azure资源；这些是:</p><ul class=""><li id="4d68" class="ky kz iq ka b kb kc kf kg kj la kn lb kr lc kv ld le lf lg bi translated"><a class="ae kw" href="https://azure.microsoft.com/en-us/services/container-service/" rel="noopener ugc nofollow" target="_blank">Azure Container Service(AKS)</a>—托管的Kubernetes集群。</li><li id="1ec9" class="ky kz iq ka b kb lh kf li kj lj kn lk kr ll kv ld le lf lg bi translated"><a class="ae kw" href="https://azure.microsoft.com/en-us/services/application-insights/" rel="noopener ugc nofollow" target="_blank">应用洞察</a> —针对机器人的日志记录和分析。</li><li id="be0b" class="ky kz iq ka b kb lh kf li kj lj kn lk kr ll kv ld le lf lg bi translated"><a class="ae kw" href="https://azure.microsoft.com/en-us/services/bot-service/" rel="noopener ugc nofollow" target="_blank">机器人通道注册</a>——允许通过脸书信使等通道与机器人通信的注册。</li><li id="1c15" class="ky kz iq ka b kb lh kf li kj lj kn lk kr ll kv ld le lf lg bi translated"><a class="ae kw" href="https://azure.microsoft.com/en-us/services/cognitive-services/language-understanding-intelligent-service/" rel="noopener ugc nofollow" target="_blank">路易斯</a> —机器人用来理解用户信息意图的语言理解服务。</li><li id="caf1" class="ky kz iq ka b kb lh kf li kj lj kn lk kr ll kv ld le lf lg bi translated"><a class="ae kw" href="https://azure.microsoft.com/en-us/services/storage/?v=16.50" rel="noopener ugc nofollow" target="_blank">存储帐户</a> —机器人的状态存储。</li></ul><figure class="ni nj nk nl gt jr"><div class="bz fp l di"><div class="nm nn l"/></div><figcaption class="no np gj gh gi nq nr bd b be z dk translated">定义Azure资源的ARM模板</figcaption></figure><p id="f0bb" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在创建ARM模板时，我想尽快知道我是否错误地定义了它。Azure CLI提供了一种机制来验证ARM模板及其参数是否有效，而无需实际部署它。</p><p id="ab4c" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">所以我创建了这个脚本，可以作为构建的一部分:</p><figure class="ni nj nk nl gt jr"><div class="bz fp l di"><div class="nm nn l"/></div><figcaption class="no np gj gh gi nq nr bd b be z dk translated">验证ARM模板脚本</figcaption></figure><p id="14ac" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">现在我有了验证模板的方法，我需要能够部署它。同样，使用Azure CLI，我创建了以下内容:</p><figure class="ni nj nk nl gt jr"><div class="bz fp l di"><div class="nm nn l"/></div><figcaption class="no np gj gh gi nq nr bd b be z dk translated">部署ARM模板脚本</figcaption></figure><h1 id="d28b" class="lt lu iq bd lv lw ns ly lz ma nt mc md me nu mg mh mi nv mk ml mm nw mo mp mq bi translated">设置舵</h1><p id="abb7" class="pw-post-body-paragraph jy jz iq ka b kb mr kd ke kf ms kh ki kj mt kl km kn mu kp kq kr mv kt ku kv ij bi translated">创建Azure资源后的下一步是在新创建的Kubernetes集群中设置Helm。</p><p id="d81f" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">这需要在Kubernetes集群上安装Tiller (Helm的服务器组件)。根据<a class="ae kw" href="https://docs.helm.sh/using_helm/#initialize-helm-and-install-tiller" rel="noopener ugc nofollow" target="_blank">文档</a>，这可以使用以下命令完成:</p><pre class="ni nj nk nl gt nx ny nz oa aw ob bi"><span id="fb0b" class="mw lu iq ny b gy oc od l oe of">helm init </span></pre><p id="456a" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在运行之前，我需要设置<a class="ae kw" href="https://kubernetes.io/docs/tasks/access-application-cluster/configure-access-multiple-clusters/" rel="noopener ugc nofollow" target="_blank">上下文</a>来与Kubernetes集群通信。这包含在以下脚本中:</p><figure class="ni nj nk nl gt jr"><div class="bz fp l di"><div class="nm nn l"/></div><figcaption class="no np gj gh gi nq nr bd b be z dk translated">在Azure Kubernetes集群中安装helm</figcaption></figure><p id="2db4" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">需要注意的一点是超控，这是<a class="ae kw" href="https://docs.helm.sh/using_helm/#tiller-s-release-information" rel="noopener ugc nofollow" target="_blank">舵文档</a>中的建议。默认情况下，由于遗留原因，Tiller使用<a class="ae kw" href="https://kubernetes.io/docs/tasks/configure-pod-container/configure-pod-configmap/" rel="noopener ugc nofollow" target="_blank"> ConfigMaps </a>来存储敏感的发布信息，实际上应该使用<a class="ae kw" href="https://kubernetes.io/docs/concepts/configuration/secret/" rel="noopener ugc nofollow" target="_blank"> Secrets </a>。</p><h1 id="a385" class="lt lu iq bd lv lw ns ly lz ma nt mc md me nu mg mh mi nv mk ml mm nw mo mp mq bi translated">我喜欢建筑组合在一起</h1><p id="bde3" class="pw-post-body-paragraph jy jz iq ka b kb mr kd ke kf ms kh ki kj mt kl km kn mu kp kq kr mv kt ku kv ij bi translated">在创建了所有需要的脚本和模板之后，我可以使用Travis CI将所有东西放在一起。然后，每当我做出更改时，更新的基础设施就会自动构建和部署。</p><p id="4e37" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我的. travis.yml文件如下所示:</p><figure class="ni nj nk nl gt jr"><div class="bz fp l di"><div class="nm nn l"/></div><figcaption class="no np gj gh gi nq nr bd b be z dk translated">Travis CI定义</figcaption></figure><p id="d00e" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">这个Travis CI定义利用了<a class="ae kw" href="https://docs.travis-ci.com/user/build-stages/" rel="noopener ugc nofollow" target="_blank">构建阶段</a>(目前处于测试阶段)，它允许您清晰地划分构建/部署管道的各个阶段。您还会注意到，我使用了许多环境变量，这些变量是通过<a class="ae kw" href="https://docs.travis-ci.com/user/environment-variables#Defining-Variables-in-Repository-Settings" rel="noopener ugc nofollow" target="_blank">存储库设置</a>来设置的。</p><p id="3632" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">该定义执行以下操作:</p><ul class=""><li id="1974" class="ky kz iq ka b kb kc kf kg kj la kn lb kr lc kv ld le lf lg bi translated">在任何阶段之前，它会安装脚本运行所需的<a class="ae kw" href="https://docs.travis-ci.com/user/installing-dependencies/" rel="noopener ugc nofollow" target="_blank">依赖项</a>，即Azure CLI、kubectl和helm。</li><li id="e0cd" class="ky kz iq ka b kb lh kf li kj lj kn lk kr ll kv ld le lf lg bi translated">运行测试阶段，验证ARM模板和指定的参数。</li><li id="151b" class="ky kz iq ka b kb lh kf li kj lj kn lk kr ll kv ld le lf lg bi translated">如果测试阶段通过了，并且构建工作脱离了主分支，那么它将运行部署阶段。这个阶段使用实验性的<a class="ae kw" href="https://docs.travis-ci.com/user/deployment/script/" rel="noopener ugc nofollow" target="_blank">脚本部署</a>来运行部署ARM模板的包装器脚本，并设置Tiller。</li></ul><p id="7d21" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">包装器脚本如下所示，只调用我之前定义的脚本。</p><figure class="ni nj nk nl gt jr"><div class="bz fp l di"><div class="nm nn l"/></div><figcaption class="no np gj gh gi nq nr bd b be z dk translated">用于部署的包装脚本</figcaption></figure></div><div class="ab cl lm ln hu lo" role="separator"><span class="lp bw bk lq lr ls"/><span class="lp bw bk lq lr ls"/><span class="lp bw bk lq lr"/></div><div class="ij ik il im in"><p id="28f8" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">这就是基础设施的设置！<a class="ae kw" href="https://medium.com/@jonjam/building-a-kubernetes-deployment-pipeline-for-microsoft-bot-framework-part-2-61b176c2bc26?source=linkShare-8ce1fa774ade-1520462555" rel="noopener">第2部分</a>详细介绍了使用Helm构建和部署主题公园机器人。</p></div></div>    
</body>
</html>