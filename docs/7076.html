<html>
<head>
<title>Build a Twitter Leaderboard app with Redis and AWS Lambda (part 2)</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用Redis和AWS Lambda构建一个Twitter排行榜应用程序(第2部分)</h1>
<blockquote>原文：<a href="https://itnext.io/build-a-twitter-leaderboard-app-with-redis-and-aws-lambda-part-2-b5265d83d084?source=collection_archive---------1-----------------------#2022-06-03">https://itnext.io/build-a-twitter-leaderboard-app-with-redis-and-aws-lambda-part-2-b5265d83d084?source=collection_archive---------1-----------------------#2022-06-03</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="4073" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">AWS CDK代码演练</h2></div><p id="c318" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这是这个由两部分组成的系列的第二篇博文，它使用一个实际的应用程序来演示如何将Redis与AWS Lambda集成。第一部分是关于解决方案概述和部署，希望您能够端到端地进行测试。</p><div class="lb lc gp gr ld le"><a rel="noopener  ugc nofollow" target="_blank" href="/build-a-twitter-leaderboard-app-with-redis-and-aws-lambda-part-1-670e7a8c6a91"><div class="lf ab fo"><div class="lg ab lh cl cj li"><h2 class="bd ir gy z fp lj fr fs lk fu fw ip bi translated">用Redis和AWS Lambda构建一个Twitter排行榜应用程序(第1部分)</h2><div class="ll l"><h3 class="bd b gy z fp lj fr fs lk fu fw dk translated">你好，欢迎👋🏼这个由两部分组成的博客系列使用一个简单而实用的应用程序来演示如何…</h3></div><div class="lm l"><p class="bd b dl z fp lj fr fs lk fu fw dk translated">itnext.io</p></div></div><div class="ln l"><div class="lo l lp lq lr ln ls lt le"/></div></div></a></div><p id="c53e" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">正如所承诺的，第二部分(这一部分)将涵盖基础设施方面(具体来说是IaaC)，它由三个(CDK) <a class="ae lu" href="https://docs.aws.amazon.com/cdk/v2/guide/stacks.html" rel="noopener ugc nofollow" target="_blank">堆栈</a>(在单个<a class="ae lu" href="https://docs.aws.amazon.com/cdk/v2/guide/apps.html" rel="noopener ugc nofollow" target="_blank"> CDK应用</a>的上下文中)组成。</p><p id="2f30" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我将提供一个用Go编写的CDK代码的演示，感谢<a class="ae lu" href="https://docs.aws.amazon.com/cdk/v2/guide/work-with-cdk-go.html" rel="noopener ugc nofollow" target="_blank"> CDK Go支持</a>(在撰写本文时是开发者预览版)。</p><h1 id="351d" class="lv lw iq bd lx ly lz ma mb mc md me mf jw mg jx mh jz mi ka mj kc mk kd ml mm bi translated">CDK代码遍历</h1><p id="fd12" class="pw-post-body-paragraph kf kg iq kh b ki mn jr kk kl mo ju kn ko mp kq kr ks mq ku kv kw mr ky kz la ij bi translated">让我们一次拿一叠</p><blockquote class="ms mt mu"><p id="9612" class="kf kg mv kh b ki kj jr kk kl km ju kn mw kp kq kr mx kt ku kv my kx ky kz la ij bi translated"><em class="iq">请注意，为了简洁起见，一些代码已经被编辑/省略——您可以随时在</em><a class="ae lu" href="https://github.com/abhirockzz/twitter-leaderboard-app" rel="noopener ugc nofollow" target="_blank"><em class="iq">GitHub repo</em></a>中查阅完整的代码</p></blockquote><h2 id="1054" class="mz lw iq bd lx na nb dn mb nc nd dp mf ko ne nf mh ks ng nh mj kw ni nj ml nk bi translated">从基础架构堆栈开始</h2><pre class="nl nm nn no gt np nq nr ns aw nt bi"><span id="3e9d" class="mz lw iq nq b gy nu nv l nw nx">stack := awscdk.NewStack(scope, &amp;id, &amp;sprops)<br/>vpc = awsec2.NewVpc(stack, jsii.String("demo-vpc"), nil)</span><span id="0366" class="mz lw iq nq b gy ny nv l nw nx">authInfo := map[string]interface{}{"Type": "password", "Passwords": []string{memorydbPassword}}<br/>user = awsmemorydb.NewCfnUser(stack, jsii.String("demo-memorydb-user"), &amp;awsmemorydb.CfnUserProps{UserName: jsii.String("demo-user"), AccessString: jsii.String(accessString), AuthenticationMode: authInfo})<br/>acl := awsmemorydb.NewCfnACL(stack, jsii.String("demo-memorydb-acl"), &amp;awsmemorydb.CfnACLProps{AclName: jsii.String("demo-memorydb-acl"), UserNames: &amp;[]*string{user.UserName()}})</span><span id="cb99" class="mz lw iq nq b gy ny nv l nw nx"><em class="mv">//snip .....</em></span><span id="3e48" class="mz lw iq nq b gy ny nv l nw nx">subnetGroup := awsmemorydb.NewCfnSubnetGroup(stack, jsii.String("demo-memorydb-subnetgroup"), &amp;awsmemorydb.CfnSubnetGroupProps{SubnetGroupName: jsii.String("demo-memorydb-subnetgroup"), SubnetIds: &amp;subnetIDsForSubnetGroup})</span><span id="26ac" class="mz lw iq nq b gy ny nv l nw nx">memorydbSecurityGroup = awsec2.NewSecurityGroup(stack, jsii.String("memorydb-demo-sg"), &amp;awsec2.SecurityGroupProps{Vpc: vpc, SecurityGroupName: jsii.String("memorydb-demo-sg"), AllowAllOutbound: jsii.Bool(true)})</span><span id="6587" class="mz lw iq nq b gy ny nv l nw nx">memorydbCluster = awsmemorydb.NewCfnCluster(<em class="mv">//... details omitted)</em></span><span id="0e38" class="mz lw iq nq b gy ny nv l nw nx"><em class="mv">//...snip</em></span><span id="6662" class="mz lw iq nq b gy ny nv l nw nx">twitterIngestFunctionSecurityGroup = awsec2.NewSecurityGroup(<em class="mv">//... details omitted)</em><br/>twitterLeaderboardFunctionSecurityGroup = awsec2.NewSecurityGroup(<em class="mv">//... details omitted)</em></span><span id="e5d4" class="mz lw iq nq b gy ny nv l nw nx">memorydbSecurityGroup.AddIngressRule(<em class="mv">//... details omitted)</em><br/>memorydbSecurityGroup.AddIngressRule(<em class="mv">//... details omitted)</em></span></pre><p id="6dae" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">总结一下:</p><ul class=""><li id="b5bc" class="nz oa iq kh b ki kj kl km ko ob ks oc kw od la oe of og oh bi translated">创建VPC和相关组件的一行代码！</li><li id="19fe" class="nz oa iq kh b ki oi kl oj ko ok ks ol kw om la oe of og oh bi translated">我们为MemoryDB集群创建ACL、用户、子网组，并在使用<code class="fe on oo op nq b">awsmemorydb.NewCfnCluster</code>创建集群时引用它们</li><li id="401f" class="nz oa iq kh b ki oi kl oj ko ok ks ol kw om la oe of og oh bi translated">我们还创建所需的安全组——它们的主要作用是允许Lambda函数访问MemoryDB(我们指定显式的入站规则来实现这一点)</li><li id="4b66" class="nz oa iq kh b ki oi kl oj ko ok ks ol kw om la oe of og oh bi translated">一个用于内存数据库集群</li><li id="e15d" class="nz oa iq kh b ki oi kl oj ko ok ks ol kw om la oe of og oh bi translated">两个Lambda函数各一个</li></ul><h2 id="5c7b" class="mz lw iq bd lx na nb dn mb nc nd dp mf ko ne nf mh ks ng nh mj kw ni nj ml nk bi translated">下一个堆栈部署了tweets摄取Lambda功能</h2><pre class="nl nm nn no gt np nq nr ns aw nt bi"><span id="b715" class="mz lw iq nq b gy nu nv l nw nx"><em class="mv">//....</em></span><span id="1adb" class="mz lw iq nq b gy ny nv l nw nx">memoryDBEndpointURL := fmt.Sprintf("%s:%s", *memorydbCluster.AttrClusterEndpointAddress(), strconv.Itoa(int(*memorydbCluster.Port())))</span><span id="4206" class="mz lw iq nq b gy ny nv l nw nx">lambdaEnvVars := &amp;map[string]*string{"MEMORYDB_ENDPOINT": jsii.String(memoryDBEndpointURL), "MEMORYDB_USER": user.UserName(), "MEMORYDB_PASSWORD": jsii.String(getMemorydbPassword()), "TWITTER_API_KEY": jsii.String(getTwitterAPIKey()), "TWITTER_API_SECRET": jsii.String(getTwitterAPISecret()), "TWITTER_ACCESS_TOKEN": jsii.String(getTwitterAccessToken()), "TWITTER_ACCESS_TOKEN_SECRET": jsii.String(getTwitterAccessTokenSecret())}</span><span id="403b" class="mz lw iq nq b gy ny nv l nw nx">awslambda.NewDockerImageFunction(stack, jsii.String("lambda-memorydb-func"), &amp;awslambda.DockerImageFunctionProps{FunctionName: jsii.String(tweetIngestionFunctionName), Environment: lambdaEnvVars, Timeout: awscdk.Duration_Seconds(jsii.Number(20)), Code: awslambda.DockerImageCode_FromImageAsset(jsii.String(tweetIngestionFunctionPath), nil), Vpc: vpc, VpcSubnets: &amp;awsec2.SubnetSelection{Subnets: vpc.PrivateSubnets()}, SecurityGroups: &amp;[]awsec2.ISecurityGroup{twitterIngestFunctionSecurityGroup}})</span><span id="4ae5" class="mz lw iq nq b gy ny nv l nw nx"><em class="mv">//....</em></span></pre><p id="93cf" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">和之前的栈相比还是挺简单的。我们定义Lambda函数所需的环境变量(包括Twitter API凭证),并将其部署为Docker映像。</p><p id="9f72" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">对于要打包成Docker映像的函数，我使用了<a class="ae lu" href="https://gallery.ecr.aws/lambda/go" rel="noopener ugc nofollow" target="_blank"> Go:1.x基础映像</a>。但是，你也可以探索其他选择。在部署期间，Docker映像在本地构建，被推送到一个<a class="ae lu" href="https://docs.aws.amazon.com/AmazonECR/latest/userguide/Registries.html" rel="noopener ugc nofollow" target="_blank">私有ECR注册表</a>，最后Lambda函数被创建——所有这一切，只需几行代码！</p><blockquote class="ms mt mu"><p id="9413" class="kf kg mv kh b ki kj jr kk kl km ju kn mw kp kq kr mx kt ku kv my kx ky kz la ij bi translated"><em class="iq">请注意，MemoryDB集群和安全组是从以前的堆栈中自动引用/查找的(不是重新创建的！).</em></p></blockquote><h2 id="5d03" class="mz lw iq bd lx na nb dn mb nc nd dp mf ko ne nf mh ks ng nh mj kw ni nj ml nk bi translated">最后，第三个堆栈负责排行榜Lambda函数</h2><p id="84a3" class="pw-post-body-paragraph kf kg iq kh b ki mn jr kk kl mo ju kn ko mp kq kr ks mq ku kv kw mr ky kz la ij bi translated">它与前一个非常相似，除了添加了Lambda函数URL ( <code class="fe on oo op nq b">awslambda.NewFunctionUrl</code>)，我们使用它作为堆栈的输出:</p><pre class="nl nm nn no gt np nq nr ns aw nt bi"><span id="2cd3" class="mz lw iq nq b gy nu nv l nw nx"><em class="mv">//....</em><br/>memoryDBEndpointURL := fmt.Sprintf("%s:%s", *memorydbCluster.AttrClusterEndpointAddress(), strconv.Itoa(int(*memorydbCluster.Port())))</span><span id="3250" class="mz lw iq nq b gy ny nv l nw nx">lambdaEnvVars := &amp;map[string]*string{"MEMORYDB_ENDPOINT": jsii.String(memoryDBEndpointURL), "MEMORYDB_USERNAME": user.UserName(), "MEMORYDB_PASSWORD": jsii.String(getMemorydbPassword())}</span><span id="b398" class="mz lw iq nq b gy ny nv l nw nx">function := awslambda.NewDockerImageFunction(stack, jsii.String("twitter-hashtag-leaderboard"), &amp;awslambda.DockerImageFunctionProps{FunctionName: jsii.String(hashtagLeaderboardFunctionName), Environment: lambdaEnvVars, Code: awslambda.DockerImageCode_FromImageAsset(jsii.String(hashtagLeaderboardFunctionPath), nil), Timeout: awscdk.Duration_Seconds(jsii.Number(5)), Vpc: vpc, VpcSubnets: &amp;awsec2.SubnetSelection{Subnets: vpc.PrivateSubnets()}, SecurityGroups: &amp;[]awsec2.ISecurityGroup{twitterLeaderboardFunctionSecurityGroup}})</span><span id="2d5a" class="mz lw iq nq b gy ny nv l nw nx">funcURL := awslambda.NewFunctionUrl(stack, jsii.String("func-url"), &amp;awslambda.FunctionUrlProps{AuthType: awslambda.FunctionUrlAuthType_NONE, Function: function})</span><span id="b000" class="mz lw iq nq b gy ny nv l nw nx">awscdk.NewCfnOutput(stack, jsii.String("Function URL"), &amp;awscdk.CfnOutputProps{Value: funcURL.Url()})</span></pre><p id="7589" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这篇博文到此为止。以AWS Go CDK v2参考的链接结束:</p><ul class=""><li id="45c9" class="nz oa iq kh b ki kj kl km ko ob ks oc kw od la oe of og oh bi translated">对于memory db—<a class="ae lu" href="https://pkg.go.dev/github.com/aws/aws-cdk-go/awscdk/v2@v2.24.1/awsmemorydb" rel="noopener ugc nofollow" target="_blank">https://pkg . go . dev/github . com/AWS/AWS-CDK-go/AWS CDK/v2/AWS memory db</a></li><li id="0244" class="nz oa iq kh b ki oi kl oj ko ok ks ol kw om la oe of og oh bi translated">对于Lambda—<a class="ae lu" href="https://pkg.go.dev/github.com/aws/aws-cdk-go/awscdk/v2@v2.24.1/awslambda" rel="noopener ugc nofollow" target="_blank">https://pkg . go . dev/github . com/AWS/AWS-CDK-go/AWS CDK/v2/AWS Lambda</a></li><li id="9882" class="nz oa iq kh b ki oi kl oj ko ok ks ol kw om la oe of og oh bi translated">对于VPC等。—<a class="ae lu" href="https://pkg.go.dev/github.com/aws/aws-cdk-go/awscdk/v2@v2.24.1/awsec2" rel="noopener ugc nofollow" target="_blank">https://pkg . go . dev/github . com/AWS/AWS-CDK-go/AWS CDK/v2/AWS ec2</a></li><li id="5d37" class="nz oa iq kh b ki oi kl oj ko ok ks ol kw om la oe of og oh bi translated">https://pkg.go.dev/github.com/aws/aws-cdk-go/awscdk/v2 AWS CDK V2<a class="ae lu" href="https://pkg.go.dev/github.com/aws/aws-cdk-go/awscdk/v2" rel="noopener ugc nofollow" target="_blank"/></li></ul><p id="4bc5" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这个两部分系列到此结束。请继续关注，一如既往，快乐编码！</p></div></div>    
</body>
</html>