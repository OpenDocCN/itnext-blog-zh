<html>
<head>
<title>Reactive Microservices with Spring 5</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">带弹簧的反应式微服务5</h1>
<blockquote>原文：<a href="https://itnext.io/reactive-microservices-with-spring-5-95c5f8cd03d0?source=collection_archive---------0-----------------------#2017-08-04">https://itnext.io/reactive-microservices-with-spring-5-95c5f8cd03d0?source=collection_archive---------0-----------------------#2017-08-04</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="f9b8" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">Spring 5正在经历有史以来最大的更新。Spring 5是一个新版本，它承诺让开发人员能够构建更健壮、更有弹性、更灵活的系统，更好地满足现代需求。这就是我们所说的反应系统。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi kl"><img src="../Images/b60654827ed4f9e8b308735528b9e28f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*7zTm5myWG6ni83m-Jm9gIA.png"/></div></div></figure><p id="252c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">弹簧5当前在<a class="ae kx" href="https://github.com/spring-projects/spring-framework/releases/tag/v5.0.0.RC3" rel="noopener ugc nofollow" target="_blank"> v5.0.0.RC3 </a>上。(发布候选3)，于2017年7月发布，目标是，在JDK 9的GA日期后立即GA(可从<a class="ae kx" href="http://www.java9countdown.xyz/" rel="noopener ugc nofollow" target="_blank"> 21.9.2017 </a>获得)。spring的新版本是用Java 8编写的，但将与下一个版本Java 9完全兼容。如果你想了解新的Spring 5的一切，请查看<a class="ae kx" href="https://github.com/spring-projects/spring-framework/wiki/What's-New-in-the-Spring-Framework#whats-new-in-spring-framework-5x" rel="noopener ugc nofollow" target="_blank">Spring框架的新功能</a>和<a class="ae kx" href="http://docs.spring.io/spring-framework/docs/5.0.0.M5/spring-framework-reference/html/" rel="noopener ugc nofollow" target="_blank"> Spring 5文档</a>。在开始讲Spring 5之前，我们先来讲讲反应式系统和编程。</p><h1 id="844b" class="ky kz iq bd la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv bi translated">反应式编程</h1><p id="10da" class="pw-post-body-paragraph jn jo iq jp b jq lw js jt ju lx jw jx jy ly ka kb kc lz ke kf kg ma ki kj kk ij bi translated">如果你从未听说过反应系统，我推荐你阅读<a class="ae kx" href="http://www.reactivemanifesto.org/" rel="noopener ugc nofollow" target="_blank">反应宣言</a>。总之，一个反应系统必须是<strong class="jp ir">反应灵敏的、有弹性的、有弹性的和消息驱动的。</strong></p><p id="9f38" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">大系统由较小的系统组成，因此依赖于其组成部分的反应性质。这意味着反应式系统应用设计原则，因此这些属性适用于所有级别的规模，使它们成为可组合的。</p><p id="9895" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">反应式编程是异步和事件驱动的非阻塞应用程序，需要少量线程垂直伸缩(即在JVM内)而不是水平伸缩(即通过集群)。</p><p id="8fd2" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">反应式编程可以用在不同的用例中，让我们看一些例子:</p><p id="0bb0" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">外部服务调用:</strong>如今很多后端服务都是REST-ful的，HTTP从根本上来说是阻塞式和同步式的。IO操作通常是阻塞操作，我们不想等一个调用完成后再发送下一个请求。</p><p id="2696" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">高度并发的消息消费者:</strong>反应模式本质上非常适合消息处理。</p><p id="a33b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">基于同步处理的抽象:</strong>函数式反应式编程提供一些额外的抽象层是很方便的，因为不需要知道我们调用的代码是同步的还是异步的。</p><h1 id="cf5b" class="ky kz iq bd la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv bi translated">弹簧腹板反应模块</h1><p id="56ab" class="pw-post-body-paragraph jn jo iq jp b jq lw js jt ju lx jw jx jy ly ka kb kc lz ke kf kg ma ki kj kk ij bi translated">Spring Framework 5包括一个新的<code class="fe mb mc md me b">spring-web-reactive</code>模块。该模块支持反应式HTTP和WebSocket客户端以及反应式服务器web应用程序，包括REST、HTML浏览器和WebSocket风格的交互。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi mf"><img src="../Images/04b89d6d9a065ffc6782a81d547ea4d0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*6iB_zrIilNRn6DyAG1ZXjA.png"/></div></div></figure><h1 id="c2b2" class="ky kz iq bd la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv bi translated">让我们开始吧</h1><p id="0fe1" class="pw-post-body-paragraph jn jo iq jp b jq lw js jt ju lx jw jx jy ly ka kb kc lz ke kf kg ma ki kj kk ij bi translated">首先，我们需要使用<a class="ae kx" href="https://start.spring.io/" rel="noopener ugc nofollow" target="_blank"> Spring Initializr </a>创建一个Spring Boot应用程序。如果你对Spring Boot没有足够的经验，请阅读这个。基础代码可以在文章末尾找到。</p><h2 id="db03" class="mg kz iq bd la mh mi dn le mj mk dp li jy ml mm lm kc mn mo lq kg mp mq lu mr bi translated">添加依赖关系</h2><p id="813a" class="pw-post-body-paragraph jn jo iq jp b jq lw js jt ju lx jw jx jy ly ka kb kc lz ke kf kg ma ki kj kk ij bi translated">在根文件夹中找到pom.xml，添加Spring Web Flux、MondoDB、Gatling和Test的依赖项。</p><pre class="km kn ko kp gt ms me mt mu aw mv bi"><span id="2cd9" class="mg kz iq me b gy mw mx l my mz">&lt;<strong class="me ir">dependency</strong>&gt;<br/>    &lt;<strong class="me ir">groupId</strong>&gt;org.springframework.boot&lt;/<strong class="me ir">groupId</strong>&gt;<br/>    &lt;<strong class="me ir">artifactId</strong>&gt;spring-boot-starter-webflux&lt;/<strong class="me ir">artifactId</strong>&gt;<br/>&lt;/<strong class="me ir">dependency</strong>&gt;<br/><br/><em class="na">&lt;!--EMBED MONGO DB--&gt;<br/><br/>&lt;!-- https://mvnrepository.com/artifact/org.springframework.data/spring-data-commons --&gt;<br/></em>&lt;<strong class="me ir">dependency</strong>&gt;<br/>    &lt;<strong class="me ir">groupId</strong>&gt;org.springframework.boot&lt;/<strong class="me ir">groupId</strong>&gt;<br/>    &lt;<strong class="me ir">artifactId</strong>&gt;spring-boot-starter-data-mongodb-reactive&lt;/<strong class="me ir">artifactId</strong>&gt;<br/>&lt;/<strong class="me ir">dependency</strong>&gt;<br/><br/>&lt;<strong class="me ir">dependency</strong>&gt;<br/>    &lt;<strong class="me ir">groupId</strong>&gt;org.springframework.boot&lt;/<strong class="me ir">groupId</strong>&gt;<br/>    &lt;<strong class="me ir">artifactId</strong>&gt;spring-boot-starter-data-mongodb&lt;/<strong class="me ir">artifactId</strong>&gt;<br/>&lt;/<strong class="me ir">dependency</strong>&gt;<br/><br/>&lt;<strong class="me ir">dependency</strong>&gt;<br/>    &lt;<strong class="me ir">groupId</strong>&gt;de.flapdoodle.embed&lt;/<strong class="me ir">groupId</strong>&gt;<br/>    &lt;<strong class="me ir">artifactId</strong>&gt;de.flapdoodle.embed.mongo&lt;/<strong class="me ir">artifactId</strong>&gt;<br/>    &lt;<strong class="me ir">version</strong>&gt;1.50.5&lt;/<strong class="me ir">version</strong>&gt;<br/>&lt;/<strong class="me ir">dependency</strong>&gt;<br/><br/>&lt;<strong class="me ir">dependency</strong>&gt;<br/>    &lt;<strong class="me ir">groupId</strong>&gt;org.springframework.boot&lt;/<strong class="me ir">groupId</strong>&gt;<br/>    &lt;<strong class="me ir">artifactId</strong>&gt;spring-boot-starter-test&lt;/<strong class="me ir">artifactId</strong>&gt;<br/>    &lt;<strong class="me ir">scope</strong>&gt;test&lt;/<strong class="me ir">scope</strong>&gt;<br/>&lt;/<strong class="me ir">dependency</strong>&gt;<br/><br/><em class="na">&lt;!--GATLING--&gt;<br/>&lt;!-- https://mvnrepository.com/artifact/io.gatling.highcharts/gatling-charts-highcharts --&gt;<br/></em>&lt;<strong class="me ir">dependency</strong>&gt;<br/>    &lt;<strong class="me ir">groupId</strong>&gt;io.gatling.highcharts&lt;/<strong class="me ir">groupId</strong>&gt;<br/>    &lt;<strong class="me ir">artifactId</strong>&gt;gatling-charts-highcharts&lt;/<strong class="me ir">artifactId</strong>&gt;<br/>    &lt;<strong class="me ir">version</strong>&gt;2.2.5&lt;/<strong class="me ir">version</strong>&gt;<br/>    &lt;<strong class="me ir">scope</strong>&gt;test&lt;/<strong class="me ir">scope</strong>&gt;<br/>&lt;/<strong class="me ir">dependency</strong>&gt;</span></pre><h2 id="c4e2" class="mg kz iq bd la mh mi dn le mj mk dp li jy ml mm lm kc mn mo lq kg mp mq lu mr bi translated">建立我们的网络服务</h2><pre class="km kn ko kp gt ms me mt mu aw mv bi"><span id="6090" class="mg kz iq me b gy mw mx l my mz">@SpringBootApplication<br/>@EnableAutoConfiguration<br/>@EnableMongoAuditing<br/>@EnableReactiveMongoRepositories<br/><strong class="me ir">public class </strong>ReactiveAccountRestApplication {<br/>    <strong class="me ir">public static void </strong>main(String[] args) {<br/>        SpringApplication.<em class="na">run</em>(ReactiveAccountRestApplication.<strong class="me ir">class</strong>, args);<br/>    }<br/>}</span></pre><ul class=""><li id="3c14" class="nb nc iq jp b jq jr ju jv jy nd kc ne kg nf kk ng nh ni nj bi translated">SpringBootApplication :是我们REST服务的标准配置。这个注释相当于使用了<code class="fe mb mc md me b">@Configuration</code>、<code class="fe mb mc md me b">@EnableAutoConfiguration</code>和<code class="fe mb mc md me b">@ComponentScan</code></li><li id="261c" class="nb nc iq jp b jq nk ju nl jy nm kc nn kg no kk ng nh ni nj bi translated"><strong class="jp ir">enable auto configuration</strong>:允许我们的依赖项进行自我配置。</li><li id="fcad" class="nb nc iq jp b jq nk ju nl jy nm kc nn kg no kk ng nh ni nj bi translated"><strong class="jp ir">EnableReactiveMongoRepositories</strong>:使我们的MongoDB能够反应式工作。</li></ul><h2 id="f0f1" class="mg kz iq bd la mh mi dn le mj mk dp li jy ml mm lm kc mn mo lq kg mp mq lu mr bi translated">模型</h2><pre class="km kn ko kp gt ms me mt mu aw mv bi"><span id="b552" class="mg kz iq me b gy mw mx l my mz">@Document(collection = <strong class="me ir">"accounts"</strong>)<br/><strong class="me ir">public class </strong>Account {<br/><br/>    @Id<br/>    <strong class="me ir">private </strong>String <strong class="me ir">id</strong>;<br/><br/>    @CreatedDate<br/>    @JsonFormat(shape = JsonFormat.Shape.<strong class="me ir"><em class="na">STRING</em></strong>, pattern = <strong class="me ir">"dd-MM-yyyy mm:ss"</strong>)<br/>    <strong class="me ir">private </strong>Date <strong class="me ir">creationDate</strong>;<br/><br/>    <strong class="me ir">private </strong>Double <strong class="me ir">amount</strong>;<br/><br/>    <strong class="me ir">private </strong>Currency <strong class="me ir">currency</strong>;<br/><br/>    <strong class="me ir">public </strong>Account() {<br/>    }<br/><br/>    <strong class="me ir">public </strong>Account(<strong class="me ir">double </strong>amount, Currency currency) {<br/>        <strong class="me ir">this</strong>.<strong class="me ir">amount </strong>= amount;<br/>        <strong class="me ir">this</strong>.<strong class="me ir">currency </strong>= currency;<br/>    }<br/><br/>    <strong class="me ir">public </strong>String getId() {<br/>        <strong class="me ir">return id</strong>;<br/>    }<br/><br/>    <strong class="me ir">public void </strong>setId(String id) {<br/>        <strong class="me ir">this</strong>.<strong class="me ir">id </strong>= id;<br/>    }<br/><br/>    <strong class="me ir">public </strong>Date getCreationDate() {<br/>        <strong class="me ir">return creationDate</strong>;<br/>    }<br/><br/>    <strong class="me ir">public void </strong>setCreationDate(Date creationDate) {<br/>        <strong class="me ir">this</strong>.<strong class="me ir">creationDate </strong>= creationDate;<br/>    }<br/><br/>    <strong class="me ir">public </strong>Double getAmount() {<br/>        <strong class="me ir">return amount</strong>;<br/>    }<br/><br/>    <strong class="me ir">public </strong>Currency getCurrency() {<br/>        <strong class="me ir">return currency</strong>;<br/>    }<br/><br/>    <strong class="me ir">public void </strong>setCurrency(Currency currency) {<br/>        <strong class="me ir">this</strong>.<strong class="me ir">currency </strong>= currency;<br/>    }<br/><br/>    <strong class="me ir">public void </strong>setAmount(Double amount) {<br/>        <strong class="me ir">this</strong>.<strong class="me ir">amount </strong>= amount;<br/>    }<br/><br/>    @Override<br/>    <strong class="me ir">public </strong>String toString() {<br/>        <strong class="me ir">return "Account{" </strong>+<br/>                <strong class="me ir">"id='" </strong>+ <strong class="me ir">id </strong>+ <strong class="me ir">'\'' </strong>+<br/>                <strong class="me ir">", creationDate=" </strong>+ <strong class="me ir">creationDate </strong>+<br/>                <strong class="me ir">", amount=" </strong>+ <strong class="me ir">amount </strong>+<br/>                <strong class="me ir">", currency=" </strong>+ <strong class="me ir">currency </strong>+<br/>                <strong class="me ir">'}'</strong>;<br/>    }<br/>}</span><span id="e607" class="mg kz iq me b gy np mx l my mz"><strong class="me ir">public enum </strong>Currency {<br/>    <strong class="me ir"><em class="na">USD</em></strong>, <strong class="me ir"><em class="na">EUR</em></strong>, <strong class="me ir"><em class="na">BRL</em></strong>;<br/><br/>    <strong class="me ir">public static </strong>Currency fromValue(String value) {<br/>        <strong class="me ir">for </strong>(Currency currency : <em class="na">values</em>())<br/>            <strong class="me ir">if </strong>(currency.name().equalsIgnoreCase(value)) {<br/>                <strong class="me ir">return </strong>currency;<br/>            }<br/>        <strong class="me ir">return null</strong>;<br/>    }<br/>}</span></pre><h1 id="cf59" class="ky kz iq bd la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv bi translated">反应堆知识库</h1><p id="3c37" class="pw-post-body-paragraph jn jo iq jp b jq lw js jt ju lx jw jx jy ly ka kb kc lz ke kf kg ma ki kj kk ij bi translated">现在，在SPRING 5中，我们有了这个来自SPRING数据的新接口，称为ReactiveCrudRepository。它是一个通用接口，用于对特定类型的存储库进行CRUD操作，遵循反应式范例，使用建立在反应式流之上的项目反应堆类型。</p><pre class="km kn ko kp gt ms me mt mu aw mv bi"><span id="fe98" class="mg kz iq me b gy mw mx l my mz">@NoRepositoryBean<br/><strong class="me ir">public interface </strong>ReactiveCrudRepository&lt;T, ID&gt; <strong class="me ir">extends </strong>Repository&lt;T, ID&gt; {<br/>    &lt;S <strong class="me ir">extends </strong>T&gt; Mono&lt;S&gt; save(S var1);<br/><br/>    &lt;S <strong class="me ir">extends </strong>T&gt; Flux&lt;S&gt; saveAll(Iterable&lt;S&gt; var1);<br/><br/>    &lt;S <strong class="me ir">extends </strong>T&gt; Flux&lt;S&gt; saveAll(Publisher&lt;S&gt; var1);<br/><br/>    Mono&lt;T&gt; findById(ID var1);<br/><br/>    Mono&lt;T&gt; findById(Publisher&lt;ID&gt; var1);<br/><br/>    Mono&lt;Boolean&gt; existsById(ID var1);<br/><br/>    Mono&lt;Boolean&gt; existsById(Publisher&lt;ID&gt; var1);<br/><br/>    Flux&lt;T&gt; findAll();<br/><br/>    Flux&lt;T&gt; findAllById(Iterable&lt;ID&gt; var1);<br/><br/>    Flux&lt;T&gt; findAllById(Publisher&lt;ID&gt; var1);<br/><br/>    Mono&lt;Long&gt; count();<br/><br/>    Mono&lt;Void&gt; deleteById(ID var1);<br/><br/>    Mono&lt;Void&gt; deleteById(Publisher&lt;ID&gt; var1);<br/><br/>    Mono&lt;Void&gt; delete(T var1);<br/><br/>    Mono&lt;Void&gt; deleteAll(Iterable&lt;? <strong class="me ir">extends </strong>T&gt; var1);<br/><br/>    Mono&lt;Void&gt; deleteAll(Publisher&lt;? <strong class="me ir">extends </strong>T&gt; var1);<br/><br/>    Mono&lt;Void&gt; deleteAll();<br/>}</span></pre><p id="44fb" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">让我们扩展它，并为Account创建我们的存储库ReactiveAccountRepository。</p><pre class="km kn ko kp gt ms me mt mu aw mv bi"><span id="17e9" class="mg kz iq me b gy mw mx l my mz"><br/>@Repository<br/><strong class="me ir">public interface </strong>ReactiveAccountRepository <strong class="me ir">extends </strong>ReactiveCrudRepository&lt;Account, String&gt; {<br/><br/>    Flux&lt;Account&gt; findByCurrency(Currency currency);<br/>}</span></pre><p id="3d49" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">Spring框架在内部使用<a class="ae kx" href="https://projectreactor.io/" rel="noopener ugc nofollow" target="_blank">反应器</a>作为自己的反应支持。Reactor是一个Reactive Streams实现，它用<code class="fe mb mc md me b">Flux</code>和<code class="fe mb mc md me b">Mono</code>可组合API类型进一步扩展了基本Reactive Streams <code class="fe mb mc md me b">Publisher</code>契约，以提供对<code class="fe mb mc md me b">0..N</code>和<code class="fe mb mc md me b">0..1</code>数据序列的声明性操作。</p><h1 id="8c24" class="ky kz iq bd la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv bi translated">定义我们的控制器</h1><p id="cb51" class="pw-post-body-paragraph jn jo iq jp b jq lw js jt ju lx jw jx jy ly ka kb kc lz ke kf kg ma ki kj kk ij bi translated">要定义我们的控制器，我们只需要用@RestController进行注释，就像我们用spring-mvc一样。该控制器可以表现为简单的控制器，或者可以基于响应而反应。</p><pre class="km kn ko kp gt ms me mt mu aw mv bi"><span id="1f76" class="mg kz iq me b gy mw mx l my mz"><em class="na">/**<br/> * Created by rodrigo.chaves on 20/06/2017.<br/> */<br/></em>@RestController<br/>@RequestMapping(<strong class="me ir">"/accounts"</strong>)<br/><strong class="me ir">public class </strong>AccountController {<br/><br/>    <strong class="me ir">private final </strong>ReactiveAccountRepository <strong class="me ir">reactiveAccountRepository</strong>;<br/><br/>    <strong class="me ir">public </strong>AccountController(ReactiveAccountRepository reactiveAccountRepository) {<br/>        <strong class="me ir">this</strong>.<strong class="me ir">reactiveAccountRepository </strong>= reactiveAccountRepository;<br/>    }<br/><br/>    @RequestMapping(value = <strong class="me ir">"/search/bycurrency"</strong>, method = RequestMethod.<strong class="me ir"><em class="na">GET</em></strong>)<br/>    Flux&lt;Account&gt; findByCurrency(@RequestParam String currency) {<br/>        <strong class="me ir">return reactiveAccountRepository</strong>.findByCurrency(Currency.<em class="na">fromValue</em>(currency));<br/>    }<br/><br/>    @RequestMapping(value = <strong class="me ir">"/{id}"</strong>, method = RequestMethod.<strong class="me ir"><em class="na">GET</em></strong>)<br/>    Mono&lt;Account&gt; findById(@PathVariable String id) {<br/>        <strong class="me ir">return reactiveAccountRepository</strong>.findById(id);<br/>    }<br/><br/>    @RequestMapping(value = <strong class="me ir">"/"</strong>, method = RequestMethod.<strong class="me ir"><em class="na">POST</em></strong>)<br/>    Mono&lt;Account&gt; save(@RequestBody Account account) {<br/>        <strong class="me ir">return reactiveAccountRepository</strong>.save(account);<br/>    }<br/><br/>    @RequestMapping(value = <strong class="me ir">"/"</strong>, method = RequestMethod.<strong class="me ir"><em class="na">GET</em></strong>)<br/>    Flux&lt;Account&gt; findAll() {<br/>        <strong class="me ir">return reactiveAccountRepository</strong>.findAll();<br/>    }<br/>}</span></pre><p id="2a67" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">Spring框架在其自己的许多反应式API中公开了<code class="fe mb mc md me b">Flux</code>和<code class="fe mb mc md me b">Mono</code>。然而，在应用程序级别，Spring一如既往地提供了选择，并完全支持RxJava的使用。</p><h1 id="2ae4" class="ky kz iq bd la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv bi translated">测试</h1><p id="7c50" class="pw-post-body-paragraph jn jo iq jp b jq lw js jt ju lx jw jx jy ly ka kb kc lz ke kf kg ma ki kj kk ij bi translated">我们可以使用WebTestClient通过类似于<code class="fe mb mc md me b"><a class="ae kx" href="https://docs.spring.io/spring/docs/5.0.x/javadoc-api/org/springframework/web/reactive/function/client/WebClient.html" rel="noopener ugc nofollow" target="_blank">WebClient</a></code>的API来测试我们的服务器端点，并且实际上委托给一个<code class="fe mb mc md me b">WebClient</code>实例，但是侧重于测试。</p><pre class="km kn ko kp gt ms me mt mu aw mv bi"><span id="79df" class="mg kz iq me b gy mw mx l my mz">@RunWith(SpringRunner.<strong class="me ir">class</strong>)<br/>@SpringBootTest(webEnvironment = SpringBootTest.WebEnvironment.<strong class="me ir"><em class="na">DEFINED_PORT</em></strong>)<br/><strong class="me ir">public class </strong>ApplicationIntegrationTest {<br/><br/>    WebTestClient <strong class="me ir">webTestClient</strong>;<br/><br/><br/>    List&lt;Account&gt; <strong class="me ir">expectedAccounts</strong>;<br/><br/>    @Autowired<br/>    ReactiveAccountRepository <strong class="me ir">reactiveAccountRepository</strong>;<br/><br/>    @Before<br/>    <strong class="me ir">public void </strong>setup() {<br/>        <strong class="me ir">webTestClient </strong>= WebTestClient.<em class="na">bindToController</em>(<strong class="me ir">new </strong>AccountController(<strong class="me ir">reactiveAccountRepository</strong>)).build();<br/>        <strong class="me ir">expectedAccounts </strong>= <strong class="me ir">reactiveAccountRepository</strong>.findAll().collectList().block();<br/>    }<br/><br/>    @Test<br/>    <strong class="me ir">public void </strong>findAllAccountsTest() {<br/>        <strong class="me ir">this</strong>.<strong class="me ir">webTestClient</strong>.get().uri(<strong class="me ir">"/accounts/"</strong>)<br/>                .accept(<strong class="me ir"><em class="na">APPLICATION_JSON_UTF8</em></strong>)<br/>                .exchange()<br/>                .expectStatus().isOk()<br/>                .expectHeader().contentType(<strong class="me ir"><em class="na">APPLICATION_JSON_UTF8</em></strong>)<br/>                .expectBodyList(Account.<strong class="me ir">class</strong>).isEqualTo(<strong class="me ir">expectedAccounts</strong>);<br/>    }<br/><br/>    @Test<br/>    <strong class="me ir">public void </strong>streamAllAccountsTest() <strong class="me ir">throws </strong>Exception {<br/>        <strong class="me ir">this</strong>.<strong class="me ir">webTestClient</strong>.get()<br/>                .uri(<strong class="me ir">"/accounts/"</strong>)<br/>                .accept(<strong class="me ir"><em class="na">TEXT_EVENT_STREAM</em></strong>)<br/>                .exchange()<br/>                .expectStatus().isOk()<br/>                .expectHeader().contentType(<strong class="me ir"><em class="na">TEXT_EVENT_STREAM</em></strong>)<br/>                .returnResult(Account.<strong class="me ir">class</strong>);<br/>    }<br/><br/>    @Test<br/>    <strong class="me ir">public void </strong>streamAllAccountsByCurrencyTest() <strong class="me ir">throws </strong>Exception {<br/>        <strong class="me ir">this</strong>.<strong class="me ir">webTestClient</strong>.get()<br/>                .uri(<strong class="me ir">"/accounts/?currency=EUR"</strong>)<br/>                .accept(<strong class="me ir"><em class="na">TEXT_EVENT_STREAM</em></strong>)<br/>                .exchange()<br/>                .expectStatus().isOk()<br/>                .expectHeader().contentType(<strong class="me ir"><em class="na">TEXT_EVENT_STREAM</em></strong>)<br/>                .returnResult(Account.<strong class="me ir">class</strong>);<br/>    }<br/>}</span></pre><h1 id="2102" class="ky kz iq bd la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv bi translated">特性试验</h1><p id="a667" class="pw-post-body-paragraph jn jo iq jp b jq lw js jt ju lx jw jx jy ly ka kb kc lz ke kf kg ma ki kj kk ij bi translated">我们可以使用加特林测试我们的控制器的性能，最后我们会有一个非常酷的图表。该应用程序每秒将接收总共1000个请求，遵循以下操作CreatAndLoadAccountUSD、CreatAndLoadAccountEUR、CreateAndLoadAccountBR，然后是LoadAccountByCurrenciesBRL、LoadAccountByCurrenciesUSD和LoadAccountByCurrenciesEUR。</p><pre class="km kn ko kp gt ms me mt mu aw mv bi"><span id="9f9e" class="mg kz iq me b gy mw mx l my mz"><strong class="me ir">class </strong>AccountsLoadTest <strong class="me ir">extends </strong>Simulation {<br/>  <strong class="me ir">val </strong><em class="na">rampUpTimeSecs </em>= 5<br/>  <strong class="me ir">val </strong><em class="na">testTimeSecs </em>= 60<br/>  <strong class="me ir">val </strong><em class="na">noOfUsers </em>= 200<br/>  <strong class="me ir">val </strong><em class="na">noOfRequestPerSeconds </em>= 1000<br/><br/>  <strong class="me ir">val </strong><em class="na">baseURL </em>= <strong class="me ir">"http://localhost:8080"<br/>  val </strong><em class="na">accountResourcePath </em>= <strong class="me ir">"/accounts"<br/><br/>  object </strong>CreatAndLoadAccountUSD {<br/>    <strong class="me ir">val </strong><em class="na">create </em>= exec(http(<strong class="me ir">"CreateAccountUSD"</strong>)<br/>      .post(<em class="na">accountResourcePath </em>+ <strong class="me ir">"/"</strong>)<br/>      .body(RawFileBody(<strong class="me ir">"create_account_usd.json"</strong>))<br/>      .asJSON<br/>      .check(jsonPath(<strong class="me ir">"$.id"</strong>).saveAs(<strong class="me ir">"accountId"</strong>)))<br/><br/>    <strong class="me ir">val </strong><em class="na">load </em>= exec(http(<strong class="me ir">"LoadAccountUSD"</strong>)<br/>      .get(<em class="na">accountResourcePath </em>+ <strong class="me ir">"/${accountId}"</strong>)<br/>      .check(<em class="na">status</em>.is(HttpURLConnection.<em class="na">HTTP_OK</em>)))<br/>  }<br/><br/>  <strong class="me ir">object </strong>CreateAndLoadAccountBR {<br/>    <strong class="me ir">val </strong><em class="na">create </em>= exec(http(<strong class="me ir">"CreatAccountBR"</strong>)<br/>      .post(<em class="na">accountResourcePath </em>+ <strong class="me ir">"/"</strong>)<br/>      .body(RawFileBody(<strong class="me ir">"create_account_brl.json"</strong>))<br/>      .asJSON<br/>      .check(jsonPath(<strong class="me ir">"$.id"</strong>).saveAs(<strong class="me ir">"accountId"</strong>)))<br/><br/>    <strong class="me ir">val </strong><em class="na">load </em>= exec(http(<strong class="me ir">"LoadAccountBR"</strong>)<br/>      .get(<em class="na">accountResourcePath </em>+ <strong class="me ir">"/${accountId}"</strong>)<br/>      .check(<em class="na">status</em>.is(HttpURLConnection.<em class="na">HTTP_OK</em>)))<br/>  }<br/><br/>  <strong class="me ir">object </strong>CreatAndLoadAccountEUR {<br/>    <strong class="me ir">val </strong><em class="na">create </em>= exec(http(<strong class="me ir">"CreateAccountEUR"</strong>)<br/>      .post(<em class="na">accountResourcePath </em>+ <strong class="me ir">"/"</strong>)<br/>      .body(RawFileBody(<strong class="me ir">"create_account_eur.json"</strong>))<br/>      .asJSON<br/>      .check(jsonPath(<strong class="me ir">"$.id"</strong>).saveAs(<strong class="me ir">"accountId"</strong>)))<br/><br/>    <strong class="me ir">val </strong><em class="na">load </em>= exec(http(<strong class="me ir">"LoadAccountEUR"</strong>)<br/>      .get(<em class="na">accountResourcePath </em>+ <strong class="me ir">"/${accountId}"</strong>)<br/>      .check(<em class="na">status</em>.is(HttpURLConnection.<em class="na">HTTP_OK</em>)))<br/>  }<br/><br/>  <strong class="me ir">object </strong>LoadAccountByCurrencies {<br/>    <strong class="me ir">val </strong><em class="na">usd </em>= exec(http(<strong class="me ir">"LAByCurrencyUSD"</strong>)<br/>      .get(<em class="na">accountResourcePath </em>+ <strong class="me ir">"/search/bycurrency?currency=usd"</strong>)<br/>      .check(<em class="na">status</em>.is(HttpURLConnection.<em class="na">HTTP_OK</em>)))<br/>    <strong class="me ir">val </strong><em class="na">br </em>= exec(http(<strong class="me ir">"LAByCurrencyBR"</strong>)<br/>      .get(<em class="na">accountResourcePath </em>+ <strong class="me ir">"/search/bycurrency?currency=br"</strong>)<br/>      .check(<em class="na">status</em>.is(HttpURLConnection.<em class="na">HTTP_OK</em>)))<br/>    <strong class="me ir">val </strong><em class="na">eur </em>= exec(http(<strong class="me ir">"LAByCurrencyEUR"</strong>)<br/>      .get(<em class="na">accountResourcePath </em>+ <strong class="me ir">"/search/bycurrency?currency=eur"</strong>)<br/>      .check(<em class="na">status</em>.is(HttpURLConnection.<em class="na">HTTP_OK</em>)))<br/>  }<br/><br/>  <strong class="me ir">val </strong><em class="na">httpProtocol </em>= http<br/>    .baseURL(<em class="na">baseURL</em>)<br/>    .acceptHeader(<strong class="me ir">"application/json"</strong>)<br/>    .userAgentHeader(<strong class="me ir">"Gatling"</strong>)<br/><br/>  <strong class="me ir">val </strong><em class="na">testScenario </em>= scenario(<strong class="me ir">"LoadTest"</strong>)<br/>    .during(<em class="na">testTimeSecs</em>) {<br/>      exec(<br/>        CreatAndLoadAccountUSD.<em class="na">create</em>,<br/>        CreatAndLoadAccountUSD.<em class="na">load</em>,<br/>        CreatAndLoadAccountEUR.<em class="na">create</em>,<br/>        CreatAndLoadAccountEUR.<em class="na">load</em>,<br/>        CreateAndLoadAccountBR.<em class="na">create</em>,<br/>        CreateAndLoadAccountBR.<em class="na">load</em>,<br/>        LoadAccountByCurrencies.<em class="na">eur</em>,<br/>        LoadAccountByCurrencies.<em class="na">usd</em>,<br/>        LoadAccountByCurrencies.<em class="na">br<br/>      </em>)<br/>    }<br/><br/>  setUp(<br/>    <em class="na">testScenario<br/>      </em>.inject(atOnceUsers(<em class="na">noOfUsers</em>)))<br/>    .throttle(<br/>      reachRps(<em class="na">noOfRequestPerSeconds</em>) in (<em class="na">rampUpTimeSecs </em>seconds),<br/>      holdFor(<em class="na">testTimeSecs </em>seconds))<br/>    .protocols(<em class="na">httpProtocol</em>)<br/>}</span></pre><p id="06b6" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">一个有趣的测试是比较web-mvc REST应用程序和reactive REST应用程序+ reactive mongo DB。这是我们的结果:</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi nq"><img src="../Images/0fa6dc77f1655b283555054338a19db2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*HRbLAELA_vjHAh9XpRzc9w.png"/></div></div><figcaption class="nr ns gj gh gi nt nu bd b be z dk translated">反应静止—负荷账户</figcaption></figure><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi nq"><img src="../Images/bb89503c37a5bcecde14cbf924faed9d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*oK8mm-nH92Y7wgZ_9eetog.png"/></div></div><figcaption class="nr ns gj gh gi nt nu bd b be z dk translated">简单REST — LoadAccount</figcaption></figure><p id="d797" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">两项测试完全相同。LoadAccountUSD读取所有美元账户，Reactive REST我们有1000多个响应时间更短的呼叫(t &lt; 800 ms). The main reason of this result is that we're using a Reactive MongoDB. This example from <a class="ae kx" href="http://reactivemongo.org/" rel="noopener ugc nofollow" target="_blank"> Reactive Mongo </a>，很好地说明了我们所看到的情况:</p><blockquote class="nv nw nx"><p id="5a34" class="jn jo na jp b jq jr js jt ju jv jw jx ny jz ka kb nz kd ke kf oa kh ki kj kk ij bi translated">假设您有一个web应用程序，对数据库进行10次并发访问。这意味着您最终会同时拥有10个冻结的线程，除了等待响应之外什么也不做。一个常见的解决方案是增加运行线程的数量，以处理更多的请求。如果您的应用程序负载不是很重，这样的资源浪费实际上并不是问题，但是如果您要处理100个甚至1000个以上的请求，执行每个DB查询，会发生什么情况呢？乘法增长非常快。</p></blockquote><h1 id="a74e" class="ky kz iq bd la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv bi translated">结论</h1><p id="bb30" class="pw-post-body-paragraph jn jo iq jp b jq lw js jt ju lx jw jx jy ly ka kb kc lz ke kf kg ma ki kj kk ij bi translated">Spring 5将改变我们构建REST APIs的方式，但是要发布一个稳定版本的web-flux还需要做很多工作。我在编写此服务时遇到的问题:</p><ul class=""><li id="1b51" class="nb nc iq jp b jq jr ju jv jy nd kc ne kg nf kk ng nh ni nj bi translated"><strong class="jp ir"> API文档:</strong> springfox仍然不支持web-flux，但在他们的平原支持它。<a class="ae kx" href="https://github.com/springfox/springfox/issues/1773" rel="noopener ugc nofollow" target="_blank">详情</a></li><li id="9e65" class="nb nc iq jp b jq nk ju nl jy nm kc nn kg no kk ng nh ni nj bi translated"><strong class="jp ir"> Spring Security: </strong>仍然不支持。</li><li id="6d79" class="nb nc iq jp b jq nk ju nl jy nm kc nn kg no kk ng nh ni nj bi translated"><strong class="jp ir">文档:</strong>我们仍处于发布候选阶段，文档正在改进，但仍不成熟。</li></ul><p id="fc77" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我的建议是，如果你想在GA版本发布后马上使用web-flux，考虑一下你会从这种新方法中得到什么和失去什么。</p><p id="e3cd" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这个例子可以在<a class="ae kx" href="https://github.com/LINKIT-Group/spring-rest-reactive" rel="noopener ugc nofollow" target="_blank">https://github.com/LINKIT-Group/spring-rest-reactive</a>下载</p></div></div>    
</body>
</html>