<html>
<head>
<title>Kubernetes: part 4 — AWS EKS authentification, aws-iam-authenticator, and AWS IAM</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Kubernetes:第4部分— AWS EKS身份验证、aws-iam-authenticator和AWS IAM</h1>
<blockquote>原文：<a href="https://itnext.io/kubernetes-part-4-aws-eks-authentification-aws-iam-authenticator-and-aws-iam-5985d5af9317?source=collection_archive---------3-----------------------#2019-09-03">https://itnext.io/kubernetes-part-4-aws-eks-authentification-aws-iam-authenticator-and-aws-iam-5985d5af9317?source=collection_archive---------3-----------------------#2019-09-03</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div class="gh gi jn"><img src="../Images/8d0fa050e2a1ffdab9f4a92c846f2631.png" data-original-src="https://miro.medium.com/v2/resize:fit:260/format:webp/0*QjUL17uqdnIB6qZn.png"/></div></figure><p id="e48f" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">让我们继续我们的AWS弹性Kubernetes服务，<em class="ks"> EKS </em>。</p><p id="b588" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">以前的零件:</p><ul class=""><li id="d45c" class="kt ku iq jw b jx jy kb kc kf kv kj kw kn kx kr ky kz la lb bi translated"><a class="ae lc" href="https://rtfm.co.ua/en/kubernetes-part-1-architecture-and-main-components-overview/" rel="noopener ugc nofollow" target="_blank"> Kubernetes:第1部分—架构和主要组件概述</a></li><li id="e908" class="kt ku iq jw b jx ld kb le kf lf kj lg kn lh kr ky kz la lb bi translated"><a class="ae lc" href="https://rtfm.co.ua/en/kubernetes-part-2-a-cluster-set-up-on-aws-with-aws-cloud-provider-and-aws-loadbalancer/" rel="noopener ugc nofollow" target="_blank"> Kubernetes:第2部分—使用AWS云提供商和AWS负载平衡器在AWS上建立一个集群</a></li><li id="6948" class="kt ku iq jw b jx ld kb le kf lf kj lg kn lh kr ky kz la lb bi translated"><a class="ae lc" href="https://rtfm.co.ua/en/kubernetes-part-3-aws-eks-overview-and-manual-eks-cluster-set-up/" rel="noopener ugc nofollow" target="_blank"> Kubernetes:第3部分— AWS EKS概述和手动EKS集群设置</a>。</li></ul><p id="dd08" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">在之前的— <a class="ae lc" href="https://rtfm.co.ua/en/kubernetes-part-3-aws-eks-overview-and-manual-eks-cluster-set-up/" rel="noopener ugc nofollow" target="_blank"> Kubernetes:第3部分— AWS EKS概述和手动EKS集群设置</a> —部分中，我们启动了一个EKS集群。</p><p id="2af3" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated"><code class="fe li lj lk ll b">kubectl</code>正在工作，一切顺利。</p><p id="a58f" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">但是，当我团队的后端开发人员执行<code class="fe li lj lk ll b">aws eks update-kubeconfig</code>命令来配置macOS上的<code class="fe li lj lk ll b">kubectl</code>工具，并第一次尝试连接到这个集群时，他得到了下一个错误:</p><pre class="lm ln lo lp gt lq ll lr ls aw lt bi"><span id="abb8" class="lu lv iq ll b gy lw lx l ly lz">root@ip-10–0–42–255:~# kubectl get nodes<br/>error: You must be logged in to the server (Unauthorized)</span></pre><p id="9d5c" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">两个用户——我的，因为我使用我自己的IAM用户创建了这个集群，和我们的后端开发人员——在他们的AWS帐户上都有FullAdmin权限——这里会有什么问题呢？</p><p id="39b7" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">好吧，让我们深入了解一下EKS和AWS的认证和授权流程。</p><p id="7a4f" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">在本主题中，我们将讨论:</p><ul class=""><li id="9cab" class="kt ku iq jw b jx jy kb kc kf kv kj kw kn kx kr ky kz la lb bi translated"><a class="ae lc" href="https://rtfm.co.ua/en/kubernetes-part-4-aws-eks-authentification-aws-iam-authenticator-and-aws-iam/#Authentication_vs_Authorization" rel="noopener ugc nofollow" target="_blank">认证vs授权</a></li><li id="84fc" class="kt ku iq jw b jx ld kb le kf lf kj lg kn lh kr ky kz la lb bi translated"><a class="ae lc" href="https://rtfm.co.ua/en/kubernetes-part-4-aws-eks-authentification-aws-iam-authenticator-and-aws-iam/#Authentication" rel="noopener ugc nofollow" target="_blank">认证</a></li><li id="0d5b" class="kt ku iq jw b jx ld kb le kf lf kj lg kn lh kr ky kz la lb bi translated"><a class="ae lc" href="https://rtfm.co.ua/en/kubernetes-part-4-aws-eks-authentification-aws-iam-authenticator-and-aws-iam/#Authorization" rel="noopener ugc nofollow" target="_blank">授权</a></li><li id="6577" class="kt ku iq jw b jx ld kb le kf lf kj lg kn lh kr ky kz la lb bi translated"><a class="ae lc" href="https://rtfm.co.ua/en/kubernetes-part-4-aws-eks-authentification-aws-iam-authenticator-and-aws-iam/#AWS_EKS_Authentication_and_Authorization" rel="noopener ugc nofollow" target="_blank"> AWS EKS认证和授权</a></li><li id="7d98" class="kt ku iq jw b jx ld kb le kf lf kj lg kn lh kr ky kz la lb bi translated"><a class="ae lc" href="https://rtfm.co.ua/en/kubernetes-part-4-aws-eks-authentification-aws-iam-authenticator-and-aws-iam/#AWS_EKS_IAM_Authentication" rel="noopener ugc nofollow" target="_blank"> AWS EKS IAM认证</a></li><li id="45ed" class="kt ku iq jw b jx ld kb le kf lf kj lg kn lh kr ky kz la lb bi translated"><a class="ae lc" href="https://rtfm.co.ua/en/kubernetes-part-4-aws-eks-authentification-aws-iam-authenticator-and-aws-iam/#kubectl_authentification" rel="noopener ugc nofollow" target="_blank"> kubectl认证</a></li><li id="30c2" class="kt ku iq jw b jx ld kb le kf lf kj lg kn lh kr ky kz la lb bi translated"><a class="ae lc" href="https://rtfm.co.ua/en/kubernetes-part-4-aws-eks-authentification-aws-iam-authenticator-and-aws-iam/#AWS_CLI_vs_aws-iam-authenticator" rel="noopener ugc nofollow" target="_blank">AWS CLI vs AWS-iam-authenticator</a></li><li id="1a66" class="kt ku iq jw b jx ld kb le kf lf kj lg kn lh kr ky kz la lb bi translated"><a class="ae lc" href="https://rtfm.co.ua/en/kubernetes-part-4-aws-eks-authentification-aws-iam-authenticator-and-aws-iam/#AWS_profiles" rel="noopener ugc nofollow" target="_blank"> AWS配置文件</a></li><li id="dd33" class="kt ku iq jw b jx ld kb le kf lf kj lg kn lh kr ky kz la lb bi translated"><a class="ae lc" href="https://rtfm.co.ua/en/kubernetes-part-4-aws-eks-authentification-aws-iam-authenticator-and-aws-iam/#heptio-authenticator-aws_vs_aws-iam-authenticator" rel="noopener ugc nofollow" target="_blank">heptio-authenticator-AWS vs AWS-iam-authenticator</a></li><li id="2fff" class="kt ku iq jw b jx ld kb le kf lf kj lg kn lh kr ky kz la lb bi translated"><a class="ae lc" href="https://rtfm.co.ua/en/kubernetes-part-4-aws-eks-authentification-aws-iam-authenticator-and-aws-iam/#AWS_EKS_aws-auth_ConfigMap" rel="noopener ugc nofollow" target="_blank"> AWS EKS aws-auth配置图</a></li><li id="e874" class="kt ku iq jw b jx ld kb le kf lf kj lg kn lh kr ky kz la lb bi translated"><a class="ae lc" href="https://rtfm.co.ua/en/kubernetes-part-4-aws-eks-authentification-aws-iam-authenticator-and-aws-iam/#Adding_a_new_user_to_the_clusters_ConfigMap" rel="noopener ugc nofollow" target="_blank">向集群的配置图添加新用户</a></li><li id="ebd1" class="kt ku iq jw b jx ld kb le kf lf kj lg kn lh kr ky kz la lb bi translated"><a class="ae lc" href="https://rtfm.co.ua/en/kubernetes-part-4-aws-eks-authentification-aws-iam-authenticator-and-aws-iam/#root_aka_Cluster_creator" rel="noopener ugc nofollow" target="_blank">“根”又名集群创建者</a></li><li id="54c6" class="kt ku iq jw b jx ld kb le kf lf kj lg kn lh kr ky kz la lb bi translated"><a class="ae lc" href="https://rtfm.co.ua/en/kubernetes-part-4-aws-eks-authentification-aws-iam-authenticator-and-aws-iam/#Useful_links" rel="noopener ugc nofollow" target="_blank">有用链接</a></li></ul><p id="5912" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">在下一部分，我们将了解Kubernetes中的RBAC是什么，以及它是如何用于用户授权的。</p></div><div class="ab cl ma mb hu mc" role="separator"><span class="md bw bk me mf mg"/><span class="md bw bk me mf mg"/><span class="md bw bk me mf"/></div><div class="ij ik il im in"><h2 id="063b" class="lu lv iq bd mh mi mj dn mk ml mm dp mn kf mo mp mq kj mr ms mt kn mu mv mw mx bi translated">身份验证与授权</h2><p id="ae3a" class="pw-post-body-paragraph ju jv iq jw b jx my jz ka kb mz kd ke kf na kh ki kj nb kl km kn nc kp kq kr ij bi translated">首先，让我们快速检查一下用户认证和授权之间的区别。</p><h2 id="01a2" class="lu lv iq bd mh mi mj dn mk ml mm dp mn kf mo mp mq kj mr ms mt kn mu mv mw mx bi translated">证明</h2><p id="a64c" class="pw-post-body-paragraph ju jv iq jw b jx my jz ka kb mz kd ke kf na kh ki kj nb kl km kn nc kp kq kr ij bi translated">认证是一个客户端必须向服务器证明他就是他所声称的那个人的过程。</p><p id="1f15" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">例如，在我们创建了一个EKS集群之后，我们启动了Worker Nodes实例。他们必须调用EKS的API服务器来连接到集群。</p><p id="d550" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">在此期间，API服务器必须能够检查客户端要求他充当工作节点的内容，并且它对此拥有权限。</p><p id="faec" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">为此，Kubernetes提供了<em class="ks">认证模块</em>或<em class="ks">认证器</em>:当API服务器收到来自客户端的请求时，无论是像<code class="fe li lj lk ll b">kubectl</code>工具这样的客户端、新的工作节点，还是使用<code class="fe li lj lk ll b">curl</code>发出的HTTP请求，Kubernetes都会要求其配置的认证器之一验证该客户端。</p><p id="6b99" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">所有可用的模块都可以在<a class="ae lc" href="https://kubernetes.io/docs/reference/access-authn-authz/authentication/" rel="noopener ugc nofollow" target="_blank">文档</a>中找到，但是现在，我们感兴趣的是AWS Elastic Kubernetes服务中使用的一个模块——与AWS IAM一起使用来检查用户的<code class="fe li lj lk ll b">aws-iam-authenticator</code>。</p><h2 id="0059" class="lu lv iq bd mh mi mj dn mk ml mm dp mn kf mo mp mq kj mr ms mt kn mu mv mw mx bi translated">批准</h2><p id="210c" class="pw-post-body-paragraph ju jv iq jw b jx my jz ka kb mz kd ke kf na kh ki kj nb kl km kn nc kp kq kr ij bi translated">在我们的客户端通过认证过程之后——例如，Kubernreets必须检查这个用户是否可以执行客户端调用的某个操作——它是否有权限执行<code class="fe li lj lk ll b">kubectl get pods</code>命令。</p><p id="d8c4" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">如果调用AWS IAM策略，我们可以看到授予特定API调用的权限，例如:</p><figure class="lm ln lo lp gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="ne nf di ng bf nh"><div class="gh gi nd"><img src="../Images/e88853545bebd6dda1c3b0991f8f5221.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*nbCAhAspmWZHMMF8.png"/></div></div></figure><p id="5b6b" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">在这里的<em class="ks">动作中，</em>我们正在为一些将使用该策略的用户设置权限。如果这个用户试图执行“<code class="fe li lj lk ll b">s3:DeleteObject</code>”调用，AWS将拒绝它，因为这个请求没有在这个用户的策略中指定(整个AWS通过API调用工作，就像在Kubernetes中一样)。</p><p id="ad6d" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">与认证过程类似，Kubernetes有<em class="ks">个授权模块</em>或<em class="ks">个授权者</em>，例如<a class="ae lc" href="https://kubernetes.io/docs/reference/access-authn-authz/abac/" rel="noopener ugc nofollow" target="_blank">基于属性的访问控制(ABAC) </a>和<a class="ae lc" href="https://kubernetes.io/docs/reference/access-authn-authz/rbac/" rel="noopener ugc nofollow" target="_blank">基于角色的访问控制(RBAC) </a>。</p><p id="739b" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">Kubernetes会将已经通过<em class="ks">身份验证</em>模块验证的用户传递给<em class="ks">授权</em>模块，以检查其权限，然后API服务器将决定是否必须执行客户端请求的精确操作。</p><p id="ea26" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">参见此处的文档— <a class="ae lc" href="https://kubernetes.io/docs/reference/access-authn-authz/controlling-access/" rel="noopener ugc nofollow" target="_blank">控制对Kubernetes API的访问</a>。</p><p id="23f4" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">在下面的帖子中，我们将看到AWS IAM在AWS EKS的认证过程是如何工作的，在下一个帖子中，我们将讨论Kubernetes中的授权和RBAC。</p></div><div class="ab cl ma mb hu mc" role="separator"><span class="md bw bk me mf mg"/><span class="md bw bk me mf mg"/><span class="md bw bk me mf"/></div><div class="ij ik il im in"><h2 id="7db6" class="lu lv iq bd mh mi mj dn mk ml mm dp mn kf mo mp mq kj mr ms mt kn mu mv mw mx bi translated">AWS EKS认证和授权</h2><p id="557d" class="pw-post-body-paragraph ju jv iq jw b jx my jz ka kb mz kd ke kf na kh ki kj nb kl km kn nc kp kq kr ij bi translated">下图详细描述了这一过程:</p><figure class="lm ln lo lp gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="ne nf di ng bf nh"><div class="gh gi ni"><img src="../Images/52d30f59ea30fe7a7faf3f0c651781dc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*_Sm3_69HW_LIvAGG.png"/></div></div></figure><h2 id="6cf7" class="lu lv iq bd mh mi mj dn mk ml mm dp mn kf mo mp mq kj mr ms mt kn mu mv mw mx bi translated">AWS EKS IAM认证</h2><p id="6b44" class="pw-post-body-paragraph ju jv iq jw b jx my jz ka kb mz kd ke kf na kh ki kj nb kl km kn nc kp kq kr ij bi translated">对于认证，AWS EKS使用web令牌—参见<a class="ae lc" href="https://kubernetes.io/docs/reference/access-authn-authz/authentication/#webhook-token-authentication" rel="noopener ugc nofollow" target="_blank"> Webhook令牌认证</a>:客户端将传递包含用户标识符的特殊格式的令牌。</p><p id="81dd" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">在AWS EKS的情况下，该标识可以是IAM用户或IAM角色的ARN ( <em class="ks"> Amazon资源名称</em>)。</p><p id="5297" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">Kubernetes authenticator将依次将从该令牌中提取的标识符传递给AWS IAM服务，以通过使用运行在EKS控制平面上的<a class="ae lc" href="https://github.com/kubernetes-sigs/aws-iam-authenticator" rel="noopener ugc nofollow" target="_blank"> AWS IAM Authenticator </a>服务来检查令牌中指定的用户是否确实是他所声称的用户。</p><p id="1d38" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">例如，流程是:</p><ul class=""><li id="02ed" class="kt ku iq jw b jx jy kb kc kf kv kj kw kn kx kr ky kz la lb bi translated">客户机向API服务器发出q请求，传递带有用户标识符的访问令牌</li><li id="11af" class="kt ku iq jw b jx ld kb le kf lf kj lg kn lh kr ky kz la lb bi translated">API服务器将这个令牌传递给另一个Kubernetes控制平面的服务— <code class="fe li lj lk ll b">aws-iam-authenticator</code></li><li id="f74a" class="kt ku iq jw b jx ld kb le kf lf kj lg kn lh kr ky kz la lb bi translated"><code class="fe li lj lk ll b">aws-iam-authenticator</code>请求AWS IAM服务并传递该标识符，以检查该用户是否有效，以及他是否有权访问EKS集群</li><li id="7e8e" class="kt ku iq jw b jx ld kb le kf lf kj lg kn lh kr ky kz la lb bi translated">AWS IAM使用与作为用户标识符的令牌中传递的ACCESS_KEY绑定的密钥进行内部身份验证检查</li><li id="2003" class="kt ku iq jw b jx ld kb le kf lf kj lg kn lh kr ky kz la lb bi translated">AWS IAM通过检查绑定到该用户的IAM策略进行内部授权检查——必须拒绝没有<a class="ae lc" href="https://docs.aws.amazon.com/en_us/IAM/latest/UserGuide/list_amazonelasticcontainerserviceforkubernetes.html" rel="noopener ugc nofollow" target="_blank"> API调用</a>到<code class="fe li lj lk ll b">eks::*</code>资源的用户</li><li id="3361" class="kt ku iq jw b jx ld kb le kf lf kj lg kn lh kr ky kz la lb bi translated"><code class="fe li lj lk ll b">aws-iam-authenticator</code>返回到Kubernetes集群，通过<code class="fe li lj lk ll b">aws-auth</code>配置图进行检查(很快将在<a class="ae lc" href="https://rtfm.co.ua/en/kubernetes-part-4-aws-eks-authentification-aws-iam-authenticator-and-aws-iam/#AWS_EKS_aws-auth_ConfigMap" rel="noopener ugc nofollow" target="_blank"> AWS EKS aws-auth配置图</a>中看到)——该用户是否有权访问该集群</li><li id="d6fa" class="kt ku iq jw b jx ld kb le kf lf kj lg kn lh kr ky kz la lb bi translated"><code class="fe li lj lk ll b">aws-iam-authenticator</code>向API服务器返回批准/拒绝响应</li><li id="ec39" class="kt ku iq jw b jx ld kb le kf lf kj lg kn lh kr ky kz la lb bi translated">API服务器依次将或执行用户请求的动作，或将返回“<em class="ks">您必须登录到服务器(未授权)</em>”消息</li></ul><p id="af14" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated"><strong class="jw ir"> <em class="ks">注</em> </strong> <em class="ks">:之前使用的是</em> <a class="ae lc" href="https://kubernetes.io/docs/concepts/cluster-administration/cloud-providers/#aws" rel="noopener ugc nofollow" target="_blank"> <em class="ks"> AWS云提供商</em> </a> <em class="ks">而不是</em> <code class="fe li lj lk ll b"><em class="ks">aws-iam-authenticator</em></code> <em class="ks">，查看</em><a class="ae lc" href="https://rtfm.co.ua/en/kubernetes-part-2-a-cluster-set-up-on-aws-with-aws-cloud-provider-and-aws-loadbalancer/" rel="noopener ugc nofollow" target="_blank"><em class="ks">Kubernetes:part 2——一个在AWS上设置的集群，有AWS云提供商和AWS负载平衡器</em> </a> <em class="ks">帖子了解详情。</em></p><p id="5ceb" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated"><code class="fe li lj lk ll b">aws-iam-authenticator</code>本身可以在两端使用——只是在服务器端它被启动为<code class="fe li lj lk ll b">aws-iam-authenticator server</code>，而在客户端——<code class="fe li lj lk ll b">aws-iam-authenticator token -i</code>:</p><figure class="lm ln lo lp gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="ne nf di ng bf nh"><div class="gh gi nj"><img src="../Images/236926712e41ec4e40ac9d206f26a40c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*lQBah2yMKzkDWrmT.png"/></div></div></figure><p id="f26c" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">但是在我当前的例子中，客户端(kubectl)通过发出<code class="fe li lj lk ll b">aws eks update-kubeconfig</code>命令进行配置，并使用AWS CLI而不是上图中的<code class="fe li lj lk ll b">aws-iam-authenticator</code>(更多信息请参见<a class="ae lc" href="https://rtfm.co.ua/en/kubernetes-part-4-aws-eks-authentification-aws-iam-authenticator-and-aws-iam/#AWS_CLI_vs_aws-iam-authenticator" rel="noopener ugc nofollow" target="_blank">AWS CLI vs AWS-iam-authenticator</a>)。</p><h2 id="08a1" class="lu lv iq bd mh mi mj dn mk ml mm dp mn kf mo mp mq kj mr ms mt kn mu mv mw mx bi translated"><code class="fe li lj lk ll b">kubectl</code>认证</h2><p id="2efb" class="pw-post-body-paragraph ju jv iq jw b jx my jz ka kb mz kd ke kf na kh ki kj nb kl km kn nc kp kq kr ij bi translated">让我们使用本地工作站上的<code class="fe li lj lk ll b">kubectl</code>作为客户端来查看整个过程。</p><p id="2275" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">因此，<code class="fe li lj lk ll b">kubectl</code>首先将检查<code class="fe li lj lk ll b">~/.kube/config</code>文件，在那里它将获取一个EKS集群的API-server URL:</p><pre class="lm ln lo lp gt lq ll lr ls aw lt bi"><span id="5e99" class="lu lv iq ll b gy lw lx l ly lz">...<br/>server: <a class="ae lc" href="https://715***834.sk1.us-east-2.eks.amazonaws.com" rel="noopener ugc nofollow" target="_blank">https://715***834.sk1.us-east-2.eks.amazonaws.com</a><br/>...</span></pre><p id="4ab4" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">接下来，看看配置文件的下一部分，特别是我们感兴趣的<code class="fe li lj lk ll b">exec</code>，尤其是<code class="fe li lj lk ll b">command</code>和<code class="fe li lj lk ll b">args</code>:</p><pre class="lm ln lo lp gt lq ll lr ls aw lt bi"><span id="4f60" class="lu lv iq ll b gy lw lx l ly lz">...<br/>    exec:<br/>      apiVersion: client.authentication.k8s.io/v1alpha1<br/>      args:<br/>      - --region<br/>      - us-east-2<br/>      - eks<br/>      - get-token<br/>      - --cluster-name<br/>      - mobilebackend-dev-eks-0-cluster<br/>      command: aws<br/>...</span></pre><p id="03c5" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">其中描述了使用AWS CLI命令<code class="fe li lj lk ll b"><a class="ae lc" href="https://docs.aws.amazon.com/en_us/eks/latest/userguide/managing-auth.html" rel="noopener ugc nofollow" target="_blank">aws eks get-token</a></code>获取EKS身份验证令牌的命令。</p><p id="a712" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">玩一玩WS API认证会很有趣，一些快速搜索的例子可以在AWS S3的<a class="ae lc" href="https://docs.aws.amazon.com/en_us/AmazonS3/latest/dev/RESTAuthentication.html" rel="noopener ugc nofollow" target="_blank">开发者指南</a>中找到，如果有时间，也许会尝试使用<code class="fe li lj lk ll b">curl</code>实用程序来完成整个工作，因为AWS CLI只是向AWS核心发出API请求，就像我们在<code class="fe li lj lk ll b">kubectl</code>和Kubernetes API-endpoint中看到的一样。</p><p id="6f2a" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">现在—让我们使用在<code class="fe li lj lk ll b">command</code>部分指定的命令，并传递在<code class="fe li lj lk ll b">args</code>中设置的参数:</p><pre class="lm ln lo lp gt lq ll lr ls aw lt bi"><span id="7d8b" class="lu lv iq ll b gy lw lx l ly lz">$ aws — profile arseniy — region us-east-2 eks get-token — cluster-name mobilebackend-dev-eks-0-cluster<br/>{“kind”: “ExecCredential”, “apiVersion”: “client.authentication.k8s.io/v1alpha1”, “spec”: {}, “status”: {“expirationTimestamp”: “2019–08–31T10:27:24Z”, “token”: “k8s-aws-v1.aHR…zEy”}}</span></pre><p id="887b" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated"><em class="ks">“令牌”:“k8s-AWS-v1 . ahr…zEy”</em>—这是我们的令牌。</p><p id="9a4b" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">您可以在<a class="ae lc" href="https://www.base64decode.org" rel="noopener ugc nofollow" target="_blank">https://www.base64decode.org</a>上查看其内容(在第一个“<code class="fe li lj lk ll b">_</code>符号后插入令牌的内容)。</p><p id="a22b" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">这是我们在上面的案例中得到的结果:</p><blockquote class="nk nl nm"><p id="a903" class="ju jv ks jw b jx jy jz ka kb kc kd ke nn kg kh ki no kk kl km np ko kp kq kr ij bi translated">action = getcalleriddentity &amp; Version = 2011–06–15 &amp; X-Amz-Algorithm = AWS 4-HMAC-sha 256 &amp; X-Amz-Credential = AKI * * * D4Q % 2f 2019 08 31% 2 fus-east-1% 2 fsts % 2 faws 4 _ request &amp; X-Amz-Date = 2019 08 31t 092243 z &amp; X-Amz-Expires = 0 &amp; X-Amz-signed headers = host % 3Bx-k88</p></blockquote><p id="c60c" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated"><em class="ks">Amz-Credential = AKI * * * D4Q</em>字段包含我们用户的ACCESS_KEY，取自<em class="ks"> arseny </em> AWS CLI配置文件(将在<a class="ae lc" href="https://rtfm.co.ua/en/kubernetes-part-4-aws-eks-authentification-aws-iam-authenticator-and-aws-iam/#AWS_profiles" rel="noopener ugc nofollow" target="_blank"> AWS配置文件</a>中讨论配置文件):</p><pre class="lm ln lo lp gt lq ll lr ls aw lt bi"><span id="3f85" class="lu lv iq ll b gy lw lx l ly lz">$ cat ~/.aws/credentials | grep -B1 -A2 AKI***D4Q<br/>[arseniy]<br/>aws_access_key_id = AKI***D4Q<br/>aws_secret_access_key = q0I***jvj</span></pre><p id="3696" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">所以:</p><ol class=""><li id="6d27" class="kt ku iq jw b jx jy kb kc kf kv kj kw kn kx kr nq kz la lb bi translated">我们正在传递访问密钥</li><li id="d99c" class="kt ku iq jw b jx ld kb le kf lf kj lg kn lh kr nq kz la lb bi translated">通过使用ACCESS_KEY —可以获得用户的ARN</li><li id="e90f" class="kt ku iq jw b jx ld kb le kf lf kj lg kn lh kr nq kz la lb bi translated">通过使用此ARN，EKS控制平面上的<code class="fe li lj lk ll b">aws-iam-authenticator</code>将检查这是否是有效用户，以及他是否可以访问我们的集群(将很快出现在<a class="ae lc" href="https://rtfm.co.ua/en/kubernetes-part-4-aws-eks-authentification-aws-iam-authenticator-and-aws-iam/#AWS_EKS_aws-auth_ConfigMap" rel="noopener ugc nofollow" target="_blank"> AWS EKS aws-auth配置图</a>中)</li></ol><p id="c5cf" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">让我们检查一下我们的访问密钥:</p><pre class="lm ln lo lp gt lq ll lr ls aw lt bi"><span id="998a" class="lu lv iq ll b gy lw lx l ly lz">$ aws — profile arseniy iam list-access-keys — user-name arseniy<br/>{<br/>“AccessKeyMetadata”: [<br/>{<br/>“UserName”: “arseniy”,<br/>“AccessKeyId”: “AKI***D4Q”,<br/>…</span></pre><p id="7a79" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">使用此密钥的AWS帐户:</p><pre class="lm ln lo lp gt lq ll lr ls aw lt bi"><span id="a1eb" class="lu lv iq ll b gy lw lx l ly lz">$ aws — profile arseniy sts get-access-key-info — access-key-id AKI***D4Q<br/>{<br/>“Account”: “534***385”<br/>}</span></pre><p id="2ed8" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">以及用户在该帐户中的ARN:</p><pre class="lm ln lo lp gt lq ll lr ls aw lt bi"><span id="cc8d" class="lu lv iq ll b gy lw lx l ly lz">$ aws — profile arseniy iam get-user — user-name arseniy<br/>{<br/>“User”: {<br/>“Path”: “/”,<br/>“UserName”: “arseniy”,<br/>“UserId”: “AID***JU6”,<br/>“Arn”: “arn:aws:iam::534***385:user/arseniy”,<br/>…</span></pre><p id="8509" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">一切都好。</p><h2 id="aceb" class="lu lv iq bd mh mi mj dn mk ml mm dp mn kf mo mp mq kj mr ms mt kn mu mv mw mx bi translated">AWS CLI与<code class="fe li lj lk ll b">aws-iam-authenticator</code></h2><p id="74a4" class="pw-post-body-paragraph ju jv iq jw b jx my jz ka kb mz kd ke kf na kh ki kj nb kl km kn nc kp kq kr ij bi translated">以同样的方式代替AWS CLI，我们可以使用<code class="fe li lj lk ll b">aws-iam-authenticator</code>来获得一个令牌，使我们的过程与上图完全相同。</p><p id="4336" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">您可以将它安装在适用于AUR的Arch Linux上:</p><pre class="lm ln lo lp gt lq ll lr ls aw lt bi"><span id="a51a" class="lu lv iq ll b gy lw lx l ly lz">$ yaourt -S aws-iam-authenticator-bin</span></pre><p id="dcbf" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">并获得您的令牌:</p><pre class="lm ln lo lp gt lq ll lr ls aw lt bi"><span id="2f26" class="lu lv iq ll b gy lw lx l ly lz">$ aws-iam-authenticator token -i mobilebackend-dev-eks-0-cluster<br/>{“kind”:”ExecCredential”,”apiVersion”:”client.authentication.k8s.io/v1alpha1",”spec”:{},”status”:{“expirationTimestamp”:”2019–08–31T10:38:41Z”,”token”:”k8s-aws-v1.aHR***ODU”}}</span></pre><p id="64b5" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">您也可以手动编辑您的<code class="fe li lj lk ll b">kubectl</code>的配置来设置<code class="fe li lj lk ll b">aws-iam-authenticator</code>，而不是AWS CLI。</p><p id="9fbe" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">因此，更换下一个零件:</p><pre class="lm ln lo lp gt lq ll lr ls aw lt bi"><span id="18ae" class="lu lv iq ll b gy lw lx l ly lz">...<br/>    exec:<br/>      apiVersion: client.authentication.k8s.io/v1alpha1<br/>      args:<br/>      - --region<br/>      - us-east-2<br/>      - eks<br/>      - get-token<br/>      - --cluster-name<br/>      - mobilebackend-dev-eks-0-cluster<br/>      command: aws<br/>...</span></pre><p id="908c" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">下一个:</p><pre class="lm ln lo lp gt lq ll lr ls aw lt bi"><span id="ad3b" class="lu lv iq ll b gy lw lx l ly lz">...<br/>    exec:<br/>      apiVersion: client.authentication.k8s.io/v1alpha1<br/>      args:<br/>        - token<br/>        - -i<br/>        - mobilebackend-dev-eks-0-cluster<br/>      command: aws-iam-authenticator<br/>      env:<br/>      - name: AWS_PROFILE<br/>        value: arseniy<br/>...</span></pre><p id="5fe4" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">检查访问:</p><pre class="lm ln lo lp gt lq ll lr ls aw lt bi"><span id="cc78" class="lu lv iq ll b gy lw lx l ly lz">$ kubectl auth can-i get pods<br/>yes</span></pre><p id="d1fe" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">因此，我们看到<code class="fe li lj lk ll b">kubectl</code>只是通过使用或AWS CLI ( <code class="fe li lj lk ll b">/usr/bin/aws</code>)或使用<code class="fe li lj lk ll b">/usr/bin/aws-iam-authenticator</code>使用其<code class="fe li lj lk ll b">~/.kube/conf</code>配置中指定的<code class="fe li lj lk ll b">command</code>来获取令牌。</p><h2 id="6222" class="lu lv iq bd mh mi mj dn mk ml mm dp mn kf mo mp mq kj mr ms mt kn mu mv mw mx bi translated">AWS配置文件</h2><p id="bee9" class="pw-post-body-paragraph ju jv iq jw b jx my jz ka kb mz kd ke kf na kh ki kj nb kl km kn nc kp kq kr ij bi translated">让我们看看<code class="fe li lj lk ll b">~/.kube/config</code>中的<code class="fe li lj lk ll b">env</code>部分:</p><pre class="lm ln lo lp gt lq ll lr ls aw lt bi"><span id="5cf6" class="lu lv iq ll b gy lw lx l ly lz">...<br/>      command: aws<br/>      env:<br/>      - name: AWS_PROFILE<br/>        value: arseniy</span></pre><p id="da7a" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">在这里，我们正在设置一个AWL CLI配置文件的名称，该名称将用于获取令牌，有关详细信息，请查看<a class="ae lc" href="https://rtfm.co.ua/en/aws-cli-named-profiles/" rel="noopener ugc nofollow" target="_blank"> AWS: CLI命名配置文件</a>帖子。</p><p id="6218" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">所以:</p><ol class=""><li id="0c9c" class="kt ku iq jw b jx jy kb kc kf kv kj kw kn kx kr nq kz la lb bi translated"><code class="fe li lj lk ll b">kubectl</code>显示为<code class="fe li lj lk ll b">~/.kube/config</code></li><li id="487e" class="kt ku iq jw b jx ld kb le kf lf kj lg kn lh kr nq kz la lb bi translated">获取API服务器URL</li><li id="5309" class="kt ku iq jw b jx ld kb le kf lf kj lg kn lh kr nq kz la lb bi translated">用于获取令牌的命令(<code class="fe li lj lk ll b">command</code> и <code class="fe li lj lk ll b">args</code>)</li><li id="2c6f" class="kt ku iq jw b jx ld kb le kf lf kj lg kn lh kr nq kz la lb bi translated">要使用的AWS CLI用户配置文件</li><li id="6077" class="kt ku iq jw b jx ld kb le kf lf kj lg kn lh kr nq kz la lb bi translated">请求AWS获取令牌</li><li id="8bcb" class="kt ku iq jw b jx ld kb le kf lf kj lg kn lh kr nq kz la lb bi translated">将此令牌发送到EKS API服务器并传递此令牌</li></ol><p id="5024" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">让我们检查一下。</p><p id="9428" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">获取令牌:</p><pre class="lm ln lo lp gt lq ll lr ls aw lt bi"><span id="4e61" class="lu lv iq ll b gy lw lx l ly lz">$ export AWS_PROFILE=arseniy<br/>$ aws-iam-authenticator token -i mobilebackend-dev-eks-0-cluster<br/>{“kind”:”ExecCredential”,”apiVersion”:”client.authentication.k8s.io/v1alpha1",”spec”:{},”status”:{“expirationTimestamp”:”2019–08–31T11:00:15Z”,”token”:”k8s-aws-v1.aHR***Y2E”}}</span></pre><p id="58b8" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">检查它-获取用户的ARN:</p><pre class="lm ln lo lp gt lq ll lr ls aw lt bi"><span id="5846" class="lu lv iq ll b gy lw lx l ly lz">$ aws-iam-authenticator token -verify -i mobilebackend-dev-eks-0-cluster -t $token&amp;{ARN:arn:aws:iam::534***385:user/arseniy CanonicalARN:arn:aws:iam::534***385:user/arseniy AccountID:534***385 UserID:AID***JU6 SessionName:}</span></pre><p id="8e40" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">为简单起见—将令牌保存到<code class="fe li lj lk ll b">$token</code>:</p><pre class="lm ln lo lp gt lq ll lr ls aw lt bi"><span id="fac8" class="lu lv iq ll b gy lw lx l ly lz">$ token=”k8s-aws-v1.aHR***Y2E”</span></pre><p id="62f0" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">并使用<code class="fe li lj lk ll b">curl</code>连接到API服务器:</p><pre class="lm ln lo lp gt lq ll lr ls aw lt bi"><span id="68bd" class="lu lv iq ll b gy lw lx l ly lz">$ curl -X GET <a class="ae lc" href="https://715***834.sk1.us-east-2.eks.amazonaws.com/api" rel="noopener ugc nofollow" target="_blank">https://715***834.sk1.us-east-2.eks.amazonaws.com/api</a> — insecure — header “Authorization: Bearer $token”<br/>{<br/>  “kind”: “APIVersions”,<br/>  “versions”: [<br/>    “v1”<br/>  ],<br/>  “serverAddressByClientCIDRs”: [<br/>  {<br/>    “clientCIDR”: “0.0.0.0/0”,<br/>    “serverAddress”: “ip-172–16–49–148.us-east-2.compute.internal:443”<br/>  }<br/>  ]<br/>}</span></pre><p id="6d3c" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">都在这里工作。</p><p id="3086" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">以同样的方式<code class="fe li lj lk ll b">kubectl</code>将执行它自己对EKS的请求。</p><p id="0012" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">顺便说一下，如果您为EKS集群启用了这些请求，那么您可以在CloudWatch日志中看到所有这些请求。</p><p id="d3cb" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">例如，可以在<em class="ks">认证者-*** </em>日志中找到认证日志:</p><figure class="lm ln lo lp gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="ne nf di ng bf nh"><div class="gh gi nr"><img src="../Images/9d755d21ce7a45f53d1b32a7d537cc3d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*zu9RLoSXFV-ht4_H.png"/></div></div></figure><h2 id="6997" class="lu lv iq bd mh mi mj dn mk ml mm dp mn kf mo mp mq kj mr ms mt kn mu mv mw mx bi translated"><code class="fe li lj lk ll b">heptio-authenticator-aws</code> vs <code class="fe li lj lk ll b">aws-iam-authenticator</code></h2><p id="30d5" class="pw-post-body-paragraph ju jv iq jw b jx my jz ka kb mz kd ke kf na kh ki kj nb kl km kn nc kp kq kr ij bi translated">起初，我很惊讶——如果AWS文档<a class="ae lc" href="https://docs.aws.amazon.com/en_us/eks/latest/userguide/managing-auth.html" rel="noopener ugc nofollow" target="_blank">告诉了</a>关于<code class="fe li lj lk ll b">aws-iam-authenticator</code>的信息，为什么我会在日志中看到<code class="fe li lj lk ll b">heptio-authenticator-aws</code>服务？检查<a class="ae lc" href="https://docs.aws.amazon.com/en_us/eks/latest/userguide/managing-auth.html" rel="noopener ugc nofollow" target="_blank">管理集群认证</a>。</p><p id="3222" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">但答案很简单:4.0版本<code class="fe li lj lk ll b">aws-iam-authenticator</code>之前叫<code class="fe li lj lk ll b">heptio-authenticator-aws</code>。</p><p id="43a1" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">参见<a class="ae lc" href="https://github.com/kubernetes-sigs/aws-iam-authenticator/releases/tag/v0.3.0" rel="noopener ugc nofollow" target="_blank"> v0.3.0 </a>和<a class="ae lc" href="https://github.com/kubernetes-sigs/aws-iam-authenticator/releases/tag/0.4.0-alpha.1" rel="noopener ugc nofollow" target="_blank">v 0 . 4 . 0-α1</a>标签。</p><p id="25b0" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">好了，我们已经检查了客户端的身份验证是如何工作的——那么AWS EKS呢？</p></div><div class="ab cl ma mb hu mc" role="separator"><span class="md bw bk me mf mg"/><span class="md bw bk me mf mg"/><span class="md bw bk me mf"/></div><div class="ij ik il im in"><h2 id="ba8f" class="lu lv iq bd mh mi mj dn mk ml mm dp mn kf mo mp mq kj mr ms mt kn mu mv mw mx bi translated">AWS EKS <code class="fe li lj lk ll b">aws-auth</code>配置图</h2><p id="10e9" class="pw-post-body-paragraph ju jv iq jw b jx my jz ka kb mz kd ke kf na kh ki kj nb kl km kn nc kp kq kr ij bi translated">然后，“认证魔法”在这里发生了:现在<code class="fe li lj lk ll b">aws-iam-authenticator</code>必须:</p><ol class=""><li id="1e15" class="kt ku iq jw b jx jy kb kc kf kv kj kw kn kx kr nq kz la lb bi translated">询问AWS IAM服务—它是否有这样的用户以及它是否有权限，例如，必须执行身份验证</li><li id="8063" class="kt ku iq jw b jx ld kb le kf lf kj lg kn lh kr nq kz la lb bi translated">在此之后,<code class="fe li lj lk ll b">aws-iam-authenticator</code>必须将该用户传递给Kubernetes API-server，然后Kubernetes将执行用户授权——该用户是否有权访问我们的集群以及可以使用哪些命令——这里将使用<code class="fe li lj lk ll b">aws-auth</code>配置图</li></ol><p id="70fa" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">如果回到<a class="ae lc" href="https://rtfm.co.ua/en/kubernetes-part-2-a-cluster-set-up-on-aws-with-aws-cloud-provider-and-aws-loadbalancer/" rel="noopener ugc nofollow" target="_blank"> Kubernetes:第2部分——在AWS上设置一个集群，使用AWS cloud-provider和AWS LoadBalancer </a>帖子——我们在那里创建了一个配置图，现在看起来如下:</p><pre class="lm ln lo lp gt lq ll lr ls aw lt bi"><span id="018a" class="lu lv iq ll b gy lw lx l ly lz">apiVersion: v1<br/>kind: ConfigMap<br/>metadata:<br/>  name: aws-auth<br/>  namespace: kube-system<br/>data:<br/>  mapRoles: |<br/>    - rolearn: arn:aws:iam::534***385:role/mobilebackend-dev-eks-0-wn-stack-NodeInstanceRole-15NNFZK6WW4IG<br/>      username: system:node:{{EC2PrivateDNSName}}<br/>      groups:<br/>        - system:bootstrappers<br/>        - system:nodes</span></pre><p id="c55a" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">在这里的<em class="ks">arn:AWS:iam::534 * * * 385:Role/mobilebackend-dev-eks-0-wn-stack-NodeInstanceRole-15 nnfzk 6 ww 4 ig</em>行中，我们添加了角色arn，该角色用作EC2的实例角色，我们的Worker节点将被检查权限。</p><h2 id="4191" class="lu lv iq bd mh mi mj dn mk ml mm dp mn kf mo mp mq kj mr ms mt kn mu mv mw mx bi translated">向群集的配置图添加新用户</h2><p id="7317" class="pw-post-body-paragraph ju jv iq jw b jx my jz ka kb mz kd ke kf na kh ki kj nb kl km kn nc kp kq kr ij bi translated">最后，让我们回到这篇文章的最开始:为什么另一个im-ser得到“<strong class="jw ir">你必须登录到服务器(未授权)</strong>”错误？</p><p id="95d5" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">从我们在配置图中看到的情况来看，这是显而易见的——因为没有这样的用户，因此——Kubernetes不能检查它的权限(实际上——因为这个用户有。</p><p id="1185" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">检查<code class="fe li lj lk ll b">aws-iam-authenticator</code>的<a class="ae lc" href="https://github.com/kubernetes-sigs/aws-iam-authenticator#full-configuration-format" rel="noopener ugc nofollow" target="_blank">文档</a>:</p><pre class="lm ln lo lp gt lq ll lr ls aw lt bi"><span id="d990" class="lu lv iq ll b gy lw lx l ly lz">...<br/>  # each mapUsers entry maps an IAM role to a static username and set of groups<br/>  mapUsers:<br/>...</span></pre><p id="39e6" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">更新您的配置图—添加用户的ARN、其登录名并将其组设置为<code class="fe li lj lk ll b">system:masters</code>:</p><pre class="lm ln lo lp gt lq ll lr ls aw lt bi"><span id="1e2e" class="lu lv iq ll b gy lw lx l ly lz">apiVersion: v1<br/>kind: ConfigMap<br/>metadata:<br/>  name: aws-auth<br/>  namespace: kube-system<br/>data:<br/>  mapRoles: |<br/>    - rolearn: arn:aws:iam::534***385:role/mobilebackend-dev-eks-0-wn-stack-NodeInstanceRole-15NNFZK6WW4IG<br/>      username: system:node:{{EC2PrivateDNSName}}<br/>      groups:<br/>        - system:bootstrappers<br/>        - system:nodes<br/>  mapUsers: |<br/>    - userarn: arn:aws:iam::534***385:user/yaroslav<br/>      username: yaroslav<br/>      groups:<br/>        - system:masters</span></pre><p id="be19" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">应用更改:</p><pre class="lm ln lo lp gt lq ll lr ls aw lt bi"><span id="b633" class="lu lv iq ll b gy lw lx l ly lz">$ kubectl apply -f aws-auth-cm.yaml<br/>configmap/aws-auth configured</span></pre><p id="672f" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">检查群集—查找配置图:</p><pre class="lm ln lo lp gt lq ll lr ls aw lt bi"><span id="fb77" class="lu lv iq ll b gy lw lx l ly lz">$ kubectl -n kube-system get cm<br/>NAME DATA AGE<br/>aws-auth 2 2d<br/>…</span></pre><p id="d072" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">并检查其内容:</p><pre class="lm ln lo lp gt lq ll lr ls aw lt bi"><span id="efcd" class="lu lv iq ll b gy lw lx l ly lz">$ kubectl -n kube-system describe cm aws-auth<br/>Name: aws-auth<br/>Namespace: kube-system<br/>Labels: &lt;none&gt;<br/>Annotations: kubectl.kubernetes.io/last-applied-configuration:<br/>{“apiVersion”:”v1",”data”:{“mapRoles”:”- rolearn: arn:aws:iam::534***385:role/mobilebackend-dev-eks-0-wn-stack-NodeInstanceRole-15NNFZK…<br/>Data<br/>====<br/>mapRoles:<br/> — — <br/>- rolearn: arn:aws:iam::534***385:role/mobilebackend-dev-eks-0-wn-stack-NodeInstanceRole-15NNFZK6WW4IG<br/>username: system:node:{{EC2PrivateDNSName}}<br/>groups:<br/>- system:bootstrappers<br/>- system:nodes<br/>mapUsers:<br/> — — <br/>- userarn: arn:aws:iam::534***385:user/yaroslav<br/>username: yaroslav<br/>groups:<br/>- system:masters<br/>Events: &lt;none&gt;</span></pre><p id="ac29" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">Done —我们的用户<em class="ks">arn:AWS:iam::534 * * * 385:user/yaroslav</em>现在能够在集群中执行任何操作。</p><h2 id="1413" class="lu lv iq bd mh mi mj dn mk ml mm dp mn kf mo mp mq kj mr ms mt kn mu mv mw mx bi translated">“根”即集群创建者</h2><p id="4e22" class="pw-post-body-paragraph ju jv iq jw b jx my jz ka kb mz kd ke kf na kh ki kj nb kl km kn nc kp kq kr ij bi translated">我想说的最后一件事是创建者用户:IAM条目，用于创建集群，将成为它的超级管理员。</p><p id="19da" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">但问题是你无法看到任何地方——这就是为什么我感到困惑——为什么<em class="ks">arn:AWS:iam::534 * * * 385:user/arseniy</em>用户对集群有完全访问权限，而a<em class="ks">rn:AWS:iam::534 * * * 385:user/yaroslav</em>却没有。</p><p id="0f23" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">但是，您仍然可以通过调用AWS的<code class="fe li lj lk ll b"><a class="ae lc" href="https://docs.aws.amazon.com/eks/latest/APIReference/API_CreateCluster.html" rel="noopener ugc nofollow" target="_blank">CreateCluster</a></code> API来检查CloudTrail，从而找到创建者:</p><figure class="lm ln lo lp gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="ne nf di ng bf nh"><div class="gh gi ns"><img src="../Images/be11ae5f5c382f05394164bb25bdc058.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*l_IjZgBB-4GFD3Hf.png"/></div></div></figure><p id="f8df" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">支持人员对查看“根”用户的任何方式的回答如下:</p><blockquote class="nk nl nm"><p id="90bc" class="ju jv ks jw b jx jy jz ka kb kc kd ke nn kg kh ki no kk kl km np ko kp kq kr ij bi translated">此时，创建集群的IAM实体成为第一个集群管理员。该实体被传递给<br/>主节点，并且在<code class="fe li lj lk ll b">aws-auth</code>配置图中不可见。这与您的AWS帐户<br/>的根用户相似，因为它拥有system:masters权限。</p></blockquote><h2 id="fc2d" class="lu lv iq bd mh mi mj dn mk ml mm dp mn kf mo mp mq kj mr ms mt kn mu mv mw mx bi translated">有用的链接</h2><ul class=""><li id="f371" class="kt ku iq jw b jx my kb mz kf nt kj nu kn nv kr ky kz la lb bi translated"><a class="ae lc" rel="noopener ugc nofollow" target="_blank" href="/how-does-client-authentication-work-on-amazon-eks-c4f2b90d943b">亚马逊EKS上的Kubernetes客户端认证</a></li><li id="774e" class="kt ku iq jw b jx ld kb le kf lf kj lg kn lh kr ky kz la lb bi translated"><a class="ae lc" href="http://marcinkaszynski.com/2018/07/12/eks-auth.html" rel="noopener ugc nofollow" target="_blank">auth如何在EKS与IAM用户合作</a></li><li id="e66c" class="kt ku iq jw b jx ld kb le kf lf kj lg kn lh kr ky kz la lb bi translated"><a class="ae lc" href="https://docs.aws.amazon.com/en_us/eks/latest/userguide/add-user-role.html" rel="noopener ugc nofollow" target="_blank">管理集群的用户或IAM角色</a></li><li id="2739" class="kt ku iq jw b jx ld kb le kf lf kj lg kn lh kr ky kz la lb bi translated">在亚马逊EKS创建集群后，我如何向其他用户和角色提供访问权限？</li></ul></div><div class="ab cl ma mb hu mc" role="separator"><span class="md bw bk me mf mg"/><span class="md bw bk me mf mg"/><span class="md bw bk me mf"/></div><div class="ij ik il im in"><p id="fdc0" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated"><em class="ks">最初发布于</em> <a class="ae lc" href="https://rtfm.co.ua/en/kubernetes-part-4-aws-eks-authentification-aws-iam-authenticator-and-aws-iam/" rel="noopener ugc nofollow" target="_blank"> <em class="ks"> RTFM: Linux、DevOps和系统管理。</em> </a></p></div></div>    
</body>
</html>