<html>
<head>
<title>Next.js Passwordless Email Authentication with NextAuth &amp; MongoDB</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Next.js使用NextAuth &amp; MongoDB进行无密码电子邮件认证</h1>
<blockquote>原文：<a href="https://itnext.io/next-js-passwordless-email-authentication-with-nextauth-mongodb-397e558bdcf0?source=collection_archive---------0-----------------------#2021-12-28">https://itnext.io/next-js-passwordless-email-authentication-with-nextauth-mongodb-397e558bdcf0?source=collection_archive---------0-----------------------#2021-12-28</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><figure class="gl gn jr js jt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi jq"><img src="../Images/e0774141e51a3c299576b24d6d21eb4a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*oydQr9RwW875F9xdgESm3A.png"/></div></div></figure><p id="b187" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">对Next.js应用程序实现身份验证的最简单方法之一是通过<a class="ae kz" href="https://next-auth.js.org/" rel="noopener ugc nofollow" target="_blank"> NextAuth.js </a>。让我们看看如何使用这个库添加无密码电子邮件认证。</p><div class="la lb gp gr lc ld"><a href="https://next-auth.js.org/" rel="noopener  ugc nofollow" target="_blank"><div class="le ab fo"><div class="lf ab lg cl cj lh"><h2 class="bd iu gy z fp li fr fs lj fu fw is bi translated">NextAuth.js</h2><div class="lk l"><h3 class="bd b gy z fp li fr fs lj fu fw dk translated">Next.js的身份验证</h3></div><div class="ll l"><p class="bd b dl z fp li fr fs lj fu fw dk translated">next-auth.js.org</p></div></div><div class="lm l"><div class="ln l lo lp lq lm lr jz ld"/></div></div></a></div><h1 id="56c8" class="ls lt it bd lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp bi translated">1.创建新的Next.js应用程序</h1><pre class="mq mr ms mt gt mu mv mw mx aw my bi"><span id="723c" class="mz lt it mv b gy na nb l nc nd">npx create-next-app some-project-name</span></pre><h1 id="6103" class="ls lt it bd lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp bi translated">2.安装依赖项</h1><pre class="mq mr ms mt gt mu mv mw mx aw my bi"><span id="532a" class="mz lt it mv b gy na nb l nc nd">yarn add next-auth <a class="ae kz" href="http://twitter.com/next" rel="noopener ugc nofollow" target="_blank">@next</a>-auth/mongodb-adapter mongodb nodemailer</span></pre><p id="289b" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">注意:当我这么做的时候，我的M1 Mac电脑出现了一个错误。我在上面的命令中添加了<code class="fe ne nf ng mv b">--ignore-engines</code>标志。</p><h1 id="0cdd" class="ls lt it bd lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp bi translated">3.连接到MongoDB</h1><p id="df1b" class="pw-post-body-paragraph kb kc it kd b ke nh kg kh ki ni kk kl km nj ko kp kq nk ks kt ku nl kw kx ky im bi translated">您可以使用NextAuth提供的众多<a class="ae kz" href="https://next-auth.js.org/adapters/overview" rel="noopener ugc nofollow" target="_blank">适配器</a>中的一个来使用任何其他数据库。对于本教程，我们将使用MongoDB。</p><p id="95fb" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated"><strong class="kd iu">添加</strong>T1】</p><figure class="mq mr ms mt gt ju"><div class="bz fp l di"><div class="nm nn l"/></div></figure><p id="370f" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">这个文件将向我们的应用程序公开MongoDB连接。我们将把这个连接传递给我们的NextAuth MongoDB适配器。</p><p id="f5f5" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated"><strong class="kd iu">添加</strong>T2】</p><figure class="mq mr ms mt gt ju"><div class="bz fp l di"><div class="nm nn l"/></div></figure><p id="108e" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">这将允许NextAuth创建所需的API端点。</p><p id="3a49" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated"><strong class="kd iu"> JWT —可选</strong></p><p id="7f9c" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">我们在这里使用JWT策略，因为我们不想不断地从数据库中查询会话信息。<code class="fe ne nf ng mv b">maxAge</code>定义了用户必须再次重新认证的时间。<code class="fe ne nf ng mv b">updateAge</code>定义了每次令牌刷新的时间间隔。</p><p id="c130" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated"><strong class="kd iu">电子邮件提供商— SMTP中继</strong></p><p id="a1db" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">由于我们使用无密码身份验证，当用户输入他们的电子邮件时，我们将向该电子邮件发送一个验证链接。然后，用户点击这个链接，登录到我们的应用程序。要发送这些电子邮件，我们需要电子邮件提供商和SMTP凭证。由于NextAuth在内部使用Nodemailer，所以您可以看看下面与Nodemailer合作的电子邮件提供商的<a class="ae kz" href="https://nodemailer.com/smtp/well-known/" rel="noopener ugc nofollow" target="_blank">列表。</a></p><p id="b0e0" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">出于演示的目的，我使用了我的Gmail。以下是如何获得Gmail SMTP证书的指南:</p><div class="la lb gp gr lc ld"><a href="https://kinsta.com/blog/gmail-smtp-server/" rel="noopener  ugc nofollow" target="_blank"><div class="le ab fo"><div class="lf ab lg cl cj lh"><h2 class="bd iu gy z fp li fr fs lj fu fw is bi translated">如何使用Gmail SMTP服务器免费发送电子邮件</h2><div class="lk l"><h3 class="bd b gy z fp li fr fs lj fu fw dk translated">大多数人都知道Gmail简洁的界面和有用的功能，比如搜索操作符和插件。但是你也可以…</h3></div><div class="ll l"><p class="bd b dl z fp li fr fs lj fu fw dk translated">kinsta.com</p></div></div><div class="lm l"><div class="no l lo lp lq lm lr jz ld"/></div></div></a></div><h1 id="9b98" class="ls lt it bd lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp bi translated">4.添加环境变量</h1><p id="5bb7" class="pw-post-body-paragraph kb kc it kd b ke nh kg kh ki ni kk kl km nj ko kp kq nk ks kt ku nl kw kx ky im bi translated">不要忘记添加环境变量。</p><p id="a758" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated"><strong class="kd iu">添加</strong>T5】</p><figure class="mq mr ms mt gt ju"><div class="bz fp l di"><div class="nm nn l"/></div></figure><h1 id="967e" class="ls lt it bd lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp bi translated">5.测试身份验证</h1><p id="3296" class="pw-post-body-paragraph kb kc it kd b ke nh kg kh ki ni kk kl km nj ko kp kq nk ks kt ku nl kw kx ky im bi translated">我们现在可以在您的应用程序的<code class="fe ne nf ng mv b">/api/auth/signin</code>路径访问NextAuth为我们创建的默认登录页面。</p><figure class="mq mr ms mt gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi np"><img src="../Images/9c8bf607014cfa40323d440935f2a59d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*fno7Dr15sPg0DgEPE4aG9g.png"/></div></div></figure><p id="e722" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">输入您希望用来登录的电子邮件，然后提交表单。您将会看到以下屏幕。</p><figure class="mq mr ms mt gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi nq"><img src="../Images/f36b252a3ad19cdcadb5cf1f4add745a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*FpgC0892nuX2YV5gpmbitA.png"/></div></div></figure><p id="1868" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">现在，检查您的电子邮件，您应该收到了这样一封电子邮件:</p><figure class="mq mr ms mt gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi nr"><img src="../Images/282c79e91d8a5e17b6bfcd5c7bc27584.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Nv21miDFkcAgG25fkNIhKw.png"/></div></div></figure><p id="5a8d" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">单击电子邮件中的登录按钮，您将被重定向回您的应用程序。</p><h1 id="ea01" class="ls lt it bd lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp bi translated">6.检查身份验证</h1><h2 id="8cd0" class="mz lt it bd lu ns nt dn ly nu nv dp mc km nw nx mg kq ny nz mk ku oa ob mo oc bi translated">从客户那里</h2><p id="e31f" class="pw-post-body-paragraph kb kc it kd b ke nh kg kh ki ni kk kl km nj ko kp kq nk ks kt ku nl kw kx ky im bi translated">我们已经完成了身份验证，但是我们无法从屏幕上判断用户是否登录。让我们使用NextAuth提供的钩子来显示用户的信息。</p><p id="460c" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated"><strong class="kd iu">编辑</strong>T0】</p><figure class="mq mr ms mt gt ju"><div class="bz fp l di"><div class="nm nn l"/></div></figure><p id="de22" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">首先，我们编辑our _app.js以包含<code class="fe ne nf ng mv b">SessionProvider</code>。</p><p id="3b88" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated"><strong class="kd iu">编辑</strong>T2】</p><p id="bdba" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">接下来，出于演示的目的，让我们编辑我们的<code class="fe ne nf ng mv b">index.js</code>文件以包含<code class="fe ne nf ng mv b">useSession</code>钩子来获取用户信息和登录状态。</p><figure class="mq mr ms mt gt ju"><div class="bz fp l di"><div class="nm nn l"/></div></figure><p id="4826" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated"><code class="fe ne nf ng mv b">useSession</code>钩子提供会话数据和认证状态。有三种可能的规约— <code class="fe ne nf ng mv b">loading</code>、<code class="fe ne nf ng mv b">authenticated</code>和<code class="fe ne nf ng mv b">unauthenticated</code>。</p><p id="e218" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">该页面现在看起来像这样:</p><figure class="mq mr ms mt gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi od"><img src="../Images/33e3b619dfb4865727493f5a8007236b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*aXLGTwIRHoeTOWCzCOH86Q.png"/></div></div></figure><h2 id="5a38" class="mz lt it bd lu ns nt dn ly nu nv dp mc km nw nx mg kq ny nz mk ku oa ob mo oc bi translated">从服务器</h2><p id="182c" class="pw-post-body-paragraph kb kc it kd b ke nh kg kh ki ni kk kl km nj ko kp kq nk ks kt ku nl kw kx ky im bi translated">为了从服务器读取认证状态，我们可以将<code class="fe ne nf ng mv b">getSession</code>方法添加到<code class="fe ne nf ng mv b">getServerSideProps</code>中。确保你没有被弄糊涂。对于客户端来说是<code class="fe ne nf ng mv b">useSession</code>，对于服务器来说是<code class="fe ne nf ng mv b">getSession</code>。一个完整的示例将如下所示:</p><figure class="mq mr ms mt gt ju"><div class="bz fp l di"><div class="nm nn l"/></div></figure><h2 id="02d7" class="mz lt it bd lu ns nt dn ly nu nv dp mc km nw nx mg kq ny nz mk ku oa ob mo oc bi translated">来自API</h2><p id="3f29" class="pw-post-body-paragraph kb kc it kd b ke nh kg kh ki ni kk kl km nj ko kp kq nk ks kt ku nl kw kx ky im bi translated"><code class="fe ne nf ng mv b">getSession</code>也可用于API路线。但是我们不是传递上下文，而是传递如下所示的<code class="fe ne nf ng mv b">req</code>对象:</p><figure class="mq mr ms mt gt ju"><div class="bz fp l di"><div class="nm nn l"/></div></figure><h1 id="4be2" class="ls lt it bd lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp bi translated">7.保护页面</h1><p id="c182" class="pw-post-body-paragraph kb kc it kd b ke nh kg kh ki ni kk kl km nj ko kp kq nk ks kt ku nl kw kx ky im bi translated">现在，让我们让一些未经认证的用户无法访问某些页面。</p><h2 id="c108" class="mz lt it bd lu ns nt dn ly nu nv dp mc km nw nx mg kq ny nz mk ku oa ob mo oc bi translated">来自客户</h2><figure class="mq mr ms mt gt ju"><div class="bz fp l di"><div class="nm nn l"/></div></figure><h2 id="0381" class="mz lt it bd lu ns nt dn ly nu nv dp mc km nw nx mg kq ny nz mk ku oa ob mo oc bi translated">从服务器</h2><p id="b201" class="pw-post-body-paragraph kb kc it kd b ke nh kg kh ki ni kk kl km nj ko kp kq nk ks kt ku nl kw kx ky im bi translated">我们可以简单地使用<code class="fe ne nf ng mv b">getSession</code>方法，并在<code class="fe ne nf ng mv b">getServerSideProps</code>中使用重定向。</p><figure class="mq mr ms mt gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi oe"><img src="../Images/e805e7a2a0c2c80105e0f749749562a4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*1NnqSv4Antf5Ce5DGosS6A.png"/></div></div></figure><h2 id="dfaf" class="mz lt it bd lu ns nt dn ly nu nv dp mc km nw nx mg kq ny nz mk ku oa ob mo oc bi translated">使用中间件(Next.js 12)</h2><p id="30c6" class="pw-post-body-paragraph kb kc it kd b ke nh kg kh ki ni kk kl km nj ko kp kq nk ks kt ku nl kw kx ky im bi translated">随着Next.js 12的发布，我们还可以使用中间件一次性保护多条路由。下面的例子是在<code class="fe ne nf ng mv b">/pages/protected/_middleware.js</code>创建的中间件。这个中间件将保护<code class="fe ne nf ng mv b">/protected</code>路径下的所有页面。</p><figure class="mq mr ms mt gt ju"><div class="bz fp l di"><div class="nm nn l"/></div></figure><h1 id="07b1" class="ls lt it bd lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp bi translated">8.自定义登录页面</h1><p id="ad52" class="pw-post-body-paragraph kb kc it kd b ke nh kg kh ki ni kk kl km nj ko kp kq nk ks kt ku nl kw kx ky im bi translated">NextAuth还使我们能够重建我们的登录页面。要使用自定义登录页面，我们需要编辑掉<code class="fe ne nf ng mv b">/pages/api/auth/[...nextauth].js</code>。我们需要添加<code class="fe ne nf ng mv b">pages</code>选项。</p><figure class="mq mr ms mt gt ju"><div class="bz fp l di"><div class="nm nn l"/></div></figure><p id="0880" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">现在，我们可以添加自定义页面。</p><p id="ded5" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated"><code class="fe ne nf ng mv b">/pages/login.js</code></p><figure class="mq mr ms mt gt ju"><div class="bz fp l di"><div class="nm nn l"/></div></figure><p id="91a2" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">注意，通过向<code class="fe ne nf ng mv b">signIn</code>方法传递参数，我们还可以在登录后将用户重定向到不同的路由，例如<code class="fe ne nf ng mv b">/protected</code>。</p><p id="584a" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated"><code class="fe ne nf ng mv b">/pages/verify-request.js</code></p><figure class="mq mr ms mt gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi of"><img src="../Images/bdfb821bdd3e420c47126c3b2226c4db.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*qrYE_62glMMCjC0BWgw-Pw.png"/></div></div></figure><h1 id="fdbf" class="ls lt it bd lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp bi translated">9.自定义电子邮件</h1><p id="fbcf" class="pw-post-body-paragraph kb kc it kd b ke nh kg kh ki ni kk kl km nj ko kp kq nk ks kt ku nl kw kx ky im bi translated">我们可以通过在<code class="fe ne nf ng mv b">/pages/api/auth/[...nextauth].js</code>的EmailProvider选项中添加<code class="fe ne nf ng mv b">sendVerificationRequest</code>方法来轻松定制验证邮件</p><figure class="mq mr ms mt gt ju"><div class="bz fp l di"><div class="nm nn l"/></div></figure><p id="95d4" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">如果您现在检查您的MongoDB，您将看到已登录的用户被填充。您还将看到会话和验证链接的集合。</p><figure class="mq mr ms mt gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi og"><img src="../Images/7aaf559a63f9d27ff9caa1aa8a517963.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*SQiP4guYGSYJObZwXsaIsg.png"/></div></div></figure><p id="e4b9" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">就是这样！现在你可以轻松实现无密码认证了！✨</p></div></div>    
</body>
</html>