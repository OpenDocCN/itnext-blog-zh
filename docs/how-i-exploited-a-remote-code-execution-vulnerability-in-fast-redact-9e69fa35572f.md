# 我如何利用快速修订中的任意代码执行漏洞

> 原文：<https://itnext.io/how-i-exploited-a-remote-code-execution-vulnerability-in-fast-redact-9e69fa35572f?source=collection_archive---------1----------------------->

![](img/10df1d60ca81da99646fcde45289e818.png)

# 介绍

这是一个关于我如何在 GitHub 上的开源库[快速修订](https://github.com/davidmarkclements/fast-redact)的代码审查期间发现一个*不那么微不足道的* JavaScript 代码注入，以及我如何将它变成一个完全有效的任意命令执行的故事。*并非无足轻重的*来自于这样一个事实，即注入的代码正在通过 [Node.js vm 模块](https://nodejs.org/api/vm.html)创建的沙箱中进行评估。

# 发现

修复前的源代码如下所示:

如果使用该库的开发人员未经净化就传递用户输入，攻击者最终可以获得对“expr”变量的控制。

这在存储库的 [README.md](https://github.com/davidmarkclements/fast-redact/blob/master/readme.md) 文件中的[行 181](https://github.com/davidmarkclements/fast-redact/blob/master/readme.md#caveat) 处有说明。(*原文如此！*)

> 正如在方法中提到的，`paths`数组输入在初始化时被动态编译成一个函数。虽然已经对`paths`数组进行了严格的测试，以发现开发人员的任何错误，但是强烈建议不要让用户输入直接提供任何要编辑的路径。不能保证允许用户输入`paths`不会暴露攻击媒介。

# 剥削

我们可以看到,' expr '在字符串连接中被使用了两次。这允许简单的 JavaScript 代码注入，但是为了成功利用，我们需要:

1.  **使注入起作用**:这并不简单，因为同一个变量在代理上使用了点标记，并作为计算键的一部分。为了能够在不关心语法的情况下装载任意的负载，我们需要访问函数构造器。
2.  **逃离沙箱**:为了逃离沙箱，我们需要能够要求一些有用的 Node.js 模块来触发任意命令的执行。` require '本身是不可用的，所以我们需要解决这个问题，以便产生进程。

# 概念证明

经过大约两个小时的研究，我发现了一些有趣的有效载荷。我们先来看如何求解 1。第二。描述中引用。

1.  这里的问题是，我们需要提供一个静态有效并最终在运行时部分有效的“expr”字符串，以便触发任意的 JavaScript 代码注入。这不是小事，因为我们需要同时提供点符号的有效标识符和计算的密钥，并且可能触发任意代码执行。如果我们打破常规，看看 JavaScript 语法提供了什么，我们可能会注意到我们可以使用` && '操作符来注入有效的代码。现在我们意识到了这一点，我们可以提供一个有效的有效载荷，而不是点符号的有效标识符，并使用一个[生命](https://developer.mozilla.org/en-US/docs/Glossary/IIFE)来定义和调用一个函数。
2.  一旦我们实现了任意代码执行，我们就需要逃离沙箱。正如我们可以看到的，用户提供的代码正在新的上下文中进行评估，但没有“use strict”指令，因此“this”可用于沙箱内运行的代码。这将是我们的函数构造函数的关键，我们可以通过` this . constructor . constructor(" console . log(' OUCH ')")触发任意代码执行。现在，我们可以不受有效负载语法限制地执行任意代码，我们可以继续寻找一种方法来逃离沙盒上下文，它不提供“require”。为了实现任意命令的执行，我们将依赖于使用“binding”函数的全局“process”变量来要求内部模块，以便有一个工作的“spawnSync()”。这种技术的详细描述可以在这里找到:[我们如何利用 math.js 中的一个远程代码执行漏洞](https://capacitorset.github.io/mathjs/)。

在我们修复了所有东西之后，我们生成反向 shell 的最终有效负载将如下所示:

# 有趣的有效载荷

*   拒绝服务:`while (1) 0`
*   阅读`/etc/passwd`

# 时间表

*   2018/5/28 18:30 —通过代码审查发现的漏洞
*   2018/5/28 20:30 —反向外壳已生成
*   2018/5/28 23:00 —通知供应商
*   2018/5/29 00:00 —供应商确认的漏洞
*   2018/5/29 02:00—[GitHub 上发布的第一个修复](https://github.com/davidmarkclements/fast-redact/commit/e67a1e6c8ed827bbc4be329cdd928d96829efa50)

# 追踪

在查看博客帖子后，供应商要求包含以下声明:

> 作者没有将此归类为安全漏洞，因为明确的文档必须来自可信方