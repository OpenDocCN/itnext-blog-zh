<html>
<head>
<title>Hugo website with SSL on S3 is straightforward, right? Errrrm…</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在S3上使用SSL的Hugo网站很简单，对吗？Errrrm…</h1>
<blockquote>原文：<a href="https://itnext.io/hugo-website-with-ssl-on-s3-is-straightforward-right-errrrm-369c0f19ab07?source=collection_archive---------1-----------------------#2020-06-15">https://itnext.io/hugo-website-with-ssl-on-s3-is-straightforward-right-errrrm-369c0f19ab07?source=collection_archive---------1-----------------------#2020-06-15</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="685a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我是<a class="ae kl" href="https://gohugo.io/" rel="noopener ugc nofollow" target="_blank">雨果</a>项目的长期粉丝。我第一次接触它是在组织<a class="ae kl" href="https://devopsdays.org/events/2020-amsterdam/welcome/" rel="noopener ugc nofollow" target="_blank">阿姆斯特丹开发日</a>的时候，我们必须在<a class="ae kl" href="https://devopsdays.org" rel="noopener ugc nofollow" target="_blank">https://devopsdays.org</a>网站上生成页面。我对使用Markdown设置新页面、内容和所有内容的简单性印象深刻！:-D</p><p id="b141" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">最近我一直在拖延用Hugo为个人使用建立一个简单的静态网站的想法。所以我决定在每次构建之后将它的静态版本推到一个S3桶中，并从那里提供服务。如果我知道兔子洞，我会让自己进去…</p><figure class="km kn ko kp gt kq"><div class="bz fp l di"><div class="kr ks l"/></div></figure><p id="feaa" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><em class="kt">现在，我更加尊重</em> <a class="ku kv ep" href="https://medium.com/u/cf921a3f7a49?source=post_page-----369c0f19ab07--------------------------------" rel="noopener" target="_blank"> <em class="kt">马特·斯特拉顿</em> </a> <em class="kt">和所有志愿者，是他们让世界各地数百名志愿者组织者的体验变得如此无缝和轻松！</em></p></div><div class="ab cl kw kx hu ky" role="separator"><span class="kz bw bk la lb lc"/><span class="kz bw bk la lb lc"/><span class="kz bw bk la lb"/></div><div class="ij ik il im in"><h1 id="a5d0" class="ld le iq bd lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma bi translated">雨果</h1><p id="7958" class="pw-post-body-paragraph jn jo iq jp b jq mb js jt ju mc jw jx jy md ka kb kc me ke kf kg mf ki kj kk ij bi translated">查看<a class="ae kl" href="https://gohugo.io/" rel="noopener ugc nofollow" target="_blank">网站</a>、文档、快速入门，感受这款速度极快、基于GO的网站生成器的强大功能！就我的用法而言，我真的很喜欢极简主题，我发现了这个我想要使用的巨大的<a class="ae kl" href="https://github.com/luizdepra/hugo-coder" rel="noopener ugc nofollow" target="_blank"> hugo-coder主题</a>。</p><p id="93e1" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在设置了我的<code class="fe mg mh mi mj b">config.toml</code>并添加了一些带有一些基本减价的内容后，我可以顺利地在本地运行，用<code class="fe mg mh mi mj b">hugo serve</code>来“查看它”。耶！</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="ml mm di mn bf mo"><div class="gh gi mk"><img src="../Images/85a9814433f5e7ba6fe140213f867a8a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*6H-PqyIFJPVqbExx4RXovQ.png"/></div></div><figcaption class="mr ms gj gh gi mt mu bd b be z dk translated">在我的机器上运行！</figcaption></figure><h1 id="2225" class="ld le iq bd lf lg mv li lj lk mw lm ln lo mx lq lr ls my lu lv lw mz ly lz ma bi translated">把静态文件推给S3，对吗？</h1><p id="086e" class="pw-post-body-paragraph jn jo iq jp b jq mb js jt ju mc jw jx jy md ka kb kc me ke kf kg mf ki kj kk ij bi translated">如果你正在做快速入门或者只是玩玩，你可能选择了Hugo主题。看到它工作后，你可以用一个简单的<code class="fe mg mh mi mj b">hugo</code>命令生成你的静态文件(<em class="kt">我通常添加</em> <code class="fe mg mh mi mj b">-v</code> <em class="kt">详细标志，因为我… </em> ) —</p><p id="57fb" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在是上传文件到S3的时候了。但是现在，你到处都需要SSL证书。如果你研究AWS文档，你会发现在S3上托管静态站点是多么容易，对吗？这里检查<a class="ae kl" href="https://docs.aws.amazon.com/AmazonS3/latest/dev/WebsiteHosting.html" rel="noopener ugc nofollow" target="_blank">例如</a>。</p><p id="f4a8" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">然而，如果你想要你的域名，而不是一个通用的<em class="kt">http://&lt;BUCKET _ Name&gt;. s3-website-&lt;AWS _ REGION&gt;. Amazon AWS . com</em>端点，你可能需要查看一些其他文档，了解一些关于Cloudfront、DNS、ACM和S3的东西。你想穿过那条路吗？谷歌一下<code class="fe mg mh mi mj b"><a class="ae kl" href="https://www.google.com/search?q=hosting+static+website+on+s3+with+ssl" rel="noopener ugc nofollow" target="_blank">aws + s3 + hosting + ssl</a></code>之类的就行了。</p><p id="f586" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果你关注了这些精彩的帖子中的一个，你最终会遇到一个问题。为什么？因为像<code class="fe mg mh mi mj b">foo.com/bar/</code>这样的Hugo页面实际上是<code class="fe mg mh mi mj b">foo.com/bar/index.html</code>，那些奇怪的重定向可以很容易地用你的Apache和Nginx配置，但我不知道S3可以做到这一点——它可以！</p><p id="8a6e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在，您可以将这个配置文件应用到包含静态文件的bucket中，瞧！</p><figure class="km kn ko kp gt kq"><div class="bz fp l di"><div class="na ks l"/></div></figure><pre class="km kn ko kp gt nb mj nc nd aw ne bi"><span id="edc2" class="nf le iq mj b gy ng nh l ni nj">aws s3api put-bucket-website --bucket $BUCKET_NAME --website-configuration file://HugoS3BucketRedirect.json</span></pre><figure class="km kn ko kp gt kq"><div class="bz fp l di"><div class="na ks l"/></div></figure><h1 id="b0b2" class="ld le iq bd lf lg mv li lj lk mw lm ln lo mx lq lr ls my lu lv lw mz ly lz ma bi translated">为您的证书使用ACM</h1><p id="1195" class="pw-post-body-paragraph jn jo iq jp b jq mb js jt ju mc jw jx jy md ka kb kc me ke kf kg mf ki kj kk ij bi translated">我不知道你是否知道，但AWS为所有用户免费生成公共SSL证书。AWS证书管理器(ACM)服务非常好，你可以通过控制台或者API(就像AWS上的其他东西一样)来使用它。</p><p id="ae93" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">您可以通过向您的域中添加记录或通过管理员电子邮件检查来验证您的域中的SSL证书。如果您有权访问域管理员电子邮件，您可以快速运行以下代码来获取该邮件并验证它(<em class="kt">注意，我们要求一个对该域和</em><a class="ae kl" href="http://www.domain" rel="noopener ugc nofollow" target="_blank"><em class="kt">www . domain</em></a><em class="kt">版本有效的证书，以便我们稍后可以重定向它</em>)。</p><pre class="km kn ko kp gt nb mj nc nd aw ne bi"><span id="ce89" class="nf le iq mj b gy ng nh l ni nj">aws acm request-certificate --domain-name $DOMAIN_NAME --subject-alternative-names "www.$DOMAIN_NAME" --idempotency-token "`date +%s`"</span></pre><p id="7969" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><em class="kt">这里一个微妙的说法是</em> <code class="fe mg mh mi mj b"><em class="kt">idempotency-token</em></code> <em class="kt">。幂等性是API请求的一个特征，它确保请求不会被完成一次以上。对于幂等请求，如果原始请求成功完成，所有后续的重试都将返回原始成功请求的结果，并且它们没有额外的影响。因此，我们将当前时间以秒为单位放在那里，以确保如果我们再次运行该调用，从现在开始，我们将获得该域和www版本的相同结果。</em></p><p id="5f7d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在验证发生和证书颁发之后，您可以获得证书的ARN，因为我们稍后会用到它(通过控制台或API调用，由您决定)。</p><figure class="km kn ko kp gt kq"><div class="bz fp l di"><div class="nk ks l"/></div></figure><h1 id="8630" class="ld le iq bd lf lg mv li lj lk mw lm ln lo mx lq lr ls my lu lv lw mz ly lz ma bi translated">Cloudfront FTW！</h1><p id="7c3c" class="pw-post-body-paragraph jn jo iq jp b jq mb js jt ju mc jw jx jy md ka kb kc me ke kf kg mf ki kj kk ij bi translated">我不需要一个个人网站的所有数百个边缘位置，但我们需要使用Cloudfront在其上启用我的域名和SSL。那么，让我们来看看CloudFront的设置。</p><p id="35ce" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">Cloudfront配置文件是一个大的JSON文件，其中包含5个“部分”:</p><ul class=""><li id="906b" class="nl nm iq jp b jq jr ju jv jy nn kc no kg np kk nq nr ns nt bi translated">Origin:在这里你指向S3网站的托管URL来获取<code class="fe mg mh mi mj b">index.html</code>。这就产生了一个问题，因为如果你把HTTPS设置到原点，你将无法与AWS为S3请求设置的通用S3证书匹配…就是HTTP！</li><li id="5e92" class="nl nm iq jp b jq nu ju nv jy nw kc nx kg ny kk nq nr ns nt bi translated">缓存行为:SSL是强制的，所以我们将端口80重定向到443。在这里，您还可以:定义缓存内容的持续时间；转发什么请求；如果你想gzip内容；如果你要转发标题和更多。</li><li id="db9e" class="nl nm iq jp b jq nu ju nv jy nw kc nx kg ny kk nq nr ns nt bi translated">错误处理:定义4xx的重定向、错误缓存时间等等。</li><li id="d265" class="nl nm iq jp b jq nu ju nv jy nw kc nx kg ny kk nq nr ns nt bi translated">限制:如果您需要对CloudFront发行版应用地理或IP限制。</li><li id="a6d2" class="nl nm iq jp b jq nu ju nv jy nw kc nx kg ny kk nq nr ns nt bi translated">其他:放置标签、注释和名称的地方。</li></ul><figure class="km kn ko kp gt kq"><div class="bz fp l di"><div class="na ks l"/></div></figure><p id="7039" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在，您可以使用您的变量来调整上面的文件，并通过API运行以下命令来创建发行版:</p><pre class="km kn ko kp gt nb mj nc nd aw ne bi"><span id="96ba" class="nf le iq mj b gy ng nh l ni nj">aws cloudfront create-distribution --distribution-config file://HugoCloufrontConfiguration.json</span></pre><p id="fca8" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><em class="kt">如果你愿意，你也可以通过控制台来适应/选择你想要的行为。或者你不想要一个伐木桶。还是不同的TTL？由你决定！但是，必须通过HTTP准确定义S3的来源，就像这里一样。</em></p><p id="8692" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">你可能需要在这里等一会儿。Cloudfront部署可能需要几分钟的时间，直到您可以访问它的URI，一切都准备好了。</p><figure class="km kn ko kp gt kq"><div class="bz fp l di"><div class="na ks l"/></div><figcaption class="mr ms gj gh gi mt mu bd b be z dk translated">更多？！是的，更多！</figcaption></figure><h1 id="2b10" class="ld le iq bd lf lg mv li lj lk mw lm ln lo mx lq lr ls my lu lv lw mz ly lz ma bi translated">DNS设置</h1><p id="6d70" class="pw-post-body-paragraph jn jo iq jp b jq mb js jt ju mc jw jx jy md ka kb kc me ke kf kg mf ki kj kk ij bi translated">正如Kris Buytaert总是说的那样:“所有的事情都是一个该死的DNS问题！和往常一样，他是对的。确保当有人访问你的域名时，他们被适当地重定向到CloudFront发行版；我们得安排一些事情。</p><p id="a375" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我的域在53号公路上，所以我必须在我的托管区域上生成两条记录:</p><ul class=""><li id="a3d2" class="nl nm iq jp b jq jr ju jv jy nn kc no kg np kk nq nr ns nt bi translated">一个指向我在上面创建的Cloudfront发行版的<code class="fe mg mh mi mj b">A</code>记录— <em class="kt">为您的域使用别名方法— </em>。</li><li id="79b0" class="nl nm iq jp b jq nu ju nv jy nw kc nx kg ny kk nq nr ns nt bi translated">一个<code class="fe mg mh mi mj b">CNAME</code>记录指向你的<a class="ae kl" href="http://www.domain." rel="noopener ugc nofollow" target="_blank"> www.domain. </a>的同一个Cloudfront分布</li></ul><p id="9a26" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">您可以通过控制台轻松做到这一点，但是如果您想通过AWS CLI检查待办事项，您将需要类似于下面的JSON文件。</p><figure class="km kn ko kp gt kq"><div class="bz fp l di"><div class="na ks l"/></div></figure><p id="9a98" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">您可能想知道别名部分中的硬编码<code class="fe mg mh mi mj b">HostedZoneId</code>，对吗？为什么会这样？嗯，因为AWS定义了这里的<a class="ae kl" href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-properties-route53-aliastarget.html" rel="noopener ugc nofollow" target="_blank"/>:“指定Z2FDTNDATAQYW2。当您创建将流量路由到CloudFront分发的别名记录时，这始终是托管区域ID。</p><p id="85ef" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在，您可以在控制台上复制/获取包含您的域的<code class="fe mg mh mi mj b">ZONE_ID</code>(也总是通过API)并运行以下命令:</p><pre class="km kn ko kp gt nb mj nc nd aw ne bi"><span id="7928" class="nf le iq mj b gy ng nh l ni nj">aws route53 change-resource-record-sets --hosted-zone-id $ZONE_ID --change-batch file://HugoCloudfrontRoute53.json</span></pre><p id="0d82" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">像往常一样，喝点咖啡，等待一切在DNS世界中传播和适当地生成。官方说法是可能需要24小时以上，但通常30分钟就足够了！完成后，您将拥有一个Hugo静态网站，可以通过使用SSL的自定义域名访问，该网站由Cloudfront托管在S3上。:-D</p><figure class="km kn ko kp gt kq"><div class="bz fp l di"><div class="nz ks l"/></div></figure></div></div>    
</body>
</html>