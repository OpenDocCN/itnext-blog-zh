<html>
<head>
<title>CI/CD as a Code for .NET Core application and Kubernetes using Azure DevOps +YAML.</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">CI/CD作为代码。NET核心应用程序和Kubernetes使用Azure DevOps +YAML。</h1>
<blockquote>原文：<a href="https://itnext.io/ci-cd-as-a-code-for-net-core-application-and-kubernetes-using-azure-devops-yaml-26b3adeb8ace?source=collection_archive---------1-----------------------#2019-12-06">https://itnext.io/ci-cd-as-a-code-for-net-core-application-and-kubernetes-using-azure-devops-yaml-26b3adeb8ace?source=collection_archive---------1-----------------------#2019-12-06</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><figure class="is it gp gr iu iv gh gi paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="gh gi ir"><img src="../Images/94017660f4727bf2092396c691dd7331.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*bPLu2p0M7xc5Ogl-QSWsqA.png"/></div></div></figure><div class=""/><p id="1d36" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">为建立CI/CD流程。NET核心应用程序可能会很复杂，尤其是当你处理Kubernetes和Docker时，如果你需要包含代码风格分析、单元测试和代码覆盖报告。</p><p id="4fb6" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">在这篇文章中，我将解释为现有的构建简单的CI/CD管道的过程。net核心应用程序，使用Azure DevOps将其迁移到Azure Kubernetes服务。最终的管道将易于理解和重用。</p><h2 id="6e6d" class="kz la je bd lb lc ld dn le lf lg dp lh km li lj lk kq ll lm ln ku lo lp lq lr bi translated">部署架构</h2><p id="3bca" class="pw-post-body-paragraph kb kc je kd b ke ls kg kh ki lt kk kl km lu ko kp kq lv ks kt ku lw kw kx ky im bi translated">部署过程包括以下步骤:从Git库获取代码，构建应用程序，恢复NuGet包，运行单元测试，构建单元测试和代码覆盖报告，将docker镜像推送到注册表，部署到AKS集群。</p><figure class="ly lz ma mb gt iv gh gi paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="gh gi lx"><img src="../Images/8a131cad347e14b2354b4176e41d7066.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*65X8_od5-qGvJv5QwQArHw.png"/></div></div></figure><h2 id="7cef" class="kz la je bd lb lc ld dn le lf lg dp lh km li lj lk kq ll lm ln ku lo lp lq lr bi translated">Azure Kubernetes群集设置</h2><p id="f9c5" class="pw-post-body-paragraph kb kc je kd b ke ls kg kh ki lt kk kl km lu ko kp kq lv ks kt ku lw kw kx ky im bi translated">我使用了简单的AKS集群，具有包含<a class="ae mc" href="https://github.com/kubernetes/ingress-nginx" rel="noopener ugc nofollow" target="_blank"> Ingress-nginx </a>负载平衡器的3节点架构。还可以使用<a class="ae mc" href="https://docs.traefik.io/v1.7/user-guide/kubernetes/" rel="noopener ugc nofollow" target="_blank"> Traefik.io </a>、<a class="ae mc" href="https://istio.io/docs/concepts/traffic-management/" rel="noopener ugc nofollow" target="_blank"> istio.io </a>甚至<a class="ae mc" href="https://docs.microsoft.com/en-us/azure/aks/load-balancer-standard" rel="noopener ugc nofollow" target="_blank">标准Azure负载均衡器</a>。</p><figure class="ly lz ma mb gt iv gh gi paragraph-image"><div class="gh gi md"><img src="../Images/c62420dc656f398484106cd0fad65a50.png" data-original-src="https://miro.medium.com/v2/resize:fit:1162/format:webp/1*kYV0Faixa372oq1SPsaHiQ.png"/></div></figure><p id="d121" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">如何设置AKS集群的详细说明，包括入口设置和<a class="ae mc" href="https://github.com/Boriszn/DeviceManager.Api/tree/develop/aks-deployment" rel="noopener ugc nofollow" target="_blank">部署脚本</a>可在<a class="ae mc" href="https://github.com/Boriszn/DeviceManager.Api/tree/develop#kubernates-minikube-cluster-setup" rel="noopener ugc nofollow" target="_blank">这里</a>找到。</p><p id="727f" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">在部署AKS之后，主要的资源组将如下图所示。</p><figure class="ly lz ma mb gt iv gh gi paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="gh gi me"><img src="../Images/2103a01f01e325e025000cb9f982b3c6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Y6HZv3mbZjU2f4PGork8vg.png"/></div></div></figure><h2 id="e883" class="kz la je bd lb lc ld dn le lf lg dp lh km li lj lk kq ll lm ln ku lo lp lq lr bi translated">设置服务连接</h2><p id="d840" class="pw-post-body-paragraph kb kc je kd b ke ls kg kh ki lt kk kl km lu ko kp kq lv ks kt ku lw kw kx ky im bi translated">在开始配置主要管道步骤之前，Azure Container Registry(ACR)和Azure Kubernetes服务之间的连接需要通过向ACR授予AKS服务主体的访问权限来授予。Azure DevOps的RBAC服务主体已经创建，一切都已准备就绪，可以在管道中推拉docker映像。或者，你可以在Azure DevOps服务连接中这样做，我将在下一节课中解释。</p><figure class="ly lz ma mb gt iv"><div class="bz fp l di"><div class="mf mg l"/></div></figure><p id="b47d" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated"><a class="ae mc" href="https://docs.microsoft.com/en-us/azure/aks/cluster-container-registry-integration" rel="noopener ugc nofollow" target="_blank">在这里</a>您可以找到如何配置ACR和AKS之间连接的详细说明。</p><h2 id="5800" class="kz la je bd lb lc ld dn le lf lg dp lh km li lj lk kq ll lm ln ku lo lp lq lr bi translated">Azure DevOps服务与Azure Kubernetes服务和Azure容器注册表的连接。</h2><p id="6823" class="pw-post-body-paragraph kb kc je kd b ke ls kg kh ki lt kk kl km lu ko kp kq lv ks kt ku lw kw kx ky im bi translated">通过使用服务连接，您可以将Azure DevOps连接到您已经部署的AKS集群、Azure Container Registry、Docker Registry (Docker Hub)和许多其他服务。</p><figure class="ly lz ma mb gt iv gh gi paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="gh gi mh"><img src="../Images/beeb70a56aed7e61564c90f98cd9bfa4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*8ghbiV4Y0y_TatPFH5vBYA.png"/></div></div></figure><p id="68bc" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">创建到ACR的连接非常简单，您只需要指定一个连接名、一个订阅和一个注册表名，就这样。</p><figure class="ly lz ma mb gt iv gh gi paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="gh gi mi"><img src="../Images/3bb7f17907f437052c791fe4a4e6b760.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*h5cs10MlJ6Wp0g0R8BMoZg.png"/></div></div></figure><p id="fc26" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">您可以使用Kubeconfig、服务帐户和Azure订阅连接(并验证)您的AKS群集。在我的项目中，我使用了Kubeconfig，作为快速选项之一，因为你只需要找到kubeconfig JSON，复制它并选择你的集群上下文。</p><figure class="ly lz ma mb gt iv gh gi paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="gh gi mj"><img src="../Images/c749a0bf21280d8d4566094fc8c93b7f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*kyvIj-T_UNtEq-iv8EP_Sw.png"/></div></div></figure><p id="500a" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">你可以在下面的目录中找到KubeConfig(在Windows中):<code class="fe mk ml mm mn b">C:\Users\your_user_name\.kube\config</code> <a class="ae mc" href="https://kubernetes.io/docs/concepts/configuration/organize-cluster-access-kubeconfig/" rel="noopener ugc nofollow" target="_blank">这里的</a>是关于如何在Linux和Mac上找到和使用KubeConfig的文档。</p><h2 id="c0a1" class="kz la je bd lb lc ld dn le lf lg dp lh km li lj lk kq ll lm ln ku lo lp lq lr bi translated">流水线步骤</h2><p id="2dd1" class="pw-post-body-paragraph kb kc je kd b ke ls kg kh ki lt kk kl km lu ko kp kq lv ks kt ku lw kw kx ky im bi translated">Finlay我正在进行管道步骤，第一步是使用一个脚本来恢复所有NuGet依赖项/包，构建. net核心应用程序，运行单元测试，构建代码覆盖报告。还请注意，我使用了系统变量<a class="ae mc" href="https://docs.microsoft.com/en-us/azure/devops/pipelines/build/variables?view=azure-devops&amp;tabs=yaml" rel="noopener ugc nofollow" target="_blank"> <strong class="kd jf"> $(Build。BuildNumber) </strong> </a> <strong class="kd jf"> </strong>作为<strong class="kd jf"> </strong>标签用于覆盖报告的生成。最后，测试结果将作为工件发布，Azure DevOps可以构建可视化分析图表。</p><figure class="ly lz ma mb gt iv"><div class="bz fp l di"><div class="mf mg l"/></div></figure><p id="3be5" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">下面你可以在Azure DevOps的测试部分看到带有统计数据和测试结果的测试刀片</p><figure class="ly lz ma mb gt iv gh gi paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="gh gi mo"><img src="../Images/cb713ac80b6175081c168dbe08de908d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*NlT-WUdkgvgliuXika89pw.png"/></div></div></figure><figure class="ly lz ma mb gt iv gh gi paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="gh gi mp"><img src="../Images/b7d41f6055f9a0f9924d99ce3a59968d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Q5VPhkpLDPtQ3AkcCBOvsQ.png"/></div></div></figure><h2 id="7960" class="kz la je bd lb lc ld dn le lf lg dp lh km li lj lk kq ll lm ln ku lo lp lq lr bi translated">步骤2 -代码覆盖率结果</h2><p id="cd87" class="pw-post-body-paragraph kb kc je kd b ke ls kg kh ki lt kk kl km lu ko kp kq lv ks kt ku lw kw kx ky im bi translated">下一步是将代码覆盖结果发布到<em class="mq">DefaultWorkingDirectory</em>。整个过程基于<a class="ae mc" href="https://github.com/danielpalme/ReportGenerator" rel="noopener ugc nofollow" target="_blank"> Cubertura报表生成器</a>，一个. Net核心库。</p><figure class="ly lz ma mb gt iv"><div class="bz fp l di"><div class="mf mg l"/></div></figure><p id="cf63" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">第一批统计结果已经出来了:</p><figure class="ly lz ma mb gt iv gh gi paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="gh gi mr"><img src="../Images/1ae7a3100685beabc2900a5de40672cc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Tp313_B1eiyItdnqumbK4g.png"/></div></div></figure><p id="9381" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">您可以在代码覆盖率选项卡上找到详细的逐文件报告。该报告基于生成的xml报告。</p><figure class="ly lz ma mb gt iv gh gi paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="gh gi ms"><img src="../Images/6a1d960c70a580ff85be5b96ddb8d3f5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Y2c9PLY5kJYpbVgV9PAViw.png"/></div></div></figure><h2 id="9343" class="kz la je bd lb lc ld dn le lf lg dp lh km li lj lk kq ll lm ln ku lo lp lq lr bi translated">第3步和第4步—构建集装箱并将其推送到ACR</h2><p id="1d1f" class="pw-post-body-paragraph kb kc je kd b ke ls kg kh ki lt kk kl km lu ko kp kq lv ks kt ku lw kw kx ky im bi translated">完成前面的步骤后，项目将被放入容器中。为此，我将使用版本1 Docker步骤。您需要指定Docker文件的路径，就像我在这里做的那样<a class="ae mc" href="https://github.com/Boriszn/DeviceManager.Api/blob/develop/src/DeviceManager.Api/Dockerfile" rel="noopener ugc nofollow" target="_blank"/>，提供图像名称，例如<strong class="kd jf">Boris Zn/devicemanagerapi</strong>和标签— <strong class="kd jf"> 1.102.1。，</strong>最后一步是指定一个容器注册表，例如，<strong class="kd jf">devicemanagerreg . azure Cr . io .</strong></p><p id="8351" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">对于标签创建，我使用了语义版本化，并硬编码了一些版本号来简化管道，但是您也可以使用不同的方法来构建a标签，例如使用运行管道所需的变量，或者从git版本中获取。</p><figure class="ly lz ma mb gt iv"><div class="bz fp l di"><div class="mf mg l"/></div></figure><p id="1d9e" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">下一步是将我们的dockerised应用程序推送到Azure容器注册中心。在这里，我指定了要推送的命令和图像。你应该考虑到我推送了2张图片，第一张图片标签为<strong class="kd jf"> 1.58338.4 </strong>，第二张图片标签为:<strong class="kd jf">最新</strong>。</p><figure class="ly lz ma mb gt iv"><div class="bz fp l di"><div class="mf mg l"/></div></figure><figure class="ly lz ma mb gt iv gh gi paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="gh gi mt"><img src="../Images/591874128ee86fea11d5651711ce3faf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*gUzSTjMzPWuf5jnoQymQGQ.png"/></div></div></figure><figure class="ly lz ma mb gt iv gh gi paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="gh gi mu"><img src="../Images/29fafbabf50fc9ce4da98081099b47a5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*I6XttyHYxdWknaLYQn9_Mw.png"/></div></div></figure><h2 id="bce9" class="kz la je bd lb lc ld dn le lf lg dp lh km li lj lk kq ll lm ln ku lo lp lq lr bi translated">AKS部署步骤</h2><p id="2a24" class="pw-post-body-paragraph kb kc je kd b ke ls kg kh ki lt kk kl km lu ko kp kq lv ks kt ku lw kw kx ky im bi translated">对于Azure Kubernetes部署，您需要替换AKS部署yaml文件中的内部版本号，并在成功执行后显示在Azure DevOps中。</p><figure class="ly lz ma mb gt iv"><div class="bz fp l di"><div class="mf mg l"/></div></figure><p id="deab" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">之后，对AKS集群运行“应用”命令。</p><p id="46c8" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">这里的两个重要参数是我的集群部署YAML脚本的路径(<em class="mq">)。/deployment/aks-deployment . YAML</em>)和一个集群名(<em class="mq"> device-manager-api-aks </em>)。其他参数已在前面的章节中解释过。</p><figure class="ly lz ma mb gt iv"><div class="bz fp l di"><div class="mf mg l"/></div></figure><figure class="ly lz ma mb gt iv gh gi paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="gh gi mv"><img src="../Images/39a5ad52b2720b90d345eda4884b0daa.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*HwYT_NiUvPZAbEawY7zUnA.png"/></div></div></figure><p id="0cc9" class="pw-post-body-paragraph kb kc je kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">就是这样！下面我列出了我们在前面几节中配置的完整的YAML管道，它很容易导入到您的Azure DevOps项目中。如果您有任何问题，请在评论中联系我们！</p><figure class="ly lz ma mb gt iv"><div class="bz fp l di"><div class="mf mg l"/></div></figure></div></div>    
</body>
</html>