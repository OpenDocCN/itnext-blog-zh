<html>
<head>
<title>Expose local Kubernetes service on internet using ngrok</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用ngrok在互联网上公开本地Kubernetes服务</h1>
<blockquote>原文：<a href="https://itnext.io/expose-local-kubernetes-service-on-internet-using-ngrok-2888a1118b5b?source=collection_archive---------1-----------------------#2020-02-18">https://itnext.io/expose-local-kubernetes-service-on-internet-using-ngrok-2888a1118b5b?source=collection_archive---------1-----------------------#2020-02-18</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><figure class="ip iq gp gr ir is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi io"><img src="../Images/c366a0c119a81ed6426b1d7122e7b57c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*trEH_iYn7WBWUAz6DVto1Q.jpeg"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated"><a class="ae jd" href="https://unsplash.com/@productschool?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">产品学院</a>在<a class="ae jd" href="https://unsplash.com/s/photos/office?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</figcaption></figure><div class=""/><p id="86c4" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">使用本地Kubernetes集群，如minikube、k3s、microk8s或其他集群，对于测试新功能、试验和运行POC非常有用。一旦你准备好一个很酷的新功能，或者只是想与同事或客户快速分享你的工作成果，那么你必须将一切都推到一个在线集群。如果您有良好的CI/CD管道设置，这可能不是一个问题，但大多数时候，对于一个简单的一次性演示来说，这实在是太费力了。</p><p id="8ca8" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">Ngrok是一个在线的免费服务，它可以让你(除了别的以外)创建一个SSL隧道来将你的本地http流量暴露给互联网，并且只需要几分钟就可以设置好！你可以在他们的<a class="ae jd" href="https://dashboard.ngrok.com/get-started" rel="noopener ugc nofollow" target="_blank">主页</a>上阅读更多关于ngrok的内容，这是一个很棒的产品，不仅在我们现在看到的场景中非常有用，在更广泛的范围内也非常有用。</p></div><div class="ab cl lb lc hu ld" role="separator"><span class="le bw bk lf lg lh"/><span class="le bw bk lf lg lh"/><span class="le bw bk lf lg"/></div><div class="ij ik il im in"><h2 id="2767" class="li lj jg bd lk ll lm dn ln lo lp dp lq ko lr ls lt ks lu lv lw kw lx ly lz ma bi translated">设置和先决条件</h2><p id="97f2" class="pw-post-body-paragraph kd ke jg kf b kg mb ki kj kk mc km kn ko md kq kr ks me ku kv kw mf ky kz la ij bi translated">为了跟随教程，你需要一些先决条件。</p><p id="aa00" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">一个本地的Kubernetes集群(我在Windows 10上用的是minikube，通过WSL访问)。我推荐的易于安装的本地安装有:</p><ul class=""><li id="40fb" class="mg mh jg kf b kg kh kk kl ko mi ks mj kw mk la ml mm mn mo bi translated">Minikube:Kubernetes仓库的一部分</li><li id="0e20" class="mg mh jg kf b kg mp kk mq ko mr ks ms kw mt la ml mm mn mo bi translated">K3D :帮助者二进制文件，用于一个被称为k3s的牧场主的小而快速的分发</li><li id="7ecc" class="mg mh jg kf b kg mp kk mq ko mr ks ms kw mt la ml mm mn mo bi translated"><a class="ae jd" href="https://github.com/ubuntu/microk8s" rel="noopener ugc nofollow" target="_blank"> Microk8s </a>:由Ubuntu维护</li></ul><p id="ef91" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">按照ngrok页面中的<a class="ae jd" href="https://dashboard.ngrok.com/get-started" rel="noopener ugc nofollow" target="_blank">安装步骤</a>设置cli(您需要创建一个免费帐户)。</p><p id="399e" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">您将需要<strong class="kf jh"> kubectl cli </strong>。遵循Kubernetes主页上的官方指南，或者你也可以使用我的docker镜像，它拥有kubectl cli、bash/zsh补全和一些有用的别名。</p><h2 id="747a" class="li lj jg bd lk ll lm dn ln lo lp dp lq ko lr ls lt ks lu lv lw kw lx ly lz ma bi translated">设置</h2><p id="249b" class="pw-post-body-paragraph kd ke jg kf b kg mb ki kj kk mc km kn ko md kq kr ks me ku kv kw mf ky kz la ij bi translated">一旦安装了所有的先决条件，就该在您的Kubernetes集群中创建一些资源了，我们稍后将通过ngrok在互联网上公开这些资源。</p><p id="de20" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们将创建一个简单的nginx pod，并通过nodePort类型的服务在Kubernetes中公开它。Kubernetes服务为它们的目标pod创建内部负载平衡层。你可以在官方的Kubernetes文档页面中阅读更多关于服务的信息。一旦我们在本地公开了服务，我们将使用ngrok在本地服务和自动生成的互联网地址之间创建一个隧道。</p><h2 id="d094" class="li lj jg bd lk ll lm dn ln lo lp dp lq ko lr ls lt ks lu lv lw kw lx ly lz ma bi translated">逐步说明</h2><p id="3371" class="pw-post-body-paragraph kd ke jg kf b kg mb ki kj kk mc km kn ko md kq kr ks me ku kv kw mf ky kz la ij bi translated">1.将<strong class="kf jh"> kubectl </strong>的别名设置为更容易运行的命令。这一步是可选的。</p><pre class="mu mv mw mx gt my mz na nb aw nc bi"><span id="225d" class="li lj jg mz b gy nd ne l nf ng">alias k=kubectl</span></pre><p id="2625" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">2.在本地集群中创建nginx pod。</p><pre class="mu mv mw mx gt my mz na nb aw nc bi"><span id="cf93" class="li lj jg mz b gy nd ne l nf ng">k run nginx — image nginx — restart Never</span></pre><p id="1b79" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">3.通过节点端口服务公开nginx pod。</p><pre class="mu mv mw mx gt my mz na nb aw nc bi"><span id="624d" class="li lj jg mz b gy nd ne l nf ng">k expose pod nginx — port 80 — target-port 80 — type NodePort — name nginx-service</span></pre><p id="f527" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">4.用服务的节点端口创建变量。这里我们使用的是<strong class="kf jh"> jsonpath </strong>，它是kubectl的特性，允许从api-server中选择任意值。我们正在检查Kubernetes为我们的服务自动分配了什么节点端口。</p><pre class="mu mv mw mx gt my mz na nb aw nc bi"><span id="6641" class="li lj jg mz b gy nd ne l nf ng">NODE_PORT=$(k get svc nginx-service -o=jsonpath=”{$.spec.ports[0].nodePort}{‘\n’}”)</span></pre><p id="b400" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">5.使用curl检查nginx在主机的端口上是否可用。您应该会看到nginx默认欢迎页面的HTML内容。</p><p id="2588" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">如果您在minikube中运行Kubernetes:</p><pre class="mu mv mw mx gt my mz na nb aw nc bi"><span id="c826" class="li lj jg mz b gy nd ne l nf ng">curl <a class="ae jd" rel="noopener ugc nofollow" target="_blank" href="/{minikube">http://{minikube</a> ip}:$NODE_PORT</span></pre><p id="7f6a" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">提示:您可以通过运行<strong class="kf jh"> mikikube ip </strong>来检查主机ip</p><p id="d64f" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">如果您正在运行支持本地主机的本地Kubernetes安装，只需输入</p><pre class="mu mv mw mx gt my mz na nb aw nc bi"><span id="e866" class="li lj jg mz b gy nd ne l nf ng">curl <a class="ae jd" href="http://localhost:$NODE_PORT`" rel="noopener ugc nofollow" target="_blank">http://localhost:$NODE_PORT</a></span></pre><p id="ce72" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">6.使用ngrok在互联网上公开您的服务。Ngrok将为我们生成http和https地址，以便我们能够访问我们的服务。</p><p id="ebd3" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">如果您在minikube中运行Kubernetes:</p><pre class="mu mv mw mx gt my mz na nb aw nc bi"><span id="4b48" class="li lj jg mz b gy nd ne l nf ng">ngrok http <a class="ae jd" rel="noopener ugc nofollow" target="_blank" href="/{minikube">http://{minikube</a> ip}:$NODE_PORT</span></pre><p id="ed92" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">如果您正在运行支持本地主机的本地Kubernetes安装，只需输入</p><pre class="mu mv mw mx gt my mz na nb aw nc bi"><span id="b745" class="li lj jg mz b gy nd ne l nf ng">ngrok http <a class="ae jd" href="http://localhost:$NODE_PORT`" rel="noopener ugc nofollow" target="_blank">http://localhost:$NODE_PORT</a></span></pre><p id="f123" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这将打开ngrok会话，显示生成的地址:</p><figure class="mu mv mw mx gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi nh"><img src="../Images/912a177c314399607ab0d8fb1cbe9689.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*M6TsBA-AE-uHSS59t2gN6Q.png"/></div></div></figure><p id="31f9" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">继续前进，按照“Web Interface”地址查看ngrok的仪表板:<a class="ae jd" href="http://127.0.0.1:4040" rel="noopener ugc nofollow" target="_blank"> http://127.0.0.1:4040 </a>并探索界面。点击其中一个自动生成的链接，您应该会看到nginx欢迎页面！</p><h2 id="78b7" class="li lj jg bd lk ll lm dn ln lo lp dp lq ko lr ls lt ks lu lv lw kw lx ly lz ma bi translated">结论</h2><p id="0c35" class="pw-post-body-paragraph kd ke jg kf b kg mb ki kj kk mc km kn ko md kq kr ks me ku kv kw mf ky kz la ij bi translated">我们已经看到使用ngrok公开Kubernetes服务是多么容易。不需要部署到任何在线集群，只需使用您知道有效的本地Kubernetes设置，并能够与任何人分享您的工作成果。</p><p id="e2b4" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">当然，这仅用于测试/演示目的，不适合运行生产级工作负载。</p></div></div>    
</body>
</html>