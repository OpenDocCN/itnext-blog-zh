<html>
<head>
<title>Auto-Heal Azure VM Scale Set Instances</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">自动修复Azure虚拟机规模集实例</h1>
<blockquote>原文：<a href="https://itnext.io/auto-heal-azure-vm-scale-set-instances-50c3b1908578?source=collection_archive---------5-----------------------#2020-07-10">https://itnext.io/auto-heal-azure-vm-scale-set-instances-50c3b1908578?source=collection_archive---------5-----------------------#2020-07-10</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/bd7ae4ed53b25736b7b6ee7fadd3da12.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*UU_4KFgzOWsPtMHiM0UmtA.png"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">负载平衡器运行状况探测器</figcaption></figure><p id="0135" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">在最近的一次项目中，我被要求找到一种方法，在应用程序变得不健康时自动修复规模集中的实例。最近做了相当多的Kubernetes，很好地理解了自动愈合的概念；我只需要找到音阶设置的解决方案。幸运的是，微软在2020年4月推出了一项名为VMSS自动实例修复的新功能。</p><p id="0126" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">在开始实现之前，让我们回顾一下什么是自动修复。自动修复解决方案由两个关键组件组成:</p><ol class=""><li id="c85a" class="la lb iq ke b kf kg kj kk kn lc kr ld kv le kz lf lg lh li bi translated">检查应用程序运行状况的探测机制</li><li id="46c6" class="la lb iq ke b kf lj kj lk kn ll kr lm kv ln kz lf lg lh li bi translated">使应用程序进入健康状态的恢复机制</li></ol><h1 id="9e94" class="lo lp iq bd lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml bi translated">探测机制</h1><p id="590d" class="pw-post-body-paragraph kc kd iq ke b kf mm kh ki kj mn kl km kn mo kp kq kr mp kt ku kv mq kx ky kz ij bi translated">为了探测应用程序，健康探测器被定义为定期检查应用程序。L4和L7探针是可能的。</p><ul class=""><li id="19af" class="la lb iq ke b kf kg kj kk kn lc kr ld kv le kz mr lg lh li bi translated">L4(第4层)探测器检查应用程序的TCP端口是否打开。虽然端口可以打开，但它可能无法完全反映端口背后的应用程序的健康状况。</li><li id="e36e" class="la lb iq ke b kf lj kj lk kn ll kr lm kv ln kz mr lg lh li bi translated">L7(第7层)探测器检查HTTP或HTTPS上的URL路径。最粗糙的选项是index.html，但是不会验证应用程序是否正在处理请求。首选方案是拥有一个验证应用程序多个方面的应用程序健康端点。从探测器的角度来看，当应用程序健康时，它期望接收一个HTTP 200否则将其标记为不健康。</li></ul><p id="5cef" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">可以从负载平衡器运行状况探测器或通过使用VMSS应用程序运行状况扩展来执行探测。使用负载平衡器探测器是首选选项(在下面的限制中解释)</p><h1 id="5e3c" class="lo lp iq bd lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml bi translated">恢复机制</h1><p id="51f5" class="pw-post-body-paragraph kc kd iq ke b kf mm kh ki kj mn kl km kn mo kp kq kr mp kt ku kv mq kx ky kz ij bi translated">在前云时代，实例被当作宠物来管理，操作员会尝试让实例重新联机。这种方法是劳动密集型的，并且对于每个应用需要不同的程序。</p><p id="8f03" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">相反，通过采用牛的方法，可以认为实例是一次性的和可替换的。VMSS方法将终止不健康的实例并产生一个新的实例。所有在原始实例上运行的脚本/扩展将在实例化新节点时运行(与自动缩放过程相同)。因此，尽量缩短这些步骤，因为它们会给恢复健康状态带来延迟。</p><h1 id="1573" class="lo lp iq bd lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml bi translated">限制</h1><ul class=""><li id="b053" class="la lb iq ke b kf mm kj mn kn ms kr mt kv mu kz mr lg lh li bi translated"><strong class="ke ir">宽限期</strong> —每当规模集被修改(添加节点、修改配置)时，自动修复过程都会进入至少30分钟的宽限期，然后才能采取修复措施。这是给应用程序一个稳定的时间。用Kubernetes的话来说，这是一个非常粗糙的就绪调查。我怀疑微软会加强这一点，以符合Kubernetes的语义。</li><li id="b10a" class="la lb iq ke b kf lj kj lk kn ll kr lm kv ln kz mr lg lh li bi translated"><strong class="ke ir">负载平衡器HTTPS探测器</strong> — LB HTTPS探测器不支持使用自签名证书。而应用网关探测器通过具有可信根证书(AppGw v2)或认证证书(AppGw v1)来支持这些证书；它们还不是有效的探针来源</li><li id="4d02" class="la lb iq ke b kf lj kj lk kn ll kr lm kv ln kz mr lg lh li bi translated"><strong class="ke ir">应用健康扩展</strong> —该扩展在VMSS实例中运行，并执行健康检查。该扩展针对localhost/127.0.0.1进行探测。因此，如果您的应用程序绑定到特定的接口，探测器将无法到达端点并使实例失败。修复方法是将您的应用程序绑定到0.0.0.0。</li><li id="768f" class="la lb iq ke b kf lj kj lk kn ll kr lm kv ln kz mr lg lh li bi translated"><strong class="ke ir">应用健康扩展</strong> —与外部化的负载平衡器探测器不同，由该扩展管理的探测器不支持在将实例标记为不健康之前的间隔时间和失败探测器数量。我希望微软能加强这一点，以配合外部探测行为。</li></ul><h1 id="1ac7" class="lo lp iq bd lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml bi translated">配置</h1><p id="ca25" class="pw-post-body-paragraph kc kd iq ke b kf mm kh ki kj mn kl km kn mo kp kq kr mp kt ku kv mq kx ky kz ij bi translated">要配置自动修复，需要通过在ARM模板的<em class="mv">属性</em>部分下添加这个块来启用</p><pre class="mw mx my mz gt na nb nc nd aw ne bi"><span id="f04c" class="nf lp iq nb b gy ng nh l ni nj">"automaticRepairsPolicy": {<br/>          "enabled": true,<br/>          "gracePeriod": "PT30M"<br/>}</span></pre><h2 id="49cc" class="nf lp iq bd lq nk nl dn lu nm nn dp ly kn no np mc kr nq nr mg kv ns nt mk nu bi translated">应用健康选项</h2><p id="1485" class="pw-post-body-paragraph kc kd iq ke b kf mm kh ki kj mn kl km kn mo kp kq kr mp kt ku kv mq kx ky kz ij bi translated">在<em class="mv"> extensionProfile </em>部分下，添加健康扩展的配置</p><pre class="mw mx my mz gt na nb nc nd aw ne bi"><span id="e7c0" class="nf lp iq nb b gy ng nh l ni nj">"extensionProfile": {<br/>    "extensions": [<br/>        {<br/>        "name": "[variables('applicationHealthExtensionName')]",<br/>        "properties": {<br/>            "autoUpgradeMinorVersion": true,<br/>            "publisher": "Microsoft.ManagedServices",<br/>            "type": "ApplicationHealthLinux",<br/>            "typeHandlerVersion": "1.0",<br/>            "settings": {<br/>              "protocol": "[parameters('healthProbeProtocol')]",<br/>              "port": "[parameters('healthProbePort')]"<br/>            }<br/>        }<br/>        }<br/>    ]</span></pre><h2 id="b199" class="nf lp iq bd lq nk nl dn lu nm nn dp ly kn no np mc kr nq nr mg kv ns nt mk nu bi translated">负载平衡器选项</h2><p id="d425" class="pw-post-body-paragraph kc kd iq ke b kf mm kh ki kj mn kl km kn mo kp kq kr mp kt ku kv mq kx ky kz ij bi translated">对于此选项，单独创建负载平衡器，并将探测器资源Id传递到规模集的<em class="mv">network profile . health probe . Id</em>字段中。配置简单多了。</p><pre class="mw mx my mz gt na nb nc nd aw ne bi"><span id="a5ff" class="nf lp iq nb b gy ng nh l ni nj">"networkProfile": {<br/>            "healthProbe": {<br/>              "id": "[variables('probeID')]"<br/>            },</span></pre><h1 id="504e" class="lo lp iq bd lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml bi translated">资源</h1><p id="3a6f" class="pw-post-body-paragraph kc kd iq ke b kf mm kh ki kj mn kl km kn mo kp kq kr mp kt ku kv mq kx ky kz ij bi translated">VMSS自动实例修复的微软文档:<a class="ae nv" href="https://docs.microsoft.com/en-us/azure/virtual-machine-scale-sets/virtual-machine-scale-sets-automatic-instance-repairs" rel="noopener ugc nofollow" target="_blank">https://docs . Microsoft . com/en-us/azure/virtual-machine-scale-sets/virtual-machine-scale-sets-Automatic-instance-repair</a></p></div></div>    
</body>
</html>