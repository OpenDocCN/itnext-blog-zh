<html>
<head>
<title>Creating an Expressjs app using Ejs, Express-session with Redis</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Ejs创建Expressjs应用程序，Express-session with Redis</h1>
<blockquote>原文：<a href="https://itnext.io/creating-an-expressjs-app-using-ejs-express-session-with-redis-9fee113023c6?source=collection_archive---------2-----------------------#2019-07-10">https://itnext.io/creating-an-expressjs-app-using-ejs-express-session-with-redis-9fee113023c6?source=collection_archive---------2-----------------------#2019-07-10</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/c30daf7d79e4b3dfb9765db101f21589.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Y6DbsLPTQ5nHRgNR1WeJgA.jpeg"/></div></div></figure><p id="194d" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">今天我们将学习如何使用expressjs、Ejs和express-session with redis创建简单的登录应用程序。</p><p id="d576" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">让我们先来看看我们正在使用的技术。</p><h1 id="9417" class="kw kx iq bd ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt bi translated">Expressjs</h1><blockquote class="lu lv lw"><p id="26ed" class="jy jz lx ka b kb kc kd ke kf kg kh ki ly kk kl km lz ko kp kq ma ks kt ku kv ij bi translated">Express是一个最小且灵活的Node.js web应用程序框架，为web和移动应用程序提供了一组强大的功能。</p></blockquote><div class="mb mc gp gr md me"><a href="https://expressjs.com/" rel="noopener  ugc nofollow" target="_blank"><div class="mf ab fo"><div class="mg ab mh cl cj mi"><h2 class="bd ir gy z fp mj fr fs mk fu fw ip bi translated">Express - Node.js web应用程序框架</h2><div class="ml l"><h3 class="bd b gy z fp mj fr fs mk fu fw dk translated">Express是一个最小且灵活的Node.js web应用程序框架，它为web和…</h3></div><div class="mm l"><p class="bd b dl z fp mj fr fs mk fu fw dk translated">expressjs.com</p></div></div><div class="mn l"><div class="mo l mp mq mr mn ms jw me"/></div></div></a></div><h1 id="c309" class="kw kx iq bd ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt bi translated">雷迪斯</h1><blockquote class="lu lv lw"><p id="d6f3" class="jy jz lx ka b kb kc kd ke kf kg kh ki ly kk kl km lz ko kp kq ma ks kt ku kv ij bi translated">Redis是一个内存数据结构项目，它实现了一个分布式的、具有可选持久性的内存键值数据库。Redis支持不同种类的抽象数据结构，如字符串、列表、映射、集合、有序集合、超对数。</p></blockquote><p id="34c6" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我们将使用它来存储我们的会话数据。</p><div class="mb mc gp gr md me"><a href="https://redis.io/" rel="noopener  ugc nofollow" target="_blank"><div class="mf ab fo"><div class="mg ab mh cl cj mi"><h2 class="bd ir gy z fp mj fr fs mk fu fw ip bi translated">雷迪斯</h2><div class="ml l"><h3 class="bd b gy z fp mj fr fs mk fu fw dk translated">Redis是一个开源的(BSD许可的)，内存中的数据结构存储，用作数据库，缓存和消息代理…</h3></div><div class="mm l"><p class="bd b dl z fp mj fr fs mk fu fw dk translated">redis.io</p></div></div><div class="mn l"><div class="mt l mp mq mr mn ms jw me"/></div></div></a></div><h1 id="ae80" class="kw kx iq bd ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt bi translated">快速会话</h1><blockquote class="lu lv lw"><p id="e026" class="jy jz lx ka b kb kc kd ke kf kg kh ki ly kk kl km lz ko kp kq ma ks kt ku kv ij bi translated">这是一个简单的Express会话中间件，允许您管理NodeJS-Express应用程序中的会话。</p></blockquote><div class="mb mc gp gr md me"><a href="https://www.npmjs.com/package/express-session" rel="noopener  ugc nofollow" target="_blank"><div class="mf ab fo"><div class="mg ab mh cl cj mi"><h2 class="bd ir gy z fp mj fr fs mk fu fw ip bi translated">快速会话</h2><div class="ml l"><h3 class="bd b gy z fp mj fr fs mk fu fw dk translated">Express的简单会话中间件</h3></div><div class="mm l"><p class="bd b dl z fp mj fr fs mk fu fw dk translated">www.npmjs.com</p></div></div><div class="mn l"><div class="mu l mp mq mr mn ms jw me"/></div></div></a></div><h1 id="66f1" class="kw kx iq bd ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt bi translated">EJS</h1><blockquote class="lu lv lw"><p id="210a" class="jy jz lx ka b kb kc kd ke kf kg kh ki ly kk kl km lz ko kp kq ma ks kt ku kv ij bi translated">EJS是一种简单的模板语言，可以让你用普通的JavaScript生成HTML标记。</p></blockquote><div class="mb mc gp gr md me"><a href="https://ejs.co/" rel="noopener  ugc nofollow" target="_blank"><div class="mf ab fo"><div class="mg ab mh cl cj mi"><h2 class="bd ir gy z fp mj fr fs mk fu fw ip bi translated">嵌入EJS的JavaScript模板</h2><div class="ml l"><h3 class="bd b gy z fp mj fr fs mk fu fw dk translated">e代表有效的。EJS是一种简单的模板语言，让你用普通的JavaScript生成HTML标记…</h3></div><div class="mm l"><p class="bd b dl z fp mj fr fs mk fu fw dk translated">ejs.co</p></div></div></div></a></div></div><div class="ab cl mv mw hu mx" role="separator"><span class="my bw bk mz na nb"/><span class="my bw bk mz na nb"/><span class="my bw bk mz na"/></div><div class="ij ik il im in"><h1 id="6cc1" class="kw kx iq bd ky kz nc lb lc ld nd lf lg lh ne lj lk ll nf ln lo lp ng lr ls lt bi translated">装置</h1><p id="b778" class="pw-post-body-paragraph jy jz iq ka b kb nh kd ke kf ni kh ki kj nj kl km kn nk kp kq kr nl kt ku kv ij bi translated">使用命令安装快速生成器</p><pre class="nm nn no np gt nq nr ns nt aw nu bi"><span id="5bb7" class="nv kx iq nr b gy nw nx l ny nz">$ npm install -g express-generator</span></pre><p id="e5a1" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">现在使用命令创建一个node-express项目目录</p><pre class="nm nn no np gt nq nr ns nt aw nu bi"><span id="a88b" class="nv kx iq nr b gy nw nx l ny nz">$ express --view=ejs '$project-name'</span></pre><p id="e2bd" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">这将创建一个包含必要文件和文件夹的项目目录。现在在项目目录中运行$npm install，这将安装所需的依赖项。您的目录将如下所示</p><figure class="nm nn no np gt jr gh gi paragraph-image"><div class="gh gi oa"><img src="../Images/03ecb7b17aa9ac14658d5f22036add97.png" data-original-src="https://miro.medium.com/v2/resize:fit:646/format:webp/1*V4vBu1zdBnUUEaNOLdnzog.png"/></div><figcaption class="ob oc gj gh gi od oe bd b be z dk translated">目录结构</figcaption></figure><p id="f113" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">使用命令安装Redis</p><pre class="nm nn no np gt nq nr ns nt aw nu bi"><span id="5d17" class="nv kx iq nr b gy nw nx l ny nz">$ wget http://download.redis.io/redis-stable.tar.gz<br/>$ tar xvzf redis-stable.tar.gz<br/>$ cd redis-stable<br/>$ make</span></pre><p id="833d" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">现在运行这个命令来创建redis服务器</p><pre class="nm nn no np gt nq nr ns nt aw nu bi"><span id="9d1d" class="nv kx iq nr b gy nw nx l ny nz">$ ./redis-server --port 6380 --slaveof 127.0.0.1 6379</span></pre><p id="e2af" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">Redis服务器现在运行在本地主机和6379端口上。在express目录中安装这些库</p><h2 id="aa55" class="nv kx iq bd ky of og dn lc oh oi dp lg kj oj ok lk kn ol om lo kr on oo ls op bi translated">雷迪斯</h2><p id="b70c" class="pw-post-body-paragraph jy jz iq ka b kb nh kd ke kf ni kh ki kj nj kl km kn nk kp kq kr nl kt ku kv ij bi translated">这将把节点服务器与redis服务器连接起来</p><pre class="nm nn no np gt nq nr ns nt aw nu bi"><span id="5174" class="nv kx iq nr b gy nw nx l ny nz">$ npm i redis --save</span></pre><h2 id="8d6c" class="nv kx iq bd ky of og dn lc oh oi dp lg kj oj ok lk kn ol om lo kr on oo ls op bi translated">连接-redis</h2><p id="146c" class="pw-post-body-paragraph jy jz iq ka b kb nh kd ke kf ni kh ki kj nj kl km kn nk kp kq kr nl kt ku kv ij bi translated">这将连接redis和express会话</p><pre class="nm nn no np gt nq nr ns nt aw nu bi"><span id="0804" class="nv kx iq nr b gy nw nx l ny nz">$ npm i connect-redis --save</span></pre><h2 id="92ac" class="nv kx iq bd ky of og dn lc oh oi dp lg kj oj ok lk kn ol om lo kr on oo ls op bi translated">快速会话</h2><p id="45ee" class="pw-post-body-paragraph jy jz iq ka b kb nh kd ke kf ni kh ki kj nj kl km kn nk kp kq kr nl kt ku kv ij bi translated">这将在服务器上创建会话</p><pre class="nm nn no np gt nq nr ns nt aw nu bi"><span id="82ba" class="nv kx iq nr b gy nw nx l ny nz">$ npm i express-session --save</span></pre><p id="eb06" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我们已经完成了所有的安装，现在让我们开始编码。</p></div><div class="ab cl mv mw hu mx" role="separator"><span class="my bw bk mz na nb"/><span class="my bw bk mz na nb"/><span class="my bw bk mz na"/></div><div class="ij ik il im in"><h1 id="1a34" class="kw kx iq bd ky kz nc lb lc ld nd lf lg lh ne lj lk ll nf ln lo lp ng lr ls lt bi translated">编码</h1><p id="9daf" class="pw-post-body-paragraph jy jz iq ka b kb nh kd ke kf ni kh ki kj nj kl km kn nk kp kq kr nl kt ku kv ij bi translated">在项目的根文件夹中创建一个redis.js文件，并粘贴以下代码。</p><figure class="nm nn no np gt jr"><div class="bz fp l di"><div class="oq or l"/></div></figure><p id="bb86" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">RedisStore函数在redis中创建一个存储来保存会话数据并返回一个对象，该对象有多个方法，就像我们在getAllActiveSession()函数中使用的一个方法，我们将在后面使用它。RedisStore函数接受以下参数。</p><ul class=""><li id="4b3d" class="os ot iq ka b kb kc kf kg kj ou kn ov kr ow kv ox oy oz pa bi translated"><code class="fe pb pc pd nr b">client</code>现有客户</li><li id="7536" class="os ot iq ka b kb pe kf pf kj pg kn ph kr pi kv ox oy oz pa bi translated"><code class="fe pb pc pd nr b">host</code> Redis服务器主机名</li><li id="f7b3" class="os ot iq ka b kb pe kf pf kj pg kn ph kr pi kv ox oy oz pa bi translated"><code class="fe pb pc pd nr b">port</code> Redis服务器端口号</li><li id="064c" class="os ot iq ka b kb pe kf pf kj pg kn ph kr pi kv ox oy oz pa bi translated"><code class="fe pb pc pd nr b">ttl</code>服务器会话生存时间</li></ul><p id="e204" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我们已经创建了redis存储，现在将此存储连接到express会话。为此，请在app.js中编写以下代码</p><figure class="nm nn no np gt jr"><div class="bz fp l di"><div class="oq or l"/></div></figure><p id="34d6" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">这里的会话是中间件，它会根据每个请求执行。现在让我们创建一个呈现登录页面的登录路由。在app.js中编写以下代码</p><figure class="nm nn no np gt jr"><div class="bz fp l di"><div class="oq or l"/></div></figure><p id="37a8" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">res.render函数将在views目录中搜索login.ejs文件，并将其呈现给客户端。我们还没有登录页面，现在我们将创建一个。在views目录中创建一个login.ejs文件，并编写以下代码</p><figure class="nm nn no np gt jr"><div class="bz fp l di"><div class="oq or l"/></div></figure><p id="9e91" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">创建了登录页面，如果提交登录表单会发生什么？它将给出一个错误，因为我们还没有创建任何路由来处理登录提交。为此，我们将使用POST方法创建一个登录路由。</p><figure class="nm nn no np gt jr"><div class="bz fp l di"><div class="oq or l"/></div></figure><p id="7186" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在这个函数中，我们将首先验证用户，如果它存在于数据库中，并且它的密码是正确的(我不会告诉你如何做，因为我假设你已经知道了。).如果用户通过身份验证，将为用户创建一个会话，页面将重定向到列表路由。</p><p id="bae5" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在列表路由中，我们可以看到所有活动用户的列表。列表路径将如下所示</p><figure class="nm nn no np gt jr"><div class="bz fp l di"><div class="oq or l"/></div></figure><p id="6d31" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">记得我们在redis.js中定义了一个函数getAllActiveSession()，这个函数从会话存储中返回用户的所有活动会话。列表路由是受授权保护的，这意味着如果您没有登录，您将无法访问此路由。为了保护这个路由，我创建了一个中间件函数requireLogin()，它检查用户是否登录。如果没有登录，这个函数会将您重定向到登录页面。</p><p id="5783" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我们获得了活动用户数据，现在我们将通过将这些数据分配给res.locals.users，将这些数据传递给列表页面，以在客户端显示这些数据。我们可以在views目录中的list.ejs文件中访问这些数据。因此list.ejs文件将如下所示</p><figure class="nm nn no np gt jr"><div class="bz fp l di"><div class="oq or l"/></div></figure><p id="7a1f" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">参见脚本中的这个。为什么我们这样传递用户对象？因为ejs文件在服务器上渲染并发送html到客户端，如果我们不字符串化对象，我们将在客户端看到[Object object]。所以要把对象发送到客户端，首先我们要在服务器端把对象字符串化，然后在客户端解析它，然后我们就可以使用它了。</p></div><div class="ab cl mv mw hu mx" role="separator"><span class="my bw bk mz na nb"/><span class="my bw bk mz na nb"/><span class="my bw bk mz na"/></div><div class="ij ik il im in"><p id="dfaf" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">现在，您已经具备了使用ejs创建express应用程序和使用redis创建express会话的基本知识。为了得到这个github repo的更多细节，我还在这个项目中使用soket来实时更新活跃用户列表。</p><div class="mb mc gp gr md me"><a href="https://github.com/hasanraza24/express-app" rel="noopener  ugc nofollow" target="_blank"><div class="mf ab fo"><div class="mg ab mh cl cj mi"><h2 class="bd ir gy z fp mj fr fs mk fu fw ip bi translated">hasanraza24/express-app</h2><div class="ml l"><h3 class="bd b gy z fp mj fr fs mk fu fw dk translated">通过在GitHub上创建帐户，为hasanraza24/express-app开发做出贡献。</h3></div><div class="mm l"><p class="bd b dl z fp mj fr fs mk fu fw dk translated">github.com</p></div></div></div></a></div></div></div>    
</body>
</html>