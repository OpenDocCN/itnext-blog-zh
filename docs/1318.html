<html>
<head>
<title>Letsencrypt and GCE HTTPS Loadbalancers, via Kubernetes CronJobs</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Letsencrypt和GCE HTTPS负载平衡器，通过Kubernetes CronJobs</h1>
<blockquote>原文：<a href="https://itnext.io/letsencrypt-and-gce-https-loadbalancers-via-kubernetes-cronjobs-65ad79ade46?source=collection_archive---------2-----------------------#2018-09-10">https://itnext.io/letsencrypt-and-gce-https-loadbalancers-via-kubernetes-cronjobs-65ad79ade46?source=collection_archive---------2-----------------------#2018-09-10</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><figure class="ip iq gp gr ir is gh gi paragraph-image"><div class="gh gi io"><img src="../Images/dabd6aabce30055314f627805d9a182f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1290/format:webp/1*B2Mm0LTGy_-kelpiOwKBLg.png"/></div></figure><div class=""/><p id="a6e5" class="pw-post-body-paragraph ju jv ix jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">在Aller Media，我们直接在GKE管理大部分入口资源。这感觉很好，因为我们可以像定义应用部署一样定义面向公众的网络基础设施。在yaml。在版本控制中。</p><p id="166a" class="pw-post-body-paragraph ju jv ix jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">由于历史原因，我们设置了一些GCE负载平衡器资源，最初我们向这些资源提供了供应商提供的1年证书。这很好，只是它每年会回来唠叨你一次，你将不得不进入付费使用怪异界面来创建的令人不快的地下世界。pem的，你以后需要解剖堆叠中间链在正确的顺序亚达亚达…</p><p id="08e0" class="pw-post-body-paragraph ju jv ix jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">我们更希望我们用于kubernetes ingresses的自动证书更新循环也适用于这个用例。</p><h1 id="836e" class="ks kt ix bd ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp bi translated">证书管理器</h1><p id="7981" class="pw-post-body-paragraph ju jv ix jw b jx lq jz ka kb lr kd ke kf ls kh ki kj lt kl km kn lu kp kq kr ij bi translated">回到2018年3月，Let's Encrypt发布了他们的v2 api，允许通配符证书。Cert-manager支持这个api，并允许我们将证书请求定义为yaml。为了完成这项工作，你需要一个证书管理器发行者来使用<em class="lv"> dns01 </em>验证方法。设置cert-manager超出了本文的范围。</p><figure class="lw lx ly lz gt is"><div class="bz fp l di"><div class="ma mb l"/></div><figcaption class="mc md gj gh gi me mf bd b be z dk translated">创建通配符证书</figcaption></figure><p id="105b" class="pw-post-body-paragraph ju jv ix jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">这会为*.example.com创建一个证书请求，使用Let's Encrypt完成验证周期，并在kubernetes的一个名为<em class="lv"> wilcard-example-com-tls的秘密中呈现新的有效证书。</em></p><h1 id="ca5d" class="ks kt ix bd ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp bi translated">更新HTTPS负载平衡器</h1><p id="cc33" class="pw-post-body-paragraph ju jv ix jw b jx lq jz ka kb lr kd ke kf ls kh ki kj lt kl km kn lu kp kq kr ij bi translated">在IAM角色文档中，我们发现这个项目的未来cronjobs需要所有受影响项目的<code class="fe mg mh mi mj b">compute.securityAdmin</code>角色。我们从一开始就知道我们需要分配一些特权，但这也太多了。因此，我们在<a class="ae mk" href="https://cloud.google.com/iam/docs/creating-custom-roles" rel="noopener ugc nofollow" target="_blank">文档</a>之后创建了一个新角色，并想到了这个:</p><figure class="lw lx ly lz gt is"><div class="bz fp l di"><div class="ma mb l"/></div><figcaption class="mc md gj gh gi me mf bd b be z dk translated">创建新的计算机IAM角色</figcaption></figure><p id="6c1d" class="pw-post-body-paragraph ju jv ix jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">我们将这个角色添加到我们的组织中，并将其授予一个服务帐户，然后将这个服务帐户的密钥文件放在kubernetes secret中。</p><h1 id="2e2a" class="ks kt ix bd ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp bi translated">更新-证书</h1><p id="8f6a" class="pw-post-body-paragraph ju jv ix jw b jx lq jz ka kb lr kd ke kf ls kh ki kj lt kl km kn lu kp kq kr ij bi translated">所以我们有一个服务帐户和一个证书。我们需要一些狂欢。</p><figure class="lw lx ly lz gt is"><div class="bz fp l di"><div class="ma mb l"/></div><figcaption class="mc md gj gh gi me mf bd b be z dk translated">做所有的事情</figcaption></figure><p id="baf8" class="pw-post-body-paragraph ju jv ix jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">用Google Cloud SDK将它构建到一个容器中</p><figure class="lw lx ly lz gt is"><div class="bz fp l di"><div class="ma mb l"/></div></figure><p id="f308" class="pw-post-body-paragraph ju jv ix jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">或者甚至将脚本挂载到Googles官方SDK镜像中。</p><p id="88b7" class="pw-post-body-paragraph ju jv ix jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">我们在这里假设在哪里可以找到我们的本地证书文件、gcloud cli的凭据等。当我们介绍我们的cronjob规范时，这一切都联系起来了。</p><h1 id="903d" class="ks kt ix bd ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp bi translated">克朗乔布</h1><figure class="lw lx ly lz gt is"><div class="bz fp l di"><div class="ma mb l"/></div><figcaption class="mc md gj gh gi me mf bd b be z dk translated">定期运行</figcaption></figure><p id="26f0" class="pw-post-body-paragraph ju jv ix jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">我们将我们的服务帐户和证书安装到“更新-证书”可以找到它们的地方。</p><p id="8013" class="pw-post-body-paragraph ju jv ix jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">每周一办公时间，该作业将检查由cert-manager管理的letsencrypt证书和当前在所选目标https-proxy中运行的证书之间是否存在差异。diff提示替换和清除target-https-proxy中的证书。</p><p id="1f6f" class="pw-post-body-paragraph ju jv ix jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">prometheus/alertmanager会提醒我们cronjob设置中的故障。我很乐意看到cert-manager向prometheus公开成功/错误率，但是有一些pull请求等待处理，所以我相信这很快就会发生。</p><p id="7bb9" class="pw-post-body-paragraph ju jv ix jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">可以设置项目、证书、服务帐户和目标代理的任意组合。管理几个代理只需要添加cronjobs。</p></div></div>    
</body>
</html>