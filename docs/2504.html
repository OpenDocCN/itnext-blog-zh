<html>
<head>
<title>Building docker images from private git repositories using ssh login</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用ssh登录从私有git存储库构建docker映像</h1>
<blockquote>原文：<a href="https://itnext.io/building-docker-images-from-private-git-repositories-using-ssh-login-433edf5a18f2?source=collection_archive---------0-----------------------#2019-06-04">https://itnext.io/building-docker-images-from-private-git-repositories-using-ssh-login-433edf5a18f2?source=collection_archive---------0-----------------------#2019-06-04</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><figure class="ip iq gp gr ir is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi io"><img src="../Images/800d212cadf6ab74bad30655c732337e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*IIGOCa0gPbh_m7L9"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">弗兰克·麦肯纳在<a class="ae jd" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</figcaption></figure><div class=""/><p id="66a7" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">如果你想安装和试用软件，而不需要弄乱你的操作系统，或者为你正在开发的应用程序建立一个干净的环境，Docker是一个非常棒的工具。在这篇文章中，我将一步一步地向您展示如何设置docker文件，这样您就可以克隆一个私有github repo，并在公共映像中使用从该repo构建的内容，而不必担心公共映像中的凭证或私有文件。作为例子，我从私有回购构建vue.js应用程序，并使用构建的应用程序设置web服务器。</p><p id="27d8" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">本教程有3个步骤:</p><ol class=""><li id="297e" class="lb lc jg kf b kg kh kk kl ko ld ks le kw lf la lg lh li lj bi translated">从git存储库克隆和构建docker映像</li><li id="dd62" class="lb lc jg kf b kg lk kk ll ko lm ks ln kw lo la lg lh li lj bi translated">在设置精益web服务器之前，使用构建器映像构建应用程序</li><li id="0f1d" class="lb lc jg kf b kg lk kk ll ko lm ks ln kw lo la lg lh li lj bi translated">将ssh密钥导入构建器以克隆私有存储库</li></ol><h2 id="bcfa" class="lp lq jg bd lr ls lt dn lu lv lw dp lx ko ly lz ma ks mb mc md kw me mf mg mh bi translated">从git存储库克隆和构建docker映像</h2><p id="4a4c" class="pw-post-body-paragraph kd ke jg kf b kg mi ki kj kk mj km kn ko mk kq kr ks ml ku kv kw mm ky kz la ij bi translated">最好的情况是，例如，当使用JS开发一个开放的git库并使用npm进行构建时，您可以在docker文件中设置少至5行的应用程序。获取一个节点基础映像，克隆您的repo，安装模块，并运行开发服务器。例如，我上传了一个包含用vue cli创建的锅炉板应用程序的存储库。</p><figure class="mn mo mp mq gt is"><div class="bz fp l di"><div class="mr ms l"/></div></figure><p id="2e42" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">但是，npm development server不应在生产中使用，并且映像也将非常大，对于上面的示例超过1 GB，因为安装了所有开发依赖项。因此，我们可以使用一个高效的web服务器(apache，nginx)作为基础映像，安装构建应用程序所需的一切，构建应用程序，然后删除我们安装的一切。但这不会让图像立即变小，因为docker会为每个执行的命令创建一个层，并默认保留所有层。您可以手动删除层，但这很复杂，可能会导致问题。(如果你想了解更多信息，请点击查看<a class="ae jd" href="https://medium.com/@jessgreb01/digging-into-docker-layers-c22f948ed612" rel="noopener">。)</a></p><h2 id="6136" class="lp lq jg bd lr ls lt dn lu lv lw dp lx ko ly lz ma ks mb mc md kw me mf mg mh bi translated">在设置精益web服务器之前，使用构建器映像构建应用程序</h2><p id="862f" class="pw-post-body-paragraph kd ke jg kf b kg mi ki kj kk mj km kn ko mk kq kr ks ml ku kv kw mm ky kz la ij bi translated">截至今天(2019年6月)，正确的做法是使用多阶段构建。我们首先构建一个用作构建器的映像，在其中安装我们需要的所有依赖项并构建最终的应用程序，然后在第二阶段创建生产性web服务器映像并从构建器中复制我们需要的文件。</p><figure class="mn mo mp mq gt is"><div class="bz fp l di"><div class="mr ms l"/></div></figure><p id="0d0d" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们首先创建了一个几乎和以前一样的映像，并将其命名为<em class="mt"> builder </em>，但是我们最终没有执行运行命令，而是构建了我们应用程序的生产版本。<code class="fe mu mv mw mx b">&amp;&amp;</code>连接命令，因此它们被一个接一个地执行，并且只创建一个层。这不是必须的，但是我更喜欢分组命令来创建尽可能少的层。</p><p id="9ecf" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">然后，我们基于nginx创建第二个映像，并将构建的应用程序从构建器复制到我们的web服务器映像。生成的图像有漂亮的110 MB，只有应用程序，没有构建过程的痕迹。(对于apache，使用httpd作为基本映像，并用<code class="fe mu mv mw mx b">/usr/local/apache2/htdocs/</code>替换目标目录)。</p><p id="53e0" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">现在，我们可以发布容器，下载该图像的用户将只能获得高效的应用程序和基本的web服务器。接下来是克隆私有存储库(这里是github)的重要部分。</p><h2 id="d71a" class="lp lq jg bd lr ls lt dn lu lv lw dp lx ko ly lz ma ks mb mc md kw me mf mg mh bi translated">将ssh密钥导入构建器以克隆私有存储库</h2><p id="5718" class="pw-post-body-paragraph kd ke jg kf b kg mi ki kj kk mj km kn ko mk kq kr ks ml ku kv kw mm ky kz la ij bi translated">当你想发布一个来自私有存储库的应用程序的图像时，你需要某种方式将凭证传递到docker构建过程，以允许git登录到你的存储库。直接且非常危险的方法是在克隆命令中使用用户名和密码。但是您永远不应该将凭证放在配置文件中，所以这不是一个选项。将凭证作为命令行参数传递给构建器也不是一个好主意，因为它要求总是传递凭证，并且密码可能存储在bash历史记录或其他日志中。首选解决方案是<em class="mt">部署键</em>。一组ssh公私密钥，专门用于对某些存储库的只读访问。您可以将这些密钥复制到构建器中，向ssh代理注册它们，然后克隆存储库。由于构建器图像在该过程之后被删除，所以最终图像不包含任何键的痕迹。</p><p id="e1ce" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">首先，您需要创建一个ssh密钥对，一个用于github的公钥和一个用于docker文件的私钥。在linux上，只需运行<code class="fe mu mv mw mx b">ssh-keygen -t rsa -f github_key</code>来生成一个RSA密钥对。确保不使用密码短语。然后复制docker文件旁边的<code class="fe mu mv mw mx b">github_key</code>和<code class="fe mu mv mw mx b">github_key.pub</code>文件(为了方便)。在Windows上，PuTTY/ <a class="ae jd" href="https://www.9bis.net/kitty/?page=Command-line%20options&amp;zone=en" rel="noopener ugc nofollow" target="_blank"> KiTTY </a>可以生成密钥对，确保以OpenSSH格式导出私钥。</p><figure class="mn mo mp mq gt is gh gi paragraph-image"><div class="gh gi my"><img src="../Images/60e449b383b074fb698f177a44fa7f1e.png" data-original-src="https://miro.medium.com/v2/resize:fit:954/format:webp/1*jSqsND2c9EZeMsFE2z_HSQ.png"/></div></figure><p id="acff" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">接下来，您必须登录github，导航到您的存储库，选择设置，然后部署密钥，然后添加密钥。</p><figure class="mn mo mp mq gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi mz"><img src="../Images/1791321578e2b20000ca7b8d54438876.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*tCnL6BFsET_PMp2yveduAg.png"/></div></div></figure><p id="e1eb" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在那里，您可以上传您的<em class="mt">公共</em>密钥<code class="fe mu mv mw mx b">github_key.pub</code>的内容并保存更改。</p><p id="9d2a" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">现在我们只需将github_key复制到构建器映像中，启动ssh-agent(第4行)，将密钥添加到代理中(第5行)，从github.com导入公钥(第6行)，最后使用ssh而不是https克隆映像。</p><figure class="mn mo mp mq gt is"><div class="bz fp l di"><div class="mr ms l"/></div></figure><p id="ce13" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">就是这样。适用于任何类型的项目，也应该适用于其他git主机，只要它们支持ssh登录。</p><p id="412b" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">docker文件的存储库可以在这里找到:<a class="ae jd" href="https://github.com/phillies/vue_example" rel="noopener ugc nofollow" target="_blank">https://github.com/phillies/vue_example</a></p><p id="3301" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">玩得开心！</p></div></div>    
</body>
</html>