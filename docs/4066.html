<html>
<head>
<title>Customized Resources Auto-Tagging in AWS</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">AWS中的定制资源自动标记</h1>
<blockquote>原文：<a href="https://itnext.io/customized-resources-auto-tagging-in-aws-e3413375ceb4?source=collection_archive---------4-----------------------#2020-04-20">https://itnext.io/customized-resources-auto-tagging-in-aws-e3413375ceb4?source=collection_archive---------4-----------------------#2020-04-20</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><h1 id="2142" class="jn jo iq bd jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk bi translated">背景</h1><blockquote class="kl km kn"><p id="c58d" class="ko kp kq kr b ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">作为一名DevOps顾问，我经常发现自己收到大量&amp;各种各样的客户请求，由于客户的特殊情况、目标和限制，其中一些请求非常复杂。<br/>偶尔星星在排列，你发现自己处于这种“独角兽”的境地，最好形容为:<br/><strong class="kr ir"><em class="iq">乍一看很简单，但顺着路走就复杂了</em></strong><em class="iq"/></p></blockquote><h1 id="dae6" class="jn jo iq bd jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk bi translated">场景</h1><p id="2261" class="pw-post-body-paragraph ko kp iq kr b ks ln ku kv kw lo ky kz lp lq lc ld lr ls lg lh lt lu lk ll lm ij bi translated">我的一个客户，一家领先的全球网络安全公司(名称保密)请求我帮助解决一个与AWS相关的问题。</p><p id="f5b8" class="pw-post-body-paragraph ko kp iq kr b ks kt ku kv kw kx ky kz lp lb lc ld lr lf lg lh lt lj lk ll lm ij bi translated">“我希望在创建资源时，每个EC2实例和卷都标记上供应器的身份。(例如-Tag-name:<strong class="kr ir"><em class="kq">Owner</em></strong>Tag-Value:<strong class="kr ir"><em class="kq">GOB bluth</em></strong>)"</p><p id="2433" class="pw-post-body-paragraph ko kp iq kr b ks kt ku kv kw kx ky kz lp lb lc ld lr lf lg lh lt lj lk ll lm ij bi translated">“小菜一碟！”我心想，我以前在这方面做过类似的事情，不会有任何问题。</p><figure class="lw lx ly lz gt ma gh gi paragraph-image"><div role="button" tabindex="0" class="mb mc di md bf me"><div class="gh gi lv"><img src="../Images/226ef1b2c9feec3388063e43d8cdf31b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*5gD7ZE5CED1jfx99.png"/></div></div><figcaption class="mh mi gj gh gi mj mk bd b be z dk translated">预配EC2实例后的期望状态</figcaption></figure><h1 id="7efa" class="jn jo iq bd jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk bi translated">问题是</h1><p id="3feb" class="pw-post-body-paragraph ko kp iq kr b ks ln ku kv kw lo ky kz lp lq lc ld lr ls lg lh lt lu lk ll lm ij bi translated">尽管AWS提供了各种“自动标记”和“标记实施”的方法，但仍然没有针对自动动态标记情况的完整解决方案，这可以通过一个简单的AWS服务来解决(截至2020年3月)。</p><h1 id="138e" class="jn jo iq bd jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk bi translated">解决问题的途径</h1><p id="5fdb" class="pw-post-body-paragraph ko kp iq kr b ks ln ku kv kw lo ky kz lp lq lc ld lr ls lg lh lt lu lk ll lm ij bi translated">在寻找可能的解决方案时，通过调查各种AWS服务，我没有发现任何一种服务对我的场景足够合适和准确。</p><p id="6c7d" class="pw-post-body-paragraph ko kp iq kr b ks kt ku kv kw kx ky kz lp lb lc ld lr lf lg lh lt lj lk ll lm ij bi translated">咨询我的同事，甚至AWS的高级技术专家，我既找不到这个难题的精确解决方案，也找不到一个全面的解决方案。</p><p id="ea84" class="pw-post-body-paragraph ko kp iq kr b ks kt ku kv kw kx ky kz lp lb lc ld lr lf lg lh lt lj lk ll lm ij bi translated">在对潜在解决方案进行大量研究后，我得出结论，最好的方法是通过将多个服务组合成一个全面的解决方案来扩展AWS功能。因此，满足了我的客户需求。</p><p id="c6bd" class="pw-post-body-paragraph ko kp iq kr b ks kt ku kv kw kx ky kz lp lb lc ld lr lf lg lh lt lj lk ll lm ij bi translated">在介绍该解决方案之前，我想与您分享一些有趣且有价值的资源，这些资源是我在寻找更多<strong class="kr ir">标准</strong>标记策略的过程中遇到的:</p><p id="d73a" class="pw-post-body-paragraph ko kp iq kr b ks kt ku kv kw kx ky kz lp lb lc ld lr lf lg lh lt lj lk ll lm ij bi translated"><em class="kq"> AWS组织:-</em><a class="ae ml" href="https://docs.aws.amazon.com/organizations/latest/userguide/orgs_manage_policies_tag-policies-effective.html" rel="noopener ugc nofollow" target="_blank"><em class="kq">https://docs . AWS . Amazon . com/organizations/latest/user guide/orgs _ manage _ policies _ tag-policies-effective . html</em></a></p><p id="9764" class="pw-post-body-paragraph ko kp iq kr b ks kt ku kv kw kx ky kz lp lb lc ld lr lf lg lh lt lj lk ll lm ij bi translated"><em class="kq">Via IAM policy-</em><a class="ae ml" href="https://stackoverflow.com/questions/48426761/aws-iam-policy-to-enforce-tagging" rel="noopener ugc nofollow" target="_blank"><em class="kq">https://stack overflow . com/questions/48426761/AWS-IAM-policy-to-enforce-tagging</em></a></p><p id="165a" class="pw-post-body-paragraph ko kp iq kr b ks kt ku kv kw kx ky kz lp lb lc ld lr lf lg lh lt lj lk ll lm ij bi translated"><em class="kq"> AWS配置:-</em><a class="ae ml" href="https://docs.aws.amazon.com/config/latest/developerguide/tagging.html" rel="noopener ugc nofollow" target="_blank"><em class="kq">https://docs . AWS . Amazon . com/config/latest/developer guide/tagging . html</em></a></p><h1 id="562a" class="jn jo iq bd jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk bi translated">解决方案</h1><p id="bc9c" class="pw-post-body-paragraph ko kp iq kr b ks ln ku kv kw lo ky kz lp lq lc ld lr ls lg lh lt lu lk ll lm ij bi translated">首先，解决方案的部署本身并不复杂，我们将在本文后面看到。复杂的部分是调查所有可用的服务，并理解如何将它们组合在一起，形成一个功能性的、简单的、成本有效的、可审计的和持久的机制。</p><p id="f2ca" class="pw-post-body-paragraph ko kp iq kr b ks kt ku kv kw kx ky kz lp lb lc ld lr lf lg lh lt lj lk ll lm ij bi translated">该机制由三个AWS服务组成:</p><blockquote class="kl km kn"><p id="4f01" class="ko kp kq kr b ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated"><em class="iq"> AWS云迹</em></p><p id="c870" class="ko kp kq kr b ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated"><em class="iq"> AWS云手表</em></p><p id="1b26" class="ko kp kq kr b ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated"><em class="iq"> AWS Lambda </em></p></blockquote><p id="a9c4" class="pw-post-body-paragraph ko kp iq kr b ks kt ku kv kw kx ky kz lp lb lc ld lr lf lg lh lt lj lk ll lm ij bi translated">解决方案流程图描述如下:</p><figure class="lw lx ly lz gt ma gh gi paragraph-image"><div role="button" tabindex="0" class="mb mc di md bf me"><div class="gh gi mm"><img src="../Images/eaaf9e0f383c6aa6dc132470131a83b4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*hFZr7ZcrQ8C_5y-k.png"/></div></div><figcaption class="mh mi gj gh gi mj mk bd b be z dk translated">解决方案流程图</figcaption></figure></div><div class="ab cl mn mo hu mp" role="separator"><span class="mq bw bk mr ms mt"/><span class="mq bw bk mr ms mt"/><span class="mq bw bk mr ms"/></div><div class="ij ik il im in"><h1 id="b335" class="jn jo iq bd jp jq mu js jt ju mv jw jx jy mw ka kb kc mx ke kf kg my ki kj kk bi translated">技术解决方案逐步程序</h1><p id="61ac" class="pw-post-body-paragraph ko kp iq kr b ks ln ku kv kw lo ky kz lp lq lc ld lr ls lg lh lt lu lk ll lm ij bi translated">在接下来的部分中，我将一步一步地引导您如何启动并运行这个机制。</p><h1 id="53e9" class="jn jo iq bd jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk bi translated">云迹</h1><blockquote class="kl km kn"><p id="1b0e" class="ko kp kq kr b ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated"><strong class="kr ir"> <em class="iq">定义</em> </strong> <em class="iq"> - AWS CloudTrail是一项服务，可对您的AWS帐户进行治理、合规、运营审计和风险审计。使用CloudTrail，您可以记录、持续监控和保留与您的AWS基础架构中的操作相关的帐户活动。CloudTrail提供您的AWS帐户活动的事件历史，包括通过AWS管理控制台、AWS SDKs、命令行工具和其他AWS服务采取的操作。</em></p></blockquote><p id="16e3" class="pw-post-body-paragraph ko kp iq kr b ks kt ku kv kw kx ky kz lp lb lc ld lr lf lg lh lt lj lk ll lm ij bi translated">1.转到“<strong class="kr ir">云轨迹</strong>”服务，选择“<strong class="kr ir">轨迹</strong>”部分，然后按“<strong class="kr ir">创建轨迹</strong>”按钮。</p><p id="d283" class="pw-post-body-paragraph ko kp iq kr b ks kt ku kv kw kx ky kz lp lb lc ld lr lf lg lh lt lj lk ll lm ij bi translated">2.除了这些属性之外，将所有内容保留为默认值:</p><p id="51d8" class="pw-post-body-paragraph ko kp iq kr b ks kt ku kv kw kx ky kz lp lb lc ld lr lf lg lh lt lj lk ll lm ij bi translated"><strong class="kr ir">将轨迹应用于所有区域</strong> —如果您只想要一个区域的轨迹，选择“否”</p><p id="465f" class="pw-post-body-paragraph ko kp iq kr b ks kt ku kv kw kx ky kz lp lb lc ld lr lf lg lh lt lj lk ll lm ij bi translated"><strong class="kr ir">S3·比提</strong> —选择一个能够代表贵公司命名惯例的名称</p><p id="f082" class="pw-post-body-paragraph ko kp iq kr b ks kt ku kv kw kx ky kz lp lb lc ld lr lf lg lh lt lj lk ll lm ij bi translated">3.点击<strong class="kr ir">创建</strong>按钮。</p><figure class="lw lx ly lz gt ma"><div class="bz fp l di"><div class="mz na l"/></div><figcaption class="mh mi gj gh gi mj mk bd b be z dk translated">在CloudTrail上创建踪迹</figcaption></figure><h1 id="b8f3" class="jn jo iq bd jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk bi translated">希腊字母的第11个</h1><blockquote class="kl km kn"><p id="5bab" class="ko kp kq kr b ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated"><strong class="kr ir"> <em class="iq">定义</em></strong><em class="iq">——AWS Lambda是一种计算服务，让你不用配置或管理服务器就能运行代码。AWS Lambda仅在需要时执行您的代码，并自动伸缩，从每天几个请求到每秒几千个请求。您只需为您消耗的计算时间付费，当您的代码不运行时，则不收费。有了AWS Lambda，您几乎可以为任何类型的应用程序或后端服务运行代码——所有这些都无需管理。</em></p></blockquote><p id="8dc6" class="pw-post-body-paragraph ko kp iq kr b ks kt ku kv kw kx ky kz lp lb lc ld lr lf lg lh lt lj lk ll lm ij bi translated">1.转到“<strong class="kr ir">功能</strong>下的“<strong class="kr ir">λ</strong>维修”，按下“<strong class="kr ir">创建功能</strong></p><p id="a1cb" class="pw-post-body-paragraph ko kp iq kr b ks kt ku kv kw kx ky kz lp lb lc ld lr lf lg lh lt lj lk ll lm ij bi translated">2.除了这些属性之外，将所有内容保留为默认值:</p><p id="d996" class="pw-post-body-paragraph ko kp iq kr b ks kt ku kv kw kx ky kz lp lb lc ld lr lf lg lh lt lj lk ll lm ij bi translated"><strong class="kr ir">功能名称</strong> —选择一个代表您组织命名惯例的名称</p><p id="06fc" class="pw-post-body-paragraph ko kp iq kr b ks kt ku kv kw kx ky kz lp lb lc ld lr lf lg lh lt lj lk ll lm ij bi translated"><strong class="kr ir">运行时</strong> — Python 3.6</p><p id="1dd8" class="pw-post-body-paragraph ko kp iq kr b ks kt ku kv kw kx ky kz lp lb lc ld lr lf lg lh lt lj lk ll lm ij bi translated">3.在<strong class="kr ir">功能代码</strong>部分粘贴以下<a class="ae ml" href="https://github.com/ormam/metirials/blob/master/Auto_tagging_lambda_function" rel="noopener ugc nofollow" target="_blank">代码</a></p><figure class="lw lx ly lz gt ma"><div class="bz fp l di"><div class="nb na l"/></div></figure><p id="b26e" class="pw-post-body-paragraph ko kp iq kr b ks kt ku kv kw kx ky kz lp lb lc ld lr lf lg lh lt lj lk ll lm ij bi translated">4.按下<strong class="kr ir">保存</strong>按钮</p><p id="a1b6" class="pw-post-body-paragraph ko kp iq kr b ks kt ku kv kw kx ky kz lp lb lc ld lr lf lg lh lt lj lk ll lm ij bi translated">Lambda函数需要有合适的权限来标记EC2资源，因此我们将为其预定义的角色授予合适的策略。</p><p id="4b52" class="pw-post-body-paragraph ko kp iq kr b ks kt ku kv kw kx ky kz lp lb lc ld lr lf lg lh lt lj lk ll lm ij bi translated">5.进入<strong class="kr ir"> IAM </strong>服务，点击<strong class="kr ir">角色</strong>。</p><p id="725e" class="pw-post-body-paragraph ko kp iq kr b ks kt ku kv kw kx ky kz lp lb lc ld lr lf lg lh lt lj lk ll lm ij bi translated">6.在“<strong class="kr ir">Roles”</strong>下，查找以下角色名称约定:<br/>“来自步骤‘2’的Lambda函数名称”<strong class="kr ir">-role-</strong>随机序列<strong class="kr ir"/></p><figure class="lw lx ly lz gt ma gh gi paragraph-image"><div role="button" tabindex="0" class="mb mc di md bf me"><div class="gh gi nc"><img src="../Images/61d5bf3946e47ec25252fd273abe764e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*qtbHjy_s9jqll-OE.png"/></div></div><figcaption class="mh mi gj gh gi mj mk bd b be z dk translated">角色名称的示例</figcaption></figure><p id="7732" class="pw-post-body-paragraph ko kp iq kr b ks kt ku kv kw kx ky kz lp lb lc ld lr lf lg lh lt lj lk ll lm ij bi translated">角色名称的示例</p><p id="3154" class="pw-post-body-paragraph ko kp iq kr b ks kt ku kv kw kx ky kz lp lb lc ld lr lf lg lh lt lj lk ll lm ij bi translated">7.点击<strong class="kr ir">角色</strong></p><p id="50c2" class="pw-post-body-paragraph ko kp iq kr b ks kt ku kv kw kx ky kz lp lb lc ld lr lf lg lh lt lj lk ll lm ij bi translated">8.点击“<strong class="kr ir">附加策略</strong></p><p id="83b9" class="pw-post-body-paragraph ko kp iq kr b ks kt ku kv kw kx ky kz lp lb lc ld lr lf lg lh lt lj lk ll lm ij bi translated">9.查找“<strong class="kr ir"> AmazonEC2FullAccess </strong>”并将其附加到角色。</p><figure class="lw lx ly lz gt ma"><div class="bz fp l di"><div class="mz na l"/></div><figcaption class="mh mi gj gh gi mj mk bd b be z dk translated">如何创建lambda函数并配置支持IAM的角色</figcaption></figure><h1 id="3289" class="jn jo iq bd jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk bi translated">云观察</h1><blockquote class="kl km kn"><p id="e452" class="ko kp kq kr b ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated"><strong class="kr ir"> <em class="iq">定义</em></strong><em class="iq">——cloud watch以日志、指标和事件的形式收集监控和运营数据，为您提供运行在AWS和本地服务器上的AWS资源、应用和服务的统一视图。</em></p></blockquote><p id="eb54" class="pw-post-body-paragraph ko kp iq kr b ks kt ku kv kw kx ky kz lp lb lc ld lr lf lg lh lt lj lk ll lm ij bi translated">1.进入"<strong class="kr ir">云手表</strong>服务，在"<strong class="kr ir">事件</strong>下点击"<strong class="kr ir">规则</strong>"并按下"<strong class="kr ir">创建规则</strong>按钮。</p><p id="fefc" class="pw-post-body-paragraph ko kp iq kr b ks kt ku kv kw kx ky kz lp lb lc ld lr lf lg lh lt lj lk ll lm ij bi translated">2.在“<strong class="kr ir">事件源</strong>”部分，将这些属性旁边的所有内容保留为默认值:</p><p id="9f30" class="pw-post-body-paragraph ko kp iq kr b ks kt ku kv kw kx ky kz lp lb lc ld lr lf lg lh lt lj lk ll lm ij bi translated"><strong class="kr ir">服务名</strong> — EC2</p><p id="84f8" class="pw-post-body-paragraph ko kp iq kr b ks kt ku kv kw kx ky kz lp lb lc ld lr lf lg lh lt lj lk ll lm ij bi translated"><strong class="kr ir">事件类型</strong> —通过云轨迹的AWS API调用</p><p id="693a" class="pw-post-body-paragraph ko kp iq kr b ks kt ku kv kw kx ky kz lp lb lc ld lr lf lg lh lt lj lk ll lm ij bi translated">在单选按钮部分选择:“<strong class="kr ir">特定操作”</strong>，并在自由文本框中输入“<strong class="kr ir">运行实例</strong></p><p id="3038" class="pw-post-body-paragraph ko kp iq kr b ks kt ku kv kw kx ky kz lp lb lc ld lr lf lg lh lt lj lk ll lm ij bi translated">3.在“<strong class="kr ir">目标</strong>”部分，将这些属性旁边的所有内容保留为默认值:</p><p id="1c50" class="pw-post-body-paragraph ko kp iq kr b ks kt ku kv kw kx ky kz lp lb lc ld lr lf lg lh lt lj lk ll lm ij bi translated">在第一个组合框中选择-"<strong class="kr ir">Lambda函数</strong>"</p><p id="5070" class="pw-post-body-paragraph ko kp iq kr b ks kt ku kv kw kx ky kz lp lb lc ld lr lf lg lh lt lj lk ll lm ij bi translated">在第二个组合框中选择Lambda函数的名称</p><p id="e09f" class="pw-post-body-paragraph ko kp iq kr b ks kt ku kv kw kx ky kz lp lb lc ld lr lf lg lh lt lj lk ll lm ij bi translated">4.点击<strong class="kr ir">配置详细信息</strong>按钮</p><p id="b4e6" class="pw-post-body-paragraph ko kp iq kr b ks kt ku kv kw kx ky kz lp lb lc ld lr lf lg lh lt lj lk ll lm ij bi translated">5.输入规则的名称</p><p id="9152" class="pw-post-body-paragraph ko kp iq kr b ks kt ku kv kw kx ky kz lp lb lc ld lr lf lg lh lt lj lk ll lm ij bi translated">6.点击<strong class="kr ir">创建规则</strong></p><figure class="lw lx ly lz gt ma"><div class="bz fp l di"><div class="mz na l"/></div><figcaption class="mh mi gj gh gi mj mk bd b be z dk translated">在CloudWatch上创建事件角色</figcaption></figure><h1 id="21c7" class="jn jo iq bd jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk bi translated">检查功能</h1><p id="d02e" class="pw-post-body-paragraph ko kp iq kr b ks ln ku kv kw lo ky kz lp lq lc ld lr ls lg lh lt lu lk ll lm ij bi translated">请提供EC2实例并检查标记是否存在。</p><figure class="lw lx ly lz gt ma"><div class="bz fp l di"><div class="mz na l"/></div><figcaption class="mh mi gj gh gi mj mk bd b be z dk translated">验证动态标记是否正常工作</figcaption></figure><h1 id="0fe6" class="jn jo iq bd jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk bi translated">结论</h1><p id="97cd" class="pw-post-body-paragraph ko kp iq kr b ks ln ku kv kw lo ky kz lp lq lc ld lr ls lg lh lt lu lk ll lm ij bi translated">太好了，你做到了！</p><p id="c3a2" class="pw-post-body-paragraph ko kp iq kr b ks kt ku kv kw kx ky kz lp lb lc ld lr lf lg lh lt lj lk ll lm ij bi translated">虽然AWS有很多很好的服务，旨在覆盖所有的技术场景和可能性，但仍然不可能预先预测任何情况。</p><p id="2949" class="pw-post-body-paragraph ko kp iq kr b ks kt ku kv kw kx ky kz lp lb lc ld lr lf lg lh lt lj lk ll lm ij bi translated">凭借技术创造力和开放的思维，我们可以填补这些空白，创造出伟大的解决方案。</p><p id="f3a0" class="pw-post-body-paragraph ko kp iq kr b ks kt ku kv kw kx ky kz lp lb lc ld lr lf lg lh lt lj lk ll lm ij bi translated">希望对你有帮助，</p><p id="e9ee" class="pw-post-body-paragraph ko kp iq kr b ks kt ku kv kw kx ky kz lp lb lc ld lr lf lg lh lt lj lk ll lm ij bi translated">或者妈妈</p><p id="694f" class="pw-post-body-paragraph ko kp iq kr b ks kt ku kv kw kx ky kz lp lb lc ld lr lf lg lh lt lj lk ll lm ij bi translated"><a class="ae ml" href="http://www.linkedin.com/in/ormaman" rel="noopener ugc nofollow" target="_blank">www.linkedin.com/in/ormaman</a></p></div></div>    
</body>
</html>