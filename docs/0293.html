<html>
<head>
<title>Writing acceptance tests for Phoenix with Hound</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">为Phoenix with Hound编写验收测试</h1>
<blockquote>原文：<a href="https://itnext.io/writing-acceptance-tests-for-phoenix-with-hound-part-1-555d928ae9ee?source=collection_archive---------2-----------------------#2018-02-10">https://itnext.io/writing-acceptance-tests-for-phoenix-with-hound-part-1-555d928ae9ee?source=collection_archive---------2-----------------------#2018-02-10</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/b66692ffc3305d6f4aeb78d45ac1e6ff.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*WCzTNVOSBQ0pq4LaZY9eJQ.jpeg"/></div></div></figure><p id="54aa" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在本文中，我将使用Hound对Phoenix framework进行端到端的验收测试。我将使用的运行测试的例子来自Chris McCord的书——编程凤凰——高效| &gt;可靠| &gt;快速。我已经从书上写了<strong class="ka ir"> rumbl </strong>项目，并对其进行了相应的转换以支持Phoenix 1.3。完整的项目代码和测试可以在我的github <a class="ae kw" href="https://github.com/imeraj/Phoenix_rumbl" rel="noopener ugc nofollow" target="_blank">这里</a>找到。</p><p id="065a" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我已经用Safari和Chrome浏览器测试了测试用例。对于Safari浏览器，需要进行一些额外的设置，如下面的<strong class="ka ir">先决条件</strong>部分所述。</p><p id="f740" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">它应该是直接运行项目，除非你需要配置Mysql数据库正确。</p><pre class="kx ky kz la gt lb lc ld le aw lf bi"><span id="e17c" class="lg lh iq lc b gy li lj l lk ll">config :rumbl, Rumbl.Repo,<br/>  adapter: Ecto.Adapters.MySQL,<br/>  username: "root",<br/>  password: "root",<br/>  database: "rumbl_dev",<br/>  hostname: "localhost",<br/>  pool_size: 10</span></pre><p id="b3fd" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">如果您使用其他用户名/密码，请在config/dev.exs文件中相应更新。</p><p id="8f0b" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">config/test.exs也是如此。</p><h1 id="edea" class="lm lh iq bd ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi bi translated"><strong class="ak">什么是猎犬</strong></h1><p id="bb95" class="pw-post-body-paragraph jy jz iq ka b kb mj kd ke kf mk kh ki kj ml kl km kn mm kp kq kr mn kt ku kv ij bi translated">正如github页面上提到的，Hound是一个为Elixir/Phoenix编写端到端自动化测试的库。同一页中提到的一些主要特征是—</p><ul class=""><li id="4626" class="mo mp iq ka b kb kc kf kg kj mq kn mr kr ms kv mt mu mv mw bi translated">可以同时运行多个浏览器会话。</li><li id="afd6" class="mo mp iq ka b kb mx kf my kj mz kn na kr nb kv mt mu mv mw bi translated">支持Selenium (Firefox，Chrome)，ChromeDriver和PhantomJs。</li><li id="1541" class="mo mp iq ka b kb mx kf my kj mz kn na kr nb kv mt mu mv mw bi translated">支持大量使用Javascript的应用。在报告错误之前重试几次。</li><li id="f115" class="mo mp iq ka b kb mx kf my kj mz kn na kr nb kv mt mu mv mw bi translated">实现WebDriver Wire协议。</li></ul><p id="167e" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">你可以在这里找到库的API参考—<a class="ae kw" href="https://hexdocs.pm/hound/readme.html" rel="noopener ugc nofollow" target="_blank">https://hexdocs.pm/hound/readme.html</a></p><h1 id="99e2" class="lm lh iq bd ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi bi translated"><strong class="ak">前提条件</strong></h1><ol class=""><li id="5691" class="mo mp iq ka b kb mj kf mk kj nc kn nd kr ne kv nf mu mv mw bi translated"><strong class="ka ir">网络驱动</strong></li></ol><p id="5480" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">为了让浏览器自动化测试正常运行，有必要安装并正常运行一个webdriver服务器。如果您不熟悉什么是webdriver服务器或如何运行它，请查看互联网上的各种资源。如需快速入门，请点击此处的<a class="ae kw" href="https://github.com/HashNuke/hound/wiki/Starting-a-webdriver-server" rel="noopener ugc nofollow" target="_blank">链接</a>。深入研究webdriver如何工作超出了本文的范围。</p><p id="81ab" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在mac平台上，你可以很容易地用自制软件安装selenium webdriver</p><pre class="kx ky kz la gt lb lc ld le aw lf bi"><span id="965e" class="lg lh iq lc b gy li lj l lk ll"># brew install selenium-server-standalone</span></pre><p id="25e5" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">安装后，在终端中运行命令—</p><pre class="kx ky kz la gt lb lc ld le aw lf bi"><span id="aa29" class="lg lh iq lc b gy li lj l lk ll"># selenium-server</span></pre><p id="bcfe" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">如果您的服务器启动时没有任何错误，您应该会看到下面的输出消息—</p><pre class="kx ky kz la gt lb lc ld le aw lf bi"><span id="5799" class="lg lh iq lc b gy li lj l lk ll">2018-02-10 22:45:39.241:INFO:osjs.Server:main: Started @668ms</span><span id="68f3" class="lg lh iq lc b gy ng lj l lk ll">22:45:39.241 INFO - Selenium Server is up and running</span></pre><p id="85ae" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">2.对于Safari，从<strong class="ka ir">开发</strong>菜单中启用“允许远程自动化”。</p><h1 id="ef85" class="lm lh iq bd ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi bi translated"><strong class="ak">猎犬设置</strong></h1><p id="cbd0" class="pw-post-body-paragraph jy jz iq ka b kb mj kd ke kf mk kh ki kj ml kl km kn mm kp kq kr mn kt ku kv ij bi translated">一旦你的先决条件得到解决，是时候设置猎犬了，包括以下步骤</p><ol class=""><li id="c5c5" class="mo mp iq ka b kb kc kf kg kj mq kn mr kr ms kv nf mu mv mw bi translated">将依赖性添加到您的Phoenix项目中——</li></ol><pre class="kx ky kz la gt lb lc ld le aw lf bi"><span id="2be3" class="lg lh iq lc b gy li lj l lk ll">{:hound, "~&gt; 1.0"}</span></pre><p id="95ad" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">2.在test/test_helper.exs文件中的ExUnit.start()行之前启动Hound:</p><pre class="kx ky kz la gt lb lc ld le aw lf bi"><span id="b421" class="lg lh iq lc b gy li lj l lk ll">{:ok, _} = Application.ensure_all_started(:hound)<br/>ExUnit.start()</span></pre><p id="c6de" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">3.在config/test.exs中，将端点的服务器选项更改为<strong class="ka ir"> true </strong>:</p><pre class="kx ky kz la gt lb lc ld le aw lf bi"><span id="2524" class="lg lh iq lc b gy li lj l lk ll">config :rumbl, RumblWeb.Endpoint,<br/>  http: [port: 4001],<br/>  server: <strong class="lc ir">true</strong></span></pre><h1 id="e6fb" class="lm lh iq bd ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi bi translated"><strong class="ak">猎犬配置</strong></h1><p id="9fe6" class="pw-post-body-paragraph jy jz iq ka b kb mj kd ke kf mk kh ki kj ml kl km kn mm kp kq kr mn kt ku kv ij bi translated">要配置hound，请将下面一行放在config/config.exs中—</p><pre class="kx ky kz la gt lb lc ld le aw lf bi"><span id="6f0e" class="lg lh iq lc b gy li lj l lk ll">config :hound, browser: "safari"</span></pre><p id="6d4c" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">如果你更喜欢用“chrome”来代替，用上面的“Chrome”来代替“safari”。更多选项，请点击查看<a class="ae kw" href="https://github.com/HashNuke/hound/blob/master/notes/configuring-hound.md" rel="noopener ugc nofollow" target="_blank">。</a></p><h1 id="6e0a" class="lm lh iq bd ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi bi translated"><strong class="ak">运行测试</strong></h1><p id="91ea" class="pw-post-body-paragraph jy jz iq ka b kb mj kd ke kf mk kh ki kj ml kl km kn mm kp kq kr mn kt ku kv ij bi translated">一旦设置和配置完成，selenium-server运行，您应该能够使用下载的<strong class="ka ir"> rumbl </strong>项目文件夹中的以下命令运行测试</p><pre class="kx ky kz la gt lb lc ld le aw lf bi"><span id="def6" class="lg lh iq lc b gy li lj l lk ll"># mix test test/rumbl_web/acceptance/hound_test.ex</span></pre><p id="2346" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">如果一切顺利，你应该看到类似下面的视频，所有的测试都应该通过。</p><figure class="kx ky kz la gt jr"><div class="bz fp l di"><div class="nh ni l"/></div><figcaption class="nj nk gj gh gi nl nm bd b be z dk translated">用猎犬进行测试</figcaption></figure><pre class="kx ky kz la gt lb lc ld le aw lf bi"><span id="0488" class="lg lh iq lc b gy li lj l lk ll">Finished in 8.2 seconds</span><span id="a2f1" class="lg lh iq lc b gy ng lj l lk ll">3 tests, 0 failures</span></pre><h1 id="dcb2" class="lm lh iq bd ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi bi translated"><strong class="ak">测试用例解释</strong></h1><p id="6bf7" class="pw-post-body-paragraph jy jz iq ka b kb mj kd ke kf mk kh ki kj ml kl km kn mm kp kq kr mn kt ku kv ij bi translated">有三个简单的测试用例都写在test/rumbl _ web/acceptance/hound _ test . ex文件中。在这一节中，我将回顾测试用例并提供一些解释。</p><h1 id="3635" class="lm lh iq bd ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi bi translated"><strong class="ak">测试1:主页加载成功</strong></h1><p id="9870" class="pw-post-body-paragraph jy jz iq ka b kb mj kd ke kf mk kh ki kj ml kl km kn mm kp kq kr mn kt ku kv ij bi translated">检查主页是否加载成功。</p><pre class="kx ky kz la gt lb lc ld le aw lf bi"><span id="3ac0" class="lg lh iq lc b gy li lj l lk ll">test "homepage loads successfully", _meta <strong class="lc ir">do<br/>  </strong>navigate_to(@page_url)<br/>  assert page_title() == "Hello Rumbl!"<br/><strong class="lc ir">end</strong></span></pre><p id="24ff" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">naviage_to将导航到@page_url —</p><pre class="kx ky kz la gt lb lc ld le aw lf bi"><span id="f6fe" class="lg lh iq lc b gy li lj l lk ll">@page_url page_url(RumblWeb.Endpoint, :index)</span></pre><p id="dfb5" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">这转化为主页。</p><p id="d430" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">断言是检查页面标题是否与预期的标题匹配——“Hello Rumbl！”。</p><h1 id="68bc" class="lm lh iq bd ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi bi translated">测试2:注册成功</h1><p id="9ec4" class="pw-post-body-paragraph jy jz iq ka b kb mj kd ke kf mk kh ki kj ml kl km kn mm kp kq kr mn kt ku kv ij bi translated">该测试将检查使用名称、用户名和密码作为注册字段的用户注册是否成功。</p><pre class="kx ky kz la gt lb lc ld le aw lf bi"><span id="da04" class="lg lh iq lc b gy li lj l lk ll">test "successfull registration", _meta <strong class="lc ir">do<br/>  </strong>navigate_to(@page_url)<br/><br/>  element = find_element(:link_text, "Register")<br/>  element |&gt; click()<br/><br/>  name = find_element(:xpath, ~s|//*[@id="user_name"]|)<br/>  name |&gt; fill_field("Meraj")<br/><br/>  username = find_element(:xpath, ~s|//*[@id="user_username"]|)<br/>  username |&gt; fill_field("meraj")<br/><br/>  password = find_element(:xpath, ~s|//*[@id="user_password"]|)<br/>  password |&gt; fill_field("password")<br/><br/>  submit = find_element(:xpath, ~s|/html/body/div/main/form/div[4]/button|)<br/>  submit |&gt; click()<br/><br/>  assert current_url() == @user_url<br/>  assert page_source() =~ "Listing Users"<br/>  assert page_source() =~ "meraj"<br/><strong class="lc ir">end</strong></span></pre><p id="7d28" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">这里—</p><ul class=""><li id="575f" class="mo mp iq ka b kb kc kf kg kj mq kn mr kr ms kv mt mu mv mw bi translated">find_element(:link_text，" Register ")在主页上找到<strong class="ka ir">注册</strong>链接并点击它。这将加载<strong class="ka ir">注册</strong>表单。</li><li id="f414" class="mo mp iq ka b kb mx kf my kj mz kn na kr nb kv mt mu mv mw bi translated">接下来，我使用三个xpath字段来检索名称、用户名和密码字段，并用适当的输入值填充。</li><li id="8935" class="mo mp iq ka b kb mx kf my kj mz kn na kr nb kv mt mu mv mw bi translated">接下来，我使用xpath找到submit按钮并点击它</li><li id="1ed6" class="mo mp iq ka b kb mx kf my kj mz kn na kr nb kv mt mu mv mw bi translated">这将把我们带到@user_url页面，其中列出了所有用户(成功登录后显示相同的页面)。</li><li id="8720" class="mo mp iq ka b kb mx kf my kj mz kn na kr nb kv mt mu mv mw bi translated">接下来，一些断言检查注册用户是否在用户列表中</li></ul><h1 id="8781" class="lm lh iq bd ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi bi translated">测试3:登录成功</h1><p id="6588" class="pw-post-body-paragraph jy jz iq ka b kb mj kd ke kf mk kh ki kj ml kl km kn mm kp kq kr mn kt ku kv ij bi translated">最后一个测试是检查注册用户是否可以成功登录。</p><pre class="kx ky kz la gt lb lc ld le aw lf bi"><span id="893b" class="lg lh iq lc b gy li lj l lk ll">test "successful login", _meta <strong class="lc ir">do<br/> </strong>user = insert_user()<br/> navigate_to(@page_url)<br/><br/> element = find_element(:link_text, "Log In")<br/> element |&gt; click()<br/><br/> username = find_element(:xpath, ~s|//*[@id="session_username"]|)<br/> username |&gt; fill_field(user.name)<br/><br/> password = find_element(:xpath, ~s|//*[@id="session_password"]|)<br/> password |&gt; fill_field(user.password)<br/><br/> submit = find_element(:xpath, ~s|/html/body/div/main/form/button|)<br/> submit |&gt; click()<br/><br/> assert current_url() == @user_url<br/> assert page_source() =~ "Listing Users"<br/> assert page_source() =~ "meraj"<br/><strong class="lc ir">end</strong></span></pre><p id="23a5" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在这个阶段，它应该是非常简单明了的。这里-</p><ul class=""><li id="c199" class="mo mp iq ka b kb kc kf kg kj mq kn mr kr ms kv mt mu mv mw bi translated">使用insert_user()插入一个用户。这方面的代码可以在<strong class="ka ir">test/support/test _ helpers . ex</strong>中找到。</li><li id="094d" class="mo mp iq ka b kb mx kf my kj mz kn na kr nb kv mt mu mv mw bi translated">然后，用户名和密码用于测试成功登录。</li></ul><h1 id="b9cc" class="lm lh iq bd ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi bi translated"><strong class="ak">一些观察</strong></h1><p id="fb7e" class="pw-post-body-paragraph jy jz iq ka b kb mj kd ke kf mk kh ki kj ml kl km kn mm kp kq kr mn kt ku kv ij bi translated">对于运行并发浏览器测试，我得到了以下错误</p><pre class="kx ky kz la gt lb lc ld le aw lf bi"><span id="7c7d" class="lg lh iq lc b gy li lj l lk ll">** (DBConnection.OwnershipError) cannot find ownership process for #PID&lt;0.475.0&gt;</span></pre><p id="c788" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">快速搜索把我带到了这个页面。</p><p id="d737" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">要解决这个问题，请按照以下步骤操作—</p><ul class=""><li id="1bc0" class="mo mp iq ka b kb kc kf kg kj mq kn mr kr ms kv mt mu mv mw bi translated">在config/config.exs或config/test.exs中设置一个标志以启用沙盒</li></ul><pre class="kx ky kz la gt lb lc ld le aw lf bi"><span id="f02b" class="lg lh iq lc b gy li lj l lk ll">config :rumbl, sql_sandbox: <strong class="lc ir">true</strong></span></pre><ul class=""><li id="2f25" class="mo mp iq ka b kb kc kf kg kj mq kn mr kr ms kv mt mu mv mw bi translated">使用标志有条件地将插件添加到lib/rumbl_web/endpoint.ex中的<strong class="ka ir">插件(RumblWeb)之前。【T21路由器】。</strong></li></ul><pre class="kx ky kz la gt lb lc ld le aw lf bi"><span id="aadc" class="lg lh iq lc b gy li lj l lk ll">if Application.get_env(:your_app, :sql_sandbox) do<br/>  plug Phoenix.Ecto.SQL.Sandbox<br/>end</span></pre><ul class=""><li id="5578" class="mo mp iq ka b kb kc kf kg kj mq kn mr kr ms kv mt mu mv mw bi translated">将以下内容添加到测试用例或用例模板中</li></ul><pre class="kx ky kz la gt lb lc ld le aw lf bi"><span id="142d" class="lg lh iq lc b gy li lj l lk ll">setup do  <br/>  :ok = Ecto.Adapters.SQL.Sandbox.checkout(YourApp.Repo)<br/>  metadata = Phoenix.Ecto.SQL.Sandbox.metadata_for(YourApp.Repo, self())<br/>  Hound.start_session(metadata: metadata)<br/>  :ok<br/>end</span></pre><p id="f1ad" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我希望这篇文章能帮助一些人使用Hound for Phoenix平台编写验收测试(端到端自动化测试)。</p><p id="fe8e" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><em class="nn">更多详细和深入的未来技术帖子请关注我这里或点击</em> <a class="ae kw" href="https://twitter.com/meraj_enigma" rel="noopener ugc nofollow" target="_blank"> <em class="nn"> twitter </em> </a> <em class="nn">。</em></p><h1 id="3f40" class="lm lh iq bd ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi bi translated">高效| &gt;可靠| &gt;快速</h1></div></div>    
</body>
</html>