<html>
<head>
<title>Third-Party Cookies &amp; Authentication</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">第三方Cookies和认证</h1>
<blockquote>原文：<a href="https://itnext.io/third-party-cookies-authentication-769a08709330?source=collection_archive---------2-----------------------#2020-03-25">https://itnext.io/third-party-cookies-authentication-769a08709330?source=collection_archive---------2-----------------------#2020-03-25</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div class="gh gi jn"><img src="../Images/4b228d492895a001eb4e4be69e6749ec.png" data-original-src="https://miro.medium.com/v2/resize:fit:1074/format:webp/1*gXSUHjoQNi1Yjl9edD5tyQ.png"/></div></figure><p id="98e2" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">长话短说:年复一年，浏览器越来越保护我们的隐私和安全。副作用之一是第三方cookies开始被广泛屏蔽。</p><p id="46b8" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">简而言之:<strong class="jw ir">第一方cookie</strong>是由被访问域创建的cookie。<strong class="jw ir">第三方cookie</strong>是由不同于被访问域的域创建的cookie。让我们考虑一个例子。你访问awesome.com的<strong class="jw ir">，使用来自my.plugin.com<strong class="jw ir">的集成插件(它被集成为一个iframe)。来自<strong class="jw ir">awesome.com</strong>、<strong class="jw ir">static.awesome.com</strong>的cookie被视为第一方cookie，而来自<strong class="jw ir">my.plugin.com</strong>、<strong class="jw ir">plugin.com</strong>的cookie被视为第三方cookie。</strong></strong></p><p id="c648" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">阻止详细信息:</p><ul class=""><li id="19b7" class="ks kt iq jw b jx jy kb kc kf ku kj kv kn kw kr kx ky kz la bi translated"><a class="ae lb" href="https://webkit.org/blog/10218/full-third-party-cookie-blocking-and-more/" rel="noopener ugc nofollow" target="_blank">全面的第三方Cookie拦截和更多功能</a></li><li id="7d04" class="ks kt iq jw b jx lc kb ld kf le kj lf kn lg kr kx ky kz la bi translated">Chrome <a class="ae lb" href="https://chromestatus.com/feature/5633521622188032" rel="noopener ugc nofollow" target="_blank">用<em class="lh"> SameSite=None </em>拒绝不安全的cookie</a>从Chrome 80 <em class="lh">开始。</em></li></ul><h1 id="6fc4" class="li lj iq bd lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf bi translated">证明</h1><p id="511a" class="pw-post-body-paragraph ju jv iq jw b jx mg jz ka kb mh kd ke kf mi kh ki kj mj kl km kn mk kp kq kr ij bi translated">cookies如何与身份验证相关联？你的应用程序可以是一个独立的应用程序，它总是作为第一方使用，但你的应用程序也可以是另一个系统的插件(例如，特雷罗加电，JIRA插件等)。在这种情况下，浏览器会将您的应用视为第三方。</p><p id="6c80" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">有两种常见的身份验证方法。让我们回顾一下它们以及它们如何与第三方cookies一起工作。</p><h2 id="fe8d" class="ml lj iq bd lk mm mn dn lo mo mp dp ls kf mq mr lw kj ms mt ma kn mu mv me mw bi translated">无状态认证</h2><p id="765a" class="pw-post-body-paragraph ju jv iq jw b jx mg jz ka kb mh kd ke kf mi kh ki kj mj kl km kn mk kp kq kr ij bi translated">通常它和饼干没有任何共同之处。出于认证原因，在每个请求中添加令牌。它可以作为标题或查询参数添加。</p><p id="3005" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">适用于第一方和第三方，因为它根本不使用cookies。</p><h2 id="1280" class="ml lj iq bd lk mm mn dn lo mo mp dp ls kf mq mr lw kj ms mt ma kn mu mv me mw bi translated">状态认证</h2><p id="f12c" class="pw-post-body-paragraph ju jv iq jw b jx mg jz ka kb mh kd ke kf mi kh ki kj mj kl km kn mk kp kq kr ij bi translated">它是通过会话实现的。在cookie中设置会话id的常见方法，以便能够在每次请求时自动发送它。作为替代选项，会话id可以作为查询参数传递。</p><p id="b044" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">如果查询参数用于会话id，那么cookie就没有任何问题(因为您不使用cookie)。但是仍然有问题，因为会话id将是可见的，更容易被<a class="ae lb" href="https://owasp.org/www-community/attacks/Session_fixation" rel="noopener ugc nofollow" target="_blank">会话固定攻击</a>，可以被代理记录，因为它是请求url的一部分。</p><p id="6696" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">如果使用了cookies，那么如果你的应用是第三方的，你可能会有问题(你被集成到另一个域的另一个应用中)。因为您可能无法设置自己的会话cookies。</p><h2 id="c816" class="ml lj iq bd lk mm mn dn lo mo mp dp ls kf mq mr lw kj ms mt ma kn mu mv me mw bi translated">怎么修？</h2><p id="242e" class="pw-post-body-paragraph ju jv iq jw b jx mg jz ka kb mh kd ke kf mi kh ki kj mj kl km kn mk kp kq kr ij bi translated">如果可能，那么<strong class="jw ir">基于令牌的身份验证</strong>进行迁移。通常，集成提供商(如特雷罗、JIRA等)会提供一种获取、存储和刷新短期令牌的机制。但有时它有问题或不适合你的系统。</p><p id="896b" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">另一个选择是修复你的cookies(目前这是可能的)。</p><ol class=""><li id="89f8" class="ks kt iq jw b jx jy kb kc kf ku kj kv kn kw kr mx ky kz la bi translated">使用OAuth进行用户验证。同意屏幕应在一个单独的窗口中打开(由于<a class="ae lb" href="https://interceptd.com/what-is-click-hijacking-and-how-does-it-work/" rel="noopener ugc nofollow" target="_blank">点击劫持</a>攻击，默认方法)。在这种情况下，OAuth也将在该窗口中完成，会话cookie将被设置为第一方cookie。<strong class="jw ir">实际上，cookie被设置为第一方的事实将允许你作为第三方使用你的会话cookie(现在在Safari中实际上是这样工作的)。</strong></li><li id="4757" class="ks kt iq jw b jx lc kb ld kf le kj lf kn lg kr mx ky kz la bi translated">正确配置您的cookie。您的会话cookie应该包含<em class="lh"> SameSite </em>属性。如果该属性设置为<em class="lh">无</em>，则必须设置<em class="lh">安全</em>标志。否则会被屏蔽。</li></ol><blockquote class="my mz na"><p id="fee6" class="ju jv lh jw b jx jy jz ka kb kc kd ke nb kg kh ki nc kk kl km nd ko kp kq kr ij bi translated">在没有“SameSite”属性的情况下，设置了与位于<url>的跨站点资源相关联的cookie。它已被阻止，因为Chrome现在只在跨站点请求设置了“SameSite=None”和“Secure”的情况下提供cookies。您可以在应用程序&gt;存储&gt; cookie下的开发工具中查看cookie，并在<url>和<url>查看更多详细信息。</url></url></url></p></blockquote><h1 id="5d43" class="li lj iq bd lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf bi translated">如何测试cookies是否受支持？</h1><p id="a0f5" class="pw-post-body-paragraph ju jv iq jw b jx mg jz ka kb mh kd ke kf mi kh ki kj mj kl km kn mk kp kq kr ij bi translated">显示需要cookies支持的占位符页面是一种常见的做法。但是要适当的表现出来。如果你谷歌一下如何测试，你很可能会找到下面的代码片段:</p><figure class="ne nf ng nh gt jr"><div class="bz fp l di"><div class="ni nj l"/></div></figure><p id="89c0" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">但实际上它现在对第三方不适用(至少在Chrome上)。它适用于第一方案件。代码片段可以稍加调整，以支持第三方的情况(看起来很笨拙，但它的工作):</p><figure class="ne nf ng nh gt jr"><div class="bz fp l di"><div class="ni nj l"/></div></figure><p id="9287" class="pw-post-body-paragraph ju jv iq jw b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ij bi translated">此外，如果使用OAuth流，那么最好在OAuth完成后运行该检查。在这种情况下，完整的OAuth可以解锁您的第三方cookies。</p><h1 id="0a72" class="li lj iq bd lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf bi translated">存储器存取</h1><p id="4c8a" class="pw-post-body-paragraph ju jv iq jw b jx mg jz ka kb mh kd ke kf mi kh ki kj mj kl km kn mk kp kq kr ij bi translated">它与身份验证无关，但仍与阻止第三方访问有关。一旦第三方cookies被阻止，对本地和会话存储的访问也会被阻止。在这种情况下，我强烈建议预见这种情况，并准备好退回到“内存存储”。下面是一个简单的例子:</p><figure class="ne nf ng nh gt jr"><div class="bz fp l di"><div class="ni nj l"/></div></figure><h1 id="9b21" class="li lj iq bd lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf bi translated">进一步阅读</h1><ul class=""><li id="8b37" class="ks kt iq jw b jx mg kb mh kf nk kj nl kn nm kr kx ky kz la bi translated"><a class="ae lb" href="https://clearcode.cc/blog/difference-between-first-party-third-party-cookies/#first-party-cookies" rel="noopener ugc nofollow" target="_blank">第一方和第三方Cookies有什么区别？</a></li><li id="af26" class="ks kt iq jw b jx lc kb ld kf le kj lf kn lg kr kx ky kz la bi translated"><a class="ae lb" href="https://webkit.org/blog/10218/full-third-party-cookie-blocking-and-more/" rel="noopener ugc nofollow" target="_blank">全面的第三方Cookie拦截和更多</a></li><li id="006b" class="ks kt iq jw b jx lc kb ld kf le kj lf kn lg kr kx ky kz la bi translated"><a class="ae lb" href="https://cookie-script.com/all-you-need-to-know-about-third-party-cookies.html" rel="noopener ugc nofollow" target="_blank">关于第三方Cookies你需要知道的一切</a></li><li id="a398" class="ks kt iq jw b jx lc kb ld kf le kj lf kn lg kr kx ky kz la bi translated"><a class="ae lb" href="https://chromestatus.com/feature/5633521622188032" rel="noopener ugc nofollow" target="_blank">拒绝不安全的same site = None cookie</a></li><li id="c30f" class="ks kt iq jw b jx lc kb ld kf le kj lf kn lg kr kx ky kz la bi translated"><a class="ae lb" href="https://www.chromium.org/updates/same-site" rel="noopener ugc nofollow" target="_blank">Chromium-same site更新</a></li><li id="b3f0" class="ks kt iq jw b jx lc kb ld kf le kj lf kn lg kr kx ky kz la bi translated"><a class="ae lb" href="https://www.theverge.com/2020/1/14/21064698/google-third-party-cookies-chrome-two-years-privacy-safari-firefox" rel="noopener ugc nofollow" target="_blank">谷歌将“逐步淘汰”Chrome中的第三方cookies，但不是在两年内</a></li></ul></div></div>    
</body>
</html>