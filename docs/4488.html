<html>
<head>
<title>Generating network rules on Azure Container Registry with Terraform</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Terraform在Azure容器注册表上生成网络规则</h1>
<blockquote>原文：<a href="https://itnext.io/generating-network-rules-on-azure-container-registry-with-terraform-667667f2493f?source=collection_archive---------4-----------------------#2020-07-10">https://itnext.io/generating-network-rules-on-azure-container-registry-with-terraform-667667f2493f?source=collection_archive---------4-----------------------#2020-07-10</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/248a59cb42ea2861a8e92ce229860e47.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*NqNh9nY2eSF0ITonWiQReQ.png"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk translated">地形动态块</figcaption></figure><p id="0591" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">许多Azure资源，如Azure Container Registry (ACR)、Storage和Key Vault，都支持通过授予某些IP范围或虚拟网络来访问资源，从而添加网络级保护。这些控制是建立控制资源访问的分层方法的重要部分。虽然许多资源正在脱离虚拟网络规则，转而支持私有端点，但您会发现我的苦难对学习一些Terraform结构很有用。</p><p id="1a2d" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">本文将重点介绍我在尝试使用Terraform构造(for、for_each和dynamic blocks)从子网标识符的输入列表中生成网络规则列表时遇到的一些挑战。当我遇到这些问题时，我四处搜索，看到其他人也面临着同样的问题，但是这些帖子没有提供解决方案。</p><p id="e1fe" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">这是我最初的方法。我尝试使用for_each和一个动态块。不幸的是，变量var.allowed_subnet_ids不可达，并返回代码片段下面的错误。困惑之余，我开始排除故障，用一个硬编码的数组替换了这个变量…它会生成正确的配置。是时候发挥创造力了</p><pre class="la lb lc ld gt le lf lg lh aw li bi"><span id="8568" class="lj lk iq lf b gy ll lm l ln lo">variable "allowed_subnet_ids" {<br/>  type        = list(string)<br/>  description = "List of subnet IDs to be allowed to access the ACR"<br/>}</span><span id="ef40" class="lj lk iq lf b gy lp lm l ln lo">resource "azurerm_container_registry" "acr" {<br/>  name                     = module.azure_naming.acr_name<br/>  location                 = var.location<br/>  resource_group_name      = azurerm_resource_group.acr_rg.name<br/>  sku                      = "Premium"<br/>  admin_enabled            = false<br/>  georeplication_locations = var.georeplicated_region_list<br/>  network_rule_set {<br/>    default_action = "Deny"<br/>    dynamic "virtual_network" {<br/>      for_each =  var.allowed_subnet_ids<br/>      # for_each =  ["/subscriptions/xxxxxxxxxxxxxxxxxxxx/resourceGroups/rg-app1-network-sbox-canadaeast-persistent/providers/Microsoft.Network/virtualNetworks/vnet-app1-network-sbox-canadaeast/subnets/Private", "/subscriptions/xxxxxxxxxxxxxxxxxxxx/resourceGroups/rg-app2-network-sbox-canadaeast-persistent/providers/Microsoft.Network/virtualNetworks/vnet-app2-network-sbox-canadaeast/subnets/Private"]<br/>      content {<br/>        action    = "Allow"<br/>        subnet_id = virtual_network.value<br/>      }<br/>    }<br/>  }<br/>}</span></pre><p id="85c8" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated"><strong class="ke ir">错误:</strong></p><pre class="la lb lc ld gt le lf lg lh aw li bi"><span id="65a8" class="lj lk iq lf b gy ll lm l ln lo">Error: Unknown variable<br/>  on ../acr_resource/main.tf line 25, in resource "azurerm_container_registry" "acr":<br/>  25:       for_each =  var.allowed_subnet_ids</span></pre><h1 id="48fe" class="lq lk iq bd lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm bi translated">变得有创造力</h1><p id="9f9f" class="pw-post-body-paragraph kc kd iq ke b kf mn kh ki kj mo kl km kn mp kp kq kr mq kt ku kv mr kx ky kz ij bi translated">仔细考虑问题和故障排除排列，很明显我仍然需要生成网络规则列表。作为一个计算/生成，我使用局部变量来解决这个问题。这被证明是一个简单的解决方案；虽然我希望动态块能够工作。</p><pre class="la lb lc ld gt le lf lg lh aw li bi"><span id="01c7" class="lj lk iq lf b gy ll lm l ln lo">locals {<br/>  allowed_virtual_networks = [for s in var.allowed_subnet_ids : {<br/>    action    = "Allow",<br/>    subnet_id = s<br/>  }]<br/>}</span><span id="837c" class="lj lk iq lf b gy lp lm l ln lo">resource "azurerm_container_registry" "acr" {<br/>  name                     = module.azure_naming.acr_name<br/>  location                 = var.location<br/>  resource_group_name      = azurerm_resource_group.acr_rg.name<br/>  sku                      = "Premium"<br/>  admin_enabled            = false<br/>  georeplication_locations = var.georeplicated_region_list</span><span id="28a2" class="lj lk iq lf b gy lp lm l ln lo">network_rule_set {<br/>    default_action  = "Deny"<br/>    virtual_network = local.allowed_virtual_networks<br/>  }<br/>}</span></pre><p id="585a" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">关于For、for_each和动态块的更多信息，这个资源非常有用(尽管它把我引入了动态块的老鼠洞)。</p><div class="ms mt gp gr mu mv"><a href="https://www.hashicorp.com/blog/hashicorp-terraform-0-12-preview-for-and-for-each/" rel="noopener  ugc nofollow" target="_blank"><div class="mw ab fo"><div class="mx ab my cl cj mz"><h2 class="bd ir gy z fp na fr fs nb fu fw ip bi translated">哈希公司Terraform 0.12预览版:For和For-Each</h2><div class="nc l"><h3 class="bd b gy z fp na fr fs nb fu fw dk translated">作为Terraform 0.12发布前的一部分，我们发布了一系列功能预览博客帖子。的…</h3></div><div class="nd l"><p class="bd b dl z fp na fr fs nb fu fw dk translated">www.hashicorp.com</p></div></div><div class="ne l"><div class="nf l ng nh ni ne nj jw mv"/></div></div></a></div><p id="5755" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">其他人面临类似问题的其他资源:</p><ul class=""><li id="a7d8" class="nk nl iq ke b kf kg kj kk kn nm kr nn kv no kz np nq nr ns bi translated"><a class="ae nt" href="https://alexharv074.github.io/2019/09/17/adventures-in-the-terraform-dsl-part-vii-resource-for_each-in-terraform-0.12.6.html" rel="noopener ugc nofollow" target="_blank">https://Alex harv 074 . github . io/2019/09/17/adventures-in-the-terraform-DSL-part-VII-resource-for _ each-in-terraform-0 . 12 . 6 . html</a></li><li id="7e54" class="nk nl iq ke b kf nu kj nv kn nw kr nx kv ny kz np nq nr ns bi translated"><a class="ae nt" href="https://www.reddit.com/r/Terraform/comments/gh15g4/using_dynamic_inside_blocks_in_a_resource/" rel="noopener ugc nofollow" target="_blank">https://www . Reddit . com/r/terra form/comments/gh15g 4/using _ dynamic _ inside _ blocks _ in _ a _ resource/</a></li><li id="eb70" class="nk nl iq ke b kf nu kj nv kn nw kr nx kv ny kz np nq nr ns bi translated">https://discuse . hashi corp . com/t/using-dynamic-inside-blocks-in-A-resource/8542/2—对我的发现的后续回答提供了关于为什么动态块不工作的更多见解。</li></ul></div></div>    
</body>
</html>