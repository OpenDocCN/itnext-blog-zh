<html>
<head>
<title>Deploying a Nuxt Universal App to Azure</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">将Nuxt通用应用部署到Azure</h1>
<blockquote>原文：<a href="https://itnext.io/deploying-a-nuxt-universal-app-to-azure-f61e5a85d8a2?source=collection_archive---------1-----------------------#2018-08-13">https://itnext.io/deploying-a-nuxt-universal-app-to-azure-f61e5a85d8a2?source=collection_archive---------1-----------------------#2018-08-13</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/e6048a8640e32e215822da93b438bee9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*MuvrrSQG7TPgc4Pi5HqD2g.jpeg"/></div></div></figure><p id="d99d" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">这是一个漫长而艰难的过程，最终我的应用程序被部署在<a class="ae kw" href="https://vuejs.org/" rel="noopener ugc nofollow" target="_blank"> Vue </a> / <a class="ae kw" href="https://nuxtjs.org/" rel="noopener ugc nofollow" target="_blank"> Nuxt </a>中。</p><p id="8357" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">虽然有一些关于如何将Nuxt部署到各种地方的文档，如Heroku或GitHub Pages，但没有指向如何让Nuxt在Microsoft Azure上运行的T21的指针，具体来说是一个通用的应用程序，可以运行服务器端和客户端，而不仅仅是静态生成的应用程序或SPA风格的客户端应用程序。</p><p id="ed72" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">最重要的是，我不太确定哪些文件应该在服务器上，哪些不是。</p><p id="6139" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">截至2018年8月，这里真的是你需要知道的全部。</p><h1 id="b547" class="ky kz iq bd la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv bi translated">我的服务器上有什么？</h1><p id="6fc5" class="pw-post-body-paragraph jy jz iq ka b kb lw kd ke kf lx kh ki kj ly kl km kn lz kp kq kr ma kt ku kv ij bi translated">这些是<em class="kx">需要</em>保存在Azure上生产服务器实例的<code class="fe mb mc md me b">wwwroot</code>中的唯一文件:</p><pre class="mf mg mh mi gt mj me mk ml aw mm bi"><span id="f994" class="mn kz iq me b gy mo mp l mq mr">.nuxt<br/>static<br/>nuxt.config.js<br/>package.json<br/>server.js</span></pre><p id="e3c5" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">所以让我们一次过一遍。</p><h1 id="bae1" class="ky kz iq bd la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv bi translated"><code class="fe mb mc md me b">.nuxt</code>目录</h1><p id="d41d" class="pw-post-body-paragraph jy jz iq ka b kb lw kd ke kf lx kh ki kj ly kl km kn lz kp kq kr ma kt ku kv ij bi translated"><code class="fe mb mc md me b">.nuxt</code>目录拥有Nuxt作为服务器端应用程序运行所需的一切，它还包含一个名为<code class="fe mb mc md me b">dist</code>的目录。通过从你的应用程序的根目录运行命令<code class="fe mb mc md me b">npm run build</code>，这个目录中包含了组成你的应用程序的所有文件。</p><p id="bf61" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在<code class="fe mb mc md me b">dist</code>内部，您将会看到如下内容:</p><pre class="mf mg mh mi gt mj me mk ml aw mm bi"><span id="e9a6" class="mn kz iq me b gy mo mp l mq mr">0fdda7689bf96582760e.js<br/>7a8ee1584491e3b3499a.js<br/>5843c32d223ef79c6cac.js<br/>7698b9b9d7a056e0332e.js<br/>5359442cf7d324107315.js<br/>c2dbf45c410d904f8449.js</span></pre><p id="6104" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">这些都是编译后的Javascript文件，它们组成了您的个人<code class="fe mb mc md me b">.vue</code>页面和组件。非常简单。</p><p id="e197" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">默认情况下，您还将拥有:</p><pre class="mf mg mh mi gt mj me mk ml aw mm bi"><span id="fd39" class="mn kz iq me b gy mo mp l mq mr">index.spa.html<br/>index.ssr.html<br/>server-bundle.json<br/>vue-ssr-client-manifest.json</span></pre><p id="ae32" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">这些文件是应用程序的必需元素。对于通用应用程序，你并不真的需要<code class="fe mb mc md me b">index.spa.html</code>，所以如果你愿意，你可以安全地删除它。这是1KB，所以，没有什么大不了的。</p><h1 id="d830" class="ky kz iq bd la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv bi translated">确保。CSS实际上是作为。CSS文件</h1><pre class="mf mg mh mi gt mj me mk ml aw mm bi"><span id="e6c7" class="mn kz iq me b gy mo mp l mq mr">153d433a761cf8ccc028.css<br/>5376176449ad137de0b4.css</span></pre><p id="637f" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">当然还有你的样式表。现在，默认情况下，在没有首先修改配置文件的情况下，当构建应用程序时，您不会将样式视为它们自己的单独文件。所以这些可能不会在为你运行<code class="fe mb mc md me b">npm run build</code>后出现。原因如下:</p><p id="308e" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">默认模式是将所有样式都包含在其中。js文件，然后当你在浏览器中加载应用程序时，它内联所有的css，而不是指向外部。css文件。因此，在您的<code class="fe mb mc md me b">&lt;head&gt;</code>中，您最终会有大量的<code class="fe mb mc md me b">&lt;style type="text/css"&gt;...&lt;/style&gt;</code>声明。</p><p id="2a49" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">为了保证这些。当你构建你的应用程序时，css文件实际上是存在的，你需要在你的<code class="fe mb mc md me b">nuxt.config.js</code>配置文件中使用几行。在顶部，您需要安装并导入<a class="ae kw" href="https://github.com/webpack-contrib/uglifyjs-webpack-plugin" rel="noopener ugc nofollow" target="_blank"> UglifyJS </a>和<a class="ae kw" href="https://github.com/NMFR/optimize-css-assets-webpack-plugin" rel="noopener ugc nofollow" target="_blank">optimize-CSS-assets-web pack-plugin</a>:</p><pre class="mf mg mh mi gt mj me mk ml aw mm bi"><span id="f223" class="mn kz iq me b gy mo mp l mq mr">const UglifyJsPlugin = require('uglifyjs-webpack-plugin')<br/>const OptimizeCssAssetsPlugin = require('optimize-css-assets-webpack-plugin')</span></pre><p id="90b3" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">接下来，您需要在<code class="fe mb mc md me b"><strong class="ka ir">build</strong></code> <strong class="ka ir"> </strong>部分包含以下内容:</p><pre class="mf mg mh mi gt mj me mk ml aw mm bi"><span id="ddb3" class="mn kz iq me b gy mo mp l mq mr">module.exports = {<br/>...<br/>build: {<br/> extractCSS: true,<br/> optimization: {<br/>  minimizer: [<br/>   new UglifyJsPlugin({<br/>    cache: true,<br/>    parallel: true,<br/>    sourceMap: true // set to true if you want JS source maps<br/>   }),<br/>   new OptimizeCssAssetsPlugin({})<br/>  ],<br/>  splitChunks: {<br/>   cacheGroups: {<br/>    styles: {<br/>     name: 'styles',<br/>     test: /\.(vue)$/,<br/>     chunks: 'all',<br/>     enforce: true<br/>    }<br/>   }<br/>  }<br/> }<br/>}<br/>...<br/>}</span></pre><p id="f6c7" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><code class="fe mb mc md me b">extractCSS</code>是不言自明的——它让Nuxt知道您想将CSS从。js文件和make。改为指向css文件。</p><p id="beea" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">UglifyJsPlugin 是为了确保所有的。由于我们正在修改webpack的<code class="fe mb mc md me b">minimizer</code>设置，js被压缩和缩小了。</p><p id="f397" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><code class="fe mb mc md me b">OptimizeCssAssetsPlugin</code>所做的正是你所想的:通过缩小css资产、删除空白、让它们尽可能精简来优化它们。</p><p id="3266" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><code class="fe mb mc md me b">splitChunks</code>部分确保不是为每一个都创建大量的样式表。vue单个文件组件和页面，它将你所有的风格整合到几个文件中。</p><p id="20eb" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">好的。所以现在我们有了。js文件，我们的。css文件和其余的<code class="fe mb mc md me b">dist</code>文件夹。</p><h1 id="7aec" class="ky kz iq bd la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv bi translated">部署文件夹中的其他文件和目录</h1><p id="3126" class="pw-post-body-paragraph jy jz iq ka b kb lw kd ke kf lx kh ki kj ly kl km kn lz kp kq kr ma kt ku kv ij bi translated">所以我们还剩下一些其他的目录和文件:</p><pre class="mf mg mh mi gt mj me mk ml aw mm bi"><span id="4c87" class="mn kz iq me b gy mo mp l mq mr">static<br/>nuxt.config.js<br/>package.json<br/>server.js</span></pre><p id="2f0e" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">所以<code class="fe mb mc md me b">static</code>目录只是从你的应用根目录复制/粘贴的。它是你的应用程序使用的所有静态文件。像字体、图片、ads.txt、favicon.ico、robots.txt这样的东西——本质上，任何应该在你的网站上从<code class="fe mb mc md me b">"/"</code>提供的东西。</p><p id="0f16" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><code class="fe mb mc md me b">nuxt.config.js</code>也可以从您的应用程序根目录复制/粘贴。它仍然告诉Nuxt你希望你的应用程序如何配置，并且是一个必需的文件。除非您有非常具体的只用于生产的需求，否则您不需要在其中做任何更改。</p><p id="53d2" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">您的<code class="fe mb mc md me b">package.json</code>可以被复制/粘贴，但是您可能希望对其进行删减，只包含以下内容:</p><pre class="mf mg mh mi gt mj me mk ml aw mm bi"><span id="1c37" class="mn kz iq me b gy mo mp l mq mr">{<br/>  "name": "yourappname",<br/>  "engines": {<br/>    "node": "&gt;=6.11",<br/>    "npm": "&gt;=5.6.0"<br/>  },<br/>  "dependencies": {    <br/>    "nuxt-edge": "latest"<br/>  }<br/>}</span></pre><p id="fca0" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><em class="kx">(旁注:我在这里引用</em> <code class="fe mb mc md me b"><em class="kx">nuxt-edge</em></code> <em class="kx">是因为Nuxt 2.0还没有出来，但是当你读到这里的时候，你可能想只是引用</em> <code class="fe mb mc md me b"><em class="kx">"nuxt": "^2.0.0"</em></code> <em class="kx">来代替。)</em></p><p id="997e" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">本质上，你所需要的就是<code class="fe mb mc md me b">name</code>，这个<code class="fe mb mc md me b">engines</code>模块向Azure指示应该运行哪个版本的Node和NPM，然后是你的任何应用依赖。</p><p id="38d5" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">(注意:你<strong class="ka ir">不需要</strong>包含你的<code class="fe mb mc md me b">devDependencies</code>，因为你的应用已经构建好了，并且存在于<code class="fe mb mc md me b">.nuxt/dist</code>文件夹中，你不需要在服务器上重新构建你的应用——因此，在Azure上你的生产服务器上不需要devDependencies。)</p><p id="ec46" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">最后，但同样重要的是，我们有<code class="fe mb mc md me b">server.js</code>。这是一个最让我困惑的文件，因为在任何文档中都没有真正提到它与部署到Azure的具体关系。以下是我的<code class="fe mb mc md me b">server.js</code>全文:</p><pre class="mf mg mh mi gt mj me mk ml aw mm bi"><span id="a4de" class="mn kz iq me b gy mo mp l mq mr">const express = require('express')<br/>const {Nuxt} = require('nuxt-edge')</span><span id="02f1" class="mn kz iq me b gy ms mp l mq mr">const app = express()</span><span id="694d" class="mn kz iq me b gy ms mp l mq mr">const host = process.env.HOST || '127.0.0.1'<br/>const port = process.env.PORT || 3000</span><span id="05bd" class="mn kz iq me b gy ms mp l mq mr">// Import and set Nuxt.js options<br/>let config = require('./nuxt.config.js')</span><span id="6667" class="mn kz iq me b gy ms mp l mq mr">const nuxt = new Nuxt(config)</span><span id="ea1e" class="mn kz iq me b gy ms mp l mq mr">// Give Nuxt middleware to express<br/>app.use(nuxt.render)</span><span id="172f" class="mn kz iq me b gy ms mp l mq mr">// Listen the server<br/>app.listen(port, host);<br/>console.log('Server listening on ' + host + ':' + port);</span></pre><p id="09b0" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">本质上，这只是设置主机和端口，实例化Nuxt，并让Express服务于应用程序。</p><p id="f13a" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">好的。现在我们的配置都设置好了，请确保再次运行<code class="fe mb mc md me b">npm run build</code>，复制我们的目录和文件(。nuxt，static，nuxt.config.js，package.json，server.js)到一个新文件夹中——可能命名为“deployment ”,或者类似的名称——我们就可以开始了。</p><h1 id="b020" class="ky kz iq bd la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv bi translated">我们拿到了文件。我们如何把它们放到Azure上？</h1><p id="e380" class="pw-post-body-paragraph jy jz iq ka b kb lw kd ke kf lx kh ki kj ly kl km kn lz kp kq kr ma kt ku kv ij bi translated">由于缺乏清晰的文档，这对我来说是另一个棘手的部分，但我在Azure Node上参考了这个指南。JS部署和它为我工作:<a class="ae kw" href="https://code.visualstudio.com/tutorials/nodejs-deployment/getting-started" rel="noopener ugc nofollow" target="_blank">https://code . visual studio . com/tutorials/nodejs-deployment/getting-started</a></p><p id="eb72" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">这将使您的应用程序在一个节点上启动。免费层Azure上的JS web app。这不需要花费任何成本，但是一旦你部署了应用程序，你就可以随时扩展它，让它表现得更好。这也是从Windows机器部署的。</p><p id="5610" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><strong class="ka ir">Tl；dr</strong>——上面关于部署到Azure的快速链接是:</p><ul class=""><li id="0570" class="mt mu iq ka b kb kc kf kg kj mv kn mw kr mx kv my mz na nb bi translated">转到您的“部署”目录，其中包含。nuxt，static，nuxt.config.js，package.json，server.js)</li><li id="0909" class="mt mu iq ka b kb nc kf nd kj ne kn nf kr ng kv my mz na nb bi translated">确保你的机器上安装了<a class="ae kw" href="https://docs.microsoft.com/en-us/cli/azure/install-azure-cli?view=azure-cli-latest" rel="noopener ugc nofollow" target="_blank"> <strong class="ka ir"> Azure CLI </strong> </a>和<a class="ae kw" href="https://git-scm.com/" rel="noopener ugc nofollow" target="_blank"> <strong class="ka ir"> Git </strong> </a></li><li id="dd01" class="mt mu iq ka b kb nc kf nd kj ne kn nf kr ng kv my mz na nb bi translated"><strong class="ka ir">创建资源组</strong> : <code class="fe mb mc md me b">az group create --name myResourceGroup --location "Your Location"</code> <em class="kx">(参考</em> <a class="ae kw" href="https://azure.microsoft.com/en-us/global-infrastructure/locations/" rel="noopener ugc nofollow" target="_blank"> <em class="kx">天蓝色位置</em> </a> <em class="kx">为离你最近的位置名称— </em> <code class="fe mb mc md me b"><em class="kx">myResourceGroup</em></code> <em class="kx">可以是你喜欢的任何名称)</em></li><li id="403d" class="mt mu iq ka b kb nc kf nd kj ne kn nf kr ng kv my mz na nb bi translated"><strong class="ka ir">创建Azure App服务计划</strong> : <code class="fe mb mc md me b">az appservice plan create --name myAppServicePlan --resource-group myResourceGroup --sku F1</code> <em class="kx">(还是那句话，</em> <code class="fe mb mc md me b"><em class="kx">myAppServicePlan</em></code> <em class="kx">随便你怎么叫)</em></li><li id="d782" class="mt mu iq ka b kb nc kf nd kj ne kn nf kr ng kv my mz na nb bi translated"><strong class="ka ir">创建一个web应用:</strong> <code class="fe mb mc md me b">az webapp create --resource-group myResourceGroup --plan myAppServicePlan --name &lt;app_name&gt;</code></li><li id="1384" class="mt mu iq ka b kb nc kf nd kj ne kn nf kr ng kv my mz na nb bi translated"><strong class="ka ir">初始化您的Git回购:<br/> </strong> <code class="fe mb mc md me b">git init<br/>git add -A<br/>git commit -m "initial commit"</code></li><li id="ea59" class="mt mu iq ka b kb nc kf nd kj ne kn nf kr ng kv my mz na nb bi translated"><strong class="ka ir">设置遥控器:</strong> <code class="fe mb mc md me b">az webapp deployment user set --user-name &lt;UserName&gt; --password &lt;Password&gt;<br/>git remote add azure &lt;your git endpoint&gt;</code></li><li id="7017" class="mt mu iq ka b kb nc kf nd kj ne kn nf kr ng kv my mz na nb bi translated"><strong class="ka ir">部署吧！</strong> <code class="fe mb mc md me b">git push azure master</code></li></ul><p id="6a03" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">如果部署成功并且您没有遇到任何错误，那么您<strong class="ka ir"> <em class="kx">应该</em> </strong>能够浏览到部署的地址<code class="fe mb mc md me b">&lt;yourappname&gt;.azurewebsites.net</code></p><p id="475b" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">如果第一次加载失败，尝试刷新几次浏览器。在免费层上，Azure有时需要一点时间来运行，但最终它应该会加载成功。</p><h1 id="63dd" class="ky kz iq bd la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv bi translated">咻！我们做到了！</h1><p id="aecf" class="pw-post-body-paragraph jy jz iq ka b kb lw kd ke kf lx kh ki kj ly kl km kn lz kp kq kr ma kt ku kv ij bi translated">我希望这能帮助那些正在努力把他们的Nuxt应用程序放到Azure上的人。当然，有一百万种不同的部署要考虑，以确保伟大的<a class="ae kw" href="https://developers.google.com/web/tools/lighthouse/" rel="noopener ugc nofollow" target="_blank">灯塔</a>分数，或者不同的中间件选项，或者如果你有你喜欢使用的特定预处理，或者任何数量的事情。我鼓励你加入<a class="ae kw" href="https://t.co/8YvZaR0Q8u" rel="noopener ugc nofollow" target="_blank"> <strong class="ka ir">不和谐服务器</strong> </a>，那里总是有其他开发者在一起，互相帮助解决棘手的问题。成为社区的一份子，我们一起解决！</p></div></div>    
</body>
</html>