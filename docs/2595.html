<html>
<head>
<title>Traefik cluster as Ingress Controller for Kubernetes</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Traefik集群作为Kubernetes的入口控制器</h1>
<blockquote>原文：<a href="https://itnext.io/traefik-cluster-as-ingress-controller-for-kubernetes-99fa6c34402?source=collection_archive---------1-----------------------#2019-06-20">https://itnext.io/traefik-cluster-as-ingress-controller-for-kubernetes-99fa6c34402?source=collection_archive---------1-----------------------#2019-06-20</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><p id="0308" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">Traefik集群作为Kubernetes的入口控制器</p><h2 id="16d1" class="ko kp it bd kq kr ks dn kt ku kv dp kw kb kx ky kz kf la lb lc kj ld le lf lg bi translated">介绍</h2><p id="b523" class="pw-post-body-paragraph jq jr it js b jt lh jv jw jx li jz ka kb lj kd ke kf lk kh ki kj ll kl km kn im bi translated">入口控制器是Kubernetes集群上运行的服务的入口。为了获得高可用性集群，应该有多个入口控制器作为一个集群一起工作。</p><p id="6128" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">Traefik是<a class="ae lm" href="https://kubernetes.io/docs/concepts/services-networking/ingress-controllers/" rel="noopener ugc nofollow" target="_blank">入口控制器</a>之一。我使用它的动态配置和自动LetsEncrypt证书。部署单个Traefik入口控制器的说明很多，但Traefik集群的详细信息不如入口控制器多。<a class="ae lm" href="https://docs.traefik.io/user-guide/cluster/" rel="noopener ugc nofollow" target="_blank">公文</a>比较简短，所以我想在这篇文章里分享一下我的经验。</p><p id="a3d8" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">一个工作的HA Kubernetes集群至少有3个主节点和一些工作节点。我在这里 分享过我的经验<a class="ae lm" href="https://medium.com/@liejuntao001/create-highly-available-kubernetes-cluster-with-minimal-dependencies-c45f5b34e9d2" rel="noopener">。通过添加Traefik集群，集群的架构如下图所示。</a></p><p id="fd9f" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">在这里，我在主节点上部署入口控制器，我认为这适用于低流量集群。如果集群需要服务高流量，可以将更多实例部署到工作节点。</p><figure class="lp lq lr ls gt lt gh gi paragraph-image"><div role="button" tabindex="0" class="lu lv di lw bf lx"><div class="gh gi lo"><img src="../Images/c9b0f2eb128a795d47cea59c4f78d3e6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*OqcozGntcycyEbaKGB5g5w.png"/></div></div><figcaption class="ma mb gj gh gi mc md bd b be z dk translated">体系结构</figcaption></figure><p id="9dd8" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><em class="ln">2020年1月9日更新</em></p><blockquote class="me mf mg"><p id="9f80" class="jq jr ln js b jt ju jv jw jx jy jz ka mh kc kd ke mi kg kh ki mj kk kl km kn im bi translated">Traefik使用Consul集群作为存储后端。为了使它安全/稳定，我在本文中分享了我最近在Kubernetes中为生产运行Consul的经验。</p></blockquote><h2 id="b0bf" class="ko kp it bd kq kr ks dn kt ku kv dp kw kb kx ky kz kf la lb lc kj ld le lf lg bi translated">先决条件</h2><p id="f65b" class="pw-post-body-paragraph jq jr it js b jt lh jv jw jx li jz ka kb lj kd ke kf lk kh ki kj ll kl km kn im bi translated"><a class="ae lm" href="https://www.consul.io/downloads.html" rel="noopener ugc nofollow" target="_blank">咨询</a>命令行，示例如下</p><pre class="lp lq lr ls gt mk ml mm mn aw mo bi"><span id="2747" class="ko kp it ml b gy mp mq l mr ms">cd /tmp &amp;&amp; wget   <a class="ae lm" href="https://releases.hashicorp.com/consul/1.5.1/consul_1.5.1_linux_amd64.zip" rel="noopener ugc nofollow" target="_blank">https://releases.hashicorp.com/consul/1.5.1/consul_1.5.1_linux_amd64.zip</a> &amp;&amp; unzip <a class="ae lm" href="https://releases.hashicorp.com/consul/1.5.1/consul_1.5.1_linux_amd64.zip" rel="noopener ugc nofollow" target="_blank">consul_1.5.1_linux_amd64.zip</a> &amp;&amp; sudo mv consul /usr/local/bin</span></pre><p id="7c1f" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><a class="ae lm" href="https://github.com/containous/traefik/releases" rel="noopener ugc nofollow" target="_blank"> traefik </a>命令行，示例如下</p><pre class="lp lq lr ls gt mk ml mm mn aw mo bi"><span id="c9c1" class="ko kp it ml b gy mp mq l mr ms">cd /tmp &amp;&amp; wget <a class="ae lm" href="https://github.com/containous/traefik/releases/download/v1.7.11/traefik_linux-amd64" rel="noopener ugc nofollow" target="_blank">https://github.com/containous/traefik/releases/download/v1.7.11/trae  fik_linux-amd64</a> &amp;&amp; chmod +x traefik_linux-amd64 &amp;&amp; mv traefik_linux-amd64 traefik &amp;&amp; sudo mv traefik /usr/local/bin</span></pre><p id="b705" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">go环境，cfssl，cfssljson</p><pre class="lp lq lr ls gt mk ml mm mn aw mo bi"><span id="e890" class="ko kp it ml b gy mp mq l mr ms"># Install <a class="ae lm" href="https://github.com/travis-ci/gimme" rel="noopener ugc nofollow" target="_blank">gimme</a><br/>$ curl -sL -o ~/bin/gimme https://raw.githubusercontent.com/travis-ci/gimme/master/gimme<br/>$ chmod +x ~/bin/gimme</span><span id="e798" class="ko kp it ml b gy mt mq l mr ms"># Install go<br/>$ eval `gimme stable`</span><span id="42b5" class="ko kp it ml b gy mt mq l mr ms"># Install cfssl, cfssljson<br/>go get -u github.com/cloudflare/cfssl/cmd/cfssl<br/>go get -u github.com/cloudflare/cfssl/cmd/cfssljson</span></pre><h2 id="4cfd" class="ko kp it bd kq kr ks dn kt ku kv dp kw kb kx ky kz kf la lb lc kj ld le lf lg bi translated">本文中使用的来源</h2><pre class="lp lq lr ls gt mk ml mm mn aw mo bi"><span id="3d76" class="ko kp it ml b gy mp mq l mr ms"><a class="ae lm" href="https://github.com/liejuntao001/traefik-ingress-cluster" rel="noopener ugc nofollow" target="_blank">github link</a></span></pre><h2 id="e2e6" class="ko kp it bd kq kr ks dn kt ku kv dp kw kb kx ky kz kf la lb lc kj ld le lf lg bi translated">部署领事</h2><p id="4b17" class="pw-post-body-paragraph jq jr it js b jt lh jv jw jx li jz ka kb lj kd ke kf lk kh ki kj ll kl km kn im bi translated">领事是用来作为KV商店的Traefik，而它实际上更强大。</p><p id="3bb7" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">我将按照本教程<a class="ae lm" href="https://testdriven.io/blog/running-vault-and-consul-on-kubernetes/" rel="noopener ugc nofollow" target="_blank"> <em class="ln">的前半部分</em> </a>部署一个3副本consul集群。</p><p id="bbf1" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">为咨询生成CA和证书</p><pre class="lp lq lr ls gt mk ml mm mn aw mo bi"><span id="3770" class="ko kp it ml b gy mp mq l mr ms">$ cd ca</span><span id="977d" class="ko kp it ml b gy mt mq l mr ms"># Generate CA</span><span id="f67d" class="ko kp it ml b gy mt mq l mr ms">$ cfssl gencert -initca config/ca-csr.json | cfssljson -bare ca</span><span id="04df" class="ko kp it ml b gy mt mq l mr ms"># Generate certs</span><span id="b064" class="ko kp it ml b gy mt mq l mr ms">$ cfssl gencert \<br/>    -ca=ca.pem \<br/>    -ca-key=ca-key.pem \<br/>    -config=config/ca-config.json \<br/>    -profile=default \<br/>    config/consul-csr.json | cfssljson -bare consul</span><span id="b94a" class="ko kp it ml b gy mt mq l mr ms">$ cfssl gencert \<br/>    -ca=ca.pem \<br/>    -ca-key=ca-key.pem \<br/>    -config=config/ca-config.json \<br/>    -profile=default \<br/>    config/traefik-csr.json | cfssljson -bare traefik</span></pre><p id="517e" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">部署领事</p><p id="dfe4" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">由于Consul需要持久卷，请适当调整consul/consul_statefulset.yml中的storageClassName。</p><p id="37e7" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">如果集群的工作节点少于3个，请从consul/Consul _ statefullset . yml中删除“podAntiAffinity ”,但是，要获得高可用性的Consul集群，最好在不同的节点上运行3或5个副本。</p><pre class="lp lq lr ls gt mk ml mm mn aw mo bi"><span id="b143" class="ko kp it ml b gy mp mq l mr ms">kubectl apply -f consul/</span></pre><p id="a40f" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">生成领事机密</p><pre class="lp lq lr ls gt mk ml mm mn aw mo bi"><span id="4f7c" class="ko kp it ml b gy mp mq l mr ms">$ cd ca</span><span id="f8b5" class="ko kp it ml b gy mt mq l mr ms"># Generate gossip key<br/>$ export GOSSIP_ENCRYPTION_KEY=$(consul keygen)</span><span id="d327" class="ko kp it ml b gy mt mq l mr ms"># consul<br/>$ kubectl -n consul create secret generic consul \<br/>  --from-literal="gossip-encryption-key=${GOSSIP_ENCRYPTION_KEY}" \<br/>  --from-file=ca.pem \<br/>  --from-file=consul.pem \<br/>  --from-file=consul-key.pem</span></pre><p id="99c1" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">如果一切顺利，我们应该有3个执政官舱。</p><pre class="lp lq lr ls gt mk ml mm mn aw mo bi"><span id="80cd" class="ko kp it ml b gy mp mq l mr ms">$ kubectl -n consul get pod<br/>NAME       READY   STATUS    RESTARTS   AGE<br/>consul-0   2/2     Running   0          17s<br/>consul-1   2/2     Running   0          14s<br/>consul-2   2/2     Running   0          11s</span><span id="ef97" class="ko kp it ml b gy mt mq l mr ms"># check log<br/>$ kubectl -n consul logs -f consul-0 -c consul<br/>bootstrap_expect &gt; 0: expecting 3 servers<br/>==&gt; Starting Consul agent...<br/>==&gt; Consul agent running!<br/>           Version: 'v1.5.0'<br/>           Node ID: '159adb35-0cfd-2c58-ea51-8e3a6b64ee4c'<br/>         Node name: 'consul-0'<br/>        Datacenter: 'dc1' (Segment: '&lt;all&gt;')<br/>            Server: true (Bootstrap: false)<br/>       Client Addr: [0.0.0.0] (HTTP: 8500, HTTPS: 8443, gRPC: -1, DNS: 8600)<br/>      Cluster Addr: 10.0.210.154 (LAN: 8301, WAN: 8302)<br/>           Encrypt: Gossip: <strong class="ml iu">true</strong>, TLS-Outgoing: <strong class="ml iu">true</strong>, TLS-Incoming: <strong class="ml iu">true</strong></span><span id="6454" class="ko kp it ml b gy mt mq l mr ms"># forward consul to localhost<br/>$ kubectl -n consul port-forward consul-0 8500:8500 &amp;</span><span id="5b9e" class="ko kp it ml b gy mt mq l mr ms"># run this command in different console to maintain the connection<br/>$ while true; do consul members &amp;&amp; sleep 20; done</span><span id="e899" class="ko kp it ml b gy mt mq l mr ms">$ consul members<br/>Node      Address            Status  Type    Build  Protocol  DC   Segment<br/>consul-0  10.0.210.154:8301  alive   server  1.5.0  2         dc1  &lt;all&gt;<br/>consul-1  10.0.143.30:8301   alive   server  1.5.0  2         dc1  &lt;all&gt;<br/>consul-2  10.0.181.84:8301   alive   server  1.5.0  2         dc1  &lt;all&gt;<br/></span></pre><p id="e474" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">浏览到<a class="ae lm" href="http://localhost:8500" rel="noopener ugc nofollow" target="_blank"> http://localhost:8500 </a>获得咨询用户界面</p><figure class="lp lq lr ls gt lt gh gi paragraph-image"><div role="button" tabindex="0" class="lu lv di lw bf lx"><div class="gh gi mu"><img src="../Images/171148f32efaca1c74c85b01deab14ca.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*OwZda7AMxw6vcQwNhyxmAA.png"/></div></div><figcaption class="ma mb gj gh gi mc md bd b be z dk translated">咨询服务</figcaption></figure><figure class="lp lq lr ls gt lt gh gi paragraph-image"><div role="button" tabindex="0" class="lu lv di lw bf lx"><div class="gh gi mv"><img src="../Images/f00337c1a5fc6cf1ba1697313b83f71b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*kzz8hllXsSBOWfzDddPtzw.png"/></div></div><figcaption class="ma mb gj gh gi mc md bd b be z dk translated">咨询节点</figcaption></figure><figure class="lp lq lr ls gt lt gh gi paragraph-image"><div role="button" tabindex="0" class="lu lv di lw bf lx"><div class="gh gi mu"><img src="../Images/b71778d63c3f50f71f877dc2972eb30b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*uytqGW3ZWl13IjiNCw0GvQ.png"/></div></div><figcaption class="ma mb gj gh gi mc md bd b be z dk translated">领事K/V商店，现在空了</figcaption></figure><h2 id="03c0" class="ko kp it bd kq kr ks dn kt ku kv dp kw kb kx ky kz kf la lb lc kj ld le lf lg bi translated">将traefik.toml导入Consul</h2><p id="359d" class="pw-post-body-paragraph jq jr it js b jt lh jv jw jx li jz ka kb lj kd ke kf lk kh ki kj ll kl km kn im bi translated">我有这个traefik.toml.sample作为模板。<br/>填写合适的邮箱地址和域名，生成一个文件traefik.toml</p><figure class="lp lq lr ls gt lt"><div class="bz fp l di"><div class="mw mx l"/></div></figure><p id="22f7" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">使用“traefik storeconfig”命令导入traefik.toml。</p><pre class="lp lq lr ls gt mk ml mm mn aw mo bi"><span id="c2e0" class="ko kp it ml b gy mp mq l mr ms"># Generate from template<br/>$ EMAIL=youremail@example.com DOMAIN=example.com envsubst &lt; traefik.toml.kv.sample  &gt; traefik.toml</span><span id="39d0" class="ko kp it ml b gy mt mq l mr ms"># forward consul to localhost<br/>$ kubectl -n consul port-forward consul-0 8500:8500 &amp;</span><span id="8d2c" class="ko kp it ml b gy mt mq l mr ms"># magic time<br/>$ traefik storeconfig  --consul --consul.endpoint=localhost:8500 --file.filename=./traefik.toml<br/>...<br/>Writing config to KV</span></pre><p id="77d1" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">如果正确导入，请检查领事K/V商店中的值</p><figure class="lp lq lr ls gt lt gh gi paragraph-image"><div role="button" tabindex="0" class="lu lv di lw bf lx"><div class="gh gi my"><img src="../Images/306a9fa24214551b3ba9c4b6b977f013.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*z27gviv45MWFjI3iLHeURw.png"/></div></div><figcaption class="ma mb gj gh gi mc md bd b be z dk translated">导入后K/V存储</figcaption></figure><p id="14f8" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">完成上述导入步骤后，需要手动更改键traefik/consul/endpoint的值。如下图截图所示，to '<a class="ae lm" href="https://consul.consul.svc.cluster.local:8443" rel="noopener ugc nofollow" target="_blank">https://consul . consul . SVC . cluster . local:8443</a>，这是领事服务的URL。</p><figure class="lp lq lr ls gt lt gh gi paragraph-image"><div role="button" tabindex="0" class="lu lv di lw bf lx"><div class="gh gi mz"><img src="../Images/5a865ec2cf4afcd2cb4a0259eaf60b53.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*PgVe1D9RAMM1FRT-D1edWQ.png"/></div></div><figcaption class="ma mb gj gh gi mc md bd b be z dk translated">手动修改该值</figcaption></figure><p id="e185" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">如果在acme.json文件中存在现有的Let'sEncrypt证书，只需取消注释该行即可</p><pre class="lp lq lr ls gt mk ml mm mn aw mo bi"><span id="a877" class="ko kp it ml b gy mp mq l mr ms">#storageFile = "./acme.json"</span></pre><p id="9996" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">从文件traefik.toml进行导入。它也会被导入到Consul中。</p><p id="bdda" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">然后删除键traefik/acme/account/lock，以允许traefik入口pod获得锁。</p><h2 id="d658" class="ko kp it bd kq kr ks dn kt ku kv dp kw kb kx ky kz kf la lb lc kj ld le lf lg bi translated">部署Traefik入口控制器集群</h2><p id="b428" class="pw-post-body-paragraph jq jr it js b jt lh jv jw jx li jz ka kb lj kd ke kf lk kh ki kj ll kl km kn im bi translated">为traefik群集创建TLS机密。它是用来访问领事的。</p><pre class="lp lq lr ls gt mk ml mm mn aw mo bi"><span id="9f18" class="ko kp it ml b gy mp mq l mr ms">$ cd ca<br/>$ kubectl -n kube-system create secret generic traefik-consul \<br/>&gt;     --from-file=ca.pem \<br/>&gt;     --from-file=traefik.pem \<br/>&gt;     --from-file=traefik-key.pem<br/>secret/traefik-consul created</span></pre><p id="531d" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">创建traefik仪表板密码。</p><pre class="lp lq lr ls gt mk ml mm mn aw mo bi"><span id="ef15" class="ko kp it ml b gy mp mq l mr ms">kubectl -n kube-system create secret generic kubesecret --from-file auth</span></pre><p id="4e65" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">文件“auth”就是从这个命令创建的。用户名/密码将用于访问traefik仪表板</p><pre class="lp lq lr ls gt mk ml mm mn aw mo bi"><span id="ced9" class="ko kp it ml b gy mp mq l mr ms">$ htpasswd -c ./auth &lt;username&gt;<br/>New password:<br/>Re-type new password:<br/>Adding password for user testaaa</span></pre><p id="3693" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">现在部署它。</p><p id="47e7" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">示例traefik_kv.yaml将部署到主节点。如果不希望如此，请调整“nodeAffinity”部分。</p><pre class="lp lq lr ls gt mk ml mm mn aw mo bi"><span id="d7cd" class="ko kp it ml b gy mp mq l mr ms">DOMAIN=example.com envsubst &lt; traefik_kv.yaml | kubectl apply -f -</span></pre><p id="ff41" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">traefik-ingress-controller有3个pod。</p><pre class="lp lq lr ls gt mk ml mm mn aw mo bi"><span id="e19a" class="ko kp it ml b gy mp mq l mr ms">$ kubectl -n kube-system get pod -o wide<br/>traefik-ingress-controller-5dlbz          1/1     Running   0          5m21s   10.0.142.69       master3<br/>traefik-ingress-controller-9nxqt          1/1     Running   0          6m34s   10.0.123.196      master2   <br/>traefik-ingress-controller-xzkzd          1/1     Running   0          5m34s   10.0.255.14       master1   </span></pre><p id="6368" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">向部署了入口控制器的节点添加标签，因为我将使用标签来处理集群重启序列。参考我的文章《如何重启高可用的Kubernetes集群》(<a class="ae lm" href="https://medium.com/@liejuntao001/how-to-reboot-highly-available-kubernetes-cluster-5a9df4daecf" rel="noopener">链接</a>)。</p><pre class="lp lq lr ls gt mk ml mm mn aw mo bi"><span id="6933" class="ko kp it ml b gy mp mq l mr ms"># for all nodes that has Ingress Controller<br/>$ <!-- -->kubectl label nodes master1 <!-- -->node-role.kubernetes.io/ingress-controller=</span><span id="8e0d" class="ko kp it ml b gy mt mq l mr ms">$ kubectl get nodes<br/>NAME      STATUS   ROLES                       AGE   VERSION<br/>master1   Ready    ingress-controller,master   49d   v1.14.1<br/>master2   Ready    ingress-controller,master   49d   v1.14.1<br/>master3   Ready    ingress-controller,master   49d   v1.14.1<br/>worker1   Ready    &lt;none&gt;                      49d   v1.14.1<br/>worker2   Ready    &lt;none&gt;                      48d   v1.14.1<br/>worker3   Ready    &lt;none&gt;                      48d   v1.14.1</span></pre><h2 id="52ea" class="ko kp it bd kq kr ks dn kt ku kv dp kw kb kx ky kz kf la lb lc kj ld le lf lg bi translated"><strong class="ak">添加Haproxy规则</strong></h2><p id="a016" class="pw-post-body-paragraph jq jr it js b jt lh jv jw jx li jz ka kb lj kd ke kf lk kh ki kj ll kl km kn im bi translated">traefik集群准备就绪后，将haproxy规则添加到主要和备份haproxy主机。基本上，转发端口80和443。</p><figure class="lp lq lr ls gt lt"><div class="bz fp l di"><div class="mw mx l"/></div></figure><p id="6ac9" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">由于域的DNS指向haproxy，现在可以使用上面创建的用户名/密码访问trae fik dashboard h<a class="ae lm" href="https://traefik.example.com/" rel="noopener ugc nofollow" target="_blank">ttps://trae fik . k8s . example . com/</a>。</p><h2 id="c67b" class="ko kp it bd kq kr ks dn kt ku kv dp kw kb kx ky kz kf la lb lc kj ld le lf lg bi translated">从领事处导出顶点</h2><p id="a690" class="pw-post-body-paragraph jq jr it js b jt lh jv jw jx li jz ka kb lj kd ke kf lk kh ki kj ll kl km kn im bi translated">我想检查/备份Traefik群集为服务获得的Let'sEncrypt证书。我找不到清晰的说明，以下是我尝试后的步骤。</p><pre class="lp lq lr ls gt mk ml mm mn aw mo bi"><span id="17e1" class="ko kp it ml b gy mp mq l mr ms"># Connect to consul<br/>kubectl -n consul port-forward consul-0 8500:8500 &amp;</span><span id="c76b" class="ko kp it ml b gy mt mq l mr ms"># Keep the consul connection open<br/>while true; do consul members &amp;&amp; sleep 10; done</span><span id="a4e2" class="ko kp it ml b gy mt mq l mr ms"># retrieve compressed acme object<br/>consul kv get traefik/acme/account/object &gt; acme.gz</span><span id="92ee" class="ko kp it ml b gy mt mq l mr ms"># gunzip<br/>cat acme.gz | gunzip &gt; acme.json</span><span id="65c0" class="ko kp it ml b gy mt mq l mr ms"># Format<br/>cat acme.json | jq '.' &gt; acme.json.formatted</span></pre><h2 id="a69e" class="ko kp it bd kq kr ks dn kt ku kv dp kw kb kx ky kz kf la lb lc kj ld le lf lg bi translated">备份/恢复咨询</h2><p id="d12f" class="pw-post-body-paragraph jq jr it js b jt lh jv jw jx li jz ka kb lj kd ke kf lk kh ki kj ll kl km kn im bi translated">我遇到了一个案例，我想为consul集群更改持久卷。所以我需要摧毁执政官集群并重建它。显然，我不想失去现有的KV值。我发现使用consul快照备份/恢复非常简单。</p><ol class=""><li id="a109" class="na nb it js b jt ju jx jy kb nc kf nd kj ne kn nf ng nh ni bi translated">创建快照作为备份</li><li id="ee73" class="na nb it js b jt nj jx nk kb nl kf nm kj nn kn nf ng nh ni bi translated">销毁领事声明集和pvc</li><li id="e3ce" class="na nb it js b jt nj jx nk kb nl kf nm kj nn kn nf ng nh ni bi translated">用新的咨询配置重新创建</li><li id="6a55" class="na nb it js b jt nj jx nk kb nl kf nm kj nn kn nf ng nh ni bi translated">从快照恢复</li></ol><pre class="lp lq lr ls gt mk ml mm mn aw mo bi"><span id="80be" class="ko kp it ml b gy mp mq l mr ms"># backup<br/>consul snapshot save backup.snap</span><span id="85c8" class="ko kp it ml b gy mt mq l mr ms"># restore<br/>consul snapshot restore backup.snap</span></pre><p id="30b3" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">感谢阅读。</p></div></div>    
</body>
</html>