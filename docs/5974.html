<html>
<head>
<title>AWS: CloudTrail overview and integration with CloudWatch and Opsgenie</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">AWS: CloudTrail概述以及与CloudWatch和Opsgenie的集成</h1>
<blockquote>原文：<a href="https://itnext.io/aws-cloudtrail-overview-and-integration-with-cloudwatch-and-opsgenie-1efa192bc2fa?source=collection_archive---------5-----------------------#2021-07-15">https://itnext.io/aws-cloudtrail-overview-and-integration-with-cloudwatch-and-opsgenie-1efa192bc2fa?source=collection_archive---------5-----------------------#2021-07-15</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/4db53edc2d31ceaf0cc5efaa8b7bac60.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*8QppZuMnRQSngTE4H4UqzA.png"/></div></div></figure><p id="638e" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">AWS CloudTrail是用于审计AWS帐户事件的服务，默认情况下处于启用状态。</p><p id="3e7f" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">它保存用户、IAM角色或AWS服务通过AWS控制台、AWS CLI或AWS SDK完成的所有操作。</p><p id="3440" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">CloudTrail会写每个API调用的信息，登录系统，服务事件，是AWS账号安全不可或缺的工具。</p><p id="e106" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">此类事件将存储90天，但您可以配置一个<em class="kw">跟踪</em>，它将把选定的事件存储到AWS S3桶中，并可以将它们发送到AWS CloudWatch，在CloudWatch中，我们可以配置警报来接收通知。</p><p id="a914" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">这些踪迹可以有两种类型:应用于所有AWS区域的全局踪迹，以及仅用于一个选定区域的局部踪迹。参见【CloudTrail在地区和全球的表现如何？</p><p id="e16f" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">因此，在这篇文章中，我们将进一步了解AWS CloudTrail及其特性，将配置导出到CloudWatch，并将通过Opsgenie创建警报和通知到Slack。</p><ul class=""><li id="535f" class="ky kz iq ka b kb kc kf kg kj la kn lb kr lc kv ld le lf lg bi translated"><a class="ae kx" href="https://rtfm.co.ua/en/aws-cloudtrail-overview-and-integration-with-cloudwatch-and-opsgenie/#AWS_CloudTrail_Events" rel="noopener ugc nofollow" target="_blank"> AWS CloudTrail事件</a></li><li id="df61" class="ky kz iq ka b kb lh kf li kj lj kn lk kr ll kv ld le lf lg bi translated"><a class="ae kx" href="https://rtfm.co.ua/en/aws-cloudtrail-overview-and-integration-with-cloudwatch-and-opsgenie/#Management_events" rel="noopener ugc nofollow" target="_blank">管理事件</a></li><li id="5946" class="ky kz iq ka b kb lh kf li kj lj kn lk kr ll kv ld le lf lg bi translated"><a class="ae kx" href="https://rtfm.co.ua/en/aws-cloudtrail-overview-and-integration-with-cloudwatch-and-opsgenie/#Data_events" rel="noopener ugc nofollow" target="_blank">数据事件</a></li><li id="5277" class="ky kz iq ka b kb lh kf li kj lj kn lk kr ll kv ld le lf lg bi translated"><a class="ae kx" href="https://rtfm.co.ua/en/aws-cloudtrail-overview-and-integration-with-cloudwatch-and-opsgenie/#Insights_events" rel="noopener ugc nofollow" target="_blank">洞见事件</a></li><li id="89a3" class="ky kz iq ka b kb lh kf li kj lj kn lk kr ll kv ld le lf lg bi translated"><a class="ae kx" href="https://rtfm.co.ua/en/aws-cloudtrail-overview-and-integration-with-cloudwatch-and-opsgenie/#CloudTrail_trail" rel="noopener ugc nofollow" target="_blank"> CloudTrail步道</a></li><li id="6c13" class="ky kz iq ka b kb lh kf li kj lj kn lk kr ll kv ld le lf lg bi translated"><a class="ae kx" href="https://rtfm.co.ua/en/aws-cloudtrail-overview-and-integration-with-cloudwatch-and-opsgenie/#Create_a_CloudTrail_trail" rel="noopener ugc nofollow" target="_blank">创建CloudTrail踪迹</a></li><li id="8995" class="ky kz iq ka b kb lh kf li kj lj kn lk kr ll kv ld le lf lg bi translated"><a class="ae kx" href="https://rtfm.co.ua/en/aws-cloudtrail-overview-and-integration-with-cloudwatch-and-opsgenie/#CloudTrail_and_CloudWatch_integration" rel="noopener ugc nofollow" target="_blank"> CloudTrail和CloudWatch集成</a></li><li id="f26d" class="ky kz iq ka b kb lh kf li kj lj kn lk kr ll kv ld le lf lg bi translated"><a class="ae kx" href="https://rtfm.co.ua/en/aws-cloudtrail-overview-and-integration-with-cloudwatch-and-opsgenie/#Create_an_AWS_CloudWatch_custom_metric" rel="noopener ugc nofollow" target="_blank">创建一个AWS CloudWatch自定义指标</a></li><li id="4e7a" class="ky kz iq ka b kb lh kf li kj lj kn lk kr ll kv ld le lf lg bi translated"><a class="ae kx" href="https://rtfm.co.ua/en/aws-cloudtrail-overview-and-integration-with-cloudwatch-and-opsgenie/#Opsgenie_and_AWS_Simple_Notifications_Service" rel="noopener ugc nofollow" target="_blank"> Opsgenie和AWS简单通知服务</a></li><li id="4559" class="ky kz iq ka b kb lh kf li kj lj kn lk kr ll kv ld le lf lg bi translated"><a class="ae kx" href="https://rtfm.co.ua/en/aws-cloudtrail-overview-and-integration-with-cloudwatch-and-opsgenie/#Create_an_AWS_CloudWatch_Alarm" rel="noopener ugc nofollow" target="_blank">创建一个AWS CloudWatch警报</a></li><li id="f797" class="ky kz iq ka b kb lh kf li kj lj kn lk kr ll kv ld le lf lg bi translated"><a class="ae kx" href="https://rtfm.co.ua/en/aws-cloudtrail-overview-and-integration-with-cloudwatch-and-opsgenie/#Opsgenie_and_custom_fields_from_AWS_SNS" rel="noopener ugc nofollow" target="_blank">来自AWS SNS的Opsgenie和自定义字段</a></li></ul><h1 id="1eb7" class="lm ln iq bd lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj bi translated">AWS CloudTrail事件</h1><p id="6c9f" class="pw-post-body-paragraph jy jz iq ka b kb mk kd ke kf ml kh ki kj mm kl km kn mn kp kq kr mo kt ku kv ij bi translated">参见<a class="ae kx" href="https://docs.aws.amazon.com/awscloudtrail/latest/userguide/cloudtrail-concepts.html#cloudtrail-concepts-events" rel="noopener ugc nofollow" target="_blank">什么是CloudTrail事件？</a>和<a class="ae kx" href="https://docs.aws.amazon.com/awscloudtrail/latest/userguide/logging-management-events-with-cloudtrail.html" rel="noopener ugc nofollow" target="_blank">小道日志管理事件</a>。</p><p id="33ec" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">CloudTrail中的<em class="kw">事件</em>是AWS帐户中任何活动的记录。事件可以分为三种:<em class="kw">管理事件</em>，<em class="kw">数据事件</em>，<em class="kw">洞察事件</em>。</p><h2 id="5799" class="mp ln iq bd lo mq mr dn ls ms mt dp lw kj mu mv ma kn mw mx me kr my mz mi na bi translated">管理事件</h2><p id="21b0" class="pw-post-body-paragraph jy jz iq ka b kb mk kd ke kf ml kh ki kj mm kl km kn mn kp kq kr mo kt ku kv ij bi translated">管理事件是在AWS资源上执行的任何操作，也称为<em class="kw">控制平面操作，</em>例如:</p><ul class=""><li id="5c51" class="ky kz iq ka b kb kc kf kg kj la kn lb kr lc kv ld le lf lg bi translated">安全操作(例如，<code class="fe nb nc nd ne b">AttachRolePolicy</code> API调用)</li><li id="86a7" class="ky kz iq ka b kb lh kf li kj lj kn lk kr ll kv ld le lf lg bi translated">新资源创建(例如，<code class="fe nb nc nd ne b">CreateDefaultVpc</code> API调用)</li><li id="0b2c" class="ky kz iq ka b kb lh kf li kj lj kn lk kr ll kv ld le lf lg bi translated">网络配置更新(例如，<code class="fe nb nc nd ne b">CreateSubnet</code> API调用)</li><li id="9ff3" class="ky kz iq ka b kb lh kf li kj lj kn lk kr ll kv ld le lf lg bi translated">记录配置更改(例如，<code class="fe nb nc nd ne b">CreateTrail</code> API调用)</li></ul><p id="5374" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">此外，它还包括非API调用，如登录AWS管理控制台，请参见CloudTrail捕获的<a class="ae kx" href="https://docs.aws.amazon.com/awscloudtrail/latest/userguide/cloudtrail-non-api-events.html" rel="noopener ugc nofollow" target="_blank">非API事件</a>。</p><p id="fd7d" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">同样，这些事件可以是关于<em class="kw">读</em>或<em class="kw">写</em>的API调用。读操作是只请求关于AWS资源的信息的操作(例如，<code class="fe nb nc nd ne b">DescribeSubnets</code>)，而写任意修改请求(例如，<code class="fe nb nc nd ne b">TerminateInstances</code>，参见<a class="ae kx" href="https://docs.aws.amazon.com/awscloudtrail/latest/userguide/logging-management-events-with-cloudtrail.html#read-write-events-mgmt" rel="noopener ugc nofollow" target="_blank">读写事件</a>。</p><h2 id="e98a" class="mp ln iq bd lo mq mr dn ls ms mt dp lw kj mu mv ma kn mw mx me kr my mz mi na bi translated">数据事件</h2><p id="8d2b" class="pw-post-body-paragraph jy jz iq ka b kb mk kd ke kf ml kh ki kj mm kl km kn mn kp kq kr mo kt ku kv ij bi translated">参见<a class="ae kx" href="https://docs.aws.amazon.com/awscloudtrail/latest/userguide/logging-data-events-with-cloudtrail.html#logging-data-events" rel="noopener ugc nofollow" target="_blank">数据事件</a>。</p><p id="51a8" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">这些是关于具体AWS资源内操作的信息，也称为<em class="kw">数据平面操作</em>，例如:</p><ul class=""><li id="73f9" class="ky kz iq ka b kb kc kf kg kj la kn lb kr lc kv ld le lf lg bi translated">S3桶操作如<code class="fe nb nc nd ne b">GetObject</code>、<code class="fe nb nc nd ne b">DeleteObject,</code>、<code class="fe nb nc nd ne b">PutObject</code></li><li id="4734" class="ky kz iq ka b kb lh kf li kj lj kn lk kr ll kv ld le lf lg bi translated">AWS Lambda函数调用</li><li id="08ff" class="ky kz iq ka b kb lh kf li kj lj kn lk kr ll kv ld le lf lg bi translated">亚马逊DynamoDB操作如<code class="fe nb nc nd ne b">PutItem</code>、<code class="fe nb nc nd ne b">DeleteItem</code>、и <code class="fe nb nc nd ne b">UpdateItem</code></li></ul><p id="330c" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">默认情况下不会记录，创建踪迹时必须启用。</p><h2 id="b460" class="mp ln iq bd lo mq mr dn ls ms mt dp lw kj mu mv ma kn mw mx me kr my mz mi na bi translated">洞察事件</h2><p id="b912" class="pw-post-body-paragraph jy jz iq ka b kb mk kd ke kf ml kh ki kj mm kl km kn mn kp kq kr mo kt ku kv ij bi translated">CloudTrail Insights将监视异常，如果发现异常，将创建CloudTrail事件。</p><p id="4c76" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">这种异常可能是对AWS S3存储桶的异常数量的删除API调用，或者像<code class="fe nb nc nd ne b">AuthorizeSecurityGroupIngress</code>这样的过高(或过低)调用。</p><h1 id="1d6a" class="lm ln iq bd lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj bi translated">云迹步道</h1><p id="0c6f" class="pw-post-body-paragraph jy jz iq ka b kb mk kd ke kf ml kh ki kj mm kl km kn mn kp kq kr mo kt ku kv ij bi translated">如上所述，<em class="kw"> trail </em>可以存储超过90天的事件，并且可以与CloudTrail和CloudWatch集成。此外，它可以收集所有地区的数据，而CloudTrail Dashboard只显示当前地区的信息。</p><h2 id="d530" class="mp ln iq bd lo mq mr dn ls ms mt dp lw kj mu mv ma kn mw mx me kr my mz mi na bi translated">创建CloudTrail踪迹</h2><p id="cc00" class="pw-post-body-paragraph jy jz iq ka b kb mk kd ke kf ml kh ki kj mm kl km kn mn kp kq kr mo kt ku kv ij bi translated">转到<em class="kw">轨迹</em>，点击<em class="kw">创建轨迹</em>按钮:</p><figure class="ng nh ni nj gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nf"><img src="../Images/87c8f8784b70c688da9ef67d4627be6c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*w3LOPLAGticySZ-Y.png"/></div></div></figure><p id="bae0" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">设置它的名字，选择<em class="kw">创建新的S3桶</em>，指定它的名字，现在禁用它的数据加密:</p><figure class="ng nh ni nj gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nk"><img src="../Images/1f4637718cc70b0af8260f1c5098b7ab.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*ljIATqR4omc1SXIK.png"/></div></div></figure><p id="e672" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">要配置警报，请启用向AWS CloudWatch日志发送事件:</p><figure class="ng nh ni nj gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nl"><img src="../Images/0e3652039453222bbba8d2d064fb29c9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*xrvPOC7QfUr4d_-S.png"/></div></div></figure><p id="81c8" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">离开<em class="kw">管理事件</em>并启用<em class="kw">洞察</em>。</p><p id="3361" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">对于<em class="kw">管理事件</em>启用读写，对于<em class="kw">洞察事件</em>启用<em class="kw"> API调用速率</em>:</p><figure class="ng nh ni nj gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nm"><img src="../Images/b9cdcf2e4ab990cadec0700ec2c425b8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*ixGPszc-Eq3pz19u.png"/></div></div></figure><p id="c28b" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">检查CloudWatch日志中的数据:</p><figure class="ng nh ni nj gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nn"><img src="../Images/aed46c43bbbc83c537ca2996bfbf8e66.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*XzTlTed2lqDYbxAA.png"/></div></div></figure><p id="0361" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">现在，我们可以从这些事件中创建CloudWatch指标并配置警报。</p><h1 id="d391" class="lm ln iq bd lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj bi translated">CloudTrail和CloudWatch集成</h1><p id="cc40" class="pw-post-body-paragraph jy jz iq ka b kb mk kd ke kf ml kh ki kj mm kl km kn mn kp kq kr mo kt ku kv ij bi translated">接下来，让我们基于CloudTrail事件创建一个新的CLoudWatch指标，然后将配置一个警报，该警报将向AWS简单通知服务(SNS)发送通知，该服务又将通知转发给Opsgenie，我们将从那里接收消息到Slack。</p><p id="5e94" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">有一个问题，哪些赛事是我们真正需要观看的。这可以通过“<em class="kw"> cloudtrail security alerts </em>”查询进行谷歌搜索，该查询将提供两个有趣的资料——Splunk中的<a class="ae kx" href="https://www.chrisfarris.com/post/reinforce-threat-hunting/" rel="noopener ugc nofollow" target="_blank">使用cloudtrail和GuardDuty搜索威胁，以及</a><a class="ae kx" href="https://www.gorillastack.com/blog/real-time-events/important-aws-cloudtrail-security-events-tracking/" rel="noopener ugc nofollow" target="_blank">在AWS </a>中监控安全的关键CloudTrail事件，或者只查看<a class="ae kx" href="https://docs.aws.amazon.com/awscloudtrail/latest/userguide/use-cloudformation-template-to-create-cloudwatch-alarms.html" rel="noopener ugc nofollow" target="_blank">使用AWS CloudFormation模板创建CloudWatch警报</a>中的示例。</p><p id="92be" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">为了便于使用，我们将使用以下内容:</p><ul class=""><li id="eab3" class="ky kz iq ka b kb kc kf kg kj la kn lb kr lc kv ld le lf lg bi translated">在我们办公室之外登录AWS控制台(作为这里的办公室IP示例—8 . 8 . 8):<code class="fe nb nc nd ne b">{ ($.eventName = ConsoleLogin) &amp;&amp; ($.sourceIPAddress != "8.8.8.8") }</code></li><li id="9a07" class="ky kz iq ka b kb lh kf li kj lj kn lk kr ll kv ld le lf lg bi translated">登录AWS控制台的根用户:<code class="fe nb nc nd ne b">{ ($.eventName = ConsoleLogin) &amp;&amp; ($.userIdentity.type = "Root") }</code></li><li id="0145" class="ky kz iq ka b kb lh kf li kj lj kn lk kr ll kv ld le lf lg bi translated">出现错误的AWS控制台登录:<code class="fe nb nc nd ne b">{ ($.eventName = ConsoleLogin) &amp;&amp; ($.errorMessage = "Failed authentication") }</code></li><li id="faef" class="ky kz iq ka b kb lh kf li kj lj kn lk kr ll kv ld le lf lg bi translated">未经授权的操作:<code class="fe nb nc nd ne b">{ ($.errorCode = "*UnauthorizedOperation") || ($.errorCode = "AccessDenied*") }</code></li><li id="abbd" class="ky kz iq ka b kb lh kf li kj lj kn lk kr ll kv ld le lf lg bi translated">例如，我们团队使用的最大类型是c5.4xlarge : <code class="fe nb nc nd ne b">{ ($.eventName = RunInstances) &amp;&amp; (($.requestParameters.instanceType = *.8xlarge) || ($.requestParameters.instanceType = *.4xlarge)) }</code></li><li id="bcf9" class="ky kz iq ka b kb lh kf li kj lj kn lk kr ll kv ld le lf lg bi translated">新IAM用户创建:<code class="fe nb nc nd ne b">{ $.eventName="CreateUser" }</code></li></ul><p id="64e2" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">参见<a class="ae kx" href="https://docs.aws.amazon.com/AmazonCloudWatch/latest/logs/FilterAndPatternSyntax.html" rel="noopener ugc nofollow" target="_blank">过滤器和模式语法</a>。</p><p id="df20" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">首先，让我们创建一个关于任何AWS控制台登录的简单警报</p><p id="4590" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">首先，看看事件中的登录是什么样子的:登录到您的帐户，等待10-15分钟，根据<em class="kw">事件名称</em> == <code class="fe nb nc nd ne b">ConsoleLogin</code>进行过滤:</p><figure class="ng nh ni nj gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi no"><img src="../Images/f03fc916ad6952536cc1718388c9be83.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*56eejZ2_6AxEqam-.png"/></div></div></figure><h2 id="53fd" class="mp ln iq bd lo mq mr dn ls ms mt dp lw kj mu mv ma kn mw mx me kr my mz mi na bi translated">创建AWS CloudWatch自定义指标</h2><p id="15ea" class="pw-post-body-paragraph jy jz iq ka b kb mk kd ke kf ml kh ki kj mm kl km kn mn kp kq kr mo kt ku kv ij bi translated">回到上面的日志组创建，在<em class="kw">度量过滤器</em>选项卡上点击<em class="kw">创建度量过滤器</em>。</p><p id="3af2" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在<em class="kw">过滤模式</em>中使用<code class="fe nb nc nd ne b">{ ($.eventName = ConsoleLogin) }</code>:</p><figure class="ng nh ni nj gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi np"><img src="../Images/405c13b90c7cc91c9c79318eceb8afa0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*40mK4owyliM1C8aj.png"/></div></div></figure><p id="3680" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">填充其字段:</p><figure class="ng nh ni nj gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nq"><img src="../Images/d22eab0b49116d2ad63a97c4e3eb751d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*2I9EA3s-gN6xMlnf.png"/></div></div></figure><p id="bd2a" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">检查图表上的指标:</p><figure class="ng nh ni nj gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nr"><img src="../Images/1baee3bae349a0913d252d365c9e7e8c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*rzP4dO1apOKtqKBs.png"/></div></div></figure><h2 id="5c21" class="mp ln iq bd lo mq mr dn ls ms mt dp lw kj mu mv ma kn mw mx me kr my mz mi na bi translated">Opsgenie和AWS简单通知服务</h2><p id="a704" class="pw-post-body-paragraph jy jz iq ka b kb mk kd ke kf ml kh ki kj mm kl km kn mn kp kq kr mo kt ku kv ij bi translated">转到AWS SNS，使用<em class="kw">standard</em>类型创建一个新的SNS主题:</p><figure class="ng nh ni nj gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi ns"><img src="../Images/76121f39baea28401d088f395a34a989.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*y0UdHOy_QhgRXJtR.png"/></div></div></figure><p id="4807" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在Opsginie <em class="kw">整合列表</em>中找到<em class="kw">即将发布的亚马逊社交网站</em>:</p><figure class="ng nh ni nj gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nt"><img src="../Images/0960e7d31124d3e18db3d09ab16eee83.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*QLddYa-jjMZ7p_cD.png"/></div></div></figure><p id="2976" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">保存集成，保存API键:</p><figure class="ng nh ni nj gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nu"><img src="../Images/e4f19ee4a140787c27c8dab0291cac61.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*-rGEWiQ5ShgdKuPu.png"/></div></div></figure><p id="d577" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">回到SNS，点击<em class="kw">创建订阅</em>，选择<em class="kw"> HTTPS </em>，设置Opsgenie提供的URL和API key:</p><figure class="ng nh ni nj gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nv"><img src="../Images/29d702e72065dea5bc0d0799c8cf02ea.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*HjdTNmgndjcupYjd.png"/></div></div></figure><p id="59fc" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">收到订阅已确认的通知:</p><figure class="ng nh ni nj gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nw"><img src="../Images/1ac308b579669bfe72718552e34e602c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*rGh3Xr36GzgyXjWT.png"/></div></div></figure><h2 id="8478" class="mp ln iq bd lo mq mr dn ls ms mt dp lw kj mu mv ma kn mw mx me kr my mz mi na bi translated">创建AWS CloudWatch警报</h2><p id="cd67" class="pw-post-body-paragraph jy jz iq ka b kb mk kd ke kf ml kh ki kj mm kl km kn mn kp kq kr mo kt ku kv ij bi translated">转到<em class="kw">报警</em>，点击<em class="kw">创建报警</em>:</p><figure class="ng nh ni nj gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nx"><img src="../Images/12003581ca2eb26cfd62757827d5dad5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*mXa_1qcF_cXcFx4L.png"/></div></div></figure><p id="4a11" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">选择一个指标:</p><figure class="ng nh ni nj gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi ny"><img src="../Images/1449d9e46d94906c3af4178410d14c74.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*ZGSiegJv5f_YNtxk.png"/></div></div></figure><figure class="ng nh ni nj gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nz"><img src="../Images/a6934da37a68d3767123e72134587078.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*pb3kKf-WKE6-PQZd.png"/></div></div></figure><p id="f28e" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">描述警报的条件:—大于或等于1个事件(每次登录时发出警报):</p><figure class="ng nh ni nj gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi oa"><img src="../Images/1a1a4cde66dc9655ec05ac8733fa25db.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*75BmJXExqn29T81R.png"/></div></div></figure><p id="44b3" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">配置向上面创建的SNS主题发送通知:</p><figure class="ng nh ni nj gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi ob"><img src="../Images/d105f0c1a753006be6417ff4b4ee8bc9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*ofjhpooZnlV59adp.png"/></div></div></figure><p id="d4d4" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">设置提醒的名称，并保存它:</p><figure class="ng nh ni nj gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi oc"><img src="../Images/355197e74de642b437ffaa8a85969d8b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*ADUk2lxRvsBE_x5z.png"/></div></div></figure><p id="22a6" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">几分钟后检查它的状态:它将变成<em class="kw">ок</em>而不是<em class="kw">数据不足</em>(或者如果有登录，则变成<em class="kw">报警</em>):</p><figure class="ng nh ni nj gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi od"><img src="../Images/7fba93f9518bf519901cb976b395b09e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*phNAZFtNkUp52-sd.png"/></div></div></figure><p id="0a26" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">登录AWS控制台，等待10-15分钟的CloudTrail事件，您将触发警报:</p><figure class="ng nh ni nj gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi oe"><img src="../Images/48d48ad63f3249575880547dedf24070.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*DuGyr4r7QYTPHjqy.png"/></div></div></figure><p id="11c9" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">以及空闲时的警报:</p><figure class="ng nh ni nj gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi of"><img src="../Images/8d692b049f60f7ff1baa4591362ce5ce.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*rohMR5xd72P07-I9.png"/></div></div></figure><h2 id="5b61" class="mp ln iq bd lo mq mr dn ls ms mt dp lw kj mu mv ma kn mw mx me kr my mz mi na bi translated">来自AWS SNS的Opsgenie和自定义字段</h2><p id="6eca" class="pw-post-body-paragraph jy jz iq ka b kb mk kd ke kf ml kh ki kj mm kl km kn mn kp kq kr mo kt ku kv ij bi translated">我想做的是过滤Slack的消息文本，只显示自定义字段。</p><p id="69e5" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">这可以通过<a class="ae kx" href="https://support.atlassian.com/opsgenie/docs/string-processing-methods-in-opsgenie-integrations/" rel="noopener ugc nofollow" target="_blank">操作通用字符串函数</a>来完成。</p><p id="5987" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">进入<em class="kw">传入SNS </em>整合，点击<em class="kw">高级</em>:</p><figure class="ng nh ni nj gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi og"><img src="../Images/28219d70acdc29161160c0ddbcaba7e4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*bNjzz1Kka2gx0bxp.png"/></div></div></figure><p id="5f74" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在<em class="kw">描述</em>字段中添加<code class="fe nb nc nd ne b">Message.extract()</code>调用:</p><pre class="ng nh ni nj gt oh ne oi oj aw ok bi"><span id="4cd8" class="mp ln iq ne b gy ol om l on oo">{{Message.extract(/AlarmDescription":"(.+)","AWSAccountId"/)}}<br/><br/>AWS account ID: {{Message.extract(/AWSAccountId":"(.+)","NewStateValue"/)}}<br/><br/>AWS region: {{Message.extract(/Region":"(.+)","AlarmArn"/)}}</span></pre><figure class="ng nh ni nj gt jr gh gi paragraph-image"><div class="gh gi op"><img src="../Images/16f20f1409671811d4a4f29b55ab1af1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1054/format:webp/0*AfDmVP0wZzEfBePx.png"/></div></figure><p id="0b05" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">现在，当Opsgenie将从AWS SNS接收JSON中的消息时，它将只从那里获取三个字段— <code class="fe nb nc nd ne b">AlarmDescription</code>、<code class="fe nb nc nd ne b">AWSAccountId</code>和<code class="fe nb nc nd ne b">Region</code>，因此，我们将在Slack alarm的消息中看到下一种形式:</p><figure class="ng nh ni nj gt jr gh gi paragraph-image"><div class="gh gi oq"><img src="../Images/d63dcb5fe0eb1e09b85380c430f1e4b8.png" data-original-src="https://miro.medium.com/v2/resize:fit:978/format:webp/0*yJwIJo4_NCVwdOA0.png"/></div></figure><p id="4cbb" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">完成了。</p></div><div class="ab cl or os hu ot" role="separator"><span class="ou bw bk ov ow ox"/><span class="ou bw bk ov ow ox"/><span class="ou bw bk ov ow"/></div><div class="ij ik il im in"><p id="992b" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><em class="kw">最初发布于</em> <a class="ae kx" href="https://rtfm.co.ua/en/aws-cloudtrail-overview-and-integration-with-cloudwatch-and-opsgenie/" rel="noopener ugc nofollow" target="_blank"> <em class="kw"> RTFM: Linux、DevOps、系统管理</em> </a> <em class="kw">。</em></p></div></div>    
</body>
</html>