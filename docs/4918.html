<html>
<head>
<title>ArgoCD: Setup external clusters by name</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">ArgoCD:按名称设置外部集群</h1>
<blockquote>原文：<a href="https://itnext.io/argocd-setup-external-clusters-by-name-d3d58a53acb0?source=collection_archive---------0-----------------------#2020-10-24">https://itnext.io/argocd-setup-external-clusters-by-name-d3d58a53acb0?source=collection_archive---------0-----------------------#2020-10-24</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="45f6" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">ArgoCD可能是我们目前可以使用的最先进的GitOps工具。它出现在2020年5月版的<a class="ae kl" href="https://www.thoughtworks.com/radar/platforms/argo-cd" rel="noopener ugc nofollow" target="_blank"> Thoughtworks雷达的试验象限中，也是从2020年6月</a>开始在ass上的<a class="ae kl" href="https://radar.cncf.io/2020-06-continuous-delivery" rel="noopener ugc nofollow" target="_blank"> CNCF连续交付雷达的一部分。该项目于2020年4月</a>获准进入<a class="ae kl" href="https://www.cncf.io/blog/2020/04/07/toc-welcomes-argo-into-the-cncf-incubator/" rel="noopener ugc nofollow" target="_blank"> CNCF，此后吸引了越来越多的用户和贡献者。</a></p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="ks kt di ku bf kv"><div class="gh gi km"><img src="../Images/b2860285c2faa8a0b328e0b3c7234548.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*RgMWYxzOW5dJaslhW3wJ4Q.png"/></div></div></figure><p id="3742" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">当我写这篇文章时，ArgoCD的最新版本是2020年8月25日发布的<a class="ae kl" href="https://github.com/argoproj/argo-cd/releases/tag/v1.7.0" rel="noopener ugc nofollow" target="_blank"> 1.7.0 </a>。它有许多新特性，其中两个似乎更有趣:只使用签名提交应用状态更改的能力，并允许应用程序目标使用集群名称(在以前的版本中，您只能使用集群url)。接下来，我将通过一些例子来说明如何使用集群名称来代替url。这可以提供更好的用户体验，因为在使用EKS或AKS等托管服务时，有时会生成集群URL，所以很难知道这是您应用的开发集群还是生产集群。虽然这个特性看起来很容易使用，只需传递集群名称而不是url，但是它有一些需要注意的问题。</p><p id="91ee" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">以下命令所需的所有文件都可以在这个报告中找到:<a class="ae kl" href="https://github.com/lcostea/argocd-cluster-name-article" rel="noopener ugc nofollow" target="_blank">https://github.com/lcostea/argocd-cluster-name-article</a>。所以请克隆它，然后cd到它:</p><pre class="kn ko kp kq gt ky kz la lb aw lc bi"><span id="75c4" class="ld le iq kz b gy lf lg l lh li">git clone <a class="ae kl" href="https://github.com/lcostea/argocd-cluster-name-article.git" rel="noopener ugc nofollow" target="_blank">https://github.com/lcostea/argocd-cluster-name-article.git</a><br/>cd <a class="ae kl" href="https://github.com/lcostea/argocd-cluster-name-article.git" rel="noopener ugc nofollow" target="_blank">argocd-cluster-name-article</a></span></pre><h2 id="e22c" class="ld le iq bd lj lk ll dn lm ln lo dp lp jy lq lr ls kc lt lu lv kg lw lx ly lz bi translated">安装ArgoCD 1.7.8</h2><p id="76b0" class="pw-post-body-paragraph jn jo iq jp b jq ma js jt ju mb jw jx jy mc ka kb kc md ke kf kg me ki kj kk ij bi translated">首先，让我们安装ArgoCD 1.7.8，这是最新的补丁。我在本地安装了kind，所以我将运行一个新的集群。如果你没有kind，<a class="ae kl" href="https://kind.sigs.k8s.io/docs/user/quick-start/#installation" rel="noopener ugc nofollow" target="_blank">这里有安装说明</a>。</p><pre class="kn ko kp kq gt ky kz la lb aw lc bi"><span id="44ec" class="ld le iq kz b gy lf lg l lh li">kind create cluster --name argocd1.7</span></pre><p id="e9b3" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在集群启动并运行并且您的上下文指向它之后，我们将安装argocd，首先创建“argocd”命名空间，然后我们将应用1.7.8清单(请坚持使用此ArgoCD命名空间，其他名称将在直接使用清单而不是kustomize时产生问题):</p><pre class="kn ko kp kq gt ky kz la lb aw lc bi"><span id="cf01" class="ld le iq kz b gy lf lg l lh li">kubectl create namespace argocd</span><span id="6715" class="ld le iq kz b gy mf lg l lh li">kubectl apply -n argocd -f https://raw.githubusercontent.com/argoproj/argo-cd/v1.7.8/manifests/install.yaml</span></pre><p id="65e0" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">接下来，让我们检查所有的pod是否都已启动并运行，一旦它们启动，我们就可以尝试连接到ArgoCD UI</p><pre class="kn ko kp kq gt ky kz la lb aw lc bi"><span id="5efb" class="ld le iq kz b gy lf lg l lh li">#wait for all pods to be running<br/>kubectl get pod -n argocd<br/>kubectl port-forward svc/argocd-server -n argocd 8083:80</span></pre><p id="0790" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在localhost:8083上打开浏览器，如果证书上有任何警报，应该没问题，因为它是自己生成的。在用户名上输入“admin”，而密码可以通过运行该命令获得(它是服务器pod的名称):</p><pre class="kn ko kp kq gt ky kz la lb aw lc bi"><span id="a1c5" class="ld le iq kz b gy lf lg l lh li">kubectl get pods -n argocd -l app.kubernetes.io/name=argocd-server -o name | cut -d’/’ -f 2</span></pre><h2 id="1041" class="ld le iq bd lj lk ll dn lm ln lo dp lp jy lq lr ls kc lt lu lv kg lw lx ly lz bi translated">第一个具有群集名称的应用程序</h2><p id="8a40" class="pw-post-body-paragraph jn jo iq jp b jq ma js jt ju mb jw jx jy mc ka kb kc md ke kf kg me ki kj kk ij bi translated">在用户界面上，你应该会看到一条类似“还没有应用程序”的消息。因此，让我们创建一个，我们将使用集群名称，而不是url。即使在本地集群上部署应用程序，我们也可以使用这个名称。该应用程序将如下所示:</p><figure class="kn ko kp kq gt kr"><div class="bz fp l di"><div class="mg mh l"/></div></figure><pre class="kn ko kp kq gt ky kz la lb aw lc bi"><span id="f785" class="ld le iq kz b gy lf lg l lh li">kubectl create namespace guestbook</span><span id="7cd2" class="ld le iq kz b gy mf lg l lh li"># the file is located in the repo you cloned when we started<br/>kubectl apply -n argocd -f local-server-guestbook-app.yaml</span></pre><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="ks kt di ku bf kv"><div class="gh gi mi"><img src="../Images/df426a99546c5025d7366360e3cadd95.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*jNQg3CviNXr6Dcs2ShOEhQ.png"/></div></div><figcaption class="mj mk gj gh gi ml mm bd b be z dk translated">ArgoCD用户界面中显示的本地服务器留言簿应用程序</figcaption></figure><p id="6acd" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">因此，您可以看到如何为本地集群使用name:</p><pre class="kn ko kp kq gt ky kz la lb aw lc bi"><span id="37b5" class="ld le iq kz b gy lf lg l lh li">name: in-cluster</span></pre><p id="b745" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这应该比</p><pre class="kn ko kp kq gt ky kz la lb aw lc bi"><span id="d662" class="ld le iq kz b gy lf lg l lh li">server: <a class="ae kl" href="https://kubernetes.default.svc" rel="noopener ugc nofollow" target="_blank">https://kubernetes.default.svc</a></span></pre><p id="d801" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在，您可以在ArgoCD UI中看到状态为OutOfSync的应用程序。你可以等待ArgoCD自动同步它，或者如果你不想等待，请使用应用程序上的同步按钮。同步后，您可以在UI中看到所有组件，如部署、服务、复制集、pod。</p><h2 id="511c" class="ld le iq bd lj lk ll dn lm ln lo dp lp jy lq lr ls kc lt lu lv kg lw lx ly lz bi translated">使用cli连接到ArgoCD</h2><p id="ec98" class="pw-post-body-paragraph jn jo iq jp b jq ma js jt ju mb jw jx jy mc ka kb kc md ke kf kg me ki kj kk ij bi translated">在创建第二个集群之前，我们将使用cli连接到我们的1.7.8实例。首先让我们下载argocd cli，您可以在此页面找到所有操作系统的<a class="ae kl" href="https://argoproj.github.io/argo-cd/cli_installation/" rel="noopener ugc nofollow" target="_blank">说明。在我们有了可用的cli之后，我们将把它连接到我们的argocd 1.7.8安装(我们假设端口转发仍然在工作)。您将使用设置与UI中使用的密码相同的密码:</a></p><pre class="kn ko kp kq gt ky kz la lb aw lc bi"><span id="b4bb" class="ld le iq kz b gy lf lg l lh li">argocd login localhost:8083 --username admin --password &lt;same_password_used_in_ui&gt;</span></pre><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="ks kt di ku bf kv"><div class="gh gi mn"><img src="../Images/a1188d96017383514b38a8ba55792c6e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*VYWGN3YVLcBZSTE_1B4Y9g.png"/></div></div></figure><p id="dd42" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">您可能会得到一个关于服务器证书的错误，在这种情况下，可以继续操作(通过键入“<em class="mo">y”</em>)，因为ArgoCD生成了自己的证书。我们可以通过列出实例上安装的应用程序来测试我们是否已连接:</p><pre class="kn ko kp kq gt ky kz la lb aw lc bi"><span id="b6f3" class="ld le iq kz b gy lf lg l lh li">argocd app list</span></pre><p id="2883" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们应该会看到<em class="mo">本地服务器留言簿应用</em>条目。</p><h2 id="b0c8" class="ld le iq bd lj lk ll dn lm ln lo dp lp jy lq lr ls kc lt lu lv kg lw lx ly lz bi translated">将外部集群添加到ArgoCD</h2><p id="a9ea" class="pw-post-body-paragraph jn jo iq jp b jq ma js jt ju mb jw jx jy mc ka kb kc md ke kf kg me ki kj kk ij bi translated">接下来，我们将需要一个新的集群，ArgoCD可以在其中安装应用程序，所以让我们用kind创建一个新的集群。但在此之前，我们需要为第二个集群创建一个配置文件，以便ArgoCD(安装在第一个集群中)可以连接到它的控制平面。</p><p id="65e7" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">带有kind配置的文件看起来像这样，您可以在名为<em class="mo">kind-dev-cluster-config . YAML</em>的repo中找到它。您需要更新apiServerAddress中的值以匹配您的私有ip。要找到你的IP地址，你可以在Windows上使用<em class="mo"> ipconfig </em>或者在Linux/MacOS上使用<em class="mo"> ifconfig </em>。</p><figure class="kn ko kp kq gt kr"><div class="bz fp l di"><div class="mg mh l"/></div></figure><p id="a66c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在您更新文件之后，我们可以创建第二个集群，我们还将在其中添加一个留言簿名称空间。</p><pre class="kn ko kp kq gt ky kz la lb aw lc bi"><span id="21cb" class="ld le iq kz b gy lf lg l lh li">kind create cluster --name dev-cluster --config kind-dev-cluster-config.yaml</span></pre><p id="17bd" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">集群创建完成后，您可以将其添加到argocd。如果您在上面的配置文件中设置的IP不正确，此步骤将不会成功。请注意，我们将argocd上的集群名称从<em class="mo"> kind-dev-cluster </em>更新为<em class="mo"> dev-cluster </em>。因此上下文名称仍然是<em class="mo"> kind-dev-cluster </em>，而ArgoCD上的集群可以使用<em class="mo"> dev-cluster进行寻址。如果一切正常，我们可以从argocd查询集群列表，在那里我们可以看到新添加的集群。</em></p><pre class="kn ko kp kq gt ky kz la lb aw lc bi"><span id="c836" class="ld le iq kz b gy lf lg l lh li">argocd cluster add kind-dev-cluster --name dev-cluster<br/>argocd cluster list</span></pre><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="ks kt di ku bf kv"><div class="gh gi mp"><img src="../Images/dd89d6e5af1b292aee7c944868f6d61f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*zraNxKq3HBxGZ7BiOgPKvw.png"/></div></div><figcaption class="mj mk gj gh gi ml mm bd b be z dk translated">向ArgoCD添加新集群</figcaption></figure><p id="12fd" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">接下来，我们将把安装在本地集群上的相同应用程序应用到外部集群上。但在此之前，我们需要通过运行以下命令将上下文改回argocd集群:</p><pre class="kn ko kp kq gt ky kz la lb aw lc bi"><span id="baaf" class="ld le iq kz b gy lf lg l lh li">kubectl config use-context kind-argocd1.7</span></pre><h2 id="0063" class="ld le iq bd lj lk ll dn lm ln lo dp lp jy lq lr ls kc lt lu lv kg lw lx ly lz bi translated">将应用程序添加到外部集群</h2><p id="3ddb" class="pw-post-body-paragraph jn jo iq jp b jq ma js jt ju mb jw jx jy mc ka kb kc md ke kf kg me ki kj kk ij bi translated">在应用我们的应用程序之前，我们将使用一个<a class="ae kl" href="https://argoproj.github.io/argo-cd/operator-manual/declarative-setup/#projects" rel="noopener ugc nofollow" target="_blank"> AppProject </a>。这是一个自定义资源，允许我们对一组应用程序设置一些约束。在我们的例子中，我们将允许使用这个AppProject的应用程序只在我们的<em class="mo">开发集群</em>中部署清单，在<em class="mo">留言簿</em>名称空间中，这是在<em class="mo">目的地</em>中指定的部分。但是这里要提到的最重要的一点是，appproject文件中不支持集群名称，这里我们仍然使用集群url。原因是名称可以很容易地更新，而url应该是唯一的(或者至少非常接近)。因此，当我们应用这样一个appproject时，我们希望清楚地识别带有约束的目标集群。</p><p id="d398" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">当然你不需要使用一个特定的appproj，你可以一直依赖默认的那个(就像我们在本地app中使用的)。对于生产安装，仍然推荐使用它们，这是又一层预防措施，不要与其他集群或名称空间混淆。</p><figure class="kn ko kp kq gt kr"><div class="bz fp l di"><div class="mg mh l"/></div></figure><p id="6301" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">带有appproject的文件是<em class="mo">remote-server-guest book-proj . YAML</em>，而应用程序可以在<em class="mo">remote-server-guest book-app . YAML</em>中找到，因此我们可以继续应用它们:</p><pre class="kn ko kp kq gt ky kz la lb aw lc bi"><span id="61ae" class="ld le iq kz b gy lf lg l lh li">kubectl apply -n argocd -f remote-server-guestbook-proj.yaml<br/>kubectl apply -n argocd -f remote-server-guestbook-app.yaml</span></pre><p id="4383" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果你给它几分钟，这个应用程序将自动同步，用户界面应该是这样的:</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="ks kt di ku bf kv"><div class="gh gi mq"><img src="../Images/842e4d80e74b4a85615976f5aff73b25.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*6ktTI9nO_L05D5-GIj9sew.png"/></div></div><figcaption class="mj mk gj gh gi ml mm bd b be z dk translated">包含本地和远程应用程序的ArgoCD</figcaption></figure><p id="d4a7" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">大概就是这样，现在你已经在ArgoCD中添加了一个外部集群，并且应用了一个以它的名字命名的应用。因此，您可以尝试添加更多的应用程序。</p></div></div>    
</body>
</html>