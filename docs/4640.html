<html>
<head>
<title>Virtual Clusters For Kubernetes with Loft v0.3</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Loft v0.3的Kubernetes虚拟集群</h1>
<blockquote>原文：<a href="https://itnext.io/loft-v0-3-virtual-clusters-for-kubernetes-40b2c56918f?source=collection_archive---------2-----------------------#2020-08-11">https://itnext.io/loft-v0-3-virtual-clusters-for-kubernetes-40b2c56918f?source=collection_archive---------2-----------------------#2020-08-11</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><figure class="gl gn jr js jt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi jq"><img src="../Images/f1466b9394827f0a03baafc5d46bfb44.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*QqKQdxSBUQovs48J"/></div></div></figure><p id="35cb" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">我们自豪地宣布,<a class="ae kz" href="https://loft.sh/" rel="noopener ugc nofollow" target="_blank"> loft </a>是第一个为虚拟化Kubernetes集群提供稳定实施的云原生技术。借助loft v0.3，用户现在可以在几秒钟内创建虚拟Kubernetes集群(vClusters)，只需点击UI，使用loft CLI的一个命令，或者使用vCluster CRD(参见最后一段中的示例)。</p><h1 id="5dd5" class="la lb it bd lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx bi translated">loft是什么？</h1><p id="384e" class="pw-post-body-paragraph kb kc it kd b ke ly kg kh ki lz kk kl km ma ko kp kq mb ks kt ku mc kw kx ky im bi translated"><a class="ae kz" href="https://loft.sh" rel="noopener ugc nofollow" target="_blank"> loft </a>是<a class="ae kz" href="https://devspace.cloud" rel="noopener ugc nofollow" target="_blank"> DevSpace Cloud </a>的重新命名和重新架构版本，它让管理员为他们的Kubernetes集群建立了一个名称空间的自助服务系统。在与各种公司合作并帮助他们将自助式Kubernetes名称空间引入他们的工程团队的过程中，我们了解了很多关于IT团队和工程团队之间的紧张关系。虽然系统管理员最关心的是系统的稳定性和安全性，但工程师们努力追求速度，并要求自由地做他们工作所需的任何事情，包括在安装1000多个需要这种集群范围访问的掌舵图中的任何一个时安装CRD和自定义RBAC规则。</p><p id="e0c3" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">loft的v0.3现在用虚拟集群解决了这个问题。方法如下:</p><h1 id="d57a" class="la lb it bd lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx bi translated">什么是虚拟集群？</h1><p id="83c6" class="pw-post-body-paragraph kb kc it kd b ke ly kg kh ki lz kk kl km ma ko kp kq mb ks kt ku mc kw kx ky im bi translated">您可以将虚拟Kubernetes集群想象为运行在另一个集群之上的全功能Kubernetes集群—包含在底层主机集群的单个名称空间中。一个虚拟Kubernetes集群可以像任何其他Kubernetes集群一样使用，使用kubectl、helm或任何客户端工具都可以访问这个虚拟集群的有效kube-context。</p><p id="9b68" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">虚拟集群大致由两部分组成:</p><ul class=""><li id="2380" class="md me it kd b ke kf ki kj km mf kq mg ku mh ky mi mj mk ml bi translated">控制平面(即API服务器、数据库，如etcd和控制器管理器)</li><li id="08e0" class="md me it kd b ke mm ki mn km mo kq mp ku mq ky mi mj mk ml bi translated">实际启动和管理底层主机群集中的容器的同步程序</li></ul><p id="4416" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">虽然虚拟集群使用底层主机集群来实际运行其pod的容器，但虚拟集群有自己的API服务器，用于创建和管理所有Kubernetes资源，如pod、部署、服务、集群角色，甚至名称空间。</p><p id="a8be" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">这意味着，当您在虚拟Kubernetes集群中创建部署时，该部署不会发送到底层主机集群，也不会存储在底层主机集群的etcd存储中。相反，资源将使用虚拟集群的独立API服务器创建，并存储在该虚拟集群的数据库(可能是etcd，甚至是简单的sqlite或mysql数据库)中。为了实际运行此部署的容器，虚拟集群的syncer组件会联系底层主机集群，并在那里创建一个pod，然后正确连接所有设备，以便联网等。会按预期工作。</p><p id="7815" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">与虚拟机类似，虚拟集群应致力于以下目标:</p><ul class=""><li id="3b16" class="md me it kd b ke kf ki kj km mf kq mg ku mh ky mi mj mk ml bi translated">租户应被限制在其虚拟集群内，并且不能访问底层主机。</li><li id="39f9" class="md me it kd b ke mm ki mn km mo kq mp ku mq ky mi mj mk ml bi translated">在同一台主机上运行时，租户不应该知道彼此的存在。</li><li id="ae07" class="md me it kd b ke mm ki mn km mo kq mp ku mq ky mi mj mk ml bi translated">虚拟集群应该能够快速启动，并且易于销毁，不会在底层主机集群上留下任何痕迹。</li></ul><p id="de93" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">如果您想了解loft中虚拟集群实现的更多信息，请查看虚拟集群的<a class="ae kz" href="https://loft.sh/docs/vclusters/basics" rel="noopener ugc nofollow" target="_blank"> loft文档。</a></p><h1 id="4528" class="la lb it bd lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx bi translated">为什么选择虚拟集群？</h1><blockquote class="mr ms mt"><p id="8dd0" class="kb kc mu kd b ke kf kg kh ki kj kk kl mv kn ko kp mw kr ks kt mx kv kw kx ky im bi translated"><strong class="kd iu"><em class="it">TL；博士:</em> </strong> <em class="it">工程师需要能够安装和管理自己的CRDs、RBAC等。将用户限制在名称空间不允许他们这样做，但是虚拟集群可以解决这个问题。</em></p></blockquote><h2 id="fafb" class="my lb it bd lc mz na dn lg nb nc dp lk km nd ne lo kq nf ng ls ku nh ni lw nj bi translated">名称空间是不够的</h2><p id="ddb1" class="pw-post-body-paragraph kb kc it kd b ke ly kg kh ki lz kk kl km ma ko kp kq mb ks kt ku mc kw kx ky im bi translated">还记得90年代吗？网络托管者在共享的Linux机器上提供网络空间，用户可以在那里运行他们的PHP应用程序，只要它与他们的托管者为同一台机器上的所有用户安装的任何PHP版本兼容。我们现在正在对Kubernetes做几乎同样的事情。我们正在给工程团队分发命名空间，希望他们不会抱怨RBAC或CRD缺少的任何东西。</p><p id="a622" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">名称空间是Kubernetes的网络空间——它们是隔离租户及其工作负载的核心构件，它们不足以满足当今高速工程的需求。如果团队可以访问Kubernetes名称空间，他们的访问通常会受到RBAC之类的限制。为此，多租户集群中的用户通常被限制在其名称空间内，并且不能修改任何集群范围的对象。这意味着对于名称空间，工程师:</p><ul class=""><li id="cc27" class="md me it kd b ke kf ki kj km mf kq mg ku mh ky mi mj mk ml bi translated">无法安装CRDs</li><li id="c6c4" class="md me it kd b ke mm ki mn km mo kq mp ku mq ky mi mj mk ml bi translated">无法使用集群范围的CRD</li><li id="1d43" class="md me it kd b ke mm ki mn km mo kq mp ku mq ky mi mj mk ml bi translated">无法修改RBAC规则</li><li id="26bd" class="md me it kd b ke mm ki mn km mo kq mp ku mq ky mi mj mk ml bi translated">大多数时候甚至不能列出它们自己的名称空间</li></ul><p id="40a0" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">虽然所有这些事情对工程团队来说都很烦人，但是这个列表中的第一个问题尤其严重，因为CRD在Kubernetes生态系统中变得越来越重要。无论一个团队想要评估Kubeflow，开始使用knative，还是使用任何其他严重依赖CRD的项目，工程团队都需要能够安装CRD。如果没有能力管理自己的CRD或建立自己的RBAC规则，工程师将无法在Helm Hub上安装90%的舵图表——这是一个问题。如今，如果你想保持竞争力，你需要快速行动。那么，我们该如何解决这个问题呢？</p><h2 id="8ba5" class="my lb it bd lc mz na dn lg nb nc dp lk km nd ne lo kq nf ng ls ku nh ni lw nj bi translated">vClusters比名称空间更强大</h2><p id="0ab4" class="pw-post-body-paragraph kb kc it kd b ke ly kg kh ki lz kk kl km ma ko kp kq mb ks kt ku mc kw kx ky im bi translated">我们可以按照扎克伯格的建议，快速行动，打破常规。然而，我想我们都同意，在各种情况下，这种做法并不奏效。仅仅将管理员权限交给集群，开放我们严格的RBAC设置，以便工程师可以自己安装CRD和RBAC规则，这是一个灾难的处方。</p><p id="1b29" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">在不损坏任何东西的情况下移动东西怎么样？这就是我们努力通过虚拟Kubernetes集群实现的目标。</p><p id="6da8" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">就像虚拟服务器或现代云虚拟机允许我们在相同的物理服务器硬件上托管多个操作系统，同时忽略网络空间的所有问题一样，虚拟Kubernetes集群将允许我们在相同的Kubernetes集群上托管不同的工程团队甚至生产工作负载，而不必限制他们的能力。</p><h1 id="95c9" class="la lb it bd lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx bi translated">如何入门？</h1><p id="d12f" class="pw-post-body-paragraph kb kc it kd b ke ly kg kh ki lz kk kl km ma ko kp kq mb ks kt ku mc kw kx ky im bi translated">如果您现在想亲自尝试vClusters，以下是操作方法:</p><h1 id="55a1" class="la lb it bd lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx bi translated">1.安装放样</h1><p id="2084" class="pw-post-body-paragraph kb kc it kd b ke ly kg kh ki lz kk kl km ma ko kp kq mb ks kt ku mc kw kx ky im bi translated">按照loft文档中的说明<a class="ae kz" href="https://loft.sh/docs/getting-started/setup" rel="noopener ugc nofollow" target="_blank">将loft安装到任何Kubernetes集群</a>。</p><h1 id="f837" class="la lb it bd lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx bi translated">2.创建虚拟集群</h1><p id="0f6a" class="pw-post-body-paragraph kb kc it kd b ke ly kg kh ki lz kk kl km ma ko kp kq mb ks kt ku mc kw kx ky im bi translated"><strong class="kd iu">选项A —通过CLI </strong></p><pre class="nk nl nm nn gt no np nq nr aw ns bi"><span id="3898" class="my lb it np b gy nt nu l nv nw">loft create vcluster my-vcluster-1</span></pre></div><div class="ab cl nx ny hx nz" role="separator"><span class="oa bw bk ob oc od"/><span class="oa bw bk ob oc od"/><span class="oa bw bk ob oc"/></div><div class="im in io ip iq"><p id="0713" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated"><strong class="kd iu">选项B —通过用户界面</strong></p><figure class="nk nl nm nn gt ju"><div class="bz fp l di"><div class="oe of l"/></div><figcaption class="og oh gj gh gi oi oj bd b be z dk translated">使用loft UI创建虚拟集群</figcaption></figure></div><div class="ab cl nx ny hx nz" role="separator"><span class="oa bw bk ob oc od"/><span class="oa bw bk ob oc od"/><span class="oa bw bk ob oc"/></div><div class="im in io ip iq"><p id="4c2a" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated"><strong class="kd iu">选项C——经由CRD </strong></p><p id="bfac" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">查看放样文档，了解更多关于虚拟集群使用<a class="ae kz" href="https://loft.sh/docs/vclusters/basics" rel="noopener ugc nofollow" target="_blank">放样CRDs的信息</a>。</p><h1 id="f08e" class="la lb it bd lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx bi translated">下一步是什么？</h1><p id="3504" class="pw-post-body-paragraph kb kc it kd b ke ly kg kh ki lz kk kl km ma ko kp kq mb ks kt ku mc kw kx ky im bi translated">现在，任何人都可以在几秒钟内创建虚拟Kubernetes集群，我们正在努力支持虚拟集群的一些高级用例，包括:</p><ul class=""><li id="eea1" class="md me it kd b ke kf ki kj km mf kq mg ku mh ky mi mj mk ml bi translated">快照和恢复虚拟集群</li><li id="2fe4" class="md me it kd b ke mm ki mn km mo kq mp ku mq ky mi mj mk ml bi translated">不同Kubernetes集群之间的虚拟集群迁移(例如，从GKE迁移到EKS)</li><li id="d31f" class="md me it kd b ke mm ki mn km mo kq mp ku mq ky mi mj mk ml bi translated">跨不同主机集群的虚拟集群。</li></ul><h1 id="9a96" class="la lb it bd lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx bi translated">取得联系！</h1><p id="6f38" class="pw-post-body-paragraph kb kc it kd b ke ly kg kh ki lz kk kl km ma ko kp kq mb ks kt ku mc kw kx ky im bi translated">如果您对使用虚拟集群感兴趣，请下载loft并立即开始。如果您遇到任何问题或对虚拟集群有任何功能需求，请帮助我们制定路线图并联系我们。我们希望虚拟集群成为Kubernetes多租户的新标准，并计划支持尽可能多的用例。因此，请联系我们，让我们知道您计划如何使用虚拟集群:</p><ul class=""><li id="828f" class="md me it kd b ke kf ki kj km mf kq mg ku mh ky mi mj mk ml bi translated">在推特上关注<a class="ae kz" href="https://twitter.com/loft_sh" rel="noopener ugc nofollow" target="_blank">@ loft _ sh</a></li><li id="b180" class="md me it kd b ke mm ki mn km mo kq mp ku mq ky mi mj mk ml bi translated"><a class="ae kz" href="https://github.com/loft-sh/loft" rel="noopener ugc nofollow" target="_blank"> loft GitHub回购</a>中的未决问题</li><li id="9ae0" class="md me it kd b ke mm ki mn km mo kq mp ku mq ky mi mj mk ml bi translated">通过lg@devspace.cloud (Lukas)给我发邮件</li></ul></div><div class="ab cl nx ny hx nz" role="separator"><span class="oa bw bk ob oc od"/><span class="oa bw bk ob oc od"/><span class="oa bw bk ob oc"/></div><div class="im in io ip iq"><p id="4d1a" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated"><em class="mu">原载于2020年8月11日</em><a class="ae kz" href="https://loft.sh/blog/loft-v0-3-virtual-kubernetes-clusters/" rel="noopener ugc nofollow" target="_blank"><em class="mu">https://loft . sh</em></a><em class="mu">。</em></p></div></div>    
</body>
</html>