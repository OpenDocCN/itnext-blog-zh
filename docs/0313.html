<html>
<head>
<title>ActionCable authentication in a Token-Based Rails API with React</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">基于令牌的Rails API中的ActionCable身份验证</h1>
<blockquote>原文：<a href="https://itnext.io/actioncable-authentication-in-a-token-based-rails-api-f9cc4b8bf560?source=collection_archive---------0-----------------------#2018-02-16">https://itnext.io/actioncable-authentication-in-a-token-based-rails-api-f9cc4b8bf560?source=collection_archive---------0-----------------------#2018-02-16</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/f95ab9b4c25d65a634766e0ad4c32133.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*C2kp5kPIh1I2nFwq1_B12Q.jpeg"/></div></div></figure><p id="b166" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><a class="ae kw" href="http://guides.rubyonrails.org/action_cable_overview.html" rel="noopener ugc nofollow" target="_blank"> Action Cable </a>是Rails应用中的websocket。如果你有一个Rails API并且刚开始使用actioncable，你将需要设置它的认证。</p><p id="bf2d" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><a class="ae kw" href="https://www.linkedin.com/cws/share?url=https%3A%2F%2Fitnext.io%2Factioncable-authentication-in-a-token-based-rails-api-f9cc4b8bf560" rel="noopener ugc nofollow" target="_blank"> <em class="kx">点击这里在LinkedIn </em> </a>上分享这篇文章</p><p id="8c12" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">大多数教程使用会话或cookies来验证ActionCable连接中的<code class="fe ky kz la lb b">User</code>。但是在基于令牌的Rails API中，我们使用J <a class="ae kw" href="https://jwt.io/" rel="noopener ugc nofollow" target="_blank"> WT令牌</a>，所以我们必须设置不同的认证。对于React应用程序，幸运的是有一个名为<code class="fe ky kz la lb b"><a class="ae kw" href="https://github.com/zekedran/action-cable-react-jwt" rel="noopener ugc nofollow" target="_blank">action-cable-react-jwt</a></code>的npm库，我们可以用它来连接ActionCable。<code class="fe ky kz la lb b">action-cable-react-jwt</code>与其他<em class="kx">(如:</em> <code class="fe ky kz la lb b"><em class="kx">action-cable</em></code> <em class="kx">或</em> <code class="fe ky kz la lb b"><em class="kx">action-cable-react</em></code> <em class="kx">)不同的是，</em>有传递JWT令牌的选项。</p><h1 id="7386" class="lc ld iq bd le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz bi translated"><a class="ae kw" href="https://github.com/zekedran/action-cable-react-jwt" rel="noopener ugc nofollow" target="_blank">安装</a></h1><p id="0146" class="pw-post-body-paragraph jy jz iq ka b kb ma kd ke kf mb kh ki kj mc kl km kn md kp kq kr me kt ku kv ij bi translated">在React应用程序中:</p><pre class="mf mg mh mi gt mj lb mk ml aw mm bi"><span id="0034" class="mn ld iq lb b gy mo mp l mq mr">yarn add action-cable-react-jwt</span><span id="f885" class="mn ld iq lb b gy ms mp l mq mr">or</span><span id="29a6" class="mn ld iq lb b gy ms mp l mq mr">npm install action-cable-react-jwt</span></pre><h1 id="315e" class="lc ld iq bd le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz bi translated">使用</h1><h2 id="d27f" class="mn ld iq bd le mt mu dn li mv mw dp lm kj mx my lq kn mz na lu kr nb nc ly nd bi translated">在React应用程序中:</h2><p id="9a1f" class="pw-post-body-paragraph jy jz iq ka b kb ma kd ke kf mb kh ki kj mc kl km kn md kp kq kr me kt ku kv ij bi translated"><strong class="ka ir"> <em class="kx">导入</em> </strong> <code class="fe ky kz la lb b"><strong class="ka ir"><em class="kx">action-cable-react-jwt </em></strong></code> <strong class="ka ir"> <em class="kx">首先</em> </strong></p><pre class="mf mg mh mi gt mj lb mk ml aw mm bi"><span id="ed6e" class="mn ld iq lb b gy mo mp l mq mr">import ActionCable from 'action-cable-react-jwt'</span></pre><p id="862b" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><strong class="ka ir"> <em class="kx">连接到动作电缆</em> </strong></p><pre class="mf mg mh mi gt mj lb mk ml aw mm bi"><span id="8f01" class="mn ld iq lb b gy mo mp l mq mr">componentDidMount () { <br/>  this.createSocket()<br/>}</span><span id="6f62" class="mn ld iq lb b gy ms mp l mq mr">const createSocket = () =&gt; {</span><span id="11f0" class="mn ld iq lb b gy ms mp l mq mr">  // get your JWT token<br/>  // this is an example using localStorage<br/>  const yourToken = localStorage.Token</span><span id="ad1b" class="mn ld iq lb b gy ms mp l mq mr">  let App = {}<br/>  App.cable = ActionCable.createConsumer(‘ws://localhost:3000/cable', yourToken)</span><span id="6304" class="mn ld iq lb b gy ms mp l mq mr">  const subscription = App.cable.subscriptions.create({channel: 'YourChannelName'}, {<br/>    connected = () =&gt; {},<br/>    disconnected = () =&gt; {},<br/>    received = (data) =&gt; { <br/>      console.log(data) <br/>    }<br/>  })<br/>}</span></pre><h2 id="0ed6" class="mn ld iq bd le mt mu dn li mv mw dp lm kj mx my lq kn mz na lu kr nb nc ly nd bi translated">在您的Rails应用程序中:</h2><p id="6240" class="pw-post-body-paragraph jy jz iq ka b kb ma kd ke kf mb kh ki kj mc kl km kn md kp kq kr me kt ku kv ij bi translated"><strong class="ka ir"> <em class="kx">认证</em> </strong></p><pre class="mf mg mh mi gt mj lb mk ml aw mm bi"><span id="6c42" class="mn ld iq lb b gy mo mp l mq mr"># inside app/channels/application_cable/connection.rb</span><span id="da84" class="mn ld iq lb b gy ms mp l mq mr">module ApplicationCable        <br/>  class Connection &lt; ActionCable::Connection::Base <br/>    identified_by :current_user<br/> <br/>    def connect                <br/>      self.current_user = find_verified_user<br/>    end<br/> <br/>    private<br/>      def find_verified_user   <br/>        begin<br/>          token = request.headers[:HTTP_SEC_WEBSOCKET_PROTOCOL].split(' ').last<br/>          decoded_token = JsonWebToken.decode(token)<br/>          if (current_user = User.find(decoded_token["user_id"]))<br/>            current_user<br/>          else                 <br/>            reject_unauthorized_connection<br/>          end<br/>        rescue<br/>          reject_unauthorized_connection  <br/>        end<br/>      end<br/>  end<br/>end</span></pre><p id="731d" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">就是这样！现在应该可以用JWT令牌安全地连接到actioncable了。</p><figure class="mf mg mh mi gt jr gh gi paragraph-image"><div class="gh gi ne"><img src="../Images/9c6ea2d4fc76418637f037229e19c6cf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1200/1*YdlkQdwMHHHGZWc0uAdQpw.gif"/></div></figure><blockquote class="nf"><p id="079d" class="ng nh iq bd ni nj nk nl nm nn no kv dk translated">谢谢！我欣赏一两次鼓掌。。。\m/</p></blockquote></div></div>    
</body>
</html>