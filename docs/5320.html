<html>
<head>
<title>Setup Your Own Kubernetes Cluster with K3s</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用K3s设置您自己的Kubernetes集群</h1>
<blockquote>原文：<a href="https://itnext.io/setup-your-own-kubernetes-cluster-with-k3s-b527bf48e36a?source=collection_archive---------0-----------------------#2021-02-09">https://itnext.io/setup-your-own-kubernetes-cluster-with-k3s-b527bf48e36a?source=collection_archive---------0-----------------------#2021-02-09</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><figure class="gl gn jr js jt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi jq"><img src="../Images/12708c549269c9d068c848981dc27ab1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*WkzaOU9vYN_FHQ1d"/></div></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated">照片由<a class="ae kf" href="https://unsplash.com/@wocintechchat?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">克里斯蒂娜@ wocintechchat.com</a>在<a class="ae kf" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄</figcaption></figure><p id="6122" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">对于本教程，使用了两台运行Ubuntu 20.04.1 LTS的虚拟机。</p><p id="d67e" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">如果需要一个本地Kubernetes集群，那么<a class="ae kf" href="https://k3s.io" rel="noopener ugc nofollow" target="_blank"> K3s </a>似乎是一个不错的选择，因为每个节点只需要安装一个小的二进制文件。</p><p id="338f" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">请注意，出于隐私原因，我已经删除了所有的域名、IP地址等等。</p><h2 id="5987" class="le lf it bd lg lh li dn lj lk ll dp lm kr ln lo lp kv lq lr ls kz lt lu lv lw bi translated">安装集群</h2><p id="fd3c" class="pw-post-body-paragraph kg kh it ki b kj lx kl km kn ly kp kq kr lz kt ku kv ma kx ky kz mb lb lc ld im bi translated">在将成为主节点的计算机上，安装K3s二进制文件:</p><pre class="mc md me mf gt mg mh mi mj aw mk bi"><span id="539e" class="le lf it mh b gy ml mm l mn mo">curl -sfL https://get.k3s.io | sh -</span></pre><p id="444c" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">获取下一步需要的节点令牌:</p><pre class="mc md me mf gt mg mh mi mj aw mk bi"><span id="36ee" class="le lf it mh b gy ml mm l mn mo">cat /var/lib/rancher/k3s/server/node-token</span></pre><p id="b323" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">在将成为工作节点的每台计算机上:</p><pre class="mc md me mf gt mg mh mi mj aw mk bi"><span id="08ab" class="le lf it mh b gy ml mm l mn mo">curl -sfL https://get.k3s.io | K3S_URL=https://kubernetes01.domain.de:6443 K3S_TOKEN=&lt;the-token-from-the-step-before&gt; sh -</span></pre><p id="2c16" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">回到主节点，检查所有节点是否都在:</p><pre class="mc md me mf gt mg mh mi mj aw mk bi"><span id="f7b8" class="le lf it mh b gy ml mm l mn mo">$ sudo k3s kubectl get node<br/>NAME                     STATUS   ROLES                  AGE   VERSION<br/>kubernetes01.domain.de   Ready    control-plane,master   18m   v1.20.0+k3s2<br/>kubernetes02.domain.de   Ready    &lt;none&gt;                 93s   v1.20.0+k3s2</span></pre><h2 id="8270" class="le lf it bd lg lh li dn lj lk ll dp lm kr ln lo lp kv lq lr ls kz lt lu lv lw bi translated">部署服务</h2><p id="8775" class="pw-post-body-paragraph kg kh it ki b kj lx kl km kn ly kp kq kr lz kt ku kv ma kx ky kz mb lb lc ld im bi translated">对于第一个测试，一些NGINX实例被部署到集群中，清单如下:</p><pre class="mc md me mf gt mg mh mi mj aw mk bi"><span id="0284" class="le lf it mh b gy ml mm l mn mo">apiVersion: apps/v1<br/>kind: Deployment<br/>metadata:<br/>  name: nginx-deployment<br/>spec:<br/>  selector:<br/>    matchLabels:<br/>      app: nginx<br/>  replicas: 10<br/>  template:<br/>    metadata:<br/>      labels:<br/>        app: nginx<br/>    spec:<br/>      containers:<br/>      - name: nginx<br/>        image: nginx:1.14.2<br/>        ports:<br/>        - containerPort: 80</span></pre><p id="9345" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">将其保存到文件<code class="fe mp mq mr mh b">nginx-deployment.yml</code>中并安装:</p><pre class="mc md me mf gt mg mh mi mj aw mk bi"><span id="292b" class="le lf it mh b gy ml mm l mn mo">kubectl apply -f nginx-deployment.yml</span></pre><p id="07d6" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">现在总共应该有10个pods运行一个NGINX实例。为什么是10？只是为了好玩:-)适应你的喜好。</p><p id="8cf4" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">使用以下命令检查这些单元在哪里运行:</p><pre class="mc md me mf gt mg mh mi mj aw mk bi"><span id="cae9" class="le lf it mh b gy ml mm l mn mo">kubectl get pods -l app=nginx --output=wide</span></pre><h2 id="1d7f" class="le lf it bd lg lh li dn lj lk ll dp lm kr ln lo lp kv lq lr ls kz lt lu lv lw bi translated">创建服务</h2><p id="9e20" class="pw-post-body-paragraph kg kh it ki b kj lx kl km kn ly kp kq kr lz kt ku kv ma kx ky kz mb lb lc ld im bi translated">这是使“内部”部署可从集群外部访问的两个步骤中的第一步。</p><pre class="mc md me mf gt mg mh mi mj aw mk bi"><span id="6d79" class="le lf it mh b gy ml mm l mn mo">apiVersion: v1<br/>kind: Service<br/>metadata:<br/>  name: nginx<br/>  labels:<br/>    run: nginx<br/>spec:<br/>  ports:<br/>    - port: 80<br/>      protocol: TCP<br/>  selector:<br/>    app: nginx</span></pre><p id="066e" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">当上述清单到位时，例如<code class="fe mp mq mr mh b">nginx-service.yml</code>，其适用于:</p><pre class="mc md me mf gt mg mh mi mj aw mk bi"><span id="b6fa" class="le lf it mh b gy ml mm l mn mo">kubectl apply -f nginx-service.yml</span></pre><p id="d3e7" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">检查是否有效:</p><pre class="mc md me mf gt mg mh mi mj aw mk bi"><span id="5458" class="le lf it mh b gy ml mm l mn mo">$ sudo kubectl get services<br/>NAME         TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)   AGE<br/>kubernetes   ClusterIP   00.0.0.0       &lt;none&gt;        443/TCP   4h9m<br/>nginx        ClusterIP   00.00.000.000   &lt;none&gt;        80/TCP    13</span></pre><p id="234b" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">但是需要负载均衡，对吧？</p><p id="02ea" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">对！</p><h2 id="134a" class="le lf it bd lg lh li dn lj lk ll dp lm kr ln lo lp kv lq lr ls kz lt lu lv lw bi translated">带HAProxy的入口</h2><p id="8f24" class="pw-post-body-paragraph kg kh it ki b kj lx kl km kn ly kp kq kr lz kt ku kv ma kx ky kz mb lb lc ld im bi translated">创建服务后，可以通过创建基于HAProxy的入口从外部访问NGINX实例。</p><p id="aee5" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">HAProxy提供的原始清单相当长，因此这里不再重复。</p><p id="960e" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">无论如何，它可以直接从它的来源安装:</p><pre class="mc md me mf gt mg mh mi mj aw mk bi"><span id="82a8" class="le lf it mh b gy ml mm l mn mo">$ kubectl apply -f <a class="ae kf" href="https://raw.githubusercontent.com/haproxytech/kubernetes-ingress/v1.4/deploy/haproxy-ingress.yaml" rel="noopener ugc nofollow" target="_blank">https://raw.githubusercontent.com/haproxytech/kubernetes-ingress/v1.4/deploy/haproxy-ingress.yaml</a></span></pre><p id="aa55" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">再次检查是否一切顺利:</p><pre class="mc md me mf gt mg mh mi mj aw mk bi"><span id="dc8d" class="le lf it mh b gy ml mm l mn mo">$ sudo kubectl get ingress<br/>NAME            CLASS    HOSTS   ADDRESS        PORTS   AGE<br/>nginx-ingress   &lt;none&gt;   *       00.000.0.000   80      2m38s</span></pre><p id="264c" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">此外，让我们与其中一个pod“对话”:</p><pre class="mc md me mf gt mg mh mi mj aw mk bi"><span id="0e69" class="le lf it mh b gy ml mm l mn mo">$ curl 10.199.7.120/nginx<br/>&lt;html&gt;<br/>&lt;head&gt;&lt;title&gt;404 Not Found&lt;/title&gt;&lt;/head&gt;<br/>&lt;body bgcolor="white"&gt;<br/>&lt;center&gt;&lt;h1&gt;404 Not Found&lt;/h1&gt;&lt;/center&gt;<br/>&lt;hr&gt;&lt;center&gt;nginx/1.14.2&lt;/center&gt;<br/>&lt;/body&gt;<br/>&lt;/html&gt;</span></pre><p id="bbda" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">那辆<code class="fe mp mq mr mh b">404</code>很好。所有NGINX实例都是“空”的。</p><p id="84c3" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">编辑2021年2月15日</p><p id="4c2d" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">404不好。这里出了点问题。空的nginx应该显示一个欢迎页面。有些地方出错了，但是这篇文章已经过时了。</p><h2 id="15e1" class="le lf it bd lg lh li dn lj lk ll dp lm kr ln lo lp kv lq lr ls kz lt lu lv lw bi translated">改变当地的Kubernetes环境</h2><p id="ab5c" class="pw-post-body-paragraph kg kh it ki b kj lx kl km kn ly kp kq kr lz kt ku kv ma kx ky kz mb lb lc ld im bi translated">从一个本地终端控制集群要方便得多，而不必<code class="fe mp mq mr mh b">ssh</code>进入主节点。</p><p id="1918" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">从主节点复制<code class="fe mp mq mr mh b">/etc/rancher/k3s/k3s.yaml</code>的内容并添加到本地<code class="fe mp mq mr mh b">~/.kube/config</code>。</p><p id="4c0f" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">将“localhost”替换为主K3s节点的IP或名称。</p><p id="69c2" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">在本地机器上，用<code class="fe mp mq mr mh b">kubectl set-context &lt;yourcontext&gt;</code>改变上下文</p><p id="98cf" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">检查，例如通过检索所有窗格</p><pre class="mc md me mf gt mg mh mi mj aw mk bi"><span id="caea" class="le lf it mh b gy ml mm l mn mo">kubectl get pods -o wide</span></pre><p id="a853" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">如果你喜欢这篇文章，请给我买杯咖啡吧！T3】</p><h2 id="2774" class="le lf it bd lg lh li dn lj lk ll dp lm kr ln lo lp kv lq lr ls kz lt lu lv lw bi translated">资源</h2><ul class=""><li id="daa0" class="ms mt it ki b kj lx kn ly kr mu kv mv kz mw ld mx my mz na bi translated"><a class="ae kf" href="https://rancher.com/docs/k3s/latest/en/quick-start/" rel="noopener ugc nofollow" target="_blank"> K3s快速入门指南</a></li><li id="692f" class="ms mt it ki b kj nb kn nc kr nd kv ne kz nf ld mx my mz na bi translated"><a class="ae kf" href="https://kubernetes.io/docs/tasks/run-application/run-stateless-application-deployment/" rel="noopener ugc nofollow" target="_blank">使用部署运行无状态应用</a></li><li id="fabe" class="ms mt it ki b kj nb kn nc kr nd kv ne kz nf ld mx my mz na bi translated"><a class="ae kf" href="https://kubernetes.io/docs/concepts/services-networking/connect-applications-service/#creating-a-service" rel="noopener ugc nofollow" target="_blank">创建服务</a></li><li id="057f" class="ms mt it ki b kj nb kn nc kr nd kv ne kz nf ld mx my mz na bi translated"><a class="ae kf" href="https://www.haproxy.com/documentation/kubernetes/latest/installation/community/kubernetes/" rel="noopener ugc nofollow" target="_blank">如何将HAProxy Kubernetes入口控制器安装到您的Kubernetes集群中</a></li><li id="709e" class="ms mt it ki b kj nb kn nc kr nd kv ne kz nf ld mx my mz na bi translated"><a class="ae kf" href="https://rancher.com/docs/k3s/latest/en/cluster-access/" rel="noopener ugc nofollow" target="_blank">使用kubectl从外部访问集群</a></li></ul></div></div>    
</body>
</html>