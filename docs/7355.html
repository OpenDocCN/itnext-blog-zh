<html>
<head>
<title>Kubernetes OWASP Top 10: Centralised Policy Enforcement</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Kubernetes OWASP十大:集中政策执行</h1>
<blockquote>原文：<a href="https://itnext.io/kubernetes-owasp-top-10-centralised-policy-enforcement-9adc53438e22?source=collection_archive---------1-----------------------#2022-08-30">https://itnext.io/kubernetes-owasp-top-10-centralised-policy-enforcement-9adc53438e22?source=collection_archive---------1-----------------------#2022-08-30</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="a20b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">继我关于<a class="ae kl" rel="noopener ugc nofollow" target="_blank" href="/kubernetes-owasp-top-10-insecure-workload-configurations-60818f0c68db">不安全的工作负载配置</a>的文章之后，使用内置安全上下文也就到此为止了，开发人员和操作人员需要一定的信任来确保遵循策略。安全最薄弱的环节是人。无论是代码中的错误，测试中安全设置的删除，还是恶意的意图，人类都将系统置于风险之中，不管是有意还是无意。为了减轻这些风险，更安全的流程是使用自动化和工具来确保遵守策略。在库伯内特和CNCF地区，现有的工具能够帮助执行政策，或者可以扩展所采用的流程，以确保政策得到执行。</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="ks kt di ku bf kv"><div class="gh gi km"><img src="../Images/5c350be8902cb4adb5af719d17031d78.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*3QWoIX_KlSwDcj12"/></div></div><figcaption class="ky kz gj gh gi la lb bd b be z dk translated"><a class="ae kl" href="https://unsplash.com/@drew_harbour?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">摄德鲁港</a>在<a class="ae kl" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a></figcaption></figure><h2 id="f386" class="lc ld iq bd le lf lg dn lh li lj dp lk jy ll lm ln kc lo lp lq kg lr ls lt lu bi translated">现有流程:CI/CD</h2><p id="8095" class="pw-post-body-paragraph jn jo iq jp b jq lv js jt ju lw jw jx jy lx ka kb kc ly ke kf kg lz ki kj kk ij bi translated">利用现有CI/CD管道中的测试和关口可以确保工作负载不会被部署到不符合策略的活动系统中。通过使用测试脚本作为PR (pull request)步骤，确保策略所期望的任何安全上下文或任何其他pardigm在合并到分支或发送出去进行部署之前存在，并作为CI/CD系统的内置安全控制中的一个步骤来实施。</p><p id="84dd" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这样做的缺点是，所有检查都必须用代码手工编写，以便对yaml部署文件执行静态代码分析。它是可扩展的，但是管理开销很大，每个Kubernetes版本都会更新值和设置，在部署中使用其他工具时需要额外的工作，例如helm需要额外的步骤来确保提前生成yaml部署文件(例如helm模板),并且脚本需要单独更新和管理，这增加了出错的可能性。</p><p id="d713" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">利用现有CI/CD管道和基础设施的另一种方式是通过使用工具。像KubeSec或T2 Snyk的IAC插件(付费服务)这样的工具允许使用gates，而不需要编写和管理脚本。这些工具利用针对不安全工作负载配置的内置检查，并输出分数或列出错误或不安全值。如果分数或特定设置不符合策略阈值，这有助于可视化所需的改进，甚至阻止部署。使用这种方法的问题可能是策略的特定目标可能很困难，例如对特定名称空间应用更严格的规则，或者基于您或您的组织认为是可接受风险的单个建议而使整个构建失败。</p><p id="1e8b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">当然，为了能够利用这些流程，您需要首先使用CI/CD部署管道，这也是我强烈推荐的，因为存在人工操作员风险以及版本化的源代码控制，以便了解已经部署了什么、何时部署以及由谁部署。另一个要求是Kubernetes集群被充分锁定，只允许从CI/CD流程进行部署。如果没有这一点，操作员或威胁参与者可以通过使用kubectl、helm甚至direct从集群内的运行pod针对API直接部署到集群来绕过控制。</p><h2 id="1c2f" class="lc ld iq bd le lf lg dn lh li lj dp lk jy ll lm ln kc lo lp lq kg lr ls lt lu bi translated">Kubernetes许可控制器</h2><p id="f608" class="pw-post-body-paragraph jn jo iq jp b jq lv js jt ju lw jw jx jy lx ka kb kc ly ke kf kg lz ki kj kk ij bi translated">Kubernetes准入控制器是一种直接在Kubernetes内部构建部署入口的方式。这些基本上是在进行添加、修改或删除时Kubernetes API调用的webhooks。有两种类型的准入控制器，变异和验证。变异将获取试图部署到集群的清单，查找特定的值或设置，如果找到，则修改它们。验证准入控制器搜索部署，以确保满足特定的标准，并响应Kubernetes API，无论它是否通过验证。</p><p id="4d0f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">内置准入控制器的一个例子是DefaultStorageClass。当一个群集中存在多个存储类别时，总会有一个默认类别。如果在尝试在工作负载中使用PVC时未定义storageClass，则变异准入控制器将修改清单，以将默认storageClass的设置注入部署中。</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="ks kt di ku bf kv"><div class="gh gi ma"><img src="../Images/c32fa949fa691e983ded4ffc8443eb1b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*xPK7lyqyQ_aKboX0v2tgDg.jpeg"/></div></div><figcaption class="ky kz gj gh gi la lb bd b be z dk translated">库伯内特承认由<a class="mb mc ep" href="https://medium.com/u/cf043e176f4e?source=post_page-----9adc53438e22--------------------------------" rel="noopener" target="_blank">阿兰·斯科特</a></figcaption></figure><h2 id="edaf" class="lc ld iq bd le lf lg dn lh li lj dp lk jy ll lm ln kc lo lp lq kg lr ls lt lu bi translated">Kubernetes安全入场</h2><p id="d3cb" class="pw-post-body-paragraph jn jo iq jp b jq lv js jt ju lw jw jx jy lx ka kb kc ly ke kf kg lz ki kj kk ij bi translated">在撰写本文时，Kubernetes的v1.25有一个稳定的内置<a class="ae kl" href="https://kubernetes.io/docs/concepts/security/pod-security-admission" rel="noopener ugc nofollow" target="_blank">准入控制器</a>，它根据放置在名称空间上的标签利用不同的安全级别。Kubernetes对哪些设置属于哪个类别发表了意见。定义的类别有:</p><ul class=""><li id="b1db" class="md me iq jp b jq jr ju jv jy mf kc mg kg mh kk mi mj mk ml bi translated">特权—不提供任何限制。</li><li id="8dac" class="md me iq jp b jq mm ju mn jy mo kc mp kg mq kk mi mj mk ml bi translated">基线—这是设置限制最少的基线安全配置。</li><li id="588a" class="md me iq jp b jq mm ju mn jy mo kc mp kg mq kk mi mj mk ml bi translated">Restricted —最严格的设置，遵循当前容器强化的最佳实践。</li></ul><p id="bbb4" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">除了可以对工作负载设置的级别之外，还可以应用不同的审计级别。</p><ul class=""><li id="2c08" class="md me iq jp b jq jr ju jv jy mf kc mg kg mh kk mi mj mk ml bi translated">审核—任何违规都将触发审核日志中的事件，但将被允许。</li><li id="e880" class="md me iq jp b jq mm ju mn jy mo kc mp kg mq kk mi mj mk ml bi translated">Warn —添加向用户显示的警告，但将被允许。</li><li id="1f9c" class="md me iq jp b jq mm ju mn jy mo kc mp kg mq kk mi mj mk ml bi translated">强制—任何违规都将导致工作负载被拒绝部署。</li></ul><h2 id="40ca" class="lc ld iq bd le lf lg dn lh li lj dp lk jy ll lm ln kc lo lp lq kg lr ls lt lu bi translated">OPA和看门人</h2><p id="2090" class="pw-post-body-paragraph jn jo iq jp b jq lv js jt ju lw jw jx jy lx ka kb kc ly ke kf kg lz ki kj kk ij bi translated">开放策略代理(OPA)项目是一个CNCF项目，作为声明性策略创建，使用一种通用语言用于多个生态系统，而不仅仅是Kubernetes。这允许跨安全策略的标准化，无论工作负载部署在哪里或部署到什么类型的系统。</p><p id="6d13" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">Gatekeeper是Kubernetes准入控制器，它根据定义的策略及其结果与OPA和gates部署清单进行交互。</p><p id="8c8f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">OPA是可扩展的，因此不仅仅可以用于securityContext验证。例如，可以有一个允许部署映像的存储库列表，可以编写一个策略，以便这些存储库之外的任何映像都将失败，并且不会部署到集群中。</p><p id="5fdc" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我不会介绍如何在集群中安装OPA，这里有一些很棒的演示，也有帮助您快速启动和运行的导航图，但请给出一个示例，说明策略是如何应用于工作负载的，从约束模板开始。</p><figure class="kn ko kp kq gt kr"><div class="bz fp l di"><div class="mr ms l"/></div></figure><p id="bb0a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">约束模板列出了一个定制的资源定义规范，即稍后可以引用的Kube API对象，包括它可以采用的名称和参数，以及rego策略本身。这可以应用于集群并很好地设置准入规则。接下来，我们需要针对工作负载应用策略，在本例中是所有pod。</p><figure class="kn ko kp kq gt kr"><div class="bz fp l di"><div class="mr ms l"/></div></figure><p id="487d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">从现在开始，一旦应用此选项，部署的没有以“https://scotta01.com”开头的spec.container.image的pod将被拒绝进入集群。</p><p id="6e71" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">随着OPA针对多个系统进行标准化，它使用一种共同的语言，即减压阀语，因此在投资工具时需要考虑技能因素。然而，如果OPA可以在您的环境中被采用，而不仅仅是在Kubernetes中，那么考虑到OPA可以提供的广泛范围，投资成本应该会很快增加。</p><h2 id="6e44" class="lc ld iq bd le lf lg dn lh li lj dp lk jy ll lm ln kc lo lp lq kg lr ls lt lu bi translated">IDE林挺和插件</h2><p id="3c22" class="pw-post-body-paragraph jn jo iq jp b jq lv js jt ju lw jw jx jy lx ka kb kc ly ke kf kg lz ki kj kk ij bi translated">尽管技术上不是集中执行，ide中利用的特性允许快速反馈给开发人员，以允许在开发生命周期的早期进行更改。这有助于培养安全的设计，并确保预先考虑安全的开发标准，而不是等到生命周期的后期，这可能需要很长时间来修复。</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="ks kt di ku bf kv"><div class="gh gi mt"><img src="../Images/c3b4f778f1c851b04c498eb1dfa49f5c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Ajb1vw-usHyn4DnZyiHewA.png"/></div></div><figcaption class="ky kz gj gh gi la lb bd b be z dk translated">JetBains IDE中的Snyk代码插件</figcaption></figure><h2 id="683f" class="lc ld iq bd le lf lg dn lh li lj dp lk jy ll lm ln kc lo lp lq kg lr ls lt lu bi translated">摘要</h2><p id="7d1b" class="pw-post-body-paragraph jn jo iq jp b jq lv js jt ju lw jw jx jy lx ka kb kc ly ke kf kg lz ki kj kk ij bi translated">对于如何实施安全策略，没有一种方法是万能的，但是，通过利用这些功能的组合，可以通过快速的开发人员/运营商反馈循环进行适当的控制部署，以确保安全部署，而不会对工作效率产生任何影响。</p></div></div>    
</body>
</html>