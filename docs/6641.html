<html>
<head>
<title>How to Design and Provision a Production-Ready EKS Cluster</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何设计和配置生产就绪型EKS集群</h1>
<blockquote>原文：<a href="https://itnext.io/how-to-design-and-provision-a-production-ready-eks-cluster-f24156ac29b2?source=collection_archive---------0-----------------------#2022-01-13">https://itnext.io/how-to-design-and-provision-a-production-ready-eks-cluster-f24156ac29b2?source=collection_archive---------0-----------------------#2022-01-13</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><p id="7aff" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">使用Terraform、Helm和其他开源工具在AWS上创建和配置生产级Kubernetes集群的全面指南。</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi ko"><img src="../Images/22afe4df1af374fb8e7b5b436568e8cb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*8CQK1RYWbzOvumzl_aCdNA.jpeg"/></div></div><figcaption class="la lb gj gh gi lc ld bd b be z dk translated">图片来源:<a class="ae le" href="https://pixabay.com/illustrations/digitization-transformation-earth-5231610/" rel="noopener ugc nofollow" target="_blank"> Pixabay </a></figcaption></figure><p id="912b" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">根据<a class="ae le" href="https://info.flexera.com/CM-REPORT-State-of-the-Cloud" rel="noopener ugc nofollow" target="_blank"> Flexera的2021年云状态报告</a>，AWS领先于容器编排市场份额，51%的受访者使用亚马逊EKS和ECS，相比之下，AKS为43%，GKE为31%。</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi lf"><img src="../Images/83bf37df62f3d0da9a041a48eff356e2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*66PcSAUAgT2WACJy.png"/></div></div><figcaption class="la lb gj gh gi lc ld bd b be z dk translated">图片来源:<a class="ae le" href="https://info.flexera.com/CM-REPORT-State-of-the-Cloud" rel="noopener ugc nofollow" target="_blank"> Flexera </a></figcaption></figure><p id="e6a2" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">Flexera没有分享ECS与EKS使用之间的准确细分，但根据Datadog最新的<a class="ae le" href="https://www.datadoghq.com/container-report/" rel="noopener ugc nofollow" target="_blank">容器报告</a>，就主要云平台提供的托管Kubernetes服务而言，EKS的使用是最低的。</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi lg"><img src="../Images/8867d173df27768b46ee81df7febf61d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*gGO9iX94hKEOPmKv.png"/></div></div><figcaption class="la lb gj gh gi lc ld bd b be z dk translated">图片来源:<a class="ae le" href="https://www.datadoghq.com/container-report/" rel="noopener ugc nofollow" target="_blank">数据狗</a></figcaption></figure><p id="67e6" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">尽管这些调查结果可能基于样本量有所偏差，但有趣的是，它与我在EKS的经历相吻合。AWS将ECS、ECR、Fargate和EKS归入一个单独的<em class="lh">容器</em>产品中，并且在Kubernetes的特定功能方面往往落后于AKS和GKE，例如对最新Kubernetes版本的支持、beta功能(例如垂直pod自动缩放器、自定义kubelet参数)和管理选项(例如节点自动修复、自动升级、仪表板)。</p><p id="246c" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">尽管有这些缺点，鉴于AWS在更广泛的云市场的主导地位，许多组织将选择EKS作为首选的托管Kubernetes提供商。如果您希望设计和配置生产级EKS集群，下面是我在复杂的EKS生态系统中遇到的一些常见问题和解决方法。</p><p id="487f" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated"><em class="lh">注:有关托管Kubernetes产品的更详细比较，请参见</em> <a class="ae le" href="https://medium.com/geekculture/state-of-managed-kubernetes-2021-43e8a4ca0207" rel="noopener"> <em class="lh">托管Kubernetes 2021 </em> </a> <em class="lh">的状态。</em></p><h1 id="b73e" class="li lj it bd lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf bi translated">出发点</h1><p id="de72" class="pw-post-body-paragraph jq jr it js b jt mg jv jw jx mh jz ka kb mi kd ke kf mj kh ki kj mk kl km kn im bi translated">部署EKS有两种流行的方式:<a class="ae le" href="https://eksctl.io/" rel="noopener ugc nofollow" target="_blank"> eksctl </a>和Terraform。eksctl是一个由<a class="ae le" href="https://www.weave.works/" rel="noopener ugc nofollow" target="_blank"> Weaveworks </a>管理的开源工具，它利用CloudFormation来引导和配置EKS。如果你的工作流已经围绕云形成，eksctl可能是一个很好的开始，因为AWS有很好的<a class="ae le" href="https://www.eksworkshop.com/030_eksctl/" rel="noopener ugc nofollow" target="_blank">研讨会记录了这种情况</a>。但是，如果您正在寻找一种更传统的IaC方法，使用Terraform将是一种更好的方法。</p><p id="9cee" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">对于Terraform，AWS和Gruntwork都提供了基础架构和入门模板:</p><ul class=""><li id="6e23" class="ml mm it js b jt ju jx jy kb mn kf mo kj mp kn mq mr ms mt bi translated"><a class="ae le" href="https://docs.aws.amazon.com/prescriptive-guidance/latest/containers-provision-eks-clusters-terraform/welcome.html" rel="noopener ugc nofollow" target="_blank">使用Terraform供应生产就绪的亚马逊EKS集群</a></li><li id="737b" class="ml mm it js b jt mu jx mv kb mw kf mx kj my kn mq mr ms mt bi translated"><a class="ae le" href="https://gruntwork.io/guides/kubernetes/how-to-deploy-production-grade-kubernetes-cluster-aws/#what-is-kubernetes" rel="noopener ugc nofollow" target="_blank">如何在AWS上部署生产级Kubernetes集群</a></li></ul><p id="3535" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">就我个人而言，我使用的是官方的AWS EKS模块，所以这里显示的例子将指向那些文档，但是可以修改为与其他Terraform模板一起工作。</p><h1 id="99d4" class="li lj it bd lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf bi translated">当心EKS耗尽IP地址</h1><p id="d03b" class="pw-post-body-paragraph jq jr it js b jt mg jv jw jx mh jz ka kb mi kd ke kf mj kh ki kj mk kl km kn im bi translated">在部署EKS集群之前，首先要考虑的是VPC设计和选择容器网络接口(CNI)。默认情况下，EKS运行自动气象站CNI，这是为了兼容其他自动气象站服务，如VPC流量日志。由于这种设计选择，每个pod都从子网中分配了一个IP地址。这意味着，不仅您的微服务会消耗IP地址，AWS管理的其他helper pods(例如aws-node、coredns、kube-proxy)以及日志聚合器、监控代理和节点特定工具(例如spot termination handler、更新代理)等作为daemonsets部署的常用工具也会消耗IP地址。使这个问题更加复杂的是，每个实例类型都有一个根据网络接口的最大数量和每个接口的私有IP地址分配的最大IP数量。换句话说，如果您的集群使用小型实例类型，您将很快达到这个限制。</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi mz"><img src="../Images/83cea49b6b990813ba38c83a4b291a23.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*BLuY12DHM8denBxx.png"/></div></div><figcaption class="la lb gj gh gi lc ld bd b be z dk translated">图片来源:<a class="ae le" href="https://aws.amazon.com/blogs/containers/amazon-vpc-cni-increases-pods-per-node-limits/" rel="noopener ugc nofollow" target="_blank"> AWS博客</a></figcaption></figure><p id="2427" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">那么，可以做些什么来缓解这个问题呢？</p><ol class=""><li id="0f96" class="ml mm it js b jt ju jx jy kb mn kf mo kj mp kn na mr ms mt bi translated">利用<a class="ae le" href="https://www.eksworkshop.com/beginner/160_advanced-networking/secondary_cidr/" rel="noopener ugc nofollow" target="_blank">二级CIDR范围</a> (100.64.0.0/10和198.19.0.0/16)扩展VPC网络</li><li id="6776" class="ml mm it js b jt mu jx mv kb mw kf mx kj my kn na mr ms mt bi translated"><a class="ae le" href="https://docs.aws.amazon.com/eks/latest/userguide/cni-ipv6.html" rel="noopener ugc nofollow" target="_blank">在集群创建时启用IPv6</a></li><li id="3243" class="ml mm it js b jt mu jx mv kb mw kf mx kj my kn na mr ms mt bi translated"><a class="ae le" href="https://docs.aws.amazon.com/eks/latest/userguide/cni-increase-ip-addresses.html" rel="noopener ugc nofollow" target="_blank">在AWS CNI 1.9.0+ </a>上设置<em class="lh"> ENABLE_PREFIX_DELEGATION </em>为真。这将添加/28个IPv4地址前缀。</li><li id="b87c" class="ml mm it js b jt mu jx mv kb mw kf mx kj my kn na mr ms mt bi translated">使用不同的CNI，如<a class="ae le" href="https://platform9.com/blog/the-ultimate-guide-to-using-calico-flannel-weave-and-cilium/" rel="noopener ugc nofollow" target="_blank">印花布、法兰绒、织物或纤毛</a></li></ol><p id="a19a" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">上面列出的前三个解决方案属于AWS领域，所以如果您想确保获得AWS的全面支持，这可能是一个很好的前进方向。另一方面，其他CNI确实提供其他功能，如eBPF、WireGuard加密和网络策略支持。</p><h1 id="3694" class="li lj it bd lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf bi translated">使用瓶盖</h1><p id="5653" class="pw-post-body-paragraph jq jr it js b jt mg jv jw jx mh jz ka kb mi kd ke kf mj kh ki kj mk kl km kn im bi translated">类似于谷歌的容器优化操作系统，AWS提供了<a class="ae le" href="https://github.com/bottlerocket-os/bottlerocket/blob/develop/QUICKSTART-EKS.md" rel="noopener ugc nofollow" target="_blank"> Bottlerocket </a>，这是一个基于Linux的操作系统，旨在托管容器。由于Bottlerocket只包含运行容器所需的组件，它的攻击面<a class="ae le" href="https://github.com/bottlerocket-os/bottlerocket/blob/develop/SECURITY_FEATURES.md" rel="noopener ugc nofollow" target="_blank">比默认的Amazon Linux 2 AMI的攻击面</a>要小。</p><p id="964e" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">Bottlerocket最好的特性之一是自动安全更新。它遵循“更新框架”(TUF)，通过自动回滚安全地更新Bottlerocket的版本。这减少了每隔几周为所有底层节点更新AMI的必要工作。</p><p id="e5b8" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">请注意，默认情况下，Bottlerocket使用两个存储卷:</p><ul class=""><li id="30ac" class="ml mm it js b jt ju jx jy kb mn kf mo kj mp kn mq mr ms mt bi translated">根设备<code class="fe nb nc nd ne b">/dev/xvda</code>拥有主动和被动<a class="ae le" href="https://github.com/bottlerocket-os/bottlerocket#updates-1" rel="noopener ugc nofollow" target="_blank">分区集</a>。它还包含bootloader、用于验证<a class="ae le" href="https://github.com/bottlerocket-os/bottlerocket/blob/develop/SECURITY_FEATURES.md#immutable-rootfs-backed-by-dm-verity" rel="noopener ugc nofollow" target="_blank">不可变根文件系统</a>的dm-verity哈希树，以及Bottlerocket API的数据存储。</li><li id="76fb" class="ml mm it js b jt mu jx mv kb mw kf mx kj my kn mq mr ms mt bi translated">数据设备<code class="fe nb nc nd ne b">/dev/xvdb</code>用作容器映像、<a class="ae le" href="https://github.com/bottlerocket-os/bottlerocket#Custom-host-containers" rel="noopener ugc nofollow" target="_blank">主机容器</a>和<a class="ae le" href="https://github.com/bottlerocket-os/bottlerocket#Bootstrap-containers-settings" rel="noopener ugc nofollow" target="_blank">引导容器</a>的持久存储。</li></ul><p id="c4cc" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">如果您需要更改这些参数中的任何一个，请相应地设置这些值，例如:</p><pre class="kp kq kr ks gt nf ne ng nh aw ni bi"><span id="3686" class="nj lj it ne b gy nk nl l nm nn">additional_ebs_volumes = [{<br/>  block_device_name = "/dev/xvdb"<br/>  volume_size       = "100"<br/>  encrypted         = true<br/>}]</span></pre><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi no"><img src="../Images/f94799cf470efd97ac18792e06d47e0f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*prwuX4QKln1-i5--.png"/></div></div><figcaption class="la lb gj gh gi lc ld bd b be z dk translated">图片来源:<a class="ae le" href="https://github.com/bottlerocket-os/bottlerocket/tree/develop/sources/updater" rel="noopener ugc nofollow" target="_blank">瓶身</a></figcaption></figure><p id="8652" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">如果出于某种原因，Bottlerocket对您的用例不起作用，请安装<a class="ae le" href="https://docs.aws.amazon.com/systems-manager/latest/userguide/sysman-install-ssm-agent.html" rel="noopener ugc nofollow" target="_blank"> SSM代理</a>和<a class="ae le" href="https://docs.aws.amazon.com/inspector/v1/userguide/inspector_agents-on-linux.html" rel="noopener ugc nofollow" target="_blank">检查员</a>来保护您的AMI。确保也将<code class="fe nb nc nd ne b">AmazonSSMMangedInstanceCore</code>角色附加到节点上:</p><pre class="kp kq kr ks gt nf ne ng nh aw ni bi"><span id="0daf" class="nj lj it ne b gy nk nl l nm nn">workers_additional_policies = ["arn:aws:iam::aws:policy/AmazonSSMManagedInstanceCore"]</span><span id="ac29" class="nj lj it ne b gy np nl l nm nn">OR</span><span id="00c7" class="nj lj it ne b gy np nl l nm nn">self_managed_node_group_defaults = {<br/>  ...<br/>  iam_role_additional_policies = ["arn:aws:iam::aws:policy/AmazonSSMManagedInstanceCore"]<br/>}</span></pre><h1 id="3713" class="li lj it bd lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf bi translated">明智地使用EKS插件</h1><p id="ca80" class="pw-post-body-paragraph jq jr it js b jt mg jv jw jx mh jz ka kb mi kd ke kf mj kh ki kj mk kl km kn im bi translated">直到最近，EKS用户不得不自行管理Kubernetes组件，如<code class="fe nb nc nd ne b">kube-proxy</code>、<code class="fe nb nc nd ne b">core-dns</code>和VPC·CNI。对于任何1.18或更高版本的EKS集群，亚马逊现在为每个组件提供一个托管版本，以确保最新的安全补丁和漏洞修复通过AWS的验证。</p><p id="7c0f" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">对于新的集群，选择使用<code class="fe nb nc nd ne b">kube-proxy</code>和<code class="fe nb nc nd ne b">core-dns</code>插件，除非你预计<code class="fe nb nc nd ne b">core-dns</code>配置会有很大变化。至于VPC·CNI，答案将取决于上面做出的修改或设计决定(即使用AWS VPC·CNI与开源替代方案)。还有EBS CSI驱动程序插件，但它只在预览版中可用，所以我会等到它在未来的版本中正式发布。</p><h1 id="8497" class="li lj it bd lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf bi translated">加密etcd和EBS卷</h1><p id="4237" class="pw-post-body-paragraph jq jr it js b jt mg jv jw jx mh jz ka kb mi kd ke kf mj kh ki kj mk kl km kn im bi translated">默认情况下，Kubernetes秘密不加密地存储在主节点上的<code class="fe nb nc nd ne b">etcd</code>中。EKS提供了使用KMS来启用Kubernetes秘密的信封加密的选项，但这很容易被忽略。在EKS模块中配置<code class="fe nb nc nd ne b">cluster_encryption_config</code>模块:</p><pre class="kp kq kr ks gt nf ne ng nh aw ni bi"><span id="b78c" class="nj lj it ne b gy nk nl l nm nn">cluster_encryption_config = [{    <br/>  provider_key_arn = aws_kms_key.eks.arn    <br/>  resources        = ["secrets"]  <br/>}]</span></pre><p id="50cf" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">并相应地创建<a class="ae le" href="https://github.com/terraform-aws-modules/terraform-aws-eks/blob/master/examples/eks_managed_node_group/main.tf#L392-L460" rel="noopener ugc nofollow" target="_blank"> KMS资源</a>:</p><pre class="kp kq kr ks gt nf ne ng nh aw ni bi"><span id="bc0a" class="nj lj it ne b gy nk nl l nm nn">resource "aws_kms_key" "eks" {<br/>  description             = "EKS Secret Encryption Key"<br/>  deletion_window_in_days = 7<br/>  enable_key_rotation     = true</span><span id="48f0" class="nj lj it ne b gy np nl l nm nn">  tags = local.tags<br/>}</span><span id="87ae" class="nj lj it ne b gy np nl l nm nn">resource "aws_kms_key" "ebs" {<br/>  description             = "Customer managed key to encrypt EKS managed node group volumes"<br/>  deletion_window_in_days = 7<br/>  policy                  = data.aws_iam_policy_document.ebs.json<br/>}</span><span id="c839" class="nj lj it ne b gy np nl l nm nn"># This policy is required for the KMS key used for EKS root volumes, so the cluster is allowed to enc/dec/attach encrypted EBS volumes<br/>data "aws_iam_policy_document" "ebs" {<br/>  # Copy of default KMS policy that lets you manage it<br/>  statement {<br/>    sid       = "Enable IAM User Permissions"<br/>    actions   = ["kms:*"]<br/>    resources = ["*"]</span><span id="7a64" class="nj lj it ne b gy np nl l nm nn">principals {<br/>      type        = "AWS"<br/>      identifiers = ["arn:aws:iam::${data.aws_caller_identity.current.account_id}:root"]<br/>    }<br/>  }</span><span id="98e5" class="nj lj it ne b gy np nl l nm nn"># Required for EKS<br/>  statement {<br/>    sid = "Allow service-linked role use of the CMK"<br/>    actions = [<br/>      "kms:Encrypt",<br/>      "kms:Decrypt",<br/>      "kms:ReEncrypt*",<br/>      "kms:GenerateDataKey*",<br/>      "kms:DescribeKey"<br/>    ]<br/>    resources = ["*"]</span><span id="b09f" class="nj lj it ne b gy np nl l nm nn">principals {<br/>      type = "AWS"<br/>      identifiers = [<br/>        "arn:aws:iam::${data.aws_caller_identity.current.account_id}:role/aws-service-role/autoscaling.amazonaws.com/AWSServiceRoleForAutoScaling", # required for the ASG to manage encrypted volumes for nodes<br/>        module.eks.cluster_iam_role_arn,                                                                                                            # required for the cluster / persistentvolume-controller to create encrypted PVCs<br/>      ]<br/>    }<br/>  }</span><span id="b695" class="nj lj it ne b gy np nl l nm nn">statement {<br/>    sid       = "Allow attachment of persistent resources"<br/>    actions   = ["kms:CreateGrant"]<br/>    resources = ["*"]</span><span id="9126" class="nj lj it ne b gy np nl l nm nn">principals {<br/>      type = "AWS"<br/>      identifiers = [<br/>        "arn:aws:iam::${data.aws_caller_identity.current.account_id}:role/aws-service-role/autoscaling.amazonaws.com/AWSServiceRoleForAutoScaling", # required for the ASG to manage encrypted volumes for nodes<br/>        module.eks.cluster_iam_role_arn,                                                                                                            # required for the cluster / persistentvolume-controller to create encrypted PVCs<br/>      ]<br/>    }</span><span id="c4e8" class="nj lj it ne b gy np nl l nm nn">condition {<br/>      test     = "Bool"<br/>      variable = "kms:GrantIsForAWSResource"<br/>      values   = ["true"]<br/>    }<br/>  }<br/>}</span></pre><p id="08a2" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">要配置EBS卷以使用KMS，您还需要在Kubernetes中创建新的StorageClass对象，并配置您用上面的Terraform代码创建的<code class="fe nb nc nd ne b">kmsKeyId</code>。您还可以将这个新的存储类作为默认类，以确保通过永久卷声明配置的新EBS卷将始终被加密。</p><h1 id="2ccb" class="li lj it bd lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf bi translated">考虑手动管理aws-auth</h1><p id="f799" class="pw-post-body-paragraph jq jr it js b jt mg jv jw jx mh jz ka kb mi kd ke kf mj kh ki kj mk kl km kn im bi translated">EKS模块的一个已知问题是，它在同一个模块中使用了AWS提供者和Kubernetes提供者。当EKS集群的凭证未知或正在更新时，由于Terraform <a class="ae le" href="https://www.terraform.io/language/providers/configuration" rel="noopener ugc nofollow" target="_blank">无法可靠地支持在单个计划/应用中使用一个提供者来配置另一个提供者</a>，这就带来了挑战。当集群配置改变时(例如<a class="ae le" href="https://github.com/hashicorp/terraform-provider-kubernetes/issues/1182" rel="noopener ugc nofollow" target="_blank">在创建后启用秘密加密</a>)，用户经常遇到这个问题，Terraform认为它丢失了集群的凭证。</p><p id="7106" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">有两种解决方法:</p><ol class=""><li id="54cd" class="ml mm it js b jt ju jx jy kb mn kf mo kj mp kn na mr ms mt bi translated">在应用更改之前，从状态中删除Kubernetes资源(即<code class="fe nb nc nd ne b">terraform state rm module.eks.kubernetes_config_map.aws_auth</code>然后<code class="fe nb nc nd ne b">terraform plan</code>)</li><li id="85eb" class="ml mm it js b jt mu jx mv kb mw kf mx kj my kn na mr ms mt bi translated">在EKS模块中设置<code class="fe nb nc nd ne b">manage_aws_auth = false</code>，在Terraform之外管理configmap(这里看模块如何管理这个<a class="ae le" href="https://github.com/terraform-aws-modules/terraform-aws-eks/blob/a26c9fd0c9c880d5b99c438ad620e91dda957e10/aws_auth.tf#L65-L93" rel="noopener ugc nofollow" target="_blank">)。</a></li></ol><h1 id="fbe7" class="li lj it bd lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf bi translated">适当配置集群自动缩放</h1><p id="e431" class="pw-post-body-paragraph jq jr it js b jt mg jv jw jx mh jz ka kb mi kd ke kf mj kh ki kj mk kl km kn im bi translated">不像GKE，EKS没有集群自动缩放器(也许这将成为一个EKS管理的插件)。使用服务帐户的OIDC联合身份验证和<a class="ae le" href="https://docs.aws.amazon.com/eks/latest/userguide/iam-roles-for-service-accounts.html" rel="noopener ugc nofollow" target="_blank"> IAM角色</a>来部署集群autoscaler，自动发现功能已打开，标记由EKS Terraform模块配置。</p><p id="49de" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">在底层，cluster autoscaler利用Amazon EC2自动扩展组来管理每个节点组，这意味着它受到ASG面临的相同限制。例如，由于EBS卷是特定于区域的，因此对于EBS卷支持的状态集，群集自动缩放的简单部署可能不会在所需的可用性区域中触发扩展事件。为了减轻这种情况，请确保使用以下内容配置集群自动缩放器:</p><ul class=""><li id="d8b3" class="ml mm it js b jt ju jx jy kb mn kf mo kj mp kn mq mr ms mt bi translated"><code class="fe nb nc nd ne b">balance-similar-node-groups=true</code></li><li id="3358" class="ml mm it js b jt mu jx mv kb mw kf mx kj my kn mq mr ms mt bi translated">在不同可用性区域中配置的节点组</li></ul><p id="ade7" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">另一种解决方案是使用<a class="ae le" href="https://karpenter.sh/" rel="noopener ugc nofollow" target="_blank"> Karpenter </a>，其工作方式类似于<a class="ae le" href="https://cloud.google.com/kubernetes-engine/docs/concepts/autopilot-overview" rel="noopener ugc nofollow" target="_blank"> GKE自动驾驶的动态节点供应流程</a>。要深入了解Karpenter，请查看:</p><div class="nq nr gp gr ns nt"><a rel="noopener  ugc nofollow" target="_blank" href="/karpenter-open-source-high-performance-kubernetes-cluster-autoscaler-d56e3ab06aae"><div class="nu ab fo"><div class="nv ab nw cl cj nx"><h2 class="bd iu gy z fp ny fr fs nz fu fw is bi translated">Karpenter:开源、高性能的Kubernetes集群自动缩放器</h2><div class="oa l"><h3 class="bd b gy z fp ny fr fs nz fu fw dk translated">根据AWS，kubernetes-native cluster auto scaler现在已经可以生产了。</h3></div><div class="ob l"><p class="bd b dl z fp ny fr fs nz fu fw dk translated">itnext.io</p></div></div><div class="oc l"><div class="od l oe of og oc oh ky nt"/></div></div></a></div><h1 id="7792" class="li lj it bd lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf bi translated">利用开源工具</h1><p id="c847" class="pw-post-body-paragraph jq jr it js b jt mg jv jw jx mh jz ka kb mi kd ke kf mj kh ki kj mk kl km kn im bi translated">不幸的是，无论是Terraform还是AWS都没有提供一种方法来自动地对EKS集群中的底层实例进行变更。这意味着每次AMI需要更新或者Kubernetes版本需要升级时，所有的节点都需要手工清空和更新。通过Terraform实现这种行为的一种方法可能涉及创建一个新的节点组，并编写一个脚本来清空旧的节点组并缩小它们的规模。另一种选择是使用由Gruntwork团队维护的 <code class="fe nb nc nd ne b"><a class="ae le" href="https://github.com/gruntwork-io/kubergrunt#deploy" rel="noopener ugc nofollow" target="_blank">kubergrunt</a></code> <a class="ae le" href="https://github.com/gruntwork-io/kubergrunt#deploy" rel="noopener ugc nofollow" target="_blank">工具</a>的<code class="fe nb nc nd ne b"><a class="ae le" href="https://github.com/gruntwork-io/kubergrunt#deploy" rel="noopener ugc nofollow" target="_blank">deploy</a></code> <a class="ae le" href="https://github.com/gruntwork-io/kubergrunt#deploy" rel="noopener ugc nofollow" target="_blank">功能。这将自动创建新的节点组，隔离和清空旧的节点，并删除旧的工作节点。</a></p><p id="3790" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">对于其他有助于EKS管理的开源工具，请查看“<a class="ae le" href="https://yitaek.medium.com/useful-tools-for-better-kubernetes-development-87820c2b9435" rel="noopener">更好地开发Kubernetes的有用工具</a>”:</p><div class="nq nr gp gr ns nt"><a href="https://yitaek.medium.com/useful-tools-for-better-kubernetes-development-87820c2b9435" rel="noopener follow" target="_blank"><div class="nu ab fo"><div class="nv ab nw cl cj nx"><h2 class="bd iu gy z fp ny fr fs nz fu fw is bi translated">更好地开发Kubernetes的有用工具</h2><div class="oa l"><h3 class="bd b gy z fp ny fr fs nz fu fw dk translated">一系列出色的Kubernetes工具和项目，用于部署、保护和监控您的Kubernetes集群。</h3></div><div class="ob l"><p class="bd b dl z fp ny fr fs nz fu fw dk translated">yitaek.medium.com</p></div></div><div class="oc l"><div class="oi l oe of og oc oh ky nt"/></div></div></a></div><h1 id="5713" class="li lj it bd lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf bi translated">最终注释</h1><p id="f553" class="pw-post-body-paragraph jq jr it js b jt mg jv jw jx mh jz ka kb mi kd ke kf mj kh ki kj mk kl km kn im bi translated">近年来，EKS取得了巨大的进展，使EKS集群创建和管理的顺利经验。在托管功能方面，它仍然落后于GKE和AKS，但通过对现有工具包进行一些小的调整，人们可以轻松地组装一个生产级集群。如果在大规模操作EKS的过程中，我遗漏了其他的技巧和诀窍，请在下面评论。</p></div></div>    
</body>
</html>