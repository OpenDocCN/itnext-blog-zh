<html>
<head>
<title>Flutter Web: Twitch OAuth2 authentication flow implementation</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Flutter Web: Twitch OAuth2认证流程实现</h1>
<blockquote>原文：<a href="https://itnext.io/flutter-web-twitch-oauth2-authentication-flow-implementation-77d239c72be5?source=collection_archive---------0-----------------------#2021-02-20">https://itnext.io/flutter-web-twitch-oauth2-authentication-flow-implementation-77d239c72be5?source=collection_archive---------0-----------------------#2021-02-20</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="4aaf" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">目前在Flutter Web上很难实现OAuth2这样的认证流程。遇到的困难之一是从URL重定向获取身份验证令牌，因为您无法访问URL侦听器，也无法跟踪外部导航选项卡中的更改。</p><p id="7bf2" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我很难理解如何实现这种认证流程，而解决方案实际上非常简单。今天我将以Twitch的API为例进行解释。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div class="gh gi kl"><img src="../Images/d89bcb365691f37f8951c3d33229bd2a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1236/format:webp/1*x1g4gFCUFOFY1Suun8sH-g.jpeg"/></div></figure><h1 id="20cf" class="kt ku iq bd kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq bi translated">先决条件</h1><ul class=""><li id="7ad3" class="lr ls iq jp b jq lt ju lu jy lv kc lw kg lx kk ly lz ma mb bi translated">创建您的初始Flutter Web应用程序</li><li id="91ea" class="lr ls iq jp b jq mc ju md jy me kc mf kg mg kk ly lz ma mb bi translated">拥有有效的Twitch和Twitch开发者账户</li></ul><h1 id="17da" class="kt ku iq bd kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq bi translated">建立</h1><p id="0f3d" class="pw-post-body-paragraph jn jo iq jp b jq lt js jt ju lu jw jx jy mh ka kb kc mi ke kf kg mj ki kj kk ij bi translated">首先，你需要在<a class="ae mk" href="https://dev.twitch.tv/console" rel="noopener ugc nofollow" target="_blank"> Twitch开发者控制台</a>中注册一个应用程序，你可以随意命名它，并定义一个重定向URL:<a class="ae mk" href="http://localhost:8080" rel="noopener ugc nofollow" target="_blank">http://localhost:8080</a>(或者任何你想要的其他端口)。我使用的是本地主机URL，因为该示例不会在线托管，但您也可以随意添加将部署您的应用程序的URL。</p><p id="92c1" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">既然您已经在控制台上创建了应用程序，那么您应该已经获得了一个客户机id。您已经可以将它复制粘贴到您的<code class="fe ml mm mn mo b">main.dart</code>中。</p><pre class="km kn ko kp gt mp mo mq mr aw ms bi"><span id="86aa" class="mt ku iq mo b gy mu mv l mw mx">const String clientId = "YOUR_CLIENT_ID";</span></pre><h1 id="40d4" class="kt ku iq bd kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq bi translated">管理认证流程</h1><p id="d3c5" class="pw-post-body-paragraph jn jo iq jp b jq lt js jt ju lu jw jx jy mh ka kb kc mi ke kf kg mj ki kj kk ij bi translated">现在您已经有了客户端id，下一步是使用<a class="ae mk" href="https://dev.twitch.tv/docs/authentication/getting-tokens-oauth#oauth-implicit-code-flow" rel="noopener ugc nofollow" target="_blank"> OAuth隐式代码流</a>从Twitch的API获取认证令牌。</p><p id="1813" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">通过参考文档，在识别和授权之后，代码被返回到重定向URL中。</p><p id="793e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果你没有改变由Flutter生成的基础项目的结构，你应该有一个<code class="fe ml mm mn mo b">MyHomePage</code>类，它是一个<code class="fe ml mm mn mo b">StatefulWidget</code>。在类<code class="fe ml mm mn mo b">_MyHomePageState</code>中，您将添加一个变量:</p><pre class="km kn ko kp gt mp mo mq mr aw ms bi"><span id="f8bd" class="mt ku iq mo b gy mu mv l mw mx">/// To save the OAuth2 token.<br/>String _token;</span></pre><p id="8294" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在，您将在小部件的状态中实现<code class="fe ml mm mn mo b">initState</code>方法:</p><figure class="km kn ko kp gt kq"><div class="bz fp l di"><div class="my mz l"/></div></figure><p id="5014" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">让我解释一下这个方法内部发生了什么。</p><p id="8e56" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">首先，使用<code class="fe ml mm mn mo b">Uri.base</code>获取Flutter应用程序的当前URL。然后，通过参考Twitch的文档，你知道令牌在URL中返回如下:<code class="fe ml mm mn mo b">https://&lt;your registered redirect URI&gt;#access_token=&lt;an access token&gt;</code>这意味着如果你的URL包含<code class="fe ml mm mn mo b">access_token=</code>，你已经被Twitch重定向。</p><p id="ef0f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在你有两种情况:</p><ol class=""><li id="09d6" class="lr ls iq jp b jq jr ju jv jy na kc nb kg nc kk nd lz ma mb bi translated">您的URL中没有令牌，因此您需要进行身份验证。为了做到这一点，我们使用了<code class="fe ml mm mn mo b">dart:html</code>方法<code class="fe ml mm mn mo b">window.location(url)</code>,它将把我们当前标签的URL改为Twitch授权。</li><li id="0fdc" class="lr ls iq jp b jq mc ju md jy me kc mf kg mg kk nd lz ma mb bi translated">你已经被Twitch重定向，并且在你的URL中有令牌，所以你需要解析它来获得你的令牌，并把它保存在你的<code class="fe ml mm mn mo b">_token</code>变量中。</li></ol><h1 id="2716" class="kt ku iq bd kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq bi translated">启动应用程序</h1><p id="e84e" class="pw-post-body-paragraph jn jo iq jp b jq lt js jt ju lu jw jx jy mh ka kb kc mi ke kf kg mj ki kj kk ij bi translated">此时，您应该准备好了，您可以添加一个<code class="fe ml mm mn mo b">print(token)</code>来确保它已被正确获取，您只需运行命令:</p><pre class="km kn ko kp gt mp mo mq mr aw ms bi"><span id="3e4e" class="mt ku iq mo b gy mu mv l mw mx">flutter run -d chrome --web-port=8080</span></pre><p id="b26c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">该命令将在Google Chrome浏览器中运行您的应用程序，添加的参数将强制主机使用本地主机端口8080。请注意，我使用的是chrome，但它也适用于您可能传递的任何其他兼容参数。当然，如果你在Twitch开发者控制台中注册了一个不同于8080的端口，那么就使用这个。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div class="gh gi ne"><img src="../Images/e3304cc7ec43a4d7047f67299ab6f645.png" data-original-src="https://miro.medium.com/v2/resize:fit:1200/1*_lbg3DKQuVhkq8Ao6xiNYw.gif"/></div><figcaption class="nf ng gj gh gi nh ni bd b be z dk translated">结果</figcaption></figure><h1 id="f8b4" class="kt ku iq bd kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq bi translated">结论</h1><p id="33ca" class="pw-post-body-paragraph jn jo iq jp b jq lt js jt ju lu jw jx jy mh ka kb kc mi ke kf kg mj ki kj kk ij bi translated">这就是你要做的！正如您所看到的，这实际上很容易，重定向为您做了一切，Flutter足够聪明，不会受到URL中包含授权响应这一事实的干扰。通过使用这种实现，您不需要任何WebView或监听URL更改。虽然它可能不是对每个用例都有效，但我认为它仍然很有帮助。</p><p id="926f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">您可以在这里找到我在本文中使用的完整源代码:</p><div class="nj nk gp gr nl nm"><a href="https://github.com/TesteurManiak/flutter_web_twitch_auth" rel="noopener  ugc nofollow" target="_blank"><div class="nn ab fo"><div class="no ab np cl cj nq"><h2 class="bd ir gy z fp nr fr fs ns fu fw ip bi translated">TesteurManiak/flutter _ web _ twitch _ auth</h2><div class="nt l"><h3 class="bd b gy z fp nr fr fs ns fu fw dk translated">此时您不能执行该操作。您已使用另一个标签页或窗口登录。您已在另一个选项卡中注销，或者…</h3></div><div class="nu l"><p class="bd b dl z fp nr fr fs ns fu fw dk translated">github.com</p></div></div><div class="nv l"><div class="nw l nx ny nz nv oa kr nm"/></div></div></a></div></div></div>    
</body>
</html>