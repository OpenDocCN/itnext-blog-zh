<html>
<head>
<title>AWS: VPC Flow Logs — an overview and example with CloudWatch Logs Insights</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">AWS: VPC流量日志CloudWatch Logs Insights概述和示例</h1>
<blockquote>原文：<a href="https://itnext.io/aws-vpc-flow-logs-an-overview-and-example-with-cloudwatch-logs-insights-894b02a03199?source=collection_archive---------2-----------------------#2022-07-19">https://itnext.io/aws-vpc-flow-logs-an-overview-and-example-with-cloudwatch-logs-insights-894b02a03199?source=collection_archive---------2-----------------------#2022-07-19</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/d266187696dd0b3001d21901abcc248c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*RotXy7XKKz_-U59wSQ57sA.jpeg"/></div></div></figure><p id="14dd" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">AWS VPC流量日志允许您记录VPC中网络接口之间的流量信息。此外，这些日志可以存储在AWS S3中或发送到AWS CloudWatch日志，而启用流量日志记录不会以任何方式影响网络接口的性能。</p><p id="c1c4" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">让我们简要回顾一下基本概念和可用设置，并为VPC设置流日志，将数据传输到CloduWatch日志进行分析。</p><ul class=""><li id="5185" class="kw kx iq ka b kb kc kf kg kj ky kn kz kr la kv lb lc ld le bi translated"><a class="ae lf" href="https://rtfm.co.ua/en/aws-vpc-flow-logs-an-overview-and-example-with-cloudwatch-logs-insights/#VPC_Flow_Logs_overview" rel="noopener ugc nofollow" target="_blank"> VPC流量日志概述</a></li><li id="6091" class="kw kx iq ka b kb lg kf lh kj li kn lj kr lk kv lb lc ld le bi translated"><a class="ae lf" href="https://rtfm.co.ua/en/aws-vpc-flow-logs-an-overview-and-example-with-cloudwatch-logs-insights/#VPC_Flow_Logs_use_cases" rel="noopener ugc nofollow" target="_blank"> VPC流量日志用例</a></li><li id="b26c" class="kw kx iq ka b kb lg kf lh kj li kn lj kr lk kv lb lc ld le bi translated"><a class="ae lf" href="https://rtfm.co.ua/en/aws-vpc-flow-logs-an-overview-and-example-with-cloudwatch-logs-insights/#Flow_Log_record_-_fields" rel="noopener ugc nofollow" target="_blank">流量日志记录—字段</a></li><li id="4bd6" class="kw kx iq ka b kb lg kf lh kj li kn lj kr lk kv lb lc ld le bi translated"><a class="ae lf" href="https://rtfm.co.ua/en/aws-vpc-flow-logs-an-overview-and-example-with-cloudwatch-logs-insights/#VPC_Flow_Logs_Limitations" rel="noopener ugc nofollow" target="_blank"> VPC流量测井的局限性</a></li><li id="7e60" class="kw kx iq ka b kb lg kf lh kj li kn lj kr lk kv lb lc ld le bi translated"><a class="ae lf" href="https://rtfm.co.ua/en/aws-vpc-flow-logs-an-overview-and-example-with-cloudwatch-logs-insights/#Create_VPC_Flow_Log" rel="noopener ugc nofollow" target="_blank">创建VPC流量日志</a></li><li id="da01" class="kw kx iq ka b kb lg kf lh kj li kn lj kr lk kv lb lc ld le bi translated"><a class="ae lf" href="https://rtfm.co.ua/en/aws-vpc-flow-logs-an-overview-and-example-with-cloudwatch-logs-insights/#CloudWatch_Logs_Log_Group" rel="noopener ugc nofollow" target="_blank">云观察日志日志组</a></li><li id="d941" class="kw kx iq ka b kb lg kf lh kj li kn lj kr lk kv lb lc ld le bi translated"><a class="ae lf" href="https://rtfm.co.ua/en/aws-vpc-flow-logs-an-overview-and-example-with-cloudwatch-logs-insights/#IAM_Policy_and_IAM_Role" rel="noopener ugc nofollow" target="_blank"> IAM策略和IAM角色</a></li><li id="a546" class="kw kx iq ka b kb lg kf lh kj li kn lj kr lk kv lb lc ld le bi translated"><a class="ae lf" href="https://rtfm.co.ua/en/aws-vpc-flow-logs-an-overview-and-example-with-cloudwatch-logs-insights/#VPC_-_enabling_Flow_Logs" rel="noopener ugc nofollow" target="_blank"> VPC —启用流量日志</a></li><li id="fe8c" class="kw kx iq ka b kb lg kf lh kj li kn lj kr lk kv lb lc ld le bi translated"><a class="ae lf" href="https://rtfm.co.ua/en/aws-vpc-flow-logs-an-overview-and-example-with-cloudwatch-logs-insights/#CloudWatch_Logs_Insights" rel="noopener ugc nofollow" target="_blank"> CloudWatch日志洞察</a></li><li id="fccd" class="kw kx iq ka b kb lg kf lh kj li kn lj kr lk kv lb lc ld le bi translated"><a class="ae lf" href="https://rtfm.co.ua/en/aws-vpc-flow-logs-an-overview-and-example-with-cloudwatch-logs-insights/#VPC_Flow_Log_-_Custom_format" rel="noopener ugc nofollow" target="_blank"> VPC流量日志—自定义格式</a></li><li id="499f" class="kw kx iq ka b kb lg kf lh kj li kn lj kr lk kv lb lc ld le bi translated"><a class="ae lf" href="https://rtfm.co.ua/en/aws-vpc-flow-logs-an-overview-and-example-with-cloudwatch-logs-insights/#Flow_Log_Custom_format_and_CloudWatch_Logs_Insights" rel="noopener ugc nofollow" target="_blank">流量日志自定义格式，以及CloudWatch日志见解</a></li><li id="d478" class="kw kx iq ka b kb lg kf lh kj li kn lj kr lk kv lb lc ld le bi translated"><a class="ae lf" href="https://rtfm.co.ua/en/aws-vpc-flow-logs-an-overview-and-example-with-cloudwatch-logs-insights/#Logs_Insights_examples" rel="noopener ugc nofollow" target="_blank">日志洞察示例</a></li><li id="ac57" class="kw kx iq ka b kb lg kf lh kj li kn lj kr lk kv lb lc ld le bi translated"><a class="ae lf" href="https://rtfm.co.ua/en/aws-vpc-flow-logs-an-overview-and-example-with-cloudwatch-logs-insights/#Useful_links" rel="noopener ugc nofollow" target="_blank">有用链接</a></li><li id="f98c" class="kw kx iq ka b kb lg kf lh kj li kn lj kr lk kv lb lc ld le bi translated"><a class="ae lf" href="https://rtfm.co.ua/en/aws-vpc-flow-logs-an-overview-and-example-with-cloudwatch-logs-insights/#VPC_Flow_Logs" rel="noopener ugc nofollow" target="_blank"> VPC流量日志</a></li><li id="b5a0" class="kw kx iq ka b kb lg kf lh kj li kn lj kr lk kv lb lc ld le bi translated"><a class="ae lf" href="https://rtfm.co.ua/en/aws-vpc-flow-logs-an-overview-and-example-with-cloudwatch-logs-insights/#CloudWatch_Logs" rel="noopener ugc nofollow" target="_blank">云观察日志</a></li></ul><h1 id="f91e" class="ll lm iq bd ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi bi translated">VPC流量测井概述</h1><p id="ef1f" class="pw-post-body-paragraph jy jz iq ka b kb mj kd ke kf mk kh ki kj ml kl km kn mm kp kq kr mn kt ku kv ij bi translated">可以为整个VPC、子网或外部表面启用日志。如果为整个VPC启用，将为VPC的所有接口启用日志记录。</p><p id="2063" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">可以使用流日志的服务:</p><ul class=""><li id="0c90" class="kw kx iq ka b kb kc kf kg kj ky kn kz kr la kv lb lc ld le bi translated">弹性负载平衡</li><li id="bb56" class="kw kx iq ka b kb lg kf lh kj li kn lj kr lk kv lb lc ld le bi translated">亚马逊RDS</li><li id="b09a" class="kw kx iq ka b kb lg kf lh kj li kn lj kr lk kv lb lc ld le bi translated">亚马逊弹性缓存</li><li id="0aee" class="kw kx iq ka b kb lg kf lh kj li kn lj kr lk kv lb lc ld le bi translated">亚马逊红移</li><li id="fd12" class="kw kx iq ka b kb lg kf lh kj li kn lj kr lk kv lb lc ld le bi translated">亚马逊工作区</li><li id="7fe7" class="kw kx iq ka b kb lg kf lh kj li kn lj kr lk kv lb lc ld le bi translated">NAT网关</li><li id="8108" class="kw kx iq ka b kb lg kf lh kj li kn lj kr lk kv lb lc ld le bi translated">中转网关</li></ul><p id="0c0c" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">数据被记录为<a class="ae lf" href="https://docs.aws.amazon.com/vpc/latest/userguide/flow-logs.html#flow-log-records" rel="noopener ugc nofollow" target="_blank"> <em class="mo">流日志记录</em> </a>，并使用带有预定义字段的记录。</p><h2 id="867f" class="mp lm iq bd ln mq mr dn lr ms mt dp lv kj mu mv lz kn mw mx md kr my mz mh na bi translated">VPC流量日志用例</h2><p id="7cce" class="pw-post-body-paragraph jy jz iq ka b kb mj kd ke kf mk kh ki kj ml kl km kn mm kp kq kr mn kt ku kv ij bi translated">使用流日志可以跟踪什么？</p><ul class=""><li id="8591" class="kw kx iq ka b kb kc kf kg kj ky kn kz kr la kv lb lc ld le bi translated">安全组/网络访问列表规则—被阻止的请求将被标记为拒绝</li><li id="866d" class="kw kx iq ka b kb lg kf lh kj li kn lj kr lk kv lb lc ld le bi translated">我们实现的内容为我们记录了日志——了解VPC和服务之间的流量，以便了解谁消耗了最多的流量、在哪里消耗了多少跨AZ流量等等</li><li id="e410" class="kw kx iq ka b kb lg kf lh kj li kn lj kr lk kv lb lc ld le bi translated">监控系统的远程登录—监控端口22 (SSH)、3389 (RDP)</li><li id="f6f8" class="kw kx iq ka b kb lg kf lh kj li kn lj kr lk kv lb lc ld le bi translated">端口扫描跟踪</li></ul><h2 id="3f18" class="mp lm iq bd ln mq mr dn lr ms mt dp lv kj mu mv lz kn mw mx md kr my mz mh na bi translated">流量日志记录—字段</h2><p id="9f13" class="pw-post-body-paragraph jy jz iq ka b kb mj kd ke kf mk kh ki kj ml kl km kn mm kp kq kr mn kt ku kv ij bi translated">日志中的每个条目都是关于聚合间隔期间收到的IP流量的数据，并且是一行，其中的字段由空格分隔，每个字段都包含关于数据传输的信息，例如，源IP、目标IP和协议。</p><p id="6391" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">默认情况下，使用以下格式:</p><pre class="nb nc nd ne gt nf ng nh ni aw nj bi"><span id="ed37" class="mp lm iq ng b gy nk nl l nm nn">${version} ${account-id} ${interface-id} ${srcaddr} ${dstaddr} ${srcport} ${dstport} ${protocol} ${packets} ${bytes} ${start} ${end} ${action} ${log-status}</span></pre><p id="078f" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">参见<a class="ae lf" href="https://docs.aws.amazon.com/vpc/latest/userguide/flow-logs.html#flow-log-records" rel="noopener ugc nofollow" target="_blank">文档</a>中的<em class="mo">可用字段</em>表，版本2列中的所有内容都包含在默认格式中。</p><p id="983c" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">当创建流日志时，我们可以使用<em class="mo">默认的</em>格式，或者创建我们自己的格式——我们将在下面考虑:</p><figure class="nb nc nd ne gt jr gh gi paragraph-image"><div class="gh gi no"><img src="../Images/210a1fb9921226f1aa1ef3f82823cb06.png" data-original-src="https://miro.medium.com/v2/resize:fit:1212/format:webp/0*hC-oV732eFONHPt6.png"/></div></figure><h2 id="1ea4" class="mp lm iq bd ln mq mr dn lr ms mt dp lv kj mu mv lz kn mw mx md kr my mz mh na bi translated">VPC流量测井限制</h2><ul class=""><li id="2770" class="kw kx iq ka b kb mj kf mk kj np kn nq kr nr kv lb lc ld le bi translated">不能与EC2-Classic实例一起使用</li><li id="ffa2" class="kw kx iq ka b kb lg kf lh kj li kn lj kr lk kv lb lc ld le bi translated">您不能为VPC peering创建日志，如果它们导致不同帐户的VPC</li><li id="a806" class="kw kx iq ka b kb lg kf lh kj li kn lj kr lk kv lb lc ld le bi translated">创建日志后，您不能更改其配置或记录格式</li></ul><p id="dda7" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">此外，请记住:</p><ul class=""><li id="3505" class="kw kx iq ka b kb kc kf kg kj ky kn kz kr la kv lb lc ld le bi translated">Amazon DNS的记录不会被记录，但如果使用您自己的DNS，则会被写入</li><li id="c690" class="kw kx iq ka b kb lg kf lh kj li kn lj kr lk kv lb lc ld le bi translated">不记录进出地址169.254.169.254以获取<a class="ae lf" href="https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/ec2-instance-metadata.html" rel="noopener ugc nofollow" target="_blank"> EC2实例元数据</a>的流量</li><li id="4e0e" class="kw kx iq ka b kb lg kf lh kj li kn lj kr lk kv lb lc ld le bi translated">不会记录EC2网络接口和AWS网络负载平衡器接口之间的流量</li></ul><p id="cb17" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">参见<a class="ae lf" href="https://docs.aws.amazon.com/vpc/latest/userguide/flow-logs.html#flow-logs-limitations" rel="noopener ugc nofollow" target="_blank">流量测井限制</a>中的所有限制。</p><h1 id="e601" class="ll lm iq bd ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi bi translated">创建VPC流量日志</h1><p id="10bc" class="pw-post-body-paragraph jy jz iq ka b kb mj kd ke kf mk kh ki kj ml kl km kn mm kp kq kr mn kt ku kv ij bi translated">要创建流日志，我们需要指定:</p><ul class=""><li id="9540" class="kw kx iq ka b kb kc kf kg kj ky kn kz kr la kv lb lc ld le bi translated">我们将写入其日志的资源— VPC、子网或特定网络接口</li><li id="4af1" class="kw kx iq ka b kb lg kf lh kj li kn lj kr lk kv lb lc ld le bi translated">我们记录的流量类型(接受的流量、拒绝的流量或所有流量)</li><li id="11a4" class="kw kx iq ka b kb lg kf lh kj li kn lj kr lk kv lb lc ld le bi translated">以及我们将数据写入何处——写入S3存储桶，还是写入CloudWatch日志</li></ul><p id="b3e7" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">现在，让我们看看CloudWatch日志会发生什么，下次我们将尝试在<a class="ae lf" href="https://rtfm.co.ua/en/elastic-stack-an-overview-and-elk-installation-on-ubuntu-20-04/" rel="noopener ugc nofollow" target="_blank"> Kibana </a>中可视化。</p><h2 id="8a7e" class="mp lm iq bd ln mq mr dn lr ms mt dp lv kj mu mv lz kn mw mx md kr my mz mh na bi translated">云观察日志日志组</h2><p id="34aa" class="pw-post-body-paragraph jy jz iq ka b kb mj kd ke kf mk kh ki kj ml kl km kn mm kp kq kr mn kt ku kv ij bi translated">创建日志组:</p><figure class="nb nc nd ne gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi ns"><img src="../Images/8c9e5a713930f9ff6c0be8b688ac2dea.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*_afGw33UrI810gIf.png"/></div></div></figure><figure class="nb nc nd ne gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nt"><img src="../Images/97e46845d1bb45c04e9d3ac9dcf9c530.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*sMHA891o7CG8cDbf.png"/></div></div></figure><h2 id="1b6a" class="mp lm iq bd ln mq mr dn lr ms mt dp lv kj mu mv lz kn mw mx md kr my mz mh na bi translated">IAM策略和IAM角色</h2><p id="eebb" class="pw-post-body-paragraph jy jz iq ka b kb mj kd ke kf mk kh ki kj ml kl km kn mm kp kq kr mn kt ku kv ij bi translated">为了让流日志服务能够写入我们的CloudWatch，我们需要配置它的访问权限。</p><p id="d513" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">转到AWS IAM，创建IAM策略和IAM角色。</p><p id="a5b4" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">从IAM策略开始:</p><figure class="nb nc nd ne gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nu"><img src="../Images/d64d83174aef4d6fc3ee76156266bab1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*AoZlzgPrBhMliWVS.png"/></div></div></figure><p id="9769" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">添加规则:</p><pre class="nb nc nd ne gt nf ng nh ni aw nj bi"><span id="46df" class="mp lm iq ng b gy nk nl l nm nn">{<br/>  "Version": "2012-10-17",<br/>  "Statement": [<br/>    {<br/>      "Action": [<br/>        "logs:CreateLogGroup",<br/>        "logs:CreateLogStream",<br/>        "logs:PutLogEvents",<br/>        "logs:DescribeLogGroups",<br/>        "logs:DescribeLogStreams"<br/>      ],<br/>      "Effect": "Allow",<br/>      "Resource": "*"<br/>    }<br/>  ]<br/>}</span></pre><p id="2246" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">保存:</p><figure class="nb nc nd ne gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nv"><img src="../Images/4f9e39529038427b28bed0668a180133.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*cpzfqQ-tQp_ft8WJ.png"/></div></div></figure><p id="d516" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">现在，创建一个IAM角色。</p><p id="7dd6" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">转到IAM角色，创建一个新角色，类型为EC2:</p><figure class="nb nc nd ne gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nu"><img src="../Images/e2fc4b8487bde52fdb934f1896915c29.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*zdI--87N6R2Jb1MT.png"/></div></div></figure><p id="3a65" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">找到我们在上面创建的策略，并附加它:</p><figure class="nb nc nd ne gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nu"><img src="../Images/d347f9e468ca89119b22fee19c8d7188.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*tnhs_uVHHgO0X5oj.png"/></div></div></figure><p id="6877" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">设置其名称，保存:</p><figure class="nb nc nd ne gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nw"><img src="../Images/dfad4a726b4704c02f2ca08ee180f862.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*9iRy_1tckaqsXyru.png"/></div></div></figure><p id="111b" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">转到<em class="mo">角色信任关系</em>(参见<a class="ae lf" href="https://rtfm.co.ua/aws-iam-assumerole-opisanie-primery/" rel="noopener ugc nofollow" target="_blank"> AWS: IAM AssumeRole — описание，примеры </a>)，编辑它—为<code class="fe nx ny nz ng b">Service</code>字段设置<em class="mo">vpc-flow-logs.amazonaws.com</em>:</p><figure class="nb nc nd ne gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi oa"><img src="../Images/443052da12a4c8fa005da4dab7de9a40.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*Do_SzfKG_CNqYCrs.jpg"/></div></div></figure><p id="c72b" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">设置:</p><pre class="nb nc nd ne gt nf ng nh ni aw nj bi"><span id="60db" class="mp lm iq ng b gy nk nl l nm nn">{<br/>  "Version": "2012-10-17",<br/>  "Statement": [<br/>    {<br/>      "Sid": "",<br/>      "Effect": "Allow",<br/>      "Principal": {<br/>        "Service": "vpc-flow-logs.amazonaws.com"<br/>      },<br/>      "Action": "sts:AssumeRole"<br/>    }<br/>  ]<br/>}</span></pre><p id="9061" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">保存:</p><figure class="nb nc nd ne gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi ob"><img src="../Images/a2dba08e913603daa105c2da75cedb5a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*TgEUopwUvbKDvwkA.png"/></div></div></figure><h2 id="e201" class="mp lm iq bd ln mq mr dn lr ms mt dp lv kj mu mv lz kn mw mx md kr my mz mh na bi translated">VPC-启用流量日志</h2><p id="78db" class="pw-post-body-paragraph jy jz iq ka b kb mj kd ke kf mk kh ki kj ml kl km kn mm kp kq kr mn kt ku kv ij bi translated">最后，转到VPC启用日志—点击<em class="mo">流日志&gt;创建</em>:</p><figure class="nb nc nd ne gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi oc"><img src="../Images/3050c8cb8805caa2ace186c9b8c6f0ea.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*jqeQMWjJnjUXULNQ.png"/></div></div></figure><p id="615a" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">设置其名称，<em class="mo">过滤器</em>，<em class="mo">间隔</em>:</p><figure class="nb nc nd ne gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi od"><img src="../Images/e619bc224037da9043009be50009c50f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*wqE2-wdXrJ6tGTsB.png"/></div></div></figure><p id="77d7" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在<em class="mo">目的地</em>选择了CloudWatch日志，指定日志组和IAM角色:</p><figure class="nb nc nd ne gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi oe"><img src="../Images/350aa50a7eb444a9528c549193e795cf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*PlJU6iXy99FmYoQz.png"/></div></div></figure><p id="7eaa" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">格式—保留默认的<em class="mo"/>。</p><p id="efca" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">检查<em class="mo">状态</em>:</p><figure class="nb nc nd ne gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi of"><img src="../Images/7b6ba4e898c208f9ee339e12ed05e898.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*khtH05gbWreuO-pE.png"/></div></div></figure><p id="4dd2" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">几分钟后，我们将看到我们的数据:</p><figure class="nb nc nd ne gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi og"><img src="../Images/fb459704280dcb3fbfda50f39581fbf2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*L3mF_phktLlssBUq.png"/></div></div></figure><p id="8a6a" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在日志组中，您可以找到由弹性网络接口命名的第一个流，数据就是从该流中获取的:</p><figure class="nb nc nd ne gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi oh"><img src="../Images/c74a04816ea212b7a3f4df96ab065f13.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*BIZWGG2dCXGfuBrK.jpg"/></div></div></figure><h1 id="6219" class="ll lm iq bd ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi bi translated">CloudWatch日志洞察</h1><p id="a21c" class="pw-post-body-paragraph jy jz iq ka b kb mj kd ke kf mk kh ki kj ml kl km kn mm kp kq kr mn kt ku kv ij bi translated">让我们快速浏览一下CloudWatch日志洞察。</p><p id="fd0c" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">点击<em class="mo">查询</em>得到一些提示:</p><figure class="nb nc nd ne gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi oi"><img src="../Images/4dcc38815fb8587c623d17795c7036bf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*b60gFpwIahu6e1BH.png"/></div></div></figure><p id="858f" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">例如，要查找为大多数数据包提供服务的前15台主机:</p><figure class="nb nc nd ne gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi oi"><img src="../Images/85d4a3e8fec5d0920c4d55013baad726.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*u0LUaE7_0SO0fez8.png"/></div></div></figure><p id="426e" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">或者通过传输的数据量:</p><pre class="nb nc nd ne gt nf ng nh ni aw nj bi"><span id="d98f" class="mp lm iq ng b gy nk nl l nm nn">stats sum(bytes) as BytesSent by srcAddr, dstAddr<br/>| sort BytesSent desc</span></pre><figure class="nb nc nd ne gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi oi"><img src="../Images/d29e6d5cebc9f78f2598e3f15e48ebc6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*Lfqi5ArL_EgT7NTt.png"/></div></div></figure><p id="07ae" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">好的，很好。但是其他形式呢？</p><p id="9a8a" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">例如，我希望看到一个请求方向(出口/入口)和一个<code class="fe nx ny nz ng b">pkt-dstaddr</code>字段的值。</p><h1 id="b447" class="ll lm iq bd ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi bi translated">VPC流量测井—自定义格式</h1><p id="5043" class="pw-post-body-paragraph jy jz iq ka b kb mj kd ke kf mk kh ki kj ml kl km kn mm kp kq kr mn kt ku kv ij bi translated">更多信息参见<a class="ae lf" href="https://docs.aws.amazon.com/vpc/latest/userguide/flow-logs-records-examples.html" rel="noopener ugc nofollow" target="_blank">流量日志记录示例</a>。</p><p id="8004" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">现在，我们可以设置以下格式:</p><pre class="nb nc nd ne gt nf ng nh ni aw nj bi"><span id="b57a" class="mp lm iq ng b gy nk nl l nm nn">region vpc-id az-id subnet-id instance-id interface-id flow-direction srcaddr dstaddr srcport dstport pkt-srcaddr pkt-dstaddr pkt-src-aws-service pkt-dst-aws-service traffic-path packets bytes action</span></pre><p id="9e85" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在CloudWatch日志中创建新的日志组，将其命名为<em class="mo">Bt trm-eks-dev-1–21-VPC-fl-custom</em>，不要忘记保留:</p><figure class="nb nc nd ne gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi oj"><img src="../Images/c61cadf0f826afb57371068eead0bb11.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*_3cCYugJP1vSn4uy.png"/></div></div></figure><p id="7094" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">回到VPC，创建一个新的流日志，并将其命名为<em class="mo">Bt trm-eks-dev-1–21-VPC-fl-custom</em>:</p><figure class="nb nc nd ne gt jr gh gi paragraph-image"><div class="gh gi ok"><img src="../Images/7b3c7d196da0924cdf9096827c711cac.png" data-original-src="https://miro.medium.com/v2/resize:fit:1388/format:webp/0*ZBbB9YMACnLocJU1.png"/></div></figure><p id="1001" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">选择了<em class="mo">自定义格式</em>和字段，这是我们想看到的。这样做时，请考虑您将在此处指定的字段顺序将用于对日志中的记录进行排序。</p><p id="b645" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">即，如果第一个字段是“<em class="mo">区域</em>”——那么在最终日志中，它也将被设置为第一个字段:</p><figure class="nb nc nd ne gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi ol"><img src="../Images/1f7260f4e9e250821feaad173948973f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*E0LaLcr3jfe9vPSG.png"/></div></div></figure><p id="4adc" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">结果是:</p><pre class="nb nc nd ne gt nf ng nh ni aw nj bi"><span id="e5a8" class="mp lm iq ng b gy nk nl l nm nn">${region} ${vpc-id} ${az-id} ${subnet-id} ${instance-id} ${interface-id} ${flow-direction} ${srcaddr} ${dstaddr} ${srcport} ${dstport} ${pkt-srcaddr} ${pkt-dstaddr} ${pkt-src-aws-service} ${pkt-dst-aws-service} ${traffic-path} ${packets} ${bytes} ${action}</span></pre><figure class="nb nc nd ne gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi ol"><img src="../Images/0f083a2b098f74e8e674384a4a0d8066.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*rqqh1yrWPLTOTGeM.png"/></div></div></figure><h2 id="12a0" class="mp lm iq bd ln mq mr dn lr ms mt dp lv kj mu mv lz kn mw mx md kr my mz mh na bi translated">流量日志自定义格式，以及CloudWatch日志洞察</h2><p id="b623" class="pw-post-body-paragraph jy jz iq ka b kb mj kd ke kf mk kh ki kj ml kl km kn mm kp kq kr mn kt ku kv ij bi translated">但是，如果我们现在转到CloudWatch Logs Insights，并尝试以前使用的任何查询，我们将不会获得我们已经设置的字段</p><figure class="nb nc nd ne gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi om"><img src="../Images/861c602a68b24de905724fa444ecc53f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*2iHdSQzkWgN5ryX3.png"/></div></div></figure><p id="4bdf" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">因此，我们可以看到数据，但我们如何将它拆分到字段中呢？</p><p id="5645" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在我们的项目中，我不认为我们会大量使用CloudWatch日志，最有可能的是数据将被发送到一个S3桶，然后到(logz.io)，因此，我不会在这里详细深入，但让我们看看操作的原理——它将在以后对ELK的工作中派上用场。</p><p id="e413" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">默认情况下，CloudWatch日志会创建几个我们可以在请求中使用的元字段:</p><ul class=""><li id="e3aa" class="kw kx iq ka b kb kc kf kg kj ky kn kz kr la kv lb lc ld le bi translated"><code class="fe nx ny nz ng b">@message</code>:“原始”数据——文本中的全部信息</li><li id="be4d" class="kw kx iq ka b kb lg kf lh kj li kn lj kr lk kv lb lc ld le bi translated"><code class="fe nx ny nz ng b">@timestamp</code>:事件发生的时间</li><li id="d884" class="kw kx iq ka b kb lg kf lh kj li kn lj kr lk kv lb lc ld le bi translated"><code class="fe nx ny nz ng b">@logStream</code>:一条蜿蜒的小溪的名字</li></ul><p id="e982" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">对于查看字段的自定义格式，我们需要使用<code class="fe nx ny nz ng b"><a class="ae lf" href="https://docs.aws.amazon.com/AmazonCloudWatch/latest/logs/CWL_QuerySyntax.html" rel="noopener ugc nofollow" target="_blank">parse</a></code>并将<code class="fe nx ny nz ng b">@message</code>传递给它，这样它将根据我们指定的字段解析内容:</p><pre class="nb nc nd ne gt nf ng nh ni aw nj bi"><span id="b4e3" class="mp lm iq ng b gy nk nl l nm nn">parse @message "* * * * * * * * * * * * * * * * * * *" <br/>| as region, vpc_id, az_id, subnet_id, instance_id, interface_id, <br/>| flow_direction, srcaddr, dstaddr, srcport, dstport, <br/>| pkt_srcaddr, pkt_dstaddr, pkt_src_aws_service, pkt_dst_aws_service, <br/>| traffic_path, packets, bytes, action <br/>| sort start desc</span></pre><p id="a17d" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">这里，<code class="fe nx ny nz ng b">@message</code>中的星号“<code class="fe nx ny nz ng b">*</code>”的个数必须相同，和我们设置的很多字段一样- <code class="fe nx ny nz ng b">${vpc-id}</code> и т.д。</p><p id="05d7" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">此外，字段名称不得包含破折号。也就是我们要吃的<code class="fe nx ny nz ng b">${vpc-id}</code>名为<code class="fe nx ny nz ng b">vpc_id</code>(或者<code class="fe nx ny nz ng b">vpcID</code> -随你便)。</p><p id="11ac" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">检查:</p><figure class="nb nc nd ne gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi om"><img src="../Images/d954b98c54e05d84ae69c804b0bc12a7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*on_P5C2smVMOPl_x.png"/></div></div></figure><p id="c6c7" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">哇！现在，我们得到了所有的田地。</p><p id="5516" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">除了<code class="fe nx ny nz ng b">parse</code>，我们还可以使用<code class="fe nx ny nz ng b">filter</code>、<code class="fe nx ny nz ng b">display</code>、<code class="fe nx ny nz ng b">stats</code>。查看<a class="ae lf" href="https://docs.aws.amazon.com/AmazonCloudWatch/latest/logs/CWL_QuerySyntax.html" rel="noopener ugc nofollow" target="_blank"> CloudWatch日志中的所有洞察查询语法</a>。</p><h2 id="4bad" class="mp lm iq bd ln mq mr dn lr ms mt dp lv kj mu mv lz kn mw mx md kr my mz mh na bi translated">日志洞察示例</h2><p id="fb13" class="pw-post-body-paragraph jy jz iq ka b kb mj kd ke kf mk kh ki kj ml kl km kn mm kp kq kr mn kt ku kv ij bi translated">让我们尝试进行几个查询，例如，获取被安全组/网络访问列表阻止的所有请求，它们将被标记为<em class="mo">拒绝。</em></p><p id="8c9b" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">让我们看看之前的查询:</p><pre class="nb nc nd ne gt nf ng nh ni aw nj bi"><span id="e788" class="mp lm iq ng b gy nk nl l nm nn">parse @message "* * * * * * * * * * * * * * * * * * * * * *" <br/>| as start, end, region, vpc_id, az_id, subnet_id, instance_id, interface_id, <br/>| flow_direction, srcaddr, dstaddr, srcport, dstport, protocol, <br/>| pkt_srcaddr, pkt_dstaddr, pkt_src_aws_service, pkt_dst_aws_service, <br/>| traffic_path, packets, bytes, action</span></pre><p id="99c8" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在那里加上:</p><ul class=""><li id="3cbf" class="kw kx iq ka b kb kc kf kg kj ky kn kz kr la kv lb lc ld le bi translated"><code class="fe nx ny nz ng b">filter action="REJECT"</code></li><li id="0d52" class="kw kx iq ka b kb lg kf lh kj li kn lj kr lk kv lb lc ld le bi translated"><code class="fe nx ny nz ng b">stats count(action) as redjects by srcaddr</code></li><li id="79ec" class="kw kx iq ka b kb lg kf lh kj li kn lj kr lk kv lb lc ld le bi translated"><code class="fe nx ny nz ng b">sort redjects desc</code></li></ul><p id="9632" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">这里:</p><ul class=""><li id="5c85" class="kw kx iq ka b kb kc kf kg kj ky kn kz kr la kv lb lc ld le bi translated">通过应用于数据包的操作进行过滤—选择所有被拒绝的<em class="mo"/></li><li id="9f15" class="kw kx iq ka b kb lg kf lh kj li kn lj kr lk kv lb lc ld le bi translated">通过<em class="mo">动作</em>字段统计事件数量，通过源的IP地址选择，并显示在<em class="mo"> redjects </em>列</li><li id="457e" class="kw kx iq ka b kb lg kf lh kj li kn lj kr lk kv lb lc ld le bi translated">并按<em class="mo">对象</em>排序</li></ul><p id="5f46" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">因此，现在完整的查询将是:</p><pre class="nb nc nd ne gt nf ng nh ni aw nj bi"><span id="79eb" class="mp lm iq ng b gy nk nl l nm nn">parse @message "* * * * * * * * * * * * * * * * * * *" <br/>| as region, vpc_id, az_id, subnet_id, instance_id, interface_id, <br/>| flow_direction, srcaddr, dstaddr, srcport, dstport, <br/>| pkt_srcaddr, pkt_dstaddr, pkt_src_aws_service, pkt_dst_aws_service, <br/>| traffic_path, packets, bytes, action <br/>| filter action="REJECT" <br/>| stats count(action) as redjects by srcaddr <br/>| sort redjects desc</span></pre><p id="a734" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">其结果是:</p><figure class="nb nc nd ne gt jr gh gi paragraph-image"><div class="gh gi on"><img src="../Images/6f22cd08e91b5561efb5a1861a4b9cf4.png" data-original-src="https://miro.medium.com/v2/resize:fit:938/format:webp/0*xMLOycFZ9Yg91X3q.png"/></div></figure><p id="c461" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我们也可以使用负过滤器，并结合使用<code class="fe nx ny nz ng b">and</code> / <code class="fe nx ny nz ng b">or</code>操作符。</p><p id="59bc" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">例如，要从输出中删除以<em class="mo"> 162.142.125 </em>开始的所有IP—添加过滤器<code class="fe nx ny nz ng b">filter (srcaddr not like "162.142.125.")</code>:</p><pre class="nb nc nd ne gt nf ng nh ni aw nj bi"><span id="4d1d" class="mp lm iq ng b gy nk nl l nm nn">...<br/>| filter action="REJECT"<br/>| filter (srcaddr not like "162.142.125.")<br/>| stats count(action) as redjects by srcaddr<br/>| sort redjects desc</span></pre><p id="351d" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">参见<a class="ae lf" href="https://docs.aws.amazon.com/AmazonCloudWatch/latest/logs/CWL_QuerySyntax-examples.html" rel="noopener ugc nofollow" target="_blank">样本查询</a>。</p><p id="d379" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">并添加一个过滤器来只选择传入的请求—<code class="fe nx ny nz ng b">flow_direction</code>=<em class="mo">ingress</em>:</p><pre class="nb nc nd ne gt nf ng nh ni aw nj bi"><span id="3a23" class="mp lm iq ng b gy nk nl l nm nn">...<br/>| filter action="REJECT"<br/>| filter (srcaddr not like "162.142.125.") and (flow_direction like "ingress")<br/>| stats count(action) as redjects by flow_direction, srcaddr, dstaddr, pkt_srcaddr, pkt_dstaddr<br/>| sort redjects desc</span></pre><figure class="nb nc nd ne gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi oo"><img src="../Images/e5df0588040851252a2f116527b356ab.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*T34IRcT0Bm2X60J_.png"/></div></div></figure><p id="c87e" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">现在，当安全组或VPC网络访问列表规则起作用时，我们得到了被拒绝的请求的顶部。</p><p id="cf52" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">让我们看看<code class="fe nx ny nz ng b">dstaddr</code>中的IP是什么——谁是最终目的地？</p><p id="354c" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">转到E <em class="mo"> C2 &gt;网络接口</em>，通过私有IP找到:</p><figure class="nb nc nd ne gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi op"><img src="../Images/03470184df390fb1f55da1b35870d6eb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*-IIM7o5BX2_c1iYt.png"/></div></div></figure><p id="fe77" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">找到“<em class="mo">弹性IP地址所有者</em>”:</p><figure class="nb nc nd ne gt jr gh gi paragraph-image"><div class="gh gi oq"><img src="../Images/74fc244065dd33499007db8fe50488da.png" data-original-src="https://miro.medium.com/v2/resize:fit:408/format:webp/0*Xdn4Qug-QHZAiq2c.png"/></div></figure><p id="7974" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">好的，这是其中一个负载平衡器。</p><p id="2f72" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">如果在AWS中找不到一个IP，它可能是一个<a class="ae lf" href="https://rtfm.co.ua/en/kubernetes-what-is-endpoints/" rel="noopener ugc nofollow" target="_blank"> Kubernetes端点</a>，请使用:</p><p id="9ad1" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">kubectl获取端点—所有名称空间| grep 10.1.55.140</p><p id="0b40" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">开发-IOs-检查-翻译-ns IOs-检查-翻译-后端-svc 10.1.55.140:3000 58d</p><p id="35c4" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">开发-IOs-检查-转换-ns IOs-检查-转换-前端-svc 10.1.55.140:80 58d</p><p id="1c85" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">其实就这些了。</p><h1 id="4178" class="ll lm iq bd ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi bi translated">有用的链接</h1><h2 id="0ed6" class="mp lm iq bd ln mq mr dn lr ms mt dp lv kj mu mv lz kn mw mx md kr my mz mh na bi translated">VPC流量测井</h2><ul class=""><li id="a59f" class="kw kx iq ka b kb mj kf mk kj np kn nq kr nr kv lb lc ld le bi translated"><a class="ae lf" href="https://docs.elastic.co/en/integrations/aws/vpcflow" rel="noopener ugc nofollow" target="_blank">用弹性代理收集亚马逊VPC流量日志</a>—поляипрочеедлякибаны.</li><li id="1105" class="kw kx iq ka b kb lg kf lh kj li kn lj kr lk kv lb lc ld le bi translated"><a class="ae lf" href="https://docs.aws.amazon.com/vpc/latest/userguide/flow-logs-records-examples.html" rel="noopener ugc nofollow" target="_blank">流量日志记录示例</a></li></ul><h2 id="296d" class="mp lm iq bd ln mq mr dn lr ms mt dp lv kj mu mv lz kn mw mx md kr my mz mh na bi translated">CloudWatch日志</h2><ul class=""><li id="4ac2" class="kw kx iq ka b kb mj kf mk kj np kn nq kr nr kv lb lc ld le bi translated"><a class="ae lf" href="https://panther.com/cyber-explained/aws-security-logging-vpc-flow-logs/" rel="noopener ugc nofollow" target="_blank"> AWS安全日志基础— VPC流量日志</a>—пиимерcloud watch日志с Athena</li><li id="fa77" class="kw kx iq ka b kb lg kf lh kj li kn lj kr lk kv lb lc ld le bi translated"><a class="ae lf" href="https://dheeraj3choudhary.com/analyze-query-and-visualize-aws-cloudwatch-logs-using-logs-insight" rel="noopener ugc nofollow" target="_blank">使用Logs Insight分析查询并可视化AWS Cloudwatch日志</a> — прмиеры запросов в Cloudwatch日志</li><li id="c018" class="kw kx iq ka b kb lg kf lh kj li kn lj kr lk kv lb lc ld le bi translated"><a class="ae lf" href="https://aws.amazon.com/blogs/security/how-to-visualize-and-refine-your-networks-security-by-adding-security-group-ids-to-your-vpc-flow-logs/" rel="noopener ugc nofollow" target="_blank">如何通过向您的VPC流量日志添加安全组id来可视化和优化您的网络安全</a></li><li id="08e7" class="kw kx iq ka b kb lg kf lh kj li kn lj kr lk kv lb lc ld le bi translated"><a class="ae lf" href="https://docs.aws.amazon.com/AmazonCloudWatch/latest/logs/CWL_Insights-Visualizing-Log-Data.html" rel="noopener ugc nofollow" target="_blank">在图形中可视化测井数据</a></li><li id="853e" class="kw kx iq ka b kb lg kf lh kj li kn lj kr lk kv lb lc ld le bi translated"><a class="ae lf" href="https://marbot.io/blog/analyze-cloudwatch-logs-like-a-pro.html" rel="noopener ugc nofollow" target="_blank">像专家一样分析CloudWatch日志</a></li><li id="7a92" class="kw kx iq ka b kb lg kf lh kj li kn lj kr lk kv lb lc ld le bi translated"><a class="ae lf" href="https://harishkm.in/2020/06/25/filter-parse-group-log-data-in-aws-cloudwatch-logs-insights/" rel="noopener ugc nofollow" target="_blank">过滤、解析AWS CloudWatch Logs Insights中的&amp;组日志数据</a></li><li id="4024" class="kw kx iq ka b kb lg kf lh kj li kn lj kr lk kv lb lc ld le bi translated"><a class="ae lf" href="https://aws.amazon.com/ru/premiumsupport/knowledge-center/cloudwatch-vpc-flow-logs/" rel="noopener ugc nofollow" target="_blank">如何使用CloudWatch Logs Insights分析定制的VPC流量日志？</a> — ещё примеры</li><li id="4d81" class="kw kx iq ka b kb lg kf lh kj li kn lj kr lk kv lb lc ld le bi translated"><a class="ae lf" href="https://aws.amazon.com/ru/premiumsupport/knowledge-center/vpc-flow-logs-and-cloudwatch-logs-insights/" rel="noopener ugc nofollow" target="_blank">如何在我的VPC流量日志中使用CloudWatch Logs Insights查询？</a></li><li id="b7b4" class="kw kx iq ka b kb lg kf lh kj li kn lj kr lk kv lb lc ld le bi translated"><a class="ae lf" href="https://docs.aws.amazon.com/AmazonCloudWatch/latest/logs/CWL_QuerySyntax.html" rel="noopener ugc nofollow" target="_blank"> CloudWatch日志洞察查询语法</a></li><li id="2993" class="kw kx iq ka b kb lg kf lh kj li kn lj kr lk kv lb lc ld le bi translated"><a class="ae lf" href="https://www.cloudreach.com/en/technical-blog/networking-issues-cloudwatch-logs-insights/" rel="noopener ugc nofollow" target="_blank">使用AWS CloudWatch Logs Insights对网络问题进行分类</a></li></ul></div><div class="ab cl or os hu ot" role="separator"><span class="ou bw bk ov ow ox"/><span class="ou bw bk ov ow ox"/><span class="ou bw bk ov ow"/></div><div class="ij ik il im in"><p id="5a8d" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><em class="mo">最初发表于</em> <a class="ae lf" href="https://rtfm.co.ua/en/aws-vpc-flow-logs-an-overview-and-example-with-cloudwatch-logs-insights/" rel="noopener ugc nofollow" target="_blank"> <em class="mo"> RTFM: Linux、DevOps和系统管理</em> </a> <em class="mo">。</em></p></div></div>    
</body>
</html>