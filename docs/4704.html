<html>
<head>
<title>Work with AWS RDS Proxy</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用AWS RDS代理</h1>
<blockquote>原文：<a href="https://itnext.io/work-with-aws-rds-proxy-9d7e09668080?source=collection_archive---------1-----------------------#2020-08-27">https://itnext.io/work-with-aws-rds-proxy-9d7e09668080?source=collection_archive---------1-----------------------#2020-08-27</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/f9cf3c61c428e78be5dd4e5f04cdf9e9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ayXTabUmUQs5_BsD7AqtpQ.png"/></div></div></figure><p id="ef39" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">2020年6月，AWS宣布RDS代理将同时兼容MySQL和PostgreSQL引擎。对于AWS无服务器生态系统来说，这是一个重要的里程碑，因为对于许多无服务器架构来说，使DB无服务器不是一项简单的任务，现在有了RDS代理，这项任务不再像以前那样具有挑战性。</p><p id="e332" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我假设正在阅读这篇文章的任何人都是无服务器先锋，并且知道RDS代理的优点和缺点，所以我不打算写一个好东西的列表，相反，我将深入代码并向您展示如何使用它。</p></div><div class="ab cl kw kx hu ky" role="separator"><span class="kz bw bk la lb lc"/><span class="kz bw bk la lb lc"/><span class="kz bw bk la lb"/></div><div class="ij ik il im in"><h2 id="5da3" class="ld le iq bd lf lg lh dn li lj lk dp ll kj lm ln lo kn lp lq lr kr ls lt lu lv bi translated">创建代理</h2><p id="f39c" class="pw-post-body-paragraph jy jz iq ka b kb lw kd ke kf lx kh ki kj ly kl km kn lz kp kq kr ma kt ku kv ij bi translated">创建RDS代理非常简单。当你创建一个代理时，需要记住一些事情。</p><p id="83c1" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><strong class="ka ir"> &gt; VPC安全小组。</strong>分配给代理的安全组必须允许来自应用程序环境(如Lambda或EC2)的流量到达代理，以及来自代理的流量到达RDS。如果安全组配置不正确，</p><p id="6e46" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">&gt;<strong class="ka ir"> IAM认证。</strong>当您选择使用IAM认证时，您必须使用TLS连接到代理。当需要IAM身份验证时，本机凭据，即用户名和密码身份验证将不会被接受用于连接。</p><p id="4a41" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">如果代理没有正确配置，您通常会看到目标变得不可用，这意味着到RDS的连接没有准备好，在大多数情况下，原因是安全组或RDS的凭据。</p><figure class="mc md me mf gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mb"><img src="../Images/2bca677948093eb138002ebd6873c0f9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*k5t4IAstpi_l9kGeZTLNxg.png"/></div></div></figure><p id="e033" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">幸运的是，有了AWS CLI，我们可以很容易地调试它。</p><pre class="mc md me mf gt mg mh mi mj aw mk bi"><span id="2a17" class="ld le iq mh b gy ml mm l mn mo">aws rds describe-db-proxy-targets --db-proxy-name dev-rds-proxy-test</span></pre><p id="c530" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">比如我故意设置错了秘密管理者。由于错误的密码，目标变得不可用。</p><figure class="mc md me mf gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mp"><img src="../Images/6d696bc787698ea7b6586e8ad925121a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*A8SpGYkdA-3FHNnTM4GNcA.png"/></div></div></figure><p id="76d5" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">最大的问题可能是安全组设置。当安全组不正确时，通常意味着流量不被允许，因此您会看到以下错误。</p><figure class="mc md me mf gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mq"><img src="../Images/9d7e4fefd219364cbb91d50df266326b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*M39a3DW8CZ45JohSqGeEBA.png"/></div></div></figure><p id="8c73" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">你必须有耐心，找出哪个SG是不正确的。</p><p id="3148" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">请注意，在配置更改和状态更改之间有几秒钟的延迟。</p></div><div class="ab cl kw kx hu ky" role="separator"><span class="kz bw bk la lb lc"/><span class="kz bw bk la lb lc"/><span class="kz bw bk la lb"/></div><div class="ij ik il im in"><h2 id="a05b" class="ld le iq bd lf lg lh dn li lj lk dp ll kj lm ln lo kn lp lq lr kr ls lt lu lv bi translated">通过代理连接到RDS</h2><p id="6608" class="pw-post-body-paragraph jy jz iq ka b kb lw kd ke kf lx kh ki kj ly kl km kn lz kp kq kr ma kt ku kv ij bi translated">有不同的方法通过代理连接到RDS，使用或不使用TLS，使用或不使用IAM认证，我将向您展示如何。对于示例，我将使用Postgres和TypeScript。</p><p id="9705" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><strong class="ka ir"> &gt; psql </strong></p><p id="cb9e" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在编写任何代码之前，我们应该首先使用<code class="fe mr ms mt mh b">psql</code>测试连接，这样我们可以确保一路绿灯。</p><pre class="mc md me mf gt mg mh mi mj aw mk bi"><span id="e37e" class="ld le iq mh b gy ml mm l mn mo"># With TLS required<br/>psql "host=dev-rds-proxy-test.xxxxxxxxxxx.ap-southeast-2.rds.amazonaws.com dbname=rds user=rds_user sslmode=require"</span></pre><p id="3b9b" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">如果需要IAM身份验证，您将需要生成IAM令牌</p><pre class="mc md me mf gt mg mh mi mj aw mk bi"><span id="a9a9" class="ld le iq mh b gy ml mm l mn mo">aws rds generate-db-auth-token --hostname dev-rds-proxy-test.xxxxxxxxxxx.rds.amazonaws.com --port 5432 --region ap-southeast-2 --username dev_rds_user</span></pre><p id="c783" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在使用令牌连接到RDS之前，需要确保EC2或Lamda附加了以下IAM策略</p><pre class="mc md me mf gt mg mh mi mj aw mk bi"><span id="ec20" class="ld le iq mh b gy ml mm l mn mo">{<br/>    "Version": "2012-10-17",<br/>    "Statement": [<br/>        {<br/>            "Effect": "Allow",<br/>            "Action": [<br/>                "rds-db:connect"<br/>            ],<br/>            "Resource": [<br/>                "arn:aws:rds-db:ap-southeast-2:xxxxxxxxx:dbuser:<strong class="mh ir">prx-0f9d9414be09b1c57</strong>/<strong class="mh ir">dev_rds_user</strong>"<br/>            ]<br/>        }<br/>    ]<br/>}</span></pre><p id="4ab7" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><strong class="ka ir">一个非常重要的注意事项，AWS中没有记录(至少我找不到)，是放代理资源ID，而不是DB资源ID，因为我们使用IAM认证连接到代理，而不是RDS。代理仍然使用在secret manager中配置的本地auth连接到RDS。</strong></p><p id="4e77" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">你还需要从https://www.amazontrust.com/repository/AmazonRootCA1.pem的<a class="ae mu" href="https://www.amazontrust.com/repository/AmazonRootCA1.pem" rel="noopener ugc nofollow" target="_blank">获得亚马逊根CA</a></p><p id="5421" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">最后，我们可以连接</p><pre class="mc md me mf gt mg mh mi mj aw mk bi"><span id="0fbe" class="ld le iq mh b gy ml mm l mn mo">psql "host=dev-rds-proxy-test.proxy-xxxxx.ap-southeast-2.rds.amazonaws.com port=5432 sslmode=verify-full sslrootcert=cert.pem dbname=rds user=dev_rds_user password=<strong class="mh ir">the-token-gernated-before</strong>"</span></pre></div><div class="ab cl kw kx hu ky" role="separator"><span class="kz bw bk la lb lc"/><span class="kz bw bk la lb lc"/><span class="kz bw bk la lb"/></div><div class="ij ik il im in"><p id="683a" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><strong class="ka ir">代码&gt;代码</strong></p><p id="95ff" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在我们使用<code class="fe mr ms mt mh b">psql</code>验证了连接之后，我们现在可以编码了！</p><p id="2f98" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">使用TLS的连接</p><figure class="mc md me mf gt jr"><div class="bz fp l di"><div class="mv mw l"/></div></figure><p id="37f1" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">使用IAM身份验证的连接</p><figure class="mc md me mf gt jr"><div class="bz fp l di"><div class="mv mw l"/></div></figure><p id="a22b" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">请注意我们如何获得EC2或Lambda的凭证。</p><pre class="mc md me mf gt mg mh mi mj aw mk bi"><span id="7c49" class="ld le iq mh b gy ml mm l mn mo">new aws.EC2MetadataCredentials()</span></pre><p id="a3ff" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">因为权限是通过IAM角色控制的，所以函数需要异步。</p><p id="0aae" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><strong class="ka ir"><em class="mx">AWS文件中注明:</em> </strong></p><p id="983f" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><em class="mx">如果您同步调用此方法(没有回调)，您必须确保您拥有静态或先前解析的凭据，否则它可能无法正确地对请求进行签名。如果您不能保证这一点(您使用的是异步凭据提供程序，即EC2 IAM角色)，您应该始终使用异步回调来调用此方法。</em></p><p id="673c" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">这意味着如果您在本地存储了凭据，例如~/。aws/credentials，然后您可以以同步方式调用<code class="fe mr ms mt mh b">getAuthToken</code>，以不同的方式获取凭证</p><pre class="mc md me mf gt mg mh mi mj aw mk bi"><span id="a032" class="ld le iq mh b gy ml mm l mn mo"><strong class="mh ir">new</strong> AWS.SharedIniFileCredentials({profile: 'default'})</span></pre></div><div class="ab cl kw kx hu ky" role="separator"><span class="kz bw bk la lb lc"/><span class="kz bw bk la lb lc"/><span class="kz bw bk la lb"/></div><div class="ij ik il im in"><p id="d304" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">AWS RDS代理是添加到无服务器大军中的一个非常令人兴奋和有用的特性。只需很少的代码更改，就可以轻松地进行配置和调整。希望这个演示能让您在考虑使用代理管理RDS连接时更有信心。</p></div></div>    
</body>
</html>