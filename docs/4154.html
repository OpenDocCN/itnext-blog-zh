<html>
<head>
<title>Nested vSphere 7 and Kubernetes Lab Deployment explained</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">解释嵌套的vSphere 7和Kubernetes实验室部署</h1>
<blockquote>原文：<a href="https://itnext.io/nested-vsphere-7-and-kubernetes-lab-deployment-explained-f9bfca0112f5?source=collection_archive---------4-----------------------#2020-05-06">https://itnext.io/nested-vsphere-7-and-kubernetes-lab-deployment-explained-f9bfca0112f5?source=collection_archive---------4-----------------------#2020-05-06</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="b5d8" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><a class="ae kl" href="https://github.com/lamw/vghetto-vsphere-with-kubernetes-external-nsxt-automated-lab-deployment" rel="noopener ugc nofollow" target="_blank">林柏希出色的部署脚本</a>引发了在我们的开发vSphere环境之上建立一个完全嵌套的vSphere 7和Kubernetes (VCF 4)环境的想法。</p><p id="85d0" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">虽然部署本身非常适合部署嵌套的vSphere 7环境，但在启用Kubernetes部分(VMware Cloud Foundation 4-VCF)之前，您需要满足一些重要要求。</p><p id="74a2" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这篇博客文章将涵盖这些需求，以及一些使用新的VCF 4环境、工作负载管理和Tanzu Kubernetes网格(TKG)集群的技巧和诀窍。</p><h1 id="0ae8" class="km kn iq bd ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj bi translated">自动化部署</h1><h2 id="b5e3" class="lk kn iq bd ko ll lm dn ks ln lo dp kw jy lp lq la kc lr ls le kg lt lu li lv bi translated">要求</h2><p id="4b3d" class="pw-post-body-paragraph jn jo iq jp b jq lw js jt ju lx jw jx jy ly ka kb kc lz ke kf kg ma ki kj kk ij bi translated">William提出了以下运行其脚本的要求:</p><p id="a778" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><a class="ae kl" href="https://github.com/lamw/vghetto-vsphere-with-kubernetes-external-nsxt-automated-lab-deployment" rel="noopener ugc nofollow" target="_blank">https://github . com/lamw/vghetto-VSP here-with-kubernetes-external-nsxt-automated-lab-deployment</a></p><h2 id="2654" class="lk kn iq bd ko ll lm dn ks ln lo dp kw jy lp lq la kc lr ls le kg lt lu li lv bi translated">额外要求</h2><p id="5a52" class="pw-post-body-paragraph jn jo iq jp b jq lw js jt ju lx jw jx jy ly ka kb kc lz ke kf kg ma ki kj kk ij bi translated">如果您想在嵌套环境中继续启用工作负载管理(VCF ),我们将进一步推荐以下内容——否则您的SupervisorControlPlaneVM将不会完全初始化。</p><ul class=""><li id="4e40" class="mb mc iq jp b jq jr ju jv jy md kc me kg mf kk mg mh mi mj bi translated">在从NSX T0上行链路到您的互联网网关(sNAT)的通信路径上的每个虚拟和物理交换机上配置大小为1600或更大的MTU。这包括底层(部署嵌套环境的地方)和嵌套的vSwitch/dvSwitch！</li><li id="96a9" class="mb mc iq jp b jq mk ju ml jy mm kc mn kg mo kk mg mh mi mj bi translated">接受端口组上的安全混杂模式和伪造传输设置</li><li id="6cf9" class="mb mc iq jp b jq mk ju ml jy mm kc mn kg mo kk mg mh mi mj bi translated">配置PFsense(或类似设备)作为网关，包括NSX T0上行链路的SNAT</li></ul><figure class="mq mr ms mt gt mu gh gi paragraph-image"><div role="button" tabindex="0" class="mv mw di mx bf my"><div class="gh gi mp"><img src="../Images/63bbbca685527634619340d1931ac54f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*JDGYL6Baj71JK0ps.png"/></div></div></figure><h1 id="05df" class="km kn iq bd ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj bi translated">运行脚本</h1><p id="5093" class="pw-post-body-paragraph jn jo iq jp b jq lw js jt ju lx jw jx jy ly ka kb kc lz ke kf kg ma ki kj kk ij bi translated">简单来说就是克隆GitHub存储库，根据README.md修改脚本，并使用PowerCLI运行它。</p><figure class="mq mr ms mt gt mu gh gi paragraph-image"><div class="gh gi nb"><img src="../Images/b50785abd3f0f49faea90b43252d563b.png" data-original-src="https://miro.medium.com/v2/resize:fit:976/format:webp/0*cPm0QYEFPqZvIYFG.png"/></div></figure><p id="8d47" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">当脚本成功部署您的嵌套ESXi、vCSA、NSX管理和NSX边缘时，您可以继续连接到您新部署的vCSA 7。</p><h1 id="0f0b" class="km kn iq bd ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj bi translated">启用工作负载管理</h1><figure class="mq mr ms mt gt mu gh gi paragraph-image"><div class="gh gi nc"><img src="../Images/dd6e4a0931d00ee9498519aea6fcee9e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1338/format:webp/0*FCMsnD-Ke7SOwhdK.png"/></div></figure><p id="06ab" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">要启用工作负载管理并部署Kubernetes环境，只需在vSphere client菜单中选择workload management。</p><figure class="mq mr ms mt gt mu gh gi paragraph-image"><div role="button" tabindex="0" class="mv mw di mx bf my"><div class="gh gi nd"><img src="../Images/5daf5b5991de580bed9399fa77e3e48c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*bUarfrgRI4fcDWtW.png"/></div></div></figure><p id="9a39" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">让我们启用工作负载管理</p><p id="3ae5" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">该向导将指导您完成最重要的步骤，大多数人可以选择tiny作为部署大小。</p><figure class="mq mr ms mt gt mu gh gi paragraph-image"><div role="button" tabindex="0" class="mv mw di mx bf my"><div class="gh gi nd"><img src="../Images/eeb92640ceed93efae7e66cbe1247de8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*I3WcCV4R_hs6JTz9.png"/></div></div></figure><p id="606c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">为了简化指南，我们使用了William在他的脚本中使用的所有网络设置。</p><p id="60bd" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">您需要确保您的网关在管理和工作负载网络(入口和出口)中有一个适配器和ip地址，以确保以后可以下载容器映像。</p><figure class="mq mr ms mt gt mu gh gi paragraph-image"><div role="button" tabindex="0" class="mv mw di mx bf my"><div class="gh gi nd"><img src="../Images/4a137d3fddf82618c7b0add6272c5a65.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*Ar-dtvcv6MkwMm5G.png"/></div></div></figure><p id="41ee" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">此外，确保在网关中启用SNAT并配置防火墙。</p><figure class="mq mr ms mt gt mu gh gi paragraph-image"><div role="button" tabindex="0" class="mv mw di mx bf my"><div class="gh gi nd"><img src="../Images/eb533fcd4e5cb8e5224cfaf4c0ef3f22.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*DVEgHIXo0LpNqsH8.png"/></div></div></figure><p id="663f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">下一个重要步骤是为所有图像和相关数据选择正确的数据存储。</p><p id="9e5c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">开始实施后，是时候喝杯咖啡了，因为这个过程需要一些时间。</p><h1 id="b80d" class="km kn iq bd ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj bi translated">部署问题</h1><figure class="mq mr ms mt gt mu gh gi paragraph-image"><div role="button" tabindex="0" class="mv mw di mx bf my"><div class="gh gi nd"><img src="../Images/c0e3764c19cd3dabb03d52d559cfdbb1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*HuQfS_fizsqjOB3a.png"/></div></div></figure><p id="addc" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">开始的几分钟相当无聊，你可以忽略一些错误。</p><figure class="mq mr ms mt gt mu gh gi paragraph-image"><div role="button" tabindex="0" class="mv mw di mx bf my"><div class="gh gi nd"><img src="../Images/ea21ff64f10c12abbfb9fecec26d4b4c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*uei21FPYFASWzspw.png"/></div></div></figure><p id="39e5" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">但是检查将被启动的第一个SuperVisorControlPlaneVM的事件并没有坏处。一个是Kubernetes Master，如果这次部署失败，未来不会发生太多事情。</p><p id="90b4" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果你看到一些这样的条目</p><p id="84d2" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">com . VMware . VC . guest operations . guest operation的爆发开始</strong></p><p id="baad" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在第一个启动SupervisorControlPlaneVM的事件中，您可以确信部署进展顺利，嵌套的ESXi和VCF虚拟机之间的通信正常。</p><figure class="mq mr ms mt gt mu gh gi paragraph-image"><div role="button" tabindex="0" class="mv mw di mx bf my"><div class="gh gi nd"><img src="../Images/8c79b7a67b14dde61564d36075aafc32.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*BW3ZRjn3HEMtvZlG.png"/></div></div></figure><p id="8eb0" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">不要心急！</strong></p><p id="908b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">有些错误是绝对正常的，如果持续时间不超过15-20分钟，可以忽略。</p><p id="9f51" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">您还可以在安装过程中通过pinging the上行链路来测试环境。</p><figure class="mq mr ms mt gt mu gh gi paragraph-image"><div role="button" tabindex="0" class="mv mw di mx bf my"><div class="gh gi nd"><img src="../Images/dd7725ebf93f013eeea6971b653082c8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*wMBjXkOSZB9YhZQI.png"/></div></div></figure><p id="189e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">配置主虚拟机后，其他两个SupervisorControlPlane虚拟机也将启动，所有配置都将复制到它们。</p><h1 id="fb49" class="km kn iq bd ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj bi translated">创建您的第一个名称空间</h1><figure class="mq mr ms mt gt mu gh gi paragraph-image"><div role="button" tabindex="0" class="mv mw di mx bf my"><div class="gh gi ne"><img src="../Images/12f4e08a88f5229570a7deb8d24db56e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*DisfdMCLt5vlFTP0.png"/></div></div></figure><p id="cc6e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">当您选择Namespaces选项卡时，您可以创建您的第一个名称空间来部署演示应用程序或只是进行一点测试。</p><figure class="mq mr ms mt gt mu gh gi paragraph-image"><div class="gh gi nf"><img src="../Images/e0a7c2b03343fe6b7ecd524eeda56733.png" data-original-src="https://miro.medium.com/v2/resize:fit:1164/format:webp/0*Gj8hTHS18PK5Lkig.png"/></div></figure><p id="8441" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">让我们创建名称空间测试</p><figure class="mq mr ms mt gt mu gh gi paragraph-image"><div role="button" tabindex="0" class="mv mw di mx bf my"><div class="gh gi ng"><img src="../Images/b9ae5d7bf9d06c637b0b01b6d8e811ec.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*JlC8vLvVwZ4h4Nfb.png"/></div></div></figure><p id="6acc" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">添加权限和存储</p><h1 id="3bc0" class="km kn iq bd ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj bi translated">连接到控制平面</h1><figure class="mq mr ms mt gt mu gh gi paragraph-image"><div role="button" tabindex="0" class="mv mw di mx bf my"><div class="gh gi nh"><img src="../Images/67a020c8d291f03928ea448f0c202fc0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*XUw_YQSw9xrXltuI.png"/></div></div></figure><p id="9d66" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">使用Kubernetes平台的主要工具是kubectl，可以通过使用浏览器访问控制平面IP或单击CLI工具链接下的打开来下载。</p><p id="41f0" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">下载kubectl和vsphere插件，以便您可以直接连接到基于vSphere的Kubernetes部署:</p><pre class="mq mr ms mt gt ni nj nk nl aw nm bi"><span id="7def" class="lk kn iq nj b gy nn no l np nq"># Login to Kubernetes <br/>kubectl vsphere login --server=https://controlplane-ip -u administrator@vsphere.local --insecure-skip-tls-verify </span><span id="264f" class="lk kn iq nj b gy nr no l np nq"># select the test namespace - it safes you typing -n test after each command <br/>kubectl config use-context test </span><span id="2759" class="lk kn iq nj b gy nr no l np nq"># show all existing resources <br/>kubectl get all</span></pre><p id="138f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果您还没有部署任何东西，您可以简单地看到<strong class="jp ir">在测试名称空间</strong>中没有找到资源。我们要改变这种状况。</p><h1 id="c27f" class="km kn iq bd ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj bi translated">运行测试舱</h1><p id="dbd3" class="pw-post-body-paragraph jn jo iq jp b jq lw js jt ju lx jw jx jy ly ka kb kc lz ke kf kg ma ki kj kk ij bi translated">让我们测试一下，我们是否可以通过创建一个演示nginx pod来访问互联网以提取图像。</p><figure class="mq mr ms mt gt mu gh gi paragraph-image"><div class="gh gi ns"><img src="../Images/525c33e08df8db4270b1abfff9dc7337.png" data-original-src="https://miro.medium.com/v2/resize:fit:1368/format:webp/0*4CGABO9YNrNsBmAi.png"/></div></figure><pre class="mq mr ms mt gt ni nj nk nl aw nm bi"><span id="d1c3" class="lk kn iq nj b gy nn no l np nq"># deploy nginx for testing <br/>kubectl run nginx --image=nginx </span><span id="1a43" class="lk kn iq nj b gy nr no l np nq"># ignore the warning as we're just testing: <br/>kubectl run --generator=deployment/apps.v1 is DEPRECATED and will be removed in a future version. Use kubectl run --generator=run-pod/v1 or kubectl create instead. deployment.apps/nginx created </span><span id="432b" class="lk kn iq nj b gy nr no l np nq"># check the deployment status <br/>kubectl get all</span></pre><p id="f719" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">好像管用！</p><p id="b2bb" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果对您不起作用，请尝试以下命令来获取详细信息:</p><pre class="mq mr ms mt gt ni nj nk nl aw nm bi"><span id="e919" class="lk kn iq nj b gy nn no l np nq"># get information about nginx deployment <br/>kubectl describe deployment.apps/nginx </span><span id="b7c3" class="lk kn iq nj b gy nr no l np nq"># get pods with label/value run=nginx and return full configuration kubectl get pods -l run=nginx -o yaml</span></pre><figure class="mq mr ms mt gt mu gh gi paragraph-image"><div role="button" tabindex="0" class="mv mw di mx bf my"><div class="gh gi nd"><img src="../Images/44a372395c1dfb40072cc12220d7bdc9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*0hXxKOEx0Hvtyg5s.png"/></div></div></figure><figure class="mq mr ms mt gt mu gh gi paragraph-image"><div role="button" tabindex="0" class="mv mw di mx bf my"><div class="gh gi nd"><img src="../Images/53838dec2f5e1e18f4e886f2f9b9db5e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*Bxgd7rGNH5_PR7Sm.png"/></div></div></figure><p id="81b7" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">您还可以跟踪vSphere client中的所有事件和配置文件。</p><pre class="mq mr ms mt gt ni nj nk nl aw nm bi"><span id="e33b" class="lk kn iq nj b gy nn no l np nq"># delete the pod <br/>kubectl delete pods -l run=nginx </span><span id="d534" class="lk kn iq nj b gy nr no l np nq"># check for pods again and you'll find a new pod with a low AGE kubectl get pods -l run=nginx </span><span id="dbcd" class="lk kn iq nj b gy nr no l np nq"># delete the deployment <br/>kubectl delete deployment nginx </span><span id="754f" class="lk kn iq nj b gy nr no l np nq"># check for pods again and you'll nothing will be shown <br/>kubectl get pods</span></pre><p id="f3a0" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这个小练习解释了Kubernetes是如何工作的。pod将基于由部署创建的副本集来创建。如果我们删除pod，复制集就会创建一个新的。</p><figure class="mq mr ms mt gt mu gh gi paragraph-image"><div role="button" tabindex="0" class="mv mw di mx bf my"><div class="gh gi nd"><img src="../Images/b9ef71423ad7aad802c4dca5075252b7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*KgAU3fnisJg-2fWt.png"/></div></div></figure><p id="c834" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">删除部署也会删除pod和副本集。</p><p id="748b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">下一篇博文将是关于添加Tanzu内容库、创建TKG集群以及如何<a class="ae kl" href="https://www.opvizor.com" rel="noopener ugc nofollow" target="_blank">监控日志和性能</a>。</p></div><div class="ab cl nt nu hu nv" role="separator"><span class="nw bw bk nx ny nz"/><span class="nw bw bk nx ny nz"/><span class="nw bw bk nx ny"/></div><div class="ij ik il im in"><p id="c5cb" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><em class="oa">原载于2020年5月6日https://www.opvizor.com</em><em class="oa">的</em> <a class="ae kl" href="https://www.opvizor.com/nested-vsphere-7-and-kubernetes-lab-deployment-explained" rel="noopener ugc nofollow" target="_blank"> <em class="oa">。</em></a></p></div></div>    
</body>
</html>