<html>
<head>
<title>Build a Project Management Tool with Vue.js, Node.js and Apollo — Part 4</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用Vue.js、Node.js和Apollo构建一个项目管理工具——第4部分</h1>
<blockquote>原文：<a href="https://itnext.io/build-a-project-management-tool-with-vue-js-node-js-and-apollo-part-4-40fbe0625d32?source=collection_archive---------4-----------------------#2018-08-16">https://itnext.io/build-a-project-management-tool-with-vue-js-node-js-and-apollo-part-4-40fbe0625d32?source=collection_archive---------4-----------------------#2018-08-16</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="817b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">欢迎回来！感谢你的支持，现在这个系列教程是下一个的一部分！我很高兴能接触到更多的观众，帮助更多的人。</p><p id="96cc" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在这一部分，我们将建立一个工作区。</p><blockquote class="km kn ko"><p id="51c1" class="jn jo kp jp b jq jr js jt ju jv jw jx kq jz ka kb kr kd ke kf ks kh ki kj kk ij bi translated"><a class="ae kl" rel="noopener ugc nofollow" target="_blank" href="/build-a-project-management-software-with-vue-js-and-apollo-part1-d12ee75a7641">第1部分—构建简单的GraphQL API </a></p><p id="23be" class="jn jo kp jp b jq jr js jt ju jv jw jx kq jz ka kb kr kd ke kf ks kh ki kj kk ij bi translated"><a class="ae kl" rel="noopener ugc nofollow" target="_blank" href="/build-a-project-management-tool-with-vue-js-node-js-and-apollo-part2-47fbe5dc2de4">第2部分—构建MongoDB模式和电子邮件表单</a></p><p id="f5bf" class="jn jo kp jp b jq jr js jt ju jv jw jx kq jz ka kb kr kd ke kf ks kh ki kj kk ij bi translated"><a class="ae kl" rel="noopener ugc nofollow" target="_blank" href="/build-a-project-management-tool-with-vue-js-node-js-and-apollo-part-3-69a7bf9f2f1b">第3部分—认证</a></p><p id="583b" class="jn jo kp jp b jq jr js jt ju jv jw jx kq jz ka kb kr kd ke kf ks kh ki kj kk ij bi translated">第4部分—构建工作空间(这一部分)</p><p id="9689" class="jn jo kp jp b jq jr js jt ju jv jw jx kq jz ka kb kr kd ke kf ks kh ki kj kk ij bi translated"><a class="ae kl" rel="noopener ugc nofollow" target="_blank" href="/build-a-project-management-tool-with-vue-js-node-js-and-apollo-part-5-d59e6e345e39">第5部分—文件夹的CRUD功能</a></p></blockquote><p id="b914" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><em class="kp">本教程的代码可在</em> <a class="ae kl" href="https://github.com/kenzotakahashi/enamel/tree/part4" rel="noopener ugc nofollow" target="_blank"> <em class="kp">这里</em> </a> <em class="kp">获得。或者如果你想跟随，你可以在这里</em>  <em class="kp">克隆part3分支</em> <a class="ae kl" href="https://github.com/kenzotakahashi/enamel/tree/part3" rel="noopener ugc nofollow" target="_blank"> <em class="kp">。</em></a></p><h1 id="500d" class="kt ku iq bd kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq bi translated">演出团队</h1><p id="886b" class="pw-post-body-paragraph jn jo iq jp b jq lr js jt ju ls jw jx jy lt ka kb kc lu ke kf kg lv ki kj kk ij bi translated">我们要做的第一件事是获得用户的团队。我们不再需要<code class="fe lw lx ly lz b">test</code>查询，所以删除它并在<code class="fe lw lx ly lz b">server/src/schema.graphql</code>中添加<code class="fe lw lx ly lz b">getTeam</code>和<code class="fe lw lx ly lz b">Team</code>类型:</p><pre class="ma mb mc md gt me lz mf mg aw mh bi"><span id="04e6" class="mi ku iq lz b gy mj mk l ml mm">type Query {<br/>  getTeam: Team<br/>}</span><span id="5164" class="mi ku iq lz b gy mn mk l ml mm">type Team {<br/>  id: String<br/>  name: String<br/>}</span></pre><p id="69f3" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">由于workspace需要登录，我们需要检查请求头以确保用户已经登录。创造<code class="fe lw lx ly lz b">server/src/utils.js</code>:</p><pre class="ma mb mc md gt me lz mf mg aw mh bi"><span id="6fc9" class="mi ku iq lz b gy mj mk l ml mm">// server/src/utils.js<br/>const jwt = require('jsonwebtoken')<br/>require('dotenv').config()</span><span id="6752" class="mi ku iq lz b gy mn mk l ml mm">function getUserId(context) {<br/>  const Authorization = context.request.get('Authorization')<br/>  if (Authorization) {<br/>    const token = Authorization.replace('Bearer ', '')<br/>    const {id} = jwt.verify(token, process.env.JWT_SECRET)<br/>    return id<br/>  }<br/>  throw new Error('Not authenticated')<br/>}</span><span id="9d4b" class="mi ku iq lz b gy mn mk l ml mm">module.exports = {<br/>  getUserId,<br/>}</span></pre><p id="a4e2" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">将功能导入<code class="fe lw lx ly lz b">resolvers.js</code>。在我们授权用户之后，我们从用户那里获得团队id并返回团队对象:</p><pre class="ma mb mc md gt me lz mf mg aw mh bi"><span id="3bc8" class="mi ku iq lz b gy mj mk l ml mm">const { getUserId } = require('./utils')</span><span id="93e9" class="mi ku iq lz b gy mn mk l ml mm">const resolvers = {<br/>  Query: {<br/>    async getTeam (_, args, context) {<br/>      const userId = getUserId(context)<br/>      const user = await User.findById(userId)<br/>      return await Team.findById(user.team)<br/>    },<br/>  },<br/>  ...<br/>}</span></pre><p id="0b62" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">让我们在操场上测试一下。首先，使用您之前创建的帐户登录。如果没有，可以使用<code class="fe lw lx ly lz b">captureEmail</code>和<code class="fe lw lx ly lz b">signup</code>创建一个新的。</p><figure class="ma mb mc md gt mp gh gi paragraph-image"><div role="button" tabindex="0" class="mq mr di ms bf mt"><div class="gh gi mo"><img src="../Images/6b3a2f051df8266db4e64b3383a16d19.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*6DlsHFnR_HcCBZQvecOZbw.png"/></div></div></figure><p id="48cd" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">然后复制令牌并在playground中打开一个新标签。下面是<code class="fe lw lx ly lz b">getTeam</code>查询的样子:</p><figure class="ma mb mc md gt mp gh gi paragraph-image"><div role="button" tabindex="0" class="mq mr di ms bf mt"><div class="gh gi mw"><img src="../Images/3c94fdec5a3f371b8eaed41a7d6046f5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*J0VQoGRtayFGZKUhvMqIJg.png"/></div></div></figure><p id="a4e3" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">将令牌粘贴在标题选项中的<code class="fe lw lx ly lz b">Bearer</code>之后。</p><pre class="ma mb mc md gt me lz mf mg aw mh bi"><span id="9859" class="mi ku iq lz b gy mj mk l ml mm">"Authorization": "Bearer [TOKEN]"</span></pre><p id="3fcf" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果操作正确，应该会得到如上所示的响应。</p><p id="09f5" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这很好，那么我们如何在客户端做到这一点？使用ApolloLink，您可以自动为每个请求添加标题。将以下内容添加到<code class="fe lw lx ly lz b">client/src/main.js</code>。链接的顺序很重要，所以<code class="fe lw lx ly lz b">authMiddleware</code>应该在<code class="fe lw lx ly lz b">errorLink</code>之后<code class="fe lw lx ly lz b">httpLink</code>之前。</p><pre class="ma mb mc md gt me lz mf mg aw mh bi"><span id="6f31" class="mi ku iq lz b gy mj mk l ml mm">const authMiddleware = new ApolloLink((operation, forward) =&gt; {<br/>  const token = localStorage.getItem('user-token')<br/>  operation.setContext({<br/>    headers: {<br/>      authorization: token ? `Bearer ${token}` : null<br/>    }<br/>  })<br/>  return forward(operation)<br/>})</span><span id="cd32" class="mi ku iq lz b gy mn mk l ml mm">const client = new ApolloClient({<br/>  link: ApolloLink.from([<br/>    errorLink,<br/>    authMiddleware,<br/>    httpLink<br/>  ]),<br/>  cache,<br/>  connectToDevTools: true,<br/>})</span></pre><p id="29d6" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">将<code class="fe lw lx ly lz b">getTeam</code>查询添加到<code class="fe lw lx ly lz b">client/src/constants/query.gpl</code>:</p><pre class="ma mb mc md gt me lz mf mg aw mh bi"><span id="bcce" class="mi ku iq lz b gy mj mk l ml mm">query GetTeam {<br/>  getTeam {<br/>    id<br/>    name<br/>  }<br/>}</span></pre><p id="ff87" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">创建一个新文件<code class="fe lw lx ly lz b">client/src/views/Workspace.vue</code>并粘贴以下代码:</p><pre class="ma mb mc md gt me lz mf mg aw mh bi"><span id="1c12" class="mi ku iq lz b gy mj mk l ml mm">&lt;template&gt;<br/>  &lt;div&gt;</span><span id="18cb" class="mi ku iq lz b gy mn mk l ml mm">&lt;div class="container"&gt;<br/>      &lt;aside class="tree-root"&gt;<br/>        &lt;div v-if="getTeam.id" class="tree-item"<br/>            <a class="ae kl" href="http://twitter.com/click" rel="noopener ugc nofollow" target="_blank">@click</a>.left.stop="$router.push({name: 'folder', params: {id: getTeam.id}})"&gt;<br/>          &lt;div class="tree-plate"  v-bind:class="{active: $route.params.id === getTeam.id}"&gt;<br/>            &lt;div class="circle"&gt;&lt;/div&gt;<br/>            &lt;span class="folder no-select-color teamname"&gt;{{ getTeam.name }}&lt;/span&gt;<br/>          &lt;/div&gt;<br/>        &lt;/div&gt;</span><span id="d33b" class="mi ku iq lz b gy mn mk l ml mm">&lt;/aside&gt;</span><span id="ab10" class="mi ku iq lz b gy mn mk l ml mm">&lt;div class="workspace-main"&gt;<br/>        &lt;router-view :key="$route.fullPath"&gt;&lt;/router-view&gt;<br/>      &lt;/div&gt;</span><span id="4b91" class="mi ku iq lz b gy mn mk l ml mm">&lt;/div&gt;</span><span id="6589" class="mi ku iq lz b gy mn mk l ml mm">&lt;/div&gt;</span><span id="4d55" class="mi ku iq lz b gy mn mk l ml mm">&lt;/template&gt;</span><span id="e562" class="mi ku iq lz b gy mn mk l ml mm">&lt;script&gt;<br/>import { GetTeam } from '../constants/query.gql'</span><span id="7bb4" class="mi ku iq lz b gy mn mk l ml mm">export default {<br/>  data() {<br/>    return {<br/>      getTeam: {},<br/>    }<br/>  },<br/>  apollo: {<br/>    getTeam: {<br/>      query: GetTeam,<br/>    },<br/>  },<br/>}<br/>&lt;/script&gt;</span><span id="e4d0" class="mi ku iq lz b gy mn mk l ml mm">&lt;style scoped&gt;<br/>.container {<br/>  width: 100%;<br/>  height: calc(100% - 52px);<br/>}</span><span id="774e" class="mi ku iq lz b gy mn mk l ml mm">.plus-button {<br/>  position: absolute;<br/>  right: 0;<br/>  top: 7px;<br/>  margin: 0 2px;<br/>}</span><span id="d48a" class="mi ku iq lz b gy mn mk l ml mm">aside {<br/>  width: 220px;<br/>  height: 100%;<br/>  display: inline-block;<br/>}</span><span id="0169" class="mi ku iq lz b gy mn mk l ml mm">.workspace-main {<br/>  flex: 1 1;<br/>}<br/>&lt;/style&gt;</span></pre><p id="5169" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这是在左侧显示文件夹树的主视图。它还呈现子组件。但目前，它只是查询当前用户的团队并显示名称。</p><p id="da0b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><code class="fe lw lx ly lz b">client/src/router.js</code>有很多变化:</p><pre class="ma mb mc md gt me lz mf mg aw mh bi"><span id="2eb6" class="mi ku iq lz b gy mj mk l ml mm">import Vue from 'vue'<br/>import Router from 'vue-router'<br/>import Home from './views/Home.vue'<br/>import Signup from './views/Signup.vue'<br/>import Login from './views/Login.vue'<br/>import Workspace from './views/Workspace.vue'</span><span id="4e45" class="mi ku iq lz b gy mn mk l ml mm">Vue.use(Router)</span><span id="dbf4" class="mi ku iq lz b gy mn mk l ml mm">const login = {<br/>  path: '/login',<br/>  name: 'login',<br/>  component: Login,<br/>  meta: { title: 'Login - enamel' }<br/>}</span><span id="4d8b" class="mi ku iq lz b gy mn mk l ml mm">const workspace = {<br/>  path: '/w',<br/>  name: 'workspace',<br/>  component: Workspace,<br/>  meta: { title: 'Workspace - enamel', requiresAuth: true },<br/>}</span><span id="7395" class="mi ku iq lz b gy mn mk l ml mm">const router = new Router({<br/>  mode: 'history',<br/>  routes: [<br/>    {<br/>      path: '/',<br/>      name: 'home',<br/>      component: Home,<br/>      meta: { title: 'enamel', redirect: true}<br/>    },<br/>    {<br/>      path: '/signup/:id',<br/>      name: 'signup',<br/>      component: Signup,<br/>      meta: { title: 'Signup - enamel' }<br/>    },<br/>    login,<br/>    workspace<br/>  ]<br/>})</span><span id="7621" class="mi ku iq lz b gy mn mk l ml mm">router.beforeEach((to, from, next) =&gt; {<br/>  const auth = localStorage.getItem('user-id')<br/>  if (to.matched.some(record =&gt; record.meta.requiresAuth)) {<br/>    if(!auth) {<br/>      next(login)<br/>    }<br/>  } else if (to.matched.some(record =&gt; record.meta.redirect)) {<br/>    if(auth) {<br/>      next(workspace)<br/>    }<br/>  }<br/>  next()<br/>})</span><span id="1182" class="mi ku iq lz b gy mn mk l ml mm">router.afterEach((to, from) =&gt; {<br/>  document.title = to.meta.title<br/>})</span><span id="36e4" class="mi ku iq lz b gy mn mk l ml mm">export default router</span></pre><p id="c0bb" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">首先，我为workspace添加了一条路线。我还添加了<code class="fe lw lx ly lz b">beforeEach</code>来根据用户是否登录来重定向用户。如果他在登录时转到根页面(电子邮件表单)，他将被重定向到工作区。如果他在<em class="kp">未</em>登录时进入工作区，那么他将被重定向到登录页面。</p><p id="f9bf" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">最后，我们需要对<code class="fe lw lx ly lz b">Login.vue</code>和<code class="fe lw lx ly lz b">Signup.vue</code>做些小改动。现在，我们只是在登录或注册后打印“成功”。用<code class="fe lw lx ly lz b">this.$router.push({name: ‘workspace’})</code>替换。此外，我们需要在每次用户登录时清除Apollo缓存，否则如果不同的用户在同一台计算机上登录，她可以看到前一个用户的数据。清除VueApollo中的缓存是<code class="fe lw lx ly lz b">this.$apollo.provider.clients.defaultClient.cache.reset()</code>。顺便说一句，这个不容易找到。而且相当长。</p><p id="b79c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><code class="fe lw lx ly lz b">client/src/views/Login.vue</code>中<code class="fe lw lx ly lz b">login</code>的更新版本如下:</p><pre class="ma mb mc md gt me lz mf mg aw mh bi"><span id="a45f" class="mi ku iq lz b gy mj mk l ml mm">methods: {<br/>  async login() {<br/>    this.$apollo.provider.clients.defaultClient.cache.reset()</span><span id="9d18" class="mi ku iq lz b gy mn mk l ml mm">const { email, password } = this.form<br/>    if (email &amp;&amp; password) {<br/>      this.$apollo.mutate({<br/>        mutation: Login,<br/>        variables: { email, password }<br/>      }).then(async (data) =&gt; {<br/>        const login = data.data.login<br/>        const id = login.user.id<br/>        const token = login.token<br/>        this.saveUserData(id, token)<br/>        this.$router.push({name: 'workspace'})<br/>      }).catch((error) =&gt; {<br/>        this.error = 'Invalid email or password'<br/>        console.log(error)<br/>      })<br/>    }<br/>  },<br/>  ...<br/>}</span></pre><p id="4340" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">和<code class="fe lw lx ly lz b">client/src/views/Signup.vue</code></p><pre class="ma mb mc md gt me lz mf mg aw mh bi"><span id="2748" class="mi ku iq lz b gy mj mk l ml mm">methods: {<br/>  async signup() {<br/>    this.$apollo.provider.clients.defaultClient.cache.reset()</span><span id="2213" class="mi ku iq lz b gy mn mk l ml mm">const { firstname, lastname, password } = this.form<br/>    if (!(firstname &amp;&amp; lastname &amp;&amp; password)) {<br/>      this.error = 'Please complete the form'<br/>      return<br/>    }<br/>    this.$apollo.mutate({<br/>      mutation: Signup,<br/>      variables: {<br/>        id: this.$route.params.id,<br/>        firstname,<br/>        lastname,<br/>        password<br/>      }<br/>    }).then(({data: {signup}}) =&gt; {<br/>      const id = signup.user.id<br/>      const token = signup.token<br/>      this.saveUserData(id, token)<br/>      this.$router.push({name: 'workspace'})<br/>    }).catch((error) =&gt; {<br/>      this.error = 'Something went wrong'<br/>      console.log(error)<br/>    })<br/>  },<br/>}</span></pre><p id="4a2c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在我们准备测试！登录后，您应该会看到以下内容:</p><figure class="ma mb mc md gt mp gh gi paragraph-image"><div role="button" tabindex="0" class="mq mr di ms bf mt"><div class="gh gi mx"><img src="../Images/f46a4f86ddef99c76886ce5060e66784.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*dyEz_6-iy29HxlvWOYcA0g.png"/></div></div></figure><p id="f5f0" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">哇，真无聊。</p><h1 id="40d0" class="kt ku iq bd kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq bi translated">获取文件夹</h1><p id="2f99" class="pw-post-body-paragraph jn jo iq jp b jq lr js jt ju ls jw jx jy lt ka kb kc lu ke kf kg lv ki kj kk ij bi translated">接下来，我们将创建<code class="fe lw lx ly lz b">getFolders</code>和<code class="fe lw lx ly lz b">getFolder</code>查询。将此添加到<code class="fe lw lx ly lz b">server/src/schema.graphql</code>:</p><pre class="ma mb mc md gt me lz mf mg aw mh bi"><span id="3198" class="mi ku iq lz b gy mj mk l ml mm">scalar Date<br/>scalar JSON</span><span id="e10f" class="mi ku iq lz b gy mn mk l ml mm">type Query {<br/>  getTeam: Team<br/>  getFolders(parent: String): [Folder]<br/>  getFolder(id: String!): Folder<br/>}</span><span id="c79c" class="mi ku iq lz b gy mn mk l ml mm">type Folder {<br/>  id: String<br/>  name: String<br/>  parent: String<br/>  description: String<br/>  shareWith: [JSON]<br/>}</span></pre><p id="6e73" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">记住，文件夹中的<code class="fe lw lx ly lz b">shareWith</code>可以是团队、组或成员，所以我们不能定义类型，因为GraphQL中没有多态性。在这种情况下，我们需要定义一个新的缩放器。我把它叫做JSON，但是你想怎么叫都行。</p><p id="38dc" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><code class="fe lw lx ly lz b">getFolders</code>和<code class="fe lw lx ly lz b">getFolder</code>的分解器如下:</p><pre class="ma mb mc md gt me lz mf mg aw mh bi"><span id="080d" class="mi ku iq lz b gy mj mk l ml mm">const mongoose = require('mongoose')<br/>const ObjectId = mongoose.Types.ObjectId<br/>const { User, Team, Folder, Group } = require('./models')</span><span id="1d7c" class="mi ku iq lz b gy mn mk l ml mm">const resolvers = {<br/>  Query: {<br/>    ...<br/>    async getFolders (_, {parent}, context) {<br/>      const userId = getUserId(context)<br/>      if (parent) {<br/>        return await Folder.find({parent})<br/>      } else {<br/>        const user = await User.findById(userId)<br/>        const groups = await Group.find({users: ObjectId(userId)}, '_id')<br/>        const ids = groups.map(o =&gt; o._id).concat(<br/>          ['External User', 'Collaborator'].includes(user.role)<br/>          ? [ObjectId(userId)]<br/>          : [ObjectId(userId), user.team]<br/>        )<br/>        return await Folder.find({ 'shareWith.item': ids }).populate('shareWith')<br/>      }<br/>    },<br/>    async getFolder (_, {id}, context) {<br/>      const userId = getUserId(context)<br/>      return await Folder.findById(id).populate('shareWith')<br/>    },<br/>  },<br/>}</span></pre><p id="4efd" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><code class="fe lw lx ly lz b">getFolder</code>直截了当。<code class="fe lw lx ly lz b">getFolders</code>用于查询根文件夹和子文件夹，所以有点复杂。如果提供了<code class="fe lw lx ly lz b">parent</code>参数，它将查询子文件夹。如果没有，它将查询与用户共享的根文件夹。所以我们需要获得用户id、用户所属的组以及用户的团队。只有管理员(+所有者)和普通用户属于该团队。因此，普通用户用于全职员工，外部用户和协作者用于承包商。您可能不希望自动将公司的所有项目共享给承包商，对吗？</p><p id="c729" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">外部用户和协作者完全相同。我两个都有，因为里克也有。在Wrike中，Collaborator甚至更受限制。他不能创建新的任务或文件夹。他只能评论和更新状态。我最初打算构建它，但我认为构建新特性比构建限制更重要。</p><p id="fa13" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们还没有团体模型，所以把这个加到<code class="fe lw lx ly lz b">server/src/models.js</code>:</p><pre class="ma mb mc md gt me lz mf mg aw mh bi"><span id="cbee" class="mi ku iq lz b gy mj mk l ml mm">module.exports.Group = buildModel('Group', {<br/>  team: { type: ObjectId, ref: 'Team' },<br/>  name: String,<br/>  initials: String,<br/>  avatarColor: String,<br/>  users: [{ type: ObjectId, ref: 'User' }],<br/>})</span></pre><p id="c857" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">一个组属于一个团队，有用户。我们不会很快使用它，所以不用担心。</p><p id="afda" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">移动到客户端，将这段代码添加到<code class="fe lw lx ly lz b">client/src/constants/query.gql</code></p><pre class="ma mb mc md gt me lz mf mg aw mh bi"><span id="3e7e" class="mi ku iq lz b gy mj mk l ml mm">fragment FolderFields on Folder {<br/>  id<br/>  name<br/>  parent<br/>  description<br/>  shareWith<br/>}</span><span id="4597" class="mi ku iq lz b gy mn mk l ml mm">query GetFolders($parent: String) {<br/>  getFolders(parent: $parent) { ...FolderFields }<br/>}</span><span id="0f78" class="mi ku iq lz b gy mn mk l ml mm">query GetFolder($id: String!) {<br/>  getFolder(id: $id) { ...FolderFields }<br/>}</span></pre><p id="0b23" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">默认情况下不支持Fragment，所以我们需要导入<code class="fe lw lx ly lz b">enableExperimentalFragmentVariables</code>，我们已经在<code class="fe lw lx ly lz b">client/src/main.js</code>中导入了。</p><p id="5c68" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">按如下方式更新路由器:</p><pre class="ma mb mc md gt me lz mf mg aw mh bi"><span id="f37c" class="mi ku iq lz b gy mj mk l ml mm">import Folder from './views/Folder.vue'<br/>import FolderDetail from './views/FolderDetail.vue'</span><span id="d8d6" class="mi ku iq lz b gy mn mk l ml mm">const workspace = {<br/>  path: '/w',<br/>  name: 'workspace',<br/>  component: Workspace,<br/>  meta: { title: 'Workspace - enamel', requiresAuth: true },<br/>  children: [<br/>    {<br/>      path: 'folder/:id',<br/>      component: Folder,<br/>      props: true,<br/>      children: [<br/>        {<br/>          path: '',<br/>          name: 'folder',<br/>          component: FolderDetail<br/>        },<br/>        // {<br/>        //   path: 'task/:taskId',<br/>        //   name: 'task',<br/>        //   component: Task,<br/>        //   props: true<br/>        // }<br/>      ]<br/>    }<br/>  ]<br/>}</span></pre><p id="8e66" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">工作区有两个白色面板，或者卡片。左侧显示所选文件夹中的任务列表。默认情况下，右侧显示文件夹信息，当点击一个任务时，显示任务信息。我确信有不止一种方法可以做到这一点。我的方法是将右侧视为左侧的子组件。如你所见，<code class="fe lw lx ly lz b">FolderDetail</code>是左侧<code class="fe lw lx ly lz b">Folder</code>的子节点。在本系列的后面，我们将实现<code class="fe lw lx ly lz b">Task</code>组件。</p><p id="63fe" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">创建<code class="fe lw lx ly lz b">client/src/views/Folder.vue</code>:</p><pre class="ma mb mc md gt me lz mf mg aw mh bi"><span id="7e1a" class="mi ku iq lz b gy mj mk l ml mm">&lt;template&gt;<br/>  &lt;el-row class="max-height"&gt;<br/>    &lt;el-col :span="12" class="max-height"&gt;<br/>      &lt;div class="white card max-height"&gt;<br/>        &lt;div class="folder-header"&gt;<br/>          &lt;div class="header-title folder-name"&gt;{{folder.name}}&lt;/div&gt;<br/>        &lt;/div&gt;<br/>      &lt;/div&gt;<br/>    &lt;/el-col&gt;<br/>    &lt;el-col v-if="!isTeam(folder) &amp;&amp; subRoute==='folder'" :span="12" class="max-height"&gt;<br/>      &lt;FolderDetail :folder="folder"&gt;&lt;/FolderDetail&gt;<br/>    &lt;/el-col&gt;<br/>  &lt;/el-row&gt;<br/>&lt;/template&gt;</span><span id="e046" class="mi ku iq lz b gy mn mk l ml mm">&lt;script&gt;<br/>import { GetFolder } from '../constants/query.gql'<br/>import FolderDetail from './FolderDetail.vue'</span><span id="2f3f" class="mi ku iq lz b gy mn mk l ml mm">export default {<br/>  components: {<br/>    FolderDetail<br/>  },<br/>  beforeRouteUpdate (to, from, next) {<br/>    this.subRoute = to.name<br/>    next()<br/>  },<br/>  data() {<br/>    return {<br/>      subRoute: 'folder',<br/>      folderName: '',<br/>      folder: {<br/>        shareWith: []<br/>      },<br/>    }<br/>  },<br/>  apollo: {<br/>    getFolder: {<br/>      query: GetFolder,<br/>      variables() {<br/>        return {id: this.$route.params.id}<br/>      },<br/>      result ({data: { getFolder }}) {<br/>        this.folder = getFolder<br/>        this.folderName = this.folder.name<br/>        if (this.isTeam) {<br/>          document.title = `${this.folder.name} - enamel`          <br/>        }<br/>      },<br/>    }<br/>  },<br/>  methods: {<br/>    isTeam(folder) {<br/>      return !folder.parent &amp;&amp; folder.shareWith.length === 0<br/>    }<br/>  }<br/>}<br/>&lt;/script&gt;</span><span id="abe7" class="mi ku iq lz b gy mn mk l ml mm">&lt;style&gt;<br/>.folder-header {<br/>  padding: 15px 24px 0;<br/>  line-height: 21px;<br/>  min-height: 40px;<br/>}</span><span id="119b" class="mi ku iq lz b gy mn mk l ml mm">.folder-name {<br/>  padding: 0;<br/>  margin: 5px 0;<br/>  height: 32px;<br/>  width: 100%;<br/>}</span><span id="0c97" class="mi ku iq lz b gy mn mk l ml mm">.menu-title {<br/>  margin: 0 5px;<br/>  font-size: 12px;<br/>}</span><span id="a520" class="mi ku iq lz b gy mn mk l ml mm">.max-height {<br/>  height: 100%;<br/>}</span><span id="f926" class="mi ku iq lz b gy mn mk l ml mm">.white.card {<br/>  display: flex;<br/>  flex-direction: column;<br/>}</span><span id="49f8" class="mi ku iq lz b gy mn mk l ml mm">.task-container {<br/>  flex-grow: 1;<br/>  overflow: scroll;<br/>}</span><span id="4d22" class="mi ku iq lz b gy mn mk l ml mm">&lt;/style&gt;</span></pre><p id="aa5b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">它查询文件夹并显示名称。如果文件夹不是一个团队，它在右边呈现<code class="fe lw lx ly lz b">FolderDetail</code>。</p><p id="2a08" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">创建<code class="fe lw lx ly lz b">client/src/views/FolderDetail.vue</code>。现在没什么用。可以忽略长css，后面会用到。</p><pre class="ma mb mc md gt me lz mf mg aw mh bi"><span id="6820" class="mi ku iq lz b gy mj mk l ml mm">&lt;template&gt;<br/>  &lt;div class="white card max-height"&gt;<br/>  &lt;/div&gt;<br/>&lt;/template&gt;</span><span id="3231" class="mi ku iq lz b gy mn mk l ml mm">&lt;script&gt;</span><span id="d266" class="mi ku iq lz b gy mn mk l ml mm">export default {<br/>  props: ['folder'],<br/>  mounted() {<br/>    document.title = `${this.folder.name} - enamel`<br/>  },<br/>}<br/>&lt;/script&gt;</span><span id="b30a" class="mi ku iq lz b gy mn mk l ml mm">&lt;style scoped&gt;<br/>.folder-header {<br/>  padding: 15px 24px 0;<br/>  line-height: 21px;<br/>  min-height: 40px;<br/>}</span><span id="c4c1" class="mi ku iq lz b gy mn mk l ml mm">.folder-statebar {  <br/>  display: flex;<br/>  height: 48px;<br/>  position: relative;<br/>  padding: 0 24px;<br/>  border-bottom: solid 1px;<br/>  border-color: rgba(0,0,0,.16);<br/>}</span><span id="be69" class="mi ku iq lz b gy mn mk l ml mm">.folder-name {<br/>  padding: 0;<br/>  margin: 5px 0;<br/>  height: 32px;<br/>  width: 100%;<br/>}</span><span id="52ee" class="mi ku iq lz b gy mn mk l ml mm">.shared-with {<br/>  padding-left: 7px;<br/>}</span><span id="7a11" class="mi ku iq lz b gy mn mk l ml mm">.subfolder:hover {<br/>  color: initial;<br/>  cursor: default;<br/>}</span><span id="4e3b" class="mi ku iq lz b gy mn mk l ml mm">/*tooltip*/</span><span id="298f" class="mi ku iq lz b gy mn mk l ml mm">.member-avatar {<br/>  margin-right: 8px;<br/>  cursor: pointer;<br/>}</span><span id="ddc7" class="mi ku iq lz b gy mn mk l ml mm">.member-avatar:hover .remove-button {<br/>  visibility: visible;<br/>}</span><span id="d093" class="mi ku iq lz b gy mn mk l ml mm">.tooltip .tooltip-content {<br/>  width: 278px;<br/>  left: 50%; <br/>  margin-left: -139px;<br/>}</span><span id="3614" class="mi ku iq lz b gy mn mk l ml mm">.search-input {<br/>  padding: 15px;<br/>}</span><span id="f2bb" class="mi ku iq lz b gy mn mk l ml mm">.contact-picker-item-list {<br/>  padding-bottom: 24px;<br/>  max-height: 295px;<br/>  overflow: auto;<br/>}</span><span id="3c82" class="mi ku iq lz b gy mn mk l ml mm">.group-field {<br/>  box-sizing: border-box;<br/>  padding: 15px;<br/>}</span><span id="e1ff" class="mi ku iq lz b gy mn mk l ml mm">.add-additional {<br/>  display: flex;<br/>  flex-direction: row;<br/>}</span><span id="4a68" class="mi ku iq lz b gy mn mk l ml mm">.label {<br/>  text-align: left;<br/>}</span><span id="87c7" class="mi ku iq lz b gy mn mk l ml mm">&lt;/style&gt;</span></pre><p id="e852" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">好吧，让我们来测试一下目前的情况。进入工作区，点击团队。您应该会看到左边的<code class="fe lw lx ly lz b">Folder</code>组件。既然是团队，<code class="fe lw lx ly lz b">FolderDetail</code>就不显示了。</p><figure class="ma mb mc md gt mp gh gi paragraph-image"><div role="button" tabindex="0" class="mq mr di ms bf mt"><div class="gh gi my"><img src="../Images/8e300b58ebd6246cd7113e49087d1314.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*kCxV-_PnLCLYA1VoUDtPiA.png"/></div></div></figure><p id="0170" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">还是很无聊，我知道。</p><h1 id="d7e8" class="kt ku iq bd kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq bi translated">接下来:创建、更新和删除文件夹</h1><p id="67d3" class="pw-post-body-paragraph jn jo iq jp b jq lr js jt ju ls jw jx jy lt ka kb kc lu ke kf kg lv ki kj kk ij bi translated">这部分结果比我预想的要长，我就讲到这里。在<a class="ae kl" href="https://medium.com/@kenzotakahashi2/build-a-project-management-tool-with-vue-js-node-js-and-apollo-part-5-d59e6e345e39" rel="noopener">第5部分</a>中，我们将为文件夹实现一个CRUD功能。</p><p id="1a88" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><em class="kp">如果你喜欢这个帖子，请给它一些掌声！这激励我尽快写下一部分。</em></p></div></div>    
</body>
</html>