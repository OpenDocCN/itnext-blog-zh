# CI/CD 管道:您需要知道的一切

> 原文：<https://itnext.io/ci-cd-pipelines-everything-you-need-to-know-e0ef2754d449?source=collection_archive---------4----------------------->

## CI/CD 管道简介

在本帖中，我们将深入研究 CI/CD 管道的基础知识，概述使用它们的好处。然后，我们将查看管道中的每个阶段，以及什么构成了一个好的管道，以及一些与 Terraform 相关的示例。

![](img/801b05adf5d4ad98d76829b5ca5d92c1.png)

照片由 [Helio Dilolwa](https://unsplash.com/@dilolwa?utm_source=unsplash&utm_medium=referral&utm_content=creditCopyText) 在 [Unsplash](https://unsplash.com/s/photos/pipeline?utm_source=unsplash&utm_medium=referral&utm_content=creditCopyText) 拍摄

# 什么是 CI/CD 管道？

CI/CD 管道用于自动化软件或基础设施代码交付，从源代码到产品。它可以被认为是发布代码所需要采取的一系列步骤。

CI 代表持续集成，CD 代表持续交付或部署。“管道”是指交付工作流程的自动化，包括构建、测试、交付和部署阶段。尽管这些步骤中的每一步都可以手动执行，但是通过最小化人为错误并为每个版本带来一致性，自动化和协调这些阶段可以最大化使用 CI/CD 管道的好处。

CI/CD 管道通常由应用交付团队和运营团队(DevOps)使用。他们是采用 DevOps 方法的支柱。

采用 CI/CD 管道带来许多**好处**，包括:

*   **降低成本** —减少应用或基础设施编码和部署的时间，意味着占用更少的人力资源。
*   **缩短部署时间** —通过自动化缩短部署时间。从编码到部署的整个流程得到了简化，减少了总流程长度，提高了效率。可以更频繁地进行部署。发布的速度可以给公司带来比竞争对手更大的商业竞争优势。如果出现问题，部署也可以轻松回滚。代码开发人员可以保持专注。
*   **支持持续反馈—** 支持团队根据收到的反馈改进他们的代码和工作流程。测试阶段会突出问题或错误，并立即给出反馈以改进代码。在编码过程中尽早发现错误意味着更容易、更快地修复错误。可以设置通知来提醒团队成员每个阶段的成功或失败。
*   **改善团队协作** —团队可以看到问题，查看反馈，并在适当的时候做出改变。
*   **审计跟踪** —管道的每个阶段都会生成日志，并且可以实现责任性和可追溯性。

CI/CD 管道本身通常在代码中配置，有时称为“管道代码”。

通常，构建服务器(或构建代理)用于启用 CI/CD 运行。这些通常采取云中自托管虚拟机的形式，这些虚拟机可以完全配置，但也必须维护，或者作为您正在使用的平台的一部分提供的虚拟机，这些虚拟机在添加软件和插件方面通常不太灵活。

容器还可以用来支持一致的构建环境，进一步消除对维护构建服务器的依赖。CI/CD 管道的每一步都可以在它自己的容器中运行，允许每一步都在一个完全定制的容器中运行。这也使管道能够充分利用容器化编排带来的所有好处，比如需要时的弹性和伸缩性。

## 持续集成

CI 涵盖了管道的构建和测试阶段。代码中的每一个变化都应该触发一个自动化的构建和测试，允许代码的开发者得到快速的反馈。

## 持续交付/部署(CD)

CI/CD 管道的 CD 部分指的是交付和部署(CI/CDD 有人吗？！)CD 发生在代码成功通过管道的测试阶段之后。连续交付指的是在 CI 阶段之后自动发布到存储库。连续部署是指已经交付的工件的自动部署。

# CI/CD 管道的阶段

从编写源代码开始，到产品化结束，这些阶段组成了开发工作流，并形成了 CI/CD 管道的生命周期。管道运行通常由代码更改自动触发，但也可以按计划运行、由用户手动运行或在另一个管道运行后触发。

## **建造**

构建阶段包括正在编写的代码。这通常由一个团队中的多个人来完成，对于较大的项目，由多个团队来完成。代码保存在版本控制系统(VCS)中，基于 Git 的工作流通常用于控制添加到存储库中的代码(也称为 GitOps)。当在管道中使用时，为了消除不同作者代码之间的任何差异，管理开发人员环境并使其标准化的工具特别有用。在使用云原生软件时，这通常采用 docker 容器的形式。

## **测试**

由于需要更大的弹性，并且引入了更多不同的基础设施，测试代码导致对代码将按预期执行更大的信心。你的代码测试可以自动化。一般来说，这通常是一个重复的、复杂的、有时乏味的手动执行的过程。许多团队犯的一个错误是跳过测试阶段或没有充分利用它，因为在交付和部署之前正确测试代码的好处是巨大的，有助于高质量的产品。

测试可以分为多种类型，结合使用这些类型和不同的工具将会给出最高的代码覆盖率，并产生更高质量的产品。在使用大量不同测试的情况下，这些测试可以并行化，以减少流水线运行时间。

**冒烟测试** —对代码进行快速的完整性检查。

**集成测试** —集成测试旨在测试所有的代码，或者作为一个整体的系统。他们验证新引入的代码不会破坏现有的代码。

**单元测试** —单元测试旨在测试一个特定的功能，几个功能一起，或者部分代码。基础设施的较小部分可以被隔离，测试可以并行运行以缩短反馈周期。

**合规性测试** —合规性测试用于确保配置遵循您为项目定义的策略。

**端到端测试(E2E)** —在部署到生产环境之前，E2E 测试会验证一切是否能够协同工作。这是对整个过程的完整测试。

## 传递

在代码被测试之后，代码被打包成一个工件并提交给一个存储库。

## 部署

部署阶段允许工件发布的编排。通常，团队将部署到多个环境中，包括供内部使用的环境，如开发和试运行，以及供最终用户使用的生产环境。使用这个模型，当管道被触发时，团队可以自动地部署到一个阶段环境。一旦评审和批准了阶段环境，代码就可以合并到主分支中，然后自动部署到生产中。

# 什么是好的 CI/CD 渠道？

好的管道应该可靠、准确、快速。

## 可靠性

管道每次都应该可靠地运行，没有任何错误或意外的间歇错误。破裂的管道会导致沮丧和浪费时间。当管道破裂或抛出错误时，建议所有者在继续产品工作之前尽快修复它。这种方法可以让其他用户避免同样的问题，并帮助整个团队。正是由于这个原因，许多组织都有一个指定的“DevOps”团队，该团队将拥有管道并监控其成功。

给定相同的输入，可靠的管道将产生相同的结果。

自托管的构建代理通常是不可靠管道运行的原因，这是因为这些管道需要维护(底层基础设施、修补、包管理、安全性等)。然而，它们有时是必要的，因为与平台提供的构建代理相比，它们提供了更大的灵活性。

## 准确(性)

消除重复性任务中的错误是 CI/CD 管道真正能够提高产品整体质量的地方。

## 速度

优化管道以尽可能快地运行可以确保代码的开发人员能够快速获得管道运行成功或失败的反馈，使他们更加高效，减少分心和“上下文切换”(切换到另一个任务/会议/浏览网页)的机会。

快速管道运行还可以更频繁地实现部署。例如，如果管道运行需要 1 小时，工作日为 8 小时，那么每天绝对最多可以进行 8 次部署。将管道运行时间减少到 30 分钟，现在可以进行 16 次部署。

管道运行的一个常见问题是，它们最终处于排队状态，等待生成代理处理完上一次运行，然后才能开始下一次运行。因此，应该提供多个代理，以便不同的管道可以并行运行。无服务器模型或容器编排解决方案在这里特别有用，以便在需求高时动态地扩展构建代理的容量。

好的管道也能快速建立。它们应该用代码编写，并与产品代码一起保存在 VCS 中。基本模板可以通过提供一个公共结构来编写，其他模板可以引用该结构，从而加快创建新管道所需的时间。

# 使用 Terraform 的管道工作流程示例

## 建设

开发人员编写 Terraform 代码，并将其推送到 VCS 中的 Git 存储库。

## 试验

与 Terraform CLI 驱动的管道运行一起使用的测试工具包括 *Tfsec* 和 *Checkov* 。许多特定于基础设施即代码的 CI/CD 平台支持策略即代码，例如 *Terraform Cloud* ，或者更好的是 *Spacelift* ，它使用开源开放策略代理(OPA)，这意味着这种测试语言可以跨使用不同工具的多个项目使用。

## 传递

准备 Terraform 执行环境(可能包括从密钥库中获取秘密，或者设置环境变量)。

`terraform init`

`terraform plan`(将输出文件复制到一个存储库中，以备部署阶段的 apply 命令使用。

## 部署

`terraform apply`

# 使用 Kubernetes 的管道工作流示例

## 建设

开发人员编写 Kubernetes 配置文件，并将它们推送到 VCS 中的 Git 存储库中。可以添加 YAML 文件来定义管道的其他组件，例如配置数据的配置图或敏感信息的机密。

## 试验

构建代码并在其上运行测试。 *Kube-bench* 是一个安全工具，它根据最佳实践和行业标准(包括 CIS 基准)检查 Kubernetes 的配置。*舵单元测试*是舵图表的测试工具。

## 传递

一旦测试通过，CI 服务器就会创建应用程序的 Docker 容器映像，并将其推送到 Docker Hub 或 Amazon ECR 等容器注册中心。

## 部署

一旦容器映像在注册中心可用，就可以使用 Kubernetes 来部署应用程序。

# . NET 应用程序的管道工作流示例

## 建设

开发者写。NET 代码，并将其推送到 VCS 中的 Git 存储库中。代码是在推送时构建的，由 CI 使用构建工具(如 MSBuild 或 dotnet CLI)触发。

## 试验

构建代码并在其上运行测试。单元测试可以使用像 *NUnit* 或 *xUnit* 这样的框架来完成。

## 传递

一旦测试通过，CI 服务器就会生成一个工件，比如可以部署的 NuGet 包或自包含的可执行文件。

## 部署

藏物已经展开了。

# 摘要

CI/CD 管道对于现代工程师来说是一个需要完全理解的重要概念，尤其是在当前的云环境中。

干杯！🍻

[](https://www.buymeacoffee.com/jackwesleyroper) [## Jack Roper 正在 Azure、Azure DevOps、Terraform、Kubernetes 和 Cloud tech 上写博客！

### 希望我的博客能帮到你，你会喜欢它的内容！我真的很喜欢写技术内容和分享…

www.buymeacoffee.com](https://www.buymeacoffee.com/jackwesleyroper) 

*原载于*[*space lift . io*](https://spacelift.io/)*。*