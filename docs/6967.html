<html>
<head>
<title>Fluentd Pulsar Plugin</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Fluentd Pulsar插件</h1>
<blockquote>原文：<a href="https://itnext.io/fluentd-pulsar-plugin-ad7085f44278?source=collection_archive---------1-----------------------#2022-04-28">https://itnext.io/fluentd-pulsar-plugin-ad7085f44278?source=collection_archive---------1-----------------------#2022-04-28</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><figure class="gl gn jr js jt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi jq"><img src="../Images/3133b4b21e22cbddbdb2f0e8a7a0e530.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*ABg9yUaPxIFOADeo"/></div></div><figcaption class="kb kc gj gh gi kd ke bd b be z dk translated">照片由<a class="ae kf" href="https://unsplash.com/@drew_beamer?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">德鲁·比默</a>在<a class="ae kf" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄</figcaption></figure><p id="7a6d" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">对于那些碰巧读过<a class="ae kf" rel="noopener ugc nofollow" target="_blank" href="/pulsar-or-kafka-and-the-lessons-from-doing-our-own-testing-a0180dfc4582">脉冲星或Kakfa的人来说？</a>你会知道我们最近决定双脚跳进脉冲星。我们的部分数据流使用Fluentd将数据路由到许多地方，包括Grafana Loki(<a class="ae kf" rel="noopener ugc nofollow" target="_blank" href="/loki-to-the-rescue-7c3cc0989a7">Loki to the rescue</a>)和一些将数据推送到Pulsar进行一些额外测试的微服务。这些都工作了，但是还有一个服务需要维护。</p><p id="ff57" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">我们首先想到的是，有人已经为Fluentd创建了一个Pulsar插件。我们找不到！我们确实发现了一些Fluentbit插件，但是它们没有被设置为处理多个实例(将数据推送到多个主题)。我们甚至发现了几个毫无用处的空插件。我们试图修改其中一个插件，并能够让它处理多个实例，我们认为生活很好，直到我们尝试了一些测试，其中Fluentbit无法连接到pulsar集群，这导致了Fluentbit本身的SIGTERM，我们认为它来自pulsar go库。所以这些都是彻头彻尾的失败。</p><p id="0eb9" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">在我们测试Kafka和Strimzi时，它有一个名为Bridge的组件，这是Kafka的一个REST API，允许您推送事件。谢天谢地，Pulsar最近也实现了类似的功能；Pulsar只让你充当发行商，但这正是我们所需要的！请记住，这个特性是刚刚添加到2.10.0版本中的。</p><p id="fd8e" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">那么两个不认识Ruby的家伙该怎么办呢？好吧，从当前不稳定的代码中取出一些，并使其服从我们的意愿。这包括一个格式化程序和输出插件。</p><h2 id="650f" class="le lf it bd lg lh li dn lj lk ll dp lm kr ln lo lp kv lq lr ls kz lt lu lv lw bi translated">格式化程序</h2><p id="955c" class="pw-post-body-paragraph kg kh it ki b kj lx kl km kn ly kp kq kr lz kt ku kv ma kx ky kz mb lb lc ld im bi translated">我们面临的第一个挑战是通过REST API将数据转换成Pulsar期望的正确格式。</p><p id="2f6f" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">因为我们处理的所有数据都是JSON，所以我们采用了formatter_json.rb并对其进行了修改，使其适用于正确的格式，并保存为formatter_json_pulsar.rb。您将会注意到，唯一真正的区别是将当前消息放在message中:{}</p><figure class="mc md me mf gt ju"><div class="bz fp l di"><div class="mg mh l"/></div></figure><h2 id="4034" class="le lf it bd lg lh li dn lj lk ll dp lm kr ln lo lp kv lq lr ls kz lt lu lv lw bi translated">输出插件</h2><p id="553a" class="pw-post-body-paragraph kg kh it ki b kj lx kl km kn ly kp kq kr lz kt ku kv ma kx ky kz mb lb lc ld im bi translated">为了实际发送到Pulsar REST API，我们需要稍微修改一下输出，将所有消息作为有效载荷数组下的一个数组，然后将它们发送到Fluentd HTTP输入。</p><figure class="mc md me mf gt ju"><div class="bz fp l di"><div class="mg mh l"/></div></figure><h2 id="cc7b" class="le lf it bd lg lh li dn lj lk ll dp lm kr ln lo lp kv lq lr ls kz lt lu lv lw bi translated">包括新的插件</h2><p id="7b36" class="pw-post-body-paragraph kg kh it ki b kj lx kl km kn ly kp kq kr lz kt ku kv ma kx ky kz mb lb lc ld im bi translated">我们使用Bitnami Fluentd容器映像，以便将这两个文件添加到/opt/bitbnami/fluentd/plugins目录中。这可以通过创建一个新的容器(我们的路径)或者通过docker-compose文件来完成。如果您走容器路线，您将只需要一个复制命令来把文件放到插件目录中。</p><h2 id="d451" class="le lf it bd lg lh li dn lj lk ll dp lm kr ln lo lp kv lq lr ls kz lt lu lv lw bi translated">流动配置</h2><p id="1c88" class="pw-post-body-paragraph kg kh it ki b kj lx kl km kn ly kp kq kr lz kt ku kv ma kx ky kz mb lb lc ld im bi translated">既然我们已经将新的插件添加到了Fluentd容器中，我们可以修改我们的Fluentd配置来包含新的http_pulsar输出。默认情况下，输出使用格式化程序，因此您不需要显式设置它。</p><p id="ad32" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">注意:Pulsar REST API只对已经创建的主题有效，它不会创建新的主题。</p><p id="4852" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">这个配置将通过样本输入生成一些样本数据，并输出到pulsar。当然你需要适应你的环境，但是会给你一个它能做什么的想法。HTTP输出中的所有标准配置选项都在这里，除了content_type，它已经被硬编码，因为Pulsar只接受Application/json</p><figure class="mc md me mf gt ju"><div class="bz fp l di"><div class="mg mh l"/></div></figure><h1 id="42db" class="mi lf it bd lg mj mk ml lj mm mn mo lm mp mq mr lp ms mt mu ls mv mw mx lv my bi translated">摘要</h1><p id="d6ff" class="pw-post-body-paragraph kg kh it ki b kj lx kl km kn ly kp kq kr lz kt ku kv ma kx ky kz mb lb lc ld im bi translated">希望你觉得这有点用！我花了很长时间寻找一个可以工作的Pulsar插件，但是每个插件都有这样或那样的问题。我们已经做了大量的测试，还没有发现弱点，但是我确信这个解决方案中存在一个弱点(像所有软件一样！).</p><p id="578b" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">感谢您的阅读，如果您喜欢这篇文章或我的其他文章，请鼓掌并关注！</p></div></div>    
</body>
</html>