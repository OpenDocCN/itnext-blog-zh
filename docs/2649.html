<html>
<head>
<title>AWS Step Functions — why you should use them.</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">AWS阶跃函数——为什么应该使用它们。</h1>
<blockquote>原文：<a href="https://itnext.io/aws-step-functions-why-you-should-use-them-eb40cc359f2a?source=collection_archive---------0-----------------------#2019-07-03">https://itnext.io/aws-step-functions-why-you-should-use-them-eb40cc359f2a?source=collection_archive---------0-----------------------#2019-07-03</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="554c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在本系列的第一篇文章中，我们介绍了设置一个可以在AWS上运行的无头chrome浏览器的过程，使用Puppeteer API，让chrome导航到一个URL，等待页面完全加载，然后创建一个PDF。</p><p id="6a97" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在第二篇文章的<a class="ae kl" rel="noopener ugc nofollow" target="_blank" href="/running-arbitrary-executables-in-aws-lambda-encrypting-a-pdf-afea47e3c345?source=friends_link&amp;sk=22d11f9a7e4a759c51f09368a4974b30">中，我们使用命令行工具<code class="fe km kn ko kp b">qpdf</code>对PDF进行了加密，这是从源代码构建的。</a></p><p id="8d22" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">今天，我将介绍一个使用AWS阶跃函数的真实例子。我们将介绍构建一个step functions流程，该流程调用PDF服务，决定是否加密输出，然后通过电子邮件将PDF发送到指定的地址。</p></div><div class="ab cl kq kr hu ks" role="separator"><span class="kt bw bk ku kv kw"/><span class="kt bw bk ku kv kw"/><span class="kt bw bk ku kv"/></div><div class="ij ik il im in"><figure class="ky kz la lb gt lc gh gi paragraph-image"><div role="button" tabindex="0" class="ld le di lf bf lg"><div class="gh gi kx"><img src="../Images/70cea52b7565476392f295262b6b838c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*QlgMf5hz9qtNGpymQeZM0g.jpeg"/></div></div></figure><h2 id="92b6" class="lj lk iq bd ll lm ln dn lo lp lq dp lr jy ls lt lu kc lv lw lx kg ly lz ma mb bi translated">什么是阶跃函数？</h2><blockquote class="mc md me"><p id="f9f8" class="jn jo mf jp b jq jr js jt ju jv jw jx mg jz ka kb mh kd ke kf mi kh ki kj kk ij bi translated">AWS步骤功能允许您将多个AWS服务协调到无服务器工作流中，以便您可以快速构建和更新应用程序。使用Step函数，您可以设计和运行将AWS Lambda和Amazon ECS等服务缝合到功能丰富的应用程序中的工作流。</p></blockquote><p id="4407" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们将要构建的流程如下所示:</p><figure class="ky kz la lb gt lc gh gi paragraph-image"><div class="gh gi mj"><img src="../Images/1c204e8a3d91fbb25764c049030f2fe6.png" data-original-src="https://miro.medium.com/v2/resize:fit:428/format:webp/1*HSYgUzidWrIYC1xJYtMoaA.png"/></div></figure><p id="72ae" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们将传入我们想要pdf的url，以及可选的加密参数和要发送到的电子邮件地址。如果我们的参数请求，工作流只运行加密步骤。</p><h2 id="2d7e" class="lj lk iq bd ll lm ln dn lo lp lq dp lr jy ls lt lu kc lv lw lx kg ly lz ma mb bi translated">为什么要使用阶跃函数？</h2><p id="6a6e" class="pw-post-body-paragraph jn jo iq jp b jq mk js jt ju ml jw jx jy mm ka kb kc mn ke kf kg mo ki kj kk ij bi translated">我推荐使用阶跃函数有很多原因。其中包括:</p><ul class=""><li id="ae69" class="mp mq iq jp b jq jr ju jv jy mr kc ms kg mt kk mu mv mw mx bi translated">这是处理长时间运行的工作流的简单方法。如果您使用过Api Gateway，您可能会遇到<a class="ae kl" href="https://stackoverflow.com/questions/54299958/how-can-i-set-the-aws-api-gateway-timeout-higher-than-30-seconds" rel="noopener ugc nofollow" target="_blank"> 30秒超时限制</a>。使用step功能，您的整个业务流程最多可在一年内完成！此外，每个单独的lambda函数最多允许15分钟。</li><li id="1193" class="mp mq iq jp b jq my ju mz jy na kc nb kg nc kk mu mv mw mx bi translated">它鼓励您将代码分解成一堆可重用的微服务，然后可以针对不同的业务流程以不同的方式进行组合。</li><li id="5c18" class="mp mq iq jp b jq my ju mz jy na kc nb kg nc kk mu mv mw mx bi translated">每个步骤都可以指定失败时是否应该重试。您可以指定重试间隔、最大尝试次数和退避率。这意味着您可以防止您的流程由于您的一个依赖项中的临时中断而失败。</li><li id="db02" class="mp mq iq jp b jq my ju mz jy na kc nb kg nc kk mu mv mw mx bi translated">您可以看到工作流的可视化显示，它会随着流程的进展而更新，允许您检查每个步骤的输入和输出、任何异常和完整的日志。您还可以添加警报，以便在出现问题时通知您。</li><li id="a541" class="mp mq iq jp b jq my ju mz jy na kc nb kg nc kk mu mv mw mx bi translated">您可以添加选择步骤，以便根据输入数据决定下一步运行哪个步骤。在上面的流程中，IsEncryptionRequired是一个选择步骤。</li><li id="bed1" class="mp mq iq jp b jq my ju mz jy na kc nb kg nc kk mu mv mw mx bi translated">您还可以添加一个用于创建并行执行分支的并行步骤。</li><li id="1940" class="mp mq iq jp b jq my ju mz jy na kc nb kg nc kk mu mv mw mx bi translated">最后，您可以直接触发step函数，或者使用类似cron-job的表达式来调度它们。</li></ul><p id="0e7a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">主要缺点是:</p><ul class=""><li id="6713" class="mp mq iq jp b jq jr ju jv jy mr kc ms kg mt kk mu mv mw mx bi translated">一旦步骤功能流已经开始，当前就没有api支持来检查其进度。</li><li id="f0d4" class="mp mq iq jp b jq my ju mz jy na kc nb kg nc kk mu mv mw mx bi translated">您被限制在两个步骤之间传递不超过32K的数据。在这篇文章的后面，我们将看看如何解决这个限制。</li><li id="b32e" class="mp mq iq jp b jq my ju mz jy na kc nb kg nc kk mu mv mw mx bi translated">免费层并不是特别慷慨，虽然至少它不会在你的第一年结束时过期。您目前每月收到4000份免费状态转换。见<a class="ae kl" href="https://aws.amazon.com/step-functions/pricing/" rel="noopener ugc nofollow" target="_blank">定价</a>。注意<em class="mf"> </em>每一次重试都将作为一次额外的状态转换。</li></ul><h2 id="76af" class="lj lk iq bd ll lm ln dn lo lp lq dp lr jy ls lt lu kc lv lw lx kg ly lz ma mb bi translated">发送电子邮件</h2><p id="f0be" class="pw-post-body-paragraph jn jo iq jp b jq mk js jt ju ml jw jx jy mm ka kb kc mn ke kf kg mo ki kj kk ij bi translated">我们的服务将通过电子邮件发送PDF文件。为了支持这一点，让我们定义一个适当的接口来支持电子邮件发送:</p><pre class="ky kz la lb gt nd kp ne nf aw ng bi"><span id="a0f1" class="lj lk iq kp b gy nh ni l nj nk">export interface EmailService {</span><span id="c9e2" class="lj lk iq kp b gy nl ni l nj nk">  send(to: string, subject: string, body: string, base64Attachment?: string, attachmentName?: string): Promise&lt;any&gt;;</span><span id="143a" class="lj lk iq kp b gy nl ni l nj nk">}</span></pre><p id="02a7" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">有很多方法可以实现这个接口，例如使用<a class="ae kl" href="https://sendgrid.com" rel="noopener ugc nofollow" target="_blank"> SendGrid </a>，但是最简单的方法可能是使用<a class="ae kl" href="https://nodemailer.com/about/" rel="noopener ugc nofollow" target="_blank"> nodemailer </a></p><pre class="ky kz la lb gt nd kp ne nf aw ng bi"><span id="9a71" class="lj lk iq kp b gy nh ni l nj nk">npm i nodemailer</span></pre><p id="3d5c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">下面是一个可能的实现，使用gmail作为发件人:</p><figure class="ky kz la lb gt lc"><div class="bz fp l di"><div class="nm nn l"/></div></figure><p id="ac20" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">要允许nodemailer连接到您的邮件服务器，您需要提供凭据，这不应该包含在您的代码中。无服务器框架为<a class="ae kl" href="https://serverless.com/blog/serverless-secrets-api-keys/" rel="noopener ugc nofollow" target="_blank">管理机密</a>提供了一些选择。我最喜欢的选择是利用AWS参数存储(也称为SSM，简单系统管理器)。</p><h2 id="ae37" class="lj lk iq bd ll lm ln dn lo lp lq dp lr jy ls lt lu kc lv lw lx kg ly lz ma mb bi translated">向你的lambda传递秘密</h2><p id="6657" class="pw-post-body-paragraph jn jo iq jp b jq mk js jt ju ml jw jx jy mm ka kb kc mn ke kf kg mo ki kj kk ij bi translated">将环境部分添加到您的<code class="fe km kn ko kp b">serverless.yml</code></p><pre class="ky kz la lb gt nd kp ne nf aw ng bi"><span id="4c99" class="lj lk iq kp b gy nh ni l nj nk">environment:<br/>  EMAIL_ADDRESS: ${ssm:emailAddress-${opt:stage, self:provider.stage}~true}<br/>  EMAIL_PASSWORD: ${ssm:emailPassword-${opt:stage, self:provider.stage}~true}</span></pre><p id="b327" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">请注意，在值被加密的地方需要使用<code class="fe km kn ko kp b">~true</code>后缀，如果您使用<code class="fe km kn ko kp b">SecureString</code>值类型，就会出现这种情况——见下文。此外，通过在这些值的名称中包含阶段，您可以轻松地为<code class="fe km kn ko kp b">dev</code>、<code class="fe km kn ko kp b">test</code>和<code class="fe km kn ko kp b">prod</code>阶段设置不同的值。</p><p id="4d1b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">上面的实现使用以下代码行从环境中提取这些值:</p><pre class="ky kz la lb gt nd kp ne nf aw ng bi"><span id="5625" class="lj lk iq kp b gy nh ni l nj nk">const emailAddress = process.env.EMAIL_ADDRESS;<br/>const emailPassword = process.env.EMAIL_PASSWORD;</span></pre><p id="7c54" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">最后，使用AWS cli设置这些值，例如</p><pre class="ky kz la lb gt nd kp ne nf aw ng bi"><span id="b9b4" class="lj lk iq kp b gy nh ni l nj nk">aws ssm put-parameter --name emailPassword-dev --type SecureString --region us-east-1 --value PLw-q6x-PdX-Ab1</span></pre><p id="029d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">请注意，您可以在不同的区域设置不同的值，因此请确保您指定了要部署到的区域。</p><h2 id="1cce" class="lj lk iq bd ll lm ln dn lo lp lq dp lr jy ls lt lu kc lv lw lx kg ly lz ma mb bi translated">在S3存储文件</h2><p id="a86a" class="pw-post-body-paragraph jn jo iq jp b jq mk js jt ju ml jw jx jy mm ka kb kc mn ke kf kg mo ki kj kk ij bi translated">正如上面的缺点列表中所提到的，您被限制在步骤之间传递不超过32K的数据。为了在步骤之间传递pdf文件，我们将把它们写入S3，并将文件路径传递给下一个步骤，而不是传递文件的内容。</p><div class="no np gp gr nq nr"><a href="https://docs.aws.amazon.com/step-functions/latest/dg/concepts-service-integrations.html" rel="noopener  ugc nofollow" target="_blank"><div class="ns ab fo"><div class="nt ab nu cl cj nv"><h2 class="bd ir gy z fp nw fr fs nx fu fw ip bi translated">AWS服务集成- AWS步骤功能</h2><div class="ny l"><h3 class="bd b gy z fp nw fr fs nx fu fw dk translated">了解如何协调其他AWS服务和AWS步骤功能。</h3></div><div class="nz l"><p class="bd b dl z fp nw fr fs nx fu fw dk translated">docs.aws.amazon.com</p></div></div><div class="oa l"><div class="ob l oc od oe oa of lh nr"/></div></div></a></div><p id="2580" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">Step functions目前支持与各种AWS服务(如DynamoDB)的直接集成，但在撰写本文时，还不支持将文件写入S3。为了允许我们读写S3文件，让我们给我们的<code class="fe km kn ko kp b">FileSystemService</code>添加一个S3实现。</p><figure class="ky kz la lb gt lc"><div class="bz fp l di"><div class="nm nn l"/></div></figure><p id="2e02" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们还需要通过向<code class="fe km kn ko kp b">serverless.yml</code>添加以下内容来配置对存储文件的S3存储桶的访问</p><pre class="ky kz la lb gt nd kp ne nf aw ng bi"><span id="d9f9" class="lj lk iq kp b gy nh ni l nj nk">environment:<br/>  STEP_FUNCTIONS_DATA_BUCKET: ${self:service}-${opt:stage, self:provider.stage}-step-functions-data-bucket</span><span id="98d2" class="lj lk iq kp b gy nl ni l nj nk"><br/>resources:<br/>  Resources:<br/>    StepFunctionsDataBucket:<br/>      Type: AWS::S3::Bucket<br/>      Properties:<br/>        BucketName: ${self:provider.environment.STEP_FUNCTIONS_DATA_BUCKET}</span><span id="c4f9" class="lj lk iq kp b gy nl ni l nj nk">iamRoleStatements: # permissions for all functions are set here<br/>  - Effect: Allow<br/>    Action:<br/>      - s3:PutObject<br/>      - s3:GetObject<br/>    Resource:<br/>      Fn::Join:<br/>        - ""<br/>        - - "arn:aws:s3:::"<br/>          - Ref: "StepFunctionsDataBucket"<br/>          - "/*"</span></pre><p id="d114" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这里我们定义一个环境变量来保存bucket名称(包括stage)，创建bucket资源并允许PutObject和GetObject调用它。</p><h2 id="2083" class="lj lk iq bd ll lm ln dn lo lp lq dp lr jy ls lt lu kc lv lw lx kg ly lz ma mb bi translated">定义工作流</h2><p id="2fbf" class="pw-post-body-paragraph jn jo iq jp b jq mk js jt ju ml jw jx jy mm ka kb kc mn ke kf kg mo ki kj kk ij bi translated">现在我们已经有了所有的构建模块，我们可以继续定义一个阶跃函数状态机。</p><p id="159b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">您使用基于JSON的<a class="ae kl" href="https://docs.aws.amazon.com/step-functions/latest/dg/concepts-amazon-states-language.html" rel="noopener ugc nofollow" target="_blank"> Amazon States语言</a>定义状态机。<code class="fe km kn ko kp b"><a class="ae kl" href="https://serverless.com/plugins/serverless-step-functions/" rel="noopener ugc nofollow" target="_blank">serverless-step-functions</a></code>插件支持在我们的<code class="fe km kn ko kp b">serverless.yml</code>文件中包含这样的定义。<code class="fe km kn ko kp b"> serverless-pseudo-parameters</code>插件对于构建ARNs也很有用。</p><p id="6486" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在终端运行中:</p><pre class="ky kz la lb gt nd kp ne nf aw ng bi"><span id="7b97" class="lj lk iq kp b gy nh ni l nj nk">npm install --save-dev serverless-step-functions<br/>npm install --save-dev serverless-pseudo-parameters</span></pre><p id="7355" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">然后将以下部分添加到您的<code class="fe km kn ko kp b">serverless.yml</code></p><pre class="ky kz la lb gt nd kp ne nf aw ng bi"><span id="2ba4" class="lj lk iq kp b gy nh ni l nj nk">plugins:<br/>  - serverless-step-functions<br/>  - serverless-pseudo-parameters</span></pre><p id="0378" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">将以下状态机定义添加到您的<code class="fe km kn ko kp b">serverless.yml</code></p><figure class="ky kz la lb gt lc"><div class="bz fp l di"><div class="nm nn l"/></div></figure><p id="6d9c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">events部分设置了一个https端点，一个<code class="fe km kn ko kp b">POST</code>将启动这个流，而<code class="fe km kn ko kp b">POST</code>的主体为第一步提供输入数据。</p><p id="205a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">定义为<code class="fe km kn ko kp b">GeneratePdf</code>、<code class="fe km kn ko kp b">Encrypt</code>和<code class="fe km kn ko kp b">SendByEmail</code>定义了3个任务步骤。这些步骤各自定义了一个结果路径，例如<code class="fe km kn ko kp b">$.pdfFileName</code>。这将步骤的输出作为属性添加到输入对象中。这样，步骤之间传递的数据可以累积。</p><p id="e080" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">该定义还包括一个选择步骤，它查看输入的<code class="fe km kn ko kp b">encryptionRequired</code>属性。如果是，下一步是<code class="fe km kn ko kp b">encrypt</code>，否则是<code class="fe km kn ko kp b">sendByEmail</code>。</p><p id="fbb1" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们可以定义一个接口来描述可以传递给工作流的参数:</p><pre class="ky kz la lb gt nd kp ne nf aw ng bi"><span id="6b8b" class="lj lk iq kp b gy nh ni l nj nk">export interface CreatePdfRequest {<br/>    url: string;<br/>    reportName: string;<br/>    toAddress: string;<br/>    encryptionRequired: boolean;<br/>    ownerPassword?: string;<br/>    userPassword?: string;<br/>    pdfFilePath?: string;<br/>    encryptedFilePath?: string;<br/>};</span></pre><p id="e48e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">最后一项工作是修改handler.ts来定义每个任务步骤使用的lambda函数</p><figure class="ky kz la lb gt lc"><div class="bz fp l di"><div class="nm nn l"/></div></figure><p id="7699" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">并将映射添加到<code class="fe km kn ko kp b">serverless.yml</code></p><pre class="ky kz la lb gt nd kp ne nf aw ng bi"><span id="e641" class="lj lk iq kp b gy nh ni l nj nk">functions:<br/>  generatePdf:<br/>    handler: lib/handler.generatePdf<br/>  encrypt:<br/>    handler: lib/handler.encrypt<br/>  emailPdfReport:<br/>    handler: lib/handler.emailPdfReport</span></pre><p id="e1fb" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">每个函数都遵循相同的模式:</p><ul class=""><li id="01c5" class="mp mq iq jp b jq jr ju jv jy mr kc ms kg mt kk mu mv mw mx bi translated">将传入事件转换到请求接口</li><li id="ecc0" class="mp mq iq jp b jq my ju mz jy na kc nb kg nc kk mu mv mw mx bi translated">如果需要，读取输入数据</li><li id="8df5" class="mp mq iq jp b jq my ju mz jy na kc nb kg nc kk mu mv mw mx bi translated">调用支持该步骤功能的服务</li><li id="7458" class="mp mq iq jp b jq my ju mz jy na kc nb kg nc kk mu mv mw mx bi translated">构建步骤的输出</li><li id="2776" class="mp mq iq jp b jq my ju mz jy na kc nb kg nc kk mu mv mw mx bi translated">将输出传递给回调。</li></ul><p id="7edb" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">现在用<code class="fe km kn ko kp b">npm run deploy</code>部署您的代码，如果一切顺利，您将看到已经创建的端点:</p><pre class="ky kz la lb gt nd kp ne nf aw ng bi"><span id="a3f8" class="lj lk iq kp b gy nh ni l nj nk">Serverless StepFunctions OutPuts<br/>endpoints:<br/>  POST - <a class="ae kl" href="https://j80szm0d9i.execute-api.us-east-1.amazonaws.com/dev/pdf/create" rel="noopener ugc nofollow" target="_blank">https://j80szm0d9i.execute-api.us-east-1.amazonaws.com/dev/pdf/create</a></span></pre><p id="215d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">使用curl测试服务:</p><pre class="ky kz la lb gt nd kp ne nf aw ng bi"><span id="c527" class="lj lk iq kp b gy nh ni l nj nk">curl "Content-Type: application/json" -d '{"url" : "<a class="ae kl" href="https://example.com" rel="noopener ugc nofollow" target="_blank">https://example.com</a>", "reportName" : "example report 1", "toAddress": "<a class="ae kl" href="mailto:keith.coughtrey@gmail.com" rel="noopener ugc nofollow" target="_blank">[to email address</a>]", "encryptionRequired": false }' <a class="ae kl" href="https://j80szm0d9i.execute-api.us-east-1.amazonaws.com/dev/pdf/create" rel="noopener ugc nofollow" target="_blank">https://j80szm0d9i.execute-api.us-east-1.amazonaws.com/dev/pdf/create</a></span></pre><p id="f6cf" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><code class="fe km kn ko kp b">POST</code>应该返回类似这样的内容:</p><pre class="ky kz la lb gt nd kp ne nf aw ng bi"><span id="5510" class="lj lk iq kp b gy nh ni l nj nk">{"executionArn":"arn:aws:states:us-east-1:175240006580:execution:lambda-puppeteer-dev-pdf-workflow:eaacf7ac-9bc4-11e9-8a16-abe9d3e2566a","startDate":1.561960566573E9}</span></pre><p id="ce68" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">希望你会收到这封邮件，如果没有，请转到步骤功能控制台并单击执行。如果您尚未成功设置您的电子邮件服务器凭据，您可能会看到如下内容:</p><figure class="ky kz la lb gt lc gh gi paragraph-image"><div role="button" tabindex="0" class="ld le di lf bf lg"><div class="gh gi og"><img src="../Images/cfbf513481988c7034428a6796055a2a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*uqmxtZJK9iENw5taKEMCMQ.png"/></div></div></figure><h2 id="ff8d" class="lj lk iq bd ll lm ln dn lo lp lq dp lr jy ls lt lu kc lv lw lx kg ly lz ma mb bi translated">如果一开始你没有成功…</h2><p id="88b2" class="pw-post-body-paragraph jn jo iq jp b jq mk js jt ju ml jw jx jy mm ka kb kc mn ke kf kg mo ki kj kk ij bi translated">一旦我们获得了正确的邮件服务器凭据，如果我们试图发送电子邮件时邮件服务器关闭了，会发生什么情况。我们只需在步骤定义中添加一个<code class="fe km kn ko kp b">retry</code>部分，例如:</p><pre class="ky kz la lb gt nd kp ne nf aw ng bi"><span id="4a86" class="lj lk iq kp b gy nh ni l nj nk">EmailPdfReport:<br/>    Type: Task<br/>    Resource: ...<br/>    ResultPath: $.email<br/>    Next: GetPaymentType<br/>    Retry:<br/>    - ErrorEquals:<br/>      - States.ALL<br/>      IntervalSeconds: 30<br/>      MaxAttempts: 4<br/>      BackoffRate: 4</span></pre><p id="e755" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">此配置将在30秒、2分钟、8分钟和32分钟后重试。</p></div><div class="ab cl kq kr hu ks" role="separator"><span class="kt bw bk ku kv kw"/><span class="kt bw bk ku kv kw"/><span class="kt bw bk ku kv"/></div><div class="ij ik il im in"><p id="1ac5" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">step函数的真正优点是，当我们需要支持一个新的需求，使用Stripe对一些报告进行收费，或者我们需要通过回调而不是电子邮件来交付一些报告时，会发生什么情况呢？显然，答案是我们添加更多的步骤和选择来支持这些不同的流程，随着时间的推移，我们建立了一个可重用的服务库，这些服务可以以不同的方式进行组合。</p><p id="c825" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">好了，这就结束了这一系列的职位。我希望你觉得它们有趣并且有用。该系列的所有代码都可以在<a class="ae kl" href="https://github.com/keithcoughtrey/LambdaPuppeteer" rel="noopener ugc nofollow" target="_blank">这里</a>找到。</p><p id="cb9b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">当我开始使用阶跃函数时，我发现了许多人为的例子和教程，我在这里的目的是展示一些更真实的东西。注意，为了简洁起见，我省略了一些细节，比如确保存储在S3的文件名是惟一的(这样它们就不会被并发调用覆盖),以及在流程结束时从S3删除文件。</p><p id="8f06" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">记得使用<code class="fe km kn ko kp b">sls remove</code>来释放你的资源，我建议在CloudFormation中检查栈实际上已经被删除了。</p></div></div>    
</body>
</html>