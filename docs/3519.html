<html>
<head>
<title>Using Dry-rb for Form Objects in Ruby on Rails</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在Ruby on Rails中对表单对象使用Dry-rb</h1>
<blockquote>原文：<a href="https://itnext.io/using-dry-rb-for-form-objects-in-ruby-on-rails-f965e0c0e86a?source=collection_archive---------4-----------------------#2020-01-02">https://itnext.io/using-dry-rb-for-form-objects-in-ruby-on-rails-f965e0c0e86a?source=collection_archive---------4-----------------------#2020-01-02</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="a1cb" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">Form对象允许你将验证从ActiveRecord模型转移到单独的类，这允许你保持你的模型精简，这对于大型项目尤其重要。</p><p id="a178" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我以前用<a class="ae kl" href="https://github.com/solnic/virtus" rel="noopener ugc nofollow" target="_blank"> virtus gem </a>来建造形态物体，但是现在它被弃用了，为此我选择了<a class="ae kl" href="https://dry-rb.org/" rel="noopener ugc nofollow" target="_blank"> dry-rb </a>。还有很多其他的宝石，比如浅属性，快属性，属性，也许你会选择它们。</p><p id="2e43" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">给宝石文件添加宝石</strong></p><pre class="km kn ko kp gt kq kr ks kt aw ku bi"><span id="ebdc" class="kv kw iq kr b gy kx ky l kz la">gem 'dry-struct', '~&gt; 1.2.0'<br/>gem 'dry-types', '~&gt; 1.2.2'<br/>gem 'dry-validation', '~&gt; 1.4.0'</span></pre><p id="a014" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我使用dry-struct作为表单对象的基类，dry-types用于定义变量类型，dry-validation用于验证对象。</p><p id="b250" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">安装它</strong></p><pre class="km kn ko kp gt kq kr ks kt aw ku bi"><span id="a3c4" class="kv kw iq kr b gy kx ky l kz la">bundle install</span></pre><p id="f20e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">建筑形体对象</strong></p><p id="18fe" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在我的应用程序中，我有一个带有名称和区域字符串属性的世界类，所以这个类的基本表单对象将是这样的。</p><pre class="km kn ko kp gt kq kr ks kt aw ku bi"><span id="7a3e" class="kv kw iq kr b gy kx ky l kz la">class WorldForm &lt; Dry::Struct<br/>  module Types<br/>    include Dry::Types(default: :nominal)<br/>  end</span><span id="ab2b" class="kv kw iq kr b gy lb ky l kz la">  attribute :id, Types::Integer.optional<br/>  attribute :name, Types::String<br/>  attribute :zone, Types::Integer<br/>end</span></pre><p id="af1d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在这里，我们为世界形态对象定义类并设置属性。在<a class="ae kl" href="https://dry-rb.org/gems/dry-types/1.2/" rel="noopener ugc nofollow" target="_blank"> dry-types </a>中有许多属性选项可供您使用。</p><p id="8992" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">添加验证</strong></p><p id="3943" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">为了在表单对象中使用验证，我添加了带有已定义模式和自定义验证规则的契约类。所以这里必须给出<strong class="jp ir">名称</strong>和<strong class="jp ir">区域</strong>字符串参数。在自定义验证规则中，我们首先传递规则中使用的属性，然后可以检查它们，所以我检查了具有这种参数的世界不存在(values[:id])。零？检查它是新记录还是已有记录)。</p><pre class="km kn ko kp gt kq kr ks kt aw ku bi"><span id="f503" class="kv kw iq kr b gy kx ky l kz la">class WorldContract &lt; Dry::Validation::Contract<br/>  schema do<br/>    optional(:id)<br/>    required(:name).filled(:string)<br/>    required(:zone).filled(:string)<br/>  end</span><span id="cd6a" class="kv kw iq kr b gy lb ky l kz la">  rule(:id, :name, :zone) do<br/>    worlds = values[:id].nil? ? World.all : World.where.not(id: values[:id])</span><span id="7309" class="kv kw iq kr b gy lb ky l kz la">    key.failure('Failed') if worlds.where(name: values[:name], zone: values[:zone]).exists?<br/>  end<br/>end</span></pre><p id="30a2" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">整理表单对象</strong></p><p id="d850" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们只需要添加一些方法来检查属性和创建/更新对象。</p><p id="a695" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">to_hash方法使用属性及其值创建散列。在调用world contract . new . call(attributes)之后，我们将在模式对象中得到验证结果。如果模式包含错误，那么我修改它们以便更好地呈现(你可以有别的东西)并且save方法返回false。如果验证通过，那么我通过设置表单对象的属性来创建/更新世界对象，并保存。</p><pre class="km kn ko kp gt kq kr ks kt aw ku bi"><span id="f761" class="kv kw iq kr b gy kx ky l kz la">class WorldForm &lt; Dry::Struct<br/>  ...</span><span id="f685" class="kv kw iq kr b gy lb ky l kz la">  attr_reader :world, :errors</span><span id="3039" class="kv kw iq kr b gy lb ky l kz la">  def save<br/>    attributes = to_hash<br/>    schema = WorldContract.new.call(attributes)<br/>    <a class="ae kl" href="http://twitter.com/errors" rel="noopener ugc nofollow" target="_blank">@errors</a> = schema.errors(locale: I18n.locale).to_h.values.flatten<br/>    return false unless errors.empty?<br/>    <a class="ae kl" href="http://twitter.com/world" rel="noopener ugc nofollow" target="_blank">@world</a> = attributes[:id] ? World.find_by(id: attributes[:id]) : World.new<br/>    world.attributes = attributes.except(:id)<br/>    world.save<br/>  end<br/>end</span></pre><p id="a61d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">添加I18n </strong></p><p id="996d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">您可以将本地化参数传递给契约类。</p><pre class="km kn ko kp gt kq kr ks kt aw ku bi"><span id="b4e7" class="kv kw iq kr b gy kx ky l kz la">class WorldContract &lt; Dry::Validation::Contract<br/>  config.messages.namespace = :world<br/>  config.messages.backend = :i18n</span><span id="2f2f" class="kv kw iq kr b gy lb ky l kz la">  ...</span><span id="d422" class="kv kw iq kr b gy lb ky l kz la">  rule(:id, :name, :zone) do<br/>    ...</span><span id="8acd" class="kv kw iq kr b gy lb ky l kz la">   key.failure(I18n.t('dry_validation.errors.world.is_exist')) if worlds.where(name: values[:name], zone: values[:zone]).exists?<br/>  end<br/>end</span></pre><p id="f3bf" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">并使用本地化创建新yaml文件。</p><pre class="km kn ko kp gt kq kr ks kt aw ku bi"><span id="7643" class="kv kw iq kr b gy kx ky l kz la">en:<br/>  dry_validation:<br/>    errors:<br/>      world:<br/>        is_exist: World with such params already exists<br/>        rules:<br/>          name:<br/>            filled?: Name can't be blank<br/>          zone:<br/>            filled?: Zone can't be blank</span></pre><p id="adc0" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">通过在save方法中调用schema . errors(locale:i18n . locale ),您将在WorldForm对象的errors变量中找到本地化的错误。</p><p id="9acd" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">结果</strong></p><p id="bdbb" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">所以用dry-rb完成的表单对象看起来像这样。</p><pre class="km kn ko kp gt kq kr ks kt aw ku bi"><span id="fa74" class="kv kw iq kr b gy kx ky l kz la">class WorldForm &lt; Dry::Struct<br/>  module Types<br/>    include Dry::Types(default: :nominal)<br/>  end</span><span id="3df8" class="kv kw iq kr b gy lb ky l kz la">  attribute :id, Types::Integer.optional<br/>  attribute :name, Types::String<br/>  attribute :zone, Types::Integer</span><span id="bd5a" class="kv kw iq kr b gy lb ky l kz la">  attr_reader :world, :errors</span><span id="d25d" class="kv kw iq kr b gy lb ky l kz la">  def save<br/>    attributes = to_hash<br/>    schema = WorldContract.new.call(attributes)<br/>    <a class="ae kl" href="http://twitter.com/errors" rel="noopener ugc nofollow" target="_blank">@errors</a> = schema.errors(locale: I18n.locale).to_h.values.flatten<br/>    return false unless errors.empty?<br/>    <a class="ae kl" href="http://twitter.com/world" rel="noopener ugc nofollow" target="_blank">@world</a> = attributes[:id] ? World.find_by(id: attributes[:id]) : World.new<br/>    world.attributes = attributes.except(:id)<br/>    world.save<br/>  end<br/>end</span><span id="7737" class="kv kw iq kr b gy lb ky l kz la">class WorldContract &lt; Dry::Validation::Contract<br/>  config.messages.namespace = :world<br/>  config.messages.backend = :i18n</span><span id="a17a" class="kv kw iq kr b gy lb ky l kz la">  schema do<br/>    optional(:id)<br/>    required(:name).filled(:string)<br/>    required(:zone).filled(:string)<br/>  end</span><span id="00fa" class="kv kw iq kr b gy lb ky l kz la">  rule(:id, :name, :zone) do<br/>    worlds = values[:id].nil? ? World.all : World.where.not(id: values[:id])</span><span id="c706" class="kv kw iq kr b gy lb ky l kz la">    key.failure(I18n.t('dry_validation.errors.world.is_exist')) if worlds.where(name: values[:name], zone: values[:zone]).exists?<br/>  end<br/>end</span></pre><p id="cc0b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">使用表单对象</strong></p><p id="a4cf" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">然后你可以在控制器或交互器中使用你的表单对象。</p><p id="9186" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">为了用表单对象创建世界，我传递了带符号键和nil id的参数。成功保存后，您可以使用world_form.world来呈现json或其他任何内容。以及保存失败后world _ form.errors为渲染错误。</p><pre class="km kn ko kp gt kq kr ks kt aw ku bi"><span id="4344" class="kv kw iq kr b gy kx ky l kz la">world_form = WorldForm.new(world_params.merge(id: nil))<br/>if world_form.save<br/>  # world_form.world<br/>  ...<br/>else<br/>  # world_form.errors<br/>  ...<br/>end</span><span id="6773" class="kv kw iq kr b gy lb ky l kz la">...</span><span id="4f76" class="kv kw iq kr b gy lb ky l kz la">def world_params<br/>  params.require(:world).permit(:name, :zone).to_h.symbolize_keys<br/>end</span></pre><p id="fc55" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">为了更新世界对象，我只改变了世界形状的属性。</p><pre class="km kn ko kp gt kq kr ks kt aw ku bi"><span id="b7ae" class="kv kw iq kr b gy kx ky l kz la">world_form = WorldForm.new(<a class="ae kl" href="http://twitter.com/world" rel="noopener ugc nofollow" target="_blank">@world</a>.attributes.symbolize_keys.merge(world_params))<br/>if world_form.save<br/>  ...</span></pre><p id="af71" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">自定义类型</strong></p><p id="026a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果您需要验证与其他模型的关系，您将需要添加一些额外的代码。</p><pre class="km kn ko kp gt kq kr ks kt aw ku bi"><span id="3c43" class="kv kw iq kr b gy kx ky l kz la">class ActivityForm &lt; Dry::Struct<br/>  module Types<br/>    ...<br/>    World = Dry::Types::Nominal.new(::World)<br/>  end</span><span id="4b16" class="kv kw iq kr b gy lb ky l kz la">  ...<br/>  attribute :world, Types::World<br/>  ...<br/>end</span><span id="76e9" class="kv kw iq kr b gy lb ky l kz la">class ActivityContract &lt; Dry::Validation::Contract</span><span id="df89" class="kv kw iq kr b gy lb ky l kz la">  schema do<br/>    ...<br/>    required(:world).filled<br/>  end<br/>end</span></pre><p id="dcb2" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">用RSpec测试</strong></p><p id="8fa7" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们可以用rspec测试表单对象。</p><pre class="km kn ko kp gt kq kr ks kt aw ku bi"><span id="940c" class="kv kw iq kr b gy kx ky l kz la">RSpec.describe WorldForm, type: :service do<br/>  describe '.save' do<br/>    context 'for invalid data' do<br/>      let(:service) { described_class.new(id: nil, name: '', zone: '') }</span><span id="e5b2" class="kv kw iq kr b gy lb ky l kz la">      it 'does not create new world' do<br/>        expect { service.save }.to_not change(World, :count)<br/>      end</span><span id="1b1f" class="kv kw iq kr b gy lb ky l kz la">      it 'and returns false' do<br/>        expect(service.save).to eq false<br/>      end</span><span id="bb31" class="kv kw iq kr b gy lb ky l kz la">      it 'and form contains errors' do<br/>        service.save</span><span id="d80c" class="kv kw iq kr b gy lb ky l kz la">        expect(service.errors.size.positive?).to eq true<br/>      end<br/>    end</span><span id="70f1" class="kv kw iq kr b gy lb ky l kz la">    context 'for valid data' do<br/>      let!(:world) { create :world }</span><span id="f1fe" class="kv kw iq kr b gy lb ky l kz la">      context 'for existed world' do<br/>        let(:service) { described_class.new(id: nil, name: world.name, zone: world.zone) }</span><span id="89db" class="kv kw iq kr b gy lb ky l kz la">        it 'does not create new world' do<br/>          expect { service.save }.to_not change(World, :count)<br/>        end</span><span id="ea9a" class="kv kw iq kr b gy lb ky l kz la">        it 'and returns false' do<br/>          expect(service.save).to eq false<br/>        end</span><span id="d2c7" class="kv kw iq kr b gy lb ky l kz la">        it 'and form contains errors' do<br/>          service.save</span><span id="4c8f" class="kv kw iq kr b gy lb ky l kz la">          expect(service.errors.size.positive?).to eq true<br/>        end<br/>      end</span><span id="14b9" class="kv kw iq kr b gy lb ky l kz la">      context 'for unexisted world' do<br/>        let(:service) { described_class.new(id: nil, name: 'Хроми', zone: 'RU') }</span><span id="fde7" class="kv kw iq kr b gy lb ky l kz la">        it 'creates new world' do<br/>          expect { service.save }.to change { World.count }.by(1)<br/>        end</span><span id="ec75" class="kv kw iq kr b gy lb ky l kz la">        it 'and returns true' do<br/>          expect(service.save).to eq true<br/>        end</span><span id="1f0c" class="kv kw iq kr b gy lb ky l kz la">        it 'and form contains created world' do<br/>          service.save</span><span id="641f" class="kv kw iq kr b gy lb ky l kz la">          expect(service.world).to eq World.last<br/>        end<br/>      end<br/>    end</span><span id="7aa2" class="kv kw iq kr b gy lb ky l kz la">    context 'for updating' do<br/>      let!(:world1) { create :world }<br/>      let!(:world2) { create :world }</span><span id="edab" class="kv kw iq kr b gy lb ky l kz la">      context 'for invalid data' do<br/>        let(:service) { described_class.new(id: world1.id, name: '', zone: '') }</span><span id="d158" class="kv kw iq kr b gy lb ky l kz la">        it 'does not update world' do<br/>          service.save<br/>          world1.reload</span><span id="7792" class="kv kw iq kr b gy lb ky l kz la">          expect(world1.name).to_not eq ''<br/>          expect(world1.zone).to_not eq ''<br/>        end</span><span id="3abb" class="kv kw iq kr b gy lb ky l kz la">        it 'and form contains errors' do<br/>          service.save</span><span id="6af3" class="kv kw iq kr b gy lb ky l kz la">          expect(service.errors.size.positive?).to eq true<br/>        end<br/>      end</span><span id="8f6f" class="kv kw iq kr b gy lb ky l kz la">      context 'for existed data' do<br/>        let(:service) { described_class.new(id: world1.id, name: world2.name, zone: world2.zone) }</span><span id="55d2" class="kv kw iq kr b gy lb ky l kz la">        it 'does not update world' do<br/>          service.save<br/>          world1.reload</span><span id="e0de" class="kv kw iq kr b gy lb ky l kz la">          expect(world1.name).to_not eq world2.name<br/>        end</span><span id="fdcb" class="kv kw iq kr b gy lb ky l kz la">        it 'and form contains errors' do<br/>          service.save</span><span id="03f4" class="kv kw iq kr b gy lb ky l kz la">          expect(service.errors.size.positive?).to eq true<br/>        end<br/>      end</span><span id="e4eb" class="kv kw iq kr b gy lb ky l kz la">      context 'for valid data' do<br/>        let(:service) { described_class.new(id: world1.id, name: 'Хроми', zone: 'RU') }</span><span id="c242" class="kv kw iq kr b gy lb ky l kz la">        it 'does not update world' do<br/>          service.save<br/>          world1.reload</span><span id="f73e" class="kv kw iq kr b gy lb ky l kz la">          expect(world1.name).to eq 'Хроми'<br/>          expect(world1.zone).to eq 'RU'<br/>        end</span><span id="b343" class="kv kw iq kr b gy lb ky l kz la">        it 'and returns true' do<br/>          expect(service.save).to eq true<br/>        end</span><span id="a6a0" class="kv kw iq kr b gy lb ky l kz la">        it 'and form contains updated world' do<br/>          service.save</span><span id="ae36" class="kv kw iq kr b gy lb ky l kz la">          expect(service.world.id).to eq world1.id<br/>        end<br/>      end<br/>    end<br/>  end<br/>end</span></pre><p id="db17" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir">结论</strong></p><p id="0668" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">对表单对象使用<strong class="jp ir"> dry-rb </strong>允许你干净地保存你的模型，并把你所有的验证逻辑放在一个明确界定的地方。</p></div></div>    
</body>
</html>