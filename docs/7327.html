<html>
<head>
<title>ASP.NET Custom Metrics with OpenTelemetry Collector &amp; Prometheus/Grafana</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用open telemetry Collector &amp; Prometheus/Grafana的ASP.NET定制指标</h1>
<blockquote>原文：<a href="https://itnext.io/asp-net-custom-metrics-with-opentelemetry-collector-prometheus-grafana-4b39b4a2b754?source=collection_archive---------2-----------------------#2022-08-22">https://itnext.io/asp-net-custom-metrics-with-opentelemetry-collector-prometheus-grafana-4b39b4a2b754?source=collection_archive---------2-----------------------#2022-08-22</a></blockquote><div><div class="fc if ig ih ii ij"/><div class="ik il im in io"><div class=""/><p id="6c41" class="pw-post-body-paragraph jo jp ir jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl ik bi translated">不时有人问我，在现代应用程序中应该使用哪种跟踪、日志记录或监控解决方案，因为可能性越来越大——至少，你可能会有这种感觉。为了尽可能灵活和依赖开放标准，建议更仔细地研究OpenTelemetry。它变得越来越受欢迎，因为它提供了一个独立于供应商的解决方案，在您的服务中处理遥测数据，并将它们发送到您选择的后端(Prometheus、Jaeger等)。).让我们看看如何在space服务中使用OpenTelemetry自定义指标，并结合云本地空间中可能最流行的监控堆栈:Prometheus / Grafana。</p><h1 id="13d1" class="km kn ir bd ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj bi translated">TL；速度三角形定位法(dead reckoning)</h1><p id="364c" class="pw-post-body-paragraph jo jp ir jq b jr lk jt ju jv ll jx jy jz lm kb kc kd ln kf kg kh lo kj kk kl ik bi translated">你可以在<a class="ae lp" href="https://github.com/cdennig/otel-demo" rel="noopener ugc nofollow" target="_blank"> GitHub </a>上找到演示项目。它使用一个本地Kubernetes集群(<a class="ae lp" href="https://kind.sigs.k8s.io/" rel="noopener ugc nofollow" target="_blank">类</a>)来设置环境，并部署一个生成一些样本指标的演示应用程序。这些指标被发送到作为Prometheus指标端点的OTEL收集器。最后，这些指标由Prometheus收集并显示在Grafana仪表板/图表中。</p><figure class="lr ls lt lu gu lv gi gj paragraph-image"><div role="button" tabindex="0" class="lw lx di ly bf lz"><div class="gi gj lq"><img src="../Images/6c7508d84edea6d9dadb1b31165ee936.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*BhgK72KWRfPP9Y_6"/></div></div><figcaption class="mc md gk gi gj me mf bd b be z dk translated">演示设置</figcaption></figure><h1 id="8b8f" class="km kn ir bd ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj bi translated">OpenTelemetry —它是什么，为什么您应该关注它？</h1><figure class="lr ls lt lu gu lv gi gj paragraph-image"><div class="gi gj mg"><img src="../Images/d7fd5e26f92e9a08834dc87279822b57.png" data-original-src="https://miro.medium.com/v2/resize:fit:560/0*QdxBaEdvchXemVeP"/></div><figcaption class="mc md gk gi gj me mf bd b be z dk translated">开放式遥测</figcaption></figure><p id="a0c7" class="pw-post-body-paragraph jo jp ir jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl ik bi translated">OpenTelemetry (OTEL)是一个开源的CNCF项目，旨在提供一个独立于供应商的解决方案，用于生成、收集和处理基础设施和服务的遥测数据。它能够接收、处理和导出跟踪、日志和指标到不同的后端，如<a class="ae lp" href="https://prometheus.io/" rel="noopener ugc nofollow" target="_blank">普罗米修斯</a>、<a class="ae lp" href="https://www.jaegertracing.io/" rel="noopener ugc nofollow" target="_blank">积家</a>或其他商业SaaS产品，而不需要您的应用程序依赖这些解决方案。虽然OTEL本身不提供后端甚至分析能力，但它充当了“中央监控组件”，知道如何通过使用所谓的“导出器”将收到的数据发送到不同的后端。</p><p id="aed1" class="pw-post-body-paragraph jo jp ir jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl ik bi translated">所以你为什么要在乎呢？在当今的分布式系统和微服务架构世界中，开发人员可以更快、更独立地发布软件和服务，可观察性成为您环境中最重要的特性之一。系统的可见性对于应用程序的成功至关重要，因为它有助于您扩展组件、发现错误和错误配置等。</p><p id="7e0e" class="pw-post-body-paragraph jo jp ir jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl ik bi translated">如果您还没有决定在下一个应用中使用什么样的监控或跟踪解决方案，请查看OpenTelemetry。它让您可以自由尝试不同的监控解决方案，甚至在生产后期替换您喜欢的方案。</p><h1 id="39d1" class="km kn ir bd ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj bi translated">打开遥测组件</h1><p id="1a03" class="pw-post-body-paragraph jo jp ir jq b jr lk jt ju jv ll jx jy jz lm kb kc kd ln kf kg kh lo kj kk kl ik bi translated">OpenTelemetry目前由几个组件组成，如用于接收、处理/转换和导出遥测数据的仪器和工具的<a class="ae lp" href="https://opentelemetry.io/docs/reference/specification/" rel="noopener ugc nofollow" target="_blank">跨语言规范</a>(API/SDK和OpenTelemetry协议OTLP)。SDK有几种流行的语言版本，如Java、C++、C#、Go等。你可以在这里找到支持语言的完整列表<a class="ae lp" href="https://opentelemetry.io/docs/instrumentation/" rel="noopener ugc nofollow" target="_blank">。</a></p><p id="f6c6" class="pw-post-body-paragraph jo jp ir jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl ik bi translated">此外，还有一个名为“OpenTelemetry Collector”的组件，它是一个独立于供应商的代理，可以从不同的来源接收遥测数据，并在将数据发送到所需的后端解决方案之前对其进行转换。</p><p id="ca60" class="pw-post-body-paragraph jo jp ir jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl ik bi translated">让我们仔细看看收集器……<em class="mh">接收器、处理器</em>和<em class="mh">输出器</em>的组件:</p><ul class=""><li id="4b35" class="mi mj ir jq b jr js jv jw jz mk kd ml kh mm kl mn mo mp mq bi translated"><em class="mh">接收器</em>—open telemetry中的接收器是负责将数据送入收集器的组件。它可以用于基于推或拉的方法。它可以支持OLTP协议，甚至可以抓取Prometheus /metrics端点</li><li id="3117" class="mi mj ir jq b jr mr jv ms jz mt kd mu kh mv kl mn mo mp mq bi translated"><em class="mh">处理器</em> —处理器是一种组件，在将采集器接收的遥测数据移交给<em class="mh">导出器</em>之前，可以对其进行批处理、采样、转换和/或丰富。您可以添加或删除属性，例如“个人身份信息”(PII)，或者基于正则表达式过滤数据。处理器是收集器管道中的可选组件。</li><li id="3588" class="mi mj ir jq b jr mr jv ms jz mt kd mu kh mv kl mn mo mp mq bi translated"><em class="mh">导出器</em> —导出器负责将数据发送到后端解决方案，如Prometheus、Azure Monitor、DataDog、Splunk等。</li></ul><p id="f151" class="pw-post-body-paragraph jo jp ir jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl ik bi translated">最终，它归结为配置带有接收者、(可选的)处理器和导出者的收集器服务，以形成一个功能齐全的收集器管道——官方文档可以在<a class="ae lp" href="https://opentelemetry.io/docs/collector/configuration/" rel="noopener ugc nofollow" target="_blank">这里</a>找到。此处演示的配置如下:</p><pre class="lr ls lt lu gu mw mx my mz aw na bi"><span id="ce79" class="nb kn ir mx b gz nc nd l ne nf">receivers:<br/>  otlp:<br/>    protocols:<br/>      http:<br/>      grpc:<br/>processors:<br/>  batch:<br/>exporters:<br/>  logging:<br/>    loglevel: debug<br/>  prometheus:<br/>    endpoint: "0.0.0.0:8889"<br/>service:<br/>  pipelines:<br/>    metrics:<br/>      receivers: [otlp]<br/>      processors: [batch]<br/>      exporters: [logging, prometheus]</span></pre><p id="bab5" class="pw-post-body-paragraph jo jp ir jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl ik bi translated">该配置包括:</p><ul class=""><li id="d787" class="mi mj ir jq b jr js jv jw jz mk kd ml kh mm kl mn mo mp mq bi translated">一个开放式遥测协议(OTLP)接收器，用于<em class="mh"> http </em>和<em class="mh"> gRPC </em>通信</li><li id="d4cc" class="mi mj ir jq b jr mr jv ms jz mt kd mu kh mv kl mn mo mp mq bi translated">一个处理器，用默认值(例如200毫秒的<code class="fe ng nh ni mx b">timeout</code>)批量处理遥测数据</li><li id="0714" class="mi mj ir jq b jr mr jv ms jz mt kd mu kh mv kl mn mo mp mq bi translated">两个导出器将数据传输到控制台(<code class="fe ng nh ni mx b">logging</code>)，并在<code class="fe ng nh ni mx b">0.0.0.0:8889</code>上暴露一个普罗米修斯<code class="fe ng nh ni mx b">/metrics</code>端点(远程写入也是可能的)</li></ul><h1 id="d9a5" class="km kn ir bd ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj bi translated">ASP。网络开放遥测</h1><p id="736c" class="pw-post-body-paragraph jo jp ir jq b jr lk jt ju jv ll jx jy jz lm kb kc kd ln kf kg kh lo kj kk kl ik bi translated">为了演示如何通过OpenTelemetry将自定义指标从ASP.NET应用程序发送到Prometheus，我们首先需要一个公开这些指标的服务。在这个演示中，我们简单地创建了两个自定义指标<code class="fe ng nh ni mx b">otel.demo.metric.gauge1</code>和<code class="fe ng nh ni mx b">otel.demo.metric.gauge2</code>，它们将被发送到控制台(<code class="fe ng nh ni mx b">AddConsoleExporter()</code>)并通过OTLP协议发送到一个收集服务程序(<code class="fe ng nh ni mx b">AddOtlpExporter()</code>)，我们将在后面介绍这个收集服务程序。该应用程序使用ASP.NET最小API，代码或多或少是不言自明的:</p><pre class="lr ls lt lu gu mw mx my mz aw na bi"><span id="17cd" class="nb kn ir mx b gz nc nd l ne nf">using System.Diagnostics.Metrics;<br/>using OpenTelemetry.Resources;<br/>using OpenTelemetry.Metrics;<br/> <br/>var builder = WebApplication.CreateBuilder(args);<br/> <br/>builder.Services.AddOpenTelemetryMetrics(metricsProvider =&gt;<br/>{<br/>    metricsProvider<br/>        .AddConsoleExporter()<br/>        .AddOtlpExporter()<br/>        .AddMeter("otel.demo.metric")<br/>        .SetResourceBuilder(ResourceBuilder.CreateDefault()<br/>            .AddService(serviceName: "otel.demo", serviceVersion: "0.0.1")<br/>        );<br/>});<br/> <br/>var app = builder.Build();<br/>var otel_metric = new Meter("otel.demo.metric", "0.0.1");<br/>var randomNum = new Random();<br/>// Create two metrics<br/>var obs_gauge1 = otel_metric.CreateObservableGauge&lt;int&gt;("otel.demo.metric.gauge1", () =&gt;<br/>{<br/>    return randomNum.Next(10, 80);<br/>});<br/>var obs_gauge2 = otel_metric.CreateObservableGauge&lt;double&gt;("otel.demo.metric.gauge2", () =&gt;<br/>{<br/>    return randomNum.NextDouble();<br/>});<br/> <br/>app.MapGet("/otelmetric", () =&gt;<br/>{<br/>    return "Hello, Otel-Metric!";<br/>});<br/> <br/>app.Run();</span></pre><p id="b48f" class="pw-post-body-paragraph jo jp ir jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl ik bi translated">我们目前正在处理自定义指标。当然，ASP.NET也提供了现成的指标供您使用。在配置指标提供者时，只需通过添加<code class="fe ng nh ni mx b">AddAspNetCoreInstrumentation<strong class="jq is">()</strong></code>来使用ASP.NET工具特性——更多信息请点击<a class="ae lp" href="https://github.com/open-telemetry/opentelemetry-dotnet-instrumentation" rel="noopener ugc nofollow" target="_blank">这里</a>。</p><h1 id="8d12" class="km kn ir bd ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj bi translated">演示</h1><p id="3a52" class="pw-post-body-paragraph jo jp ir jq b jr lk jt ju jv ll jx jy jz lm kb kc kd ln kf kg kh lo kj kk kl ik bi translated">是时候把事情联系起来了。首先，让我们使用创建一个Kubernetes集群，在这里我们可以发布演示服务，启动OTEL收集器实例并运行一个Prometheus/Grafana环境。如果你想跟随教程，从<a class="ae lp" href="https://github.com/cdennig/otel-demo" rel="noopener ugc nofollow" target="_blank">https://github.com/cdennig/otel-demo</a>克隆回购，并切换到<code class="fe ng nh ni mx b">otel-demo</code>目录。</p><h1 id="258f" class="km kn ir bd ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj bi translated">创建一个本地Kubernetes集群</h1><p id="2c4b" class="pw-post-body-paragraph jo jp ir jq b jr lk jt ju jv ll jx jy jz lm kb kc kd ln kf kg kh lo kj kk kl ik bi translated">要创建一个能够托管Prometheus环境的<code class="fe ng nh ni mx b">kind</code>集群，请执行:</p><pre class="lr ls lt lu gu mw mx my mz aw na bi"><span id="9c24" class="nb kn ir mx b gz nc nd l ne nf">$ kind create cluster --name demo-cluster \ <br/>     --config ./kind/kind-cluster.yaml</span></pre><p id="6226" class="pw-post-body-paragraph jo jp ir jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl ik bi translated">YAML配置文件(<code class="fe ng nh ni mx b">./kind/kind-cluster.yaml</code>)调整Kubernetes控制平面的一些设置，以便Prometheus能够抓取控制器服务的端点。接下来，创建OpenTelemetry收集器实例。</p><h1 id="5549" class="km kn ir bd ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj bi translated">OTEL收藏家</h1><p id="54fb" class="pw-post-body-paragraph jo jp ir jq b jr lk jt ju jv ll jx jy jz lm kb kc kd ln kf kg kh lo kj kk kl ik bi translated">在<code class="fe ng nh ni mx b">manifests</code>目录中，您会发现两个Kubernetes清单。一个包含收集器的配置(<code class="fe ng nh ni mx b">otel-collector.yaml</code>)。它包括收集器配置的<code class="fe ng nh ni mx b">ConfigMap</code>(它将作为一个卷安装到收集器容器中)，收集器本身的部署和一个公开数据接收端口的服务(<code class="fe ng nh ni mx b">4318</code>用于<code class="fe ng nh ni mx b">http</code>和<code class="fe ng nh ni mx b">4317</code>用于<code class="fe ng nh ni mx b">gRPC</code>)以及稍后将由Prometheus收集的指标端点(<code class="fe ng nh ni mx b">8889</code>)。它看起来如下:</p><pre class="lr ls lt lu gu mw mx my mz aw na bi"><span id="68d0" class="nb kn ir mx b gz nc nd l ne nf">apiVersion: v1<br/> <br/>kind: ConfigMap<br/>metadata:<br/>  name: otel-collector-config<br/>data:<br/>  otel-collector-config: |-<br/>    receivers:<br/>      otlp:<br/>        protocols:<br/>          http:<br/>          grpc:<br/>    exporters:<br/>      logging:<br/>        loglevel: debug<br/>      prometheus:<br/>        endpoint: "0.0.0.0:8889"<br/>    processors:<br/>      batch:<br/>    service:<br/>      pipelines:<br/>        metrics:<br/>          receivers: [otlp]<br/>          processors: [batch]<br/>          exporters: [logging, prometheus]<br/>---<br/>apiVersion: apps/v1<br/>kind: Deployment<br/>metadata:<br/>  name: otel-collector<br/>  labels:<br/>    app: otel-collector<br/>spec:<br/>  replicas: 1<br/>  selector:<br/>    matchLabels:<br/>      app: otel-collector<br/>  template:<br/>    metadata:<br/>      labels:<br/>        app: otel-collector<br/>    spec:<br/>      containers:<br/>        - name: collector<br/>          image: otel/opentelemetry-collector:latest<br/>          args:<br/>            - --config=/etc/otelconf/otel-collector-config.yaml<br/>          ports:<br/>            - name: otel-http<br/>              containerPort: 4318<br/>            - name: otel-grpc<br/>              containerPort: 4317<br/>            - name: prom-metrics<br/>              containerPort: 8889<br/>          volumeMounts:<br/>            - name: otel-config<br/>              mountPath: /etc/otelconf<br/>      volumes:<br/>        - name: otel-config<br/>          configMap:<br/>            name: otel-collector-config<br/>            items:<br/>              - key: otel-collector-config<br/>                path: otel-collector-config.yaml<br/>---<br/>apiVersion: v1<br/>kind: Service<br/>metadata:<br/>  name: otel-collector<br/>  labels:<br/>    app: otel-collector<br/>spec:<br/>  type: ClusterIP<br/>  ports:<br/>    - name: otel-http<br/>      port: 4318<br/>      protocol: TCP<br/>      targetPort: 4318<br/>    - name: otel-grpc<br/>      port: 4317<br/>      protocol: TCP<br/>      targetPort: 4317<br/>    - name: prom-metrics<br/>      port: 8889<br/>      protocol: TCP<br/>      targetPort: prom-metrics<br/>  selector:<br/>    app: otel-collector</span></pre><p id="f4c3" class="pw-post-body-paragraph jo jp ir jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl ik bi translated">让我们应用清单。</p><pre class="lr ls lt lu gu mw mx my mz aw na bi"><span id="4424" class="nb kn ir mx b gz nc nd l ne nf">$ kubectl apply -f ./manifests/otel-collector.yaml<br/> <br/>configmap/otel-collector-config created<br/>deployment.apps/otel-collector created<br/>service/otel-collector created</span></pre><p id="2c0a" class="pw-post-body-paragraph jo jp ir jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl ik bi translated">检查一切是否按预期运行:</p><pre class="lr ls lt lu gu mw mx my mz aw na bi"><span id="b212" class="nb kn ir mx b gz nc nd l ne nf">$ kubectl get pods,deployments,services,endpoints<br/> <br/>NAME                                  READY   STATUS    RESTARTS   AGE<br/>pod/otel-collector-5cd54c49b4-gdk9f   1/1     Running   0          5m13s<br/> <br/>NAME                             READY   UP-TO-DATE   AVAILABLE   AGE<br/>deployment.apps/otel-collector   1/1     1            1           5m13s<br/> <br/>NAME                     TYPE        CLUSTER-IP     EXTERNAL-IP   PORT(S)                      AGE<br/>service/kubernetes       ClusterIP   10.96.0.1      &lt;none&gt;        443/TCP                      22m<br/>service/otel-collector   ClusterIP   10.96.194.28   &lt;none&gt;        4318/TCP,4317/TCP,8889/TCP   5m13s<br/> <br/>NAME                       ENDPOINTS                                         AGE<br/>endpoints/kubernetes       172.19.0.9:6443                                   22m<br/>endpoints/otel-collector   10.244.1.2:8889,10.244.1.2:4318,10.244.1.2:4317   5m13s</span></pre><p id="f729" class="pw-post-body-paragraph jo jp ir jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl ik bi translated">既然OpenTelemetry基础设施已经就绪，让我们添加暴露定制指标的工作负载。</p><h1 id="5b15" class="km kn ir bd ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj bi translated">ASP。净工作量</h1><p id="5e72" class="pw-post-body-paragraph jo jp ir jq b jr lk jt ju jv ll jx jy jz lm kb kc kd ln kf kg kh lo kj kk kl ik bi translated">为了您的方便，演示应用程序已经被容器化并发布到GitHub容器注册中心。因此，要向集群添加工作负载，只需应用包含<code class="fe ng nh ni mx b">Deployment</code>清单的<code class="fe ng nh ni mx b">./manifests/otel-demo-workload.yaml</code>，并添加两个环境变量来配置OTEL收集器端点和要使用的OTLP协议——在本例中是<code class="fe ng nh ni mx b">gRPC</code>。</p><p id="d4e2" class="pw-post-body-paragraph jo jp ir jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl ik bi translated">相关部分如下:</p><pre class="lr ls lt lu gu mw mx my mz aw na bi"><span id="096d" class="nb kn ir mx b gz nc nd l ne nf">spec:<br/>  containers:<br/>  - image: ghcr.io/cdennig/otel-demo:1.0<br/>    name: otel-demo<br/>    env:<br/>    - name: OTEL_EXPORTER_OTLP_ENDPOINT<br/>      value: "<a class="ae lp" href="http://otel-collector.default.svc.cluster.local:4317" rel="noopener ugc nofollow" target="_blank">http://otel-collector.default.svc.cluster.local:4317</a>"<br/>    - name: OTEL_EXPORTER_OTLP_PROTOCOL<br/>      value: "grpc"</span></pre><p id="2592" class="pw-post-body-paragraph jo jp ir jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl ik bi translated">立即应用清单。</p><pre class="lr ls lt lu gu mw mx my mz aw na bi"><span id="d542" class="nb kn ir mx b gz nc nd l ne nf">$ kubectl apply -f ./manifests/otel-demo-workload.yaml</span></pre><p id="5dc7" class="pw-post-body-paragraph jo jp ir jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl ik bi translated">请记住，应用程序也会记录到控制台。让我们查询ASP.NET服务的日志(注意，在您的环境中，podname会有所不同)。</p><pre class="lr ls lt lu gu mw mx my mz aw na bi"><span id="df7b" class="nb kn ir mx b gz nc nd l ne nf">$ kubectl logs po/otel-workload-69cc89d456-9zfs7<br/> <br/>info: Microsoft.Hosting.Lifetime[14]<br/>      Now listening on: <a class="ae lp" href="http://[::]:80" rel="noopener ugc nofollow" target="_blank">http://[::]:80</a><br/>info: Microsoft.Hosting.Lifetime[0]<br/>      Application started. Press Ctrl+C to shut down.<br/>info: Microsoft.Hosting.Lifetime[0]<br/>      Hosting environment: Production<br/>info: Microsoft.Hosting.Lifetime[0]<br/>      Content root path: /app/<br/>Resource associated with Metric:<br/>    service.name: otel.demo<br/>    service.version: 0.0.1<br/>    service.instance.id: b84c78be-49df-42fa-bd09-0ad13481d826<br/> <br/>Export otel.demo.metric.gauge1, Meter: otel.demo.metric/0.0.1<br/>(2022-08-20T11:40:41.4260064Z, 2022-08-20T11:40:51.3451557Z] LongGauge<br/>Value: 10<br/> <br/>Export otel.demo.metric.gauge2, Meter: otel.demo.metric/0.0.1<br/>(2022-08-20T11:40:41.4274763Z, 2022-08-20T11:40:51.3451863Z] DoubleGauge<br/>Value: 0.8778815716262417<br/> <br/>Export otel.demo.metric.gauge1, Meter: otel.demo.metric/0.0.1<br/>(2022-08-20T11:40:41.4260064Z, 2022-08-20T11:41:01.3387999Z] LongGauge<br/>Value: 19<br/> <br/>Export otel.demo.metric.gauge2, Meter: otel.demo.metric/0.0.1<br/>(2022-08-20T11:40:41.4274763Z, 2022-08-20T11:41:01.3388003Z] DoubleGauge<br/>Value: 0.35409627617124295</span></pre><p id="a9ae" class="pw-post-body-paragraph jo jp ir jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl ik bi translated">同样，让我们检查数据是否将被发送到收集器。记住它在<code class="fe ng nh ni mx b">0.0.0.0:8889/metrics</code>上公开了它的<code class="fe ng nh ni mx b">/metrics</code>端点。让我们通过将服务端口转发到本地机器来查询它。</p><pre class="lr ls lt lu gu mw mx my mz aw na bi"><span id="4468" class="nb kn ir mx b gz nc nd l ne nf">$ kubectl port-forward svc/otel-collector 8889:8889<br/> <br/>Forwarding from 127.0.0.1:8889 -&gt; 8889<br/>Forwarding from [::1]:8889 -&gt; 8889<br/> <br/># in a different session, curl the endpoint<br/>$  curl <a class="ae lp" href="http://localhost:8889/metrics" rel="noopener ugc nofollow" target="_blank">http://localhost:8889/metrics</a><br/> <br/># HELP otel_demo_metric_gauge1<br/># TYPE otel_demo_metric_gauge1 gauge<br/>otel_demo_metric_gauge1{instance="b84c78be-49df-42fa-bd09-0ad13481d826",job="otel.demo"} 37<br/># HELP otel_demo_metric_gauge2<br/># TYPE otel_demo_metric_gauge2 gauge<br/>otel_demo_metric_gauge2{instance="b84c78be-49df-42fa-bd09-0ad13481d826",job="otel.demo"} 0.45433988869946285</span></pre><p id="b1c7" class="pw-post-body-paragraph jo jp ir jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl ik bi translated">太好了，两个组件——指标生成器和收集器——都正常工作。现在，让我们启动Prometheus/Grafana环境，添加服务监视器来抓取<code class="fe ng nh ni mx b">/metrics</code>端点并为其创建Grafana仪表板。</p><h1 id="cdae" class="km kn ir bd ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj bi translated">添加Kube-Prometheus-Stack</h1><p id="be66" class="pw-post-body-paragraph jo jp ir jq b jr lk jt ju jv ll jx jy jz lm kb kc kd ln kf kg kh lo kj kk kl ik bi translated">将Prometheus/Grafana stack添加到您的Kubernetes集群的最简单方法是使用<a class="ae lp" href="https://github.com/prometheus-community/helm-charts/tree/main/charts/kube-prometheus-stack" rel="noopener ugc nofollow" target="_blank">kube-Prometheus-stack</a>Helm chart。我们将使用一个定制的<code class="fe ng nh ni mx b">values.yaml</code>文件为名为<code class="fe ng nh ni mx b">demo/otel-collector</code>的OTEL收集器自动添加静态Prometheus目标(仅在<code class="fe ng nh ni mx b">kind</code>环境中需要<code class="fe ng nh ni mx b">kubeEtc</code>配置):</p><pre class="lr ls lt lu gu mw mx my mz aw na bi"><span id="a3cd" class="nb kn ir mx b gz nc nd l ne nf">kubeEtcd:<br/>  service:<br/>    targetPort: 2381<br/>prometheus:<br/>  prometheusSpec:<br/>    additionalScrapeConfigs:<br/>    - job_name: "demo/otel-collector"<br/>      static_configs:<br/>      - targets: ["otel-collector.default.svc.cluster.local:8889"]</span></pre><p id="125b" class="pw-post-body-paragraph jo jp ir jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl ik bi translated">现在，通过执行以下命令将舵图添加到集群中:</p><pre class="lr ls lt lu gu mw mx my mz aw na bi"><span id="3318" class="nb kn ir mx b gz nc nd l ne nf">$ helm upgrade --install --wait --timeout 15m \<br/>  --namespace monitoring --create-namespace \<br/>  --repo <a class="ae lp" href="https://prometheus-community.github.io/helm-charts" rel="noopener ugc nofollow" target="_blank">https://prometheus-community.github.io/helm-charts</a> \<br/>  kube-prometheus-stack kube-prometheus-stack --values ./prom-grafana/values.yaml<br/> <br/>Release "kube-prometheus-stack" does not exist. Installing it now.<br/>NAME: kube-prometheus-stack<br/>LAST DEPLOYED: Mon Aug 22 13:53:58 2022<br/>NAMESPACE: monitoring<br/>STATUS: deployed<br/>REVISION: 1<br/>NOTES:<br/>kube-prometheus-stack has been installed. Check its status by running:<br/>  kubectl --namespace monitoring get pods -l "release=kube-prometheus-stack"</span></pre><p id="1ac0" class="pw-post-body-paragraph jo jp ir jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl ik bi translated">让我们来看看Prometheus目标，如果Prometheus可以抓取OTEL收集器端点—同样，将服务转发到您的本地机器，并在<a class="ae lp" href="http://localhost:9090/targets" rel="noopener ugc nofollow" target="_blank">http://localhost:9090/targets</a>打开浏览器。</p><pre class="lr ls lt lu gu mw mx my mz aw na bi"><span id="1be7" class="nb kn ir mx b gz nc nd l ne nf">$ kubectl port-forward -n monitoring svc/kube-prometheus-stack-prometheus 9090:9090</span></pre><figure class="lr ls lt lu gu lv gi gj paragraph-image"><div role="button" tabindex="0" class="lw lx di ly bf lz"><div class="gi gj lq"><img src="../Images/3f741bf379ee8b1f3677ae334dc620a2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*cGpXViVY7P4RZr53"/></div></div><figcaption class="mc md gk gi gj me mf bd b be z dk translated">普罗米修斯目标</figcaption></figure><p id="56c3" class="pw-post-body-paragraph jo jp ir jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl ik bi translated">这看起来和预期的一样，现在转到Grafana并创建一个显示定制指标的仪表板。如前所述，将Grafana服务端口转发到您的本地机器，并在<a class="ae lp" href="http://localhost:3000" rel="noopener ugc nofollow" target="_blank"> http://localhost:3000 </a>打开一个浏览器。因为您需要用户名/密码组合来登录Grafana，所以我们首先需要从Kubernetes secret中获取该信息:</p><pre class="lr ls lt lu gu mw mx my mz aw na bi"><span id="fe60" class="nb kn ir mx b gz nc nd l ne nf"># Grafana admin username<br/>$ kubectl get secret -n monitoring kube-prometheus-stack-grafana -o jsonpath='{.data.admin-user}' | base64 --decode<br/> <br/># Grafana password<br/>$ kubectl get secret -n monitoring kube-prometheus-stack-grafana -o jsonpath='{.data.admin-password}' | base64 --decode<br/> <br/># port-forward Grafana service<br/>$ kubectl port-forward -n monitoring svc/kube-prometheus-stack-grafana 3000:80<br/> <br/>Forwarding from 127.0.0.1:3000 -&gt; 3000<br/>Forwarding from [::1]:3000 -&gt; 3000</span></pre><p id="d392" class="pw-post-body-paragraph jo jp ir jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl ik bi translated">在<a class="ae lp" href="http://localhost:3000" rel="noopener ugc nofollow" target="_blank"> http://localhost:3000 </a>打开浏览器并成功登录后，您应该会看到Grafana欢迎页面。</p><figure class="lr ls lt lu gu lv gi gj paragraph-image"><div role="button" tabindex="0" class="lw lx di ly bf lz"><div class="gi gj lq"><img src="../Images/8d3fca3037527f1d4bd199b46498408d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*3P1Cj85NfuZ-KU3H"/></div></div><figcaption class="mc md gk gi gj me mf bd b be z dk translated">Grafana欢迎页面</figcaption></figure><h1 id="6164" class="km kn ir bd ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj bi translated">为自定义指标添加仪表板</h1><p id="ec8a" class="pw-post-body-paragraph jo jp ir jq b jr lk jt ju jv ll jx jy jz lm kb kc kd ln kf kg kh lo kj kk kl ik bi translated">转到<a class="ae lp" href="https://partlycloudy.blog/2022/08/22/asp-net-custom-metrics-with-opentelemetry-collector-prometheus-grafana/3000/dashboard/import" rel="noopener ugc nofollow" target="_blank">http://localhost:3000/dashboard/import</a>，从<code class="fe ng nh ni mx b">./prom-grafana/dashboard.json</code>上传预先创建的仪表板(或者简单地将其内容粘贴到文本框中)。导入定义后，您应该会被重定向到仪表板，并看到显示的自定义指标。</p><figure class="lr ls lt lu gu lv gi gj paragraph-image"><div role="button" tabindex="0" class="lw lx di ly bf lz"><div class="gi gj lq"><img src="../Images/e01126412ebc61ee0ad760f1c955f2de.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*AMeJXhWTeV0HNZej"/></div></div><figcaption class="mc md gk gi gj me mf bd b be z dk translated">导入Grafana仪表板</figcaption></figure><figure class="lr ls lt lu gu lv gi gj paragraph-image"><div role="button" tabindex="0" class="lw lx di ly bf lz"><div class="gi gj nj"><img src="../Images/16227bc74ca4b0c7c9b153a2398375aa.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*QGk9WxJSkNBlGFIA"/></div></div><figcaption class="mc md gk gi gj me mf bd b be z dk translated">具有仪表1和仪表2指标的图表</figcaption></figure><h1 id="5a5f" class="km kn ir bd ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj bi translated">总结</h1><p id="e0d1" class="pw-post-body-paragraph jo jp ir jq b jr lk jt ju jv ll jx jy jz lm kb kc kd ln kf kg kh lo kj kk kl ik bi translated">该演示展示了如何在ASP.NET服务中使用OpenTelemetry自定义指标，将遥测数据发送到由Prometheus实例收集的OTEL收集器实例。为了结束这个循环，这些定制指标最终会显示在Grafana仪表板中。这种解决方案的优点是，您可以使用OpenTelemetry这样的通用解决方案来生成和收集指标。通过OTEL导出器配置，可以轻松地交换数据最终发送到哪个服务以及使用哪个解决方案来分析数据——如果您不想使用Prometheus，您只需修改OTEL管道并将遥测数据导出到Azure Monitor或DataDog、Splunk等。</p><p id="93fa" class="pw-post-body-paragraph jo jp ir jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl ik bi translated">我希望这个演示已经很好地向您介绍了OpenTelemetry世界。编码快乐！🙂</p></div><div class="ab cl nk nl hv nm" role="separator"><span class="nn bw bk no np nq"/><span class="nn bw bk no np nq"/><span class="nn bw bk no np"/></div><div class="ik il im in io"><p id="923b" class="pw-post-body-paragraph jo jp ir jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl ik bi translated"><em class="mh">原载于2022年8月22日</em><a class="ae lp" href="https://partlycloudy.blog/2022/08/22/asp-net-custom-metrics-with-opentelemetry-collector-prometheus-grafana/" rel="noopener ugc nofollow" target="_blank"><em class="mh">http://partly cloudy . blog</em></a><em class="mh">。</em></p></div></div>    
</body>
</html>