<html>
<head>
<title>This is why coupling is your worst enemy</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">这就是为什么耦合是你最大的敌人</h1>
<blockquote>原文：<a href="https://itnext.io/this-is-why-coupling-is-your-worst-enemy-d4678d0cab49?source=collection_archive---------7-----------------------#2018-11-19">https://itnext.io/this-is-why-coupling-is-your-worst-enemy-d4678d0cab49?source=collection_archive---------7-----------------------#2018-11-19</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><figure class="ip iq gp gr ir is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi io"><img src="../Images/a81cc5d741154ad3aa18b1ddd85aed49.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*SFELgpAxx_k8W7BRFF8hOg.png"/></div></div></figure><div class=""/><p id="6325" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我来给你看看它对<strong class="ka jc"> Node.Js. </strong>里写得很差的HTTP Server(<a class="ae kw" href="https://expressjs.com/" rel="noopener ugc nofollow" target="_blank">Express Framework</a>)的负面影响</p><p id="1753" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">【auriosoftware.com】<em class="kx">我们构建壮观的应用程序，查看</em><a class="ae kw" href="https://auriosoftware.com/" rel="noopener ugc nofollow" target="_blank"><strong class="ka jc"><em class="kx"/></strong></a></p></div><div class="ab cl ky kz hu la" role="separator"><span class="lb bw bk lc ld le"/><span class="lb bw bk lc ld le"/><span class="lb bw bk lc ld"/></div><div class="ij ik il im in"><p id="2ba9" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">它总是以一个有趣的预测开始，即我们的新服务器将“小而简单”。</p><p id="935e" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">然而，正如大多数预测一样，即使是这一次也将很快被毁灭。</p><h2 id="e148" class="lf lg jb bd lh li lj dn lk ll lm dp ln kj lo lp lq kn lr ls lt kr lu lv lw lx bi translated">这一切都始于这段样板代码</h2><figure class="ly lz ma mb gt is"><div class="bz fp l di"><div class="mc md l"/></div><figcaption class="me mf gj gh gi mg mh bd b be z dk translated">Login.js</figcaption></figure><p id="dc97" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">第一个用例非常简单。当我们的服务器收到来自客户端的登录请求时，它将调用<strong class="ka jc">外部HTTP API </strong>，当一切顺利时，它将向最终用户发送200状态代码响应。</p><p id="a18d" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我们正在构建中间件。这个服务器位于UI和外部HTTP端点之间，终端用户不应该知道这个端点。</p><p id="4db8" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">小而简单，这是理所应当的。</p><p id="7474" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">这是这个用例的测试片段。</p><figure class="ly lz ma mb gt is"><div class="bz fp l di"><div class="mc md l"/></div></figure><p id="3a68" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">当我们的外部端点返回OK状态代码时，我们期望正确的响应被发送给最终用户。</p></div><div class="ab cl ky kz hu la" role="separator"><span class="lb bw bk lc ld le"/><span class="lb bw bk lc ld le"/><span class="lb bw bk lc ld"/></div><div class="ij ik il im in"><h2 id="d977" class="lf lg jb bd lh li lj dn lk ll lm dp ln kj lo lp lq kn lr ls lt kr lu lv lw lx bi translated">几个月后</h2><p id="d806" class="pw-post-body-paragraph jy jz jb ka b kb mi kd ke kf mj kh ki kj mk kl km kn ml kp kq kr mm kt ku kv ij bi translated">一段时间后，我们的中间件有更多的用例需要处理。因此，出现了很多像这样的新功能，也出现了很多这样的测试案例。</p><p id="97ba" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我们发现，我们必须改变我们的HTTP服务器(快速)，因为它太慢了，一些新的花式HTTP服务器刚刚出现。</p><p id="2bcb" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">所以我们进入代码并意识到…那…嗯… <strong class="ka jc">我们差不多要完蛋了。</strong></p><figure class="ly lz ma mb gt is gh gi paragraph-image"><div class="gh gi mn"><img src="../Images/640ac599364b7ee0f3ab59ad74bda176.png" data-original-src="https://miro.medium.com/v2/resize:fit:748/1*tOIjeDcbge_UJChJs1dqbQ.gif"/></div></figure><p id="e442" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">为什么？？</p><p id="2de1" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">因为我们必须改变一切。</p><p id="ac11" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">是的，我是说一切。看看我们的代码，到处都有express。在我们的测试和产品代码中。</p><p id="97bb" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我们将我们的高级策略与低级细节紧密耦合，比如快速响应和请求对象。</p><p id="54cb" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">看看代码就知道了。如果我们想要改变我们的HTTP服务器，我们必须检查整个代码库，并将express请求和响应对象的API改变为新服务器的API。</p><p id="4d28" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我们以前的测试片段。</p><figure class="ly lz ma mb gt is"><div class="bz fp l di"><div class="mc md l"/></div><figcaption class="me mf gj gh gi mg mh bd b be z dk translated">旧Express API</figcaption></figure><p id="cfa8" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">具有更改的API的新代码片段。</p><figure class="ly lz ma mb gt is"><div class="bz fp l di"><div class="mc md l"/></div><figcaption class="me mf gj gh gi mg mh bd b be z dk translated">新的花式服务器API</figcaption></figure><p id="deb0" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">旧的生产代码。</p><figure class="ly lz ma mb gt is"><div class="bz fp l di"><div class="mc md l"/></div><figcaption class="me mf gj gh gi mg mh bd b be z dk translated">快速API</figcaption></figure><p id="452e" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">新的。</p><figure class="ly lz ma mb gt is"><div class="bz fp l di"><div class="mc md l"/></div><figcaption class="me mf gj gh gi mg mh bd b be z dk translated">新的花式服务器API</figcaption></figure><h2 id="b885" class="lf lg jb bd lh li lj dn lk ll lm dp ln kj lo lp lq kn lr ls lt kr lu lv lw lx bi translated">几个月后#2</h2><p id="1fdc" class="pw-post-body-paragraph jy jz jb ka b kb mi kd ke kf mj kh ki kj mk kl km kn ml kp kq kr mm kt ku kv ij bi translated">我们设法把我们的HTTP服务器换成了新的(花了很多时间)。</p><figure class="ly lz ma mb gt is gh gi paragraph-image"><div class="gh gi mo"><img src="../Images/bd1e53cdd6cb4f3beb71625fcedfa047.png" data-original-src="https://miro.medium.com/v2/resize:fit:576/1*ff4Bt3cpqenRyiNmNlrl7w.gif"/></div></figure><h2 id="c1d0" class="lf lg jb bd lh li lj dn lk ll lm dp ln kj lo lp lq kn lr ls lt kr lu lv lw lx bi translated">几个月后#3</h2><p id="ebd5" class="pw-post-body-paragraph jy jz jb ka b kb mi kd ke kf mj kh ki kj mk kl km kn ml kp kq kr mm kt ku kv ij bi translated">我们的产品负责人告诉我们，我们必须将我们的外部HTTP端点更改为另一个具有完全不同的API的端点。</p><p id="9927" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">所以我们运行我们的IDE并意识到…</p><p id="e1fa" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">嗯…</p><figure class="ly lz ma mb gt is gh gi paragraph-image"><div class="gh gi mp"><img src="../Images/66cad46c5f2dc322b62d3158f85b4cd4.png" data-original-src="https://miro.medium.com/v2/resize:fit:480/1*zkhojjWIsW2WkNT2PPsaKg.gif"/></div></figure><p id="a943" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我们真的完蛋了。我们又要完蛋了。</p><p id="474e" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><strong class="ka jc">为什么？？</strong></p><p id="9b97" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">因为我们再次将我们的底层细节(外部API)与我们的高层策略结合在一起。</p><p id="ca17" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">只要看看代码，我们必须再次检查我们的代码库，并更改我们的外部HTTP端点的API。</p><p id="9df8" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">这是旧的外部端点的外观。</p><figure class="ly lz ma mb gt is"><div class="bz fp l di"><div class="mc md l"/></div><figcaption class="me mf gj gh gi mg mh bd b be z dk translated">旧端点</figcaption></figure><p id="a5bd" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">新的API。</p><figure class="ly lz ma mb gt is"><div class="bz fp l di"><div class="mc md l"/></div><figcaption class="me mf gj gh gi mg mh bd b be z dk translated">新端点</figcaption></figure><p id="81a0" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">整个登录用例的类图是这样的。</p><figure class="ly lz ma mb gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi mq"><img src="../Images/0ef5d2f573e9d128211be37e468d5c2e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*0EuDppVrMCMXfu8DmW226A.png"/></div></div></figure><p id="9a98" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">那么…我们如何解决这个问题呢？</p></div><div class="ab cl ky kz hu la" role="separator"><span class="lb bw bk lc ld le"/><span class="lb bw bk lc ld le"/><span class="lb bw bk lc ld"/></div><div class="ij ik il im in"><h1 id="f7fb" class="mr lg jb bd lh ms mt mu lk mv mw mx ln my mz na lq nb nc nd lt ne nf ng lw nh bi translated">这个解决方案怎么样？</h1><figure class="ly lz ma mb gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi ni"><img src="../Images/da95d8cd7faacd35afd67be2cef35a54.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*G4RuybDWvX4JdGjzKIQiRw.png"/></div></div></figure><p id="556b" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">登录对其周围环境一无所知！(<a class="ae kw" href="https://en.wikipedia.org/wiki/Law_of_Demeter" rel="noopener ugc nofollow" target="_blank">得墨忒耳定律</a>)。</p><p id="45bc" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">它知道稳定的接口，如<strong class="ka jc">响应</strong>、<strong class="ka jc">请求</strong>和<strong class="ka jc">动作</strong>。它不知道Response是express对象、node对象还是其他对象。它不在乎。</p><p id="6c19" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我们遵守<a class="ae kw" href="https://en.wikipedia.org/wiki/Dependency_inversion_principle" rel="noopener ugc nofollow" target="_blank"> <strong class="ka jc">依赖倒置原则</strong> </a>，因为高层模块(登录)依赖于抽象(响应、请求和动作)，低层细节(快速响应、请求和特定的外部HTTP端点)也依赖于这些抽象。</p><p id="a2e7" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我们颠倒了依赖关系。现在我们可以在一个地方改变Express HTTP服务器，而不破坏其他任何东西。这正是我们想要的。我们也不关心改变特定的外部HTTP端点。我们依赖于名为<strong class="ka jc">动作</strong>的抽象。什么都有可能。</p><p id="bf45" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">看看新代码就知道了。</p><figure class="ly lz ma mb gt is"><div class="bz fp l di"><div class="mc md l"/></div></figure><p id="d70f" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">请求和响应适配器如下所示。</p><figure class="ly lz ma mb gt is"><div class="bz fp l di"><div class="mc md l"/></div></figure><p id="264e" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">和特定外部登录操作。</p><figure class="ly lz ma mb gt is"><div class="bz fp l di"><div class="mc md l"/></div></figure></div><div class="ab cl ky kz hu la" role="separator"><span class="lb bw bk lc ld le"/><span class="lb bw bk lc ld le"/><span class="lb bw bk lc ld"/></div><div class="ij ik il im in"><p id="ec6d" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">如果我们需要更改外部HTTP操作，我们只需创建一个新文件。如果我们需要更改HTTP服务器，我们将只为他的请求和响应对象创建带有新服务器和适配器的新文件。</p><p id="ee68" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><strong class="ka jc">我们根本不会更改登录文件(用例)!</strong></p><h1 id="9d26" class="mr lg jb bd lh ms nj mu lk mv nk mx ln my nl na lq nb nm nd lt ne nn ng lw nh bi translated">应用模式和原则</h1><h2 id="fc63" class="lf lg jb bd lh li lj dn lk ll lm dp ln kj lo lp lq kn lr ls lt kr lu lv lw lx bi translated">德米特里定律</h2><blockquote class="no np nq"><p id="114a" class="jy jz kx ka b kb kc kd ke kf kg kh ki nr kk kl km ns ko kp kq nt ks kt ku kv ij bi translated">"一个给定的对象应该尽可能少地假设其他任何东西的结构或属性(包括它的子组件)"</p></blockquote><h2 id="e17c" class="lf lg jb bd lh li lj dn lk ll lm dp ln kj lo lp lq kn lr ls lt kr lu lv lw lx bi translated">从属倒置原则</h2><blockquote class="no np nq"><p id="98fa" class="jy jz kx ka b kb kc kd ke kf kg kh ki nr kk kl km ns ko kp kq nt ks kt ku kv ij bi translated">“高层模块不应该依赖低层模块。两者都应该依赖于<a class="ae kw" href="https://en.wikipedia.org/wiki/Abstraction_(computer_science)" rel="noopener ugc nofollow" target="_blank">抽象</a></p></blockquote><h2 id="ec7c" class="lf lg jb bd lh li lj dn lk ll lm dp ln kj lo lp lq kn lr ls lt kr lu lv lw lx bi translated">适配器模式</h2><blockquote class="no np nq"><p id="c62c" class="jy jz kx ka b kb kc kd ke kf kg kh ki nr kk kl km ns ko kp kq nt ks kt ku kv ij bi translated">"通过将一个类的接口转换为客户端期望的接口，允许原本不兼容的类一起工作。"</p></blockquote><h1 id="608c" class="mr lg jb bd lh ms nj mu lk mv nk mx ln my nl na lq nb nm nd lt ne nn ng lw nh bi translated">哦，天啊…那个JavaScript的东西</h1><blockquote class="nu"><p id="8323" class="nv nw jb bd nx ny nz oa ob oc od kv dk translated">“但是……JavaScript没有接口，所以图中的类和接口没有依赖性”</p></blockquote><p id="01c8" class="pw-post-body-paragraph jy jz jb ka b kb oe kd ke kf of kh ki kj og kl km kn oh kp kq kr oi kt ku kv ij bi translated">不要被骗了！</p><p id="269f" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">没有<strong class="ka jc">显式</strong>依赖，但肯定有<strong class="ka jc">隐式</strong>依赖！</p><p id="4db3" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">如果登录操作不使用接口Request、Response和action提供的相同API，它将在代码中的某个地方的操作期间抛出运行时错误。</p><p id="b59d" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我强烈建议改用TypeScript，因为很多人都落入了这个陷阱。使用TypeScript，您可以定义模块的显式依赖关系，这有助于保持设计的整洁。</p><h1 id="79c3" class="mr lg jb bd lh ms nj mu lk mv nk mx ln my nl na lq nb nm nd lt ne nn ng lw nh bi translated">不全是阳光和彩虹</h1><p id="a19a" class="pw-post-body-paragraph jy jz jb ka b kb mi kd ke kf mj kh ki kj mk kl km kn ml kp kq kr mm kt ku kv ij bi translated">至少还有一个问题。我们的业务逻辑(登录用例)仍然与HTTP协议相耦合。如果你看这个图，你可以看到这个耦合。但是想象一下，要分离它需要多少抽象(看看登录的例子)。</p><p id="94a7" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">添加越来越多的抽象可能会伤害我们。想象一下，为了解耦，你需要写多少代码。甚至添加一个新的用例也是非常困难和耗时的。</p><p id="00ea" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">明智的做法是思考你的项目，考虑对你的设计做出这样的改变，因为这种灵活性的代价是非常昂贵的。</p><p id="fe27" class="pw-post-body-paragraph jy jz jb ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><a class="ae kw" href="http://foobazbar.club" rel="noopener ugc nofollow" target="_blank">更多文章尽在我的博客<strong class="ka jc"> foobazbar.club </strong> </a> <strong class="ka jc">。</strong></p></div></div>    
</body>
</html>