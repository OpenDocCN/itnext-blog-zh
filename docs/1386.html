<html>
<head>
<title/>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1/>
<blockquote>原文：<a href="https://itnext.io/battle-testing-a-ride-sharing-api-and-react-natives-mapview-in-expo-c0ce5d50cbf0?source=collection_archive---------2-----------------------#2018-10-01">https://itnext.io/battle-testing-a-ride-sharing-api-and-react-natives-mapview-in-expo-c0ce5d50cbf0?source=collection_archive---------2-----------------------#2018-10-01</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><figure class="ip iq gp gr ir is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi io"><img src="../Images/3bf9014bc9e4a063ca85e27053a5cec3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*eo19YuJgnxQAn4-5"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">“车载手机支架上的iPhone”作者<a class="ae jd" href="https://unsplash.com/@samuelfoster?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Samuel Foster </a>在<a class="ae jd" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a></figcaption></figure></div><div class="ab cl je jf hu jg" role="separator"><span class="jh bw bk ji jj jk"/><span class="jh bw bk ji jj jk"/><span class="jh bw bk ji jj"/></div><div class="ij ik il im in"><p id="bdc7" class="pw-post-body-paragraph jl jm jn jo b jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj ij bi translated"><strong class="jo kk">这是关于使用React Native为</strong><a class="ae jd" href="https://uncovercity.com/" rel="noopener ugc nofollow" target="_blank"><strong class="jo kk">uncovercity</strong></a><strong class="jo kk">构建iOS和Android应用的系列文章的第二篇。你可以在这里找到其他的:</strong></p><ol class=""><li id="66ad" class="kl km jn jo b jp jq jt ju jx kn kb ko kf kp kj kq kr ks kt bi translated"><a class="ae jd" rel="noopener ugc nofollow" target="_blank" href="/speeding-up-the-build-of-a-surprise-dinner-app-in-react-native-using-expo-2c18beabaaa7">使用Expo加速React Native中惊喜晚餐应用的构建</a></li><li id="d93e" class="kl km jn jo b jp ku jt kv jx kw kb kx kf ky kj kq kr ks kt bi translated">在Expo中对战测试一个ridesharing API和React Native的MapView</li><li id="0aa4" class="kl km jn jo b jp ku jt kv jx kw kb kx kf ky kj kq kr ks kt bi translated"><a class="ae jd" href="https://medium.com/@marcelkalveram/supporting-multiple-languages-in-react-native-with-expos-localization-module-9611f9e3b6a0" rel="noopener">通过Expo本地化在React Native中支持多种语言</a></li><li id="202c" class="kl km jn jo b jp ku jt kv jx kw kb kx kf ky kj kq kr ks kt bi translated"><a class="ae jd" href="https://medium.com/@marcelkalveram/the-intricacies-of-nesting-navigators-in-react-native-using-react-navigation-fef52ca72964" rel="noopener">使用react-navigation在React Native中嵌套导航器的复杂性</a></li></ol></div><div class="ab cl je jf hu jg" role="separator"><span class="jh bw bk ji jj jk"/><span class="jh bw bk ji jj jk"/><span class="jh bw bk ji jj"/></div><div class="ij ik il im in"><h1 id="9342" class="kz la jn bd lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw bi translated">在Expo中对战测试一个ridesharing API和React Native的MapView</h1><p id="3be4" class="pw-post-body-paragraph jl jm jn jo b jp lx jr js jt ly jv jw jx lz jz ka kb ma kd ke kf mb kh ki kj ij bi translated">最近，在为<a class="ae jd" href="https://uncovercity.com/" rel="noopener ugc nofollow" target="_blank">uncovercity.com</a>开发iOS应用程序时，我有幸在React Native中体验了地图和API集成。</p><p id="195f" class="pw-post-body-paragraph jl jm jn jo b jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj ij bi translated">挑战可以很容易地概括为:</p><ol class=""><li id="3da1" class="kl km jn jo b jp jq jt ju jx kn kb ko kf kp kj kq kr ks kt bi translated">一辆汽车(通过优步这样的拼车应用程序订购)在特定的地点接你，带你去一个未知的地点吃一顿惊喜的晚餐。</li><li id="f779" class="kl km jn jo b jp ku jt kv jx kw kb kx kf ky kj kq kr ks kt bi translated">当你的晚餐结束后，你可以使用该应用程序订购一辆车回家。</li></ol><p id="e155" class="pw-post-body-paragraph jl jm jn jo b jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj ij bi translated">让这个挑战变得有趣的是，我们被迫从一开始就在生产中测试应用程序的乘车共享部分，所以我们经常与司机保持联系，坐在豪华汽车里，手里拿着手机，腿上放着电脑。</p><h1 id="0284" class="kz la jn bd lb lc mc le lf lg md li lj lk me lm ln lo mf lq lr ls mg lu lv lw bi translated">挑战</h1><p id="87ce" class="pw-post-body-paragraph jl jm jn jo b jp lx jr js jt ly jv jw jx lz jz ka kb ma kd ke kf mb kh ki kj ij bi translated">为了使用户的体验尽可能愉快和可预测，我们实现了一个实时地图，显示车辆在行驶中的当前位置，包括接送和返程。</p><div class="mh mi mj mk gt ab cb"><figure class="ml is mm mn mo mp mq paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><img src="../Images/5fa93ece3f1a488c9fc1c78d1ae53a44.png" data-original-src="https://miro.medium.com/v2/resize:fit:666/format:webp/1*F5OqWxY_RV_cFa0OoL8O7g.png"/></div></figure><figure class="ml is mr mn mo mp mq paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><img src="../Images/0bdf8de4b64b8f0604a27cc52feb9063.png" data-original-src="https://miro.medium.com/v2/resize:fit:668/format:webp/1*aKyIaJ3ufYwJEvUx6cqfZg.png"/></div></figure><figure class="ml is mr mn mo mp mq paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><img src="../Images/3d4a62f21ba902c8d407c7e276b51706.png" data-original-src="https://miro.medium.com/v2/resize:fit:668/format:webp/1*yXvpjpgTIUz3TGQ5Jgl8Xw.png"/></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk ms di mt mu translated">iPhone X上的uncovercity应用程序的一些截图。从左到右:搜索搭车，在餐厅接机，回家</figcaption></figure></div><p id="cb04" class="pw-post-body-paragraph jl jm jn jo b jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj ij bi translated">在上面的截图中，你可以看到应用程序的不同状态:</p><ul class=""><li id="fc16" class="kl km jn jo b jp jq jt ju jx kn kb ko kf kp kj mv kr ks kt bi translated">搜索车辆:在用户请求返程后</li><li id="23f1" class="kl km jn jo b jp ku jt kv jx kw kb kx kf ky kj mv kr ks kt bi translated">接送旅程:当车辆在去接用户回家的路上时</li><li id="46b8" class="kl km jn jo b jp ku jt kv jx kw kb kx kf ky kj mv kr ks kt bi translated">回程:车辆在去餐馆接用户的路上</li></ul><p id="5fd5" class="pw-post-body-paragraph jl jm jn jo b jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj ij bi translated">在这篇文章中，我将谈谈我们是如何做到这一点的，以及我们面临的挑战。</p><h1 id="ea39" class="kz la jn bd lb lc mc le lf lg md li lj lk me lm ln lo mf lq lr ls mg lu lv lw bi translated">解决方案</h1><p id="2c61" class="pw-post-body-paragraph jl jm jn jo b jp lx jr js jt ly jv jw jx lz jz ka kb ma kd ke kf mb kh ki kj ij bi translated">该技术方案包括三个主要部分:</p><ul class=""><li id="7392" class="kl km jn jo b jp jq jt ju jx kn kb ko kf kp kj mv kr ks kt bi translated"><a class="ae jd" href="https://redux.js.org/" rel="noopener ugc nofollow" target="_blank"> Redux </a>每次从API得到响应时，更新地图上的车辆位置</li><li id="282b" class="kl km jn jo b jp ku jt kv jx kw kb kx kf ky kj mv kr ks kt bi translated"><a class="ae jd" href="https://github.com/gaearon/redux-thunk" rel="noopener ugc nofollow" target="_blank"> Redux Thunk </a>调度异步API请求以触发来自服务器的响应的动作(由于限制，这必须通过轮询来完成)</li><li id="8e24" class="kl km jn jo b jp ku jt kv jx kw kb kx kf ky kj mv kr ks kt bi translated">一个API代理，它将与拼车服务进行通信，并根据我们的需要过滤/映射数据。</li><li id="7cc6" class="kl km jn jo b jp ku jt kv jx kw kb kx kf ky kj mv kr ks kt bi translated">Expo的<a class="ae jd" href="https://docs.expo.io/versions/latest/sdk/map-view" rel="noopener ugc nofollow" target="_blank"> MapView </a>组件(基于React社区的<a class="ae jd" href="https://github.com/react-community/react-native-maps" rel="noopener ugc nofollow" target="_blank"> React Native组件</a>)显示带有车辆当前坐标的标记以及家庭和餐馆位置的图标。</li></ul><h1 id="930d" class="kz la jn bd lb lc mc le lf lg md li lj lk me lm ln lo mf lq lr ls mg lu lv lw bi translated">围绕未完成的API工作</h1><p id="1516" class="pw-post-body-paragraph jl jm jn jo b jp lx jr js jt ly jv jw jx lz jz ka kb ma kd ke kf mb kh ki kj ij bi translated">API代理听起来像是一件奇怪的事情，但我们实际上必须将该层放在我们的应用程序和拼车API之间，原因有几个。在有些情况下，没有车辆可用，我们不能依靠应用程序本身来发送另一个请求(因为它可能处于非活动状态)。相反，cron作业处理该任务。</p><p id="a03e" class="pw-post-body-paragraph jl jm jn jo b jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj ij bi translated">不幸的是，在我们开发这款应用时，也没有办法使用拼车API的websocket集成，这种集成会将状态更新推送到应用中。因此，我们必须进行良好的轮询，每隔几秒钟就向服务器发送请求，以获取当前位置数据。因为我们不期望每小时有大量的请求，所以一开始这似乎是一个可行的解决方案，尽管不是一个非常可伸缩的解决方案。</p><figure class="mh mi mj mk gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi mw"><img src="../Images/f58f83d553f364228c706f9339b083de.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Bg8_r1e7yizmuj1Ipw90og.png"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk translated">应用程序数据流的简单概述:从UI组件到Redux再到API，然后返回</figcaption></figure><p id="2c41" class="pw-post-body-paragraph jl jm jn jo b jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj ij bi translated">当我们发现拼车服务的测试环境仍在开发中时，事情变得更加复杂。因此，我们需要在自己的产品中响应的任何可能的场景(订购乘车、汽车上路、汽车到达、所有司机都很忙等等)只能在生产中进行测试！稍后会有更多相关信息…</p><h1 id="73c8" class="kz la jn bd lb lc mc le lf lg md li lj lk me lm ln lo mf lq lr ls mg lu lv lw bi translated">用Expo的MapView组件显示标记</h1><p id="9e65" class="pw-post-body-paragraph jl jm jn jo b jp lx jr js jt ly jv jw jx lz jz ka kb ma kd ke kf mb kh ki kj ij bi translated">使用Expo的<a class="ae jd" href="https://docs.expo.io/versions/latest/sdk/map-view" rel="noopener ugc nofollow" target="_blank"> MapView </a>在地图上显示实时标记的体验非常简单(为了让它更清晰，我删除了这个片段中的一些噪声)。</p><pre class="mh mi mj mk gt mx my mz na aw nb bi"><span id="cf8c" class="nc la jn my b gy nd ne l nf ng">&lt;MapView&gt;<br/>    &lt;MapView.<strong class="my kk">Marker</strong><br/>      identifier="vehiclePosition"<br/>      coordinate=<!-- -->{{<br/>        latitude: this.props.location[0],<br/>        longitude: this.props.location[1]<br/>      }}<br/>      image={ICON_MAP}<br/>    /&gt;<br/>    &lt;MapView.<strong class="my kk">Marker</strong><br/>      identifier="restaurantPosition"<br/>      coordinate=<!-- -->{{<br/>        latitude: experience.local_latitude,<br/>        longitude: experience.local_longitude<br/>      }}<br/>      image={ICON_RESTAURANT}<br/>    /&gt;<br/>&lt;/MapView&gt;</span></pre><p id="3918" class="pw-post-body-paragraph jl jm jn jo b jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj ij bi translated">更新坐标也非常简单:</p><ul class=""><li id="5486" class="kl km jn jo b jp jq jt ju jx kn kb ko kf kp kj mv kr ks kt bi translated">JavaScript间隔触发redux-thunk事件，每秒调度一个新的API请求。</li><li id="1a71" class="kl km jn jo b jp ku jt kv jx kw kb kx kf ky kj mv kr ks kt bi translated">然后，redux reducer处理响应，并将数据发送到视图。</li><li id="c632" class="kl km jn jo b jp ku jt kv jx kw kb kx kf ky kj mv kr ks kt bi translated">一旦MapView <a class="ae jd" href="https://github.com/react-community/react-native-maps/blob/master/docs/marker.md" rel="noopener ugc nofollow" target="_blank">标记</a>收到新坐标，它会立即更新其位置。</li></ul><div class="mh mi mj mk gt ab cb"><figure class="ml is nh mn mo mp mq paragraph-image"><img src="../Images/d478d7b0963c3c329af6b7d1a4bd655a.png" data-original-src="https://miro.medium.com/v2/resize:fit:702/1*jeAs2o1vOq24-Ja4nQf5ag.gif"/></figure><figure class="ml is ni mn mo mp mq paragraph-image"><img src="../Images/5a55a21e31f0a8c9c433fef33729bafc.png" data-original-src="https://miro.medium.com/v2/resize:fit:702/1*XSFqxeS02XImJfksU8MM7Q.gif"/><figcaption class="iz ja gj gh gi jb jc bd b be z dk nj di nk mu translated">当地图更新汽车的位置时，它会自动调整其视口，使相关图标居中</figcaption></figure></div><h1 id="82f3" class="kz la jn bd lb lc mc le lf lg md li lj lk me lm ln lo mf lq lr ls mg lu lv lw bi translated">将地图拟合到一组提供的标记</h1><p id="c26f" class="pw-post-body-paragraph jl jm jn jo b jp lx jr js jt ly jv jw jx lz jz ka kb ma kd ke kf mb kh ki kj ij bi translated">MapView组件还可以使用它的<code class="fe nl nm nn my b"><a class="ae jd" href="https://github.com/react-community/react-native-maps/blob/master/docs/mapview.md#methods" rel="noopener ugc nofollow" target="_blank">fitToSuppliedMarkers</a></code>方法，轻松地将地图聚焦在一组标记上，并平滑地显示地图的相应区域。</p><p id="15a3" class="pw-post-body-paragraph jl jm jn jo b jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj ij bi translated">然而不幸的是，该方法不允许任何填充(不像它的<code class="fe nl nm nn my b"><a class="ae jd" href="https://github.com/react-community/react-native-maps/blob/master/docs/mapview.md#methods" rel="noopener ugc nofollow" target="_blank">fitToCoordinates</a></code>对应物)来确保标记不与屏幕上的其他元素重叠。</p><p id="bd53" class="pw-post-body-paragraph jl jm jn jo b jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj ij bi translated">幸运的是，<a class="ae jd" href="https://github.com/react-community/react-native-maps/issues/1149#issuecomment-344883668" rel="noopener ugc nofollow" target="_blank">社区提供了一个非常容易实现的解决方案</a>:</p><pre class="mh mi mj mk gt mx my mz na aw nb bi"><span id="5307" class="nc la jn my b gy nd ne l nf ng">fitToSuppliedMarkersCustom(coordinates) {<br/>  const markers = [];<br/>  markers.push(this.vehicleCoordinates());<br/>  markers.push(coordinates);</span><span id="5e39" class="nc la jn my b gy no ne l nf ng">  this.map.<strong class="my kk">fitToCoordinates</strong>(markers, {<br/>    edgePadding: {<br/>      bottom: 200, right: 50, top: 150, left: 50,<br/>    },<br/>    animated: true,<br/>  });<br/>}</span></pre><p id="cf0c" class="pw-post-body-paragraph jl jm jn jo b jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj ij bi translated">你所要做的就是使用React的<a class="ae jd" href="https://reactjs.org/docs/refs-and-the-dom.html" rel="noopener ugc nofollow" target="_blank"> ref </a>属性存储标记的引用，将它们推到一个数组中，然后使用<code class="fe nl nm nn my b"><a class="ae jd" href="https://github.com/react-community/react-native-maps/blob/master/lib/components/MapView.js#L594" rel="noopener ugc nofollow" target="_blank">fitToCoordinates</a></code>方法。</p><blockquote class="np nq nr"><p id="70fa" class="jl jm ns jo b jp jq jr js jt ju jv jw nt jy jz ka nu kc kd ke nv kg kh ki kj ij bi translated">更新:我最近在<a class="ae jd" href="https://github.com/react-community/react-native-maps" rel="noopener ugc nofollow" target="_blank"> react-native-maps </a> repo上创建了一个<a class="ae jd" href="https://github.com/react-community/react-native-maps/pull/2479" rel="noopener ugc nofollow" target="_blank"> pull请求</a>，修复了这种行为，并允许您将<strong class="jo kk"> edgePadding </strong>对象直接传递给<code class="fe nl nm nn my b"><a class="ae jd" href="https://github.com/react-community/react-native-maps/blob/master/lib/components/MapView.js#L585" rel="noopener ugc nofollow" target="_blank">fitToSuppliedMarkers</a></code>。请购单已被批准并合并到主数据中。</p></blockquote><h1 id="7810" class="kz la jn bd lb lc mc le lf lg md li lj lk me lm ln lo mf lq lr ls mg lu lv lw bi translated">测试我们的废料解决方案</h1><p id="5e55" class="pw-post-body-paragraph jl jm jn jo b jp lx jr js jt ly jv jw jx lz jz ka kb ma kd ke kf mb kh ki kj ij bi translated">正如您所想象的，最初几次将API响应与UI正确同步的尝试都非常不成功。当您使用一个测试环境并且您的请求对现实世界没有任何影响时，这不是一件大事。我们的情况是，每次我们“测试”API时，我们都会请求一辆真实的车辆。</p><p id="9566" class="pw-post-body-paragraph jl jm jn jo b jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj ij bi translated">不过，对我们有利的是，拼车服务提供了30秒的取消乘车的礼貌时间，这对于司机来说不是最理想的功能，但至少它允许我们调整和微调我们的系统，稍微有点缺点的是，会一直把司机送到随机的目的地。</p><p id="d1dc" class="pw-post-body-paragraph jl jm jn jo b jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj ij bi translated">事实上，我最后坐在一个司机的车里，他抱怨我们的请求/取消方法使他们的服务的API不安全。但是，尽管让一些驱动程序对我们非常恼火，尽管我们没有开发出最优雅的解决方案(使用轮询，在生产中测试，依赖cron jobs)，它现在实际上工作稳定，我们设法通过有限的资源和意外的约束来引导我们的方式生产就绪的应用程序。</p></div></div>    
</body>
</html>